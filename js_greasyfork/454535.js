// ==UserScript==
// @name            KPA
// @description     :)
// @namespace       KPA
// @version         1.5.4
// @author          mohu.tech
// @match           https://www.kinopoisk.ru/*
// @require         https://code.jquery.com/jquery-3.6.0.min.js
// @grant           GM_xmlhttpRequest
// @downloadURL https://update.greasyfork.org/scripts/454535/KPA.user.js
// @updateURL https://update.greasyfork.org/scripts/454535/KPA.meta.js
// ==/UserScript==

var timerType=1,gameStatus=!1,gameId=0;let lastId=0;var lastAnswer="",correctAnswers_count=0;let arrayAnswer={};var correctAnswer_db="",connectToServer=!1,tokenToServer=USER.integrations.items[0].email;let availableEpisodes=[];function createElementsPaKPA(){let e=document.createElement("div"),t=document.createElement("div"),r=document.createElement("select"),o=document.createElement("select"),n=document.createElement("div"),s=document.createElement("div"),l=document.createElement("div"),i=document.createElement("div"),c=(document.querySelectorAll(".episode-card_is-available"),[]);if(r.setAttribute("id","xtimesKPA"),r.setAttribute("name","xtimesKPA"),r.innerHTML="<option value='1'>1 с.</option><option value='2'>Случайно</option>",o.setAttribute("id","nakomKPA"),o.setAttribute("name","nakomKPA"),Object.keys(availableEpisodes).length>0)for(let e=0;e<Object.keys(availableEpisodes).length;e++)c[e]=document.createElement("option"),c[e].setAttribute("value",`${e+1}`),c[e].innerHTML=`Эпизод ${e+1}`,o.appendChild(c[e]);else c[0]=document.createElement("option"),c[0].setAttribute("value","0"),c[0].innerHTML="Авто",o.appendChild(c[0]);n.setAttribute("style","display: flex;justify-content: space-evenly;"),s.setAttribute("id","RTSHKPA"),s.setAttribute("style","cursor:pointer;"),s.textContent="Начать",l.setAttribute("id","RTSTKPA"),l.setAttribute("style","display:none;cursor:pointer;"),l.textContent="Стоп",i.setAttribute("id","otvArrKPA"),i.setAttribute("style","display:none;cursor:pointer;"),i.textContent="Ответы",n.appendChild(i),n.appendChild(s),n.appendChild(l),n.appendChild(o),n.appendChild(r),e.setAttribute("style","bottom: 0;position: fixed; z-index: 999;background-color: #fff;color: #1e1e1e;padding: 5px;width: 250px;"),t.setAttribute("id","nbjnKPA"),t.setAttribute("style","display:none"),t.textContent="Правильных ответов: "+correctAnswers_count,e.appendChild(t),e.appendChild(n),document.querySelector("body").appendChild(e),GM_xmlhttpRequest({method:"POST",url:"http://mohu.tech/admiral",data:"&summerKey="+tokenToServer,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(e){let t=JSON.parse(e.responseText);t.result?(connectToServer=!0,initBlockMenue()):(document.querySelector("#nbjnKPA").innerHTML=t.message,initBlockMenue())},onerror:function(e){console.log("Не получены ответы от сервиса.")}})}function initBlockMenue(){let e=document.querySelector("#nakomKPA"),t=document.querySelector("#RTSHKPA"),r=document.querySelector("#RTSTKPA"),o=document.querySelector("#otvArrKPA"),n=document.querySelector("#nbjnKPA"),s=document.querySelector("#xtimesKPA");connectToServer?(n.setAttribute("style","display:none"),s.setAttribute("style","display:block"),e.setAttribute("style","display:block"),t.setAttribute("style","display:block;cursor:pointer;"),r.setAttribute("style","display:none"),o.setAttribute("style","display:none")):(n.setAttribute("style","display:block"),s.setAttribute("style","display:none"),e.setAttribute("style","display:none"),t.setAttribute("style","display:none;"),r.setAttribute("style","display:none"),o.setAttribute("style","display:none"))}function gameDA(e){if(!connectToServer)return!0;gameStatus=e,e&&setTimeout((()=>{document.querySelectorAll(".episodes__slider-slide")[gameId-1].querySelector(".episode-card__btn").click(),setTimeout((()=>{document.querySelector(".modal-start__button").click(),setTimeout((()=>{gaswer_text(gameStatus)}),1500)}),500)}),500)}function gaswer_text(e=!1){if(!connectToServer)return!0;let t=document.querySelector("button.button_color_darken");null!=t&&t.click(),GM_xmlhttpRequest({method:"POST",url:"http://mohu.tech/henry",data:"&gameId="+gameId+"&lastId="+lastId+"&summerKey="+tokenToServer,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(t){let r=JSON.parse(t.responseText);if(r.result){correctAnswer_db=r.answer;let t=document.querySelectorAll(".game__answer-text");for(let e=0;e<4;e++){let r=t[e].querySelector(".text-fit").innerHTML;if(r=r.trimStart(),r=r.trimEnd(),""==correctAnswer_db){t[e].querySelector(".text-fit").click(),lastAnswer=r;break}if(correctAnswer_db==r){t[e].querySelector(".text-fit").click(),lastAnswer=r;break}if(3==e){t[e].querySelector(".text-fit").click(),lastAnswer=r;break}}if(e){if(2==timerType){let e=document.querySelector(".countdown").innerHTML;e=e.trimStart(),e=e.trimEnd(),e=e.split(":"),e[0]>0&&(e[1]=59),e[1]=1e3*e[1],e[1]>6e3?e[1]=6e3:e[1]<1e3&&(e[1]=1e3),setTimeout((()=>{gaswer_text(gameStatus)}),Math.ceil(Math.random(1e3)*e[1]))}else setTimeout((()=>{gaswer_text(gameStatus)}),1e3)}}else console.log(r.message)},onerror:function(e){console.log("Не получены ответы от сервиса.")}})}GM_xmlhttpRequest({method:"POST",url:"http://mohu.tech/kpiso",data:"&summerKey="+tokenToServer,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(e){let t=JSON.parse(e.responseText);t.result?(console.log("Скрипт загружен! Пользуйтесь меню в левом нижнем углу экрана."),availableEpisodes=JSON.parse(t.episodes),createElementsPaKPA()):(createElementsPaKPA(),console.log("Не получены эпизоды от сервиса."))},onerror:function(e){console.log("Не получены ответ от сервиса.")}}),$(document).ready((function(){$("html").on("click","#RTSHKPA",(function(){let e=document.querySelector("#nakomKPA"),t=document.querySelector("#RTSHKPA"),r=document.querySelector("#RTSTKPA"),o=document.querySelector("#otvArrKPA"),n=document.querySelector("#nbjnKPA"),s=document.querySelector("#xtimesKPA");gameId=e.value,timerType=s.value,0==gameId&&(gameId=3),s.setAttribute("style","display:none"),e.setAttribute("style","display:none"),t.setAttribute("style","display:none"),r.setAttribute("style","display:block;cursor:pointer;"),o.setAttribute("style","display:block;cursor:pointer;"),n.setAttribute("style","display:block"),gameDA(!0)})),$("html").on("click","#RTSTKPA",(function(){let e=document.querySelector("#nakomKPA"),t=document.querySelector("#RTSHKPA"),r=document.querySelector("#RTSTKPA"),o=document.querySelector("#otvArrKPA");document.querySelector("#nbjnKPA");document.querySelector("#xtimesKPA").setAttribute("style","display:block"),e.setAttribute("style","display:block"),t.setAttribute("style","display:block;cursor:pointer;"),r.setAttribute("style","display:none"),o.setAttribute("style","display:none"),gameDA(!1)}))})),XMLHttpRequest.prototype.realSend=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.send=function(e){this.addEventListener("load",(function(){if(("https://kp-guess-game-api.kinopoisk.ru/v1/games"==this.responseURL||"https://kp-guess-game-api.kinopoisk.ru/v1/questions/answers"==this.responseURL)&&0!=gameId&&null!=this&&null!=this.responseText){var e=JSON.parse(this.responseText);//!e.
if(0==lastId&&(lastId=e.stateData.question.id),null!==e.correctAnswer&&null!=e.correctAnswer&&"null"!=e.correctAnswer&&void 0!==e.correctAnswer&&"undefined"!==e.correctAnswer&&"undefined"!=e.correctAnswer||(e.correctAnswer=lastAnswer),e.isCorrect){if(e.isCorrect&&""==correctAnswer_db){t={method:"POST",url:"http://mohu.tech/dora",data:"summerKey="+tokenToServer+"&gameId="+gameId+"&lastId="+lastId+"&correct="+e.correctAnswer,headers:{"Content-Type":"application/x-www-form-urlencoded"}};GM_xmlhttpRequest(t)}}else{var t={method:"POST",url:"http://mohu.tech/dora",data:"summerKey="+tokenToServer+"&gameId="+gameId+"&lastId="+lastId+"&correct="+e.correctAnswer,headers:{"Content-Type":"application/x-www-form-urlencoded"}};GM_xmlhttpRequest(t)}if(e.isCorrect){correctAnswers_count++,document.getElementById("nbjnKPA").innerHTML="Правильных ответов: "+correctAnswers_count}if(null!=e.stateData.question&&(lastId=e.stateData.question.id),lastAnswer="","game"!=e.stateData.state){correctAnswers_count=0,document.getElementById("nbjnKPA").innerHTML="Правильных ответов: "+correctAnswers_count,setTimeout((()=>{gameStatus&&document.querySelector(".button_color_white-2").click()}),500)}}}),!1),this.realSend(e)};