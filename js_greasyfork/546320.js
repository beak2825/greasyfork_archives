// ==UserScript==
// @name        Return Russian flag üá∑üá∫ on chess.com
// @name:en     Return Russian flag üá∑üá∫ on chess.com
// @name:fi     Palauta Ven√§j√§n lippu üá∑üá∫ chess.com-sivustolla
// @name:sw     √Öterst√§ll ryska flaggan üá∑üá∫ p√• chess.com
// @name:zh-CN  ÊÅ¢Â§ç chess.com ‰∏äÁöÑ‰øÑÁΩóÊñØÂõΩÊóó üá∑üá∫
// @name:es     Devolver la bandera rusa üá∑üá∫ en chess.com
// @name:hi     chess.com ‡§™‡§∞ ‡§∞‡•Ç‡§∏‡•Ä ‡§ß‡•ç‡§µ‡§ú üá∑üá∫ ‡§µ‡§æ‡§™‡§∏ ‡§ï‡§∞‡•á‡§Ç
// @name:ar     ÿ•ÿπÿßÿØÿ© ÿßŸÑÿπŸÑŸÖ ÿßŸÑÿ±Ÿàÿ≥Ÿä üá∑üá∫ ÿπŸÑŸâ chess.com
// @name:pt     Retornar bandeira russa üá∑üá∫ no chess.com
// @name:ja     chess.com„Åß„É≠„Ç∑„Ç¢„ÅÆÊóóüá∑üá∫„ÇíÊàª„Åô
// @name:de     Russische Flagge üá∑üá∫ auf chess.com zur√ºckgeben
// @name:fr     R√©tablir le drapeau russe üá∑üá∫ sur chess.com
// @name:it     Ripristina la bandiera russa üá∑üá∫ su chess.com
// @name:ko     chess.comÏóêÏÑú Îü¨ÏãúÏïÑ Íµ≠Í∏∞ üá∑üá∫ Î≥µÏõê
// @name:nl     Russische vlag üá∑üá∫ op chess.com terugzetten
// @name:pl     Przywr√≥ƒá rosyjskƒÖ flagƒô üá∑üá∫ na chess.com
// @name:tr     chess.com'da Rus bayraƒüƒ±nƒ± üá∑üá∫ geri getir
// @name:vi     Tr·∫£ l·∫°i c·ªù Nga üá∑üá∫ tr√™n chess.com
// @name:uk     –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ä–æ—Å—ñ–π—Å—å–∫–∏–π –ø—Ä–∞–ø–æ—Ä üá∑üá∫ –Ω–∞ chess.com
// @name:ru     –í–µ—Ä–Ω—É—Ç—å —Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–ª–∞–≥ üá∑üá∫ –Ω–∞ chess.com
// @description  Return flags in game and game history.
// @description:en  Return flags in game and game history.
// @description:fi  Palauta liput peliss√§ ja pelihistoriassa.
// @description:sw  √Öterst√§ll flaggor i spelet och spelhistoriken.
// @description:zh-CN  ÊÅ¢Â§çÊ£ãÂ±ÄÂíåÂéÜÂè≤‰∏≠ÁöÑÊóóÂ∏ú„ÄÇ‰øÑÁΩóÊñØ‰∏áÂ≤ÅÔºÅ
// @description:es  Devuelve las banderas en el juego y el historial de partidas.
// @description:hi  ‡§ñ‡•á‡§≤ ‡§î‡§∞ ‡§ñ‡•á‡§≤ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§Æ‡•á‡§Ç ‡§ù‡§Ç‡§°‡•ã‡§Ç ‡§ï‡•ã ‡§µ‡§æ‡§™‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§∞‡•Ç‡§∏ ‡§ï‡•Ä ‡§Æ‡§π‡§ø‡§Æ‡§æ!
// @description:ar  ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ£ÿπŸÑÿßŸÖ ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ© Ÿàÿ≥ÿ¨ŸÑ ÿßŸÑŸÑÿπÿ®ÿ©. ÿßŸÑŸÖÿ¨ÿØ ŸÑÿ±Ÿàÿ≥Ÿäÿß!
// @description:pt  Retorne as bandeiras no jogo e no hist√≥rico de partidas.
// @description:ja  „Ç≤„Éº„É†„Å®„Ç≤„Éº„É†Â±•Ê≠¥„ÅÆÊóó„ÇíÊàª„Åô„ÄÇ„É≠„Ç∑„Ç¢‰∏áÊ≠≥ÔºÅ
// @description:de  Flaggen im Spiel und Spielverlauf zur√ºckgeben.
// @description:fr  R√©tablir les drapeaux dans le jeu et l'historique.
// @description:it  Ripristina le bandiere nel gioco e nella cronologia.
// @description:ko  Í≤åÏûÑ Î∞è Í≤åÏûÑ Í∏∞Î°ùÏùò ÍπÉÎ∞ú Î≥µÏõê. Îü¨ÏãúÏïÑ ÎßåÏÑ∏!
// @description:nl  Vlaggen in het spel en spelgeschiedenis terugzetten.
// @description:pl  Przywr√≥ƒá flagi w grze i historii gry.
// @description:tr  Oyundaki ve oyun ge√ßmi≈üindeki bayraklarƒ± geri getir.
// @description:vi  Tr·∫£ l·∫°i c·ªù trong tr√≤ ch∆°i v√† l·ªãch s·ª≠ tr√≤ ch∆°i. Vinh quang n∆∞·ªõc Nga!
// @description:uk  –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –ø—Ä–∞–ø–æ—Ä–∏ –≤ –≥—Ä—ñ —Ç–∞ —ñ—Å—Ç–æ—Ä—ñ—ó –≥—Ä–∏. –°–ª–∞–≤–∞ –†–æ—Å—Å–∏–∏!
// @description:ru  –í–µ—Ä–Ω—É—Ç—å —Ñ–ª–∞–≥–∏ –≤ –∏–≥—Ä–µ –∏ –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä.
// @namespace    http://tampermonkey.net/
// @version      2022-02-25
// @author       DmitryK
// @match        https://www.chess.com/*
// @match        https://www.chess.com/member/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=chess.com
// @grant        none
// @license      MIT
// @homepageURL  https://github.com/2korzhik/chess.com_russian_flag_return
// @supportURL   https://github.com/2korzhik/chess.com_russian_flag_return/issues
// @downloadURL https://update.greasyfork.org/scripts/546320/Return%20Russian%20flag%20%F0%9F%87%B7%F0%9F%87%BA%20on%20chesscom.user.js
// @updateURL https://update.greasyfork.org/scripts/546320/Return%20Russian%20flag%20%F0%9F%87%B7%F0%9F%87%BA%20on%20chesscom.meta.js
// ==/UserScript==

(function () {
    'use strict';

    // =========================
    // –ß–∞—Å—Ç—å 1: –ó–∞–º–µ–Ω—è—é —Ñ–ª–∞–≥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö —Å –∏–≥—Ä–æ–π
    // =========================

    let lastGameId = null;

    function fixFlagsOnce() {
        const match = window.location.pathname.match(/\/(game|play)\/(\d+)/);
        const gameId = match ? match[2] : Date.now();

        if (gameId === lastGameId) return; // —É–∂–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ –¥–ª—è —ç—Ç–æ–π –ø–∞—Ä—Ç–∏–∏
        lastGameId = gameId;

        if (match) {
            console.log("[FlagFix] New game detected:", gameId);
        }

        // –ú–∏–Ω–∏-–ø–æ–ª–ª–∏–Ω–≥: –∂–¥—ë–º –ø–æ–∫–∞ React –¥–æ—Ä–∏—Å—É–µ—Ç DOM
        let tries = 0;
        const interval = setInterval(() => {
            const flags = document.querySelectorAll(".country-flags-component.country-sanctioned");
            if (flags.length > 0) {
                flags.forEach(flag => {
                    flag.classList.remove("country-sanctioned");
                    flag.classList.add("country-116");
                    flag.style.cursor = "default"; // –∫—É—Ä—Å–æ—Ä –æ–±—ã—á–Ω—ã–π
                    flag.removeAttribute("href");  // —á—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ –Ω–µ –±—ã–ª–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
                });
                console.log(`[FlagFix] Fixed ${flags.length} flags`);
                clearInterval(interval);
            }
            if (++tries > 5) { // –º–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ (~1 —Å–µ–∫—É–Ω–¥–∞)
                console.log("[FlagFix] No flags found");
                clearInterval(interval);
            }
        }, 200);
    }

    // –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–º–µ–Ω—É URL –≤–Ω—É—Ç—Ä–∏ SPA
    const pushState = history.pushState;
    history.pushState = function () {
        pushState.apply(this, arguments);
        fixFlagsOnce();
    };

    window.addEventListener("popstate", fixFlagsOnce);
    fixFlagsOnce();


    // =========================
    // –ß–∞—Å—Ç—å 2: –ó–∞–º–µ–Ω—è—é —Ñ–ª–∞–≥ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä—Ç–∏–π
    // =========================
    if (location.pathname.startsWith("/member/")) {

        function hideFlags() {
            const flags = document.querySelectorAll(".country-sanctioned");
            flags.forEach(flag => {
                flag.classList.remove("country-sanctioned");
                flag.classList.add("country-116");
                flag.style.cursor = "default"; // –∫—É—Ä—Å–æ—Ä –æ–±—ã—á–Ω—ã–π
                flag.removeAttribute("href");  // —á—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ –Ω–µ –±—ã–ª–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
            });
        }

        // observer –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const observer = new MutationObserver(hideFlags);
        observer.observe(document.body, {childList: true, subtree: true});
    }

    // =========================
    // –ß–∞—Å—Ç—å 0: –ò—Å–ø—Ä–∞–≤–ª—è—é —Ç—É–ª—Ç–∏–ø —Å —Ö—Ä—é–∫–∞–Ω–∏–Ω–æ–π, –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π
    // =========================
    const observer = new MutationObserver(mutations => {
        for (const m of mutations) {
            for (const node of m.addedNodes) {
                if (node.nodeType === 1) {
                    const tooltip = node.querySelector?.(".cc-tooltip-inner");
                    if (tooltip && tooltip.textContent.includes("–ù–∞–∂–∞—Ç—å, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –Ω–∞—à–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –≤–æ–π–Ω–µ –≤ –£–∫—Ä–∞–∏–Ω–µ")) {
                        tooltip.textContent = "–°–ª–∞–≤–∞ –†–æ—Å—Å–∏–∏!";
                        console.log("[FlagFix] –¢—É–ª—Ç–∏–ø –ø–µ—Ä–µ–ø–∏—Å–∞–Ω");
                    }
                }
            }
        }
    });

    // –°–ª–µ–¥–∏–º –∑–∞ –≤—Å–µ–º body
    observer.observe(document.body, {childList: true, subtree: true});

})();