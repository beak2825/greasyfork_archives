// ==UserScript==
// @name         ANT Letterboxd
// @namespace    http://tampermonkey.net/
// @version      1.1
// @description  Adds Letterboxd link to film pages
// @author       EnigmaticBacon
// @match        https://anthelion.me/torrents.php?*
// @grant        none
// @license      MIT
// @downloadURL https://update.greasyfork.org/scripts/488741/ANT%20Letterboxd.user.js
// @updateURL https://update.greasyfork.org/scripts/488741/ANT%20Letterboxd.meta.js
// ==/UserScript==
(function() {
    'use strict';

    // Find the parent container to insert the new element. If not found, exit the script.
    const ratingsBox = document.querySelector('.torrent_ratings');
    if (!ratingsBox) return;

    // Function to create the Letterboxd link
    function createLetterboxdLink(imdbId, tmdbId) {
        if (imdbId) {
            return `https://letterboxd.com/imdb/${imdbId}`;
        } else if (tmdbId) {
            return `https://letterboxd.com/tmdb/${tmdbId}`;
        } else {
            return '#'; // Fallback if neither ID is available
        }
    }
    
      function createTraktLink(imdbId, tmdbId) {
        if (imdbId) {
            return `https://trakt.tv/search/imdb/${imdbId}`;
        } else if (tmdbId) {
            return `https://trakt.tv/search/imdb/${tmdbId}`;
        } else {
            return '#'; // Fallback if neither ID is available
        }
    }

    // Extract the IMDb and TMDb slugs from the page
    const imdbLinkElement = document.querySelector('a[href*="https://www.imdb.com/title/"]');
    const tmdbLinkElement = document.querySelector('a[href*="https://www.themoviedb.org/movie/"]');

    let imdbId = imdbLinkElement ? imdbLinkElement.href.match(/tt\d+/)[0] : null;
    let tmdbId = tmdbLinkElement ? new URL(tmdbLinkElement.href).pathname.split('/').pop() : null;

    // Construct the Letterboxd link
    const letterboxdLink = createLetterboxdLink(imdbId, tmdbId);
    const traktLink = createTraktLink(imdbId, tmdbId);

    const svgIconLetterBoxd = `<?xml version="1.0" encoding="UTF-8"?> <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="48px" height="48px" viewBox="0 0 48 48" version="1.1"> <g id="surface1"> <rect x="0" y="0" width="48" height="48" style="fill:rgb(12.54902%,15.686275%,18.823529%);fill-opacity:1;stroke:none;"/> <path style=" stroke:none;fill-rule:evenodd;fill:rgb(25.098039%,73.72549%,95.686275%);fill-opacity:1;" d="M 38.832031 11.269531 C 38.832031 8.226562 36.375 5.761719 33.339844 5.761719 C 30.308594 5.761719 27.851562 8.226562 27.851562 11.269531 C 27.851562 14.3125 30.308594 16.777344 33.339844 16.777344 C 36.375 16.777344 38.832031 14.3125 38.832031 11.269531 Z M 38.832031 11.269531 "/> <path style=" stroke:none;fill-rule:evenodd;fill:rgb(0%,87.843137%,32.941176%);fill-opacity:1;" d="M 29.515625 11.269531 C 29.515625 8.226562 27.054688 5.761719 24.023438 5.761719 C 20.992188 5.761719 18.53125 8.226562 18.53125 11.269531 C 18.53125 14.3125 20.992188 16.777344 24.023438 16.777344 C 27.054688 16.777344 29.515625 14.3125 29.515625 11.269531 Z M 29.515625 11.269531 "/> <path style=" stroke:none;fill-rule:evenodd;fill:rgb(100%,50.196078%,0%);fill-opacity:1;" d="M 20.195312 11.269531 C 20.195312 8.226562 17.738281 5.761719 14.707031 5.761719 C 11.675781 5.761719 9.214844 8.226562 9.214844 11.269531 C 9.214844 14.3125 11.675781 16.777344 14.707031 16.777344 C 17.738281 16.777344 20.195312 14.3125 20.195312 11.269531 Z M 20.195312 11.269531 "/> <path style=" stroke:none;fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 19.363281 14.1875 C 18.835938 13.339844 18.53125 12.339844 18.53125 11.269531 C 18.53125 10.199219 18.835938 9.199219 19.363281 8.351562 C 19.890625 9.199219 20.195312 10.199219 20.195312 11.269531 C 20.195312 12.339844 19.890625 13.339844 19.363281 14.1875 Z M 19.363281 14.1875 "/> <path style=" stroke:none;fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 28.683594 8.351562 C 29.210938 9.199219 29.515625 10.199219 29.515625 11.269531 C 29.515625 12.339844 29.210938 13.339844 28.683594 14.1875 C 28.15625 13.339844 27.851562 12.339844 27.851562 11.269531 C 27.851562 10.199219 28.15625 9.199219 28.683594 8.351562 Z M 28.683594 8.351562 "/> <path style=" stroke:none;fill-rule:evenodd;fill:rgb(100%,100%,100%);fill-opacity:1;" d="M 40.394531 29.109375 L 38.191406 29.386719 L 38.242188 22.367188 L 39.972656 22.148438 L 40.257812 23.554688 C 40.492188 22.433594 41.191406 21.898438 42.425781 21.746094 L 42.816406 21.695312 L 42.796875 24.007812 L 41.992188 24.109375 C 40.738281 24.265625 40.425781 24.753906 40.417969 26 Z M 37.375 27.265625 C 36.984375 28.789062 35.910156 29.855469 33.910156 30.105469 C 31.527344 30.40625 30.425781 29.1875 30.441406 27.023438 L 30.441406 26.816406 C 30.460938 24.566406 31.855469 23.023438 34 22.753906 C 36.429688 22.449219 37.445312 23.929688 37.433594 25.828125 L 37.425781 26.617188 L 32.582031 27.226562 C 32.683594 28.058594 33.152344 28.460938 33.980469 28.355469 C 34.585938 28.277344 34.917969 27.972656 35.089844 27.550781 Z M 34.011719 24.421875 C 33.207031 24.523438 32.742188 25.003906 32.59375 25.847656 L 35.304688 25.503906 C 35.214844 24.730469 34.816406 24.320312 34.011719 24.421875 Z M 19.863281 29.503906 C 19.472656 31.027344 18.398438 32.09375 16.398438 32.34375 C 14.015625 32.644531 12.914062 31.429688 12.929688 29.261719 L 12.929688 29.054688 C 12.945312 26.804688 14.34375 25.265625 16.488281 24.996094 C 18.917969 24.6875 19.933594 26.167969 19.921875 28.070312 L 19.914062 28.855469 L 15.070312 29.464844 C 15.167969 30.296875 15.640625 30.699219 16.46875 30.59375 C 17.074219 30.519531 17.40625 30.210938 17.574219 29.789062 Z M 16.5 26.660156 C 15.691406 26.761719 15.226562 27.242188 15.078125 28.085938 L 17.792969 27.742188 C 17.703125 26.96875 17.304688 26.558594 16.5 26.660156 Z M 24.960938 24.074219 L 24.960938 24.066406 C 25.21875 24.035156 25.398438 23.988281 25.636719 23.910156 C 26.074219 23.792969 26.242188 23.578125 26.316406 22.976562 C 26.355469 22.683594 26.375 22.4375 26.386719 22.144531 L 28.164062 21.921875 L 28.152344 23.675781 L 29.785156 23.46875 L 29.773438 25.417969 L 28.136719 25.625 L 28.125 27.304688 C 28.117188 28.515625 28.292969 28.625 29.3125 28.5 L 29.75 28.445312 L 29.734375 30.488281 L 28.644531 30.625 C 26.570312 30.886719 26.066406 30.1875 26.082031 27.996094 L 26.097656 25.878906 L 24.9375 26.027344 L 24.9375 26.023438 L 23.320312 26.226562 L 23.308594 27.910156 C 23.300781 29.117188 23.476562 29.230469 24.496094 29.101562 L 24.933594 29.046875 L 24.917969 31.089844 L 23.828125 31.230469 C 21.753906 31.488281 21.25 30.789062 21.269531 28.601562 L 21.285156 26.484375 L 20.125 26.628906 L 20.136719 24.800781 C 20.398438 24.769531 20.574219 24.722656 20.8125 24.644531 C 21.25 24.527344 21.417969 24.3125 21.496094 23.710938 C 21.53125 23.417969 21.558594 23.039062 21.574219 22.746094 L 23.347656 22.523438 L 23.335938 24.277344 Z M 12.402344 32.664062 L 6.609375 33.390625 L 6.675781 24.714844 L 8.902344 24.4375 L 8.855469 30.945312 L 12.417969 30.5 Z M 15.898438 41.917969 C 14.832031 42.042969 14.152344 41.617188 13.824219 40.871094 L 13.640625 42.011719 L 11.71875 42.238281 L 11.847656 33.324219 L 14.023438 33.066406 L 13.976562 36.34375 C 14.359375 35.535156 15.066406 35 16.046875 34.882812 C 17.617188 34.710938 18.761719 35.601562 18.730469 37.871094 L 18.726562 38.082031 C 18.695312 40.363281 17.625 41.714844 15.898438 41.917969 Z M 15.210938 40.164062 C 16.019531 40.066406 16.523438 39.507812 16.539062 38.328125 L 16.542969 38.167969 C 16.558594 37.101562 16.035156 36.632812 15.273438 36.722656 C 14.476562 36.816406 13.921875 37.472656 13.910156 38.453125 L 13.90625 38.605469 C 13.890625 39.773438 14.414062 40.257812 15.210938 40.164062 Z M 22.898438 41.089844 C 20.625 41.359375 19.386719 40.375 19.417969 38.136719 L 19.421875 37.929688 C 19.453125 35.648438 20.945312 34.304688 23.011719 34.058594 C 25.113281 33.8125 26.523438 34.847656 26.488281 37.09375 L 26.488281 37.300781 C 26.453125 39.535156 25.035156 40.835938 22.898438 41.089844 Z M 22.9375 39.269531 C 23.746094 39.175781 24.285156 38.589844 24.300781 37.539062 L 24.300781 37.351562 C 24.320312 36.253906 23.84375 35.742188 22.996094 35.84375 C 22.175781 35.941406 21.625 36.546875 21.609375 37.671875 L 21.605469 37.855469 C 21.589844 38.886719 22.125 39.367188 22.9375 39.269531 Z M 31.21875 39.933594 L 29.964844 38.183594 L 28.65625 40.234375 L 26.070312 40.542969 L 28.707031 36.738281 L 26.40625 33.796875 L 28.898438 33.503906 L 30.019531 35.070312 L 31.191406 33.230469 L 33.671875 32.9375 L 31.292969 36.410156 L 33.730469 39.636719 Z M 38.410156 39.082031 L 38.222656 37.9375 C 37.859375 38.765625 37.152344 39.359375 36.078125 39.484375 C 34.382812 39.683594 33.335938 38.640625 33.371094 36.335938 L 33.375 36.140625 C 33.40625 33.882812 34.582031 32.703125 36.1875 32.511719 C 37.203125 32.390625 37.863281 32.71875 38.203125 33.359375 L 38.25 30.199219 L 40.414062 29.945312 L 40.285156 38.859375 Z M 36.828125 37.605469 C 37.636719 37.507812 38.175781 36.890625 38.191406 35.753906 L 38.195312 35.605469 C 38.210938 34.585938 37.699219 34.066406 36.914062 34.160156 C 36.089844 34.257812 35.601562 34.859375 35.585938 35.914062 L 35.582031 36.0625 C 35.566406 37.269531 36.078125 37.691406 36.828125 37.605469 Z M 11.207031 38.738281 L 3.457031 39.734375 L 3.492188 38.273438 L 11.21875 37.28125 Z M 11.207031 38.738281 "/> </g> </svg>`;
    const svgIconTrakt = '<img src="https://walter.trakt.tv/hotlink-ok/public/favicon.svg" alt="Trakt" title="Trakt" style="width: 50px; filter: invert(16%) sepia(71%) saturate(7167%) hue-rotate(352deg) brightness(98%) contrast(90%);">';
    
    const additionalLinksDiv = document.createElement('div');
    additionalLinksDiv.className = 'box additional_links';
    additionalLinksDiv.innerHTML = `
        <div class="head"><strong>Additional Links</strong></div>
        <table class="body" style="text-align:center;">
            <tbody><tr>
                <td>
                    <a href="${letterboxdLink}" target="_blank">${svgIconLetterBoxd}</a>
                    <a href="${traktLink}" target="_blank">${svgIconTrakt}</a>
                </td>
            </tr></tbody>
        </table>
    `;

    ratingsBox.parentNode.insertBefore(additionalLinksDiv, ratingsBox.nextSibling);
})();
