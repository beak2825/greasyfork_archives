// ==UserScript==
// @name         百度网盘下载
// @namespace    https://nav.moxiaoying.top/#/list
// @version      0.0.2
// @author       moxiaoying
// @description  百度网盘下载器
// @license      MIT
// @icon         https://nd-static.bdstatic.com/m-static/v20-main/favicon-main.ico
// @match        https://pan.baidu.com/disk/main*
// @require      https://cdn.bootcdn.net/ajax/libs/vue/3.3.8/vue.global.min.js
// @require      data:application/javascript,window.Vue%3DVue%2Cwindow.VueDemi%3DVue%3B
// @require      https://cdn.bootcdn.net/ajax/libs/element-plus/2.4.2/index.full.min.js
// @require      https://cdn.bootcdn.net/ajax/libs/pinia/2.1.7/pinia.iife.min.js
// @resource     element-plus  https://cdn.bootcdn.net/ajax/libs/element-plus/2.4.2/index.min.css
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @grant        GM_setClipboard
// @grant        GM_xmlhttpRequest
// @downloadURL https://update.greasyfork.org/scripts/480654/%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E4%B8%8B%E8%BD%BD.user.js
// @updateURL https://update.greasyfork.org/scripts/480654/%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E4%B8%8B%E8%BD%BD.meta.js
// ==/UserScript==

(n=>{if(typeof GM_addStyle=="function"){GM_addStyle(n);return}const r=document.createElement("style");r.textContent=n,document.head.append(r)})(' *,:before,:after{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-pan-x: ;--un-pan-y: ;--un-pinch-zoom: ;--un-scroll-snap-strictness:proximity;--un-ordinal: ;--un-slashed-zero: ;--un-numeric-figure: ;--un-numeric-spacing: ;--un-numeric-fraction: ;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgb(0 0 0 / 0);--un-ring-shadow:0 0 rgb(0 0 0 / 0);--un-shadow-inset: ;--un-shadow:0 0 rgb(0 0 0 / 0);--un-ring-inset: ;--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgb(147 197 253 / .5);--un-blur: ;--un-brightness: ;--un-contrast: ;--un-drop-shadow: ;--un-grayscale: ;--un-hue-rotate: ;--un-invert: ;--un-saturate: ;--un-sepia: ;--un-backdrop-blur: ;--un-backdrop-brightness: ;--un-backdrop-contrast: ;--un-backdrop-grayscale: ;--un-backdrop-hue-rotate: ;--un-backdrop-invert: ;--un-backdrop-opacity: ;--un-backdrop-saturate: ;--un-backdrop-sepia: }::backdrop{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-pan-x: ;--un-pan-y: ;--un-pinch-zoom: ;--un-scroll-snap-strictness:proximity;--un-ordinal: ;--un-slashed-zero: ;--un-numeric-figure: ;--un-numeric-spacing: ;--un-numeric-fraction: ;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgb(0 0 0 / 0);--un-ring-shadow:0 0 rgb(0 0 0 / 0);--un-shadow-inset: ;--un-shadow:0 0 rgb(0 0 0 / 0);--un-ring-inset: ;--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgb(147 197 253 / .5);--un-blur: ;--un-brightness: ;--un-contrast: ;--un-drop-shadow: ;--un-grayscale: ;--un-hue-rotate: ;--un-invert: ;--un-saturate: ;--un-sepia: ;--un-backdrop-blur: ;--un-backdrop-brightness: ;--un-backdrop-contrast: ;--un-backdrop-grayscale: ;--un-backdrop-hue-rotate: ;--un-backdrop-invert: ;--un-backdrop-opacity: ;--un-backdrop-saturate: ;--un-backdrop-sepia: }[top~="12vh"]{top:12vh}.mx-2{margin-left:.5rem;margin-right:.5rem}.my-1{margin-top:.25rem;margin-bottom:.25rem}.mb-2{margin-bottom:.5rem}.mr-2{margin-right:.5rem}.mt-3{margin-top:.75rem}.h-\\[35vh\\]{height:35vh}.w-1\\/3{width:33.3333333333%}.flex{display:flex}.flex-row{flex-direction:row}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.gap-x-3{column-gap:.75rem}.gap-x-6{column-gap:1.5rem}.gap-y-4{row-gap:1rem}.border-t-2{border-top-width:2px}.border-gray-300{--un-border-opacity:1;border-color:rgb(209 213 219 / var(--un-border-opacity))}.bg-blue-950{--un-bg-opacity:1;background-color:rgb(23 37 84 / var(--un-bg-opacity))}.py-2{padding-top:.5rem;padding-bottom:.5rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-gray-600{--un-text-opacity:1;color:rgb(75 85 99 / var(--un-text-opacity))}.text-red-900{--un-text-opacity:1;color:rgb(127 29 29 / var(--un-text-opacity))} ');

(function (vue, L, pinia) {
	'use strict';

	const O=t=>{const e=GM_getResourceText(t);return GM_addStyle(e),e};O("element-plus");var q=(()=>typeof GM_setClipboard<"u"?GM_setClipboard:void 0)(),v=(()=>typeof GM_xmlhttpRequest<"u"?GM_xmlhttpRequest:void 0)();function G(){return location.href.indexOf(".baidu.com/disk/home")>0}function N(){return location.href.indexOf(".baidu.com/disk/main")>0}function E(){let t=location.pathname.replace("/disk/","");return /^\/(s|share)\//.test(t)}function I(){return G()?"old":N()?"new":E()?"share":""}function R(){let t=I();if(t==="old")return require("system-core:context/context.js").instanceForSystem.list.getSelected();if(t==="new"){let e=document.querySelector(".nd-main-list");return e||(e=document.querySelector(".nd-new-main-list")),e.__vue__.selectedList}}function J(t){t=t||4;let e="AE516JPTZaejptz258452032",n=e.length,a="";for(let o=0;o<t;o++)a+=e.charAt(Math.floor(Math.random()*n));return a}function A(){let t="";for(let e=0;e<4;e++)t+=Math.floor(Math.random()*256),e!==3&&(t+=".");return t}function z(t,e,n){return new Promise((a,o)=>{try{v({method:"POST",responseType:"json",timeout:1e4,url:`/share/set?channel=chunlei&clienttype=0&web=1&channel=chunlei&web=1&app_id=250528&bdstoken=${n}&clienttype=0`,data:`fid_list=[${t}]&schannel=4&channel_list=[]&period=1&pwd=${e}`,onload:function(r){if(r.status===200)return a(r.response);console.error(r);},ontimeout:o,onerror:o});}catch(r){return o(r)}})}const P="https://sswpdd.xyz";function B(t,e){return new Promise((n,a)=>{try{v({method:"POST",url:`${P}/parse/link`,data:JSON.stringify({fs_id:t,...e}),responseType:"json",timeout:1e4,headers:{"Content-Type":"application/json","x-forwarded-for":A()},onload:function(o){if(o.response.error===0)return n(o.response);debugger;return L.ElMessage.error(o.response.msg),a(o.response.status)},ontimeout:function(o){return L.ElMessage.error("解析链接超时"),a(o.response)}});}catch(o){debugger;return a(o)}})}function H(t,e,n){return new Promise((a,o)=>{try{v({method:"POST",timeout:1e4,url:`${P}/parse/list`,data:JSON.stringify({surl:t,pwd:e,password:n}),responseType:"json",headers:{"Content-Type":"application/json","x-forwarded-for":A()},onload:function(r){return r.status===200?a(r.response):(L.ElMessage.error("请求错误"),o("请求错误"))},ontimeout:function(r){return L.ElMessage.error("获取链接超时"),o("获取链接超时")}});}catch(r){return L.ElMessage.error(r),o(r)}})}function Z(t,e,n="http://localhost:6800/jsonrpc",a="D:SSDown"){return new Promise((o,r)=>{const i=JSON.stringify({id:"shensuDown",jsonrpc:"2.0",method:"aria2.addUri",params:[[t],{"max-connection-per-server":16,dir:a,out:e,"user-agent":"LogStatistic"}]}),_={method:"POST",responseType:"json",timeout:3e3,url:n,data:i,onload:function(l){console.log("发送至Aria2，返回：",l),l.status===200&&l.response.result?o(!0):r(!1);},ontimeout:r,onerror:r};try{v(_);}catch{r(!1);}})}function K(){return new Promise((t,e)=>{try{v({method:"GET",timeout:5e3,url:`${P}/getpass.php?get=1`,onload:function(n){return n.status===200?t(n.response):e("请求错误")}});}catch(n){return console.error(n),e(n)}})}const k=pinia.defineStore("baiduwp",{state:()=>({currentFile:{},code:"",shareId:"",pwd:"",downloadUrl:"",aria2Url:"http://localhost:16800/jsonrpc",aria2SavePath:"D:SSDown"}),actions:{async getCode(){this.code=await K();}}}),Q=vue.createElementVNode("span",{class:"text-gray-600 text-sm mb-2"},"请注意，数据会实时修改",-1),W={__name:"config",setup(t){const e=k();return (n,a)=>{const o=vue.resolveComponent("el-input"),r=vue.resolveComponent("el-form-item"),c=vue.resolveComponent("el-form");return vue.openBlock(),vue.createElementBlock(vue.Fragment,null,[Q,vue.createVNode(c,null,{default:vue.withCtx(()=>[vue.createVNode(r,{label:"Aria2保存路径",required:""},{default:vue.withCtx(()=>[vue.createVNode(o,{modelValue:vue.unref(e).aria2SavePath,"onUpdate:modelValue":a[0]||(a[0]=i=>vue.unref(e).aria2SavePath=i)},null,8,["modelValue"])]),_:1}),vue.createVNode(r,{label:"Aria2Uri",required:""},{default:vue.withCtx(()=>[vue.createVNode(o,{modelValue:vue.unref(e).aria2Url,"onUpdate:modelValue":a[1]||(a[1]=i=>vue.unref(e).aria2Url=i)},null,8,["modelValue"])]),_:1})]),_:1})],64)}}},X={class:"flex flex-row gap-x-6"},Y={class:""},j={class:"flex flex-row items-center"},ee={class:"gap-y-4"},te=vue.createElementVNode("p",{class:"text-red-900 py-2 text-2xl"},"IDM",-1),oe=vue.createElementVNode("p",{class:"text-gray-600"}," 选项 -> 下载 -> 手动添加任务时使用的用户代理（UA）-> 填入 LogStatistic。在 IDM 新建任务，粘贴链接即可下载。 ",-1),ne={class:"border-t-2 mt-3 border-gray-300"},re={class:"flex items-center gap-x-3"},ae=vue.createElementVNode("p",{class:"text-red-900 py-2 text-2xl"},"Aria2",-1),le=vue.createElementVNode("p",{class:"text-gray-600"},"点击推送到Aria2将自动下载",-1),se={__name:"file",setup(t){const e=k(),n=vue.ref(!1),a=vue.ref(!1),o=vue.ref(!1);async function r(){e.downloadUrl="",n.value=!0,console.log("开始获取链接");try{const l=await H(e.shareId,e.pwd,e.code);debugger;if(l.error!==0)return L.ElMessage.error(l.msg),null;if(l.error===0){const f=l.dirdata,y=l.filedata[0],g=await B(y.fs_id,f);e.downloadUrl=g.directlink,L.ElMessage.success("获取链接成功");}}finally{n.value=!1;}}function c(){q(e.downloadUrl,"text"),L.ElMessage.success("链接复制成功");}function i(){var l;a.value=!0,Z(e.downloadUrl,(l=e.currentFile)==null?void 0:l.formatName,e.aria2Url,e.aria2SavePath).then(f=>{L.ElMessage.success("推送至Aria2成功");}).catch(f=>{L.ElMessage.error("推送至Aria2失败"),console.log(f);}).finally(()=>{a.value=!1;});}function _(){o.value=!0,e.getCode().finally(()=>{o.value=!1;});}return (l,f)=>{const y=vue.resolveComponent("el-input"),g=vue.resolveComponent("el-button"),M=vue.resolveComponent("el-popover");return vue.openBlock(),vue.createElementBlock("div",X,[vue.createElementVNode("div",Y,[vue.createElementVNode("div",j,[vue.createVNode(y,{clearable:"",modelValue:vue.unref(e).code,"onUpdate:modelValue":f[0]||(f[0]=V=>vue.unref(e).code=V),placeholder:"请输入暗号",maxlength:4,minlength:4},null,8,["modelValue"]),vue.createVNode(g,{disabled:vue.unref(e).code.length!==4,type:"primary",class:"mx-2 my-1",loading:n.value,onClick:r},{default:vue.withCtx(()=>[vue.createTextVNode("提交 ")]),_:1},8,["disabled","loading"]),vue.createVNode(g,{type:"danger",loading:o.value,onClick:_},{default:vue.withCtx(()=>[vue.createTextVNode(" 重置验证码 ")]),_:1},8,["loading"])]),vue.createElementVNode("div",ee,[vue.createElementVNode("div",null,[te,oe,vue.withDirectives(vue.createVNode(g,{type:"danger",onClick:c},{default:vue.withCtx(()=>[vue.createTextVNode("复制链接 ")]),_:1},512),[[vue.vShow,vue.unref(e).downloadUrl]])]),vue.createElementVNode("div",ne,[vue.createElementVNode("div",re,[ae,vue.createVNode(M,{placement:"bottom",width:400,trigger:"click"},{reference:vue.withCtx(()=>[vue.createVNode(g,{type:"warning"},{default:vue.withCtx(()=>[vue.createTextVNode("设置")]),_:1})]),default:vue.withCtx(()=>[vue.createVNode(W)]),_:1})]),le,vue.withDirectives(vue.createVNode(g,{loading:a.value,type:"danger",onClick:i},{default:vue.withCtx(()=>[vue.createTextVNode("开始推送 ")]),_:1},8,["loading"]),[[vue.vShow,vue.unref(e).downloadUrl]])])])])])}}},ie={__name:"App",setup(t){const e=vue.ref(!1),n=k();async function a(){const c=R();if(c&&c.length>0){if(c[0]===n.currentFile)return console.log("文件相同，不需要再次分享"),!0;n.currentFile=c[0];}else return L.ElMessage.error("请先选择文件"),!1;const i="",_=J(4),l=await z(n.currentFile.fs_id,_,i);return l.errno===0?(n.pwd=_,n.shareId=l.link.split("/").slice(-1)[0],!0):!1}async function o(){e.value=!0,await n.getCode(),await a()||L.ElMessage.error("分享失败");}function r(){n.downloadUrl="",e.value=!1;}return (c,i)=>{var f;const _=vue.resolveComponent("el-button"),l=vue.resolveComponent("el-dialog");return vue.openBlock(),vue.createElementBlock(vue.Fragment,null,[vue.createVNode(_,{round:"",type:"danger",class:"mr-2",onClick:o},{default:vue.withCtx(()=>[vue.createTextVNode("神都下载 ")]),_:1}),vue.createVNode(l,{"close-on-click-modal":!1,modal:!1,width:"32%",top:"12vh",class:"bg-blue-950 h-[35vh]",modelValue:e.value,"onUpdate:modelValue":i[0]||(i[0]=y=>e.value=y),draggable:!0,"before-close":r,title:`您选中的文件为：	${(f=vue.unref(n).currentFile)==null?void 0:f.formatName}`},{default:vue.withCtx(()=>[vue.createVNode(se)]),_:1},8,["modelValue","title"])],64)}}};vue.createApp(ie).use(L).use(pinia.createPinia()).mount((()=>{const t=document.createElement("div");return document.querySelector(".wp-s-agile-tool-bar__header").prepend(t),t})());

})(Vue, ElementPlus, Pinia);