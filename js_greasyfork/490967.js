// ==UserScript==
// @name        JKLM Cheat 1.6
// @namespace   JKLM Cheat 1.6
// @author      Macadelic
// @version     1.6
// @require     https://code.jquery.com/jquery-3.7.1.min.js
// @description JKLM.FUN Overlay
// @match        https://jklm.fun/*
// @match        https://*.jklm.fun/games/bombparty/
// @match        https://jklm.macadelic.me/*
// @match        *://*.jklm.dannyhpy.wip.la/*
// @match        https://*.jklm.macadelic.me/games/bombparty/
// @match        http://jklm.macadelic.me/*
// @match        http://*.jklm.macadelic.me/games/bombparty/
// @grant       unsafeWindow
// @license MIT 
// @downloadURL https://update.greasyfork.org/scripts/490967/JKLM%20Cheat%2016.user.js
// @updateURL https://update.greasyfork.org/scripts/490967/JKLM%20Cheat%2016.meta.js
// ==/UserScript==

function roomScript(){console.log("Room Script started - 1.6");var e=null,t=null,n=!0,o=!1,a=!1,l="random",i=null,s=null,r=null;function c(e,t){void 0!==t?document.querySelector("iframe").contentWindow.postMessage({name:e,data:t},"*"):document.querySelector("iframe").contentWindow.postMessage({name:e},"*")}function d(){$("#wordDisplay").empty(),t.forEach(e=>{var t=e.word.toUpperCase(),a=i.toUpperCase();const l=t.indexOf(a),r=n,c=o;if(r&&c){t=t.toLowerCase();const e=s;let n=t.indexOf(i),o=n+i.length,a="";for(let l=0;l<t.length;l++){let s=t[l];if(l===n)a+="<span style='color: #00ff00;'>"+i.toUpperCase()+"</span>",l=o-1;else{if(l>=n&&l<o)continue;e[s]?a+="<span style='color: red;'>"+s.toUpperCase()+"</span>":a+=s.toUpperCase()}}t=a}else if(r&&(t=t.substring(0,l)+"<span style='color: #00ff00;'>"+i.toUpperCase()+"</span>"+t.substring(l+i.length)),c){const e=s;let n="";t.split("").forEach(t=>{const o=t.toUpperCase();e.hasOwnProperty(o.toLowerCase())&&e[o.toLowerCase()]>0?n+="<span style='color: red;'>"+t+"</span>":n+=t}),t=n}const d=$("<div>").html(t);d.css({color:"white","text-align":"left","font-size":"20px"}),$("#wordDisplay").append(d)})}window.addEventListener("message",function(e){"selectedWordsChange"===e.data.name&&(t=e.data.data.selectedWords),"updateGameVariables"===e.data.name&&(i=e.data.data.syllable,s=e.data.data.currentPlayerBonusLetters),"display"===e.data.name&&d(),"updateNewDictionary"===e.data.name&&(r=e.data.data.newDictionary,$("#newWordDictionary").text(`üìä ${r.length} nouvelles occurrences charg√©s`))}),$(".tabs").append('<a href="#" class="cheat" title="Cheat">üîß</a>'),$(".sidebar").append('<div class="cheat pane" hidden></div>'),$(".darkSettings > fieldset .label").css("background-color","rgba(255, 255, 255, 0.1)"),$(".sidebar > .pane.cheat").html('\n    <div class="darkSettings darkScrollbar">\n        <fieldset>\n            <div class="setting display">\n                <div class="label">üñ•Ô∏è Affichage</div>\n                <div class="field" id="wordDisplay"></div>\n            </div>\n        </fieldset>\n        <fieldset>\n            <div class="setting dictionnary">\n                <div class="label">üìô Dictionnaire</div>\n                <div class="field"></div>\n            </div>\n        </fieldset>\n        <fieldset>\n            <div class="setting misc">\n                <div class="label">‚öôÔ∏è Options</div>\n                <div class="field"></div>\n            </div>\n        </fieldset>\n    </div>\n    '),$(".pane.cheat .dictionnary > .field").html('\n    <p>S√©lectionner un fichier texte contenant le dictionnaire √† charger (format .txt)</p>\n    <p>Il est possible de fournir un fichier texte contenant l\'occurrence de chaque mot, avec le format "mot;occurrence" pour chaque ligne</p>\n    <div class="formGroup" id="formGroupDictionary" title="Importer une liste de mots.">\n        <input type="file" accept="text/plain" id="importDictionnary" />\n        <br><br>\n        <input type="button" id="downloadDictionary" value="Exporter le nouveau dictionnaire"></input>\n        <br><br>\n        <label id="wordCountLabel"></label>\n        <br>\n        <label id="newWordDictionary"></label>\n    </div>\n    '),$(".pane.cheat .display > .field").html("\n    <p>Un dictionnaire doit √™tre fourni pour l'affichage des mots</p>\n    "),$(".pane.cheat .misc > .field").html('\n    <p>G√©rer les param√®tres li√©s √† l\'affichage des mots</p>\n    <div class="formGroup" title="Mettre en surbrillance dans l\'affichage">\n        <label>Mettre en surbrillance la syllabe</label>\n        <select id="highlightSyllable" data-type="boolean">\n            <option value="1" selected>Activ√©</option>\n            <option value="2">D√©sactiv√©</option>\n        </select>\n        <label>Mettre en surbrillance les lettres bonus</label>\n        <select id="highlightBonusLetters" data-type="boolean">\n            <option value="1">Activ√©</option>\n            <option value="2" selected>D√©sactiv√©</option>\n        </select>\n        <label>Afficher une fen√™tre flotante</label>\n        <select id="showWordFloat" data-type="boolean">\n            <option value="1">Activ√©</option>\n            <option value="2" selected>D√©sactiv√©</option>\n        </select>\n    </div>\n    <label>Triage l\'affichage des mots</label>\n    <select id="sortMode">\n        <option value="1" selected>Al√©atoire</option>\n        <option value="2">Occurrence</option>\n        <option value="3">Lettres bonus</option>\n    </select>\n    '),$(".tabs > a").on("click",e=>{const t=$(e.target),n=t.attr("class").split(" ")[0];if("cheat"!==n)return;const o=$(".tabs > a.active").attr("class").split(" ")[0],a=$(".tabs > a.active");$(`.sidebar > .${o}.pane`).prop("hidden",!0),a.removeClass("active"),$(`.sidebar > .pane.${n}`).prop("hidden",!1),t.addClass("active")}),$("#importDictionnary").on("change",async function(t){!function(t){const n=new FileReader;n.onload=function(t){const n=t.target.result,o=n.split("\n"),a=(e=o.map(e=>{const[t,n]=e.split(";").map(e=>e.trim());return{word:t,occurrences:n?parseInt(n):1}})).length;$("#wordCountLabel").text(`‚úÖ ${a} mots charg√©s`),c("dictionaryLoaded",e)},n.readAsText(t)}(t.target.files[0])}),$("#showWordFloat").on("change",function(){const e=$(this).val();"1"===e?a=!0:"2"===e&&(a=!1),c("showFloatingElement",{show:a})}),$("#highlightSyllable").on("change",function(){const t=$(this).val();"1"===t?n=!0:"2"===t&&(n=!1),null!=e&&null!=i&&(d(),c("updateHighlightVariables",{highlightSyllable:n,highlightBonusLetters:o}),c("displayFloatingElement"))}),$("#highlightBonusLetters").on("change",function(){const t=$(this).val();"1"===t?o=!0:"2"===t&&(o=!1),null!=e&&null!=i&&(d(),c("updateHighlightVariables",{highlightSyllable:n,highlightBonusLetters:o}),c("displayFloatingElement"))}),$("#sortMode").on("change",function(){const t=$(this).val();"1"===t?l="random":"2"===t?l="occurrence":"3"===t&&(l="bonusLetters"),null!=e&&null!=i&&(c("sortModeChange",{sortMode:l}),d(),c("displayFloatingElement"))}),$("#downloadDictionary").on("click",function(){if(null==e)alert("Une erreur s'est produite. Veuillez d'abord importer un dictionnaire.");else if(null!=e&&null==r)alert("Une erreur s'est produite. Aucun nouveau mot n'a √©t√© enregistr√©.");else if(null!=e&&null!=r){!function(e,t){var n="";for(var o in e)n+=e[o].word+";"+e[o].occurrences+"\n";const a=new Blob([n],{type:"text/plain"}),l=window.URL.createObjectURL(a),i=document.createElement("a");i.href=l,i.download=t,i.click(),window.URL.revokeObjectURL(l)}(function(e,t){for(var n={},o=0;o<t.length;o++){var a=t[o].word,l=t[o].occurrences;n[a]=l}for(var i=0;i<e.length;i++){var s=e[i].word,r=e[i].occurrences;s in n?n[s]+=r:n[s]=r}var c=[];for(var d in n)c.push({word:d,occurrences:n[d]});return c}(e,r),"newDictionary")}})}function gameScript(){console.log("Room Script started - 1.6");var e=[],t=null,n=null,o=null,a=[],l=null,i="random",s=!0,r=!1,c=[];let d,u,p,f,h=!1;function g(e,t){void 0!==t?window.parent.postMessage({name:e,data:t},"*"):window.parent.postMessage({name:e},"*")}window.addEventListener("message",function(e){"dictionaryLoaded"===e.data.name&&(l=e.data.data,L()),"showFloatingElement"===e.data.name&&(e.data.data.show?$("#floatingElement").prop("hidden",!1):$("#floatingElement").prop("hidden",!0)),"sortModeChange"===e.data.name&&(i=e.data.data.sortMode,null!=l&&null!=n&&b()),"displayFloatingElement"===e.data.name&&C(),"updateHighlightVariables"===e.data.name&&function(e){s=e.highlightSyllable,r=e.highlightBonusLetters}(e.data.data)}),$(".middle").append('\n        <div id="floatingElement" class="floating-element" hidden>\n            <div class="field" id="wordDisplayFloating"></div>\n        </div>\n        <style>\n        .floating-element {\n            position: absolute;\n            background-color: rgba(241, 241, 241, 0.05);\n            padding: 10px;\n            cursor: move;\n            border-radius: 10px;\n        },\n        </style>'),$("#floatingElement").mousedown(function(e){h=!0,d=e.clientX,u=e.clientY,p=$("#floatingElement").offset().left,f=$("#floatingElement").offset().top}),$(document).mouseup(function(){h=!1}),$(document).mousemove(function(e){if(h){const t=e.clientX-d,n=e.clientY-u,o=$(".middle").width(),a=$(".middle").height(),l=$("#floatingElement").width(),i=$("#floatingElement").height();let s=p+t,r=f+n;s<0?s=0:s+l>o&&(s=o-l),r<0?r=0:r+i>a&&(r=a-i),$("#floatingElement").css({left:s+"px",top:r+"px"})}});class m{constructor(e=null,t=null,n=null,o=null){this.peerId=e,this.nickname=t,this.language=n,this.roles=o,this.bonusLetters=[],this.word=""}updateGeneralInfo(e){this.auth(e[2].auth),this.language(e[2].language),this.nickname(e[2].nickname),this.peerId(e[2].peerId),this.roles(e[2].roles)}updateGameInfo(){this.word=""}}function w(t){return e.find(e=>e.peerId===t)||null}function v(e){const t={};for(const n in e)e.hasOwnProperty(n)&&e[n]>0&&(t[n]=e[n]);return t}function b(){"random"==i?function(){const e=l.filter(e=>e.word.includes(n)&&!a.includes(e.word)),o=Math.min(e.length,10),i=function(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}(e);t=i.slice(0,o)}():"occurrence"==i?function(){const e=l.filter(e=>e.word.includes(n)&&!a.includes(e.word)).sort((e,t)=>t.occurrences-e.occurrences),o=Math.min(e.length,10);t=e.slice(0,o)}():"bonusLetters"==i&&function(){const e=l.filter(e=>{if(e.word.includes(n)&&!a.includes(e.word)){const t=e.word.toLowerCase().split("");let n=0;for(const e of t)o[e]>0&&n++;return e.missingBonusLetters=n,!0}return!1}).sort((e,t)=>t.missingBonusLetters-e.missingBonusLetters);t=e.slice(0,10)}(),g("selectedWordsChange",{selectedWords:t})}function y(e,t){g("updateGameVariables",{syllable:n,currentPlayerBonusLetters:t})}function L(){null!=l&&null!=n&&(b(),null!=t&&(g("display"),C()))}function C(){$("#wordDisplayFloating").empty(),t.forEach(e=>{var t=e.word.toUpperCase(),a=n.toUpperCase();const l=t.indexOf(a),i=s,c=r;if(i&&c){let a=e.word.toLowerCase();const l=o;let i=a.indexOf(n),s=i+n.length,r="";for(let e=0;e<a.length;e++){let t=a[e];if(e===i)r+="<span style='color: #00ff00;'>"+n.toUpperCase()+"</span>",e=s-1;else{if(e>=i&&e<s)continue;l[t]?r+="<span style='color: red;'>"+t.toUpperCase()+"</span>":r+=t.toUpperCase()}}t=r}else if(i&&(t=t.substring(0,l)+"<span style='color: #00ff00;'>"+n.toUpperCase()+"</span>"+t.substring(l+n.length)),c){const e=o;let n="";t.split("").forEach(t=>{const o=t.toUpperCase();e.hasOwnProperty(o.toLowerCase())&&e[o.toLowerCase()]>0?n+="<span style='color: red;'>"+t+"</span>":n+=t}),t=n}const d=$("<div>").html(t);d.css({color:"white","text-align":"left","font-size":"20px"}),$("#wordDisplayFloating").append(d)})}socket.on("setup",t=>{for(const n of t.players)e.push(new m(n.profile.peerId,n.profile.nickname,n.profile.language,n.profile.roles));switch(t.milestone.name){case"round":var a=v(w(t.milestone.currentPlayerPeerId).bonusLetters);n=t.milestone.syllable,t.milestone.currentPlayerPeerId,y(0,o=a),L(),e.forEach(e=>{e.updateGameInfo();const n=t.milestone.playerStatesByPeerId[e.peerId];n&&n.bonusLetters&&(e.bonusLetters=n.bonusLetters)})}}),socket.on("setMilestone",t=>{switch(t.name){case"round":var a=v(w(t.currentPlayerPeerId).bonusLetters);n=t.syllable,t.currentPlayerPeerId,y(0,o=a),L(),e.forEach(e=>{e.updateGameInfo();const n=t.playerStatesByPeerId[e.peerId];n&&n.bonusLetters&&(e.bonusLetters=n.bonusLetters)});break;case"seating":e=[]}}),socket.on("setPlayerWord",(e,t,n)=>{w(e).word=t}),socket.on("nextTurn",(e,t,a)=>{var l=v(w(e).bonusLetters);n=t,e,y(0,o=l),L()}),socket.on("correctWord",({playerPeerId:e,bonusLetters:t})=>{let n=w(e);n.bonusLetters=t;var o=n.word.replace(/[^a-zA-Z-']/gi,"");a.push(o),function(e){var t=c.find(t=>t.word===e);t?t.occurrence++:c.push({word:e,occurrences:1})}(o),g("updateNewDictionary",{newDictionary:c})}),socket.on("addPlayer",t=>{!function(t){e.push(new m(t.profile.peerId,t.profile.nickname,t.profile.language,t.profile.roles))}(t)}),socket.on("removePlayer",t=>{!function(t){const n=e.findIndex(e=>e.peerId===t);-1!==n&&e.splice(n,1)}(t)})}window.addEventListener("load",function(){window.top==window.self?roomScript():window.top!==window.self&&gameScript()});