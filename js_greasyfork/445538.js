// ==UserScript==
// @name MAM Auto Gift All
// @namespace zzz
// @description (3/11/23) Gifts new users every 20 minutes on gift days so as not to miss one
// @match https://www.myanonamouse.net/index.php
// @match https://www.myanonamouse.net/
// @icon  https://cdn.myanonamouse.net/imagebucket/164109/Mgift64.png
// @version 1.1
// @license MIT
// @run-at document-end
// @grant unsafeWindow
// @grant window.close
// @grant window.focus
// @grant window.onurlchange
// @grant       GM_setValue
// @grant       GM_getValue
// @grant       GM_deleteValue
// @grant       GM_listValues
// @grant       GM_addElement
// @downloadURL https://update.greasyfork.org/scripts/445538/MAM%20Auto%20Gift%20All.user.js
// @updateURL https://update.greasyfork.org/scripts/445538/MAM%20Auto%20Gift%20All.meta.js
// ==/UserScript==
/*jshint esversion: 6 */

// Function from https://stackoverflow.com/questions/41296950/
const milliseconds = (h, m, s) => ((h*60*60+m*60+s)*1000);

let DEBUG =1; // Debugging mode on (1) or off (0)

if (DEBUG) console.log("MAM Auto Gift All"); // Just making sure we're watching the right console window

// Specify page reload time in hours, minutes, and seconds
// 20 minutes in gift times, 3 hours other times v1.0
// Get current date and time in GMT
var nows = new Date().toUTCString();
// Extract day of week, hour and minute (Generated by Bing AI)
var day = nows.split(",")[0];
var hour = nows.slice(-12,-10); // AI was off by 1 (-13,-11) got space and first digit
//var minute = nows.slice(-10,-8); //This may be off too, but unneeded
var rtime = "20 minutes";

// Compare with ranges v 1.0
if (DEBUG) console.log("Checking time ranges");
var reloadTime = milliseconds(0, 20, 0); // Never set below 60 seconds! <--* const broke 1.0, var fixed, WHY?
if ((day == "Sat" && hour >= "08") || (day == "Sun" && hour <= "09") || (day == "Wed" && hour >= "08") || (day == "Thu" && hour <= "09")) {
  // We are in a signup period
    if (DEBUG) console.log("It is sign up time!");
  // Do nothing, initialized to 20 minutes above
} else {
  // We are NOT in a signup period
  reloadTime = milliseconds(1, 0, 0);
    rtime = "1 hour"
  if (DEBUG) console.log("It is NOT sign up time!");
}

let headr = document.querySelector("div[class='blockHeadCon']"); //v.75 moved to 1st header
let now = new Date();
headr.innerText = "Loaded at: " + now.toUTCString();
now.setMilliseconds(now.getMilliseconds() + reloadTime);
headr.innerText += " -> Reloading at: " + now.toUTCString() + " or locally " + now.toLocaleString();

function auto_reload()
{
	window.location = 'https://www.myanonamouse.net/index.php';
}

setTimeout(safeReload,reloadTime); // Works in Tampermonkey etc. v1.0 safe reload


setTimeout(function(){
let giftall = document.querySelector("#mp_giftAll"); //Fails when MAM+ isn't finished first
if (DEBUG) console.log("giftall: ",giftall);
if (giftall !== null) {
	giftall.style.backgroundColor="SpringGreen"; // Show auto gift running
	if (DEBUG) console.log("Setting timer to click in 20 seconds");
	setTimeout(function(){	// Give a little time to see debug info before reloading
	giftall.dispatchEvent(new MouseEvent('click'));
    giftall.style.backgroundColor="Blue"; // Show running, or waiting for reload
	if (DEBUG) console.log("Clicked Gift All button, will reload in " + rtime);
	}, 30000);
	} else {
      if (!document.querySelector("meta[http-equiv='refresh']")) setTimeout(safeReload,10000); //If MAM+ failed to load, reload in 10 seconds instead of 20 minutes, unless MAM is down
    }
}, 10000); // Give MAM+ 10 seconds to Initialize the Gift Button

// *** New Code to prevent death by internet outage, and run and outage logs ***

if (DEBUG) console.log("Beginning Online Check section");
let elc = document.querySelector("div[id='mainBody'] div[class='blockFoot']"); //Bar under table
elc.innerHTML = "<span id='status'> - Online - </span>";
createButton(elc, "Reload if STILL Online", safeReload, "MTT_Buttn");
const statusDisplay = document.getElementById("status");
const imgurl= "https://www.myanonamouse.net/pic/anchor-icon.png";
 //will this work on cdn instead of www?  That'd be less load on server, but this assures server is up too.
var timestmp;
var LOGGING = 0; // "Use var or const instead of let" Bing AI Chat bot bug fix!
    //When LOGGING >0 we have gone offline.
var maxLogLength = 200; // Limit on GM storage use

// Define the height and width of the textarea in lines and characters
var height = 10;
var width = 30;
// Define the list of lognames and logtitle pairs
// This should work for three logs, four if shorter timestamps
var logList = [
    {logname: 'ulog', logtitle: 'Up/Down MAM Reachable log'},
    {logname: 'rlog', logtitle: 'Reload log'}
];
// May add a third log of purchases

if (DEBUG) console.log("calling createTable");
// Call the create table function
createTable(height, width, logList);

// Define the function to create a table
function createTable(height, width, logList) {
        // Create a table element
        var table = GM_addElement(document.body, 'table');
        // Set the table style
        table.style.border = '1px solid black';
        table.style.margin = '10px';
        // Create a table header row
        var header = GM_addElement(table, 'tr');
// Loop through the logList array
for (let i = 0; i < logList.length; i++) {
    // Create a table header cell for the current log
    var logtitle = GM_addElement(header, 'th');
    // Set the text content to the current logtitle
    logtitle.textContent = logList[i].logtitle;
}
    // Create a table row for textareas
    var textareaRow = GM_addElement(table, 'tr');
    // Set the colspan attribute to span across three columns
    textareaRow.setAttribute('colspan', '3');
    // Loop through the logList
for (var i = 0; i < logList.length; i++) {
    // Get the logname and logtitle pair
    var log = logList[i];
    // Create a table cell for textarea
    var textareaCell = GM_addElement(textareaRow, 'td');
    // Create a textarea element
    var textArea = GM_addElement(textareaCell, 'textarea');
    // Set the textarea style
    textArea.style.resize = 'both';
    textArea.style.height = height + 'em';
    textArea.style.width = width + 'em';
    // Get the log content from the local storage
    var logContent = GM_getValue(log.logname, '');
    // Remove the quotes from each line
    logContent = logContent.replace(/"/g, '');
    // Replace the comma separating the lines with a line break
    logContent = logContent.replace(/,/g, '\n');
    logContent = logContent.substring(1, logContent.length - 1); // remove [ ], could also use replace(/^\[|\]$/g, '');

	// Set the textarea value
	textArea.value = logContent;
	// Autoscroll to the bottom
    textArea.scrollTop = textArea.scrollHeight;
	// Add a property to store the reference to the text area
	log.textarea = textArea;
    }
}

//function to append lines to the appropriate text area for a log, by log name
function appendLineToLog(logname, logline) {
    for (let i = 0; i < logList.length; i++) {
        let log = logList[i];
        if (log.logname == logname) { //find the matching log object
            let textArea = log.textarea; //get the textarea element
            // Avoid duplicate timestamp someday
            let sep = ": "; if (logline.length == 0) sep =""; //skip separator if no message
            if (DEBUG) console.log("sep: " + sep);
            textArea.value += '\n' + new Date().toLocaleString().replace(/,/g, "") + sep + logline; //append the new line with n character
            textArea.scrollTop = textArea.scrollHeight; //scroll to the bottom
            break; //exit the loop
        }
    }
}
// An alternate approach would be to use the log's index 0,1,...
// Append a new line of text to the first log's text area
// appendLine(logList[0].textarea, "This is a new line of text");

// Appends a new line of text to a given text area
function appendLine(textArea, newText) {
  // Add a line break and then the new text
  textArea.value += "\n" + newText;

  // Autoscroll to the bottom
  textArea.scrollTop = textArea.scrollHeight;
}

// Write to log and text area at the same time
function logToBoth(logname, message) {
  // Call the logToGM_setValue function to write to the logfile
  logToGM_setValue(logname, message);
  // Call the appendLineToLog function to write to the textarea
  appendLineToLog(logname, message); //Did not include timestamp
}


// *** The next three functions accompish online Internet Up or Down detection without leaving our target URL!

// Operates on boolian status results from checkServer callback
// **** This is where we respond to online status changes, and now reload if safe ****
function ReloadIfOnline(status){
now = new Date();
timestmp = now.toLocaleString().replace(/,/g, "");
//if (DEBUG) console.log(timestmp + ": Safe Reload clicked"); // Wrong timestamp as delayed by callback v.8
if (status) { statusDisplay.textContent = " - ONline - ";
    if (DEBUG) {console.log("Reload code run at: " + now.toLocaleString() );
              if (LOGGING) console.log(timestmp + ": Internet back up");
               }
    if (LOGGING) { logToBoth("ulog"," Up" );
                  //logToGM_setValue("ulog"," Back up" ); Removed v1.2
                  //appendLine(logList[0].textarea, timestmp + " Back up");
                  LOGGING = 1;
                 }
logToBoth("rlog","" );
// reload code goes here:
 auto_reload();
}
else { statusDisplay.textContent = " - OFFline - ";
   if (DEBUG) {console.log(timestmp + ": Recheck online timer scheduled");
               if (LOGGING) console.log(timestmp + ": Internet offline");
              }
   if (!LOGGING) { now = new Date(); //v.9
       logToBoth("ulog"," Down");
   }
      LOGGING = 1; // This didn't work until I changed let to var in declaring this boolean
      setTimeout(safeReload, 30000); // Creates a loop checking for restored connection every 30 seconds
    }
//if (DEBUG) console.log("GM_listValues(): " + GM_listValues());
}

// Called by test button, or by script when it's time to check a page again for something to do.
// Actual page reload would be done in the ReloadIfOnline callback function
function safeReload(){
now = new Date();
timestmp = now.toLocaleString().replace(/,/g, "");
if (DEBUG) console.log(timestmp + ": Safe Reload clicked");
    // Timestamp debug log moved here!  v.9
   // logToBoth("rlog"," Offline");
checkServer(ReloadIfOnline);
}

// https://stackoverflow.com/questions/5224197/javascript-check-if-server-is-online
function checkServer(callback) {
    statusDisplay.textContent = " - Checking - ";
    let img = new Image();
    img.onload = function() { callback(true); };
    img.onerror = function() { callback(false); };
    img.src = imgurl + '?r=' + Math.random(); /* avoids caching */
}

function logToGM_setValue(logname, message) {
  // Get the current log array from GM_setValue or create a new one
  var log = JSON.parse(GM_getValue(logname,null)) || [];
//if (DEBUG > 0) console.log("log: " + log);
  // Push the message to the log array with a timestamp
let str = new Date().toLocaleString().replace(/,/g, "") + ": " + message;
  log.push(str);
if (DEBUG > 0) console.log(logname + ": " + str);
  // Trim the log array if it exceeds maxLogLength lines
  if (log.length > maxLogLength) {
    log = log.slice(-maxLogLength);
  }
if (DEBUG > 0) console.log("logToGM log.length: " + log.length);

  // Save the log array back to GM_setValue
  GM_setValue(logname, JSON.stringify(log));
if (DEBUG) {console.log("GM_listValues(): " + GM_listValues());
            console.log(JSON.stringify(log));
           }
}


// Similar to https://stackoverflow.com/questions/45056949/adding-button-to-specific-div
function createButton(elemnt, value, func, id, color) {
  var button = document.createElement("input");
  button.type = "button";
  if (id) button.id = id; //won't work for falsy ids like 0 or NaN
  button.value = value; //button label or in some cases set name
  color = color || "White";
  button.style.backgroundColor = color;
  button.style.borderRadius = "10%";
  button.onclick = func;
  elemnt.appendChild(button);
}
