// ==UserScript==
// @name         中国教师研修网
// @namespace    https://nav.moxiaoying.top/#/list
// @version      0.3.3
// @author       moxiaoying
// @description  点击开始运行后就什么都不用管了，脚本会自动查看是否完成所有任务
// @icon         https://srt-read-online.3ren.cn/basebusiness/headimg/20200711/1594463211851X00rZyPRV8-23.png
// @match        https://ipx.yanxiu.com/grain/course/*
// @match        https://ipx.yanxiu.com/train/workspace*
// @match        https://ipx.yanxiu.com/train/guide/course/list*
// @require      https://cdn.jsdelivr.net/npm/vue@3.3.8/dist/vue.global.prod.js
// @require      data:application/javascript,window.Vue%3DVue%2Cwindow.VueDemi%3DVue%3B
// @require      https://cdn.jsdelivr.net/npm/element-plus@2.4.2/dist/index.full.min.js
// @require      https://cdn.jsdelivr.net/npm/pinia@2.1.7/dist/pinia.iife.min.js
// @require      https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js
// @resource     element-plus/dist/index.css  https://cdn.jsdelivr.net/npm/element-plus@2.4.2/dist/index.css
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @downloadURL https://update.greasyfork.org/scripts/435552/%E4%B8%AD%E5%9B%BD%E6%95%99%E5%B8%88%E7%A0%94%E4%BF%AE%E7%BD%91.user.js
// @updateURL https://update.greasyfork.org/scripts/435552/%E4%B8%AD%E5%9B%BD%E6%95%99%E5%B8%88%E7%A0%94%E4%BF%AE%E7%BD%91.meta.js
// ==/UserScript==

(n=>{if(typeof GM_addStyle=="function"){GM_addStyle(n);return}const u=document.createElement("style");u.textContent=n,document.head.append(u)})(" *,:before,:after{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-pan-x: ;--un-pan-y: ;--un-pinch-zoom: ;--un-scroll-snap-strictness:proximity;--un-ordinal: ;--un-slashed-zero: ;--un-numeric-figure: ;--un-numeric-spacing: ;--un-numeric-fraction: ;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgb(0 0 0 / 0);--un-ring-shadow:0 0 rgb(0 0 0 / 0);--un-shadow-inset: ;--un-shadow:0 0 rgb(0 0 0 / 0);--un-ring-inset: ;--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgb(147 197 253 / .5);--un-blur: ;--un-brightness: ;--un-contrast: ;--un-drop-shadow: ;--un-grayscale: ;--un-hue-rotate: ;--un-invert: ;--un-saturate: ;--un-sepia: ;--un-backdrop-blur: ;--un-backdrop-brightness: ;--un-backdrop-contrast: ;--un-backdrop-grayscale: ;--un-backdrop-hue-rotate: ;--un-backdrop-invert: ;--un-backdrop-opacity: ;--un-backdrop-saturate: ;--un-backdrop-sepia: }::backdrop{--un-rotate:0;--un-rotate-x:0;--un-rotate-y:0;--un-rotate-z:0;--un-scale-x:1;--un-scale-y:1;--un-scale-z:1;--un-skew-x:0;--un-skew-y:0;--un-translate-x:0;--un-translate-y:0;--un-translate-z:0;--un-pan-x: ;--un-pan-y: ;--un-pinch-zoom: ;--un-scroll-snap-strictness:proximity;--un-ordinal: ;--un-slashed-zero: ;--un-numeric-figure: ;--un-numeric-spacing: ;--un-numeric-fraction: ;--un-border-spacing-x:0;--un-border-spacing-y:0;--un-ring-offset-shadow:0 0 rgb(0 0 0 / 0);--un-ring-shadow:0 0 rgb(0 0 0 / 0);--un-shadow-inset: ;--un-shadow:0 0 rgb(0 0 0 / 0);--un-ring-inset: ;--un-ring-offset-width:0px;--un-ring-offset-color:#fff;--un-ring-width:0px;--un-ring-color:rgb(147 197 253 / .5);--un-blur: ;--un-brightness: ;--un-contrast: ;--un-drop-shadow: ;--un-grayscale: ;--un-hue-rotate: ;--un-invert: ;--un-saturate: ;--un-sepia: ;--un-backdrop-blur: ;--un-backdrop-brightness: ;--un-backdrop-contrast: ;--un-backdrop-grayscale: ;--un-backdrop-hue-rotate: ;--un-backdrop-invert: ;--un-backdrop-opacity: ;--un-backdrop-saturate: ;--un-backdrop-sepia: } ");

(function (vue, B, pinia, X) {
	'use strict';

	function Q(){const e=window.unsafeWindow||document.defaultView||window,t=e.document,r=new WeakMap;let n="css",s;const a=e.Element.prototype,S=a.matches||a.matchesSelector||a.webkitMatchesSelector||a.mozMatchesSelector||a.oMatchesSelector,u=e.MutationObserver||e.WebkitMutationObserver||e.MozMutationObserver;function y(c,i){const o=new u(f=>{for(const l of f){if(l.type==="attributes"&&(i(l.target),o.canceled))return;for(const d of l.addedNodes)if(d instanceof Element&&i(d),o.canceled)return}});return o.canceled=!1,o.observe(c,{childList:!0,subtree:!0,attributes:!0}),()=>{o.canceled=!0,o.disconnect();}}function p(c,i){let o=r.get(c);o||(o={filters:new Set,remove:y(c,f=>o.filters.forEach(l=>l(f)))},r.set(c,o)),o.filters.add(i);}function w(c,i){const o=r.get(c);o&&(o.filters.delete(i),o.filters.size||(o.remove(),r.delete(c)));}function g(c,i,o,f,l){switch(l){case"css":const d=f&&S.call(o,i);if(c){const I=o.querySelectorAll(i);return d?[o,...I]:[...I]}return d?o:o.querySelector(i);case"jquery":let m=s(f?o:[]);return m=m.add([...o.querySelectorAll("*")]).filter(i),c?s.map(m,I=>s(I)):m.length?s(m.get(0)):null;case"xpath":const h=o.ownerDocument||o;if(i+="/self::*",c){const I=h.evaluate(i,o,null,7,null),_=[];for(let j=0;j<I.snapshotLength;j++)_.push(I.snapshotItem(j));return _}return h.evaluate(i,o,null,9,null).singleNodeValue}}function C(c){return c&&c.fn&&typeof c.fn.jquery=="string"}function x(c,i,o){const f=n;return new Promise(l=>{const d=g(!1,c,i,!1,f);if(d)return l(d);let m;const h=I=>{const _=g(!1,c,I,!0,f);_&&(w(i,h),m&&clearTimeout(m),l(_));};p(i,h),o>0&&(m=setTimeout(()=>{w(i,h),l(null);},o));})}return {get currentSelector(){return n},get(c,...i){let o=typeof i[0]!="number"&&i.shift()||t;n==="jquery"&&o instanceof s&&(o=o.get(0));const f=i[0]||0;return Array.isArray(c)?Promise.all(c.map(l=>x(l,o,f))):x(c,o,f)},each(c,...i){let o=typeof i[0]!="function"&&i.shift()||t;n==="jquery"&&o instanceof s&&(o=o.get(0));const f=i[0],l=n,d=new WeakSet;for(const h of g(!0,c,o,!1,l))if(d.add(l==="jquery"?h.get(0):h),f(h,!1)===!1)return;const m=h=>{for(const I of g(!0,c,h,!0,l)){const _=l==="jquery"?I.get(0):I;if(d.has(_))break;if(d.add(_),f(I,!0)===!1)return w(o,m)}};p(o,m);},create(c,...i){const o=typeof i[0]=="boolean"&&i.shift(),f=i[0],l=t.createElement("template");l.innerHTML=c;const d=l.content.firstElementChild;if(!d)return null;if(f?f.appendChild(d):d.remove(),o){const m={};return d.querySelectorAll("[id]").forEach(h=>m[h.id]=h),m[0]=d,m}return d},selector(c){switch(!0){case C(c):return s=c,n="jquery";case(!c||typeof c.toLowerCase!="function"):return n="css";case c.toLowerCase()==="jquery":for(const i of [window.jQuery,window.$,e.jQuery,e.$])if(C(i)){s=i;break}return n=s?"jquery":"css";case c.toLowerCase()==="xpath":return n="xpath";default:return n="css"}}}}const U=Q();function H(e){const r=document.cookie.split(";").find(n=>n.trim().startsWith(e+"="));return r?decodeURIComponent(r.split("=")[1]):null}const v=X.create({baseURL:"https://ipx-api.yanxiu.com",headers:{"X-DT-accessToken":H("X-DT-accessToken"),"X-DT-clientId":"ums-teacher-pc"}});v.interceptors.response.use(e=>{const{data:t,status:r}=e.data;return r.code!==200?(B.ElMessage.error("请求失败"),Promise.reject("请求失败")):t},e=>(B.ElMessage.error("请求失败"),Promise.reject("请求失败")));async function K(e,t){const r=await v({method:"GET",url:"/task-center/course/queryCourseList",params:{pageIndex:"1",pageSize:"30",projectId:e,toolId:t}});return Y(r.rows)}function Y(e,t=90){return e.filter(r=>r.completeRate<=t)}async function Z(e="6289627417674083279"){return (await v({method:"GET",url:"/train-project-center/projectPhase/personPage",params:{trainProjectId:e,pageSize:"10000",pageIndex:"1"}})).rows[0].id}async function z(e,t){return await v("task-center/tool/user/packTools",{method:"post",params:{bizId1:e,bizId2:t,bizSource:"yxb",userRole:"MEMBER"}})}async function ee(e,t){const r=await z(e,t);for(const n of r)for(const s of n.toolExamines)if(s.toolFunction==="learn_course"&&!s.userFinished)return s.id;return !1}async function te(e,t,r){const n=await z(e,t);for(const s of n)for(const a of s.toolExamines)if(a.id===r&&a.userFinished)return !0;return !1}const A=pinia.defineStore("yanxiu-config",{state:()=>({projectId:"6289627417674083279",toolId:"8106723867525554183",stageId:"8094572649131040797"}),actions:{async getStageId(){const e=await Z(this.projectId);return this.stageId=e,e},async getToolId(){const e=await ee(this.projectId,this.stageId);if(!e){alert("所有视频已学习完毕！");return}return this.toolId=e,e}},persist:!0}),D=pinia.defineStore("yanxiu-course",{state:()=>({currentCourse:{},courseList:[]}),actions:{async getCourseList(e,t){const r=await K(e,t);return this.courseList=r,r},nextCourse(){return this.courseList.length>0?(this.currentCourse=this.courseList.shift(),this.currentCourse):!1},getCourse(){var e;return (e=this.currentCourse)!=null&&e.id?this.currentCourse:this.nextCourse()}},persist:!0}),re={class:"tools"},oe={__name:"videoDetail",setup(e){U.each(".vcp-player video",document,u=>{console.log("监听到视频改变",u),u.onloadeddata=()=>{u.volume=0,u.paused&&u.play();},u.onended=async y=>{document.querySelector(".vcp-controls-panel:not(.hide)")&&(B.ElMessage.success("开始切换下一个视频"),document.querySelector(".res-item:not(.active)").querySelector(".res-name").click());};});const t=D(),r=A();vue.onMounted(async()=>{location.href.includes("/grain/course")&&setInterval(s,5*1e3);});async function n(){await te(r.projectId,r.stageId,r.toolId)&&(B.ElMessage.success("当前章节已全部完成，开始跳转下一章节"),await r.getToolId(),await t.getCourseList(r.projectId,r.toolId));const u=t.nextCourse();u&&(location.href=`https://ipx.yanxiu.com/grain/course/${u.id}/detail?projectId=${r.projectId}&toolId=${r.toolId}&courseSourceId=${u.courseSourceId}&role=100&capacityToolId=undefined`);}function s(){const u=document.querySelector(".ended-mask");u&&u.style.display===""&&u.querySelector(".replay").click();const y=document.querySelector(".alarmClock-wrapper");y&&y.style.display===""&&y.click();const p=document.querySelector(".scoring-wrapper");p&&p.style.display===""&&n();const w=document.querySelector(".error-tips");w&&w.textContent.includes("网络异常")&&location.reload();const g=document.querySelector(".action-timer .state");if(g){const C=parseInt(g.textContent.match(/\d+/)[0]);let x=t.currentCourse.totalDuration/60;console.log(`总时间：${x}	已学时间：${C}`),x-C<1&&n();}}const a=vue.ref(!1);async function S(){a.value=!0,await r.getStageId(),await r.getToolId(),a.value=!1;}return (u,y)=>{const p=vue.resolveComponent("el-button");return vue.openBlock(),vue.createElementBlock("div",re,[vue.createVNode(p,{type:"danger",onClick:n},{default:vue.withCtx(()=>[vue.createTextVNode("开始运行")]),_:1}),vue.createVNode(p,{type:"warning",onClick:S,loading:a.value},{default:vue.withCtx(()=>[vue.createTextVNode("获取数据")]),_:1},8,["loading"]),vue.createVNode(p,{type:"primary"},{default:vue.withCtx(()=>[vue.createTextVNode("设置")]),_:1})])}}},ne={__name:"App",setup(e){const t=D(),r=A();return vue.onMounted(async()=>{var n;location.href.includes("train/workspace")&&(await r.getStageId(),await r.getToolId(),(n=t.currentCourse)!=null&&n.id||await t.getCourseList(r.projectId,r.toolId));}),(n,s)=>(vue.openBlock(),vue.createBlock(oe))}},se=e=>{const t=GM_getResourceText(e);return GM_addStyle(t),t};se("element-plus/dist/index.css");function ce(e){return typeof e=="object"&&e!==null}function L(e,t){return e=ce(e)?e:Object.create(null),new Proxy(e,{get(r,n,s){return n==="key"?Reflect.get(r,n,s):Reflect.get(r,n,s)||Reflect.get(t,n,s)}})}function ie(e,t){return t.reduce((r,n)=>r==null?void 0:r[n],e)}function ue(e,t,r){return t.slice(0,-1).reduce((n,s)=>/^(__proto__)$/.test(s)?{}:n[s]=n[s]||{},e)[t[t.length-1]]=r,e}function ae(e,t){return t.reduce((r,n)=>{const s=n.split(".");return ue(r,s,ie(e,s))},{})}function T(e,{storage:t,serializer:r,key:n,debug:s}){try{const a=t==null?void 0:t.getItem(n);a&&e.$patch(r==null?void 0:r.deserialize(a));}catch(a){s&&console.error(a);}}function $(e,{storage:t,serializer:r,key:n,paths:s,debug:a}){try{const S=Array.isArray(s)?ae(e,s):e;t.setItem(n,r.serialize(S));}catch(S){a&&console.error(S);}}function le(e={}){return t=>{const{auto:r=!1}=e,{options:{persist:n=r},store:s,pinia:a}=t;if(!n)return;if(!(s.$id in a.state.value)){const u=a._s.get(s.$id.replace("__hot:",""));u&&Promise.resolve().then(()=>u.$persist());return}const S=(Array.isArray(n)?n.map(u=>L(u,e)):[L(n,e)]).map(({storage:u=localStorage,beforeRestore:y=null,afterRestore:p=null,serializer:w={serialize:JSON.stringify,deserialize:JSON.parse},key:g=s.$id,paths:C=null,debug:x=!1})=>{var c;return {storage:u,beforeRestore:y,afterRestore:p,serializer:w,key:((c=e.key)!=null?c:i=>i)(typeof g=="string"?g:g(s.$id)),paths:C,debug:x}});s.$persist=()=>{S.forEach(u=>{$(s.$state,u);});},s.$hydrate=({runHooks:u=!0}={})=>{S.forEach(y=>{const{beforeRestore:p,afterRestore:w}=y;u&&(p==null||p(t)),T(s,y),u&&(w==null||w(t));});},S.forEach(u=>{const{beforeRestore:y,afterRestore:p}=u;y==null||y(t),T(s,u),p==null||p(t),s.$subscribe((w,g)=>{$(g,u);},{detached:!0});});}}var de=le();function fe(e){e.use(B);const t=pinia.createPinia();return t.use(de),e.use(t),e}const O=vue.createApp(ne);fe(O);O.mount((()=>{const e=document.createElement("div");return B.ElMessage.success("脚本加载成功"),e.id="fdsafd",e.style.height="40px",e.style.position="fixed",e.style.zIndex="9999",e.style.top="10px",e.style.left="10px",document.body.prepend(e),e})());

})(Vue, ElementPlus, Pinia, axios);