/*! For license information please see B站下载.user.js.LICENSE.txt */
// ==UserScript==
// @name         B站下载
// @namespace    http://tampermonkey.net/
// @version      0.4.12816619
// @description  下载B站视频
// @author       抖音兔不迟到
// @run-at       document-start
// @license      MIT License
// @grant        GM_invokeFn
// @include      *://*.bilibili.com/*
// @inject-into  page
// @require      https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.18.0/js/md5.min.js
// @require      https://cdn.bootcdn.net/ajax/libs/jquery/1.7.2/jquery.min.js
// @require      https://cdn.jsdelivr.net/npm/protobufjs@6.10.1/dist/protobuf.js
// @dev          9999
// @downloadURL https://update.greasyfork.org/scripts/436373/B%E7%AB%99%E4%B8%8B%E8%BD%BD.user.js
// @updateURL https://update.greasyfork.org/scripts/436373/B%E7%AB%99%E4%B8%8B%E8%BD%BD.meta.js
// ==/UserScript==
const API_HOST="https://api.bilibili.com/x",PB_CONF='{"nested":{"bilibili":{"nested":{"DmWebViewReply":{"fields":{"state":{"type":"int32","id":1},"text":{"type":"string","id":2},"textSide":{"type":"string","id":3},"dmSge":{"type":"DmSegConfig","id":4},"flag":{"type":"DanmakuFlagConfig","id":5},"specialDms":{"rule":"repeated","type":"string","id":6},"checkBox":{"type":"bool","id":7},"count":{"type":"int64","id":8},"commandDms":{"rule":"repeated","type":"CommandDm","id":9},"dmSetting":{"type":"DanmuWebPlayerConfig","id":10}}},"CommandDm":{"fields":{"id":{"type":"int64","id":1},"oid":{"type":"int64","id":2},"mid":{"type":"int64","id":3},"command":{"type":"string","id":4},"content":{"type":"string","id":5},"progress":{"type":"int32","id":6},"ctime":{"type":"string","id":7},"mtime":{"type":"string","id":8},"extra":{"type":"string","id":9},"idStr":{"type":"string","id":10}}},"DmSegConfig":{"fields":{"pageSize":{"type":"int64","id":1},"total":{"type":"int64","id":2}}},"DanmakuFlagConfig":{"fields":{"recFlag":{"type":"int32","id":1},"recText":{"type":"string","id":2},"recSwitch":{"type":"int32","id":3}}},"DmSegMobileReply":{"fields":{"elems":{"rule":"repeated","type":"DanmakuElem","id":1}}},"DanmakuElem":{"fields":{"id":{"type":"int64","id":1},"progress":{"type":"int32","id":2},"mode":{"type":"int32","id":3},"fontsize":{"type":"int32","id":4},"color":{"type":"uint32","id":5},"midHash":{"type":"string","id":6},"content":{"type":"string","id":7},"ctime":{"type":"int64","id":8},"weight":{"type":"int32","id":9},"action":{"type":"string","id":10},"pool":{"type":"int32","id":11},"idStr":{"type":"string","id":12}}},"DanmuWebPlayerConfig":{"fields":{"dmSwitch":{"type":"bool","id":1},"aiSwitch":{"type":"bool","id":2},"aiLevel":{"type":"int32","id":3},"blocktop":{"type":"bool","id":4},"blockscroll":{"type":"bool","id":5},"blockbottom":{"type":"bool","id":6},"blockcolor":{"type":"bool","id":7},"blockspecial":{"type":"bool","id":8},"preventshade":{"type":"bool","id":9},"dmask":{"type":"bool","id":10},"opacity":{"type":"float","id":11},"dmarea":{"type":"int32","id":12},"speedplus":{"type":"float","id":13},"fontsize":{"type":"float","id":14},"screensync":{"type":"bool","id":15},"speedsync":{"type":"bool","id":16},"fontfamily":{"type":"string","id":17},"bold":{"type":"bool","id":18},"fontborder":{"type":"int32","id":19},"drawType":{"type":"string","id":20}}}}}}}';let videoInfo,bvid;const danmuCache={},detailCache={};var origOpen=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,t,...i){let n;t.startsWith("//")&&(t=`https:${t}`);try{n=new URL(t)}catch(e){return}const o=n.searchParams.get("bvid"),d=n.searchParams.get("avid"),a=n.searchParams.get("cid");this.addEventListener("load",(function(){if(t.includes("playurl?")){if(this.responseType&&"text"!==this.responseType)return;videoInfo=JSON.parse(this.responseText),d&&(unsafeWindow.aid=d),a&&(unsafeWindow.cid=a),o&&(bvid=o)}else if(t.includes("view/detail?")){const e=JSON.parse(this.responseText);e?.data?.View&&(detailCache[o]=e.data.View)}})),origOpen.call(this,e,t,...i)},function(){const root=protobuf.Root.fromJSON(JSON.parse(PB_CONF)),protoSeg=root.lookupType("bilibili.DmSegMobileReply"),protoView=root.lookupType("bilibili.DmWebViewReply"),getBangumiInfo=async function(e){let t=`https://api.bilibili.com/pgc/view/web/season?ep_id=${e.replace("ep","")}`;return new Promise((function(i){const n=new XMLHttpRequest;n.addEventListener("load",(()=>{const t=JSON.parse(n.responseText);t?.result?.episodes&&(detailCache[e]=t.result.episodes.filter((t=>t.link.includes(e)))[0]),i()})),n.open("get",t),n.responseType="text",n.send()}))},getDetailInfo=async function(e){let t=unsafeWindow.aid,i=`${API_HOST}/web-interface/view/detail?bvid=${e}&aid=${t}&need_operation_card=1&web_rm_repeat=&need_elec=1&out_referer=${encodeURIComponent(window.location.href)}`;return new Promise((function(t){const n=new XMLHttpRequest;n.addEventListener("load",(()=>{const i=JSON.parse(n.responseText);i?.data?.View&&(detailCache[e]=i.data.View),t()})),n.open("get",i),n.responseType="text",n.send()}))},parsePlayInfo=async function(e){const t=e.result||e.data,i=[],n=function(e,t){return t.id!=e.id?t.id-e.id:t.bandwidth-e.bandwidth},{baseUrl:o}=t.dash.audio.sort(n)[0],d=[];return t.dash.video.sort(n).forEach((e=>{if(d.includes(e.id))return;d.push(e.id);const{width:t,height:n,baseUrl:a}=e;i.push({audio:o,video:a})})),i[0]},getDanmuConfig=async function(e,t){return new Promise((function(i){const n=new XMLHttpRequest;n.addEventListener("load",(function(){let e=protoView.decode(new Uint8Array(n.response));i(e)})),n.open("get",`${API_HOST}/v2/dm/web/view?type=1&oid=${e}&pid=${t}`),n.responseType="arraybuffer",n.send()}))},parseDanmu=async function(e){let t=e.cid||unsafeWindow.cid,i=e.aid||unsafeWindow.aid;if(!t||!i)return;const n=`${t}.${i}`;if(danmuCache[n])return danmuCache[n];const o=await getDanmuConfig(t,i),d=o.dmSge.total;console.log(o);const a=[],s=[];for(let e=1;e<=d;e++)a.push(new Promise((function(n){let o=new XMLHttpRequest;o.addEventListener("load",(function(){s[e]=o.response,n()})),o.open("get",`${API_HOST}/v2/dm/web/seg.so?type=1&oid=${t}&pid=${i}&segment_index=${e}`),o.responseType="arraybuffer",o.send()})));await Promise.all(a);let r=[];return s.forEach((function(e){r=r.concat(protoSeg.decode(new Uint8Array(e)).elems)})),danmuCache[n]=r,r};var parser={parseItems:async()=>{const href=new URL(window.location.href),paths=href.pathname.split("/");if("video"===paths[1]||"bangumi"===paths[1]){if(!videoInfo){const infoKey="__playinfo__",scripts=$("script").filter(((e,t)=>t.innerText.includes(infoKey)));scripts.length>0&&(eval(scripts[0].innerText),videoInfo=window[infoKey])}if(!videoInfo)return[];let url;const meta=await parsePlayInfo(videoInfo);if(meta&&meta.video&&meta.audio&&(url=meta.video),!url)return[];const video_id=md5(url+meta.audio),id=`mona-${md5(video_id)}`;if(meta.filename=`${video_id}.mp4`,$(`#${id}`).length>0)return[];let detailInfo;if("video"===paths[1]&&paths[2].startsWith("BV")){const e=paths[2];detailCache[e]||await getDetailInfo(e),detailInfo=detailCache[e],detailInfo.cover=detailInfo.pic}else if("bangumi"===paths[1]&&paths[3].startsWith("ep")){const e=paths[3];detailCache[e]||await getBangumiInfo(e),detailInfo=detailCache[e],detailInfo.title=detailInfo.share_copy}if(detailInfo){if(!detailInfo.cid||!url.includes(detailInfo.cid))return[];Object.assign(meta,detailInfo),console.log("has detail",meta)}try{meta.danmu=await parseDanmu(meta),console.log("danmu load",meta.danmu?.length)}catch(e){console.log("danmu err",e)}const dom=$(`<div id='${id}'></div>`);let pdom=$(".bilibili-player-video-wrap");return 0==pdom.length&&(pdom=$(".bpx-player-primary-area")),item={id,url,dom,pdom,meta},[item]}throw 999}};GM_invokeFn("regParser",parser)}();