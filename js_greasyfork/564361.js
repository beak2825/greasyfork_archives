// ==UserScript==
// @name         æ— é™æš–æš–èµ„è®¯å¯¼å…¥Biliwiki
// @namespace    https://github.com/haihe8177
// @version      1.0.1
// @description  å°†æ— é™æš–æš–å®˜ç½‘èµ„è®¯ä¸€é”®å¯¼å…¥ Biliwiki
// @author       Haihe
// @license      MIT
// @match        https://infinitynikki.nuanpaper.com/news/*
// @match        https://wiki.biligame.com/wxnn/index.php?title=*&action=edit
// @match        https://wiki.biligame.com/wxnn/index.php?title=*&action=submit
// @grant        GM_openInTab
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_log
// @grant        GM_registerMenuCommand
// @run-at       document-end
// @downloadURL https://update.greasyfork.org/scripts/564361/%E6%97%A0%E9%99%90%E6%9A%96%E6%9A%96%E8%B5%84%E8%AE%AF%E5%AF%BC%E5%85%A5Biliwiki.user.js
// @updateURL https://update.greasyfork.org/scripts/564361/%E6%97%A0%E9%99%90%E6%9A%96%E6%9A%96%E8%B5%84%E8%AE%AF%E5%AF%BC%E5%85%A5Biliwiki.meta.js
// ==/UserScript==

(function () {
    'use strict';

    if (window.location.hostname === 'infinitynikki.nuanpaper.com') {
        GM_registerMenuCommand('ğŸ“¥ å¯¼å…¥åˆ° Wiki', async () => {
            try {
                const nextData = document.getElementById('__NEXT_DATA__');
                if (!nextData) throw new Error('æœªæ‰¾åˆ° __NEXT_DATA__');

                const json = JSON.parse(nextData.textContent);
                const data = json?.props?.pageProps?.pageData;
                if (!data?.title || !data?.content_html) throw new Error('æ•°æ®ä¸å®Œæ•´');

                const wikiPageTitle = data.title.trim();
                const publishTime = new Date(data.publish_time);
                const dateStr = `${publishTime.getFullYear()}-${String(publishTime.getMonth() + 1).padStart(2, '0')}-${String(publishTime.getDate()).padStart(2, '0')}`;
                const contentHtml = data.content_html;
                const articleType = data.section === 1 ? 'å…¬å‘Š' : (data.title.includes('æ´»åŠ¨') || data.abstract?.includes('æ´»åŠ¨')) ? 'æ´»åŠ¨' : 'æ–°é—»';
                const rawTitleForSearch = wikiPageTitle; // ä¿ç•™å®Œæ•´æ ‡é¢˜ç”¨äºæœç´¢

                const shouldDownload = confirm('æ˜¯å¦ä¸‹è½½å›¾ç‰‡ï¼Ÿ');
                const convertedContent = await convertContent(contentHtml, dateStr, articleType, shouldDownload, rawTitleForSearch);

                const wikiMeta = `{{æ–‡ç« æˆ³
|æ–‡ç« ä¸Šçº§é¡µé¢=${articleType}
|æ—¶é—´=${dateStr}
|ä½œè€…=ã€Šæ— é™æš–æš–ã€‹å®˜æ–¹
|æ˜¯å¦åŸåˆ›=å¦
|æ¥æº=å®˜ç½‘
|åŸæ–‡åœ°å€=${window.location.href}
}}
<div style="font-size:16px;line-height:30px;">
<br>
`;
                const fullContent = wikiMeta + convertedContent + '\n</div>\n\n<!-- Generated by Importer (by Haihe) -->';

                GM_setValue('extractedData', JSON.stringify({ title: wikiPageTitle, content: fullContent }));

                const cleanWikiTitle = wikiPageTitle
                    .replace(/^ã€Šæ— é™æš–æš–ã€‹(?!Ã—)/, 'â™¾ï¸ ')
                    .replace(/\s*\|\s*/g, 'ä¸¨')
                    .trim();

                const wikiUrl = `https://wiki.biligame.com/wxnn/index.php?title=${encodeURIComponent(cleanWikiTitle)}&action=edit`;
                GM_openInTab(wikiUrl, { active: true });
            } catch (error) {
                alert(`âŒ ${error.message}`);
                GM_log(error);
            }
        });

        console.log('â„¹ï¸ æ— é™æš–æš–å¯¼å…¥å·¥å…·å°±ç»ªã€‚Tampermonkey èœå• â†’ â–¼ â†’ â€œğŸ“¥ å¯¼å…¥åˆ° Wikiâ€');
    }

    async function convertContent(htmlString, date, articleType, shouldDownload, rawTitleForSearch = '') {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlString;

        let imageIndex = 1;

        // å¤„ç†å›¾ç‰‡
        tempDiv.querySelectorAll('img').forEach(img => {
            const src = img.src;
            if (!src) return;
            const filename = `${date}${articleType}å›¾${imageIndex}.jpg`;
            const wikiTag = `\n[[File:${filename}|600px|link=]]\n`;
            img.replaceWith(document.createTextNode(wikiTag));
            if (shouldDownload) downloadImage(src, filename);
            imageIndex++;
        });

        tempDiv.querySelectorAll('div[data-w-e-type="video"]').forEach(videoDiv => {
            const encodedKeyword = encodeURIComponent(rawTitleForSearch);
            const searchUrl = `https://space.bilibili.com/3461576715667734/search?keyword=${encodedKeyword}`;
            const linkText = `[${searchUrl} å®˜æ–¹è§†é¢‘æœç´¢]`;
            const comment = `\n<!-- {{Bç«™è§†é¢‘|å¡«å…¥BVå·}} -->`;
            const replacement = `\n${linkText}${comment}\n`;
            videoDiv.replaceWith(document.createTextNode(replacement));
        });

        // æ¸…ç†æ®µè½å’Œ span
        tempDiv.querySelectorAll('p').forEach(p => {
            if (p.innerHTML.trim() === '') p.remove();
            else p.outerHTML = p.innerHTML + '<br>';
        });

        tempDiv.querySelectorAll('span').forEach(span => {
            span.outerHTML = span.innerHTML;
        });

        return tempDiv.innerHTML
            .replace(/<br>\s*<br>/g, '<br>')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/\u003c/g, '<')
            .replace(/\u003e/g, '>')
            .replace(/<\/?tbody>/g, '')
            .trim();
    }

    // å›¾ç‰‡ä¸‹è½½å‡½æ•°
    async function downloadImage(url, filename) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const blob = await res.blob();
            const bitmap = await createImageBitmap(blob);

            const canvas = document.createElement('canvas');
            canvas.width = bitmap.width;
            canvas.height = bitmap.height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(bitmap, 0, 0);

            const jpegBlob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.92));
            const a = document.createElement('a');
            a.href = URL.createObjectURL(jpegBlob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
            GM_log(`âœ… ä¸‹è½½å›¾ç‰‡: ${filename}`);
        } catch (err) {
            GM_log(`âš ï¸ å›¾ç‰‡ä¸‹è½½å¤±è´¥ (${filename}):`, err);
        }
    }

    // Wiki è‡ªåŠ¨å¡«å……
    if (window.location.hostname === 'wiki.biligame.com' && window.location.pathname.startsWith('/wxnn/')) {
        const fillData = () => {
            const raw = GM_getValue('extractedData', null);
            if (!raw) return;

            try {
                const { title, content } = JSON.parse(raw);
                const checkInterval = setInterval(() => {
                    const editor = document.querySelector('.CodeMirror')?.CodeMirror;
                    if (editor) {
                        editor.setValue(content);
                        document.title = `ç¼–è¾‘ ${title} - æ— é™æš–æš–`;
                        GM_setValue('extractedData', null);
                        clearInterval(checkInterval);
                    }
                }, 300);
            } catch (e) {
                GM_log('[Wiki Fill Error]:', e);
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fillData);
        } else {
            fillData();
        }
    }
})();