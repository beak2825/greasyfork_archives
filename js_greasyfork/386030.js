// ==UserScript==
// @name            AutomaticCalls for PopMundo 
// @Author	    Peter Svendsen (CharId #1662408)
// @description     Calls everyone in PopMundo character contact list.
// @version         1.0
// @include         https://*.popmundo.com/World/Popmundo.aspx/Character/AddressBook
// @include         https://*.popmundo.com/World/Popmundo.aspx/Interact/Phone/*
// @require         https://greasyfork.org/scripts/386028-ppmfunctions/code/ppmFunctions.js?version=708620
// @require         https://greasyfork.org/scripts/386029-ppmtranslations/code/ppmTranslations.js?version=708621
// @require         https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js
// @grant           GM_info
// @namespace https://scriptsppm.000webhostapp.com/
// @downloadURL https://update.greasyfork.org/scripts/386030/AutomaticCalls%20for%20PopMundo.user.js
// @updateURL https://update.greasyfork.org/scripts/386030/AutomaticCalls%20for%20PopMundo.meta.js
// ==/UserScript==

var jisQuery=jQuery.noConflict(),_appendJsFiles=["https://greasyfork.org/scripts/386028-ppmfunctions/code/ppmFunctions.js?version=708620","https://greasyfork.org/scripts/386029-ppmtranslations/code/ppmTranslations.js?version=708621"],_labels=null,_idMainChar=0,_idCurrentChar=0,_idStorage="_GEX_MAIN_ID_",_urlCurrent=window.location.href,_urlToCall="/World/Popmundo.aspx/Interact/Phone/",_urlToCall_Token="#toCall",_keys=[],_valuesRunTime={},_valuesStorage={},_valueDefault=24,_valueCalls=Array(9999,171,162,121,24,61,58,26,25,73,74);function loadJavaScriptFiles(e){for(var t=0;t<_appendJsFiles.length;t++){var a=document.createElement("script");a.type="text/javascript",a.src=_appendJsFiles[t],jisQuery("head").append(a)}}function getLabels(){var e=jisQuery("#ctl00_ctl06_ucMenu_lnkCharacter").text().toLowerCase();_labels=ppmGetTranslations(e)}function getIdMain(){_idMainChar=jisQuery(".idHolder").first().html(),_idStorage+=_idMainChar}function getIdFromUrl(e){var t=e.split("/");return t[t.length-1]}function addCallButton(){var e=document.createElement("tr"),t=document.createElement("td");t.setAttribute("colspan",8),e.appendChild(t);var a=document.createElement("div");a.setAttribute("class","box beta"),t.appendChild(a);var r=document.createElement("label");r.innerHTML="<b>AutomaticCalls:</b>&nbsp;&nbsp;",a.appendChild(r);var l=document.createElement("input");l.type="button",l.style="cursor:pointer",l.value=_labels.call_everyone,l.setAttribute("onclick","ppmCallEveryone('"+_idStorage+"')"),a.appendChild(l);var n=document.createElement("input");n.type="button",n.style="cursor:pointer",n.value=_labels.bug_report,n.setAttribute("onclick","ppmContactAuthor('"+_idMainChar+"')"),a.appendChild(n),jisQuery(e).insertAfter("thead")}function getKeys(){jisQuery("a[id^='ctl00_cphLeftColumn_ctl00_repAddressBook_ctl'][id$=_lnkCharacter]").each(function(){var e=getIdFromUrl(jisQuery(this).attr("href"));_keys.push(e)})}function loadValues(){for(getKeys(),e=0;e<_keys.length;e++)_valuesRunTime[_keys[e]]=_valueDefault;null===window.localStorage.getItem(_idStorage)?(window.localStorage.setItem(_idStorage,JSON.stringify(_valuesRunTime)),_valuesStorage=_valuesRunTime):_valuesStorage=JSON.parse(window.localStorage.getItem(_idStorage));for(var e=0;e<_keys.length;e++)void 0!==_valuesStorage[_keys[e]]&&(_valuesRunTime[_keys[e]]=_valuesStorage[_keys[e]]);window.localStorage.setItem(_idStorage,JSON.stringify(_valuesRunTime))}function getCallSelect(){var e=document.createElement("select");e.id="gex_CharId_"+_idMainChar+"_ContId_"+_idCurrentChar,e.name=e.id,e.setAttribute("onchange","ppmUpdateLocalStorage( '"+_idStorage+"', '"+_idCurrentChar+"', '"+e.id+"' )"),e.style="display:block",e.style.padding="3px",e.style.borderRadius="7px";for(var t=0;t<_valueCalls.length;t++){var a=document.createElement("option");a.value=_valueCalls[t],a.text=_labels[_valueCalls[t]],_valuesRunTime[_idCurrentChar]==_valueCalls[t]&&a.setAttribute("selected","selected"),e.appendChild(a)}return e}function addCallSelects(){jisQuery("a[id^='ctl00_cphLeftColumn_ctl00_repAddressBook_ctl'][id$=_lnkCharacter]").each(function(){var e=jisQuery(this).attr("id");_idCurrentChar=getIdFromUrl(jisQuery(this).attr("href")),jisQuery(this).attr("href",_urlToCall+_idCurrentChar+_urlToCall_Token+_idMainChar),jisQuery(this).attr("target","_BLANK");var t=getCallSelect();jisQuery(t).insertAfter("a[id^='"+e+"']")})}function executeOnPage_Contact(){window.location.href;var e=jisQuery(".idHolder").eq(1).html(),t=9999;jisQuery("select[id='ctl00_cphTopColumn_ctl00_ddlInteractionTypes']").each(function(){_valuesStorage=JSON.parse(window.localStorage.getItem(_idStorage)),t=_valuesStorage[e]}),9999!==t&&(jisQuery("select option:selected").attr("selected",!1),jisQuery("select option[value='"+t+"']").attr("selected",!0),jisQuery("#ctl00_cphTopColumn_ctl00_btnInteract").click())}loadJavaScriptFiles(),getLabels(),getIdMain(),_urlCurrent.match(/\/World\/Popmundo.aspx\/Character\/AddressBook/g)&&(addCallButton(),loadValues(),addCallSelects()),_urlCurrent.match(/.*#toCall[0-9]+/g)&&executeOnPage_Contact();