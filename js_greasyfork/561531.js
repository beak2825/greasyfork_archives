// ==UserScript==
// @name         YouTubeMusicAdSolutions
// @name:ar      YouTubeMusicAdSolutions
// @name:be      YouTubeMusicAdSolutions
// @name:bg      YouTubeMusicAdSolutions
// @name:ckb     YouTubeMusicAdSolutions
// @name:cs      YouTubeMusicAdSolutions
// @name:da      YouTubeMusicAdSolutions
// @name:de      YouTubeMusicAdSolutions
// @name:el      YouTubeMusicAdSolutions
// @name:en      YouTubeMusicAdSolutions
// @name:eo      YouTubeMusicAdSolutions
// @name:es      YouTubeMusicAdSolutions
// @name:es-419  YouTubeMusicAdSolutions
// @name:fi      YouTubeMusicAdSolutions
// @name:fr      YouTubeMusicAdSolutions
// @name:fr-CA   YouTubeMusicAdSolutions
// @name:he      YouTubeMusicAdSolutions
// @name:hr      YouTubeMusicAdSolutions
// @name:hu      YouTubeMusicAdSolutions
// @name:id      YouTubeMusicAdSolutions
// @name:it      YouTubeMusicAdSolutions
// @name:ja      YouTubeMusicAdSolutions
// @name:ka      YouTubeMusicAdSolutions
// @name:ko      YouTubeMusicAdSolutions
// @name:mr      YouTubeMusicAdSolutions
// @name:nb      YouTubeMusicAdSolutions
// @name:nl      YouTubeMusicAdSolutions
// @name:pl      YouTubeMusicAdSolutions
// @name:pt-BR   YouTubeMusicAdSolutions
// @name:ro      YouTubeMusicAdSolutions
// @name:ru      YouTubeMusicAdSolutions
// @name:sk      YouTubeMusicAdSolutions
// @name:sr      YouTubeMusicAdSolutions
// @name:sv      YouTubeMusicAdSolutions
// @name:th      YouTubeMusicAdSolutions
// @name:tr      YouTubeMusicAdSolutions
// @name:uk      YouTubeMusicAdSolutions
// @name:ug      YouTubeMusicAdSolutions
// @name:vi      YouTubeMusicAdSolutions
// @name:zh-CN   YouTubeMusicAdSolutions
// @name:zh-TW   YouTubeMusicAdSolutions
// @description  Combines bass boost, volume/boost sliders, intelligent ad-block speedup for YouTube Music.
// @description:ar  يجمع بين تعزيز الباس، مثبتات الصوت/التعزيز، تسريع حظر الإعلانات الذكي لـ YouTube Music.
// @description:be  Камбінуе bass boost, 슬라이더ы гукамасці/павялічэння, інтэлектуальнае прыцягненне блякавання рэкламы для YouTube Music.
// @description:bg  Комбинира бас буст, плъзгачи за сила/усилване, интелигентно ускоряване на блокиране на реклами за YouTube Music.
// @description:ckb  هەموو بەس بوست، سڵایدرەکانی دەنگ/بووست، خێراکی زیرەک لە کۆتکردنەوەی ڕیکلامەکان بۆ YouTube Music.
// @description:cs  Kombinuje basový posilovač, posuvníky hlasitosti/zesílení, inteligentní urychlení blokování reklam pro YouTube Music.
// @description:da  Kombinerer bas boost, volumen/boost-glidere, intelligent annonceringsblokering for YouTube Music.
// @description:de  Kombiniert Bass-Boost, Lautstärke/Boost-Slider, intelligente Ad-Block-Beschleunigung für YouTube Music.
// @description:el  Συνδυάζει ενίσχυση μπάσων, ρυθμιστές έντασης/ενίσχυσης, έξυπνη επιτάχυνση μπλοκ διαφημίσεων για YouTube Music.
// @description:en  Combines bass boost, volume/boost sliders, intelligent ad-block speedup for YouTube Music.
// @description:eo  Kombinas bass-plifortigo, volumen/plifortigaj ŝuojiloj, inteligenta reklamŝildo-akcelo por YouTube Music.
// @description:es  Combina refuerzo de graves, controles de volumen/potencia, aceleración inteligente de bloqueo de anuncios para YouTube Music.
// @description:es-419  Combina refuerzo de graves, controles de volumen/potencia, aceleración inteligente de bloqueo de anuncios para YouTube Music.
// @description:fi  Yhdistää bass boostin, äänenvoimakkuus/tehostus-liukusäätimet, älykkään mainosesto-nopeuden YouTube Musicille.
// @description:fr  Combine boost de basse, curseurs volume/boost, accélération intelligente de blocage de pubs pour YouTube Music.
// @description:fr-CA  Combine boost de basse, curseurs volume/boost, accélération intelligente de blocage de pubs pour YouTube Music.
// @description:he  משלב הגברת באס, מחוונים עוצמת קول/חיזוק, האצת חסימת פרסומות חכמה עבור YouTube Music.
// @description:hr  Kombinira pojačanje basa, klizače za glasnoću/pojačanje, inteligentno ubrzanje blokiranja oglasa za YouTube Music.
// @description:hu  Kombinálja a basszuskiemelést, hangerő/fokozó csúszkákat, intelligens hirdetésblokkoló-gyorsítást YouTube Musichez.
// @description:id  Menggabungkan peningkatan bass, slider volume/boost, akselerasi blokir iklan cerdas untuk YouTube Music.
// @description:it  Combina bass boost, slider volume/boost, accelerazione intelligente del blocco degli annunci per YouTube Music.
// @description:ja  ベースブースト、音量/ブーストスライダー、YouTube Music向けインテリジェント広告ブロック加速を組み合わせ।
// @description:ka      აერთიანებს ბასის გაძლიერებას, მოცულობის/გაძლიერების სლაიდერებს, რეკლამის დაბლოკვის ინტელექტუალურ დაჩქარებას YouTube Music-ისთვის.
// @description:ko  베이스 부스트, 볼륨/부스트 슬라이더, YouTube Music용 지능형 광고 차단 가속을 결합합니다.
// @description:mr  बास बूस्ट, व्हॉल्यूम/बूस्ट स्लायडर्स, YouTube Music साठी इंटेलिजंट जाहिरात-ब्लॉक स्पीडअप एकत्र करते.
// @description:nb  Kombinerer bassboost, volum/boost-skyvere, intelligent annonseblokkeringsakselerasjon for YouTube Music.
// @description:nl  Combineert bass boost, volume/boost-schuifregelaars, intelligente advertentieblokkeringversnelling voor YouTube Music.
// @description:pl  Łączy wzmocnienie basów, suwaki głośności/wzmacniacza, inteligentne przyspieszanie blokowania reklam dla YouTube Music.
// @description:pt-BR  Combina reforço de graves, sliders de volume/boost, aceleração inteligente de bloqueio de anúncios para YouTube Music.
// @description:ro  Combină amplificarea basului, cursorii de volum/impuls, accelerarea inteligentă a blocării reclamelor pentru YouTube Music.
// @description:ru  Сочетает усиление басов, ползунки громкости/усиления, интеллектуальное ускорение блокировки рекламы для YouTube Music.
// @description:sk  Kombinuje zosilnenie basov, posuvníky hlasitosti/zosilnenia, inteligentné zrýchlenie blokovania reklám pre YouTube Music.
// @description:sr  Комбинује појачање баса, клизаче за jaчину звука/појачање, интелигентно убрзање блокирања огласа за YouTube Music.
// @description:sv  Kombinerar basförstärkning, volym/boost-reglage, intelligent annonsblockeringsacceleration för YouTube Music.
// @description:th  ผสมผสานการเพิ่มเบス, สไลเดอร์ระดับเสียง/บูสต์, การเร่งความเร็วการบล็อกโฆษณาอัจฉริยะสำหรับ YouTube Music
// @description:tr  Bas güçlendirme, ses seviyesi/güçlendirme kaydırıcıları, YouTube Music için akıllı reklam engelleme hızlandırmasını birleştirir.
// @description:uk  Поєднує посилення басів, повзунки гучності/підсилення, інтелектуальне прискорення блокування реклами для YouTube Music.
// @description:ug  بۇ باس كۈچەيتىش، ئاۋاز دەرىجىسى/كۈچەيتىش سىيرىلاش ئىسىمچىلىكلىرى، YouTube Music ئۈچۈن ئەقلىي ئېلان توسۇش تېزلىكىنى بىرلەشتۈرىدۇ.
// @description:vi  Kết hợp tăng cường âm trầm, thanh trượt âm lượng/boost, tăng tốc chặn quảng cáo thông minh cho YouTube Music.
// @description:zh-CN  结合低音增强、音量/增强滑块、YouTube Music智能广告拦截加速。
// @description:zh-TW  結合低音增強、音量/增強滑塊、YouTube Music智慧廣告攔截加速。
// @namespace    http://tampermonkey.net/
// @version      1.0
// @author       Pascal
// @match        https://music.youtube.com/*
// @grant        none
// @run-at       document-start
// @icon         https://www.gstatic.com/youtube/img/branding/favicon/youtubemusic/favicon_144x144.png
// @license      MIT
// @downloadURL https://update.greasyfork.org/scripts/561531/YouTubeMusicAdSolutions.user.js
// @updateURL https://update.greasyfork.org/scripts/561531/YouTubeMusicAdSolutions.meta.js
// ==/UserScript==

(function() {
    'use strict';

    const SETTINGS = {
        fastSpeed: 16,
        checkInterval: 250,
    };

    let audioCtx, source, gainNode, bassFilter;
    let isAudioInited = false;
    const wrapperId = 'custom-ytm-controls';

    function initAudio() {
        const video = document.querySelector('video');
        if (!video || isAudioInited) return;

        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            source = audioCtx.createMediaElementSource(video);
            gainNode = audioCtx.createGain();
            bassFilter = audioCtx.createBiquadFilter();

            bassFilter.type = "lowshelf";
            bassFilter.frequency.value = 150;

            source.connect(bassFilter);
            bassFilter.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            isAudioInited = true;

            const savedBoost = localStorage.getItem('ytm-boost');
            const savedBass = localStorage.getItem('ytm-bass');
            if (savedBoost) gainNode.gain.value = parseFloat(savedBoost);
            if (savedBass) bassFilter.gain.value = parseFloat(savedBass);

            console.log('[YTM AdSolutions] Audio Engine Ready');
        } catch (e) {
            console.warn("[YTM AdSolutions] Audio Init Warning:", e);
        }
    }

    function createControl(color, labelText, min, max, step, storageKey, unit, onChangeFn) {
        const savedVal = localStorage.getItem(storageKey) || (labelText === 'BOOST' ? 1 : 0);

        const container = document.createElement('div');
        container.style.cssText = 'display: flex; align-items: center; margin-right: 15px; color: white; font-family: Roboto, Arial; font-size: 11px;';

        const label = document.createElement('span');
        label.textContent = labelText;
        label.style.cssText = `margin-right: 5px; color: ${color}; font-weight: bold;`;

        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = min; slider.max = max; slider.step = step;
        slider.value = (labelText === 'VOL' && !localStorage.getItem(storageKey)) ? 50 : savedVal;
        slider.style.cssText = `width: 65px; height: 4px; accent-color: ${color}; cursor: pointer;`;

        const valDisp = document.createElement('span');
        valDisp.style.cssText = 'padding-left: 5px; min-width: 30px; font-weight: bold;';
        valDisp.textContent = Math.round(slider.value) + unit;

        slider.oninput = (e) => {
            if (!isAudioInited) initAudio();
            const val = parseFloat(e.target.value);
            onChangeFn(val);
            valDisp.textContent = Math.round(val) + unit;
            localStorage.setItem(storageKey, val);
        };

        // Verhindert, dass das Ziehen des Sliders das Video pausiert
        slider.addEventListener('click', (e) => e.stopPropagation());
        slider.addEventListener('mousedown', (e) => e.stopPropagation());

        container.appendChild(label);
        container.appendChild(slider);
        container.appendChild(valDisp);
        return container;
    }

    function applyLogic() {
        // 1. Logo (Grün-Cyan Filter)
        const logoImg = document.querySelector('ytmusic-logo img.logo');
        if (logoImg) logoImg.style.filter = "hue-rotate(145deg) brightness(1.2) saturate(1.5)";

        // 2. Controls einfügen
        const header = document.querySelector('.top-row-buttons.style-scope.ytmusic-player');
        const video = document.querySelector('video');

        if (header && video && !document.getElementById(wrapperId)) {
            const wrap = document.createElement('div');
            wrap.id = wrapperId;
            // WICHTIG: pointer-events auto und stopPropagation
            wrap.style.cssText = 'display: flex; align-items: center; background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 20px; margin-right: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); z-index: 10000; position: relative; pointer-events: auto;';

            // Klicks auf den schwarzen Balken abfangen
            wrap.addEventListener('click', (e) => e.stopPropagation());
            wrap.addEventListener('mousedown', (e) => e.stopPropagation());
            wrap.addEventListener('dblclick', (e) => e.stopPropagation());

            wrap.appendChild(createControl('#ff4444', 'VOL', 0, 100, 1, 'ytm-vol', '%', (v) => video.volume = v/100));
            wrap.appendChild(createControl('cyan', 'BOOST', 1, 10, 0.1, 'ytm-boost', 'x', (v) => { if(gainNode) gainNode.gain.value = v; }));
            wrap.appendChild(createControl('orange', 'BASS', 0, 30, 1, 'ytm-bass', 'dB', (v) => { if(bassFilter) bassFilter.gain.value = v; }));

            header.prepend(wrap);

            if(localStorage.getItem('ytm-vol')) video.volume = localStorage.getItem('ytm-vol') / 100;
        }

        // 3. Ad-Skipper
        const ad = document.querySelector('.ad-showing, .ad-interrupting');
        if (ad && video) {
            video.playbackRate = SETTINGS.fastSpeed;
            video.muted = true;
            const skipButtons = document.querySelectorAll('.ytp-ad-skip-button, .ytp-skip-ad-button, .ytp-ad-overlay-close-button');
            skipButtons.forEach(btn => btn.click());
        }
    }

    setInterval(applyLogic, SETTINGS.checkInterval);

    // Initialisierung bei erstem Klick
    document.addEventListener('mousedown', function initOnAction() {
        if (!isAudioInited) initAudio();
    }, { once: false });

    // CSS Korrekturen
    const style = document.createElement('style');
    style.textContent = `
        .top-row-buttons.ytmusic-player { min-width: 600px !important; overflow: visible !important; }
        #custom-ytm-controls input[type=range] { -webkit-appearance: none; background: #333; border-radius: 5px; }
        #custom-ytm-controls input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: white; border-radius: 50%; cursor: pointer; }
    `;
    document.head.appendChild(style);
})();
