// ==UserScript==
// @name         nhentai 滚动浏览
// @namespace    npm/vite-plugin-monkey
// @version      0.0.2
// @description  一个提升nhentai的脚本，包括无限滚动加载，滚动浏览图片
// @license      MIT
// @icon         https://nhentai.net/favicon.ico
// @match        https://nhentai.net/*
// @grant        GM_addStyle
// @run-at       document-end
// @downloadURL https://update.greasyfork.org/scripts/547087/nhentai%20%E6%BB%9A%E5%8A%A8%E6%B5%8F%E8%A7%88.user.js
// @updateURL https://update.greasyfork.org/scripts/547087/nhentai%20%E6%BB%9A%E5%8A%A8%E6%B5%8F%E8%A7%88.meta.js
// ==/UserScript==

(function () {
	'use strict';

	const d$1=new Set;const e = async e=>{d$1.has(e)||(d$1.add(e),(t=>{typeof GM_addStyle=="function"?GM_addStyle(t):document.head.appendChild(document.createElement("style")).append(t);})(e));};

	e("/*! tailwindcss v4.1.12 | MIT License | https://tailwindcss.com */@layer theme{:root,:host{--color-gray-200:oklch(92.8% .006 264.531);--color-gray-600:oklch(44.6% .03 256.802);--color-black:#000;--color-white:#fff;--spacing:.25rem;--text-xl:1.25rem;--text-xl--line-height:calc(1.75/1.25);--radius-sm:.25rem;--animate-spin:spin 1s linear infinite}}@layer utilities{.absolute{position:absolute}.relative{position:relative}.top-\\[20px\\]{top:20px}.right-\\[10px\\]{right:10px}.container{width:100%}@media (min-width:40rem){.container{max-width:40rem}}@media (min-width:48rem){.container{max-width:48rem}}@media (min-width:64rem){.container{max-width:64rem}}@media (min-width:80rem){.container{max-width:80rem}}@media (min-width:96rem){.container{max-width:96rem}}.mx-auto{margin-inline:auto}.mb-\\[30px\\]{margin-bottom:30px}.ml-5{margin-left:calc(var(--spacing)*5)}.block{display:block}.flex{display:flex}.size-10{width:calc(var(--spacing)*10);height:calc(var(--spacing)*10)}.max-h-\\[90vh\\]{max-height:90vh}.w-auto{width:auto}.w-fit{width:fit-content}.animate-spin{animation:var(--animate-spin)}.items-center{align-items:center}.justify-center{justify-content:center}.rounded-\\[4px\\]{border-radius:4px}.rounded-full{border-radius:3.40282e38px}.border-gray-200{border-color:var(--color-gray-200)}.bg-\\[\\#1f1f1f\\]{background-color:#1f1f1f}.bg-black\\/70{background-color:#000000b3}@supports (color:color-mix(in lab,red,red)){.bg-black\\/70{background-color:color-mix(in oklab,var(--color-black)70%,transparent)}}.object-contain{object-fit:contain}.p-\\[20px\\]{padding:20px}.px-\\[10px\\]{padding-inline:10px}.py-5{padding-block:calc(var(--spacing)*5)}.py-\\[5px\\]{padding-block:5px}.pt-5{padding-top:calc(var(--spacing)*5)}.pb-10{padding-bottom:calc(var(--spacing)*10)}.text-center{text-align:center}.text-xl{font-size:var(--text-xl);line-height:var(--tw-leading,var(--text-xl--line-height))}.text-\\[14px\\]{font-size:14px}.text-white{color:var(--color-white)}#scroll-mode.btn.btn-primary{margin-left:calc(var(--spacing)*0)!important;background-color:#4caf50!important;border-color:#4caf50!important}#scroll-mode.btn.btn-primary:hover{background-color:#388e3c!important;border-color:#388e3c!important}#scroll-mode.btn.btn-primary .fa{margin-right:5px}}:root{--nhentai:#ed2553}@layer components{.page-indicator{top:calc(var(--spacing)*32);right:calc(var(--spacing)*5);border-radius:var(--radius-sm);background-color:var(--color-gray-600);padding-inline:calc(var(--spacing)*5);padding-block:calc(var(--spacing)*1);position:fixed}.border-nhentai{border-width:3px;border-top-color:var(--nhentai);border-style:solid}.image-placeholder{background-color:#2a2a2a;justify-content:center;align-items:center;width:63.2967vh;height:90vh;margin-inline:auto;display:flex}.gallery,.thumb-container{z-index:1;transition:transform .3s ease-in-out;position:relative}.gallery:hover,.thumb-container:hover{z-index:100;transform:scale(1.3)}.caption{background-color:#000000b3;padding:8px;transition:all .3s ease-in-out}.gallery:hover .caption,.thumb-container:hover .caption{background-color:#000000b3}}@keyframes spin{to{transform:rotate(360deg)}}");let t=null;const n=new WeakMap;function o(e){return new Proxy(e,{get(e,o,r){const i=Reflect.get(e,o,r);return function(e,o){if(!t)return;let r=n.get(e);r||n.set(e,r=new Map);let i=r.get(o);i||r.set(o,i=new Set),i.add(t);}(e,o),i},set(e,t,o,r){if(Reflect.get(e,t,r)===o)return  true;const i=Reflect.set(e,t,o,r);return function(e,t){const o=n.get(e);if(!o)return;const r=o.get(t);r&&r.forEach(e=>e());}(e,t),i}})}function r(e){t=e,e(),t=null;}var i="object"==typeof global&&global&&global.Object===Object&&global,a="object"==typeof self&&self&&self.Object===Object&&self,l=i||a||Function("return this")(),s=l.Symbol,c=Object.prototype,u=c.hasOwnProperty,p=c.toString,d=s?s.toStringTag:void 0;var m=Object.prototype.toString;var h=s?s.toStringTag:void 0;function f(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":h&&h in Object(e)?function(e){var t=u.call(e,d),n=e[d];try{e[d]=void 0;var o=!0;}catch(i){}var r=p.call(e);return o&&(t?e[d]=n:delete e[d]),r}(e):function(e){return m.call(e)}(e)}var g=/\s/;var y=/^\s+/;function b(e){return e?e.slice(0,function(e){for(var t=e.length;t--&&g.test(e.charAt(t)););return t}(e)+1).replace(y,""):e}function v(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var w=/^[-+]0x[0-9a-f]+$/i,x=/^0b[01]+$/i,k=/^0o[0-7]+$/i,E=parseInt;function S(e){if("number"==typeof e)return e;if(function(e){return "symbol"==typeof e||function(e){return null!=e&&"object"==typeof e}(e)&&"[object Symbol]"==f(e)}(e))return NaN;if(v(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=v(t)?t+"":t;}if("string"!=typeof e)return 0===e?e:+e;e=b(e);var n=x.test(e);return n||k.test(e)?E(e.slice(2),n?2:8):w.test(e)?NaN:+e}var O=function(){return l.Date.now()},j=Math.max,T=Math.min;function P(e,t,n){var o,r,i,a,l,s,c=0,u=false,p=false,d=true;if("function"!=typeof e)throw new TypeError("Expected a function");function m(t){var n=o,i=r;return o=r=void 0,c=t,a=e.apply(i,n)}function h(e){var n=e-s;return void 0===s||n>=t||n<0||p&&e-c>=i}function f(){var e=O();if(h(e))return g(e);l=setTimeout(f,function(e){var n=t-(e-s);return p?T(n,i-(e-c)):n}(e));}function g(e){return l=void 0,d&&o?m(e):(o=r=void 0,a)}function y(){var e=O(),n=h(e);if(o=arguments,r=this,s=e,n){if(void 0===l)return function(e){return c=e,l=setTimeout(f,t),u?m(e):a}(s);if(p)return clearTimeout(l),l=setTimeout(f,t),m(s)}return void 0===l&&(l=setTimeout(f,t)),a}return t=S(t)||0,v(n)&&(u=!!n.leading,i=(p="maxWait"in n)?j(S(n.maxWait)||0,t):i,d="trailing"in n?!!n.trailing:d),y.cancel=function(){ void 0!==l&&clearTimeout(l),c=0,o=s=r=l=void 0;},y.flush=function(){return void 0===l?a:g(O())},y}class z{currentPage;totalPages;loadNextPage;isLoading=false;scrollListener;throttleTime;constructor(e){this.currentPage=e.currentPage||1,this.totalPages=e.totalPages,this.loadNextPage=e.loadNextPage,this.throttleTime=200,this.scrollListener=function(e,t,n){var o=true,r=true;if("function"!=typeof e)throw new TypeError("Expected a function");return v(n)&&(o="leading"in n?!!n.leading:o,r="trailing"in n?!!n.trailing:r),P(e,t,{leading:o,maxWait:t,trailing:r})}(this.handleScroll.bind(this),this.throttleTime),window.addEventListener("scroll",this.scrollListener);}handleScroll(){if(this.isLoading||this.currentPage>=this.totalPages)return;const e=document.documentElement.scrollTop||document.body.scrollTop,t=document.documentElement.scrollHeight||document.body.scrollHeight;(e+(document.documentElement.clientHeight||window.innerHeight))/t>=.8&&this.loadNext();}async loadNext(){this.isLoading=true;const e=this.currentPage+1;try{await this.loadNextPage(e),this.currentPage=e;}catch(t){await this.retryLoad(e);}finally{this.isLoading=false;}}async retryLoad(e){await new Promise(e=>setTimeout(e,500));try{await this.loadNextPage(e),this.currentPage=e;}catch(t){await this.retryLoad(e);}}}function L(){const e=document.createElement("div");return e.id="indicator",e.className="page-indicator",document.body.appendChild(e),e}function I(e){const t=o({page:0,total:0}),n=L();r(()=>{n.textContent=`${t.page} / ${t.total}`;});const i=document.querySelector(".pagination > .last");if(i){const e=i.href,n=new URL(e).searchParams.get("page");n&&(t.total=parseInt(n,10));}else t.total=1;const a=location.href;let l;const s=new URL(a).searchParams.get("page");s?(l=parseInt(s,10),t.page=parseInt(s,10)):(t.page=1,l=1);const c=document.querySelector("section.pagination");c&&c.remove();const u=document.getElementById("content"),p=document.createElement("div");p.id="loading",p.innerHTML='\n        <div class="flex justify-center items-center py-5">\n            <div class="size-10 border-nhentai border-gray-200 rounded-full animate-spin"></div>\n            <span class="text-white ml-5 text-xl">加载中...</span>\n        </div>\n    ',u?.appendChild(p),r(()=>{t.page===t.total&&(p.innerHTML='\n                <div class="flex justify-center items-center pt-5 pb-10">\n                    <span class="text-white text-xl"> - 已经没有了 - </span>\n                </div>\n            ');});const d=document.querySelector(e),m=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const n=new Map,o=e.target.getAttribute("data-page");if(!o)return;if(n.has(o)){const e=n.get(o);if(void 0===e)return;n.set(o,e+1);}else n.set(o,1);const r=Math.max(...n.values()),i=[...n.entries()].find(([e,t])=>t===r)[0];t.page=Number(i);}});},{threshold:0});d&&d.querySelectorAll("img.lazyload").forEach(e=>{e.setAttribute("data-page",l.toString()),m.observe(e);}),new z({totalPages:t.total,currentPage:l,loadNextPage:async t=>{const n=new URL(window.location.href);n.searchParams.set("page",String(t));const o=await fetch(n.href);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const r=function(e){return (new DOMParser).parseFromString(e,"text/html")}(await o.text()),i=r.querySelector(e),a=document.querySelector(e);if(!i||!a)throw new Error("找不到容器元素");const l=document.createDocumentFragment();Array.from(i.children).forEach(e=>{l.appendChild(e);}),l.querySelectorAll("img.lazyload").forEach(e=>{const n=e.getAttribute("data-src");m.observe(e),n&&(e.src=n),e.setAttribute("data-page",t.toString());}),a.appendChild(l);}});}const $=Symbol.for("[values]"),N=Symbol.for("[items]"),M=Symbol.for("[keys]"),R=Symbol.for("[EnumItem]"),C=Symbol.for("[EnumCollection]"),_=Symbol.for("[EnumItems]"),A={localize:e=>"enum-plus.options.all"===e?"All":e};var W={};class q{value;label;key;raw;[R]=true;#e;#t=new Proxy(this,{get:(e,t)=>{const n=e[t];return "label"===t?e.toString():"function"==typeof n?n.bind(e):n},set:(e,t)=>(W.JEST_WORKER_ID||console.warn(`Cannot modify property "${String(t)}" on EnumItem. EnumItem instances are readonly and should not be mutated.`),true),defineProperty:(e,t)=>(W.JEST_WORKER_ID||console.warn(`Cannot modify property "${String(t)}" on EnumItem. EnumItem instances are readonly and should not be mutated.`),true),deleteProperty:(e,t)=>(W.JEST_WORKER_ID||console.warn(`Cannot modify property "${String(t)}" on EnumItem. EnumItem instances are readonly and should not be mutated.`),true),setPrototypeOf:()=>(W.JEST_WORKER_ID||console.warn("Cannot change prototype of EnumItem. EnumItem instances are immutable."),true)});constructor(e,t,n,o,r){this.key=e,this.value=t,this.label=n,this.raw=o,this.#e=e=>{const t=r?.localize??A.localize;return "function"==typeof t?t(e):e},this[Symbol.toPrimitive]=e=>"number"===e?this.valueOf():"string"===e?this.toString():this.valueOf();}readonly(){return this.#t}toString(){return this.#e(this.label)??this.label}toLocaleString(){return this.toString()}valueOf(){return this.value}}class D extends Array{#n;#e;#o={firstOption:false};constructor(e,t,...n){super(...n),this.#n=e,this.#e=e=>{const n=t?.localize??A.localize;return "function"==typeof n?n(e):e};}[_]=true;label(e){return (this.find(t=>t.value===e)??this.find(t=>t.key===e))?.label}key(e){return this.find(t=>t.value===e)?.key}raw(e){if(null==e)return this.#n;{if(Object.keys(this.#n).some(t=>t===e))return this.#n[e];const t=this.find(t=>t.value===e);return t?t.raw:void 0}}has(e){return this.some(t=>t.value===e||t.key===e)}toSelect(e=this.#o){const{firstOption:t=this.#o.firstOption}=e;if(t){if(true===t){const t=("firstOptionValue"in e?e.firstOptionValue:void 0)??"",n=("firstOptionLabel"in e?e.firstOptionLabel:void 0)??"enum-plus.options.all";return [{key:"",value:t,label:this.#e(n)},...this]}return [{...t,key:t.key??t.value,label:this.#e(t.label)},...this]}return this}options(e){return this.toSelect(e)}toValueMap(){const e={};for(let t=0;t<this.length;t++){const{value:n,label:o}=this[t];e[n]={text:o};}return e}valuesEnum(){return this.toValueMap()}toMenu(){return this.map(({value:e,label:t})=>({key:e,label:t}))}menus(){return this.toMenu()}toFilter(){return this.map(({value:e,label:t})=>({text:t,value:e}))}filters(){return this.toFilter()}get valueType(){throw new Error("The valueType property of the enumeration is only allowed to be used to declare the ts type, and cannot be accessed at runtime! Please use the `typeof` operator in the ts type, for example: typeof Week.valueType")}get keyType(){throw new Error("The keyType property of the enumeration is only allowed to be used to declare the ts type, and cannot be accessed at runtime! Please use the `typeof` operator in the ts type, for example: typeof Week.keyType")}get rawType(){throw new Error("The rawType property of the enumeration is only allowed to be used to declare the ts type, and cannot be accessed at runtime! Please use the `typeof` operator in the ts type, for example: typeof Week.rawType")}}class H{}class F extends H{_options;items;keys;[C]=true;get name(){const e=this._options?.localize??A.localize;return "function"==typeof e?e(this._options?.name):this._options?.name}constructor(e={},t){super(),this._options=t;const n=Object.keys(e).filter(t=>!(/^-?\d+$/.test(t)&&t===`${e[e[t]]??""}`)),o=n.map(t=>function(e,t){let n,o;if(null!=e)if("number"==typeof e||"string"==typeof e||"symbol"==typeof e)n=e,o=t;else {if("object"!=typeof e)throw new Error(`Invalid enum item: ${JSON.stringify(e)}`);"[object Object]"===Object.prototype.toString.call(e)?"value"in e&&Object.keys(e).some(e=>"value"===e)?(n=e.value??t,o="label"in e&&Object.keys(e).some(e=>"label"===e)?e.label:t):"label"in e&&Object.keys(e).some(e=>"label"===e)?(n=t,o=e.label??t):(n=t,o=t):(n=e,o=t);}else n=t,o=t;return {value:n,label:o}}(e[t],t));n.forEach((e,t)=>{const{value:n}=o[t];this[e]=n;}),Object.freeze(n),this[Object.keys(e).some(e=>"keys"===e)?M:"keys"]=n;const r=new D(e,this._options,...n.map((t,n)=>{const{value:r,label:i}=o[n];return new q(t,r,i,e[t],this._options).readonly()}));this[Object.keys(e).some(e=>"items"===e)?N:"items"]=r,this[Object.keys(e).some(e=>"values"===e)?$:"values"]=r,this[Symbol.hasInstance]=e=>this.items.some(t=>e==t.value||e===t.key),Object.freeze(this),Object.freeze(this.items),Object.freeze(this.keys);}label(e){return this.items.label(e)}key(e){return this.items.key(e)}raw(e){return null!=e?this.items.raw(e):this.items.raw()}has(e){return this.items.has(e)}toSelect(e){return this.items.toSelect(e)}options(e){return this.items.options(e)}toMenu(){return this.items.toMenu()}menus(){return this.items.menus()}toFilter(){return this.items.toFilter()}filters(){return this.items.filters()}toValueMap(){return this.items.toValueMap()}valuesEnum(){return this.items.valuesEnum()}get valueType(){return this.items.valueType}get keyType(){return this.items.keyType}get rawType(){return this.items.rawType}}let U;const V=(e,t)=>{if(Array.isArray(e)){const n=function(e,t){const{getValue:n="value",getLabel:o="label",getKey:r="key"}=t??{};return e.reduce((e,t)=>{const i="function"==typeof n?n(t):t[n],a="function"==typeof o?o(t):t[o];let l;return r&&(l="function"==typeof r?r(t):t[r]),e[l??i]={...t,label:a||(l??"")||(null!=i?i.toString():i),value:i},e},{})}(e,t);return new F(n,t)}return new F(e,t)};Object.defineProperty(V,"localize",{get:()=>A.localize,set:e=>{A.localize=e;}}),V.extends=function(e){if(void 0!==e&&"[object Object]"!==Object.prototype.toString.call(e))throw new Error("The extension of Enum must be an object");U=void 0!==e?e:{},Object.setPrototypeOf(H.prototype,U);};const J=V({webp:{value:"w",ext:".webp"},jpg:{value:"j",ext:".jpg"},png:{value:"p",ext:".png"}});function K(e,t){return new Promise((n,o)=>{const r=new Image;r.src=e,r.className="max-h-[90vh] w-auto block mx-auto object-contain";const i=new URL(e).pathname.split("/").at(-1),a=i?.split(".")[0];r.onload=()=>n({page:Number(a),img:r}),r.onerror=()=>o({index:t,error:"Failed to load image"});})}const B=window.location.pathname;if("/"===B||["/search/","/parody/","/tag/","/artist/","/group/","/language/","/category/","/character/"].some(e=>B.includes(e)))I(".container.index-container:not(.index-popular)");else if(B.includes("/g/")){"true"===new URL(window.location.href).searchParams.get("single")?async function(){const e=o({page:0,total:0}),t=L();r(()=>{t.innerHTML=`\n            <span>加载中... ${e.page} / ${e.total}</span>\n        `,e.total===e.page&&0!==e.total&&t.remove();});const n=new URL(window.location.href).pathname,[i,a,l,s,c]=n.split("/"),u=Number(s),p=document.getElementById("content");if(!p)return;const d=document.querySelector(".page-number.btn.btn-unstyled > .num-pages");if(!d)return;const m=Number(d.textContent);e.total=m-u+1,p.remove();const h=document.createElement("div");h.className="w-fit mx-auto p-[20px] bg-[#1f1f1f]",document.body.appendChild(h);for(let o=u;o<=m;o++){const e=document.createElement("div");e.className="relative mb-[30px] text-center w-fit mx-auto",e.id=`image-wrapper-${o}`,e.innerHTML=`\n        <div class="image-placeholder"></div>\n        <span class="absolute top-[20px] right-[10px] bg-black/70 text-white px-[10px] py-[5px] rounded-[4px] text-[14px]">${o} / ${m}</span>\n        `,h.appendChild(e);}const{images:f,media_id:g}=await async function(e){const t=await fetch(`https://nhentai.net/api/gallery/${e}`);return await t.json()}(l),y=[],b=[];for(let o=u;o<=m;o++){const e=`https://i1.nhentai.net/galleries/${g}/${o}${J.raw(f.pages[o-1].t).ext}`;y.push(e),b.push(e);}!async function(){const t=[];for(;b.length>0||t.length>0;){if(t.length<3&&b.length>0){const n=b.shift();if(!n)return;const o=y.indexOf(n);K(n,o).then(({page:t,img:n})=>{const o=document.getElementById(`image-wrapper-${t}`);if(!o)return;const r=o.querySelector(".image-placeholder");r&&r.remove(),o.appendChild(n),e.page+=1;}).catch(({index:e})=>{console.log(`Image ${e} failed, retrying...`),b.push(y[e]);}).finally(()=>{const e=t.indexOf(o);e>=0&&t.splice(e,1);}),t.push(o);}await new Promise(e=>setTimeout(e,100));}}();}():function(){const e=document.querySelector("#favorite");if(!e)return;const t=document.createElement("button");t.id="scroll-mode",t.className="btn btn-primary",t.innerHTML='\n        <i class="fa fa-scroll"></i>\n        <span class="text">滚动浏览</span>\n    ',t.addEventListener("click",()=>{const e=new URL(window.location.href),t=e.pathname.split("/"),n=`${t[1]}/${t[2]}/1/`;window.location.href=`${e.origin}/${n}?single=true`;}),e.parentNode?.insertBefore(t,e.nextSibling);}();}else B.includes("/favorites/")&&I(".container#favcontainer");

})();