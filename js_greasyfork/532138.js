// ==UserScript==
// @name         ShadConnect | Foreman Mode
// @namespace    http://tampermonkey.net/
// @version      5.4.1
// @description  Foreman Mode: Sign-in presets, Prestart Generator, PTA Helper, Machine Prestarts, Preferences (Condensed + Compressed)
// @match        https://employee.shadconnect.com.au/*
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/532138/ShadConnect%20%7C%20Foreman%20Mode.user.js
// @updateURL https://update.greasyfork.org/scripts/532138/ShadConnect%20%7C%20Foreman%20Mode.meta.js
// ==/UserScript==
(function(){'use strict';
const fa=document.createElement('link');fa.rel='stylesheet';fa.href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';document.head.appendChild(fa);
const $=(s,r=document)=>r.querySelector(s),$$=(s,r=document)=>Array.from(r.querySelectorAll(s)),sleep=ms=>new Promise(r=>setTimeout(r,ms)),log=(s,...a)=>console.log(`[${s}]`,...a);
const fireInput=(el,v)=>{if(!el)return;el.focus();el.value=v;el.dispatchEvent(new Event('input',{bubbles:true}));el.dispatchEvent(new Event('change',{bubbles:true}));el.blur?.();};
const waitFor=(selector,{textEquals,root=document,timeout=10000}={})=>{const now=()=>{const els=$$(selector,root);if(!els.length)return null;return textEquals?els.find(e=>e.textContent.trim()===textEquals.trim())||null:els[0];};return new Promise((res,rej)=>{const hit=now();if(hit)return res(hit);const mo=new MutationObserver(()=>{const m=now();if(m){mo.disconnect();res(m);}});mo.observe(root,{childList:true,subtree:true});setTimeout(()=>{mo.disconnect();rej(`Timeout: ${selector}${textEquals?` = "${textEquals}"`:''}`)},timeout);})};
const parseCSV=t=>t.trim().split('\n').map(l=>l.split(',')),toast=m=>{const d=document.createElement('div');d.style.cssText='position:fixed;bottom:10px;left:10px;background:#ff4444;color:#fff;padding:8px;border-radius:5px;z-index:99999;';d.textContent=m;document.body.appendChild(d);setTimeout(()=>d.remove(),6000);},zBump=()=>{const o=$$('.dx-overlay-wrapper').filter(o=>o.querySelector('.dx-list')).at(-1);if(!o)return;const p=$$('.dx-popup-wrapper').at(-1);o.style.zIndex=String((p?parseInt(getComputedStyle(p).zIndex||'1500',10):1500)+2);};
const css=`.fmContainer,.submitModal{width:180px;position:fixed;top:0;right:145px;z-index:99999;background:#636b70;color:#fff;font-family:Geomanist-Book,serif;font-size:16px;padding:15px;border:none;border-radius:8px;box-shadow:0 0 grey;transition:box-shadow .3s ease-in-out}.fmContainer.open{box-shadow:5px 5px #d3dc26}.fmContainer.open .menuWrapper{padding-bottom:11px}.fmContainer button,.submitModal button,.ptaModal button{width:100%;margin-bottom:8px;font-family:Geomanist-Book,serif;font-size:10pt;background:teal;color:#fff;border:none;cursor:pointer;padding:8px 12px;transition:border-radius .3s;text-transform:uppercase;border-radius:6px}.fmContainer button:hover{border-radius:100px}.currentPage{background:#d3dc26!important;color:grey!important}#toggleButton{cursor:pointer;color:#fff;font-weight:bold;margin-bottom:0;text-align:center}#toggleButton .words{float:left}.menu-icon{width:22px;height:16px;position:relative;cursor:pointer;transition:transform .3s;float:right;margin:4px 11px 0 0}.menu-icon span{position:absolute;height:3px;width:100%;background:#fff;border-radius:2px;transition:all .3s}.menu-icon span:nth-child(1){top:0}.menu-icon span:nth-child(2){top:6.5px}.menu-icon span:nth-child(3){top:13px}.menu-icon.open span:nth-child(1){transform:rotate(45deg);top:6.5px}.menu-icon.open span:nth-child(2){opacity:0}.menu-icon.open span:nth-child(3){transform:rotate(-45deg);top:6.5px}.clearfix{overflow:auto}.clearfix::after{content:'';clear:both;display:table}.itemsWrapper{max-height:500px;overflow:hidden;transition:max-height .3s ease-in-out;top:18px;position:relative}.menuOpen.itemsWrapper{max-height:0}#prefsBtn{background:grey}.submitModal{top:auto!important;bottom:100px;box-shadow:5px 5px #d3dc26}.submitModal ul{margin:0;padding:0 0 0 16px}.submitModal strong{display:block;margin-bottom:6px}.submitModal ul li::marker{color:#d3dc26}.fm-spoof-submenu{margin:-8px 0 10px;font-size:12px;padding:10px;max-height:150px;overflow-y:auto;background:#d3dc26}.fm-spoof-submenu .fm-loc{width:100%;margin-bottom:6px;font-family:Geomanist-Book,serif;font-size:8pt;color:#fff;border:none;cursor:pointer;padding:8px 12px;border-radius:6px;background:teal}.ptaModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:min(760px,92vw);max-height:80vh;overflow:auto;background:#636b70;color:#fff;z-index:99999;border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.25);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;border:1px solid #e6e6e6;padding:16px 16px 10px}.ptaHead{display:flex;align-items:center;gap:12px;padding:6px 8px 12px;border-bottom:1px solid #eee;margin:-6px -6px 12px}.ptaHead .icon{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#e8f5e9}.ptaHead h3{margin:0;font-weight:700;font-size:18px}.ptaList{display:grid;grid-template-columns:1fr;gap:8px}@media (min-width:680px){.ptaList{grid-template-columns:1fr 1fr}}.ptaBtn{display:block;text-align:left;border:1px solid #e6e6e6;background:#fafafa;border-radius:10px;padding:10px 12px;cursor:pointer;transition:transform .06s ease,box-shadow .12s ease,border-color .12s ease;color:#333;text-transform:none}.ptaBtn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.08);border-color:#d7d7d7;background:#d3dc26!important}.ptaBtn strong{font-weight:700;color:#000}.ptaBtn em{font-style:normal;opacity:.85}.ptaBtn small{display:block;opacity:.7;margin-top:2px}.ptaFoot{display:flex;justify-content:flex-end;gap:8px;padding-top:10px;border-top:1px solid #eee;margin-top:12px}.ptaClose{background:#f2f2f2;border:1px solid #e1e1e1;border-radius:8px;padding:8px 12px;cursor:pointer}.ptaClose:hover{background:#eaeaea}`;
const st=document.createElement('style');st.textContent=css;document.head.appendChild(st);

/* PTA (condensed) */
(function(){const CSV_FALLBACK="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg_UV1Bj6FKzxU4iVmyX0mwLaAd5lQtZIIemLFgbO3bmsZPXzd5vmuUtGDzLrZv23RWiqfOCcsqv54/pub?output=csv";
const fetchTemplates=async(url)=>{const rows=parseCSV(await (await fetch(url)).text());if(!rows.length)return[];const[hdr,...data]=rows,idx=n=>hdr.findIndex(h=>(h||'').trim().toLowerCase()===n),col={taskCategory:idx('task category'),hazardType:idx('hazard type'),taskDesc:idx('task description'),hazardDesc:idx('hazard description'),controls:idx('controls')};return data.map(r=>({taskCategory:(r[col.taskCategory]||'').trim(),hazardType:(r[col.hazardType]||'').trim(),taskDescription:(r[col.taskDesc]||'').trim(),hazardDescription:(r[col.hazardDesc]||'').trim(),controls:((r[col.controls]||'')).split(';').map(s=>s.trim()).filter(Boolean)})).filter(t=>t.taskCategory&&t.hazardType)};
const clickYesLike=()=>{const y=t=>/yes|true|pass/i.test((t||'').trim());$$('.dx-checkbox').forEach(cb=>{const l=cb.querySelector('.dx-checkbox-text')?.textContent;if(y(l)&&!cb.classList.contains('dx-checkbox-checked'))cb.click();});$$('.dx-radiobutton').forEach(rb=>{const l=rb.querySelector('.dx-radiobutton-text')?.textContent;if(y(l)&&!rb.classList.contains('dx-radiobutton-checked'))(rb.querySelector('input[type=radio]')||rb).dispatchEvent(new MouseEvent('click',{bubbles:true}));});$$('.dx-switch').forEach(sw=>{const l=sw.nextElementSibling?.textContent||'';if(y(l)&&sw.getAttribute('aria-checked')!=='true')sw.dispatchEvent(new MouseEvent('click',{bubbles:true}));});};
const ensureField=async(label,{timeout=12000}={})=>{const n=s=>(s||'').replace(/\s+/g,' ').trim().toLowerCase(),t0=Date.now();while(Date.now()-t0<timeout){const f=$$('.field').find(f=>n(f.querySelector('.field-label')?.textContent).includes(n(label)));const lu=f?.querySelector('dx-lookup');if(lu&&!lu.classList.contains('dx-state-disabled')&&getComputedStyle(lu).display!=='none')return f;await sleep(180)}return null};
const selectDxLookupByLabel=async(label,opt)=>{const f=await ensureField(label);if(!f)return false;const t=f.querySelector('dx-lookup .dx-lookup-field');if(!t)return false;const want=(opt||'').replace(/\s+/g,' ').trim().toLowerCase(),pick=r=>{const it=r?.querySelectorAll('.dx-list-item, .dx-list-item .dx-list-item-content')||[];return Array.from(it).find(i=>{const tx=(i.textContent||'').replace(/\s+/g,' ').trim().toLowerCase();return tx===want||tx.includes(want)})};t.click();zBump();let ov=await waitFor('.dx-overlay-wrapper .dx-list',{timeout:900}).catch(()=>null);if(!ov){await waitFor('.dx-overlay-wrapper .dx-list',{timeout:4000}).catch(()=>{});t.click();zBump();ov=await waitFor('.dx-overlay-wrapper .dx-list',{timeout:1500}).catch(()=>null)}if(!ov)return false;let hit=pick(ov);if(!hit){const s=ov.closest('.dx-lookup-popup')?.querySelector('.dx-lookup-search input.dx-texteditor-input')||$('.dx-lookup-search input.dx-texteditor-input');if(s){fireInput(s,opt);await sleep(200);hit=pick(ov)}}if(hit){(hit.closest('.dx-list-item')||hit).click();document.body.click();return true}document.body.click();console.warn('[PTA] Option not found:',opt);return false};
const fillPTAFields=async(t)=>{const task=await waitFor('dx-text-box input.dx-texteditor-input',{timeout:5000});const a=$$('textarea.dx-texteditor-input'),haz=a[0],ctrl=a[1];fireInput(task,t.taskDescription);await sleep(120);if(haz)fireInput(haz,t.hazardDescription);if(ctrl)fireInput(ctrl,t.controls.join('\n'));await sleep(360);if(haz&&!haz.value.trim())fireInput(haz,t.hazardDescription);if(ctrl&&!ctrl.value.trim())fireInput(ctrl,t.controls.join('\n'))};
const waitAndAutofill=t=>{const mo=new MutationObserver(()=>{const task=$('dx-text-box input.dx-texteditor-input'),a=$$('textarea.dx-texteditor-input');if(task&&a.length>=2){const[haz,ctrl]=a;fireInput(task,t.taskDescription);fireInput(haz,'');fireInput(ctrl,'');setTimeout(()=>{fireInput(haz,t.hazardDescription);fireInput(ctrl,t.controls.join('\n'));setTimeout(()=>{if(!haz.value.trim())fireInput(haz,t.hazardDescription);if(!ctrl.value.trim())fireInput(ctrl,t.controls.join('\n'))},800)},280);mo.disconnect();}});mo.observe(document.body,{childList:true,subtree:true})};
const openPTAModal=ts=>{if(window.__ptaOpen)return;window.__ptaOpen=true;const m=document.createElement('div');m.className='ptaModal';m.innerHTML=`<div class="ptaHead"><div class="icon">üõ†Ô∏è</div><h3>Select a PTA Template</h3></div><div class="ptaList"></div><div class="ptaFoot"><button class="ptaClose">Cancel</button></div>`;const list=m.querySelector('.ptaList');ts.forEach(t=>{const b=document.createElement('button');b.className='ptaBtn';b.innerHTML=`<strong>${t.taskCategory}</strong> ‚Äî <em>${t.hazardType}</em><small>${t.taskDescription}</small>`;b.onclick=async()=>{m.remove();window.__ptaOpen=false;clickYesLike();await sleep(700);const okCat=await selectDxLookupByLabel('Task Category',t.taskCategory);if(!okCat)return alert(`Couldn't select Task Category: ${t.taskCategory}`);fireInput($('dx-text-box input.dx-texteditor-input'),t.taskDescription);const hazField=await ensureField('Hazard Type',{timeout:10000});if(!hazField)return alert('Hazard Type field did not appear. Check required answers.');let okHaz=await selectDxLookupByLabel('Hazard Type',t.hazardType);if(!okHaz){await sleep(250);okHaz=await selectDxLookupByLabel('Hazard Type',t.hazardType)}if(!okHaz)return alert(`Couldn't select Hazard Type: ${t.hazardType}`);await fillPTAFields(t);waitAndAutofill(t)};list.appendChild(b)});m.querySelector('.ptaClose').onclick=()=>{m.remove();window.__ptaOpen=false};document.body.appendChild(m)};
const ptaTriggerBtn=document.createElement('button');ptaTriggerBtn.textContent='Autofill PTA';ptaTriggerBtn.style.opacity='0';ptaTriggerBtn.onclick=async()=>{try{ptaTriggerBtn.disabled=true;ptaTriggerBtn.textContent='Loading templates...';const url=localStorage.getItem('ptaCSVUrl')||CSV_FALLBACK;const t=await fetchTemplates(url).catch(()=>[]);ptaTriggerBtn.disabled=false;ptaTriggerBtn.textContent='Autofill PTA';if(!t.length)return alert('No templates found. Check CSV URL, headings and data.');openPTAModal(t)}catch(e){console.error('[PTA] Error:',e);alert('Failed to load PTA templates.');ptaTriggerBtn.disabled=false;ptaTriggerBtn.textContent='Autofill PTA'}};document.body.appendChild(ptaTriggerBtn);window.ptaTriggerBtn=ptaTriggerBtn;})();

/* Prestart (condensed) */
const scrollToDx=async el=>{const root=el.closest('.dx-popup-content')||document;const sr=root.querySelector('.dx-scrollview.dx-scrollable')||root.querySelector('.dx-scrollable');const DX=window.DevExpress?.ui;const inst=sr&&(DX?.dxScrollView?.getInstance(sr)||DX?.dxScrollable?.getInstance(sr));if(inst?.scrollToElement)return inst.scrollToElement(el);const c=el.closest('.dx-scrollable-wrapper')?.querySelector('.dx-scrollable-container');if(c){const r=el.getBoundingClientRect(),cr=c.getBoundingClientRect();c.scrollTo({top:Math.max(0,(r.top-cr.top)+(c.scrollTop||0)-(c.clientHeight-r.height)/2),behavior:'smooth'})}else el.scrollIntoView({behavior:'smooth',block:'center'})};
async function initPrestartFlow(){try{(await waitFor('app-kick-off-meeting-list > div > div i')).click();(await waitFor('div[role="generic"], div.dx-item-content',{textEquals:'Kick Off'})).click();await waitFor('.title-popup',{textEquals:'New Kick Off Meeting'});const siteField=await waitFor('[displayexpr="siteName"] .dx-lookup-field');await waitFor('.dx-scrollable-content .dx-list-item-content',{timeout:3000}).catch(()=>{});siteField.click();zBump();let it=await waitFor('.dx-overlay-wrapper .dx-list .dx-list-item-content',{timeout:1000}).catch(()=>null);if(!it){await waitFor('.dx-overlay-wrapper .dx-list .dx-list-item-content',{timeout:5000}).catch(()=>{});siteField.click();zBump()}const selectedSite=await(async()=>{const t0=Date.now();for(;;){const v=($('[displayexpr="siteName"] .dx-lookup-field')?.textContent||'').trim();if(v&&v!=='Select...')return v;if(Date.now()-t0>20000)throw new Error('Timeout waiting for site selection');await sleep(250)}})();log('Prestart',`Site selected: ${selectedSite}`);(await waitFor('dx-button .dx-button-text',{textEquals:'Copy Previous Meeting'})).closest('dx-button')?.click();log('Prestart','Copied previous meeting');await sleep(400);let submitBtn=await waitFor('dx-button[aria-label="Submit"]',{timeout:7000}).catch(()=>null);if(!submitBtn){const t=await waitFor('dx-button .dx-button-text',{textEquals:'Submit',timeout:7000}).catch(()=>null);submitBtn=t?.closest('dx-button')||null}if(submitBtn){await scrollToDx(submitBtn);submitBtn.querySelector('button, .dx-button-content')?.focus?.();if(!$('#fm-pulse-style')){const s=document.createElement('style');s.id='fm-pulse-style';s.textContent='@keyframes fmPulse{0%{box-shadow:0 0 0 0 rgba(50,205,50,.8)}70%{box-shadow:0 0 0 12px rgba(50,205,50,0)}100%{box-shadow:0 0 0 0 rgba(50,205,50,0)}}.fm-pulse{animation:fmPulse 1.2s ease-out 2;border-radius:8px}';document.head.appendChild(s)}submitBtn.classList.add('fm-pulse');setTimeout(()=>submitBtn.classList.remove('fm-pulse'),2400)}}catch(e){console.error('[Prestart Flow] Error:',e);alert(`[Prestart Error]\n${e}`)}}

/* Machine Prestarts (condensed) */
(function(){const TARGET_URL="https://employee.shadconnect.com.au/site-resources/equipment-prestart-checklist",SCOPE='MachinePrestart';
const fillForm=()=>{log(SCOPE,'Ticking Pass/Yes checkboxes‚Ä¶');let n=0;$$('.lbl-answer-value').forEach(l=>{const t=(l.textContent||'').trim().toLowerCase();if(t==='pass'||t==='yes'){const cb=l.closest('.d-flex')?.querySelector('.dx-checkbox');if(cb&&!cb.classList.contains('dx-checkbox-checked')){cb.click();n++}}});log(SCOPE,`Selected ${n} checkboxes.`)};
const waitForMachineToRender=async target=>{const c=await waitFor('.dx-list-items',{timeout:10000}).catch(()=>null);if(!c)throw new Error('Machine list container not found');const look=()=>$$( '.dx-list-item-content',c).find(el=>(el.textContent||'').includes(target))||null;const now=look();if(now)return now;return new Promise((res,rej)=>{const mo=new MutationObserver(()=>{const m=look();if(m){mo.disconnect();res(m)}});mo.observe(c,{childList:true,subtree:true});setTimeout(()=>{mo.disconnect();rej('Search results did not update in time.')},8000)})};
const selectMachineFromSearch=async name=>{try{const m=await waitForMachineToRender(name);if(m){log(SCOPE,'Selecting result:',(m.textContent||'').trim());m.click();return true}}catch(e){toast(e)}return false};
const handleConfirmationDialog=async()=>{const p=await waitFor('.dx-popup-content',{timeout:5000}).catch(()=>null);if(!p)return;const y=await waitFor('[aria-label="Yes"]',{timeout:5000}).catch(()=>null);if(y){log(SCOPE,'Confirming machine change');y.click()}};
const verifyAndFillForm=async m=>{const f=await waitFor('dx-lookup[placeholder*="Equipment"] .dx-lookup-field');const sel=(f.textContent||'').trim();log(SCOPE,`Verify: expected "${m}", got "${sel}"`);if(sel.includes(m)){fillForm();showSubmitModal(m)}else toast('Machine mismatch after selection.')};
const attempt=async m=>{log(SCOPE,'Attempt selection:',m);(await waitFor('div.mt-2 .dx-lookup-arrow')).click();await waitFor('.dx-lookup-popup');const inp=await waitFor('.dx-lookup-search input');fireInput(inp,m);const ok=await selectMachineFromSearch(m);if(!ok)return;await handleConfirmationDialog();await verifyAndFillForm(m)};
function showSubmitModal(m){if($('.submitModal'))return;const md=document.createElement('div');md.className='submitModal';md.innerHTML=`<strong>Machine ${m} prestart ready.</strong><br><br><button id="submitPrestart">Submit Prestart</button>`;document.body.appendChild(md);$('#submitPrestart').addEventListener('click',()=>{const sb=[...$$('dx-button[aria-label="Submit"]')].pop();if(!sb)return toast('Could not locate submit button');log(SCOPE,'Clicking submit‚Ä¶');sb.click();const dk='completedMachines',done=JSON.parse(localStorage.getItem(dk)||'[]');done.push(m);localStorage.setItem(dk,JSON.stringify(done));const ik='currentMachineIndex',idx=parseInt(localStorage.getItem(ik)||'0',10)||0;localStorage.setItem(ik,String(idx+1));setTimeout(()=>{location.href=TARGET_URL},4000)})}
function showCompletionModal(list){const md=document.createElement('div');md.className='submitModal';md.innerHTML=`<strong>Prestarts Completed</strong><ul>${list.map(n=>`<li>${n}</li>`).join('')}</ul><br><button id="closeReview">Confirm</button>`;document.body.appendChild(md);$('#closeReview').addEventListener('click',()=>md.remove())}
async function runMachinePrestartAutomation(){log(SCOPE,'Launching‚Ä¶');const sess=`prestartSession-${new Date().toISOString().slice(0,10)}`;let idx=parseInt(localStorage.getItem('currentMachineIndex')||'0',10)||0,done=JSON.parse(localStorage.getItem('completedMachines')||'[]'),names=[];const url=localStorage.getItem('ptaCSVUrl');if(!url)return toast('No PTA CSV URL found in Preferences');let rows=[];try{rows=parseCSV(await (await fetch(url)).text())}catch{return toast('CSV empty or unreadable')}if(!rows.length)return toast('CSV empty or unreadable');const hdr=rows[0].map(h=>(h||'').trim().toLowerCase()),mc=hdr.indexOf('machine name');if(mc===-1)return toast("CSV missing 'Machine Name' column");names=rows.slice(1).map(r=>(r[mc]||'').trim()).filter(n=>n&&n.toLowerCase()!=='machine name');log(SCOPE,`Loaded ${names.length} machines. index=${idx}`);if(!names.length)return toast('No valid machines in CSV');if(!localStorage.getItem(sess)){if(!confirm("You haven't submitted any prestarts today. Start now?"))return;localStorage.setItem(sess,'true');idx=0;done=[];localStorage.setItem('currentMachineIndex','0');localStorage.setItem('completedMachines','[]')}if(idx>=names.length)return showCompletionModal(done);const field=await waitFor('dx-lookup[placeholder*="Equipment"] .dx-lookup-field'),sel=(field.textContent||'').trim(),exp=names[idx];log(SCOPE,`Initial: expected "${exp}", got "${sel}"`);if(sel.includes(exp)){fillForm();showSubmitModal(exp)}else await attempt(exp)}
window.runMachinePrestartAutomation=runMachinePrestartAutomation;$('#machinePrestart')?.addEventListener('click',()=>{if(location.href.startsWith(TARGET_URL))setTimeout(runMachinePrestartAutomation,1000);else location.href=TARGET_URL});})();

/* Preferences */
function openPreferences(){$('#foremanPrefsModal')?.remove();const m=document.createElement('div');m.id='foremanPrefsModal';Object.assign(m.style,{position:'fixed',top:'50%',left:'50%',transform:'translate(-50%,-50%)',background:'#fff',border:'2px solid grey',borderRadius:'10px',padding:'20px',zIndex:100000,fontFamily:'Arial',fontSize:'10pt',boxShadow:'0 0 10px rgba(0,0,0,.2)',color:'#333'});m.innerHTML=`<div style="margin-bottom:8px;color:teal;font-weight:bold;">Foreman Preferences</div><label style="display:block;margin-top:12px;margin-bottom:4px;">Site Address:</label><input type="text" id="siteAddress" value="${localStorage.getItem('siteAddress')||''}" style="width:100%;padding:4px;border:1px solid grey;border-radius:4px;"><small style="color:gray;">Used to fetch and cache lat/lon coordinates</small><label style="display:block;margin-top:12px;margin-bottom:4px;">PTA CSV URL:</label><input type="text" id="ptaCSVUrl" value="${localStorage.getItem('ptaCSVUrl')||''}" style="width:100%;padding:4px;border:1px solid grey;border-radius:4px;"><button id="savePrefs" style="margin-top:10px;">Save</button><button id="closePrefs" style="margin-top:6px;background:grey;">Cancel</button>`;document.body.appendChild(m);$('#savePrefs').addEventListener('click',async()=>{const url=$('#ptaCSVUrl').value.trim(),addr=$('#siteAddress').value.trim();if(!url)return alert('Please enter a valid CSV URL.');localStorage.setItem('ptaCSVUrl',url);if(addr){localStorage.setItem('siteAddress',addr);try{const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`,{headers:{'User-Agent':'ForemanMode/1.0'}}),d=await r.json();if(d&&d[0]){localStorage.setItem('siteLat',d[0].lat);localStorage.setItem('siteLon',d[0].lon);alert('Preferences saved and coordinates updated!')}else alert('Address saved, but coordinates not found.')}catch(e){console.error('[ForemanMode] Geocode error:',e);alert('Address saved, but failed to fetch coordinates.')}}else{localStorage.removeItem('siteAddress');localStorage.removeItem('siteLat');localStorage.removeItem('siteLon')}m.remove()});$('#closePrefs').addEventListener('click',()=>m.remove())}

/* Sign-in spoof submenu (locations CSV) */
const LOCATION_CSV='https://docs.google.com/spreadsheets/d/e/2PACX-1vQnB6xLIgt0uukKVO0y7KeysbVgNrzwix6doLoJniAQ_l82El9AXMEYh9UjlAsk8T6eKIQJSwdfxzN_/pub?output=csv';
const fetchLocations=async()=>{const rows=parseCSV(await (await fetch(LOCATION_CSV)).text());if(!rows.length)return[];const[hdr,...data]=rows,iName=hdr.findIndex(h=>(h||'').trim().toLowerCase()==='locationname'),iAddr=hdr.findIndex(h=>(h||'').trim().toLowerCase()==='locations');if(iName<0||iAddr<0)return[];return data.map(r=>({name:(r[iName]||'').trim(),address:(r[iAddr]||'').trim()})).filter(x=>x.name&&x.address)};
const geocodeAll=async locs=>{const cache=JSON.parse(localStorage.getItem('geoCache')||'{}'),out=[];for(const{ name,address }of locs){if(cache[address]?.lat&&cache[address]?.lng){out.push({name,address,...cache[address]});continue}try{const rsp=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`),d=await rsp.json();if(d&&d[0]){const c={lat:+d[0].lat,lng:+d[0].lon};cache[address]=c;out.push({name,address,...c})}else console.warn('[Geo] Not found:',address)}catch(e){console.warn('[Geo] Error:',address,e)}await sleep(750)}localStorage.setItem('geoCache',JSON.stringify(cache));return out};
const injectSpoofSubmenu=async()=>{const btn=$('#enterSite');if(!btn||!location.href.includes('/site-resources/digital-sign-on'))return;const sub=document.createElement('div');sub.className='fm-spoof-submenu';btn.insertAdjacentElement('afterend',sub);const locs=await fetchLocations();if(!locs.length)return;const enriched=await geocodeAll(locs);sub.innerHTML=enriched.map(x=>`<button class="fm-loc" data-lat="${x.lat}" data-lng="${x.lng}">${x.name}</button>`).join('');sub.addEventListener('click',e=>{const b=e.target.closest('.fm-loc');if(!b)return;const lat=+b.dataset.lat,lng=+b.dataset.lng;if(lat&&lng){navigator.geolocation.getCurrentPosition=cb=>cb({coords:{latitude:lat,longitude:lng,accuracy:10}});navigator.geolocation.watchPosition=navigator.geolocation.getCurrentPosition;localStorage.setItem('siteLat',String(lat));localStorage.setItem('siteLon',String(lng));console.log('[Foreman Mode] Spoofed to:',lat,lng)}else alert('‚ùå Invalid coordinates for selected location.')})};

/* Dashboard */
window.addEventListener('load',()=>{const d=document.createElement('div');d.className='fmContainer open';d.innerHTML=`<div class="menuWrapper"><div id="toggleButton" class="clearfix"><div class="words">Foreman Mode</div><div id="menuIcon" class="menu-icon open"><span></span><span></span><span></span></div></div><div class="itemsWrapper"><button id="enterSite" class="toggleTarget" data-url="https://employee.shadconnect.com.au/site-resources/digital-sign-on"><i class="fas fa-map"></i>&nbsp;&nbsp;Sign In</button><button id="startPrestart" class="toggleTarget" data-url="https://employee.shadconnect.com.au/supervisor-resources/site-meetings"><i class="fas fa-atom"></i>&nbsp;&nbsp;Prestart</button><button id="ptaHelper" class="toggleTarget" data-url="https://employee.shadconnect.com.au/employee-resources/pta-form"><i class="fas fa-tasks"></i>&nbsp;&nbsp;PTA</button><button id="machinePrestart" class="toggleTarget" data-url="https://employee.shadconnect.com.au/site-resources/equipment-prestart-checklist"><i class="fas fa-truck-pickup"></i>&nbsp;&nbsp;Machines</button><button id="prefsBtn" class="toggleTarget"><i class="fas fa-tools"></i>&nbsp;&nbsp;Preferences</button></div></div>`;document.body.appendChild(d);
$('#toggleButton').addEventListener('click',()=>{$$('.toggleTarget').forEach(e=>e.classList.toggle('hidden'));$$('.menu-icon').forEach(e=>e.classList.toggle('open'));$$('.itemsWrapper').forEach(e=>e.classList.toggle('menuOpen'));$$('.fmContainer').forEach(e=>e.classList.toggle('open'))});
const here=location.href;$$('.fmContainer button').forEach(b=>{const u=b.getAttribute('data-url');u&&here.startsWith(u)?b.classList.add('currentPage'):b.classList.remove('currentPage')});
$('.fmContainer').addEventListener('click',e=>{const b=e.target.closest('button.toggleTarget');if(!b)return;const url=b.dataset.url;if(url&&!location.href.startsWith(url)){location.href=url;return}switch(b.id){case'ptaHelper':window.ptaTriggerBtn.click();break;case'startPrestart':initPrestartFlow();break;case'enterSite':window.initSignIn?.();break;case'machinePrestart':window.runMachinePrestartAutomation?.();break;case'prefsBtn':openPreferences();break}});
setTimeout(injectSpoofSubmenu,1200);});
})();
