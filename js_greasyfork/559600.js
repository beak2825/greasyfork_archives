// ==UserScript==
// @name The West - TW-DB.info Cloth Calc [Multi-Lang] - BB
// @namespace    https://github.com/TWGR-BelleBernice/TW-UserScripts
// @version 0.27.0
// @description The West Script: Cloth Calculation for game version 1.34 or higher
// @author [tw-db.info] Team, Belle Bernice
// @homepageURL  https://TWGR-BelleBernice.github.io/TW-UserScripts
// @supportURL   https://github.com/TWGR-BelleBernice/TW-UserScripts/issues
// @source       https://github.com/TWGR-BelleBernice/TW-UserScripts
// @icon         https://raw.githubusercontent.com/TWGR-BelleBernice/TW-UserScripts/main/TW-ClothCalc-gr-BB/assets/icon.png
// @include http://*.the-west.*/game.php*
// @include https://*.the-west.*/game.php*
// @include http://*.tw.innogames.*/game.php*
// @include https://*.tw.innogames.*/game.php*
// @grant GM_info
// @downloadURL https://update.greasyfork.org/scripts/559600/The%20West%20-%20TW-DBinfo%20Cloth%20Calc%20%5BMulti-Lang%5D%20-%20BB.user.js
// @updateURL https://update.greasyfork.org/scripts/559600/The%20West%20-%20TW-DBinfo%20Cloth%20Calc%20%5BMulti-Lang%5D%20-%20BB.meta.js
// ==/UserScript==

(function(e){const t=document,n=t.createElement("script");n.setAttribute("type","application/javascript"),n.textContent=`(${""+e})()`,(t.body||t.head||t.documentElement).appendChild(n),n.parentNode.removeChild(n)})(function(){if(isDefined(window.TWDB))!window.Language&&TWDB.lang&&(window.Language=TWDB.lang),new west.gui.Dialog(TWDB.script.name,`<div class="txcenter"><b><br>${Language._("script.duplicate_installation")}</br></b></div>`,west.gui.Dialog.SYS_WARNING).addButton(Language._("common.ok")).show();else{function round(e,t=0){const n=10**t;return Math.round((e+Number.EPSILON)*n)/n}function loadLanguage(e,t){const n=(t=t||{}).previousLang,o=t.onComplete||function(){};TWDB.ResourceLoader.load("langs",e,function(a){if(a&&typeof a=="object"){const r=TWDB.lang?._;Object.assign(TWDB.lang,a),r&&(TWDB.lang._=r)}TWDB.ResourceLoader.load("errors",null,function(r){r&&typeof r=="object"&&r.errors&&Object.assign(TWDB.lang,{errors:r.errors}),window.Language=TWDB.lang,triggerLangLoaded(),TWDB.ResourceLoader.load("notes",e,function(i){TWDB.script.notes=i},function(){TWDB.script.notes=[]}),o()},function(){window.Language=TWDB.lang,triggerLangLoaded(),TWDB.ResourceLoader.load("notes",e,function(r){TWDB.script.notes=r},function(){TWDB.script.notes=[]}),o()})},function(){const a=n||TWDB.script.gameLocale;a!==e?(TWDB.script.preferences.lang=a,localStorage.setItem("TWDB_preferences",JSON.stringify(TWDB.script.preferences)),loadLanguage(a,{previousLang:null,showSuccessMessage:!1,onComplete:o})):(triggerLangLoaded(),o())})}TWDB={};const detectedLocale=typeof Game<"u"&&Game.locale?Game.locale:"el_GR";TWDB.script=Object({version:typeof GM_info<"u"?GM_info.script.version:"0.27.0",name:"The West - TW-DB.info Cloth Calc [gr] - BB",name_max:"The%20West%20-%20TW-DBinfo%20Cloth%20Calc%20%5Bgr%5D%20-%20BB",name_min:"clothcalc",folder_url:"TWGR-BelleBernice.github.io/TW-UserScripts/TW-ClothCalc-gr-BB/",update_suffix:".user.js",update_link:"update.greasyfork.org/scripts/547843/",check:"version.js",url:"TW-DB.info",protocol:location.protocol.match(/^(.+):$/)[1],game_version:"2.256.3",gameLocale:detectedLocale,langs:{[detectedLocale]:detectedLocale+".json"},preferences:{lang:null}}),TWDB.lang={},TWDB.lang._=function(e,t,n){let o=null;typeof t!="object"||t===null||Array.isArray(t)?o=t:n=t;const a=e.split(".");let r=TWDB.lang;for(let l=0;l<a.length;l++){if(!r||typeof r!="object"||!(a[l]in r)){r=null;break}r=r[a[l]]}let i=r||o||e;if(r||o||TWDB.script?.isDev?.(),n!=null)for(const l of Object.keys(n))i=i.replace(RegExp(`\\$${l}\\$`,"g"),n[l]);return i},window.Language=TWDB.lang,TWDB.images={},TWDB.ResourceLoader=(function(){function e(o){return`${t}://raw.githubusercontent.com/${o}`}const t=TWDB.script.protocol==="https"?"https":"http",n={notes:{path:"changelog",files:!0,defaultValue:[],parser:"json"},langs:{path:"langs",files:TWDB.script.langs,defaultValue:{},parser:"json"},errors:{path:"langs/errors",filename:"log.json",defaultValue:{},parser:"json"},images:{path:"assets",filename:"images.json",defaultValue:{},parser:"json"}};return{load:function(o,a,r,i){const l=n[o];if(!l)return i&&i(),void 0;let v,d;if(l.files&&a)v=a+".json",d=l.defaultValue;else{if(!l.filename)return i&&i(),void 0;v=l.filename,d=l.defaultValue}const p=[e(`TWGR-BelleBernice/TW-UserScripts/main/TW-ClothCalc-gr-BB/${l.path}/${v}`),e(`${TWDB.script.folder_url}${l.path}/${v}`)];let c=0;(function b(){if(c>=p.length){if(o==="langs"&&a)if(typeof UserMessage<"u")new UserMessage(Language._("errors.language_file_not_found",{filename:v,locale:a}),UserMessage.TYPE_ERROR).show();else{const u=Language._("errors.language_file_not_found_console",{filename:v,locale:a}),g=Error(u);ErrorModule.report(g,Language._("errors.language_file_loading"))}return i?i():d!==void 0&&r&&r(d),void 0}if(l.parser==="json")$.getJSON(p[c],function(u){r&&r(u)}).fail(function(){c++,b()});else if(l.parser==="image"){const u=new Image;u.onload=function(){r&&r(u)},u.onerror=function(){c++,b()},u.src=p[c]}else $.getJSON(p[c],function(u){r&&r(u)}).fail(function(){c++,b()})})()},config:n}})();const notesLang=TWDB.script.preferences?.lang||TWDB.script.gameLocale||"el_GR";TWDB.ResourceLoader.load("notes",""+notesLang,function(e){TWDB.script.notes=e},function(){TWDB.script.notes=[]}),TheWestApi.version=Game.version=parseInt(Game.version,10)?Game.version:TWDB.script.game_version,TWDB.script.game_version=Game.version,TWDB.script.isDev=function(){return this.check.search("dev_version")!==-1};const twiceHTMLUnescape=e=>{const t=document.createElement("textarea");return t.innerHTML=e,t.innerHTML=t.value,t.value};if(window.debLog=TWDB.script.isDev()&&console?.info?(...e)=>{}:()=>{},localStorage.getItem("TWDB_preferences")){const e=JSON.parse(localStorage.getItem("TWDB_preferences"));for(const t in TWDB.script.preferences)e[t]===void 0&&(e[t]=TWDB.script.preferences[t]);TWDB.script.preferences=e}TWDB.script.preferences.lang=TWDB.script.preferences.lang==null?TWDB.script.gameLocale:TWDB.script.preferences.lang;const triggerLangLoaded=function(){TWDB.Eventer&&typeof TWDB.Eventer.trigger=="function"&&TWDB.Eventer.trigger("TWDBLangLoaded")};loadLanguage(TWDB.script.preferences.lang,{previousLang:null}),TWDB.ResourceLoader.load("images",null,function(e){e&&typeof e=="object"&&(Object.assign(TWDB.images,e),TWDB.Eventer&&typeof TWDB.Eventer.trigger=="function"&&TWDB.Eventer.trigger("TWDBImagesLoaded"))},function(){typeof ErrorModule<"u"&&ErrorModule.report&&ErrorModule.report(Error(Language._("errors.images_json_load_error")),Language._("errors.images_load_retry")),setTimeout(function(){TWDB.ResourceLoader.load("images",null,function(e){e&&typeof e=="object"&&(Object.assign(TWDB.images,e),TWDB.Eventer&&typeof TWDB.Eventer.trigger=="function"&&TWDB.Eventer.trigger("TWDBImagesLoaded"))},function(){typeof ErrorModule<"u"&&ErrorModule.report&&ErrorModule.report(Error(Language._("errors.images_load_failed_retry")),Language._("errors.images_load_failed_retry"))})},1e3)}),TWDB.Util=(function(e){return{addCss:function(t,n){return(function(o,a){let r="twdb_css";a!==void 0&&typeof a=="string"&&(r+="_"+a.replace(/\W+/g,"")),e("head style#"+r).append("<br />"+o).length!==1&&e("head").append(e(`<style type="text/css" id="${r}">`).text(o))})(t,n)},backupData:function(){return(function(){const t=[];let n;const o=`twdb_${Character.playerId}_`;let a;if(localStorage.getItem(o+"embackup")!==!0){for(a=0;a<localStorage.length;a++)n=localStorage.key(a),n.search(o)===0&&n.search(/(marketreminder|notes|settings|statistic)$/i)!==-1&&t.push({key:n,newKey:"backup_"+n,value:localStorage.getItem(n)});for(a=0;a<t.length;a++)localStorage.setItem(t[a].newKey,t[a].value);localStorage.setItem(o+"embackup",!0)}})()},query:function(t,n){if(!n)return document.querySelector(t);if(n instanceof Node)return n.querySelector(t);if(n instanceof jQuery)return n.length?n[0].querySelector(t):null;if(typeof n=="object"&&n!==null&&"querySelector"in n)return n.querySelector(t);if(typeof n=="string"){const o=TWDB.Util.query(n);return o?o.querySelector(t):null}return null}}})(jQuery),TWDB.ClothCalc={calcdata:{skills:{},items:{},jobs:{},custom:{},animals:[],used:{},loaded:!1},ready:!1,bidsLoading:!1,bids:{},getBids:function(){if(this.bidsLoading)return;this.bidsLoading=!0;const e=this;Ajax.remoteCall("building_market","fetch_bids",{},function(t){if(t.error)return new UserMessage(t.msg,UserMessage.TYPE_ERROR).show();const n=t.msg.search_result;for(let o=0;o<n.length;o++)e.bids[n[o].item_id]=1;e.bidsLoading=!1})},recLoading:!1,recipes:{},getLearned:function(){if(this.recLoading)return;this.recLoading=!0;const e=this;Ajax.remoteCall("crafting","",{},function(t){const n=t.recipes_content;if(n)for(let o=0;o<n.length;o++)e.recipes[n[o].item_id]=1;e.recLoading=!1})},init:function(){if(!this.ready&&(this.getBids(),this.getLearned(),!TWDB.Updater.wasUpdated())){const e=TWDB.Cache.load("calcdata");typeof e=="object"&&e!==null&&isDefined(e.loaded)&&(this.calcdata=e)}}},(function($){function waitForImages(e,t){if(Images[e])return t(),void 0;if(TWDB.Eventer){const n=TWDB.Eventer.set("TWDBImagesLoaded",function(){Images[e]&&(TWDB.Eventer.remove("TWDBImagesLoaded",n),t())},1),o=setInterval(function(){Images[e]&&(clearInterval(o),TWDB.Eventer.remove("TWDBImagesLoaded",n),t())},100);setTimeout(function(){clearInterval(o)},1e4)}else setTimeout(function(){Images[e]&&t()},500)}const _base=TWDB,w=window,Images=_base.images,Script=_base.script,ClothCalc=_base.ClothCalc,Debugger={};_base.Debugger=Debugger;const ErrorModule=(function(e){const t={},n=[];let o=!0;t.report=function(r,i){isDefined(r.message)?n.push({msg:`${i} ${r.stack&&(r.stack.match(/:\d+:\d+/)||[])[0]||""}`,e:r.message}):n.push({msg:Language._("errors.failed_add_error"),e:i}),o&&(o=!1,WestUi.NotiBar.add(new OnGoingPermanentEntry(function(){a()},Language._("errors.occurred"),"hint")))};const a=function(){const r=new west.gui.Scrollpane;e(r.getMainDiv()).css("height","375px"),e(r.getMainDiv()).find(".tw2gui_scrollpane_clipper_contentpane").addClass("selectable");let i=`<style>#twdb_error_table { width: 99.5%; border-collapse: collapse; font-size: 12px; table-layout: fixed; } #twdb_error_table th { background:url('${Game.cdnURL}/images/interface/wood_texture_dark.jpg'); color: #fff; padding: 8px; text-align: left; border: 1px solid #666; } #twdb_error_table td { padding: 6px 8px; border: 1px solid #666; word-wrap: break-word; word-break: break-word; position: relative; } #twdb_error_table .col-index { width: 30px; min-width: 30px; text-align: center; } #twdb_error_table .col-msg { width: 40%; } #twdb_error_table .col-error { width: auto; } #twdb_error_table .copy-btn { display: none; position: absolute; right: 4px; top: 4px; background: #442200; color: #fff; border: 1px solid #666; padding: 2px 6px; font-size: 10px; cursor: pointer; border-radius: 3px; z-index: 5; } #twdb_error_table .copy-btn:hover { background: #5e321a; } #twdb_error_table td.col-msg:hover .copy-btn, #twdb_error_table td.col-error:hover .copy-btn { display: inline-block; }</style><table id="twdb_error_table"><thead><tr><th class="col-index">#</th><th class="col-msg">${Language._("script.error_message")}</th><th class="col-error">${Language._("script.error_type")}</th></tr></thead><tbody>`;for(let l=n.length-1;l>=0;l--){const v=((n[l].msg||"")+"").replace(/</g,"&lt;").replace(/>/g,"&gt;"),d=((n[l].e||"")+"").replace(/</g,"&lt;").replace(/>/g,"&gt;"),p=((n[l].msg||"")+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/\n/g,"&#10;").replace(/\r/g,"&#13;"),c=((n[l].e||"")+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/\n/g,"&#10;").replace(/\r/g,"&#13;"),b=Language._("script.error_copy");i+=`<tr><td class="col-index">${l}</td><td class="col-msg">${v}<button class="copy-btn" data-copy="${p}">${b}</button></td><td class="col-error">${d}<button class="copy-btn" data-copy="${c}">${b}</button></td></tr>`}i+="</tbody></table>",r.appendContent(i),e(r.getMainDiv()).find(".copy-btn").on("click",function(){let l=e(this).attr("data-copy");const v=document.createElement("div");v.innerHTML=l,l=v.textContent||v.innerText||l;const d=Language._("script.error_copied");if(navigator.clipboard?.writeText)navigator.clipboard.writeText(l).then(function(){const p=e(this),c=p.text();p.text(d),setTimeout(function(){p.text(c)},1e3)}.bind(this));else{const p=document.createElement("textarea");p.value=l,p.style.position="fixed",p.style.opacity="0",document.body.appendChild(p),p.select();try{document.execCommand("copy");const c=e(this),b=c.text();c.text(d),setTimeout(function(){c.text(b)},1e3)}catch(c){ErrorModule.report(c,Language._("errors.copy_failed"))}document.body.removeChild(p)}}),wman.open("twdb_error",null,"noreload").setMiniTitle(Language._("errors.mini_title")).setTitle(Language._("errors.title")).appendToContentPane(r.getMainDiv())};return t.test=function(){t.report(Error("Test error with stack trace"),"Test error message 1"),t.report(Error("Language file loading error"),Language._("errors.language_file_loading")),t.report(Error("Failed to load module"),Language._("errors.failed_load_module",{module:"test-module"})||"failed 000000 test-module"),t.report(Error("Cache error"),Language._("errors.load_from_cache",{key:"test-cache"})||"failed 000000 test-cache"),t.report(Error("Worker error"),Language._("errors.worker")),t.report(Error("getFortData error"),"getFortData"),t.report(Error("Job analyzer error"),"Job-Analyzer parseAndStoreJobReport"),t.report(Error("Table sorting error"),"Analyzer applyTableSorting"),t.report(Error("Bonus job error"),"bonusjob reset"),t.report(Error("Color injection error"),"injectColor"),t.report(Error("NotiBar manipulation error"),"manipulate WestUi.NotiBar.add"),t.report(Error("Work queue error"),"manipulate removeWorkQueuePA"),t.report(Error("Nuggets error"),"manipulate changeWofNuggets"),t.report(Error("Market dialog error"),"manipulate market sell dialog"),t.report({message:"Error without stack trace"},"Test error without stack"),t.report({message:"Another plain error"},"");var r=Error("");t.report(r,"Error with empty message")},t})($);_base.Error=ErrorModule,Debugger.Error=ErrorModule;const Loader=(function(e){let t={};const n=[],o={},a={};let r,i=!1,l=!1,v=!1,d=0;t.add=function(h,_,k,T){const C={ready:!1};return n.push({key:h,txt:_,call:k,dep:T||{},ready:C,count:0}),C},t.init=function(){r||(r=w.setInterval(function(){p()},500))};const p=function(){if(!l){l=!0;try{if(i===!1){if(!c())return l=!1,void 0;TWDB.Cache.init(),o.Cache=!0;try{Updater.query(),b()}catch(h){return ErrorModule.report(h,Language._("errors.loader_api_registration")),new UserMessage(Language._("script.api_registration_failed"),UserMessage.TYPE_FATAL).show(),g()}return u()}if(isDefined(a[i.key]))return u();if(i.ready.ready)return o[i.key]=!0,v=!1,u();l=!1}catch(h){ErrorModule.report(h,Language._("errors.loader_process_queue")),l=!1}}},c=function(){try{return!!(isDefined(w.jQuery)&&isDefined(w.TheWestApi)&&isDefined(w.TheWestApi.version)&&w.ItemManager.get(2e3)!==void 0&&isDefined(w.Character)&&w.Character.playerId!==0&&w.Bag.loaded)}catch(h){return ErrorModule.report(h,Language._("errors.loader_check_game_readiness")),!1}},b=()=>{try{const h={id:"twdb_clothcalc",name:"TW-DB.info - Cloth Calc - BB",version:"2.04",gameVersion:Script.game_version+"",author:"[tw-db.info] Team - BB",website:"https://tw-db.info"},_=`<br><br><form action="https://www.paypal.com/cgi-bin/webscr" method="post"><input name="cmd" value="_s-xclick" type="hidden"><input name="encrypted" value="-----BEGIN PKCS7-----MIIHNwYJKoZIhvcNAQcEoIIHKDCCByQCAQExggEwMIIBLAIBADCBlDCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJKoZIhvcNAQEBBQAEgYChINvT18jAz9CalhBmJdmLCwpXoNRJP+VkXk8FX8ggf0svoPqtoBds+0Jtzdvj9jQ0Sf6erVBUCcRpMpkb+Tf3GCQVHTglnw8JrK6ZzzRhjsZZCJn7tgFwu2LimWCyFnNbeGNb3JeAUyoPqqNlc8tD5abn15g/a8T7+lmSJMLZOjELMAkGBSsOAwIaBQAwgbQGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQIKDoxC57piTyAgZCs1uffooeE6z5oFOY8gF33GntGddTvCLpVnR2oEfR3HaNWR2/DSZsxTSBxOQ9h43E+9A9WN1QJDj+4qyu/20IbTBVkFCl/eoGTV44O///OowbrCRqIUbDKtBBj6rrv876AFW0aV8/iRoreP66eCBd3FG7K6Pue0rBR7khec7TFMM0kd++ZT0QTSvuQ4IvsbOWgggOHMIIDgzCCAuygAwIBAgIBADANBgkqhkiG9w0BAQUFADCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBglghkiG9w0BCQEWDXJlQHBheXBhbC5jb20wHhcNMDQwMjEzMTAxMzE1WhcNMzUwMjEzMTAxMzE1WjCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBAMFHTt38RMxLXJyO2SmS+Ndl72T7oKJ4u4uw+6awntALWh03PewmIJuzbALScsTS4sZoS1fKciBGoh11gIfHzylvkdNe/hJl66/RGqrj5rFb08sAABNTzDTiqqNpJeBsYs/c2aiGozptX2RlnBktH+SUNpAajW724Nv2Wvhif6sFAgMBAAGjge4wgeswHQYDVR0OBBYEFJaffLvGbxe9WT9S1wob7BDWZJRrMIG7BgNVHSMEgbMwgbCAFJaffLvGbxe9WT9S1wob7BDWZJRroYGUpIGRMIGOMQswCQYDVQQGEwJVUzELMAkGA1UECBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJbmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoGCSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbYIBADAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBBQUAA4GBAIFfOlaagFrl71+jq6OKidbWFSE+Q4FqROvdgIONth+8kSK//Y/4ihuE4Ymvzn5ceE3S/iBSQQMjyvb+s2TWbQYDwcp129OPIbD9epdr4tJOUNiSojw7BHwYRiPh58S1xGlFgHFXwrEBb3dgNbMUa+u4qectsMAXpVHnD9wIyfmHMYIBmjCCAZYCAQEwgZQwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UEBxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsUCmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1yZUBwYXlwYWwuY29tAgEAMAkGBSsOAwIaBQCgXTAYBgkqhkiG9w0BCQMxCwYJKoZIhvcNAQcBMBwGCSqGSIb3DQEJBTEPFw0xMTAxMTkyMDQ1NDVaMCMGCSqGSIb3DQEJBDEWBBSftIcjkFDuoOkdAfklhyX0/yFgtzANBgkqhkiG9w0BAQEFAASBgF9SGe3NSMpJbcwAlWM9fDzOYOQovnXP1jCT9eR7ZCsZ4UdlS5u5/ubq4KvSd2s/Iz7H8I69CL5vY6n50Qk57lZv2m+DSmY/p+xjcPG0JBuRaT0uGNOeiPdXwC+HiDPP6EhJXXEZv5fqXPmOUJPdovWYgyu/LgVCRAZw1qp3995m-----END PKCS7-----" type="hidden"><input type="image" src="https://www.paypalobjects.com/en_US/DE/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="${Language._("script.paypal_alt")}"><img width="1" border="0" height="1" src="https://www.paypal.com/en_GB/i/scr/pixel.gif" alt=""></form><br>`,k=w.TheWestApi.register(h.id,h.name,h.version,h.gameVersion,h.author,h.website),T=e(`<div style="font-family: 'comic sans ms'; font-size: 13pt; padding-top: 10px; text-align: center;">${Language._("script.description")}${_}${Language._("script.thank_you")}</div>`);k.setGui(T),k.isOutdated()&&w.TheWestApi.displayOutdated()}catch(h){ErrorModule.report(h,Language._("errors.loader_register_script_api"))}},u=function(){if(n.length===0)return g();try{if(i=n.shift(),i.count++,i.count>d){if(v)return ErrorModule.report({message:Language._("errors.deadlock_detected")},Language._("errors.failed_load_module",{module:i.key})),a[i.key]=!0,u();d++,v=!0}for(const h in i.dep)if(!isDefined(o[h]))return TWDB.script.isDev(),n.push(i),u();try{i.call()}catch(h){return ErrorModule.report(h,Language._("errors.failed_load_module",{module:i.key})),a[i.key]=!0,u()}l=!1,p()}catch(h){ErrorModule.report(h,Language._("errors.loader_process_next_module")),l=!1}},g=function(){try{w.clearInterval(r),w.setTimeout(function(){t=null},1e3)}catch(h){ErrorModule.report(h,Language._("errors.loader_cleanup"))}};return t.stack=n,t.loaded=o,t.failed=a,t.current=i,t})($);Debugger.Loader=Loader;const Cache=(function(e){const t={},n={};let o="",a={};const r=function(i){a[i]||(a[i]=!0,t.save("keys",a))};return t.load=function(i){r(i);try{return JSON.parse(decodeURIComponent(localStorage.getItem(o+i)))}catch(l){return ErrorModule.report(l,Language._("errors.load_from_cache",{key:i})),t.save(i,null),null}},t.save=function(i,l){r(i);try{return localStorage.setItem(o+i,encodeURIComponent(JSON.stringify(l))),!0}catch(v){return ErrorModule.report(v,Language._("errors.save_to_cache",{key:i})),t.save(i,null),!1}},t.reset=function(i,l){try{if(i){if(isDefined(l))localStorage.removeItem(l);else for(const v in a)localStorage.removeItem(o+v);new UserMessage(Language._("cache.reset_complete"),UserMessage.TYPE_SUCCESS).show(),location.href=location.href.replace(location.hash||"#","")}else{const v=e(`<div><h2>${Language._("cache.reset_confirm")}</h2></div>`),d=new west.gui.Textfield("twdb_cache_key").setSize(40).setLabel(Language._("cache.reset_key"));v.append(d.getMainDiv());const p=new west.gui.Checkbox(Language._("cache.reset_all_keys")).setSelected(!0);p.setCallback(function(c){c&&d.setValue("")}),e(d.getMainDiv()).find("span").css("font-size","12px"),e(d.getMainDiv()).find("input").keyup(function(){p.setSelected(!1)}),v.append(e('<div style="display:block;" />').append(p.getMainDiv())),new west.gui.Dialog(Language._("cache.reset"),v,west.gui.Dialog.SYS_QUESTION).addButton(Language._("common.ok"),function(){p.isSelected()?t.reset(!0):t.reset(!0,d.getValue())}).addButton(Language._("common.cancel")).show()}}catch(v){ErrorModule.report(v,Language._("errors.cache_reset"))}},t.init=function(){n.ready||(o=`twdb_${Character.playerId}_`,a=t.load("keys"),a||(a={keys:!0}),n.ready=!0)},t})($);_base.Cache=Cache,Debugger.Cache=Cache;const Worker=(function(e){const t={},n=[];let o=!1,a=!1;t.add=function(i){n.push(i),o||(o=w.setInterval(function(){r()},100))};const r=function(){if(!a)try{a=!0;const i=n.shift();if(i)try{i()}catch(l){ErrorModule.report(l,Language._("errors.worker"))}n.length===0&&(w.clearInterval(o),o=!1),a=!1}catch(i){ErrorModule.report(i,Language._("errors.worker_process_task")),a=!1}};return t})();Debugger.Worker=Worker;const Timer=(function(e){const t={};let n=0,o=0,a=0;return t.getTimeout=function(){const r=Date.now();2e3>r-n?o++:o=0,6e4>r-n?a++:a=0,n=r;let i=0;return a>50&&(i=6e4),20>o?i+200:i+2e3},t})();Debugger.Timer=Timer;const Eventer=(function(e){const t={},n={};return t.set=function(o,a,r){isDefined(n[o])||(n[o]={});const i=!!isDefined(r)&&r;let l=+Date.now();for(;n[o][l];)l++;return n[o][l]={id:l,call:a,count:i},l},t.trigger=function(o){if(!isDefined(n[o]))return;let a=0;for(const r in n[o])isDefined(n[o][r].id)&&(w.setTimeout(n[o][r].call,10),n[o][r].count!==!1?(n[o][r].count--,n[o][r].count>0&&a++):a++);a===0&&delete n[o]},t.remove=function(o,a){if(!isDefined(n[o])||!isDefined(n[o][a]))return!1;delete n[o][a]},t})();_base.Eventer=Eventer,Debugger.Eventer=Eventer;const Jobs=(function(e){const t={};let n={};const o=[],a={},r={},i=[1828e3,1829e3,183e4,2e6,2003e3,2006e3,2009e3];let l,v={};n=Loader.add("Jobs","tw-db Jobsystem",function(){if(!n.ready)try{let p=0,c=0;const b={};for(;;){p++;const g=w.JobList.getJobById(p);if(g){c=0,o.push(g.id),a[g.name.toLowerCase()]=g.id,r[g.shortname.toLowerCase()]=g.id;for(const h in g.yields)Number.isNaN(h)||b[h]||(b[h]=!0,i.push(+h))}else if(c++,c>5)break}l={description:"",duration:1800,energy:6,groupid:null,id:255,malus:0,name:"Κατασκευή",randomyields:[],shortname:"construction",skills:{build:3,repair:1,leadership:1},yields:{},calcJobPoints:function(){return 0},canDo:function(){return!0}},o.push(255),a[l.name.toLowerCase()]=255,r[l.shortname.toLowerCase()]=255;const u=function(g,h){const _=g===255?l:w.JobList.getJobById(g),k=h===255?l:w.JobList.getJobById(h);return _.name>k.name};o.sort(u),i.sort(),v=Cache.load("jobdata"),v!==null&&typeof v=="object"||(v={}),Eventer.set("TWDBdataLoaded",function(){d()}),n.ready=!0}catch(p){ErrorModule.report(p,Language._("errors.jobs_initialize_system"))}},{Cache:!0});const d=function(){try{v={},Cache.save("jobdata",v)}catch(p){ErrorModule.report(p,Language._("errors.jobs_reset_data"))}};return t.getJobByName=function(p){return p=e.trim(p).toLowerCase(),isDefined(a[p])?t.getJobById(a[p]):null},t.getJobByShortname=function(p){return p=e.trim(p).toLowerCase(),isDefined(r[p])?t.getJobById(r[p]):null},t.getJobById=function(p){let c;if(p===255)c=l;else if(c=w.JobList.getJobById(p),!c)return c;const b=e.extend(!0,{},c);let u=1;w.Character.charClass==="adventurer"&&(w.Premium.hasBonus("character")?u*=1.2:u*=1.1),w.Premium.hasBonus("money")&&(u*=1.5);for(let g=0;g<b.randomyields.length;g++)b.randomyields[g]=round(b.randomyields[g]*u,2);if(b.yields.length===void 0)for(const g in b.yields)b.yields[g].prop=round(b.yields[g].prop*u,2);return b},t.openJob=function(p,c,b){w.JobWindow.open(p,c,b)},t.startJob=function(p,c,b,u){w.JobWindow.startJob(p,c,b,+u||3600)},t.getAllJobs=function(){return o},t.isProduct=function(p){return e.inArray(+p,i)},t.getPopup=function(p,c){let b='<div style="min-width:60px;text-align:center" >';const u=t.getJobById(p);return isDefined(u)&&(b+=`<span style="font-weight:bold;display:block;">${u.name}</span><div class="job" style="position:relative;left:50%;margin:10px -25px;"><div ${isDefined(c)?`class="featured ${c}"`:""}></div><img src="${Game.cdnURL}/images/jobs/${u.shortname}.png" class="job_icon" ></div>`),b+="</div>",b},t})($);_base.Jobs=Jobs,Debugger.Jobs=Jobs;const Window=(function(e){const t={};let n=null,o=null;const a={};let r={};const i=function(){if(!r.ready)try{if(!Images.button)return waitForImages("button",i),void 0;const d=e(`<div title="${Language._("script.menu_button_tooltip")}" class="menulink" />`).css("background-image",`url(${Images.button})`).on("mouseenter",function(){e(this).css("background-position","-25px 0px")}).on("mouseleave",function(){e(this).css("background-position","0px 0px")}).click(function(){l()});e("#ui_menubar").append(e('<div class="ui_menucontainer" id="TWDB_ClothCalc_menubuttons" />').append(d).append('<div class="menucontainer_bottom" />')),ready=!0,r.ready=!0}catch(d){ErrorModule.report(d,Language._("errors.window_initialize"))}};r=Loader.add("Window","tw-db Scriptwindow",i),t.open=function(d){l(d)};const l=function(d){try{let p;n=wman.open("twdb_window",null).setMiniTitle(Language._("script.twdb_title")).setTitle(Language._("script.twdb_title")),n.appendToContentPane(e(`<div style="width:100%;text-align:center;position:absolute;bottom:0px;left:0px;height:15px;display:block;font-size:12px;color:#000000;">${Language._("script.footer_window_html",{version:Script.version})}</div>`));for(const c in a)isDefined(p)||(p=c),d===c&&(p=c),n.addTab(a[c].name,c,function(b,u){v(u)}),a[c].gui.children().remove(),n.appendToContentPane(a[c].gui);isDefined(p)&&(o=a[p].gui,v(p))}catch(p){ErrorModule.report(p,Language._("errors.window_open"))}},v=function(d){try{if(o.hide(),n.showLoader(),n.activateTab(d),!isDefined(a[d]))return;a[d].title!==""?n.setTitle(Language._("script.twdb_title_with",{title:a[d].title})):n.setTitle(""),o=a[d].gui,o.show(),w.setTimeout(a[d].callback,10)}catch(p){ErrorModule.report(p,Language._("errors.window_switch_tab"))}};return t.addTab=function(d,p,c,b){return a[d]={title:c,name:p,callback:b,gui:null},a[d].gui=e('<div style="margin-top:10px;"/>').hide(),a[d].gui},t.updateTab=function(d,p,c){isDefined(a[d])&&(a[d].name=p,a[d].title=c,n!==null&&o===a[d].gui&&(c!==""?n.setTitle(Language._("script.twdb_title_with",{title:c})):n.setTitle("")))},t.hideLoader=function(){n&&n.hideLoader()},t.showLoader=function(){n&&n.showLoader()},t})($);Debugger.Window=Window;const Settings=(function(e){let t={};const n={};let o=null,a={};a=Loader.add("Settings","tw-db Settingssystem",function(){if(a.ready)return;const l=Cache.load("settings");t=typeof l=="object"&&l!==null?l:{},TWDB.Util.addCss(`span.twdb_sett_capt{font-size:115%;font-weight:bold;font-style:italic;display:inline-block;margin-top:8px;text-shadow:2px 1px 2px #643}.build_progress>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:264px}.rp_row_jobdata>.rp_jobdata_text>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:125px}#character-shadow>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:95px}#char_crafting_progress>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:144px}.dal_status>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:294px}.job_progress_jobstars>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:219px}.cell.cell_2.progress>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill,.saloon_duel_moti>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:194px}.flfi_progressbar>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:324px}.dl_motivation>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:330px}.duels-TWXDuelMap>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:766px}.sheriff-TWXSheriff>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:581px}.messages-analyzer-job>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:692px}.achievement-categories-total>.entry>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:204px}.achievement-total-completed>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:623px}#achievement_progress>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:450px}.achievement-list>.achievement-list-scroll-wrapper>.tw2gui_scrollpane>.tw2gui_scrollpane_clipper>.tw2gui_scrollpane_clipper_contentpane>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:490px}[class^="TWFBT_"]>.tw2gui_window_content_pane>.tw2gui_scrollpane>.tw2gui_scrollpane_clipper>.tw2gui_scrollpane_clipper_contentpane>.tw2gui_progressbar>.tw2gui_progressbar_progress>.tw2gui_progressbar_fill{max-width:677px}.TWDS_fbs_basestats_content table thead tr{position:sticky;top:0;background:wheat}div.job_bestwearbutton{top:5px!important}.fort_battle_button_analyzer{left:304px!important}.fort_battle_buttons{left:98px!important}.settings-container{display:flex;flex-direction:column;gap:1px;padding-bottom:12px}.settings-item{display:flex;align-items:center;gap:4px}.settings-category-header{font-size:115%;font-weight:bold;font-style:italic;display:block;margin-top:8px;text-shadow:2px 1px 2px #643}.settings-item-checkbox{flex-shrink:0;width:25px}.settings-item-label{flex-grow:1;cursor:pointer}.settings-group-header{display:flex;align-items:center;cursor:pointer;margin-top:8px;padding:4px 0;border-radius:3px}.settings-group-header .icon{width:16px;height:16px;background-repeat:no-repeat;margin-left:5px;margin-right:5px}.settings-group-header .butMinus{background-image:url(${Game.cdnURL}/images/scrollbar/scroll_down.png)}.settings-group-header .butPlus{background-image:url(${Game.cdnURL}/images/scrollbar/scroll_up.png)}.settings-group-content{padding-left:30px;display:none;flex-direction:column;gap:3px}.beeper-sound-settings{display:flex;align-items:center;gap:10px;padding:4px 0}.active_tab_id_settings>*,.active_tab_id_notes>*{user-select:none}`),o=Window.addTab("settings",Language._("settings.title"),Language._("settings.title"),r),a.ready=!0},{Cache:!0,Window:!0});const r=function(){function l(f){const L=e('<input type="text" />').css({width:"calc(100% - 10px)",maxWidth:"450px",padding:"5px",fontFamily:"monospace",fontSize:"11px",boxSizing:"border-box"}).val(f.initialText||"").attr("placeholder",f.mode==="import"?Language._("io.import_placeholder"):"");f.mode==="export"&&L.on("focus",function(){this.select()});const D=e("<div>").css({maxWidth:"470px"}).append(f.mode==="export"?e("<p>").text(Language._("io.export_copy_failed")):e("<p>").text(Language._("io.import_paste_instructions")),L),E=new west.gui.Dialog(f.title,D);f.mode==="import"&&E.addButton(Language._("io.import"),function(){f.onConfirm&&f.onConfirm(L.val()),this.close()}),E.addButton(f.mode==="export"?Language._("common.close"):Language._("common.cancel"),function(){this.close(),f.mode==="import"&&new UserMessage(Language._("io.import_cancelled"),UserMessage.TYPE_INFO).show()}).show()}o.children().remove();const v=new west.gui.Scrollpane;e(v.getMainDiv()).css("height","294px").css("margin-bottom","6px"),o.append(v.getMainDiv());const d=[{type:"category",title:Language._("settings.category_inventory")},{id:"collector",text:Language._("settings.collector")},{id:"collector_sell",text:Language._("settings.collector_sell")},{id:"pin_items",text:Language._("settings.pin_items")},{type:"category",title:Language._("settings.category_quests")},{id:"quest_cancel",text:Language._("settings.quest_cancel")},{id:"instant_quest",text:Language._("settings.instant_quest")},{id:"colored_quest",text:Language._("settings.colored_quest")},{type:"category",title:Language._("settings.category_jobs")},{id:"job_show_lp",text:Language._("settings.job_lp")},{type:"category",title:Language._("settings.category_task_list")},{id:"task_list_points",text:Language._("settings.task_points")},{type:"category",title:Language._("settings.category_fort")},{id:"import_westforts",text:Language._("settings.forts_import")},{id:"fort_recruitment",text:Language._("settings.fort_recruit")},{id:"enhanced_fort_recruitment",text:Language._("settings.fort_recruit_enhanced")},{id:"declare_report",text:Language._("settings.declare_report")},{id:"owned_forts_tab",text:Language._("settings.forts_owned")},{id:"cemetery_critical",text:Language._("settings.cemetery_critical")},{id:"total_dmg_battle",text:Language._("settings.battle_damage")},{id:"battle_info_round",text:Language._("settings.battle_round")},{type:"category",title:Language._("settings.category_town")},{id:"building_progress",text:Language._("settings.building_progress")},{id:"church_levels",text:Language._("settings.church_levels")},{id:"improved_ch_tab",text:Language._("settings.church_tab")},{id:"town_forum_blink",text:Language._("settings.forum_blink")},{type:"category",title:Language._("settings.category_market")},{id:"market_map",text:Language._("settings.market_map")},{id:"market_reminder",text:Language._("settings.market_reminder")},{id:"market_sell_dialog",text:Language._("settings.market_sell")},{id:"market_report",text:Language._("settings.market_report")},{id:"improved_market",text:Language._("settings.market_improved")},{type:"category",title:Language._("settings.category_graphics")},{id:"duel_motivation",text:Language._("settings.duel_motivation")},{id:"direct_sleep",text:Language._("settings.sleep_direct")},{id:"deposit",text:Language._("settings.deposit")},{id:"no_shop_sale",text:Language._("settings.shop_sale_off")},{id:"exp_bar",text:Language._("settings.exp_bar")},{id:"mini_chat",text:Language._("settings.mini_chat")},{id:"event_counter",text:Language._("settings.event_counter")},{id:"scrollbars_off",text:Language._("settings.scrollbars_off")},{id:"wear_close",text:Language._("settings.wear_close")},{id:"profile_duel_exp",text:Language._("settings.profile_duel_exp")},{id:"regen_timers",text:Language._("settings.regen_timers")},{id:"button_church",text:Language._("settings.button_church"),group:Language._("settings.automation_buttons")},{id:"button_market",text:Language._("settings.button_market"),group:Language._("settings.automation_buttons")},{type:"category",title:Language._("settings.category_minimap")},{id:"bonus_jobs",text:Language._("settings.bonus_jobs")},{id:"coordinates_input",text:Language._("settings.coordinates_input")},{type:"category",title:Language._("settings.category_premium")},{id:"work_queue_off",text:Language._("settings.work_queue_off")},{id:"fetch_all_off",text:Language._("settings.fetch_all_off")},{id:"wof_nuggets_off",text:Language._("settings.wof_nuggets_off")},{type:"category",title:Language._("settings.category_misc")},{id:"chat",text:Language._("settings.chat")},{id:"notes",text:Language._("settings.notes")},{id:"auto_deposit",text:Language._("settings.auto_deposit")},{id:"chest_analyzer",text:Language._("settings.chest_analyzer")},{id:"weekly_crafting",text:Language._("settings.weekly_crafting")},{id:"telegram_bb_codes",text:Language._("settings.telegram_bb_codes")},{id:"enhanced_rankings",text:Language._("settings.enhanced_rankings")},{id:"translation_texts",text:Language._("settings.translation_texts")},{id:"forum_select",text:Language._("settings.forum_select")},{id:"pin_important",text:Language._("settings.pin_important")},{id:"fortbattle_reminder",text:Language._("settings.fortbattle_reminder")},{id:"night_mode",text:Language._("settings.night_mode")},{id:"blink_events",text:Language._("settings.blink_events")},{id:"whisper_improved",text:Language._("settings.whisper_improved")}],p=e("<div class='settings-container' />"),c={};d.forEach(f=>{if(f.type==="category")return p.append(e("<div class='settings-category-header' />").text(twiceHTMLUnescape(f.title))),void 0;const L=n.get(f.id),D=(E=f.id,function(){n.set(E,!n.get(E))});var E;const O=new west.gui.Checkbox("",L?"tw2gui_checkbox_checked":"",D),W=O.getMainDiv(),P=e("<div class='settings-item' />");P.append(e('<div class="settings-item-checkbox" />').append(W));const B=e('<div class="settings-item-label" />').text(twiceHTMLUnescape(f.text));if(B.on("click",function(){O.toggle()}),P.append(B),f.group){if(!c[f.group]){const m=e(`<div class="settings-group-header"><span class="icon butMinus"></span><span>${twiceHTMLUnescape(f.group)}</span></div>`),A=e("<div class='settings-group-content' />");m.click(function(){A.toggle(),e(this).find(".icon").toggleClass("butMinus").toggleClass("butPlus")}),p.append(m),p.append(A),c[f.group]=A}c[f.group].append(P)}else p.append(P)});try{const f=e("<div class='beeper-sound-settings' />"),L=n.get("beeperSound",9),D=new west.gui.Combobox("beeper_change_sound_settings").addItem(0,Language._("misc.sound_default")).addItem(1,"Bum").addItem(2,"Chime").addItem(3,"Coin").addItem(4,"Coin 2").addItem(5,"ICQ").addItem(6,"QIP").addItem(7,"Tinkle").addItem(8,"Trumpet").addItem(9,"VK").addItem(10,Language._("common.select_file")+"...").select(typeof L=="string"?10:L).addListener(function(O){const W=n.get("beeperSound",9);let P=O;if(O===10||O==="10"){const B="https://example.com/sound.mp3",m=prompt(Language._("common.select_file")+":",B);if(!m&&m!==B)return D.select(typeof W=="string"?10:W),void 0;P=m}else typeof O=="string"&&/^-?\d+$/.test(O)&&(P=parseInt(O,10));n.set("beeperSound",P),window.ChatBeeper&&typeof window.ChatBeeper.updateSound=="function"&&window.ChatBeeper.updateSound()}),E=new west.gui.Button(Language._("common.listen"),function(){window.ChatBeeper&&typeof window.ChatBeeper.play=="function"&&window.ChatBeeper.play()}).getMainDiv();f.append(D.getMainDiv(),e(E)),p.append(f)}catch(f){ErrorModule.report(f,Language._("errors.setup_whisper_sound"))}const b=new west.gui.Button(Language._("io.export"),function(){const f=JSON.stringify(t,null,2);navigator.clipboard?.writeText?navigator.clipboard.writeText(f).then(function(){new UserMessage(Language._("io.export_clipboard_success"),UserMessage.TYPE_SUCCESS).show()},function(L){l({title:Language._("io.export_title"),initialText:f,mode:"export"})}):l({title:Language._("io.export_title"),initialText:f,mode:"export"})}),u=new west.gui.Button(Language._("io.import"),async function(){if(!window.confirm(Language._("io.import_warning")))return;const f=function(L){if(!L)return new UserMessage(Language._("io.import_no_data"),UserMessage.TYPE_INFO).show(),void 0;try{const D=JSON.parse(L);for(const E in D)Object.hasOwn(D,E)&&(t[E]=D[E]);Cache.save("settings",t),new west.gui.Dialog(Language._("io.import_title"),Language._("io.import_success_reload"),"ok").setModal(!0,!1,!0).show()}catch(D){new UserMessage(Language._("io.import_error"),UserMessage.TYPE_ERROR).show(),ErrorModule.report(D,Language._("io.import_error_log"))}};try{if(!navigator.clipboard||!navigator.clipboard.readText)throw Error(Language._("errors.clipboard_not_supported","Clipboard API read not supported in your Browser."));navigator.clipboard.readText().then(function(L){new UserMessage(Language._("io.import_clipboard_success"),UserMessage.TYPE_SUCCESS).show(),f(L)},function(L){throw new UserMessage(Language._("io.import_clipboard_failed"),UserMessage.TYPE_INFO).show(),L}).catch(function(){l({title:Language._("io.import_title"),initialText:"",mode:"import",onConfirm:f})})}catch(L){ErrorModule.report(L,Language._("errors.clipboard_import_failed")),l({title:Language._("io.import_title"),initialText:"",mode:"import",onConfirm:f})}}),g=new west.gui.Button(Language._("common.save"),function(){i(t,C)}),h=e('<div style="position: absolute; right: 0; top: calc(100% - 18px); width: auto; text-align: right;" />').append(e(`<img style="cursor:pointer;" title="${Language._("io.reset")}" src="${Images.iconReset}" />`).click(function(){Cache.reset(),new UserMessage(Language._("cache.reset_complete"),UserMessage.TYPE_INFO).show(),r()}));v.appendContent(p);const _=e('<div style="float:right; align-items:center; display:flex; margin-right:4px;" />'),k=e(`<div style="font-weight:bold; margin-right:4px; text-shadow:2px 1px 2px #fae3ad; color:#5e321a;">${Language._("script.lang")}:</div>`),T=new west.gui.Combobox().setWidth(140);[{locale:"en_DK",name:"English (en)",bg_pos:"0 -721px"},{locale:"el_GR",name:"Ελληνικά (el)",bg_pos:"0 -753px"},{locale:"cs_CZ",name:"Čeština (cs)",bg_pos:"0 -785px"},{locale:"de_DE",name:"Deutsch (de)",bg_pos:"0 -1105px"},{locale:"es_ES",name:"Español (es)",bg_pos:"0 -1393px"},{locale:"pt_BR",name:"Português (pt-br)",bg_pos:"0 -1009px"},{locale:"fr_FR",name:"Français (fr)",bg_pos:"0 -1361px"},{locale:"hu_HU",name:"Magyar (hu)",bg_pos:"0 -1137px"},{locale:"it_IT",name:"Italiano (it)",bg_pos:"0 -1297px"},{locale:"nl_NL",name:"Dutch (nl)",bg_pos:"0 -689px"},{locale:"pt_PT",name:"Português (pt)",bg_pos:"0 -849px"},{locale:"pl_PL",name:"Polski (pl)",bg_pos:"0 -1201px"},{locale:"ro_RO",name:"Română (ro)",bg_pos:"0 -977px"},{locale:"ru_RU",name:"Русский (ru)",bg_pos:"0 -913px"},{locale:"sk_SK",name:"Slovenčina (sk)",bg_pos:"0 -817px"},{locale:"tr_TR",name:"Türkçe (tr)",bg_pos:"0 -1329px"}].forEach(function(f){T.addItem(f.locale,`<span style="display:inline-block; height:16px; line-height:14px; padding-left:25px; background: url(//portal-bar.innogamescdn.com/images/west-sprite_01.newRuFlag.1661155041.png) no-repeat; background-position: ${f.bg_pos}; vertical-align: middle; position: relative; ">${f.name}</span>`)}),T.select(TWDB.script.preferences.lang||"el_GR");let C=TWDB.script.preferences.lang||"el_GR";T.addListener(function(f){C=f}),_.append(k).append(T.getMainDiv()),o.append(_).append(g.getMainDiv()).append(b.getMainDiv()).append(u.getMainDiv()).append(h),Window.hideLoader()};n.get=function(l,v){return isDefined(t[l])?t[l]:(n.set(l,v),v)},n.set=function(l,v){t[l]=v,["pinnedItems","mini_chat_min","beeperSound"].includes(l)&&Cache.save("settings",t)};const i=function(l,v){new west.gui.Dialog(Language._("common.save"),Language._("settings.save_to_reload"),"warning").addButton(Language._("common.ok"),function(){for(const d in l)Object.hasOwn(l,d)&&(t[d]=l[d]);isDefined(v)&&v!==TWDB.script.preferences.lang&&(TWDB.script.preferences.lang=v,localStorage.setItem("TWDB_preferences",JSON.stringify(TWDB.script.preferences))),Cache.save("settings",t)?window.location.reload():new UserMessage(Language._("common.save_error"),UserMessage.TYPE_ERROR).show()}).addButton(Language._("common.cancel")).show(),TWDB.Util.addCss(".tw2gui_dialog{margin:0!important;top:50%!important;left:50%!important;transform:translate(-50%,-50%)}.tw2gui_dialog_content{width:460px}")};return n})($);_base.Settings=Settings,Debugger.Settings=Settings;const Updater=(function(e){const t={};let n,o={},a=!1;o=Loader.add("Updater","tw-db Updater",function(){if(!o.ready)try{if(n=Window.addTab("notes",Language._("updater.version_features_title"),Language._("updater.version_features_title"),function(){r()}),Cache.load("version")){if(Script.version!==Cache.load("version")){Cache.save("version",Script.version),a=!0;const i=Language._("updater.script_updated");let l=`<div class="txcenter">${Language._("updater.script_updated_message")}</div>`;l=l.replace("=1=",`<b>${Script.name}</b>`),new west.gui.Dialog(i,l,"warning").addButton(Language._("common.no")).addButton(Language._("common.yes"),function(){Window.open("notes")}).show()}}else Cache.save("version",Script.version);o.ready=!0}catch(i){ErrorModule.report(i,Language._("errors.updater_initialize"))}},{Cache:!0,Window:!0}),t.wasUpdated=function(){return a};const r=function(){try{n.children().remove();const i=new west.gui.Scrollpane;e(i.getMainDiv()).css("height","335px");let l=!1;for(let v=0;v<Script.notes.length;v++){const d=e(`<h3><a>${Language._("updater.version_label")}${Script.notes[v].version}</a></h3>`).css("border-bottom","1px solid black").click(function(){e(this).next().toggle()}),p=Array.isArray(Script.notes[v].notes)?Script.notes[v].notes.join("<br>"):Script.notes[v].notes,c=e(`<div>${p}</div>`);i.appendContent(d).appendContent(c),l&&c.hide(),l=!0}n.append(i.getMainDiv()),Window.hideLoader()}catch(i){ErrorModule.report(i,Language._("errors.updater_render_notes"))}};return t.query=function(){setTimeout(function(){e.getScript(`${Script.protocol}://${Script.folder_url}${Script.check}?${Date.now()}`)},500)},t.check=function(i){try{Script.version.replace(/^0\./,"")!==i&&(function(l){try{const v=Language._("updater.script_needs_update");let d=`<div class="txcenter">${Language._("updater.new_version_available")}</div>`;d=d.replace("=1=",`<b>${Script.name}</b>`),d+=`<div><br />${Language._("updater.current_version")} ${Script.version}<br />${Language._("updater.new_version")} 0.${l}</div>`;const p=`${Script.protocol}://${Script.update_link}${Script.name_max}${Script.update_suffix}`,c=function(){window.open(p),new west.gui.Dialog(Script.name,Language._("updater.reload_after_install"),"warning").setModal(!0,!1,!0).show()};new west.gui.Dialog(v,d,west.gui.Dialog.SYS_WARNING).addButton(Language._("common.not_now")).addButton(Language._("common.ok"),c).show()}catch(v){ErrorModule.report(v,Language._("errors.updater_show_dialog"))}})(i)}catch(l){ErrorModule.report(l,Language._("errors.updater_check_version"))}},t})($);_base.Updater=Updater,Debugger.Updater=Updater;const Sleep=(function(e){let t=null;const n=[];let o,a=[],r={},i={},l=!1,v=0;const d=[],p=["","cubby","bedroom","hotel_room","apartment","luxurious_apartment"];i=Loader.add("Sleep","tw-db DirectSleep",function(){if(!i.ready)try{Settings.get("direct_sleep",!0)&&(TWDB.Util.addCss("ul.tw2gui_selectbox_content.twdb_sleepmenu{max-width:320px!important;white-space:nowrap;overflow-y:auto;overflow-x:hidden}ul.tw2gui_selectbox_content.twdb_sleepmenu>div.tw2gui_scrollpane{width:320px!important}ul.tw2gui_selectbox_content.twdb_sleepmenu>li{padding-right:20px!important}"),r=Cache.load("barracks"),r!==null&&typeof r=="object"||(r={}),c(),Character.homeTown.town_id!==0?T():k()),i.ready=!0}catch(f){ErrorModule.report(f,Language._("errors.sleep_initialize"))}},{Cache:!0,Settings:!0});const c=function(){try{if(!Images.buttonSleep)return waitForImages("buttonSleep",c),void 0;t=GameInject.CharacterButton.add(Images.buttonSleep),t.addMousePopup(Language._("misc.sleep_button_tooltip")).click(function(f){w.Character.homeTown.town_id!==0&&n.length===0?h():g(f)})}catch(f){ErrorModule.report(f,Language._("errors.sleep_add_button"))}},b=function(f,L,D){try{const E=new west.gui.Selectbox(!0).addListener(function(O){O==="home"?h():_(O)});w.Character.homeTown.town_id!==0&&E.addItem("home",`${Language._("map.hotel_label")} ${w.GameMap.calcWayTime(o,w.Character.homeTown).formatDuration()}`);for(let O=0;D>O;O++)f[O].stage!==0&&E.addItem(O,`${Language._("map.stage_label")} ${f[O].stage} ${f[O].distance.formatDuration()} | ${f[O].name}`);e(E.elContent).addClass("twdb_sleepmenu"),E.show(L),l=!1}catch(E){ErrorModule.report(E,Language._("errors.sleep_show_menu")),l=!1}},u=function(f,L,D){try{Ajax.remoteCallMode("building_hotel","get_data",{town_id:d[f].town_id},function(E){if(E.error)return new UserMessage(E.msg).show();d[f].stage=E.hotel_level,++v===L&&b(d,D,L)})}catch(E){ErrorModule.report(E,Language._("errors.sleep_fetch_hotel_data"))}},g=function(f){if(!l)try{if(l=!0,o=MapModule.getLastPosition(),w.Character.homeTown.town_id===0){for(let D=0;D<d.length;D++)d[D].distance=w.GameMap.calcWayTime(o,d[D]);d.sort(function(D,E){return D.distance-E.distance});const L=d.length>5?5:d.length;v=0;for(let D=0;L>D;D++)Object.hasOwn(d[D],"stage")?++v===L&&b(d,f,L):u(D,L,f)}else{for(let L=0;L<n.length;L++)n[L].distance=w.GameMap.calcWayTime(o,n[L]);n.sort(function(L,D){return L.distance-D.distance}),b(n,f,n.length)}}catch(L){ErrorModule.report(L,Language._("errors.sleep_handle_click")),l=!1}},h=function(){try{Ajax.remoteCallMode("building_hotel","get_data",{town_id:w.Character.homeTown.town_id},function(f){if(f.error)return new UserMessage(f.msg).show();const L=p[f.hotel_level];w.TaskQueue.add(new TaskSleep(w.Character.homeTown.town_id,L))})}catch(f){ErrorModule.report(f,Language._("errors.sleep_at_home"))}},_=function(f){try{isDefined(d[f])?w.TaskQueue.add(new TaskSleep(d[f].town_id,p[d[f].stage])):isDefined(n[f])&&w.TaskQueue.add(new TaskFortSleep(n[f].id,n[f].x,n[f].y))}catch(L){ErrorModule.report(L,Language._("errors.sleep_at_location"))}},k=function(){try{Ajax.get("map","get_minimap",{},function(f){if(f.error)return new UserMessage(f.msg).show();for(const L in f.towns)f.towns[L].member_count&&d.push(f.towns[L])})}catch(f){ErrorModule.report(f,Language._("errors.sleep_load_alliance_towns"))}},T=function(){try{w.Character.homeTown.alliance_id===0?Ajax.remoteCall("fort_overview","",{},function(f){for(const L in f.js){const D=f.js[L],E=f.page.match(RegExp(`<div id="ownforts">[\\S\\s]+FortWindow.open\\(undefined, ${D[1]}, ${D[2]})\\)">(.+?)</a>[\\S\\s]+<div id="lastbattle">`));E&&a.push({fort_id:D[0],x:D[1],y:D[2],name:E[1]})}a.length>0&&w.setTimeout(function(){C()},Timer.getTimeout())}):Ajax.remoteCallMode("alliance","get_data",{alliance_id:w.Character.homeTown.alliance_id},function(f){if(f.error)return new UserMessage(f.error).show();a=f.data.forts,a.length>0&&w.setTimeout(function(){C()},Timer.getTimeout())})}catch(f){ErrorModule.report(f,Language._("errors.sleep_load_fort_data"))}},C=function(){try{if(0>=a.length)return;const f=a.pop(),L=f.fort_id;if(isDefined(r[L])||(r[L]={time:0,stage:0}),e.extend(r[L],{id:L,x:f.x,y:f.y,name:f.name}),r[L].stage!==5&&r[L].time+86400>Date.now()/1e3)return n.push(r[L]),a.length>0?w.setTimeout(function(){C()},Timer.getTimeout()):Cache.save("barracks",r),void 0;Ajax.remoteCallMode("fort_building_barracks","index",{fort_id:L},function(D){D.error?new UserMessage(D.error).show():(r[L].time=Math.floor(Date.now()/1e3),isDefined(D.barrackStage)&&(r[L].stage=D.barrackStage),r[L].stage!==5&&r[L].time+86400>Date.now()/1e3&&n.push(r[L]),a.length>0?w.setTimeout(function(){C()},Timer.getTimeout()):Cache.save("barracks",r))})}catch(f){ErrorModule.report(f,Language._("errors.sleep_process_fort_data"))}};return{}})($);Debugger.Sleep=Sleep;const Analyzer=(function(e){function t(B,m){let A,I;if(m){const M=(m+"").match(/\[report=([0-9]+)([A-Fa-f0-9]{10})\]/);A=M?M[1]:m}else A=0;const j=parseInt(A,10);switch(I=Number.isNaN(j)?0:j-1,B){case"job":o[B]={last:I,items:{last:0}};break;case"duel":o[B]={last:I};break;case"chest":o[B]={};break;case"all":o={ver:4},t("job",I+1),t("duel",I+1),t("chest",I+1)}}const n={};let o=null,a=null,r=!1,i=[];const l=[];let v=0;const d={currentWindowElement:null,progressBar:null,tableRows:[],tableFooter:null,tableBodyScrollpane:null};let p={order:1,sortByColumn:0,displayMode:"avg"},c={};n.extra=!1;const b=function(B,m=!1,A){m?t(B,A):(function(I){const j=e(`<div><h2>${Language._("analyzer.reset_confirm_title")}</h2><span style="font-size:12px"><br />${Language._("analyzer.reset_confirm_message")}</span></div>`),M=new west.gui.Textfield("twdb_analyzer_last").setSize(40);M.setLabel(Language._("analyzer.report_link_label")),j.append(M.getMainDiv());const U=new west.gui.Checkbox(Language._("analyzer.use_all_reports")+"&nbsp;&nbsp;"),z=new west.gui.Checkbox(""+Language._("analyzer.use_future_reports"));U.setCallback(function(S){S&&(z.setSelected(!1),M.setValue(""))}),z.setCallback(function(S){S&&(U.setSelected(!1),M.setValue(""))}),e(M.getMainDiv()).find("span").css("font-size","12px"),e(M.getMainDiv()).find("input").keyup(function(){U.setSelected(!1),z.setSelected(!1)}),j.append(e('<div style="display:block;" />').append(U.getMainDiv()).append(z.getMainDiv()));const R=new west.gui.Dialog(Language._("analyzer.reset_report_analyzer"),j);R.addButton(Language._("common.ok"),function(){U.isSelected()?t(I):z.isSelected()?t(I,o[I].last+1):t(I,M.getValue()),R.hide(),MessagesWindow.open("analyzer-"+I)}),R.addButton(Language._("common.cancel")),R.show()})(B)},u=function(B,m){m||(m=1),v=m,Ajax.remoteCall("reports","get_reports",{page:m,folder:B},function(A){g(B,A)})},g=function(B,m){let A=!0;typeof m.reports=="object"&&m.reports!==null||(m.reports=[],A=!1),m.page!==void 0&&v===m.page||(m.reports=[],A=!1);for(let I=0;I<m.reports.length;I++){const j=m.reports[I];if(j.report_id<=o[B].last){A=!1;break}i.push({id:j.report_id,hash:j.hash,type:B})}d.progressBar.setMaxValue(i.length),A?window.setTimeout(()=>u(B,v+1),Timer.getTimeout()):h(B)},h=function(B){i.length>0?(d.progressBar.setValue(d.progressBar.getValue()+1),_(i.pop())):(Cache.save("statistic",o),r=!1,f(B,!0))},_=function(B){e.post("game.php?window=reports&mode=show_report",{flash:null,hash:B.hash,report_id:B.id},function(m){k(B.type,m)},"json")},k=function(B,m){if(!m||!m.report_id||!m.publishHash)return new UserMessage(Language._("errors.empty_server_response"),UserMessage.TYPE_ERROR).show(),!1;if(typeof m.page!="string"||typeof m.title!="string"||typeof m.js!="string")l.push(m.report_id);else{switch(B){case"job":T(m);break;case"duel":C(m)}o[B].last=m.report_id}window.setTimeout(()=>h(B),Timer.getTimeout())},T=function(B){const m={id:null,hash:null,job:null,motivation:null,duration:null,wage:null,bond:null,experience:null,injury:0,killed:!1,date_received:null,items:{}};try{m.id=B.report_id,m.hash=B.publishHash;const A=Jobs.getJobByName(B.title.slice(B.title.indexOf(":")+1));if(!A)return l.push(m.id),!1;m.job=A.id,m.date_received=B.date_received;const I=e(B.page);I.find(".rp_row_jobdata").each(function(z){let R=e.trim(e(this).children("span:last-child").html());switch(R=R.split("&nbsp;").join(" "),z){case 0:m.motivation=parseInt(R.slice(0,R.indexOf(" ")),10);break;case 1:{const S=parseFloat(R);m.duration=S===1?3600:S===10?600:S===15?15:null,m.duration||ErrorModule.report({message:"Unrecognized time on report:"+R},"Job-Analyzer");break}case 2:m.wage=parseInt(R.slice(R.indexOf(" ")+1),10);break;case 3:m.bond=parseInt(R,10);break;case 4:m.experience=parseInt(R.slice(0,R.indexOf(" ")),10)}}),I.find(".rp_hurtmessage_text").each(function(){m.injury=+/[0-9]+/.exec(e(this).html())}),I.find(".rp_row_killmessage").each(function(){m.killed=!0});const j=B.js.split(";");e(j).each(function(){const z=/\s*ItemManager\.get\(([0-9]+)\)\s*\)\.setCount\(([0-9]+)\)/m.exec(this);z&&(m.items[+z[1]]=+z[2])}),o.job[m.job]||(o.job[m.job]={count:0,products:{}});const M=o.job[m.job];M.count++,M[m.motivation]||(M[m.motivation]={count:0,duration:0,wage:0,bond:0,experience:0,injury:{},killed:0,items:{},extraitems:{}});const U=M[m.motivation];isDefined(U.duration)||(U.duration=0),U.count++,U.duration+=m.duration,U.wage+=m.wage,U.bond+=m.bond,U.experience+=m.experience,U.injury[m.injury]||(U.injury[m.injury]=0),U.injury[m.injury]++,m.killed&&U.killed++;for(const z in m.items){const R=+z;R===138e3&&(isDefined(o.extra)||(o.extra={count:0},n.extra=!0),o.extra.count++,o.extra[o.extra.count]=m);const S=m.items[R],G=ItemManager.get(R);if(Jobs.isProduct(R)!==-1){M.products[R]||(M.products[R]={last:0});const N=M.products[R];for(let F=0;S>F;F++){const Q=M.count-N.last;N.last=M.count,N[Q]||(N[Q]=0),N[Q]++}}else G.price===0?(U.extraitems[R]||(U.extraitems[R]=0),U.extraitems[R]++):(U.items[R]||(U.items[R]=0),U.items[R]++)}}catch(A){return l.push(m.id),ErrorModule.report(A,Language._("errors.analyzer_parse_job_report")),!1}},C=function(B){},f=function(B,m){if(MessagesWindow.window)if(d.currentWindowElement=e(MessagesWindow.window.getContentPane()).find(".messages-analyzer-"+B),m===void 0)MessagesWindow.window.showLoader(),d.progressBar=new west.gui.Progressbar(0,i.length),d.currentWindowElement.children().remove(),d.currentWindowElement.append(d.progressBar.getMainDiv()),(function(A){r||(r=!0,i=[],v=0,u(A,1))})(B);else{let A;switch(d.currentWindowElement.children().remove(),B){case"job":A=E();break;case"duel":A=O()}d.currentWindowElement.append(A),L(),D(),L(),MessagesWindow.window.hideLoader()}},L=function(B){try{B!==void 0?p.sortByColumn===B?p.order*=-1:(p.order=1,p.sortByColumn=B):B=p.sortByColumn;const m=p.order,A=(I,j)=>{const M=e(I).find(".cell_"+B).html(),U=e(j).find(".cell_"+B).html();return+M===parseFloat(M)?parseFloat(M)>parseFloat(U)?m:-m:M>U?m:-m};d.tableRows.sort(A);for(let I=0;I<d.tableRows.length;I++)d.tableBodyScrollpane.appendContent(d.tableRows[I])}catch(m){ErrorModule.report(m,Language._("errors.analyzer_apply_table_sorting"))}},D=function(){p.displayMode=p.displayMode==="avg"?"sum":"avg",e(d.currentWindowElement).find("div.row div").each(function(B){const m=e(this),A=m.data(p.displayMode+""),I=m.data(p.displayMode+"-t");m.html(A).attr("title",I)})},E=function(){d.currentWindowElement.addClass("view-rewards"),p={order:1,sortByColumn:0,displayMode:"avg"};const B=e(`<div class="fancytable"><div class="_bg tw2gui_bg_tl"></div><div class="_bg tw2gui_bg_tr"></div><div class="_bg tw2gui_bg_bl"></div><div class="_bg tw2gui_bg_br"></div><div class="trows"><div class="thead statics"><div class="row row_head"><div class="cell_0 view-rewards view-items" style="width:91px; text-align:center;"><span title="${Language._("analyzer.table_header_name")}" style="cursor:pointer, margin-bottom:3px;"><img src="${Images.iconName}"/></span></div><div class="cell_1 view-rewards view-items" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_count")}"><img src="${Images.iconCount}"/></span></div><div class="cell_2 view-rewards view-items" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_duration")}"><img src="${Images.iconClock}"/></span></div><div class="cell_3 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_experience")}"><img src="${Images.iconExperience}"/></span></div><div class="cell_4 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_money")}"><img src="${Images.iconDollar}"/></span></div><div class="cell_5 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_bonds")}"><img src="${Images.iconUpb}"/></span></div><div class="cell_6 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_motivation")}"><img src="${Images.iconMoti}"/></span></div><div class="cell_7 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_danger")}"><img src="${Images.iconDanger}"/></span></div><div class="cell_8 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_killed")}"><img src="${Images.iconKilled}"/></span></div><div class="cell_9 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_yield")}"><img src="${Images.iconYield}"/></span></div><div class="cell_9 view-items" style="width:63px; text-align:center;"><span title="${Language._("analyzer.table_header_yield")}"><img src="${Images.iconYield}"/></span></div><div class="cell_10 view-rewards" style="width:50px; text-align:center;"><span title="${Language._("analyzer.table_header_items")}"><img src="${Images.iconItem}"/></span></div><div class="cell_10 view-items" style="width:378px; text-align:center;"><span title="${Language._("analyzer.table_header_items")}"><img src="${Images.iconItem}"/></span></div><div class="cell_11 view-rewards" style="width:41px; text-align:center;"><span title="${Language._("analyzer.table_header_luck")}"><img src="${Images.iconLuck}"/></span></div><div class="cell_reset view-rewards view-items" style="width:20px; text-align:right;"><span title="${Language._("analyzer.table_header_reset")}"><img src="${Images.iconReset}"/></span></div></div></div><div class="tbody"><div class="_bg tw2gui_bg_l"></div><div class="_bg tw2gui_bg_r"></div></div><div class="tfoot statics"><div class="row row_foot"></div></div></div>`);B.find(".row_head > div").each(function(){const I=e(this),j=I.attr("class").match(/cell_(\d+|reset)/),M=j?j[1]:null;var U;M==="reset"?I.click(function(){b("job")}):M!==null&&I.click((U=+M,()=>L(U)))}),B.find(".row_head").find("img").css("cursor","pointer");const m={jobs:0,count:0,duration:0,experience:0,wage:0,bond:0,motivation:0,injury:0,killed:0,products:0,items:0,luck:0},A=o.job;d.tableRows=[];for(const I in A){const j=Jobs.getJobById(I);if(!j)continue;const M={count:0,duration:0,experience:0,wage:0,bond:0,motivation:0,injury:0,killed:0,products:0,items:0,luck:0,all_products:{},all_items:{}},U=A[I];M.count=U.count;let z=0;if(Array.isArray(j.randomyields))for(let S=0;S<j.randomyields.length;S++)z+=j.randomyields[S];if(typeof j.yields=="object"&&j.yields!==null)for(const S in j.yields)z+=j.yields[S].prop;for(const S in U.products)if(S!=="last")for(const G in U.products[S]){const N=+U.products[S][G];M.products+=N;const F=ItemManager.get(S);F&&(M.luck+=+F.price*N),M.all_products[S]=(M.all_products[S]||0)+N}for(const S in U){if(S==="count"||S==="products")continue;const G=U[S];M.motivation+=+S*G.count,M.bond+=G.bond,M.duration+=G.duration||0,M.experience+=G.experience;for(const N in G.injury)M.injury+=+N*G.injury[N];for(const N in G.items){const F=+G.items[N];M.items+=F;const Q=ItemManager.get(N);Q&&(M.luck+=+Q.price*F),M.all_items[N]=(M.all_items[N]||0)+F}M.killed+=G.killed,M.wage+=G.wage}const R=e(`<div class="row row_${I}" />`);[{classes:"cell_0 view-rewards view-items",style:"width:91px; text-align:left;cursor:pointer;font-size:11px;",sum:j.name,sumT:j.name,avg:j.name,avgT:j.name},{classes:"cell_1 view-rewards view-items",style:"width:50px; text-align:center;cursor:pointer;",sum:M.count,sumT:M.count,avg:M.count,avgT:M.count},{classes:"cell_2 view-rewards view-items",style:"width:50px; text-align:center;cursor:pointer;",sum:round(M.duration/3600,2),sumT:`${round(M.duration/3600,2)+""} ${Language._("analyzer.hours")}`,avg:round(M.duration/(3600*M.count),2),avgT:`&Oslash; ${round(M.duration/(3600*M.count),2)+""} ${Language._("analyzer.hours")}`},{classes:"cell_3 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.experience,sumT:M.experience+"",avg:round(M.experience/M.count,2),avgT:"&Oslash; "+round(M.experience/M.count,2)},{classes:"cell_4 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.wage,sumT:"$"+M.wage,avg:round(M.wage/M.count,2),avgT:"&Oslash; $"+round(M.wage/M.count,2)},{classes:"cell_5 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.bond,sumT:M.bond+"",avg:round(M.bond/M.count*100,2),avgT:`&Oslash; ${round(M.bond/M.count*100,2)+""}%`},{classes:"cell_6 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.motivation,sumT:M.motivation+"%",avg:round(M.motivation/M.count,2),avgT:`&Oslash; ${round(M.motivation/M.count,2)+""}%`},{classes:"cell_7 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.injury,sumT:M.injury+"",avg:round(M.injury/M.count,2),avgT:"&Oslash; "+round(M.injury/M.count,2)},{classes:"cell_8 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.killed,sumT:M.killed+"",avg:round(M.killed/M.count*100,2),avgT:`&Oslash; ${round(M.killed/M.count*100,2)+""}%`},{classes:"cell_9 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.products,sumT:M.products+"",avg:round(M.products/M.count*100,2),avgT:`&Oslash; ${round(M.products/M.count*100,2)+""}% [${100*z}%]`},{classes:"cell_9 view-items",style:"width:63px; text-align:center;cursor:pointer;",sum:e.map(M.all_products,(S,G)=>new tw2widget.Item(ItemManager.get(G)).setCount(S).getMainDiv()),avg:e.map(M.all_products,(S,G)=>new tw2widget.Item(ItemManager.get(G)).setCount(S).getMainDiv())},{classes:"cell_10 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.items,sumT:M.items+"",avg:round(M.items/M.count*100,2),avgT:`&Oslash; ${round(M.items/M.count*100,2)+""}%`},{classes:"cell_10 view-items",style:"width:390px; text-align:center;cursor:pointer;",sum:e.map(M.all_items,(S,G)=>new tw2widget.Item(ItemManager.get(G)).setCount(S).getMainDiv()),avg:e.map(M.all_items,(S,G)=>new tw2widget.Item(ItemManager.get(G)).setCount(S).getMainDiv())},{classes:"cell_11 view-rewards",style:"width:50px; text-align:center;cursor:pointer;",sum:M.luck,sumT:"$"+M.luck,avg:round(M.luck/M.count,2),avgT:"&Oslash; $"+round(M.luck/M.count,2)}].forEach((S,G)=>{const N=e(`<div class="${S.classes}" style="${S.style}" ></div>`);N.data("sum",S.sum),N.data("sum-t",S.sumT),N.data("avg",S.avg),N.data("avg-t",S.avgT),typeof S.sum=="object"&&S.sum!==null&&N.append(S.sum),R.append(N)}),m.jobs++,m.count+=M.count,m.duration+=M.duration,m.experience+=M.experience,m.wage+=M.wage,m.bond+=M.bond,m.motivation+=M.motivation,m.injury+=M.injury,m.killed+=M.killed,m.products+=M.products,m.items+=M.items,m.luck+=M.luck,d.tableRows.push(R),R.click(function(){W(e(this).children(".cell_0").html())})}return d.tableBodyScrollpane=new west.gui.Scrollpane,e(d.tableBodyScrollpane.getMainDiv()).css("height","300px"),B.find(".tbody").append(d.tableBodyScrollpane.getMainDiv()),d.tableFooter=B.find(".row_foot"),[{classes:"cell_0",style:"width:71px; text-align:center;",sum:m.jobs,sumT:`${m.jobs} ${Language._("analyzer.jobs_count")}`,avg:m.jobs,avgT:`${m.jobs} ${Language._("analyzer.jobs_count")}`},{classes:"cell_0 view-rewards view-items",style:"width:87px; text-align:center;cursor:pointer;color:#444;",sum:"&sum;",sumT:Language._("analyzer.table_sum_tooltip"),avg:"&Oslash;",avgT:Language._("analyzer.table_avg_tooltip"),onClick:D,onMouseEnter:function(){e(this).css("color","#888")},onMouseLeave:function(){e(this).css("color","#444")}},{classes:"cell_1 view-rewards view-items",style:"width:50px; text-align:center;",sum:m.count,sumT:m.count,avg:m.count,avgT:m.count},{classes:"cell_2 view-rewards view-items",style:"width:50px; text-align:center;",sum:round(m.duration/3600,2),sumT:`${round(m.duration/3600,2)+""} ${Language._("analyzer.hours")}`,avg:round(m.duration/(3600*m.count),2),avgT:`&Oslash; ${round(m.duration/(3600*m.count),2)+""} ${Language._("analyzer.hours")}`},{classes:"cell_3 view-rewards",style:"width:50px; text-align:center;",sum:m.experience,sumT:m.experience+"",avg:round(m.experience/m.count,2),avgT:"&Oslash; "+round(m.experience/m.count,2)},{classes:"cell_4 view-rewards",style:"width:50px; text-align:center;",sum:m.wage,sumT:"$"+m.wage,avg:round(m.wage/m.count,2),avgT:"&Oslash; $"+round(m.wage/m.count,2)},{classes:"cell_5 view-rewards",style:"width:50px; text-align:center;",sum:m.bond,sumT:m.bond+"",avg:round(m.bond/m.count*100,2),avgT:`&Oslash; ${round(m.bond/m.count*100,2)+""}%`},{classes:"cell_6 view-rewards",style:"width:50px; text-align:center;",sum:m.motivation,sumT:m.motivation+"%",avg:round(m.motivation/m.count,2),avgT:`&Oslash; ${round(m.motivation/m.count,2)+""}%`},{classes:"cell_7 view-rewards",style:"width:50px; text-align:center;",sum:m.injury,sumT:m.injury+"",avg:round(m.injury/m.count,2),avgT:"&Oslash; "+round(m.injury/m.count,2)},{classes:"cell_8 view-rewards",style:"width:50px; text-align:center;",sum:m.killed,sumT:m.killed+"",avg:round(m.killed/m.count*100,2),avgT:`&Oslash; ${round(m.killed/m.count*100,2)+""}%`},{classes:"cell_9 view-rewards",style:"width:50px; text-align:center;",sum:m.products,sumT:m.products+"",avg:round(m.products/m.count*100,2),avgT:`&Oslash; ${round(m.products/m.count*100,2)+""}%`},{classes:"cell_9 view-items",style:"width:63px; text-align:center;",sum:m.products,sumT:m.products+"",avg:round(m.products/m.count*100,2),avgT:`&Oslash; ${round(m.products/m.count*100,2)+""}%`},{classes:"cell_10 view-rewards",style:"width:50px; text-align:center;",sum:m.items,sumT:m.items+"",avg:round(m.items/m.count*100,2),avgT:`&Oslash; ${round(m.items/m.count*100,2)+""}%`},{classes:"cell_10 view-items",style:"width:390px; text-align:center;",sum:m.items,sumT:m.items+"",avg:round(m.items/m.count*100,2),avgT:`&Oslash; ${round(m.items/m.count*100,2)+""}%`},{classes:"cell_11 view-rewards",style:"width:50px; text-align:center;",sum:m.luck,sumT:"$"+m.luck,avg:round(m.luck/m.count,2),avgT:"&Oslash; $"+round(m.luck/m.count,2)}].forEach(I=>{const j=e(`<div class="${I.classes}" style="${I.style}" ></div>`);j.data("sum",I.sum),j.data("sum-t",I.sumT),j.data("avg",I.avg),j.data("avg-t",I.avgT),I.onClick&&j.click(I.onClick),I.onMouseEnter&&j.on("mouseenter",I.onMouseEnter),I.onMouseLeave&&j.on("mouseleave",I.onMouseLeave),d.tableFooter.append(j)}),e('<div style="margin: 0px 6px 0px 6px;width:680px;" />').append(e(`<a href="#">${Language._("analyzer.toggle_rewards_items")}</a>`).css({marginTop:"-8px",display:"block",textAlign:"center"}).click(function(){e(".messages-analyzer-job").toggleClass("view-rewards view-items")})).append(B)},O=function(){return e("<div/>").text(Language._("analyzer.duel_coming_soon"))},W=function(B){},P=(function(B){return{add:function(m,A){let I=!1;for(let j=0;j<A.msg.effects.length;j+=1){const M=A.msg.effects[j];if(M.type==="lottery"||M.type==="content"){isDefined(o.chest[m.item_id])||(o.chest[m.item_id]={count:0,items:{}});const U=o.chest[m.item_id];I||(U.count++,I=!0),M.items.each(function(z){isDefined(U.items[z.item_id])||(U.items[z.item_id]=0),U.items[z.item_id]+=z.count})}else M.type==="learn_recipe"&&(TWDB.ClothCalc.recipes[M.recipe]=1)}Cache.save("statistic",o)},show:function(){if(!MessagesWindow.window)return;const m=B(MessagesWindow.window.getContentPane()).find(".messages-analyzer-chest");MessagesWindow.window.showLoader(),m.children().remove();const A=new west.gui.Scrollpane;B(A.getMainDiv()).css("height","385px"),m.append(A.getMainDiv());for(const I in o.chest){const j=o.chest[I],M=new tw2widget.Item(ItemManager.get(I),"item_inventory").setCount(j.count);M.getImgEl().addClass("item_inventory_img"),A.appendContent(B('<div style="float:left;position:relative;height:61px;width:61px;" />').append(M.getMainDiv()));let U=0;const z=B('<div style="float:left;position:relative;width:610px;" />');for(const S in j.items){U++;const G=new tw2widget.Item(ItemManager.get(S),"item_inventory").setCount(j.items[S]);G.getImgEl().addClass("item_inventory_img"),z.append(G.getMainDiv())}const R=61*Math.ceil(U/10)+"";A.appendContent(`<div style="float:left;position:relative;width:10px;height:${R}px;background: url(/images/window/report/devider_report.png) repeat-y;" />`).appendContent(z).appendContent('<div style="clear:both;position:relative;height:10px;display:block;background: url(/images/window/dailyactivity/wood_devider_horiz.png) repeat-x;" />')}MessagesWindow.window.hideLoader()}}})(e);return c=Loader.add("Analyzer","tw-db Job-Analyzer",function(){if(c.ready)return;TWDB.Util.addCss(".messages-analyzer-job .item img.tw_item{width:30px;height:27px}.messages-analyzer-job .item .count{bottom:-4px}.messages-analyzer-job .item span.usable{display:none}div.tw2gui_window .messages-analyzer-job div.fancytable .row>div{display:none;vertical-align:top}.messages-analyzer-job.view-rewards div.fancytable .row>div.view-rewards{display:inline-block}.messages-analyzer-job.view-items div.fancytable .row>div.view-items{display:inline-block}div.tw2gui_window .messages-analyzer-job div.fancytable div.trows div.tbody div.row{height:auto}");const B=Cache.load("statistic");switch(typeof B=="object"&&B!==null?o=B:b("all",!0),o&&o.ver||b("all",!0),o.ver){case 1:b("job",!0,1),b("duel",!0,1),o.ver=2;case 2:b("job",!0,1),b("duel",!0,1),o.ver=3;case 3:b("chest",!0,1),o.ver=4}a=e.extend(!0,{},o),GameInject.addTabOnMessagesWindow(Language._("analyzer.job_title"),"analyzer-job",function(){f("job")}),Settings.get("chest_analyzer",!0)&&(GameInject.ItemUse(P.add),GameInject.addTabOnMessagesWindow(Language._("analyzer.chest_title"),"analyzer-chest",P.show)),c.ready=!0},{Cache:!0,Settings:!0,Jobs:!0}),n.restore=function(){o=e.extend(!0,{},a),Cache.save("statistic",o);const B=MessagesWindow.getActiveTab();if(B?.startsWith("analyzer-")){const m=B.split("-")[1];f(m,!0)}},n.debug=function(){},n.getExtra=function(){return isDefined(o.extra)?o.extra:null},n})(jQuery);Debugger.Analyzer=Analyzer;const Notes=(function(e){let t=null,n={};n=Loader.add("Notes","tw-db Notes",function(){if(!n.ready)try{Settings.get("notes",!0)&&GameInject.addTabOnMessagesWindow(Language._("misc.notes_title"),"notes",function(){o()}),n.ready=!0}catch(i){ErrorModule.report(i,Language._("errors.notes_initialize"))}},{Cache:!0,Settings:!0});const o=function(){try{if(!w.MessagesWindow.window)return;t=e(w.MessagesWindow.window.getContentPane()).find(".messages-notes"),t.css("width","680px").css("margin","0 auto").css("position","relative").css("top","0"),r(Cache.load("notes"))}catch(i){ErrorModule.report(i,Language._("errors.notes_render_tab"))}},a=function(i){try{Cache.save("notes",i),new UserMessage(Language._("common.save_success"),UserMessage.TYPE_SUCCESS).show()}catch(l){ErrorModule.report(l,Language._("errors.notes_save"))}},r=function(i){try{t.children().remove();const l=new west.gui.Scrollpane;e(l.getMainDiv()).css("height","324px"),e(l.getMainDiv()).find(".tw2gui_scrollpane_clipper_contentpane").addClass("selectable"),t.append(e('<div style="margin:8px" />').append(l.getMainDiv())).append(e('<div style="margin-left:8px" />').append(new west.gui.Button(Language._("common.save").escapeHTML(),function(){a(i)}).getMainDiv()).append(new west.gui.Button(Language._("common.edit").escapeHTML(),function(){(function(v){try{t.children().remove(),w.MessagesWindow.window.showLoader();const d=new west.gui.Textarea().setWidth(660).setHeight(300).setContent(v);t.append(e('<div style="margin-left:8px" />').append(new west.gui.Bbcodes(d).getMainDiv())).append(d.getMainDiv()).append(e('<div style="margin-left:8px" />').append(new west.gui.Button(Language._("common.save").escapeHTML(),function(){a(d.getContent()),r(d.getContent())}).getMainDiv()).append(new west.gui.Button(Language._("common.preview").escapeHTML(),function(){r(d.getContent())}).getMainDiv())),w.MessagesWindow.window.hideLoader()}catch(d){ErrorModule.report(d,Language._("errors.notes_edit"))}})(i)}).getMainDiv())),i&&(w.MessagesWindow.window.showLoader(),Ajax.remoteCall("settings","get_parsed_text",{text:i},function(v){l.appendContent(w.Game.TextHandler.parse(v.parsed_text)),w.MessagesWindow.window.hideLoader()}))}catch(l){ErrorModule.report(l,Language._("errors.notes_display"))}};return{}})($);Debugger.Notes=Notes;const MapModule=(function(e){const t={};let n=0,o=0,a={},r=null,i=null,l={};l=Loader.add("Map","tw-db Map",function(){if(!l.ready)try{Settings.get("coordinates_input",!0)&&v(),Ajax.get("map","get_minimap",{},function(d){if(d.error)return l.failed=!0,new UserMessage(d.msg).show();a=d.job_groups,l.ready=!0})}catch(d){ErrorModule.report(d,Language._("errors.map_initialize"))}},{Settings:!0}),t.getNearestJob=function(d){try{const p=JobList.getJobById(d),c=a[p.groupid];if(!c)return[];const b=[],u=t.getLastPosition();for(let h=0;h<c.length;h++){const _=c[h][0]-u.x,k=c[h][1]-u.y,T=Math.sqrt(_*_+k*k),C=window.GameMap.calcWayTime({x:c[h][0],y:c[h][1]},u);let f=round(180*Math.atan(k/_)/Math.PI);0>_&&(f-=180),b.push({dist:T,time:C,x:c[h][0],y:c[h][1],angle:f})}const g=function(h,_){return 1*h.dist>1*_.dist?1:-1};return b.sort(g),b}catch(p){return ErrorModule.report(p,Language._("errors.map_get_nearest_job")),[]}},t.getLastPosition=function(){const d={x:Character.position.x,y:Character.position.y},p=TaskQueue.queue;for(let c=0;c<p.length;c++){const b=p[c].wayData;b.x&&(d.x=b.x,d.y=b.y)}return d},t.setMinimapJob=function(d){try{r&&(window.clearInterval(i),window.clearInterval(r));const p=function(c){MinimapWindow.window&&e(MinimapWindow.window.divMain).find(".tw2gui_jobsearch_string").length!==0&&e(MinimapWindow.window.divMain).find(".tw2gui_jobsearch_string").is(":visible")&&(window.clearInterval(r),window.clearInterval(i),r=null,i=null,MinimapWindow.resetSearchContext(),e("input.tw2gui_jobsearch_string",MinimapWindow.DOM).val(c).keyup())};i=setInterval(function(){window.clearInterval(r),window.clearInterval(i),r=null,i=null},3e5),r=setInterval(function(){p(d)},200)}catch(p){ErrorModule.report(p,Language._("errors.map_set_minimap_job"))}},t.loadMap=function(){(function(){try{let d=!1,p=0;const c=[];for(let b=n;181>=b;b++){for(let u=o;79>=u;u++)if(p++,c.push([b,u]),p>299){d=!0;break}if(d)break;o=0}n=x,o=y+1,c.length>0&&window.GameMap.Data.Loader.load(c,function(){setTimeout(function(){t.loadMap()},Timer.getTimeout())})}catch(d){ErrorModule.report(d,Language._("errors.map_scan_coordinates"))}})()};const v=function(){try{TWDB.Util.addCss("div#mmap_twdb_coords{position:absolute;bottom:35px;left:1px;display:block}div#mmap_twdb_coords>img{cursor:pointer;opacity:0.5;position:relative}","minimap");const d=function(){const p=e('<div id="mmap_twdb_coords" />'),c=new west.gui.Textfield,b=new west.gui.Textfield;let u="",g="";c.setWidth(45),b.setWidth(45).setMaxLength(5);const h=function(){const T=+c.getValue(),C=+b.getValue();window.GameMap.center(T,C),c.setValue(""),b.setValue("")};e(c.getMainDiv()).find("input").keyup(function(T){window.setTimeout(function(){let C;if(T.ctrlKey&&T.keyCode===86&&!T.altKey){if(C=/^([0-9]{1,5})([^0-9]+)([0-9]{1,5})$/.exec(e.trim(c.getValue())),C)return c.setValue(C[1]),b.setValue(C[3]),e(b.getMainDiv()).find("input").focus(),u=c.getValue(),g=b.getValue(),void 0;if(C=/^([0-9]{1,5})$/.exec(e.trim(c.getValue())),C)return c.setValue(C[1]),e(b.getMainDiv()).find("input").focus(),u=c.getValue(),void 0;c.setValue(u)}return T.keyCode===13?h():(e.trim(c.getValue())+"").length===0?(u=c.getValue(),void 0):(C=/^([0-9]{1,5})$/.exec(e.trim(c.getValue())),C?(c.setValue(C[1]),(C[1]+"").length===5&&e(b.getMainDiv()).find("input").focus(),u=c.getValue(),void 0):(c.setValue(u),void 0))},100)}),e(b.getMainDiv()).find("input").keyup(function(T){window.setTimeout(function(){if(T.ctrlKey&&T.keyCode===86&&!T.altKey){const f=/^([0-9]{1,5})$/.exec(e.trim(b.getValue()));if(f)return b.setValue(f[1]),e(b.getMainDiv()).find("input").focus(),g=b.getValue(),void 0;b.setValue(g)}if(T.keyCode===13)return h(),void 0;if((e.trim(b.getValue())+"").length===0)return g=b.getValue(),void 0;const C=/^([0-9]{1,5})$/.exec(e.trim(b.getValue()));if(C)return b.setValue(C[1]),(C[1]+"").length===5&&e(b.getMainDiv()).find("input").focus(),g=b.getValue(),void 0;b.setValue(g)},100)});const _=new west.gui.Button(Language._("common.ok"),function(){h()},null,null,Language._("map.coordinates_button")).setWidth("48"),k=e(`<img title="${Language._("map.coordinates_tooltip")}" src="${Images.iconCount}" />`).click(function(){e(this).css("opacity")===1?(e(this).css("opacity","0.5"),window.GameMap.hideCoords()):(e(this).css("opacity","1"),window.GameMap.showCoords())});p.append(k,c.getMainDiv(),"<span>|</span>",b.getMainDiv(),e(_.getMainDiv()).css("top","6px")),e(".minimap-right",MinimapWindow.window.divMain).append(p)};GameInject.injectMinimap(function(){d()})}catch(d){ErrorModule.report(d,Language._("errors.map_initialize_coordinates"))}};return t})($);_base.Map=MapModule,Debugger.Map=MapModule;const BonusJobs=(function(e){let t,n={},o={gold:!1,silver:!1};initializeBonusJobs=function(){if(!n.ready)try{if(!Settings.get("bonus_jobs",!0))return n.ready=!0,void 0;let p,c,b,u;const g=get_server_date(),h=1,_=new Date;_.setUTCHours(h),_.setMinutes(15),_.setSeconds(0),_.setMilliseconds(0);let k=_.getTime();for(p in(g.getUTCHours()<h||g.getUTCHours()===h&&15>g.getMinutes())&&(k-=864e5),t=Cache.load("bonusjobs")||{},o=Cache.load("bonusdisplay")||{gold:!1,silver:!1},t)if(Object.hasOwn(t,p)){for(u in c=t[p],b=0,c)Object.hasOwn(c,u)&&(c[u].gold||c[u].time>k?b++:delete c[u]);b===0&&delete t[p]}r(),a(),n.ready=!0}catch(p){ErrorModule.report(p,Language._("errors.bonusjobs_initialize"))}},n=Loader.add("BonusJobs","tw-db BonusJobs",initializeBonusJobs,{Settings:!0,Cache:!0,Jobs:!0});const a=function(){try{const p=function(c){const b=window.GameMap.Helper.getPosition(c.parent);if(!isDefined(b)||!isDefined(b.x)||!isDefined(b.y))return;if(!isDefined(window.GameMap.JobHandler.Featured[`${b.x}-${b.y}`]))return isDefined(t[`${b.x}-${b.y}`])&&(delete t[`${b.x}-${b.y}`],Cache.save("bonusjobs",t)),void 0;const u=window.GameMap.JobHandler.Featured[`${b.x}-${b.y}`];let g;for(g in t[`${b.x}-${b.y}`]={},u)Object.hasOwn(u,g)&&(t[`${b.x}-${b.y}`][g]=u[g],t[`${b.x}-${b.y}`][g].time=Date.now());Cache.save("bonusjobs",t)};GameInject.injectRadialmenu(function(c){p(c)})}catch(p){ErrorModule.report(p,Language._("errors.bonusjobs_process_data"))}},r=function(){try{TWDB.Util.addCss('div#mmap_twdb_bonusjobs{position:absolute;top:40px;right:10px}div#mmap_twdb_bonusjobs>input[type="checkbox"]{margin-left:6px;cursor:pointer}div#mmap_twdb_bonusjobs>div{position:relative;display:inline-block;height:9px;width:9px;margin:1px}div#mmap_twdb_bonusjobs>img{margin-left:3px;cursor:pointer;position:relative;display:inline-block;height:16px;width:16px;top:-4px}',"minimap");const p=function(){const c=e('<div id="mmap_twdb_bonusjobs" />').append(e(`<input title="${Language._("jobs.show_gold_jobs")}" type="checkbox" ${o.gold?'checked="checked"':""} />`).change(function(){o.gold=e(this).is(":checked"),i()})).append(`<div title="${Language._("jobs.gold_jobs")}" style="background-color:yellow; border:1px solid red;" />`).append(e(`<input title="${Language._("jobs.show_silver_jobs")}" type="checkbox" ${o.silver?'checked="checked"':""}" />`).change(function(){o.silver=e(this).is(":checked"),i()})).append(`<div title="${Language._("jobs.silver_jobs")}" style="background-color:white; border:1px solid black;" />`).append(e(`<img title="${Language._("jobs.export_jobs_bonus")}" src="${Images.iconExport}" />`).click(function(){l()})).append(e(`<img title="${Language._("jobs.import_jobs_bonus")}" src="${Images.iconImport}" />`).click(function(){v()})).append(e(`<img title="${Language._("jobs.reset_jobs_bonus")}" src="${Images.iconReset2}" />`).click(function(){d()}));e(MinimapWindow.window.divMain).find(".minimap-right").append(c),i()};GameInject.injectMinimap(function(){p()})}catch(p){ErrorModule.report(p,Language._("errors.bonusjobs_render_markers"))}},i=function(){try{Cache.save("bonusdisplay",o),e("#minimap_worldmap > div.TWDBbonusjob",MinimapWindow.window.divMain).remove();const p=function(b,u,g,h,_){let T="";h>1&&(T="-moz-transform:rotate(45deg);-webkit-transform:rotate(45deg);-o-transform:rotate(45deg);-ms-transform:rotate(45deg);transform:rotate(45deg);");const C=e(`<div class="TWDBbonusjob" style="z-index:7;position:absolute;display:block;width:4px;height:4px;background-color:${g?"yellow":"white"};left:${parseInt(b*.00513,10)-3}px;top:${parseInt(u*.00513,10)+2}px;${T}border:1px solid ${g?"red":"black"};" />`).click((function(f,L){return function(){window.GameMap.center(f,L)}})(b,u)).addMousePopup(`<div style="min-width:60px;text-align:center">${_.join('<div class="marker_popup_divider"></div>')}</div>`);e(MinimapWindow.window.divMain).find("#minimap_worldmap").append(C)},c=t;for(const b in c){if(!Object.hasOwn(c,b))continue;const u=c[b];let g=!1,h=0;const _=[];for(const k in u)if(Object.hasOwn(u,k)){if(u[k].gold){if(!o.gold)continue;g=!0,h++}if(u[k].silver){if(!o.silver)continue;h++}_.push(Jobs.getPopup(u[k].job_id,u[k].gold?"gold":"silver"))}if(h>0){const k=u[Object.keys(u)[0]];p(k.x,k.y,g,h,_)}}}catch(p){ErrorModule.report(p,Language._("errors.bonusjobs_save_display_settings"))}},l=function(){try{const p=[];for(const _ in t){if(!Object.hasOwn(t,_))continue;const k=t[_];for(const T in k){if(!Object.hasOwn(k,T))continue;const C=Jobs.getJobById(T),f=Math.ceil(k[T].x/6635)+(k[T].y>10176?7:0);p.push({name:C.name,bonus:k[T].gold?"gold":"silver",country:f,x:k[T].x,y:k[T].y,id:T})}}const c=e("<textarea />").css({width:"500px",height:"200px","background-color":"transparent","border-width":"0px"}).click(function(){this.select()});let b="",u=1;const g=function(_){b!==_?(b=_,u=1):u*=-1,p.sort(function(C,f){return C[b]>f[b]?u:-1*u});let k="",T="";for(let C=0;C<p.length;C++){const f=p[C];b==="country"&&T!==f.country&&(T=f.country,k+=`-- ${Language._("misc.country")} ${T} -- <br />`),k+=`${f.name}; ${f.bonus}; ${f.x}-${f.y}; ${f.id}<br />`}c.val(k)};g("name");const h=e("<div />").css({width:"500px",height:"22px",position:"relative",display:"block"}).append(e(`<img src="${Images.iconName}" title="${Language._("misc.sort_by_name")}" style="margin:0px 2px 0px 2px;cursor:pointer;" /> `).click(function(){g("name")})).append(e(`<img src="${Images.iconCount}" title="${Language._("misc.sort_by_county")}" style="margin:0px 2px 0px 2px;cursor:pointer;" /> `).click(function(){g("country")}));new west.gui.Dialog(Language._("jobs.export_jobs_bonus"),e("<div />").append(h).append(c)).addButton(Language._("common.ok")).show()}catch(p){ErrorModule.report(p,Language._("errors.bonusjobs_export"))}},v=function(){try{const p=e("<textarea />").css({width:"400px",height:"100px"}),c=function(){const b=p.val().split(/[\n,\r,\r\n]/);let u,g,h,_,k,T;for(u=0;u<b.length;u++)g=b[u].split(";",4),g.length===4&&e.isNumeric(g[3])&&Jobs.getJobById(+g[3])&&(h=(g[2]+"").split("-",2),h.length===2&&e.isNumeric(h[0])&&e.isNumeric(h[1])&&(_=+g[3],k={gold:e.trim(g[1])==="gold",group_id:Jobs.getJobById(_).groupid,job_id:_,silver:e.trim(g[1])!=="gold",x:+h[0],y:+h[1],time:Date.now()},T=`${+h[0]}-${+h[1]}`,isDefined(t[T])||(t[T]={}),t[T][_]=k));Cache.save("bonusjobs",t),i()};new west.gui.Dialog(Language._("jobs.import_jobs_bonus"),p).addButton(Language._("common.ok"),c).addButton(Language._("common.cancel")).show()}catch(p){ErrorModule.report(p,Language._("errors.bonusjobs_import"))}},d=function(p){try{if(p){for(const c in t){if(!Object.hasOwn(t,c))continue;const b=t[c];let u=0;for(const g in b)Object.hasOwn(b,g)&&(p==="gold"&&b[g].gold||p==="silver"&&b[g].silver?u++:delete b[g]);u===0&&delete t[c]}Cache.save("bonusjobs",t),i(),new UserMessage(Language._("jobs.reset_jobs_bonus"),UserMessage.TYPE_SUCCESS).show()}else{const c=Language._("jobs.reset_jobs_bonus"),b=`<div class="txcenter">${Language._("jobs.reset_jobs_bonus_confirm")}</div>`;new west.gui.Dialog(c,b,west.gui.Dialog.SYS_QUESTION).addButton(Language._("jobs.reset_all_jobs_bonus"),function(){d("all")}).addButton(Language._("jobs.reset_silver_jobs_bonus"),function(){d("silver")}).addButton(Language._("jobs.reset_gold_jobs_bonus"),function(){d("gold")}).addButton(Language._("common.cancel")).show()}}catch(c){ErrorModule.report(c,Language._("errors.bonusjobs_reset"))}};return{}})($);Debugger.BonusJobs=BonusJobs;const Chat=(function(e){const t={":/":"sore","=:)":"invader",">:(":"angry",":'(":"cry",":)":"smile",":D":"grin",":(":"frown",";)":"smirk",":P":"tongue",":o":"ohmy",":x":"muted",":|":"silent",">.<":"palm","-.-":"nc","o.O":"oo","O.o":"oo","^_^":"happy",o_O:"oo","x.x":"xx","T.T":"cry","el pollo diablo!":"elpollodiablo","!el pollo diablo":"elpollodiablo_mirror","el pollo diablo?!":"elpollodiablo_front","add me":"sheep.gif","add me!":"sheep_rainbow.gif"};let n=[],o={};o=Loader.add("Chat","tw-db Chat Enhancement",function(){if(!o.ready)try{if(Settings.get("chat",!0)){GameInject.ChatLayout(function(g){r(g)}),GameInject.ChatSend(function(g){a(g)});let u=Cache.load("chathistory");typeof u=="object"&&u!==null&&(u.color&&(u=u.color,Cache.save("chathistory",u)),n=u),$("div.tw2gui_window.chat.nominimize div.tw2gui_window_buttons_close").click().length>0&&ChatWindow.open()}o.ready=!0}catch(u){ErrorModule.report(u,Language._("errors.chat_initialize"))}},{Settings:!0,Cache:!0});const a=function(u){try{let g=u.input.val();if(!g)return;const h=function(_){return u.u&&(_=_.toUpperCase()),u.p&&(_=`*${_=_.replace(/\*/g,"~")}*`),_};if(g.substr(0,1)==="/"){const _=/^\/(tell|msg)\s+([^:]+):(.+)$/,k=g.match(_);return k&&(g=u._?`/tell ${k[2]}:/${u._}${h(k[3])}`:`/tell ${k[2]}:${h(k[3])}`),u.input.val(g),void 0}return g=h(g),u._&&(g=`/${u._}${g}`),u.input.val(g),void 0}catch(g){ErrorModule.report(g,Language._("errors.chat_process_send"))}},r=function(u){try{u.mainDiv.find(".TWDBchat").length===0&&(u.mainDiv.find(".chat_input").find(".cbg").css("left","38px").addClass(".TWDBchat"),u._=null,u.p=!1,u.u=!1,i(u),c(u))}catch(g){ErrorModule.report(g,Language._("errors.chat_process_layout"))}},i=function(u){try{let g;const h=e('<span style="padding:3px;display:none;width:160px;position:absolute;bottom:20px;left:-3px;" />');for(const k in t)g=t[k].indexOf(".gif")===-1?t[k]+".png":t[k],h.append(e(`<img src="${Game.cdnURL}/images/chat/emoticons/${g}?1" title="${k}" style="cursor:pointer;margin:1px;" />`).click((function(T){return function(){u.input.val(`${u.input.val()} ${T} `),u.input.focus(),h.hide()}})(k)));let _=!1;u.mainDiv.find(".chat_input").append(e('<div style="position:absolute;width:15px;height:15px;bottom:7px;vertical-align:top;left:23px;cursor:pointer;" />').append(e(`<img style="vertical-align:top;" src="${Images.iconChatSM}" />`)).append(h).on("mouseenter",function(){_=!0,h.show()}).on("mouseleave",function(){_=!1,setTimeout(function(){_||h.hide()},200)}))}catch(g){ErrorModule.report(g,Language._("errors.chat_render_emoticon_picker"))}},l=function(u){try{const g=u.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return g?parseInt(9*g[1]/255+.5,10)+""+parseInt(9*g[2]/255+.5,10)+parseInt(9*g[3]/255+.5,10):"000"}catch(g){return ErrorModule.report(g,Language._("errors.chat_convert_rgb_to_game_color")),"000"}},v=function(u){try{return`rgb(${parseInt(255*u[0]/9,10)},${parseInt(255*u[1]/9,10)},${parseInt(255*u[2]/9,10)})`}catch(g){return ErrorModule.report(g,Language._("errors.chat_convert_game_color_to_rgb")),"rgb(0,0,0)"}},d=function(u,g){try{if(isDefined(g.color)){const h=l(g.color),_=n.length;for(let k=0;_>k;k++){const T=n.shift();T!==h&&n.push(T)}n.push(h),n.length>5&&n.shift(),Cache.save("chathistory",n),u._=h}g.color===null&&(u._=null),isDefined(g.bold)&&(u.p=g.bold),isDefined(g.caps)&&(u.u=g.caps),u.p?u.mainDiv.find(".TWDBtext").css("font-weight","bold"):u.mainDiv.find(".TWDBtext").css("font-weight","normal"),u.u?u.mainDiv.find(".TWDBtext").html("A"):u.mainDiv.find(".TWDBtext").html("a"),u._?(u.mainDiv.find(".TWDBcolor").children("div").children("div").css("background-color",v(u._)),4>u._[1]?u.mainDiv.find(".TWDBtext").css("color","#fff"):u.mainDiv.find(".TWDBtext").css("color","#000")):(u.mainDiv.find(".TWDBcolor").children("div").children("div").css("background-color","#e0e2e0"),u.mainDiv.find(".TWDBtext").css("color","#000")),u.input.focus()}catch(h){ErrorModule.report(h,Language._("errors.chat_apply_formatting"))}},p=function(u){try{const g=e('<div style="position:absolute;display:block;width:15px;height:15px;"></div>'),h=[{w:15,h:1,t:7,l:0,o:.1},{w:1,h:15,t:0,l:7,o:.1},{w:15,h:3,t:6,l:0,o:.33},{w:3,h:15,t:0,l:6,o:.33},{w:15,h:5,t:5,l:0,o:.47},{w:5,h:15,t:0,l:5,o:.47},{w:13,h:9,t:3,l:1,o:.6},{w:9,h:13,t:1,l:3,o:.6},{w:11,h:11,t:2,l:2,o:.8},{w:13,h:7,t:4,l:1},{w:7,h:13,t:1,l:4},{w:9,h:11,t:2,l:3},{w:11,h:9,t:3,l:2}];for(let _=0;_<h.length;_++){const k=h[_],T=`position:absolute; width:${k.w}px; height:${k.h}px; top:${k.t}px; left:${k.l}px; background-color:${u};${k.o!=null?`opacity:${k.o};`:""}`;g.append(e(`<div style="${T}"></div>`))}return g}catch(g){return ErrorModule.report(g,Language._("errors.chat_create_color_picker_layer")),e()}},c=function(u){try{let T=function(W,P){W.css("opacity",P?1:.5)},C=function(W,P){return e('<div style="display:inline-block;width:15px;height:15px;padding:2px;opacity:0.5;"/>').append(p("#e0e2e0")).append(e(`<div style="position:absolute;width:15px;height:15px;"><table border="0" cellspacing="0" cellpadding="0" style="padding:0;margin:0;border:0;"><tr><td style="display:block;width:15px;height:15px;text-align:center;font-size:11px;color:#000;${P==="bold"?"font-weight:bold;":""}">${W}</td></tr></table></div>`)).click(function(){const B=!u.format[P];u.format[P]=B,d(u,{[P]:B}),T(e(this),B),L.hide()})},f=function(W){return e('<div style="display:inline-block;width:15px;height:15px;padding:2px;"/>').append(p(W)).click(function(){d(u,{color:e(this).children("div").children("div").css("background-color")}),L.hide()})};var g=T,h=C,_=f;const k=["black","red","blue","yellow","green","brown","magenta","gray"];u.format=u.format||{};const L=e('<span style="position:absolute;display:none;padding:3px;width:300px;bottom:17px;left:-5px;" />');L.append('<div style="position:absolute;height:50px;width:25px;display:block" />');const D=C("a","bold"),E=C("A","caps");L.append(D),L.append(E);for(let W=0;W<k.length;W++)L.append(f(k[W]));L.append(e(`<div style="margin:2px;display:inline-block;width:15px;height:15px;background:url(${Images.iconChatNoColor}) no-repeat 0 0 transparent;" />`).click(function(){d(u,{color:null}),u.format.bold=!1,u.format.caps=!1,d(u,{bold:!1,caps:!1}),T(D,!1),T(E,!1),L.hide()})),L.append(e(`<div style="margin:3px;display:inline-block;width:13px;height:13px;background:url(${Images.iconChat}) no-repeat 0 0 transparent;" />`).click(function(){b(u),L.hide()}));let O=!1;u.mainDiv.find(".chat_input").append(e('<div class="TWDBcolor" style="position:absolute;width:15px;height:15px;bottom:7px;left:5px;cursor:pointer;" />').append(p("#e0e2e0")).append(e('<div style="position:absolute;width:15px;height:15px;"><table border="0" cellspacing="0" cellpadding="0" style="padding:0;margin:0;border:0;"><tr><td class="TWDBtext" style="display:block;width:15px;height:15px;text-align:center;font-size:11px;color:#000;">a</td></tr></table></div>')).append(L).on("mouseenter",function(){O=!0,T(D,!!u.format.bold),T(E,!!u.format.caps),L.show()}).on("mouseleave",function(){O=!1,setTimeout(function(){O||L.hide()},200)}))}catch(k){ErrorModule.report(k,Language._("errors.chat_render_color_picker"))}},b=function(u){try{const g=u.mainDiv.find(".TWDBcolor").children("div").children("div");let h=l(g.css("background-color"));const _={};_.customColor=e('<div style="width:50px;height:50px;display:inline-block;vertical-align:top;margin: 5px;" />'),_.customColor.css("background-color",v(l(g.css("background-color"))));const k=(W,P)=>{if(P&&h[W]===9||!P&&h[W]===0)return;const B=[+h[0],+h[1],+h[2]];B[W]+=P?1:-1,h=B[0]+""+B[1]+B[2],_.input.val(h),_.plusminus[W].children(".butMinus").css("opacity",h[W]===0?.3:1),_.plusminus[W].children(".butPlus").css("opacity",h[W]===9?.3:1),_.customColor.css("background-color",v(h))},T=e('<div style="width:42px;height:48px;display:inline-block;vertical-align:top;margin: 6px 5px 6px 5px;" />');_.plusminus=[];for(let W=0;3>W;W++){let P;switch(W){case 0:P="#f00";break;case 1:P="#0f0";break;case 2:P="#00f"}_.plusminus[W]=e(`<div class="tw2gui_plusminus" style="display:inline-block;background-color:${P};width:12px;height:46px;padding:1px;"><span class="butPlus" style="cursor:pointer;"></span><span style="width:12px;height:10px;display:inline-block;"></span><span class="butMinus" style="cursor:pointer;"></span></div>`),_.plusminus[W].children(".butMinus").click((B=>()=>k(B,!1))(W)),_.plusminus[W].children(".butPlus").click((B=>()=>k(B,!0))(W)),h[W]===0&&_.plusminus[W].children(".butMinus").css("opacity",.3),h[W]===9&&_.plusminus[W].children(".butPlus").css("opacity",.3),T.append(_.plusminus[W])}_.input=e(`<input maxLength="3" type="text" value="${h}" style="position: relative; top: -35px; left: 2px;color: rgb(255, 255, 255); font-weight: bold; letter-spacing: 6px; text-shadow: 1px 1px 1px rgb(0, 0, 0); width: 43px; background: none repeat scroll 0pt 0pt transparent; border: medium none; height: 18px; line-height: 18px; margin: 0pt; outline: medium none;" />`),_.input.keyup(()=>{const W=_.input.val();if(3>W.length||!W.match(/(\d){3}/))return _.input.val(h),void 0;h=W;for(let P=0;3>P;P++)_.plusminus[P].children(".butMinus").css("opacity",h[P]===0?.3:1),_.plusminus[P].children(".butPlus").css("opacity",h[P]===9?.3:1);_.customColor.css("background-color",v(h)),_.input.attr("value",h)}),T.append(_.input);const C={bold:u.p,caps:u.u},f=e('<div style="height:50px;display:inline-block;vertical-align:top;margin: 5px;" />'),L=new west.gui.Checkbox(`*${Language._("misc.color_dialog_bold")}*`,C.bold?"tw2gui_checkbox_checked":"",()=>{C.bold=!C.bold});e(L.getMainDiv()).css("display","block").css("margin-bottom","5px"),f.append(L.getMainDiv());const D=new west.gui.Checkbox(Language._("misc.color_dialog_caps"),C.caps?"tw2gui_checkbox_checked":"",()=>{C.caps=!C.caps});f.append(D.getMainDiv());const E=e('<div style="width:160px;height:50px;display:inline-block;vertical-align:top;border: 1px solid #000;padding: 0px;margin: 5px;" />');E.append(`<span style="width:140px;height:15px;display:inline-block;text-align:center;padding: 4px 0px 2px 0px;font-size:11px;">${Language._("misc.color_dialog_history")}</span>`);for(let W=0;W<n.length;W++){const P=e(`<div style="width:20px;height:20px;display:inline-block;vertical-align:top;margin: 0px 0px 0px 10px;cursor:pointer;background-color:${v(n[W])};" />`);P.click(function(){d(u,{color:e(this).css("background-color"),bold:C.bold,caps:C.caps}),_.colorBox.hide()}),E.append(P)}const O=e("<div />").append(_.customColor).append(T).append(f).append(E);_.colorBox=new west.gui.Dialog(Language._("misc.color_dialog_title"),O),_.colorBox.addButton(Language._("common.ok"),()=>{d(u,{color:e(_.customColor).css("background-color"),bold:C.bold,caps:C.caps})}),_.colorBox.addButton(Language._("common.cancel")),_.colorBox.show()}catch(g){ErrorModule.report(g,Language._("errors.chat_open_color_picker_dialog"))}};return{}})(jQuery);Debugger.Chat=Chat;const Collector=(function(e){const t={};let n={};n=Loader.add("Collector","tw-db Collector",function(){if(!n.ready)try{Settings.get("collector",!0)&&(GameInject.injectItem("Trader","collector",function(r){return o(r)}),GameInject.injectTrader("collector",function(r){return t.isNewItem(r.item_id)?`<img src="${Images.iconNew}" class="TWDBcollector" title="${Language._("collector.item_not_owned")}" style="position:absolute;top:0;left:0;padding:0;border:0;margin:0" />`:""}),GameInject.injectMarket("collector",function(r){return a(r)}),GameInject.injectGetBids()),n.ready=!0}catch(r){ErrorModule.report(r,Language._("errors.collector_initialize"))}},{Settings:!0}),t.isNewItem=function(r){try{const i=w.ItemManager.get(r),l=w.Bag.getItemsIdsByBaseItemId(i.item_base_id),v=w.Wear.wear[i.type],d=v&&v.obj.item_base_id===i.item_base_id,p=TWDB.ClothCalc.bids[i.item_id],c=TWDB.ClothCalc.recipes[i.item_id];return!(l.length||d||p||c)}catch(i){return ErrorModule.report(i,Language._("errors.collector_check_new_item")),!1}};const o=function(r){try{if(r.divMain.find(".TWDBcollector").remove(),t.isNewItem(r.obj.item_id)){if(!Images.iconNew)return waitForImages("iconNew",function(){o(r)}),void 0;r.divMain.append(`<img src="${Images.iconNew}" class="TWDBcollector" title="${Language._("collector.item_not_owned")}" style="position:absolute;top:-8px;left:-15px;padding:0;border:0;margin:0" />`)}}catch(i){ErrorModule.report(i,Language._("errors.collector_update_item_display"))}},a=function(r){try{return t.isNewItem(r)?`<img src="${Images.iconNew}" class="TWDBcollector" title="${Language._("collector.item_not_owned")}" style="width:18px;height:18px;position:relative;top:0;left:0;padding:0;border:0;margin:0" />`:""}catch(i){return ErrorModule.report(i,Language._("errors.collector_get_market_icon")),""}};return t})();Debugger.Collector=Collector;const Snippets=(function($){const _self={},_timeout=null,_interval=null;let loader={};const initializeSnippets=function(){if(!loader.ready)try{trustTWDB(),Settings.get("translation_texts",!0)&&localizeSearchPlaceholders(),Settings.get("button_church",!0)&&GameInject.MenuButton(TWDB.images.buttonChurch,Language._("misc.button_church_title"),addConstructionButton),Settings.get("button_market",!1)&&GameInject.MenuButton(TWDB.images.buttonMarket,Language._("misc.button_market_title"),addMarketButton),Settings.get("wear_close",!0)&&addCloseAllWearButton(),Settings.get("collector_sell",!0)&&GameInject.injectWanderingTraderSellDialog(),Settings.get("custom_event_counter",!0)&&repositionEventCounters(),Settings.get("scrollbars_off",!1)&&disableScrollbars(),Settings.get("building_progress",!0)&&townBuildingProgress(),Settings.get("church_levels",!0)&&addChurchLevels(),Settings.get("improved_ch_tab",!0)&&improvedCityhallTab(),Settings.get("fort_recruitment",!0)&&activateFortRecruitment(),Settings.get("work_queue_off",!0)&&removeWorkQueuePA(),Settings.get("fetch_all_off",!1)&&removeVariousPA(),Settings.get("wof_nuggets_off",!1)&&changeWofNuggets(),Settings.get("market_sell_dialog",!0)&&enhanceMarketSellDialog(),Settings.get("weekly_crafting",!0)&&weeklyCrafting(),Settings.get("pin_items",!0)&&(GameInject.injectInventoryAddItemsPinItems(),GameInject.injectInventoryAddItemDivToInvPinItems()),Settings.get("telegram_bb_codes",!0)&&GameInject.injectTelegramWindowAppendTelegramDisplaySource(),Settings.get("no_shop_sale",!1)&&suppressOnGoingEntries(),Settings.get("exp_bar",!0)&&expBarValues(),Settings.get("mini_chat",!1)&&allowChatGuiMinimize(),Settings.get("task_list_points",!0)&&(addTaskJobsHints(),GameInject.injectTaskJobs()),Settings.get("town_forum_blink",!1)&&removeForumBlink(),Settings.get("enhanced_rankings",!0)&&addEnhancedRankings(),Settings.get("profile_duel_exp",!1)&&addDuelXpInProfiles(),Settings.get("regen_timers",!0)&&addRegenTimers(),Settings.get("forum_select",!0)&&selectForumText(),Settings.get("pin_important",!0)&&TWDB.Util.addCss("#ui_bottombar, #ui_menubar, #ui_experience_bar {z-index: 20!important;}"),Settings.get("fortbattle_reminder",!1)&&TWDB.Util.addCss(".fort_battle_notification {display:none!important;}"),Settings.get("night_mode",!1)&&addNightMode(),Settings.get("blink_events",!1)&&removeBlinkingEvents(),Settings.get("market_report",!0)&&(TWDB.Util.addCss(".mpb_pickup, .wih_pickup {padding-left: 0!important; width: 65px!important; margin-left: -10px!important;}"),reworkMarketReport()),Settings.get("improved_market",!1)&&improvedMarket(),Settings.get("job_show_lp",!0)&&jobWindowLP(),Settings.get("whisper_improved",!0)&&improvedWhisper(),Settings.get("instant_quest",!1)&&addInstantQuests(),Settings.get("colored_quest",!1)&&addColoredQuests(),Settings.get("import_westforts",!0)&&importWestForts(),new ServerDate().date,loader.ready=!0}catch(e){ErrorModule.report(e,Language._("errors.snippets_initialize"))}};loader=Loader.add("Snippets","tw-db code Snippets",initializeSnippets,{Settings:!0});const trustTWDB=function(){try{let str=showlink.toString();str=str.replace("the-west","tw-db|the-west"),str=str.replace("|com|","|com|info|"),eval("showlink = "+str)}catch(e){ErrorModule.report(e,Language._("errors.inject_showlink"))}},addCloseAllWearButton=function(){const e=()=>{if(!Inventory?.window?.divMain)return;const t=$(".tw2gui_window_buttons",Inventory.window.divMain);if(!t.length||t.find(".game_ext_close_all_button").length)return;const n=$(`<div class="tw2gui_window_buttons_closeall game_ext_close_all_button" title="<b>${Language._("misc.wear_close_tooltip")}</b>"></div>`);n.on("click",()=>{Inventory.window?.destroy?.(),Inventory.dockedWindow?.destroy?.(),document.querySelectorAll(".tw2gui_window.wear").forEach(o=>{o.querySelector(".tw2gui_window_buttons_close")?.click()||o.querySelector(".tw2gui_window_buttons_closeall")?.click()||o.m?.destroy?.()||o.remove()}),document.querySelector(".button.inventory.active")?.classList.remove("active")}),t.append(n)};if(e(),typeof Inventory<"u"&&Inventory.open){const t=Inventory.open;Inventory.open=function(...n){const o=t.apply(this,n);setTimeout(()=>{e()},100);let a=0;const r=setInterval(()=>{a++,e(),5>a&&!Inventory?.window?.divMain||clearInterval(r)},200);return o}}document.addEventListener("click",function(t){if(t.target?.closest?.(".button.inventory")){setTimeout(()=>{e()},100);let o=0;const a=setInterval(()=>{o++,e(),5>o&&!Inventory?.window?.divMain||clearInterval(a)},200)}},!0)},addConstructionButton=function(){const e=`build-${Character.homeTown.x}-${Character.homeTown.y}-church`;document.querySelectorAll("."+e).forEach(t=>{const n=t.querySelector(".tw2gui_window_buttons_close");return n?(n.click(),void 0):t.m&&typeof t.m.destroy=="function"?(t.m.destroy(),void 0):(t.parentNode?.removeChild(t),void 0)}),setTimeout(()=>{BuildWindow&&typeof BuildWindow.open=="function"&&BuildWindow.open(Character.homeTown.town_id,Character.homeTown.x,Character.homeTown.y,"church",!1)},50)},addMarketButton=function(){Character.homeTown.town_id?Ajax.remoteCallMode("town","get_town",{x:Character.homeTown.x,y:Character.homeTown.y},function(e){if(e.error)return new UserMessage(e.msg).show();MarketWindow.open(Character.homeTown.town_id,e.allBuildings.market.stage,MarketWindow.townName),Wear?.window&&(Wear.window.divMain.style.display="none")}):(MarketWindow.open(),new UserMessage(Language._("errors.not_town_member"),UserMessage.TYPE_ERROR).show())},repositionEventCounters=function(){TWDB.Util.addCss("@media (min-width: 1320px) { .custom_unit_counter {top: -1px!important; margin-left: 310px!important;} #hiro_friends_container {top: -1px!important; margin-right: 304px!important;} }")},localizeSearchPlaceholders=function(){function e(){document.querySelectorAll('input[placeholder="Search"]').forEach(t=>{t.placeholder==="Search"&&(function(n){n.placeholder=Language._("common.search")})(t)})}if(!localizeSearchPlaceholders.v){if(localizeSearchPlaceholders.v=!0,e(),typeof west<"u"&&west.window&&west.window.shop&&west.window.shop.open&&!west.window.shop.open.k){const t=west.window.shop.open,n=function(...o){const a=t.apply(this,o);setTimeout(()=>{e()},100);let r=0;const i=setInterval(()=>{r++,e(),5>r||clearInterval(i)},200);return a};n.k=!0,n.L=t,west.window.shop.open=n}localizeSearchPlaceholders.M||(localizeSearchPlaceholders.M=function(t){const n=t.target;n?.closest&&(n.closest(".button.shop")||n.closest(".search_button")||n.closest('[onclick*="shop"]')||n.closest('[onclick*="trader"]')||n.closest('[href*="shop_trader"]'))&&setTimeout(()=>{e()},100)},document.addEventListener("click",localizeSearchPlaceholders.M,!0))}},disableScrollbars=function(){$("body").css({overflow:"hidden"})},addChurchLevels=function(){BuildWindow.updateLaborPoints_backup=BuildWindow.updateLaborPoints,BuildWindow.updateLaborPoints=function(e){if(BuildWindow.updateLaborPoints_backup.call(this,e),this.building==="church"&&e>0){const t=Math.floor(this.window.$("div.build_progress_nfo > span.text_bold").text()/15);this.window.$("div.build_progress_nfo").append(` (${0>t?"":"+"}${t} ${Language._("building.church_levels")})`)}}},townBuildingProgress=function(){BuildWindow.initInfo_backup=BuildWindow.initInfo,BuildWindow.initInfo=function(e){BuildWindow.initInfo_backup.call(this,e);const t=$(`<div class="rp_row_jobdata row_build_hammer" style="margin:-2px 0 ${$(".twir_bestwear").length?"-24px":"0"} 0;" title="${Language._("building.progress_label")}:&nbsp;${Language._("building.progress_tooltip")}"><span class="rp_jobdata_label_icon"><img src="${Game.cdnURL}/images/icons/hammer.png" alt="" /></span><span class="rp_jobdata_label text_bold">${Language._("building.progress_label")}</span><span class="rp_jobdata_text text_bold"></span></div>`);$("span.rp_jobdata_text",t).append(new west.gui.Progressbar(e.build_point,e.build_point_limit).getMainDiv()),$(`.build-${e.x}-${e.y}-${e.build_key} div.build_info`).append(t)}},improvedCityhallTab=function(){CityhallWindow.Build.fillContent_backup=CityhallWindow.Build.fillContent,CityhallWindow.Build.fillContent=function(e){this.table.clearBody();for(let t=0;t<e.length;t++){const n=e[t];let o;this.main.ownTown?(n.stage!==n.maxStage||n.infinite)&&(this.table.appendRow(),o=`<a href="#" onClick="javascript:void(BuildWindow.open(${Character.homeTown.town_id}, ${Character.homeTown.x}, ${Character.homeTown.y}, '${n.key}', false));">${n.name}</a></span>`,this.table.appendToCell(-1,"building",o).appendToCell(-1,"stage",`${n.stage} / ${n.infinite?`<img src='${Game.cdnURL}/images/xp_inf_000.png' style='padding-bottom: 4px;'/>`:n.maxStage}`).appendToCell(-1,"progress",new west.gui.Progressbar(n.buildPoints,n.nextStagePoints).getMainDiv())):(this.table.appendRow(),o=n.name,this.table.appendToCell(-1,"building_foreign",o).appendToCell(-1,"stage",`${n.stage} / ${n.infinite?`<img src='${Game.cdnURL}/images/xp_inf_000.png' style='padding-bottom: 4px;'/>`:n.maxStage}`))}}},allowChatGuiMinimize=function(){TWDB.Util.addCss(`div#ui_bottomleft{width:auto;overflow:hidden}div#ui_chat{margin-top:12px}div#ui_chat div#toggleMinChat{position:absolute;top:-14px;left:5px;width:27px;display:block;background-size:108px 42px;border:0 solid rgba(0,0,0,0);background-clip:content-box}div#ui_chat.minchat div#toggleMinChat{background-position:0 0;border-width:0 8px 34px 0}div#ui_chat.minchat div#servertime{display:none}div#ui_chat.minchat>div.tabs div{display:none}div#ui_chat.minchat div.container div.friend{display:none!important}div#ui_chat.minchat div.container div.general{display:block!important}div#ui_chat.minchat div.container div.vertical_divider{display:none}div#ui_chat.minchat img.leave_channel{display:none!important}div#ui_chat div.minchat_tabr{display:none}div#ui_chat.minchat div.minchat_tabr{display:block;position:absolute;left:32px;top:0;width:8px;height:34px;background:url("${to_cdn("images/interface/chat/chat-top.png?1")}") top right}div#ui_chat.minchat{position:relative;left:-10px;top:4px;width:39px}div#ui_chat.minchat>div.tabs{width:32px;background:url("${to_cdn("images/interface/chat/chat-top.png?1")}")}div#ui_chat.minchat div.chat_channel{width:24px}div#ui_chat.minchat div.chat_channel .new_message{left:2px;top:0}div#ui_chat.minchat div.chat_channel div.online_count{background:none;position:absolute;right:0;top:-1px;width:auto;height:auto;line-height:normal;padding:0;font-size:8pt;font-weight:bold;text-align:right;text-shadow:-1px 1px 1px #FFF,0 0 2px #FFF;cursor:default}div#ui_chat.minchat div.container{width:40px;background-position-x:right}div#ui_chat.minchat div.row_title{left:5px;width:32px;opacity:0}div#ui_chat.minchat div.tw2gui_scrollpane{width:50px}`,"minchat"),$("div#ui_chat").append('<div class="minchat_tabr" />').toggleClass("minchat",Settings.get("mini_chat_min",!0)).children(".tabs").first().append($('<div id="toggleMinChat" class="tw2gui_arrow_up_top" />').on("click",function(e){return e.stopPropagation(),Settings.set("mini_chat_min",$("div#ui_chat").toggleClass("minchat").hasClass("minchat")),!1}))},addTaskJobsHints=function(){try{TWDB.Util.addCss("div#ui_workcontainer div.twdb_lp_hint{position:absolute;left:2px;width:18px;height:18px;background-color:#432;border:2px ridge #976;border-radius:11px;background-blend-mode:soft-light}div.twdb_lp_hint>img{position:absolute;left:1px;top:1px}");const e=function(){if(TaskQueue.queue.length){let t;const n=$("div#ui_workcontainer");let o,a;for(t=0;t<TaskQueue.queue.length;t++)TaskQueue.queue[t].type==="job"&&(o=null,a=TWDB.ClothCalc.calcdata.loaded&&TaskQueue.queue[t].data.job_points<TWDB.ClothCalc.calcdata.jobs[TaskQueue.queue[t].data.job.id].laborpoints.sum-5,0>TaskQueue.queue[t].data.job_points?o=west.gui.Icon.get("exclamation-priority-3",Language._("task.queue_negative_lp")):TaskQueue.queue[t].data.job_points<TaskQueue.queue[t].data.job.malus/5?o=west.gui.Icon.get("exclamation-priority-2",Language._("task.queue_low_lp")):a&&(o=west.gui.Icon.get("exclamation-priority-1",Language._("task.queue_suboptimal_lp"))),o!==null&&$(`.task-queuePos-${t} > div.icon`,n).children(".twdb_lp_hint").remove().end().append($('<div class="twdb_lp_hint" />').toggleClass("tw2gui-iconset tw2gui-icon-star",!a).append(o)))}};EventHandler.listen(["taskqueue-updated","taskqueue-ready"],e)}catch(e){ErrorModule.report(e,Language._("errors.ui_task_queue_hints"))}},expBarValues=()=>{TWDB.Util.addCss("div#ui_experience_bar .label {text-shadow: 3px 1px 1px #000,3px -1px 1px #000,-2px 1px 1px #000,-2px 0px 0px #000;}");const e=n=>{const o=Math.abs(n);return 1e6>o?1e3>o?n.toString():(n/1e3).toFixed(1)+"k":(n/1e6).toFixed(2)+"m"},t=()=>{const n=$("#ui_experience_bar"),o=Character.getTrackingAchievement()===void 0?WestUi.updateTrackXp(n):WestUi.updateTrackAchievement(n);$(".label",n).off("mouseenter mouseleave"),$(".label span",n).show();const a=250>Character.level?`${o.percent}% - ${e(o.current)} / ${e(o.required)} (${e(o.required-o.current)})`:Character.experience.toLocaleString();$(".label span",n).html(a)};EventHandler.listen("character_exp_changed",t),EventHandler.listen("character_tracking_achievement_changed",t),t()},suppressOnGoingEntries=function(){try{const e=["shop_sale"],t=function(n){if($.isArray(n))for(let o=0;o<n.length;o++)t(n[o]);else if(typeof n=="string"){const o=WestUi.NotiBar.main.list;for(let a=0;a<o.length;a++)$(o[a].element).children().is("div.image."+n)&&WestUi.NotiBar.remove(o[a])}};(function(n){try{WestUi.NotiBar.__twdb__add=WestUi.NotiBar.__twdb__add||WestUi.NotiBar.add,WestUi.NotiBar.add=function(o,...a){const r=$(".image",o.element);for(let i=0;i<n.length;i++)if(r.hasClass(n[i]))return;WestUi.NotiBar.__twdb__add.call(this,o,...a)}}catch(o){ErrorModule.report(o,Language._("errors.ui_manipulate_notification_bar"))}})(e),t(e)}catch(e){ErrorModule.report(e,Language._("errors.ui_suppress_notifications"))}},removeWorkQueuePA=function(){try{TWDB.Util.addCss("#queuedTasks .buyPremiumTask {background: none!important}"),Premium.checkForAutomationPremium=function(e,t){if(t!==void 0)return t()}}catch(e){ErrorModule.report(e,Language._("errors.ui_remove_work_queue_pa"))}},changeWofNuggets=function(){try{west.gui.payHandler.prototype.W=west.gui.payHandler.prototype.addPayOption,west.gui.payHandler.prototype.addPayOption=function(e,...t){return this.W.call(this,e,...t),e===!1||e==="nugget"||e===2||e.id===2||this.setSelectedPayId(e.id||e),this}}catch(e){ErrorModule.report(e,Language._("errors.ui_change_wof_nuggets"))}},removeVariousPA=function(){const e=[];let t;if(Settings.get("fetch_all_off",!1)&&e.push("marketdelivery all"),e.length){t=RegExp(e.join("|"));try{Premium.twdb_confirmUse=Premium.confirmUse,Premium.confirmUse=function(n,o,a,r,i,l,v,d){return t.test(n)?v!==void 0?v():void 0:Premium.twdb_confirmUse(n,o,a,r,i,l,v,d)}}catch(n){ErrorModule.report(n,Language._("errors.ui_remove_various_pa"))}}},activateFortRecruitment=function(){try{TWDB.Util.addCss(".twir_fb_sector_map_btn{display:none}.TWDS_charinfocolor{margin-top:20px}"),FortBattleWindow.__twdb__getInfoArea=FortBattleWindow.__twdb__getInfoArea||FortBattleWindow.getInfoArea,FortBattleWindow.getInfoArea=function(...e){return this.preBattle.battleData.canSetPrivilege=!0,FortBattleWindow.__twdb__getInfoArea.apply(this,e)}}catch(e){ErrorModule.report(e,Language._("errors.ui_activate_fort_recruitment"))}},enhanceMarketSellDialog=function(){let e,t=TWDB.Cache.load("msdsettings");typeof t!="object"||t===null?t={cb:{}}:typeof t.cb=="object"&&t.cb!==null||(t.cb={});try{isDefined(west.gui.Dialog.prototype.B)||(west.gui.Dialog.prototype.B=west.gui.Dialog.prototype.show),TWDB.script.isDev()?west.gui.Dialog.prototype.show=function(){if(this.divMain.attr("id")==="market_createoffer_window"){const o=this.B();return w.setTimeout(function(){MarketWindow.TWDB_touchUpSellDialog(o)},25),o}const n="div#equip_manager_list, span.twdb_banking";return $(this.divMain).find(n).addBack().is(n)?this.setModal(!1).setBlockGame(!1).setDraggable(!0).B():this.B()}:west.gui.Dialog.prototype.show=function(){if(this.divMain.attr("id")==="market_createoffer_window"){const n=this.B();return w.setTimeout(function(){MarketWindow.TWDB_touchUpSellDialog(n)},25),n}return this.B()},isDefined(MarketWindow.TWDB_createMarketOffer)||(MarketWindow.TWDB_createMarketOffer=MarketWindow.createMarketOffer),MarketWindow.createMarketOffer=function(n){let o=typeof n=="number"?n:$(n).data("itemId");return o===void 0&&(o=$(this).data("dnd_droppedObj").data("itemId")),e=w.ItemManager.get(o),MarketWindow.TWDB_createMarketOffer(o)}}catch(n){ErrorModule.report(n,Language._("errors.market_enhance_sell_dialog"))}MarketWindow.TWDB_touchUpSellDialog=function(n){if(n.divMain.attr("id")!=="market_createoffer_window")return;const o=$("div.tw2gui_dialog_content",n.divMain);if(o.find("#auction_item_slot",o).html()==="")return w.setTimeout(function(){MarketWindow.TWDB_touchUpSellDialog(n)},25);$("div.tw2gui_dialog_framefix").css({left:"50%",top:"50%",width:"1px",height:"1px"}),$("textarea#auction_description",o).css("width","270px").closest("tr").append("<td id='twdb_msd_desc_cc'>");const a=$("table:nth-child(2)",o);$("tr:first-child",a).after($("<tr>").append('<td id="twdb_msd_bid_btn_cc">','<td id="twdb_msd_bid_cc" style="min-width: 90px;">','<td id="twdb_msd_buy_btn_cc">','<td id="twdb_msd_buy_cc" style="min-width: 90px;">')),$("tr:nth-last-child(5) td:nth-child(2) span.tw2gui_textfield",a).after(`<span id="twdb_msd_mult_cc" title="${Language._("market.sell_multiply")}" style="background-image: url(&quot;/images/ranking/town_ranking_icons.png&quot;); display:inline-block; height:16px; width:16px; background-position:0px -80px; cursor:pointer;">&nbsp;</span>`),$("tr:last-child td:first-child",a).attr("colspan",3).before('<td id="twdb_msd_opt_cc">');const r=function(){try{n.divMain.css({"margin-top":`-${n.divMain.height()/2}px`,"margin-left":`-${n.divMain.width()/2}px`})}catch(c){ErrorModule.report(c,Language._("errors.market_center_dialog"))}},i=function(){try{let c;const b=this.groupClass;return $("div.tw2gui_checkbox."+b).not(this.divMain).removeClass("tw2gui_checkbox_checked"),this.isSelected()?(c=this.getValue(),this.divMain.next().click()):c=0,t.cb[b]=c,TWDB.Cache.save("msdsettings",t),new UserMessage(Language._("common.save_success"),UserMessage.TYPE_SUCCESS).show(),this}catch(c){ErrorModule.report(c,Language._("errors.market_handle_checkbox"))}},l=function(c,b){try{t[c]=b,TWDB.Cache.save("msdsettings",t),new UserMessage(Language._("common.save_success"),UserMessage.TYPE_SUCCESS).show()}catch(u){ErrorModule.report(u,Language._("errors.market_save_settings"))}};$("#twdb_msd_desc_cc",o).append($(`<div class="tw2gui-iconset tw2gui-icon-save" title="${Language._("market.sell_save_desc")}">`).click(function(){l("description",$("textarea#auction_description",o).val())}),$(`<div class="tw2gui-iconset tw2gui-icon-abort" title="${Language._("market.sell_reset_desc")}">`).click(function(){l("description",""),$("textarea#auction_description",o).val("")})),$("#twdb_msd_bid_btn_cc",o).append($(`<span class="tw2gui-iconset tw2gui-icon-abort" title="${Language._("market.sell_reset_sel")}" style="display: inline-block;">`).click(function(){$("div.tw2gui_checkbox.twdb_msd_bid_fix",o).each(function(){const c=$(this).guiElement();c?.isSelected()&&(c.setSelected(!1,!0),i.call(c))}),$("#market_min_bid",o).val("").keyup()})),$("#twdb_msd_buy_btn_cc",o).append($(`<span class="tw2gui-iconset tw2gui-icon-abort" title="${Language._("market.sell_reset_sel")}" style="display: inline-block;">`).click(function(){$("div.tw2gui_checkbox.twdb_msd_buy_fix",o).each(function(){const c=$(this).guiElement();c?.isSelected()&&(c.setSelected(!1,!0),i.call(c))}),$("#market_max_price",o).val("").keyup()})),$("#twdb_msd_buy_cc",o).append(new west.gui.Checkbox("","twdb_msd_buy_fix",i).setTitle(Language._("market.use_as_default_price")).setValue(2).divMain).append($(`<div class="tw2gui_checkbox" title="${Language._("market.sell_buy_price")}">`).append('<span class="invPopup_buyicon" style="height:20px;">').click(function(){$("#market_max_price",o).val(e.price||1).keyup()})).append("&nbsp;&nbsp;").append(new west.gui.Checkbox("","twdb_msd_buy_fix",i).setTitle(Language._("market.use_as_default_price")).setValue(1).divMain).append($(`<div class="tw2gui_checkbox" title="${Language._("market.sell_sell_price")}">`).append('<span class="invPopup_sellicon" style="height:20px;">').click(function(){$("#market_max_price",o).val(e.sell_price||Math.round(e.price/2)||1).keyup()})),$("#twdb_msd_bid_cc",o).append(new west.gui.Checkbox("","twdb_msd_bid_fix",i).setTitle(Language._("market.use_as_default_price")).setValue(2).divMain).append($(`<div class="tw2gui_checkbox" title="${Language._("market.sell_buy_price")}">`).append('<span class="invPopup_buyicon" style="height:20px;">').click(function(){$("#market_min_bid",o).val(e.price||1).keyup()})).append("&nbsp;&nbsp;").append(new west.gui.Checkbox("","twdb_msd_bid_fix",i).setTitle(Language._("market.use_as_default_price")).setValue(1).divMain).append($(`<div class="tw2gui_checkbox" title="${Language._("market.sell_sell_price")}">`).append('<span class="invPopup_sellicon" style="height:20px;">').click(function(){$("#market_min_bid",o).val(e.sell_price||Math.round(e.price/2)||1).keyup()})),$("#twdb_msd_mult_cc",o).click(function(){let c;const b=parseInt($("#market_sell_itemStack",o).val(),10);b>0&&(c=parseInt($("#market_min_bid",o).val(),10),c>0&&$("#market_min_bid",o).val(b*c).keyup(),c=parseInt($("#market_max_price",o).val(),10),c>0&&$("#market_max_price",o).val(b*c).keyup())}),$("#twdb_msd_opt_cc",o).append($(`<span class="tw2gui-iconset tw2gui-icon-save" title="${Language._("market.sell_save_duration")}" style="display: inline-block;">`).click(function(){l("duration",parseInt($("#market_days",o).data("value"),10)),l("rights",parseInt($("#market_rights",o).data("value"),10))}),$(`<span class="tw2gui-iconset tw2gui-icon-abort" title="${Language._("market.sell_reset_sel")}" style="display: inline-block;">`).click(function(){l("duration",1),$("span#market_days.tw2gui_combobox",o).guiElement().select(1),l("rights",2),$("span#market_rights.tw2gui_combobox",o).guiElement().select(2)}));const v=$("span#market_rights.tw2gui_combobox",o)?.guiElement()?.items;if(v&&v.length===3){const c=["home","flag","world"];for(let b=0;b<v.length;b++)v[b].node[0].innerHTML='<span class="tw2gui-iconset tw2gui-icon-'+c[v[b].value]+'" style="display: inline-block;position: relative;top: 4px;"></span>&nbsp;'+v[b].node[0].innerHTML}const d=$("h4",o),p=$("table#mps_otheroffers",o);$("tr",p).length>2||$("tr:nth-child(2) > td",p).attr("colspan")!==4?d.html(`${d.html()}&nbsp;(${$("tr",p).length-1})`).click(function(){p.toggle(),r()}).css({cursor:"pointer"}):(d.html(d.html()+"&nbsp;(0)"),p.hide()),r(),(function(){try{let c,b;for(c in t.cb)Object.hasOwn(t.cb,c)&&$("div.tw2gui_checkbox."+c).each(function(){b=$(this).guiElement(),b.getValue()===t.cb[c]&&(b.setSelected(!0,!0),$(this).next().click())});$("textarea#auction_description",o).val(t.description||""),$("span#market_days.tw2gui_combobox",o).guiElement().select(t.duration||1),$("span#market_rights.tw2gui_combobox",o)?.guiElement()?.select(isDefined(t.rights)?t.rights:2)}catch(c){ErrorModule.report(c,Language._("errors.market_restore_settings"))}})()}},weeklyCrafting=function(){if(w.Character.professionId&&w.Character.professionSkill>599){const e=function(n){try{const o=new OnGoingEntry,a=ItemManager.get(n);if(!a||!a.craftitem)return;const r=ItemManager.get(a.craftitem);if(!r)return;const i=`<div style='text-align:center;'>${Language._("crafting.can_craft_again")}<br /><div class="item  item_inventory" style="display:inline-block;float:none;"><img class="tw_item item_inventory_img" src="${r.image}"></div><br />${r.name}</div>`;o.init("",function(){CharacterWindow.open("crafting"),TWDB.Cache.save("craftingCheck",{found:!1,date:null})},11),o.setTooltip(i),o.setImageClass("work"),o.highlightBorder(),WestUi.NotiBar.add(o),TitleTicker.setNotifyMessage(Language._("crafting.notification"))}catch(o){ErrorModule.report(o,Language._("errors.ui_show_crafting_notification"))}},t=function(){try{const n=TWDB.Cache.load("craftingCheck")||{found:!1,date:null};if(!n.found)return;const o=new Date(n.date).getTime()-new ServerDate().getTime();if(0>o)return e(n.found);864e5>o&&(18e4>o?w.setTimeout(function(){e(n.found)},o):w.setTimeout(function(){t()},parseInt(o/2,10)))}catch(n){ErrorModule.report(n,Language._("errors.ui_check_crafting_timer"))}};t()}},removeForumBlink=function(){setTimeout(function(){$("div.city > div.city").removeClass("dock-highlight")},1e3),setTimeout(function(){$("#TWM_bottombar div.city > div.Stadt").removeClass("TWM_highlight")},1e3)},addEnhancedRankings=function(){function e(i){const l=i.innerHTML.match(/open\((\d+)/);if(!l)return;const v=l[1];if(!o[v])return d=function(){e(i)},void Ajax.remoteCallMode("ranking","get_data",{tab:"experience",entries_per_page:9999},function(c){for(const b of c.ranking)o[b.player_id]=a.indexOf(b.class);localStorage.setItem(n,JSON.stringify(o)),d&&d()});var d;const p=a[o[v]];$(i).prepend(`<img src="images/class_choose/class_${p}.png" title="${Game.InfoHandler.getLocalString4Charclass(p)}"> `)}function t(i,l){i.updateTable_backup=i.updateTable,i.updateTable=function(v){i.updateTable_backup.call(this,v),(function(d){d.forEach(p=>{const c=$(`${p.selector}:not(${p.skip})`);for(let b=0;b<c.length;b++)p.hidden?$(c[b]).hide():(c[b].innerText=format_number(c[b].innerText),p.diff&&b!==0&&(c[b].title=format_number(deformat_number(c[b].innerText)-deformat_number(c[b-1].innerText))))})})(l),r.forEach(d=>{const p=$(d);for(let c=0;c<p.length;c++)e(p[c])})}}const n=`twdb_${Character.playerId}_playercategory`,o=JSON.parse(localStorage.getItem(n)||"{}"),a=[null,"greenhorn","duelist","adventurer","worker","soldier"],r=[".exp_playername",".duel_playername",".forts_playername",".craft_playername",".build_playername",".mpi_playername",".achieve_playername",".skill_playername"];TWDB.Util.addCss("#ranking_exptable div.exp_exp,#ranking_duel div.duel_exp{text-align:center}#ranking_exptable div.exp_town,#ranking_duel div.duel_town,#ranking_cities .tbody .town_member_lvl{padding-left:10px}#ranking_duel div.duel_win,#ranking_duel div.duel_loss,#ranking_duel div.duel_diff{margin-right:5px}#ranking_crafting div.craft_profession_id{width:115px}#ranking_cities .row_head .town_member_lvl span{margin:0 20px}#ranking_exptable div.exp_class{display:none}#ranking_exptable div.exp_playername{width:260px}#ranking_adventures div.mpi_knockouts,#ranking_adventures div.mpi_total_actions,#ranking_adventures div.mpi_games_played,#ranking_adventures div.mpi_friendly_dmg{width:80px}#ranking_adventures div.mpi_rage_quits{width:88px}div.ranking span.search_lable_span{top:10px}"),t(RankingWindow.Experience,[{selector:".exp_exp",skip:"div.cell.cell_3",diff:!0},{selector:".exp_class",skip:"div.cell.cell_4",diff:!0,hidden:!0}]),t(RankingWindow.Duels,[{selector:".duel_exp",skip:"div.cell.cell_2",diff:!0},{selector:".duel_win",skip:"div.cell.cell_3",diff:!0},{selector:".duel_loss",skip:"div.cell.cell_4",diff:!0},{selector:".duel_diff",skip:"div.cell.cell_5",diff:!1}]),t(RankingWindow.FortBattles,[{selector:".forts_score",skip:"div.cell.cell_2",diff:!0},{selector:".forts_damage_dealt",skip:"div.cell.cell_3",diff:!0},{selector:".forts_hits_taken",skip:"div.cell.cell_4",diff:!0},{selector:".forts_dodges",skip:"div.cell.cell_5",diff:!0}]),t(RankingWindow.Crafting,[{selector:".craft_score",skip:"div.cell.cell_4",diff:!0},{selector:".craft_items_created",skip:"div.cell.cell_5",diff:!0},{selector:".craft_profession_skill",skip:"div.cell.cell_3",diff:!1}]),t(RankingWindow.Construction,[{selector:".build_total_cp",skip:"div.cell.cell_2",diff:!0},{selector:".build_fair_points",skip:"div.cell.cell_3",diff:!1},{selector:".build_stage_ups",skip:"div.cell.cell_4",diff:!1}]),t(RankingWindow.Adventures,[{selector:".mpi_knockouts",skip:"div.cell.cell_2",diff:!0},{selector:".mpi_total_actions",skip:"div.cell.cell_3",diff:!0},{selector:".mpi_games_played",skip:"div.cell.cell_4",diff:!0},{selector:".mpi_friendly_dmg",skip:"div.cell.cell_5",diff:!0},{selector:".mpi_rage_quits",skip:"div.cell.cell_6",diff:!1}]),t(RankingWindow.Achievements,[{selector:".achieve_total",skip:"div.cell.cell_2",diff:!0},{selector:".achieve_first",skip:"div.cell.cell_3",diff:!1},{selector:".achieve_points",skip:"div.cell.cell_4",diff:!0}]),t(RankingWindow.Cities,[{selector:".town_points_sum",skip:"div.cell.cell_2",diff:!0},{selector:".town_points",skip:"div.cell.cell_3",diff:!0},{selector:".town_fort_points",skip:"div.cell.cell_4",diff:!1},{selector:".town_member_points",skip:"div.cell.cell_5",diff:!1},{selector:".town_duel_points",skip:"div.cell.cell_6",diff:!1}]),t(RankingWindow.Skills,[{selector:".skill_pointss",skip:"div.cell.cell_2",diff:!0}])},addDuelXpInProfiles=function(){try{PlayerProfileMain.setProfileInfo_backup=PlayerProfileMain.setProfileInfo_backup||PlayerProfileMain.setProfileInfo,PlayerProfileMain.setProfileInfo=function(...e){PlayerProfileMain.setProfileInfo_backup.apply(this,e);const t=this.resp.level,n=this.resp.duelLevel,o=$(`.playerprofile-${this.playerid} .profileinfo-duellevel .profileinfo-value`),a={min:Math.ceil((r=n)/1.4+.01),max:Math.min(450,Math.floor(1.4*r-.01))};var r;const i=b=>Math.ceil((10*b)**(1/.6)),l=(b,u)=>t+Math.floor((b*(u||1))**.6/10),v=i(n-t),d=n==="450"?"<b>∞</b>":i(n+1-t),p=l(v,.9),c=n==="450"?"450":l(d,.9);o.append(` <div class="tw2gui-iconset tw2gui-icon-question-priority-4" title="<span>${Language._("duel.levels_duel",{min:a.min,max:a.max})}<br><br>${Language._("duel.levels_exp",{min:v,max:d})}<br>${Language._("duel.potion_label")} -10% ⇒ ${Language._("duel.levels_potion",{min:p,max:c>p?" - "+c:""})}</span>" style="display:inline-block;vertical-align:top;cursor:pointer;"></div>`)}}catch(e){ErrorModule.report(e,Language._("errors.duel_xp_profile"))}},addRegenTimers=function(){try{let r=function(i,l,v,d,p){let c,b,u,g,h=Character[i],_=Character[l],k=Character[v],T=Character[d];const C=()=>{c=h*_;const L=3600/c,D=h-k;b=D*L,u=L-Game.getServerTime()+T,g=Math.round(100/h*D)},f=L=>L.formatDuration();C(),setInterval(()=>{h===Character[i]&&_===Character[l]&&k===Character[v]&&T===Character[d]||(h=Character[i],_=Character[l],k=Character[v],T=Character[d],C()),b>1&&b--,u>1&&u--,p(f(b),c,f(u),g)},1e3)};var e=r;TWDB.Util.addCss("#rt_container{width:16px;top:144px;left:8px;position:relative;display:flex;flex-direction:column;align-items:center}#rt_container img{cursor:help;margin:2px 0;padding:0 12px 0 6px;filter:hue-rotate(-50deg) saturate(777%)}");const t=$("#ui_character_container"),n=$('<div id="rt_container">'),o=i=>{const l=new MousePopup;return{$img:$(`<img id="${i}" src="${Images.iconRegen}" alt="sleeping">`).addMousePopup(l),popup:l}},a=[{id:"rt_health",maxKey:"maxHealth",regenKey:"healthRegen",currentKey:"health",dateKey:"healthDate",popup:null},{id:"rt_energy",maxKey:"maxEnergy",regenKey:"energyRegen",currentKey:"energy",dateKey:"energyDate",popup:null}];a.forEach(i=>{const l=o(i.id);i.$img=l.$img,i.popup=l.popup,n.append(l.$img)}),a.forEach(i=>{new r(i.maxKey,i.regenKey,i.currentKey,i.dateKey,(l,v,d,p)=>{i.popup.setXHTML(s((i.id.includes("health")?Language._("regen.full_health"):Language._("regen.full_energy"))+": <b>%1</b><br>"+Language._("regen.missing")+": <b>%4%</b>&boxv;"+Language._("regen.per_hour")+": <b>%2</b><br>"+(i.id.includes("health")?Language._("regen.next_health"):Language._("regen.next_energy"))+": <b>%3</b><br>",l,v,d,p))})}),t.append(n)}catch(t){ErrorModule.report(t,Language._("errors.regen_timers"))}},selectForumText=function(){try{if(selectForumText.T)return;selectForumText.T=!0;const e="twdb_forum_select_text",t="#forum,#ui_chat,div#ui_topbar>div,#ui_character_container,.tw2gui_window{-webkit-user-select:text!important;-khtml-user-select:text!important;-moz-user-select:text!important;-ms-user-select:text!important;user-select:text!important}",n=a=>{if(!a?.head||a.getElementById(e))return;const r=a.createElement("style");r.id=e,r.textContent=t,a.head.appendChild(r)},o=a=>{try{const r=a.contentDocument||a.contentWindow?.document;n(r)}catch(r){ErrorModule.report(r,Language._("errors.inject_forum_iframe"))}};n(document),document.querySelectorAll("iframe[src='forum.php']").forEach(o),document.addEventListener("load",a=>{const r=a.target;r?.tagName==="IFRAME"&&r.getAttribute("src")==="forum.php"&&o(r)},!0)}catch(e){ErrorModule.report(e,Language._("errors.enable_night_mode"))}},addNightMode=function(){try{$("#map").css({filter:"brightness(55%)","-webkit-filter":"brightness(55%)"})}catch(e){ErrorModule.report(e,Language._("errors.enable_night_mode"))}},removeBlinkingEvents=function(){try{const e=setInterval(()=>{$(".border.highlight").length&&(clearInterval(e),$(".border.highlight").remove(),TWDB.Util.addCss(".border.highlight {display:none;}"))},3e3)}catch(e){ErrorModule.report(e,Language._("errors.remove_blinking_events"))}},reworkMarketReport=function(){try{if(document.getElementsByClassName("marketplace").length>0&&document.querySelectorAll('[id^="mpb_marketOfferReport"]').forEach(e=>{const t=e.parentNode.parentNode.querySelector(".cell_8").querySelector("img");t!==null?(e.src=Game.cdnURL+"/images/icons/warn_circle.png",e.height=16,t.parentNode.insertBefore(e,t)):e.remove()}),Settings.get("improved_market",!0))return;MarketWindow.Buy.updateTable_backup=MarketWindow.Buy.updateTable_backup||MarketWindow.Buy.updateTable,MarketWindow.Buy.updateTable=function(...e){MarketWindow.Buy.updateTable_backup.apply(this,e),Character.homeTown.town_id&&reworkMarketReport()}}catch(e){ErrorModule.report(e,Language._("errors.rework_market_report"))}},improvedMarket=function(){try{MarketWindow.sellRights=[{i:"town_new",t:Language._("market.rights_town")},{i:"friends",t:Language._("market.rights_alliance")},{i:"welt",t:Language._("market.rights_anyone")}];const e=function(t){Ajax.remoteCall("building_market","search",{page:t,sort:"distance",visibility:0},function(n){var o=n.msg.search_result;for(let r=0;r<o.length;r++){var a=o[r];a.seller_name===Character.name&&$(`.marketSellsData_${a.market_offer_id} .mps_pickup`).prepend(`<img src="images/icons/${MarketWindow.sellRights[a.sell_rights].i}.png" title="${MarketWindow.sellRights[a.sell_rights].t}">`)}t===1&&n.msg.next&&e(2)})};MarketWindow.Sell.updateTable_backup=MarketWindow.Sell.updateTable_backup||MarketWindow.Sell.updateTable,MarketWindow.Sell.updateTable=function(...t){MarketWindow.Sell.updateTable_backup.apply(this,t),Character.homeTown.town_id&&e(1)},MarketWindow.Buy.updateTable_backup=MarketWindow.Buy.updateTable,MarketWindow.Buy.updateTable=function(t){if(MarketWindow.Buy.updateTable_backup.call(this,t),Character.homeTown.town_id){for(let n=0;n<t.length;n++)$("#mpb_vendor_"+t[n].market_offer_id).before(`<img src="images/icons/${MarketWindow.sellRights[t[n].sell_rights].i}.png" title="${MarketWindow.sellRights[t[n].sell_rights].t}">`);reworkMarketReport()}}}catch(e){ErrorModule.report(e,Language._("errors.improved_market"))}},improvedWhisper=function(){try{var e=`${Script.protocol}://${Script.folder_url}whispers/`,t=["tw","bum","chime","coin","coin2","icq","qip","tinkle","trumpet","vk"];const n=9,o={},a="whisper_improved",r="beeperSound";let i=e+t[n]+".mp3";const l=function(u){return typeof u=="string"&&u!==""&&/^-?\d+$/.test(u)?parseInt(u,10):u},v=function(){return l(Settings.get(r,n))};Settings.get(a,!0);const d=function(){const u=v();i=typeof u=="number"&&t[u]?e+t[u]+".mp3":typeof u=="string"&&u?u:e+t[n]+".mp3"},p=function(){try{new Audio(i).play()}catch(u){ErrorModule.report(u,Language._("errors.gameinject_improved_whisper_play_sound"))}},c=function(){EventHandler.listen("chat_tell_received",p,o),AudioController.play_whisper||(AudioController.play_whisper=AudioController.play,AudioController.play=function(u,...g){u!=="newmsg"&&AudioController.play_whisper.call(this,u,...g)})},b=function(){EventHandler.unlistenByContext("chat_tell_received",o),AudioController.play_whisper&&(AudioController.play=AudioController.play_whisper,delete AudioController.play_whisper)};d(),Settings.get(a,!0)&&c(),window.ChatBeeper={updateSound:d,play:p,enable:c,disable:b}}catch(n){ErrorModule.report(n,Language._("errors.improved_whisper"))}},jobWindowLP=function(){try{JobWindow.prototype.__twdb__initView=JobWindow.prototype.__twdb__initView||JobWindow.prototype.initView,JobWindow.prototype.initView=function(...e){var t=JobWindow.prototype.__twdb__initView.apply(this,e);if(this.job&&typeof this.currSkillpoints=="number"){var n=`&nbsp;&nbsp;(${Language._("jobs.lp_remaining",{lp:this.currSkillpoints-this.job.workpoints})})`;$("div.tw2gui_inner_window_title > .textart_title",this.window.divMain).append(n)}return t}}catch(e){ErrorModule.report(e,Language._("errors.job_window_lp"))}},addInstantQuests=function(){try{if(!QuestEmployerView?.showQuest)return;QuestEmployerView.showQuest_backup=QuestEmployerView.showQuest,QuestEmployerView.showQuest=e=>{QuestEmployerView.showQuest_backup(e);const t=e.accepted===!1,n=!e.questRewardsOptions;if(t&&n){const o=e.requirements||[];if(o.filter(a=>a.solved===!0).length===o.length){const a=$("div.quest_button_area_"+e.id);if(!a.length)return;const r=new west.gui.Button(Language._("quests.accept_finish"),()=>{QuestWindow.acceptQuest(e.id);let i=0;const l=setInterval(()=>{QuestLog.quests?.[e.id]?(clearInterval(l),QuestWindow.finishQuest(e.id)):++i===20&&clearInterval(l)},200)}).getMainDiv();a.empty().append(r)}}}}catch(e){ErrorModule.report(e,Language._("errors.add_instant_quests"))}},addColoredQuests=function(){try{const e=(n,o)=>{if(n.jsInfo?.metatype==="FRONTEND"){const i=n.jsInfo.key;(QuestLog.windows_opened[i]||QuestLog.tabs_opened[i])&&(n.solved=!0)}const a=n.info.replace(/ (\(?\d+\/\d+\)?)/g,"&nbsp;$1"),r=n.solved&&!o?"color:gray;":"";return`<li class="quest_requirement ${n.solved&&o?o:""}" style="${r}">- ${a}</li>`},t=QuestEmployerView.buildQuestLog;QuestEmployerView.buildQuestLog=function(n,...o){t.call(this,n,...o),n.open.forEach(a=>{const r=$("#open_quest_employerlink_"+a.id);if(!r||!r.is(":visible"))return;let i=0,l='<div style="max-width: 300px; min-width: 150px;"><ul class="requirement_container">';a.requirements.forEach(d=>{d.solved||d.type==="wear_changed"&&Bag.getItemByItemId(d.id)?i++:d.solved||(l+=e(d))}),l+="</ul></div>",l+=`<div style="text-align: center;">${Quest.getRewards(a.questRewards,a.questRewardsOptions,!1)}</div>`;const v=r.children("img");if(l.trim()!==""&&v.addMousePopup(l),a.limited?.length&&v.after($('<div class="hourglass_quest" style="display: inline-block; vertical-align: middle; margin-bottom: 3px; margin-right: 2px;"></div>').addMousePopup(a.limited)),Settings.get("colored_quest")){r.addClass("twdb_quest_entrie");const d=a.requirements.length;i===d&&a.accepted?r.css({color:"#666","font-style":"italic"}):i===d||i+1===d&&a.duel?.isNPCDuel?r.css({color:"#070"}):66>i/d*100||r.css({color:"#b75c00"})}})},TWDB.Util.addCss(".twdb_quest_entrie:hover { color: #1479A8 !important; }")}catch(e){ErrorModule.report(e,Language._("errors.add_colored_quests"))}},importWestForts=function(){try{if(location.href.includes(".the-west.")&&location.href.includes("game.php")){if(!TWDB.images.westfortsIconActive||!TWDB.images.westfortsIconInactive)return waitForImages("westfortsIconActive",importWestForts),void 0;if(document.getElementById("westforts_js"))return;const e=document.createElement("script");e.type="text/javascript",e.id="westforts_js",e.innerHTML=`(() => {const ICON_ACTIVE = TWDB.images.westfortsIconActive;const ICON_INACTIVE = TWDB.images.westfortsIconInactive;let scriptArmed = false;const originalFortStats = FortBattle.makeStats;const originalCemeteryTable = CemeteryWindow.showStatUpdateTable;const westfortsButton = document.createElement('div');westfortsButton.id = 'westforts_link_div';const TITLE_DEFAULT = \`<b>\${Language._("westforts.open_import")}</b>\`;const TITLE_ARMED = \`<b>\${Language._("westforts.close_import")}</b>\`;westfortsButton.title = TITLE_DEFAULT;westfortsButton.style.cssText = 'position:absolute; z-index:10; cursor:pointer; text-align:center; color:#fff; font-size:12px; padding:0px 3px 1px 9px; right:0; top:0; background:url("/images/interface/minimap/minimapbg.png") no-repeat scroll 0px -7px';westfortsButton.innerHTML = \`<img id="westforts_icon_img" src="\${ICON_INACTIVE}" /><div style="float:right;margin-left:5px;margin-top:1px;">\${Language._("westforts.button_label")}</div>\`;westfortsButton.onclick = () => {const iconImg = document.getElementById('westforts_icon_img');if (scriptArmed) {westfortsButton.style.color = '#fff';iconImg.src = ICON_INACTIVE;westfortsButton.title = TITLE_DEFAULT;scriptArmed = false;const existingScript = document.getElementById('wfScript');if (existingScript) existingScript.remove();FortBattle.makeStats = originalFortStats;CemeteryWindow.showStatUpdateTable = originalCemeteryTable;const form = document.getElementById('wfForm');if (form) form.remove();} else {if (!document.getElementById('wfScript')) {const script = document.createElement('script');script.id = 'wfScript';script.type = 'text/javascript';script.src = \`https://www.westforts.com/js/import.js?\${Date.now()}\`;document.body.appendChild(script);}westfortsButton.style.color = '#01DF00';iconImg.src = ICON_ACTIVE;westfortsButton.title = TITLE_ARMED;scriptArmed = true;}};document.body.appendChild(westfortsButton);})();`,document.body.appendChild(e)}}catch(e){ErrorModule.report(e,Language._("errors.import_westforts"))}};return _self})($);Debugger.Snippets=Snippets;const GameInject=(function($){const _self={},save={},minimap=[],questlog=[],radialmenu=[],quests=[],_ready=!1;let timeout=null,interval=null;const _position=[],_reportreceived=[];_self.CharacterButton=(function(e){const t={};let n=0,o=null;return t.add=function(a){n===0&&(TWDB.Util.addCss(`div#twdb_characbut{width:36px;height:35px;position:absolute;left:141px;top:131px;border-bottom-left-radius:8px;background:url(${Game.cdnURL}/images/interface/character/character.png?3) no-repeat -141px -105px transparent}`),o=e('<div id="twdb_characbut" />'),e("#ui_character_container").prepend(o)),n++,o.css({height:10+26*n+"px","background-position":`-141px ${26*n-131}px`});var r=e(`<div class="char_links" style="top:${6+26*(n-1)}px;left:6px;background:url(${a})no-repeat 0px 0px transparent;"/>`);return r.on("mouseenter",function(){e(this).css("background-position","-25px 0px")}).on("mouseleave",function(){e(this).css("background-position","0px 0px")}),o.append(r),r},t})($),_self.injectTaskJobs=function(){try{var e=TaskJob;TaskJob=function(...n){var o=e.apply(this,n);return o.D=o.getTitle,o.getTitle=function(){return`${o.D()}${Language._("task.queue_lp_label")}${0>this.data.job_points?"<b class='text_red'>":"<b>"}${this.data.job_points}</b><br />`},o}}catch(n){ErrorModule.report(n,Language._("errors.gameinject_manipulate_taskjob_template"))}try{if(TaskQueue.queue.length){var t=$("script:contains('TaskQueue.init')").text().match(/TaskQueue\.init\(\s*(\[[^\]]*\])/);t.length===2&&(t=JSON.parse(t[1]),TaskQueue.init(t,TaskQueue.limit))}}catch(n){ErrorModule.report(n,Language._("errors.gameinject_manipulate_job_tasks"))}},_self.ChatLayout=(function(e){const t=[];return function(n){if(t.length===0)try{save["window.Chat.Layout.Tab.prototype.getMainDiv"]=window.Chat.Layout.Tab.prototype.getMainDiv,window.Chat.Layout.Tab.prototype.getMainDiv=function(){for(let o=0;o<t.length;o++)try{t[o](this)}catch(a){ErrorModule.report(a,Language._("errors.gameinject_callbacks_chat_layout"))}return this.mainDiv}}catch(o){ErrorModule.report(o,Language._("errors.gameinject_manipulate_chat_layout")),window.Chat.Layout.Tab.prototype.getMainDiv=save["window.Chat.Layout.Tab.prototype.getMainDiv"]}t.push(n)}})(),_self.ChatSend=(function(e){const t=[];return function(n){if(t.length===0)try{window.Chat.Layout.Tab.prototype.twdb_send=window.Chat.Layout.Tab.prototype.send,window.Chat.Layout.Tab.prototype.send=function(){for(let o=0;o<t.length;o++)try{t[o](this)}catch(a){ErrorModule.report(a,Language._("errors.gameinject_callbacks_chat_send"))}this.twdb_send()}}catch(o){ErrorModule.report(o,Language._("errors.gameinject_manipulate_chat_send")),window.Chat.Layout.Tab.prototype.send=window.Chat.Layout.Tab.prototype.twdb_send}t.push(n)}})(),_self.MarketOfferTable=(function(e){const t=[];return function(n){if(t.length===0)try{save["MarketWindow.Offer.updateTable"]=MarketWindow.Offer.updateTable,MarketWindow.Offer.updateTable=function(o){save["MarketWindow.Offer.updateTable"](o);for(let a=0;a<t.length;a++)try{t[a](o)}catch(r){ErrorModule.report(r,Language._("errors.gameinject_callbacks_market_offer_table"))}}}catch(o){ErrorModule.report(o,Language._("errors.gameinject_manipulate_market_offer_table")),MarketWindow.Offer.updateTable=save["MarketWindow.Offer.updateTable"]}t.push(n)}})(),_self.MarketWatchlistTable=(function(e){const t=[];return function(n){if(t.length===0)try{save["MarketWindow.Watchlist.updateTable"]=MarketWindow.Watchlist.updateTable,MarketWindow.Watchlist.updateTable=function(o){save["MarketWindow.Watchlist.updateTable"](o);for(let a=0;a<t.length;a++)try{t[a](o)}catch(r){ErrorModule.report(r,Language._("errors.gameinject_callbacks_market_watchlist_table"))}}}catch(o){ErrorModule.report(o,Language._("errors.gameinject_manipulate_market_watchlist_table")),MarketWindow.Watchlist.updateTable=save["MarketWindow.Watchlist.updateTable"]}t.push(n)}})(),_self.MarketWhatIsHotTable=(function(e){const t=[];return function(n){if(t.length===0)try{save["MarketWindow.WhatIsHot.updateTable"]=MarketWindow.WhatIsHot.updateTable,MarketWindow.WhatIsHot.updateTable=function(o){save["MarketWindow.WhatIsHot.updateTable"](o);for(let a=0;a<t.length;a++)try{t[a](o)}catch(r){ErrorModule.report(r,Language._("errors.gameinject_callbacks_market_what_is_hot_table"))}}}catch(o){ErrorModule.report(o,Language._("errors.gameinject_manipulate_market_what_is_hot_table")),MarketWindow.WhatIsHot.updateTable=save["MarketWindow.WhatIsHot.updateTable"]}t.push(n)}})(),_self.injectSetDuelMotivation=(function(e){const t=[];return function(n){if(t.length===0)try{Character.twdb_setDuelMotivation=Character.setDuelMotivation,Character.setDuelMotivation=function(o){this.twdb_setDuelMotivation(o);for(let a=0;a<t.length;a++)try{t[a](o)}catch(r){ErrorModule.report(r,Language._("errors.gameinject_callbacks_set_duel_motivation"))}}}catch(o){ErrorModule.report(o,Language._("errors.gameinject_manipulate_set_duel_motivation")),Character.setDuelMotivation=twdb_Character.setDuelMotivation}t.push(n)}})(),_self.ItemUse=(function(_$){const callbacks=[];return function(callback){if(callbacks.length===0){ItemUse.twdb=function(e,t){for(let n=0;n<callbacks.length;n++)try{callbacks[n](e,t)}catch(o){ErrorModule.report(o,Language._("errors.gameinject_callbacks_item_use"))}},save["ItemUse.doIt"]=ItemUse.doIt;try{const toolkit=ItemUse.doItOrigin?"doItOrigin":"doIt",str=ItemUse[toolkit].toString(),pos=str.indexOf("EventHandler.signal('item_used'"),inject=`${str.substr(0,pos)}ItemUse.twdb(itemId,res);${str.substr(pos)}`;eval(`ItemUse.${toolkit} = ${inject}`)}catch(e){ItemUse.doIt=save["ItemUse.doIt"],ErrorModule.report(e,Language._("errors.gameinject_manipulate_item_use"))}}callbacks.push(callback)}})($),_self.injectItem=function(type,name,callback){const item=type+"Item";save[item]===void 0&&(save[item]=tw2widget[item].prototype.getMainDiv);try{tw2widget[item].prototype["TWDB"+name]=function(e){try{return callback(e)}catch(t){return ErrorModule.report(t,Language._("errors.gameinject_injected_function",{functionName:name})),""}}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_inject_function",{item,functionName:name}))}try{var inject=`this.TWDB${name}(this);`;inject.replace(/ /g,"");var newfunction=tw2widget[item].prototype.getMainDiv.toString().replace("return",inject+" return");eval(`tw2widget['${item}'].prototype.getMainDiv = ${newfunction}`)}catch(e){ErrorModule.report(e,Language._("errors.gameinject_manipulate_prototype_get_main_div",{item})),tw2widget[item].prototype.getMainDiv=save[item]}},_self.injectTrader=function(name,callback){save["west.game.shop.item.view.prototype.render"]===void 0&&(save["west.game.shop.item.view.prototype.render"]=west.game.shop.item.view.prototype.render);try{west.game.shop.item.view.prototype["TWDB"+name]=function(e){try{return callback(e)}catch(t){return ErrorModule.report(t,Language._("errors.gameinject_callback_inject_trader",{functionName:name})),""}}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_inject_trader_callback",{functionName:name}))}try{var str=west.game.shop.item.view.prototype.render.toString(),inject=`window.setTimeout(function() {$item.append(that.TWDB${name}(model.getItemData()))}, 100);`;inject.replace(/ /g,"");var newfunction=str.replace("return $item",inject+" return $item");eval("west.game.shop.item.view.prototype.render = "+newfunction)}catch(e){ErrorModule.report(e,Language._("errors.gameinject_manipulate_shop_item_render")),west.game.shop.item.view.prototype.render=save["west.game.shop.item.view.prototype.render"]}},_self.injectMarket=function(name,callback){save.MarketWindow===void 0&&(save.MarketWindow=MarketWindow.getClearName.toString());try{MarketWindow["TWDB"+name]=function(e){try{return callback(e)}catch(t){ErrorModule.report(t,Language._("errors.gameinject_injected_market_window_function",{functionName:name}))}return""}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_inject_market_window_function",{functionName:name}))}try{var str=MarketWindow.getClearName.toString(),inject=`this.TWDB${name}(obj.item_id)`;inject.replace(/ /g,"");for(var newfunction="";str.indexOf("return")!==-1;){var pos=str.indexOf("return");newfunction+=`${str.slice(0,pos+6)} ${inject} + String(`,str=str.substr(pos+7),pos=str.indexOf(";"),newfunction+=str.slice(0,pos)+");",str=str.substr(pos+1)}newfunction+=str,eval("MarketWindow.getClearName = "+newfunction)}catch(error){ErrorModule.report(error,Language._("errors.gameinject_manipulate_market_get_clear_name")),eval("MarketWindow.getClearName = "+save.MarketWindow)}},_self.injectGetBids=function(){try{MarketWindow.twdb_showTab2=MarketWindow.twdb_showTab2||MarketWindow.showTab,MarketWindow.showTab=function(e,...t){e!=="sell"&&e!=="marketmap"&&TWDB.ClothCalc.getBids(),MarketWindow.twdb_showTab2.call(this,e,...t)}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_manipulate_market_show_tab_2"))}},_self.addTabOnMessagesWindow=function(name,shortname,callback){save.MessagesWindowOpen===void 0&&(save.MessagesWindowOpen=MessagesWindow.open.toString(),save.MessagesWindowTab=MessagesWindow.showTab.toString());try{var inject=`MessagesWindow.window.addTab('${name}', '${shortname}', tabclick).appendToContentPane($('<div class="messages-${shortname}"/>'));`,newfunction=MessagesWindow.open.toString().replace(/MessagesWindow.Telegram.DOM/g,inject+"MessagesWindow.Telegram.DOM");eval(`(function ($) {MessagesWindow.open = ${newfunction}})(jQuery);`)}catch(error){ErrorModule.report(error,Language._("errors.gameinject_manipulate_messages_window_open")),eval(`(function ($) {MessagesWindow.open = ${save.MessagesWindowOpen}})(jQuery);`)}try{MessagesWindow["TWDB-"+shortname]=function(){callback()}}catch(e){ErrorModule.report(e,Language._("errors.gameinject_add_show_tab_messages_window"))}try{var inject2=`case '${shortname}':MessagesWindow['TWDB-${shortname}']();break;`,newfunction2=MessagesWindow.showTab.toString().replace(/switch(\s)*\(id\)(\s)*{/g,"switch (id) { "+inject2);eval(`(function ($) {MessagesWindow.showTab = ${newfunction2}})(jQuery);`)}catch(error){ErrorModule.report(error,Language._("errors.gameinject_manipulate_messages_window_show_tab")),eval(`(function ($) {MessagesWindow.showTab = ${save.MessagesWindowTab}})(jQuery);`)}},_self.addTabOnMarketWindow=function(e,t,n){const o=function(a,r){MarketWindow.window&&(MarketWindow.window.activateTab(r).$("div.tw2gui_window_content_pane > *",MarketWindow.DOM).each(function(i,l){$(l).hasClass("marketplace-"+r)?($(l).children().fadeIn(),$(l).show()):($(l).children().fadeOut(),$(l).hide())}),MarketWindow["TWDB-"+r]())};try{MarketWindow.twdb_open=MarketWindow.twdb_open||MarketWindow.open,MarketWindow.open=function(...a){this.twdb_open.apply(this,a),MarketWindow.window.addTab(e,t,o).appendToContentPane($(`<div class="marketplace-${t}"/>`))}}catch(a){ErrorModule.report(a,Language._("errors.gameinject_manipulate_market_window_open"))}try{MarketWindow["TWDB-"+t]=function(){n()}}catch(a){ErrorModule.report(a,Language._("errors.gameinject_add_show_tab_market_window"))}try{MarketWindow.twdb_showTab=MarketWindow.twdb_showTab||MarketWindow.showTab,MarketWindow.showTab=function(...a){MarketWindow.window.setSize(748,471).removeClass("premium-buy"),this.twdb_showTab.apply(this,a)}}catch(a){ErrorModule.report(a,Language._("errors.gameinject_manipulate_market_window_show_tab_1"))}};const waitForMinimap=function(e){interval&&(window.clearInterval(timeout),window.clearInterval(interval)),timeout=setInterval(function(){window.clearInterval(interval),window.clearInterval(timeout),interval=null,timeout=null},3e5),interval=setInterval(function(){(function(){try{if(!MinimapWindow.window||$(MinimapWindow.window.divMain).find(".mmap_jobs").length===0||$(MinimapWindow.window).find(".loader").is(":visible"))return;window.clearInterval(timeout),window.clearInterval(interval),interval=null,timeout=null;for(let t=0;t<minimap.length;t++)try{minimap[t]()}catch(n){ErrorModule.report(n,Language._("errors.gameinject_minimap_window_inject"))}}catch(t){ErrorModule.report(t,Language._("errors.gameinject_check_minimap_ready"))}})()},200)};return _self.injectMinimap=function(e){try{MinimapWindow.C||(MinimapWindow.C=MinimapWindow.open,MinimapWindow.open=function(t){try{MinimapWindow.C(t),waitForMinimap()}catch(n){ErrorModule.report(n,Language._("errors.gameinject_minimap_window_open"))}})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_minimap_window_open"))}try{MinimapWindow._refreshWindow||(MinimapWindow._refreshWindow=MinimapWindow.refreshWindow,MinimapWindow.refreshWindow=function(){try{MinimapWindow._refreshWindow(),window.setTimeout(function(){waitForMinimap()},2500)}catch(t){ErrorModule.report(t,Language._("errors.gameinject_minimap_window_refresh"))}})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_minimap_window_refresh"))}minimap.push(function(){e()})},_self.injectRadialmenu=function(e){try{window.GameMap.Radialmenu.prototype.C||(window.GameMap.Radialmenu.prototype.C=window.GameMap.Radialmenu.prototype.open,window.GameMap.Radialmenu.prototype.open=function(t){try{this.C(t);for(let n=0;n<radialmenu.length;n++)radialmenu[n](this)}catch(n){ErrorModule.report(n,Language._("errors.gameinject_radialmenu_open"))}})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_radialmenu_open"))}radialmenu.push(function(t){e(t)})},_self.injectQuestLog=function(e){try{QuestEmployerView._buildQuestLog||(QuestEmployerView._buildQuestLog=QuestEmployerView.buildQuestLog,QuestEmployerView.buildQuestLog=function(t){try{QuestEmployerView._buildQuestLog(t);for(let n=0;n<questlog.length;n++)questlog[n](t)}catch(n){ErrorModule.report(n,Language._("errors.gameinject_quest_employer_view_build_quest_log"))}}),questlog.push(function(t){e(t)})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_quest_employer_view_build_quest_log"))}},_self.injectQuest=function(e){try{Quest.prototype.j||(Quest.prototype.j=Quest.render,Quest.prototype.render=function(){try{this.j();for(let t=0;t<quests.length;t++)quests[t](this)}catch(t){ErrorModule.report(t,Language._("errors.gameinject_quest_render"))}}),quests.push(function(t){e(t)})}catch(t){ErrorModule.report(t,Language._("errors.gameinject_manipulate_quest_render"))}},_self.injectInventoryAddItemsPinItems=function(){try{Inventory.__CCPI__addItems=Inventory.__CCPI__addItems||Inventory.addItems,Inventory.addItems=function(...e){const[t,n]=e;Inventory.__CCPI__addItems.apply(this,e),$("#CC_pin_items").length||Inventory.DOM.children(".actions").append($('<div id="CC_pin_items" class="tw2gui_iconbutton" />').attr({title:Language._("misc.pin_toggle_tooltip")}).toggleClass("pinact",TWDB.Settings.itemPinningMode===1)),$("#CC_pin_items").off("click").click(function(){TWDB.Settings.itemPinningMode^=!0,$(this).toggleClass("pinact",TWDB.Settings.itemPinningMode===1),Inventory.addItems(t,n)}),(t||Inventory.defaultCategory)==="new"&&$.each((TWDB.Settings.get("pinnedItems")||[]).slice().reverse(),function(o,a){const r=Bag.getItemByItemId(a);r&&Inventory.addItemDivToInv(r,!0)})},TWDB.Util.addCss(`div#CC_pin_items{background-image:url("${Images.pinItems}");background-position:top;width:34px;height:36px;position:absolute;left:0!important}div#CC_pin_items.pinact{background-position:bottom}div.actions:has(.bag_resize) div#CC_pin_items{left:34px!important;position:absolute!important}`,"pinning")}catch(e){ErrorModule.report(e,Language._("errors.inventory_additems_pin"))}},_self.injectInventoryAddItemDivToInvPinItems=function(){try{Inventory.__CCPI__addItemDivToInv=Inventory.__CCPI__addItemDivToInv||Inventory.addItemDivToInv,Inventory.addItemDivToInv=function(...e){const[t,n]=e;if(TWDB.Settings.itemPinningMode||n){const o=TWDB.Settings.get("pinnedItems")||[],a=t.getId(),r=$("<div>").append(t.getMainDiv().data("itemId",t.getId()));r.find("img").off("click").click(TWDB.Settings.itemPinningMode?function(i){const l=o.indexOf(a);if(0>l){if(o.length>=Inventory.latestSize)return;o.push(a)}else o.splice(l,1);$(this).parent().parent().toggleClass("opacity05"),TWDB.Settings.set("pinnedItems",o)}:function(i){Inventory.clickHandler(t.getId(),i)}),TWDB.Settings.itemPinningMode?r.addClass(0>o.indexOf(a)?"opacity05":""):r.find("img").setDraggable(Inventory.announceDragStart,Inventory.announceDragStop),n?(r.addClass("pinned").prependTo($("#bag",Inventory.DOM)),$("#bag > div:empty",Inventory.DOM).remove(),$("#bag > div").length>Inventory.latestSize&&$("#bag > div:not(.pinned):first",Inventory.DOM).detach()):r.appendTo($("#bag",Inventory.DOM))}else Inventory.__CCPI__addItemDivToInv.apply(this,e)},TWDB.Util.addCss(`#bag>.pinned>.item{background:rgba(134,93,39,0.4) url("${Images.pinMini}") -1px -1px no-repeat;border-radius:4px;-webkit-box-shadow:inset 0 0 2px 1px #852;-moz-box-shadow:inset 0 0 2px 1px #852;box-shadow:inset 0 0 2px 1px #852}#bag>.pinned>.item span.count{bottom:-1px;left:1px}#bag>.pinned>.item span.usable{right:-1px}#bag>.pinned>.item span.item_level{opacity:0.4;top:1px;left:initial;right:1px;background-color:rgba(0,0,0,0)}#bag>.pinned>.item span.cooldown{top:2px;left:15px}`,"pinning")}catch(e){ErrorModule.report(e,Language._("errors.inventory_additemdiv_pin"))}},_self.injectTelegramWindowAppendTelegramDisplaySource=function(){try{if(TelegramWindow.__CCDTS__appendTelegram=TelegramWindow.__CCDTS__appendTelegram||TelegramWindow.appendTelegram,TelegramWindow.appendTelegram=function(...e){TelegramWindow.__CCDTS__appendTelegram.apply(this,e);const[t,n]=e,o=n.contentPane instanceof jQuery?n.contentPane[0]:n.contentPane;if(!o)return;const a=o.querySelectorAll(".telegram-head");if(a.length===0)return;const r=a[a.length-1],i=r.querySelector(".author");if(!i)return;Object.assign(i.style,{left:"81px",width:"140px",background:"url(/images/window/messages/post-head.jpg) -16px 0"});const l=document.createElement("div");l.className="telegram-source",l.title=Language._("misc.telegram_toggle_tooltip");const v=document.createElement("div");v.textContent="BB",l.appendChild(v),l.addEventListener("click",function(){const d=l.classList.toggle("active"),p=r.nextElementSibling;if(p)if(d){const c=t.text.replace(/<(\/?(b|i|u|del))>/g,"[$1]").replace(/<a href="[^"]+PlayerProfileWindow[^"]+">([^<]+)<\/a>/g,"[player]$1[/player]").replace(/<a href="[^"]+TownWindow[^"]+">([^<]+)<\/a>/g,"[town]$1[/town]").replace(/<a href="[^"]+FortWindow[^"]+">([^<]+)<\/a>/g,"[fort]$1[/fort]").replace(/<a href="[^"]+AllianceWindow[^"]+">([^<]+)<\/a>/g,"[alliance]$1[/alliance]").replace(/<a class="external_link" href="[^=]+=redirect[^=]+=([^"]+)" target="_blank">([^<]+)<\/a>/g,(b,u,g)=>`[url=${decodeURIComponent(u)}]${g}[/url]`).replace(/<a class="public_report_link" href="[^"]+ReportWindow\.open\((\d+), '([0-9a-f]+)'\);">([^<]+)<\/a>/g,(b,u,g,h)=>`[report=${u}${g}]${h.replace(/^\[|\]$/g,"")}[/report]`);p.innerHTML=c}else p.innerHTML=Game.TextHandler.parse(t.text)}),i.parentNode.insertBefore(l,i)},!document.getElementById("telegram-source-style")){const e=document.createElement("style");e.id="telegram-source-style",e.textContent=".telegram-source {position: absolute; width: 24px; height: 24px; cursor: pointer; background: url(/images/window/messages/icons.png) 72px -3px; left: 52px;}.telegram-source div {display: inline-block; width: 14px; height: 11px; color: white; background: #523F30; font-size: 10px; margin: 4px; padding: 0 0 5px 2px; line-height: 16px; font-family: Impact, sans-serif; font-weight: 300;}.telegram-source.active div {background: blue;}",document.head.appendChild(e)}}catch(e){ErrorModule.report(e,Language._("errors.telegram_append","Error manipulating TelegramWindow.appendTelegram"))}},_self.injectWanderingTraderSellDialog=function(){try{west.window.shop.view.__proto__.I=west.window.shop.view.__proto__.showSellDialog,west.window.shop.view.__proto__.showSellDialog=function(e,...t){var n,o,a=this.getController(),r=Bag.getItemByItemId(e),i=r.count;this.I.call(this,e,...t),3>i||(n=$("div.tw2gui_dialog").has(`div.textart_title:contains(${r.getName()})`)).length===1&&(o=`Max-1 (${--i}x = $ ${i*r.getSellPrice()})`,n.children("div.tw2gui_dialog_actions").prepend(new west.gui.Button(o,function(){a.requestSell({inv_id:r.inv_id,count:i}),n.find("div.tw2gui_button").last().click()}.bind(this)).getMainDiv()))}}catch(e){ErrorModule.report(e,"manipulate .showSellDialog (wandering trader - sell all but one)")}},_self.MenuButton=function(e,t,n){var o=n||function(){},a=$(`<div class="menulink" title="${t}">`).css({"background-image":`url(${e})`,"background-repeat":"no-repeat","background-position":"0px 0px"}),r={obj:a,setOnClick:function(i){o=i}};return a.on("mouseenter",function(){a.css("background-position","-25px 0px")}).on("mouseleave",function(){a.css("background-position","0px 0px")}).on("click",function(i){o&&o(r,i)}),$("#TWDB_ClothCalc_menubuttons").append(a),r},_self})($);Debugger.GameInject=GameInject;const Quests=(function(e){let t={};t=Loader.add("Quests","tw-db Quests",function(){if(!t.ready)try{Settings.get("quest_cancel",!0)&&n(),t.ready=!0}catch(o){ErrorModule.report(o,Language._("errors.quests_initialize"))}},{Settings:!0});const n=function(){try{var o=QuestWindow.cancelQuest;QuestWindow.cancelQuest=function(a){new west.gui.Dialog(Language._("common.cancel_quest_title"),Language._("common.cancel_quest_message")).setIcon(west.gui.Dialog.SYS_QUESTION).setModal(!0,!1,{bg:Game.cdnURL+"/images/curtain_bg.png",opacity:.4}).addButton(Language._("common.yes"),function(){o(a)}).addButton(Language._("common.no"),function(){}).show()}}catch(a){ErrorModule.report(a,Language._("errors.quests_inject_cancel_dialog"))}};return{}})();Debugger.Quests=Quests;const DuelMotivation=(function(e){let t={},n=null,o=null,a=null,r=null,i=0,l="",v=0,d="",p=!1;const c=function(_,k,T,C,f){try{_===void 0&&(_=""),k===void 0&&(k=!1),T===void 0&&(T=!1),C===void 0&&(C=!1),C?o.fadeTo(400,1,function(){c(_,k,T,!1),f&&f(),o.fadeTo(400,0)}):(typeof T=="string"&&n.attr("class",T),n.text(_),typeof k=="string"&&o.addMousePopup(k))}catch(L){ErrorModule.report(L,Language._("errors.duel_update_display"))}},b=function(){try{if(a===Character.duelProtection)return;a=Character.duelProtection,Character.getDuelProtection(!0)>new ServerDate().getTime()?g():i>0?r=666:u()}catch(_){ErrorModule.report(_,Language._("errors.duel_update_protection"))}},u=function(_){try{if(r===Character.duelMotivation||i>0)return;r=Character.duelMotivation;var k=Math.round(100*Character.duelMotivation);c(k+"%",`${Language._("duel.motivation")}: ${k}%`,_?"duelmot_dim":"")}catch(T){ErrorModule.report(T,Language._("errors.duel_update_motivation"))}},g=function(_){try{v&&w.clearInterval(v);var k=new ServerDate().getTime(),T=Character.getMandatoryDuelProtection(!0),C=Character.getDuelProtection(!0);l=`<div style='text-align:center;'>${Language._("duel.ko_time")}<br />`,p||k>=T||_?(i=parseInt((C-k)/1e3,10),d="getDuelProtection"):(l+=Language._("duel.ko_suspension",{time:new Date(T).toLocaleString()})+"<br />",i=parseInt((T-k)/1e3,10),d="getMandatoryDuelProtection"),i=Math.max(0,i),l+=Language._("duel.ko_protection",{time:new Date(C).toLocaleString()})+"<br />",c(i.formatDuration(),l,d==="getDuelProtection"?"duelmot_protect":"duelmot_ko",!0),o.addClass("koblink").click(function(){o.removeClass("koblink").stop(!0,!1).css({opacity:0})}),v=w.setInterval(function(){h()},1e3)}catch(f){ErrorModule.report(f,Language._("errors.duel_update_protection_timer"))}},h=function(){try{if(i>0)return i%180==0?i=parseInt((Character[d](!0)-new ServerDate().getTime())/1e3,10)||0:i--,i>0&&r!==666?(c(i.formatDuration()),1800>=i&&o.hasClass("koblink")&&i%8==0&&o.fadeTo(500,.5).fadeTo(500,0),void 0):(w.clearInterval(v),o.stop(!0,!0),i=0,d==="getDuelProtection"||r===666?(r=null,c("","","",!0,u)):g(!0));r=null,u()}catch(_){ErrorModule.report(_,Language._("errors.duel_update_motivation_bar"))}};return t=Loader.add("DuelMotivation","tw-db DuelMotivation",function(){if(!t.ready)try{if(!Settings.get("duel_motivation",!1))return t.ready=!0,void 0;Character.setDuelProtection.toString().search("duelprotection_changed")===-1?(Character.twdb_setDuelProtection=Character.setDuelProtection,Character.setDuelProtection=function(_,...k){_===0&&(_=1);var T=_!==Character.duelProtection;Character.twdb_setDuelProtection.call(this,_,...k),T&&EventHandler.signal("duelprotection_changed",[])}):TWDB.script.isDev()&&new UserMessage(Language._("duel.setDuelProtection_changed")).show(),TWDB.Util.addCss(`div#ui_character_container .twdb_charcont_ext{background-image:${e("#ui_character_container").css("background-image")};background-repeat:no-repeat;background-position:bottom left;width:143px;height:15px;position:absolute;left:0;top:173px;padding-top:2px}div#ui_character_container #duelmot_bar{background-image:url(${TWDB.images.duelMotBar});background-repeat:no-repeat;background-position:0 -26px;top:2px;left:3px;height:13px;width:137px;position:absolute;color:#FFF;text-align:center;font-size:8pt;line-height:12px;font-weight:bold;text-shadow:1px 0 1px #000,-1px 0 1px #000}div#ui_character_container .duelmot_ko{background-position:0 -13px!important}div#ui_character_container .duelmot_protect{background-position:0 0!important}div#ui_character_container .duelmot_warn{background-position:0 0;top:2px;left:3px;opacity:0}div#ui_character_container .duelmot_dim{opacity:0.6}`,"duelmot"),p=Game.duelProtectionEarly===Game.duelProtectionHours,(function(){try{e("#ui_character_container").css({"background-repeat":"no-repeat",height:"191px"}),e(".energy_add").css({top:"161px"});var _=e('<div class="twdb_charcont_ext" />').insertBefore(".energy_bar");n=e('<div id="duelmot_bar" class="duelmot_dim" />').appendTo(_),o=e('<div class="status_bar duelmot_warn" />').appendTo(_)}catch(k){ErrorModule.report(k,Language._("errors.duel_create_ui"))}})(),EventHandler.listen("duelprotection_changed",function(){b()}),EventHandler.listen("duelmotivation_changed",function(){u()}),b(),u(!0),Character.homeTown.town_id!==0&&Ajax.remoteCallMode("building_saloon","get_data",{town_id:Character.homeTown.town_id},function(_){if(_.error)return new UserMessage(_.msg).show();Character.setDuelMotivation(_.motivation)}),t.ready=!0}catch(_){ErrorModule.report(_,Language._("errors.duel_initialize"))}},{Settings:!0}),{}})($);Debugger.DuelMotivation=DuelMotivation;const Bank=(function(e){let t=!0,n={};n=Loader.add("Bank","tw-db Bank",function(){if(!n.ready)try{Settings.get("auto_deposit",!1)&&(EventHandler.listen("position_change",function(){r()}),r()),Settings.get("deposit",!0)&&o(),n.ready=!0}catch(l){ErrorModule.report(l,Language._("errors.bank_initialize"))}},{Settings:!0});const o=function(){try{if(!Images.buttonBank)return waitForImages("buttonBank",o),void 0;GameInject.CharacterButton.add(Images.buttonBank).click(function(){a()}).addMousePopup(Language._("banking.deposit_money"))}catch(l){ErrorModule.report(l,Language._("errors.bank_add_button"))}},a=function(){try{new west.gui.Dialog(Language._("banking.deposit_money"),e(`<span class='twdb_banking'>${Language._("banking.money")}: ${w.Character.money}</span>`)).setIcon(west.gui.Dialog.SYS_QUESTION).setModal(!0,!1).addButton(Language._("common.yes"),function(){i(1)}).addButton(Language._("common.no")).show()}catch(l){ErrorModule.report(l,Language._("errors.bank_show_deposit_dialog"))}},r=function(){try{if(w.Character.homeTown.town_id===0||10>=w.Character.money)return t=!0,void 0;w.Character.position.x===w.Character.homeTown.x&&w.Character.position.y===w.Character.homeTown.y?t&&(t=!1,new west.gui.Dialog(Language._("banking.deposit_money"),e(`<span class='twdb_banking'>${Language._("banking.deposit_message")}<br />${Language._("banking.money")}: ${w.Character.money}</span>`)).setIcon(west.gui.Dialog.SYS_QUESTION).setModal(!0,!1).addButton(Language._("common.yes"),function(){t=!0,i(w.Character.homeTown.town_id)}).addButton(Language._("common.no")).show()):t=!0}catch(l){ErrorModule.report(l,Language._("errors.bank_auto_deposit"))}},i=function(l){try{if(0>=w.Character.money)return;w.BankWindow.townid=l,w.BankWindow.DOM=new west.gui.Textfield("tb_balance_input_"+w.BankWindow.townid).setSize(10).setValue(w.Character.money).getMainDiv(),w.BankWindow.Balance.add()}catch(v){ErrorModule.report(v,Language._("errors.bank_perform_deposit"))}};return{}})($);Debugger.Bank=Bank;const Market=(function(e){let t=!1,n={},o={};o=Loader.add("Market","tw-db Market",function(){if(!o.ready)try{Settings.get("market_map",!1)&&(GameInject.addTabOnMarketWindow(Language._("market.map_tab_title"),"marketmap",function(){v()}),TWDB.Util.addCss(".twdb_mmap_point{width:7px;height:7px;background-color:#F00;position:absolute;border:1px solid #000;border-radius:5px}")),Settings.get("market_reminder",!0)&&(GameInject.MarketOfferTable(function(g){a(g)}),GameInject.MarketWatchlistTable(function(g){r(g)}),l.init()),o.ready=!0}catch(g){ErrorModule.report(g,Language._("errors.market_initialize"))}},{Settings:!0});const a=function(g){try{for(var h=0;h<g.length;h++){var _=g[h],k=e('<div class="mpo_alert" />');e(MarketWindow.offerTable.getMainDiv()).children().find(".marketBidsData_"+_.market_offer_id).append(k),_.isFinished||k.append(i(_))}}catch(T){ErrorModule.report(T,Language._("errors.market_process_offer_list"))}},r=function(g){try{for(let k=0;k<g.length;k++){var h=g[k],_=e('<div class="mpo_alert" />');e(MarketWindow.watchlistTable.getMainDiv()).children().find(".marketWatchData_"+h.market_offer_id).append(_),h.isFinished||_.append(i(h))}}catch(k){ErrorModule.report(k,Language._("errors.market_process_watchlist"))}},i=function(g){try{var h=e(`<img src="${Images.iconAlarm}" />`).css({cursor:"pointer"});return h.click((_=g,k=h,function(){l.create(_,k)})),l.exists(g.market_offer_id)===!1&&h.css("opacity",.5),h}catch(T){return ErrorModule.report(T,Language._("errors.market_create_reminder_icon")),e()}var _,k},l=(function(g){const h={};let _={};h.init=function(){try{var f=Cache.load("marketreminder");isDefined(f)&&(_=f);for(const L in _)k(L)}catch(L){ErrorModule.report(L,Language._("errors.market_reminder_init"))}},h.exists=function(f){return isDefined(_[f])};const k=function(f){try{var L=_[f],D=Math.max(1e3*L.ends-Date.now()-6e4*L.reminder,100);L.timer=setTimeout((E=f,function(){C(E)}),D)}catch(O){ErrorModule.report(O,Language._("errors.market_schedule_reminder"))}var E},T=function(f){try{delete _[f],Cache.save("marketreminder",_)}catch(L){ErrorModule.report(L,Language._("errors.market_delete_reminder"))}},C=function(f){try{var L=_[f],D=ItemManager.get(L.item),E=new OnGoingEntry;E.init(),E.setTooltip(`${Language._("market.auction_label")}${D.name}${Language._("market.auction_ends")}${(+(L.ends-Date.now()/1e3)).getTimeString4Timestamp()}`),E.setImage(g(`<img src="${Images.notiBell}" />`)),WestUi.NotiBar.add(E),TitleTicker.setNotifyMessage(`${Language._("market.auction_label")}${D.name}${Language._("market.auction_ends")}${(+(L.ends-Date.now()/1e3)).getTimeString4Timestamp()}`),AudioController.play(AudioController.SOUND_NEWMSG),T(f)}catch(O){ErrorModule.report(O,Language._("errors.market_trigger_reminder"))}};return h.create=function(f,L){try{var D=g("<div />").append(`<span style="position:relative; width:100%;display:block;">${Language._("market.auction_ends_label")}${f.auction_ends_in.getTimeString4Timestamp()}</span>`),E=new west.gui.Textfield("twdb_analyzer_last").maxlength(4).onlyNumeric().setLabel(Language._("market.reminder_before_expiry")).setPlaceholder(Language._("market.reminder_minutes"));D.append(E.getMainDiv()),h.exists(f.market_offer_id)?(E.setValue(_[f.market_offer_id].reminder),L.css("opacity",1)):L.css("opacity",.5);var O=new west.gui.Dialog(Language._("market.reminder_title"),D).setIcon(west.gui.Dialog.SYS_QUESTION).setModal(!0,!1,{bg:w.Game.cdnURL+"/images/curtain_bg.png",opacity:.4}).addButton(Language._("common.ok"),function(){L.css("opacity",1),(function(W,P,B){try{var m=parseInt(P.getValue(),10);if(Number.isNaN(m)||1>m)return h.create(W,B),void 0;if(Date.now()/1e3+60*m>=W.auction_end_date)return new UserMessage(Language._("market.reminder_toolate")).show(),h.create(W,B),void 0;h.exists(W.market_offer_id)&&(clearTimeout(_[W.market_offer_id].timer),delete _[W.market_offer_id].timer),_[W.market_offer_id]={ends:W.auction_end_date,reminder:m,id:W.market_offer_id,item:W.item_id},Cache.save("marketreminder",_),k(W.market_offer_id)}catch(A){ErrorModule.report(A,Language._("errors.market_save_reminder"))}})(f,E,L)});h.exists(f.market_offer_id)&&O.addButton(Language._("common.delete"),function(){T(f.market_offer_id),L.css("opacity",.5)}),O.addButton(Language._("common.cancel"),function(){}).show()}catch(W){ErrorModule.report(W,Language._("errors.market_create_reminder"))}},h})(e),v=function(){try{window.MarketWindow.window.showLoader(),window.MarketWindow.window.setTitle(Language._("market.map_title")).setSize(840,655).addClass("premium-buy");var g=-111,h=-1,_=e('<div style="position:relative;display:block;margin:10px 9px 10px 9px;width:770px;height:338px;" />');for(let T=1;16>T;T++){T===8&&(h+=169,g=-111);var k=e(`<img style="position:absolute;border:1px solid #000;width:110px;height:169px;left:${g+=110}px;top:${h}px;" src="${Game.cdnURL}/images/map/minimap/county_${T}.jpg" />`);T===4?k.css({height:"114px"}):T===11?k.css({height:"114px",top:h+55+"px"}):T===15&&k.css({height:"108px",width:"109px",left:"329px",top:"114px"}),_.append(k)}t=e("<div />").append(_),e(MarketWindow.window.getContentPane()).find(".marketplace-marketmap").children().remove(),e(MarketWindow.window.getContentPane()).find(".marketplace-marketmap").append(t),n={},p(),window.MarketWindow.window.hideLoader()}catch(T){ErrorModule.report(T,Language._("errors.market_render_map"))}},d=function(g,h,_,k,T,C,f){try{isDefined(n[g])||(n[g]={name:h,town_id:g,x:_,y:k,count:0,offers_end:{},offers_unend:{},money:0,distance:window.GameMap.calcWayTime(window.Character.position,{x:_,y:k}).formatDuration()});var L=n[g];T!==""&&(isDefined(L.offers_end[T.item_id])?L.offers_end[T.item_id].count+=T.count:(L.count++,L.offers_end[T.item_id]=T)),C!==""&&(isDefined(L.offers_unend[C.item_id])?L.offers_unend[C.item_id].count+=C.count:(L.count++,L.offers_unend[C.item_id]=C)),f!==0&&(L.money+=f)}catch(D){ErrorModule.report(D,Language._("errors.market_process_offer_data"))}},p=function(){try{Ajax.remoteCall("building_market","fetch_bids",{},function(g){if(g.error)return new UserMessage(g.msg,UserMessage.TYPE_ERROR).show();const h=g.msg.search_result;for(let _=0;_<h.length;_++){let k,T;0>h[_].auction_ends_in||h[_].current_bid===h[_].max_price?(k={item_id:h[_].item_id,count:parseFloat(h[_].item_count)},T=""):(T={item_id:h[_].item_id,count:parseFloat(h[_].item_count)},k=""),d(h[_].market_town_id,h[_].market_town_name,h[_].market_town_x,h[_].market_town_y,k,T,0)}c()})}catch(g){ErrorModule.report(g,Language._("errors.market_fetch_bids"))}},c=function(){try{Ajax.remoteCall("building_market","fetch_offers",{page:0},function(g){if(g.error)return new UserMessage(g.msg,UserMessage.TYPE_ERROR).show();const h=g.msg.search_result;for(let _=0;_<h.length;_++){let k="";0>h[_].auction_ends_in&&!h[_].current_bid&&(k={item_id:h[_].item_id,count:parseFloat(h[_].item_count)}),d(h[_].market_town_id,h[_].market_town_name,h[_].market_town_x,h[_].market_town_y,k,"",h[_].current_bid)}b()})}catch(g){ErrorModule.report(g,Language._("errors.market_fetch_offers"))}},b=function(){try{for(const _ in n){var g=n[_],h=`<div style="max-width: 305px;"><b>${g.name}</b>${g.money===0?"":` ${g.money}$`}<br/>`;let k,T=0;for(const f in g.offers_end){if(T++,T>19){h+=" ... ";break}k=g.offers_end[f],g.offers_end[f]!==0&&(h+=`<div class="item item_inventory"><img width="53" height="53" src="${ItemManager.get(f).image}" class="tw_item item_inventory_img dnd_draggable dnd_dragElem" style="margin-left:3px;margin-top:4px;"><span class="count" style="display: block;"><p>${k.count}</p></span></div>`)}for(const f in g.offers_unend){if(T++,T>19){h+=" ... ";break}k=g.offers_unend[f],g.offers_unend[f]!==0&&(h+=`<div style="opacity:0.35" class="item item_inventory"><img width="53" height="53" src="${ItemManager.get(f).image}" class="tw_item item_inventory_img dnd_draggable dnd_dragElem" style="margin-left:3px;margin-top:4px;"><span class="count" style="display: block;"><p>${k.count}</p></span></div>`)}h+="</div>";const C=e("<div />").css({left:g.x/(181*window.GameMap.tileSize)*770-5+"px",top:g.y/(79*window.GameMap.tileSize)*338-5+"px"}).attr({class:"twdb_mmap_point",id:_,title:h}).click((function(f){return function(){TownWindow.open(f.x,f.y)}})(g));t.append(C)}e(`<img src='${to_cdn("images/map/minimap/icons/miniicon_pos.png")}' />`).css({left:Character.position.x/(181*window.GameMap.tileSize)*770-8+"px",top:Character.position.y/(79*window.GameMap.tileSize)*338-8+"px",width:"16px",height:"16px"}).attr({class:"mmap_mappoint",id:"mmap_icon_pos",title:Language._("map.your_position")}).appendTo(t),u()}catch(_){ErrorModule.report(_,Language._("errors.market_render_markers"))}},u=function(){try{const g=[];let h,_;for(h in n)g.push({id:h,distance:n[h].distance});g.sort(function(T,C){return T.distance===C.distance?0:T.distance>C.distance?1:-1}),_="";for(let T=0;T<g.length;T++){const C=n[g[T].id];_+=`<div><a onclick="TownWindow.open(${C.x}, ${C.y});">${C.name}</a> <a title="${Language._("map.show_town_tooltip")}" onclick="GameMap.center(${C.x}, ${C.y})"><img src="${Game.cdnURL}/images/icons/center.png" /></a> ${Language._("fort.distance")}${C.distance} <a title="${Language._("town.move_tooltip")}" onclick="TaskQueue.add(new TaskWalk(${C.town_id},'town'))"><img src="${Game.cdnURL}/images/map/icons/instantwork.png"></a>${C.money===0?"":` ${C.money}$`}<br />`;for(const f in C.offers_end){const L=C.offers_end[f];C.offers_end[f]!==0&&(_+=`<div class="item item_inventory" title="${new ItemPopup(ItemManager.get(f)).getXHTML().escapeHTML()}"><img width="53" height="53" src="${ItemManager.get(f).image}" class="tw_item item_inventory_img dnd_draggable dnd_dragElem" style="margin-left:3px;margin-top:4px;"><span class="count" style="display: block;"><p>${L.count}</p></span></div>`)}for(const f in C.offers_unend){const L=C.offers_unend[f];C.offers_unend[f]!==0&&(_+=`<div style="opacity:0.35" class="item item_inventory" title="${new ItemPopup(ItemManager.get(f)).getXHTML().escapeHTML()}"><img width="53" height="53" src="${ItemManager.get(f).image}" class="tw_item item_inventory_img dnd_draggable dnd_dragElem" style="margin-left:3px;margin-top:4px;"><span class="count" style="display: block;"><p>${L.count}</p></span></div>`)}_+="</div>";for(let f=0;f<=(C.count-C.count%12)/12;f++)_+=C.count===0?"<br/>":"<br/><br/><br/><br/>"}const k=new west.gui.Scrollpane;e(k.getMainDiv()).css({height:"200px","margin-left":"8px"}),k.appendContent(_),t.append(k.getMainDiv())}catch(g){ErrorModule.report(g,Language._("errors.market_create_town_list"))}window.MarketWindow.window.hideLoader()};return{}})($);Debugger.Market=Market;const Fort=(function($){const _self={};let loader={};const battleStats={},initializeFortModule=function(){if(!loader.ready)try{Settings.get("enhanced_fort_recruitment",!0)&&enhanceFortRecruitment(),Settings.get("declare_report",!0)&&declareShowFort(),Settings.get("owned_forts_tab",!1)&&ownedForts(),Settings.get("cemetery_critical",!1)&&setupCemeteryCritHits(),Settings.get("total_dmg_battle",!1)&&calculateTotalDamage(),Settings.get("battle_info_round",!1)&&battleInfoPerRound(),(Settings.get("total_dmg_battle",!0)||Settings.get("battle_info_round",!0))&&initBattleInfo(),loader.ready=!0}catch(e){ErrorModule.report(e,Language._("errors.fort_initialize"))}};loader=Loader.add("Fort","tw-db Fort",initializeFortModule,{Settings:!0});const enhanceFortRecruitment=function(){TWDB.Util.addCss(".fortbattle .trows .status{text-align:center}.fortbattle .trows .health_points{width:90px;text-align:center;margin-left:-8px}.fortbattle .tfoot .name,.fortbattle .tfoot .town,.fortbattle .tfoot .class{width:100px;position:relative;top:10px;margin-right:10px}.fortbattle .tfoot .name{text-align:left;width:75px;margin:0 -5px 0 5px}.fort_battle_recruitlist span.tw2gui_textfield{position:relative;top:10px}.fortbattle .trows .health_points p{font-size:13px!important}.cell_3.class{margin-left:-15px;margin-right:8px}.cell_4 .sort-class{margin-left:-8px}.cell_5 .sort-status{margin-left:-20px}.cell_6 .sort-health_points{text-align:center;width:90px;display:inline-block;margin-left:-12px}.fortbattle .trows .cell_3.class{text-align:right}");try{if(window.gradeValues={TRAITOR:"-2",RESERVIST:"-1",RECRUIT:"0",PRIVATE:"1",SERGEANT:"2",CAPTAIN:"3",MAJOR_GENERAL:"4",GENERAL:"5"},window.gradeNames={"-2":"traitor","-1":"reservist",0:"recruit",1:"private",2:"sergeant",3:"captain",4:"major_general",5:"general"},window.getGradeImg=function(e,t,n,o){try{return`<img class="${n||""}" src="${window.Game.cdnURL}/images/chat/servicegrade_${gradeNames[e]}.png" title="${t?window.Chat.rankTitles[gradeNames[e]].escapeHTML():""}${isDefined(o)&&o!==""?` (${o})`:""}" />`}catch(a){ErrorModule.report(a,Language._("errors.fort_get_grade_img"))}},!window.FortBattleWindow)return;[["updateRecruitlist",!0,[[/totalCnt\s{0,1}=\s{0,1}0;/,"totalCnt=0, totalCntTotal=0, gradeCountTotal={ '-2':0, '-1':0, '0':0, '1':0, '2':0, '3':0, '4':0, '5':0 };"],[/gradeCount\[g\]/,`'<span style="font-size:15px;"><span style="font-weight:700;text-align:center;width:45px;display:inline-block;margin-left:-10px;top:2px;position:relative;color:'+(gradeCount[g]===gradeCountTotal[g]?(gradeCount[g]>0?'forestgreen':'lightslategray'):'crimson')+';">'+gradeCount[g]+'</span></span>'`],[/\+\s{0,1}totalCnt\s{0,1}\+/,"+totalCnt+' ['+totalCntTotal+']'+"],[/if\(this\.preBattle\.isHidden\(list\[i\]\['class'\], ?'rank_' ?\+ ?priv\)\)/,"totalCntTotal++;gradeCountTotal[priv]++;if(this.preBattle.isHidden(list[i]['class'],'rank_'+priv,list[i].coords.x,list[i].coords.y))"],[/getGradeImg\(priv, ?true, ?'recruitplayer recruitplayer-'\+ ?i\)/,"getGradeImg(priv,true,'recruitplayer recruitplayer-'+i,list[i].officername||'')"],[/\.addColumns\(\s*\[\s*'count'\s*,\s*'name'\s*,\s*'town'\s*,\s*'rank'\s*,\s*'class'\s*,\s*'status'\s*,\s*'evaluated'\s*\]\s*\)/,".addColumns(['count','name','town','rank','class','status','health_points'])"],[/\.appendToThCell\(\s*'head'\s*,\s*'evaluated'\s*,[\s\S]*?\);/,`.appendToThCell('head','health_points','${Language._("fort.sort_by_health")}','<span class="sort sort-health_points">${Language._("fort.health_points")}</span>');`],[/evaluated\s*:\s*list\[i\]\.officername\s*\|\|\s*''/,`health_points:'<p style="font-weight:700;color:'+((this.preBattle.battleData.fortCoords.x-list[i].coords.x==0&&this.preBattle.battleData.fortCoords.y-list[i].coords.y==0)?'rgb(0,153,0)':((Math.abs(this.preBattle.battleData.fortCoords.x-list[i].coords.x)<=500&&Math.abs(this.preBattle.battleData.fortCoords.y-list[i].coords.y)<=500)?'rgb(255,119,0)':'rgb(255,0,0)'))+'">'+(list[i].currhealth===list[i].maxhealth?format_number(list[i].maxhealth):format_number(list[i].currhealth)+'&boxv;'+format_number(list[i].maxhealth))+'</p>'`]]],["recruitListClick",!1,[[/pp ?< ?ownPriv/,"pp<ownPriv&&ownPriv>gv.SERGEANT"],[/var hidden ?= ?function\(classKey, ?privKey\) ?{ ?return that\.preBattle\.isHidden\(classKey, ?'rank_'\+ ?privKey\); ?};/,"{var hidden=function(classKey,privKey,location){return that.preBattle.isHidden(classKey,'rank_'+privKey,null,null,location);};}"],[/return ?{message: ?sorting, ?title: ?title};/,`else if(key=='health_points'){title='${Language._("fort.sort_by_health")}';sorting.append(getSortLink('${Language._("fort.sort_asc_current_health")}','>currhealth'));sorting.append(getSortLink('${Language._("fort.sort_desc_current_health")}','<currhealth'));sorting.append(getSortLink('${Language._("fort.sort_asc_max_health")}','>maxhealth'));sorting.append(getSortLink('${Language._("fort.sort_desc_max_health")}','<maxhealth'));sorting.append('<br />');sorting.append(getSortLink('${Language._("fort.sort_asc_distance")}','>distance'));sorting.append(getSortLink('${Language._("fort.sort_desc_distance")}','<distance'));sorting.append(getVisLink(hidden(null,'-3','atfort')?'${Language._("fort.show_players_at_fort")}':'${Language._("fort.hide_players_at_fort")}','atfort'));sorting.append(getVisLink(hidden(null,'-3','nearbyfort')?'${Language._("fort.show_players_near_fort")}':'${Language._("fort.hide_players_near_fort")}','nearbyfort'));sorting.append(getVisLink(hidden(null,'-3','notatfort')?'${Language._("fort.show_players_away_fort")}':'${Language._("fort.hide_players_away_fort")}','notatfort'));}return{message:sorting,title:title};`]]]].forEach(([e,t,n])=>{const o=window.FortBattleWindow[e];if(!o||o.S)return;let a=o+"";n.forEach(([i,l])=>{a=a.replace(i,l)});const r=Function("return "+(t?`(function(){var lastStamp;return ${a}})();`:`(function(){return ${a}})();`))();window.FortBattleWindow[e]=function(...i){const l=r.apply(this,i);if(e==="updateRecruitlist")try{const v=this.infoareaEl?.[0],d=TWDB.Util.query(".cell_4 .sort-class",v),p=TWDB.Util.query(".cell_5 .sort-status",v);d&&(d.textContent=Language._("fort.category")),p&&(p.innerHTML=`<img src="${window.Game.cdnURL}/images/chat/servicegrade_general.png" alt="${Language._("fort.rank")}" style="pointer-events:none;">`)}catch{}return l},window.FortBattleWindow[e].S=!0,window.FortBattleWindow[e].__hp_original=o}),PreBattle.recruitSorting.currhealth=function(e,t,n){return n?e.currhealth===t.currhealth:e.currhealth<t.currhealth},PreBattle.recruitSorting.maxhealth=function(e,t,n){return n?e.maxhealth===t.maxhealth:e.maxhealth<t.maxhealth},PreBattle.recruitSorting.distance=function(e,t,n,o,a,r){},PreBattle.isHidden=function(e,t,n,o,a){let r="notatfort";if(a===null){const i=this.battleData.fortCoords.x-n,l=this.battleData.fortCoords.y-o;i===0&&l===0?r="atfort":Math.abs(i)>500||Math.abs(l)>500||(r="nearbyfort")}else a!==null&&(r=a);return e!==void 0&&this.recruitlistVisibility[e]||t!==void 0&&this.recruitlistVisibility[t]||r!==void 0&&this.recruitlistVisibility[r]}}catch(e){ErrorModule.report(e,Language._("errors.fort_enhance_recruitment"))}},declareShowFort=function(){try{ReportWindow.init_content_backup=ReportWindow.init_content,ReportWindow.init_content=function(e){var t,n;ReportWindow.init_content_backup.call(this,e),e.reportType==="fortbattle"&&e.reportInfo.subtype==="declare"&&(t=e.reportInfo.fortname,n=e.report_id,Ajax.remoteCall("fort_overview","search_fort",{fortNames:t},function(o){if(o&&!o.error)for(const r in o){var a=o[r];if(a&&a.name===t){$(`#rp_report-${n} .fort_muster a:first-child`).replaceWith(`<a href="javascript:void(FortWindow.open(${a.fort_id}, ${a.fort_x}, ${a.fort_y}));">${a.name}</a>`);break}}}))}}catch(e){ErrorModule.report(e,Language._("errors.fort_declare_show"))}},ownedForts=function(){try{const e={},t={forts:Language._("fort.forts"),fort_size:Language._("fort.size"),fort_sizes:Language._("fort.sizes")};$(document).on("click",".tow_profileheader img",function(){var a=$(this).closest(".tw2gui_window"),r=a.find(".imagemap_cityhall").attr("onclick");if(r){var i=/CityhallWindow\.open\((.*)?\); return false;/.exec(r);if(i){var l=parseInt(i[1],10),v=this===a.find('.tow_profileheader img[src*="fort_mini_icon"]').get(0)?"owned":"members";e[l]?o(l,v):Ajax.get("map","get_minimap",{},function(d){n(d),e[l]&&o(l,v)})}}}),document.styleSheets[0].insertRule(".twdb-forts-container .fortname {width:75%;}"),document.styleSheets[0].insertRule(".twdb-forts-container .fortsize {width:25%;text-align:center;}"),document.styleSheets[0].insertRule('.tow_profileheader img[src*="fort_mini_icon"] {cursor:pointer;}');const n=function(a){for(const d in a.forts)for(const p in a.forts[d]){var r=a.forts[d][p];if(r.fort){var i=r.fort.town_id,l=r.townIds||[],v={type:r.fort.type,id:r.fort.fort_id,x:r.fort.x,y:r.fort.y,name:r.fort.name};e[i]||(e[i]={owned:[],members:[]}),e[i].owned.push(v);for(let c=0;c<l.length;c++)e[l[c]]||(e[l[c]]={owned:[],members:[]}),e[l[c]].members.push(v)}}};Ajax.get("map","get_minimap",{},function(a){n(a)});const o=function(a,r){var i=$('<div class="twdb-forts-container" style="height:100%"></div>'),l=new west.gui.Table;l.addColumn("fortname").addColumn("fortsize").appendToCell("head","fortname",t.forts).appendToCell("head","fortsize",t.fort_size);var v=e[a][r];for(let d=0;d<v.length;d++)l.appendRow(),l.appendToCell(d,"fortname",`<div class="anti_wrap"><a onclick="GameMap.center(${v[d].x}, ${v[d].y})" href="#"><img class="fortOverviewIconScroll hasMousePopup" src="images/icons/center.png"></a> <a href="javascript:void(FortWindow.open(${v[d].id},${v[d].x},${v[d].y}));" class="hasMousePopup">${v[d].name}</a></div>`).appendToCell(d,"fortsize",t.fort_sizes[v[d].type]);i.html(l.getMainDiv()),wman.open("twdb-forts-container",null,"twdb-forts-container noreload nocloseall nominimize dontminimize").setTitle(t.forts).setMiniTitle(t.forts).appendToContentPane(i).setSize(340,360)}}catch(e){ErrorModule.report(e,Language._("errors.fort_owned_forts"))}},setupCemeteryCritHits=function(){try{document.styleSheets[0].insertRule(`.cemetery .fancytable .row_head .battle_cri span {background: url("${Images.iconCritical}");height:17px;width:16px;}`),document.styleSheets[0].insertRule(".cemetery .fancytable .battle_cri, .cemetery .fancytable .battle_gho {width:18px;}"),document.styleSheets[0].insertRule(`.cemetery .fancytable .row_head .battle_gho span {background: url("${Images.iconPhantom}");height:17px;width:16px;}`),document.styleSheets[0].insertRule(".cemetery #battle_stat.fancytable div.battle_tow {width:60px!important;}");var patchedInit=CemeteryWindow.showStatInit.toString().replace("$('div.cemetery-content',",`CemeteryWindow.table.addColumn('battle_cri',{sortBy:'crithits'}).addColumn('battle_gho',{sortBy:'playdeadcount'}).appendToThCell('head','battle_cri','${Language._("battle.critical_hits")}','&nbsp;').appendToThCell('head','battle_gho','${Language._("battle.ghost_rounds")}','&nbsp;');sortByObj.sortBy=null;$('div.cemetery-content',`),patchedUpdate=CemeteryWindow.showStatUpdateTable.toString().replace("CemeteryWindow.table.buildRow('battlestat tw_red'","tmpCells['battle_cri']=rd.charclass==1?rd.crithits:'-';tmpCells['battle_gho']=rd.charclass==0?rd.playdeadcount:'-';CemeteryWindow.table.buildRow('battlestat tw_red'").replace("CemeteryWindow.table.buildRow('battlestat tw_blue'","tmpCells['battle_cri']=rd.charclass==1?rd.crithits:'-';tmpCells['battle_gho']=rd.charclass==0?rd.playdeadcount:'-';CemeteryWindow.table.buildRow('battlestat tw_blue'"),sortHelpers="var sortByObj={sortBy:null,orderBy:'ASC'};var startSortDispatcher=function(ev){var sortBy='';sortBy=$(ev.target).closest('div.cell').data('sortBy');if(sortByObj.sortBy==sortBy){sortByObj.orderBy=sortByObj.orderBy=='asc'?'desc':'asc';CemeteryWindow.currentStats.reverse();}else{sortByObj.sortBy=sortBy;sortByObj.orderBy='asc';switch(sortBy){case'name':case'townname':CemeteryWindow.currentStats.sort(sortStrings(sortBy));break;case'ko_shots':CemeteryWindow.currentStats.sort(sortLength(sortBy));break;default:if($.isNumeric(CemeteryWindow.currentStats[0][sortBy])) CemeteryWindow.currentStats.sort(sortNumbers(sortBy));break;}}updatePlayerStatTable(CemeteryWindow.currentStats);};var sortLength=function(col) {return function(a,b) {return b[col].length-a[col].length;};};var sortNumbers=function(col) {return function(a,b) {return b[col]-a[col];};};var sortStrings=function(col) {return function(a,b) {return a[col].toUpperCase().replace(/[À-Ä]/g,'A').replace(/[Ò-Ö]/,'O').replace(/[Ù-Ü]/,'U').replace(/[È-Ë]/,'E')>b[col].toUpperCase().replace(/[À-Ä]/g,'A').replace(/[Ò-Ö]/,'O').replace(/[Ù-Ü]/,'U').replace(/[È-Ë]/,'E')?1:-1;};};var updatePlayerStatTable=function() {CemeteryWindow.table.clearBody();var tmpCells={};for(var i=0;i<CemeteryWindow.currentStats.length;i++) {var rd=CemeteryWindow.currentStats[i];tmpCells['battle_nam']=rd.name;tmpCells['battle_tow']=rd.townname;tmpCells['battle_shp']=rd.starthp;tmpCells['battle_ehp']=rd.finishedhp;tmpCells['battle_fla']=rd.flagholdcount;tmpCells['battle_hco']=rd.hitcount;tmpCells['battle_fco']=rd.misscount;tmpCells['battle_dco']=rd.totalcauseddamage;tmpCells['battle_ohi']=rd.takenhits;tmpCells['battle_ofa']=rd.dodgecount;tmpCells['battle_odm']=rd.takendamage;tmpCells['battle_avd']=rd.avg_damage;tmpCells['battle_okh']=rd.ko_shots.length;tmpCells['battle_onl']=rd.onlinecount;tmpCells['battle_cri']=rd.charclass==1?rd.crithits:'-';tmpCells['battle_gho']=rd.charclass==0?rd.playdeadcount:'-';CemeteryWindow.table.buildRow('battlestat '+(rd.battle_type=='defender'?'tw_blue':'tw_red'),tmpCells,addKoShotTitle(rd.ko_shots));}};var addKoShotTitle=function(koShots){return function(row){if(koShots.length){$('.battle_okh',row).attr('title',koShots.join(', '));} return row;}};";eval(`(function($){CemeteryWindow.showStatInit=${patchedInit};CemeteryWindow.showStatUpdateTable=${patchedUpdate};${sortHelpers}})(jQuery);`)}catch(e){ErrorModule.report(e,Language._("errors.fort_setup_cemetery_crit_hits"))}},calculateTotalDamage=function(){if(typeof FortBattle<"u")try{FortBattle.flashShowCharacterInfo_backup||typeof FortBattle.flashShowCharacterInfo!="function"||(FortBattle.flashShowCharacterInfo_backup=FortBattle.flashShowCharacterInfo,FortBattle.flashShowCharacterInfo=function(...e){FortBattle.flashShowCharacterInfo_backup.apply(FortBattle,e),$("div.recruitlist_name",`#fort_battle_${e[0]}_infoarea`).html(`<span onclick="PlayerProfileWindow.open(${e[1]});" style="cursor:pointer;">${$("div.recruitlist_name").text()}</span>`)}),FortBattle.getCharDataSheet_backup||typeof FortBattle.getCharDataSheet!="function"||(FortBattle.getCharDataSheet_backup=FortBattle.getCharDataSheet,FortBattle.getCharDataSheet=function(e){return`${FortBattle.getCharDataSheet_backup(e)}<div><img src="${Images.iconTotalDMG}" title="${Language._("battle.total_damage_tooltip")}" /> %totalDmg%</div>`})}catch(e){ErrorModule.report(e,Language._("errors.fort_calculate_total_damage"))}},battleInfoPerRound=function(){try{FortBattle.addRoundStatusMessage_backup=FortBattle.addRoundStatusMessage,FortBattle.addRoundStatusMessage=function(e,t){FortBattle.addRoundStatusMessage_backup(e,t),battleStats[e]||(battleStats[e]={hit:0,missed:0,gotshot:0,dodge:0});const n=battleStats[e];for(let o=0;o<t.length;o++){const a=t[o];switch(a.action){case"gotshot":a.damage===0?n.dodge++:n.gotshot++;break;case"shot":a.damage===0?n.missed++:n.hit++}}t.length!==0&&FortBattle.showMessage(e,`<strong>${Language._("battle.stats_total")} | ${Language._("battle.stats_hits")}: </strong>"${n.hit}"<strong> | ${Language._("battle.stats_missed")}: </strong>"${n.missed}"<strong> | ${Language._("battle.stats_gotshot")}: </strong>"${n.gotshot}"<strong> | ${Language._("battle.stats_dodge")}: </strong>"${n.dodge}`)}}catch(e){ErrorModule.report(e,Language._("errors.fort_battle_info_per_round"))}},initBattleInfo=function(){try{FortBattle.addFinishMessage_backup=FortBattle.addFinishMessage,FortBattle.addFinishMessage=function(e,t){FortBattle.addFinishMessage_backup(e,t),battleStats[e]={hit:0,missed:0,gotshot:0,dodge:0}}}catch(e){ErrorModule.report(e,Language._("errors.fort_init_battle_info"))}};return _self})($);Debugger.Fort=Fort;const CCstarter=(function(e){let t={};return t=Loader.add("ClothCalc","tw-db ClothCalc",function(){if(!t.ready)try{ClothCalc.ready=t.ready,ClothCalc.init(),t.ready=!0}catch(n){ErrorModule.report(n,Language._("errors.ccstarter_initialize"))}},{}),{}})();Debugger.CCstarter=CCstarter,w.location.href.indexOf(".the-west.")===-1&&w.location.href.indexOf(".tw.innogames.")===-1||w.location.href.indexOf("game.php")===-1||Loader.init()})(jQuery)}});
