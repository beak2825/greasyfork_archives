// ==UserScript==
// @name         金手指
// @version      5.8.3
// @description  Superb Goldfinger
// @author       IWanna
// @match        https://m.66rpg.com/*
// @match        https://www.66rpg.com/*
// @match        https://m.66rpg.com/h5/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=66rpg.com
// @run-at       document-start
// @namespace https://greasyfork.org/users/1318954
// @downloadURL https://update.greasyfork.org/scripts/498061/%E9%87%91%E6%89%8B%E6%8C%87.user.js
// @updateURL https://update.greasyfork.org/scripts/498061/%E9%87%91%E6%89%8B%E6%8C%87.meta.js
// ==/UserScript==
(function(){'use strict';const scriptContent=`(function(){const originalSetInterval=window.setInterval;const originalSetTimeout=window.setTimeout;window.setInterval=function(a,b,c){if(typeof a==='function'){const wrappedCallback=function(){try{setInterval=function(){}}catch(e){console.error(e)}};return originalSetInterval(wrappedCallback,b)}return originalSetInterval(a,b,c)};window.setTimeout=function(a,b,c){if(typeof a==='function'){const wrappedCallback=function(){try{a.apply(this,args)}catch(e){console.error(e)}};return originalSetTimeout(wrappedCallback,b)}return originalSetTimeout(a,b,c)}})();`;const script=document.createElement('script');script.textContent=scriptContent;document.documentElement.appendChild(script);script.remove();function initDB(){return new Promise((resolve,reject)=>{const request=indexedDB.open('tvDataDB',1);request.onerror=(event)=>reject(event);request.onsuccess=()=>resolve(request.result);request.onupgradeneeded=(event)=>{const db=event.target.result;if(!db.objectStoreNames.contains('tvDataStore')){db.createObjectStore('tvDataStore',{keyPath:'id'})}}})}function saveDataToDB(a,b){return new Promise(async(resolve,reject)=>{try{const transaction=a.transaction(['tvDataStore'],'readwrite');const objectStore=transaction.objectStore('tvDataStore');const request=objectStore.put({id:'tvData',data:JSON.stringify(b)});request.onsuccess=()=>resolve();request.onerror=(event)=>reject(event)}catch(error){reject(error)}})}function getDataFromDB(a){return new Promise((resolve,reject)=>{const transaction=a.transaction(['tvDataStore'],'readonly');const objectStore=transaction.objectStore('tvDataStore');const request=objectStore.get('tvData');request.onsuccess=(event)=>{if(request.result){resolve(JSON.parse(request.result.data))}else{resolve(null)}};request.onerror=(event)=>reject(event)})}function monitorTVData(){try{const observer=new MutationObserver(()=>{try{if(typeof tv!=='undefined'&&tv.data&&tv.data.System&&tv.data.System.Cuis){window.monitoredData=tv.data.System.Cuis.map(cu=>{if(cu.data&&cu.data.buffer){cu.data=Array.from(new Uint8Array(cu.data.buffer))}return cu});alert('初始化完成');initDB().then((db)=>{getDataFromDB(db).then((data)=>{if(!data){saveDataToDB(db,window.monitoredData).then(()=>{console.log('Data saved successfully');const now=new Date();const timestamp=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;const blob=new Blob([JSON.stringify(window.monitoredData)],{type:"text/plain"});const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download=`chengguang${timestamp}.txt`;link.click()}).catch((err)=>{console.error('Error saving data to IndexedDB:',err)})}}).catch((err)=>{console.error('Error getting data from IndexedDB:',err)})}).catch((err)=>{console.error('Error initializing IndexedDB:',err)});observer.disconnect()}}catch(e){console.error('Error in MutationObserver callback:',e)}});observer.observe(document,{childList:true,subtree:true})}catch(e){console.error('Error in monitorTVData function:',e)}}function executeInGlobalContext(a){const script=document.createElement('script');script.textContent=a;document.documentElement.appendChild(script);script.remove()}document.addEventListener('DOMContentLoaded',()=>{monitorTVData();const existingButton=document.getElementById('goldenFingerButton');if(existingButton)return;const button=document.createElement('button');button.id='goldenFingerButton';button.innerText='金手指';button.style.fontSize='18px';button.style.padding='10px';button.style.border='none';button.style.borderRadius='5px';button.style.backgroundColor='#FFD700';button.style.color='white';button.style.cursor='pointer';button.style.position='fixed';button.style.top='10px';button.style.right='10px';button.style.zIndex='10000';button.style.boxShadow='0 0 10px rgba(255, 215, 0, 0.5)';button.style.width='100px';button.style.height='40px';document.body.appendChild(button);let isDragging=false;let startX,startY,initialX,initialY;let clickCount=0;let longPressTimer;button.onmousedown=(e)=>{isDragging=true;startX=e.clientX;startY=e.clientY;initialX=button.offsetLeft;initialY=button.offsetTop;document.onmousemove=(e)=>{if(isDragging){const dx=e.clientX-startX;const dy=e.clientY-startY;button.style.left=`${initialX+dx}px`;button.style.top=`${initialY+dy}px`}};document.onmouseup=()=>{isDragging=false;document.onmousemove=null;document.onmouseup=null}};button.onmousedown=(e)=>{isDragging=true;startX=e.clientX;startY=e.clientY;initialX=button.offsetLeft;initialY=button.offsetTop;longPressTimer=setTimeout(()=>{button.style.width='30px';button.style.height='30px';button.style.top='10px';button.style.right='10px';button.innerText='手'},1000);document.onmousemove=(e)=>{if(isDragging){const dx=e.clientX-startX;const dy=e.clientY-startY;button.style.left=`${initialX+dx}px`;button.style.top=`${initialY+dy}px`}};document.onmouseup=()=>{isDragging=false;clearTimeout(longPressTimer);document.onmousemove=null;document.onmouseup=null}};button.onclick=()=>{clickCount++;if(clickCount>=3){button.style.width='30px';button.style.height='30px';button.style.top='10px';button.style.right='10px';button.innerText='手';clickCount=0}};button.ondblclick=()=>{try{initDB().then((db)=>{getDataFromDB(db).then((data)=>{if(!data){alert('没有数据可处理');return}const allMatchesSet=new Set();const chineseCharRegex=/[\u4e00-\u9fa5]/;const digitRegex=/\d/;data.forEach(cu=>{if(!cu.isLoaded){const byteArray=new Uint8Array(cu.data);const decoder=new TextDecoder('utf-8');const decodedString=decoder.decode(byteArray);let results=[];let startIndex=-1;for(let i=0;i<decodedString.length;i++){if(decodedString[i]==='['){startIndex=i}else if(decodedString[i]===']'&&startIndex!==-1){const match=decodedString.substring(startIndex,i+1);if(chineseCharRegex.test(match)&&digitRegex.test(match)){results.push(match)}startIndex=-1}}const cleanedString=results.join(';');cleanedString.split(';').forEach(item=>allMatchesSet.add(item))}});const allMatchesArray=[...allMatchesSet];const finalResult=allMatchesArray.join(';');const dataString=finalResult;const options=[];let startIndex=0;while(startIndex<dataString.length){const startBracket=dataString.indexOf('[',startIndex);const endBracket=dataString.indexOf(']',startBracket);if(startBracket===-1||endBracket===-1)break;const item=dataString.substring(startBracket+1,endBracket);const splitIndex=item.indexOf('：');if(splitIndex!==-1){const number=item.substring(0,splitIndex).trim();const text=item.substring(splitIndex+1).trim();options.push({number,text})}startIndex=endBracket+1}options.sort((a,b)=>parseInt(a.number)-parseInt(b.number));const container=document.createElement('div');container.style.position='fixed';container.style.top='10px';container.style.left='10px';container.style.zIndex='10000';container.style.backgroundColor='#f9f9f9';container.style.padding='20px';container.style.border='1px solid #ccc';container.style.borderRadius='10px';container.style.boxShadow='0 4px 8px rgba(0, 0, 0, 0.1)';container.style.cursor='move';const makeDraggable=(element)=>{let isDragging=false;let startX,startY,initialX,initialY;element.onmousedown=(e)=>{isDragging=true;startX=e.clientX;startY=e.clientY;initialX=element.offsetLeft;initialY=element.offsetTop;document.onmousemove=(e)=>{if(isDragging){const dx=e.clientX-startX;const dy=e.clientY-startY;element.style.left=`${initialX+dx}px`;element.style.top=`${initialY+dy}px`}};document.onmouseup=()=>{isDragging=false;document.onmousemove=null;document.onmouseup=null}}};makeDraggable(container);const searchInput=document.createElement('input');searchInput.type='text';searchInput.placeholder='检索...';searchInput.style.fontSize='18px';searchInput.style.padding='10px';searchInput.style.border='1px solid #ccc';searchInput.style.borderRadius='5px';searchInput.style.marginBottom='10px';searchInput.style.width='calc(100% - 22px)';const select=document.createElement('select');select.style.fontSize='18px';select.style.padding='10px';select.style.border='1px solid #ccc';select.style.borderRadius='5px';select.style.marginBottom='10px';select.style.width='100%';const populateSelect=(filteredOptions)=>{select.innerHTML='';for(let i=0;i<filteredOptions.length;i++){const option=filteredOptions[i];const opt=document.createElement('option');opt.value=option.number;opt.textContent=`${option.number}：${option.text}`;select.appendChild(opt)}};populateSelect(options);searchInput.addEventListener('input',()=>{const searchTerm=searchInput.value.toLowerCase();const filteredOptions=options.filter(option=>option.text.toLowerCase().includes(searchTerm)||option.number.includes(searchTerm));populateSelect(filteredOptions)});const input=document.createElement('input');input.type='text';input.placeholder='输入文本';input.style.fontSize='18px';input.style.padding='10px';input.style.border='1px solid #ccc';input.style.borderRadius='5px';input.style.marginBottom='10px';input.style.width='calc(100% - 22px)';input.addEventListener('input',()=>{input.value=input.value.replace(/[^0-9]/g,'')});const submitButton=document.createElement('button');submitButton.textContent='提交';submitButton.style.fontSize='18px';submitButton.style.padding='10px';submitButton.style.border='none';submitButton.style.borderRadius='5px';submitButton.style.backgroundColor='#4CAF50';submitButton.style.color='white';submitButton.style.width='100%';submitButton.style.cursor='pointer';const activateButton=document.createElement('button');activateButton.textContent='点击激活';activateButton.style.fontSize='18px';activateButton.style.padding='10px';activateButton.style.border='none';activateButton.style.borderRadius='5px';activateButton.style.backgroundColor='#2196F3';activateButton.style.color='white';activateButton.style.width='100%';activateButton.style.cursor='pointer';activateButton.style.marginTop='10px';const hideButton=document.createElement('button');hideButton.textContent='隐藏';hideButton.style.fontSize='18px';hideButton.style.padding='10px';hideButton.style.border='none';hideButton.style.borderRadius='5px';hideButton.style.backgroundColor='#f44336';hideButton.style.color='white';hideButton.style.width='100%';hideButton.style.cursor='pointer';hideButton.style.marginTop='10px';activateButton.onclick=()=>{alert('开始执行激活');setTimeout(()=>{if(typeof userData!=='undefined'){userData.totalFlower=6600}if(typeof gIndex!=='undefined'){gIndex='1670380'}alert('激活成功');if(typeof toggleFullscreen!=='undefined'){toggleFullscreen()}},100)};hideButton.onclick=()=>{container.style.display='none'};submitButton.onclick=()=>{const selectedOption=select.options[select.selectedIndex];const inputValue=input.value;if(inputValue===''){alert('请输入一个数字')}else{const sanitizedInputValue=inputValue.replace(/^0+/,'')||'0';const numberValue=(parseInt(selectedOption.value,10)-1).toString();const code=`tv['system']['vars']['data'][${numberValue}]=(sq=>sq^GloableData._instance.getEncryptionInt())(${sanitizedInputValue});let aa1='askdjhasijhdklajhslkdjhaskjhdklashkdhaskjhdkas';let aa2='1231287368127648768asuhdgjkashsdjhgajshdgajkhgdjhassdasd';let aa3='12398127938712989iuasyhdkjagsjdhgyt1uyt8ausydhjhqguaysgdja';let aa4='912863981263878asuydtgajshgdhjasfdhgasfdjhafshdgfashgd';`;function obfuscateCode(a){return a.split('').map(c=>'\\u'+('0000'+c.charCodeAt(0).toString(16)).slice(-4)).join('')}const obfuscatedCode=obfuscateCode(code);const tryCatchCode=`try{let result=eval(runCode);if(typeof result==='number'){console.log('success')}else{console.log('abortive')}}catch(e){console.error('Error executing code:',e)}`;const obfuscatedTryCatchCode=obfuscateCode(tryCatchCode);const finalCode=`const vb='${selectedOption.text}';const runCode=String.fromCharCode(...[${obfuscatedCode.split('\\u').slice(1).map(c=>'0x'+c).join(', ')}]);const tryCatch=String.fromCharCode(...[${obfuscatedTryCatchCode.split('\\u').slice(1).map(c=>'0x'+c).join(', ')}]);eval(tryCatch);const label='${selectedOption.text}';`;navigator.clipboard.writeText(finalCode).then(()=>{alert('指令已复制，请打开控制台切换环境（gameMainBox），并在控制台输入后执行')})}};container.appendChild(searchInput);container.appendChild(select);container.appendChild(input);container.appendChild(submitButton);container.appendChild(activateButton);container.appendChild(hideButton);document.body.appendChild(container)}).catch((err)=>{console.error('Error getting data from IndexedDB:',err)})}).catch((err)=>{console.error('Error initializing IndexedDB:',err)})}catch(e){console.error('Error in button double-click event:',e)}}})})();