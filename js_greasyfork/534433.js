// ==UserScript==
// @name      Top Academy Journal Auto Rater Pro
// @version      0.6.1
// @description      –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ journal
// @author      Rodion
// @match      https://journal.top-academy.ru/*
// @grant      GM_getValue
// @grant      GM_setValue
// @grant      GM_registerMenuCommand
// @grant      GM_addStyle
// @run-at      document-end
// @namespace http://tampermonkey.net/
// @downloadURL https://update.greasyfork.org/scripts/534433/Top%20Academy%20Journal%20Auto%20Rater%20Pro.user.js
// @updateURL https://update.greasyfork.org/scripts/534433/Top%20Academy%20Journal%20Auto%20Rater%20Pro.meta.js
// ==/UserScript==

!function(){"use strict";const e={ZOOM_LEVEL:"80%",PROGRESS_PAGE_REGEX:"https://journal.top-academy.ru/.*/main/progress/.*",AUTO_RATE_ENABLED:!0,AUTO_SUBMIT_ENABLED:!0};class t{constructor(){this.config={...e},this.listeners=new Set}async loadConfig(){try{const t=await GM_getValue("config",{});let n=t.ZOOM_LEVEL||e.ZOOM_LEVEL;"number"==typeof n?n=`${n}%`:"string"!=typeof n||n.includes("%")||(n=`${n}%`),this.config={...e,...t,ZOOM_LEVEL:n},this.notifyListeners()}catch(t){console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.\nWarning: "+t),this.config={...e},this.notifyListeners()}}async saveConfig(e){try{let t=e.ZOOM_LEVEL||this.config.ZOOM_LEVEL;"number"==typeof t?t=`${t}%`:"string"!=typeof t||t.includes("%")||(t=`${t}%`),this.config={...this.config,...e,ZOOM_LEVEL:t};const n={...this.config};return n.PROGRESS_PAGE_REGEX instanceof RegExp&&(n.PROGRESS_PAGE_REGEX=n.PROGRESS_PAGE_REGEX.toString()),await GM_setValue("config",n),this.notifyListeners(),!0}catch(e){return console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:",e),!1}}addChangeListener(e){return this.listeners.add(e),()=>this.listeners.delete(e)}removeChangeListener(e){this.listeners.delete(e)}notifyListeners(){this.listeners.forEach(e=>{try{e(this.config)}catch(e){console.error("–û—à–∏–±–∫–∞ –≤ —Å–ª—É—à–∞—Ç–µ–ª–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:",e)}})}registerMenuCommands(e){try{GM_registerMenuCommand("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞",()=>{e.emit("config:show-ui")}),console.log('–ú–µ–Ω—é-–∫–æ–º–∞–Ω–¥–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞" –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞')}catch(e){console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–µ–Ω—é-–∫–æ–º–∞–Ω–¥—ã:",e)}}}class n{constructor(){this.events=new Map}on(e,t){return this.events.has(e)||this.events.set(e,new Set),this.events.get(e).add(t),()=>this.off(e,t)}off(e,t){this.events.has(e)&&this.events.get(e).delete(t)}emit(e,t){this.events.has(e)&&this.events.get(e).forEach(n=>{try{n(t)}catch(t){console.error(`–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–±—ã—Ç–∏—è ${e}:`,t)}})}cleanup(){this.events.clear()}}function s(){console.log("[DOM] createWidget called"),i();const e=document.createElement("div");return e.id="attendance-stats-widget",e.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: white;\n        border: 2px solid #007bff;\n        border-radius: 8px;\n        padding: 15px;\n        z-index: 9999;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        min-width: 280px;\n        font-family: Arial, sans-serif;\n        transition: all 0.3s ease;\n    ",console.log("[DOM] Widget element created, appending to body..."),e.innerHTML='\n        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">\n            <h3 style="margin: 0; font-size: 16px; color: #007bff;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</h3>\n            <button id="toggle-stats" style="background: none; border: none; font-size: 16px; cursor: pointer;">‚ØÜ</button>\n        </div>\n        \n        <div id="stats-content" style="margin-bottom: 15px;">\n            –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...\n        </div>\n        \n        <div style="margin-bottom: 10px;">\n            <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ü–µ—Ä–∏–æ–¥:</label>\n            <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">\n                <input type="date" id="date-from" style="flex: 1; padding: 5px; box-sizing: border-box;">\n                <span style="font-weight: bold;">‚Äî</span>\n                <input type="date" id="date-to" style="flex: 1; padding: 5px; box-sizing: border-box;">\n            </div>\n        </div>\n        \n        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">\n            <button id="reset-stats" style="padding: 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">–°–±—Ä–æ—Å</button>\n            <button id="refresh-stats" style="padding: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">–û–±–Ω–æ–≤–∏—Ç—å</button>\n        </div>\n        \n        <style>\n            .progress-bar {\n                width: 100%;\n                height: 8px;\n                background: #e9ecef;\n                border-radius: 4px;\n                margin-top: 5px;\n                overflow: hidden;\n            }\n            \n            .progress-bar-inner {\n                height: 100%;\n                background: #28a745;\n                transition: width 0.3s ease;\n            }\n            \n            .present { color: #28a745; }\n            .lateness { color: #ffc107; }\n            .absent { color: #dc3545; }\n            \n            #attendance-stats-widget.collapsed {\n                height: 40px;\n                overflow: hidden;\n                min-width: auto;\n                width: 200px;\n            }\n            \n            #attendance-stats-widget.collapsed > *:not(:first-child) {\n                display: none;\n            }\n        </style>\n    ',document.body.appendChild(e),console.log("[DOM] Widget appended to body, id:",e.id),e}function i(){const e=document.getElementById("attendance-stats-widget");e&&(console.log("[DOM] Removing widget"),console.trace("[DOM] Widget removal trace"),e.remove())}function o(e){if(!e)return!1;const t=window.getComputedStyle(e);return e.offsetWidth>0&&e.offsetHeight>0&&"hidden"!==t.visibility&&"none"!==t.display&&"0"!==t.opacity}class a{constructor({eventBus:e,config:t}){this.eventBus=e,this.config=t,this.widget=null,this.isCollapsed=!1,this.rangeStart=null,this.rangeEnd=null,this.navigationObserver=null,this.lastUrl=window.location.href,this.navigationCheckTimeout=null,this.overridePresent=null,this.overrideLateness=null,this.overrideAbsent=null}init(){console.log("[AttendanceModule] Initializing..."),this.setupEventListeners(),this.applyConfigImmediately();const e=this.isProgressPage();console.log("[AttendanceModule] Is progress page:",e),e&&(console.log("[AttendanceModule] Calling initAttendanceStats..."),this.initAttendanceStats()),this.setupNavigationObserver(),console.log("[AttendanceModule] Initialization complete")}setupEventListeners(){this.eventBus.on("config:updated",()=>this.onConfigUpdated()),this.eventBus.on("page:changed",()=>this.onPageChanged())}onConfigUpdated(){this.applyConfigImmediately(),this.isProgressPage()?this.updateAttendanceStats():this.widget&&document.getElementById("attendance-stats-widget")&&(i(),this.widget=null)}onPageChanged(){console.log("[AttendanceModule] onPageChanged called"),this.isProgressPage()?(console.log("[AttendanceModule] Page changed to progress page, initializing stats"),this.initAttendanceStats()):(console.log("[AttendanceModule] Page changed to non-progress page"),this.widget&&document.getElementById("attendance-stats-widget")&&(console.log("[AttendanceModule] Removing widget due to page change"),i(),this.widget=null))}applyConfigImmediately(){this.setPageZoom()}setPageZoom(){let e=this.config.ZOOM_LEVEL;"number"==typeof e?e=`${e}%`:"string"!=typeof e||e.includes("%")||(e=`${e}%`),document.documentElement.style.zoom=e}isProgressPage(){const e=window.location.href;if(console.log("[AttendanceModule] Checking URL:",e),console.log("[AttendanceModule] Regex pattern:",this.config.PROGRESS_PAGE_REGEX),"string"==typeof this.config.PROGRESS_PAGE_REGEX)try{const t=new RegExp(this.config.PROGRESS_PAGE_REGEX).test(e);return console.log("[AttendanceModule] isProgressPage result:",t),t}catch(e){return console.error("Invalid regex pattern:",e),!1}if(this.config.PROGRESS_PAGE_REGEX instanceof RegExp){const t=this.config.PROGRESS_PAGE_REGEX.test(e);return console.log("[AttendanceModule] isProgressPage result:",t),t}const t=/https:\/\/journal\.top-academy\.ru\/.*\/main\/progress\/.*/.test(e);return console.log("[AttendanceModule] isProgressPage result (fallback):",t),t}initAttendanceStats(){console.log("[AttendanceModule] initAttendanceStats called");const e=document.getElementById("attendance-stats-widget");e?(console.log("[AttendanceModule] Widget already exists in DOM"),this.widget=e):(console.log("[AttendanceModule] Widget not in DOM, creating..."),this.widget=s(),console.log("[AttendanceModule] Widget created:",this.widget),this.setDefaultDateRange(),this.setupWidgetControls(),this.setupRangeSelection(),this.setupDateInputListeners()),this.updateAttendanceStats()}setDefaultDateRange(){const e=new Date,t=e.getFullYear();this.rangeStart=new Date(t,e.getMonth(),1),this.rangeStart.setHours(0,0,0,0),this.rangeEnd=new Date(t,e.getMonth(),e.getDate()),this.rangeEnd.setHours(23,59,59,999),this.syncDateInputs()}setupWidgetControls(){if(!this.widget)return;const e=this.widget.querySelector("#reset-stats"),t=this.widget.querySelector("#refresh-stats"),n=this.widget.querySelector("#toggle-stats");e.addEventListener("click",()=>{this.setDefaultDateRange(),this.clearHighlights(),this.overridePresent=null,this.overrideLateness=null,this.overrideAbsent=null,this.updateAttendanceStats()}),t.addEventListener("click",()=>{this.updateAttendanceStats(),this.highlightRange()}),n.addEventListener("click",()=>{this.isCollapsed=!this.isCollapsed,this.isCollapsed?(this.widget.classList.add("collapsed"),n.textContent="‚Øà"):(this.widget.classList.remove("collapsed"),n.textContent="‚ØÜ")})}setupDateInputListeners(){if(!this.widget)return;const e=this.widget.querySelector("#date-from"),t=this.widget.querySelector("#date-to"),n=()=>{const n=e.value,s=t.value;if(n){const e=new Date(n);e.setHours(0,0,0,0),this.rangeStart=e}else this.rangeStart=null;if(s){const e=new Date(s);e.setHours(23,59,59,999),this.rangeEnd=e}else this.rangeEnd=null;this.updateAttendanceStats()};e.addEventListener("change",n),t.addEventListener("change",n)}setupStatsInputListeners(){if(!this.widget)return;const e=this.widget.querySelector("#override-present"),t=this.widget.querySelector("#override-lateness"),n=this.widget.querySelector("#override-absent");if(!e||!t||!n)return;const s=()=>{const s=parseInt(e.value,10),i=parseInt(t.value,10),o=parseInt(n.value,10);this.overridePresent=isNaN(s)?null:s,this.overrideLateness=isNaN(i)?null:i,this.overrideAbsent=isNaN(o)?null:o,this.updateStatsDisplay()};e.addEventListener("input",s),t.addEventListener("input",s),n.addEventListener("input",s)}updateStatsDisplay(){if(!this.widget)return;const e=this.calculateStats();if(this.widget.querySelector("#stats-content")){const t=this.widget.querySelector("#total-lessons");t&&(t.textContent=e.total);const n=this.widget.querySelector("#percentage-value");n&&(n.textContent=`${e.percentage}%`);const s=this.widget.querySelector(".progress-bar-inner");s&&(s.style.width=`${e.percentage}%`)}}updateAttendanceStats(){console.log("[AttendanceModule] updateAttendanceStats called");if(!this.isProgressPage())return console.log("[AttendanceModule] Not on progress page"),void(this.widget&&document.getElementById("attendance-stats-widget")&&(console.log("[AttendanceModule] Removing widget"),i(),this.widget=null));this.widget||(console.log("[AttendanceModule] Widget does not exist, creating..."),this.widget=s());const e=this.calculateStats();console.log("[AttendanceModule] Stats calculated:",e),this.widget&&(console.log("[AttendanceModule] Updating widget content"),this.widget.querySelector("#stats-content").innerHTML=`\n                <div style="margin-bottom: 5px;">–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π: <b id="total-lessons">${e.total}</b></div>\n                <div style="display: flex; align-items: center; margin-bottom: 3px;">\n                    <span class="present" style="flex: 1;">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è:</span>\n                    <input type="number" id="override-present" min="0" value="${e.present}"\n                           style="width: 60px; padding: 2px 5px; border: 1px solid #28a745; border-radius: 3px;">\n                </div>\n                <div style="display: flex; align-items: center; margin-bottom: 3px;">\n                    <span class="lateness" style="flex: 1;">–û–ø–æ–∑–¥–∞–Ω–∏—è:</span>\n                    <input type="number" id="override-lateness" min="0" value="${e.lateness}"\n                           style="width: 60px; padding: 2px 5px; border: 1px solid #ffc107; border-radius: 3px;">\n                </div>\n                <div style="display: flex; align-items: center; margin-bottom: 8px;">\n                    <span class="absent" style="flex: 1;">–ü—Ä–æ–ø—É—Å–∫–∏:</span>\n                    <input type="number" id="override-absent" min="0" value="${e.absent}"\n                           style="width: 60px; padding: 2px 5px; border: 1px solid #dc3545; border-radius: 3px;">\n                </div>\n                –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å: <b id="percentage-value">${e.percentage}%</b>\n                <div class="progress-bar"><div class="progress-bar-inner" style="width:${e.percentage}%;"></div></div>\n            `,this.setupStatsInputListeners(),console.log("[AttendanceModule] Widget content updated")),this.highlightRange()}calculateStats(){this.normalizeRange();const e=this.rangeStart,t=this.rangeEnd;if(!e||!t)return{total:0,present:0,lateness:0,absent:0,percentage:0};if(null!==this.overridePresent||null!==this.overrideLateness||null!==this.overrideAbsent){const e=this.overridePresent??0,t=this.overrideLateness??0,n=this.overrideAbsent??0,s=e+t+n;return{total:s,present:e,lateness:t,absent:n,percentage:s>0?((e+t)/s*100).toFixed(1):0}}const n=document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass");let s=0,i=0,o=0;for(let a=0;a<n.length;a++){const r=n[a],l=r.querySelector(".date")?.textContent.trim();if(!l)continue;const[d,c,g]=l.split(".").map(Number),h=new Date(g,c-1,d);h.setHours(12,0,0,0);h>=e&&h<=t&&(s++,r.classList.contains("lateness")&&i++,r.classList.contains("pass")&&o++)}const a=s-(o+i);return{total:s,present:a,lateness:i,absent:o,percentage:s>0?((a+i)/s*100).toFixed(1):0}}syncDateInputs(){if(!this.widget)return;const e=this.widget.querySelector("#date-from"),t=this.widget.querySelector("#date-to");if(this.rangeStart){const t=new Date(this.rangeStart);e.value=t.toISOString().split("T")[0]}else e.value="";if(this.rangeEnd){const e=new Date(this.rangeEnd);t.value=e.toISOString().split("T")[0]}else t.value=""}setupRangeSelection(){document.body.addEventListener("click",e=>{const t=e.target.closest(".lessons, .lessons.lateness, .lessons.pass");if(!t)return;const n=t.querySelector(".date");if(!n)return;const[s,i,o]=n.textContent.trim().split(".").map(Number),a=new Date(o,i-1,s);a.setHours(12,0,0,0),e.preventDefault(),e.stopPropagation(),console.log("–ö–ª–∏–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω:",e.shiftKey?"Shift + –õ–ö–ú":"–õ–ö–ú",a.toDateString()),e.shiftKey?(this.rangeEnd=a,console.log("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ rangeEnd:",this.rangeEnd.toDateString())):(this.rangeStart=a,this.rangeEnd=null,console.log("–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ rangeStart:",this.rangeStart.toDateString(),"rangeEnd —Å–±—Ä–æ—à–µ–Ω–∞")),this.normalizeRange(),this.syncDateInputs(),this.updateAttendanceStats(),this.highlightRange()},!0)}normalizeRange(){if(!this.rangeStart)return this.rangeStart=null,void(this.rangeEnd=null);if(this.rangeEnd)if(this.rangeEnd<this.rangeStart){const e=this.rangeStart;this.rangeStart=new Date(this.rangeEnd),this.rangeStart.setHours(0,0,0,0),this.rangeEnd=new Date(e),this.rangeEnd.setHours(23,59,59,999)}else this.rangeStart.setHours(0,0,0,0),this.rangeEnd.setHours(23,59,59,999);else this.rangeEnd=new Date(this.rangeStart),this.rangeEnd.setHours(23,59,59,999)}highlightRange(){this.clearHighlights(),this.normalizeRange();const e=this.rangeStart,t=this.rangeEnd;e&&t&&requestAnimationFrame(async()=>{const n=document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass");for(let s=0;s<n.length;s++){const i=n[s],o=i.querySelector(".date");if(!o)continue;const a=o.textContent.trim();if(!a)continue;const[r,l,d]=a.split(".").map(Number),c=new Date(d,l-1,r);c.setHours(12,0,0,0);c>=e&&c<=t&&(c.getTime()===e.getTime()||c.getTime()===t.getTime()?i.style.border="2px solid #ff6b00":i.style.border="2px solid green",i.style.boxSizing="border-box",s%10==0&&await new Promise(e=>requestAnimationFrame(e)))}})}clearHighlights(){document.querySelectorAll(".lessons, .lessons.lateness, .lessons.pass").forEach(e=>{e.style.border=""})}setupNavigationObserver(){const e=()=>{const e=window.location.href;e!==this.lastUrl&&(this.lastUrl=e,this.eventBus.emit("page:changed"))};this.navigationObserver=new MutationObserver(t=>{t.some(e=>e.addedNodes.length>0||e.removedNodes.length>0)&&(clearTimeout(this.navigationCheckTimeout),this.navigationCheckTimeout=setTimeout(e,300))});const t=document.body;t&&this.navigationObserver.observe(t,{childList:!0,subtree:!1}),window.addEventListener("popstate",()=>{clearTimeout(this.navigationCheckTimeout),this.navigationCheckTimeout=setTimeout(e,100)}),setInterval(e,2e3)}cleanup(){i(),this.eventBus.off("config:updated",()=>this.onConfigUpdated()),this.eventBus.off("page:changed",()=>this.onPageChanged()),this.navigationObserver&&this.navigationObserver.disconnect(),clearTimeout(this.navigationCheckTimeout)}}class r{constructor({eventBus:e,config:t}){this.eventBus=e,this.config=t,this.observer=null,this.isProcessing=!1,this.processedModals=new Set,this.pendingRetries=new Map,this.ratingSelector=".bs-rating-star",this.activeClass="active",this.maxRating=5,this.retryAttempts=3,this.retryDelay=1e3,this.homeworkModalSelector="hw-upload-homework",this.modalCheckTimeout=null}init(){this.config.AUTO_RATE_ENABLED&&(this.setupEventListeners(),this.setupMutationObserver())}setupEventListeners(){this.eventBus.on("config:updated",()=>this.onConfigUpdated()),this.eventBus.on("homework:modal-opened",e=>this.onHomeworkModalOpened(e))}onConfigUpdated(){this.config.AUTO_RATE_ENABLED?this.setupMutationObserver():this.cleanup()}onHomeworkModalOpened(e){this.config.AUTO_RATE_ENABLED&&!this.isProcessing&&this.processHomeworkModal(e)}setupMutationObserver(){this.cleanupObserver(),this.observer=new MutationObserver(e=>{e.some(e=>e.addedNodes.length>0)&&(clearTimeout(this.modalCheckTimeout),this.modalCheckTimeout=setTimeout(()=>{this.detectHomeworkModal()},500))}),this.observer.observe(document.body,{childList:!0,subtree:!1})}detectHomeworkModal(){const e=document.querySelector(this.homeworkModalSelector);e&&!this.processedModals.has(e)&&this.eventBus.emit("homework:modal-opened",e)}async processHomeworkModal(e){this.isProcessing=!0,this.processedModals.add(e);try{await this.delay(1e3),await this.fillTimeSpent(),await this.rateMaximum(),await this.selectPositiveTags(),this.config.AUTO_SUBMIT_ENABLED}catch(e){console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è:",e)}finally{this.isProcessing=!1}}setInputValue(e,t){Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value").set.call(e,t);[new Event("input",{bubbles:!0}),new Event("change",{bubbles:!0}),new Event("blur",{bubbles:!0})].forEach(t=>e.dispatchEvent(t))}async fillTimeSpent(){return new Promise(e=>{setTimeout(()=>{const t=document.querySelectorAll(".text-homework-time-spent-wrap input");if(t.length>=2){const e=Math.floor(2*Math.random())+1;this.setInputValue(t[0],e);const n=Math.floor(31*Math.random())+15;this.setInputValue(t[1],n),console.log(`‚è∞ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó: ${e}—á ${n}–º–∏–Ω`)}e()},500)})}async rateMaximum(){return new Promise(e=>{setTimeout(()=>{document.querySelectorAll(".emoji-evaluation").forEach(e=>{const t=this.generateContainerId(e);if(this.pendingRetries.has(t))return;const n=e.querySelectorAll(this.ratingSelector);if(n.length===this.maxRating){const s=n[this.maxRating-1];if(s.classList.contains(this.activeClass))console.log("‚úÖ –û—Ü–µ–Ω–∫–∞ –î–ó —É–∂–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞ –Ω–∞ –º–∞–∫—Å–∏–º—É–º");else{console.log("‚≠ê –ö–ª–∏–∫–∞–µ–º –Ω–∞ 5-—é –∑–≤–µ–∑–¥—É –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –î–ó");this.clickStar(s)&&this.startRetryCycle(e,t,0)}}}),e()},300)})}async selectPositiveTags(){return new Promise(e=>{setTimeout(()=>{console.log("üîç –ò—â–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–≥–∏...");const t=document.querySelectorAll(".evaluation-tags-item");let n=0;t.forEach((e,t)=>{const n=e.querySelector("span")?.textContent,s=o(e),i=e.classList.contains("selected");console.log(`–¢–µ–≥ ${t+1}: "${n}", –≤–∏–¥–∏–º: ${s}, –≤—ã–±—Ä–∞–Ω: ${i}`)});const s=["–í—Å–µ –∫—Ä—É—Ç–æ!","–í—Å–µ –ø–æ–Ω—è—Ç–Ω–æ!","–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è"];t.forEach(e=>{if(!o(e)||n>=2)return;const t=e.querySelector("span")?.textContent;if(console.log(`–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–≥: "${t}"`),t&&s.includes(t)&&!e.classList.contains("selected"))try{e.click(),console.log(`‚úÖ –í—ã–±—Ä–∞–Ω —Ç–µ–≥: "${t}"`),n++}catch(e){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–µ–≥–∞:",e)}}),0===n&&console.log("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–µ–≥–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞"),e()},800)})}async submitHomework(){return new Promise(e=>{setTimeout(()=>{const t=document.querySelector(".btn-accept");t&&!t.disabled?(console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ"),t.click()):t&&t.disabled&&console.log("‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π"),e()},1500)})}startRetryCycle(e,t,n){if(n>=this.retryAttempts)return console.log("‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –î–ó"),void this.pendingRetries.delete(t);console.log(`‚è≥ –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ü–µ–Ω–∫–∏ –î–ó (–ø–æ–ø—ã—Ç–∫–∞ ${n+1}/${this.retryAttempts})...`),this.pendingRetries.set(t,setTimeout(()=>{this.checkRatingSuccess(e,t,n)},this.retryDelay))}checkRatingSuccess(e,t,n){const s=e.querySelectorAll(this.ratingSelector);if(0===s.length)return console.log("‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –æ—Ü–µ–Ω–∫–∏ –∏—Å—á–µ–∑–ª–∏"),void this.pendingRetries.delete(t);const i=s[this.maxRating-1];if(i.classList.contains(this.activeClass))console.log("‚úÖ –û—Ü–µ–Ω–∫–∞ –î–ó —É—Å–ø–µ—à–Ω–æ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∞!"),this.pendingRetries.delete(t);else{console.log("‚ùå –û—Ü–µ–Ω–∫–∞ –î–ó –Ω–µ –ø—Ä–æ—à–ª–∞, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞...");this.clickStar(i)?this.startRetryCycle(e,t,n+1):(console.log("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –∑–≤–µ–∑–¥—É"),this.pendingRetries.delete(t))}}clickStar(e){if(o(e)&&function(e){if(!e)return!1;const t=window.getComputedStyle(e);return"none"!==t.pointerEvents&&"pointer"===t.cursor&&!e.hasAttribute("disabled")}(e))try{const t=e.querySelector("button.rating-star");return t?(t.click(),!0):(e.click(),!0)}catch(e){return console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–≤–µ–∑–¥—É:",e),!1}return!1}generateContainerId(e){return Array.from(e.parentNode.children).indexOf(e)}delay(e){return new Promise(t=>setTimeout(t,e))}cleanup(){this.cleanupObserver(),this.processedModals.clear(),this.pendingRetries.forEach((e,t)=>{clearTimeout(e),this.pendingRetries.delete(t)}),clearTimeout(this.modalCheckTimeout)}cleanupObserver(){this.observer&&(this.observer.disconnect(),this.observer=null)}}class l{constructor(e,t){this.currentConfig={...e},this.onSave=t,this.modal=null}show(){this.modal?this.modal.style.display="block":this.createModal()}createModal(){this.modal=document.createElement("div"),this.modal.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: white;\n            padding: 20px;\n            border-radius: 8px;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n            z-index: 10000;\n            min-width: 400px;\n            font-family: Arial, sans-serif;\n        ";const e=document.createElement("h3");e.textContent="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞",e.style.marginTop="0";const t=document.createElement("div"),n=document.createElement("label");n.textContent="–ú–∞—Å—à—Ç–∞–± —Å—Ç—Ä–∞–Ω–∏—Ü—ã (%):",n.style.display="block",n.style.marginBottom="5px";const s=document.createElement("input");s.type="number",s.min="10",s.max="200",s.step="5",s.value=this.parseZoomValue(this.currentConfig.ZOOM_LEVEL),s.style.width="100%",s.style.padding="8px",s.style.marginBottom="15px",s.style.boxSizing="border-box";const i=document.createElement("label");i.style.display="flex",i.style.alignItems="center",i.style.marginBottom="15px";const o=document.createElement("input");o.type="checkbox",o.checked=this.currentConfig.AUTO_RATE_ENABLED,o.style.marginRight="10px";const a=document.createElement("span");a.textContent="–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–æ—Ü–µ–Ω–∫—É –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π",i.appendChild(o),i.appendChild(a);const r=document.createElement("div");r.style.display="flex",r.style.justifyContent="space-between",r.style.marginTop="20px";const l=document.createElement("button");l.textContent="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",l.style.padding="10px 20px",l.style.background="#007bff",l.style.color="white",l.style.border="none",l.style.borderRadius="4px",l.style.cursor="pointer";const d=document.createElement("button");d.textContent="–û—Ç–º–µ–Ω–∞",d.style.padding="10px 20px",d.style.background="#6c757d",d.style.color="white",d.style.border="none",d.style.borderRadius="4px",d.style.cursor="pointer",r.appendChild(l),r.appendChild(d),t.appendChild(n),t.appendChild(s),t.appendChild(i),t.appendChild(r),this.modal.appendChild(e),this.modal.appendChild(t);const c=document.createElement("div");c.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0,0,0,0.5);\n            z-index: 9999;\n        ";const g=()=>{document.body.removeChild(c),document.body.removeChild(this.modal),this.modal=null};c.addEventListener("click",g),d.addEventListener("click",g),l.addEventListener("click",()=>{const e=s.value;if(e<10||e>200)return void alert("–ú–∞—Å—à—Ç–∞–± –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 10 –¥–æ 200%");const t={ZOOM_LEVEL:`${e}%`,AUTO_RATE_ENABLED:o.checked};this.onSave(t),g()}),document.body.appendChild(c),document.body.appendChild(this.modal)}parseZoomValue(e){if("string"==typeof e){const t=parseInt(e.replace("%",""),10);return isNaN(t)?80:t}return 80}hide(){this.modal&&(this.modal.style.display="none")}}class d{constructor({eventBus:e,configManager:t}){this.eventBus=e,this.configManager=t,this.configUI=null}init(){this.setupEventListeners(),this.configManager.registerMenuCommands(this.eventBus)}setupEventListeners(){this.eventBus.on("config:show-ui",()=>this.showConfigUI())}showConfigUI(){try{if(this.configUI)return void this.configUI.show();this.configUI=new l(this.configManager.config,async e=>{await this.configManager.saveConfig(e)&&this.eventBus.emit("config:updated")}),this.configUI.show()}catch(e){console.error("Failed to load ConfigUI module:",e)}}cleanup(){this.eventBus.off("config:show-ui",()=>this.showConfigUI())}}class c{constructor(){this.eventBus=new n,this.configManager=new t,this.modules=new Map,this.isInitialized=!1}async init(){if(!this.isInitialized)try{"undefined"==typeof GM_registerMenuCommand&&console.warn("GM —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ú–µ–Ω—é –Ω–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ."),await this.configManager.loadConfig(),this.initModules(),this.isInitialized=!0,this.eventBus.emit("app:initialized")}catch(e){console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:",e)}}initModules(){this.modules.set("attendance",new a({eventBus:this.eventBus,config:this.configManager.config})),this.modules.set("autoRater",new r({eventBus:this.eventBus,config:this.configManager.config})),this.modules.set("ui",new d({eventBus:this.eventBus,configManager:this.configManager})),this.modules.forEach(e=>e.init())}getModule(e){return this.modules.get(e)}cleanup(){this.modules.forEach(e=>e.cleanup()),this.eventBus.cleanup()}}(async()=>{const e=new c;await e.init(),window.addEventListener("unload",()=>e.cleanup())})()}();
