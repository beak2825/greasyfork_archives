// ==UserScript==
// @name			排骨的 UGC 平台分发助手
// @namespace		http://tampermonkey.net/
// @version			0.11
// @description		支持 markdown 文本导入 (什么值得买)
// @author			cuteribs
// @match			https://post.smzdm.com/*
// @grant			GM.xmlHttpRequest
// @require			https://cdn.staticfile.org/marked/0.7.0/marked.min.js
// @downloadURL https://update.greasyfork.org/scripts/389579/%E6%8E%92%E9%AA%A8%E7%9A%84%20UGC%20%E5%B9%B3%E5%8F%B0%E5%88%86%E5%8F%91%E5%8A%A9%E6%89%8B.user.js
// @updateURL https://update.greasyfork.org/scripts/389579/%E6%8E%92%E9%AA%A8%E7%9A%84%20UGC%20%E5%B9%B3%E5%8F%B0%E5%88%86%E5%8F%91%E5%8A%A9%E6%89%8B.meta.js
// ==/UserScript==

"use strict";Array.prototype.split=function(e){for(var t=[],i=0;i<this.length;)t.push(this.slice(i,i+e)),i+=e;return t};var maxTask=3,editorId="test.smzdm.com"==location.host?"report_desc":"yuanchuang",editor=UE.getEditor(editorId);editor.ready(function(){var e=new marked.Renderer;e.code=function(e,t,i){return"<blockquote>"+e.split("\n").join("<br/>")+"</blockquote>"},e.heading=function(e,t){return t++,t>7?"<p>"+e+"</p>":"<h"+t+">"+e+"</h"+t+">"},e.blockquote=function(e){return"<blockquote>"+e+"</blockquote>"},e.image=function(e,t,i){return'<dir class="img-body"><img title="'+t+'" alt="'+i+'" src="'+e+'" class="uploading" /></dir>'},e.list=function(e,t,i){return t?'<ol class="list-paddingleft-2" style="list-style-type: decimal;">'+e+"</ol>":'<ul class="list-paddingleft-2" style="list-style-type: disc;">'+e+"</ul>"};var t=function(e){return new Promise(function(t,i){var n=e.src,a=void 0;switch(n.substring(n.lastIndexOf("."))){case".jpg":a="image/jpg";break;case".gif":a="image/gif";break;default:a="image/png"}GM.xmlHttpRequest({url:n,method:"GET",responseType:"blob",onload:function(n){var d=new Blob([n.response],{type:a}),o=void 0,r=$("#id").val();o="report_desc"==editorId?"https://test.smzdm.com/public/ue_editor/pic_manage?act=uploadImg&type=probreport&uid=&osid="+r:"https://post.smzdm.com/ajax_res?action=uploadImg&id="+r+"&uid=&key=D7326DC2462053A1334080DA5490537C",d.name||(d.name="image.png",d.lastModifiedDate=new Date);var l=new FormData;l.append("id","WU_FILE_"+d.lastModifiedDate.valueOf()),l.append("name",d.name),l.append("type",d.type),l.append("lastModifiedDate",d.lastModifiedDate),l.append("size",d.size),l.append("imgFile",d,d.name),$.ajax({url:o,method:"POST",data:l,processData:!1,contentType:!1,dataType:"json"}).done(function(n){n&&0==n.error?(e.src=e._src=n.url.substr(n.url.indexOf(":")+1),t()):i()})}})})},i=function(i){var n=$($("#ueditor_0")[0].contentWindow.document.body),a=marked(i,{renderer:e});n.html(a);var d=n.find("img.uploading").toArray().map(function(e){return t(e)}).split(maxTask).map(function(e){return Promise.all(e)});Promise.all(d)},n=$('\n<div class="edui-box edui-button edui-for-preview edui-default">\n\t<div class="edui-default">\n\t\t<div class="edui-button-wrap edui-default">\n\t\t\t<div unselectable="on" class="edui-button-body edui-default">\n\t\t\t\t<label class="edui-box edui-label edui-default" style="color: red; cursor: pointer; font-weight: bold;" for="upload-md">导入 MD</label>\n\t\t\t\t<input type="file" accept=".md,.txt" id="upload-md" style="display: none" />\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n\t');n.insertBefore("#edui57"),n.find("#upload-md").on("change",function(e){var t=e.currentTarget;if(1===t.files.length){var n=new FileReader;n.readAsText(t.files[0],"UTF-8"),n.onload=function(e){return i(e.target.result)},n.onerror=function(e){return alert(e)}}})});