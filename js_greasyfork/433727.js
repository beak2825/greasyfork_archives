// ==UserScript==
// @name        吉客云工具条
// @version     0.1.17
// @author      wangxiang<forhot2000@qq.com>
// @description 吉客云自定义工具按钮条
// @match       https://web.jackyun.com/oms/order/order_queryv2.html*
// @match       https://web.jackyun.com/oms/order/order_auditv2.html*
// @namespace   https://github.com/forhot2000
// @icon        https://web.jackyun.com/favicon.ico
// @license     ISC
// @grant       GM_notification
// @grant       GM_setClipboard
// @downloadURL https://update.greasyfork.org/scripts/433727/%E5%90%89%E5%AE%A2%E4%BA%91%E5%B7%A5%E5%85%B7%E6%9D%A1.user.js
// @updateURL https://update.greasyfork.org/scripts/433727/%E5%90%89%E5%AE%A2%E4%BA%91%E5%B7%A5%E5%85%B7%E6%9D%A1.meta.js
// ==/UserScript==

!function(t){var i={};function e(r){if(i[r])return i[r].exports;var n=i[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,e),n.l=!0,n.exports}e.m=t,e.c=i,e.d=function(t,i,r){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:r})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(e.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var n in t)e.d(r,n,function(i){return t[i]}.bind(null,n));return r},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=0)}([function(t,i,e){"use strict";e.r(i);async function r(t){return new Promise((i,e)=>{setTimeout(()=>{e(new Error("timeout"))},t)})}async function n(t,i){var e=new Promise((i,e)=>{var r=setInterval(()=>{var n=t();if(!1!==n)return null==n?(clearInterval(r),e(new Error("Must return value from callback, return false if not ready, return true or actual value if ready, dont't return undefined or null value."))):(clearInterval(r),i(n))},100)});return Promise.race([e,r(i||3e4)])}async function o(t,i){for(var{maxRetryCount:e=3}=i,r=0,n=null;r<e;)try{return void await Promise.resolve(t())}catch(t){r++,n=t}throw n}function s(){console.log.apply(console,Array.from(arguments))}function a(){console.log.apply(console,Array.from(arguments))}function c(t){var i=()=>{GM_setClipboard(t),GM_notification({title:"成功",text:"已复制到剪贴板。",timeout:3e3})},e=$("<div>").css({position:"fixed",inset:0,background:"#d3d3d380",zIndex:1e3}).appendTo(document.body),r=$("<div>").css({position:"absolute",inset:"15%",margin:"auto",background:"#d3d3d3",border:"1px solid #333",padding:5,display:"flex",flexDirection:"column"}).appendTo(e),n=($("<textarea>").attr({disabled:!0}).val(t).css({flex:1}).appendTo(r),$("<div>").css({display:"flex",flexDirection:"row"}).appendTo(r));$("<button>").text("一键复制").on("click",i).css({flex:1,marginRight:10,marginTop:5,height:30}).appendTo(n),$("<a>").attr("href","https://admin.aijimu.cc/tools/extract-order/").attr("target","_blank").append($("<button>").text("提取收件人").css({width:"100%",height:30})).css({flex:1,marginRight:10,marginTop:5}).appendTo(n),$("<button>").text("关闭").on("click",()=>{e.remove()}).css({flex:1,marginTop:5,height:30}).appendTo(n);i()}class l{constructor(t){this.context={...t},this.context.$grid=$("#gridOrder"),this.context.colNames=["订单编号","网店订单号","收货人","手机","收货地址"]}async scrape(){var{$grid:t}=this.context,i=this.context.cols=this.getCols();s("cols:",i);var e=this.context.rows=[],r=this.context.jyIdMap={},n=this.context.wdIdMap={};s("start...");var o=t.find(".mini-grid-rows-view"),l=this.getGridRows(),d=o.height();s("rows count in page:",l.length);for(let t=0;t<l.length;t++){var w=l.eq(t),g=w.position().top,u=o.scrollTop();(g<u||g>u+d-30)&&o.scrollTop(g);var h=this.getValues(w,i);s("row:",t,h);var[x,f]=h;if(!r[x]){if(f&&n[f]){var v=n[f];h=[...h.slice(0,2),...v.slice(2)]}else{await this.unlock(t,i[3].index);var p=this.getGridRow(t);h=this.getValues(p,i)}e.push(h),r[x]=!0,n[f]=h}}a("all finished.",e),c(JSON.stringify(e))}getGridRows(){var{$grid:t}=this.context;return t.find(".mini-grid-rows-view .mini-grid-row")}getGridRow(t){var{$grid:i}=this.context;return i.find(".mini-grid-rows-view .mini-grid-row").eq(t)}getCols(){var{$grid:t,colNames:i}=this.context,e=t.find(".mini-grid-columns-view .mini-grid-headerCell").get().map(t=>t.innerText);return i.map(t=>{var i=e.findIndex(i=>i===t);return{name:t,index:i}})}getValues(t,i){return i.map(i=>t.find(".mini-grid-cell").eq(i.index).text().trim())}async unlock(t,i){s("unlock row:",t);try{await o(async()=>{var e=this.getGridRow(t).find(".mini-grid-cell").eq(i).find(".grid-sensitive-lock");s("click the lock.",t,i),e.click(),await n(()=>!this.getGridRow(t).find(".mini-grid-cell").eq(i).find(".grid-sensitive-lock").length,300)},{maxRetryCount:10})}catch(t){throw a("rows:",this.context.rows),new Error("wait unlock: "+(t.message||t))}}}class d{constructor(t){this.context={...t},this.context.$grid=$("#gridOrder"),this.context.colNames=["订单编号","网店订单号","收货人","手机","收货地址"]}async scrape(){var{$grid:t}=this.context;s("cols:",this.context.cols=this.getCols());var i=this.context.$scroll=t.find(".mini-grid-vscroll");a({viewportHeight:this.context.viewportHeight=i.height(),totalHeight:this.context.totalHeight=i.find(".mini-grid-vscroll-content").height()});var e=this.context.rows=[];for(this.context.jyIdMap={},this.context.wdIdMap={},await this.scrollTop(),s("start...");;){await this.scrapePage();var r=await this.nextPage();if(s("position: "+this.getScrollPosition()),!r)break}a("all finished.",e),c(JSON.stringify(e))}async scrapePage(){var{cols:t,rows:i,jyIdMap:e,wdIdMap:r}=this.context,n=this.getGridRows();s("rows count in page:",n.length);for(let g=0;g<n.length;g++){var o=this.getGridRow(g),a=this.getValues(o,t);s("row:",g,a);var[c,l]=a;if(!e[c]){if(l&&r[l]){var d=r[l];a=[...a.slice(0,2),...d.slice(2)]}else{await this.unlock(g,t[3].index);var w=this.getGridRow(g);a=this.getValues(w,t)}i.push(a),e[c]=!0,r[l]=a}}}getGridRows(){var{$grid:t}=this.context;return t.find(".mini-grid-rows-view .mini-grid-row")}getGridRow(t){var{$grid:i}=this.context;return i.find(".mini-grid-rows-view .mini-grid-row").eq(t)}getScrollPosition(){const{$grid:t}=this.context;return t.find(".mini-grid-rows-view .mini-grid-virtualscroll-top").height()}async nextPage(){return s("scroll to next page"),await this.scrollDown(1)}async scrollTop(){var t=this.getScrollPosition();0!==t&&(s("scroll to top"),await this.scrollTo(0,t),await this.waitForSensitiveData(),await async function(t){return new Promise((i,e)=>{setTimeout(()=>{i()},t)})}(100))}async scrollDown(t){var{viewportHeight:i,totalHeight:e}=this.context,r=this.getScrollPosition(),n=r+i*t;return s(`targetPosition: ${n}, position: ${r}, viewportHeight: ${i}, totalHeight: ${e}`),!(n>e-40)&&(await this.scrollTo(n,r),await this.waitForSensitiveData(),!0)}async scrollTo(t,i){var{$scroll:e}=this.context;try{await o(async()=>{e.scrollTop(t),await n(()=>this.getScrollPosition()!==i,300)},{maxRetryCount:3})}catch(t){throw a("rows:",this.context.rows),new Error("wait scroll to: "+(t.message||t))}}getCols(){var{$grid:t,colNames:i}=this.context,e=t.find(".mini-grid-columns-view .mini-grid-headerCell").get().map(t=>t.innerText);return i.map(t=>{var i=e.findIndex(i=>i===t);return{name:t,index:i}})}getValues(t,i){return i.map(i=>t.find(".mini-grid-cell").eq(i.index).text().trim())}toObject(t,i){return t.reduce((t,e,r)=>(t[e.name]=i[r],t),{})}async waitForSensitiveData(t){var{cols:i}=this.context,e=i[3].index;return n(()=>{var t=this.getGridRows();for(let r=0;r<t.length;r++){var i=t.eq(r).find(".mini-grid-cell").eq(e).text();if(i.startsWith("~"))return s("wait for sensitive:",r,i),!1}return s("wait for sensitive data end."),!0},t).catch(t=>(a("rows:",this.context.rows),Promise.reject(new Error("wait sensitive data: "+(t.message||t)))))}async unlock(t,i){s("unlock row:",t);try{await o(async()=>{var e=this.getGridRow(t).find(".mini-grid-cell").eq(i).find(".grid-sensitive-lock");s("click the lock.",t,i),e.click(),await n(()=>!this.getGridRow(t).find(".mini-grid-cell").eq(i).find(".grid-sensitive-lock").length,300)},{maxRetryCount:10})}catch(t){throw a("rows:",this.context.rows),new Error("wait unlock: "+(t.message||t))}}}function w(t){var i=$("<div>").css({position:"fixed",top:40,right:20,display:"flex",flexDirection:"column",zIndex:100});t.forEach(t=>{!function(t,i){var e=$("<button>").css({width:30,height:30,marginBottom:10,padding:"2px"}).on("click",()=>{e.attr("disabled",!0),Promise.resolve(i.onClick()).catch(t=>{console.error(t)}).finally(()=>{e.attr("disabled",!1)})});if(i.icon){var r=$("<i>").attr({title:i.title}).css({display:"block",width:"100%",height:"100%",backgroundImage:`url(${i.icon})`,backgroundRepeat:"no-repeat"});e.append(r)}else i.text&&e.text(i.text);e.appendTo(t)}(i,t)}),i.appendTo(document.body)}async function g(){var t=$("#gridOrder .mini-grid-rows-view .mini-grid-rowstable").length?new l:new d;t&&await t.scrape()}window.addEventListener("load",(function(){w([{icon:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/Pjxzdmcgdmlld0JveD0iMCAwIDI0IDI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjx0aXRsZS8+PHBhdGggZD0iTTE4LDIxSDZhMywzLDAsMCwxLTMtM1Y2QTMsMywwLDAsMSw2LDNoNGExLDEsMCwwLDEsMCwySDZBMSwxLDAsMCwwLDUsNlYxOGExLDEsMCwwLDAsMSwxSDE4YTEsMSwwLDAsMCwxLTFWMTRhMSwxLDAsMCwxLDIsMHY0QTMsMywwLDAsMSwxOCwyMVoiIGZpbGw9IiM0NjQ2NDYiLz48cGF0aCBkPSJNMjEsNC4wNXY1YTEsMSwwLDAsMS0uNjIuOTIuODQuODQsMCwwLDEtLjM4LjA4LDEsMSwwLDAsMS0uNzEtLjI5TDE3LjQ1LDhsLTQuNzksNC43OWExLDEsMCwwLDEtMS40MiwwLDEsMSwwLDAsMSwwLTEuNDJMMTYsNi41NSwxNC4yNCw0Ljc2QTEsMSwwLDAsMSwxNCwzLjY3LDEsMSwwLDAsMSwxNSwzLjA1aDVhLjczLjczLDAsMCwxLC4yNSwwLC4zNy4zNywwLDAsMSwuMTQsMCwuOTQuOTQsMCwwLDEsLjUzLjUzLjM3LjM3LDAsMCwxLDAsLjE0QS43My43MywwLDAsMSwyMSw0LjA1WiIgZmlsbD0iIzQ2NDY0NiIvPjwvc3ZnPg==",title:"获取收件人",onClick:g}])}))}]);