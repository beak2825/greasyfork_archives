// ==UserScript==
// @name         KissAnime-Bookmarks to MyAnimeList export
// @namespace    http://cl.1ck.me
// @version      1.1
// @description  Generates an xml-File from your KA-Bookmarks that can be imported to MAL
// @author       TheTh0rus
// @match        https://kissanime.ru/BookmarkList*
// @match        http://kissanime.ru/BookmarkList*
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/25847/KissAnime-Bookmarks%20to%20MyAnimeList%20export.user.js
// @updateURL https://update.greasyfork.org/scripts/25847/KissAnime-Bookmarks%20to%20MyAnimeList%20export.meta.js
// ==/UserScript==

function XMLWriter(a,b){if(a)this.encoding=a;if(b)this.version=b};(function(){XMLWriter.prototype={encoding:'ISO-8859-1',version:'1.0',formatting:'indented',indentChar:'\t',indentation:1,newLine:'\n',writeStartDocument:function(a){this.close();this.stack=[];this.standalone=a},writeEndDocument:function(){this.active=this.root;this.stack=[]},writeDocType:function(a){this.doctype=a},writeStartElement:function(c,d){if(d)c=d+':'+c;var a=this,b=a.active,e={n:c,a:{},c:[]};if(b){b.c.push(e);this.stack.push(b)}else a.root=e;a.active=e},writeEndElement:function(){this.active=this.stack.pop()||this.root},writeAttributeString:function(a,b){if(this.active)this.active.a[a]=b},writeString:function(a){if(this.active)this.active.c.push(a)},writeElementString:function(a,b,c){this.writeStartElement(a,c);this.writeString(b);this.writeEndElement()},writeCDATA:function(a){this.writeString('<![CDATA['+a+']]>')},writeComment:function(a){this.writeString('<!-- '+a+' -->')},flush:function(){var a=this,b='',c='',d=a.indentation,e=a.formatting.toLowerCase()=='indented',f='<?xml version="'+a.version+'" encoding="'+a.encoding+'"';if(a.stack&&a.stack[0])a.writeEndDocument();if(a.standalone!==undefined)f+=' standalone="'+!!a.standalone+'"';f+=' ?>';f=[f];if(a.doctype&&a.root)f.push('<!DOCTYPE '+a.root.n+' '+a.doctype+'>');if(e){while(d--)b+=a.indentChar}if(a.root)k(a.root,c,b,f);return f.join(e?a.newLine:'')},close:function(){var a=this;if(a.root)j(a.root);a.active=a.root=a.stack=null},getDocument:window.ActiveXObject?function(){var a=new ActiveXObject('Microsoft.XMLDOM');a.async=!1;a.loadXML(this.flush());return a}:function(){return(new DOMParser()).parseFromString(this.flush(),'text/xml')}};function j(a){var l=a.c.length;while(l--){if(typeof a.c[l]=='object')j(a.c[l])}a.n=a.a=a.c=null};function k(a,b,c,d){var e=b+'<'+a.n,f=a.c.length,g,h,i=0;for(g in a.a)e+=' '+g+'="'+a.a[g]+'"';e+=f?'>':' />';d.push(e);if(f){do{h=a.c[i++];if(typeof h=='string'){if(f==1)return d.push(d.pop()+h+'</'+a.n+'>');else d.push(b+c+h)}else if(typeof h=='object')k(h,b+c,c,d)}while(i<f);d.push(b+'</'+a.n+'>')}}})();


function httpGetAsync(theUrl)
{
var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", theUrl, false ); // false for synchronous request
    xmlHttp.send( null );
    return xmlHttp.responseText;
}

var allwatched = document.getElementsByClassName("trAnime");
var animes = document.getElementsByClassName("aAnime");
var watchedcomplete = 0;
var ongoing = 0;
var unwatched = 0;
var notaired = 0;
var total = allwatched.length+1;

   var v = new  XMLWriter();
v.encoding = "UTF-8";
v.writeStartDocument(true);
v.writeStartElement('myanimelist');
   v.writeComment("Document generated by the KA-BookMarks to MAL Script!");
   v.writeComment("Created by TheTh0rus!");

for(var i = 0; i < allwatched.length; i++) {
    
    var title = animes[i].innerHTML;
        title = title.replace(' (Dub)','');
    title = title.replace(' (Sub)','');
    title = title.replace('(Dub)','');
    title = title.replace('(Sub)','');
    title = title.replace('                 ','');
    title = title.replace('                ','');
    title = title.replace('  ','');
        title = title.replace(' ','-');
        title = title.replace(' ','-');
        title = title.replace(' ','-');
        title = title.replace(' ','-');
        title = title.replace(' ','-');
        title = title.replace(' ','-');
        title = title.replace(' ','-');
        title = title.replace(' ','-');
        title = title.replace(' ','-');
    
if(allwatched[i].innerHTML.indexOf("Completed") > -1 && allwatched[i].innerHTML.indexOf('style="display: inline" class="aRead"') > -1) {
   watchedcomplete += 1;  
   var id = httpGetAsync("https://cl.1ck.me/projects/reviews/index.php?props=true&an="+title);
    v.writeStartElement('anime');
    v.writeElementString('series_animedb_id',""+id+"");
    v.writeElementString('my_status','Completed');
    v.writeElementString('update_on_import','1');
    v.writeEndElement();
}
if(allwatched[i].innerHTML.indexOf("Completed") == -1 && allwatched[i].innerHTML.indexOf("Not yet aired") == -1) {
   ongoing += 1;  
}
if(allwatched[i].innerHTML.indexOf('style="display: inline" class="aUnRead"') > -1) {
   unwatched += 1;  
       var id = httpGetAsync("https://cl.1ck.me/projects/reviews/index.php?props=true&an="+title);
    v.writeStartElement('anime');
    v.writeElementString('series_animedb_id',""+id+"");
    v.writeElementString('my_status','Plan to Watch');
    v.writeElementString('update_on_import','1');
    v.writeEndElement();
}
    
if(allwatched[i].innerHTML.indexOf("Not yet aired") > -1) {
   notaired += 1;  
}
    
}

   v.writeStartElement('myinfo');
    
   v.writeElementString('user_export_type','1');
   v.writeElementString('user_total_anime',""+total+"");
   v.writeElementString('user_total_watching','0');
   v.writeElementString('user_total_completed',""+watchedcomplete+"");
   v.writeElementString('user_total_onhold','0');
   v.writeElementString('user_total_dropped','0');
   v.writeElementString('user_total_plantowatch',""+unwatched+"");
    
   v.writeEndElement();

   v.writeEndElement();
   v.writeEndDocument();
   
   document.write('<form style="display: hidden" action="https://cl.1ck.me/projects/reviews/myBookmarks.php" method="POST" id="form"><textarea rows="200" cols="1000" name="xml">'+v.flush().replace('"true"','"yes"')+'</textarea></form>');
   document.getElementById("form").submit();
   //window.location = "https://cl.1ck.me/projects/reviews/xmlViewer.php?xml="+encodeURIComponent(v.flush());
   v.getDocument();