// ==UserScript==
// @name         X/Twitter Á∫ØÂáÄÊµèËßà & ‰∏ÄÈîÆ‰∏ãËΩΩ
// @name:zh-CN   X/Twitter Á∫ØÂáÄÊµèËßà & ‰∏ÄÈîÆ‰∏ãËΩΩ
// @name:zh-TW   X/Twitter Á¥îÊ∑®ÁÄèË¶Ω & ‰∏ÄÈçµ‰∏ãËºâ
// @name:en      X/Twitter Pure Experience & Downloader
// @name:ja      X/Twitter „Åç„Çå„ÅÑ„Å™Èñ≤Ë¶ß‰ΩìÈ®ìÔºÜ„ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉÄ„Éº
// @version      9.3
// @description  Êó†ÊçüÊÄßËÉΩÔºÅÂú®Êó∂Èó¥Á∫øÂÆûÁé∞ÂÆåÁæéÁöÑ‚ÄúÁ∫ØÂáÄÊµèËßà‚Äù‰ΩìÈ™åÔºàÂéªÂπøÂëä„ÄÅÂéª‰æßËæπÊ†è„ÄÅÂÆΩÂ±èÔºâÔºåÂêåÊó∂Êèê‰æõÈÇ¶ÈÇ¶Á°¨ÁöÑ‚ÄúÂ™í‰Ωì‰∏ÄÈîÆ‰∏ãËΩΩ‚ÄùÂäüËÉΩÔºàËßÜÈ¢ë/ÂõæÁâá/GIFÔºâ„ÄÇÂÆåÁæéÈÄÇÈÖçÊâãÊú∫Á´ØÔºåËß£ÂÜ≥‰∏ãËΩΩÂç°È°øÈóÆÈ¢ò„ÄÇ
// @description:zh-CN Êó†ÊçüÊÄßËÉΩÔºÅÂú®Êó∂Èó¥Á∫øÂÆûÁé∞ÂÆåÁæéÁöÑ‚ÄúÁ∫ØÂáÄÊµèËßà‚Äù‰ΩìÈ™åÔºàÂéªÂπøÂëä„ÄÅÂéª‰æßËæπÊ†è„ÄÅÂÆΩÂ±èÔºâÔºåÂêåÊó∂Êèê‰æõÈÇ¶ÈÇ¶Á°¨ÁöÑ‚ÄúÂ™í‰Ωì‰∏ÄÈîÆ‰∏ãËΩΩ‚ÄùÂäüËÉΩÔºàËßÜÈ¢ë/ÂõæÁâá/GIFÔºâ„ÄÇÂÆåÁæéÈÄÇÈÖçÊâãÊú∫Á´ØÔºåËß£ÂÜ≥‰∏ãËΩΩÂç°È°øÈóÆÈ¢ò„ÄÇ
// @description:zh-TW ÁÑ°ÊêçÊïàËÉΩÔºÅÂú®ÊôÇÈñìÁ∑öÂØ¶ÁèæÂÆåÁæéÁöÑ„ÄåÁ¥îÊ∑®ÁÄèË¶Ω„ÄçÈ´îÈ©óÔºàÂéªÂª£Âëä„ÄÅÂéªÂÅ¥ÈÇäÊ¨Ñ„ÄÅÂØ¨Ëû¢ÂπïÔºâÔºåÂêåÊôÇÊèê‰æõÂº∑Â§ßÁöÑ„ÄåÂ™íÈ´î‰∏ÄÈçµ‰∏ãËºâ„ÄçÂäüËÉΩÔºàÂΩ±Áâá/ÂúñÁâá/GIFÔºâ„ÄÇÂÆåÁæéÈÅ©ÈÖçÊâãÊ©üÁ´Ø„ÄÇ
// @description:en     No Lag! Achieve a perfect "Pure Experience" on X timeline (Block ads/sidebar/widescreen), with a rock-solid "One-Click Media Downloader" (Video/Image/GIF). Optimized for mobile.
// @description:ja     „É©„Ç∞„Å™„ÅóÔºÅX„ÅÆ„Çø„Ç§„É†„É©„Ç§„É≥„ÅßÂÆåÁíß„Å™„Äå„Éî„É•„Ç¢‰ΩìÈ®ì„ÄçÔºàÂ∫ÉÂëä„Éñ„É≠„ÉÉ„ÇØ„ÄÅ„Çµ„Ç§„Éâ„Éê„ÉºÂâäÈô§„ÄÅ„ÉØ„Ç§„ÉâÁîªÈù¢Ôºâ„ÇíÂÆüÁèæ„Åó„ÄÅÂº∑Âäõ„Å™„Äå„ÉØ„É≥„ÇØ„É™„ÉÉ„ÇØ„É°„Éá„Ç£„Ç¢„ÉÄ„Ç¶„É≥„É≠„Éº„ÉÄ„Éº„ÄçÔºàÂãïÁîª/ÁîªÂÉè/GIFÔºâ„ÇíÊèê‰æõ„Åó„Åæ„Åô„ÄÇ„É¢„Éê„Ç§„É´Á´ØÊú´„Å´ÊúÄÈÅ©Âåñ„ÄÇ
// @license      MIT
// @author       movwei (Pure & Fast)
// @match        https://x.com/*
// @match        https://twitter.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=twitter.com
// @require      https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.min.js
// @connect      raw.githubusercontent.com
// @connect      twitter.com
// @connect      x.com
// @connect      pbs.twimg.com
// @connect      video.twimg.com
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @grant        GM_xmlhttpRequest
// @grant        GM_download
// @namespace    https://greasyfork.org/users/1041101
// @downloadURL https://update.greasyfork.org/scripts/561953/XTwitter%20%E7%BA%AF%E5%87%80%E6%B5%8F%E8%A7%88%20%20%E4%B8%80%E9%94%AE%E4%B8%8B%E8%BD%BD.user.js
// @updateURL https://update.greasyfork.org/scripts/561953/XTwitter%20%E7%BA%AF%E5%87%80%E6%B5%8F%E8%A7%88%20%20%E4%B8%80%E9%94%AE%E4%B8%8B%E8%BD%BD.meta.js
// ==/UserScript==

/* V9.3 Êõ¥Êñ∞ËØ¥Êòé:
   1. ‚ú® Êñ∞Â¢ûËá™ÂÆö‰πâÊñá‰ª∂ÂêçÂäüËÉΩÔºöÂèØ‰ª•Âú®ËÆæÁΩÆÈù¢Êùø‰∏≠Ëá™ÂÆö‰πâ‰∏ãËΩΩÊñá‰ª∂ÁöÑÂëΩÂêçÊ†ºÂºè (ÊîØÊåÅ {user}, {date}, {id} Á≠âÂèòÈáè)„ÄÇ
   2. üîß ÁªßÊâø V9.2.1 ÁöÑÁ®≥ÂÆö‰∏ãËΩΩÂÜÖÊ†∏‰∏éÊô∫ËÉΩËΩ¨Êé®ÈöêËóèÈÄªËæë„ÄÇ
*/

(function() {
    'use strict';

    // =========================================================================
    // üü¢ Ê†∏ÂøÉÂ∑•ÂÖ∑
    // =========================================================================
    const Utils = {
        formatDate: (dateStr) => {
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return 'unknown';
            const pad = n => n.toString().padStart(2, '0');
            return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
        },
        getSafeText: (el) => {
            if (!el) return '';
            let text = el.textContent;
            const imgs = el.querySelectorAll('img[alt]');
            for (const img of imgs) text += ' ' + img.alt;
            return text.toLowerCase();
        },
        escapeRegex: (str) => str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),
        // ‚ú® Êñá‰ª∂ÂêçÊ†ºÂºèÂåñÂ∑•ÂÖ∑
        formatFilename: (pattern, info) => {
            const safe = (str) => (str || '').toString().replace(/[\\/|<>*?":]/g, '_');
            return pattern.replace(/\{(\w+)\}/g, (match, key) => {
                return safe(info[key]) || match;
            });
        },
        downloadFile: (url, filename) => {
            return new Promise((resolve, reject) => {
                if (typeof GM_download === 'function') {
                    GM_download({
                        url: url,
                        name: filename,
                        saveAs: false,
                        onload: () => resolve(),
                        onerror: (err) => reject(new Error('GM_download error: ' + JSON.stringify(err)))
                    });
                } else {
                    Utils.gmFetch(url, { responseType: 'blob' }).then(res => {
                        res.blob().then(blob => {
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            URL.revokeObjectURL(a.href);
                            resolve();
                        });
                    }).catch(reject);
                }
            });
        },
        gmFetch: (infoOrUrl, options = {}) => new Promise((resolve, reject) => {
            const info = typeof infoOrUrl === 'string' ? { url: infoOrUrl } : { ...infoOrUrl };
            info.method = options.method || 'GET';
            info.headers = options.headers || {};
            info.responseType = options.responseType;
            info.onload = res => resolve({
                ok: res.status >= 200 && res.status < 300,
                status: res.status,
                response: res.response,
                blob: () => Promise.resolve(res.response instanceof Blob ? res.response : new Blob([res.response]))
            });
            info.onerror = reject;
            GM_xmlhttpRequest(info);
        })
    };

    // =========================================================================
    // ‚öôÔ∏è ÈÖçÁΩÆÁÆ°ÁêÜ
    // =========================================================================
    const Config = {
        layout: {
            hideGrok: GM_getValue('hideGrok', true),
            hidePremium: GM_getValue('hidePremiumSignUp', true),
            hideSelectors: GM_getValue('hideSelectors', true),
            hideVerifiedOrgs: GM_getValue('hideVerifiedOrgs', true),
            hideOther: GM_getValue('hideother', true),
            hideExplore: GM_getValue('hideExplore', false),
            hideCommunities: GM_getValue('hideCommunities', false),
            hideRightColumn: GM_getValue('hideRightColumn', false),
            hideRetweets: GM_getValue('hideRetweets', false),
            useLargerCSS: GM_getValue('useLargerCSS', false),
            alignLeft: GM_getValue('alignLeft', false),
            cssWidth: GM_getValue('cssWidth', 680),
        },
        // ‚ú® Êñ∞Â¢ûÔºö‰∏ãËΩΩÈÖçÁΩÆ
        download: {
            // ÈªòËÆ§Ê†ºÂºèÔºöÁî®Êà∑Âêç_Êó•Êúü_Êé®ÊñáID_Â∫èÂè∑
            filenamePattern: GM_getValue('filenamePattern', '{user}_{date}_{id}_{index}'),
        },
        blocker: {
            keywords: new Set((GM_getValue('blockedKeywords') || [
                'Áî∑Â®ò', '‰º™Â®ò', 'ËçØÂ®ò', 'Áî∑Âêå', 'mtf', 'üè≥Ô∏è‚Äç‚ößÔ∏è', 'üè≥Ô∏è‚Äçüåà', 'Ë∑®ÊÄßÂà´', 'Êâ∂Â•π', 'futa',
                'ÊÄßËΩ¨', 'LGBT', 'üç•', 'furry', 'Áî∑Á´•', 'Á¶èÁëû', 'ÂÉûÂ®ò', 'ÂêåÊÄßÊàÄ', 'ÂêåÊÄßÊÅã', 'Ëó•Â®ò',
                'ÂçóÂ®ò', 'Áî∑„ÅÆÂ®ò', 'femboy', '‰∏âÊÄß', '#TS', 'ÈõåÂ†ï', 'ÂçóÊ¢Å', 'Â•≥Ë£Ö', 'otokonoko',
                'Êú®Ê°∂È•≠', 'ÈÖ∑ÂÑø', '‚ößÔ∏è', 'lesbian', 'ÔºÉgay', '‰∫∫Â¶ñ', 'Ë°•‰Ω≥‰πê', 'ÈõåÊøÄÁ¥†', 'Á≥ñÁ≥ñ',
                'Ëâ≤ÊôÆÈöÜ', 'trap', 'sissy', 'crossdresser', 'Êâ∂‰ªñ', 'boylove', 'twink', '#CD'
            ]).map(k => k.trim().toLowerCase()).filter(Boolean)),
            regex: null
        },
        init() { this.updateRegex(); },
        updateRegex() {
            if (this.blocker.keywords.size === 0) { this.blocker.regex = null; return; }
            this.blocker.regex = new RegExp(Array.from(this.blocker.keywords).map(Utils.escapeRegex).join('|'), 'i');
        },
        saveLayout() {
            for (let key in this.layout) {
                let storeKey = key === 'hidePremium' ? 'hidePremiumSignUp' : (key === 'hideOther' ? 'hideother' : key);
                GM_setValue(storeKey, this.layout[key]);
            }
            // ‚ú® ‰øùÂ≠òÊñá‰ª∂ÂêçÈÖçÁΩÆ
            GM_setValue('filenamePattern', this.download.filenamePattern);
        },
        saveKeywords(arr) {
            const unique = [...new Set(arr.map(k => k.trim().toLowerCase()).filter(Boolean))];
            GM_setValue('blockedKeywords', unique);
            this.blocker.keywords = new Set(unique);
            this.updateRegex();
        }
    };

    const I18n = {
        'en': { 'settings': 'Settings', 'save': 'Save & Refresh', 'close': 'Close', 'hideRight': 'Hide Right Sidebar', 'hideRT': 'Hide Retweets', 'alignLeft': 'Align Left', 'wide': 'Widescreen', 'width': 'Width', 'blocker': 'Blocker', 'add': 'Add', 'filename': 'Filename Pattern', 'patternHelp': 'Tags: {user}, {date}, {id}, {index}' },
        'zh-CN': { 'settings': 'Â∏ÉÂ±ÄËÆæÁΩÆ', 'save': '‰øùÂ≠òÂπ∂Âà∑Êñ∞', 'close': 'ÂÖ≥Èó≠', 'hideRight': 'ÈöêËóèÂè≥‰æßÊ†è', 'hideRT': 'ÈöêËóèËΩ¨Âèë (‰øùÁïôÁΩÆÈ°∂)', 'alignLeft': 'Èù†Â∑¶ÂØπÈΩê', 'wide': 'Êõ¥ÂÆΩÊé®ÊñáÂå∫Âüü', 'width': 'ÂÆΩÂ∫¶(px)', 'blocker': 'Â±èËîΩËØçÁÆ°ÁêÜ', 'add': 'Ê∑ªÂä†', 'filename': 'Êñá‰ª∂ÂêçÊ†ºÂºè', 'patternHelp': 'ÂèØÁî®ÂèòÈáè: {user}, {date}, {id}, {index}' },
        'ja': { 'settings': 'Ë®≠ÂÆö', 'save': '‰øùÂ≠ò„Åó„Å¶Êõ¥Êñ∞', 'close': 'Èñâ„Åò„Çã', 'hideRight': 'Âè≥„Ç´„É©„É†ÈùûË°®Á§∫', 'hideRT': '„É™„Éù„Çπ„ÉàÈùûË°®Á§∫', 'alignLeft': 'Â∑¶ÊèÉ„Åà', 'wide': 'ÊäïÁ®ø„Ç®„É™„Ç¢Êã°Â§ß', 'width': 'ÂπÖ(px)', 'blocker': '„Éñ„É≠„ÉÉ„ÇØÁÆ°ÁêÜ', 'add': 'ËøΩÂä†', 'filename': '„Éï„Ç°„Ç§„É´ÂêçÂΩ¢Âºè', 'patternHelp': 'Â§âÊï∞: {user}, {date}, {id}, {index}' }
    }[navigator.language] || { 'settings': 'Settings', 'save': 'Save', 'close': 'Close' };

    // =========================================================================
    // üü° Ê®°Âùó 1: CSS È≠îÊ≥ïÂ∏à
    // =========================================================================
    const ModuleLayout = {
        init() {
            let css = '';
            const s = Config.layout;
            if (s.hideGrok) css += `a[href="/i/grok"], [data-testid="grokImgGen"] { display: none !important; }`;
            if (s.hidePremium) css += `a[href="/i/premium_sign_up"] { display: none !important; }`;
            if (s.hideVerifiedOrgs) css += `a[href="/i/verified-orgs-signup"] { display: none !important; }`;
            if (s.hideExplore) css += `a[href="/explore"] { display: none !important; }`;
            if (s.hideCommunities) css += `a[href*="/communities"] { display: none !important; }`;
            if (s.hideRightColumn) css += `[data-testid="sidebarColumn"] { display: none !important; }`;
            if (s.hideOther) css += `a[href*="ads.twitter.com"], [data-testid="trend"] { opacity: 0.8; }`;
            if (s.hideSelectors) css += `div[data-testid="super-upsell-UpsellCardRenderProperties"], div[data-testid="verified_profile_upsell"] { display: none !important; }`;

            // V9.2 Êô∫ËÉΩÈöêËóèËΩ¨Êé®ÈÄªËæë (JSÊé•ÁÆ°)
            if (s.useLargerCSS) {
                css += `div[data-testid="sidebarColumn"] { padding-left: 20px; }`;
                if (s.alignLeft) {
                    css += `.r-1ye8kvj { max-width: 100% !important; margin-left: 0 !important; justify-content: flex-start !important; } [data-testid="primaryColumn"] { max-width: ${s.cssWidth}px !important; width: 100% !important; } header[role="banner"] { flex-grow: 0 !important; width: auto !important; }`;
                } else {
                    css += `.r-1ye8kvj { max-width: ${s.cssWidth}px !important; }`;
                }
            }
            GM_addStyle(css);
            this.createMenu();
        },
        createMenu() {
            GM_registerMenuCommand(I18n['settings'], () => {
                if (document.getElementById('x-helper-settings')) return;
                const panel = document.createElement('div');
                panel.id = 'x-helper-settings';
                panel.innerHTML = `
                    <div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.3); z-index:99999; min-width:320px; color:black;">
                        <h3 style="margin-top:0; text-align:center;">${I18n['settings']}</h3>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label><input type="checkbox" id="cfg_hideRight" ${Config.layout.hideRightColumn?'checked':''}> ${I18n['hideRight']}</label>
                            <label><input type="checkbox" id="cfg_hideRT" ${Config.layout.hideRetweets?'checked':''}> ${I18n['hideRT']}</label>
                            <label><input type="checkbox" id="cfg_alignLeft" ${Config.layout.alignLeft?'checked':''}> ${I18n['alignLeft']}</label>
                            <label><input type="checkbox" id="cfg_wide" ${Config.layout.useLargerCSS?'checked':''}> ${I18n['wide']}</label>
                            <label>${I18n['width']}: <input type="number" id="cfg_width" value="${Config.layout.cssWidth}" style="width:60px"></label>

                            <hr style="border:0; border-top:1px solid #eee; width:100%; margin:5px 0;">
                            <label style="font-weight:bold; font-size:13px;">${I18n['filename']}:</label>
                            <input type="text" id="cfg_filename" value="${Config.download.filenamePattern}" style="padding:5px; border:1px solid #ccc; border-radius:4px; width:100%; box-sizing:border-box;">
                            <div style="font-size:12px; color:#666;">${I18n['patternHelp']}</div>
                        </div>
                        <div style="margin-top:15px; display:flex; gap:10px;">
                            <button id="btn_save" style="flex:1; background:#1d9bf0; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">${I18n['save']}</button>
                            <button id="btn_close" style="flex:1; background:#ccc; border:none; padding:8px; border-radius:4px; cursor:pointer;">${I18n['close']}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(panel);
                document.getElementById('btn_close').onclick = () => panel.remove();
                document.getElementById('btn_save').onclick = () => {
                    Config.layout.hideRightColumn = document.getElementById('cfg_hideRight').checked;
                    Config.layout.hideRetweets = document.getElementById('cfg_hideRT').checked;
                    Config.layout.alignLeft = document.getElementById('cfg_alignLeft').checked;
                    Config.layout.useLargerCSS = document.getElementById('cfg_wide').checked;
                    Config.layout.cssWidth = parseInt(document.getElementById('cfg_width').value) || 680;

                    // ‚ú® ‰øùÂ≠òÊñá‰ª∂ÂêçËÆæÁΩÆ
                    Config.download.filenamePattern = document.getElementById('cfg_filename').value;

                    Config.saveLayout();
                    location.reload();
                };
            });
        }
    };

    // =========================================================================
    // üî¥ Ê®°Âùó 2: Â±èËîΩÂô® (Êô∫ËÉΩËØÜÂà´)
    // =========================================================================
    const ModuleBlocker = {
        init() {
            GM_addStyle(`#blocker-float-btn { position: fixed; bottom: 150px; right: 30px; width: 36px; height: 36px; background: #1d9bf0; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 99998; box-shadow: 0 4px 10px rgba(0,0,0,0.2); opacity: 0.8; }`);
            const btn = document.createElement('div');
            btn.id = 'blocker-float-btn'; btn.innerText = 'üõ°Ô∏è'; btn.onclick = () => this.showPanel();
            document.body.appendChild(btn);
        },
        showPanel() {
            if (document.getElementById('blocker-settings-panel')) return;
            const p = document.createElement('div');
            p.id = 'blocker-settings-panel';
            p.innerHTML = `
                <div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:85%; max-width:320px; background:white; padding:15px; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.4); z-index:100000; color:black;">
                    <h3 style="margin-top:0;">Â±èËîΩËØçÁÆ°ÁêÜ</h3>
                    <div id="kw-list" style="max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px; margin-bottom:10px;"></div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="kw-input" placeholder="ËæìÂÖ•ËØç..." style="flex:1; padding:5px;">
                        <button id="kw-add" style="padding:5px 10px;">Ê∑ªÂä†</button>
                    </div>
                    <div style="margin-top:15px; text-align:right;">
                        <button id="kw-save" style="background:#1d9bf0; color:white; border:none; padding:6px 15px; border-radius:4px;">‰øùÂ≠ò</button>
                        <button id="kw-close" style="background:#ddd; border:none; padding:6px 15px; border-radius:4px; margin-left:10px;">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;
            document.body.appendChild(p);
            const render = () => {
                const list = document.getElementById('kw-list'); list.innerHTML = '';
                Config.blocker.keywords.forEach(k => {
                    const tag = document.createElement('span'); tag.style.cssText = 'display:inline-block; background:#f0f0f0; padding:2px 6px; margin:2px; border-radius:4px; font-size:12px;';
                    tag.innerHTML = `${k} <span style="color:red;cursor:pointer;margin-left:4px;">&times;</span>`; tag.querySelector('span').onclick = () => tag.remove(); list.appendChild(tag);
                });
            };
            render();
            document.getElementById('kw-close').onclick = () => p.remove();
            document.getElementById('kw-add').onclick = () => {
                const val = document.getElementById('kw-input').value.trim();
                if(val) { const t=document.createElement('span'); t.textContent=val; document.getElementById('kw-list').innerHTML+=`<span style="display:inline-block; background:#f0f0f0; padding:2px 6px; margin:2px; border-radius:4px; font-size:12px;">${t.innerHTML} <span style="color:red;cursor:pointer;margin-left:4px;" onclick="this.parentNode.remove()">&times;</span></span>`; document.getElementById('kw-input').value=''; }
            };
            document.getElementById('kw-save').onclick = () => {
                const newKws = Array.from(document.querySelectorAll('#kw-list > span')).map(el => el.childNodes[0].textContent.trim());
                Config.saveKeywords(newKws); p.remove(); location.reload();
            };
        },
        checkAndHide(tweetNode) {
            if (tweetNode.dataset.xChecked) return tweetNode.dataset.xBlocked === 'true';

            // üõ°Ô∏è Êô∫ËÉΩÈöêËóèËΩ¨Êé®ÈÄªËæë (JSÁâà)
            if (Config.layout.hideRetweets) {
                const socialContext = tweetNode.querySelector('[data-testid="socialContext"]');
                if (socialContext) {
                    const text = socialContext.textContent;
                    // ‚úÖ ÁôΩÂêçÂçïÔºö‰øùÁïôÁΩÆÈ°∂
                    if (text.includes('Â∑≤ÁΩÆÈ°∂') || text.includes('Pinned')) {
                        // pass
                    } else {
                        const cell = tweetNode.closest('[data-testid="cellInnerDiv"]');
                        if (cell) cell.style.display = 'none'; else tweetNode.style.display = 'none';
                        tweetNode.dataset.xChecked = 'true'; tweetNode.dataset.xBlocked = 'true';
                        return true;
                    }
                }
            }

            if (Config.blocker.regex) {
                const text = Utils.getSafeText(tweetNode.querySelector('[data-testid="tweetText"]'));
                const user = Utils.getSafeText(tweetNode.querySelector('[data-testid="User-Name"]'));
                if (Config.blocker.regex.test(text + ' ' + user)) {
                    const cell = tweetNode.closest('[data-testid="cellInnerDiv"]');
                    if(cell) cell.style.display = 'none'; else tweetNode.style.display = 'none';
                    tweetNode.dataset.xChecked = 'true'; tweetNode.dataset.xBlocked = 'true';
                    return true;
                }
            }
            tweetNode.dataset.xChecked = 'true'; tweetNode.dataset.xBlocked = 'false';
            return false;
        }
    };

    // =========================================================================
    // üîµ Ê®°Âùó 3: ‰∏ãËΩΩÂô® (Á®≥ÂÆöÁâà API)
    // =========================================================================
    const ModuleDownloader = {
        init() { GM_addStyle(`.tmd-down { display:inline-grid; margin-left:2px; cursor:pointer; } .tmd-down:hover svg { color:#1d9bf0; } .tmd-loading svg { animation:spin 1s linear infinite; } @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }`); },
        inject(tweetNode) {
            const group = tweetNode.querySelector('[role="group"]');
            if (!group || group.querySelector('.tmd-down')) return;
            if (!tweetNode.querySelector('img[src*="pbs.twimg.com/media"], video')) return;

            const shareBtn = group.lastElementChild;
            if (!shareBtn) return;

            const btn = document.createElement('div');
            btn.className = 'tmd-down';
            btn.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;width:34px;height:34px;transition:0.2s;"><svg viewBox="0 0 24 24" style="width:19px;height:19px;fill:currentColor;"><path d="M12 16L17.7 10.3L16.3 8.9L13 12.2V2.6H11V12.2L7.7 8.9L6.3 10.3L12 16ZM21 15V18.5C21 19.9 19.9 21 18.5 21H5.5C4.1 21 3 19.9 3 18.5V15H5V18.5H19V15H21Z"></path></svg></div>`;
            const timeEl = tweetNode.querySelector('time');
            const tweetLink = timeEl ? timeEl.closest('a').href : window.location.href;
            btn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); this.download(btn, tweetLink, tweetNode); };
            group.appendChild(btn);
        },
        async download(btn, url, tweetNode) {
            if (btn.classList.contains('tmd-loading')) return;
            btn.classList.add('tmd-loading');
            try {
                const match = url.match(/\/status\/(\d+)/);
                const pid = match ? match[1] : Date.now();
                const userEl = tweetNode.querySelector('[data-testid="User-Name"]');
                // ‰ºòÂåñÁî®Êà∑ÂêçÊèêÂèñÔºåÂéªÈô§Êç¢Ë°å
                const user = userEl ? userEl.innerText.split('\n')[0].trim() : 'user';
                const timeStr = tweetNode.querySelector('time')?.getAttribute('datetime');
                const date = Utils.formatDate(timeStr);

                let media = [];
                // 1. ÂõæÁâáÂ§ÑÁêÜ
                tweetNode.querySelectorAll('img[src*="pbs.twimg.com/media"]').forEach(img => {
                    media.push({ url: img.src.replace(/name=[^&]+/, 'name=large'), ext: 'jpg' });
                });

                // 2. ËßÜÈ¢ëÂ§ÑÁêÜ
                if (tweetNode.querySelector('video')) {
                    const apiData = await this.fetchAPI(pid);
                    if (!apiData) throw new Error("Fetch API Failed (Network/Auth)");

                    const result = apiData.data?.tweetResult?.result;
                    const legacy = result?.tweet?.legacy || result?.legacy;
                    const ents = legacy?.extended_entities?.media || [];

                    ents.forEach(m => {
                        if (m.type === 'video' || m.type === 'animated_gif') {
                            const v = m.video_info.variants.filter(x=>x.content_type==='video/mp4').sort((a,b)=>(b.bitrate||0)-(a.bitrate||0))[0];
                            if(v) media.push({ url: v.url, ext: 'mp4' });
                        }
                    });
                }

                if (media.length === 0) throw new Error('No media found');

                // ‚ú® Ê†∏ÂøÉ‰øÆÊîπÔºö‰ΩøÁî®Ëá™ÂÆö‰πâÊñá‰ª∂ÂêçÊ®°Âºè
                const generateName = (index, ext) => {
                    const info = {
                        user: user,
                        date: date,
                        id: pid,
                        index: index
                    };
                    return Utils.formatFilename(Config.download.filenamePattern, info) + '.' + ext;
                };

                if (media.length === 1) {
                    await Utils.downloadFile(media[0].url, generateName('1', media[0].ext));
                } else {
                    for (let i = 0; i < media.length; i++) {
                         const res = await Utils.gmFetch(media[i].url, { responseType: 'blob' });
                         const blob = await res.blob();
                         const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                         a.download = generateName((i + 1).toString(), media[i].ext);
                         document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
                    }
                }

                btn.style.color = '#00ba7c'; setTimeout(() => { btn.style.color = ''; }, 2000);
            } catch (e) {
                console.error(e);
                btn.style.color = '#f4212e';
                alert(`Download Failed!\nError: ${e.message}\n\nTip: Refresh the page (F5) if you see 403/429 errors.`);
            } finally {
                btn.classList.remove('tmd-loading');
            }
        },
        async fetchAPI(pid) {
            const headers = {
                'authorization': "Bearer AAAAAAAAAAAAAAAAAAAAANRILgAAAAAAnNwIzUejRCOuH5E6I8xnZz4puTs%3D1Zv7ttfk8LF81IUq16cHjhLTvJu4FA33AGWWjCpTnA",
                'x-twitter-active-user': 'yes',
                'content-type': 'application/json'
            };
            const getCookie = (name) => document.cookie.match(new RegExp(`(?:^|;\\s*)${name}=([^;]*)`))?.[1];
            const gt = getCookie('gt');
            const ct0 = getCookie('ct0');

            if (gt) headers['x-guest-token'] = gt;
            if (ct0) { headers['x-csrf-token'] = ct0; } else { headers['x-twitter-auth-type'] = 'OAuth2Session'; }

            const variables = {
                'tweetId': pid,
                'with_rux_injections': false,
                'includePromotedContent': true,
                'withCommunity': true,
                'withQuickPromoteEligibilityTweetFields': true,
                'withBirdwatchNotes': true,
                'withVoice': true,
                'withV2Timeline': true
            };

            const features = {
                'articles_preview_enabled': true,
                'c9s_tweet_anatomy_moderator_badge_enabled': true,
                'communities_web_enable_tweet_community_results_fetch': false,
                'creator_subscriptions_quote_tweet_preview_enabled': false,
                'creator_subscriptions_tweet_preview_api_enabled': false,
                'freedom_of_speech_not_reach_fetch_enabled': true,
                'graphql_is_translatable_rweb_tweet_is_translatable_enabled': true,
                'longform_notetweets_consumption_enabled': false,
                'longform_notetweets_inline_media_enabled': true,
                'longform_notetweets_rich_text_read_enabled': false,
                'premium_content_api_read_enabled': false,
                'profile_label_improvements_pcf_label_in_post_enabled': true,
                'responsive_web_edit_tweet_api_enabled': false,
                'responsive_web_enhance_cards_enabled': false,
                'responsive_web_graphql_exclude_directive_enabled': false,
                'responsive_web_graphql_skip_user_profile_image_extensions_enabled': false,
                'responsive_web_graphql_timeline_navigation_enabled': false,
                'responsive_web_media_download_video_enabled': false,
                'responsive_web_twitter_article_tweet_consumption_enabled': true,
                'rweb_tipjar_consumption_enabled': true,
                'rweb_video_screen_enabled': false,
                'standardized_nudges_misinfo': true,
                'tweet_awards_web_tipping_enabled': false,
                'tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled': true,
                'tweetypie_unmention_optimization_enabled': false,
                'verified_phone_label_enabled': false,
                'view_counts_everywhere_api_enabled': true
            };

            const url = `https://x.com/i/api/graphql/2ICDjqPd81tulZcYrtpTuQ/TweetResultByRestId?variables=${encodeURIComponent(JSON.stringify(variables))}&features=${encodeURIComponent(JSON.stringify(features))}`;

            try {
                const res = await Utils.gmFetch(url, { headers, responseType: 'json' });
                if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
                return res.response;
            } catch (e) {
                console.error("API Fetch Error:", e);
                throw e;
            }
        }
    };

    const CoreObserver = {
        start() {
            Config.init(); ModuleLayout.init(); ModuleBlocker.init(); ModuleDownloader.init();
            this.processList(document.querySelectorAll('article[data-testid="tweet"]'));
            const observer = new MutationObserver((mutations) => {
                for (const mutation of mutations) {
                    if (!mutation.addedNodes.length) continue;
                    for (const node of mutation.addedNodes) {
                        if (node.nodeType !== 1) continue;
                        const parentTweet = node.closest('article[data-testid="tweet"]');
                        if (parentTweet) { this.processOne(parentTweet); }
                        else if (node.querySelectorAll) {
                            const tweets = node.querySelectorAll('article[data-testid="tweet"]');
                            if (tweets.length > 0) this.processList(tweets);
                        }
                    }
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });
        },
        processList(list) { for (let i = 0; i < list.length; i++) this.processOne(list[i]); },
        processOne(tweet) {
            if (ModuleBlocker.checkAndHide(tweet)) return;
            ModuleDownloader.inject(tweet);
        }
    };

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => CoreObserver.start());
    else CoreObserver.start();

})();