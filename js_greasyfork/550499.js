// ==UserScript==
// @name         Bilibili 广告跳过助手
// @name:en      Bilibili Ad Skip Assistant
// @name:ja      Bilibili 広告スキップアシスタント
// @name:ko      Bilibili 광고 건너뛰기 도우미
// @name:zh-TW   Bilibili 廣告跳過助手
// @name:zh-HK   Bilibili 廣告跳過助手
// @name:zh-CN   Bilibili 广告跳过助手
// @name:fr      Assistant de saut d'annonces Bilibili
// @name:de      Bilibili Werbung überspringen Assistent
// @name:es      Asistente para saltar anuncios de Bilibili
// @name:ru      Помощник пропуска рекламы Bilibili
// @name:pt      Assistente de pular anúncios do Bilibili
// @name:it      Assistente per saltare annunci Bilibili
// @name:ar      مساعد تخطي إعلانات Bilibili
// @name:nl      Bilibili Advertentie Overslaan Assistent
// @name:sv      Bilibili Reklamhoppnings Assistent
// @name:no      Bilibili Annonse Hopp Assistent
// @name:da      Bilibili Reklame Spring Over Assistent
// @name:fi      Bilibili Mainoksen Ohitus Avustaja
// @name:pl      Asystent pomijania reklam Bilibili
// @name:cs      Asistent přeskočení reklam Bilibili
// @name:hu      Bilibili Hirdetés Kihagyás Asszisztens
// @name:th      ผู้ช่วยข้ามโฆษณา Bilibili
// @name:vi      Trợ lý bỏ qua quảng cáo Bilibili
// @name:tr      Bilibili Reklam Atlama Asistanı
// @name:id      Asisten Lompat Iklan Bilibili
// @name:ms      Pembantu Langkau Iklan Bilibili
// @name:he      עוזר דילוג על פרסומות ב-Bilibili
// @name:uk      Помічник пропуску реклами Bilibili
// @name:ro      Asistent de sărit publicitate Bilibili
// @name:el      Βοηθός παραβίασης διαφημίσεων Bilibili
// @name:hi      बिलिबिली विज्ञापन छलांग सहायक
// @name:bn      বিলিবিলি বিজ্ঞাপন এড়ানো সহায়ক
// @name:fa      دستیار رد کردن آگهی‌های بیلی‌بیلی
// @name:sw      Msaada wa Kuruka Matangazo ya Bilibili
// @name:tl      Tulong sa Pag-skip ng Ad ng Bilibili
// @name:my      ဘီလီဘီလီ ကြော်ငြာများ ခလောက်ကူညီရေး
// @name:km      កម្មវិធីជួយលើកលែងប្រាកដបិលីបីលី
// @name:ne      बिलिबिली विज्ञापन छलांग सहायक
// @name:si      බිලිබිලි ප්‍රචාරණ ඉටු කරන්නා සහායක
// @name:am      በቢሊቢሊ ማስታወቂያ ማስቀጠል አገልግሎት
// @name:yo      Irú Ẹ̀kọ́ Bilibili Tó Ńlọ̀ Síwájú
// @name:ig      Nkwado Bilibili Na-akpata Ngwa
// @name:ha      Taimakon Kashe Bilibili Na Kaya
// @name:zu      Usizo Lokushiya Izinhlelo Zokwengeza Zokwengeza Ku-Bilibili
// @name:ur      بلبلی اشتہارات چھوڑنے میں مددگار
// @name:ta      பிலிபிலி விளம்பரத் தவிர்ப்பு உதவியாளர்
// @name:te      బిలిబిలి ప్రకటనలు దాటవేత సహాయకం
// @name:ml      ബിലിബിലി പ്രചാരണം തവണയ്‌ക്കാനുള്ള സഹായി
// @name:gu      બિલિબિલી જાહેરાત છોડવાનું સહાયક
// @name:pa      ਬਿਲੀਬਿਲੀ ਵਿਗਿਆਪਨ ਛੱਡਣ ਸਹਾਇਕ
// @name:mr      बिलिबिली जाहिरात वगळण्यासाठी सहाय्यक
// @name:kn      ಬಿಲಿಬಿಲಿ ಜಾಹೀರಾತು ಬಿಟ್ಟುಬಿಡುವ ಸಹಾಯಕ
// @name:or      ବିଲିବିଲି ବିଜ୍ଞାପନ ଛାଡ଼ିବା ସହାଯକ
// @name:as      বিলিবিলি বিজ্ঞাপন লাফ দিয়া যোৱা সহায়ক
// @name:mr      बिलिबिली जाहिरात वगळण्यासाठी सहाय्यक
// @name:sa      बिलिबिलि विज्ञापनातिगन्तृसहायकः
// @name:ka      ბილიბილის რეკლამების გავლევის ასისტენტი
// @name:az      Bilibili reklamları keçmək köməkçisi
// @name:hy      Բիլիբիլի գովազդի բաց թողնող օգնական
// @name:eu      Bilibili Publizitate Saltatzeko Laguntzailea
// @name:be      Дапаможнік прапуску рэкламы Bilibili
// @name:bg      Помощник за прескачане на реклами в Bilibili
// @name:ka      ბილიბილის რეკლამების გავლევის ასისტენტი
// @name:lt      Bilibili reklamų praleidimo pagalbininkas
// @name:lv      Bilibili reklāmu izlaizošanas palīgs
// @name:et      Bilibili reklaamide üle hüppamise abiline
// @name:sl      Pomočnik za preskakanje oglasov Bilibili
// @name:hr      Pomoćnik za preskakanje oglasa Bilibili
// @name:sr      Помоћник за прескакање оглада Bilibili
// @name:sk      Asistent na preskakovanie reklám Bilibili
// @name:mk      Помошник за прескокнување на реклами на Bilibili
// @name:bs      Pomoćnik za preskakanje oglasa Bilibili
// @name:sq      Ndihmës për kalimin e reklamave të Bilibili
// @name:mt      Għajnuna għall-ħlas ta' reklami fuq Bilibili
// @name:ga      Cúntóir Chos ar Fhógraí Bilibili
// @name:cy      Cynorthwyydd Neidio Hysbysebion Bilibili
// @name:is      Aðstoðarmaður til að sleppa auglýsingum á Bilibili
// @name:mt      Għajnuna għall-ħlas ta' reklami fuq Bilibili
// @name:lb      Hëllef fir d'Publicitéiten vum Bilibili ze iwwerspringen
// @name:gl      Asistente para saltar anuncios de Bilibili
// @description  通过识别弹幕跳过嵌入式广告段
// @description:en  Skip embedded ad segments by analyzing danmaku comments
// @description:ja  弾幕コメントを分析して埋め込み広告セグメントをスキップ
// @description:ko  댄막 댓글을 분석하여 삽입된 광고 구간을 건너뛰기
// @description:zh-TW  透過識別彈幕跳過嵌入式廣告段
// @description:zh-HK  透過識別彈幕跳過嵌入式廣告段
// @description:zh-CN  通过识别弹幕跳过嵌入式广告段
// @description:fr  Ignorer les segments publicitaires intégrés en analysant les commentaires danmaku
// @description:de  Eingebettete Werbesegmente durch Analyse von Danmaku-Kommentaren überspringen
// @description:es  Saltar segmentos de anuncios integrados analizando comentarios danmaku
// @description:ru  Пропускать встроенные рекламные сегменты, анализируя комментарии danmaku
// @description:pt  Pular segmentos de anúncios incorporados analisando comentários danmaku
// @description:it  Salta i segmenti pubblicitari incorporati analizzando i commenti danmaku
// @description:ar  تخطي مقاطع الإعلانات المدمجة من خلال تحليل تعليقات danmaku
// @description:nl  Sla ingebedde advertentiesegmenten over door danmaku-opmerkingen te analyseren
// @description:sv  Hoppa över inbäddade annonssegment genom att analysera danmaku-kommentarer
// @description:no  Hopp over innebygde annonse-segmenter ved å analysere danmaku-kommentarer
// @description:da  Spring over indlejrede reklamesegmenter ved at analysere danmaku-kommentarer
// @description:fi  Ohita upotetut mainossegmentit analysoimalla danmaku-kommentteja
// @description:pl  Pomiń osadzone segmenty reklamowe analizując komentarze danmaku
// @description:cs  Přeskočte vložené reklamní segmenty analýzou komentářů danmaku
// @description:hu  Ugorja át a beágyazott hirdetési szegmenseket a danmaku megjegyzések elemzésével
// @description:th  ข้ามส่วนโฆษณาที่ฝังอยู่โดยการวิเคราะห์ความคิดเห็น danmaku
// @description:vi  Bỏ qua các phân đoạn quảng cáo nhúng bằng cách phân tích bình luận danmaku
// @description:tr  Danmaku yorumlarını analiz ederek gömülü reklam bölümlerini atlayın
// @description:id  Melompati segmen iklan tertanam dengan menganalisis komentar danmaku
// @description:ms  Langkau segmen iklan tertanam dengan menganalisis komen danmaku
// @description:he  דלג על קטעי פרסומת מוטמעים על ידי ניתוח תגובות דנמאקו
// @description:uk  Пропускати вбудовані рекламні сегменти, аналізуючи коментарі данмаку
// @description:ro  Sariți peste segmentele publicitare integrate prin analizarea comentariilor danmaku
// @description:el  Παράλειψη ενσωματωμένων διαφημιστικών τμημάτων αναλύοντας σχόλια danmaku
// @description:hi  डैनमाकू टिप्पणियों का विश्लेषण करके एम्बेडेड विज्ञापन खंडों को छोड़ें
// @description:bn  ড্যানমাকু মন্তব্য বিশ্লেষণ করে এম্বেডেড বিজ্ঞাপন অংশগুলি এড়িয়ে যান
// @description:fa  رد کردن بخش‌های تبلیغاتی جاسازی‌شده با تحلیل نظرات دانماکو
// @description:sw  Ruka sehemu za tangazo zilizojikunja kwa kuchambua maoni ya danmaku
// @description:tl  Laktawan ang mga embedded na segment ng ad sa pamamagitan ng pag-analisa ng mga komento ng danmaku
// @description:my  ဒန်မကု မတ်ခ်များ အခြေခံပြု၍ ပါဝင်သော ကြော်ငြာအပိုင်းများ ခလောက်ပါ
// @description:km  លើកលែងផ្នែកប្រាកដដែលបានដាក់ដោយការវិភាគមតិក្រមដំណង
// @description:ne  ड्यानमाकु टिप्पणी विश्लेषण गरेर एम्बेडेड विज्ञापन खण्डहरू छल्नुहोस्
// @description:si  ඩැන්මාකු අත්තීන් විශ්ලේෂණය කරුත් ඇම්බෙඩ් විජ්ඞාපන කාංද ඉටු කරන්න
// @description:am  የዳንማኩ አስተያየቶችን በማስተካከል የተጣሉ ማስታወቂያ ክፍሎችን ይለፍቱ
// @description:yo  Ṣe àwárí àwùjọ àdéhùn tó ńgbà danmaku pẹ̀lú ìrísìdúna
// @description:ig  Gbanwee ngwa ahụ nke ejikọtara na danmaku na-emekọta
// @description:ha  Kuɗin kuɗin da aka ƙora a cikin bayanai na danmaku
// @description:zu  Shiya izinhlelo zokwengeza ezingemuke ngokuhlaziya izingcezo zokwengeza
// @description:ur  ڈینماکو تبصروں کا تجزیہ کر کے انبیڈڈ اشتہاری سیکشنوں کو چھوڑ دیں
// @description:ta  டான்மாகு கருத்துகளை பகுப்பாய்வு செய்து பொதிந்த விளம்பர பகுதிகளை தவிர்க்கவும்
// @description:te  డాన్మాకు వ్యాఖ్యలను విశ్లేషించి ఎంబెడెడ్ ప్రకటన విభాగాలను దాటవేయండి
// @description:ml  ഡാൻമാകു അഭിപ്രായങ്ങൾ വിശകലനം ചെയ്യുന്നതിലൂടെ എംബെഡഡ് പ്രചാരണ ഭാഗങ്ങൾ തവണയ്‌ക്കുക
// @description:gu  ડેનમાકુ ટિપ્પણીઓનું વિશ્લેષણ કરીને એમ્બેડેડ જાહેરાત ખંડોને છોડો
// @description:pa  ਡੈਨਮਾਕੂ ਟਿੱਪਣੀਆਂ ਦਾ ਵਿਸ਼ਲੇਸ਼ਣ ਕਰਕੇ ਐਮਬੈਡਡ ਵਿਗਿਆਪਨ ਖੰਡਾਂ ਨੂੰ ਛੱਡੋ
// @description:mr  डॅनमाकू टिप्पण्या विश्लेषण करून एम्बेडेड जाहिरात विभाग सोडा
// @description:kn  ಡ್ಯಾನ್ಮಾಕು ಟಿಪ್ಪಣಿಗಳನ್ನು ವಿಶ್ಲೇಷಿಸುವುದರ ಮೂಲಕ ಎಂಬೆಡೆಡ್ ಜಾಹೀರಾತು ವಿಭಾಗಗಳನ್ನು ಬಿಟ್ಟುಬಿಡಿ
// @description:or  ଡାନ୍ମାକୁ ମନ୍ତବ୍ୟ ବିଶ୍ଳେଷଣ କରି ଏମ୍ବେଡେଡ୍ ବିଜ୍ଞାପନ ଖଣ୍ଡଗୁଡ଼ିକୁ ଛାଡ଼ିବା
// @description:as  ড্যানমাকু মন্তব্য বিশ্লেষণ কৰি এম্বেডেড বিজ্ঞাপন অংশবোৰ এড়াই লওঁক
// @description:sa  दान्माकु-टिप्पणीनां विश्लेषणेन अधिष्ठापितविज्ञापनखण्डानि अतिक्रमतु
// @description:ka  დანმაკუს კომენტარების ანალიზით ჩადებული რეკლამების სეგმენტების გავლევა
// @description:az  Danmaku rəylərini analiz edərək quraşdırılmış reklam segmentlərini keçin
// @description:hy  Դանմակու մեկնաբանությունները վերլուծելով անցեք ներդրված գովազդային հատվածները
// @description:eu  Azaldu danmaku iruzkinak aztertuz txertatutako publizitate atalak
// @description:be  Прапускаць убудаваныя рэкламныя сегменты, аналізуючы каментары данмаку
// @description:bg  Прескачайте вградените рекламни сегменти, като анализирате коментарите на данмаку
// @description:lt  Praleiskite įterptus reklaminius segmentus analizavus danmaku komentarus
// @description:lv  Izlaiziet iegultos reklāmu segmentus, analizējot danmaku komentārus
// @description:et  Jätta vahele sisseehitatud reklaamilõigud danmaku kommentaare analüüsides
// @description:sl  Preskočite vdelane oglasne segmente z analizo danmaku komentarjev
// @description:hr  Preskočite ugrađene oglasne segmente analiziranjem danmaku komentara
// @description:sr  Прескочите уграђене рекламне сегменте анализом коментара данмаку
// @description:sk  Preskočte vložené reklamné segmenty analýzou komentárov danmaku
// @description:mk  Прескокнете вградени рекламни сегменти со анализирање на коментарите на данмаку
// @description:bs  Preskočite ugrađene oglasne segmente analizom danmaku komentara
// @description:sq  Anësoni segmentet e reklamave të futura përmes analizës së komenteve danmaku
// @description:mt  Ħlief segmenti ta' pubbliċità mħaqqda bl-analiżi ta' kummenti danmaku
// @description:ga  Léim thar shnipeacha fógraíochta iompaithe tríd anailís a dhéanamh ar thuarascáil danmaku
// @description:cy  Neidio dros odau hysbysebion meysyddol trwy ddadansoddi sylwadau danmaku
// @description:is  Sleppa innfeldd auglýsingahluta með því að greina danmaku athugasemdir
// @description:lb  Iwwerspringt engemaachte Publicitéitssegmenter duerch d'Analys vun Danmaku Kommentaren
// @description:gl  Saltar segmentos de anuncios integrados analizando comentarios danmaku
// @namespace    http://tampermonkey.net/
// @version      1.1.3
// @author       wzy403, aspen138
// @match        https://www.bilibili.com/video/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @run-at       document-idle
// @license      GPL-3.0
// @icon         https://www.bilibili.com/favicon.ico
// @downloadURL https://update.greasyfork.org/scripts/550499/Bilibili%20%E5%B9%BF%E5%91%8A%E8%B7%B3%E8%BF%87%E5%8A%A9%E6%89%8B.user.js
// @updateURL https://update.greasyfork.org/scripts/550499/Bilibili%20%E5%B9%BF%E5%91%8A%E8%B7%B3%E8%BF%87%E5%8A%A9%E6%89%8B.meta.js
// ==/UserScript==



(function() {
    'use strict';

    // === Global State ===
    let SKIP_MODE = 'manual';  // 'auto' | 'manual'
    let skipped = false;       // Flag to indicate whether the ad has been skipped
    let isBtnAdd = false;      // Whether the skip button has been inserted
    let currentVideo = null;   // Current video element
    let currentAdSkipHandler = null;  // Current timeupdate event handler
    let isSuspiciousAd = false; // Whether the ad was detected using keyword matching (suspicious)
    let countdownTimer = null; // Countdown timer for skipping ads
    const COUNTDOWN = 5; // Countdown duration in seconds
    let settingsPanel = null; // Settings panel element

    let buttonEventHandlers = {
        click: null,
        mouseenter: null,
        mouseleave: null,
        play: null,
        pause: null
    };

    // === Style the skip button ===
    const btn = document.createElement('button');
    Object.assign(btn.style, {
        position: 'absolute',
        right: '24px',
        bottom: '10%',
        padding: '8px 16px',
        background: 'rgba(0, 0, 0, 0.7)',
        color: '#fff',
        border: '1px solid rgba(255, 255, 255, 0.3)',
        borderRadius: '20px',
        fontSize: '14px',
        fontWeight: 'bold',
        cursor: 'pointer',
        zIndex: 999999,
        transition: 'background 0.3s, transform 0.2s',
    });
    btn.addEventListener('mouseenter', () => {
        btn.style.background = 'rgba(0, 0, 0, 0.85)';
        btn.style.transform = 'scale(1.05)';
    });
    btn.addEventListener('mouseleave', () => {
        btn.style.background = 'rgba(0, 0, 0, 0.7)';
        btn.style.transform = 'scale(1)';
    });

    // === Settings Panel Styles ===
    GM_addStyle(`
        .bili-skip-settings {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-width: 180px;
            display: none;
        }

        .bili-skip-settings h4 {
            margin: 0 0 16px 0;
            font-size: 14px;
            color: #333;
        }

        .bili-skip-switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .bili-skip-switch-label {
            font-size: 14px;
            margin-right: 10px;
            white-space: nowrap;
        }

        .bili-skip-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .bili-skip-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .bili-skip-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .bili-skip-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .bili-skip-switch input:checked + .bili-skip-slider {
            background-color: #4caf50;
        }

        .bili-skip-switch input:checked + .bili-skip-slider:before {
            transform: translateX(24px);
        }

        .bili-skip-mode-text {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 8px;
        }

        .bili-skip-close {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }

        .bili-skip-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00a1d6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            z-index: 999999;
            font-size: 12px;
        }
    `);

    // === Create Settings Panel ===
    function createSettingsPanel() {
        const panel = document.createElement('div');
        panel.className = 'bili-skip-settings';
        panel.innerHTML = `
            <button class="bili-skip-close">&times;</button>
            <h4>跳过广告模式</h4>
            <div class="bili-skip-switch-container">
                <span class="bili-skip-switch-label">手动</span>
                <label class="bili-skip-switch">
                    <input type="checkbox" id="biliSkipModeSwitch">
                    <span class="bili-skip-slider"></span>
                </label>
                <span class="bili-skip-switch-label">自动</span>
            </div>
            <div class="bili-skip-mode-text" id="biliSkipModeText">当前：手动跳过</div>
        `;

        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'bili-skip-toggle';
        toggleBtn.textContent = '广告跳过设置';

        toggleBtn.addEventListener('click', () => {
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        });

        panel.querySelector('.bili-skip-close').addEventListener('click', () => {
            panel.style.display = 'none';
        });

        const switchInput = panel.querySelector('#biliSkipModeSwitch');
        const modeText = panel.querySelector('#biliSkipModeText');

        // Initialize state
        const currentMode = GM_getValue('skipMode', 'manual');
        SKIP_MODE = currentMode;
        switchInput.checked = currentMode === 'auto';
        updateText(currentMode);

        switchInput.addEventListener('change', () => {
            const mode = switchInput.checked ? 'auto' : 'manual';
            GM_setValue('skipMode', mode);
            SKIP_MODE = mode;
            updateText(mode);
        });

        function updateText(mode) {
            modeText.textContent = `当前：${mode === 'auto' ? '自动跳过' : '手动跳过'}`;
        }

        document.body.appendChild(toggleBtn);
        document.body.appendChild(panel);
        settingsPanel = panel;
    }

    // === Initialize plugin ===
    function init() {
        console.log("Bilibili 广告跳过助手已启动");

        SKIP_MODE = GM_getValue('skipMode', 'manual');
        createSettingsPanel();
        mainLogic();
        observeURLChange();
    }

    // === Main logic entry point ===
    function mainLogic() {
        cleanUp();
        (async () => {
            const seg = await getSkipSegment();
            if (!seg) return;
            waitForVideo(() => attachSkipper(seg));
        })();
    }

    // === Clean up previous video state ===
    function cleanUp() {
        skipped = false;
        isBtnAdd = false;

        if (btn.parentElement) btn.remove();

        if (currentVideo && currentAdSkipHandler) {
            currentVideo.removeEventListener('timeupdate', currentAdSkipHandler);
        }

        if (countdownTimer){
            clearInterval(countdownTimer);
            countdownTimer = null;
        }

        isSuspiciousAd = false;

        currentVideo = null;
        currentAdSkipHandler = null;
    }

    // === Observe URL changes (for SPA routing) ===
    function observeURLChange() {
        let lastUrl = location.href;
        const observer = new MutationObserver(() => {
            if (location.href !== lastUrl) {
                lastUrl = location.href;
                mainLogic();
            }
        });
        observer.observe(document, { subtree: true, childList: true });
    }

    // === Wait for video element to load ===
    function waitForVideo(onVideoReady) {
        const videoElement = document.querySelector('video');
        if (videoElement) {
            currentVideo = videoElement;
            return onVideoReady();
        }

        const obs = new MutationObserver(() => {
            const video = document.querySelector('video');
            if (video) {
                obs.disconnect();
                currentVideo = video;
                onVideoReady();
            }
        });
        obs.observe(document.body, { childList: true, subtree: true });
    }

    // === Get ad segment timestamps ===
    async function getSkipSegment() {
        const cid = await getCidFromPage();
        if (!cid) return null;
        const danmaku = await fetchDanmakuWithTime(cid);
        let adTimes = findAdTimestamps(danmaku);
        if (!adTimes) {
            isSuspiciousAd = true;
            adTimes = getAdTimeByKeywords(danmaku);
        }

        if (!checkAdSegVaild(adTimes, danmaku)) {
            return null;
        }

        return adTimes;
    }

    function checkAdSegVaild(adTimes, danmaku) {
        if (!adTimes || adTimes.start < 60) return false;

        if (adTimes.end - adTimes.start >= 180 || adTimes.end >= danmaku[danmaku.length - 1].time - 20) {
            return false;
        }

        return true;
    }

    // === Keyword-based ad time detection (fallback) ===
    function getAdTimeByKeywords(danmaku) {
        const filterSet = ["已买","购买","购入","接广","广告","广子","欢迎回来","感谢金主","买了","恭喜接广","下单","期待发货","付款", "商单", "买买买", "恰饭", "恰上饭"];
        const startTime = 0, endTime = danmaku[danmaku.length - 1].time;
        let possibleAdTimes = []
        danmaku.forEach(d => {
            const time = d.time;
            if (time >= startTime && time <= endTime) {
                const text = d.textContent.trim();
                for (const f of filterSet) {
                    if (text.includes(f)) {
                        possibleAdTimes.push(time);
                    }
                }
            }
        });

        const AD_MAX_DURATION = 100, AD_MIN_DURATION = 30;
        let i = 0, j = 1;
        let adStart, adEnd;
        while (i < possibleAdTimes.length && j < possibleAdTimes.length) {
            const start = possibleAdTimes[i];
            const end = possibleAdTimes[j];

            if (end - start > AD_MAX_DURATION) {
                if (adStart) {
                    break;
                }
                if (j - 1 == i){
                    j++;
                }
                i++;
            }else {
                if(end - start >= AD_MIN_DURATION) {
                    adStart = start;
                    adEnd = end;
                }
                j++;
            }
        }

        if (adStart) {
            return { start: adStart - 5, end: adEnd };
        }
        return null;
    }

    // === Fetch danmaku-related data ===
    async function getCidFromPage() {
        const bvid = window.location.pathname.split('/')[2];
        const res = await fetch(`https://api.bilibili.com/x/player/pagelist?bvid=${bvid}`);
        const data = await res.json();
        return data.data[0]?.cid || null;
    }

    async function fetchDanmakuWithTime(cid) {
        const url = `https://comment.bilibili.com/${cid}.xml`;
        const res = await fetch(url);
        const text = await res.text();
        const danmakuXML = new DOMParser().parseFromString(text, 'text/xml');
        const danmaku = Array.from(danmakuXML.getElementsByTagName("d")).map(d => ({
            time: parseFloat(d.getAttribute("p").split(",")[0]),
            textContent: d.textContent
        }));
        danmaku.sort((a, b) => a.time - b.time);
        return danmaku;
    }

    // === Parse ad timestamps from danmaku ===
    function findAdTimestamps(danmaku) {
        let timePairs = [];

        danmaku.forEach(d => {
            const start = d.time;
            const text = d.textContent;
            const endInfo = extractTimeFromText(text);

            if (endInfo && !isNaN(start)) {
                timePairs.push({
                    start: start,
                    end: endInfo.time,
                    confidence: endInfo.confidence,
                    text: text
                });
            }
        });

        if (timePairs.length === 0) return null;

        timePairs.sort((a, b) => a.start - b.start);

        const endTimeCounts = {};
        timePairs.forEach(({ end, confidence }) => {
            const rounded = Math.round(end);
            endTimeCounts[rounded] = (endTimeCounts[rounded] || 0) + confidence;
        });

        const [mostLikelyEnd, totalConfidence] = Object.entries(endTimeCounts).sort((a, b) => b[1] - a[1])[0];
        if (totalConfidence < 0.9) return null;

        const PET = parseInt(mostLikelyEnd);
        let startTime = null;
        let endTime = PET;

        for (const { start, end } of timePairs) {
            if (end - start < 30) continue;
            if (!startTime && Math.round(end) === PET) {
                startTime = start + 5;
            } else if (Math.round(end) === PET && Math.round(start) - PET > 0) {
                endTime = start - 5;
                break;
            }
        }

        return startTime ? { start: startTime, end: endTime } : null;
    }

    function extractTimeFromText(text) {
        const match1 = text.match(/(\d{1,2})[:;：；](\d{2})/);
        if (match1) return { time: parseInt(match1[1]) * 60 + parseInt(match1[2]), confidence: 1 };

        const match2 = text.match(/([一二三四五六七八九]?十[一二三四五六七八九]?|[一二三四五六七八九]|\d)分([一二三四五六七八九]?十[一二三四五六七八九]?|[一二三四五六七八九]|\d{1,2})秒?/);
        if (match2) return { time: zhNumToInt(match2[1]) * 60 + zhNumToInt(match2[2]), confidence: 1 };

        return null;
    }

    function zhNumToInt(str) {
        if (/^\d+$/.test(str)) return Number(str);
        const map = { 零:0, 一:1, 二:2, 三:3, 四:4, 五:5, 六:6, 七:7, 八:8, 九:9 };
        if (str === '十') return 10;
        if (str.includes('十')) {
            const [left, right] = str.split('十');
            return (left ? map[left] : 1) * 10 + (right ? map[right] : 0);
        }
        return map[str];
    }

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${m}:${sec.toString().padStart(2, '0')}`;
    }

    // === Bind ad skipping logic ===
    function attachSkipper({ start, end }) {
        currentAdSkipHandler = () => {
            const t = currentVideo.currentTime;
            if (SKIP_MODE === 'auto' && !skipped && !isSuspiciousAd) {
                if (t >= start && t < end) {
                    skipToEnd(end);
                }
            } else {
                if (!isBtnAdd && t >= start && t < end) {
                    addSkipBtn(end);
                } else if (t < start - 0.2 || t > end + 0.2) {
                    btnCleanUp();
                    isBtnAdd = false;
                }
            }
        };

        currentVideo.addEventListener('timeupdate', currentAdSkipHandler);
    }

    function skipToEnd(end) {
        currentVideo.currentTime = end + 0.05;
        setTimeout(() => {
            currentVideo.play().catch(err => console.warn('Autoplay failed:', err));
        }, 300);
        skipped = true;
        btnCleanUp();
        isBtnAdd = false;
    }

    function btnCleanUp(){
        btn.remove();
        if (countdownTimer){
            clearInterval(countdownTimer);
            countdownTimer = null;
        }
        cleanUpBtnEvents();
    }

    function cleanUpBtnEvents(){
        if (buttonEventHandlers.click){
            btn.removeEventListener('click', buttonEventHandlers.click);
            buttonEventHandlers.click = null;
        }
        if (buttonEventHandlers.mouseenter){
            btn.removeEventListener('mouseenter', buttonEventHandlers.mouseenter);
            buttonEventHandlers.mouseenter = null;
        }
        if (buttonEventHandlers.mouseleave){
            btn.removeEventListener('mouseleave', buttonEventHandlers.mouseleave);
            buttonEventHandlers.mouseleave = null;
        }
        if (buttonEventHandlers.play){
            currentVideo.removeEventListener('play', buttonEventHandlers.play);
            buttonEventHandlers.play = null;
        }
        if (buttonEventHandlers.pause){
            currentVideo.removeEventListener('pause', buttonEventHandlers.pause);
            buttonEventHandlers.pause = null;
        }
    }

    function possibleAdCountdown(counter){
        let countdown = counter;
        btn.textContent = `跳过疑似广告 (${countdown})`;

        const countdownStart = () => {
            countdownTimer = setInterval(() => {
                countdown--;
                if (countdown == -1){
                    btnCleanUp();
                    return;
                }else if (countdown > 0){
                    btn.textContent = `跳过疑似广告 (${countdown})`;
                }

            }, 1000);
        };

        buttonEventHandlers.mouseenter = () => {
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
        };
        btn.addEventListener('mouseenter', buttonEventHandlers.mouseenter);
        buttonEventHandlers.mouseleave = () => {
            if (!countdownTimer && countdown > 0) {
                countdownStart();
            }
        };
        btn.addEventListener('mouseleave', buttonEventHandlers.mouseleave);
        currentVideo.addEventListener('play', () => {
            if (!countdownTimer && countdown > 0) {
                countdownStart();
            }
        });
        buttonEventHandlers.play = () => {
            if (!countdownTimer && countdown > 0) {
                countdownStart();
            }
        };
        currentVideo.addEventListener('play', buttonEventHandlers.play);
        buttonEventHandlers.pause = () => {
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
        };
        currentVideo.addEventListener('pause', buttonEventHandlers.pause);
        countdownStart();
    }

    function addSkipBtn(end) {
        cleanUpBtnEvents();
        if (!isSuspiciousAd){
            btn.textContent = '跳过广告';
        }else {
            possibleAdCountdown(COUNTDOWN);
        }

        const container = currentVideo.parentElement;
        if (getComputedStyle(container).position === 'static') {
            container.style.position = 'relative';
        }
        buttonEventHandlers.click = () => skipToEnd(end);
        btn.addEventListener('click', buttonEventHandlers.click);
        container.appendChild(btn);
        isBtnAdd = true;
    }

    // Start the script when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

})();