// ==UserScript==
// @name         光遇公告同步
// @namespace    https://github.com/haihe8177
// @version      1.2.5
// @description  转换光遇国服公告至光遇Biliwiki
// @author       Haihe
// @license MIT
// @match        https://sky.163.com/news/official/*.html
// @match        https://sky.163.com/news/update/*.html
// @match        https://sky.163.com/news/activity/*.html
// @match        https://sky.163.com/news/strategy/*.html
// @match        https://wiki.biligame.com/sky/index.php?title=*&action=submit
// @match        https://wiki.biligame.com/sky/index.php?title=*&action=edit
// @grant        GM_openInTab
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_log
// @grant        GM_download
// @downloadURL https://update.greasyfork.org/scripts/542785/%E5%85%89%E9%81%87%E5%85%AC%E5%91%8A%E5%90%8C%E6%AD%A5.user.js
// @updateURL https://update.greasyfork.org/scripts/542785/%E5%85%89%E9%81%87%E5%85%AC%E5%91%8A%E5%90%8C%E6%AD%A5.meta.js
// ==/UserScript==

(function () {
    function setupNetEasePage() {
        function getArticleTypeFromUrl() {
            const path = window.location.pathname;
            if (path.includes('/official/')) return '新闻';
            if (path.includes('/update/')) return '公告';
            if (path.includes('/activity/')) return '活动';
            if (path.includes('/strategy/')) return '采访';
        }
        const articleType = getArticleTypeFromUrl();
        const panel = document.createElement('div');
        panel.style.cssText = `
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 9999;
            padding: 10px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 14px;
        `;
        const downloadLabel = document.createElement('label');
        downloadLabel.style.cssText = 'display: block; margin: 8px 0;';
        downloadLabel.innerHTML = `
            <input type="checkbox" name="download-images" id="download-images">
            下载图片
        `;
        panel.appendChild(downloadLabel);

        const btn = document.createElement('button');
        btn.textContent = '导入wiki';
        btn.style.cssText = `
            padding: 5px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            width: 100%;
        `;
        btn.addEventListener('click', async () => {
            try {
                const titleElement = document.querySelector('h1.artTitle')?.textContent
                    .replace(/《光·遇》(?![×x])\s?|[《》·]|\n.*返回/g, '').replace(/[\|丨｜]\s?/g, ' ').replace(/(?<=光遇)[×x]\s?/g, '×')
                    .trim();
                const dateElement = document.querySelector('.artDate')?.textContent
                    .replace(/-/g, '')
                    .trim();
                const shouldDownload = document.getElementById('download-images').checked;
                let contentHTML = `{{文章戳\n|文章上级页面=${articleType}\n|时间=${dateElement}\n|作者=《光·遇》官方运营团队\n|是否原创=否\n|来源=官网\n|原文地址=${window.location.href}\n}}\n<div style="font-size:16px;line-height:30px;">\n<br>\n`;
                const contentElement = document.querySelector('.artText');
                if (!contentElement) throw new Error('找不到文章内容');
                const convertedContent = await convertContent(contentElement, dateElement, articleType, shouldDownload);
                const fullContent = contentHTML + convertedContent + '\n</div>\n\n<!-- Generated by SKY NewsConverter by Haihe -->';
                GM_setValue('extractedData', JSON.stringify({
                    title: titleElement,
                    content: fullContent
                }));
                const wikiUrl = `https://wiki.biligame.com/sky/index.php?title=${encodeURIComponent(titleElement)}&action=edit`;
                GM_openInTab(wikiUrl, {
                    active: true,
                    insert: true,
                    setParent: true
                });
            } catch (error) {
                alert(`出错: ${error.message}`);
                GM_log(`Error in sky.163.com: ${error.stack}`);
            }
        });
        panel.appendChild(btn);
        document.body.appendChild(panel);
    }
    async function convertContent(contentElement, date, articleType, shouldDownload) {
        const clone = contentElement.cloneNode(true);
        const images = clone.querySelectorAll('img');
        let imageIndex = 1;
        for (const img of images) {
            const originalSrc = img.src;
            if (!originalSrc) continue;

            const filename = `${date}${articleType}图${imageIndex}.jpg`;
            const wikiFormat = `<br>\n[[File:${filename}|600px|link=]]<br>\n`;
            img.replaceWith(wikiFormat);

            if (shouldDownload) {
                try {
                    // 1. 加载图片
                    const imageBitmap = await createImageBitmap(await fetch(originalSrc).then(r => r.blob()));
                    // 2. 创建 canvas 并绘制
                    const canvas = document.createElement('canvas');
                    canvas.width = imageBitmap.width;
                    canvas.height = imageBitmap.height;
                    const ctx = canvas.getContext('2d');
                    // 填充白色背景（避免 PNG 透明变黑）
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(imageBitmap, 0, 0);

                    // 3. 转换为 JPEG 格式的 Blob（质量可调）
                    const jpegBlob = await new Promise(resolve =>
                        canvas.toBlob(resolve, 'image/jpeg', 0.9) // 0.9 是质量（0～1）
                    );

                    // 4. 下载
                    const url = URL.createObjectURL(jpegBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    GM_log(`格式转换并下载成功: ${filename}`);
                } catch (error) {
                    GM_log(`图片处理失败: ${filename} - ${error.message}`);
                }
            }
            imageIndex++;
        }
        const headings = clone.querySelectorAll('h1, h2, h3, h4, h5, h6');
        headings.forEach(heading => {
            const text = heading.textContent;
            heading.replaceWith(`<big>{{天蓝色|'''${text}'''}}</big><br>`);
        });
        const alignedElements = clone.querySelectorAll('[style*="text-align"]');
        alignedElements.forEach(el => {
            const style = el.getAttribute('style');
            const alignMatch = style.match(/text-align:\s*([^;]+)/);
            if (alignMatch) {
                const align = alignMatch[1].trim();
                el.outerHTML = `<div style="text-align:${align}">${el.innerHTML}</div><br>`;
            }
        });
        const paragraphs = clone.querySelectorAll('p:not([style*="text-align"])');
        paragraphs.forEach(p => {
            if (p.innerHTML.trim() === '') {
                p.remove();
            } else {
                p.outerHTML = `${p.innerHTML}<br>`;
            }
        });
        let result = clone.innerHTML
            .replace(/<br>\n{2,}/g, '<br>\n')
            .replace(/<\/?(article)[^>]*>/g, '')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/^\n/g, '')
            .replace(/<\/?tbody.*?>/g, '')
            .replace(/\s+\n/g, '\n')
            .trim();
        return result;
    }
    function setupWikiPage() {
        function fillData() {
            const storedData = GM_getValue('extractedData', null);
            if (!storedData) return;
            try {
                const data = JSON.parse(storedData);
                const checkExist = setInterval(() => {
                    const editor = document.querySelector(".CodeMirror")?.CodeMirror;
                    if (editor) {
                        editor.setValue(data.content);
                        document.title = `编辑 ${data.title} - 天空王国`;
                        GM_setValue('extractedData', null);
                        clearInterval(checkExist);
                    }
                }, 300);
            } catch (error) {
                GM_log(`Error in wiki.biligame.com: ${error.stack}`);
            }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fillData);
        } else {
            fillData();
        }
    }
    const domainHandlers = {
        'sky.163.com': setupNetEasePage,
        'wiki.biligame.com': setupWikiPage
    };
    const hostname = window.location.hostname;
    for (const domain in domainHandlers) {
        if (hostname.includes(domain)) {
            domainHandlers[domain]();
            break;
        }
    }
})();