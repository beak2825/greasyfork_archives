// ==UserScript==
// @name         Bank balance adjuster + RW score grabber
// @namespace    http://tampermonkey.net/
// @version      3.2.1
// @description  CSV sheet faction bank balance adjustment script, semi-automation for adjusting balances to faction members. Added RW score grabber
// @author       IAMAPEX [2523988]
// @match        https://www.torn.com/*
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/504227/Bank%20balance%20adjuster%20%2B%20RW%20score%20grabber.user.js
// @updateURL https://update.greasyfork.org/scripts/504227/Bank%20balance%20adjuster%20%2B%20RW%20score%20grabber.meta.js
// ==/UserScript==
(function(){'use strict';
let isCancelled=false,savedFile=null,panelOpen=false,panelWrapper=null,panelLocked=false;let useManualColumns=false,selectedLayout='abcLayout';let manualIDIndex=0,manualNameIndex=1,manualPayIndex=2,manualRowStart=2;let rowsGlobal=null,rowIdxGlobal=0,delayMs=500;let progressEl=null,currentEl=null,statusEl=null;
const log=(...a)=>console.log('[BankAdjuster]',...a);const beep=()=>{try{const a=new(AudioContext||webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.type='square';o.frequency.value=880;g.gain.setValueAtTime(.05,a.currentTime);o.connect(g);g.connect(a.destination);o.start();setTimeout(()=>{o.stop();a.close&&a.close()},150)}catch(_){}};function waitFor(s,cb){const el=document.querySelector(s);if(el)return cb(el);setTimeout(()=>waitFor(s,cb),150)}function waitForCond(fn,cb){const v=fn();if(v)return cb(v);setTimeout(()=>waitForCond(fn,cb),150)}
function addCustomButton(){if(document.getElementById('mom-payout-btn'))return;waitFor('#notes_settings_button',btn=>{const c=btn.cloneNode(true);c.id='mom-payout-btn';c.innerHTML='';const icon=document.createElement('div');Object.assign(icon.style,{backgroundImage:'url("https://mayhemhub.net/images/MayhemLogo.png")',backgroundSize:'cover',width:'24px',height:'24px',cursor:'pointer'});Object.assign(c.style,{display:'flex',alignItems:'center',justifyContent:'center',padding:'0'});c.appendChild(icon);c.addEventListener('click',togglePanel);btn.parentElement.insertBefore(c,btn.nextSibling)})}
waitFor('#chatRoot .root___oWxEV',tb=>{new MutationObserver(addCustomButton).observe(tb,{childList:true});addCustomButton()});
function togglePanel(){panelOpen?closePanel():openPanel()}
function openPanel(){panelOpen=true;waitFor('#chatRoot .root___Io7i2',parent=>{panelWrapper=document.createElement('div');panelWrapper.className='item___ydsFW';panelWrapper.style.transitionDuration='150ms';parent.appendChild(panelWrapper);const p=document.createElement('div');p.id='mom_payout_panel';p.className='root___FmdS_ root___ZIY55 visible___dJHqr root____TLtV';Object.assign(p.style,{background:'var(--chat-color-surface)',border:'1px solid var(--chat-color-border-primary)',borderRadius:'6px',maxHeight:'80vh',overflow:'auto'});const h=document.createElement('button');h.type='button';h.className='root___WHFbh root___Do3R6';h.style.cssText='display:flex;justify-content:space-between;align-items:center;width:100%;padding:8px;';h.innerHTML=`<div style="display:flex;align-items:center;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="root___DYylw" style="margin-right:8px;"><g fill="url(#icon_gradient68_default)"><g transform="scale(1.5)" transform-origin="12"><path d="M1443,19.674a8.407,8.407,0,0,0-.659-1.593,2.576,2.576,0,0,1-2.582-.84,2.492,2.492,0,0,1-.65-2.582,8.4,8.4,0,0,0-1.592-.659,2.828,2.828,0,0,1-5.034,0,8.4,8.4,0,0,0-1.592.659,2.492,2.492,0,0,1-.65,2.582,2.578,2.578,0,0,1-2.582.841,8.371,8.371,0,0,0-.659,1.592A2.722,2.722,0,0,1,1428.539,22,3.015,3.015,0,0,1,1427,24.517a8.4,8.4,0,0,0,.659,1.592,2.595,2.595,0,0,1,3.232,3.232,8.338,8.338,0,0,0,1.592.659,2.828,2.828,0,0,1,5.034,0,8.4,8.4,0,0,0,1.592-.659,2.492,2.492,0,0,1,.65-2.582,2.576,2.576,0,0,1,2.582-.84,8.407,8.407,0,0,0,.659-1.593A2.722,2.722,0,0,1,1441.461,22,2.722,2.722,0,0,1,1443,19.674Zm-8,5.805A3.479,3.479,0,1,1,1438.479,22,3.48,3.48,0,0,1,1435,25.479Z"/></g></g></svg><span style="font-weight:bold;color:white;">Payout Settings</span></div><span style="cursor:pointer;font-size:18px;">✕</span>`;h.addEventListener('click',()=>{if(!panelLocked)closePanel()});p.appendChild(h);const c=document.createElement('div');c.className='content___zX_G4';c.style.padding='8px';buildCsvForm(c);p.appendChild(c);panelWrapper.appendChild(p);setTimeout(()=>document.addEventListener('click',closeOutsideClick),50);repositionPanels()})}
function closePanel(){if(panelWrapper)panelWrapper.remove();panelWrapper=null;panelOpen=false;document.removeEventListener('click',closeOutsideClick);repositionPanels()}
function closeOutsideClick(e){if(!panelWrapper)return;if(panelLocked)return;if(!panelWrapper.contains(e.target)&&!e.target.closest('#mom-payout-btn')&&!e.target.closest('#notes_settings_button'))closePanel()}
function buildCsvForm(parent){
  const fileInput=document.createElement('input');fileInput.type='file';fileInput.accept='.csv';fileInput.style.display='block';fileInput.style.margin='10px 0';
  const payoutBtn=document.createElement('button');payoutBtn.type='button';payoutBtn.className='root___ROGwA';payoutBtn.disabled=true;
  const cancelBtn=document.createElement('button');cancelBtn.type='button';cancelBtn.className='root___ROGwA';
  const grabBtn=document.createElement('button');grabBtn.type='button';grabBtn.className='root___ROGwA';
  fileInput.addEventListener('change',()=>{payoutBtn.disabled=!fileInput.files.length});
  const layoutLabel=document.createElement('label');layoutLabel.textContent='Select Payout Column Layout:';layoutLabel.style.display='block';layoutLabel.style.marginTop='10px';
  const layoutSelect=document.createElement('select');layoutSelect.style.marginTop='5px';layoutSelect.innerHTML=`<option value="abcLayout" selected>CSV Tab V3 (A,B,C, Row 2)</option><option value="manual">Manual input</option>`;
  const manualDiv=document.createElement('div');manualDiv.style.display='none';manualDiv.style.marginTop='10px';manualDiv.innerHTML=`<div style="display:flex;gap:6px;flex-wrap:wrap;"><label>Row start (e.g. 2): <input id="mom-man-row" type="number" min="1" value="${manualRowStart}" style="width:80px;"></label><label>ID col: <input id="mom-man-id" type="number" min="1" value="${manualIDIndex+1}" style="width:60px;"></label><label>Name col: <input id="mom-man-name" type="number" min="1" value="${manualNameIndex+1}" style="width:60px;"></label><label>Amount col: <input id="mom-man-amt" type="number" min="1" value="${manualPayIndex+1}" style="width:60px;"></label></div>`;
  layoutSelect.addEventListener('change',()=>{const v=layoutSelect.value;if(v==='manual'){useManualColumns=true;manualDiv.style.display='block'}else{useManualColumns=false;manualDiv.style.display='none';selectedLayout='abcLayout'}});
  payoutBtn.addEventListener('click',()=>{isCancelled=false;panelLocked=true;statusEl&&(statusEl.textContent='Status: Initializing...');if(!useManualColumns)selectedLayout='abcLayout';const here=location.href,base='https://www.torn.com/factions.php?step=your&type=1#/tab=controls',target=base+'&option=give-to-user';const start=file=>{let skipRows=1,layout='abcLayout';if(useManualColumns){const rs=document.getElementById('mom-man-row'),idc=document.getElementById('mom-man-id'),nc=document.getElementById('mom-man-name'),ac=document.getElementById('mom-man-amt');manualRowStart=parseInt((rs&&rs.value)||'2',10)||2;manualIDIndex=Math.max(0,(parseInt((idc&&idc.value)||'1',10)||1)-1);manualNameIndex=Math.max(0,(parseInt((nc&&nc.value)||'2',10)||2)-1);manualPayIndex=Math.max(0,(parseInt((ac&&ac.value)||'3',10)||3)-1);skipRows=Math.max(manualRowStart-1,0);layout='manual'}delayMs=500;parseAndQueueCSV(file,skipRows,layout)};if(here===base||here===target)start(fileInput.files[0]);else if(confirm('Navigate to payouts tab now?')){savedFile=fileInput.files[0];location.href=target}});
  cancelBtn.addEventListener('click',()=>{isCancelled=true;panelLocked=false;statusEl&&(statusEl.textContent='Status: Cancelled')});
  grabBtn.addEventListener('click',()=>{try{statusEl&&(statusEl.textContent='Status: Scraping RW...');const data=grabRWScore();if(!data||!data.length){alert('No RW members found. Open a RW page with members.');statusEl&&(statusEl.textContent='Status: Idle');return}const rows=[['Name','ID','Score'],...data];const csv=rows.map(r=>r.map(x=>{const s=String(x??'');return s.includes(',')||s.includes('"')||s.includes('\n')?`"${s.replace(/"/g,'""')}"`:s}).join(',')).join('\n');const ts=new Date();const pad=n=>String(n).padStart(2,'0');const fname=`rw_scores_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.csv`;const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=fname;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove();statusEl&&(statusEl.textContent='Status: RW CSV saved')},250)}catch(e){console.error(e);alert('Failed to scrape RW. Make sure the RW members list is visible.');statusEl&&(statusEl.textContent='Status: Idle')}});

  parent.appendChild(layoutLabel);parent.appendChild(layoutSelect);parent.appendChild(manualDiv);parent.appendChild(fileInput);
  const wrap=document.createElement('div');wrap.style.display='flex';wrap.style.gap='8px';wrap.style.marginTop='10px';
  payoutBtn.innerHTML='<span class="root___xn40j subtitle___ETd9T title___GULIz">Payout</span>';cancelBtn.innerHTML='<span class="root___xn40j subtitle___ETd9T title___GULIz">Cancel</span>';grabBtn.innerHTML='<span class="root___xn40j subtitle___ETd9T title___GULIz">Grab RW Score</span>';
  wrap.appendChild(payoutBtn);wrap.appendChild(cancelBtn);wrap.appendChild(grabBtn);
  parent.appendChild(wrap);
  const info=document.createElement('div');info.style.marginTop='10px';
  progressEl=document.createElement('div');progressEl.style.opacity='.9';progressEl.textContent='Progress: 0 / 0 (0.0%)';
  currentEl=document.createElement('div');currentEl.style.opacity='.9';currentEl.textContent='Current: —';
  statusEl=document.createElement('div');statusEl.style.opacity='.9';statusEl.textContent='Status: Idle';
  info.appendChild(progressEl);info.appendChild(currentEl);info.appendChild(statusEl);parent.appendChild(info)
}
function parseAndQueueCSV(file,skipRows,layout){const r=new FileReader();r.onload=e=>{const rows=parseCSV(e.target.result).slice(skipRows);rowsGlobal=rows||[];rowIdxGlobal=0;if(!rowsGlobal.length){alert('No rows found after skipping header(s).');panelLocked=false;return}log('CSV loaded:',rowsGlobal.length,'rows. Layout:',layout);updateProgress();statusEl.textContent='Status: Starting...';processNext(layout)};r.readAsText(file)}
function processNext(layout){if(isCancelled){alert('Cancelled');statusEl.textContent='Status: Cancelled';panelLocked=false;return}
if(!rowsGlobal||rowIdxGlobal>=rowsGlobal.length){alert('Payout process completed.');statusEl.textContent='Status: Completed';updateProgress(true);panelLocked=false;return}
const cols=rowsGlobal[rowIdxGlobal]||[];let id,name,amt;if(layout==='abcLayout'){id=cols[0];name=cols[1];amt=cols[2]}else if(layout==='manual'){id=cols[manualIDIndex];name=cols[manualNameIndex];amt=cols[manualPayIndex]}else{id=cols[0];name=cols[1];amt=cols[2]}
if(!Array.isArray(cols)||typeof name==='undefined'||typeof amt==='undefined'){log('Row malformed. idx:',rowIdxGlobal,'cols:',cols);if(confirm(`⚠ Malformed data on row ${rowIdxGlobal+1}. OK = Skip • Cancel = Stop`)){rowIdxGlobal++;updateProgress();setTimeout(()=>processNext(layout),delayMs);return}else{statusEl.textContent='Status: Stopped on malformed data';panelLocked=false;return}}
if(!name||!String(amt).trim()){if(confirm(`⚠ Missing data on row ${rowIdxGlobal+1}. Name or Amount blank.\nOK = Skip • Cancel = Stop`)){rowIdxGlobal++;updateProgress();setTimeout(()=>processNext(layout),delayMs);return}else{statusEl.textContent='Status: Stopped on missing data';panelLocked=false;return}}
currentEl.textContent=`Current: ${name} — ${amt}`;statusEl.textContent='Status: Filling form...';log(`Row ${rowIdxGlobal+1}:`,name,'->',amt);
fillForm(String(name).trim(),String(amt).trim(),()=>{statusEl.textContent='Status: Awaiting Add Money (manual)...';waitForUserCompleted(()=>{setTimeout(()=>{rowIdxGlobal++;updateProgress();processNext(layout)},delayMs)})})}
function updateProgress(done){if(!rowsGlobal){progressEl.textContent='Progress: 0 / 0 (0.0%)';return}const tot=rowsGlobal.length,cur=Math.min(rowIdxGlobal,tot),num=done?tot:cur,pct=tot?((num/tot)*100).toFixed(1):'0.0';progressEl.textContent=`Progress: ${num} / ${tot} (${pct}%)`}
function fillForm(userName,amount,cb){if(isCancelled){alert('Cancelled');panelLocked=false;return}
waitFor('input[name="searchAccount"]',input=>{input.focus();waitFor('button[aria-label="Search by All"]',allBtn=>{allBtn.click();const setter=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,'value').set;setter.call(input,userName);input.dispatchEvent(new Event('input',{bubbles:true}));input.dispatchEvent(new Event('change',{bubbles:true}));setTimeout(()=>{input.click();const want=userName.toLowerCase();waitForCond(()=>{const items=document.querySelectorAll('.torn-react-autocomplete .item');for(const el of items){if(el.textContent.trim().toLowerCase().startsWith(want))return el}return null},sugg=>{sugg.click();setTimeout(()=>{waitFor('.input-money-group .input-money:not([type="hidden"])',amtInput=>{amtInput.value=amount;amtInput.dispatchEvent(new Event('input',{bubbles:true}));setTimeout(()=>{const label=document.querySelector('label[for="add-money-to-balance"]');if(label)label.click();cb&&cb()},200)})},300)})},300)})})}
function autoClickConfirmWithRetry(ms){const tryClick=()=>{const btn=document.querySelector('form.form___KTIE7 .confirmation___bSWqH button[type="submit"], .confirmation___bSWqH button[type="submit"], button.torn-btn.silver[type="submit"]');if(btn){setTimeout(()=>{btn.click();log('Auto-confirm clicked')},100);return true}return false};if(tryClick())return Promise.resolve(true);return new Promise(res=>{const start=Date.now(),iv=setInterval(()=>{if(tryClick()){clearInterval(iv);return res(true)}if(Date.now()-start>ms){clearInterval(iv);log('Confirm retry timed out');return res(false)}},120)})}
function detectTornError(){const texts=[];document.querySelectorAll('[class*="error"], [class*="danger"], [class*="warning"], .toast, .msg, .message').forEach(el=>{const t=(el.textContent||'').trim().toLowerCase();if(!t)return;if(t.includes('error')||t.includes('invalid')||t.includes('failed')||t.includes('not found')||t.includes('insufficient')||t.includes('denied'))texts.push(t)});return texts[0]||null}
function waitForUserCompleted(done){let finished=false;const finish=()=>{if(finished)return;finished=true;mo.disconnect();clearInterval(poll);clearTimeout(timeout);done&&done()};const hasModal=()=>document.querySelector('.confirmation___bSWqH, [role="dialog"].confirmation, .confirmation-modal, .confirmation___');const noModal =()=>!hasModal();const inputsReset=()=>{const amt=document.querySelector('.input-money-group .input-money:not([type="hidden"])');const acct=document.querySelector('input[name="searchAccount"]');const actionBtn=document.querySelector('div.controls___A35ZN button');const btnDisabled=actionBtn&&actionBtn.classList.contains('disabled');const amtEmpty=amt&&(!amt.value||amt.value==='');const acctEmpty=acct&&(!acct.value||acct.value==='');return (amtEmpty||(acctEmpty&&!btnDisabled))};let modalSeen=false,confirmTried=false;const mo=new MutationObserver(async()=>{if(hasModal()){modalSeen=true;if(!confirmTried){confirmTried=true;await autoClickConfirmWithRetry(5000)}return}
if(modalSeen&&noModal()){const err=detectTornError();if(err){beep();statusEl&&(statusEl.textContent=`Status: Torn error — "${err}"`);const cont=confirm(`⚠ Torn reported an error:\n"${err}"\n\nOK = Skip this row\nCancel = Stop now`);if(!cont){panelLocked=false;return}} if(inputsReset())finish()}});mo.observe(document.body,{childList:true,subtree:true,attributes:true,attributeFilter:['class','style','value']});const poll=setInterval(async()=>{if(hasModal()){modalSeen=true;if(!confirmTried){confirmTried=true;await autoClickConfirmWithRetry(5000)}return}
if(modalSeen&&noModal()){const err=detectTornError();if(err){beep();statusEl&&(statusEl.textContent=`Status: Torn error — "${err}"`);const cont=confirm(`⚠ Torn reported an error:\n"${err}"\n\nOK = Skip this row\nCancel = Stop now`);if(!cont){clearInterval(poll);mo.disconnect();panelLocked=false;return}} if(inputsReset()){clearInterval(poll);mo.disconnect();finish()}}},300);const timeout=setTimeout(()=>{mo.disconnect();clearInterval(poll);statusEl&&(statusEl.textContent='Status: Timeout waiting for confirmation — continuing');finish()},120000)}
function parseCSV(data){const rows=[],lines=data.split(/\r?\n/);for(const line of lines){if(!line.trim()){rows.push([]);continue}const tokens=line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);rows.push(tokens?tokens.map(t=>{t=t.trim();if(t.startsWith('"')&&t.endsWith('"'))t=t.slice(1,-1).replace(/""/g,'"');return t}):[])}return rows}
window.addEventListener('load',()=>{if(savedFile){log('Resuming with saved file on payouts tab');if(!panelOpen)openPanel();parseAndQueueCSV(savedFile,1,'abcLayout');savedFile=null}});
function repositionPanels(){const c=document.querySelector('#chatRoot .root___Io7i2');if(!c)return;const ws=Array.from(c.querySelectorAll('.item___ydsFW'));if(!ws.length)return;let w=0;const sample=document.querySelector('.item___ydsFW > .root___FmdS_');if(sample)w=sample.parentElement.getBoundingClientRect().width;if(!w)return;ws.forEach((el,i)=>{el.style.transform=`translateX(${-(ws.length-i-1)*w}px)`;el.style.transitionDuration='150ms'})}
waitFor('#chatRoot .root___Io7i2',container=>{try{new MutationObserver(repositionPanels).observe(container,{childList:true,attributes:true,subtree:true,attributeFilter:['style']})}catch(err){log('Observer init failed (non-fatal):',err)}});
function grabRWScore(){const SEL='#faction_war_list_id > li.descriptions > div > div.faction-war.membersWrap___NbYLx > div.tab-menu-cont.cont-gray.bottom-round.tabMenuCont___v65Yc.your-faction.right';const root=document.querySelector(SEL)||document.querySelector('#faction_war_list_id .membersWrap___NbYLx .tab-menu-cont.your-faction.right')||document.querySelector('#faction_war_list_id .tab-menu-cont.your-faction.right')||document.querySelector('.tab-menu-cont.your-faction.right');const list=root?root.querySelector('ul.members-list'):document.querySelector('#faction_war_list_id ul.members-list');if(!list)return[];const items=list.querySelectorAll('li.your');const out=[];items.forEach(li=>{try{const prof=li.querySelector('a[href*="/profiles.php?XID="]');let id='';if(prof){const href=prof.getAttribute('href')||'';const qs=href.split('?')[1]||'';const usp=new URLSearchParams(qs);id=(usp.get('XID')||'').trim()}let name='';const nameEl=li.querySelector('.honor-text');if(nameEl&&nameEl.textContent)name=nameEl.textContent.trim();if(!name){const img=li.querySelector('.honor-text-wrap img[alt]');if(img)name=(img.getAttribute('alt')||'').trim()}const ptsEl=li.querySelector('.points');const score=(ptsEl?ptsEl.textContent:'').trim();if(name||id||score)out.push([name,id,score])}catch(e){console.warn('RW row parse failed',e)}});return out}
})();
