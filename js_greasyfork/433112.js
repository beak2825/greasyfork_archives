// ==UserScript==
// @name               RR: Auto Refresh Last Seen Time
// @name:zh-TW         RR: 自動更新最後在線時間
// @namespace          -
// @version            1.0.2
// @description        Show your last online time via Profile > About (computer only)
// @description:zh-TW  透過 Profile > About 向其他人顯示你的最後在線時間（僅限電腦）
// @author             LianSheng
// @include            http://rivalregions.com/*
// @include            https://rivalregions.com/*
// @grant              none
// @downloadURL https://update.greasyfork.org/scripts/433112/RR%3A%20Auto%20Refresh%20Last%20Seen%20Time.user.js
// @updateURL https://update.greasyfork.org/scripts/433112/RR%3A%20Auto%20Refresh%20Last%20Seen%20Time.meta.js
// ==/UserScript==

(() => {
    async function changeAbout(msg) {
        let fd = new FormData();
        fd.append("c", c_html);
        fd.append("m", msg);

        let queryString = new URLSearchParams(fd).toString();

        await fetch("https://rivalregions.com/rival/about", {
            "headers": {
                "content-type": "application/x-www-form-urlencoded",
                "x-requested-with": "XMLHttpRequest"
            },
            "referrer": "https://rivalregions.com/",
            "referrerPolicy": "strict-origin-when-cross-origin",
            "body": queryString,
            "method": "POST",
            "mode": "cors",
            "credentials": "include"
        });
    }

    function getFullDatetime() {
        let d = new Date();
        let offset = d.getTimezoneOffset();
        d = new Date(d.getTime() - (offset*60*1000));
        let fullDatetime = d.toISOString().replace("T", " ").replace(/\.\d+/, "").replace("Z", ` (UTC${offset < 0 ? "+" : "-"}${Math.abs(offset/60)})`);

        return fullDatetime;
    }

    window.onhashchange = async () => {
        if(!window.onHashChangeLock) {
            window.onHashChangeLock = true;
            let time = getFullDatetime();
            let message = `Last time seen on computer: ${time}\n# This message is auto-generated by: https://greasyfork.org/en/scripts/433112 #`;

            await changeAbout(message);
            window.onHashChangeLock = false;
        }
    }

    window.dispatchEvent(new Event("hashchange"));
})();