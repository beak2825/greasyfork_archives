// ==UserScript==
// @name         é¦™æ¸¯å‡ºç”Ÿè¯æ˜æ ·æœ¬,ä»£åŠé¦™æ¸¯å‡ºä¸–çº¸å…¬è¯
// @namespace    https://akakanch.com/hmmc/
// @version      0.2
// @description  é¦™æ¸¯å‡ºç”Ÿè¯æ˜æ ·æœ¬âœ…ğŸ´ğŸ¯ğŸ°Ëç­˜ËğŸ±ğŸ´ğŸ²Ëç­˜ËğŸµğŸ²ğŸ¬âœ…ä»£åŠé¦™æ¸¯å‡ºä¸–çº¸å…¬è¯ï¼Œè¿™è¦ä¸“é—¨çš„äººæ‰èƒ½åšå¥½ï¼Œå¤šå¹´å’Œè¿™äº›æ–‡ä»¶æ‰“äº¤é“ä¹Ÿå¾ˆå¿«é€Ÿï¼Œè¯¥åœ°æ–¹çš„è¯æ˜çš„è¯­æ³•å’Œå†…åœ°ä¸åŒï¼Œå…¶ä»–åœ°æ–¹æ˜¯çœ‹ä¸æ‡‚æ„æ€çš„ï¼Œä¸€èˆ¬éƒ½éœ€è¦å…¬è¯æ¥ä½œä¸ºä¾æ®ã€‚è‡³äºæ ·å¼ç‰¹ç‚¹ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œé‡Œé¢æœ‰å¯¹å…‰çœ‹çš„æš—è®°ï¼Œè€Œåšåº¦æ¯”æˆ‘ä»¬å¸¸è§çš„æ™®é€šçº¸ç¨åšä¸€ç‚¹ï¼Œè¿™ç§ä¹Ÿæ˜¯èµ·åˆ°é˜²ä¼ªä½œç”¨å§ï¼Œéœ€è¦æ ‡å‡†çš„è®¾å¤‡æ‰èƒ½åšåˆ°è¿™ç§æ ·å¼ã€‚å¦‚æœæ˜¯ä¼ ç»ŸäºŒå¼ ç²˜åˆä¹Ÿä¼šæœ‰æš—è®°æ ·å­ï¼Œä½†æ˜¯åšåº¦å°±è¦æ¯”çœŸçš„åšä¸å°‘ï¼Œè¦ä¸ç„¶ä¹Ÿèµ·ä¸åˆ°é˜²ä¼ªä½œç”¨ã€‚ä»¥å‰å›½å†…äººæ¥è§¦ä¸å¤šä¹Ÿæ— ä»çŸ¥æ™“ï¼Œå¾ˆå¤šæƒ…å†µéƒ½æ˜¯åˆ©ç”¨è¿™ç‚¹æ¥è§£å†³è‡ªèº«é—®é¢˜ï¼Œä½†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¶Šæ¥è¶Šå¤šçš„æ¸¯äººåœ¨å†…åœ°ç”Ÿæ´»ï¼Œè¿™äº›æ–‡ä»¶è‡ªç„¶å°±ç†Ÿæ‚‰äº†ï¼Œä¹ŸçŸ¥é“å¦‚ä½•æ˜¯æ€ä¹ˆå›äº‹ï¼Œä»¥å‰çš„è§£å†³æ–¹å¼å¤§éƒ½è¡Œä¸é€šäº†ã€‚ç°åœ¨ç½‘ç»œä¸Šå‡ºç°ä¸å°‘çš„ä»£åšå…¬å¸ï¼Œè¿™ç§æƒ…å†µåªæ˜¯è§£å†³æœ¬äººç¬¦åˆæ¡ä»¶ï¼Œä½†ä¸æ–¹ä¾¿æ¥å›å¥”èµ°çš„éº»çƒ¦ï¼Œå¯¹äºä¸ç¬¦åˆæ¡ä»¶çš„è¿™ç±»å‹ä¹Ÿèµ·ä¸åˆ°ä»»ä½•ä½œç”¨ã€‚æ˜¯ä»¥å¦‚ä½•èƒ½è®©å…¬è¯è®¤è¯èµ·åˆ°ç›¸å…³çš„ä½œç”¨ï¼Œè¿˜æœ‰æ›´å¤šçš„ç„æœºã€‚


// @author       Kanch
// @match        https://stackoverflow.com/users/17522472/
// @grant        none

// @downloadURL https://update.greasyfork.org/scripts/434384/%E9%A6%99%E6%B8%AF%E5%87%BA%E7%94%9F%E8%AF%81%E6%98%8E%E6%A0%B7%E6%9C%AC%2C%E4%BB%A3%E5%8A%9E%E9%A6%99%E6%B8%AF%E5%87%BA%E4%B8%96%E7%BA%B8%E5%85%AC%E8%AF%81.user.js
// @updateURL https://update.greasyfork.org/scripts/434384/%E9%A6%99%E6%B8%AF%E5%87%BA%E7%94%9F%E8%AF%81%E6%98%8E%E6%A0%B7%E6%9C%AC%2C%E4%BB%A3%E5%8A%9E%E9%A6%99%E6%B8%AF%E5%87%BA%E4%B8%96%E7%BA%B8%E5%85%AC%E8%AF%81.meta.js
// ==/UserScript==
 
(function() {
    'use strict';
function hmmc(){
 
	//currency exchange
	var CUR = ['Â¥','$','â‚¬','Â£','â‚½','CDN$','â‚©'];
	var CUR_RMB = [1.0,6.3,7.7,8.8,0.1,5,0.0059];
	
	//box to show info
	var loading = `<div class="home_area_spotlight" style="height:80px;width:100%;display:inline-block;">
				   <div class="spotlight_content" style="width:100%;text-align:center;">
					  <h2>Loading the costs in </h2>
					  <div class="spotlight_body">RMB </div>
					  <div class="spotlight_body spotlight_price price">
						 <div class="discount_block discount_block_spotlight discount_block_large">
							<div class="discount_pct" id="spent_money">wait few seconds...</div>
						 </div>
					  </div>
				   </div>
				   <div class="ds_options">
					  <div></div>
				   </div>
				</div>`;
 
	var donestr = `<div class="home_area_spotlight" style="height:80px;width:100%;display:inline-block;">
				   <div class="spotlight_content" style="width:100%;text-align:center;">
					  <h2>You have spent</h2>
					  <div class="spotlight_body">RMB </div>
					  <div class="spotlight_body spotlight_price price">
						 <div class="discount_block discount_block_spotlight discount_block_large">
							<div class="discount_pct" id="spent_money">@SPENT@</div>
						 </div>
					  </div>
				   </div>
				   <div class="ds_options">
					  <div></div>
				   </div>
				</div>`;
	// target div before our box
	var ppt = document.querySelector("body > div.page_header_ctn.account_management");
	ppt.insertAdjacentHTML("afterend", loading);
	
	//load all wallet transactions
	
	console.log("Loading all transactions...."); 
	WalletHistory_LoadMore();
	
	console.log("done.\r\nWaiting for 8 seconds..."); 
	 setTimeout(function() {
		//extract all transactions
		var costRM = [];
		var cc = document.getElementsByClassName('wht_wallet_change');
		var change = document.getElementsByClassName('wht_total');
		var balance = document.getElementsByClassName('wht_wallet_balance');
		for (var i = 1; i < cc.length; i++) {
			if(change[i].textContent.length >1){
				//check if it is expenditure
				if((cc[i].textContent.length > 3 && cc[i].textContent[0]=='-') || (cc[i].textContent.length < 2 && balance[i].textContent.length < 2)){
					var vv =  change[i].textContent.replace(/[^\-+.0-9]/g,'');
					var oly = change[i].textContent.replace(/[^\-+.0-9à¸¿â‚µÂ¢â‚¡Bâ‚«â‚¬Æ’â‚²KÄâ‚­Â£â‚¤â‚¥â‚¦â‚±â‚¨â‚½$â‚®â‚©Â¥â‚´â‚ªÖÂ¥]/g,'');
					//convert currency to RMB 
					vv = CUR_RMB[CUR.indexOf(oly[0])]*parseFloat(vv);
					costRM.push( parseFloat(vv) );
				}
			}
		}
		
		// compute all cost
		var X = costRM.reduce(function(a, b) { return a + b; }, 0);
		console.log('done.\r\n-\r\n-\r\nYou have cost Â¥ ' + Number((X).toFixed(2)) + ' RMB on Steam so far.\r\n-\r\n-\r\n');
		document.querySelector("body > div.home_area_spotlight").remove();
		ppt.insertAdjacentHTML("afterend", donestr.replace("@SPENT@",Number((X).toFixed(2))));
	 },8888);
}
    hmmc();
})();