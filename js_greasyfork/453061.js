// ==UserScript==
// @name         Clan Stat helper 1790
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  Для клана 1790 с любовью <3
// @author       Яшка
// @match        https://www.heroeswm.ru/clan_mwlog.php?key=*
// @match        https://www.heroeswm.ru/clan_log.php?id=*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=heroeswm.ru
// @grant        none
// @license      Яшка
// @downloadURL https://update.greasyfork.org/scripts/453061/Clan%20Stat%20helper%201790.user.js
// @updateURL https://update.greasyfork.org/scripts/453061/Clan%20Stat%20helper%201790.meta.js
// ==/UserScript==
const urlDef="clan_mwlog.php?key=",urlDefOne="https://www.heroeswm.ru/clan_mwlog.php?key=",urlClanLog="https://www.heroeswm.ru/clan_log.php?id=",urlHwmHelper="https://hwm-helper.ru/";function createButton(e,t,l){var o=document.createElement("input");o.type="button",o.value=t,o.onclick=l,e.appendChild(o)}async function CheckToken(){let e,t=JSON.stringify({token:"mO50RtjMRU2BSz4/ShbbPQ=="});await fetch(`${urlHwmHelper}hwmStat/token/check`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:t}).then(async t=>{t=await t.json(),e=!!t.success,console.log(t)}).catch(t=>{e=!1});return e}async function StartDefStats(){if(!await CheckToken())return void alert("Клан не добавлен или не оплачен");try{let e=null,t=document.querySelectorAll("td"),l=t.length,o=[],n=null;for(const s of t[l-1].childNodes)if("CENTER"===s.nodeName&&"Протокол клана "===s.childNodes[0].textContent&&(n=s.childNodes[1].childNodes[0].textContent),"#text"===s.nodeName){let t=s.textContent;if(2===t.split("По результатам прошедших суток").length){let l=t.split(": По результатам прошедших суток")[0].replace(/\n/g,"").trim(),s=l.split(" "),c=s[1].replace(/\s/g,""),d=s[0].split("-");if(l=`${d[1]}-${d[0]}-${d[2]} ${c}`,console.log("!!!",l),2===t.split("выплачено налогов").length){e=t.split("выплачено налогов")[1].replace(/[^\d-]/g,""),o.push({gold:e,date:l,status:0,clanId:n});continue}if(2===t.split("в размере").length){console.log("2222"),e=t.split("в размере")[1].replace(/[^\d-]/g,""),o.push({gold:e,date:l,status:2,clanId:n});continue}if(2===t.split("клан получает").length){e=t.split("клан получает")[1].replace(/[^\d-]/g,""),o.push({gold:e,date:l,status:3,clanId:n});continue}}}console.log("123",o);let s=JSON.stringify({goldStat:o});console.log(s);await fetch(`${urlHwmHelper}hwmStat/gold/post`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:s}).then(e=>{console.log(e)})}catch(e){console.log(e)}let e=[];try{let t=document.getElementsByTagName("a");for(const l of t)if(l.href){2===l.href.split(urlDef).length&&e.push(l.href)}}catch(e){console.log(e)}try{if(0!==e.length)for(const t of e)window.open(t)}catch(e){}}async function GetStatsDefOnePage(){let e=!1,t=document.getElementsByTagName("center");for(const l of t)if(l.childNodes&&l.childNodes[2]&&l.childNodes[2].innerText&&"#1790"===l.childNodes[2].innerText){e=!0;break}if(e)try{let e=document.getElementsByTagName("table"),t=e.length,l=e[t-2].childNodes[0].childNodes[0].childNodes[0].childNodes[3].data,o=l.split("Нападение Сурвилургов на")[0].split(" "),n=o[1].replace(/\s/g,""),s=o[0].split("-");l=`${s[1]}-${s[0]}-${s[2]} ${n}`,console.log("!!!",l);let c=e[t-1].querySelectorAll("tr"),d=[];for(const e of c)try{let t;if(5===e.childNodes[3].childNodes.length){let o,n,s=e.childNodes[4].childNodes[0];(s=s.querySelectorAll("b"))[1]&&(o=s[1].innerText),s[0]&&(n=s[0].innerText);let c=[];e.childNodes[3].childNodes[2].childNodes[0].innerText&&c.push(e.childNodes[3].childNodes[2].childNodes[0].innerText),e.childNodes[3].childNodes[4].childNodes[0].innerText&&c.push(e.childNodes[3].childNodes[4].childNodes[0].innerText),t={clanId:"1790",heroes:c,clanGold:o,heroesGold:n,warResult:"win",url:e.childNodes[5].childNodes[0].childNodes[1].href,date:l}}else{let o=[];e.childNodes[3].childNodes[2].innerText&&o.push(e.childNodes[3].childNodes[2].innerText),e.childNodes[3].childNodes[5].innerText&&o.push(e.childNodes[3].childNodes[5].innerText),t={clanId:"1790",heroes:o,clanGold:"0",heroesGold:"0",warResult:"lose",date:l}}d.push(t)}catch(e){console.log(e)}if(0!==d.length){let e=JSON.stringify(d);console.log(e);await fetch(`${urlHwmHelper}hwmStat/post`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:e}).then(e=>{console.log(e)})}console.log(d),window.close()}catch(e){console.log(e),window.close()}else window.close()}!async function(){"use strict";let e=window.location.href,t=e.split("https://www.heroeswm.ru/clan_log.php?id="),l=e.split("https://www.heroeswm.ru/clan_mwlog.php?key="),o=!1;if(2===t.length){let e=document.getElementsByTagName("center");for(const t of e)if(t.childNodes&&t.childNodes[1]&&t.childNodes[1].text&&"#1790"===t.childNodes[1].text){o=!0;break}if(o){let e=document.getElementsByTagName("table");createButton(e[e.length-1],"Залить статистику",StartDefStats)}}2===l.length&&await GetStatsDefOnePage()}();