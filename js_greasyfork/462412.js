// ==UserScript==
// @name         某办公系统区域调价压缩版本
// @namespace    http://tampermonkey.net/
// @version      0.4
// @description  针对某办公系统区域调价交互进行优化。
// @author       glk
// @include      http://39.104.68.206:1688/*
// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/462412/%E6%9F%90%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F%E5%8C%BA%E5%9F%9F%E8%B0%83%E4%BB%B7%E5%8E%8B%E7%BC%A9%E7%89%88%E6%9C%AC.user.js
// @updateURL https://update.greasyfork.org/scripts/462412/%E6%9F%90%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F%E5%8C%BA%E5%9F%9F%E8%B0%83%E4%BB%B7%E5%8E%8B%E7%BC%A9%E7%89%88%E6%9C%AC.meta.js
// ==/UserScript==


const STYLE='\n  #hll_glk {\n    display: flex;\n    padding: 15px 0 15px 0;\n    align-items: center;\n  }\n\n  #hll_glk .area > textarea {\n    max-height: 40px;\n    height: 30px;\n    margin: 0px;\n    width: 300px;\n    height: 40px;\n    padding-left: 5px;\n    padding-top: 5px;\n    font-size: 12px;\n  }\n\n  #hll_glk > textarea::-webkit-input-placeholder {\n    color: hotpink;\n  }\n\n  #hll_glk > label, \n  #hll_glk > textarea {\n    margin-right: 10px;\n  }\n\n  #hll_glk label > input {\n    width: auto;\n    padding: 5px 0 5px 5px;\n    border: 1px solid #95B8E7;\n    border-radius: 4px;\n    width: 90px;\n  }\n\n  #hll_glk label > input[type="checkbox"] {\n    width: auto;\n  }\n  \n  #hll_glk .primary {\n    color: #fff;\n    background: #1890ff;\n    border-color: #1890ff;\n    text-shadow: 0 -1px 0 rgb(0 0 0 / 12%);\n    box-shadow: 0 2px #0000000b;\n    cursor: pointer;\n    padding: 4px 15px;\n    font-size: 13px;\n    border-radius: 3px;\n    height: 32px;\n    line-height: 1.5715;\n    position: relative;\n    font-weight: 400;\n    user-select: none;\n    touch-action: manipulation;\n    white-space: nowrap;\n    text-align: center;\n    outline: none;\n  }\n\n  #hll_glk .danger {\n    padding: 5px 10px;\n    color: #ff4d4f;\n    background: #fff;\n    border: 1px solid #ff4d4f;\n    border-radius: 3px;\n  }\n\n  #hll_glk > label > select {\n    padding: 5px 0 5px 5px;\n  }\n\n  #hll_glk > div {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n  }\n\n  /* 数字类型文本框去除上下快捷按钮 */\n  #hll_glk input[type=number] {  \n    -moz-appearance:textfield;  \n  } \n  #hll_glk input[type=number]::-webkit-inner-spin-button,  \n  #hll_glk input[type=number]::-webkit-outer-spin-button {  \n    -webkit-appearance: none;  \n    margin: 0;  \n  }\n\n  #goto_table a:nth-of-type(1) {\n    position: fixed;\n      right: 30px;\n      top: 50%;\n      z-index: 9999;\n      border: 1px solid #4f99ee;\n  }\n';function addStyle(e=""){let t=document.createElement("style");t.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(t)}function getDecimal(e){let t=e.toString();return t.includes("%")?Number(e.replace("%",""))/100:Number(t)}Number.prototype.toFixed=function(e){if(e>20||e<0)throw new RangeError("toFixed() digits argument must be between 0 and 20");const t=this;if(isNaN(t)||t>=Math.pow(10,21))return t.toString();if(void 0===e||0==e)return Math.round(t).toString();let a=t.toString();const r=a.split(".");if(r.length<2){a+=".";for(let t=0;t<e;t+=1)a+="0";return a}const n=r[0],i=r[1];if(i.length==e)return a;if(i.length<e){for(let t=0;t<e-i.length;t+=1)a+="0";return a}a=n+"."+i.substr(0,e);const s=i.substr(e,1);if(parseInt(s,10)>=5){const t=Math.pow(10,e);a=(a=(Math.round(parseFloat(a)*t)+1)/t).toFixed(e)}return a},function(){"use strict";const e=[{name:"其他国家",key:"all",less_than_2:{start_price:3.5,value_per_gram:.048}},{name:"俄罗斯",key:"Russian Federation",less_than_2:{start_price:1.474,value_per_gram:.157249},greater_than_2:{start_price:5.092,value_per_gram:.146127}},{name:"美国",key:"United States",less_than_2:{}},{name:"加拿大",key:"Canada",less_than_2:{}},{name:"西班牙",key:"Spain",less_than_2:{start_price:4.03,value_per_gram:.10196},greater_than_2:{}},{name:"法国",key:"France",less_than_2:{}},{name:"英国",key:"United Kingdom",less_than_2:{start_price:9.23,value_per_gram:.08707}},{name:"荷兰",key:"Netherlands",less_than_2:{}},{name:"以色列",key:"Israel",less_than_2:{start_price:7.27,value_per_gram:.07463}},{name:"巴西",key:"Brazil",less_than_2:{}},{name:"智利",key:"Chile",less_than_2:{}},{name:"澳大利亚",key:"Australia",less_than_2:{start_price:6.6,value_per_gram:.0944}},{name:"乌克兰",key:"Ukraine",less_than_2:{start_price:1.005,value_per_gram:.157316},greater_than_2:{start_price:4.69,value_per_gram:.10854}},{name:"白俄罗斯",key:"Belarus",less_than_2:{start_price:1.005,value_per_gram:.1273},greater_than_2:{start_price:4.355,value_per_gram:.15477}},{name:"日本",key:"Japan",less_than_2:{start_price:7.26,value_per_gram:.0466}},{name:"韩国",key:"South Korea",less_than_2:{start_price:6.31,value_per_gram:.049}},{name:"意大利",key:"Italy",less_than_2:{}},{name:"德国",key:"Germany",less_than_2:{start_price:8.06,value_per_gram:.08103}},{name:"波兰",key:"Poland",less_than_2:{}}];window.App=new class{constructor(){this.EXCHANGE_RATE=6.7,this.TRANSACTION_FEE=.08,this.rememberFirstXyjy=!1,this.firstSubmitEd=!1,this.firstSubmitData=[],this.hasGreaterThan2=!1,this.init()}addOptionsToSelect(){this.select_order.empty();let e='<option value="all">所有行</option>';this.priceTableTrLength=this.priceTable.find("tbody tr").length,this.select_nums=[];for(let t=0;t<this.priceTableTrLength;t++)e+=`<option value="${t+1}" >序号${t+1}</option>`,this.select_nums.push({num:t+1,isSeted:!1});this.select_order.prepend(e)}onPaste(t){$(".datum_label").css("display","none");const a=t.clipboardData.getData("text/html"),r=(new DOMParser).parseFromString(a,"text/html");if(!a.includes("其他国家"))return alert("粘贴数据有误，请清空后重新粘贴！",r),void $(".area textarea").val("");let n=[];Array.from(r.querySelectorAll("table tr")).map((e,t)=>{t>0&&n.push({name:e.children[1].textContent,estimated_profit_ratio:e.children[4].textContent,logistics:e.children[0].textContent,xslr:Number(e.children[9].textContent.trim())})}),console.log("解析的 data",n),e.forEach(e=>{let t=n.filter(t=>t.name===e.name);if(t.length)if("其他国家"===e.name)Object.assign(e.less_than_2,{estimated_profit_ratio:t[0].estimated_profit_ratio,xslr:t[0].xslr});else{let a=t.find(e=>!e.logistics.includes("无忧简易")),r=t.find(e=>e.logistics.includes("无忧简易"));Object.assign(e.less_than_2,{estimated_profit_ratio:a.estimated_profit_ratio,xslr:a.xslr}),r&&Object.assign(e.greater_than_2,{estimated_profit_ratio:r.estimated_profit_ratio,xslr:r.xslr})}}),$(".area button.primary").css("display","flex"),console.log("%c 格式化后的 COUNTRY_OPT","color: hotpink; font-size: 15px; font-weight: bold;",e),this.priceTableHeader=this.priceTable.find('thead th:has("input")').map((e,t)=>({key:$(t).contents().eq(1).text(),parentThIndex:$(t).contents().eq(1).parents("th").index()})).toArray();let i=null;this.priceTable.find("thead tr th").each((e,t)=>{$(t).prop("textContent").includes("售价")&&(i=$(t).index())}),this.priceTableHeader.push({key:"all",parentThIndex:i})}autoHandle(){$("a.pdtb5")[0].click()}addDomToTable(){if(this.priceTable){this.priceTable.parent().prepend('\n        <div id="goto_table">\n          <a href="#price_table">跳转区域定价表格</a>\n          <a name="price_table"></a>\n        </div>\n        <div id="hll_glk">\n          <div class="area">\n            <textarea placeholder="在这里粘贴各国数据..."></textarea>\n            <label class="datum_label">基准：<select name="datum">\n              <option value="xslr">销售利润</option>\n              <option value="ylb">预计盈利</option>\n            </select></label>\n            <button class="danger">清空</button>\n            <button class="primary">保存</button>\n          </div>\n          <div class="form">\n            <label>重量: <input type="number" name="weight" /></label>\n            <label>进货价格: <input type="number" name="purchase_price" /></label>\n            <label>店铺折扣: <input type="string" name="store_discount" value="70%" /></label>\n            <label>汇率: <input type="number" name="exchange_rate" value="6.7" /></label>\n            <label>沿用首次提交情况: <input type="checkbox" name="remember_first_xyjy" checked="true" /></label>\n            <label>提交到：<select name="order_number"></select></label>\n            <button class="primary submit">提交</button>\n            <button class="primary goback">返回</button>\n          </div>\n        </div>\n        '),this.select_datum=$("#hll_glk select").eq(0),this.select_datum.on("change",e=>{const t=e.target.value;this.curDatum=t,localStorage.setItem("curDatum",t)});const e=localStorage.getItem("curDatum");e?["xslr","ylb"].includes(e)?(this.curDatum=e,this.select_datum.val(e)):alert("不要乱动数据哦！"):(this.curDatum=this.select_datum.val(),localStorage.setItem("curDatum",this.curDatum)),this.remember_first_xyjy_el=$("#hll_glk input[name='remember_first_xyjy']"),this.rememberFirstXyjy=this.remember_first_xyjy_el.prop("checked"),this.remember_first_xyjy_el.on("change",e=>{const t=e.target.checked;this.rememberFirstXyjy=t}),this.exchange_rate_el=$("#hll_glk input[name='exchange_rate']"),this.EXCHANGE_RATE=Number(this.exchange_rate_el.val()),this.exchange_rate_el.on("change",e=>{this.EXCHANGE_RATE=Number(e.target.value)}),this.autoHandle(),$(".area textarea")[0].addEventListener("paste",this.onPaste.bind(this)),$("#hll_glk").children(':not(".area")').css("display","none"),$(".area button.primary").css("display","none"),$(".area button.danger").on("click",()=>{$(".area textarea").val(""),$(".area button.primary").css("display","none")}),$(".area button.primary").on("click",()=>{console.log(`%c 此次数据计算是以${this.curDatum}为基准`,"color: hotpink; font-size: 15px; font-weight: bold;"),$(".area").css("display","none"),$("#hll_glk").children(':not(".area")').css("display","flex")}),this.select_order=$("#hll_glk select").eq(1),this.addOptionsToSelect(),this.select_order.on("focus",this.addOptionsToSelect.bind(this)),$("#hll_glk button.submit").eq(0).on("click",()=>{let e=$("#hll_glk input[name='weight']").val(),t=$("#hll_glk input[name='purchase_price']").val(),a=$("#hll_glk input[name='store_discount']").val();if(e&&t&&a)if(this.getCountryExpressFee({weight:e,purchase_price:t,store_discount:a}),this.firstSubmitEd||(this.firstSubmitEd=!0),"all"===this.select_order.val())for(let e=0;e<this.select_order.children().length-1;e++)this.CurData.forEach((t,a)=>{let r=this.priceTableHeader.find(e=>e.key===t.key);r&&this.setTdByLineAndColumn(e,r.parentThIndex,t.final_price)});else this.CurData.forEach((e,t)=>{let a=this.priceTableHeader.find(t=>t.key===e.key);a&&this.setTdByLineAndColumn(Number($("#hll_glk select[name='order_number'] option:selected").val())-1,a.parentThIndex,e.final_price)});else alert("填写数据不完整！")}),$("#hll_glk button.goback").eq(0).on("click",()=>{$("#hll_glk").children(':not(".area")').css("display","none"),$(".datum_label").css("display","revert"),$(".area").css("display","flex"),$("#hll_glk textarea").eq(0).val("")})}}getPriceTable(){return new Promise(e=>{let t=null,a=$("tb-list, .goodsTable");a.length?(this.priceTable=a,this.priceTableTrLength=this.priceTable.find("tbody tr").length,this.priceTableHeader=this.priceTable.find('thead th:has("input")').map((e,t)=>({key:$(t).contents().eq(1).text(),parentThIndex:$(t).contents().eq(1).parents("th").index()})).toArray(),this.priceTableHeader.push({key:"all",parentThIndex:5}),e()):t=setTimeout(async()=>{await this.getPriceTable(),e()},5e3)})}setTdByLineAndColumn(e,t,a){this.priceTable.find("tbody").find("tr").eq(e).find("td").eq(t).find("input").val(a)[0].__v_model.set(a)}async init(){await this.getPriceTable(),addStyle(STYLE),this.addDomToTable()}getExpressFee({key:e,weight:t,value_per_gram:a,start_price:r}){let n;if(a||r)n=t*a+r;else switch(e){case"United States":n=t<=100?.09104*t+11.2:.11837*t+13.93;break;case"Canada":n=t<=30?.115*t+6.41:.09*t+7.1;break;case"Spain":t>0&&t<=100?n=.059094*t+8.308:t>100&&t<=500&&(n=.049044*t+14.271);break;case"France":n=t<100?.0693*t+6.67:.04066*t+9.65;break;case"Netherlands":n=t<=100?.0729*t+6.72:.05394*t+7.29;break;case"Brazil":t>0&&t<=300?n=.08*t+25:t>300&&t<=450?n=.08*t+27:t>450&&t<=2e3&&(n=.08*t+28);break;case"Chile":n=t/1e3*113+6.78;break;case"Italy":n=t<=100?.0715*t+6.62:.05132*t+7.2;break;case"Poland":t>0&&t<=40?n=.05491*t+4.65:t>40&&t<=100?n=.05792*t+6.12:t>100&&t<=2e3&&(n=.04763*t+10.52)}return Number(n.toFixed(2))}getPriceAndFinalPrice(e={}){const{express_fee:t,purchase_price:a,estimated_profit_ratio:r,exchange_rate:n,store_discount:i}=e;let s=(t+getDecimal(a))/(1-getDecimal(r)-this.TRANSACTION_FEE)/n;return{price:Number(s.toFixed(2)),final_price:Number((s/getDecimal(i)).toFixed(2))}}getCountryExpressFee({weight:t,purchase_price:a,store_discount:r}){console.log(`%c \n          重量【${t}g】\n          进货价格【${a}】\n          店铺折扣【${r}】\n          基准【${this.curDatum}】  \n        时`,"color: #000; font-size: 18px; font-weight: bold;",e),this.CurData=null;const n=JSON.parse(JSON.stringify(e));this.CurData=n.map((e,n)=>{let i,s,l=0,o=0;const{name:p,key:c,less_than_2:{start_price:_,value_per_gram:h,xslr:d}}=e;let u=this.getExpressFee({key:c,weight:t,value_per_gram:h,start_price:_});if("xslr"===this.curDatum&&(console.log(`${p} 原利润比`,e,e.less_than_2.estimated_profit_ratio),e.less_than_2.estimated_profit_ratio=this.getYlbByXslr({xslr:d,purchase_price:a,express_fee:u,exchange_rate:this.EXCHANGE_RATE}),console.log(`${p} 计算后利润比`,e.less_than_2.estimated_profit_ratio)),i=this.getPriceAndFinalPrice({express_fee:u,purchase_price:a,estimated_profit_ratio:e.less_than_2.estimated_profit_ratio,exchange_rate:this.EXCHANGE_RATE,store_discount:r}),e.greater_than_2){const{start_price:n,value_per_gram:i,xslr:l}=e.greater_than_2;let o=this.getExpressFee({key:c,weight:t,value_per_gram:i,start_price:n});"xslr"===this.curDatum&&(console.log(`${p} 方案2原利润比`,e,e.greater_than_2.estimated_profit_ratio),e.greater_than_2.estimated_profit_ratio=this.getYlbByXslr({xslr:l,purchase_price:a,express_fee:o,exchange_rate:this.EXCHANGE_RATE}),console.log(`${p} 方案2计算后利润比`,e.greater_than_2.estimated_profit_ratio)),s=this.getPriceAndFinalPrice({express_fee:o,purchase_price:a,estimated_profit_ratio:e.greater_than_2.estimated_profit_ratio,exchange_rate:this.EXCHANGE_RATE,store_discount:r})}if(this.rememberFirstXyjy)if(this.firstSubmitEd)if(this.firstSubmitData.length){const e=this.firstSubmitData.find(e=>e.key===c);e&&(1===e.use_price_plan?(l=i.price,o=i.final_price):2===e.use_price_plan&&(l=s.price,o=s.final_price))}else s&&i.price>2?(l=s.price,o=s.final_price):(l=i.price,o=i.final_price);else s&&i.price>2?(l=s.price,o=s.final_price,this.hasGreaterThan2=!0):(l=i.price,o=i.final_price);else s&&i.price>2?(l=s.price,o=s.final_price):(l=i.price,o=i.final_price);return console.log(`最终【${p}】的销售价格和最终价是：`,l,o),{name:p,key:c,result:i,result2:s,price:l,final_price:o}}),this.rememberFirstXyjy&&!this.firstSubmitEd&&this.CurData.forEach(e=>{if(this.hasGreaterThan2)if(e.result2){const{final_price:t,price:a}=e.result2;e.price=a,e.final_price=t,this.firstSubmitData.push({key:e.key,use_price_plan:2})}else this.firstSubmitData.push({key:e.key,use_price_plan:1});else this.firstSubmitData.push({key:e.key,use_price_plan:1})}),console.log("本次提交的最终信息",this.CurData),console.log("this.firstSubmitData",this.firstSubmitData)}getYlbByXslr({xslr:e,purchase_price:t,express_fee:a,exchange_rate:r}){const n=(e+getDecimal(t)+a)/(1-this.TRANSACTION_FEE)/r;console.log(`通过设置销售利润为 ${e}￥ 得到的销售价格${n}`);const i=1-((a+getDecimal(t))/(n*r)+this.TRANSACTION_FEE);return console.log(`通过设置销售利润为 ${e}￥ 得到的预计盈利比${i} ${(100*i).toFixed(2)}%`),i}dispose(){}}}();
