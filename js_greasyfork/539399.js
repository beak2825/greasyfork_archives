// ==UserScript==
// @name         Google AI Studio æ¨¡å‹æ³¨å…¥å™¨
// @namespace    http://tampermonkey.net/
// @version      1.8.1
// @description  å‘ Google AI Studio æ³¨å…¥è‡ªå®šä¹‰æ¨¡å‹ï¼Œæ”¯æŒåœ¨æ¨¡å‹åˆ—è¡¨ä¸­æ‰‹åŠ¨æ·»åŠ IDï¼ˆæ— éœ€è¾“å…¥ models/ï¼‰ã€‚æ‹¦æˆª XHR/Fetch è¯·æ±‚ã€‚
// @author       Generated by AI / HCPTangHY / Mozi / wisdgod / UserModified / Yefori /lccong
// @match        https://aistudio.google.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=aistudio.google.com
// @grant        none
// @run-at       document-start
// @license      MIT
// @downloadURL https://update.greasyfork.org/scripts/539399/Google%20AI%20Studio%20%E6%A8%A1%E5%9E%8B%E6%B3%A8%E5%85%A5%E5%99%A8.user.js
// @updateURL https://update.greasyfork.org/scripts/539399/Google%20AI%20Studio%20%E6%A8%A1%E5%9E%8B%E6%B3%A8%E5%85%A5%E5%99%A8.meta.js
// ==/UserScript==

(function() {
    'use strict';

    // ==================== é…ç½®ç®¡ç† ====================
    /**
     * è„šæœ¬å…¨å±€é…ç½®
     * @const
     */
    const CONFIG = {
        VERSION: "1.8.1", // æ›´æ–°ç‰ˆæœ¬å·
        STORAGE_KEY: 'AI_STUDIO_INJECTOR_CUSTOM_MODELS',
        API: { ANTI_HIJACK_PREFIX: ")]}'\n", TARGET_PATH: '/ListModels', TARGET_HOST: 'alkalimakersuite' },
        MODEL_PREFIX: 'models/',
        FIELD_INDEX: { NAME: 0, DISPLAY_NAME: 3, DESCRIPTION: 4, METHODS: 7 }
    };

    // ==================== æ¨¡å‹å®šä¹‰ ====================

    /**
     * é¢„è®¾æ¨¡å‹åˆ—è¡¨
     * @const
     */
    const PREDEFINED_MODELS = [
        {
            name: "models/gemini-2.5-pro-preview-05-06",
            displayName: `âœ¨ Gemini 2.5 Pro 05-06 (è„šæœ¬ v${CONFIG.VERSION})`,
            description: `ç”±è„šæœ¬ v${CONFIG.VERSION} é¢„è®¾æ³¨å…¥çš„æ¨¡å‹`,
        },
        // --- æ–°æ·»åŠ çš„æ¨¡å‹ç»“æŸ ---
         {
            name: "models/gemini-2.5-pro-exp-03-25",
            displayName: `âœ¨ Gemini 2.5 Pro Exp 03-25 (è„šæœ¬ v${CONFIG.VERSION})`,
            description: `ç”±è„šæœ¬ v${CONFIG.VERSION} é¢„è®¾æ³¨å…¥çš„æ¨¡å‹`,
        },
        {
            name: "models/gemini-2.5-pro-preview-03-25",
            displayName: `âœ¨ Gemini 2.5 Pro 03-25 (è„šæœ¬ v${CONFIG.VERSION})`,
            description: `ç”±è„šæœ¬ v${CONFIG.VERSION} é¢„è®¾æ³¨å…¥çš„æ¨¡å‹`,
        },
    ];

    /**
     * ç‰¹æ®ŠåŠ¨ä½œæ¨¡å‹ï¼šæ·»åŠ è‡ªå®šä¹‰æ¨¡å‹
     * @const
     */
    const ACTION_ADD_MODEL = {
        name: 'models/---script-action-add-custom---',
        displayName: `â• æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹ (ç‚¹å‡»æ­¤å¤„)`,
        description: 'ç‚¹å‡»æ­¤é¡¹ä»¥æ‰‹åŠ¨è¾“å…¥æ–°çš„æ¨¡å‹ ID å¹¶ä¿å­˜ã€‚'
    };

    /**
     * ç‰¹æ®ŠåŠ¨ä½œæ¨¡å‹ï¼šæ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰æ¨¡å‹
     * @const
     */
    const ACTION_CLEAR_MODELS = {
        name: 'models/---script-action-clear-custom---',
        displayName: `ğŸ—‘ï¸ æ¸…é™¤æ‰‹åŠ¨æ·»åŠ çš„æ¨¡å‹ (ç‚¹å‡»æ­¤å¤„)`,
        description: 'ç‚¹å‡»æ­¤é¡¹ä»¥æ¸…é™¤æ‰€æœ‰æ‚¨æ‰‹åŠ¨æ·»åŠ çš„æ¨¡å‹ã€‚'
    };



    // ==================== æ—¥å¿—ç®¡ç† ====================
    /**
     * ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†å™¨
     * @namespace Logger
     */
    const Logger = {
        prefix: `[AI Studio æ³¨å…¥å™¨ v${CONFIG.VERSION}]`,

        /**
         * è¾“å‡ºå¸¸è§„æ—¥å¿—
         * @param {...any} args - æ—¥å¿—å†…å®¹
         */
        log(...args) {
            console.log(this.prefix, ...args);
        },

        /**
         * è¾“å‡ºé”™è¯¯æ—¥å¿—
         * @param {...any} args - é”™è¯¯å†…å®¹
         */
        error(...args) {
            console.error(this.prefix, ...args);
        },

        /**
         * è¾“å‡ºè­¦å‘Šæ—¥å¿—
         * @param {...any} args - è­¦å‘Šå†…å®¹
         */
        warn(...args) {
            console.warn(this.prefix, ...args);
        }
    };

    // ==================== å­˜å‚¨ç®¡ç† ====================
    /**
     * æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨ï¼Œå¤„ç†è‡ªå®šä¹‰æ¨¡å‹çš„æŒä¹…åŒ–
     * @namespace Storage
     */
    const Storage = {
        /**
         * ä»æœ¬åœ°å­˜å‚¨åŠ è½½è‡ªå®šä¹‰æ¨¡å‹åˆ—è¡¨
         * @returns {Array<Object>} è‡ªå®šä¹‰æ¨¡å‹æ•°ç»„ï¼ŒåŒ…å«nameã€displayNameå’Œdescriptionå­—æ®µ
         */
        load() {
            try {
                const data = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (data) {
                    const models = JSON.parse(data);
                    // è‡ªåŠ¨æ›´æ–°æ¨¡å‹çš„ç‰ˆæœ¬æ ‡è®°ä»¥åŒ¹é…å½“å‰è„šæœ¬ç‰ˆæœ¬
                    return models.map(model => ({
                        ...model,
                        displayName: model.displayName.replace(/ \(è„šæœ¬ v[\d.]+\)$/, '') + ` (è„šæœ¬ v${CONFIG.VERSION})`,
                        description: model.description.replace(/è„šæœ¬ v[\d.]+/, `è„šæœ¬ v${CONFIG.VERSION}`)
                    }));
                }
            } catch (e) {
                Logger.error('åŠ è½½è‡ªå®šä¹‰æ¨¡å‹æ—¶å‡ºé”™:', e);
            }
            return [];
        },

        /**
         * ä¿å­˜è‡ªå®šä¹‰æ¨¡å‹åˆ—è¡¨åˆ°æœ¬åœ°å­˜å‚¨
         * @param {Array<Object>} models - è¦ä¿å­˜çš„æ¨¡å‹æ•°ç»„
         * @returns {boolean} ä¿å­˜æ˜¯å¦æˆåŠŸ
         */
        save(models) {
            try {
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(models));
                return true;
            } catch (e) {
                Logger.error('ä¿å­˜è‡ªå®šä¹‰æ¨¡å‹æ—¶å‡ºé”™:', e);
                return false;
            }
        }
    };

    // ==================== å·¥å…·å‡½æ•° ====================
    /**
     * é€šç”¨å·¥å…·å‡½æ•°é›†åˆ
     * @namespace Utils
     */
    const Utils = {
        /**
         * æ¸…ç†æ¨¡å‹åç§°ï¼Œç§»é™¤ç‰ˆæœ¬æ ‡è®°å’Œemojiå‰ç¼€
         * @param {string} name - åŸå§‹æ¨¡å‹åç§°
         * @returns {string} æ¸…ç†åçš„åç§°
         */
        cleanModelName(name) {
            return String(name)
                .replace(/ \(è„šæœ¬ v\d+\.\d+(\.\d+)?\)/, '')
                .replace(/^[âœ¨ğŸ¦ğŸ’§â„ï¸ğŸŒŠğŸ‰ğŸ´â€â˜ ï¸ğŸ¤–ğŸªğŸ“šğŸ—£ï¸ğŸ–¼ï¸ğŸ¨ğŸ¬âš¡ğŸ’¡ğŸŒŸğŸš€ğŸ”§ğŸ”®]\s*/, '') // å¢åŠ äº†æ–°çš„emoji
                .trim();
        },

        /**
         * æ ¼å¼åŒ–æ¨¡å‹æ˜¾ç¤ºåç§°ï¼Œæ·»åŠ ç‰ˆæœ¬æ ‡è®°
         * @param {string} displayName - åŸå§‹æ˜¾ç¤ºåç§°
         * @returns {string} å¸¦ç‰ˆæœ¬æ ‡è®°çš„æ˜¾ç¤ºåç§°
         */
        formatDisplayName(displayName) {
            const cleanName = displayName.replace(/ \(è„šæœ¬ v[\d.]+\)$/, '');
            return `${cleanName} (è„šæœ¬ v${CONFIG.VERSION})`;
        },

        /**
         * æ ¼å¼åŒ–æ¨¡å‹æè¿°ï¼Œæ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
         * @param {string} description - åŸå§‹æè¿°
         * @returns {string} æ›´æ–°ç‰ˆæœ¬åçš„æè¿°
         */
        formatDescription(description) {
            return description.replace(/è„šæœ¬ v[\d.]+/, `è„šæœ¬ v${CONFIG.VERSION}`);
        },

        /**
         * æ£€æŸ¥URLæ˜¯å¦åŒ¹é…éœ€è¦æ‹¦æˆªçš„æ¨¡å‹åˆ—è¡¨API
         * @param {string} url - è¦æ£€æŸ¥çš„URL
         * @returns {boolean} æ˜¯å¦ä¸ºç›®æ ‡URL
         */
        isTargetURL(url) {
            return url && typeof url === 'string' &&
                url.includes(CONFIG.API.TARGET_HOST) &&
                url.includes(CONFIG.API.TARGET_PATH);
        },

        /**
         * éªŒè¯æ¨¡å‹IDæ˜¯å¦æœ‰æ•ˆ
         * @param {string} id - æ¨¡å‹ID
         * @returns {boolean} IDæ˜¯å¦æœ‰æ•ˆ
         */
        validateModelId(id) {
            if (!id || typeof id !== 'string') return false;
            const trimmed = id.trim();
            return trimmed.length > 0;
        },

        /**
         * ç¡®ä¿æ¨¡å‹IDå…·æœ‰æ­£ç¡®çš„å‰ç¼€
         * @param {string} id - åŸå§‹æ¨¡å‹ID
         * @returns {string} å¸¦æ­£ç¡®å‰ç¼€çš„æ¨¡å‹ID
         */
        ensureModelPrefix(id) {
            const trimmed = id.trim();
            return trimmed.startsWith(CONFIG.MODEL_PREFIX) ? trimmed : CONFIG.MODEL_PREFIX + trimmed;
        }
    };




    // ==================== è‡ªå®šä¹‰æ¨¡å‹ç®¡ç† (UI é€»è¾‘) ====================

    /**
     * é€šè¿‡å¯¹è¯æ¡†æ”¶é›†ç”¨æˆ·è¾“å…¥å¹¶åˆ›å»ºæ–°çš„è‡ªå®šä¹‰æ¨¡å‹
     */
    function promptForNewModel() {
        // æç¤ºç”¨æˆ·è¾“å…¥æ¨¡å‹IDï¼Œä¼šè‡ªåŠ¨æ·»åŠ  'models/' å‰ç¼€
        const rawInputId = prompt("ã€æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹ã€‘\nè¯·è¾“å…¥æ–°çš„æ¨¡å‹ID (ä¾‹å¦‚: my-custom-model):\n(ä¼šè‡ªåŠ¨æ·»åŠ  'models/' å‰ç¼€)");
        if (!rawInputId) return;

        if (!Utils.validateModelId(rawInputId)) {
            alert("é”™è¯¯ï¼šæ¨¡å‹IDä¸èƒ½ä¸ºç©ºã€‚");
            return;
        }

        // è‡ªåŠ¨æ·»åŠ  'models/' å‰ç¼€
        const fullModelId = Utils.ensureModelPrefix(rawInputId);

        // ä½¿ç”¨æ¨¡å‹IDç”Ÿæˆé»˜è®¤æ˜¾ç¤ºåç§°
        const defaultName = fullModelId.split('/').pop();
        const displayNameInput = prompt("è¯·è¾“å…¥è¯¥æ¨¡å‹çš„æ˜¾ç¤ºåç§° (ä¾‹å¦‚: ğŸ¤– æˆ‘çš„æ¨¡å‹):", `ğŸ¤– ${defaultName}`);
        if (!displayNameInput) return;

        const newModel = {
            name: fullModelId,
            displayName: Utils.formatDisplayName(displayNameInput),
            description: `ç”±ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ å¹¶é€šè¿‡è„šæœ¬ v${CONFIG.VERSION} æ³¨å…¥çš„æ¨¡å‹`
        };

        const customModels = Storage.load();
        const allCurrentModels = [...PREDEFINED_MODELS, ...customModels];

        // æ£€æŸ¥æ¨¡å‹IDæ˜¯å¦å·²å­˜åœ¨
        if (allCurrentModels.some(m => m.name === fullModelId)) {
            alert(`é”™è¯¯ï¼šæ¨¡å‹ID ${fullModelId} å·²å­˜åœ¨ã€‚`);
            return;
        }

        customModels.push(newModel);
        if (Storage.save(customModels)) {
            alert(`æ¨¡å‹ ${fullModelId} æ·»åŠ æˆåŠŸï¼\n\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ä»¥åº”ç”¨æ›´æ”¹ã€‚`);
            window.location.reload();
        } else {
            alert("é”™è¯¯ï¼šæ— æ³•ä¿å­˜æ¨¡å‹ã€‚");
        }
    }

    /**
     * æ¸…é™¤æ‰€æœ‰ç”¨æˆ·è‡ªå®šä¹‰çš„æ¨¡å‹ï¼ˆä¸å½±å“é¢„è®¾æ¨¡å‹ï¼‰
     */
    function clearAllCustomModels() {
        if (confirm("âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ‚¨æ‰‹åŠ¨æ·»åŠ çš„è‡ªå®šä¹‰æ¨¡å‹å—ï¼Ÿ\n\n(è„šæœ¬é¢„è®¾çš„æ¨¡å‹ä¸ä¼šè¢«åˆ é™¤)")) {
            if (Storage.save([])) {
                alert("æ‰€æœ‰æ‰‹åŠ¨æ·»åŠ çš„è‡ªå®šä¹‰æ¨¡å‹å·²æ¸…é™¤ã€‚é¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚");
                window.location.reload();
            } else {
                alert("é”™è¯¯ï¼šæ— æ³•æ¸…é™¤æ¨¡å‹ã€‚");
            }
        }
    }

    /**
     * è®¾ç½®æ¨¡å‹é€‰æ‹©å™¨çš„ç‚¹å‡»äº‹ä»¶æ‹¦æˆªå™¨ï¼Œç”¨äºå¤„ç†åŠ¨ä½œæ¨¡å‹çš„ç‚¹å‡»
     */
    function setupModelSelectionInterceptor() {
        document.body.addEventListener('click', (event) => {
            const optionElement = event.target.closest('[role="option"], mat-option');

            if (optionElement && optionElement.textContent) {
                const text = optionElement.textContent;
                let actionTaken = false;

                if (text.includes(ACTION_ADD_MODEL.displayName)) {
                    Logger.log("æ‹¦æˆªåˆ° 'æ·»åŠ æ¨¡å‹' ç‚¹å‡»äº‹ä»¶ã€‚");
                    actionTaken = true;
                    setTimeout(promptForNewModel, 50);
                } else if (text.includes(ACTION_CLEAR_MODELS.displayName)) {
                    Logger.log("æ‹¦æˆªåˆ° 'æ¸…é™¤æ¨¡å‹' ç‚¹å‡»äº‹ä»¶ã€‚");
                    actionTaken = true;
                    setTimeout(clearAllCustomModels, 50);
                }

                if (actionTaken) {
                    // é˜»æ­¢é»˜è®¤è¡Œä¸ºå’Œäº‹ä»¶å†’æ³¡
                    event.preventDefault();
                    event.stopPropagation();
                    // ç§»é™¤ç„¦ç‚¹ä»¥å…³é—­ä¸‹æ‹‰èœå•
                    if (document.activeElement) {
                        document.activeElement.blur();
                    }
                }
            }
        }, true); // åœ¨æ•è·é˜¶æ®µå¤„ç†äº‹ä»¶
        Logger.log('æ¨¡å‹é€‰æ‹©ç‚¹å‡»æ‹¦æˆªå™¨å·²è®¾ç½®ã€‚');
    }

    // ==================== åˆå§‹åŒ– ====================

    const customModels = Storage.load();
    const ALL_MODELS_TO_INJECT = [...PREDEFINED_MODELS, ...customModels];

    Logger.log(`é¢„è®¾æ¨¡å‹: ${PREDEFINED_MODELS.length} ä¸ª, ç”¨æˆ·è‡ªå®šä¹‰æ¨¡å‹: ${customModels.length} ä¸ª`);

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupModelSelectionInterceptor);
    } else {
        setupModelSelectionInterceptor();
    }

    // ==================== æ•°æ®å¤„ç†å·¥å…·å‡½æ•° ====================

    /**
     * é€’å½’æŸ¥æ‰¾å“åº”æ•°æ®ä¸­çš„æ¨¡å‹åˆ—è¡¨æ•°ç»„ã€‚
     * è¿™ä¸ªå‡½æ•°ç°åœ¨æ›´å…·é²æ£’æ€§ï¼Œèƒ½å¤Ÿå¤„ç†æ›´æ·±å±‚æ¬¡çš„åµŒå¥—ï¼Œå¹¶éªŒè¯æ‰¾åˆ°çš„æ•°ç»„æ˜¯å¦ç¡®å®æ˜¯æ¨¡å‹åˆ—è¡¨ã€‚
     * @param {Object} obj - è¦æœç´¢çš„å¯¹è±¡
     * @returns {Array|null} æ‰¾åˆ°çš„æ¨¡å‹æ•°ç»„æˆ–null
     */
    function findModelListArray(obj) {
        if (!obj) return null;

        // ä½¿ç”¨ä¸€ä¸ªæ ˆæ¥æ¨¡æ‹Ÿé€’å½’ï¼Œé¿å…æ·±åº¦é€’å½’é™åˆ¶
        const stack = [obj];
        const visited = new Set(); // é˜²æ­¢å¾ªç¯å¼•ç”¨

        while (stack.length > 0) {
            const current = stack.pop();

            if (visited.has(current)) {
                continue;
            }
            visited.add(current);

            // æ£€æŸ¥å½“å‰æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ¨¡å‹æ•°ç»„ï¼š
            // 1. æ˜¯æ•°ç»„
            // 2. é•¿åº¦å¤§äº0
            // 3. è‡³å°‘ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯æ•°ç»„ï¼Œä¸”å…¶0ç´¢å¼•æ˜¯å­—ç¬¦ä¸²ï¼Œå¹¶ä»¥ 'models/' å¼€å¤´
            if (Array.isArray(current) && current.length > 0 &&
                Array.isArray(current[0]) &&
                typeof current[0][CONFIG.FIELD_INDEX.NAME] === 'string' &&
                current[0][CONFIG.FIELD_INDEX.NAME].startsWith(CONFIG.MODEL_PREFIX)
            ) {
                return current;
            }

            // å¦‚æœæ˜¯å¯¹è±¡æˆ–æ•°ç»„ï¼Œå°†å…¶å¯æšä¸¾çš„å±æ€§/å…ƒç´ æ¨å…¥æ ˆä¸­
            if (typeof current === 'object' && current !== null) {
                for (const key in current) {
                    if (Object.prototype.hasOwnProperty.call(current, key) && current[key] !== null) {
                        stack.push(current[key]);
                    }
                }
            }
        }
        return null;
    }

    /**
     * æŸ¥æ‰¾åˆé€‚çš„æ¨¡æ¿æ¨¡å‹ç”¨äºåˆ›å»ºæ–°æ¨¡å‹æ¡ç›®
     * @param {Array} modelsArray - æ¨¡å‹æ•°ç»„
     * @returns {Array|undefined} æ‰¾åˆ°çš„æ¨¡æ¿æ¨¡å‹
     */
    function findTemplateModel(modelsArray) {
        // ä¼˜å…ˆé€‰æ‹©åŒ…å« 'pro' çš„æ¨¡å‹ä½œä¸ºæ¨¡æ¿
        return modelsArray.find(m => Array.isArray(m) && m[CONFIG.FIELD_INDEX.NAME] && String(m[CONFIG.FIELD_INDEX.NAME]).includes('pro') && Array.isArray(m[CONFIG.FIELD_INDEX.METHODS])) ||
            // æ¬¡é€‰åŒ…å« 'flash' çš„æ¨¡å‹
            modelsArray.find(m => Array.isArray(m) && m[CONFIG.FIELD_INDEX.NAME] && String(m[CONFIG.FIELD_INDEX.NAME]).includes('flash') && Array.isArray(m[CONFIG.FIELD_INDEX.METHODS])) ||
            // æœ€åé€‰æ‹©ä»»æ„æœ‰æ–¹æ³•åˆ—è¡¨çš„æ¨¡å‹
            modelsArray.find(m => Array.isArray(m) && m[CONFIG.FIELD_INDEX.NAME] && Array.isArray(m[CONFIG.FIELD_INDEX.METHODS]));
    }

    /**
     * æ ¹æ®æ¨¡å‹åç§°æŸ¥æ‰¾åˆé€‚çš„æ¨¡æ¿æ¨¡å‹ç”¨äºåˆ›å»ºæ–°æ¨¡å‹æ¡ç›®
     * @param {Array} modelsArray - æ¨¡å‹æ•°ç»„
     * @param {String} modelName - æ¨¡æ¿æ¨¡å‹åç§°
     * @returns {Array|undefined} æ‰¾åˆ°çš„æ¨¡æ¿æ¨¡å‹
     */
    function findTemplateModelByModelName(modelsArray, modelName) {
        return modelsArray.find(m => Array.isArray(m) && m[CONFIG.FIELD_INDEX.NAME] && String(m[CONFIG.FIELD_INDEX.NAME]) === modelName && Array.isArray(m[CONFIG.FIELD_INDEX.METHODS]));
    }

    /**
     * æ›´æ–°å·²å­˜åœ¨çš„æ¨¡å‹æ¡ç›®
     * @param {Array} existingModel - ç°æœ‰æ¨¡å‹æ•°ç»„
     * @param {Object} modelToInject - è¦æ³¨å…¥çš„æ¨¡å‹é…ç½®
     * @returns {boolean} æ˜¯å¦æˆåŠŸæ›´æ–°ï¼ˆtrueè¡¨ç¤ºå·²æ›´æ–°ï¼Œæ— éœ€å†æ³¨å…¥æ–°æ¡ç›®ï¼‰
     */
    function updateExistingModel(existingModel, modelToInject) {
        // å¦‚æœç°æœ‰æ¨¡å‹ä¸å­˜åœ¨ï¼Œæˆ–è€…å…¶æ˜¾ç¤ºåç§°å·²ç»ä¸è¦æ³¨å…¥çš„æ¨¡å‹æ˜¾ç¤ºåç§°å®Œå…¨ä¸€è‡´ï¼Œåˆ™æ— éœ€æ›´æ–°
        if (!existingModel || existingModel[CONFIG.FIELD_INDEX.DISPLAY_NAME] === modelToInject.displayName) {
            return false;
        }

        const baseExistingName = Utils.cleanModelName(existingModel[CONFIG.FIELD_INDEX.DISPLAY_NAME]);
        const baseInjectName = Utils.cleanModelName(modelToInject.displayName);

        // å¦‚æœæ¸…ç†åçš„åŸºç¡€åç§°ç›¸åŒï¼Œè¯´æ˜æ˜¯åŒä¸€ä¸ªæ¨¡å‹ï¼Œåªæ˜¯ç‰ˆæœ¬æ ‡è®°æˆ–å‰ç¼€ä¸åŒï¼Œæ›´æ–°ç‰ˆæœ¬æ ‡è®°
        if (baseExistingName === baseInjectName) {
            // åŸºç¡€åç§°ç›¸åŒï¼Œæ›´æ–°ç‰ˆæœ¬æ ‡è®°
            existingModel[CONFIG.FIELD_INDEX.DISPLAY_NAME] = modelToInject.displayName;
            return true;
        } else {
            // å¦‚æœåŸºç¡€åç§°ä¸åŒï¼Œä¸”ç°æœ‰æ¨¡å‹å°šæœªè¢«æ ‡è®°ä¸ºâ€œåŸå§‹â€ï¼Œåˆ™æ ‡è®°å®ƒ
            if (!String(existingModel[CONFIG.FIELD_INDEX.DISPLAY_NAME]).includes("(åŸå§‹)")) {
                existingModel[CONFIG.FIELD_INDEX.DISPLAY_NAME] += " (åŸå§‹)";
            }
            return false;
        }
    }

    /**
     * åŸºäºæ¨¡æ¿åˆ›å»ºæ–°çš„æ¨¡å‹æ¡ç›®
     * @param {Array} templateModel - æ¨¡æ¿æ¨¡å‹
     * @param {Object} modelToInject - è¦æ³¨å…¥çš„æ¨¡å‹é…ç½®
     * @param {string} templateName - æ¨¡æ¿æ¨¡å‹åç§°
     * @returns {Array} æ–°åˆ›å»ºçš„æ¨¡å‹æ¡ç›®
     */
    function createNewModel(templateModel, modelToInject, templateName) {
        const newModel = structuredClone(templateModel);
        newModel[CONFIG.FIELD_INDEX.NAME] = modelToInject.name;
        newModel[CONFIG.FIELD_INDEX.DISPLAY_NAME] = modelToInject.displayName;
        newModel[CONFIG.FIELD_INDEX.DESCRIPTION] = `${modelToInject.description} (åŸºäº ${templateName} ç»“æ„)`;

        // ç¡®ä¿æœ‰æ–¹æ³•åˆ—è¡¨
        if (!Array.isArray(newModel[CONFIG.FIELD_INDEX.METHODS])) {
            newModel[CONFIG.FIELD_INDEX.METHODS] = [
                "generateContent", "countTokens", "createCachedContent", "batchGenerateContent"
            ];
        }
        return newModel;
    }

    // ==================== æ ¸å¿ƒå¤„ç†å‡½æ•° ====================

    /**
     * å¤„ç†APIå“åº”æ•°æ®ï¼Œæ³¨å…¥è‡ªå®šä¹‰æ¨¡å‹
     * @param {Object} jsonData - åŸå§‹JSONå“åº”æ•°æ®
     * @param {string} url - è¯·æ±‚URL
     * @returns {{data: Object, modified: boolean}} å¤„ç†ç»“æœ
     */
    function processJsonData(jsonData, url) {
        let modificationMade = false;
        const modelsArray = findModelListArray(jsonData);

        if (!modelsArray) {
            Logger.warn('æœªåœ¨å“åº”ä¸­æ‰¾åˆ°æ¨¡å‹åˆ—è¡¨æ•°ç»„ã€‚');
            return { data: jsonData, modified: false };
        }

        const generalTemplateModel = findTemplateModel(modelsArray);
        const generalTemplateName = generalTemplateModel?.[CONFIG.FIELD_INDEX.NAME] || 'unknown_template';

        if (!generalTemplateModel) {
            Logger.warn('æœªæ‰¾åˆ°åˆé€‚çš„æ¨¡æ¿æ¨¡å‹æ¥åˆ›å»ºæ–°æ¨¡å‹æ¡ç›®ã€‚');
            // å³ä½¿æ²¡æœ‰æ¨¡æ¿æ¨¡å‹ï¼Œä¹Ÿå¯ä»¥å°è¯•æ³¨å…¥ï¼Œä½†æ–°æ¨¡å‹å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ
            // è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä¸æ³¨å…¥ï¼Œå› ä¸ºæ²¡æœ‰å¯é çš„æ¨¡æ¿
            return { data: jsonData, modified: false };
        }

        // éå†æ‰€æœ‰è¦æ³¨å…¥çš„æ¨¡å‹ (é¢„è®¾ + è‡ªå®šä¹‰)ï¼Œç¡®ä¿å®ƒä»¬åœ¨åˆ—è¡¨ä¸­
        // ä½¿ç”¨ for...of å¾ªç¯ï¼Œä»¥ä¾¿åœ¨å¾ªç¯ä¸­ä¿®æ”¹æ•°ç»„æ—¶è¡Œä¸ºå¯é¢„æµ‹
        for (const modelToInject of ALL_MODELS_TO_INJECT) {
            // æŸ¥æ‰¾åˆ—è¡¨ä¸­æ˜¯å¦å·²ç»å­˜åœ¨åŒåçš„æ¨¡å‹
            const existingModel = modelsArray.find(model =>
                Array.isArray(model) && model[CONFIG.FIELD_INDEX.NAME] === modelToInject.name
            );

            let templateModel = generalTemplateModel;
            let templateName = generalTemplateName;
            // å¦‚æœæŒ‡å®šäº†æ¨¡æ¿æ¨¡å‹åç§°ï¼Œå°è¯•æŸ¥æ‰¾è¯¥æ¨¡æ¿
            if (modelToInject.templateModelName) {
                const specificTemplate = findTemplateModelByModelName(modelsArray, modelToInject.templateModelName);
                if (specificTemplate) {
                    templateModel = specificTemplate;
                    templateName = modelToInject.templateModelName;
                } else {
                    Logger.warn(`æœªæ‰¾åˆ°æŒ‡å®šçš„æ¨¡æ¿æ¨¡å‹: ${modelToInject.templateModelName}ï¼Œå°†ä½¿ç”¨é€šç”¨æ¨¡æ¿ã€‚`);
                }
            }

            if (existingModel) {
                // å¦‚æœæ¨¡å‹å·²å­˜åœ¨ï¼Œå°è¯•æ›´æ–°å…¶æ˜¾ç¤ºåç§°ï¼ˆä¾‹å¦‚ï¼Œæ›´æ–°è„šæœ¬ç‰ˆæœ¬æ ‡è®°ï¼‰
                const updated = updateExistingModel(existingModel, modelToInject);
                if (updated) {
                    modificationMade = true;
                    Logger.log(`æ›´æ–°äº†ç°æœ‰æ¨¡å‹: ${modelToInject.displayName}`);
                }
            } else {
                // å¦‚æœæ¨¡å‹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ¡ç›®å¹¶æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
                const newModelEntry = createNewModel(templateModel, modelToInject, templateName);
                modelsArray.unshift(newModelEntry); // æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
                modificationMade = true;
                Logger.log(`æˆåŠŸæ³¨å…¥æ–°æ¨¡å‹: ${modelToInject.displayName} (åŸºäº ${templateName} ç»“æ„)`);
            }
        }

        // æ³¨å…¥åŠ¨ä½œæ¨¡å‹ï¼ˆæ·»åŠ å’Œæ¸…é™¤æŒ‰é’®ï¼‰
        // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è¿™äº›åŠ¨ä½œæ¨¡å‹ï¼Œé¿å…é‡å¤æ³¨å…¥
        const addActionModelExists = modelsArray.some(m => Array.isArray(m) && m[CONFIG.FIELD_INDEX.NAME] === ACTION_ADD_MODEL.name);
        if (!addActionModelExists) {
            const addActionModel = createNewModel(generalTemplateModel, ACTION_ADD_MODEL, generalTemplateName);
            addActionModel[CONFIG.FIELD_INDEX.METHODS] = []; // æ¸…ç©ºæ–¹æ³•åˆ—è¡¨
            modelsArray.unshift(addActionModel);
            modificationMade = true;
            Logger.log('å·²æ³¨å…¥"æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹"åŠ¨ä½œæ¡ç›®ã€‚');
        }

        if (customModels.length > 0) {
            const clearActionModelExists = modelsArray.some(m => Array.isArray(m) && m[CONFIG.FIELD_INDEX.NAME] === ACTION_CLEAR_MODELS.name);
            if (!clearActionModelExists) {
                const clearActionModel = createNewModel(generalTemplateModel, ACTION_CLEAR_MODELS, generalTemplateName);
                clearActionModel[CONFIG.FIELD_INDEX.METHODS] = [];
                modelsArray.unshift(clearActionModel);
                modificationMade = true;
                Logger.log('å·²æ³¨å…¥"æ¸…é™¤æ‰‹åŠ¨æ·»åŠ çš„æ¨¡å‹"åŠ¨ä½œæ¡ç›®ã€‚');
            }
        }

        return { data: jsonData, modified: modificationMade };
    }

    /**
     * ä¿®æ”¹HTTPå“åº”ä½“ï¼Œæ³¨å…¥è‡ªå®šä¹‰æ¨¡å‹æ•°æ®
     * @param {string} originalText - åŸå§‹å“åº”æ–‡æœ¬
     * @param {string} url - è¯·æ±‚URL
     * @returns {string} ä¿®æ”¹åçš„å“åº”æ–‡æœ¬
     */
    function modifyResponseBody(originalText, url) {
        if (!originalText || typeof originalText !== 'string') return originalText;

        try {
            let textBody = originalText;
            let hasPrefix = false;

            // å¤„ç†Googleçš„ååŠ«æŒå‰ç¼€
            if (textBody.startsWith(CONFIG.API.ANTI_HIJACK_PREFIX)) {
                textBody = textBody.substring(CONFIG.API.ANTI_HIJACK_PREFIX.length);
                hasPrefix = true;
            }

            if (!textBody.trim()) return originalText; // å¦‚æœå¤„ç†å®Œå‰ç¼€åä¸ºç©ºï¼Œåˆ™è¿”å›åŸå§‹æ–‡æœ¬

            const jsonData = JSON.parse(textBody);
            const result = processJsonData(jsonData, url);

            if (result.modified) {
                let newBody = JSON.stringify(result.data);
                if (hasPrefix) newBody = CONFIG.API.ANTI_HIJACK_PREFIX + newBody;
                return newBody;
            }
        } catch (error) {
            Logger.error('å¤„ç†å“åº”ä½“æ—¶å‡ºé”™:', url, error);
        }
        return originalText;
    }

    // ==================== è¯·æ±‚æ‹¦æˆª ====================

    // æ‹¦æˆª Fetch API
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
        const url = (args[0] instanceof Request) ? args[0].url : String(args[0]);
        const response = await originalFetch.apply(this, args);

        if (Utils.isTargetURL(url) && response.ok) {
            try {
                const cloneResponse = response.clone();
                const originalText = await cloneResponse.text();
                const newBody = modifyResponseBody(originalText, url);
                if (newBody !== originalText) {
                    return new Response(newBody, {
                        status: response.status,
                        statusText: response.statusText,
                        headers: response.headers
                    });
                }
            } catch (e) {
                Logger.error('[Fetch] å¤„ç†é”™è¯¯:', e);
            }
        }
        return response;
    };

    // æ‹¦æˆª XMLHttpRequest
    const xhrProto = XMLHttpRequest.prototype;
    const originalOpen = xhrProto.open;
    const originalResponseTextDescriptor = Object.getOwnPropertyDescriptor(xhrProto, 'responseText');
    const originalResponseDescriptor = Object.getOwnPropertyDescriptor(xhrProto, 'response');

    /**
     * é‡å†™XHRçš„openæ–¹æ³•ä»¥è®°å½•è¯·æ±‚URL
     */
    xhrProto.open = function(method, url) {
        this._interceptorUrl = url;
        this._isTargetXHR = Utils.isTargetURL(url);
        return originalOpen.apply(this, arguments);
    };

    /**
     * å¤„ç†XHRå“åº”ï¼Œæ ¹æ®éœ€è¦ä¿®æ”¹å†…å®¹
     * @param {XMLHttpRequest} xhr - XHRå¯¹è±¡
     * @param {*} originalValue - åŸå§‹å“åº”å€¼
     * @param {string} type - å“åº”ç±»å‹ ('text' æˆ– 'json')
     * @returns {*} å¤„ç†åçš„å“åº”å€¼
     */
    const handleXHRResponse = (xhr, originalValue, type = 'text') => {
        if (!xhr._isTargetXHR || xhr.readyState !== 4 || xhr.status !== 200) return originalValue;

        const cacheKey = '_modifiedResponseCache_' + type;
        if (xhr[cacheKey] === undefined) {
            const originalText = (type === 'text' || typeof originalValue !== 'object' || originalValue === null)
            ? String(originalValue || '') : JSON.stringify(originalValue);
            xhr[cacheKey] = modifyResponseBody(originalText, xhr._interceptorUrl);
        }

        const cachedResponse = xhr[cacheKey];
        try {
            if (type === 'json' && typeof cachedResponse === 'string') {
                const textToParse = cachedResponse.replace(CONFIG.API.ANTI_HIJACK_PREFIX, '');
                return textToParse ? JSON.parse(textToParse) : null;
            }
        } catch (e) {
            Logger.error('[XHR] è§£æ JSON æ—¶å‡ºé”™:', e);
            return originalValue;
        }
        return cachedResponse;
    };

    // é‡å†™responseTextå±æ€§
    if (originalResponseTextDescriptor?.get) {
        Object.defineProperty(xhrProto, 'responseText', {
            get: function() {
                const originalText = originalResponseTextDescriptor.get.call(this);
                if (this.responseType && this.responseType !== 'text' && this.responseType !== "") return originalText;
                return handleXHRResponse(this, originalText, 'text');
            },
            configurable: true
        });
    }

    // é‡å†™responseå±æ€§
    if (originalResponseDescriptor?.get) {
        Object.defineProperty(xhrProto, 'response', {
            get: function() {
                const originalResponse = originalResponseDescriptor.get.call(this);
                if (this.responseType === 'json') return handleXHRResponse(this, originalResponse, 'json');
                if (!this.responseType || this.responseType === 'text' || this.responseType === "") {
                    return handleXHRResponse(this, originalResponse, 'text');
                }
                return originalResponse;
            },
            configurable: true
        });
    }

    Logger.log(`è„šæœ¬ v${CONFIG.VERSION} å·²æ¿€æ´»ã€‚Fetch å’Œ XHR æ‹¦æˆªå·²å¯ç”¨ã€‚`);
})();