// ==UserScript==
// @name                WME Boston MA 7-19-15 Overlay
// @namespace           https://greasyfork.org/users/5252
// @description         Creates polygons for MapRaid groups in a WME "Boston MA 7-19-15 Groups" layer
// @include             https://www.waze.com/editor/*
// @include             https://www.waze.com/*/editor/*
// @include             https://editor-beta.waze.com/*
// @version             1.8
// @grant               none
// @copyright           2014 davielde
// @downloadURL https://update.greasyfork.org/scripts/11013/WME%20Boston%20MA%207-19-15%20Overlay.user.js
// @updateURL https://update.greasyfork.org/scripts/11013/WME%20Boston%20MA%207-19-15%20Overlay.meta.js
// ==/UserScript==


//---------------------------------------------------------------------------------------


//generated by rickzabel's overlay generator

//RZ RaidName will be replaced by the name of the layer in your KML file
//RZ RaidNameNoSpaces will be replaced by the name of the layer in your KML file
//RZ AreaPoints will be replaced by the names, colors, and area points from your KML file

setTimeout(InitMapRaidOverlay, 1000);

function AddRaidPolygon(raidLayer,groupPoints,groupColor,groupNumber){
    
    var mro_Map = Waze.map;
    var mro_OL = OpenLayers;
    var raidGroupLabel = 'Raid Group ' + groupNumber;
    var groupName = 'RaidGroup' + groupNumber;
    
    var style = {
        strokeColor: groupColor,
        strokeOpacity: .8,
        strokeWidth: 3,
        fillColor: groupColor,
        fillOpacity: 0.15,
        label: raidGroupLabel,
        labelOutlineColor: "black",
        labelOutlineWidth: 3,
        fontSize: 14,
        fontColor: groupColor,
        fontOpacity: .85,
        fontWeight: "bold"  
    };
    
    var attributes = {
        name: groupName,
        number: groupNumber
    };
    
    var pnt= [];
    for(i=0;i<groupPoints.length;i++){
        convPoint = new OpenLayers.Geometry.Point(groupPoints[i].lon,groupPoints[i].lat).transform(new OpenLayers.Projection("EPSG:4326"), mro_Map.getProjectionObject());
        //console.log('MapRaid: ' + JSON.stringify(groupPoints[i]) + ', ' + groupPoints[i].lon + ', ' + groupPoints[i].lat);
        pnt.push(convPoint);
    }
		       
    var ring = new mro_OL.Geometry.LinearRing(pnt);
    var polygon = new mro_OL.Geometry.Polygon([ring]);
    
    var feature = new mro_OL.Feature.Vector(polygon,attributes,style);
    raidLayer.addFeatures([feature]);

}

function CurrentRaidLocation(raid_mapLayer){
    var mro_Map = Waze.map;

    for(i=0;i<raid_mapLayer.features.length;i++){
        var raidMapCenter = mro_Map.getCenter();
        var raidCenterPoint = new OpenLayers.Geometry.Point(raidMapCenter.lon,raidMapCenter.lat);
        var raidCenterCheck = raid_mapLayer.features[i].geometry.components[0].containsPoint(raidCenterPoint);
        //console.log('MapRaid: ' + raid_mapLayer.features[i].attributes.number + ': ' + raidCenterCheck);
        if(raidCenterCheck === true){
        	var raidLocationLabel = 'Raid Group ' + raid_mapLayer.features[i].attributes.number + ' - ' + $('.WazeControlLocationInfo').text();
    		//setTimeout(function(){$('.WazeControlLocationInfo').text(raidLocationLabel);},200);
			setTimeout(function(){$('.WazeControlLocationInfo').text(raidLocationLabel);},50);
			var str = $('.WazeControlLocationInfo').text();
			
			var n2 = str.indexOf(" - ");
			
			if(n2 > 0){
				var n = str.length;
				var res = str.substring(n2+2, n);
				var rescount = res.indexOf(" - ");
				if(rescount>0){
					var n3 = res.length;
					var res2 = res.substring(rescount+2, n3);
						
				}
				var raidLocationLabel = 'Raid Group ' + raid_mapLayer.features[i].attributes.number + ' - ' + res2;
			} else {
				var raidLocationLabel = 'Raid Group ' + raid_mapLayer.features[i].attributes.number + ' - ' + $('.WazeControlLocationInfo').text();
			}	
    		setTimeout(function(){$('.WazeControlLocationInfo').text(raidLocationLabel);},200);
		}
    }
}

function InitMapRaidOverlay(){

    var mro_Map = Waze.map;
    var mro_OL = OpenLayers;

    //if (!mro_Map) return;
	
    //if (!mro_OL) return;

    var mro_mapLayers = mro_Map.getLayersBy("uniqueName","__BostonMA7-19-15");
        
    var raid_mapLayer = new mro_OL.Layer.Vector("Boston MA 7-19-15", {
        displayInLayerSwitcher: true,
        uniqueName: "__BostonMA7-19-15"
    });
        
    I18n.translations.en.layers.name["__BostonMA7-19-15"] = "Boston MA 7-19-15";
    mro_Map.addLayer(raid_mapLayer);
    raid_mapLayer.setVisibility(true);
    

var V01Boston = [{lon:'-71.2047969',lat:'42.4011664'},{lon:'-71.2106335',lat:'42.3230187'},{lon:'-71.1440136',lat:'42.2585023'},{lon:'-71.0125019',lat:'42.2597735'},{lon:'-70.9335265',lat:'42.3136259'},{lon:'-70.9407362',lat:'42.3993901'},{lon:'-71.0155914',lat:'42.451607'},{lon:'-71.1281286',lat:'42.4558817'},{lon:'-71.2047969',lat:'42.4011664'}];
AddRaidPolygon(raid_mapLayer, V01Boston,"#7C3592","01-Boston");

var V02Orr = [{lon:'-70.9335265',lat:'42.3136259'},{lon:'-71.0125019',lat:'42.2597735'},{lon:'-70.8980364',lat:'42.068464'},{lon:'-70.6496837',lat:'42.1126907'},{lon:'-70.7477547',lat:'42.2550602'},{lon:'-70.8584929',lat:'42.30723950000001'},{lon:'-70.9335265',lat:'42.3136259'}];
AddRaidPolygon(raid_mapLayer, V02Orr,"#DB4436","02-Orr");

var V04Williams = [{lon:'-70.8980364',lat:'42.068464'},{lon:'-71.0125019',lat:'42.2597735'},{lon:'-71.1440136',lat:'42.2585023'},{lon:'-71.2689964',lat:'42.07935869999999'},{lon:'-70.8980364',lat:'42.068464'}];
AddRaidPolygon(raid_mapLayer, V04Williams,"#4186F0","04-Williams");

var V06Brady = [{lon:'-71.2689964',lat:'42.07935869999999'},{lon:'-71.1440136',lat:'42.2585023'},{lon:'-71.2106335',lat:'42.3230187'},{lon:'-71.4183426',lat:'42.2661307'},{lon:'-71.2689964',lat:'42.07935869999999'}];
AddRaidPolygon(raid_mapLayer, V06Brady,"#DB4436","06-Brady");

var V08Bourque = [{lon:'-71.4183426',lat:'42.2661307'},{lon:'-71.2106335',lat:'42.3230187'},{lon:'-71.2047969',lat:'42.4011664'},{lon:'-71.3915367',lat:'42.458502800000005'},{lon:'-71.4183426',lat:'42.2661307'}];
AddRaidPolygon(raid_mapLayer, V08Bourque,"#4186F0","08-Bourque");

var V10Yaz = [{lon:'-71.3915367',lat:'42.458502800000005'},{lon:'-71.2047969',lat:'42.4011664'},{lon:'-71.1281286',lat:'42.4558817'},{lon:'-71.2150955',lat:'42.6026308'},{lon:'-71.3915367',lat:'42.458502800000005'}];
AddRaidPolygon(raid_mapLayer, V10Yaz,"#DB4436","10-Yaz");

var V12Martinez = [{lon:'-71.2150955',lat:'42.6026308'},{lon:'-71.1281286',lat:'42.4558817'},{lon:'-71.0155914',lat:'42.451607'},{lon:'-70.9325409',lat:'42.6051578'},{lon:'-71.2150955',lat:'42.6026308'}];
AddRaidPolygon(raid_mapLayer, V12Martinez,"#4186F0","12-Martinez");

var V14Pierce = [{lon:'-70.9325409',lat:'42.6051578'},{lon:'-71.0155914',lat:'42.451607'},{lon:'-70.9407362',lat:'42.3993901'},{lon:'-70.7668865',lat:'42.5184905'},{lon:'-70.9325409',lat:'42.6051578'}];
AddRaidPolygon(raid_mapLayer, V14Pierce,"#DB4436","14-Pierce");

var V03Russell = [{lon:'-70.6496837',lat:'42.1126907'},{lon:'-70.8980364',lat:'42.068464'},{lon:'-70.926361',lat:'41.8710948'},{lon:'-70.7146334',lat:'41.8766376'},{lon:'-70.517807',lat:'41.920672599999996'},{lon:'-70.6496837',lat:'42.1126907'}];
AddRaidPolygon(raid_mapLayer, V03Russell,"#4186F0","03-Russell");

var V05Bird = [{lon:'-70.926361',lat:'41.8710948'},{lon:'-70.8980364',lat:'42.068464'},{lon:'-71.2689964',lat:'42.07935869999999'},{lon:'-71.3802337',lat:'41.9303791'},{lon:'-71.1593468',lat:'41.875396599999995'},{lon:'-70.926361',lat:'41.8710948'}];
AddRaidPolygon(raid_mapLayer, V05Bird,"#DB4436","05-Bird");

var V07Cousy = [{lon:'-71.3802337',lat:'41.9303791'},{lon:'-71.2689964',lat:'42.07935869999999'},{lon:'-71.4183426',lat:'42.2661307'},{lon:'-71.6157531',lat:'42.21377090000001'},{lon:'-71.5279429',lat:'42.063979499999995'},{lon:'-71.3802337',lat:'41.9303791'}];
AddRaidPolygon(raid_mapLayer, V07Cousy,"#4186F0","07-Cousy");

var V09Havlicek = [{lon:'-71.6157531',lat:'42.21377090000001'},{lon:'-71.4183426',lat:'42.2661307'},{lon:'-71.3915367',lat:'42.458502800000005'},{lon:'-71.6178131',lat:'42.5212056'},{lon:'-71.6414091',lat:'42.365465099999994'},{lon:'-71.6157531',lat:'42.21377090000001'}];
AddRaidPolygon(raid_mapLayer, V09Havlicek,"#DB4436","09-Havlicek");

var V11Hannah = [{lon:'-71.3915367',lat:'42.458502800000005'},{lon:'-71.2150955',lat:'42.6026308'},{lon:'-71.2875366',lat:'42.7868346'},{lon:'-71.6178131',lat:'42.5212056'},{lon:'-71.3915367',lat:'42.458502800000005'}];
AddRaidPolygon(raid_mapLayer, V11Hannah,"#4186F0","11-Hannah");

var V13Fisk = [{lon:'-71.2875366',lat:'42.7868346'},{lon:'-71.2150955',lat:'42.6026308'},{lon:'-70.9325409',lat:'42.6051578'},{lon:'-70.905075',lat:'42.9021245'},{lon:'-71.2875366',lat:'42.7868346'}];
AddRaidPolygon(raid_mapLayer, V13Fisk,"#DB4436","13-Fisk");

var V15Clemens = [{lon:'-70.7668865',lat:'42.5184905'},{lon:'-70.5191803',lat:'42.6420408'},{lon:'-70.905075',lat:'42.9021245'},{lon:'-70.9325409',lat:'42.6051578'},{lon:'-70.7668865',lat:'42.5184905'}];
AddRaidPolygon(raid_mapLayer, V15Clemens,"#4186F0","15-Clemens");


    
	
    setTimeout(function(){CurrentRaidLocation(raid_mapLayer);},3000);
    mro_Map.events.register("moveend", Waze.map, function(){CurrentRaidLocation(raid_mapLayer);});
    mro_Map.events.register("zoomend", Waze.map, function(){CurrentRaidLocation(raid_mapLayer);});
       
}