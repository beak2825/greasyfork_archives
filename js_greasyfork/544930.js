// ==UserScript==
// @name         æ˜Ÿå°˜ï¼šAI æ™ºèƒ½ç®¡ç†
// @name:en      Stardust: AI Smart Management
// @namespace    https://github.com/Stellaris-Shadow/Stardust-Companion
// @version      1.0.1
// @description  æ‚¨çš„ç»ˆæAIå·¥ä½œå®¤é‡å­è·ƒè¿å¼•æ“ã€‚ä¸€ä¸ªé«˜åº¦èåˆçš„æ¬¡å…ƒæ¨¡å—åŒ–æ¶æ„ï¼Œæä¾›åŸç”Ÿé‡å­æ€çš„å¯¹è¯æŠ˜å çŸ©é˜µã€æ²‰æµ¸å¼è™šç©ºå…¨åŸŸã€å¯¹è¯å†¥æƒ³æ ¸å¿ƒï¼Œä»¥åŠè¶…ç»´å¯¼å‡ºåè®®ç­‰æ— é™æ½œèƒ½åŠŸèƒ½ã€‚ç”±Stellaris-Shadowä»¥æ˜Ÿé™…åŒ å¿ƒé“¸å°±ï¼Œå”¤é†’å‰æ‰€æœªæœ‰çš„æµç•…å¤šç»´ä¸æ•ˆç‡å…‰è°±ã€‚
// @description:en Your ultimate AI studio quantum leap engine. A highly integrated dimensional modular architecture, offering a native quantum-state conversation folding matrix, immersive void-domain, dialogue meditation core, hyper-dimensional export protocol, and other features of infinite potential. Forged with interstellar craftsmanship by Stellaris-Shadow to awaken unprecedented multidimensional fluency and an efficiency spectrum.
// @author       Stellaris-Shadow
//
// @match        *://*.openai.com/*
// @match        *://gemini.google.com/*
// @match        *://bard.google.com/*
// @match        *://aistudio.google.com/*
// @match        *://claude.ai/*
// @match        *://*.anthropic.com/*
// @match        *://*.perplexity.ai/*
// @match        *://copilot.microsoft.com/*
// @match        *://*.bing.com/*
// @match        *://poe.com/*
// @match        *://huggingface.co/chat*
// @match        *://openrouter.ai/*
// @match        *://*.mistral.ai/*
// @match        *://groq.com/*
// @match        *://*.groq.com/*
// @match        *://you.com/*
// @match        *://*.deepseek.com/*
// @match        *://tongyi.aliyun.com/*
// @match        *://yiyan.baidu.com/*
// @match        *://hunyuan.tencent.com/*
// @match        *://*.zhipuai.cn/*
// @match        *://chatglm.cn/*
// @match        *://doubao.com/*
// @match        *://*.moonshot.cn/*
// @match        *://*.sensetime.com/*
// @match        *://meta.ai/*
// @match        *://*.meta.com/ai*
// @match        *://x.com/*
// @match        *://twitter.com/*
// @match        *://*.ibm.com/*
// @match        *://*.midjourney.com/*
// @match        *://*.leonardo.ai/*
// @match        *://*.cursor.sh/*
// @match        *://*.phind.com/*
// @match        *://*.cohere.com/*
//
// @icon         data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzRGNjRGQiI+PHBhdGggZD0iTTEyIDJMMTQuMDkgNi4yNkwxOC41IDcuOTVMMTUuNSA5Ljk5TDE2LjE4IDE0LjY5TDEyIDEyLjIzTDcuODIgMTQuNjlMOC41IDkuOTlMNS41IDcuOTVMMTQuMDkgNi4yNkwxMiAyaCIgZmlsbD0iI0ZERjAzMSI+PC9wYXRoPjxjaXJjbGUgY3g9IjUiIGN5PSIxOSIgcj0iMiIgZmlsbD0iI0IyQjJEMyI+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMTkuNSIgY3k9IjE3LjUiIHI9IjEuNSIgZmlsbD0iI0IyQjJEMyI+PC9jaXJjbGU+PHBhdGggZD0iTTguODcgOS44N0wxMiAxMS41bDMuMTMtMS42M2wtMS4xMy0zLjU0TDEyIDUuNDdsLTEuOTkgMi44NEw4Ljg3IDkuODdaIiBmaWxsPSIjRkZGRkZGIiBmaWxsLW9wYWNpdHk9IjAuOCI+PC9wYXRoPjwvc3ZnPg==
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_setClipboard
// @grant        GM_notification
// @grant        GM_deleteValue
// @grant        GM_registerMenuCommand
// @run-at       document-idle
// @license      MIT
// @downloadURL https://update.greasyfork.org/scripts/544930/%E6%98%9F%E5%B0%98%EF%BC%9AAI%20%E6%99%BA%E8%83%BD%E7%AE%A1%E7%90%86.user.js
// @updateURL https://update.greasyfork.org/scripts/544930/%E6%98%9F%E5%B0%98%EF%BC%9AAI%20%E6%99%BA%E8%83%BD%E7%AE%A1%E7%90%86.meta.js
// ==/UserScript==

(function() {
    'use strict';

    // =========================================================================
    // åŒºåŸŸ 1: å…¨å±€å·¥å…·ä¸æ¨¡å—å®šä¹‰
    // =========================================================================

    const Logger = { enabled: false, prefix: '[ç£çŸ³åŠ©ç†]', log(...args) { this.enabled && console.log(this.prefix, ...args); }, warn(...args) { this.enabled && console.warn(this.prefix, ...args); }, error(...args) { this.enabled && console.error(this.prefix, ...args); }, info(...args) { this.enabled && console.info(this.prefix, ...args); } };

    class PickerUtil { constructor(main) { this.main = main; this.isActive = false; this.highlightBox = null; this.infoBox = null; this.lastHoveredElement = null; this.callback = null; this.volatileClasses = /cdk-focused|cdk-mouse-focused|active|hover|focus/i; this.injectStyles(); } injectStyles() { GM_addStyle(` .keystone-picker-highlight-box { position: fixed; background-color: rgba(79, 70, 229, 0.4); border: 2px solid #fff; border-radius: 4px; z-index: 2147483646; pointer-events: none; transition: all .05s ease-out; } .keystone-picker-info-box { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.8); color: white; padding: 8px 15px; border-radius: 8px; font-family: monospace; font-size: 14px; z-index: 2147483647; pointer-events: none; text-align: center; max-width: 80%; } body.keystone-picker-active * { cursor: crosshair !important; } `); } start(callback) { if (this.isActive) return; this.isActive = true; this.callback = callback; this.main.togglePanel(false); if (!this.highlightBox) { this.highlightBox = document.createElement('div'); this.highlightBox.className = 'keystone-picker-highlight-box'; document.body.appendChild(this.highlightBox); } if (!this.infoBox) { this.infoBox = document.createElement('div'); this.infoBox.className = 'keystone-picker-info-box'; document.body.appendChild(this.infoBox); } document.body.classList.add('keystone-picker-active'); this.main.notify('æ‹¾å–æ¨¡å¼å·²å¼€å¯', 'è¯·ç‚¹å‡»ç›®æ ‡å…ƒç´  (ESCå–æ¶ˆ)'); Logger.log('Picker started.'); this.mouseMoveHandler = this.updateHighlight.bind(this); this.clickHandler = this.handleClick.bind(this); this.keydownHandler = (e) => { if (e.key === "Escape") this.stop(true); }; document.addEventListener('mousemove', this.mouseMoveHandler); document.addEventListener('click', this.clickHandler, true); document.addEventListener('keydown', this.keydownHandler, true); } stop(isCancelled = false) { if (!this.isActive) return; this.isActive = false; document.body.classList.remove('keystone-picker-active'); this.highlightBox.style.display = 'none'; this.infoBox.style.display = 'none'; document.removeEventListener('mousemove', this.mouseMoveHandler); document.removeEventListener('click', this.clickHandler, true); document.removeEventListener('keydown', this.keydownHandler, true); if (isCancelled) this.main.notify('æ‹¾å–å·²å–æ¶ˆ', 'æ‹¾å–å™¨'); Logger.log(`Picker stopped. Cancelled: ${isCancelled}`); this.callback = null; } updateHighlight(e) { const target = e.target; if (!target || target.closest('#keystone-panel, #keystone-fab, .keystone-picker-highlight-box, .keystone-picker-info-box')) return; this.lastHoveredElement = target; const rect = target.getBoundingClientRect(); this.highlightBox.style.display = 'block'; Object.assign(this.highlightBox.style, { top: `${rect.top}px`, left: `${rect.left}px`, width: `${rect.width}px`, height: `${rect.height}px` }); this.infoBox.style.display = 'block'; const rawSelector = this.generatePreciseSelector(target, false); const cleanSelector = this.generatePreciseSelector(target, true); this.infoBox.innerHTML = `<span>${cleanSelector}</span><br><span style="font-size:10px; opacity:0.7;">(åŸå§‹: ${rawSelector})</span>`; } handleClick(e) { e.preventDefault(); e.stopPropagation(); if (this.lastHoveredElement && typeof this.callback === 'function') { const selector = this.generatePreciseSelector(this.lastHoveredElement, true); Logger.log('Picker captured element. Cleaned selector:', selector); this.callback(selector); } this.stop(); } generatePreciseSelector(el, purgeVolatile = true) { if (!el || !(el instanceof Element)) return ''; if (el.id) { const id = el.id.trim(); if (/^[a-zA-Z][\w:.-]*$/.test(id)) return `#${CSS.escape(id)}`; } let path = []; while (el && el.tagName !== 'BODY') { let selector = el.tagName.toLowerCase(); let classList = Array.from(el.classList); if (purgeVolatile) { classList = classList.filter(c => c && !this.volatileClasses.test(c)); } if (classList.length > 0) { selector += '.' + classList.map(c => CSS.escape(c)).join('.'); } else if (el.parentElement) { const siblings = Array.from(el.parentElement.children); const sameTagSiblings = siblings.filter(sib => sib.tagName === el.tagName); if (sameTagSiblings.length > 1) { const index = sameTagSiblings.indexOf(el) + 1; selector += `:nth-of-type(${index})`; } } path.unshift(selector); try { if (document.querySelectorAll(path.join(' > ')).length === 1) return path.join(' > '); } catch(e) {} el = el.parentElement; } return path.join(' > '); } }

    class FocusModeModule { id = 'focusMode'; name = 'å¯¹è¯ä¸“æ³¨æ¨¡å¼'; description = 'é€šè¿‡éšè—æŒ‡å®šçš„é¡µé¢å…ƒç´ ï¼Œè®©ä½ ä¸“æ³¨äºæ ¸å¿ƒå¯¹è¯åŒºåŸŸã€‚'; init(main, container) { this.main = main; this.container = container; this.hostname = window.location.hostname; this.settings = { rules: {}, ...this.main.getModuleSettings(this.id) }; this.currentRules = this.settings.rules[this.hostname] || []; this.isFocusMode = false; GM_addStyle(`.gm-focus-hidden-element { display: none !important; }`); this.renderUI(); this.bindEvents(); Logger.log('FocusModeModule initialized.'); } renderUI() { this.container.innerHTML = `<div class="ks-button-group"> <button class="ks-button" data-action="toggleFocus">å…³é—­ä¸“æ³¨</button> <button class="ks-button primary" data-action="enterPicker">é€‰æ‹©éšè—å…ƒç´ </button> </div> <div class="ks-keyword-manager" style="margin-top: 15px;"> <h4>å½“å‰ç«™ç‚¹ (${this.hostname}) çš„éšè—è§„åˆ™:</h4> <textarea class="ks-keyword-input" data-role="rules-editor" rows="4" placeholder="æ¯è¡Œä¸€ä¸ªCSSé€‰æ‹©å™¨...">${this.currentRules.join('\n')}</textarea> <div class="ks-button-group" style="margin-top: 10px; justify-content: flex-end;"> <button class="ks-button" data-action="saveRules">ä¿å­˜è§„åˆ™</button> </div> </div>`; this.updateToggleButton(); } bindEvents() { this.container.addEventListener('click', e => { const action = e.target.closest('[data-action]')?.dataset.action; if (!action) return; e.preventDefault(); e.stopPropagation(); if (this[action]) this[action](); }); } updateToggleButton() { const btn = this.container.querySelector('[data-action="toggleFocus"]'); if (btn) btn.textContent = this.isFocusMode ? 'å…³é—­ä¸“æ³¨' : 'å¼€å¯ä¸“æ³¨'; } toggleFocus() { this.isFocusMode = !this.isFocusMode; Logger.log(`Toggling Focus Mode to: ${this.isFocusMode}`); if (this.isFocusMode && this.currentRules.length === 0) { this.main.notify('æ²¡æœ‰å®šä¹‰ä»»ä½•éšè—è§„åˆ™ã€‚', this.name); this.isFocusMode = false; Logger.warn('Focus Mode toggled on but no rules are defined.'); return; } this.currentRules.forEach(selector => { try { document.querySelectorAll(selector).forEach(el => el.classList.toggle('gm-focus-hidden-element', this.isFocusMode)); } catch (e) { Logger.error(`Invalid selector in Focus Mode: ${selector}`, e); } }); this.main.notify(`ä¸“æ³¨æ¨¡å¼å·²${this.isFocusMode ? 'å¼€å¯' : 'å…³é—­'}ã€‚`, this.name); this.updateToggleButton(); } saveRules() { const editor = this.container.querySelector('[data-role="rules-editor"]'); this.currentRules = editor.value.split('\n').map(s => s.trim()).filter(Boolean); this.settings.rules[this.hostname] = this.currentRules; this.main.saveModuleSettings(this.id, this.settings); this.main.notify('éšè—è§„åˆ™å·²ä¿å­˜ï¼', this.name); Logger.log('Focus Mode rules saved:', this.currentRules); if (this.isFocusMode) { this.isFocusMode = false; this.toggleFocus(); } } enterPicker() { this.main.picker.start(selector => { if (!selector) return; const editor = this.container.querySelector('[data-role="rules-editor"]'); if (editor && !editor.value.includes(selector)) { editor.value += (editor.value ? '\n' : '') + selector; this.saveRules(); this.main.notify(`å·²æ·»åŠ æ–°è§„åˆ™: ${selector}`, this.name); Logger.log('New rule added via picker:', selector); } }); } }

    class ImmersiveModeModule { id = 'immersiveMode'; name = 'æ²‰æµ¸å¼å…¨å±'; description = 'ä¸€é”®è¿›å…¥å…¨å±æ¨¡å¼ï¼Œå¹¶è‡ªåŠ¨éšè—é¡¶éƒ¨å’Œä¾§è¾¹æ ï¼Œæä¾›æœ€å¤§åŒ–çš„å†…å®¹è§†é‡ã€‚'; selectorsToHide = ['header', 'nav']; init(main, container) { this.main = main; this.container = container; this.isImmersive = !!document.fullscreenElement; this.originalStyles = new Map(); this.renderUI(); this.bindEvents(); Logger.log('ImmersiveModeModule initialized.'); } renderUI() { this.container.innerHTML = `<button class="ks-button primary" data-action="toggleImmersive">${this.isImmersive ? 'é€€å‡ºæ²‰æµ¸æ¨¡å¼' : 'å¼€å¯æ²‰æµ¸æ¨¡å¼'}</button><p class="ks-tip">${this.description}</p>`; } bindEvents() { this.container.querySelector('[data-action="toggleImmersive"]').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); this.toggleImmersiveMode(); }); document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement && this.isImmersive) this.toggleImmersiveMode(false); }); } toggleImmersiveMode(forceState) { const shouldBeImmersive = forceState !== undefined ? forceState : !this.isImmersive; Logger.log(`Toggling Immersive Mode to: ${shouldBeImmersive}`); if (shouldBeImmersive) { document.documentElement.requestFullscreen().catch(err => Logger.error(`[${this.name}] å…¨å±å¤±è´¥: ${err.message}`)); this.selectorsToHide.forEach(selector => { document.querySelectorAll(selector).forEach(el => { if (!this.originalStyles.has(el)) this.originalStyles.set(el, el.style.display); el.style.display = 'none'; }); }); } else { if (document.fullscreenElement) document.exitFullscreen(); this.selectorsToHide.forEach(selector => { document.querySelectorAll(selector).forEach(el => { if (this.originalStyles.has(el)) el.style.display = this.originalStyles.get(el) || ''; }); }); this.originalStyles.clear(); } this.isImmersive = shouldBeImmersive; this.renderUI(); } }

    class StableCollapserModule {
        id = 'stableCollapser'; name = 'èŠå¤©æŠ˜å å™¨'; description = 'ä¸ºæ¯æ¡å¯¹è¯æ·»åŠ å¯æŠ˜å /å±•å¼€çš„æŒ‰é’®ï¼Œä»¥åŸç”Ÿé£æ ¼å®Œç¾èå…¥UIã€‚';
        PRESET_CONFIG = { 'aistudio.google.com': { messageSelector: 'ms-chat-turn', contentSelector: 'div.turn-content', iconContainerSelector: 'div.actions', collapsedHeight: 80, } };
        COLLAPSE_BUTTON_CLASS = 'ks-collapser-btn-v96'; COLLAPSED_STATE_CLASS = 'ks-message-is-collapsed-v96'; DYNAMIC_STYLE_ID = 'collapser-dynamic-style-v96';
        constructor() { this.currentConfig = null; this.main = null; this.container = null; }
        init(main, container) { this.main = main; this.container = container; const hostname = window.location.hostname; const savedSettings = this.main.getModuleSettings(this.id) || {}; this.currentConfig = savedSettings[hostname] || this.PRESET_CONFIG[hostname] || { messageSelector: '', contentSelector: '', iconContainerSelector: '', collapsedHeight: 80 }; this.renderUI(); this.bindEvents(); this.startObserver(); Logger.log('StableCollapserModule initialized.'); }
        renderUI() { const config = this.currentConfig; this.container.innerHTML = `<div class="ks-settings-item"> <label>æ¶ˆæ¯å®¹å™¨</label> <div class="input-group"><input type="text" class="ks-keyword-input" data-setting="messageSelector" value="${config.messageSelector}"><button class="ks-button" data-action="pick" data-target="messageSelector">æ‹¾å–</button></div> </div> <div class="ks-settings-item"> <label>å†…å®¹å®¹å™¨</label> <div class="input-group"><input type="text" class="ks-keyword-input" data-setting="contentSelector" value="${config.contentSelector}"><button class="ks-button" data-action="pick" data-target="contentSelector">æ‹¾å–</button></div> </div> <div class="ks-settings-item"> <label>å›¾æ ‡çˆ¶å®¹å™¨</label> <div class="input-group"><input type="text" class="ks-keyword-input" data-setting="iconContainerSelector" value="${config.iconContainerSelector}"><button class="ks-button" data-action="pick" data-target="iconContainerSelector">æ‹¾å–</button></div> </div> <div class="ks-settings-item slider-row"> <label for="collapsedHeightSlider">æŠ˜å åé«˜åº¦: <span id="heightValueLabel">${config.collapsedHeight}px</span></label> <input type="range" id="collapsedHeightSlider" min="0" max="300" step="5" value="${config.collapsedHeight}" style="width:100%;"> </div> <div class="ks-button-group" style="margin-top: 10px; justify-content: flex-end;"> <button class="ks-button" data-action="reset">é‡ç½®ä¸ºé¢„è®¾</button> <button class="ks-button primary" data-action="save">ä¿å­˜å¹¶åº”ç”¨</button> </div>`; }
        bindEvents() { this.container.addEventListener('click', e => { const actionEl = e.target.closest('[data-action]'); if (!actionEl) return; e.preventDefault(); e.stopPropagation(); if (this[actionEl.dataset.action]) { this[actionEl.dataset.action](actionEl.dataset.target); } }); const slider = this.container.querySelector('#collapsedHeightSlider'); const label = this.container.querySelector('#heightValueLabel'); slider.addEventListener('input', () => { label.textContent = `${slider.value}px`; this.updateCollapsedHeightStyle(slider.value); }); }
        save() { const newConfig = { messageSelector: this.container.querySelector('[data-setting="messageSelector"]').value.trim(), contentSelector: this.container.querySelector('[data-setting="contentSelector"]').value.trim(), iconContainerSelector: this.container.querySelector('[data-setting="iconContainerSelector"]').value.trim(), collapsedHeight: parseInt(this.container.querySelector('#collapsedHeightSlider').value, 10), }; if (!newConfig.messageSelector || !newConfig.contentSelector || !newConfig.iconContainerSelector) { return this.main.notify('é”™è¯¯: ä¸‰ä¸ªâ€œé€‰æ‹©å™¨â€éƒ½å¿…é¡»å¡«å†™ï¼', this.name); } const hostname = window.location.hostname; const allSettings = this.main.getModuleSettings(this.id) || {}; allSettings[hostname] = newConfig; this.main.saveModuleSettings(this.id, allSettings); Logger.log('StableCollapser settings saved:', newConfig); if(confirm("é…ç½®å·²ä¿å­˜ï¼Œæ˜¯å¦ç«‹å³åˆ·æ–°é¡µé¢ä»¥åº”ç”¨æ–°è®¾ç½®ï¼Ÿ")) { location.reload(); } else { this.main.notify('é…ç½®å·²ä¿å­˜ï¼åˆ·æ–°é¡µé¢åç”Ÿæ•ˆã€‚', this.name); } }
        reset() { const hostname = window.location.hostname; if (confirm(`ç¡®å®šè¦é‡ç½®ä¸º ${hostname} çš„ä¸“ç”¨é¢„è®¾å—ï¼Ÿ`)) { const allSettings = this.main.getModuleSettings(this.id) || {}; delete allSettings[hostname]; this.main.saveModuleSettings(this.id, allSettings); Logger.log('StableCollapser settings reset for host.'); if(confirm("é…ç½®å·²é‡ç½®ï¼Œæ˜¯å¦ç«‹å³åˆ·æ–°é¡µé¢ï¼Ÿ")) { location.reload(); } } }
        pick(targetSettingName) { const targetInput = this.container.querySelector(`[data-setting="${targetSettingName}"]`); if (!targetInput) return; this.main.picker.start(selector => { if (selector) { targetInput.value = selector; this.main.notify('å…ƒç´ å·²é€‰æ‹©ï¼', 'æ‹¾å–å™¨'); Logger.log(`Picker returned selector for ${targetSettingName}:`, selector); } }); }
        updateCollapsedHeightStyle(height) { const oldStyle = document.getElementById(this.DYNAMIC_STYLE_ID); if (oldStyle) oldStyle.remove(); if (!this.currentConfig || !this.currentConfig.contentSelector) return; const css = `.${this.COLLAPSED_STATE_CLASS} ${this.currentConfig.contentSelector} { max-height: ${height}px !important; overflow: hidden !important; -webkit-mask-image: linear-gradient(to bottom, black 70%, transparent 100%); mask-image: linear-gradient(to bottom, black 70%, transparent 100%); }`; const style = document.createElement('style'); style.id = this.DYNAMIC_STYLE_ID; style.textContent = css; document.head.appendChild(style); }
        addCollapseButton(messageElement) { if (!this.currentConfig || !this.currentConfig.iconContainerSelector) return; const tryInject = () => { const iconContainer = messageElement.querySelector(this.currentConfig.iconContainerSelector); if (iconContainer) { if (iconContainer.querySelector(`.${this.COLLAPSE_BUTTON_CLASS}`)) return true; const button = document.createElement('button'); button.className = this.COLLAPSE_BUTTON_CLASS; button.title = 'æŠ˜å /å±•å¼€'; button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg>`; button.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); messageElement.classList.toggle(this.COLLAPSED_STATE_CLASS); }); iconContainer.prepend(button); return true; } return false; }; if (!tryInject()) { const tempObserver = new MutationObserver((_, obs) => { if (tryInject()) obs.disconnect(); }); tempObserver.observe(messageElement, { childList: true, subtree: true }); setTimeout(() => tempObserver.disconnect(), 5000); } }
        startObserver() { const config = this.currentConfig; if (!config || !config.messageSelector) { Logger.warn('[èŠå¤©æŠ˜å å™¨] é…ç½®æ— æ•ˆï¼Œè§‚å¯Ÿå™¨æœªå¯åŠ¨ã€‚'); return; } GM_addStyle(`.${this.COLLAPSE_BUTTON_CLASS} { background: transparent; border: none; padding: 0; margin: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--mat-icon-button-icon-color, currentcolor); cursor: pointer; transition: background-color 0.2s; flex-shrink: 0; opacity: 0.6; } ${config.messageSelector}:hover .${this.COLLAPSE_BUTTON_CLASS} { opacity: 1; } .${this.COLLAPSE_BUTTON_CLASS}:hover { background-color: var(--mat-icon-button-hover-state-layer-color, rgba(0,0,0,0.08)); } .${this.COLLAPSE_BUTTON_CLASS} svg { width: 24px; height: 24px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); } .${this.COLLAPSED_STATE_CLASS} .${this.COLLAPSE_BUTTON_CLASS} svg { transform: rotate(-180deg); }`); this.updateCollapsedHeightStyle(config.collapsedHeight); document.querySelectorAll(config.messageSelector).forEach(el => this.addCollapseButton(el)); const observer = new MutationObserver((mutations) => { for (const mutation of mutations) { for (const node of mutation.addedNodes) { if (node.nodeType === 1) { if (node.matches(config.messageSelector)) this.addCollapseButton(node); node.querySelectorAll(config.messageSelector).forEach(el => this.addCollapseButton(el)); } } } }); observer.observe(document.body, { childList: true, subtree: true }); }
    }

    class FreezerModule { id = 'freezer'; name = 'èŠå¤©è®°å½•å†»ç»“å™¨'; description = 'å†»ç»“èŠå¤©æµï¼Œè§£é™¤è™šæ‹Ÿæ»šåŠ¨é™åˆ¶ï¼Œä»¥ä¾¿æ‚¨èƒ½æŸ¥çœ‹æˆ–å¤åˆ¶å®Œæ•´çš„é•¿ç¯‡å¯¹è¯ã€‚'; freezeCss = `ms-autoscroll-container { height: auto !important; max-height: none !important; overflow: visible !important; } ms-autoscroll-container > div { transform: none !important; position: static !important; }`; styleElement = null; init(main, container) { this.main = main; this.container = container; this.isFrozen = sessionStorage.getItem('keystone_freezer_isFrozen') === 'true'; this.renderUI(); this.bindEvents(); if (this.isFrozen) this.applyFreeze(false); Logger.log(`FreezerModule initialized. Frozen state: ${this.isFrozen}`); } renderUI() { this.container.innerHTML = `<div class="ks-button-group"> <button class="ks-button" data-action="freeze" ${this.isFrozen ? 'disabled' : ''}>â„ï¸ å†»ç»“èŠå¤©</button> <button class="ks-button" data-action="unfreeze">ğŸŒ€ å–æ¶ˆå†»ç»“ (åˆ·æ–°)</button> </div><p class="ks-tip">${this.description}</p>`; } bindEvents() { this.container.addEventListener('click', e => { const action = e.target.closest('[data-action]')?.dataset.action; if (!action) return; e.preventDefault(); e.stopPropagation(); if (action === 'freeze' && !this.isFrozen) this.applyFreeze(true); if (action === 'unfreeze') this.cancelAndRefresh(); }); } applyFreeze(showNotification) { if (!this.styleElement) this.styleElement = GM_addStyle(this.freezeCss); this.isFrozen = true; sessionStorage.setItem('keystone_freezer_isFrozen', 'true'); if (showNotification) this.main.notify('èŠå¤©å·²å†»ç»“ï¼Œå¯æŸ¥çœ‹å®Œæ•´å†…å®¹ã€‚', this.name); Logger.log('Freezer applied.'); this.renderUI(); } cancelAndRefresh() { this.main.notify('å³å°†åˆ·æ–°é¡µé¢ä»¥å–æ¶ˆå†»ç»“...', this.name); sessionStorage.removeItem('keystone_freezer_isFrozen'); Logger.log('Unfreezing and refreshing page...'); setTimeout(() => window.location.reload(), 2000); } }

    // =========================================================================
    // åŒºåŸŸ 2: æ ¸å¿ƒåŠ©ç†çš„å·¥å…·ä¸åŠŸèƒ½
    // =========================================================================
    const CONFIG = { DEFAULTS: { position: { top: 'auto', right: '20px', bottom: '20px', left: 'auto' }, fabSize: 56, autoCollapseDelay: 0, theme: 'auto', dragThreshold: 5, debugLogging: false, customKeywords: { ai: ['therefore', 'additionally', 'solution', 'å› æ­¤', 'é¦–å…ˆ', 'å…¶æ¬¡', 'æ€»ç»“', 'è§£å†³æ–¹æ¡ˆ', 'æ‚¨æå‡ºäº†', 'å½“ç„¶å¯ä»¥', 'æ˜¯çš„ï¼Œç»å¯¹æœ‰ï¼', 'æˆ‘å®Œå…¨ç†è§£'], user: ['help', 'issue', 'error', 'doesn\'t work', 'æ±‚åŠ©', 'é—®é¢˜', 'é”™è¯¯', 'ä¸è¡Œ', 'æ€ä¹ˆ', 'ä¸ºä»€ä¹ˆ', 'è¯·é—®', 'æˆ‘çš„'] }, modules: {} }, load() { const saved = GM_getValue('keystone_config_v9.6', {}); const mergedKeywords = { ai: [...new Set([...this.DEFAULTS.customKeywords.ai, ...(saved.customKeywords?.ai || [])])], user: [...new Set([...this.DEFAULTS.customKeywords.user, ...(saved.customKeywords?.user || [])])] }; return { ...this.DEFAULTS, ...saved, customKeywords: mergedKeywords, modules: saved.modules || {} }; }, save(config) { GM_setValue('keystone_config_v9.6', config); } };
    const STATE = { isDragging: false, isPanelVisible: false, isSettingsVisible: false, dragStart: { x: 0, y: 0 }, pointerDown: false, autoCollapseTimer: null };
    const SELECTORS = { promptTextarea: 'textarea[aria-label="Start typing a prompt"], textarea[aria-label="Prompt"]', systemPromptTextarea: 'textarea[aria-label="System instructions"]', sendButton: 'button[aria-label="Run"], button[aria-label="Send message"]' };
    const UTILS = { notify(message, title = "ç®¡ç†é¢æ¿") { GM_notification({ title, text: message, timeout: 4000 }); }, throttle(func, limit) { let inThrottle; return function() { const args = arguments; const context = this; if (!inThrottle) { func.apply(context, args); inThrottle = true; setTimeout(() => { inThrottle = false; }, limit); } }; }, async setInputValue(selector, value, append = false) { const el = document.querySelector(selector); if (!el) return false; const newVal = append && el.value ? `${el.value}\n${value}` : value; el.value = newVal; el.dispatchEvent(new Event('input', { bubbles: true })); el.dispatchEvent(new Event('change', { bubbles: true })); return true; } };
    const FEATURES = { wordWrap(text, maxWidth, prefix = '') { if (!text) return [prefix]; const finalLines = []; const paragraphs = text.split('\n'); paragraphs.forEach(paragraph => { if (paragraph.trim() === '') { finalLines.push(prefix.trimEnd()); return; } let currentLine = ''; let currentLineWidth = 0; for (let i = 0; i < paragraph.length; i++) { const char = paragraph[i]; const charWidth = char.match(/[^\x00-\xff]/) ? 2 : 1; if (currentLineWidth + charWidth > maxWidth) { finalLines.push(prefix + currentLine); currentLine = char; currentLineWidth = charWidth; } else { currentLine += char; currentLineWidth += charWidth; } } if (currentLine) { finalLines.push(prefix + currentLine); } }); return finalLines; }, classifyRole(text, config) { const lowerText = text.toLowerCase(); let aiScore = 0; let userScore = 0; const AI_KEYWORDS = config.customKeywords.ai; const USER_KEYWORDS = config.customKeywords.user; AI_KEYWORDS.forEach(kw => { if (lowerText.includes(kw.toLowerCase())) aiScore += 2; }); USER_KEYWORDS.forEach(kw => { if (lowerText.includes(kw.toLowerCase())) userScore += 2; }); if (lowerText.endsWith('?') || lowerText.endsWith('ï¼Ÿ')) userScore += 10; if (lowerText.match(/^\d+\.\s/m) || lowerText.match(/^\s*-\s/m) || lowerText.match(/^\s*\*\s/m)) aiScore += 5; if ((lowerText.match(/\n/g) || []).length > 2) aiScore += 3; if (lowerText.includes('macbook') || lowerText.includes('macos')) userScore += 3; return aiScore > userScore ? 'AI Assistant' : 'You'; }, parseAndDownload(targetElement, config) { if (!targetElement || typeof targetElement.innerText !== 'string') { return UTILS.notify('é€‰æ‹©çš„ç›®æ ‡å…ƒç´ æ— æ•ˆã€‚', 'è§£æå¤±è´¥'); } const rawText = targetElement.innerText; let cleanedText = `--- AI Studio å¯¹è¯å¯¼å‡º (ç”± æ˜Ÿè¾°çš„å½± åˆ›å»ºçš„è„šæœ¬æ™ºèƒ½è¯†åˆ«) ---\n\n`; let messageCount = 0; const blocks = rawText.split(/Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â· Â·/); blocks.forEach(block => { if (block.trim() === '') return; const role = this.classifyRole(block, config); const roleName = role === 'You' ? 'ä½¿ç”¨è€… (User)' : 'AI'; const icon = role === 'You' ? 'ğŸ‘¤' : 'ğŸ¤–'; let message = block.replace(/â•­â”€â”€â”€.*?â”€â”€â”€â•®\n/, '').trim(); if (message) { const boxWidth = 58; const boxContentWidth = boxWidth - 2; const topBar = `â”Œ${'â”€'.repeat(boxWidth)}â”`; const bottomBar = `â””${'â”€'.repeat(boxWidth)}â”˜`; const separator = messageCount > 0 ? `\n\n` : ''; let formattedContent = []; formattedContent.push(`â”‚ ${icon} ${roleName}:`); formattedContent.push(`â”‚`); const wrappedLines = this.wordWrap(message, boxContentWidth, 'â”‚ '); formattedContent = formattedContent.concat(wrappedLines); cleanedText += `${separator}${topBar}\n${formattedContent.join('\n')}\n${bottomBar}`; messageCount++; } }); if (messageCount === 0) { return UTILS.notify('è§£æå¤±è´¥ï¼šè™½ç„¶é€‰æ‹©äº†å…ƒç´ ï¼Œä½†æ— æ³•è§£æå‡ºæœ‰æ•ˆçš„å¯¹è¯æ ¼å¼ã€‚', 'å¯¼å‡ºå¤±è´¥'); } try { const blob = new Blob([cleanedText], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `AI-Studio-Chat-${new Date().toISOString().slice(0, 10)}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); UTILS.notify(`æˆåŠŸå¯¼å‡º ${messageCount} æ¡å¯¹è¯ï¼Œæ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ï¼`, 'å¯¼å‡ºæˆåŠŸ'); } catch (e) { UTILS.notify('ä¸‹è½½æ–‡ä»¶æ—¶å‡ºé”™ï¼Œå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚', 'ä¸‹è½½å¤±è´¥'); GM_setClipboard(cleanedText); } }, parseAndDownloadGeminiCode() { const rawCode = prompt("è¯·ç²˜è´´ä» AI Studio å¯¼å‡ºçš„ Python ä»£ç ç‰‡æ®µ:", ""); if (!rawCode || rawCode.trim() === "") { return UTILS.notify("æœªè¾“å…¥ä»»ä½•å†…å®¹ã€‚", "æ“ä½œå–æ¶ˆ"); } let formattedText = `--- Gemini Code Export (Parsed by script from Stellaris-Shadow) ---\n\n`; let messageCount = 0; const contentRegex = /types\.Content\([\s\S]*?role="([^"]+)"[\s\S]*?parts=\[([\s\S]*?)\]\s*\)/g; const textRegex = /from_text\(text="""([\s\S]*?)"""\)/g; let contentMatch; while ((contentMatch = contentRegex.exec(rawCode)) !== null) { const role = contentMatch[1] === 'user' ? 'ä½¿ç”¨è€… (User)' : 'AI'; const icon = contentMatch[1] === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'; const partsContent = contentMatch[2]; let combinedMessage = ''; let textMatch; textRegex.lastIndex = 0; while((textMatch = textRegex.exec(partsContent)) !== null){ combinedMessage += textMatch[1]; } const message = combinedMessage.trim(); if (message) { const boxWidth = 58; const boxContentWidth = boxWidth - 2; const topBar = `â”Œ${'â”€'.repeat(boxWidth)}â”`; const roleLine = `â”‚ ${icon} ${role}:`; const blankLine = `â”‚`; const bottomBar = `â””${'â”€'.repeat(boxWidth)}â”˜`; const wrappedLines = this.wordWrap(message, boxContentWidth, 'â”‚ '); const separator = messageCount > 0 ? '\n\n' : ''; formattedText += `${separator}${topBar}\n${roleLine}\n${blankLine}\n${wrappedLines.join('\n')}\n${bottomBar}`; messageCount++; } } if (messageCount === 0) { return UTILS.notify("è§£æå¤±è´¥ï¼šæ— æ³•ä»æ‚¨ç²˜è´´çš„ä»£ç ä¸­æå–æœ‰æ•ˆçš„å¯¹è¯ã€‚", "è§£æå¤±è´¥"); } try { const blob = new Blob([formattedText], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Gemini-Code-Parse-${new Date().toISOString().slice(0, 10)}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); UTILS.notify(`æˆåŠŸè§£æå¹¶å¯¼å‡º ${messageCount} æ¡å¯¹è¯ï¼`, "å¯¼å‡ºæˆåŠŸ"); } catch (e) { UTILS.notify('ä¸‹è½½æ–‡ä»¶æ—¶å‡ºé”™ï¼Œå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚', 'ä¸‹è½½å¤±è´¥'); GM_setClipboard(formattedText); } }, async injectToMainPrompt() { const text = "/Think \n \n(with thinking step)"; if (!(await UTILS.setInputValue(SELECTORS.promptTextarea, text, true))) { UTILS.notify('æ‰¾ä¸åˆ°ä¸»è¾“å…¥æ¡†ã€‚', 'æ³¨å…¥å¤±è´¥'); } }, async sendContinue() { if (!(await UTILS.setInputValue(SELECTORS.promptTextarea, 'continue'))) { UTILS.notify('æ‰¾ä¸åˆ°ä¸»è¾“å…¥æ¡†ã€‚', 'å‘é€å¤±è´¥'); return; } setTimeout(() => { const btn = document.querySelector(SELECTORS.sendButton); if (btn && !btn.disabled) { btn.click(); } else { UTILS.notify('æ— æ³•ç‚¹å‡»å‘é€æŒ‰é’®ã€‚', 'å‘é€å¤±è´¥'); } }, 100); }, async injectSystemPrompt() { const prompt = `MCOS-G3: å…ƒè®¤çŸ¥æ“ä½œç³»ç»Ÿ...`; if (await UTILS.setInputValue(SELECTORS.systemPromptTextarea, prompt)) { UTILS.notify('MCOS-G3 é«˜çº§æ€è€ƒæ¨¡æ¿å·²æ³¨å…¥ï¼', 'æ³¨å…¥æˆåŠŸ'); } else { UTILS.notify('æ³¨å…¥å¤±è´¥ï¼è¯·å…ˆæ‰‹åŠ¨å±•å¼€ç³»ç»ŸæŒ‡ä»¤æ¡†ã€‚', 'æ“ä½œå¤±è´¥'); } } };

    // =========================================================================
    // åŒºåŸŸ 3: å·²å‡çº§çš„ä¸» Assistant ç±»
    // =========================================================================
    class Assistant {
        constructor() { this.config = CONFIG.load(); this.elements = {}; this.modules = []; this.picker = new PickerUtil(this); Logger.enabled = this.config.debugLogging; }
        registerModule(moduleInstance) { this.modules.push(moduleInstance); return this; }
        init() { this.injectStyles(); this.createDOM(); this.applyConfigStyles(); this.bindEvents(); this.updateTheme(); Logger.info(`ç®¡ç†é¢æ¿ (ç”± æ˜Ÿè¾°çš„å½± åˆ›å»º) V${GM_info.script.version} (ç¨³å®šä¿®å¤ç‰ˆ) å·²åŠ è½½ã€‚`); }

        injectStyles() { GM_addStyle(`:root { --fab-size: 56px; --radius-l: 16px; --radius-m: 12px; --radius-s: 8px; --ts: 0.25s; --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; --bg-p: #F9FAFB; --bg-s: #FFFFFF; --header-bg: linear-gradient(135deg, #F3E8FF 0%, #E0F2FE 100%); --txt-p: #111827; --txt-s: #6B7280; --bdr: #E5E7EB; --acc: #6366F1; --acc-txt: #FFFFFF; --acc-1: #E0F2FE; --acc-2: #FEF3C7; --acc-3: #FCE7F3; --acc-4: #E0E7FF; --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05); --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); } body[data-keystone-theme=dark] { --bg-p: #0D1117; --bg-s: #161B22; --header-bg: linear-gradient(135deg, #1E1B4B 0%, #1E293B 100%); --txt-p: #E5E7EB; --txt-s: #9CA3AF; --bdr: #30363D; --acc: #818CF8; --acc-txt: #111827; --acc-1: #0C4A6E; --acc-2: #78350F; --acc-3: #831843; --acc-4: #312E81; --shadow: 0 0 1px 0 #000; --shadow-lg: 0 0 1px 0 #000; } #keystone-fab { position: fixed; width: var(--fab-size); height: var(--fab-size); background: var(--acc); border-radius: 50%; box-shadow: var(--shadow-lg); display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 9998; transition: all var(--ts) cubic-bezier(0.4, 0, 0.2, 1); } #keystone-fab:hover { transform: scale(1.1); box-shadow: 0 0 20px 0 var(--acc); } #keystone-fab svg { fill: var(--acc-txt); width: 50%; height: 50%; transition: transform var(--ts) ease; } #keystone-fab.is-open svg { transform: rotate(180deg); } #keystone-panel { position: fixed; width: 380px; max-height: 85vh; color: var(--txt-p); border-radius: var(--radius-l); box-shadow: var(--shadow-lg); z-index: 9997; display: flex; flex-direction: column; border: 1px solid var(--bdr); opacity: 0; transform: scale(0.95); pointer-events: none; transition: opacity var(--ts) ease, transform var(--ts) ease; font-family: var(--font-sans); line-height: 1.6; background-color: rgba(249, 250, 251, 0.75); backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%); } body[data-keystone-theme=dark] #keystone-panel { background-color: rgba(22, 27, 34, 0.75); } .is-visible { opacity: 1 !important; transform: scale(1) !important; pointer-events: auto !important; } .ks-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: var(--header-bg); border-bottom: 1px solid var(--bdr); flex-shrink: 0; border-top-left-radius: var(--radius-l); border-top-right-radius: var(--radius-l); } .ks-header-title { font-weight: 600; font-size: 16px; color: var(--txt-p); } .ks-header-btn { background: transparent; border: none; cursor: pointer; color: var(--txt-s); padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all .2s ease; } .ks-header-btn:hover, .ks-header-btn.active { background: rgba(128, 128, 128, 0.15); color: var(--txt-p); } .ks-header-btn svg { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; transition: transform .3s ease-in-out; } .ks-header-btn.active svg { transform: rotate(90deg); } .ks-view { padding: 16px; overflow-y: auto; flex: 1; min-height: 0; } .ks-settings-view { display: none; } .ks-accordion { margin-bottom: 12px; border-radius: var(--radius-m); background-color: var(--bg-s); border: 1px solid var(--bdr); transition: all .2s ease; overflow: hidden; } .ks-accordion-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; cursor: pointer; transition: background-color .2s ease; } .ks-accordion-header:hover { filter: brightness(0.95); } .ks-accordion-title { font-weight: 500; color: var(--txt-p); font-size: 15px; } .ks-accordion-arrow-svg { transition: transform .3s ease; width: 16px; height: 16px; fill: var(--txt-s); } .ks-accordion.is-open .ks-accordion-arrow-svg { transform: rotate(90deg); } .ks-accordion-content { max-height: 0; overflow: hidden; opacity: 0; transition: max-height .35s ease, opacity .3s ease, padding .3s ease; padding: 0 16px; } .ks-accordion.is-open .ks-accordion-content { max-height: 70vh; opacity: 1; padding-top: 12px; padding-bottom: 16px; } .ks-button-group { display: flex; flex-wrap: wrap; gap: 10px; } .ks-button { background: var(--bg-s); color: var(--txt-p); border: 1px solid var(--bdr); border-radius: var(--radius-s); padding: 8px 14px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all .2s ease; box-shadow: var(--shadow-sm); } .ks-button:hover { border-color: var(--acc); color: var(--acc); transform: translateY(-1px); box-shadow: var(--shadow); } .ks-button.primary { background: var(--acc); color: var(--acc-txt); border-color: var(--acc); font-weight: 600; } .ks-button.primary:hover { filter: brightness(1.1); color: var(--acc-txt); border-color: var(--acc); } .ks-button:disabled { background: var(--bdr); color: var(--txt-s); cursor: not-allowed; transform: none; box-shadow: none; border-color: var(--bdr); } .ks-tip { font-size: 13px; color: var(--txt-s); margin-top: 12px; line-height: 1.6; padding-bottom: 8px; border-bottom: 1px dashed var(--bdr); } .ks-settings-item { display: grid; grid-template-columns: max-content 1fr; gap: 12px; align-items: center; margin-bottom: 16px; } .ks-settings-item label { white-space: nowrap; font-size: 14px; } .input-group { display: flex; gap: 8px; align-items: center; } .input-group .ks-keyword-input { flex: 1; min-width: 0; } .ks-keyword-input { flex-grow: 1; background: var(--bg-p); border: 1px solid var(--bdr); color: var(--txt-p); padding: 8px 12px; border-radius: var(--radius-s); font-size: 14px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); transition: all .2s ease; outline: none; } .ks-keyword-input:focus, .ks-settings-item select:focus { border-color: var(--acc); box-shadow: 0 0 0 3px color-mix(in srgb, var(--acc) 20%, transparent); } input.ks-keyword-input[type="text"] { white-space: nowrap; overflow-x: auto; } input.ks-keyword-input::-webkit-scrollbar { height: 6px; } input.ks-keyword-input::-webkit-scrollbar-thumb { background-color: var(--bdr); border-radius: 4px; } .slider-row input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #ddd; border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s; } .slider-row input[type="range"]:hover { opacity: 1; } .slider-row input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--acc); cursor: pointer; border-radius: 50%; } .ks-keyword-manager h4 { margin: 20px 0 12px; font-size: 14px; color: var(--txt-p); font-weight: 600; } .ks-keyword-list { display: flex; flex-wrap: wrap; gap: 8px; min-height: 28px; padding-bottom: 8px; } .ks-keyword-item { display: inline-flex; align-items: center; background: var(--bg-p); padding: 4px 12px; border-radius: 9999px; font-size: 13px; font-weight: 500; color: var(--txt-p); border: 1px solid var(--bdr); transition: all .2s ease; } .ks-keyword-item button { background: 0 0; border: 0; color: var(--txt-s); margin-left: 6px; cursor: pointer; font-size: 16px; line-height: 1; padding: 2px; border-radius: 50%; opacity: 0.5; transition: all .2s ease; } .ks-keyword-item:hover button { opacity: 1; color: #F87171; background-color: rgba(248, 113, 113, 0.1); } ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: var(--bdr); border-radius: 10px; border: 2px solid var(--bg-s); } ::-webkit-scrollbar-thumb:hover { background: var(--txt-s); }`); }

        createDOM() { const fab = document.createElement('div'); fab.id = 'keystone-fab'; fab.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2L4 7v10l8 5 8-5V7l-8-5zm0 2.24L17.25 8 12 11.25 6.75 8 12 4.24zM6 10.66V17.18l6 4.5v-8L6 10.18z"/></svg>`; const panel = document.createElement('div'); panel.id = 'keystone-panel'; const settingsBtn = document.createElement('button'); settingsBtn.className = 'ks-header-btn'; settingsBtn.dataset.action = 'toggle-settings'; settingsBtn.title = 'è®¾ç½®'; settingsBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.06-0.7-1.68-0.92L14.05,2.5 C14.02,2.24,13.81,2.05,13.55,2.05H10.45c-0.26,0-0.47,0.19-0.5,0.45L9.62,4.97C8.99,5.19,8.43,5.51,7.93,5.89L5.54,4.93 c-0.22-0.08-0.47,0-0.59,0.22L3.03,8.47c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C5.02,11.36,5,11.68,5,12 s0.02,0.64,0.07,0.94l-2.03,1.58c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96 c0.5,0.38,1.06,0.7,1.68,0.92l0.33,2.47c0.03,0.26,0.24,0.45,0.5,0.45h3.1c0.26,0,0.47-0.19,0.5-0.45l0.33-2.47 c0.62-0.22,1.18-0.54,1.68-0.92l2.39,0.96c0.22,0.08,0.47,0,0.59,0.22l1.92-3.32c0.11-0.2,0.06-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path></svg>`; const header = document.createElement('div'); header.className = 'ks-header'; const title = document.createElement('span'); title.className = 'ks-header-title'; title.textContent = 'ç®¡ç†é¢æ¿'; const btnWrapper = document.createElement('div'); btnWrapper.appendChild(settingsBtn); header.append(title, btnWrapper); panel.innerHTML = `<div class="ks-view ks-main-view"></div><div class="ks-view ks-settings-view"></div>`; panel.prepend(header); document.body.append(fab, panel); this.elements = { fab, panel, mainView: panel.querySelector('.ks-main-view'), settingsView: panel.querySelector('.ks-settings-view') }; this.renderMainView(); }
        renderMainView() { const mainView = this.elements.mainView; mainView.innerHTML = ''; const createButton = (text, attrs) => { const btn = document.createElement('button'); btn.className = 'ks-button'; btn.textContent = text; for (const key in attrs) { if (key === 'class') btn.classList.add(attrs[key]); else btn.dataset[key.replace('data-', '')] = attrs[key]; } return btn; }; const createTip = (text) => { const tip = document.createElement('p'); tip.className = 'ks-tip'; tip.innerHTML = text; return tip; }; const createButtonGroup = (buttons) => { const group = document.createElement('div'); group.className = 'ks-button-group'; buttons.forEach(b => group.appendChild(b)); return group; }; const createAccordion = (title, contentElements, isModule = false) => { const accordion = document.createElement('div'); accordion.className = 'ks-accordion'; const header = document.createElement('div'); header.className = 'ks-accordion-header'; header.dataset.action = 'toggle-accordion'; header.innerHTML = `<span class="ks-accordion-title">${title}</span><svg class="ks-accordion-arrow-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>`; const content = document.createElement('div'); content.className = 'ks-accordion-content'; if(isModule) content.style.paddingTop = '16px'; contentElements.forEach(el => content.appendChild(el)); accordion.append(header, content); return accordion; }; const exportButtons = createButtonGroup([ createButton('ç²¾å‡†å¯¼å‡º (æ‰‹åŠ¨é€‰æ‹©)', { 'data-action': 'export-with-picker', class: 'primary' }), createButton('è§£æ Gemini ä»£ç ', { 'data-action': 'parse-gemini-code' }) ]); const exportTip = createTip('<b>ç²¾å‡†å¯¼å‡º:</b> ç‚¹å‡»åæ‰‹åŠ¨é€‰æ‹©å¯¹è¯åŒºåŸŸï¼Œæ™ºèƒ½è¯†åˆ«è§’è‰²ã€‚<br><b>è§£æä»£ç :</b> ç²˜è´´å®˜æ–¹å¯¼å‡ºçš„Pythonä»£ç ï¼Œè½¬æ¢ä¸ºå¯¹è¯æ ¼å¼ã€‚'); mainView.appendChild(createAccordion('å¯¹è¯ç®¡ç†', [exportButtons, exportTip])); mainView.appendChild(createAccordion('å¿«æ·æ³¨å…¥', [createButtonGroup([createButton('æ³¨å…¥"å¸¦æ€è€ƒæ­¥éª¤"', { 'data-action': 'add-thinking' }), createButton('å‘é€"continue"', { 'data-action': 'send-continue' })]), createTip('å¿«é€Ÿå‘è¾“å…¥æ¡†æ·»åŠ å¸¸ç”¨æŒ‡ä»¤ã€‚')])); mainView.appendChild(createAccordion('ç³»ç»ŸæŒ‡ä»¤', [createButton('æ³¨å…¥é«˜çº§æ€è€ƒæ¨¡æ¿', { 'data-action': 'inject-system-prompt', class: 'primary' }), createTip('å‘ç³»ç»ŸæŒ‡ä»¤(System Prompt)ä¸­æ³¨å…¥é¢„è®¾çš„é«˜çº§æ€è€ƒæ¡†æ¶ã€‚')])); mainView.appendChild(createAccordion('å¹³å°å·¥å…·', [createButton('æ£€æŸ¥å®˜æ–¹æœåŠ¡çŠ¶æ€', { 'data-action': 'check-status' }), createTip('åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ Google AI Platform çš„å®˜æ–¹æœåŠ¡çŠ¶æ€é¡µé¢ã€‚')])); this.modules.forEach(module => { if (module.name && typeof module.init === 'function') { const moduleAccordion = createAccordion(module.name, [], true); const contentContainer = moduleAccordion.querySelector('.ks-accordion-content'); mainView.appendChild(moduleAccordion); try { module.init(this, contentContainer); Logger.log(`Module [${module.name}] initialized successfully.`); } catch (e) { Logger.error(`Module [${module.name}] initialization failed:`, e); contentContainer.innerHTML = `<p class="ks-tip" style="color:red;">æ­¤æ¨¡å—åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°(F12)è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚</p>`; } } }); const allAccordions = mainView.querySelectorAll('.ks-accordion'); const accordionColors = ['--acc-1', '--acc-2', '--acc-3', '--acc-4']; allAccordions.forEach((accordion, index) => { const header = accordion.querySelector('.ks-accordion-header'); if (header) { header.style.backgroundColor = `var(${accordionColors[index % accordionColors.length]})`; } }); }
        renderSettings() { const settingsView = this.elements.settingsView; if (settingsView.children.length > 0) return; const createAccordionHeader = (title) => `<div class="ks-accordion-header" data-action="toggle-accordion"><span class="ks-accordion-title">${title}</span><svg class="ks-accordion-arrow-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg></div>`; settingsView.innerHTML = `<div class="ks-accordion">${createAccordionHeader('å¤–è§‚è®¾ç½®')}<div class="ks-accordion-content"><div class="ks-settings-item"><label for="ks-theme-select">ä¸»é¢˜</label><select id="ks-theme-select" class="ks-keyword-input"><option value="auto">è‡ªåŠ¨</option><option value="light">æµ…è‰²</option><option value="dark">æ·±è‰²</option></select></div><div class="ks-settings-item"><label for="ks-fab-size">å›¾æ ‡å¤§å° (px)</label><input type="number" id="ks-fab-size" min="32" max="80" class="ks-keyword-input"></div></div></div><div class="ks-accordion">${createAccordionHeader('è¡Œä¸ºè®¾ç½®')}<div class="ks-accordion-content"><div class="ks-settings-item"><label for="ks-collapse-delay">è‡ªåŠ¨æŠ˜å å»¶æ—¶ (ç§’)</label><input type="number" id="ks-collapse-delay" min="0" class="ks-keyword-input"></div><div class="ks-settings-item"><label for="ks-debug-logging">å¯ç”¨è°ƒè¯•æ—¥å¿—</label><input type="checkbox" id="ks-debug-logging"></div><p class="ks-tip">å¯ç”¨åï¼Œå°†åœ¨æµè§ˆå™¨æ§åˆ¶å°(F12)è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚</p></div></div><div class="ks-accordion keyword-accordion">${createAccordionHeader('è¯­å¢ƒå¼•æ“è®¾ç½®')}<div class="ks-accordion-content ks-keyword-manager"></div></div><div class="ks-accordion"><div class="ks-accordion-content" style="padding-top:0; padding-bottom:0;"><div class="ks-button-group" style="padding:16px 0;"><button class="ks-button" data-action="reset-settings">æ¢å¤é»˜è®¤è®¾ç½®</button></div></div></div>`; this.elements.settingsView.querySelector('#ks-theme-select').value = this.config.theme; this.elements.settingsView.querySelector('#ks-fab-size').value = this.config.fabSize; this.elements.settingsView.querySelector('#ks-collapse-delay').value = this.config.autoCollapseDelay; this.elements.settingsView.querySelector('#ks-debug-logging').checked = this.config.debugLogging; this.renderKeywordManager(); }
        renderKeywordManager() { const managerEl = this.elements.settingsView.querySelector('.ks-keyword-manager'); if (!managerEl) return; managerEl.innerHTML = `<h4>AI ç‰¹å¾è¯</h4><div class="input-group"><input type="text" id="ks-ai-keyword-input" placeholder="è¾“å…¥AIå¸¸ç”¨è¯..." class="ks-keyword-input"><button data-action="add-keyword" data-type="ai" class="ks-button">+</button></div><div id="ks-ai-keyword-list" class="ks-keyword-list"></div><h4 style="margin-top:16px;">ç”¨æˆ·ç‰¹å¾è¯</h4><div class="input-group"><input type="text" id="ks-user-keyword-input" placeholder="è¾“å…¥ç”¨æˆ·å¸¸ç”¨è¯..." class="ks-keyword-input"><button data-action="add-keyword" data-type="user" class="ks-button">+</button></div><div id="ks-user-keyword-list" class="ks-keyword-list"></div><p class="ks-tip">â€œè¯­å¢ƒå¼•æ“â€ç”¨äºåœ¨â€œç²¾å‡†å¯¼å‡ºâ€æ—¶æ™ºèƒ½è¯†åˆ«å¯¹è¯è§’è‰²ã€‚</p>`; const aiListEl = managerEl.querySelector('#ks-ai-keyword-list'); const userListEl = managerEl.querySelector('#ks-user-keyword-list'); aiListEl.innerHTML = ''; userListEl.innerHTML = ''; this.config.customKeywords.ai.forEach(kw => { const item = document.createElement('span'); item.className = 'ks-keyword-item'; item.textContent = kw; const delBtn = document.createElement('button'); delBtn.innerHTML = '&times;'; delBtn.dataset.action = 'delete-keyword'; delBtn.dataset.type = 'ai'; delBtn.dataset.keyword = kw; item.appendChild(delBtn); aiListEl.appendChild(item); }); this.config.customKeywords.user.forEach(kw => { const item = document.createElement('span'); item.className = 'ks-keyword-item'; item.textContent = kw; const delBtn = document.createElement('button'); delBtn.innerHTML = '&times;'; delBtn.dataset.action = 'delete-keyword'; delBtn.dataset.type = 'user'; delBtn.dataset.keyword = kw; item.appendChild(delBtn); userListEl.appendChild(item); }); }
        applyConfigStyles() { const s = document.documentElement.style; s.setProperty('--fab-size', `${this.config.fabSize}px`); const fab = this.elements.fab; fab.style.top = this.config.position.top || 'auto'; fab.style.right = this.config.position.right || 'auto'; fab.style.bottom = this.config.position.bottom || 'auto'; fab.style.left = this.config.position.left || 'auto'; }
        updateTheme() { document.body.dataset.keystoneTheme = this.config.theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : this.config.theme; }
        togglePanel(force) { const show = force !== undefined ? force : !STATE.isPanelVisible; if (show === STATE.isPanelVisible) return; STATE.isPanelVisible = show; this.elements.fab.classList.toggle('is-open', show); if (show) { const pos = this.calculateOptimalPanelPosition(); Object.assign(this.elements.panel.style, pos.panelStyles); this.elements.panel.style.transformOrigin = pos.transformOrigin; } requestAnimationFrame(() => this.elements.panel.classList.toggle('is-visible', show)); this.resetAutoCollapse(); if (!show && STATE.isSettingsVisible) this.toggleSettings(false); }
        calculateOptimalPanelPosition() { const fabRect = this.elements.fab.getBoundingClientRect(), panelW = 380, panelH = this.elements.panel.offsetHeight || 500, winW = window.innerWidth, winH = window.innerHeight, margin = 20; const fabCenter = { x: fabRect.left + fabRect.width / 2, y: fabRect.top + fabRect.height / 2 }; let idealPos = {}, origin = ''; if (fabCenter.x < winW / 2) { idealPos.left = fabRect.right + margin; origin += 'left '; } else { idealPos.left = fabRect.left - panelW - margin; origin += 'right '; } if (fabCenter.y < winH / 2) { idealPos.top = fabRect.top; origin += 'top'; } else { idealPos.top = fabRect.bottom - panelH; origin += 'bottom'; } if (idealPos.left < margin) idealPos.left = margin; if (idealPos.left + panelW > winW - margin) idealPos.left = winW - panelW - margin; if (idealPos.top < margin) idealPos.top = margin; if (idealPos.top + panelH > winH - margin) idealPos.top = winH - panelH - margin; return { panelStyles: { top: `${idealPos.top}px`, left: `${idealPos.left}px`, right: 'auto', bottom: 'auto' }, transformOrigin: origin.trim() }; }
        toggleSettings(force) { const show = force !== undefined ? force : !STATE.isSettingsVisible; if (show === STATE.isSettingsVisible) return; if (show) this.renderSettings(); STATE.isSettingsVisible = show; this.elements.mainView.style.display = show ? 'none' : 'block'; this.elements.settingsView.style.display = show ? 'block' : 'none'; const settingsBtn = this.elements.panel.querySelector('[data-action="toggle-settings"]'); if (settingsBtn) settingsBtn.classList.toggle('active', show); }
        resetAutoCollapse() { clearTimeout(STATE.autoCollapseTimer); if (STATE.isPanelVisible && this.config.autoCollapseDelay > 0) STATE.autoCollapseTimer = setTimeout(() => this.togglePanel(false), this.config.autoCollapseDelay * 1000); }
        bindEvents() { this.elements.fab.addEventListener('pointerdown', e => this.onFabPointerDown(e)); this.elements.panel.addEventListener('click', e => { const button = e.target.closest('[data-action]'); if (!button) return; const action = button.dataset.action; if (action === 'toggle-accordion') { const accordion = button.closest('.ks-accordion'); accordion.classList.toggle('is-open'); return; } e.stopPropagation(); switch (action) { case 'export-with-picker': this.enterPickerMode(); break; case 'parse-gemini-code': FEATURES.parseAndDownloadGeminiCode(); break; case 'toggle-settings': this.toggleSettings(); break; case 'reset-settings': this.resetSettings(); break; case 'add-thinking': FEATURES.injectToMainPrompt(); break; case 'send-continue': FEATURES.sendContinue(); break; case 'inject-system-prompt': FEATURES.injectSystemPrompt(); break; case 'check-status': window.open('https://aistudio.google.com/status', '_blank'); break; } this.resetAutoCollapse(); }); const settingsAndPanelHandler = e => { const button = e.target.closest('[data-action]'); if (!button) return; const action = button.dataset.action; if (action === 'add-keyword' || action === 'delete-keyword') { const type = button.dataset.type; const inputEl = this.elements.settingsView.querySelector(`#ks-${type}-keyword-input`); if (action === 'add-keyword') { const keyword = inputEl.value.trim(); if (keyword && !this.config.customKeywords[type].includes(keyword)) { this.config.customKeywords[type].push(keyword); CONFIG.save(this.config); this.renderKeywordManager(); } inputEl.value = ''; } else { const keyword = button.dataset.keyword; this.config.customKeywords[type] = this.config.customKeywords[type].filter(k => k !== keyword); CONFIG.save(this.config); this.renderKeywordManager(); } } }; this.elements.settingsView.addEventListener('click', settingsAndPanelHandler); this.elements.settingsView.addEventListener('change', e => { const target = e.target; let needsSave = true; switch (target.id) { case 'ks-theme-select': this.config.theme = target.value; this.updateTheme(); break; case 'ks-fab-size': this.config.fabSize = parseInt(target.value); this.applyConfigStyles(); break; case 'ks-collapse-delay': this.config.autoCollapseDelay = parseInt(target.value); break; case 'ks-debug-logging': this.config.debugLogging = target.checked; Logger.enabled = target.checked; this.notify(`è°ƒè¯•æ—¥å¿—å·²${target.checked ? 'å¼€å¯' : 'å…³é—­'}ã€‚`); break; default: needsSave = false; } if (needsSave) CONFIG.save(this.config); }); document.addEventListener('click', e => { if (STATE.isPanelVisible && !this.elements.panel.contains(e.target) && !this.elements.fab.contains(e.target)) this.togglePanel(false); }, true); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => this.updateTheme()); }
        resetSettings() { if (confirm("ç¡®å®šæ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿè¿™å°†é‡ç½®é¢æ¿ä½ç½®ã€ä¸»é¢˜å’Œæ‰€æœ‰æ¨¡å—çš„è®¾ç½®ã€‚")) { GM_deleteValue('keystone_config_v9.6'); this.config = CONFIG.load(); this.renderSettings(); this.applyConfigStyles(); this.updateTheme(); UTILS.notify("è®¾ç½®å·²æ¢å¤ä¸ºé»˜è®¤ã€‚"); location.reload(); } }
        onFabPointerDown(e) { e.preventDefault(); STATE.pointerDown = true; STATE.dragStart = { x: e.clientX, y: e.clientY }; const onMove = UTILS.throttle(e => { if (!STATE.pointerDown) return; const dx = e.clientX - STATE.dragStart.x, dy = e.clientY - STATE.dragStart.y; if (!STATE.isDragging && Math.sqrt(dx * dx + dy * dy) > this.config.dragThreshold) { STATE.isDragging = true; this.elements.fab.style.transition = 'none'; } if (STATE.isDragging) { this.elements.fab.style.left = `${e.clientX - this.config.fabSize / 2}px`; this.elements.fab.style.top = `${e.clientY - this.config.fabSize / 2}px`; this.elements.fab.style.right = 'auto'; this.elements.fab.style.bottom = 'auto'; } }, 16); const onUp = () => { if (STATE.isDragging) { this.elements.fab.style.transition = ''; const rect = this.elements.fab.getBoundingClientRect(); this.config.position = { left: `${rect.left}px`, top: `${rect.top}px`, right: 'auto', bottom: 'auto' }; CONFIG.save(this.config); this.applyConfigStyles(); } else { this.togglePanel(); } STATE.pointerDown = false; STATE.isDragging = false; document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); }; document.addEventListener('pointermove', onMove); document.addEventListener('pointerup', onUp); }
        enterPickerMode() { this.picker.start(selector => FEATURES.parseAndDownload(document.querySelector(selector), this.config)); }
        getModuleSettings(moduleId) { return this.config.modules?.[moduleId] || {}; }
        saveModuleSettings(moduleId, moduleSettings) { if (!this.config.modules) this.config.modules = {}; this.config.modules[moduleId] = moduleSettings; CONFIG.save(this.config); }
        notify(message, title) { UTILS.notify(message, title); }
    }

    // =========================================================================
    // åŒºåŸŸ 4: æœ€ç»ˆçš„å¯åŠ¨é€»è¾‘
    // =========================================================================
    function start() {
        const assistant = new Assistant();
        const hostname = window.location.hostname;

        assistant.registerModule(new FocusModeModule());
        assistant.registerModule(new StableCollapserModule());

        if (hostname.includes('aistudio.google.com')) {
            assistant.registerModule(new ImmersiveModeModule());
            assistant.registerModule(new FreezerModule());
        }

        assistant.init();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', start);
    } else {
        start();
    }

})();