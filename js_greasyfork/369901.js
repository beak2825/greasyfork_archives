// ==UserScript==
// @name            IGExt
// @description     IGExt user script
// @author          Provetic
// @namespace       provetic/igext
// @homepageURL     https://greasyfork.org/en/scripts/369901
// @originURL       https://bitbucket.org/snippets/provetic/9ezo9M/
// @icon            https://dl.dropbox.com/s/j3vuagrdc6yte8s/glarge96-min.png?dl=0
// @require         https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.js
// @require         https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js
// @require         https://cdn.jsdelivr.net/npm/flatpickr
// @include         /https?:\/\/www.instagram.com\//
// @include         /https?:\/\/www.instagram.com\/(.+)/
// @include         /https?:\/\/www.instagram.com\/explore\/tags/(.+)/
// @version         2.2
// @timestamp       1537539053731
// @grant           GM_log
// @grant           GM_getValue
// @grant           GM_setValue
// @grant           GM_deleteValue
// @run-at          document-end
// @downloadURL https://update.greasyfork.org/scripts/369901/IGExt.user.js
// @updateURL https://update.greasyfork.org/scripts/369901/IGExt.meta.js
// ==/UserScript==
(function(){function H(e){function y(a,c,d){if(a.match(/^https?:\/\/.+/))var b=B("link",{type:"text/css",rel:"stylesheet",href:a});else b=B("style",{type:"text/css"}),b.appendChild(document.createTextNode(a));m(c)&&"object"!=typeof c&&"function"!=typeof c&&b.setAttribute("id",c);if(m(d)&&d)document.body.insertBefore(b,document.body.firstChild);else{var g=document.getElementsByTagName("head");m(g[0])&&"HEAD"==g[0].nodeName?setTimeout(function(){g[0].appendChild(b)},100):document.body.insertBefore(b,
document.body.firstChild)}return b}function m(a){return!(null==a&&null!==a)}function h(a){return"string"==typeof a&&a?a.replace(/^\s+|\s+$/g,""):""}function c(b){if(!a.__DEBUG__)return!1;a.counter?a.counter++:a.counter=1;a.ApiUpgrade&&"number"!=typeof b&&"string"!=typeof b&&(b=JSON.stringify(b));if("function"==typeof GM_log){var c=-1!==["string","number"].indexOf(typeof b);GM_log("("+a.counter+") "+(c?b:"[OBJ]"));c||GM_log(b)}else console&&console.log&&console.log(b)}function B(a,c,d){a=document.createElement(a);
for(var b in c)c.hasOwnProperty(b)&&a.setAttribute(b,c[b]);d&&(a.innerHTML=d);return a}function z(a,c){var b,f=A[a];f&&setTimeout(function(){b=GM_getValue(a,f[0]);if(!b){b=I.getItem(a);var g=null;try{g=JSON.parse(b)}catch(r){}null!==g&&(b=g)}if("function"==typeof c)c(b);else if(c)c=b;else return b},0)}function w(a,e,d){var b=null,g="";A[a]&&setTimeout(function(){try{if(b=GM_setValue(a,e),g=e,"object"==typeof e&&(g=JSON.stringify(e)),I.setItem(a,g),"function"==typeof d)d(b);else if(d)d=b;else return b}catch(r){r&&
r.message&&c(r.message)}},0)}function C(a){a=new Date(a);var b={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"},c="";var f=a.getDate();9>f&&(f="0"+f);c+=f+"-";f=a.getMonth();"undefined"!=typeof b[f]&&(c+=b[f]+"-");f=a.getFullYear();return c+f}function D(a){a=new Date(a);var b="";var c=a.getHours();1==(c+"").length&&(c="0"+c);b+=c+":";c=a.getMinutes();1==(c+"").length&&(c="0"+c);return b+c}function E(){return location.pathname+location.search}function G(){var c=
e(a.root_selector+' [role="main"]');if(a.is_tags_page){c=c.find("article");var k=(k=c.find(">header"))&&k.length&&c&&c.length?!0:!1}else k=c.find("header"),c=c.find("article"),k=(k=k&&k.length&&c&&c.length?!0:!1)&&!c.find(">header").length;return k}function F(){a.stored={search:E(),bulk:[]};a.daterange_reached=!1;c("Reseting stored data.");w("KEY_SAVE_BULK","");w("KEY_SAVE_STATE","");w("KEY_SAVE_URL_SEARCH",E());if(a.is_child&&a.page_name){var b=(a.is_tags_page?"tags":"user")+"_"+a.page_name;a.stored["bulk_"+
b]=[];w("KEY_SAVE_BULK_"+b,"")}a.is_parent?z("KEY_SAVE_KEYS",function(a){c("[KEY_SAVE_KEYS]");c(a);if(a&&a.length){var b="";c("clearing dynamic storage..");for(var f=0,g=a.length;f<g;f++)b="KEY_SAVE_BULK_"+a[f],c("Emptying ["+b+"].."),w(b,""),f+1>=a.length&&setTimeout(function(){c("Emptying [KEYS]..");w("KEY_SAVE_KEYS","")},123)}c("[CLEARED]")}):c("[CLEARED]");I.clear()}function L(b){var e=E(),d="KEY_SAVE_BULK",f="bulk";a.stored={search:e,bulk:[]};a.is_child&&a.page_name&&(f="bulk_"+a.page_name,a.stored[f]=
[]);z("KEY_SAVE_URL_SEARCH",function(g){a.is_child||g==e||(F(),"function"==typeof b&&b(a.stored));g?(a.is_child&&(d+="_"+(a.is_tags_page?"tags":"user")+"_"+a.page_name),z(d,function(c){if(c){try{c=JSON.parse(c)}catch(t){}a.stored[f]=c}"function"==typeof b&&b(a.stored)})):(c("everything blank.."),F(),"function"==typeof b&&b(a.stored))})}function u(b){var k=e(".wrap_prv_scraper").first().find("#status-done"),d=e("#btn-startscrap"),f="";if(-1===["Ready","Running","Done"].indexOf(b))return!1;f=b.toUpperCase();
a.status=f;d.find(".fa").removeClass("fa-play fa-stop fa-spin");d.data("mode","play").find(".inner").text("Start");switch(b){case "Running":k.attr("title","Running");d.data("mode","stop").find(".fa").addClass("fa-stop fa-spin");d.find(".inner").text("STOP");break;case "Ready":case "Done":if(d.find(".fa").addClass("fa-play"),"Ready"==b)k.attr("title","Not running");else{k.attr("title","Done");c("DONE, scr-bulk visibility="+e(".scr-bulk").is(":visible"));if(e(".scr-bulk").is(":visible")){d=e(".scr-bulk").data("mode");
var g=null;g=e(".mnu-"+d);g.length&&g.trigger("click")}a.is_child&&(c("Signal for parent reading, child is done."),w("KEY_SAVE_STATE_"+((a.is_tags_page?"tags":"user")+"_"+a.page_name),1))}}c("[STATUS]: "+b);k.text(f).data("status",b).attr("data-status",b);(function(c){var b=e("title"),f="",g=null,d=b.attr("data-original");if(!d)return!1;b.text(d);if(a.is_tags_page){if(g=/#(\w+)/.exec(d))f="#"+g[1]}else if(g=/@(\w+)/.exec(d))f="@"+g[1];-1!==["RUNNING","DONE"].indexOf(c)&&b.text("["+c.substr(0,1)+"] "+
d);"DONE"!=c||document.hasFocus()||b.data("alerted")||(setTimeout(function(){!a.is_child&&e(window).hasClass("inactive")&&alert("Scraping "+f+" selesai...")},154),b.data("alerted",!0))})(f)}function H(){var b=e(window).height(),k=e("title"),d=function(){};d="";y('body.isparent{overflow:hidden;}body.isparent #react-root{opacity: .21;}[role="main"]>div, .tagspage [role="main"]>article{margin-right: 0}.wrap_prv_scraper{border:1px solid #ddd; position: fixed; z-index:1000; left:0; top:50px; width: 300px; padding:5px 0; background-color: #fff; font-size: 12px; padding-right: 4px;}[role="main"] article .done{border: 1px solid red}.scr-bulk{min-height: '+
(b-80)+"px;}.scr-bulk h5{font-weight: bold; color: #555;}.scr-bulk .bulk{margin-top: 5px;}.scr-bulk textarea{font-family:monospace; font-size:10px; width: 100%; min-width: 100%; max-width: 100%; line-height: 1.2em; color: #444; padding: 4px 0!important;}.scr-bulk textarea[readonly]{cursor:default!important;}.scr-inner{position: relative;}.scr-inner>h5{color: #666; padding:0 5px; margin: -5px; padding-bottom: 6px;}.param-date .inner{display: inline-block; width: 40px;}.wrap-action{position: absolute; right: 5px; top: -3px;}.wrap-action .dropdown{display:inline-block; position: relative; z-index:3;}.dropdown ul{display: none; position: absolute; left:0; top: 24px; z-index:5; background-color: #fff; border: 1px solid #ccc; margin-top: -1px;}.wrap-action .dropdown.pull-right ul{left:initial; right: 0;}.dropdown:hover ul{display: block; width: 80px;}.dropdown ul li a{padding: 2px 5px; display: block;}.dropdown ul>li{width: 100%; display: inline-block;}.dropdown ul>li.separator{display: block; height: 1px; border-top: 1px solid #ddd; margin-top: 2px;}.dropdown ul li a:hover{background-color: #eee;}.wrap-action>a{margin-left:2px;}.wrap-action>a.btn-menu{position: relative;}.status{margin-left: 4px;}.inline-clear{position: absolute; display: inline-block; right: 2px; top: 5px;}.inline-clear .btn{font-size: 12px; padding: 0 5px;}.wrap_prv_scraper code{font-family: monospace; font-size: 11px;}.wrap_prv_scraper code.bignum{font-size:14px;}.wrap_prv_scraper code.smallnum{font-size:9px;}.vnum{display: inline-block; color: #003569;}.vnum sub{font-weight: normal; margin-left: 1px; color: #285a8a; font-size: 11px;}.hlight{color: #882222;}.hide{display:none}.pull-right{float:right}.wrap-filterdate {position:relative; padding: 4px 0 8px; background-color: #eee;}.wrap-filterdate .btn{position:absolute; top: 4px; font-size: 12px;}.wrap-filterdate .btn-clear{right: 42px;}.wrap-filterdate .btn-apply{right: 0;}.bulk-account textarea{height: 45px}.bulk-feedlog{}.bulk-feedlog.ninja{position:absolute; left: -99999px;}.bulk-feedlog textarea{height: 90px; white-space: pre; overflow-wrap: normal; overflow-x: scroll;}.bulk-feedlog h5>span{display: inline-block; margin-left: 5px; font-weight: normal; font-size: 11px;}.btn{display: inline-block; padding: 2px 5px;  border: 1px solid transparent; cursor: pointer;}.btn[disabled]{cursor: not-allowed; pointer-events: none; filter: alpha(opacity=65); -webkit-box-shadow: none; box-shadow: none; opacity: .65;}.btn:hover{color: #333; background-color: #e6e6e6; border-color: #adadad;}.btn-default{color: #333; background-color: #fff; border-color: #ccc;}.btn-sm{line-height: 1; padding: 2px 4px; font-size: 12px;}.btn-primary{color: #fff; background-color: #337ab7; border-color: #2e6da4;}.btn-primary:hover{color: #fff; background-color: #286090; border-color: #204d74;}.flatpickr-input{font-size: 12px; font-family: monospace; letter-spacing: -.0362em; word-spacing: -.15em;}.flatpickr-weekdays .flatpickr-weekdaycontainer{width: 100%; flex-direction: unset;}.dayContainer, .flatpickr-time, .flatpickr-time .numInputWrapper{flex-direction: unset;}",
"ig-uscraper-css");y("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css");y("https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css");k.attr("data-original",k.text());d='<div class="wrap_prv_scraper"><div class="scr-inner"><h5><code id="total-num" title="Total stored items" class="hlight bignum">0</code> post.<span class="status" title="Fetching status"><code id="status-done" class="hlight" title="Not running">READY</code></span></h5><span class="wrap-action">'+
(a.is_parent?"":'<a href="javascript:;" id="btn-startscrap" title="Start fetch" class="btn btn-primary btn-act" data-mode="play"><i class="fa fa-play" aria-hidden="true"></i> <span class="inner">Start</span></a>')+'<div class="dropdown'+(a.is_parent?" pull-right":"")+'"><a href="javascript:;" class="btn btn-default btn-act btn-menu"><i class="fa fa-ellipsis-v" aria-hidden="true"></i> <i class="fa fa-caret-down" aria-hidden="true"></i></a><ul><li><a href="javascript:;" id="mnu_getjson" class="mnu-json" data-format="json" title="Get data CSV formated"><i class="fa fa-download"></i>&nbsp;JSON</a></li><li><a href="javascript:;" id="mnu_getcsv" class="mnu-csv" data-format="csv" title="Get data CSV formated"><i class="fa fa-download"></i>&nbsp;CSV</a></li><li class=separator></li><li><a href="javascript:;" id="btn-clearscrap" title="Clear Stored data" class="btn btn-default btn-act"><i class="fa fa-trash-o" aria-hidden="true"></i>&nbsp;Clear</a></li></ul></div>'+
(a.is_parent?"":'<a href="javascript:;" id="btn-togglescrap" title="Toggle" class="btn btn-default btn-act"><i class="fa fa-toggle-off" aria-hidden="true"></i></a>')+"</span></div>";d=a.is_parent?d+'<div class="scr-bulk"><label for="bulk_parentinput">Insert IG link, multiple separated by line</label><textarea id="bulk_parentinput" class="scr-output code" rows=5></textarea><button type="button" class="btn btn-primary btn-submit_bulk">GO</button><hr/><label for="bulk_parentresult"><strong>Result</strong></label><textarea id="bulk_parentresult" class="scr-output-result code" rows=10 readonly placeholder="Your bulk result will be stored here"></textarea></div>':
d+('<div class="scr-bulk" style="display: none" data-mode="json"><div class="bulk bulk-account"><h5>Account <div class="vnum pull-right">'+function(){var c=a.version.timestamp;return'<a title="Instagram User Scrapper Userscript (private)" href="https://bitbucket.org/snippets/provetic/9ezo9M/instagram-user-scrapper-userscript" target="_blank">v'+a.version.number+"<sub>b"+(""+c).substr(Math.floor((""+c).length/2))+"</sub></a>"}()+'</div></h5><textarea id="bulk_account" class="scr-output" readonly></textarea></div><div class="bulk bulk-feed"><h5>Feeds <a href="javascript:;" id="btn-filterdate" class="pull-right">Filter Date</a></h5><div class="wrap-filterdate hide"><input class=flatpickr type="text" placeholder="Select Date.." data-id="datetime" />'+
(a.hasDaterange?'<button type="button" class="btn btn-default btn-clear btn-clearfilter" title="Clear date-range filter from URL">Clear</button>':"")+'<button type="button" id="btn-applydate" class="btn btn-primary btn-apply" title="Apply date-range to URL">Apply</button></div>'+function(){var c="";a.hasDaterange&&(c+='<div class="params">');if(a.SINCE_ts){var b=1E3*parseInt(a.SINCE_ts);c+='<code class="param-date"> <span class="inner">Start:</span> <span class="hlight">'+C(b)+" "+D(b)+"</span></code>"}else a.hasDaterange&&
(c+='<code class="param-date"> <span class="inner">Start:</span> &lt;first-post-creation&gt;</code>');a.UNTIL_ts?(b=1E3*parseInt(a.UNTIL_ts),c+='<code class="param-date"> <span class="inner">End:</span> <span class="hlight">'+C(b)+" "+D(b)+"</span></code>"):a.hasDaterange&&(b=(new Date).getTime(),c+='<code class="param-date"> <span class="inner">End:</span> <span class="hlight">'+C(b)+" "+D(b)+"</span> <strong>(Now)</strong></code>");a.hasDaterange&&(c+='<div class="inline-clear"><button type="button" class="btn btn-default btn-clearfilter" title="Clear date-range filter from URL">Clear filter</button></div></div>');
return c}()+'<textarea id="bulk_feed" class="scr-output" readonly></textarea></div><div class="bulk bulk-feedlog'+(a.feedlog_show?"":" ninja")+'"><h5>FeedLog <span title="Timestamp last update">ts: <code id="ts_update" class="ts-update smallnum">0</code></span><span title="Number of row">rows: <code id="row_total" class="row-total smallnum">0</code></span><button type="button" class="btn btn-default btn-sm pull-right btn-clearfeedlog" title="Clear feedlog">clear</button></h5><textarea id="bulk_feedlog" class="scr-output" onclick="return selectMe(this)" readonly></textarea></div></div></div>');
e("body").append(d);e("#btn-filterdate").click(function(a){var c=e(this).closest(".bulk");a=c.find(".wrap-filterdate");var b=c.find(".params");c=a.find(".flatpickr");var f=e("#btn-startscrap"),d=a.hasClass("hide");a[(d?"remove":"add")+"Class"]("hide");b[(d?"add":"remove")+"Class"]("hide");a.hasClass("hide")?f.removeAttr("disabled"):f.attr("disabled","disabled");c.hasClass("flatpickr-input")||(a={mode:"range",dateFormat:"Y-m-d",time_24hr:!0},c.flatpickr(a))});e(".btn-clearfilter").each(function(){e(this).click(function(b){b=
location.protocol+"//"+location.hostname+location.pathname;var f=location.search;f=/&?\bstart=/.test(f)||/&?\bend=/.test(f);c("is_has_daterange="+f);f?(a.feedlog_show&&(b+="?showlog=true"),top.location.href=b+"#clear"):(F(),u("Ready"));return!1})});e(".btn-clearfeedlog").click(function(a){e(this).closest(".bulk").find("textarea").val("");e("#row_total, #ts_update").text(0)});e("#btn-applydate").click(function(b){var f=e(this).closest(".wrap-filterdate").find(".flatpickr");b=location.protocol+"//"+
location.hostname+location.pathname;var d=f.val();if(!d)return c("Empty daterange"),!1;d=d.split(" to ");d[0]=h(d[0])+" 00:00:00";d[1]=h(d[1])+" 23:59:59";f=(new Date(d[0])).getTime();d=(new Date(d[1])).getTime();b=b+"?"+("start="+f/1E3)+("&end="+d/1E3);a.feedlog_show&&(b+="&showlog=true");f=location.href==b;top.location.href=b+"#start";f&&location.reload();return!1});e("#btn-togglescrap").click(function(a){a.preventDefault();a=e(this);var c=e(".wrap-filterdate"),b=e("#btn-filterdate"),f=a.closest(".wrap_prv_scraper").find(".scr-bulk");
a.find(".fa").removeClass("fa-toggle-off fa-toggle-on");f.is(":visible")?(c.hasClass("hide")||b.trigger("click"),f.hide(),a.find(".fa").addClass("fa-toggle-off")):(f.show(),a.find(".fa").addClass("fa-toggle-on"))});e("#btn-startscrap").click(function(b){b.preventDefault();if("stop"==e(this).data("mode")){c("Stoping cuyy..");if(a.xhrFeeds){try{a.xhrFeeds.ajaxStop()}catch(g){}a.halted=!0}u("Ready");return!1}a.halted=!1;e("#btn-clearscrap").trigger("click");e("html,body").animate({scrollTop:0},0,function(){});
L(function(b){c("Stored data fetched, yihaa..");c(b);c("Start parsing...");a.tick_start=new Date;c("Tick start: "+a.tick_start.getTime()+"; date: "+a.tick_start);u("Running");e("title").data("alerted",!1);R()})});e("#btn-clearscrap").click(function(a){a.preventDefault();F();u("Ready");e("#total-num, #row_total, #ts_update").text(0);e(".scr-bulk textarea").val("");e(".scr-bulk").is(":visible")&&e("#btn-togglescrap").trigger("click")});e(".mnu-json, .mnu-csv").each(function(){e(this).click(function(b){b.preventDefault();
var f=e(this);b=function(){};var d=function(){};b=function(){var b=f.data("format"),d=f.closest(".wrap_prv_scraper"),g=d.find("#btn-togglescrap"),k=d.find(".scr-bulk"),h=k.find("#bulk_account"),r=k.find("#bulk_feed"),q=function(){},v=function(){};b&&k.attr("data-mode",b);k.find("textarea").val("");v=function(){e(window).height();k.show();g.find(".fa").removeClass("fa-toggle-off fa-toggle-on").addClass("fa-toggle-on");e(window).trigger("resize")};q=function(a,b){c("inside handleCSV..");c(a);c(b);var f=
Object.keys(b[0]),e=function(a,c){return null===c?"":c},d=b.map(function(a){return f.map(function(c){return/^\d+$/.test(a[c])?'"'+a[c]+'"':JSON.stringify(a[c],e)}).join(",")});d.unshift(f.join(","));r.val(d.join("\r\n"));f=Object.keys(a);d=[a].map(function(a){return f.map(function(c){return JSON.stringify(a[c],e)}).join(",")});d.unshift(f.join(","));h.val(d.join("\r\n"));v()};z("KEY_SAVE_URL_SEARCH",function(f){var d="KEY_SAVE_BULK";if(a.is_child)a.page_name&&(d+="_"+(a.is_tags_page?"tags":"user")+
"_"+a.page_name);else if(f&&f!=E())return c("Stored BULK data changed, exiting"),alert("Stored BULK data changed, another script may overwrite it. Please run the script one by one"),e("#total-num").text(0),u("Ready"),!1;c("[save data using key]: "+d);z(d,function(f){var d={},e=a.stored[a.is_tags_page?"tags":"profile"];if(!f)return c("Blank BULK data"),!1;c("BULK-Length: "+f.length);try{f=JSON.parse(f)}catch(S){}c(f);e||(c("Fetching profile by shareddata.."),e=N());if("csv"==b)return q(e,f);e&&h.replaceWith('<textarea id="bulk_account" class="scr-output" readonly onclick="return selectMe(this)">'+
JSON.stringify(e)+"</textarea>");d.total_post=f.length;a.hasDaterange&&(d.params={},a.SINCE_ts&&(d.params.start=a.SINCE_ts),a.UNTIL_ts&&(d.params.end=a.UNTIL_ts));d.feeds=f;r.replaceWith('<textarea id="bulk_feed" class="scr-output" readonly onclick="return selectMe(this)">'+JSON.stringify(d)+"</textarea>");v()})})};d=function(){c("Inside parentHandler..");var b=f.data("format"),d=f.closest(".wrap_prv_scraper").find(".scr-bulk"),e=d.find("#bulk_parentresult");d.find("#bulk_parentaccount");d=a.screen_keys;
var g=[],k=function(){},h=function(){};k=function(a){c("inside handleCSV..");c(a);var b=Object.keys(a[0]),d=function(a,c){return null===c?"":c};a=a.map(function(a){return b.map(function(c){return/^\d+$/.test(a[c])?'"'+a[c]+'"':JSON.stringify(a[c],d)}).join(",")});a.unshift(b.join(","));e.val(a.join("\r\n"))};h=function(a){e.val(JSON.stringify(a))};if(!d||!d.length)return!1;for(var r={},v=0,m=d.length;v<m;r={is_lastitem:r.is_lastitem},v++){var M="KEY_SAVE_BULK_"+d[v];r.is_lastitem=v+1>=d.length;z(M,
function(a){return function(d){var f=null;if(d&&d.length){if("string"==typeof d){try{f=JSON.parse(d)}catch(S){}f&&(d=f)}d instanceof Array&&(g=g.concat(d))}a.is_lastitem&&(c("ALL DONE.."),c(g),"json"==b?h(g):k(g))}}(r))}};a.is_parent?d():b()})});e(".btn-submit_bulk").click(function(){var b=e(this),d=b.closest(".scr-bulk").find("textarea").val(),k=/instagram.com/,h=[],p=[],m=function(){};b.text("Processing..").prop("disabled",!0);m=function(a){var c=document.createElement("a"),b={};var d="href protocol port pathname search hash hostname host".split(" ");
c.setAttribute("href",a);for(var e=0,f=d.length;e<f;e++)a=d[e],"undefined"!=typeof c[a]&&(b[a]=c[a]);return b};d&&(h=d.split("\n"));if(h.length){d=0;for(var l=h.length;d<l;d++)(b=h[d].trim())&&k.test(b)&&(-1===b.indexOf("?")&&(b+="?"),/&?parent=true\b/.test(b)&&(b=b.replace(/&?parent=true/,"")),/&?child=true\b/.test(b)||(b+="&child=true"),/&?start=true\b/.test(b)||(b+="&start=true"),p.push(b))}c(h);c(p);if(p&&p.length){var x=[],n=[],q=function(){};a.stIChildWatch=null;q=function(b){var d=function(d){var f=
0,g=[];d={};for(var k=0,h=b.length;k<h;d={ks_bulk:d.ks_bulk,key:d.key},k++){d.key=b[k];d.ks_bulk="KEY_SAVE_BULK_"+d.key;var r="KEY_SAVE_STATE_"+d.key;z(d.ks_bulk,function(a){return function(b){var d=null;c("key: "+a.ks_bulk+"; data.length:"+(b&&b.length?b.length:0));if(b&&b.length&&"string"==typeof b){try{d=JSON.parse(b)}catch(V){}d&&(f+=d.length,e("#total-num").text(f))}}}(d));z(r,function(d){return function(k){1==k&&-1===g.indexOf(d.key)&&(g.push(d.key),g.length>=b.length&&(u("Done"),a.stIChildWatch&&
clearInterval(a.stIChildWatch),c("All Done..."),e("#total-num").text(f),e("#mnu_getjson").trigger("click"),e(".btn-submit_bulk").text("GO").prop("disabled",!1)))}}(d))}};a.stIChildWatch=setInterval(function(){d(b)},1E3)};a.stIChildWatch&&clearInterval(a.stIChildWatch);u("Running");z("KEY_SAVE_KEYS",function(b){b&&b.length&&(x=b);c(x);b=0;for(var d=p.length;b<d;b++)(function(b){var d=null,f="",k=m(p[b]);if(d=/\/explore\/tags\/([^\/]+)/.exec(k.pathname))f="tags_"+d[1];else if(d=/\/([^\/]+)/.exec(k.pathname))f=
"user_"+d[1];-1!=x.indexOf(f)&&x.push(f);n.push(f);w("KEY_SAVE_KEYS",x);A["KEY_SAVE_BULK_"+f]=[""];A["KEY_SAVE_STATE_"+f]=[""];w("KEY_SAVE_BULK_"+f,"");w("KEY_SAVE_STATE_"+f,"0");setTimeout(function(){c("opening="+p[b]);var d=p[b];"undefined"!=typeof e?e("<a>").attr("href",d).attr("target","_blank").get(0).click():window.open(d,"_blank");b+1>=p.length&&(a.screen_keys=n,q(n))},456)})(b)})}});d=function(a){a.select();return!1};window.selectMe=d;unsafeWindow.selectMe=d;e(window).on("resize",function(){var b=
e(window).height(),c=45,d=e(".scr-bulk"),k=d.find("#bulk_feed");a.feedlog_show&&(c=180);c+=a.hasDaterange?36:0;var h=c+d.find("#bulk_account").height();a.feedlog_show&&(h+=d.find("#bulk_feedlog").height());d.css("min-height",b-(c-80)+"px");k.css("min-height",b-h+"px").css("height",b-h+"px")});e(window).on("blur",function(){e(this).addClass("inactive")}).on("focus",function(){e(this).removeClass("inactive")})}function O(b,k){var d=e(a.root_selector+' [role="main"]>div>article'),f=null,g=null,h=[],
t=[];if(a.halted)return c("Interrupted by user, progress halted"),u("Ready"),!1;b.count&&(g=a.stored.profile||{},g.total_posts=b.count,a.stored.profile=g);b.edges&&(h=b.edges);if(!h||!h.length)return c("Empty feeds, exiting"),!1;c("edges.length="+h.length);for(var p=0,m=h.length;p<m;p++){var l=h[p],x="",n=null,q=0;n={};l.node&&(l=l.node);if(l){q=parseInt(l.taken_at_timestamp);if(a.hasDaterange)if(a.SINCE_ts&&q<a.SINCE_ts){c("[Daterange Reached]");c("[START]: "+a.SINCE_ts+"; date: "+new Date(1E3*a.SINCE_ts));
c("Item(current)-ts: "+q+"; Date: "+new Date(1E3*q)+"; Shortcode: "+l.shortcode);a.daterange_reached=!0;break}else if(a.UNTIL_ts&&q>a.UNTIL_ts){c("next..");continue}n={id:l.id+"",created_at:q,shortcode:l.shortcode,total_comment:l.edge_media_to_comment&&l.edge_media_to_comment.count?l.edge_media_to_comment.count:0,total_like:l.edge_liked_by&&l.edge_liked_by.count?l.edge_liked_by.count:0,item_url:"https://www.instagram.com/p/"+l.shortcode+"/"+(g&&g.fromuser?"?taken-by="+g.fromuser:""),image_url:l.display_url,
image_url_thumbnail:l.thumbnail_src,is_video:l.is_video?1:0};n.is_video&&(l.video_url&&(n.video_url=l.video_url),n.video_view_count=l.video_view_count);l.edge_media_preview_like&&l.edge_media_preview_like.count&&(n.total_like=l.edge_media_preview_like.count);a.is_tags_page&&l.owner&&l.owner.id&&(n.owner_id=l.owner.id);n.created_at_gmt=new Date(1E3*q);n.created_at_local_dmy=C(1E3*q)+", "+D(1E3*q);if(l.edge_media_to_caption&&l.edge_media_to_caption.edges){f=0;for(q=l.edge_media_to_caption.edges.length;f<
q;f++){var v=l.edge_media_to_caption.edges[f];v.node&&v.node.text&&(x+=v.node.text+" ")}x=(x+"").trim()}n.caption=x;f=n;n[a.is_tags_page?"hashtag":"author_username"]=a.page_name;(function(b){var d=e("#bulk_feedlog"),f,k=a.feedlog_maxrow,g=d.val();if(g=(g+"").trim())g=g.split("\n");else if(g=[],f=a.stored.profile||null)f=['"DATA_USER"',JSON.stringify(f)],g.push("["+String(f)+"]");f=['"DATA_POST"',JSON.stringify(b)];g.push("["+String(f)+"]");g.length>k&&(c("Reach maxrow treshold; splicing.."),g.splice(0,
g.length-k));d.val(g.join("\n"))})(n);t.push(n);n=d.find('a[href*="/'+l.shortcode+'/"]');n.length&&n.addClass("fetched").parent().addClass("done")}else c("Missing node")}(function(a){a=e("#bulk_feedlog");var b=a.val(),c=e(".wrap_prv_scraper .scr-bulk"),d=e("#ts_update"),f=e("#row_total"),k=a.get(0);c.is(":visible")&&setTimeout(function(){k.scrollTop=k.scrollHeight},0);d.text((new Date).getTime());b&&(b=(b=b.trim())?b.split("\n"):[]);f.text(b.length)})();f&&c("Last item to save: "+f.created_at+"; Date: "+
new Date(1E3*f.created_at)+"; Shortcode: "+f.shortcode);if(t&&0<t.length){c(t);d=a.stored.bulk;g=e("#total-num");var B=t.length;h=null;p=[];if(d)try{d=JSON.parse(d)}catch(M){}d||(d=[]);p=d.concat(t);g.text(p.length);a.stored.bulk=p;p=JSON.stringify(p);h="KEY_SAVE_BULK";a.is_child&&a.page_name&&(h+="_"+(a.is_tags_page?"tags":"user")+"_"+a.page_name);c("[save data using key]: "+h);w(h,p,function(){c("["+B+"] NEW BULK saved..")});"function"==typeof k&&k(t)}else c("NO New BULK saved"),a.hasDaterange&&
"function"==typeof k&&k(t)}function N(){c("collecting user-profile based on sharedData");J();var b=P(),e=a.is_tags_page;if(!b)return!1;var d=(new Date).getTime(),f=e?b.edge_hashtag_to_media:b.edge_owner_to_timeline_media,g={};e?(g.name=b.name,g.profile_pic_url=b.profile_pic_url,a.stored.tags=g):(g={fromuser:"",fromname:"",fromavatar:"",fromavatar_hd:"",fromuser_id:"",total_followers:0,total_following:0,total_posts:0,is_verified:!1,is_private:!1,datetaken:C(d)+", "+D(d)},g.total_followers=b.edge_followed_by&&
b.edge_followed_by.count?b.edge_followed_by.count:0,g.total_following=b.edge_followed_by&&b.edge_follow.count?b.edge_follow.count:0,g.total_posts=f&&f.count?f.count:0,b.full_name&&(g.fromname=b.full_name),b.username&&(g.fromuser=b.username),b.profile_pic_url&&(g.fromavatar=b.profile_pic_url),b.profile_pic_url_hd&&(g.fromavatar_hd=b.profile_pic_url_hd),b.id&&(g.fromuser_id=b.id+""),b.is_verified&&(g.is_verified=b.is_verified),b.is_private&&(g.is_private=b.is_private),a.stored.profile=g);return g}function J(b){var e=
null;"undefined"==typeof b&&(b=!0);b&&a._sharedData&&(e=a._sharedData);return e||(window._sharedData&&(e=window._sharedData),!e&&unsafeWindow&&unsafeWindow._sharedData&&(e=unsafeWindow._sharedData),e)?e:(c("Missing _sharedData, exiting"),!1)}function P(){var b,c=null;a._sharedData||(a._sharedData=J());if(!a._sharedData)return!1;(b=a._sharedData)&&b.entry_data&&(b=b.entry_data,(b=a.is_tags_page?b.TagPage:b.ProfilePage)&&b.length&&(b=b[0]),b&&b.graphql&&(b=b.graphql),b&&(a.is_tags_page&&b.hashtag?b=
b.hashtag:b.user&&(b=b.user)),c=b);return c}function R(){c("[PARSER Inside]");c("last-bulk-count="+(a.stored.bulk&&a.stored.bulk.length?a.stored.bulk.length:0));var b=J(!1),e=null,d=null,f={is_private:!1};f=null;a._sharedData=b;if(!b)return!1;f=a.is_tags_page?b.entry_data&&b.entry_data.TagPage:b.entry_data&&b.entry_data.ProfilePage;if(!f)return c("Missing _sharedData.entry_data."+(a.is_tags_page?"TagPage":"ProfilePage")),!1;e=P();if(!e)return!1;f=N();if(f.is_private)return c("User is private, exiting.."),
!1;(d=a.is_tags_page?e.edge_hashtag_to_media:e.edge_owner_to_timeline_media)&&O(d,function(){d.page_info&&d.page_info.has_next_page&&(a.daterange_reached?(c("[Daterange reached] from page_parser."),"DONE"!=a.status&&u("Done")):setTimeout(function(){Q(e)},1200))})}function Q(b){c("XHR-ing..");var k=a.is_tags_page,d=a._sharedData,f=a.stored[k?"tags":"profile"];b=k?b.edge_hashtag_to_media:b.edge_owner_to_timeline_media;var g="";g=b.page_info&&b.page_info.end_cursor?b.page_info.end_cursor:"";var h={},
m={};b="";f&&(k&&f.name?h={tag_name:f.name,first:2,after:g}:f.fromuser_id&&(h={id:f.fromuser_id,first:12,after:g}));h=JSON.stringify(h);c("computing signature of ("+(d.rhx_gis+":"+h)+")");b=md5(d.rhx_gis+":"+h);c("signature="+b);m={query_hash:k?"ded47faa9a1aaded10161a2ff32abb6b":"df16f80848b2de5a3ca9495d781f98df",variables:h};c(m);g="https://www.instagram.com/graphql/query/?"+e.param(m);a.xhrFeeds=e.ajax({url:g,method:"GET",dataType:"json",headers:{Accept:"*/*","X-Instagram-GIS":b},cache:!0}).done(function(b){c(b);
if(!b||!b.data)return c("Empty data respond"),!1;var d=null,e=null;a.is_tags_page&&b.data.hashtag?d=b.data.hashtag:b.data.user&&(d=b.data.user);d&&(a.is_tags_page&&d.edge_hashtag_to_media?e=d.edge_hashtag_to_media:d.edge_owner_to_timeline_media&&(e=d.edge_owner_to_timeline_media));if(!e)return c("Empty timeline data feed"),!1;O(e,function(b){e.page_info&&e.page_info.has_next_page?a.daterange_reached?"DONE"!=a.status&&(c("[Daterange Reached]..."),u("Done")):setTimeout(function(){Q(d)},1200):(c("No more next page."),
"DONE"!=a.status&&u("Done"))});a.daterange_reached&&(c("[Daterange Reached]; Eof, exiting.."),"DONE"!=a.status&&u("Done"));"DONE"==a.status&&setTimeout(function(){var b=0,d=((new Date).getTime()-a.tick_start)/1E3;60<d&&(b=(d/60).toFixed(2));d=parseFloat(d.toFixed(2));c("[DONE] Elapsed time: "+(b?b+" minute"+(1<b?"s":""):"")+(d?d+" second"+(1<d?"s":""):""))},456)}).fail(function(){c("XHR: error")}).always(function(){})}function K(){c("Initialize...");if(a.observer){c("Disconnecting observer..");try{a.observer.disconnect()}catch(k){}}var b=
e(a.root_selector);if(e(".error-container").length)return c("Page contain error, exiting.."),!1;if(!b.length)return c("Not profile page; Missing element "+a.root_selector+". Exiting.."),!1;if(-1!==b.find("article h2").text().indexOf("is Private"))return c("Account is private; Exiting.."),!1;if(!G()&&!a.is_parent)return c("Not profile page; Unknown structure. Exiting.."),!1;e("html,body").animate({scrollTop:0},0,function(){});(function(b){var d;if(d=/&?\bstart=(\d+)/.exec(b))a.SINCE_ts=parseInt(d[1]),
c("Range[start]: "+a.SINCE_ts);if(d=/&?\bend=(\d+)/.exec(b))a.UNTIL_ts=parseInt(d[1]),c("Range[end]: "+a.UNTIL_ts);a.hasDaterange=a.SINCE_ts||a.UNTIL_ts;/&?\bforceclear=([^&]+)/.exec(b)&&(c("Forced to clear stored data.."),F());(d=/&?\bfeedmaxrow=([^&]]+)/.exec(b))&&!isNaN(d[1])&&0<d[1]&&(a.feedlog_maxrow=parseInt(d[1]))})(location.search);T(a);c("Designing...");H();setTimeout(function(){L(function(b){c("Stored data fetched:");c(b);var d=null;a.hasDaterange&&(a.SINCE_ts&&c("[START]: "+a.SINCE_ts+
"; date: "+new Date(1E3*a.SINCE_ts)),a.UNTIL_ts&&c("[END]: "+a.UNTIL_ts+"; date: "+new Date(1E3*a.UNTIL_ts)));b.search&&b.search==E()&&(a.is_child||a.is_parent||b.bulk&&e("#total-num").text(parseInt(b.bulk.length)));if(location.hash){switch(location.hash){case "#start":d=e("#btn-startscrap");break;case "#clear":d=e("#btn-clearscrap");break;default:c("Unknown hash")}if(-1!==["#start","#clear"].indexOf(location.hash)){c("Hash detected: "+location.hash);d.length&&d.trigger("click");try{location.hash=
""}catch(f){}}}else{if(a.is_autostart=/&?\bstart=true\b/.test(location.search))d=e("#btn-startscrap");else if(a.is_autoclear=/&?\bclear=true\b/.test(location.search))d=e("#btn-clearscrap");if(d&&d.length){c("Hash detected: "+location.hash);d.length&&d.trigger("click");try{history.replaceState(null,null," ")}catch(f){}}}})},100)}function U(b,h){c("Observing dom change..");var d=new (window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver)(function(a){var b={};try{a.forEach(function(a){"function"==
typeof h.callback&&h.callback(a.target)})}catch(t){if(t!==b)throw t;}}),f=e.extend({attributes:!0,childList:!0,characterData:!0},h.config);d.observe(b,f);a.observer=d}var a=function(){};a.__DEBUG__=1;a.version={number:"2.2",timestamp:"1537539053731"};a.SINCE_ts=0;a.UNTIL_ts=0;a.stored={};a.status="READY";a.daterange_reached=null;a.tick_start=null;a.halted=null;a.is_parent=null;a.feedlog_show=null;a.feedlog_maxrow=200;a.is_tags_page=!1;a.page_name="";a.observed=!1;a.observe_timeout=5;a.screen_keys=
[];a.root_selector="#react-root";var A={KEY_SAVE_URL_SEARCH:[""],KEY_SAVE_STATE:[""],KEY_SAVE_BULK:[""],KEY_SAVE_KEYS:[""]},I=window.localStorage;(function(){c("IG-UserScrap v"+a.version.number+" build."+a.version.timestamp);var b=e(a.root_selector),h="/"===location.pathname,d={config:{attributes:!1,childList:!0,subtree:!0,characterData:!1},callback:function(b){if(a.observed)return!1;G()&&(c("[OK] pattern_page_checked via observer"),a.observed=!0,K())}};if(b.length||h){var f=null,g="";if(f=/\/explore\/tags\/([^\/]+)/.exec(location.pathname))a.is_tags_page=
!0,b.addClass("tagspage"),a.page_name=f[1],g="tags_"+a.page_name;else if(f=/\/([^\/]+)/.exec(location.pathname))a.page_name=f[1],g="user_"+a.page_name;g&&(A=A||{},A["KEY_SAVE_BULK_"+g]=[""],A["KEY_SAVE_STATE_"+g]=[""]);c("Pagename: "+a.page_name);a.is_tags_page&&c("is_tags_page: True");(a.feedlog_show=/&?\bshowlog=true\b/.test(location.search))&&c("Feedlog Enabled");if(a.is_parent=/&?\bparent=true\b/.test(location.search)||h)if(e("body").addClass("isparent"),c("Parent-mode Enabled"),a.is_rootpage=
h)a.is_parent=!0;(a.is_child=/&?\bchild=true\b/.test(location.search))&&c("Child-mode");h?(a.observed=!0,K()):U(b.get(0),d);a.stIDomWatch=setInterval(function(){a.observed&&a.stIDomWatch?clearInterval(a.stIDomWatch):G()&&(c("[OK] pattern_page_checked via stIDomWatch"),a.observed=!0,c("Force running main script.."),K())},1E3);setTimeout(function(){if(!G()){c("Page observe & check failed after "+a.observe_timeout+" sec");if(a.observer){c("[HALT] Disconnecting observer..");try{a.observer.disconnect()}catch(r){}}return!1}},
1E3*a.observe_timeout)}else return c("Not profile page; Missing element "+a.root_selector+". Exiting.."),!1})()}function T(e){"undefined"==typeof unsafeWindow&&(unsafeWindow=window);"undefined"==typeof GM_log&&(GM_log=function(e){try{unsafeWindow.console.log("GM_log: "+e)}catch(c){}});var y=!1;window.navigator.appName.match(/^opera/i)&&"undefined"!=typeof window.opera&&(clog("Opera detected...",0),y=!0,e.isOpera=!0,GM_log=window.opera.postError);if("undefined"!=typeof GM_setValue){try{var m=GM_setValue.toString()}catch(h){m=
".staticArgs.FF4.0"}0<m.indexOf("staticArgs")?(e.isGreaseMonkey=!0,e.isFF4=!1,clog("GreaseMonkey Api detected"+((e.isFF4=0<m.indexOf("FF4.0"))?" >= FF4":"")+"...",0)):m.match(/not\s+supported/)&&(clog("Bugged Chrome GM Api detected...",0),y=!0,e.isBuggedChrome=!0)}else clog("No GM Api detected...",0),y=!0;e.noCrossDomain=e.isOpera||e.isBuggedChrome;if(y){clog("Try to recreate needed GM Api...",0);m=null;try{m=typeof unsafeWindow.localStorage}catch(h){m=null}"object"==m?(clog("Using localStorage for GM Api.",
0),GM_getValue=function(e,c){var h=unsafeWindow.localStorage.getItem(GMSTORAGE_PATH+e);if(null==h)return c;switch(h.substr(0,2)){case "S]":return h.substr(2);case "N]":return parseInt(h.substr(2));case "B]":return"true"==h.substr(2)}return h},GM_setValue=function(e,c){switch(typeof c){case "string":unsafeWindow.localStorage.setItem(GMSTORAGE_PATH+e,"S]"+c);break;case "number":0>c.toString().indexOf(".")&&unsafeWindow.localStorage.setItem(GMSTORAGE_PATH+e,"N]"+c);break;case "boolean":unsafeWindow.localStorage.setItem(GMSTORAGE_PATH+
e,"B]"+c)}},GM_deleteValue=function(e){unsafeWindow.localStorage.removeItem(GMSTORAGE_PATH+e)}):e.isOpera&&"undefined"!=typeof GM_setValue||(clog("Using temporarilyStorage for GM Api.",0),e.temporarilyStorage=[],GM_getValue=function(h,c){return"undefined"==typeof e.temporarilyStorage[GMSTORAGE_PATH+h]?c:e.temporarilyStorage[GMSTORAGE_PATH+h]},GM_setValue=function(h,c){switch(typeof c){case "string":case "boolean":case "number":e.temporarilyStorage[GMSTORAGE_PATH+h]=c}},GM_deleteValue=function(h){delete e.temporarilyStorage[GMSTORAGE_PATH+
h]});"undefined"==typeof GM_openInTab&&(GM_openInTab=function(e){unsafeWindow.open(e,"")});"undefined"==typeof GM_registerMenuCommand&&(GM_registerMenuCommand=function(e,c){GM_log("Notice: GM_registerMenuCommand is not supported.")});e.isOpera&&"undefined"!=typeof GM_xmlhttpRequest||(clog("Using XMLHttpRequest for GM Api.",0),GM_xmlhttpRequest=function(e){var c=new XMLHttpRequest;c.onreadystatechange=function(){if(e.onreadystatechange)e.onreadystatechange(c);if(4==c.readyState&&e.onload)e.onload(c)};
c.onerror=function(){if(e.onerror)e.onerror(c)};try{c.open(e.method,e.url,!0)}catch(B){if(e.onerror)e.onerror({readyState:4,responseHeaders:"",responseText:"",responseXML:"",status:403,statusText:"Forbidden"});return}if(e.headers)for(name in e.headers)c.setRequestHeader(name,e.headers[name]);c.send(e.data);return c})}GM_getIntValue=function(e,c){return parseInt(GM_getValue(e,c),10)};e.ApiUpgrade=y}setTimeout(function(){var e=jQuery?jQuery.noConflict():null;e&&e(function(){H(e)})},0)})();