// ==UserScript==
// @name         juejin-book-exporter
// @namespace    http://tampermonkey.net/
// @version      0.0.1
// @author       c0dedance
// @description  export juejin book
// @license      MIT
// @icon         https://vitejs.dev/logo.svg
// @match        https://juejin.cn/book/*
// @match        https://juejin.cn/video/*
// @run-at       document-start
// @downloadURL https://update.greasyfork.org/scripts/478452/juejin-book-exporter.user.js
// @updateURL https://update.greasyfork.org/scripts/478452/juejin-book-exporter.meta.js
// ==/UserScript==

(function () {
	'use strict';

	function E(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var H=function(){var e=document.getSelection();if(!e.rangeCount)return function(){};for(var n=document.activeElement,s=[],d=0;d<e.rangeCount;d++)s.push(e.getRangeAt(d));switch(n.tagName.toUpperCase()){case"INPUT":case"TEXTAREA":n.blur();break;default:n=null;break}return e.removeAllRanges(),function(){e.type==="Caret"&&e.removeAllRanges(),e.rangeCount||s.forEach(function(f){e.addRange(f);}),n&&n.focus();}},L=H,R={"text/plain":"Text","text/html":"Url",default:"Text"},M="Copy to clipboard: #{key}, Enter";function S(e){var n=(/mac os x/i.test(navigator.userAgent)?"⌘":"Ctrl")+"+C";return e.replace(/#{\s*key\s*}/g,n)}function j(e,n){var s,d,f,m,p,i,w=!1;n||(n={}),s=n.debug||!1;try{f=L(),m=document.createRange(),p=document.getSelection(),i=document.createElement("span"),i.textContent=e,i.ariaHidden="true",i.style.all="unset",i.style.position="fixed",i.style.top=0,i.style.clip="rect(0, 0, 0, 0)",i.style.whiteSpace="pre",i.style.webkitUserSelect="text",i.style.MozUserSelect="text",i.style.msUserSelect="text",i.style.userSelect="text",i.addEventListener("copy",function(u){if(u.stopPropagation(),n.format)if(u.preventDefault(),typeof u.clipboardData>"u"){s&&console.warn("unable to use e.clipboardData"),s&&console.warn("trying IE specific stuff"),window.clipboardData.clearData();var y=R[n.format]||R.default;window.clipboardData.setData(y,e);}else u.clipboardData.clearData(),u.clipboardData.setData(n.format,e);n.onCopy&&(u.preventDefault(),n.onCopy(u.clipboardData));}),document.body.appendChild(i),m.selectNodeContents(i),p.addRange(m);var v=document.execCommand("copy");if(!v)throw new Error("copy command was unsuccessful");w=!0;}catch(u){s&&console.error("unable to copy using execCommand: ",u),s&&console.warn("trying IE specific stuff");try{window.clipboardData.setData(n.format||"text",e),n.onCopy&&n.onCopy(window.clipboardData),w=!0;}catch(y){s&&console.error("unable to copy using clipboardData: ",y),s&&console.error("falling back to prompt"),d=S("message"in n?n.message:M),window.prompt(d,e);}}finally{p&&(typeof p.removeRange=="function"?p.removeRange(m):p.removeAllRanges()),i&&document.body.removeChild(i),f();}return w}var U=j;const P=E(U),O='<svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M8 8H7.2C6.0799 8 5.51984 8 5.09202 8.21799C4.71569 8.40973 4.40973 8.71569 4.21799 9.09202C4 9.51984 4 10.0799 4 11.2V16.8C4 17.9201 4 18.4802 4.21799 18.908C4.40973 19.2843 4.71569 19.5903 5.09202 19.782C5.51984 20 6.0799 20 7.2 20H12.8C13.9201 20 14.4802 20 14.908 19.782C15.2843 19.5903 15.5903 19.2843 15.782 18.908C16 18.4802 16 17.9201 16 16.8V16M11.2 16H16.8C17.9201 16 18.4802 16 18.908 15.782C19.2843 15.5903 19.5903 15.2843 19.782 14.908C20 14.4802 20 13.9201 20 12.8V7.2C20 6.0799 20 5.51984 19.782 5.09202C19.5903 4.71569 19.2843 4.40973 18.908 4.21799C18.4802 4 17.9201 4 16.8 4H11.2C10.0799 4 9.51984 4 9.09202 4.21799C8.71569 4.40973 8.40973 4.71569 8.21799 5.09202C8 5.51984 8 6.07989 8 7.2V12.8C8 13.9201 8 14.4802 8.21799 14.908C8.40973 15.2843 8.71569 15.5903 9.09202 15.782C9.51984 16 10.0799 16 11.2 16Z" stroke="#7b808a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>',T=`<svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M19 15V21M19 21L17 19M19 21L21 19M13 3H8.2C7.0799 3 6.51984 3 6.09202 3.21799C5.71569 3.40973 5.40973 3.71569 5.21799 4.09202C5 4.51984 5 5.0799 5 6.2V17.8C5 18.9201 5 19.4802 5.21799 19.908C5.40973 20.2843 5.71569 20.5903 6.09202 20.782C6.51984 21 7.0799 21 8.2 21H14M13 3L19 9M13 3V7.4C13 7.96005 13 8.24008 13.109 8.45399C13.2049 8.64215 13.3578 8.79513 13.546 8.89101C13.7599 9 14.0399 9 14.6 9H19M19 9V11" stroke="#7b808a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>`;function V(e,n){const s=new Blob([e],{type:"text/markdown"}),d=URL.createObjectURL(s),f=document.createElement("a");f.href=d,f.download=n,f.click(),URL.revokeObjectURL(d);}function q(){const e=document.createElement("span");return e.style.display="inline-block",e.style.marginLeft="8px",e.innerHTML=O,e.addEventListener("click",()=>{if(!window[b])return console.log("md为空");P(window[b])&&console.log("已复制");}),e}function I(){const e=document.createElement("span");return e.style.display="inline-block",e.innerHTML=T,e.addEventListener("click",()=>{if(!window[b])return;const n=document.querySelector(".book-summary  a.section.route-active .title-text").innerHTML;V(window[b],n);}),e}function A(){const e=document.createElement("div");return e.style.cursor="pointer",e.appendChild(I()),e.appendChild(q()),e}function B(e){let n=20,s=setInterval(()=>{--n<=0&&clearInterval(s);const d=document.querySelector("div.book-content nav");d&&(d.insertBefore(e,d.querySelector(".toggle")),clearInterval(s));},1e3);}const F=function(){const e=window.unsafeWindow||document.defaultView||window,n=[],s=e.XMLHttpRequest.prototype,d=Object.getOwnPropertyDescriptors(s),f=e.Response.prototype,m=s.open,p=e.fetch,i=["response","responseText","responseXML"],w=["arrayBuffer","blob","formData","json","text"];function v(){}function u(l,t,o=l[t]){Object.defineProperty(l,t,{configurable:!0,enumerable:!0,get:()=>o,set:v});}function y(l,t,o=l[t]){Object.defineProperty(l,t,{configurable:!0,enumerable:!0,writable:!0,value:o});}function x(...l){const t=this,o={type:"xhr",url:l[1],method:l[0].toUpperCase(),abort:!1,headers:null,data:null,response:null};for(const a of n)if(a(o),o.abort)return;l[1]=o.url,l[0]=o.method;const c={};if(t.setRequestHeader=(a,r)=>{c[a]=r;},t.send=function(a){typeof o.headers=="function"&&o.headers(c);for(const r in c)s.setRequestHeader.call(t,r,c[r]);if(typeof o.data=="function"){const r=o.data(a);r!==void 0&&(a=r);}return s.send.call(t,a)},typeof o.response=="function"){const a={};i.forEach(r=>{Object.defineProperty(t,r,{configurable:!0,enumerable:!0,get:()=>{if(t.readyState===4){if(!("finalUrl"in a)){a.finalUrl=t.responseURL,a.status=t.status,a.responseHeaders={};const h=t.getAllResponseHeaders().trim().split(/[\r\n]+/);for(const g of h){const C=g.split(/:\s*/);C.length===2&&(a.responseHeaders[C[0].toLowerCase()]=C[1]);}}r in a||(a[r]=d[r].get.call(t),o.response(a));}return r in a?a[r]:d[r].get.call(t)}});});}else i.forEach(a=>{delete t[a];});return m.apply(t,l)}function k(l,t,o){w.forEach(c=>{l[c]=()=>new Promise((a,r)=>{f[c].call(l).then(h=>{c in t||(t[c]=h,o(t)),a(c in t?t[c]:h);},r);});});}function D(l,t){if(typeof l=="string"||l instanceof String){t=t||{};const o={type:"fetch",url:l,method:(t.method||"GET").toUpperCase(),abort:!1,headers:null,data:null,response:null};for(const c of n)if(c(o),o.abort)return Promise.reject("aborted");if(l=o.url,t.method=o.method,typeof o.headers=="function"){let c;if(t.headers.toString()==="[object Headers]"){c={};for(const[a,r]of t.headers)c[a]=r;}else c={...t.headers};o.headers(c),t.headers=c;}if(typeof o.data=="function"){const c=o.data(t.body);c!==void 0&&(t.body=c);}if(typeof o.response=="function")return new Promise((c,a)=>{p.call(e,l,t).then(r=>{const h={finalUrl:r.url,status:r.status,responseHeaders:{}};for(const[g,C]of r.headers)h.responseHeaders[g]=C;k(r,h,o.response),r.clone=()=>{const g=f.clone.call(r);return k(g,h,o.response),g},c(r);},a);})}return p.call(e,l,t)}return s.open=x,e.fetch=D,{hook:l=>n.push(l),protect:()=>{u(e,"XMLHttpRequest"),u(s,"open"),u(e,"fetch");},unhook:()=>{y(e,"XMLHttpRequest"),y(s,"open",m),y(e,"fetch",p);}}}(),X="https://api.juejin.cn/booklet_api/v1/section/get",b=Symbol("md");B(A());F.hook(e=>{const{url:n}=e;n.startsWith(X)&&(e.response=s=>{window[b]=s.json.data.section.markdown_show;});});

})();