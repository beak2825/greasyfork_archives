// ==UserScript==
// @name        茂语划词翻译
// @namespace   vincent-du-hello.github.io
// @version     1.0
// @description 茂语翻译
// @license     https://www.apache.org/licenses/LICENSE-2.0
// @author      yuyanMC
// @include     *
// @run-at      document-end
// @downloadURL https://update.greasyfork.org/scripts/462700/%E8%8C%82%E8%AF%AD%E5%88%92%E8%AF%8D%E7%BF%BB%E8%AF%91.user.js
// @updateURL https://update.greasyfork.org/scripts/462700/%E8%8C%82%E8%AF%AD%E5%88%92%E8%AF%8D%E7%BF%BB%E8%AF%91.meta.js
// ==/UserScript==
!function(){"use strict";let e=["猫","毛","铆","茂"];var t=document.createElement("div");function n(e,t){t.textContent=e,t.style.display="block"}t.innerHTML='<span style="font-size:24px;position: absolute;margin: 4px;line-height:24px;user-select:none;">茂</span>',t.setAttribute("style","width:32px;height:32px;display:none;background:#fff;border-radius:16px;box-shadow:4px 4px 8px #888;position:absolute;z-index:2147483647;"),document.documentElement.appendChild(t),document.addEventListener("mousedown",function(e){(e.target==t||e.target.parentNode&&e.target.parentNode==t||e.target.parentNode.parentNode&&e.target.parentNode.parentNode==t)&&e.preventDefault()}),document.addEventListener("selectionchange",function(){window.getSelection().toString().trim()||(t.style.display="none")}),document.addEventListener("mouseup",function(e){if(e.target==t||e.target.parentNode&&e.target.parentNode==t||e.target.parentNode.parentNode&&e.target.parentNode.parentNode==t){e.preventDefault();return}var n=window.getSelection().toString().trim();if(n&&n.length<800&&"none"==t.style.display)t.style.top=e.pageY+12+"px",t.style.left=e.pageX+"px",t.style.display="block";else if(!n){t.style.display="none";for(var o=0;o<r.rendered.length;o++)if(e.target==r.rendered[o])return;r.containerDestroy()}}),t.addEventListener("click",function(o){var i=window.getSelection().toString().trim();if(i){t.style.display="none",r.containerDestroy();var a=r.container();a.style.top=o.pageY+"px",o.pageX+350<=document.body.clientWidth?a.style.left=o.pageX+"px":a.style.left=document.body.clientWidth-350+"px",document.body.appendChild(a),r.rendered.push(a);let l=RegExp(/[^\u732b\u6bdb\u94c6\u8302]/);try{l.test(i)?n(function t(n){let r=n.split(""),o="";for(let i=0;i<r.length;i++){let a=r[i].charCodeAt(0).toString(16);for(;a.length<4;)a="0"+a;o+=a}let l=0,d=o.split(""),s="";for(let p=0;p<d.length;p++)(l=parseInt("0x"+d[p])+p%16)>=16&&(l-=16),s+=e[parseInt(l/4)]+e[l%4];return s}(i),a):n(function t(n){let r="",o=n.split("");for(let i=0;i<=n.length-2;i+=2){let a="",l=0;for(a=o[i];l<=3&&a!=e[l];l++);let d=0;for(a=o[i+1];d<=3&&a!=e[d];d++);let s=4*l+d-parseInt(i/2)%16;s<0&&(s+=16),r+=s.toString(16)}let p="",f=0,g=4;for(;g<=r.length;)p+=String.fromCharCode(parseInt("0x"+r.substring(f,g))),f+=4,g+=4;return p}(i),a)}catch(d){console.error(d),n("翻译失败",a)}}});var r={rendered:[],containerDestroy:function(){for(var e=this.rendered.length-1;e>=0;e--)this.rendered[e]&&this.rendered[e].parentNode&&this.rendered[e].parentNode.removeChild(this.rendered[e])},container:function(){var e=document.createElement("textarea");return e.setAttribute("style","display:none;position:absolute;font-size:13px;overflow:auto;background:#fff;font-family:sans-serif,Arial;font-weight:normal;text-align:left;color:#000;padding:0.5em 1em;line-height:1.5em;border-radius:5px;border:1px solid #ccc;box-shadow:4px 4px 8px #888;max-width:350px;max-height:216px;z-index:2147483647;"),e}}}();