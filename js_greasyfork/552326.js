// ==UserScript==
// @name         Milky Way Idle TITS
// @namespace    http://tampermonkey.net/
// @version      5.91
// @description  Adds market prices, checkboxes, and helper functions to the MWI inventory.
// @author       You & Jango Fett
// @match        https://www.milkywayidle.com/game*
// @grant        GM_xmlhttpRequest
// @grant        GM_getValue
// @grant        GM_setValue
// @downloadURL https://update.greasyfork.org/scripts/552326/Milky%20Way%20Idle%20TITS.user.js
// @updateURL https://update.greasyfork.org/scripts/552326/Milky%20Way%20Idle%20TITS.meta.js
// ==/UserScript==

(async function() {
    'use strict';

    let usedListings = null;
    let totalListings = null;
    let selectionQueue = [];

    // --- UTILITY FUNCTIONS ---
    function formatNumber(num) { if (num === -1 || num === undefined || num === null) return 'N/A'; if (num >= 1000000000) return (num / 1000000000).toFixed(2).replace(/\.00$/, '') + 'B'; if (num >= 1000000) return (num / 1000000).toFixed(2).replace(/\.00$/, '') + 'M'; if (num >= 1000) return (num / 1000).toFixed(2).replace(/\.00$/, '') + 'K'; return Math.floor(num); }
    function parseFormattedNumber(text) { if (typeof text !== 'string') return 0; const lowerText = text.toLowerCase().replace(/,/g, ''); let num = parseFloat(lowerText); if (lowerText.includes('b')) { num *= 1000000000; } else if (lowerText.includes('m')) { num *= 1000000; } else if (lowerText.includes('k')) { num *= 1000; } return isNaN(num) ? 0 : Math.floor(num); }
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    function randomDelay(min = 250, max = 600) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function waitForElement(selector, timeout = 5000) { return new Promise((resolve, reject) => { const intervalTime = 100; let elapsedTime = 0; const interval = setInterval(() => { const element = document.querySelector(selector); if (element) { clearInterval(interval); resolve(element); } elapsedTime += intervalTime; if (elapsedTime >= timeout) { clearInterval(interval); reject(new Error(`Element "${selector}" not found after ${timeout}ms`)); } }, intervalTime); }); }
    function findButtonByText(text) { return Array.from(document.querySelectorAll('button')).find(button => button.textContent.trim() === text); }
    function makeDraggable(element, handle) { let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0; let isDragging = false; handle.onmousedown = dragMouseDown; function dragMouseDown(e) { e = e || window.event; e.preventDefault(); isDragging = false; pos3 = e.clientX; pos4 = e.clientY; if (element.style.bottom || element.style.right) { const rect = element.getBoundingClientRect(); element.style.top = rect.top + "px"; element.style.left = rect.left + "px"; element.style.bottom = 'auto'; element.style.right = 'auto'; } document.onmouseup = closeDragElement; document.onmousemove = elementDrag; } function elementDrag(e) { e = e || window.event; e.preventDefault(); isDragging = true; pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; element.style.top = (element.offsetTop - pos2) + "px"; element.style.left = (element.offsetLeft - pos1) + "px"; } function closeDragElement() { document.onmouseup = null; document.onmousemove = null; GM_setValue('marketHelperPanelTop', element.style.top); GM_setValue('marketHelperPanelLeft', element.style.left); setTimeout(() => { isDragging = false; }, 0); } handle.addEventListener('click', (e) => { if (isDragging || e.target !== handle) return; const totalsContainer = document.getElementById('mwi-market-helper-totals'); const queueBox = document.getElementById('mwi-market-helper-queue-box'); const buttonContainer = document.getElementById('mwi-market-helper-button-container'); const isCollapsed = queueBox.style.display === 'none'; if (isCollapsed) { totalsContainer.style.display = 'flex'; queueBox.style.display = 'block'; buttonContainer.style.display = 'flex'; handle.textContent = 'Market Helper ▼'; GM_setValue('marketHelperPanelCollapsed', 'false'); } else { totalsContainer.style.display = 'none'; queueBox.style.display = 'none'; buttonContainer.style.display = 'none'; handle.textContent = 'Market Helper ▲'; GM_setValue('marketHelperPanelCollapsed', 'true'); } }); }

    // --- ACTION PROCESSING & NOTIFICATION HANDLING ---
    function waitForNotification(timeout = 7000) { return new Promise((resolve) => { const notificationContainer = document.querySelector('.GamePage_notifications__1xT_i'); if (!notificationContainer) { return resolve({ success: false, message: "N-Container not found" }); } let timeoutId = setTimeout(() => { observer.disconnect(); resolve({ success: true, message: "Success (Timeout)" }); }, timeout); const observer = new MutationObserver((mutations) => { for (const mutation of mutations) { if (mutation.addedNodes.length > 0) { const notificationNode = mutation.addedNodes[0]; if (notificationNode.nodeType === 1) { const textEl = notificationNode.querySelector('.Notification_text__3fYCr'); const message = textEl ? Array.from(textEl.querySelectorAll('div')).map(d => d.textContent).join(' ') : 'Unknown notification'; const isError = notificationNode.classList.contains('Notification_error__f9p7B'); clearTimeout(timeoutId); observer.disconnect(); resolve({ success: !isError, message: message }); return; } } } }); observer.observe(notificationContainer, { childList: true }); }); }
    async function processPostSellItem(item) { try { item.clickableElement.click(); await sleep(randomDelay()); await waitForElement('.Item_actionMenu__2yUcG'); const viewMarketButton = findButtonByText('View Marketplace'); if (!viewMarketButton) throw new Error("'View Marketplace' button not found."); viewMarketButton.click(); await sleep(randomDelay()); const newSellButton = await waitForElement('button.Button_sell__3FNpM'); newSellButton.click(); await sleep(randomDelay()); await waitForElement('.MarketplacePanel_priceInputs__3iWxy'); const priceIncreaseButton = findButtonByText('+'); if (!priceIncreaseButton) throw new Error("Price '+' button not found."); priceIncreaseButton.click(); await sleep(randomDelay()); const maxButton = findButtonByText('Max'); if (!maxButton) throw new Error("'Max' button not found."); maxButton.click(); await sleep(randomDelay()); const postButton = findButtonByText('Post Sell Listing'); if (!postButton) throw new Error("Could not find 'Post' button."); const notificationPromise = waitForNotification(); postButton.click(); const result = await notificationPromise; if (result.success) { const listMatch = result.message.match(/Progress: ([\d,]+\s*\/\s*[\d,]+)/); return { success: true, message: listMatch ? `Listed ${listMatch[1]}` : 'Listed!' }; } else { return { success: false, message: `Error: ${result.message}` }; } } catch (error) { console.error(`Error processing 'post-sell':`, error); const header = document.querySelector('.Header_header__1DxsV'); if (header) header.click(); return { success: false, message: `Error` }; } }
    async function processInstantSellItem(item) { try { item.clickableElement.click(); await sleep(randomDelay()); await waitForElement('.Item_actionMenu__2yUcG'); const viewMarketButton = findButtonByText('View Marketplace'); if (!viewMarketButton) throw new Error("'View Marketplace' button not found."); viewMarketButton.click(); await sleep(randomDelay()); const topSellButton = await waitForElement('.MarketplacePanel_orderBookTable__3zzrv tbody tr:first-child .Button_sell__3FNpM'); topSellButton.click(); await sleep(randomDelay()); await waitForElement('.MarketplacePanel_postButtonContainer__3KOIO'); const allButton = findButtonByText('All'); if (!allButton) throw new Error("'All' button not found."); allButton.click(); await sleep(randomDelay()); const postButton = findButtonByText('Post Sell Order'); if (!postButton) throw new Error("Could not find 'Post Sell Order' button."); const notificationPromise = waitForNotification(); postButton.click(); const result = await notificationPromise; if (result.success) { const sellMatch = result.message.match(/Sold ([\d,]+)/); return { success: true, message: sellMatch ? `Sold ${sellMatch[1]}/${item.quantity}` : 'Sold!' }; } else { return { success: false, message: `Error: ${result.message}` }; } } catch (error) { console.error(`Error processing 'instant-sell':`, error); const header = document.querySelector('.Header_header__1DxsV'); if (header) header.click(); return { success: false, message: `Error` }; } }
    async function handleGoButtonClick() { const goButton = document.getElementById('mwi-market-helper-go-btn'); const refreshButton = document.getElementById('mwi-market-helper-refresh-btn'); goButton.disabled = true; refreshButton.disabled = true; goButton.textContent = 'Running...'; const queue = []; selectionQueue.forEach((checkboxId, index) => { const checkbox = document.getElementById(checkboxId); if (!checkbox) return; const itemContainer = checkbox.closest('.Item_itemContainer__x7kH1'); const clickableElement = itemContainer.querySelector('.Item_item__2De2O'); const countEl = itemContainer.querySelector('.Item_count__1HVvv'); const quantityText = countEl ? countEl.textContent : '0'; queue.push({ queueId: `queue-item-${index}`, action: checkbox.dataset.action, clickableElement: clickableElement, quantity: formatNumber(parseFormattedNumber(quantityText)) }); }); for (const item of queue.reverse()) { const statusEl = document.querySelector(`#${item.queueId} .action-status`); if (!statusEl) continue; let result; if (item.action === 'post-sell') { statusEl.textContent = 'Listing...'; statusEl.style.color = 'yellow'; result = await processPostSellItem(item); } else if (item.action === 'instant-sell') { statusEl.textContent = 'Selling...'; statusEl.style.color = 'yellow'; result = await processInstantSellItem(item); } else { result = { success: false, message: 'Skipped' }; } statusEl.textContent = result.message; statusEl.style.color = result.success ? 'lightgreen' : 'lightcoral'; await sleep(randomDelay(2000, 3000)); } goButton.disabled = false; refreshButton.disabled = false; goButton.textContent = 'Go'; fetchMarketData(); }

    // --- UI & DATA FUNCTIONS ---
    function updateQueueDisplay() { const queueBox = document.getElementById('mwi-market-helper-queue-box'); const totalListDiv = document.getElementById('mwi-market-helper-total-list'); const totalSellDiv = document.getElementById('mwi-market-helper-total-sell'); if (!queueBox || !totalListDiv || !totalSellDiv) return; queueBox.innerHTML = ''; let totalListValue = 0; let totalSellValue = 0; if (selectionQueue.length === 0) { queueBox.innerHTML = '<div style="color: #888; text-align: center; margin-top: 10px;">No items selected</div>'; } else { selectionQueue.slice().reverse().forEach((checkboxId, index) => { const checkbox = document.getElementById(checkboxId); if (!checkbox) return; const itemContainer = checkbox.closest('.Item_itemContainer__x7kH1'); if (!itemContainer) return; const svg = itemContainer.querySelector('svg'); const itemName = svg ? svg.getAttribute('aria-label') : 'Unknown Item'; const enhancementEl = itemContainer.querySelector('.Item_enhancementLevel__19g-e'); const enhancement = enhancementEl ? ` ${enhancementEl.textContent}` : ''; const countEl = itemContainer.querySelector('.Item_count__1HVvv'); const quantityText = countEl ? countEl.textContent : '0'; const quantity = parseFormattedNumber(quantityText); const action = checkbox.dataset.action === 'post-sell' ? 'List' : 'Sell'; const actionColor = action === 'List' ? '#4CAF50' : '#FF9800'; const priceLabel = checkbox.nextElementSibling; const priceText = priceLabel ? priceLabel.textContent : '0'; const price = parseFormattedNumber(priceText); const total = (quantity * price) * 0.98; if (action === 'List') { totalListValue += total; } else { totalSellValue += total; } const queueItemDiv = document.createElement('div'); queueItemDiv.id = `queue-item-${index}`; queueItemDiv.style.cssText = 'padding: 3px 4px; border-bottom: 1px solid #333; line-height: 1.3;'; queueItemDiv.innerHTML = ` <div> <span style="color: ${actionColor}; font-weight: bold;">${action}:</span> <span>${itemName}${enhancement} (${formatNumber(quantity)}) @ ${priceText}</span> <span class="action-status" style="float: right; color: #aaa; font-style: italic;">Pending</span> </div> <div style="font-size: 11px; color: #ccc; text-align: right;"> Total (after tax): ${formatNumber(total)} </div> `; queueBox.appendChild(queueItemDiv); }); } totalListDiv.innerHTML = `<span>Total To List:</span> <span style="color: #4CAF50;">${formatNumber(totalListValue)}</span>`; totalSellDiv.innerHTML = `<span>Total To Sell:</span> <span style="color: #FF9800;">${formatNumber(totalSellValue)}</span>`; }
    function scanForListingCount() { const listingElement = document.querySelector('.MarketplacePanel_listingCount__3nVY_'); if (listingElement) { const match = listingElement.textContent.match(/(\d+)\s*\/\s*(\d+)/); if (match) { usedListings = parseInt(match[1], 10); totalListings = parseInt(match[2], 10); } } }
    function addCategoryButtons() { document.querySelectorAll('.Inventory_label__XEOAx:not(.market-helper-buttons-added)').forEach(header => { header.classList.add('market-helper-buttons-added'); const categoryNameSpan = header.querySelector('.Inventory_categoryButton__35s1x'); if (categoryNameSpan) { const categoryName = categoryNameSpan.textContent; const categoriesToSkip = ['Currencies', 'Loots']; if (categoriesToSkip.includes(categoryName)) { return; } } header.style.display = 'flex'; header.style.alignItems = 'center'; const buttonContainer = document.createElement('div'); buttonContainer.classList.add('market-helper-all-buttons'); buttonContainer.style.marginLeft = '10px'; const buyAllBtn = document.createElement('button'); buyAllBtn.textContent = 'All'; buyAllBtn.style.cssText = 'background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; padding: 2px 8px; margin-right: 5px;'; buyAllBtn.dataset.action = 'post-sell'; const sellAllBtn = document.createElement('button'); sellAllBtn.textContent = 'All'; sellAllBtn.style.cssText = 'background-color: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; padding: 2px 8px;'; sellAllBtn.dataset.action = 'instant-sell'; buttonContainer.appendChild(buyAllBtn); buttonContainer.appendChild(sellAllBtn); if (categoryNameSpan) { categoryNameSpan.insertAdjacentElement('afterend', buttonContainer); } else { header.appendChild(buttonContainer); } buttonContainer.addEventListener('click', function(event) { if (event.target.tagName !== 'BUTTON') return; const action = event.target.dataset.action; const itemGrid = header.closest('.Inventory_itemGrid__20YAH'); if (itemGrid) { const checkboxes = itemGrid.querySelectorAll(`input[data-action="${action}"]`); const allAreChecked = Array.from(checkboxes).every(box => box.checked); const siblingAction = action === 'post-sell' ? 'instant-sell' : 'post-sell'; checkboxes.forEach(box => { const boxId = box.id; const index = selectionQueue.indexOf(boxId); if (index > -1) { selectionQueue.splice(index, 1); } if (allAreChecked) { box.checked = false; } else { box.checked = true; selectionQueue.push(boxId); const itemContainer = box.closest('.Item_itemContainer__x7kH1'); if (itemContainer) { const siblingBox = itemContainer.querySelector(`input[data-action="${siblingAction}"]`); if (siblingBox && siblingBox.checked) { siblingBox.checked = false; const siblingIndex = selectionQueue.indexOf(siblingBox.id); if (siblingIndex > -1) { selectionQueue.splice(siblingIndex, 1); } } } } }); updateQueueDisplay(); } }); }); }
    function setupEventListeners() { const inventoryPanel = document.querySelector('.Inventory_inventory__17CH2'); if (inventoryPanel && !inventoryPanel.dataset.marketHelperListeners) { inventoryPanel.dataset.marketHelperListeners = 'true'; inventoryPanel.addEventListener('click', async function(event) { let shouldUpdateQueue = false; if (event.target.matches('input.mwi-market-checkbox')) { shouldUpdateQueue = true; const checkbox = event.target; const checkboxId = checkbox.id; const index = selectionQueue.indexOf(checkboxId); if (index > -1) { selectionQueue.splice(index, 1); } if (checkbox.checked) { selectionQueue.push(checkboxId); } const isTopBox = checkbox.dataset.action === 'post-sell'; const siblingAction = isTopBox ? 'instant-sell' : 'post-sell'; const itemContainer = checkbox.closest('.Item_itemContainer__x7kH1'); const siblingCheckbox = itemContainer.querySelector(`input[data-action="${siblingAction}"]`); if (siblingCheckbox && siblingCheckbox.checked) { siblingCheckbox.checked = false; const siblingIndex = selectionQueue.indexOf(siblingCheckbox.id); if (siblingIndex > -1) { selectionQueue.splice(siblingIndex, 1); } } } const item = event.target.closest('.Item_item__2De2O'); if (item) { if (event.ctrlKey || event.shiftKey || event.altKey) { event.preventDefault(); event.stopPropagation(); const itemContainer = item.closest('.Item_itemContainer__x7kH1'); const topBox = itemContainer.querySelector('input[data-action="post-sell"]'); const bottomBox = itemContainer.querySelector('input[data-action="instant-sell"]'); if (event.shiftKey && topBox) { topBox.click(); } else if (event.ctrlKey && bottomBox) { bottomBox.click(); } else if (event.altKey) { item.click(); try { await waitForElement('.Item_actionMenu__2yUcG'); const viewMarketButton = findButtonByText('View Marketplace'); if (viewMarketButton) { viewMarketButton.click(); } } catch (e) { console.error("Market Helper: Could not open marketplace view.", e); } } } } if (shouldUpdateQueue) { setTimeout(updateQueueDisplay, 0); } }, true); } }
    function fetchMarketData() { scanForListingCount(); const refreshButton = document.getElementById('mwi-market-helper-refresh-btn'); if (refreshButton) { refreshButton.textContent = '...'; refreshButton.disabled = true; } GM_xmlhttpRequest({ method: "GET", url: "https://www.milkywayidle.com/game_data/marketplace.json", onload: function(response) { try { const fullData = JSON.parse(response.responseText); const marketData = fullData.marketData; if (!marketData) return; updateUI(marketData); addCategoryButtons(); } catch (e) { console.error("MWI Market Helper: Failed to parse market data.", e); } finally { if (refreshButton) { setTimeout(() => { refreshButton.textContent = 'Refresh'; refreshButton.disabled = false; }, 500); } } }, onerror: function(e) { console.error("MWI Market Helper: Failed to FETCH market data.", e); if (refreshButton) { refreshButton.textContent = 'Error!'; setTimeout(() => { refreshButton.textContent = 'Refresh'; refreshButton.disabled = false; }, 2000); } } }); }
    function updateUI(marketData) { const inventoryContainer = document.querySelector('.Inventory_inventory__17CH2'); if (!inventoryContainer) return; let listingDiv = document.getElementById('mwi-market-helper-listings'); if (!listingDiv) { listingDiv = document.createElement('div'); listingDiv.id = 'mwi-market-helper-listings'; listingDiv.style.cssText = 'color: orange; font-size: 14px; text-align: left; font-weight: bold; margin: 10px 0 10px 5px;'; } if (usedListings !== null && totalListings !== null) { listingDiv.textContent = `Market Listings Used: ${usedListings} / ${totalListings}`; } else { listingDiv.textContent = 'Market Listings: Visit "My Listings" to update count.'; } const netWorthElement = document.getElementById('toggleNetWorth'); if (netWorthElement && netWorthElement.parentElement) { if (netWorthElement.parentElement.nextElementSibling !== listingDiv) { netWorthElement.parentElement.insertAdjacentElement('afterend', listingDiv); } } else if (!listingDiv.parentElement) { inventoryContainer.prepend(listingDiv); } const inventoryPanel = inventoryContainer.querySelector('.Inventory_items__6SXv0'); if (!inventoryPanel) return; const checkedStates = new Set(); inventoryPanel.querySelectorAll('input.mwi-market-checkbox:checked').forEach(checkbox => { checkedStates.add(checkbox.id); }); const itemContainers = inventoryPanel.querySelectorAll('.Item_itemContainer__x7kH1'); itemContainers.forEach(container => { const svg = container.querySelector('svg'); if (!svg) return; const ariaLabel = svg.getAttribute('aria-label'); if (!ariaLabel) return; const itemName = ariaLabel.toLowerCase().replace(/[^a-z0-9 ]/g, "").replace(/ /g, '_'); const itemsToSkip = ['coin', 'task_token', 'enchanted_token', 'cowbell', 'large_treasure_chest']; if (itemsToSkip.includes(itemName)) return; const itemMarketData = marketData[`/items/${itemName}`]; if (!itemMarketData) { const oldMarketDiv = container.querySelector('.market-data'); if (oldMarketDiv) oldMarketDiv.remove(); return; }; let enhancementLevel = '0'; const enhancementElement = container.querySelector('.Item_enhancementLevel__19g-e'); if (enhancementElement) { enhancementLevel = enhancementElement.textContent.replace('+', ''); } let priceData = null; if (itemMarketData[enhancementLevel]) { priceData = itemMarketData[enhancementLevel]; } else if (enhancementLevel === '0' && (itemMarketData.hasOwnProperty('a') || itemMarketData.hasOwnProperty('b'))) { priceData = itemMarketData; } if (priceData) { const topPrice = priceData.a; const bottomPrice = priceData.b; const topId = `post-sell-${itemName}-${enhancementLevel}`; const bottomId = `instant-sell-${itemName}-${enhancementLevel}`; let marketDiv = container.querySelector('.market-data'); if (!marketDiv) { marketDiv = document.createElement('div'); marketDiv.classList.add('market-data'); marketDiv.style.cssText = 'text-align: center; font-size: 12px;'; marketDiv.innerHTML = ` <div style="display: flex; justify-content: space-evenly; align-items: center; padding: 0 4px;"> <input type="checkbox" class="mwi-market-checkbox" id="${topId}" data-action="post-sell" style="margin-left: 5px; margin-right: 4px;"> <label class="top-label" style="color: #4CAF50; flex-grow: 1; text-align: left;"></label> </div> <div style="display: flex; justify-content: space-evenly; align-items: center; padding: 0 4px;"> <input type="checkbox" class="mwi-market-checkbox" id="${bottomId}" data-action="instant-sell" style="margin-left: 5px; margin-right: 4px;"> <label class="bottom-label" style="color: #FF9800; flex-grow: 1; text-align: left;"></label> </div> `; container.appendChild(marketDiv); } marketDiv.querySelector('.top-label').textContent = formatNumber(topPrice); marketDiv.querySelector('.bottom-label').textContent = formatNumber(bottomPrice); marketDiv.querySelector(`#${topId}`).checked = checkedStates.has(topId); marketDiv.querySelector(`#${bottomId}`).checked = checkedStates.has(bottomId); } }); };

    const savedTop = await GM_getValue('marketHelperPanelTop', null);
    const savedLeft = await GM_getValue('marketHelperPanelLeft', null);
    const savedCollapsed = await GM_getValue('marketHelperPanelCollapsed', 'false') === 'true';
    const style = document.createElement('style'); style.textContent = ` .market-helper-hidden .market-data, .market-helper-hidden .market-helper-all-buttons { display: none !important; } #mwi-market-helper-toggle-btn { background-color: #555; padding: 8px 12px; color: white; border: none; border-radius: 5px; cursor: pointer; } #mwi-market-helper-toggle-btn.active { background-color: #007bff; box-shadow: inset 0 2px 4px rgba(0,0,0,0.4); } `; document.head.appendChild(style);
    if (!document.getElementById('mwi-market-helper-container')) {
        const mainContainer = document.createElement('div'); mainContainer.id = 'mwi-market-helper-container'; let initialPosition = 'bottom: 20px; right: 20px;'; if (savedTop && savedLeft) { initialPosition = `top: ${savedTop}; left: ${savedLeft};`; } mainContainer.style.cssText = `position: fixed; ${initialPosition} width: 280px; background-color: rgba(20, 20, 30, 0.85); border: 1px solid #555; border-radius: 8px; z-index: 1000; backdrop-filter: blur(5px); display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.5);`;
        const header = document.createElement('div'); header.id = 'mwi-market-helper-header'; header.style.cssText = 'padding: 8px; cursor: move; background-color: rgba(40, 40, 50, 0.9); color: white; font-weight: bold; text-align: center; border-top-left-radius: 8px; border-top-right-radius: 8px; user-select: none;';
        const totalsContainer = document.createElement('div'); totalsContainer.id = 'mwi-market-helper-totals'; totalsContainer.style.cssText = 'padding: 4px 8px; font-size: 12px; background-color: rgba(40, 40, 50, 0.9); color: white; display: flex; justify-content: space-between;';
        const totalListDiv = document.createElement('div'); totalListDiv.id = 'mwi-market-helper-total-list';
        const totalSellDiv = document.createElement('div'); totalSellDiv.id = 'mwi-market-helper-total-sell';
        totalsContainer.appendChild(totalListDiv); totalsContainer.appendChild(totalSellDiv);
        const queueBox = document.createElement('div'); queueBox.id = 'mwi-market-helper-queue-box'; queueBox.style.cssText = 'height: 200px; color: white; padding: 5px; font-size: 12px; overflow-y: auto;';
        const buttonContainer = document.createElement('div'); buttonContainer.id = 'mwi-market-helper-button-container'; buttonContainer.style.cssText = 'display: flex; justify-content: space-around; padding: 8px; border-top: 1px solid #555;';
        if (savedCollapsed) { totalsContainer.style.display = 'none'; queueBox.style.display = 'none'; buttonContainer.style.display = 'none'; header.textContent = 'Market Helper ▲'; } else { header.textContent = 'Market Helper ▼'; }
        const refreshButton = document.createElement('button'); refreshButton.id = 'mwi-market-helper-refresh-btn'; refreshButton.textContent = 'Refresh'; refreshButton.style.cssText = 'padding: 8px 12px; background-color: #555; color: white; border: none; border-radius: 5px; cursor: pointer;'; refreshButton.addEventListener('click', fetchMarketData);
        const toggleButton = document.createElement('button'); toggleButton.id = 'mwi-market-helper-toggle-btn'; toggleButton.textContent = 'Toggle UI';
        const goButton = document.createElement('button'); goButton.id = 'mwi-market-helper-go-btn'; goButton.textContent = 'Go'; goButton.style.cssText = 'padding: 8px 12px; background-color: #6495ED; color: white; border: none; border-radius: 5px; cursor: pointer;'; goButton.addEventListener('click', handleGoButtonClick);
        buttonContainer.appendChild(refreshButton); buttonContainer.appendChild(toggleButton); buttonContainer.appendChild(goButton);
        mainContainer.appendChild(header); mainContainer.appendChild(totalsContainer); mainContainer.appendChild(queueBox); mainContainer.appendChild(buttonContainer);
        document.body.appendChild(mainContainer);
        makeDraggable(mainContainer, header);
    }
    setTimeout(() => {
        fetchMarketData();
        setupEventListeners();
        updateQueueDisplay();
        const savedToggleState = localStorage.getItem('marketHelperToggleState') === 'true';
        const toggleButton = document.getElementById('mwi-market-helper-toggle-btn');
        const panel = document.querySelector('.Inventory_items__6SXv0');
        if (panel && savedToggleState) {
            panel.classList.add('market-helper-hidden');
            if (toggleButton) toggleButton.classList.add('active');
        }
        if (toggleButton) {
            toggleButton.addEventListener('click', () => {
                if (panel) {
                    panel.classList.toggle('market-helper-hidden');
                    const isHidden = panel.classList.contains('market-helper-hidden');
                    toggleButton.classList.toggle('active', isHidden);
                    localStorage.setItem('marketHelperToggleState', isHidden);
                }
            });
        }
    }, 3000);
})();