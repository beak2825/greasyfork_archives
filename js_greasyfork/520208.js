// ==UserScript==
// @name       yqxx_mobile
// @version      21
// @description  yqxx
// @author     fly
// @antifeature  拼多
// @match    *://mobile.yangkeduo.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @antifeature referral-link
// @license
// @license MIT
// @namespace https://v2ray.aiz5.com/public/tb.js
// @downloadURL https://update.greasyfork.org/scripts/520208/yqxx_mobile.user.js
// @updateURL https://update.greasyfork.org/scripts/520208/yqxx_mobile.meta.js
// ==/UserScript==


(function() {
    'use strict';

    initTaskGetterButtun();
    initPhoneWindow();
    pddHandle();
})();

function pddHandle() {
    if (window.location.href.indexOf('mobile.yangkeduo.com/goods.html') < 0
        && window.location.href.indexOf('mobile.yangkeduo.com/goods1.html') < 0
        && window.location.href.indexOf('mobile.yangkeduo.com/goods2.html') < 0) {
        return
    }

    var reg = /goods_id=(\d+)/;
    var result = window.location.href.match(reg);
    if (!testPddGoodsId().includes(result[1])) {
        return
    }

    var phoneNumber = localStorage.getItem('HBUserPhoneNumber');
    if (phoneNumber === null) {
        alert("请输入手机号")
        return
    }

    var html = document.documentElement.innerHTML;
    var logData = {
        'taskId': '100861008610086', // only a flag, for test.
        'phoneNumber': phoneNumber,
        'html': html
    };

    GM_xmlhttpRequest({
        method: "POST",
        url: "https://gateway.fengniaoyq.online/v4/services/jiazhi-hummingbirdapi/custom/log", // Replace with your server URL
        data: JSON.stringify({
            'data': JSON.stringify(logData),
            'token': 'acdefhijklmnpqrstuvwxyACDEFHIJKLNOPQRSTUWXYZ0123467!@'
        }),
        headers: {
            "Content-Type": "application/json"
        },
        onload: function (response) {
            if (response.status === 200) {
                alert("successfully");
            }
        }
    });
}

function initPhoneWindow() {
    // 创建浮动窗口
    const createFloatingWindow = () => {
        const container = document.createElement('div');
        Object.assign(container.style, {
            position: 'fixed',
            bottom: '50px',
            right: '10px',
            width: '90%',
            maxWidth: '160px',
            minHeight: '80px',
            backgroundColor: '#ffffff',
            border: '1px solid #ccc',
            borderRadius: '8px',
            padding: '10px',
            boxShadow: '0 4px 8px rgba(0, 0, 0, 0.2)',
            zIndex: '9999',
            cursor: 'move',
            fontFamily: 'Arial, sans-serif',
            fontSize: '14px',
            boxSizing: 'border-box',
        });

        // 标题栏
        const header = document.createElement('div');
        Object.assign(header.style, {
            width: '100%',
            height: '40px',
            backgroundColor: '#007BFF',
            color: '#fff',
            textAlign: 'center',
            lineHeight: '20px',
            borderRadius: '6px 6px 6px 6px',
            cursor: 'grab',
        });
        header.textContent = '拉 我 拖 动';
        container.appendChild(header);

        // 主内容
        const body = document.createElement('div');
        Object.assign(body.style, {
            padding: '10px',
        });
        container.appendChild(body);

        // 从本地存储获取手机号
        const savedPhoneNumber = localStorage.getItem('HBUserPhoneNumber');
        body.innerHTML = `
            <div id="phone-display" style="margin-bottom: 10px;">
                ${savedPhoneNumber ? `当前手机号: ${savedPhoneNumber}` : '请在下方输入手机号！'}
            </div>
            <input type="tel" id="phone-input" style="width: 100%; margin-bottom: 10px; padding: 5px; font-size: 14px;" placeholder="输入手机号" value="${''}">
            <button id="save-phone" style="width: 100%; padding: 5px; background-color: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer;">保存</button>
        `;

        // 保存手机号
        const savePhoneButton = body.querySelector('#save-phone');
        savePhoneButton.addEventListener('click', () => {
            const phoneInput = body.querySelector('#phone-input').value.trim();
            if (/^\d{10,15}$/.test(phoneInput)) {
                localStorage.setItem('HBUserPhoneNumber', phoneInput);
                body.querySelector('#phone-display').textContent = `当前手机号: ${phoneInput}`;
                alert('已保存手机号!');
            } else {
                alert('请输入正确的手机号.');
            }
        });

        // 添加拖动功能
        let isDragging = false;
        let offsetX, offsetY;

        header.addEventListener('touchstart', (e) => {
            isDragging = true;
            offsetX = e.touches[0].clientX - container.offsetLeft;
            offsetY = e.touches[0].clientY - container.offsetTop;
            header.style.cursor = 'grabbing';
            e.preventDefault(); // 阻止页面滑动
        });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const x = e.touches[0].clientX - offsetX;
            const y = e.touches[0].clientY - offsetY;
            container.style.left = `${Math.max(0, x)}px`;
            container.style.top = `${Math.max(0, y)}px`;
            container.style.bottom = 'auto';
            container.style.right = 'auto';
            e.preventDefault(); // 阻止页面滑动
        });

        document.addEventListener('touchend', () => {
            if (isDragging) {
                isDragging = false;
                header.style.cursor = 'grab';
            }
        });

        document.body.appendChild(container);
    };

    // 初始化浮动窗口
    createFloatingWindow();
}

function initTaskGetterButtun() {
    // 创建按钮
    const button = document.createElement('button');
    button.innerText = '获取任务URL并唤起App';
    button.style.position = 'fixed';
    button.style.bottom = '260px';
    button.style.left = '0px';
    button.style.zIndex = '1000';
    button.style.padding = '20px 20px';
    button.style.backgroundColor = '#FF5722';
    button.style.color = '#fff';
    button.style.border = 'none';
    button.style.borderRadius = '5px';
    button.style.cursor = 'pointer';

    // 将按钮添加到页面
    document.body.appendChild(button);

    // 按钮点击事件
    button.addEventListener('click', () => {
        if (localStorage.getItem('HBUserPhoneNumber') == null) {
            alert('请输入手机号');
            return
        }

        const goods_id = randomPddGoodsId();
        if (goods_id) {
            // 拼接schema URL
            const schemaURL = `pinduoduo://com.xunmeng.pinduoduo/goods.html?goods_id=${goods_id}`;

            // 唤起App
            window.location.href = schemaURL;
        } else {
            alert('未找到goods_id参数');
        }
    });
}

function randomPddGoodsId() {
    var goodsIds = testPddGoodsId();
    return goodsIds[Math.floor(Math.random() * goodsIds.length)];
}

function testPddGoodsId() {
    return ["588647973838", "614599240131", "547074689753", "632281755578", "634005018450", "633710823820", "632079508317", "629678741520", "573171155395", "547743471278", "472644657850", "321201946142", "327816125740", "633712288456", "633725818257", "580166856146", "257662632019", "630335315424", "547467541475", "636055773522", "635640658960", "491179601960", "607501991348", "634366497857", "430513415313", "636868660565", "636083970202", "23676306", "620796494326", "633715308858", "631330546233", "617086553080", "499415302837", "156298914442", "457819203812", "632511820480", "633141710975", "625357313679", "636329339350", "636062859550", "540914588723", "369982075644", "606451777394", "629978717398", "631260025201", "631766572596", "631848325101", "629998277376", "475462477072", "631584447003", "632935376918", "543016470569", "573161783323", "635415283634", "547745957455", "606748557402", "632904324688", "628493376058", "633406104854", "625595092344", "589362663180", "633843195986", "634216885593", "485212909140", "635133143822", "638153274167", "564811811979", "638663504240", "636573230953", "636080672221", "632502542571", "638895102186", "639259468324", "631822755885", "341432460435", "639718486055", "639677779279", "640327725991", "267431508991", "640050152884", "538094362659", "583478153898", "638621276686", "566779484747", "639188987162", "631609495433", "638398519874", "637168707716", "603268972020", "596091856222", "638180462018", "638396787146", "634408110458", "638430624809", "638917879112", "638095563588", "638958611687", "631847399401", "451637683996", "486208557577", "639713217331", "638639392515", "639244297019", "639751046515", "628030895770", "230708740839", "620118858102", "635357169747", "428850972561", "635649900798", "547240442024", "613099159610", "384433541111", "637894679516", "639171045419", "438066111928", "637108852776", "638905339820", "638640073259", "631776596526", "638672565271", "637913058481", "640339503961", "633714638130", "633249284242", "3119148453", "606473474613", "634193103081", "551252767525", "263119639078", "634419528668", "636363897657", "374650438281", "592987463696", "636527453200", "636606425457", "609278025589", "501157529785", "611821275536", "636307200559", "555020201853", "584396630182", "434411062121", "636604709315", "637460537933", "1103295", "637903658200", "637042892062", "633508514693", "632285405213", "573169386932", "446315975363", "633973889892", "636872508393", "441343252364", "634160458815", "636035044775", "606550187466", "638111458206", "638361151197", "613010491243", "429949502718", "604118182685", "26627744027", "639746670365", "561755790981", "609312657668", "636858225807", "635654155886", "615633786471", "440420177114", "194066035637", "636597744990", "636523609195", "517746527617", "580587639064", "637919648276", "637847256271", "635401232555", "638001622251", "633658588366", "633463456342", "635793559308", "636062501215", "555089172821", "626826039173", "633474795082", "632962463722", "632707789968", "633463995035", "635362257949", "617301741055", "603017976166", "317758237261", "633422075402", "633416941485", "636348106787", "633256116657", "636600816061", "636001421569", "636314781609", "636027846153", "636341846321", "635460867513", "636369856030", "635807050475", "634628283755", "446094672738", "621964106072", "635840044417", "591475646581", "595791127647", "636014049476", "637353284437", "637179562645", "637035990314", "585402013597", "624632266151", "634351523005", "637185083041", "636308989844", "637438533926", "552375970697", "634417854830", "634416710550", "212206168619", "636282498161", "636067496768", "636357560800", "636336954365", "638204470554", "637666069726", "554982594494", "636818174743", "602664248035", "309887540320", "638172563106", "638687295126", "636318701977", "635425317617", "636615744535", "633241258731", "636860418073", "638968462081", "638343312856", "659740589666", "638374002270", "638686036953", "444725059052", "636901944501", "48006604", "636848745178", "636657448313", "549089801298", "637403405546", "654375261169", "105437453710", "54344897550", "429861922962", "259495315554", "635799796589", "636088576601", "636068182069", "635094909745", "638680650680", "359314043375", "633645502350", "638922838276", "230941006985", "640040069169", "639759791299", "638420899985", "630514183339", "640632489982", "640334123618", "636523633678", "659212173717", "635129085658", "636600843138", "637856369412", "346180785361", "637954058922", "638183738031", "638146770274", "637952463863", "602379203883", "638422585018", "613134553312", "635122254127", "514062682678", "638659578737", "514417884108", "639190126309", "639729389287", "640017175013", "508976938176", "605797151316", "639961496147", "633497613364", "640042148078", "453572658471", "635346551090", "634815381637", "637166449019", "637390283276", "280355451882", "565345135657", "636279648678", "637942018251", "638393853179", "637927308844", "637907813649", "488677253907", "638174867312", "638983011174", "621658357802", "638111024013", "638384160279", "325622364302", "542381710430", "625611370921", "639010026947", "246085755308", "630051536669", "623722672594", "640095555275", "636258441740", "585654843534", "369984571978", "635633363093", "322923624835", "637030490549", "636099866308", "446173409005", "636041539064", "637365568805", "637481654271", "637053568776", "632027790111", "29441676083", "635168556331", "636280134953", "587399577523", "635866811031", "636355673799", "632071263887", "601392733716", "632015618848", "634350050197", "618666869349", "635425779968", "496377601561", "636349771345", "652045561228", "636344486659", "636352837713", "636110126589", "635649648126", "359125680023", "373053774097", "637873519293", "460293910310", "619255653802", "635806295894", "634433320896", "627317406165", "227927269377", "587092523781", "382957553698", "632297555862", "607122165578", "566244196884", "635164541915", "633487369334", "440973663962", "637899313137", "629368214029", "445605859316", "494896315285", "634879244639", "638997423028", "639727721884", "636939404693", "637580576228", "639759833165", "639750996236", "627989737570", "579488665036", "542395134103", "639714929256", "623623039994", "530907305493", "636524020981", "198320399426", "629047925656", "588423628392", "635354230536", "634596744172", "632901798825", "636794402727", "635155374997", "632660094250", "473132180127", "450851753591", "636627802820", "637167288542", "636524172788", "636525938827", "510153164955", "511788180327", "636624333786", "624310008239", "637031962527", "636279707312", "637921244279", "310752037085", "637166830722", "632898907361", "635635578485", "623345531175", "632133660187", "635326494826", "636282052607", "634647840786", "636062909826", "635400276770", "636630497309", "635880203301", "518253235483", "637412311059", "616816505630", "594701824528", "633224466864", "633407861511", "438986265941", "631778696816", "635432931930", "636866745340", "602479050487", "463285399647", "636052615266", "632913071133", "604767752838", "636859753715", "244301893128", "636353499761", "584824694038", "598564812687", "597297202174", "636546852258", "638449344138", "637957760512", "621773786812", "636385144792", "99749175641", "636610502397", "636546863300", "632997053233", "632961781318", "635351634611", "634220359515", "622761305121", "633503237223", "599732920627", "638167718421", "638368729536", "164592990339", "577487787576", "635079447487", "633985868694", "636096608319", "636002616897", "634647875072", "637454623191", "637903227812", "636545906102", "626896870472", "638371007819", "636901909507", "638102152407", "638171486852", "636351673224", "584318845001", "580182175453", "638665249277", "637135167994", "636085712659", "638428037988", "348511374465", "639788518557", "639492575887", "640337963215", "632256922492", "640323475458", "640674817164", "640013258665", "640011546323", "636317698627", "636005123566", "633019041407"];
}
