// ==UserScript==
// @name         TW - Actions multiples (traducido por pepe100)
// @namespace    http://your.homepage/
// @version      0.2
// @description:fr  Permet d'acheter des lots d'items dans les magasins, ouvrir des lots de sacs.
// @description  Permet d'acheter des lots d'items dans les magasins, ouvrir des lots de sacs.
// @author       Thathanka Iyothanka
// @include		http*://*.the-west.*/game.php*
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/12991/TW%20-%20Actions%20multiples%20%28traducido%20por%20pepe100%29.user.js
// @updateURL https://update.greasyfork.org/scripts/12991/TW%20-%20Actions%20multiples%20%28traducido%20por%20pepe100%29.meta.js
// ==/UserScript==

Trader.buyDialog=function(item_id){var buy_popup;if($('#buy_popup')){$('#buy_popup').remove();}var xhtml='';var item=Trader.getItemByItemId(item_id);xhtml='<div class="bag_item float_left"><img src="'+item.obj.image+'" /><br /><br /></div>'+'<span class="item_popup_title" id="buy_popup_item_name"></span><span style="font-size:9pt;">'+'¿Cómo se compra ?'+'</span><p><input class="item_popup_input" type="text" id="item_popup_input" value="1"/>'+'<span class="item_count_scrolls"><img src="https://westfrs.innogamescdn.com/images/scrollbar/scroll_up.png" id="buy_rise_count" alt="'+'en arriba'+'"><img src="https://westfrs.innogamescdn.com/images/scrollbar/scroll_down.png" id="buy_lower_count" alt="'+'abajo'+'"></span>'+'</p><br />'+'<span class="item_popup_buy_value">'+'Precio de compra '+': $<span id="buy_popup_price"></span>,&nbsp;'+'Montante total '+':'+'<span class="item_popup_max_money" id="item_popup_max_money"></span></span>';var position=$(Inventory.window.divMain).position();var pos={'left':Math.min($(window).width()-210,position.left+55)+'px','top':Math.min($(window).height()-150,position.top+236)+'px'};new west.gui.Dialog(item.obj.name,xhtml).setId('buy_popup').setX(pos.left).setY(pos.top).addButton('yes',function(){var count=parseInt($('#item_popup_input',context).val());if(count==1){Trader.buyItem(item);}else{var price=parseInt($('#item_popup_max_money').text().substring(1));new west.gui.Dialog("Compra","<br><p>Está seguro (a) de querer transferir <br>" + price + "$ para comprar " + count + " [" + item.obj.name + "] ?</p>").setIcon(west.gui.Dialog.SYS_QUESTION).setModal(true,false,{bg:"https://westfrs.innogamescdn.com/images/curtain_bg.png",opacity:0.5}).addButton('Sí',function(){if(price<=(Character.deposit+Character.money)){Ajax.remoteCall(Trader.types[Trader.type],'buy',{item_id:item.obj.item_id,town_id:Trader.id,last_inv_id:Bag.getLastInvId()},function(json){if(json.error){return new UserMessage(json.error,UserMessage.TYPE_ERROR).show();}else if(json.expressoffer){return new UserMessage("¡Tiene que estar allí!",UserMessage.TYPE_ERROR).show();}else{if(count>55){cnt=0;var tick = setInterval(function(){Trader.buyItem(item);cnt++;if (cnt==count){clearInterval(tick);};},1050);}else{for (i=0;i<count-1;i++){Trader.buyItem(item)};};};});}else{new UserMessage("No tienes suficiente dinero",UserMessage.TYPE_ERROR).show()}}).addButton('cancel').show()}}).addButton('cancel').setModal(true,true).show();var context=$('#buy_popup');$('#buy_popup_price',context).text(parseInt(item.count.substring(1)));$('#buy_popup_item_name',context).text(item.name);$('#item_popup_max_money',context).addClass('text_bold').text("$"+parseInt(item.count.substring(1)));$('#buy_rise_count',context).on('click',function(){Trader.riseBuyCount(item,context)});$('#buy_lower_count',context).on('click',function(){Trader.lowerBuyCount(item,context)});$('#item_popup_input').change(function(){Trader.updateBuyCount(item,context)});;};Trader.updateBuyCount=function(item,context){var count=parseInt($('#item_popup_input',context).val());$('#item_popup_max_money',context).text("$"+parseInt(item.count.substring(1))*count);};Trader.riseBuyCount=function(item,context){var count=parseInt($('#item_popup_input',context).val());if(!isNaN(count)){count=count+1;$('#item_popup_input',context).val(count);$('#item_popup_max_money',context).text("$"+parseInt(item.count.substring(1))*count);};};Trader.lowerBuyCount=function(item,context){var count=parseInt($('#item_popup_input',context).val());if(!isNaN(count)&&count>1){count=count-1;$('#item_popup_input',context).val(count);$('#item_popup_max_money',context).text("$"+parseInt(item.count.substring(1))*count);};}
ItemUse.use=function(itemId,bonuses,type){var item=Bag.getItemByItemId(itemId);var title="";var message="";switch(type){case'recipe':title='¿Aprender la receta ?';message="<div style='text-align:center'>"+'Aprenderá a hacer un nuevo objeto.'+"</div>";break;default:if(undefined!=item.obj.level&&item.obj.level>Character.level)return new UserMessage(s('El objeto requiere el nivel %1',item.obj.level),UserMessage.TYPE_ERROR).show();if(undefined!=item.obj.duelLevel&&item.obj.duelLevel>Character.duelLevel)return new UserMessage(s('Este objeto requiere de un nivel de duelo de %1!',item.obj.duelLevel),UserMessage.TYPE_ERROR).show();title='¿Utilizar el objeto ?';message="<div style='text-align:center'>"+'¿Desea utilizarlo ? Tendrás las siguientes ventajas :'+"<br /><div style='margin:10px;font-size:12pt;font-weight:bold;'>"+bonuses.join("<br />")+"</div>";if(item.obj.usetype=="buff"){message+="<div style='color: red;margin:10px;font-size:12pt;font-weight:bold;'>";if(BuffList[item.obj.bufftype]!=null)message+='Serán reemplazados los buffs existentes.'+'<br />';message+='El bono desaparece cuando se cancela la tarea.'+"</div>";}if (itemId==1975000){message+='<span style="font-size:9pt;">'+'¿Cómo se abre ?'+'</span><p><input class="open_popup_input" type="text" id="open_popup_input" value="1" style="width:50px;"/>'+'<span class="open_count_scrolls"><img src="https://westfrs.innogamescdn.com/images/scrollbar/scroll_up.png" id="open_rise_count" onclick="javascript:ItemUse.riseOpenCount()"alt="'+'arriba'+'"><img src="https://westfrs.innogamescdn.com/images/scrollbar/scroll_down.png" id="open_lower_count" onclick="javascript:ItemUse.lowerOpenCount()" alt="'+'abajo'+'"></span>';ItemUse.riseOpenCount=function(){var count=parseInt($('#open_popup_input').val());if(!isNaN(count)){count=count+1;$('#open_popup_input').val(count);};};ItemUse.lowerOpenCount=function(){var count=parseInt($('#open_popup_input').val());if(!isNaN(count)&&count>1){count=count-1;$('#open_popup_input').val(count);};}}if($.fn.isInArray(itemId,[21340,21341,21342,21343]))message+='<p>'+'Extender el premium automáticamente cuando tenga pepitas disponibles.'+'<br />'+'Si quieres desactivar esta opción, puedes hacerlo desde las opciones.'+'</p>';break;};if (itemId==1975000){new west.gui.Dialog(title,message,west.gui.Dialog.SYS_QUESTION).addButton("Sí",function(){open(parseInt($('#open_popup_input').val()))}).addButton("Cancelar",function(){}).show();} else {new west.gui.Dialog(title,message,west.gui.Dialog.SYS_QUESTION).addButton("Sí",function(){ItemUse.doIt(itemId);}).addButton("Cancelar",function(){}).show();}}
function open(number){var cnt = 0;var Div=$('<div></div>');var info=$('<div style="font-size:15pt;text-align:center;"><strong>0</strong> / ' +number+'</div>');wman.open('progreso', 'Progresión...').appendToContentPane(info).setSize(250,125);time = setInterval(function(){Ajax.remoteCall("itemuse","use_item",{item_id:1975000,lastInvId:Bag.getLastInvId()},function(res){cnt++;info=$('<div style="font-size:15pt;text-align:center;"><strong>'+cnt+'</strong> / ' +number+'</div>');wman.open('progreso', 'Progresión...').appendToContentPane(info).setSize(250,125);if (cnt >= number){for (x =0; x <res.msg.changes.length;x++){Div.append(new tw2widget.InventoryItem(ItemManager.get(res.msg.changes[x].item_id),'item_popup_item').setCount(res.msg.changes[x].count-Bag.getItemByItemId(res.msg.changes[x].item_id).count).getMainDiv());};EventHandler.signal('inventory_changed'); new west.gui.Dialog("Tienes...",Div).setIcon(west.gui.Dialog.SYS_OK).addButton('ok').show();clearInterval(time)};});},1000);};