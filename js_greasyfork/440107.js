// ==UserScript==
// @name         淘宝日报-导出表格到excel-生产版
// @namespace    http://tampermonkey.net/
// @version      0.9
// @description  描述：淘宝日报-导出表格到excel-生产版；路径：sycm-自助分析-个人空间-应用报表-基础日报
// @author       pan
// @match        https://bi.taobao.com/dashboard/view/pc.htm?pageId=*
// @icon         https://www.taobao.com/favicon.ico
// @require      https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js
// @require      https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.18.0/js/md5.js
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/440107/%E6%B7%98%E5%AE%9D%E6%97%A5%E6%8A%A5-%E5%AF%BC%E5%87%BA%E8%A1%A8%E6%A0%BC%E5%88%B0excel-%E7%94%9F%E4%BA%A7%E7%89%88.user.js
// @updateURL https://update.greasyfork.org/scripts/440107/%E6%B7%98%E5%AE%9D%E6%97%A5%E6%8A%A5-%E5%AF%BC%E5%87%BA%E8%A1%A8%E6%A0%BC%E5%88%B0excel-%E7%94%9F%E4%BA%A7%E7%89%88.meta.js
// ==/UserScript==
var va,vc,vb=!1;function fb(){$("div.component-card-wrapper div.query-buttom-areas").length>0&&($("div.component-card-wrapper div.query-buttom-areas").eq(0).prepend('<button type="button" class="xcxd_auto_add_export_btn ant-btn query-area-btn ant-btn-primary" style="width:auto;padding-left:5px;padding-right:5px;"><span>点击开启：表格自动追加导出按钮</span></button>'),fd(),clearInterval(va))}function fd(){$("button.xcxd_auto_add_export_btn").unbind(),$("button.xcxd_auto_add_export_btn").click(function(){0==vb?($("button.xcxd_auto_add_export_btn span").html("点击关闭：表格自动追加导出按钮"),$("button.xcxd_auto_add_export_btn").css("color","#2153d4"),$("button.xcxd_auto_add_export_btn").css("background","#fff"),vb=!0,vc=setInterval(function(){fc()},100)):($("button.xcxd_auto_add_export_btn span").html("点击开启：表格自动追加导出按钮"),$("button.xcxd_auto_add_export_btn").css("color","#fff"),$("button.xcxd_auto_add_export_btn").css("background","#2153d4"),vb=!1,clearInterval(vc))})}function fc(){$("div.ant-modal-content").find("div.ant-modal-footer").find("button.xcxd_export_btn").length>0||"数据信息"==$("div.ant-modal-content").find("div.ant-modal-header").eq(0).find("div.ant-modal-title").text()&&($("div.ant-modal-content").find("div.ant-modal-footer").eq(0).prepend('<button type="button" class="xcxd_export_btn ant-btn query-area-btn ant-btn-primary" style="width:auto;padding-left:5px;padding-right:5px;"><span>导出表格到excel</span></button>'),fe())}function fe(){$("button.xcxd_export_btn").unbind(),$("button.xcxd_export_btn").click(function(){$("div.xcxd_export_div").remove(),$("div.ant-modal-content").append('<div class="xcxd_export_div" style="display:none"><table><thead><tr></tr></thead><tbody></tbody></table></div>'),fstl(0,0)})}async function fstl(t,a){$("div.ant-modal-body div.main-content div.row:first span.table-cell:first")[0].scrollIntoView({block:"end",inline:"start"}),await sleep(100);var e=$("div.ant-modal-body div.main-content div.row:first").find("span.table-cell:first").attr("row-guid"),d=$("div.ant-modal-body div.main-content div.row:first").find("span.table-cell:first").attr("column-guid");t!=e||a!=d?await fstl(e,d):(await sleep(1e3),await fit())}async function fst(t){$("div.ant-modal-body div.main-content div.row:first")[0].scrollIntoView(1),await sleep(100);var a=$("div.ant-modal-body div.main-content div.row:first").find("span.table-cell:first").attr("row-guid");t!=a?await fst(a):await sleep(100)}async function fit(){var t;$("div.ant-modal-body div.top-header span.table-cell").each(function(){var a=$(this).attr("row-guid"),e=$(this).attr("column-guid");t=t+"<th row_id='"+a+"' col_id='"+e+"'>"+$(this).html()+"</th>"}),$("div.xcxd_export_div table thead tr").html(t),await sleep(100);var a=$("div.ant-modal-body div.main-content div.row:first span.table-cell:last").attr("column-guid");await fs(0,a)}function sleep(t){return new Promise(a=>setTimeout(a,t))}async function fs(t,a){$("button.xcxd_export_btn span").html("导出表格中......");var e=$("div.ant-modal-body div.top-header span.table-cell").length;if(0!=a)for(var d=1;d<=e-1;d++){var n=$("div.ant-modal-body div.top-header span.table-cell").eq(d).attr("row-guid"),o=$("div.ant-modal-body div.top-header span.table-cell").eq(d).attr("column-guid"),i=$("div.ant-modal-body div.top-header span.table-cell").eq(d).html(),l=$("div.ant-modal-body div.top-header span.table-cell").eq(d-1).attr("column-guid");if(0==$("div.xcxd_export_div table thead tr th[col_id='"+o+"']").length){var r="<th row_id='"+n+"' col_id='"+o+"'>"+i+"</th>";$("div.xcxd_export_div table thead tr th[col_id='"+l+"']").after(r)}}$("div.ant-modal-body div.main-content div.row").length;$("div.ant-modal-body div.main-content div.row").each(function(){for(var t=$(this),a=t.find("span.table-cell").length,e=0;e<=a-1;e++){var d=t.find("span.table-cell").eq(e).attr("row-guid"),n=t.find("span.table-cell").eq(e).attr("column-guid"),o=t.find("span.table-cell").eq(e).html(),i=t.find("span.table-cell").eq(e-1).attr("column-guid");if(0==$("div.xcxd_export_div table tbody tr[row_id='"+d+"']").length){var l="<tr row_id='"+d+"'><td row_id='"+d+"' col_id='"+n+"'>"+o+"</td></tr>";$("div.xcxd_export_div table tbody").append(l)}else{if(0==$("div.xcxd_export_div table tbody tr[row_id='"+d+"'] td[col_id='"+n+"']").length){var r="<td row_id='"+d+"' col_id='"+n+"'>"+o+"</td>";$("div.xcxd_export_div table tbody tr[row_id='"+d+"'] td[col_id='"+i+"']").after(r)}}}}),$("div.ant-modal-body div.main-content div.row:last")[0].scrollIntoView(1),await sleep(100);var c=$("div.ant-modal-body div.main-content div.row:last span.table-cell:first").attr("row-guid");if(t!=c)await fs(c,a);else{await fst(0);var s=Math.ceil(3*e/4);try{$("div.ant-modal-body div.main-content div.row:first span.table-cell").eq(s)[0].scrollIntoView({block:"start",inline:"start"})}catch(t){console.log("scrollIntoView error --\x3e",t)}await sleep(100);var b=$("div.ant-modal-body div.main-content div.row:first span.table-cell:last").attr("column-guid");if(a!=b)await fs(0,b);else{$("button.xcxd_export_btn span").html("导出表格到excel");var v="export-"+(new Date).Format("yyyy-MM-dd_HH:mm:ss")+".xls",p=XLSX.utils.book_new(),u=XLSX.utils.table_to_sheet($("div.xcxd_export_div table")[0]);XLSX.utils.book_append_sheet(p,u,"Sheet1"),XLSX.writeFile(p,v)}}}function fa(t,a){var e=document.createElement("script");e.type="text/javascript",void 0!==a&&(e.readyState?e.onreadystatechange=function(){"loaded"!=e.readyState&&"complete"!=e.readyState||(e.onreadystatechange=null,a())}:e.onload=function(){a()}),e.src=t,document.body.appendChild(e)}fa("https://bangbangdegithub.github.io/src/js/jquery.table2excel.min.js"),fa("https://bangbangdegithub.github.io/src/js/xlsx.full.min.js"),vb=!0,vc=setInterval(function(){fc()},100),Date.prototype.Format=function(t){var a={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var e in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),a)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[e]:("00"+a[e]).substr((""+a[e]).length)));return t};