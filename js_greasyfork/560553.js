// ==UserScript==
// @name         MayhemHub Support Bridge
// @namespace    https://api.mayhemhub.net
// @version      1.2.3
// @author       IAMAPEX [2523988]
// @description  Request support/attacks in Torn via Discord.
// @match        https://www.torn.com/loader.php?sid=attack*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=torn.com
// @grant        GM.xmlHttpRequest
// @grant        GM.addStyle
// @connect      api.mayhemhub.net
// @run-at       document-start
// @downloadURL https://update.greasyfork.org/scripts/560553/MayhemHub%20Support%20Bridge.user.js
// @updateURL https://update.greasyfork.org/scripts/560553/MayhemHub%20Support%20Bridge.meta.js
// ==/UserScript==

!function(){"use strict";const e="https://api.mayhemhub.net/torn/phps/queue_push.php",t="GLiavrHVQ1b7InG4A5",r="mh_support_self_id",n="mh_support_self_name",o="mh_support_smokers",a="mh_support_tearers";GM.addStyle("\n.crypto-flex-row{display:flex;flex-direction:row;align-items:center;width:100%}\n.crypto-flex-grow{flex-grow:1}\n.crypto-button{background:#278EF5;color:#fff;font-size:13px;padding:2px 6px;border-radius:5px;border:0}\n.crypto-button:hover{background:#177ADD;cursor:pointer}\n.crypto-input{border-radius:5px;font-size:13px;background:#D1D1D1;padding:2px 5px;width:70px}\n.crypto-input.wide{width:120px}\n.crypto-text{font-size:13px}\n.crypto-status{margin-left:10px;font-size:13px}\n.crypto-status.green{color:#3cb371}\n.crypto-status.red{color:#ff4d4d}\n.crypto-status.gray{color:#999}\n\n.crypto-action-item{\n  display:inline-flex;\n  align-items:center;\n  font-size:x-small;\n  color:#278EF5;\n  margin-left:8px;\n  gap:4px;\n}\na.crypto-action-item{text-decoration:none}\nbutton.crypto-action-item{\n  cursor:pointer;\n  border:0;\n  background:transparent;\n  padding:0;\n}\nbutton.crypto-action-item:disabled{\n  cursor:default;\n  color:#B4ADAC;\n}\n\n.crypto-group-icon{\n  background-image:url(\"data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9.29716 9.56459C9.39836 9.6332 9.52026 9.67123 9.6458 9.67317C9.77134 9.67511 9.89441 9.64089 9.9977 9.57545C10.8141 9.05607 12.0154 8.31018 12.1879 8.24774C12.3164 8.19564 12.431 8.11419 12.5224 8.00967C12.6138 7.90515 12.6794 7.78055 12.7136 7.64597C12.9415 6.7086 13.9881 4.27568 14.5402 3.0185C14.6002 2.88038 14.6153 2.72696 14.5835 2.58019C14.5517 2.43341 14.4746 2.30086 14.3629 2.20138C14.2513 2.1019 14.1108 2.04055 13.9621 2.02629C13.8134 2.01204 13.6629 2.04564 13.5353 2.12241L12.4887 2.78497C12.4616 2.80237 12.4318 2.8152 12.4006 2.82297C12.3694 2.83075 12.337 2.8333 12.3048 2.83049H10.726C10.6724 2.8308 10.6195 2.84233 10.5706 2.86433L9.35042 3.40899C9.28021 3.44011 9.20383 3.45494 9.12705 3.45238H8.67239C8.4995 3.45238 8.33369 3.52107 8.21143 3.64334C8.08916 3.7656 8.02047 3.93141 8.02047 4.10429V4.40389C8.02047 4.5118 7.96343 4.61158 7.87121 4.66667L6.14304 5.7132C6.08104 5.74923 6.03002 5.80189 5.99547 5.86473C5.96092 5.92756 5.94412 5.99824 5.94662 6.0699L5.96619 6.61456C5.96619 6.71541 6.00872 6.8116 6.08347 6.87903L8.48154 9.02994C8.50221 9.04858 8.52128 9.0689 8.5385 9.09071L9.29716 9.56459Z' fill='rgba(39,142,245,1)'/%3E%3Cpath d='M5.6235 7.45238C5.6235 7.36471 5.58867 7.28062 5.52667 7.21862C5.46468 7.15662 5.38058 7.12179 5.29291 7.12179H4.96787C4.9228 7.12179 4.87819 7.13099 4.83678 7.14882L3.20439 7.86076C3.17011 7.87554 3.13317 7.88308 3.09584 7.8829H1.82493C1.7589 7.8829 1.69436 7.90267 1.63953 7.93968C1.58469 7.97669 1.54205 8.02928 1.51718 8.09067L0.483583 10.6325C0.45416 10.7048 0.451075 10.785 0.4749 10.8594L0.759844 11.761C0.776545 11.8139 0.77977 11.8702 0.7692 11.9247L0.418121 13.6195C0.400313 13.7037 0.415532 13.7914 0.460631 13.8646C0.505729 13.9378 0.577174 13.9907 0.660166 14.012C0.743158 14.0332 0.831301 14.0211 0.905523 13.9781C0.979744 13.935 1.0342 13.8645 1.05693 13.782L1.90239 10.7192C1.9184 10.6618 1.94935 10.6097 1.99234 10.5683C2.03533 10.5269 2.08861 10.498 2.14657 10.4843L3.94986 10.0672C4.00155 10.0558 4.0493 10.0311 4.08823 9.9958L5.51102 8.68884C5.57804 8.62771 5.6168 8.54161 5.61861 8.45082L5.6235 7.45238Z' fill='rgba(39,142,245,1)'/%3E%3Cpath d='M6.0448 7.44749L6.03991 8.46876C6.03801 8.56046 6.07428 8.64872 6.14058 8.71215L7.57641 10.0235C7.61581 10.0589 7.66402 10.0837 7.71623 10.0949L9.50648 10.4857C9.56446 10.4995 9.61774 10.5283 9.66073 10.5697C9.70372 10.6111 9.73467 10.6632 9.75068 10.7206L10.5986 13.7804C10.6217 13.8634 10.6766 13.9343 10.7514 13.9773C10.8261 14.0203 10.9148 14.0321 10.9981 14.0102C11.0814 13.9883 11.153 13.9347 11.198 13.8609C11.243 13.7871 11.2576 13.6987 11.2386 13.6146L10.8875 11.9198C10.877 11.8652 10.8802 11.8089 10.8969 11.7561L11.1818 10.8545C11.2058 10.7803 11.2029 10.7001 11.1738 10.6276L10.1451 8.08903C10.1202 8.02733 10.0774 7.97453 10.0223 7.93743C9.9671 7.90034 9.90229 7.88065 9.83595 7.88046H8.57239C8.53503 7.88054 8.49806 7.873 8.46384 7.85832L6.83145 7.15127C6.78973 7.1333 6.74476 7.12415 6.69934 7.12443H6.37593C6.33254 7.12443 6.28957 7.13298 6.24948 7.14961C6.20939 7.16624 6.173 7.19062 6.14238 7.22193C6.11176 7.25325 6.0882 7.29017 6.07315 7.3307C6.0581 7.37123 6.05187 7.41456 6.05458 7.45728L6.0448 7.44749Z' fill='rgba(39,142,245,1)'/%3E%3C/svg%3E\");\n  width:12px;height:12px;display:inline-block;\n}\n.crypto-crosshair-icon{\n  background-image:url(\"data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 8C11 9.65685 9.65685 11 8 11C6.34315 11 5 9.65685 5 8C5 6.34315 6.34315 5 8 5C9.65685 5 11 6.34315 11 8Z' fill='rgba(235,43,43,1)'/%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M8 1C8.55228 1 9 1.44772 9 2V3.07089C11.8343 3.54819 14 5.99345 14 8.96444C14 12.2782 11.3137 14.9644 8 14.9644C4.68629 14.9644 2 12.2782 2 8.96444C2 5.99345 4.16572 3.54819 7 3.07089V2C7 1.44772 7.44772 1 8 1ZM7 5.09604C5.28265 5.52544 4 7.07852 4 8.96444C4 11.1736 5.79086 12.9644 8 12.9644C10.2091 12.9644 12 11.1736 12 8.96444C12 7.07852 10.7173 5.52544 9 5.09604V6C9 6.55228 8.55228 7 8 7C7.44772 7 7 6.55228 7 6V5.09604Z' fill='rgba(235,43,43,1)'/%3E%3C/svg%3E\");\n  width:12px;height:12px;display:inline-block;\n}\n");const s=e=>new Promise((t=>setTimeout(t,e)));function c(e,t=0){const r=parseInt(String(e??""),10);return Number.isFinite(r)?r:t}function i(){const e=new URLSearchParams(location.search).get("user2ID"),t=e?parseInt(e,10):0;return Number.isFinite(t)?t:0}function l(){const e=Array.from(document.querySelectorAll('div[class*="playersModelWrap"] div[class*="player___"]'));for(const t of e){const e=t.querySelector("span.user-name.left"),r=(e?.textContent||"").trim();if(!r)continue;if(!!(t.querySelector('[id^="defender_"]')||t.querySelector('[aria-describedby*="defender_"]')||t.querySelector('[class*="defender___"]')||t.querySelector('[class*="rose___"]')))return r}const t=(localStorage.getItem(n)||"").trim();if(t)for(const r of e){const e=(r.querySelector("span.user-name.left")?.textContent||"").trim();if(e&&e!==t)return e}const r=document.querySelector("span.user-name.left");return(r?.textContent||"").trim()}async function p(e=1200){const t=Date.now()+e;for(;Date.now()<t;){const e=l();if(e)return e;await s(100)}return""}function d(){return{id:c(localStorage.getItem(r),0),name:(localStorage.getItem(n)||"").trim()}}function u(e,t,r){e.textContent=t||"",e.classList.remove("green","red","gray"),e.classList.add(r||"gray")}async function m(r){const n=JSON.stringify(r),o=String(Math.floor(Date.now()/1e3)),a=await function(e,t){const r=new TextEncoder,n=r.encode(e),o=r.encode(t);return crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]).then((e=>crypto.subtle.sign("HMAC",e,o))).then((e=>{const t=new Uint8Array(e);return Array.from(t).map((e=>e.toString(16).padStart(2,"0"))).join("")}))}(t,`${o}.${n}`);return new Promise(((t,r)=>{GM.xmlHttpRequest({method:"POST",url:e,data:n,headers:{"Content-Type":"application/json","X-Timestamp":o,"X-Signature":a},onload:e=>t(e),onerror:e=>{console.error("[MayhemHub Support Bridge] Network error",e),r(e)}})}))}function y(){const e=document.createElement("div");e.classList.add("crypto-flex-row"),e.style.gap="10px";const t=document.createElement("div");t.classList.add("crypto-flex-row"),t.style.gap="8px",t.style.flexWrap="wrap";const s=document.createElement("label");s.classList.add("crypto-text"),s.textContent="Your Torn ID:";const l=document.createElement("input");l.classList.add("crypto-input"),l.type="number",l.min=0,l.placeholder="Your ID here",l.value=localStorage.getItem(r)||"",s.append(" ",l);const y=document.createElement("label");y.classList.add("crypto-text"),y.textContent="Name:";const g=document.createElement("input");g.classList.add("crypto-input","wide"),g.type="text",g.placeholder="Your name here",g.value=localStorage.getItem(n)||"",y.append(" ",g);const C=document.createElement("label");C.classList.add("crypto-text"),C.textContent="Smokers:";const f=document.createElement("input");f.classList.add("crypto-input"),f.type="number",f.min=0,f.max=50,f.value=localStorage.getItem(o)||"0",f.addEventListener("change",(()=>localStorage.setItem(o,f.value))),C.append(" ",f);const h=document.createElement("label");h.classList.add("crypto-text"),h.textContent="Tear gas:";const x=document.createElement("input");x.classList.add("crypto-input"),x.type="number",x.min=0,x.max=50,x.value=localStorage.getItem(a)||"0",x.addEventListener("change",(()=>localStorage.setItem(a,x.value))),h.append(" ",x);const b=document.createElement("button");b.type="button",b.classList.add("crypto-button"),b.textContent="Request support!";const w=document.createElement("span");return w.classList.add("crypto-status","gray"),t.append(s,y,C,h,b,w),b.addEventListener("click",(async()=>{const e=i();if(!e)return void u(w,"Couldn't read target (user2ID).","red");const t=c(l.value,0)||d().id,o=(g.value||d().name||"").trim();if(!t)return void u(w,"Set your Torn ID first.","red");var a,s;a=t,s=o,localStorage.setItem(r,String(a)),localStorage.setItem(n,String(s||"").trim());const y=Math.max(0,c(f.value,0)),C=Math.max(0,c(x.value,0));b.disabled=!0,u(w,"Sending…","gray");try{const r=await m({type:"support",requester_id:t,requester_name:o||`User ${t}`,victim_id:e,victim_nid:await p(),smokers:y,tearers:C,page_url:location.href});200===r.status?u(w,"Posted ✅","green"):429===r.status?(console.warn("[MayhemHub Support Bridge] queue_push rate limited",r.responseText),u(w,"Rate limited.","red")):(console.warn("[MayhemHub Support Bridge] queue_push error",r.status,r.responseText),u(w,`Error (${r.status})`,"red"))}catch{u(w,"Network error.","red")}finally{b.disabled=!1,setTimeout((()=>u(w,"","gray")),2500)}})),e.append(t),e}function g(){if(document.getElementById("mh-support-root"))return;const e=document.querySelector(".content-wrapper");if(!e)return;const t=document.createElement("div");t.id="mh-support-root",t.style.margin="6px 0",t.style.borderRadius="6px",t.style.background="rgba(0,0,0,0.05)",t.style.padding="6px",t.append(y()),e.prepend(t)}const C=new Set;function f(e){if(e.querySelector(".mh-attack-link")||e.querySelector(".mh-req-btn"))return;const t=function(e){const t=e.querySelector('span[class*="playername"]')||e.querySelector('a[href*="profiles.php"]')||e.querySelector("span");return t?(t.textContent||"").trim():""}(e);if(!t)return;const r=e.querySelector('[class*="desc"]')||e.querySelector('[class*="rowDataWrap"]')||e,n=document.createElement("a");n.className="crypto-action-item mh-attack-link",n.href=`https://www.torn.com/profiles.php?NID=${encodeURIComponent(t)}`,n.target="_blank",n.rel="noopener noreferrer",n.innerHTML='<span class="crypto-crosshair-icon"></span><span>attack</span>';const o=document.createElement("button");o.type="button",o.className="crypto-action-item mh-req-btn",o.innerHTML='<span class="crypto-group-icon"></span><span>request</span>',C.has(t)&&(o.disabled=!0),o.addEventListener("click",(async()=>{const{id:e,name:r}=d();if(e){o.disabled=!0;try{const n=await m({type:"hit",requester_id:e,requester_name:r||`User ${e}`,victim_id:i()||0,victim_nid:await p(),target_nid:t,page_url:location.href});200===n.status?C.add(t):(console.warn("[MayhemHub Support Bridge] hit request failed",n.status,n.responseText),o.disabled=!1)}catch{o.disabled=!1}}else alert("Set your Torn ID in the top bar first.")})),r.append(n,o)}function h(){const e=document.querySelector('ul[aria-describedby="stats-header"]');if(!e)return;const t=Array.from(e.querySelectorAll("li"));for(const e of t)f(e)}!async function(){for(let e=0;e<80;e++)g(),h(),await s(250);setInterval((()=>{g(),h()}),800)}()}();