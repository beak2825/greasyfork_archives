// ==UserScript==
// @name         WME Forum Chat Indicator
// @description  Add indication if user has unread forum chat items
// @namespace    https://greasyfork.org/users/gad_m/wme_forum_chat_indicator
// @version      0.1.14
// @author       gad_m
// @license      MIT
// @include 	 /^https:\/\/(www|beta)\.waze\.com\/(?!user\/)(.{2,6}\/)?editor.*$/
// @exclude      https://www.waze.com/user/*editor/*
// @exclude      https://www.waze.com/*/user/*editor/*
// @grant        GM_xmlhttpRequest
// @connect      waze.com
// @icon         data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAAMO2lDQ1BJQ0MgUHJvZmlsZQAASImVVwdYU8kWnltSSWiBCEgJvQkivUgJoQUQkA42QhIglBgDQcWOLiq4FlREwYauiii6FkDWithdBHtfLKgo62LBrrxJAV32le/N9507/z1z5j9nzp2ZOwOAxnGeRJKLagKQJy6QxoYGspJTUlmkJ4AMtKHQAJHHz5ewY2IiASwD9d/Lu+sAkddXHORc/2z/r0VLIMznA4DEQJwuyOfnQXwAALyaL5EWAECU682nFkjkGArQkcIAIV4kx5lKXC3H6Uq8V2ETH8uBuBUAMo3Hk2YCoN4O9axCfibkUO+F2EksEIkB0GBB7JeXN1kAcRrENtBGArGc3zP9B57Mv3GmD3LyeJmDWDkWRSEHifIlubzp/2c6/nfJy5UN+LCCQsuShsXKxwzzdjNncoQc0yDuEadHRUOsDfEHkUBhDzFKzZKFJSjtUUN+PgfmDDAhdhLwgiIgNoQ4RJwbFanSp2eIQrgQwxmCThMVcOMh1oN4kTA/OE5ls0k6OVblC23IkHLYKv1ZnlThV+7rviwnga3if50l5Kr4MfWirPgkiKkQWxSKEqMgVofYMT8nLkJlM7ooixM1YCOVxcrjt4A4VigODVTyY4UZ0pBYlX1pXv7AeLFNWSJulArvK8iKD1PmB2vl8xTxw7Fg7UIxO2GAR5ifHDkwFoEwKFg5duyZUJwQp+L5ICkIjFX2xamS3BiVPW4mzA2V680gds0vjFP1xRML4IRU8uMZkoKYeGWceFE2LzxGGQ++HEQCDggCLCCDkg4mg2wgautp7IFvypYQwANSkAmEwEGlGeiRpGgRw2ccKAJ/QiQE+YP9AhWtQlAI9V8HtcqnA8hQtBYqeuSAJxDngQiQC99lil7iQW+J4DHUiP7hnQeFD+PNhSJv//f6Ae13DRtqIlUa2YBHlsaAJTGYGEQMI4YQbXED3A/3wSPhMwCKM+6Jew2M47s94Qmhg/CQcI3QSbg1SVQsHRLlGNAJ+UNUuUj/MRe4FeR0wwNxX8gOmXEmbgAccFfoh437Q89uUMtRxS3PCmsI999G8MPXUNlRnCgoZRglgGIztKe6nbrbIIs81z/mRxlr+mC+OYMtQ/1zfsi+ANYRQy2xRdh+7Ax2AjuHHcYaAQs7hjVhF7Ejcjw4ux4rZteAt1hFPDmQR/QPfwNfVp7JfKc6p26nL8q2AuE0+R4NOJMl06WizKwCFhv+EYQsrpjvOILl7OTsDID8/6Lcvt4wFf8NhHn+u24+XOO+4v7+/sPfdRGfADhgCpd/53ed9WW4TcB9+uwKvkxaqNTh8gcB7hIacKXpA2NgDmzgeJyBO/ABASAYhINoEA9SwEQYfRac51IwFcwE80AJKAPLwWqwDmwEW8AOsBvsA43gMDgBToMLoB1cA3fg7OkCL0AveAc+IwhCQugIA9FHTBBLxB5xRjwRPyQYiURikRQkDclExIgMmYnMR8qQcmQdshmpRX5FDiEnkHNIB3ILeYB0I6+RTyiG0lAd1Ai1QkeinigbjUDj0QloJjoFLUIXoEvRSrQG3YU2oCfQC+g1tBN9gfZhAFPDmJgp5oB5YhwsGkvFMjApNhsrxSqwGqwea4bf+QrWifVgH3EizsBZuAOcwWF4As7Hp+Cz8SX4OnwH3oC34lfwB3gv/o1AJxgS7AneBC4hmZBJmEooIVQQthEOEk7BtdRFeEckEplEa6IHXIspxGziDOIS4nriHuJxYgfxEbGPRCLpk+xJvqRoEo9UQCohrSXtIh0jXSZ1kT6Q1cgmZGdyCDmVLCYXkyvIO8lHyZfJT8mfKZoUS4o3JZoioEynLKNspTRTLlG6KJ+pWlRrqi81nppNnUetpNZTT1HvUt+oqamZqXmpjVUTqc1Vq1Tbq3ZW7YHaR5o2zY7GoY2nyWhLadtpx2m3aG/odLoVPYCeSi+gL6XX0k/S79M/qDPUHdW56gL1OepV6g3ql9VfalA0LDXYGhM1ijQqNPZrXNLo0aRoWmlyNHmaszWrNA9p3tDs02JojdKK1srTWqK1U+uc1jNtkraVdrC2QHuB9hbtk9qPGBjDnMFh8BnzGVsZpxhdOkQdax2uTrZOmc5unTadXl1tXVfdRN1pulW6R3Q7mRjTisll5jKXMfcxrzM/DTMaxh4mHLZ4WP2wy8Pe6w3XC9AT6pXq7dG7pvdJn6UfrJ+jv0K/Uf+eAW5gZzDWYKrBBoNTBj3DdYb7DOcPLx2+b/htQ9TQzjDWcIbhFsOLhn1GxkahRhKjtUYnjXqMmcYBxtnGq4yPGnebMEz8TEQmq0yOmTxn6bLYrFxWJauV1WtqaBpmKjPdbNpm+tnM2izBrNhsj9k9c6q5p3mG+SrzFvNeCxOLMRYzLeosbltSLD0tsyzXWJ6xfG9lbZVktdCq0eqZtZ4117rIus76rg3dxt9mik2NzVVboq2nbY7tett2O9TOzS7Lrsrukj1q724vsl9v3zGCMMJrhHhEzYgbDjQHtkOhQ53DA0emY6RjsWOj48uRFiNTR64YeWbkNyc3p1ynrU53RmmPCh9VPKp51GtnO2e+c5XzVRe6S4jLHJcml1eu9q5C1w2uN90YbmPcFrq1uH1193CXute7d3tYeKR5VHvc8NTxjPFc4nnWi+AV6DXH67DXR2937wLvfd5/+Tj45Pjs9Hk22nq0cPTW0Y98zXx5vpt9O/1Yfml+m/w6/U39ef41/g8DzAMEAdsCnrJt2dnsXeyXgU6B0sCDge853pxZnONBWFBoUGlQW7B2cELwuuD7IWYhmSF1Ib2hbqEzQo+HEcIiwlaE3eAacfncWm5vuEf4rPDWCFpEXMS6iIeRdpHSyOYx6JjwMSvH3I2yjBJHNUaDaG70yuh7MdYxU2J+G0scGzO2auyT2FGxM2PPxDHiJsXtjHsXHxi/LP5Ogk2CLKElUSNxfGJt4vukoKTypM7kkcmzki+kGKSIUppSSamJqdtS+8YFj1s9rmu82/iS8dcnWE+YNuHcRIOJuROPTNKYxJu0P42QlpS2M+0LL5pXw+tL56ZXp/fyOfw1/BeCAMEqQbfQV1gufJrhm1Ge8SzTN3NlZneWf1ZFVo+II1onepUdlr0x+31OdM72nP7cpNw9eeS8tLxDYm1xjrh1svHkaZM7JPaSEknnFO8pq6f0SiOk2/KR/An5TQU68CB/UWYj+0n2oNCvsKrww9TEqfunaU0TT7s43W764ulPi0KKfpmBz+DPaJlpOnPezAez2LM2z0Zmp89umWM+Z8Gcrrmhc3fMo87Lmfd7sVNxefHb+UnzmxcYLZi74NFPoT/VlaiXSEtuLPRZuHERvki0qG2xy+K1i7+VCkrPlzmVVZR9WcJfcv7nUT9X/ty/NGNp2zL3ZRuWE5eLl19f4b9iR7lWeVH5o5VjVjasYq0qXfV29aTV5ypcKzauoa6RremsjKxsWmuxdvnaL+uy1l2rCqzaU21Yvbj6/XrB+ssbAjbUbzTaWLbx0ybRppubQzc31FjVVGwhbinc8mRr4tYzv3j+UrvNYFvZtq/bxds7d8TuaK31qK3dabhzWR1aJ6vr3jV+V/vuoN1N9Q71m/cw95TtBXtle5//mvbr9X0R+1r2e+6vP2B5oPog42BpA9IwvaG3MauxsymlqeNQ+KGWZp/mg785/rb9sOnhqiO6R5YdpR5dcLT/WNGxvuOS4z0nMk88apnUcudk8smrrWNb205FnDp7OuT0yTPsM8fO+p49fM773KHznucbL7hfaLjodvHg726/H2xzb2u45HGpqd2rvbljdMfRy/6XT1wJunL6KvfqhWtR1zquJ1y/eWP8jc6bgpvPbuXeenW78PbnO3PvEu6W3tO8V3Hf8H7NH7Z/7Ol07zzyIOjBxYdxD+884j968Tj/8ZeuBU/oTyqemjytfeb87HB3SHf783HPu15IXnzuKflT68/qlzYvD/wV8NfF3uTerlfSV/2vl7zRf7P9revblr6Yvvvv8t59fl/6Qf/Djo+eH898Svr09PPUL6QvlV9tvzZ/i/h2tz+vv1/Ck/IURwEMCpqRAcDr7QDQUwBgwPsZdZzy/qcoiPLOqkDgP2HlHVFR3AGoh5X8GM85DsBeKFZzITcU+RE+PgCgLi6DMnBXU9wr5YUI7wGbAuTomp4oGQwpyjvnD3EPrYGc1RUMrf8Fdmx6qfQOqGsAAACWZVhJZk1NACoAAAAIAAUBEgADAAAAAQABAAABGgAFAAAAAQAAAEoBGwAFAAAAAQAAAFIBKAADAAAAAQACAACHaQAEAAAAAQAAAFoAAAAAAAAAkAAAAAEAAACQAAAAAQADkoYABwAAABIAAACEoAIABAAAAAEAAAAkoAMABAAAAAEAAAAkAAAAAEFTQ0lJAAAAU2NyZWVuc2hvdH6Ods0AAAAJcEhZcwAAFiUAABYlAUlSJPAAAALVaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA2LjAuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOmV4aWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vZXhpZi8xLjAvIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDxleGlmOlBpeGVsWERpbWVuc2lvbj43NDwvZXhpZjpQaXhlbFhEaW1lbnNpb24+CiAgICAgICAgIDxleGlmOlVzZXJDb21tZW50PlNjcmVlbnNob3Q8L2V4aWY6VXNlckNvbW1lbnQ+CiAgICAgICAgIDxleGlmOlBpeGVsWURpbWVuc2lvbj43NDwvZXhpZjpQaXhlbFlEaW1lbnNpb24+CiAgICAgICAgIDx0aWZmOlJlc29sdXRpb25Vbml0PjI8L3RpZmY6UmVzb2x1dGlvblVuaXQ+CiAgICAgICAgIDx0aWZmOllSZXNvbHV0aW9uPjE0NDwvdGlmZjpZUmVzb2x1dGlvbj4KICAgICAgICAgPHRpZmY6WFJlc29sdXRpb24+MTQ0PC90aWZmOlhSZXNvbHV0aW9uPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4Kru+YjAAABx9JREFUWAntVmlMVFcU/mZ7zLANROIGNCKI0UZcaAUtLmBFxYg1YpMarXGhWm3/tJr+aRObxtRqf1lTqzV1bd3QVqvWutSKKGgrKCCKYEAQhBmVkZEZmJk3r+fexxtGmQHU/jBNbzLv3bn3nHO/+53tqSQaeImG+iXCwqH8hwExzyveV4LAe62HrlC9cAyxQ1Wqro/jQEmmGzFmRNu1pW52nwLjarHBZW+FpJLobBWEoECo9foOwE/J+7L+3IBYcqrambHfa0TDuTw8PHEO9rMlEEUHtCHBCJryGiImj0fvN8ZACAuVgXUD6plcxkBweyAwajkfTBcuoWLZathKT0DolwxNTATFkook3BDz78KFazC+nY341SthHBIvk9IFqB4BUkqVwohC9b0/clE2aQK00WMhjIqFaLZAvFhDUB5AHR4J7bB+9A5G6+ErUKMFw6+fRNjQwV2C6haQ2+2Gup0NZkkURag1GjyurEJxRjZc1hYIiQPhvHoHYt1tGKamQoiJgr2gFM6iaqjj+kA3JAqtv15B8JwUDN+8HkK4Uc5IH8nQZQwxZhQwTU1NKLpSiFs1d5CRmgaQq6wVZ2DMnAdXdSOkOgsiN3+JV2ZkQAgNxuOGRlRt2QnLukNw6TXQZybCcuB7NM6fhegZ0/zGk9/CqASt0+XCqdNnkL1sOSZNfhOn8wugIVYsF/8iNzC7KjiLTyFoQSrilyyAJsiAmqO/IzQ2BrHLF0E9IAxi6X1IrRToGIr7J3Mh2uyy23w8fTKkgGmhNN62fTs+/GAFqaqx9qt1mJk1G0FkvGLLbuiHT4ZotVGCG6EyBMD8dxGqNm5F065NiJzaTOACgXADwBh0uKBJ6A/bsctwfNYCQyCt+yhMnQApYFis7Ni5k4NZkr0USxYvQmLiKGi1WpiLSyHCBC2BcD+0Qpc4BrbLpSj8LhGBQjLGVNdAZwxBzfY9EIvKoBkxBJK9jWemq95CGaiU8s4UPeEyBQwTy809jxXL38fCxdlYtepjJCWN5mDYHlPSwACJAp5nnkGAq7AEoSmzkFC6G6HRUSjfsAUVC+dCFRUNlV6A1OYiRRXUgs4HL8yqPJ4ApCxarVZ88+0mYjQcixYuQPygQRAplpwOBxcJCAmBMCIVblMz1L1C4cqrQdCcDCTs3gDjoFg8vlMDbZgRsVt3IiAhBmKZCerQQIi1FhimJ0DLqjcfnZnqAMRbktxsyspu4Oec/Vj9+UdIGj2aq7rpqdXIHtb37YPA6WPhrM6TAeEqjONHQ987Ak67HWqKj4Hz5iAyPQ0ayjh3cy00vcPgNF9C+LSJ0IWGyHh8PD0xxPzK+g8bFZWV/J2clASdTgcXsaOj2FGG1qBH3Duz0bTmUzir6mEY/xYeHD0Da1k5VMwl5CJQrXI/sqLtVg0C0sbCcb0ahogU9E0dp5iRU7/jH591nNK+wYK5tvYu/xcdFcXfGjJeV1eH0utleJ0FNlHeTDePzzmM0qyZCEzOgMolwrppI12rjeswZ6jRB0L6BLhqzXDcOItXqbIHRUfyfbkHdW7/XoDkTcaGyWwiJS2xI2+zwC0sLEJm5gwUF5dQsVRh5Rdr8MPatRiWcwTXszIpyAFhXCbUxmAq59THnE6Id+6j9eR+CLpkDDl+Cv0mtrPTRS/zAsTuRJ8MgoBoyhJQW7Q8ekRvVuUlJCcn4cKFi4iJieGfP58se4+ndsTsGdDkX0bjsVN4/EsuWs8fIU1QDg5GSFYKApdmoV9GOsLaG6t3JnPjTz9IgA/qWcpUOpBzkKGTftqzl6+RGz17/iai3S5Zyislc+E1qfnmLel+UbFkLiuXxDaHR8XdAzueLPPu5AkJwzju47+dQH19Pe9nzJVk+YkfE2K1iA+KK2N8LMJHJuCq5SG25efhQYCO1x0WL7xmeTVpWcnH0wOfJgpLNptNmjvvXc7SlcJCLuJwOPi+IsPe/Ee7bW1tktR++7Nn/+R6g4cOl+7V3+O6PWGYC9KD3bjTaGhokKLihkrzFyyUTCYz33c6nR45doDyUwCyzYKCS1L61AwOKD+/wCPvLeNZ9DPxAPJWUm65Z+8+P2pPLrML5Bw8JKVMTONg9u7b72H7WdhhVr2yrMOfxSUl/E9AQADoMFRW3kbt3bswmUzQU6zEDBgADRVKa3MzGhobkUfZ9+OuHVzn6NFjmDIlnfc48qrne6rDejcz5a7eDOW0Z1na5Cn8xmSim7deWrf+a+nmzXLFnOQWO7LWs9iDic9P2JaWFlDK4yJ9jI0cOQIDqfYMiouD0WhEVVUVZ4suAMZgRK9eVJsGoH///h426Fz5K6AbMnxt+wTEBNmBNvqyCw4O8qXnd+1FwDCjfgH5OpEuzqu07z3mVbYvtyBfMj1Z8wuI3dR7KAc9vc5klD1v+eed+wX0vAZfVM/TOl7U0L+l/z+g7pj8B4ED8vOOCcIoAAAAAElFTkSuQmCC
// @downloadURL https://update.greasyfork.org/scripts/450472/WME%20Forum%20Chat%20Indicator.user.js
// @updateURL https://update.greasyfork.org/scripts/450472/WME%20Forum%20Chat%20Indicator.meta.js
// ==/UserScript==

/* global W */
/* global jQuery */
/* global ChatSDK */

(function() {

    console.info('wme-forum-chat-indicator: script loading...');
    //"https://www.waze.com/chat/sdk/v1"
    const ChatSDK_=function(e){var t={};function i(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)i.d(n,o,function(t){return e[t]}.bind(null,o));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=4)}([function(e,t,i){(t=i(7)(!1)).push([e.i,".iEq5RN8t4YhcS87dFFLCN{--waze-header-height: 56px;--waze-chat-container-width: 100%;--waze-chat-z-index: var(\n    --waze-chat-option-z-index,\n    4\n  );--waze-chat-z-index-keyboard-open: 2147483647;--waze-viewport-offset-top: 0px;--waze-chat-offset-bottom: var(--waze-chat-option-offset-bottom, 0px);position:fixed;top:calc(var(--waze-viewport-offset-top) + var(--waze-header-height));right:0;width:var(--waze-chat-container-width);height:calc( var(--waze-viewport-height, 100%) - var(--waze-header-height) - var(--waze-chat-offset-bottom));box-shadow:0 1px 2px 0 rgba(60,64,67,0.3),0 1px 3px 1px rgba(60,64,67,0.15);transform:translateX(100%);transition:all 0.3s ease 0s;transition-property:visibility, transform;visibility:hidden;z-index:var(--waze-chat-z-index)}._18oJSOFPVApLWzpTvysjrb{transform:translateX(0);visibility:visible}._2hSZ_d6Ih8DPXnZSzbiyev{top:var(--waze-viewport-offset-top, 0);height:var(--waze-viewport-height, 100%);z-index:var(--waze-chat-z-index-keyboard-open)}@media not screen and (max-width: 600px){.iEq5RN8t4YhcS87dFFLCN{--waze-header-height: 64px;--waze-chat-container-width: 375px}}.QHePh__PQbIugMr1SN6Sv{position:absolute;width:100%;height:100%;left:0;top:0;border:none}\n",""]),t.locals={container:"iEq5RN8t4YhcS87dFFLCN",containerOpen:"_18oJSOFPVApLWzpTvysjrb",containerKeyboardOpen:"_2hSZ_d6Ih8DPXnZSzbiyev",iframe:"QHePh__PQbIugMr1SN6Sv"},e.exports=t},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AppMode=void 0,function(e){e.App="app",e.Embed="embed",e.MobileWeb="mobile-web"}(t.AppMode||(t.AppMode={}))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Orientation=t.DeviceType=void 0,function(e){e.IOS="ios",e.Android="android",e.Other="other"}(t.DeviceType||(t.DeviceType={})),function(e){e.Portrait="portrait",e.Landscape="landscape"}(t.Orientation||(t.Orientation={}))},function(e,t,i){"use strict";var n,o=function(){return void 0===n&&(n=Boolean(window&&document&&document.all&&!window.atob)),n},r=function(){var e={};return function(t){if(void 0===e[t]){var i=document.querySelector(t);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(e){i=null}e[t]=i}return e[t]}}(),s=[];function a(e){for(var t=-1,i=0;i<s.length;i++)if(s[i].identifier===e){t=i;break}return t}function c(e,t){for(var i={},n=[],o=0;o<e.length;o++){var r=e[o],c=t.base?r[0]+t.base:r[0],d=i[c]||0,h="".concat(c," ").concat(d);i[c]=d+1;var l=a(h),p={css:r[1],media:r[2],sourceMap:r[3]};-1!==l?(s[l].references++,s[l].updater(p)):s.push({identifier:h,updater:g(p,t),references:1}),n.push(h)}return n}function d(e){var t=document.createElement("style"),n=e.attributes||{};if(void 0===n.nonce){var o=i.nc;o&&(n.nonce=o)}if(Object.keys(n).forEach((function(e){t.setAttribute(e,n[e])})),"function"==typeof e.insert)e.insert(t);else{var s=r(e.insert||"head");if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(t)}return t}var h,l=(h=[],function(e,t){return h[e]=t,h.filter(Boolean).join("\n")});function p(e,t,i,n){var o=i?"":n.media?"@media ".concat(n.media," {").concat(n.css,"}"):n.css;if(e.styleSheet)e.styleSheet.cssText=l(t,o);else{var r=document.createTextNode(o),s=e.childNodes;s[t]&&e.removeChild(s[t]),s.length?e.insertBefore(r,s[t]):e.appendChild(r)}}function u(e,t,i){var n=i.css,o=i.media,r=i.sourceMap;if(o?e.setAttribute("media",o):e.removeAttribute("media"),r&&"undefined"!=typeof btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}var f=null,v=0;function g(e,t){var i,n,o;if(t.singleton){var r=v++;i=f||(f=d(t)),n=p.bind(null,i,r,!1),o=p.bind(null,i,r,!0)}else i=d(t),n=u.bind(null,i,t),o=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(i)};return n(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;n(e=t)}else o()}}e.exports=function(e,t){(t=t||{}).singleton||"boolean"==typeof t.singleton||(t.singleton=o());var i=c(e=e||[],t);return function(e){if(e=e||[],"[object Array]"===Object.prototype.toString.call(e)){for(var n=0;n<i.length;n++){var o=a(i[n]);s[o].references--}for(var r=c(e,t),d=0;d<i.length;d++){var h=a(i[d]);0===s[h].references&&(s[h].updater(),s.splice(h,1))}i=r}}}},function(e,t,i){"use strict";const n=i(5);let o;const r={create:function(e){if(!o){const t=new n.ChatSDK(e);o=t.bootstrap().then(()=>t)}return o}},s=Object.assign(Object.assign({},r),{reset:function(){o=null}});e.exports=s},function(e,t,i){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ChatSDK=void 0;const o=n(i(6)),r=i(8),s=i(1),a=i(9),c=i(10),d=i(11),h=i(15);class l{constructor(e){var t;this.options=e,this.callbacks=new Set,this.visible=!1,this.unreadCount=0,this.bootstrap=()=>(this.bootstrapPromise||(this.bootstrapPromise=new Promise((e,t)=>{this.initContainer(),this.initIFrame(),this.initMessageService(),this.initVisibilityMessageListener(),this.initUnreadCountMessageListener(),this.receiveReadyMessage().then(e,t)})),this.bootstrapPromise),this.getVisibility=()=>this.visible,this.setVisibility=e=>{this.nonEmptyMessageService.postMessage({type:h.MessageType.ChatSetVisibility,visible:e})},this.startChat=(e,{userName:t,userPhotoUrl:i}={})=>{this.nonEmptyMessageService.postMessage({type:h.MessageType.ChatOpenConversation,userId:e,userName:t,userPhotoUrl:i})},this.getUnreadChatCount=()=>this.unreadCount,this.subscribe=e=>{this.callbacks.add(e)},this.unsubscribe=e=>{this.callbacks.delete(e)},this.execCallbacks=()=>{this.callbacks.forEach(e=>e())},this.initUnreadCountMessageListener=()=>{this.logger.info("setting up listener"),this.nonEmptyMessageService.initListener(e=>{e.type===h.MessageType.ChatUnreadCount&&(this.unreadCount=e.count,this.execCallbacks())})},this.initVisibilityMessageListener=()=>{this.logger.info("setting up listener"),this.nonEmptyMessageService.initListener(e=>{e.type===h.MessageType.ChatVisibility&&(this.visible=e.visible,this.nonEmptyViewport.containerElement.classList.toggle(o.default.containerOpen,e.visible))})},this.receiveReadyMessage=async()=>{this.logger.info("waiting for ready event"),await this.nonEmptyMessageService.receiveMessage(e=>e.type===h.MessageType.ChatReady?e:void 0)},this.logger=new a.ClientLogger("SDK",null!==(t=this.options.verbose)&&void 0!==t&&t),null==this.options.appIdentifierName&&(this.options.appIdentifierName="APP_IDENTIFIER_UNSPECIFIED",this.logger.info(`'options.appIdentifierName' missing. Falling back to default '${this.options.appIdentifierName}'`))}static getBootstrapValue(e){if(void 0===e)throw new Error("please bootstrap first");return e}get nonEmptyViewport(){return l.getBootstrapValue(this.viewport)}get nonEmptyIFrame(){return l.getBootstrapValue(this.iframe)}get nonEmptyMessageService(){return l.getBootstrapValue(this.messageService)}initContainer(){var e;const t=new d.Viewport({className:o.default.container,classNameKeyboardOpen:o.default.containerKeyboardOpen});this.options.zIndex&&t.containerElement.style.setProperty("--waze-chat-z-index",this.options.zIndex),this.options.offsetBottom&&t.containerElement.style.setProperty("--waze-chat-offset-bottom",this.options.offsetBottom),t.init();(null!==(e=this.options.parentNode)&&void 0!==e?e:document.body).appendChild(t.containerElement),this.viewport=t}initIFrame(){this.logger.info("creating iframe");const e=document.createElement("iframe"),t=new URL(`/${r.ChatPathPrefix}/${s.AppMode.Embed}`,location.origin);this.options.locale&&t.searchParams.append("locale",this.options.locale),this.options.verbose&&t.searchParams.append("verbose","1"),this.options.theme&&t.searchParams.append("theme",this.options.theme),t.searchParams.append("app_id",this.options.appIdentifierName),e.src=t.toString(),e.className=o.default.iframe,this.nonEmptyViewport.contentElement.appendChild(e),this.iframe=e}initMessageService(){this.logger.info("creating message service");const e=this.nonEmptyIFrame.contentWindow,t=new URL(this.nonEmptyIFrame.src).origin;this.messageService=new c.MessageService(window,e,t,this.logger)}}t.ChatSDK=l},function(e,t,i){"use strict";i.r(t);var n=i(3),o=i.n(n),r=i(0),s=i.n(r),a={insert:"head",singleton:!1};o()(s.a,a);t.default=s.a.locals||{}},function(e,t,i){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var i=function(e,t){var i=e[1]||"",n=e[3];if(!n)return i;if(t&&"function"==typeof btoa){var o=(s=n,a=btoa(unescape(encodeURIComponent(JSON.stringify(s)))),c="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(a),"/*# ".concat(c," */")),r=n.sources.map((function(e){return"/*# sourceURL=".concat(n.sourceRoot||"").concat(e," */")}));return[i].concat(r).concat([o]).join("\n")}var s,a,c;return[i].join("\n")}(t,e);return t[2]?"@media ".concat(t[2]," {").concat(i,"}"):i})).join("")},t.i=function(e,i,n){"string"==typeof e&&(e=[[null,e,""]]);var o={};if(n)for(var r=0;r<this.length;r++){var s=this[r][0];null!=s&&(o[s]=!0)}for(var a=0;a<e.length;a++){var c=[].concat(e[a]);n&&o[c[0]]||(i&&(c[2]?c[2]="".concat(i," and ").concat(c[2]):c[2]=i),t.push(c))}},t}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChatSdkPath=t.ChatApiPath=t.SdkPlaygroundPath=t.ChatPlaygroundPath=t.ChatMobileWebAppPath=t.ChatEmbedAppPath=t.ChatAppPath=t.ChatPathPrefix=void 0;const n=i(1);t.ChatPathPrefix="chat",t.ChatAppPath=`${t.ChatPathPrefix}/${n.AppMode.App}(/*)?`,t.ChatEmbedAppPath=`${t.ChatPathPrefix}/${n.AppMode.Embed}(/*)?`,t.ChatMobileWebAppPath=`${t.ChatPathPrefix}/${n.AppMode.MobileWeb}(/*)?`,t.ChatPlaygroundPath=t.ChatPathPrefix+"/playground",t.SdkPlaygroundPath=t.ChatPathPrefix+"/sdk-playground",t.ChatApiPath=t.ChatPathPrefix+"/api",t.ChatSdkPath=t.ChatPathPrefix+"/sdk"},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ClientLogger=void 0;t.ClientLogger=class{constructor(e,t){this.name=e,this.verbose=t}info(...e){this.verbose&&console.info(`[${this.name}]`,...e)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageService=void 0;t.MessageService=class{constructor(e,t,i,n){this.currentWindow=e,this.targetWindow=t,this.targetOrigin=i,this.logger=n,this.initListener=e=>{const t=t=>{this.logger.info("got message",t.data),t.origin===this.targetOrigin&&e(t.data)};return this.currentWindow.addEventListener("message",t),()=>this.currentWindow.removeEventListener("message",t)},this.receiveMessage=e=>new Promise(t=>{const i=this.initListener(n=>{const o=e(n);o&&(i(),t(o))})}),this.postMessage=e=>{this.logger.info("sending message ",e),this.targetWindow.postMessage(e,this.targetOrigin)}}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Viewport=void 0;const n=i(12),o=i(14),r={interactiveWidgetWorkaroundAllowed:!0};t.Viewport=class{constructor(e){this.options=Object.assign(Object.assign(Object.assign({},r),e)),this.contentElement=document.createElement("div"),this.interactiveWidgetWorkaroundEnabled?(this.containerElement=document.createElement("div"),this.containerElement.appendChild(this.contentElement)):this.containerElement=this.contentElement,this.containerElement.className=e.className,this.visualViewportObserver=new o.VisualViewportObserver(this.containerElement,e)}init(){this.interactiveWidgetWorkaroundEnabled&&(this.setInteractiveWidgetWorkaroundStyle(),this.visualViewportObserver.init())}dispose(){this.interactiveWidgetWorkaroundEnabled&&this.visualViewportObserver.dispose()}get interactiveWidgetWorkaroundEnabled(){return(0,n.isApple)()&&this.options.interactiveWidgetWorkaroundAllowed}setInteractiveWidgetWorkaroundStyle(){this.containerElement.style.overflowY="scroll",this.containerElement.style.overscrollBehavior="none",this.contentElement.style.position="relative",this.contentElement.style.width="100%",this.contentElement.style.height="calc(100% + 1px)",this.contentElement.style.left="0",this.contentElement.style.top="0"}}},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),o=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||n(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),o(i(2),t),o(i(13),t)},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.identifyBrowser=t.getOrientation=t.isRetina=t.getWidth=t.isMobile=t.isApple=t.isAndroid=t.addDeviceTypeClassToBody=t.getDeviceType=t.identifyDevice=void 0;const n=i(2),o=new URLSearchParams(location.search);let r;function s(e=navigator.userAgent,t=o){const i=t.get("fake_device");return i===n.DeviceType.IOS||i===n.DeviceType.Android||i===n.DeviceType.Other?i:/(iPhone|iPad|iPod)/.test(e)?n.DeviceType.IOS:/Android/.test(e)?n.DeviceType.Android:n.DeviceType.Other}function a(){return null==r&&(r=s()),r}function c(){return a()===n.DeviceType.Android}function d(){return a()===n.DeviceType.IOS}function h(){return a()===n.DeviceType.IOS||a()===n.DeviceType.Android}function l(){return window.innerWidth}function p(){return window.devicePixelRatio>1}function u(){if(null!=window.orientation)return 90===window.orientation||-90===window.orientation?n.Orientation.Landscape:n.Orientation.Portrait}t.identifyDevice=s,t.getDeviceType=a,t.addDeviceTypeClassToBody=function(){document.body.classList.add("device-"+a())},t.isAndroid=c,t.isApple=d,t.isMobile=h,t.getWidth=l,t.isRetina=p,t.getOrientation=u,t.identifyBrowser=function(){return{deviceType:a(),isAndroid:c(),isApple:d(),isMobile:h(),isRetina:p(),orientation:u(),width:l()}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VisualViewportObserver=void 0;t.VisualViewportObserver=class{constructor(e,t={}){this.element=e,this.options=t}init(){this.setViewportPositionStyle(),this.animationFrameRequestId=window.requestAnimationFrame(()=>this.init())}dispose(){void 0!==this.animationFrameRequestId&&(window.cancelAnimationFrame(this.animationFrameRequestId),this.animationFrameRequestId=void 0)}get documentHeight(){return window.document.documentElement.clientHeight}get viewportHeight(){var e,t;return null!==(t=null===(e=window.visualViewport)||void 0===e?void 0:e.height)&&void 0!==t?t:this.documentHeight}get viewportOffsetTop(){var e,t;return null!==(t=null===(e=window.visualViewport)||void 0===e?void 0:e.offsetTop)&&void 0!==t?t:0}get keyboardOpen(){return this.viewportHeight<this.documentHeight}setViewportPositionStyle(){this.element.style.setProperty("--waze-viewport-height",this.viewportHeight+"px"),this.element.style.setProperty("--waze-viewport-offset-top",this.viewportOffsetTop+"px"),this.options.classNameKeyboardOpen&&this.element.classList.toggle(this.options.classNameKeyboardOpen,this.keyboardOpen)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageType=void 0,function(e){e.ChatReady="ChatReady",e.ChatUnreadCount="ChatUnreadCount",e.ChatVisibility="ChatVisibility",e.ChatSetVisibility="ChatSetVisibility",e.ChatOpenConversation="ChatOpenConversation"}(t.MessageType||(t.MessageType={}))}]);
    const indicatorButtonID = "forum-unread-messages";
    let WazeChatSdk;

    function createChatSdk_() {
        console.debug('wme-forum-chat-indicator: createChatSdk_ creating chat sdk...');
        ChatSDK_.create({
            locale:"en"
        }).then(sdk => {
            console.debug('wme-forum-chat-indicator: createChatSdk_ chat sdk created successfully.');
            WazeChatSdk = sdk;
            sdk.subscribe( () => {
                getUnreadChatCount();
            });
            //getUnreadChatCount();
        });
    }

    function getUnreadChatCount() {
        console.debug('wme-forum-chat-indicator: getting unread count...');
        let unreadChatCount = WazeChatSdk.getUnreadChatCount();
        WazeChatSdk.setVisibility(false);
        console.info('wme-forum-chat-indicator: got unread count: ' + unreadChatCount);
        handleUI(unreadChatCount);
    }

    if (typeof W !== 'undefined' && W['userscripts'] && W['userscripts']['state'] && W['userscripts']['state']['isReady']) {
        console.debug('wme-forum-chat-indicator: WME is ready.');
        createChatSdk_();
    } else {
        console.debug('wme-forum-chat-indicator: WME is not ready. adding event listener.');
        document.addEventListener("wme-ready", createChatSdk_, {
            once: true,
        });
    }

    function handleUI(unreadCount) {
        console.debug('wme-forum-chat-indicator: handling UI...');
        jQuery("#" + indicatorButtonID).remove();
        if (unreadCount > 0) {
            let clonedObj = jQuery('#save-button').clone().prop('id', indicatorButtonID );
            clonedObj.css("align-items", "center");
            jQuery(".secondary-toolbar-actions.user-toolbar").prepend(clonedObj);
            clonedObj.attr('disabled', false)
            let unreadDivI = jQuery('#forum-unread-messages');
            unreadDivI.text(unreadCount + " Chat");
            clonedObj.attr('title','Unread Chat Count');
            clonedObj.on("click", function() {
                window.open('https://www.waze.com/forum/', '_blank');
                jQuery("#" + indicatorButtonID).remove();
                return false;
            });
        }
        console.info('wme-forum-chat-indicator: handling UI done.');
    }

}.call(this));