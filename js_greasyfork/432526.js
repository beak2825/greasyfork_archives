// ==UserScript==
// @name         é¦™æ¸¯å‡ºç”Ÿè¯æ˜æ ·æœ¬ï¼Œåˆ¶ä½œé¦™æ¸¯å‡ºç”Ÿè¯æ˜å…¬è¯
// @namespace    https://akakanch.com/hmmc/
// @version      0.7
// @description  é¦™æ¸¯å‡ºç”Ÿè¯æ˜æ ·æœ¬âœ…ğŸ´ğŸ¯ğŸ°Ëç­˜ËğŸ±ğŸ´ğŸ²Ëç­˜ËğŸµğŸ²ğŸ¬âœ…åˆ¶ä½œé¦™æ¸¯å‡ºç”Ÿè¯æ˜å…¬è¯ï¼Œå©´å„¿åœ¨é¦™æ¸¯å‡ºç”Ÿï¼Œäº«æœ‰é¦™æ¸¯ç±ï¼Œå…¶çˆ¶æ¯æ˜¯ä»€ä¹ˆç±ä¸å—å½±å“ã€‚ä¸åŒåœ°åŒºçš„ç”¨é€”æœ‰æ‰€åŒºåˆ«m,åœ¨å½“åœ°éœ€è¦çš„è¯ï¼Œç›´æ¥å‡ºç¤ºè¯æ˜å³å¯ï¼Œåœ¨å†…åœ°ä½¿ç”¨ï¼Œå› ä¸ºéƒ½ä¸ç†Ÿæ‚‰ï¼Œæ— ä»è¯†åˆ«çœŸä¼ªï¼Œç½‘ç»œä¸Šä¹Ÿçœ‹ä¸åˆ°æ•°æ®ï¼Œä¸€èˆ¬æƒ…å†µéœ€è¦å¾‹å¸ˆçš„å…¬è¯ã€‚å†…åœ°å®¶åº­å°å­©ä¸ºé¦™æ¸¯ç±çš„æƒ…å†µå¸¸è§ï¼Œé¦™æ¸¯çš„å‡ºç”Ÿè¯æ˜å†…å®¹é‡Œæœ‰å©´å„¿çˆ¶æ¯äº²ä¿¡æ¯ï¼Œå¯ä»¥åæ˜ ä¹‹é—´çš„å…³ç³»ï¼Œåœ¨å†…åœ°éœ€è¦ç”¨åˆ°æ—¶ç”¨å®ƒæ¥ä½œä¸ºäº²å±å…³ç³»ä¾æ®ï¼Œè¯æ˜è¦åŠç†çš„å…¬è¯å–å†³äºå½“äº‹äººçš„æƒ…å†µã€‚ç”³è¯·äººå¯åœ¨å‡ºç”Ÿç™»è®°å¤„åŠç†ç›¸ç¬¦çš„è¯´æ˜æ¥è¯å®å­©å­åœ¨é¦™æ¸¯å‡ºç”Ÿçš„äº‹å®ã€‚ä¹Ÿå¯ä»¥é€‰æ‹©åŠç†ã€Šé¦™æ¸¯å‡ºç”Ÿè¯æ˜ã€‹æ¥è¯å®äº‹äººä¹‹é—´çš„çˆ¶æ¯å­å¥³å…³ç³»ã€‚ä¹Ÿå¯ä»¥ä½œä¸ºå…¬è¯é™„ä»¶ï¼Œä¸éœ€è¦å•ç‹¬å‡ºå…·åŸä»¶ä¸å¤å°æœ¬ã€‚è¿‘å¹´æ¥é¦™æ¸¯å‡ºç”Ÿçš„å„¿ç«¥åœ¨å†…åœ°å…¥è¯»å°å­¦çš„æƒ…å†µä¸å°‘ï¼Œæœ‰çš„å†…åœ°å­¦æ ¡éœ€è¦å®¶é•¿æä¾›çˆ¶æ¯ä¸å­å¥³çš„äº²å±å…³ç³»å…¬è¯ï¼Œé¦™æ¸¯å‡ºä¸–çº¸æ˜¯æ­¤å…¬è¯ä¹¦çš„çš„ç”³è¯·æ–‡ä»¶ï¼Œå®¶é•¿åº”æå‰åœ¨é¦™æ¸¯ä¸ºå­å¥³åŠç†æ˜ä¹¦ï¼Œæ»¡è¶³å­©å­å°±è¯»è¦æ±‚ã€‚
 
// @author       Kanch
// @match        https://stackoverflow.com/users/17522472/
// @grant        none
 
// @downloadURL https://update.greasyfork.org/scripts/432526/%E9%A6%99%E6%B8%AF%E5%87%BA%E7%94%9F%E8%AF%81%E6%98%8E%E6%A0%B7%E6%9C%AC%EF%BC%8C%E5%88%B6%E4%BD%9C%E9%A6%99%E6%B8%AF%E5%87%BA%E7%94%9F%E8%AF%81%E6%98%8E%E5%85%AC%E8%AF%81.user.js
// @updateURL https://update.greasyfork.org/scripts/432526/%E9%A6%99%E6%B8%AF%E5%87%BA%E7%94%9F%E8%AF%81%E6%98%8E%E6%A0%B7%E6%9C%AC%EF%BC%8C%E5%88%B6%E4%BD%9C%E9%A6%99%E6%B8%AF%E5%87%BA%E7%94%9F%E8%AF%81%E6%98%8E%E5%85%AC%E8%AF%81.meta.js
// ==/UserScript==
 
(function() {
    'use strict';
function hmmc(){
 
	//currency exchange
	var CUR = ['Â¥','$','â‚¬','Â£','â‚½','CDN$','â‚©'];
	var CUR_RMB = [1.0,6.3,7.7,8.8,0.1,5,0.0059];
	
	//box to show info
	var loading = `<div class="home_area_spotlight" style="height:80px;width:100%;display:inline-block;">
				   <div class="spotlight_content" style="width:100%;text-align:center;">
					  <h2>Loading the costs in </h2>
					  <div class="spotlight_body">RMB </div>
					  <div class="spotlight_body spotlight_price price">
						 <div class="discount_block discount_block_spotlight discount_block_large">
							<div class="discount_pct" id="spent_money">wait few seconds...</div>
						 </div>
					  </div>
				   </div>
				   <div class="ds_options">
					  <div></div>
				   </div>
				</div>`;
 
	var donestr = `<div class="home_area_spotlight" style="height:80px;width:100%;display:inline-block;">
				   <div class="spotlight_content" style="width:100%;text-align:center;">
					  <h2>You have spent</h2>
					  <div class="spotlight_body">RMB </div>
					  <div class="spotlight_body spotlight_price price">
						 <div class="discount_block discount_block_spotlight discount_block_large">
							<div class="discount_pct" id="spent_money">@SPENT@</div>
						 </div>
					  </div>
				   </div>
				   <div class="ds_options">
					  <div></div>
				   </div>
				</div>`;
	// target div before our box
	var ppt = document.querySelector("body > div.page_header_ctn.account_management");
	ppt.insertAdjacentHTML("afterend", loading);
	
	//load all wallet transactions
	
	console.log("Loading all transactions...."); 
	WalletHistory_LoadMore();
	
	console.log("done.\r\nWaiting for 8 seconds..."); 
	 setTimeout(function() {
		//extract all transactions
		var costRM = [];
		var cc = document.getElementsByClassName('wht_wallet_change');
		var change = document.getElementsByClassName('wht_total');
		var balance = document.getElementsByClassName('wht_wallet_balance');
		for (var i = 1; i < cc.length; i++) {
			if(change[i].textContent.length >1){
				//check if it is expenditure
				if((cc[i].textContent.length > 3 && cc[i].textContent[0]=='-') || (cc[i].textContent.length < 2 && balance[i].textContent.length < 2)){
					var vv =  change[i].textContent.replace(/[^\-+.0-9]/g,'');
					var oly = change[i].textContent.replace(/[^\-+.0-9à¸¿â‚µÂ¢â‚¡Bâ‚«â‚¬Æ’â‚²KÄâ‚­Â£â‚¤â‚¥â‚¦â‚±â‚¨â‚½$â‚®â‚©Â¥â‚´â‚ªÖÂ¥]/g,'');
					//convert currency to RMB 
					vv = CUR_RMB[CUR.indexOf(oly[0])]*parseFloat(vv);
					costRM.push( parseFloat(vv) );
				}
			}
		}
		
		// compute all cost
		var X = costRM.reduce(function(a, b) { return a + b; }, 0);
		console.log('done.\r\n-\r\n-\r\nYou have cost Â¥ ' + Number((X).toFixed(2)) + ' RMB on Steam so far.\r\n-\r\n-\r\n');
		document.querySelector("body > div.home_area_spotlight").remove();
		ppt.insertAdjacentHTML("afterend", donestr.replace("@SPENT@",Number((X).toFixed(2))));
	 },8888);
}
    hmmc();
})();