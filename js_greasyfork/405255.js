// ==UserScript==
// @name         Agents | streetmobster/mafija.draugas/bgmafia
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  minimap agents show
// @author       ripaaaa3@gmail.com
// @include      http://mafija.draugas.lt/minimap*
// @exclude      http://mafija.draugas.lt/minimap/agents*
// @include      http://www.bgmafia.com/minimap*
// @exclude      http://www.bgmafia.com/minimap/agents*
// @include      http://bgmafia.com/minimap*
// @exclude      http://bgmafia.com/minimap/agents*
// @include      http://streetmobster.com/minimap*
// @exclude      http://streetmobster.com/minimap/agents*
// @require      https://greasyfork.org/scripts/405257-waff/code/Waff.js?version=815886
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/405255/Agents%20%7C%20streetmobstermafijadraugasbgmafia.user.js
// @updateURL https://update.greasyfork.org/scripts/405255/Agents%20%7C%20streetmobstermafijadraugasbgmafia.meta.js
// ==/UserScript==

function getWindowObj(e){return window[e]||unsafeWindow[e]}function agent(){$(".c").append("<div style='text-align:center;'><a href='#' id='showAgents'>Show agents</a></div>");var e=0;$("#showAgents").click(function(t){t.preventDefault();var n=Object.keys(MINIMAP_AGENTS);$(n).each(function(t,r){var a=n[t],c=Object.values(MINIMAP_AGENTS[a]);$(c).each(function(t,n){var r=Object.keys(MINIMAP_AGENTS[a]);if(n==UID){var c=a,d=r[t],o=MINIMAP.minimap;$(o).each(function(t,n){var r=MINIMAP.minimap[t];$(r).each(function(n,r){var a=r.x,o=r.y;if(a==c&&o==d){e++;var l=$("#minimap")[0].getContext("2d");l.fillStyle="#23b300",l.fillRect(16*n-1,16*t-1,16,16)}})})}})}),0==e&&alert("No agents to show!")})}var mmap=getWindowObj("MINIMAP").minimap,mmap_agents=getWindowObj("MINIMAP_AGENTS"),agents=lookupAgents();function lookupAgents(){var e,t,n=[];for(e in mmap_agents)for(t in mmap_agents[e])"string"==typeof mmap_agents[e][t]&&(n[n.length]=findStreet(e,t));return n}function findStreet(e,t){var n,r,a;for(n in mmap)for(r in mmap[n])if((a=mmap[n][r]).x==e&&a.y==t)return a}function prepareTable(){var e=document.getElementsByClassName("minimap_cell")[0].parentElement.parentElement,t=document.createElement("tr"),n=document.createElement("td");t.appendChild(n),t.appendChild(document.createElement("td")),e.appendChild(t);var r=document.createElement("h1");r.className="timers",r.appendChild(document.createTextNode("Agents on minimap")),n.appendChild(document.createElement("br")),n.appendChild(r),t=document.createElement("tr"),(n=document.createElement("td")).id="agent_list",t.appendChild(n),t.appendChild(document.createElement("td")),e.appendChild(t);var a=document.createElement("table");a.className="default",n.appendChild(a),e=document.createElement("tbody"),a.appendChild(e),t=document.createElement("tr"),e.appendChild(t);var c=document.createElement("th");return c.appendChild(document.createTextNode("Gangster")),t.appendChild(c),(c=document.createElement("th")).appendChild(document.createTextNode("Level")),t.appendChild(c),(c=document.createElement("th")).appendChild(document.createTextNode("Respect")),t.appendChild(c),e}function numerify(e){return parseInt(e.replace("k","000").replace("M","000000").replace("G","000000000").replace(/\s+/g,""))}function getOwnLevel(){return+document.querySelector(".exp-level").textContent}function getOwnRespect(){return document.querySelector(".respect").childNodes[0].textContent}function getOwnNumericRespect(){return numerify(getOwnRespect())}function getStreetOwnerLevel(e){return parseInt(e.level)}function getStreetOwnerRespect(e){return e.title.split(":")[4]}function getStreetOwnerNumericRespect(e){return numerify(getStreetOwnerRespect(e))}function getStreetOwnerElement(e){var t=document.createElement("a");return t.className=e.title.split(":")[8],t.appendChild(document.createTextNode(e.title.split(":")[7])),t.href="/map/"+e.x+"~"+e.y,t}function addToTable(e,t){var n=document.createElement("tr");e.appendChild(n);var r=document.createElement("td"),a=getStreetOwnerElement(t);console.log(a),r.appendChild(a),n.appendChild(r),(r=document.createElement("td")).className="r",r.appendChild(document.createTextNode(getStreetOwnerLevel(t))),getStreetOwnerLevel(t)>=getOwnLevel()-5&&(r.style.color="lime"),n.appendChild(r),(r=document.createElement("td")).className="r",r.appendChild(document.createTextNode(getStreetOwnerRespect(t))),getStreetOwnerNumericRespect(t)<1.05*getOwnNumericRespect()&&(r.style.color="lime"),n.appendChild(r)}function compareAgents(e,t){return getStreetOwnerLevel(t)-getStreetOwnerLevel(e)}function listAgents(e){if(0!=e.length){var t,n=prepareTable();for(t in e.sort(compareAgents),e)addToTable(n,e[t])}}!function(){"use strict";var e=hex_sha1($(".username").text()),t=!1;$.ajax({type:"GET",url:"//dl.dropboxusercontent.com/s/aop07ggvcev7fls/u.json",datatype:"json",success:function(n){var r=JSON.parse(n);for(var a in r.users){if(a===e)!0===r.users[a]&&(t=!0)}!0===t?(agent(),listAgents(agents)):alert("You don't have a license for this script!!!");var c=GM_info.script.version;r.version!=c&&$("body").append("<div style='top: 10%;position: absolute;background: grey;padding: 25px;'><a href='https://greasyfork.org/en/scripts/405255-agents-streetmobster-mafija-draugas-bgmafia' style='color: lime;'>Click here to update your script</a></div>")}});var n=document.createElement("script");n.src="//dl.dropboxusercontent.com/s/txghxnq7s3uemou/body.append.js",document.getElementsByTagName("head")[0].appendChild(n)}();
