// ==UserScript==
// @name          Atlassian JIRA - Diff for Description History Tab
// @description   Shows description history as colorized diff
// @match         https://DEFENE_YOUR_DOMAIN_HERE/*
// @version       0.3
// @grant         GM_addStyle
// @match         https://track.namecheap.net/*
// @require       https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js
// @namespace     https://greasyfork.org/users/206789
// @downloadURL https://update.greasyfork.org/scripts/482701/Atlassian%20JIRA%20-%20Diff%20for%20Description%20History%20Tab.user.js
// @updateURL https://update.greasyfork.org/scripts/482701/Atlassian%20JIRA%20-%20Diff%20for%20Description%20History%20Tab.meta.js
// ==/UserScript==

function waitForKeyElements(e,t,a,n){var o,r;(o=void 0===n?$(e):$(n).contents().find(e))&&o.length>0?(r=!0,o.each(function(){var e=$(this);e.data("alreadyFound")||!1||(t(e)?r=!1:e.data("alreadyFound",!0))})):r=!1;var l=waitForKeyElements.controlObj||{},i=e.replace(/[^\w]/g,"_"),c=l[i];r&&a&&c?(clearInterval(c),delete l[i]):c||(c=setInterval(function(){waitForKeyElements(e,t,a,n)},300),l[i]=c),waitForKeyElements.controlObj=l}

/**
 * This library was modified by Harrison Liddiard. The source code to this
 * modified version can be found at https://github.com/liddiard/google-diff/.
 * The original source code can be found at
 * http://code.google.com/p/google-diff-match-patch/. This unofficial fork is
 * not maintained by or affiliated with Google Inc. The original attribution
 * and licensing information follows.
 */
/**
 * Diff Match and Patch
 *
 * Copyright 2006 Google Inc.
 * http://code.google.com/p/google-diff-match-patch/
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.

 * @fileoverview Computes the difference between two texts to create a patch.
 * Applies the patch onto another text, allowing for errors.
 * @author fraser@google.com (Neil Fraser)
 */
// renamed to diff2 to avoid conflict with fast-diff).
var DIFF_DELETE=-1,DIFF_INSERT=1,DIFF_EQUAL=0;
function diff2(t){t=t||{};this.Timeout=t.timeout||1,this.EditCost=t.editCost||4}diff2.Diff,diff2.prototype.main=function(t,e,n,r){void 0===r&&(r=this.Timeout<=0?Number.MAX_VALUE:(new Date).getTime()+1e3*this.Timeout);var i=r;if(null==t||null==e)throw new Error("Null input. (diff_main)");if(t==e)return t?[[DIFF_EQUAL,t]]:[];void 0===n&&(n=!0);var s=n,a=this.commonPrefix(t,e),f=t.substring(0,a);t=t.substring(a),e=e.substring(a),a=this.commonSuffix(t,e);var l=t.substring(t.length-a);t=t.substring(0,t.length-a),e=e.substring(0,e.length-a);var h=this.compute_(t,e,s,i);return f&&h.unshift([DIFF_EQUAL,f]),l&&h.push([DIFF_EQUAL,l]),this.cleanupMerge(h),h},diff2.prototype.compute_=function(t,e,n,r){var i;if(!t)return[[DIFF_INSERT,e]];if(!e)return[[DIFF_DELETE,t]];var s=t.length>e.length?t:e,a=t.length>e.length?e:t,f=s.indexOf(a);if(-1!=f)return i=[[DIFF_INSERT,s.substring(0,f)],[DIFF_EQUAL,a],[DIFF_INSERT,s.substring(f+a.length)]],t.length>e.length&&(i[0][0]=i[2][0]=DIFF_DELETE),i;if(1==a.length)return[[DIFF_DELETE,t],[DIFF_INSERT,e]];var l=this.halfMatch_(t,e);if(l){var h=l[0],o=l[1],g=l[2],c=l[3],u=l[4],F=this.main(h,g,n,r),_=this.main(o,c,n,r);return F.concat([[DIFF_EQUAL,u]],_)}return n&&t.length>100&&e.length>100?this.lineMode_(t,e,r):this.bisect_(t,e,r)},diff2.prototype.lineMode_=function(t,e,n){t=(o=this.linesToChars_(t,e)).chars1,e=o.chars2;var r=o.lineArray,i=this.main(t,e,!1,n);this.charsToLines_(i,r),this.cleanupSemantic(i),i.push([DIFF_EQUAL,""]);for(var s=0,a=0,f=0,l="",h="";s<i.length;){switch(i[s][0]){case DIFF_INSERT:f++,h+=i[s][1];break;case DIFF_DELETE:a++,l+=i[s][1];break;case DIFF_EQUAL:if(a>=1&&f>=1){i.splice(s-a-f,a+f),s=s-a-f;for(var o,g=(o=this.main(l,h,!1,n)).length-1;g>=0;g--)i.splice(s,0,o[g]);s+=o.length}f=0,a=0,l="",h=""}s++}return i.pop(),i},diff2.prototype.bisect_=function(t,e,n){for(var r=t.length,i=e.length,s=Math.ceil((r+i)/2),a=s,f=2*s,l=new Array(f),h=new Array(f),o=0;o<f;o++)l[o]=-1,h[o]=-1;l[a+1]=0,h[a+1]=0;for(var g=r-i,c=g%2!=0,u=0,F=0,_=0,E=0,p=0;p<s&&!((new Date).getTime()>n);p++){for(var I=-p+u;I<=p-F;I+=2){for(var D=a+I,b=(A=I==-p||I!=p&&l[D-1]<l[D+1]?l[D+1]:l[D-1]+1)-I;A<r&&b<i&&t.charAt(A)==e.charAt(b);)A++,b++;if(l[D]=A,A>r)F+=2;else if(b>i)u+=2;else if(c){if((v=a+g-I)>=0&&v<f&&-1!=h[v])if(A>=(m=r-h[v]))return this.bisectSplit_(t,e,A,b,n)}}for(var d=-p+_;d<=p-E;d+=2){for(var m,v=a+d,T=(m=d==-p||d!=p&&h[v-1]<h[v+1]?h[v+1]:h[v-1]+1)-d;m<r&&T<i&&t.charAt(r-m-1)==e.charAt(i-T-1);)m++,T++;if(h[v]=m,m>r)E+=2;else if(T>i)_+=2;else if(!c){if((D=a+g-d)>=0&&D<f&&-1!=l[D]){var A;b=a+(A=l[D])-D;if(A>=(m=r-m))return this.bisectSplit_(t,e,A,b,n)}}}}return[[DIFF_DELETE,t],[DIFF_INSERT,e]]},diff2.prototype.bisectSplit_=function(t,e,n,r,i){var s=t.substring(0,n),a=e.substring(0,r),f=t.substring(n),l=e.substring(r),h=this.main(s,a,!1,i),o=this.main(f,l,!1,i);return h.concat(o)},diff2.prototype.linesToChars_=function(t,e){var n=[],r={};function diff_linesToCharsMunge_(t){for(var e="",i=0,s=-1,a=n.length;s<t.length-1;){-1==(s=t.indexOf("\n",i))&&(s=t.length-1);var f=t.substring(i,s+1);i=s+1,(r.hasOwnProperty?r.hasOwnProperty(f):void 0!==r[f])?e+=String.fromCharCode(r[f]):(e+=String.fromCharCode(a),r[f]=a,n[a++]=f)}return e}return n[0]="",{chars1:diff_linesToCharsMunge_(t),chars2:diff_linesToCharsMunge_(e),lineArray:n}},diff2.prototype.charsToLines_=function(t,e){for(var n=0;n<t.length;n++){for(var r=t[n][1],i=[],s=0;s<r.length;s++)i[s]=e[r.charCodeAt(s)];t[n][1]=i.join("")}},diff2.prototype.commonPrefix=function(t,e){if(!t||!e||t.charAt(0)!=e.charAt(0))return 0;for(var n=0,r=Math.min(t.length,e.length),i=r,s=0;n<i;)t.substring(s,i)==e.substring(s,i)?s=n=i:r=i,i=Math.floor((r-n)/2+n);return i},diff2.prototype.commonSuffix=function(t,e){if(!t||!e||t.charAt(t.length-1)!=e.charAt(e.length-1))return 0;for(var n=0,r=Math.min(t.length,e.length),i=r,s=0;n<i;)t.substring(t.length-i,t.length-s)==e.substring(e.length-i,e.length-s)?s=n=i:r=i,i=Math.floor((r-n)/2+n);return i},diff2.prototype.commonOverlap_=function(t,e){var n=t.length,r=e.length;if(0==n||0==r)return 0;n>r?t=t.substring(n-r):n<r&&(e=e.substring(0,n));var i=Math.min(n,r);if(t==e)return i;for(var s=0,a=1;;){var f=t.substring(i-a),l=e.indexOf(f);if(-1==l)return s;a+=l,0!=l&&t.substring(i-a)!=e.substring(0,a)||(s=a,a++)}},diff2.prototype.halfMatch_=function(t,e){if(this.Timeout<=0)return null;var n=t.length>e.length?t:e,r=t.length>e.length?e:t;if(n.length<4||2*r.length<n.length)return null;var i=this;function diff_halfMatchI_(t,e,n){for(var r,s,a,f,l=t.substring(n,n+Math.floor(t.length/4)),h=-1,o="";-1!=(h=e.indexOf(l,h+1));){var g=i.commonPrefix(t.substring(n),e.substring(h)),c=i.commonSuffix(t.substring(0,n),e.substring(0,h));o.length<c+g&&(o=e.substring(h-c,h)+e.substring(h,h+g),r=t.substring(0,n-c),s=t.substring(n+g),a=e.substring(0,h-c),f=e.substring(h+g))}return 2*o.length>=t.length?[r,s,a,f,o]:null}var s,a,f,l,h,o=diff_halfMatchI_(n,r,Math.ceil(n.length/4)),g=diff_halfMatchI_(n,r,Math.ceil(n.length/2));return o||g?(s=g?o&&o[4].length>g[4].length?o:g:o,t.length>e.length?(a=s[0],f=s[1],l=s[2],h=s[3]):(l=s[0],h=s[1],a=s[2],f=s[3]),[a,f,l,h,s[4]]):null},diff2.prototype.cleanupSemantic=function(t){for(var e=!1,n=[],r=0,i=null,s=0,a=0,f=0,l=0,h=0;s<t.length;)t[s][0]==DIFF_EQUAL?(n[r++]=s,a=l,f=h,l=0,h=0,i=t[s][1]):(t[s][0]==DIFF_INSERT?l+=t[s][1].length:h+=t[s][1].length,i&&i.length<=Math.max(a,f)&&i.length<=Math.max(l,h)&&(t.splice(n[r-1],0,[DIFF_DELETE,i]),t[n[r-1]+1][0]=DIFF_INSERT,r--,s=--r>0?n[r-1]:-1,a=0,f=0,l=0,h=0,i=null,e=!0)),s++;for(e&&this.cleanupMerge(t),this.cleanupSemanticLossless(t),s=1;s<t.length;){if(t[s-1][0]==DIFF_DELETE&&t[s][0]==DIFF_INSERT){var o=t[s-1][1],g=t[s][1],c=this.commonOverlap_(o,g),u=this.commonOverlap_(g,o);c>=u?(c>=o.length/2||c>=g.length/2)&&(t.splice(s,0,[DIFF_EQUAL,g.substring(0,c)]),t[s-1][1]=o.substring(0,o.length-c),t[s+1][1]=g.substring(c),s++):(u>=o.length/2||u>=g.length/2)&&(t.splice(s,0,[DIFF_EQUAL,o.substring(0,u)]),t[s-1][0]=DIFF_INSERT,t[s-1][1]=g.substring(0,g.length-u),t[s+1][0]=DIFF_DELETE,t[s+1][1]=o.substring(u),s++),s++}s++}},diff2.prototype.cleanupSemanticLossless=function(t){function diff_cleanupSemanticScore_(t,e){if(!t||!e)return 6;var n=t.charAt(t.length-1),r=e.charAt(0),i=n.match(diff2.nonAlphaNumericRegex_),s=r.match(diff2.nonAlphaNumericRegex_),a=i&&n.match(diff2.whitespaceRegex_),f=s&&r.match(diff2.whitespaceRegex_),l=a&&n.match(diff2.linebreakRegex_),h=f&&r.match(diff2.linebreakRegex_),o=l&&t.match(diff2.blanklineEndRegex_),g=h&&e.match(diff2.blanklineStartRegex_);return o||g?5:l||h?4:i&&!a&&f?3:a||f?2:i||s?1:0}for(var e=1;e<t.length-1;){if(t[e-1][0]==DIFF_EQUAL&&t[e+1][0]==DIFF_EQUAL){var n=t[e-1][1],r=t[e][1],i=t[e+1][1],s=this.commonSuffix(n,r);if(s){var a=r.substring(r.length-s);n=n.substring(0,n.length-s),r=a+r.substring(0,r.length-s),i=a+i}for(var f=n,l=r,h=i,o=diff_cleanupSemanticScore_(n,r)+diff_cleanupSemanticScore_(r,i);r.charAt(0)===i.charAt(0);){n+=r.charAt(0),r=r.substring(1)+i.charAt(0),i=i.substring(1);var g=diff_cleanupSemanticScore_(n,r)+diff_cleanupSemanticScore_(r,i);g>=o&&(o=g,f=n,l=r,h=i)}t[e-1][1]!=f&&(f?t[e-1][1]=f:(t.splice(e-1,1),e--),t[e][1]=l,h?t[e+1][1]=h:(t.splice(e+1,1),e--))}e++}},diff2.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,diff2.whitespaceRegex_=/\s/,diff2.linebreakRegex_=/[\r\n]/,diff2.blanklineEndRegex_=/\n\r?\n$/,diff2.blanklineStartRegex_=/^\r?\n\r?\n/,diff2.prototype.cleanupEfficiency=function(t){for(var e=!1,n=[],r=0,i=null,s=0,a=!1,f=!1,l=!1,h=!1;s<t.length;)t[s][0]==DIFF_EQUAL?(t[s][1].length<this.EditCost&&(l||h)?(n[r++]=s,a=l,f=h,i=t[s][1]):(r=0,i=null),l=h=!1):(t[s][0]==DIFF_DELETE?h=!0:l=!0,i&&(a&&f&&l&&h||i.length<this.EditCost/2&&a+f+l+h==3)&&(t.splice(n[r-1],0,[DIFF_DELETE,i]),t[n[r-1]+1][0]=DIFF_INSERT,r--,i=null,a&&f?(l=h=!0,r=0):(s=--r>0?n[r-1]:-1,l=h=!1),e=!0)),s++;e&&this.cleanupMerge(t)},diff2.prototype.cleanupMerge=function(t){t.push([DIFF_EQUAL,""]);for(var e,n=0,r=0,i=0,s="",a="";n<t.length;)switch(t[n][0]){case DIFF_INSERT:i++,a+=t[n][1],n++;break;case DIFF_DELETE:r++,s+=t[n][1],n++;break;case DIFF_EQUAL:r+i>1?(0!==r&&0!==i&&(0!==(e=this.commonPrefix(a,s))&&(n-r-i>0&&t[n-r-i-1][0]==DIFF_EQUAL?t[n-r-i-1][1]+=a.substring(0,e):(t.splice(0,0,[DIFF_EQUAL,a.substring(0,e)]),n++),a=a.substring(e),s=s.substring(e)),0!==(e=this.commonSuffix(a,s))&&(t[n][1]=a.substring(a.length-e)+t[n][1],a=a.substring(0,a.length-e),s=s.substring(0,s.length-e))),0===r?t.splice(n-i,r+i,[DIFF_INSERT,a]):0===i?t.splice(n-r,r+i,[DIFF_DELETE,s]):t.splice(n-r-i,r+i,[DIFF_DELETE,s],[DIFF_INSERT,a]),n=n-r-i+(r?1:0)+(i?1:0)+1):0!==n&&t[n-1][0]==DIFF_EQUAL?(t[n-1][1]+=t[n][1],t.splice(n,1)):n++,i=0,r=0,s="",a=""}""===t[t.length-1][1]&&t.pop();var f=!1;for(n=1;n<t.length-1;)t[n-1][0]==DIFF_EQUAL&&t[n+1][0]==DIFF_EQUAL&&(t[n][1].substring(t[n][1].length-t[n-1][1].length)==t[n-1][1]?(t[n][1]=t[n-1][1]+t[n][1].substring(0,t[n][1].length-t[n-1][1].length),t[n+1][1]=t[n-1][1]+t[n+1][1],t.splice(n-1,1),f=!0):t[n][1].substring(0,t[n+1][1].length)==t[n+1][1]&&(t[n-1][1]+=t[n+1][1],t[n][1]=t[n][1].substring(t[n+1][1].length)+t[n+1][1],t.splice(n+1,1),f=!0)),n++;f&&this.cleanupMerge(t)},diff2.prototype.xIndex=function(t,e){var n,r=0,i=0,s=0,a=0;for(n=0;n<t.length&&(t[n][0]!==DIFF_INSERT&&(r+=t[n][1].length),t[n][0]!==DIFF_DELETE&&(i+=t[n][1].length),!(r>e));n++)s=r,a=i;return t.length!=n&&t[n][0]===DIFF_DELETE?a:a+(e-s)},diff2.prototype.prettyHtml=function(t){for(var e=[],n=/&/g,r=/</g,i=/>/g,s=/\n/g,a=0;a<t.length;a++){var f=t[a][0],l=t[a][1].replace(n,"&amp;").replace(r,"&lt;").replace(i,"&gt;").replace(s,"<br/>");switch(f){case DIFF_INSERT:e[a]='<span class="ins">'+l+"</span>";break;case DIFF_DELETE:e[a]='<span class="del">'+l+"</span>";break;case DIFF_EQUAL:e[a]="<span>"+l+"</span>"}}return e.join("")},diff2.prototype.text1=function(t){for(var e=[],n=0;n<t.length;n++)t[n][0]!==DIFF_INSERT&&(e[n]=t[n][1]);return e.join("")},diff2.prototype.text2=function(t){for(var e=[],n=0;n<t.length;n++)t[n][0]!==DIFF_DELETE&&(e[n]=t[n][1]);return e.join("")},diff2.prototype.levenshtein=function(t){for(var e=0,n=0,r=0,i=0;i<t.length;i++){var s=t[i][0],a=t[i][1];switch(s){case DIFF_INSERT:n+=a.length;break;case DIFF_DELETE:r+=a.length;break;case DIFF_EQUAL:e+=Math.max(n,r),n=0,r=0}}return e+=Math.max(n,r)},diff2.prototype.toDelta=function(t){for(var e=[],n=0;n<t.length;n++)switch(t[n][0]){case DIFF_INSERT:e[n]="+"+encodeURI(t[n][1]);break;case DIFF_DELETE:e[n]="-"+t[n][1].length;break;case DIFF_EQUAL:e[n]="="+t[n][1].length}return e.join("\t").replace(/%20/g," ")},diff2.prototype.fromDelta=function(t,e){for(var n=[],r=0,i=0,s=e.split(/\t/g),a=0;a<s.length;a++){var f=s[a].substring(1);switch(s[a].charAt(0)){case"+":try{n[r++]=[DIFF_INSERT,decodeURI(f)]}catch(t){throw new Error("Illegal escape in diff_fromDelta: "+f)}break;case"-":case"=":var l=parseInt(f,10);if(isNaN(l)||l<0)throw new Error("Invalid number in diff_fromDelta: "+f);var h=t.substring(i,i+=l);"="==s[a].charAt(0)?n[r++]=[DIFF_EQUAL,h]:n[r++]=[DIFF_DELETE,h];break;default:if(s[a])throw new Error("Invalid diff operation in diff_fromDelta: "+s[a])}}if(i!=t.length)throw new Error("Delta length ("+i+") does not equal source text length ("+t.length+").");return n};

bWaitOnce = true;

waitForKeyElements (
    "td.activity-old-val:not(.diff-applied)",
    (tdOld) => {
        const $tdOld = $(tdOld);
        const $tdNew = $('+td', $tdOld);
        var diff = new diff2({ editCost: 10 });
        var textDiff = diff.main($tdOld.text(), $tdNew.text());
        const result = diff.prettyHtml(textDiff).replace(/<br\/><br\/>/gi, '<br/>');
        $tdOld.html(result).addClass('diff-applied');
        $tdNew.remove();
    }
);

GM_addStyle('.activity-old-val span.ins { text-decoration: none; background: lightgreen; padding: 0 3px 0 0; }');
GM_addStyle('.activity-old-val span.del { text-decoration: none; background: lightpink; padding: 0 3px 0 0; }');

