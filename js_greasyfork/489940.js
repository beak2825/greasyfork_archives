// ==UserScript==
// @name         NamuWiki Thread Administration Tool
// @namespace    http://tampermonkey.net/
// @version      0.8.7.1
// @description  토론 간편 관리를 위한 도구를 제공합니다.
// @author       Yor
// @match        *://theseed.io/*
// @match        *://namu.wiki/*
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/1.1.1/progressbar.min.js
// @require      https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js
// @require      https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js
// @require      https://cdn.jsdelivr.net/npm/linkify-html@4.1.3/dist/linkify-html.min.js
// @resource     MODAL https://rawcdn.githack.com/YorKR/test/4ddb167dd41c19643f2345298b168ebcb86e66cb/styles.css
// @icon         https://cdn-icons-png.flaticon.com/512/5828/5828587.png
// @license      MIT
// @grant        GM_getResourceText
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @grant        unsafeWindow
// @connect      ipinfo.io
// @connect      raw.githubusercontent.com
// @run-at       document-end
// @noframes
// @downloadURL https://update.greasyfork.org/scripts/489940/NamuWiki%20Thread%20Administration%20Tool.user.js
// @updateURL https://update.greasyfork.org/scripts/489940/NamuWiki%20Thread%20Administration%20Tool.meta.js
// ==/UserScript==

let observer,wikiTheme;const new_ver="0.8.7.1",applyTheme=()=>{const e=JSON.parse(localStorage.getItem("theseed_settings"))||{};wikiTheme=e["wiki.theme"]||"auto",document.documentElement.classList.toggle("dark","dark"===e["wiki.theme"]||"light"!==e["wiki.theme"]&&matchMedia("(prefers-color-scheme: dark)").matches)},restoreButtonPosition=()=>{const e=document.getElementById("recycle_btn");if(e){const t=window.innerHeight/2;window.scrollTo({top:e.offsetTop-t})}},hideLogBtn=()=>{if(document.getElementById("hidelog_btn"))return;const e=Array.from(document.querySelectorAll("button")).find((e=>e.textContent.includes("선택 리비전 비교")));if(e){const t=document.createElement("div");t.style.display="flex",t.style.justifyContent="space-between";const n=e.parentElement;if(n){t.appendChild(e);const o=createBtn("hidelog_btn","ion-md-eye-off","일괄 관리",(async function(){await Swal.fire({theme:wikiTheme,template:"#input",html:'\n                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">\n                            <label style="flex: 1 1 auto; white-space: nowrap;"><input type="radio" name="action" value="[A]반달로 표시" checked> 반달로 표시</label>\n                            <label style="flex: 1 1 auto; white-space: nowrap;"><input type="radio" name="action" value="[A]반달표시 해제"> 반달표시 해제</label>\n                        </div>\n                    ',input:"text",inputPlaceholder:"대상자를 입력해 주세요.",inputValidator:e=>e?null:"입력값은 필수입니다.",showLoaderOnConfirm:!0,preConfirm:async e=>{const t=document.querySelector('input[name="action"]:checked').value,n=[...document.querySelectorAll("li")].filter((t=>t.querySelector(".v-popper")?.textContent.trim()===e)).flatMap((e=>[...e.querySelectorAll('a[rel="nofollow"]')])).filter((e=>e.textContent.trim()===t));await Promise.all(n.map(((e,t)=>new Promise((e=>setTimeout(e,300*t))).then((()=>e.click())))))}})}));t.appendChild(o),n.appendChild(t)}}};function preventCopyAdminAButtons(){const e=["[A]반달로 표시","[A]편집요약 숨기기","[A]리비전 숨기기","[A]반달표시 해제","[A]편집요약 숨기기 해제","[A]리비전 숨기기 해제"],t="user-select:none;-webkit-user-select:none",n=document.querySelectorAll('a[rel="nofollow"]:not([data-no-drag])');for(const o of n)if(e.includes(o.textContent.trim())){o.setAttribute("data-no-drag",""),o.style.cssText+=t;const e=o.previousElementSibling;if("none"===e?.style.userSelect&&e.textContent.includes("|"))continue;const n=o.previousSibling;if(3===n?.nodeType){const e=n.textContent,r=e.lastIndexOf("|");if(-1!==r){const a=document.createElement("span");a.style.cssText=t;const i=e.slice(0,r).match(/\u00A0+$/),s=i?r-i[0].length:r;a.textContent=e.slice(s),n.textContent=e.slice(0,s),n.parentNode.insertBefore(a,o)}}}}const searchIP=()=>{const e=document.querySelector('input[name="from"]');if(!e)return;const t=e.parentNode;let n=document.getElementById("order_select");if(!n){n=document.createElement("select"),n.id="order_select";["ID","CIDR"].forEach((e=>n.add(new Option(e,e)))),Array.from(e.attributes).forEach((e=>{e.name.startsWith("data-v-")&&n.setAttribute(e.name,e.value)})),t.insertBefore(n,e)}n.value="ID"===e.placeholder?"ID":"CIDR";const o={ipv4:/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,ipv6:/^([0-9a-fA-F]{1,4}:){1,7}([0-9a-fA-F]{1,4}|:)$/,ipv4WithCIDR:/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\/([0-9]|[1-2][0-9]|3[0-2]))?$/,ipv6WithCIDR:/^([0-9a-fA-F]{1,4}:){1,7}([0-9a-fA-F]{1,4}|:)(\/(1[0-1][0-9]|12[0-8]|[1-9]?[0-9]))?$/};n.addEventListener("change",(()=>{"CIDR"===n.value&&Swal.fire({theme:wikiTheme,template:"#search",inputLabel:"IP 주소를 입력해 주세요",inputPlaceholder:"CIDR 또는 단일 IP 주소를 입력...",preConfirm:e=>o.ipv4WithCIDR.test(e)?e.split("/")[0]:o.ipv6WithCIDR.test(e)?(e=>{const[t,n]=e.split("::").map((e=>e.split(":"))),o=Array(8-(t.length+(n?n.length:0))).fill("0000");return[...t,...o,...n||[]].map((e=>e.padStart(4,"0"))).join(":")})(e.split("/")[0]):(Swal.showValidationMessage("유효한 IP 주소를 입력해 주세요."),!1)}).then((e=>{if(e.isConfirmed){const t=new URL(window.location.href);t.searchParams.set("ip",e.value),window.location.href=t.toString()}}))}))},urlHighlighter=e=>{const t=document.querySelectorAll(e),n=location.origin,o=/"([0-9]{1,3}(?:\.[0-9]{1,3}){3}|(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:)*::(?:[0-9a-fA-F]{1,4}:)*[0-9a-fA-F]{1,4})" 기여 목록/g,r=/편집 요청 ([A-Z][a-zA-Z]+)/g,a=/토론 ([A-Z][a-zA-Z]+)(?: #(\d+))?/g,i=/(문서:(.+?)) r(\d+)/g,s=new RegExp(`((${["파일","분류","틀","템플릿","사용자","나무위키","휴지통","파일휴지통","위키운영","투표","토론","특수기능","시스템","특정판","삭제된사용자"].join("|")}):)(.+?) r(\\d+)`,"g");t.forEach((e=>{for(let t of e.childNodes){if(t.nodeType!==Node.TEXT_NODE)continue;const e=t.nodeValue;let c=e.replace(o,((e,t)=>`<a href="${n}/contribution/ip/${t}">"${t}" 기여 목록</a>`)).replace(r,((e,t)=>`<a href="${n}/edit_request/${t}">편집 요청 ${t}</a>`)).replace(a,((e,t,o)=>o?`<a href="${n}/thread/${t}#${o}">토론 ${t} #${o}</a>`:`<a href="${n}/thread/${t}">토론 ${t}</a>`)).replace(i,((e,t,o,r)=>`<a href="${n}/history/${encodeURIComponent(o)}?from=${r}">${t} r${r}</a>`)).replace(s,((e,t,o,r,a)=>`<a href="${n}/history/${encodeURIComponent(`${o}:${r}`)}?from=${a}">${t}${r} r${a}</a>`));if(c=linkifyHtml(c),c===e)continue;const l=document.createDocumentFragment(),d=document.createElement("div");for(d.innerHTML=c,d.querySelectorAll("a").forEach((e=>e.classList.add("custom-link")));d.firstChild;)l.appendChild(d.firstChild);t.replaceWith(l)}}))};function createBtn(e,t,n,o){const r=document.createElement("button");return r.className="namu-refresher-btn",r.id=e,r.innerHTML=`<span class="${t}"></span><span>${n}</span>`,r.style.userSelect="none",r.addEventListener("click",o),r}async function ipInfo(){if(document.getElementById("ip-info-button"))return;const e=document.querySelector(".v-popper__inner");if(!e)return;const t=[...e.querySelectorAll("div")].find((e=>"IP"===e.textContent.trim()))?.parentElement;if(!t)return;const n=t.querySelector("div:nth-child(2)");if(!n)return;const[o]=n.textContent.trim().split(" ");if(!(e=>/^(25[0-5]|2[0-4][0-9]|[0-1]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[0-1]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[0-1]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[0-1]?[0-9][0-9]?)$/.test(e)||/^(?:[0-9a-fA-F]{1,4}:){7}(?:[0-9a-fA-F]{1,4}|:)|^(?:[0-9a-fA-F]{1,4}:){1,7}|^::$|^(?:[0-9a-fA-F]{1,4}:){1,6}::$|^(?:[0-9a-fA-F]{1,4}:){1,5}(?::[0-9a-fA-F]{0,1}:|$)/.test(e))(o))return;const r=e.querySelector('a[href*="/document"]');if(r&&!document.getElementById("ip-info-button")){const e=document.createElement("a");e.textContent="IP 정보 조회",e.href=`https://ipinfo.io/${o}`,e.id="ip-info-button",e.className=r.className,[...r.attributes].forEach((t=>{t.name.startsWith("data-v-")&&e.setAttribute(t.name,t.value)})),r.insertAdjacentElement("beforebegin",e)}const a=`ipinfo_${o}`,i=sessionStorage.getItem(a);if(i){const{country:e,org:r}=JSON.parse(i);n.textContent=`${o} ${e}`;let a=t.querySelector("div.ip-info-org");return a||(a=document.createElement("div"),a.className="ip-info-org",a.style.fontSize="0.8rem",n.insertAdjacentElement("afterend",a)),void(a.textContent=r)}const s=n.textContent,c=document.createElement("style");c.textContent="\n        :root {\n            --skeleton-bg: #E0E0E0;\n            --skeleton-animation-1: #E0E0E0;\n            --skeleton-animation-2: #E8E8E8;\n        }\n\n        .theseed-dark-mode {\n            --skeleton-bg: #2A2A2A;\n            --skeleton-animation-1: #2A2A2A;\n            --skeleton-animation-2: #313131;\n        }\n\n        @keyframes skeleton-loading {\n            0% {\n                background-color: var(--skeleton-animation-1);\n            }\n            100% {\n                background-color: var(--skeleton-animation-2);\n            }\n        }\n    ",document.head.appendChild(c);const l=document.createElement("div");l.className="ip-info-skeleton",l.style.cssText="\n        height: 0.8rem;\n        line-height: 0.8rem;\n        background-color: var(--skeleton-bg);\n        border-radius: 4px;\n        margin-top: 4px;\n        animation: skeleton-loading 1.5s infinite ease-in-out;\n    ";let d=t.querySelector("div.ip-info-org");d||(d=document.createElement("div"),d.className="ip-info-org",d.style.fontSize="0.8rem",d.style.lineHeight="0.8rem",n.insertAdjacentElement("afterend",d)),d.textContent="",d.appendChild(l);const{country:u,org:m}=await(e=>new Promise(((t,n)=>{GM_xmlhttpRequest({method:"GET",url:`https://ipinfo.io/${e}/json`,onload:function(e){if(e.status>=200&&e.status<300)try{const{country:o="",org:r=""}=JSON.parse(e.responseText);t({country:(n=o,n.toUpperCase().split("").map((e=>String.fromCodePoint(127462+e.charCodeAt(0)-65))).join("")),org:r})}catch(n){t({country:"",org:`${e.status} ${e.statusText}`})}else t({country:"",org:`${e.status} ${e.statusText}`});var n},onerror:function(){t({country:"",org:`${status} ${title}`})}})})))(o);d.removeChild(l),n.textContent=`${s} ${u}`,d.textContent=m,sessionStorage.setItem(a,JSON.stringify({country:u,org:m}))}const formatTime=e=>{if(e<1e3)return`${e}ms`;const t=Math.round(e/1e3);if(t<60)return`${t}초`;const n=Math.round(t/60);if(n<60)return`${n}분`;const o=Math.floor(n/60),r=n%60;return 0===r?`${o}시간`:`${o}시간 ${r}분`},fetchIpApiData=async e=>{const t=`https://raw.githubusercontent.com/ipverse/asn-ip/master/as/${e}/aggregated.json`,n=await fetch(t);if(!n.ok)throw new Error(await n.text());const{asn:o,description:r,subnets:a}=await n.json();return{asn:o,org:r,prefixes:[...a?.ipv4||[],...a?.ipv6||[]]}},delay=e=>new Promise((t=>setTimeout(t,e))),createProgressBar=(e,t,n,o)=>new Promise((r=>{Swal.fire({theme:wikiTheme,allowOutsideClick:!1,showCancelButton:!0,cancelButtonText:"취소",showConfirmButton:!1,html:`\n            <div style="display:flex;flex-direction:column;align-items:center;width:100%">\n                <p style="margin:0;">AS${e}(${t})에 속한 IP를 차단하고 있어요. 창을 벗어나지 마세요.</p>\n                <p id="progress-bar-text" style="margin:10px 0;">0% (0/${n})</p>\n                <div id="progress-bar-container" style="width:100%;margin-top:10px;"></div>\n            </div>`,didOpen:()=>{const e=new ProgressBar.Line("#progress-bar-container",{easing:"easeInOut",trailColor:o,svgStyle:{width:"100%",height:"100%"},from:{color:"#00a69c"},to:{color:"#28b472"},step:(e,t)=>t.path.setAttribute("stroke",e.color)});r(e)}})})),updateProgressBar=(e,t,n,o)=>{try{e.animate(t,{duration:100});const r=Swal.getHtmlContainer()?.querySelector("#progress-bar-text");r&&(r.textContent=`${Math.round(100*t)}% (${n}/${o})`)}catch(e){}},overrideFetchForCapture=(e,t,n)=>{const o=unsafeWindow.fetch;return unsafeWindow.fetch=async(r,a={})=>{const{body:i,method:s}=a;if("POST"===s&&i instanceof URLSearchParams){const o=Object.fromEntries(i.entries());o.ip===e.value&&o.note===t&&(n.url=r,n.options={...a,body:new URLSearchParams(i.toString())})}return o(r,a)},()=>{unsafeWindow.fetch=o}},blockIPs=async(e,t,n,o)=>{const r=document.querySelector('input[name="ip"]'),a=document.querySelector('input[name="note"]'),i=[...document.querySelectorAll("button")].find((e=>e.textContent.includes("추가")));if(!i||i.disabled)return Swal.fire({theme:wikiTheme,template:"#error",text:"권한이 부족합니다."});const s=document.body.classList.contains("theseed-dark-mode")?"#333":"#eee",c=await createProgressBar(e,t,n.length,s),l=Swal.getHtmlContainer();let d=!1;Swal.getCancelButton()?.addEventListener("click",(()=>{d=!0,c.stop()}));const u={},m=overrideFetchForCapture(r,o,u),p=async()=>{const e=Object.assign(document.createElement("p"),{id:"cooldown-message",style:"margin-top:.5rem;font-size:0.875rem;color:gray;"});l?.appendChild(e);for(let t=5;t>0&&!d;t--)e.textContent=`서버 안정화를 위해 잠시 쉬고 있어요. ${t}초 후에 이어서 처리됩니다...`,await delay(1e3);e.remove()};try{for(let e=0;e<n.length&&!d;e++){0!==e&&e%200==0&&await p();const t=n[e];if(0===e)r.value=t,a.value=o,i.click();else if(u.url&&u.options){const e=new URLSearchParams(u.options.body);e.set("ip",t);if(!(await fetch(u.url,{...u.options,body:e})).ok)throw new Error(`차단 실패 (${t})`)}updateProgressBar(c,(e+1)/n.length,e+1,n.length)}const s=d?"작업이 취소되었어요.":`AS${e}(${t})에 속한 IP 대역 차단이 완료되었어요.`;d||(c.animate(1),updateProgressBar(c,1,n.length,n.length)),await Swal.fire({theme:wikiTheme,template:d?"#error":"#success",text:s})}catch(e){await Swal.fire({theme:wikiTheme,template:"#error",text:e?.message||"Something went wrong."})}finally{m(),Swal.close()}},aclgroup=()=>{const e=[...document.querySelectorAll("button")].find((e=>e.textContent.includes("추가")));if(!e||document.getElementById("batch_btn"))return;const t=Object.assign(document.createElement("div"),{style:"display: flex"});e.parentNode.insertBefore(t,e);const n=createBtn("batch_btn","ion-md-cloud-done","대역(ASN) 차단",(async()=>{const{isConfirmed:e,value:t}=await Swal.fire({theme:wikiTheme,template:"#search",text:"ASN을 입력해 주세요.",input:"text",inputPlaceholder:"예: AS13335",preConfirm:async e=>{const t=e.replace(/^AS/i,"");try{return await fetchIpApiData(t)}catch(e){return Swal.showValidationMessage(`${e}`),!1}}});if(!e)return;const{asn:n,org:o,prefixes:r=[]}=t;if(0===r.length)return Swal.fire({theme:wikiTheme,template:"#error",text:`AS${n}(${o})에 속한 IP 대역이 없습니다. (Inactive)`});const a=formatTime(Math.round(100*r.length+r.length/200*5e3));(await Swal.fire({theme:wikiTheme,template:"#warning",html:`AS${n}(${o})에 속한 IP 대역을 차단하시겠어요?<br>(예상 소요: ${a})`,confirmButtonText:"차단"})).isConfirmed&&await blockIPs(n,o,r,`AS${n}(${o})`)}));t.append(e,n),Object.assign(n,{type:"button",style:"margin-left: auto; font: inherit; cursor: pointer; display: flex; align-items: center; justify-content: center;"})};function loginAllowCheckbox(){const e=document.querySelector('form[action="/aclgroup"]');if(!e||"빠른 ACLGroup"!==e.querySelector("h4")?.textContent.trim())return;const t="login-checkbox-container",n=" | 현재 이용 중인 IP는 문서 훼손이 잦아 비로그인 편집이 제한되어 있습니다. 로그인 후 이용하실 수 있습니다.";e.querySelector('select[name="group"]')?.addEventListener("change",(o=>(o=>{let r=document.getElementById(t);if(o){if(!r){r=document.createElement("div"),r.id=t,r.style.display="flex",r.style.alignItems="center",r.innerHTML='\n                    <input type="checkbox" id="login-checkbox" name="login-checkbox">\n                    <label for="login-checkbox" style="margin-left: 5px;">로그인 허용 차단 안내</label>\n                ';const o=e.querySelector('input[name="note"]')?.parentElement;o?.insertAdjacentElement("afterend",r);const a=r.querySelector("#login-checkbox");a.addEventListener("change",(()=>{const t=e.querySelector('input[name="note"]'),o=t.value.includes(n);a.checked&&!o?t.value+=n:!a.checked&&o&&(t.value=t.value.replace(n,"")),t.dispatchEvent(new Event("input",{bubbles:!0}))}))}}else r?.remove()})("로그인 허용 차단"===o.target.value)));const o=e.querySelector('input[name="note"]')?.parentElement;if(o&&!document.querySelector("#paste-button")){const e=document.createElement("button");e.type="button",e.id="paste-button";const t=[...document.querySelectorAll("button")].find((e=>"취소"===e.textContent.trim()));t&&[...t.attributes].forEach((({name:t,value:n})=>{(t.startsWith("data-v-")||"class"===t)&&e.setAttribute(t,n)})),e.classList.add("ion-md-clipboard"),e.style.cssText="padding-top: 0; padding-bottom: 0; display: flex; align-items: center; position: relative; left: -1px;";const n=document.createElement("div");n.style.cssText="display: flex; align-items: stretch;";const r=o.querySelector('input[name="note"]'),a=o.querySelector("p");a&&o.insertBefore(a,o.firstChild),r&&(n.append(r,e),o.appendChild(n)),e.addEventListener("click",(async()=>{try{const e=await navigator.clipboard.readText();r.value=e,r.dispatchEvent(new Event("input",{bubbles:!0}))}catch{Swal.fire({theme:wikiTheme,toast:!0,position:"top-end",timer:1e4,timerProgressBar:!0,showConfirmButton:!1,text:"클립보드에 접근할 수 없습니다. 클립보드 권한을 허용해 주세요.",icon:"warning"})}}))}}function aclgroupOption(){const e=document.querySelector('form[action="/aclgroup"]');if(!document.getElementById("block_options_container")){const t=document.createElement("div");t.id="block_options_container",t.style.cssText="margin-bottom: 8px; display: flex; align-items: center;",t.innerHTML='\n            <input type="checkbox" id="block_edit_request" name="block_edit_request">\n            <label for="block_edit_request" style="margin-left: 5px;">편집 요청 차단(베타)</label>\n        ',e.querySelector('button[type="submit"]')?.parentNode.insertAdjacentElement("beforebegin",t);const n=document.getElementById("block_edit_request");n?.addEventListener("change",(()=>{modifyFetch(n.checked?"active":"deactive",n.checked?"편집요청 차단":"")}))}}const originalFetch=unsafeWindow.fetch;function modifyFetch(e,t){unsafeWindow.fetch="deactive"===e?async(e,t={})=>{try{if(!sessionStorage.getItem("x-chika")&&t.headers){const e=new Headers(t.headers);if(e.has("x-chika")){const t=e.get("x-chika");sessionStorage.setItem("x-chika",t)}}}catch(e){}return originalFetch(e,t)}:async(e,n={})=>{const{body:o,method:r}=n,a=await originalFetch(e,n).then((e=>e.clone())).catch((e=>{}));if(o instanceof URLSearchParams){const a=Object.fromEntries(o.entries());if("POST"===r&&a.group){t&&(a.group=t);try{const t=await originalFetch(e,{...n,body:new URLSearchParams(a)});return t.ok,t}catch(e){}}}return a}}function setRollBackOption(){let e;const t=document.querySelector('.v-popper__inner a[href*="/contribution/"][href*="/document"][role="button"]');if(t){const n=/\/contribution\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\/document/,o=t.getAttribute("href").match(n);o&&o[1]&&(e=o[1])}if(!e){const t=document.querySelector('a[href^="/BlockHistory"][href*="query="]');if(t){const n=t.getAttribute("href"),o=new URLSearchParams(n.split("?")[1]).get("query");o&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/.test(o)&&(e=o)}}e&&sessionStorage.setItem("uuid",e);const n=document.querySelector('form[action="/aclgroup"]');if(n&&"빠른 ACLGroup"===n.querySelector("h4")?.textContent.trim()){if(!document.getElementById("checkbox-container")){const e=document.createElement("div");e.id="checkbox-container",e.style.cssText="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;",e.innerHTML=[{id:"close-edit-request",label:"편집 요청 닫기"},{id:"hide-discussion-comments",label:"토론 댓글 숨기기"},{id:"undo-edit",label:"편집 되돌리기"}].map((({id:e,label:t})=>`\n          <div style="display: flex; align-items: center;">\n              <input type="checkbox" id="${e}" name="${e}">\n              <label for="${e}" style="margin-left: 5px;">${t}</label>\n          </div>\n      `)).join(""),n.querySelector('button[type="submit"]')?.parentNode.insertAdjacentElement("beforebegin",e)}n.addEventListener("submit",(e=>{e.preventDefault();const t=n.querySelector('input[name="note"]').value,o=["close-edit-request","hide-discussion-comments","undo-edit"].filter((e=>document.getElementById(e)?.checked));t&&o.length&&rollback({uuid:sessionStorage.getItem("uuid"),note:t,checkboxes:o})}))}}function rollback({uuid:e,note:t,checkboxes:n}){const o=()=>{const e=document.getElementById("rollback-iframe");e&&document.body.removeChild(e),sessionStorage.removeItem("uuid")};Swal.fire({theme:wikiTheme,template:"#info",text:"최근 활동을 모두 되돌리고 있어요.",showConfirmButton:!1,reverseButtons:!1,didOpen:()=>{Swal.showLoading(),performIframeOperation({uuid:e,note:t,checkboxes:n,onResult:e=>{e.error?Swal.fire({theme:wikiTheme,template:"#error",text:e.error}):e.success&&Swal.fire({theme:wikiTheme,template:"#success",text:"작업이 완료되었어요.",html:`<div>${e.success}</div>`,showCancelButton:!1}),o()}})},willClose:o})}function performIframeOperation({uuid:e,note:t,checkboxes:n,onResult:o}){let r=document.getElementById("rollback-iframe");r||(r=document.createElement("iframe"),r.id="rollback-iframe",r.src="/admin/batch_revert",r.style.cssText="width: 0; height: 0; position: fixed; top: 0; left: 0; visibility: hidden",document.body.appendChild(r));const a=(e,t,n=9e4)=>new Promise(((o,r)=>{const a=e.querySelector(t);if(a)return void o(a);const i=new MutationObserver((n=>{n.forEach((n=>{const r=e.querySelector(t);r&&(i.disconnect(),o(r))}))}));i.observe(e.body,{childList:!0,subtree:!0}),setTimeout((()=>{i.disconnect(),r("작업 시간이 초과되었습니다.")}),n)})),i=e=>{const t={"uuid의 값은 필수입니다.":"세션이 만료되었습니다. 새로고침 후 다시 시도해 주세요.","reason의 값은 필수입니다.":"메모를 입력했는지 다시 확인해 주세요."},n=e.textContent.trim();for(const[e,o]of Object.entries(t))if(n.startsWith(e))return o;return n.includes("[오류!]")?n:null},s=setInterval((()=>{const c=r.contentDocument;c&&"complete"===c.readyState&&(clearInterval(s),(async()=>{const s=r.contentDocument;if("complete"===s.readyState)try{const r=await a(s,"#uuidInput"),c=await a(s,"#reasonInput"),l=Array.from(s.querySelectorAll('button[type="submit"]')).find((e=>e.textContent.includes("실행")));if(r&&c&&l){r.value=e,c.value=t;const a={"close-edit-request":"close_editrequestsInput","hide-discussion-comments":"hide_threadInput","undo-edit":"revert_documentInput"};Object.entries(a).forEach((([e,t])=>{const o=s.querySelector(`#${t}`);o&&(o.checked=n.includes(e))}));const d=new MutationObserver((e=>{for(let t of e)t.addedNodes.forEach((e=>{if(e.nodeType===Node.ELEMENT_NODE){const t=i(e);if(t)return d.disconnect(),o({error:t});const n=e.querySelector("div ul"),r=e.querySelector("a");if(n&&r&&"확인"===r.textContent.trim())return d.disconnect(),o({success:n.innerHTML})}}))}));d.observe(s.body,{childList:!0,subtree:!0}),setTimeout((()=>{l?l.click():o({error:"Submit button not found."})}),500)}else o({error:"Required inputs or buttons are missing."})}catch(e){o({error:e})}})())}),500);r.onerror=()=>{clearInterval(s),o({error:"Iframe loading failed."})}}const createAdminControl=()=>{const e=["선택...","방기","뻘토론","발제 요건 미달","편집 분쟁 없음","의견 수렴","발제 철회","분쟁 당사자 동의","규정 위반","발제자 차단","분쟁 당사자 차단"];return new class{constructor(){this.observeChanges()}observeChanges(){const e=new MutationObserver((t=>{t.forEach((t=>{if("childList"===t.type||"subtree"===t.type){const t=Array.from(document.querySelectorAll("h3")).find((e=>e.textContent.includes("댓글 달기")));t&&(e.disconnect(),this.initAdminControl(t))}}))}));e.observe(document.body,{childList:!0,subtree:!0})}async initAdminControl(e){const t=window.location.pathname.split("/").pop();document.getElementById("admin_control")||(this.setupQuickPrefix(e),this.setupRecycleButton(e),this.setupTemplateSystem(t),this.showStrict())}async showStrict(){const e=e=>new Promise((t=>setTimeout(t,e))),t=(e,t=null)=>new Promise((n=>{const o=new MutationObserver((()=>{const r=document.querySelectorAll(e),a=t?Array.from(r).find((e=>e.textContent.includes(t))):r[0];a&&(o.disconnect(),n(a))}));o.observe(document.body,{childList:!0,subtree:!0});const r=document.querySelectorAll(e),a=t?Array.from(r).find((e=>e.textContent.includes(t))):r[0];a&&(o.disconnect(),n(a))})),n=async t=>{t&&(["touchstart","touchend"].forEach((e=>{t.dispatchEvent(new TouchEvent(e,{bubbles:!0,cancelable:!0}))})),t.click(),await e(100))},o=document.querySelector('div.v-popper.v-popper--theme-contextmenu span[role="button"]');if(!o)return;await n(o);const r=(await t("label","숨겨진 댓글 보이지 않기"))?.querySelector('input[type="checkbox"]');if(!r)return;await n(r);const a="div.v-popper.v-popper--shown.v-popper--theme-contextmenu",i=await t(a);var s;if(await n(i),await(s=a,new Promise((e=>{const t=new MutationObserver((()=>{document.querySelector(s)||(t.disconnect(),e())}));t.observe(document.body,{childList:!0,subtree:!0}),document.querySelector(s)||(t.disconnect(),e())}))),location.hash){await e(100);const t=location.hash;history.replaceState(null,"",location.pathname+location.search),location.hash=t}}setupQuickPrefix(t){const n=document.createElement("form");n.id="admin_control",n.innerHTML="[ADMIN] 빠른 말머리: ";const o=document.createElement("select");o.id="select_input",e.forEach((e=>{const t=document.createElement("option");t.text=e,o.add(t)})),o.selectedIndex=0,n.appendChild(o),t.parentNode.insertBefore(n,t.nextSibling),o.addEventListener("change",(async function(){const e=o.value;if("선택..."!==e){await Swal.fire({theme:wikiTheme,template:"#info",text:`정말로 '${e}' 처리하시겠어요?`,showLoaderOnConfirm:!0,preConfirm:async()=>{try{return await changeTopic(e),await delay(300),await restoreButtonPosition(),!0}catch(e){return Swal.showValidationMessage(e.toString()),!1}}});o.selectedIndex=0}}))}setupRecycleButton(e){const t=getSlug();if(!t)return;const n=sessionStorage.getItem("x-chika");if(!n)return;async function o(e,o){const r=await fetch(`${location.origin}/internal/admin/thread/${t}/${e}`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8","x-chika":n},body:new URLSearchParams(o)});if(!r.ok)throw new Error(`API 요청 실패: ${e}, status=${r.status}`);return r}const r=[async()=>{await o("document",{document:"휴지통:토론 휴지통"})},async()=>{await o("topic",{topic:"[redacted]"})},async()=>{await o("status",{status:"close"})}],a=createBtn("recycle_btn","ion-md-trash","휴지통으로 이동",(async function(){await Swal.fire({theme:wikiTheme,template:"#warning",text:"정말로 휴지통:토론 휴지통으로 이동하시겠어요?",showLoaderOnConfirm:!0,preConfirm:async()=>{for(let e=0;e<r.length;e++)try{await r[e]()}catch(e){return Swal.showValidationMessage(e.toString()),!1}return!0}})}));a.style.height="32px",e.appendChild(a)}setupTemplateSystem(e){const t=document.querySelector(`form[action="/thread/${e}"]`);if(!t)return;const n=t.querySelector('button[type="submit"]');if(!n)return;const o=document.createElement("select");o.id="template_dropdown",o.style.cssText="width: 8rem; background: transparent; color: var(--espejo-text-color); border: 1px; border-style:solid; border-color: var(--espejo-component-border-color); padding: 0px 8px;";const r=document.createElement("option");r.text="상용구 선택...",r.value="",o.add(r);JSON.parse(localStorage.getItem("templates")||"[]").forEach((e=>{const t=document.createElement("option");t.value=e.title,t.text=e.title,o.add(t)})),o.addEventListener("change",(function(){const e=o.value;e&&""!==e&&(typeTemplate(e),o.value="")}));const a=document.createElement("div");a.className="custom-dropdown-container",a.style.cssText="display: flex; flex-wrap:wrap; justify-content: space-between;",n.parentNode.insertBefore(a,n),a.appendChild(o),a.appendChild(n)}}};function getSlug(){const e=window.location.pathname.match(/^\/thread\/([A-Za-z]+)/);return e?e[1]:null}const submitForm=e=>new Promise((t=>{const n=window.location.pathname.split("/").pop(),o=document.querySelector(`form[action="/admin/thread/${n}/${e}"]`);o&&o.querySelector('button[type="submit"]')?(o.querySelector('button[type="submit"]').click(),t(!0)):t(!1)})),changeTopic=e=>{const t=document.querySelector('input[name="topic"]');if(!t)return!1;const n=t.value,o="redacted"===e?"[redacted]":`[${e}] ${n}`;return n!==o&&(t.value=o,submitForm("topic"))},changeDocument=async e=>{const t=document.querySelector('input[name="document"]');if(!t)return!1;if(t.value===e)return!1;t.value=e;return await submitForm("document")},changeStatus=async e=>{const t=document.querySelector('select[name="status"]');if(!t)return!1;const n=Array.from(t.options).map((e=>e.value));if(JSON.stringify(n)===JSON.stringify({close:["normal","pause"],normal:["normal","pause","close"],pause:["normal","close"]}[e]))return!1;t.value=e;return await submitForm("status")};function typeTemplate(e){const t=document.querySelector("textarea"),n=(JSON.parse(localStorage.getItem("templates"))||[]).find((t=>t.title===e));n&&(t.value=n.content,t.dispatchEvent(new Event("input",{bubbles:!0})))}function write(e){const t=window.location.pathname.split("/").pop(),n=document.querySelector("textarea");return n.value=e,n.dispatchEvent(new Event("input",{bubbles:!0})),document.querySelector(`form[action="/thread/${t}"]`).querySelector('button[type="submit"]').click(),!0}function wait(){return restoreButtonPosition(),new Promise(((e,t)=>{const n=new MutationObserver((o=>{restoreButtonPosition();for(let r of o)for(let o of r.addedNodes)if(o.nodeType===Node.ELEMENT_NODE){const r=o.querySelector("div strong"),a=o.querySelector("div span");if(r&&a&&r.textContent.includes("[오류!]"))return n.disconnect(),t(a.textContent),error;if(o.querySelector("b"))return n.disconnect(),void e()}}));n.observe(document.body,{childList:!0,subtree:!0})}))}function createModal(){document.querySelector('a[id="extension_setting"]')||document.querySelectorAll('a[href="/member/mypage"]').forEach((e=>{const t=createNewLink(e);insertNewLink(e,t),t.addEventListener("click",(e=>{e.preventDefault(),openModal()}))}))}function createNewLink(e){const t=document.createElement("a");return t.innerHTML='<div style="display:flex; flex-direction:row"><span style="align-items: center; display: flex; justify-content:center; margin-right:var(--espejo-dropdown-menu-item-icon-gap-var); width:1rem;"><span class="ion-md-color-wand"></span></span>관리 도구 설정</div>',t.href="#",t.id="extension_setting",[...e.attributes].forEach((e=>{e.name.startsWith("data-v-")&&t.setAttribute(e.name,e.value)})),t.className=e.className,t}function insertNewLink(e,t){const n=e.parentElement;n.children[3]?n.insertBefore(t,n.children[3]):n.appendChild(t)}function openModal(){const e=GM_getResourceText("MODAL");GM_addStyle(e);let t=document.getElementById("extension_modal");t||(t=document.createElement("div"),t.id="extension_modal",t.style.display="none",t.innerHTML=getModalContent(),document.body.appendChild(t),initEventListeners()),t.style.display="block"}function closeModal(){const e=document.getElementById("extension_modal");e&&(e.style.display="none");document.querySelectorAll("style").forEach((e=>{e.innerHTML.includes(GM_getResourceText("MODAL"))&&e.remove()}))}function getModalContent(){return'\n    <div id="nmst-modal" tabindex="-1" aria-hidden="true" class="nmst-modal overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">\n    <div class="relative p-4 w-full max-w-2xl max-h-full">\n    <div id="mainModalContent" class="flex flex-col gap-4 relative bg-white rounded-lg p-5 shadow dark:bg-zinc-900 w-full max-w-2xl">\n    <div class="flex justify-between items-center">\n    <h3 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">관리 도구 설정</h3>\n    <button class="close text-zinc-400 bg-transparent hover:text-zinc-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:text-white">\n    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24v24H0z" fill="none" />\n    <path d="M18 6l-12 12" />\n    <path d="M6 6l12 12" />\n    </svg>\n    <span class="sr-only">Close modal</span>\n    </button>\n    </div>\n    <div class="relative rounded-md shadow-sm">\n    <div class="pointer-events-none absolute flex h-full items-center pl-3">\n    <svg class="w-4 h-4 text-zinc-400 dark:text-zinc-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24v24H0z" fill="none" />\n    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />\n    <path d="M21 21l-6 -6" />\n    </svg>\n    </div>\n    <input type="text" name="search" id="simple-search" class="bg-transparent block w-full text-zinc-900 dark:text-zinc-100 rounded-md border-0 py-1.5 pl-9 pr-3 text-zinc-900 ring-1 ring-inset ring-zinc-200 dark:ring-zinc-700 placeholder:text-zinc-400 focus:outline-none focus:ring-1 focus:ring-inset focus:ring-emerald-500 text-sm leading-6" placeholder="검색어를 입력하세요">\n    </div>\n    <div class="flex justify-between items-center">\n    <div class="flex space-x-2">\n    <button id="importButton" type="button" class="h-9 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-md border border-zinc-200 bg-white text-zinc-800 shadow-sm hover:bg-zinc-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-100 dark:hover:bg-zinc-800">\n    <svg class="w-4 h-4 text-zinc-900 dark:text-zinc-100" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24v24H0z" fill="none" />\n    <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />\n    <path d="M7 9l5 -5l5 5" />\n    <path d="M12 4l0 12" />\n    </svg>\n    </button>\n    <input type="file" id="importFile" class="hidden" />\n    <button id="exportButton" type="button" class="h-9 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-md border border-zinc-200 text-zinc-800 shadow-sm hover:bg-zinc-50 disabled:opacity-50 disabled:pointer-events-none dark:border-zinc-700 dark:text-zinc-100 dark:hover:bg-zinc-800">\n    <svg class="w-4 h-4 text-zinc-900 dark:text-zinc-100" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24h24H0z" fill="none" />\n    <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />\n    <path d="M7 11l5 5l5 -5" />\n    <path d="M12 4l0 12" />\n    </svg>\n    </button>\n    </div>\n    <button id="addButton" type="button" class="h-9 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-md bg-emerald-500 text-white shadow-sm hover:bg-emerald-400 dark:hover:bg-emerald-600">등록</button>\n    </div>\n    <div class="flex flex-col">\n    <div class="min-w-full inline-block align-middle">\n    <div class="border border-zinc-200 rounded-md shadow-sm overflow-x-scroll dark:border-zinc-700">\n    <table id="templateTable" class="min-w-full divide-y divide-zinc-200 dark:divide-zinc-700">\n    <thead>\n    <tr>\n    <th scope="col" class="h-8 px-4 text-center text-xs font-medium text-zinc-500">#</th>\n    <th scope="col" class="h-8 px-4 text-start text-xs font-medium text-zinc-500">TITLE</th>\n    <th scope="col" class="h-8 px-4 w-full text-start text-xs font-medium text-zinc-500">BODY</th>\n    <th scope="col" class="h-8 px-4 text-center text-xs font-medium text-zinc-500">ACTION</th>\n    </tr>\n    </thead>\n    <tbody id="templateBody" class="divide-y divide-zinc-200 dark:divide-zinc-700">\n    <tr id="empty-row">\n    <td colspan="4" class="h-10 text-center text-sm text-zinc-400">No matches found.</td>\n    </tr>\n    </tbody>\n    </table>\n    </div>\n    </div>\n    </div>\n    </div>\n    <div id="editModalContent" class="hidden relative flex flex-col p-5 gap-4 bg-white rounded-lg shadow dark:bg-zinc-900 w-full max-w-2xl mx-auto">\n    <div class="flex justify-between items-center">\n    <button id="backButton" class="text-zinc-400 bg-transparent hover:text-zinc-900 text-sm mr-2 p-1.5 inline-flex items-center dark:hover:text-white">\n    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24h24H0z" fill="none" />\n    <path d="M15 6l-6 6l6 6" />\n    </svg>\n    <span class="sr-only">Back</span>\n    </button>\n    <h3 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">상용구 등록</h3>\n    <button class="close text-zinc-400 bg-transparent hover:text-zinc-900 rounded-lg text-sm ml-auto p-1.5 inline-flex items-center dark:hover:text-white">\n    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24h24H0z" fill="none" />\n    <path d="M18 6l-12 12" />\n    <path d="M6 6l12 12" />\n    </svg>\n    <span class="sr-only">Close modal</span>\n    </button>\n    </div>\n    <div>\n    <label for="editTitle" class="block mb-2 text-sm font-medium text-zinc-900 dark:text-zinc-100">제목</label>\n    <input type="text" id="editTitle" class="bg-transparent block w-full text-zinc-900 dark:text-zinc-100 rounded-md border-0 px-3 py-1.5 text-zinc-900 ring-1 ring-inset ring-zinc-200 dark:ring-zinc-700 placeholder:text-zinc-400 focus:outline-none focus:ring-1 focus:ring-inset focus:ring-emerald-500 text-sm leading-6" placeholder="제목을 입력하세요." required/>\n    </div>\n    <div>\n    <label for="editContent" class="block mb-2 text-sm font-medium text-zinc-900 dark:text-zinc-100">내용</label>\n    <textarea id="editContent" class="bg-transparent min-h-9 block w-full text-zinc-900 dark:text-zinc-100 rounded-md border-0 px-3 py-1.5 text-zinc-900 ring-1 ring-inset ring-zinc-200 dark:ring-zinc-700 placeholder:text-zinc-400 focus:outline-none focus:ring-1 focus:ring-inset focus:ring-emerald-500 text-sm leading-6" placeholder="내용을 입력하세요." required></textarea>\n    </div>\n    <div class="flex justify-end items-center space-x-2">\n    <button id="cancelButton" type="button" class="h-9 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-md border border-zinc-200 bg-white text-zinc-800 shadow-sm hover:bg-zinc-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-100 dark:hover:bg-zinc-800">취소</button>\n    <button id="saveButton" type="button" class="h-9 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-md bg-emerald-500 text-white shadow-sm hover:bg-emerald-400 dark:hover:bg-emerald-600">등록</button>\n    </div>\n    </div>\n    </div>\n    </div>\n  '}function initEventListeners(){const e=document.getElementById("addButton"),t=document.getElementById("editModalContent"),n=document.getElementById("mainModalContent"),o=document.getElementById("backButton"),r=document.getElementById("cancelButton"),a=document.querySelectorAll(".close"),i=document.getElementById("saveButton"),s=document.getElementById("templateBody"),c=document.getElementById("simple-search"),l=document.getElementById("editTitle"),d=document.getElementById("editContent"),u=document.getElementById("exportButton"),m=document.getElementById("importButton"),p=document.getElementById("importFile");let h=JSON.parse(localStorage.getItem("templates"))||[],f=-1,g=!1;const w=e=>{s.innerHTML="",0===e.length?s.innerHTML='<tr><td colspan="4" class="h-10 text-center text-sm text-zinc-400">No matches found.</td></tr>':e.forEach(((e,t)=>{const n=document.createElement("tr"),o=document.createElement("td"),r=document.createElement("td"),a=document.createElement("td"),i=document.createElement("td");o.className="p-4 text-center whitespace-nowrap text-sm text-gray-800 dark:text-neutral-200 handle",r.className="p-4 text-start text-sm font-medium text-gray-800 dark:text-neutral-200",a.className="p-4 w-full text-start text-sm text-gray-800 dark:text-neutral-200 break-all",i.className="p-4 whitespace-nowrap text-end text-sm font-medium",o.textContent=t+1,r.textContent=e.title;const c=document.createElement("div");c.className="line-clamp-3 whitespace-normal",c.textContent=e.content,a.appendChild(c);const l=document.createElement("button"),d=document.createElement("button"),u=document.createElement("div");l.type="button",l.className="h-6 px-3 inline-flex items-center text-xs font-medium rounded-md border border-gray-200 bg-white text-gray-500 shadow-sm hover:bg-gray-50 dark:bg-neutral-900 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800 editBtn",l.textContent="편집",l.onclick=()=>x(t),d.type="button",d.className="h-6 px-3 inline-flex items-center text-xs font-medium rounded-md border border-gray-200 bg-white text-red-500 shadow-sm hover:bg-gray-50 dark:bg-neutral-900 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800 deleteBtn",d.textContent="삭제",d.onclick=()=>{Swal.fire({theme:wikiTheme,template:"#info",text:"정말로 삭제하시겠어요?"}).then((e=>{e.isConfirmed&&k(t)}))},u.className="flex flex-col items-center space-y-1",u.appendChild(l),u.appendChild(d),i.appendChild(u),n.appendChild(o),n.appendChild(r),n.appendChild(a),n.appendChild(i),s.appendChild(n)}))},y=()=>localStorage.setItem("templates",JSON.stringify(h)),b=e=>{g&&(e.preventDefault(),e.returnValue="")},v=e=>{e?(n.classList.add("hidden"),t.classList.remove("hidden")):(t.classList.add("hidden"),n.classList.remove("hidden")),g=e,e?window.addEventListener("beforeunload",b):window.removeEventListener("beforeunload",b)};e.addEventListener("click",(()=>{f=-1,l.value="",d.value="",v(!0)})),o.addEventListener("click",(()=>v(!1))),r.addEventListener("click",(()=>v(!1))),i.addEventListener("click",(()=>{const e=l.value.trim(),t=d.value;e&&t?(-1===f?h.push({title:e,content:t}):h[f]={title:e,content:t},y(),w(h),v(!1)):alert("제목과 내용을 입력하세요.")})),a.forEach((e=>{e.addEventListener("click",(()=>{closeModal(),v(!1)}))})),c.addEventListener("input",(()=>{const e=c.value.toLowerCase();w(e?h.filter((t=>t.title.toLowerCase().includes(e)||t.content.toLowerCase().includes(e))):h)}));const x=e=>{const t=h[e];l.value=t.title,d.value=t.content,f=e,v(!0)},k=e=>{h.splice(e,1),y(),w(h)};w(h),new Sortable(s,{handle:".handle",animation:150,onEnd:()=>{const e=Array.from(s.children);h=e.map((e=>({title:e.querySelector("td:nth-child(2)").textContent,content:e.querySelector("td:nth-child(3)").textContent}))),y(),w(h)}}),u.addEventListener("click",(()=>{const e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(h)),t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download","templates.json"),document.body.appendChild(t),t.click(),t.remove()})),m.addEventListener("click",(()=>p.click())),p.addEventListener("change",(e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{try{const t=JSON.parse(e.target.result);Array.isArray(t)?(h=t,y(),w(h)):alert("Invalid JSON format")}catch(e){alert("Failed to parse JSON")}},e.readAsText(t)}}))}function generateUuidV7(){const e=new Uint8Array(16),t=Date.now();e[0]=t/2**40&255,e[1]=t/2**32&255,e[2]=t/2**24&255,e[3]=t/65536&255,e[4]=t/256&255,e[5]=255&t;const n=new Uint8Array(10);if("undefined"!=typeof crypto&&crypto.getRandomValues)crypto.getRandomValues(n);else for(let e=0;e<10;e++)n[e]=Math.floor(256*Math.random());e[6]=112|15&n[0],e[7]=n[1],e[8]=128|63&n[2];for(let t=0;t<7;t++)e[9+t]=n[3+t];let o="";for(let t=0;t<16;t++)o+=(e[t]<16?"0":"")+e[t].toString(16),3!==t&&5!==t&&7!==t&&9!==t||(o+="-");return o}function updateFields(e,t,n){const o=window.location.href.split("/move/")[1]||"",r="     ";let a=`휴지통:${generateUuidV7()}`;if(o.startsWith("%ED%8C%8C%EC%9D%BC:")){const e=o.includes(".")?o.split(".").pop():"";a=`파일휴지통:${generateUuidV7()}${e?`.${e}`:""}`}else if(o.startsWith("%ED%8C%8C%EC%9D%BC%ED%9C%B4%EC%A7%80%ED%86%B5:")){const e=o.includes(".")?o.split(".").pop():"";a=`파일휴지통:${generateUuidV7()}${e?`.${e}`:""}`}n?(e.value=a,t.value=localStorage.getItem("log")||r):(e.value="",t.value="",localStorage.setItem("log",r)),[e,t].forEach((e=>e.dispatchEvent(new Event("input"))))}function moveToBin(){if(document.getElementById("bin_check"))return;const e=document.querySelector('input[value="swap"]'),t=document.createElement("input"),n=document.createElement("label");t.type="checkbox",t.id="bin_check",n.style.cssText="user-select: none; display: inline-block; margin-left: 0.25rem",n.append(t," [A]휴지통으로 이동"),t.addEventListener("change",(()=>{const[e,n]=["title","log"].map((e=>document.querySelector(`input[name="${e}"]`)));updateFields(e,n,t.checked)}));const o=e.closest("label");o.parentNode.insertBefore(n,o.nextSibling),document.querySelector('input[name="log"]').addEventListener("input",(({target:e})=>{t.checked&&localStorage.setItem("log",e.value)}))}function updateNote(){localStorage.getItem("nmst_ver")!==new_ver&&Swal.fire({theme:wikiTheme,toast:!0,position:"top-end",title:"토론 관리 도구 업데이트 노트",timer:1e4,timerProgressBar:!0,html:'<p style="font-size:0.9rem; line-height:1.5;">[0.8.7]<br>· 차단 내역 외부 링크 표시가 개선되었어요.</p></div>',icon:"info",confirmButtonText:"확인했어요.",confirmButtonColor:"#3f82e6",didOpen:e=>{e.addEventListener("mouseenter",Swal.stopTimer),e.addEventListener("mouseleave",Swal.resumeTimer)}}).then((e=>{e.isConfirmed&&localStorage.setItem("nmst_ver",new_ver)}))}!function(){"use strict";document.body.insertAdjacentHTML("beforeend",'\n<template id="success">\n    <swal-icon type="success"></swal-icon>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="confirmButtonColor" value="#0275d8"/>\n</template>\n<template id="warning">\n    <swal-icon type="warning"></swal-icon>\n    <swal-param name="showCancelButton" value="true"/>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="cancelButtonText" value="취소"/>\n    <swal-param name="reverseButtons" value="true"/>\n    <swal-param name="confirmButtonColor" value="#d9534f"/>\n</template>\n<template id="error">\n    <swal-icon type="error"></swal-icon>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="confirmButtonColor" value="#d9534f"/>\n</template>\n<template id="info">\n    <swal-icon type="info"></swal-icon>\n    <swal-param name="showCancelButton" value="true"/>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="cancelButtonText" value="취소"/>\n    <swal-param name="reverseButtons" value="true"/>\n    <swal-param name="confirmButtonColor" value="#0275d8"/>\n</template>\n<template id="input">\n    <swal-param name="showCancelButton" value="true"/>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="cancelButtonText" value="취소"/>\n    <swal-param name="reverseButtons" value="true"/>\n    <swal-param name="confirmButtonColor" value="#d9534f"/>\n</template>\n<template id="search">\n    <swal-param name="showCancelButton" value="true"/>\n    <swal-param name="confirmButtonText" value="검색"/>\n    <swal-param name="cancelButtonText" value="취소"/>\n    <swal-param name="reverseButtons" value="true"/>\n    <swal-param name="input" value="text"/>\n    <swal-param name="input" value="text"/>\n    <swal-param name="showLoaderOnConfirm" value="true"/>\n    <swal-param name="confirmButtonColor" value="#0275d8"/>\n</template>'),document.head.insertAdjacentHTML("beforeend",'<style>\n.custom-link {\n    color: #090;\n}\n\n.custom-link:hover {\n    color: #090;\n}\n\n.custom-link::before {\n    content: "";\n    background: green;\n    color: #fff;\n    font-family: "Ionicons" !important;\n    padding: 0 .15em;\n}\n\n.namu-refresher-btn {\n    display: flex;\n    gap: 0.5rem;\n    align-items: center;\n    background-color: #ef4544;\n    border: 0;\n    border-radius: 0.25rem;\n    font-size: 0.9rem;\n    color: #fff;\n    float: right;\n    padding: 0rem 0.75rem;\n    cursor: pointer;\n    transition: background-color .1s ease-in, box-shadow .1s linear;\n}\n\n.theseed-dark-mode .namu-refresher-btn {\n    background-color: #801d1c;\n}\n\n.theseed-dark-mode .namu-refresher-btn:hover {\n    background-color: #8d101d;\n}\n\n.namu-refresher-btn:hover {\n    background-color: #f15957;\n}\n\n#nmst-modal {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    width: 100%;\n    height: 100%;\n    z-index: 999;\n    background: rgba(0, 0, 0, 0.5);\n}\n\n.handle {\n    cursor: move;\n}\n</style>');const e={childList:!0,subtree:!0},t=new Map([["/thread/",()=>{createAdminControl()}],["/BlockHistory",()=>o("li span")],["/history/",()=>{o("li span"),hideLogBtn(),preventCopyAdminAButtons()}],["/w/%EC%82%AC%EC%9A%A9%EC%9E%90:",()=>o("div:has(time[datetime]):has(span:first-child + br)")],["/edit_request/",()=>o("div:has(label)")],["/aclgroup",()=>{aclgroup(),searchIP()}],["/move/",moveToBin]]);applyTheme(),updateNote();const n=new MutationObserver((()=>{createModal(),applyTheme(),ipInfo(),"빠른 ACLGroup"===document.querySelector('form[action="/aclgroup"] h4')?.textContent.trim()?(setRollBackOption(),aclgroupOption(),loginAllowCheckbox()):modifyFetch("deactive","");const e=location.pathname;for(const[n,o]of t)if(e.startsWith(n)){o();break}}));function o(t){n.disconnect(),urlHighlighter(t),n.observe(document.body,e)}n.observe(document.body,e),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",applyTheme)}();