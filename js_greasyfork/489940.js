// ==UserScript==
// @name         NamuWiki Thread Administration Tool
// @namespace    http://tampermonkey.net/
// @version      0.9.0-beta
// @description  토론 간편 관리를 위한 도구를 제공합니다.
// @author       Yor
// @match        *://theseed.io/*
// @match        *://namu.wiki/*
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/1.1.1/progressbar.min.js
// @require      https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js
// @require      https://cdn.jsdelivr.net/npm/linkifyjs@4.1.3/dist/linkify.min.js
// @require      https://cdn.jsdelivr.net/npm/linkify-html@4.1.3/dist/linkify-html.min.js
// @resource     MODAL https://rawcdn.githack.com/YorKR/test/4ddb167dd41c19643f2345298b168ebcb86e66cb/styles.css
// @icon         https://cdn-icons-png.flaticon.com/512/5828/5828587.png
// @license      MIT
// @grant        GM_getResourceText
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @grant        unsafeWindow
// @connect      ip.guide
// @connect      githubusercontent.com
// @noframes
// @downloadURL https://update.greasyfork.org/scripts/489940/NamuWiki%20Thread%20Administration%20Tool.user.js
// @updateURL https://update.greasyfork.org/scripts/489940/NamuWiki%20Thread%20Administration%20Tool.meta.js
// ==/UserScript==

let observer,wikiTheme;const new_ver="0.9.0-beta",xChika=sessionStorage.getItem("x-chika");function initXChikaInterceptor(){const e="undefined"!=typeof unsafeWindow?unsafeWindow:window;if(e.isInterceptorInitialized)return;e.isInterceptorInitialized=!0;const t=e.fetch;e.fetch=new Proxy(t,{apply:(n,o,r)=>{const a=r[1];return a?.headers?.["X-Chika"]&&(e.sessionStorage.setItem("x-chika",a.headers["X-Chika"]),e.fetch=t),n.apply(o,r)}})}const applyTheme=()=>{const e=JSON.parse(localStorage.getItem("theseed_settings"))||{};wikiTheme=e["wiki.theme"]||"auto",document.documentElement.classList.toggle("dark","dark"===e["wiki.theme"]||"light"!==e["wiki.theme"]&&matchMedia("(prefers-color-scheme: dark)").matches)},hideLogBtn=()=>{if(document.getElementById("hidelog_btn"))return;const e=[...document.querySelectorAll("button")].find((e=>e.textContent.includes("선택 리비전 비교")));if(!e)return;const t=document.createElement("div");t.style.cssText="display:flex;justify-content:space-between";const n=e.parentElement;t.appendChild(e);const o=createBtn("hidelog_btn","ion-md-eye-off","일괄 관리",(async function(){await Swal.fire({theme:wikiTheme,template:"#input",html:'\n                    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">\n                        <label><input type="radio" name="action" value="mark" checked> 반달로 표시</label>\n                        <label><input type="radio" name="action" value="unmark"> 반달표시 해제</label>\n                    </div>\n                ',input:"text",inputPlaceholder:"대상자를 입력해 주세요.",inputValidator:e=>!e&&"입력값은 필수입니다.",showLoaderOnConfirm:!0,preConfirm:async e=>{const t="unmark"===document.querySelector('input[name="action"]:checked').value?"1":"",n=location.pathname.match(/^\/history\/(.+)$/);if(!n)throw new Error("문서명을 찾을 수 없습니다.");const o=decodeURIComponent(n[1]),r=sessionStorage.getItem("x-chika");if(!r)throw new Error("x-chika 없음");const a=[...document.querySelectorAll("li")].filter((t=>t.querySelector(".v-popper")?.textContent.trim()===e)).map((e=>e.querySelector('a[href*="?uuid="]')?.href)).filter(Boolean).map((e=>new URL(e,location.origin).searchParams.get("uuid"))).filter(Boolean);if(!a.length)throw new Error("대상 리비전이 없습니다.");const i=`/internal/mark_troll_revision/${encodeURIComponent(o)}`,s={"Content-Type":"application/x-www-form-urlencoded","x-chika":r};for(const e of a){if(!(await fetch(i,{method:"POST",headers:s,body:new URLSearchParams({uuid:e,revert:t})})).ok)throw new Error(`처리 실패: ${e}`)}window.dispatchEvent(new PopStateEvent("popstate"))}})}));t.appendChild(o),n.appendChild(t)};function preventCopyAdminAButtons(){const e=["[A]반달로 표시","[A]편집요약 숨기기","[A]리비전 숨기기","[A]반달표시 해제","[A]편집요약 숨기기 해제","[A]리비전 숨기기 해제"];for(const t of document.querySelectorAll('a[rel="nofollow"]:not([data-no-drag])')){if(!e.includes(t.textContent.trim()))continue;t.setAttribute("data-no-drag",""),t.style.userSelect="none";const n=t.previousSibling;if(3!==n?.nodeType)continue;const o=n.textContent.lastIndexOf("|");if(-1===o)continue;const r=document.createElement("span");r.style.userSelect="none",r.textContent=n.textContent.slice(o),n.textContent=n.textContent.slice(0,o),n.parentNode.insertBefore(r,t)}}const searchIP=()=>{const e=document.querySelector('input[name="from"]');if(!e)return;const t=e.parentNode;let n=document.getElementById("order_select");if(!n){n=document.createElement("select"),n.id="order_select";["ID","CIDR"].forEach((e=>n.add(new Option(e,e)))),Array.from(e.attributes).forEach((e=>{e.name.startsWith("data-v-")&&n.setAttribute(e.name,e.value)})),t.insertBefore(n,e)}n.value="ID"===e.placeholder?"ID":"CIDR";const o={ipv4:/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,ipv6:/^([0-9a-fA-F]{1,4}:){1,7}([0-9a-fA-F]{1,4}|:)$/,ipv4WithCIDR:/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\/([0-9]|[1-2][0-9]|3[0-2]))?$/,ipv6WithCIDR:/^([0-9a-fA-F]{1,4}:){1,7}([0-9a-fA-F]{1,4}|:)(\/(1[0-1][0-9]|12[0-8]|[1-9]?[0-9]))?$/};n.addEventListener("change",(()=>{"CIDR"===n.value&&Swal.fire({theme:wikiTheme,template:"#search",inputLabel:"IP 주소를 입력해 주세요",inputPlaceholder:"CIDR 또는 단일 IP 주소를 입력...",preConfirm:e=>o.ipv4WithCIDR.test(e)?e.split("/")[0]:o.ipv6WithCIDR.test(e)?(e=>{const[t,n]=e.split("::").map((e=>e.split(":"))),o=Array(8-(t.length+(n?n.length:0))).fill("0000");return[...t,...o,...n||[]].map((e=>e.padStart(4,"0"))).join(":")})(e.split("/")[0]):(Swal.showValidationMessage("유효한 IP 주소를 입력해 주세요."),!1)}).then((e=>{if(e.isConfirmed){const t=new URL(window.location.href);t.searchParams.set("ip",e.value),window.location.href=t.toString()}}))}))},processedCache=new WeakMap,urlHighlighter=e=>{const t=document.querySelectorAll(e),n=location.origin,o=/"([0-9]{1,3}(?:\.[0-9]{1,3}){3}|(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:)*::(?:[0-9a-fA-F]{1,4}:)*[0-9a-fA-F]{1,4})" 기여 목록/g,r=/편집 요청 ([A-Z][a-zA-Z]+)/g,a=/토론 ([A-Z][a-zA-Z]+)(?: #(\d+))?/g,i=/(문서:(.+?)) r(\d+)/g,s=new RegExp(`((${["파일","분류","틀","템플릿","사용자","나무위키","휴지통","파일휴지통","위키운영","투표","토론","특수기능","시스템","특정판","삭제된사용자"].join("|")}):)(.+?) r(\\d+)`,"g");t.forEach((e=>{const t=e.textContent;if(processedCache.get(e)===t)return;let c=!1;for(let t of e.childNodes){if(t.nodeType!==Node.TEXT_NODE)continue;const e=t.nodeValue;let l=e.replace(o,((e,t)=>`<a href="${n}/contribution/ip/${t}">"${t}" 기여 목록</a>`)).replace(r,((e,t)=>`<a href="${n}/edit_request/${t}">편집 요청 ${t}</a>`)).replace(a,((e,t,o)=>o?`<a href="${n}/thread/${t}#${o}">토론 ${t} #${o}</a>`:`<a href="${n}/thread/${t}">토론 ${t}</a>`)).replace(i,((e,t,o,r)=>`<a href="${n}/history/${encodeURIComponent(o)}?from=${r}">${t} r${r}</a>`)).replace(s,((e,t,o,r,a)=>`<a href="${n}/history/${encodeURIComponent(`${o}:${r}`)}?from=${a}">${t}${r} r${a}</a>`));if("function"==typeof linkifyHtml&&(l=linkifyHtml(l)),l===e)continue;const d=document.createDocumentFragment(),u=document.createElement("div");for(u.innerHTML=l,u.querySelectorAll("a").forEach((e=>e.classList.add("custom-link")));u.firstChild;)d.appendChild(u.firstChild);t.replaceWith(d),c=!0}processedCache.set(e,e.textContent)}))};function createBtn(e,t,n,o){const r=document.createElement("button");return r.type="button",r.className="namu-refresher-btn",r.id=e,r.innerHTML=`<span class="${t}"></span><span>${n}</span>`,r.style.userSelect="none",r.addEventListener("click",o),r}async function ipInfo(){if(document.getElementById("ip-info-button"))return;const e="ipinfo_cache",t=()=>JSON.parse(sessionStorage.getItem(e)||"{}"),n=e=>e.toUpperCase().split("").map((e=>String.fromCodePoint(127462+e.charCodeAt(0)-65))).join(""),o=document.querySelector(".v-popper__inner");if(!o)return;const r=[...o.querySelectorAll("div")].find((e=>"IP"===e.textContent.trim()))?.parentElement?.querySelector("div:nth-child(2)");if(!r)return;const a=r.textContent.trim().split(" ")[0];if(!/^(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])(\.(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])){3}$/.test(a)&&!/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|::)$/.test(a))return;const i=o.querySelector('a[href*="/document"]');if(i){const e=i.cloneNode();Object.assign(e,{textContent:"IP 정보 조회",href:`https://ipinfo.io/${a}`,id:"ip-info-button"}),i.before(e)}let s=r.nextElementSibling?.classList.contains("ip-info-org")?r.nextElementSibling:Object.assign(document.createElement("div"),{className:"ip-info-org"});s.style.fontSize="0.8rem",s.parentElement||r.after(s);const c=t();if(c[a]){const{countryCode:e,org:t}=c[a];return r.textContent=`${a} ${e?n(e):""}`,void(s.textContent=t)}document.getElementById("ip-skeleton-style")||document.head.insertAdjacentHTML("beforeend",'<style id="ip-skeleton-style">\n      @keyframes skeleton{0%{opacity:.5}100%{opacity:1}}\n      .ip-skeleton{height:.8rem;background:#ddd;border-radius:4px;margin-top:4px;animation:skeleton 1s infinite alternate}\n      .theseed-dark-mode .ip-skeleton{background:#333}\n    </style>'),s.innerHTML='<div class="ip-skeleton"></div>';const{countryCode:l,org:d}=await(e=>new Promise((t=>{GM_xmlhttpRequest({method:"GET",url:`https://ip.guide/${e}`,timeout:5e3,onload:e=>{try{const n=JSON.parse(e.responseText).network?.autonomous_system,o=n?.asn?`AS${n.asn}`:"",r=n?.organization||n?.name||"";t({countryCode:n?.country||"",org:[o,r].filter(Boolean).join(" ")})}catch{t({countryCode:"",org:`Error: ${e.status}`})}},onerror:()=>t({countryCode:"",org:"Network Error"})})})))(a);r.textContent=`${a} ${l?n(l):""}`,s.textContent=d,((n,o)=>{const r=t();r[n]=o;const a=Object.entries(r);a.length>100?sessionStorage.setItem(e,JSON.stringify(Object.fromEntries(a.slice(-100)))):sessionStorage.setItem(e,JSON.stringify(r))})(a,{countryCode:l,org:d})}const formatTime=e=>{if(e<1e3)return`${e}ms`;const t=Math.round(e/1e3);if(t<60)return`${t}초`;const n=Math.round(t/60);if(n<60)return`${n}분`;const o=Math.floor(n/60),r=n%60;return 0===r?`${o}시간`:`${o}시간 ${r}분`},createProgressBar=(e,t,n,o)=>new Promise((r=>{Swal.fire({theme:wikiTheme,allowOutsideClick:!1,showCancelButton:!0,cancelButtonText:"취소",showConfirmButton:!1,html:`\n            <div style="display:flex;flex-direction:column;align-items:center;width:100%">\n                <p style="margin:0;">AS${e}(${t})에 속한 IP를 차단하고 있어요. 창을 벗어나지 마세요.</p>\n                <p id="progress-bar-text" style="margin:10px 0;">0% (0/${n})</p>\n                <div id="progress-bar-container" style="width:100%;margin-top:10px;"></div>\n            </div>`,didOpen:()=>{const e=new ProgressBar.Line("#progress-bar-container",{easing:"easeInOut",trailColor:o,svgStyle:{width:"100%",height:"100%"},from:{color:"#00a69c"},to:{color:"#28b472"},step:(e,t)=>t.path.setAttribute("stroke",e.color)});r(e)}})})),updateProgressBar=(e,t,n,o)=>{try{e.animate(t,{duration:100});const r=Swal.getHtmlContainer()?.querySelector("#progress-bar-text");r&&(r.textContent=`${Math.round(100*t)}% (${n}/${o})`)}catch(e){}},fetchAsnData=async e=>{const t=e.toString().replace(/^AS/i,"").trim();if(!t)throw new Error("유효한 ASN을 입력해야 합니다.");const n=await GM.xmlHttpRequest({method:"GET",url:`https://ip.guide/AS${t}`,headers:{Accept:"application/json"}});if(200!==n.status)throw new Error(`정보를 가져오는데 실패했습니다. (Status: ${n.status})`);const o=JSON.parse(n.responseText);return{asn:o.asn,org:o.organization||o.name,prefixes:[...o.routes?.v4||[],...o.routes?.v6||[]]}},blockIPs=async(e,t,n,o)=>{const r=[...document.querySelectorAll("button")].find((e=>e.textContent.includes("추가")));if(!r||r.disabled)return Swal.fire({theme:wikiTheme,template:"#error",text:"권한이 부족합니다."});if(void 0===xChika||!xChika)return Swal.fire({theme:wikiTheme,template:"#error",text:"인증 정보가 없습니다. 페이지를 새로고침해주세요."});const a=document.querySelector('input[name="group"]')?.value;if(!a)return Swal.fire({theme:wikiTheme,template:"#error",text:"차단 그룹을 선택해주세요."});const i=document.querySelector('input[name="expire"]')?.value||"0",s=document.body.classList.contains("theseed-dark-mode")?"#333":"#eee",c=await createProgressBar(e,t,n.length,s);let l=!1;Swal.getCancelButton()?.addEventListener("click",(()=>{l=!0,c.stop()}));let d=0,u=[];try{for(let e=0;e<n.length&&!l;e++){const t=n[e];try{(await fetch("/internal/aclgroup",{method:"POST",headers:{"x-chika":xChika,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({mode:"ip",ip:t,note:o,expire:i,group:a}).toString()})).ok?d++:u.push(t)}catch(e){u.push(t)}updateProgressBar(c,(e+1)/n.length,e+1,n.length)}let r,s;l?(r=`작업이 취소되었어요. (${d}/${n.length} 완료)`,s="#error"):0===u.length?(r=`AS${e}(${t})에서 사용 중인 ${d}개의 CIDR 블록이 ${a} ACL 그룹에 추가되었습니다.`,s="#success",c.animate(1),updateProgressBar(c,1,n.length,n.length)):(r=`차단 완료: ${d}/${n.length}\n실패한 IP: ${u.length}개`,s="#error"),await Swal.fire({theme:wikiTheme,template:s,text:r})}catch(e){await Swal.fire({theme:wikiTheme,template:"#error",text:e?.message||"Something went wrong."})}finally{Swal.close(),window.dispatchEvent(new PopStateEvent("popstate"))}},asnBlock=()=>{if(document.getElementById("batch_btn"))return;const e=Array.from(document.querySelectorAll("button")).find((e=>e.textContent.includes("추가")));if(!e)return;const t=document.createElement("div");t.style.display="flex",e.parentNode.insertBefore(t,e),t.appendChild(e);const n=createBtn("batch_btn","ion-md-cloud-done","ASN 불러오기",(async()=>{const{isConfirmed:e,value:t}=await Swal.fire({theme:wikiTheme,template:"#search",text:"불러올 ASN을 입력해 주세요.",input:"text",inputPlaceholder:"예: AS13335",showCancelButton:!0,preConfirm:async e=>{try{return await fetchAsnData(e)}catch(e){return Swal.showValidationMessage(`에러 발생: ${e.message}`),!1}}});if(!e||!t)return;const{asn:n,org:o,prefixes:r}=t;if(!r?.length)return Swal.fire({theme:wikiTheme,template:"#error",text:`AS${n}(${o})에서 사용 중인 CIDR 블록이 없습니다.`});const a=document.querySelector('input[name="group"]')?.value;if(!a)return Swal.fire({theme:wikiTheme,template:"#error",text:"차단 그룹을 먼저 선택해주세요."});const i=Math.round(100*r.length+r.length/200*5e3),s=formatTime(i);(await Swal.fire({theme:wikiTheme,template:"#warning",text:`AS${n} (${o})\n총 ${r.length}개의 CIDR 블록을 ${a} ACL 그룹에 추가하시겠어요?\n(예상 소요 시간: ${s})`,confirmButtonText:"차단",showCancelButton:!0})).isConfirmed&&await blockIPs(n,o,r,`AS${n}(${o})`)}));Object.assign(n.style,{marginLeft:"auto",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}),t.appendChild(n)};function loginAllowCheckbox(){const e=document.querySelector('form[action="/aclgroup"]');if(!e||"빠른 ACLGroup"!==e.querySelector("h4")?.textContent.trim())return;const t="login-checkbox-container",n=" | 현재 이용 중인 IP는 문서 훼손이 잦아 비로그인 편집이 제한되어 있습니다. 로그인 후 이용하실 수 있습니다.";e.querySelector('select[name="group"]')?.addEventListener("change",(o=>(o=>{let r=document.getElementById(t);if(o){if(!r){r=document.createElement("div"),r.id=t,r.style.display="flex",r.style.alignItems="center",r.innerHTML='\n                    <input type="checkbox" id="login-checkbox" name="login-checkbox">\n                    <label for="login-checkbox" style="margin-left: 5px;">로그인 허용 차단 안내</label>\n                ';const o=e.querySelector('input[name="note"]')?.parentElement;o?.insertAdjacentElement("afterend",r);const a=r.querySelector("#login-checkbox");a.addEventListener("change",(()=>{const t=e.querySelector('input[name="note"]'),o=t.value.includes(n);a.checked&&!o?t.value+=n:!a.checked&&o&&(t.value=t.value.replace(n,"")),t.dispatchEvent(new Event("input",{bubbles:!0}))}))}}else r?.remove()})("로그인 허용 차단"===o.target.value)));const o=e.querySelector('input[name="note"]')?.parentElement;if(o&&!document.querySelector("#paste-button")){const e=document.createElement("button");e.type="button",e.id="paste-button";const t=[...document.querySelectorAll("button")].find((e=>"취소"===e.textContent.trim()));t&&[...t.attributes].forEach((({name:t,value:n})=>{(t.startsWith("data-v-")||"class"===t)&&e.setAttribute(t,n)})),e.classList.add("ion-md-clipboard"),e.style.cssText="padding-top: 0; padding-bottom: 0; display: flex; align-items: center; position: relative; left: -1px;";const n=document.createElement("div");n.style.cssText="display: flex; align-items: stretch;";const r=o.querySelector('input[name="note"]'),a=o.querySelector("p");a&&o.insertBefore(a,o.firstChild),r&&(n.append(r,e),o.appendChild(n)),e.addEventListener("click",(async()=>{try{const e=await navigator.clipboard.readText();r.value=e,r.dispatchEvent(new Event("input",{bubbles:!0}))}catch{Swal.fire({theme:wikiTheme,toast:!0,position:"top-end",timer:1e4,timerProgressBar:!0,showConfirmButton:!1,text:"클립보드에 접근할 수 없습니다. 클립보드 권한을 허용해 주세요.",icon:"warning"})}}))}}class AclGroupBlockManager{constructor(){this.form=document.querySelector('form[action="/aclgroup"]'),this.apiUrl="/internal/aclgroup",this.blockGroup="편집요청 차단"}init(){this.form&&(this.form.dataset.aclManagerAttached||(this.form.dataset.aclManagerAttached="true",this.createBlockOptionUI(),this.form.addEventListener("submit",(()=>this.handleFormSubmit()))))}createBlockOptionUI(){if(document.getElementById("block_options_container"))return;const e=this.form.querySelector('button[type="submit"]');if(!e)return;const t=e.closest("div");if(!t||!t.parentNode)return;const n=document.createElement("div");n.id="block_options_container",n.style.cssText="margin-bottom: 8px; display: flex; align-items: center; gap: 5px;",n.innerHTML='\n            <input type="checkbox" id="block_edit_request">\n            <label for="block_edit_request">편집 요청 차단</label>\n        ',t.parentNode.insertBefore(n,t)}handleFormSubmit(){if(!document.getElementById("block_edit_request")?.checked)return;if(void 0===xChika||!xChika)return void alert("인증 정보가 없습니다. 페이지를 새로고침해주세요.");const e=this.extractFormData();["username","ip"].forEach((t=>{e[t]&&this.sendBlockRequest(xChika,{...e,mode:t})}))}extractFormData(){const e=e=>this.form.querySelector(`input[name="${e}"]`)?.value||"";return{username:e("username"),ip:e("ip"),note:e("note"),expire:e("expire")||"0",group:this.blockGroup}}async sendBlockRequest(e,t){try{await fetch(this.apiUrl,{method:"POST",headers:{"x-chika":e,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t).toString(),credentials:"same-origin"})}catch(e){alert("편집 요청 차단 처리 중 오류가 발생했습니다.")}}}function initAclGroupBlockManager(){(new AclGroupBlockManager).init()}const SBOX_URL="https://raw.githubusercontent.com/YorKR/seed-deobfuscator/refs/heads/main/token.txt";let sboxCache=null;async function loadSbox(){if(sboxCache)return sboxCache;try{const e=await new Promise(((e,t)=>{GM.xmlHttpRequest({method:"GET",url:SBOX_URL,headers:{"Cache-Control":"no-cache"},onload:e,onerror:t})}));if(200===e.status){const t=JSON.parse(e.responseText);return sboxCache=new Uint8Array(t),sboxCache}return null}catch(e){return null}}function decrypt(e,t,n){if(!t||!n)return e;const o=new Uint8Array(n);let r=0,a=0;for(let t=0;t<e.length;t++)a=a+o[r=r+1&255]&255,[o[r],o[a]]=[o[a],o[r]],e[t]^=o[o[r]+o[a]&255];return e}class ProtoReader{constructor(e){this.buf=e,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.pos=0,this.decoder=new TextDecoder("utf-8",{fatal:!1})}varint(){let e,t=0,n=0;do{if(this.pos>=this.buf.length)throw new Error("Buffer overflow");e=this.buf[this.pos++],t|=(127&e)<<n,n+=7}while(128&e);return t>>>0}str(e){const t=this.buf.subarray(this.pos,this.pos+e);return this.pos+=e,this.decoder.decode(t)}bytes(e){const t=this.buf.slice(this.pos,this.pos+e);return this.pos+=e,t}fixed32(){const e=this.view.getUint32(this.pos,!0);return this.pos+=4,e}fixed64(){const e=this.view.getFloat64(this.pos,!0);return this.pos+=8,e}}function decodeProto(e,t){const n={};for(;e.pos<t;){const t=e.varint(),o=7&t,r=t>>>3;let a;if(0===o)a=e.varint();else if(1===o)a=e.fixed64();else if(2===o){const t=e.varint(),n=e.pos;let o=!0,r=null;try{r=decodeProto(new ProtoReader(e.buf.subarray(n,n+t)),t),t>0&&0===Object.keys(r).length&&(o=!1)}catch{o=!1}if(o&&r)a=r,e.pos+=t;else{e.pos=n;const o=e.str(t);o&&!/[\x00-\x08\x0E-\x1F]/.test(o)?a=o:(e.pos=n,a=btoa(String.fromCharCode(...e.bytes(t))))}}else{if(5!==o)break;a=e.fixed32()}n[r]?(Array.isArray(n[r])||(n[r]=[n[r]]),n[r].push(a)):n[r]=a}return n}async function handleApiResponse(e){const t="dia"===e.headers.get("x-ruby"),n=e.headers.get("x-namuwiki-key");if(!t||!n)return{type:"text",data:await e.text()};try{const t=await loadSbox();if(!t)return{type:"text",data:await e.text()};const o=await e.arrayBuffer();let r=decrypt(new Uint8Array(o),n,t);try{"undefined"!=typeof pako&&(r=pako.inflate(r))}catch(e){}try{const e=new ProtoReader(r);return{type:"json",data:decodeProto(e,r.length)}}catch(e){return{type:"text",data:new TextDecoder("utf-8",{fatal:!1}).decode(r)}}}catch(e){return{type:"error",data:"복호화 중 오류 발생"}}}function extractUUID(){const e=document.querySelector('.v-popper__inner a[href*="/contribution/"][href*="/document"][role="button"]');if(e){const t=e.getAttribute("href").match(/\/contribution\/([0-9a-f-]{36})\/document/);if(t?.[1])return t[1]}const t=document.querySelector('a[href^="/BlockHistory"][href*="query="]');if(t){const e=t.getAttribute("href"),n=new URLSearchParams(e.split("?")[1]).get("query");if(n&&/^[0-9a-f-]{36}$/.test(n))return n}return null}function createCheckboxUI(e){if(document.getElementById("checkbox-container"))return;const t=document.createElement("div");t.id="checkbox-container",t.style.cssText="margin-top: 8px;";const n=[{id:"undo-edit",label:"편집"},{id:"hide-discussion-comments",label:"토론"},{id:"close-edit-request",label:"편집 요청"},{id:"revert-editrequest",label:"승인한 편집 요청"}];t.innerHTML=`\n        <div>\n            <input type="checkbox" id="select-all">\n            <label for="select-all">일괄 되돌리기</label>\n            <span>(</span>\n            ${n.map((({id:e,label:t},o)=>`\n                <input type="checkbox" id="${e}">\n                <label for="${e}">${t}</label>\n                ${o<n.length-1?" | ":""}\n            `)).join("")}\n            <span>)</span>\n        </div>\n    `;e.querySelector('button[type="submit"]')?.parentNode.insertAdjacentElement("beforebegin",t);const o=document.getElementById("select-all"),r=n.map((e=>document.getElementById(e.id)));o.addEventListener("change",(()=>{r.forEach((e=>e.checked=o.checked))})),r.forEach((e=>{e.addEventListener("change",(()=>{o.checked=r.every((e=>e.checked))}))}))}async function performBatchRevert(e,t,n){const o=[`uuid=${encodeURIComponent(e)}`,`reason=${encodeURIComponent(t)}`,...n].join("&");await Swal.fire({theme:void 0!==wikiTheme?wikiTheme:"auto",template:"#info",text:"최근 활동을 모두 되돌리고 있어요.",showConfirmButton:!1,didOpen:async()=>{Swal.showLoading();try{const e=await fetch("/internal/admin/batch_revert",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","x-chika":sessionStorage.getItem("x-chika")},body:o});if(!e.ok)throw new Error(`HTTP Error: ${e.status}`);const t=await handleApiResponse(e);let n="";if("json"===t.type){n=`<pre style="text-align: left; background: #282c34; color: #abb2bf; padding: 10px; border-radius: 4px; overflow-x: auto; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto;">${JSON.stringify(t.data,null,2)}</pre>`}else{if(t.data.includes&&t.data.includes("[오류!]"))throw t.data;n=`<div>${t.data}</div>`}Swal.fire({theme:void 0!==wikiTheme?wikiTheme:"auto",template:"#success",icon:"success",title:"완료",text:"일괄 되돌리기를 완료했어요.",html:n,width:"800px"})}catch(e){Swal.fire({theme:void 0!==wikiTheme?wikiTheme:"auto",template:"#error",icon:"error",title:"오류",text:"string"==typeof e?e:"요청 처리 중 오류가 발생했습니다."})}}})}function setRollBackOption(){const e=extractUUID();if(!e)return;const t=document.querySelector('form[action="/aclgroup"]');if(!t)return;if(t.dataset.batchRevertAttached)return;const n=t.querySelector("h4")?.textContent.trim();"빠른 ACLGroup"===n&&(t.dataset.batchRevertAttached="true",loadSbox(),createCheckboxUI(t),t.addEventListener("submit",(async n=>{const o=Object.entries({"close-edit-request":"close_editrequests","hide-discussion-comments":"hide_thread","undo-edit":"revert_document","revert-editrequest":"revert_editrequest"}).filter((([e])=>document.getElementById(e)?.checked)).map((([,e])=>`${e}=Y`));if(0===o.length)return;n.preventDefault();const r=t.querySelector('input[name="note"]')?.value;r?await performBatchRevert(e,r,o):Swal.fire({icon:"warning",text:"사유를 입력해주세요."})}),{once:!1}))}const AdminAPI={async postAPI(e,t,n){const o=await fetch(`${location.origin}/internal/admin/thread/${e}/${t}`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8","x-chika":xChika},body:new URLSearchParams(n)});if(!o.ok)throw new Error(`API 요청 실패: ${t}, status=${o.status}`)},async changeTopic(e,t){return await this.postAPI(e,"topic",{topic:t})},async changeDocument(e,t){return await this.postAPI(e,"document",{document:t})},async changeStatus(e,t){return await this.postAPI(e,"status",{status:t})}},StrictModeManager={async showStrict(){const e=document.querySelector('div.v-popper.v-popper--theme-contextmenu span[role="button"]');if(!e)return;await this.click(e);const t=(await this.waitFor("label",(e=>e.textContent.includes("숨겨진 댓글 보이지 않기"))))?.querySelector('input[type="checkbox"]');if(!t)return;await this.click(t);const n="div.v-popper.v-popper--shown.v-popper--theme-contextmenu";this.click(await this.waitFor(n)),await this.waitFor(n,null,1),location.hash&&document.getElementById(location.hash.slice(1))?.scrollIntoView({block:"start"})},click(e){if(!e)return;const t={bubbles:!0,cancelable:!0};e.dispatchEvent(new TouchEvent("touchstart",t)),e.dispatchEvent(new TouchEvent("touchend",t)),e.click()},waitFor:(e,t,n)=>new Promise((o=>{const r=()=>n?!document.querySelector(e):t?[...document.querySelectorAll(e)].find(t):document.querySelector(e),a=r();if(a)return o(n?null:a);const i=new MutationObserver((()=>{const e=r();e&&(i.disconnect(),o(n?null:e))}));i.observe(document.body,{childList:!0,subtree:!0})}))},QuickPrefixModule={ADMIN_OPTIONS:["선택...","방기","뻘토론","발제 요건 미달","편집 분쟁 없음","의견 수렴","발제 철회","분쟁 당사자 동의","규정 위반","발제자 차단","분쟁 당사자 차단"],setup(e,t){const n=document.createElement("form");n.id="admin_control",n.innerHTML="[ADMIN] 빠른 말머리: ";const o=document.createElement("select");o.id="select_input",this.ADMIN_OPTIONS.forEach((e=>{const t=document.createElement("option");t.text=e,o.add(t)})),o.selectedIndex=0,n.appendChild(o),e.parentNode.insertBefore(n,e.nextSibling),o.addEventListener("change",(async function(){const e=o.value;if("선택..."!==e){await Swal.fire({theme:wikiTheme,template:"#info",text:`정말로 '${e}' 처리하시겠어요?`,showLoaderOnConfirm:!0,preConfirm:async()=>{try{const n=document.querySelector('input[name="topic"]'),o=n?n.value:"",r=`[${e}] ${o}`.trim();return await AdminAPI.changeTopic(t,r),!0}catch(e){return Swal.showValidationMessage(e.toString()),!1}}});o.selectedIndex=0}}))}},RecycleModule={setup(e,t){if(!t)return;const n=[async()=>await AdminAPI.changeDocument(t,"휴지통:토론 휴지통"),async()=>await AdminAPI.changeTopic(t,"[redacted]"),async()=>await AdminAPI.changeStatus(t,"close")],o=createBtn("recycle_btn","ion-md-trash","휴지통으로 이동",(async function(){await Swal.fire({theme:wikiTheme,template:"#warning",text:"정말로 휴지통:토론 휴지통으로 이동하시겠어요?",showLoaderOnConfirm:!0,preConfirm:async()=>{for(let e=0;e<n.length;e++)try{await n[e]()}catch(e){return Swal.showValidationMessage(e.toString()),!1}return!0}})}));o.style.height="32px",e.appendChild(o)}},TemplateModule={setup(e){const t=document.querySelector(`form[action="/thread/${e}"]`);if(!t)return;const n=t.querySelector('button[type="submit"]');if(!n)return;const o=document.createElement("select");o.id="template_dropdown",o.style.cssText="width: 8rem; background: transparent; color: var(--espejo-text-color); border: 1px; border-style:solid; border-color: var(--espejo-component-border-color); padding: 0px 8px;";const r=document.createElement("option");r.text="상용구 선택...",r.value="",o.add(r);JSON.parse(localStorage.getItem("templates")||"[]").forEach((e=>{const t=document.createElement("option");t.value=e.title,t.text=e.title,o.add(t)})),o.addEventListener("change",(function(){const e=o.value;e&&""!==e&&(typeTemplate(e),o.value="")}));const a=document.createElement("div");a.className="custom-dropdown-container",a.style.cssText="display: flex; flex-wrap:wrap; justify-content: space-between;",n.parentNode.insertBefore(a,n),a.appendChild(o),a.appendChild(n)}};class AdminController{constructor(){this.observeChanges()}observeChanges(){const e=new MutationObserver((t=>{t.forEach((t=>{if("childList"===t.type||"subtree"===t.type){const t=Array.from(document.querySelectorAll("h3")).find((e=>e.textContent.includes("댓글 달기")));t&&(e.disconnect(),this.initAdminControl(t))}}))}));e.observe(document.body,{childList:!0,subtree:!0})}async initAdminControl(e){const t=window.location.pathname.split("/").pop(),n=getSlug();document.getElementById("admin_control")||(QuickPrefixModule.setup(e,n),RecycleModule.setup(e,n),TemplateModule.setup(t),await StrictModeManager.showStrict())}}const createAdminControl=()=>new AdminController;function getSlug(){const e=window.location.pathname.match(/^\/thread\/([A-Za-z]+)/);return e?e[1]:null}function typeTemplate(e){const t=document.querySelector("textarea"),n=(JSON.parse(localStorage.getItem("templates"))||[]).find((t=>t.title===e));n&&(t.value=n.content,t.dispatchEvent(new Event("input",{bubbles:!0})))}function createModal(){document.querySelector('a[id="extension_setting"]')||document.querySelectorAll('a[href="/member/mypage"]').forEach((e=>{const t=createNewLink(e);insertNewLink(e,t),t.addEventListener("click",(e=>{e.preventDefault(),openModal()}))}))}function createNewLink(e){const t=document.createElement("a");return t.innerHTML='<div style="display:flex; flex-direction:row"><span style="align-items: center; display: flex; justify-content:center; margin-right:var(--espejo-dropdown-menu-item-icon-gap-var); width:1rem;"><span class="ion-md-color-wand"></span></span>관리 도구 설정</div>',t.href="#",t.id="extension_setting",[...e.attributes].forEach((e=>{e.name.startsWith("data-v-")&&t.setAttribute(e.name,e.value)})),t.className=e.className,t}function insertNewLink(e,t){const n=e.parentElement;n.children[3]?n.insertBefore(t,n.children[3]):n.appendChild(t)}function openModal(){const e=GM_getResourceText("MODAL");GM_addStyle(e);let t=document.getElementById("extension_modal");t||(t=document.createElement("div"),t.id="extension_modal",t.style.display="none",t.innerHTML=getModalContent(),document.body.appendChild(t),initEventListeners()),t.style.display="block"}function closeModal(){const e=document.getElementById("extension_modal");e&&(e.style.display="none");document.querySelectorAll("style").forEach((e=>{e.innerHTML.includes(GM_getResourceText("MODAL"))&&e.remove()}))}function getModalContent(){return'\n    <div id="nmst-modal" tabindex="-1" aria-hidden="true" class="nmst-modal overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">\n    <div class="relative p-4 w-full max-w-2xl max-h-full">\n    <div id="mainModalContent" class="flex flex-col gap-4 relative bg-white rounded-lg p-5 shadow dark:bg-zinc-900 w-full max-w-2xl">\n    <div class="flex justify-between items-center">\n    <h3 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">관리 도구 설정</h3>\n    <button class="close text-zinc-400 bg-transparent hover:text-zinc-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:text-white">\n    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24v24H0z" fill="none" />\n    <path d="M18 6l-12 12" />\n    <path d="M6 6l12 12" />\n    </svg>\n    <span class="sr-only">Close modal</span>\n    </button>\n    </div>\n    <div class="relative rounded-md shadow-sm">\n    <div class="pointer-events-none absolute flex h-full items-center pl-3">\n    <svg class="w-4 h-4 text-zinc-400 dark:text-zinc-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24v24H0z" fill="none" />\n    <path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0" />\n    <path d="M21 21l-6 -6" />\n    </svg>\n    </div>\n    <input type="text" name="search" id="simple-search" class="bg-transparent block w-full text-zinc-900 dark:text-zinc-100 rounded-md border-0 py-1.5 pl-9 pr-3 text-zinc-900 ring-1 ring-inset ring-zinc-200 dark:ring-zinc-700 placeholder:text-zinc-400 focus:outline-none focus:ring-1 focus:ring-inset focus:ring-emerald-500 text-sm leading-6" placeholder="검색어를 입력하세요">\n    </div>\n    <div class="flex justify-between items-center">\n    <div class="flex space-x-2">\n    <button id="importButton" type="button" class="h-9 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-md border border-zinc-200 bg-white text-zinc-800 shadow-sm hover:bg-zinc-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-100 dark:hover:bg-zinc-800">\n    <svg class="w-4 h-4 text-zinc-900 dark:text-zinc-100" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24v24H0z" fill="none" />\n    <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />\n    <path d="M7 9l5 -5l5 5" />\n    <path d="M12 4l0 12" />\n    </svg>\n    </button>\n    <input type="file" id="importFile" class="hidden" />\n    <button id="exportButton" type="button" class="h-9 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-md border border-zinc-200 text-zinc-800 shadow-sm hover:bg-zinc-50 disabled:opacity-50 disabled:pointer-events-none dark:border-zinc-700 dark:text-zinc-100 dark:hover:bg-zinc-800">\n    <svg class="w-4 h-4 text-zinc-900 dark:text-zinc-100" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24h24H0z" fill="none" />\n    <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />\n    <path d="M7 11l5 5l5 -5" />\n    <path d="M12 4l0 12" />\n    </svg>\n    </button>\n    </div>\n    <button id="addButton" type="button" class="h-9 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-md bg-emerald-500 text-white shadow-sm hover:bg-emerald-400 dark:hover:bg-emerald-600">등록</button>\n    </div>\n    <div class="flex flex-col">\n    <div class="min-w-full inline-block align-middle">\n    <div class="border border-zinc-200 rounded-md shadow-sm overflow-x-scroll dark:border-zinc-700">\n    <table id="templateTable" class="min-w-full divide-y divide-zinc-200 dark:divide-zinc-700">\n    <thead>\n    <tr>\n    <th scope="col" class="h-8 px-4 text-center text-xs font-medium text-zinc-500">#</th>\n    <th scope="col" class="h-8 px-4 text-start text-xs font-medium text-zinc-500">TITLE</th>\n    <th scope="col" class="h-8 px-4 w-full text-start text-xs font-medium text-zinc-500">BODY</th>\n    <th scope="col" class="h-8 px-4 text-center text-xs font-medium text-zinc-500">ACTION</th>\n    </tr>\n    </thead>\n    <tbody id="templateBody" class="divide-y divide-zinc-200 dark:divide-zinc-700">\n    <tr id="empty-row">\n    <td colspan="4" class="h-10 text-center text-sm text-zinc-400">No matches found.</td>\n    </tr>\n    </tbody>\n    </table>\n    </div>\n    </div>\n    </div>\n    </div>\n    <div id="editModalContent" class="hidden relative flex flex-col p-5 gap-4 bg-white rounded-lg shadow dark:bg-zinc-900 w-full max-w-2xl mx-auto">\n    <div class="flex justify-between items-center">\n    <button id="backButton" class="text-zinc-400 bg-transparent hover:text-zinc-900 text-sm mr-2 p-1.5 inline-flex items-center dark:hover:text-white">\n    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24h24H0z" fill="none" />\n    <path d="M15 6l-6 6l6 6" />\n    </svg>\n    <span class="sr-only">Back</span>\n    </button>\n    <h3 class="text-lg font-semibold text-zinc-900 dark:text-zinc-100">상용구 등록</h3>\n    <button class="close text-zinc-400 bg-transparent hover:text-zinc-900 rounded-lg text-sm ml-auto p-1.5 inline-flex items-center dark:hover:text-white">\n    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <path stroke="none" d="M0 0h24h24H0z" fill="none" />\n    <path d="M18 6l-12 12" />\n    <path d="M6 6l12 12" />\n    </svg>\n    <span class="sr-only">Close modal</span>\n    </button>\n    </div>\n    <div>\n    <label for="editTitle" class="block mb-2 text-sm font-medium text-zinc-900 dark:text-zinc-100">제목</label>\n    <input type="text" id="editTitle" class="bg-transparent block w-full text-zinc-900 dark:text-zinc-100 rounded-md border-0 px-3 py-1.5 text-zinc-900 ring-1 ring-inset ring-zinc-200 dark:ring-zinc-700 placeholder:text-zinc-400 focus:outline-none focus:ring-1 focus:ring-inset focus:ring-emerald-500 text-sm leading-6" placeholder="제목을 입력하세요." required/>\n    </div>\n    <div>\n    <label for="editContent" class="block mb-2 text-sm font-medium text-zinc-900 dark:text-zinc-100">내용</label>\n    <textarea id="editContent" class="bg-transparent min-h-9 block w-full text-zinc-900 dark:text-zinc-100 rounded-md border-0 px-3 py-1.5 text-zinc-900 ring-1 ring-inset ring-zinc-200 dark:ring-zinc-700 placeholder:text-zinc-400 focus:outline-none focus:ring-1 focus:ring-inset focus:ring-emerald-500 text-sm leading-6" placeholder="내용을 입력하세요." required></textarea>\n    </div>\n    <div class="flex justify-end items-center space-x-2">\n    <button id="cancelButton" type="button" class="h-9 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-md border border-zinc-200 bg-white text-zinc-800 shadow-sm hover:bg-zinc-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-100 dark:hover:bg-zinc-800">취소</button>\n    <button id="saveButton" type="button" class="h-9 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-md bg-emerald-500 text-white shadow-sm hover:bg-emerald-400 dark:hover:bg-emerald-600">등록</button>\n    </div>\n    </div>\n    </div>\n    </div>\n  '}function initEventListeners(){const e=document.getElementById("addButton"),t=document.getElementById("editModalContent"),n=document.getElementById("mainModalContent"),o=document.getElementById("backButton"),r=document.getElementById("cancelButton"),a=document.querySelectorAll(".close"),i=document.getElementById("saveButton"),s=document.getElementById("templateBody"),c=document.getElementById("simple-search"),l=document.getElementById("editTitle"),d=document.getElementById("editContent"),u=document.getElementById("exportButton"),m=document.getElementById("importButton"),p=document.getElementById("importFile");let h=JSON.parse(localStorage.getItem("templates"))||[],f=-1,g=!1;const w=e=>{s.innerHTML="",0===e.length?s.innerHTML='<tr><td colspan="4" class="h-10 text-center text-sm text-zinc-400">No matches found.</td></tr>':e.forEach(((e,t)=>{const n=document.createElement("tr"),o=document.createElement("td"),r=document.createElement("td"),a=document.createElement("td"),i=document.createElement("td");o.className="p-4 text-center whitespace-nowrap text-sm text-gray-800 dark:text-neutral-200 handle",r.className="p-4 text-start text-sm font-medium text-gray-800 dark:text-neutral-200",a.className="p-4 w-full text-start text-sm text-gray-800 dark:text-neutral-200 break-all",i.className="p-4 whitespace-nowrap text-end text-sm font-medium",o.textContent=t+1,r.textContent=e.title;const c=document.createElement("div");c.className="line-clamp-3 whitespace-normal",c.textContent=e.content,a.appendChild(c);const l=document.createElement("button"),d=document.createElement("button"),u=document.createElement("div");l.type="button",l.className="h-6 px-3 inline-flex items-center text-xs font-medium rounded-md border border-gray-200 bg-white text-gray-500 shadow-sm hover:bg-gray-50 dark:bg-neutral-900 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800 editBtn",l.textContent="편집",l.onclick=()=>v(t),d.type="button",d.className="h-6 px-3 inline-flex items-center text-xs font-medium rounded-md border border-gray-200 bg-white text-red-500 shadow-sm hover:bg-gray-50 dark:bg-neutral-900 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-800 deleteBtn",d.textContent="삭제",d.onclick=()=>{Swal.fire({theme:wikiTheme,template:"#info",text:"정말로 삭제하시겠어요?"}).then((e=>{e.isConfirmed&&k(t)}))},u.className="flex flex-col items-center space-y-1",u.appendChild(l),u.appendChild(d),i.appendChild(u),n.appendChild(o),n.appendChild(r),n.appendChild(a),n.appendChild(i),s.appendChild(n)}))},x=()=>localStorage.setItem("templates",JSON.stringify(h)),y=e=>{g&&(e.preventDefault(),e.returnValue="")},b=e=>{e?(n.classList.add("hidden"),t.classList.remove("hidden")):(t.classList.add("hidden"),n.classList.remove("hidden")),g=e,e?window.addEventListener("beforeunload",y):window.removeEventListener("beforeunload",y)};e.addEventListener("click",(()=>{f=-1,l.value="",d.value="",b(!0)})),o.addEventListener("click",(()=>b(!1))),r.addEventListener("click",(()=>b(!1))),i.addEventListener("click",(()=>{const e=l.value.trim(),t=d.value;e&&t?(-1===f?h.push({title:e,content:t}):h[f]={title:e,content:t},x(),w(h),b(!1)):alert("제목과 내용을 입력하세요.")})),a.forEach((e=>{e.addEventListener("click",(()=>{closeModal(),b(!1)}))})),c.addEventListener("input",(()=>{const e=c.value.toLowerCase();w(e?h.filter((t=>t.title.toLowerCase().includes(e)||t.content.toLowerCase().includes(e))):h)}));const v=e=>{const t=h[e];l.value=t.title,d.value=t.content,f=e,b(!0)},k=e=>{h.splice(e,1),x(),w(h)};w(h),new Sortable(s,{handle:".handle",animation:150,onEnd:()=>{const e=Array.from(s.children);h=e.map((e=>({title:e.querySelector("td:nth-child(2)").textContent,content:e.querySelector("td:nth-child(3)").textContent}))),x(),w(h)}}),u.addEventListener("click",(()=>{const e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(h)),t=document.createElement("a");t.setAttribute("href",e),t.setAttribute("download","templates.json"),document.body.appendChild(t),t.click(),t.remove()})),m.addEventListener("click",(()=>p.click())),p.addEventListener("change",(e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{try{const t=JSON.parse(e.target.result);Array.isArray(t)?(h=t,x(),w(h)):alert("Invalid JSON format")}catch(e){alert("Failed to parse JSON")}},e.readAsText(t)}}))}function generateUUIDv7(){const e=BigInt(Date.now()),t=crypto.getRandomValues(new Uint8Array(10)),n=new Uint8Array(16);n[0]=Number(e>>40n&0xFFn),n[1]=Number(e>>32n&0xFFn),n[2]=Number(e>>24n&0xFFn),n[3]=Number(e>>16n&0xFFn),n[4]=Number(e>>8n&0xFFn),n[5]=Number(0xFFn&e),n[6]=15&t[0]|112,n[7]=t[1],n[8]=63&t[2]|128,n[9]=t[3],n[10]=t[4],n[11]=t[5],n[12]=t[6],n[13]=t[7],n[14]=t[8],n[15]=t[9];const o=Array.from(n,(e=>e.toString(16).padStart(2,"0"))).join("");return`${o.slice(0,8)}-${o.slice(8,12)}-${o.slice(12,16)}-${o.slice(16,20)}-${o.slice(20,32)}`}function updateFields(e,t,n){const o=window.location.href.split("/move/")[1]||"",r="     ";let a=`휴지통:${generateUUIDv7()}`;if(o.startsWith("%ED%8C%8C%EC%9D%BC:")){const e=o.includes(".")?o.split(".").pop():"";a=`파일휴지통:${generateUUIDv7()}${e?`.${e}`:""}`}else if(o.startsWith("%ED%8C%8C%EC%9D%BC%ED%9C%B4%EC%A7%80%ED%86%B5:")){const e=o.includes(".")?o.split(".").pop():"";a=`파일휴지통:${generateUUIDv7()}${e?`.${e}`:""}`}n?(e.value=a,t.value=localStorage.getItem("log")||r):(e.value="",t.value="",localStorage.setItem("log",r)),[e,t].forEach((e=>e.dispatchEvent(new Event("input"))))}function moveToBin(){if(document.getElementById("bin_check"))return;const e=document.querySelector('input[value="swap"]'),t=document.createElement("input"),n=document.createElement("label");t.type="checkbox",t.id="bin_check",n.style.cssText="user-select: none; display: inline-block; margin-left: 0.25rem",n.append(t," [A]휴지통으로 이동"),t.addEventListener("change",(()=>{const[e,n]=["title","log"].map((e=>document.querySelector(`input[name="${e}"]`)));updateFields(e,n,t.checked)}));const o=e.closest("label");o.parentNode.insertBefore(n,o.nextSibling),document.querySelector('input[name="log"]').addEventListener("input",(({target:e})=>{t.checked&&localStorage.setItem("log",e.value)}))}function updateNote(){localStorage.getItem("nmst_ver")!==new_ver&&Swal.fire({theme:wikiTheme,toast:!0,position:"top-end",title:"토론 관리 도구 업데이트 노트",timer:1e4,timerProgressBar:!0,html:'<p style="font-size:0.9rem; line-height:1.5;">[0.9.0-beta]<br>· 내부 API 기반으로 변경<br>· 승인한 편집요청 되돌리기 추가<br>· IP 정보 제공자 변경</p></div>',icon:"info",confirmButtonText:"확인했어요.",confirmButtonColor:"#3f82e6",didOpen:e=>{e.addEventListener("mouseenter",Swal.stopTimer),e.addEventListener("mouseleave",Swal.resumeTimer)}}).then((e=>{e.isConfirmed&&localStorage.setItem("nmst_ver",new_ver)}))}!function(){"use strict";document.body.insertAdjacentHTML("beforeend",'\n<template id="success">\n    <swal-icon type="success"></swal-icon>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="confirmButtonColor" value="#0275d8"/>\n</template>\n<template id="warning">\n    <swal-icon type="warning"></swal-icon>\n    <swal-param name="showCancelButton" value="true"/>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="cancelButtonText" value="취소"/>\n    <swal-param name="reverseButtons" value="true"/>\n    <swal-param name="confirmButtonColor" value="#d9534f"/>\n</template>\n<template id="error">\n    <swal-icon type="error"></swal-icon>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="confirmButtonColor" value="#d9534f"/>\n</template>\n<template id="info">\n    <swal-icon type="info"></swal-icon>\n    <swal-param name="showCancelButton" value="true"/>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="cancelButtonText" value="취소"/>\n    <swal-param name="reverseButtons" value="true"/>\n    <swal-param name="confirmButtonColor" value="#0275d8"/>\n</template>\n<template id="input">\n    <swal-param name="showCancelButton" value="true"/>\n    <swal-param name="confirmButtonText" value="확인"/>\n    <swal-param name="cancelButtonText" value="취소"/>\n    <swal-param name="reverseButtons" value="true"/>\n    <swal-param name="confirmButtonColor" value="#d9534f"/>\n</template>\n<template id="search">\n    <swal-param name="showCancelButton" value="true"/>\n    <swal-param name="confirmButtonText" value="검색"/>\n    <swal-param name="cancelButtonText" value="취소"/>\n    <swal-param name="reverseButtons" value="true"/>\n    <swal-param name="input" value="text"/>\n    <swal-param name="input" value="text"/>\n    <swal-param name="showLoaderOnConfirm" value="true"/>\n    <swal-param name="confirmButtonColor" value="#0275d8"/>\n</template>'),document.head.insertAdjacentHTML("beforeend",'<style>\n.custom-link {\n    color: #090;\n}\n\n.custom-link:hover {\n    color: #090;\n}\n\n.custom-link::before {\n    content: "";\n    background: green;\n    color: #fff;\n    font-family: "Ionicons" !important;\n    padding: 0 .15em;\n}\n\n.namu-refresher-btn {\n    display: flex;\n    gap: 0.5rem;\n    align-items: center;\n    background-color: #ef4544;\n    border: 0;\n    border-radius: 0.25rem;\n    font-size: 0.9rem;\n    color: #fff;\n    float: right;\n    padding: 0rem 0.75rem;\n    cursor: pointer;\n    transition: background-color .1s ease-in, box-shadow .1s linear;\n}\n\n.theseed-dark-mode .namu-refresher-btn {\n    background-color: #801d1c;\n}\n\n.theseed-dark-mode .namu-refresher-btn:hover {\n    background-color: #8d101d;\n}\n\n.namu-refresher-btn:hover {\n    background-color: #f15957;\n}\n\n#nmst-modal {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    width: 100%;\n    height: 100%;\n    z-index: 999;\n    background: rgba(0, 0, 0, 0.5);\n}\n\n.handle {\n    cursor: move;\n}\n</style>');const e={initialized:new Set,lastPath:location.pathname},t={"/thread/":{action:()=>new AdminController},"/BlockHistory":{selector:"li span",action:()=>urlHighlighter("li span")},"/history/":{selector:"li span",action:()=>{urlHighlighter("li span"),hideLogBtn(),preventCopyAdminAButtons()}},"/w/%EC%82%AC%EC%9A%A9%EC%9E%90:":{selector:"div:has(time[datetime]):has(span:first-child + br)",action:()=>urlHighlighter("div:has(time[datetime]):has(span:first-child + br)")},"/edit_request/":{selector:"div:has(label)",action:()=>urlHighlighter("div:has(label)")},"/aclgroup":{once:!0,action:()=>{asnBlock(),searchIP()}},"/move/":{once:!0,action:()=>moveToBin()}},n={modal:{action:()=>createModal()},theme:{action:()=>applyTheme()},ipInfo:{action:()=>ipInfo()},quickBlock:{check:()=>"빠른 ACLGroup"===document.querySelector('form[action="/aclgroup"] h4')?.textContent.trim(),action:()=>{setRollBackOption(),initAclGroupBlockManager(),loginAllowCheckbox()}}};applyTheme(),updateNote(),initXChikaInterceptor();new MutationObserver((()=>{!function(){const t=location.pathname;e.lastPath!==t&&(e.initialized.clear(),e.lastPath=t)}(),function(){for(const[e,t]of Object.entries(n))t.check&&!t.check()||t.action()}(),function(e){for(const[n,o]of Object.entries(t))if(e.startsWith(n)&&(o.selector,!o.selector||document.querySelector(o.selector))){o.action();break}}(location.pathname)})).observe(document.body,{childList:!0,subtree:!0}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",applyTheme)}();