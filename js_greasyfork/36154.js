// ==UserScript==
// @name        OddsPortal - Injector
// @namespace   Cunt
// @description Cunt
// @include     http://*.oddsportal.*/*
// @include     https://*.oddsportal.*/*
// @version     1
// @grant       none
// @downloadURL https://update.greasyfork.org/scripts/36154/OddsPortal%20-%20Injector.user.js
// @updateURL https://update.greasyfork.org/scripts/36154/OddsPortal%20-%20Injector.meta.js
// ==/UserScript==

function addGlobalJS(js) {
    var head, script;
    head = document.getElementsByTagName('head')[0];
    if (!head) { return; }
    script = document.createElement('script');
    script.type = 'text/javascript';
    script.innerHTML = js;
    head.appendChild(script);
}

addGlobalJS("var gmIteration;var gmCount;var gmKey = encodeURIComponent(window.location.href);var gmResult;var gmMarketStart = -1;var gmMarketEnd = 1;var gmMarket = gmMarketStart;var gmTimer;var gmDOCount;var gmInitialize;var gmMarketTitles = Array('Asian Handicap', 'Over/Under');var gmMarketTitles2 = Array('Asian handicap', 'Over/Under');var gmMarketNumbers = Array(4, 5);var gmMarketExist = Array(0, 0);var gmMarketExistOverride = Array(0, 0);function gmStart() {	gmIteration = -1;	gmCount = -1;	gmDOCount = -1;	gmInitialize = 0;	if (($('.cms').length != 0) && ($('.cms').text() == 'There are no odds available for this event.')) {		gmSendBack();		return;	}	if (gmMarketStart == gmMarket) {		if (!($('.lo.odd').length)) {			clearTimeout(gmTimer);			gmTimer = setTimeout(gmStart,100);			return;		}		gmResult = $('#event-status').text().split(' ');		gmResult = gmResult[2];		/*Check what markets exist*/		for (var x=0;x<gmMarketTitles.length;x++) {			if (($(\"a[title='\"+ gmMarketTitles[x] +\"']\").parent().css('display') != 'none') && (gmMarketExistOverride[x] == 0)) {				gmMarketExist[x] = 1;			}		}		gmMarket++;	}	switch(gmMarket) {		case 0:		if (gmMarketExist[0] == 0) {			/*Use 1x2 Rule*/			gmAnalysis(0);		} else {			/*Switch to AH*/			uid(gmMarketNumbers[0])._onClick();			gmAnalysis(1);		}		break;		case 1:		if (gmMarketExist[1] == 0) {			/*Leave Row Blank*/			/*Return Data to Server*/						gmSendBack();						return;		} else {			/*Switch to OH*/			uid(gmMarketNumbers[1])._onClick();			gmAnalysis(1);		}		break;		default:		gmSendBack();		break;	}}var gmLastType;var gmLastType2;var gmBookmakerCount;var gmBookmakerIteration;var gmTargetMarket;function gmAnalysis(type) {	if (typeof type === 'undefined') {		type = gmLastType;	} else {		gmLastType = type;	}	switch(type) {		case 0:		/*1x2 Rule:Can Grab Data Upon Load*/		break;		case 1:		if (!($('.odds-cnt').length)) {			clearTimeout(gmTimer);			gmTimer = setTimeout(gmAnalysis, 100);			return;		}		gmBookmakerCount = [];		gmBookmakerIteration = [];		/*Normal Rule:Determine Market With Most Bookmakers*/		$('.odds-cnt').each(function(i) {			var currCount = $('.odds-cnt:eq('+ i +')').text().substr(1);			currCount = currCount.substr(0, (currCount.length-1));			gmBookmakerCount.push(parseInt(currCount));			gmBookmakerIteration.push(i);		});		var booksSet = new BooksSet(gmBookmakerCount, gmBookmakerIteration);		booksSet.sort('quantity');		var targetMarket = booksSet.get('iteration')[(gmBookmakerCount.length-1)];		if (booksSet.get('quantity')[(gmBookmakerCount.length-1)] == 0) {			switch(gmMarket) {				case 0:				gmMarketExist[0] = 0;				gmMarketExistOverride[0] = 1;				gmMarket = gmMarketStart;				uid(2)._onClick();				gmStart();				break;				case 1:				gmSendBack();				break;			}			return;		}		var targetMarketLink = $('.odds-co:eq('+ targetMarket +')').html().split('\"');		var targetMarketTest = $('.odds-co:eq('+ targetMarket +')').text();		targetMarketLink = targetMarketLink[5];		gmTargetMarket = $(\"a[onclick='\"+ targetMarketLink +\"']\").text();		gmTargetMarket = gmTargetMarket.replace(gmMarketTitles2[gmMarket],'').trim();		gmTargetMarket = gmTargetMarket.split(' ');		gmTargetMarket = parseFloat(gmTargetMarket[0]);		targetMarketLink = targetMarketLink.replace('return false;','');		if (targetMarketTest == 'Compare odds') {			eval(targetMarketLink);		}		var removeCount = 0;		$('.table-container.exchangeContainer').remove();		$('.table-container').each(function(i) {			if (i != targetMarket) {				$(this).remove();				removeCount--;			}			removeCount++;		});		/*Grab Data*/		break;	}	gmTestVar = true;	gmRestrict = true;	gmRestrictType = 0;	gmBooks = Array();	gmCount2 = 0;	gmSort = 0;	gmExtra = 0;	gmDataGrab(type);}var gmNames = [];var gmHandicaps = [];var gmOdds1 = [];var gmOdds2 = [];var gmPayout = [];var gmMarkets = [];var gmTestVar;var gmRestrict;var gmRestrictType;var gmBooks;var gmBookCount;var gmCount2;var gmVar1;var gmVar2;var gmNames1;var gmHandicaps1;var gmOdds11;var gmOdds21;var gmPayout1;var gmDiffs;var gmSort;var gmExtra;var gmMarketFocus;var gmColumnExist;function gmDataGrab(type) {	if (typeof type === 'undefined') {		type = gmLastType2;	} else {		gmLastType2 = type;	}		gmNames1 = [];	gmHandicaps1 = [];	gmOdds11 = [];	gmOdds21 = [];	gmPayout1 = [];	gmDiffs = [];	gmBookCount = {pinnacle:0,sbobet:0};	gmCount2 = 0;	gmMarketFocus = -1;	gmColumnExist = 0;	gmSort++;		switch(type) {		case 0:		/*1x2 Rule*/		$('.lo.odd').each(function(i) {			var test = parseFloat($('td.right.odds:eq('+(i*6)+')').text());			var test2 = -0.5;			var test3 = parseFloat($('td.right.odds:eq('+(i*6 + 2)+')').text());			var test4 = parseFloat($('td.center:eq('+(i*2)+')').text());			if ((isNaN(test) == false) && (isNaN(test3) != false)) {				test3 = (1.0 / ((test4 / 100.00) * (1.0 - (1.0 / test)))).toFixed(2);			} else if ((isNaN(test) != false) && (isNaN(test3) == false)) {				test = (((test4 / 100.00) * test3) / (((test4 / 100.00) * test3) - 1.0)).toFixed(2);			}			if ((isNaN(test) == false) && (isNaN(test2) == false) && (isNaN(test3) == false) && (isNaN(test4) == false)) {				gmNames1.push($('a.name:eq('+(i*2)+')').text().toLowerCase().trim());				gmHandicaps1.push(test2);				gmOdds11.push(test);				gmOdds21.push(test3);				gmPayout1.push(test4);				gmDiffs.push(Math.abs(parseFloat(test)-2.0));				gmCount2++;			}			if ((isNaN(test) != false) && (isNaN(test3) != false)) {				gmColumnExist = 1;			}		});		$('.lo.even').each(function(i) {			var test = parseFloat($('td.right.odds:eq('+(i*6 + 3)+')').text());			var test2 = -0.5;			var test3 = parseFloat($('td.right.odds:eq('+(i*6 + 5)+')').text());			var test4 = parseFloat($('td.center:eq('+(i*2 + 1)+')').text());			if ((isNaN(test) == false) && (isNaN(test3) != false)) {				test3 = (1.0 / ((test4 / 100.00) * (1.0 - (1.0 / test)))).toFixed(2);			} else if ((isNaN(test) != false) && (isNaN(test3) == false)) {				test = (((test4 / 100.00) * test3) / (((test4 / 100.00) * test3) - 1.0)).toFixed(2);			}			if ((isNaN(test) == false) && (isNaN(test2) == false) && (isNaN(test3) == false) && (isNaN(test4) == false)) {				gmNames1.push($('a.name:eq('+(i*2 + 1)+')').text().toLowerCase().trim());				gmHandicaps1.push(test2);				gmOdds11.push(test);				gmOdds21.push(test3);				gmPayout1.push(test4);				gmDiffs.push(Math.abs(parseFloat(test)-2.0));				gmCount2++;			}			if ((isNaN(test) != false) && (isNaN(test3) != false)) {				gmColumnExist = 1;			}		});		if (gmCount2 == 0) {			gmMarket++;			gmStart();			return;		}		break;		case 1:		/*Other Markets*/		$('.lo.odd').each(function(i) {			var test = parseFloat($('td.right.odds:eq('+(i*4)+')').text());			var test2 = parseFloat($('td.center:eq('+(i*4)+')').text());			var test3 = parseFloat($('td.right.odds:eq('+(i*4 + 1)+')').text());			var test4 = parseFloat($('td.center:eq('+(i*4 + 1)+')').text());			if ((isNaN(test) == false) && (isNaN(test3) != false)) {				test3 = (1.0 / ((test4 / 100.00) * (1.0 - (1.0 / test)))).toFixed(2);			} else if ((isNaN(test) != false) && (isNaN(test3) == false)) {				test = (((test4 / 100.00) * test3) / (((test4 / 100.00) * test3) - 1.0)).toFixed(2);			}			if ((isNaN(test) == false) && (isNaN(test2) == false) && (isNaN(test3) == false) && (isNaN(test4) == false)) {				if (gmTargetMarket == test2) {					gmNames1.push($('a.name:eq('+(i*2)+')').text().toLowerCase().trim());					gmHandicaps1.push(test2);					gmOdds11.push(test);					gmOdds21.push(test3);					gmPayout1.push(test4);					gmDiffs.push(Math.abs(parseFloat(test)-2.0));					gmCount2++;				}			}			if ((isNaN(test) != false) && (isNaN(test3) != false)) {				gmColumnExist = 1;			}		});		$('.lo.even').each(function(i) {			var test = parseFloat($('td.right.odds:eq('+(i*4 + 2)+')').text());			var test2 = parseFloat($('td.center:eq('+(i*4 + 2)+')').text());			var test3 = parseFloat($('td.right.odds:eq('+(i*4 + 3)+')').text());			var test4 = parseFloat($('td.center:eq('+(i*4 + 3)+')').text());			if ((isNaN(test) == false) && (isNaN(test3) != false)) {				test3 = (1.0 / ((test4 / 100.00) * (1.0 - (1.0 / test)))).toFixed(2);			} else if ((isNaN(test) != false) && (isNaN(test3) == false)) {				test = (((test4 / 100.00) * test3) / (((test4 / 100.00) * test3) - 1.0)).toFixed(2);			}			if ((isNaN(test) == false) && (isNaN(test2) == false) && (isNaN(test3) == false) && (isNaN(test4) == false)) {				if (gmTargetMarket == test2) {					gmNames1.push($('a.name:eq('+(i*2 + 1)+')').text().toLowerCase().trim());					gmHandicaps1.push(test2);					gmOdds11.push(test);					gmOdds21.push(test3);					gmPayout1.push(test4);					gmDiffs.push(Math.abs(parseFloat(test)-2.0));					gmCount2++;				}			}			if ((isNaN(test) != false) && (isNaN(test3) != false)) {				gmColumnExist = 1;			}		});		if ((gmCount2 == 0) && (gmColumnExist == 0)) {			clearTimeout(gmTimer);			setTimeout(gmDataGrab, 100);			return;		} else if ((gmCount2 == 0) && (gmColumnExist == 1)) {			gmMarket++;			gmStart();			return;		}		break;	}		/*Sort Data*/	var booktest1 = gmNames1.indexOf('pinnacle');	var successful = 0;	if (booktest1 != -1) {		gmNames.push(gmNames1[booktest1]);		gmHandicaps.push(gmHandicaps1[booktest1]);		gmOdds1.push(gmOdds11[booktest1]);		gmOdds2.push(gmOdds21[booktest1]);		gmPayout.push(gmPayout1[booktest1]);		gmMarkets.push(gmMarketNumbers[gmMarket]);		gmNames1.splice(booktest1, 1);		gmHandicaps1.splice(booktest1, 1);		gmOdds11.splice(booktest1, 1);		gmOdds21.splice(booktest1, 1);		gmPayout1.splice(booktest1, 1);		successful++;	}	var booktest2 = gmNames1.indexOf('sbobet');	if (booktest2 != -1) {		gmNames.push(gmNames1[booktest2]);		gmHandicaps.push(gmHandicaps1[booktest2]);		gmOdds1.push(gmOdds11[booktest2]);		gmOdds2.push(gmOdds21[booktest2]);		gmPayout.push(gmPayout1[booktest2]);		gmMarkets.push(gmMarketNumbers[gmMarket]);		gmNames1.splice(booktest2, 1);		gmHandicaps1.splice(booktest2, 1);		gmOdds11.splice(booktest2, 1);		gmOdds21.splice(booktest2, 1);		gmPayout1.splice(booktest2, 1);		successful++;	}		if ((successful < 2) && (gmNames1.length > 0)) {		var oddsSet = new OddsSet(gmNames1, gmHandicaps1, gmOdds11, gmOdds21, gmPayout1, gmDiffs);		oddsSet.sort('diff');				var limit = 2 - successful;		if (limit > gmNames1.length) {			limit = gmNames1.length;		}				for (var x=0;x<limit;x++) {			gmNames.push(oddsSet.get('name')[x]);			gmHandicaps.push(oddsSet.get('market')[x]);			gmOdds1.push(oddsSet.get('odds1')[x]);			gmOdds2.push(oddsSet.get('odds2')[x]);			gmPayout.push(oddsSet.get('payout')[x]);			gmMarkets.push(gmMarketNumbers[gmMarket]);		}	}		if (gmMarket == gmMarketEnd) {		gmSendBack();	} else {		gmMarket++;		gmStart();		return;	}}function gmSendBack() {	gmNames = gmNames.join('|');	gmHandicaps = gmHandicaps.join('|');	gmOdds1 = gmOdds1.join('|');	gmOdds2 = gmOdds2.join('|');	gmPayout = gmPayout.join('|');	gmMarkets = gmMarkets.join('|');	$.post('http://localhost/oddsportal/check.php', { a:3,n:gmNames,h:gmHandicaps,o1:gmOdds1,o2:gmOdds2,p:gmPayout,k:gmKey,m:gmMarkets,r:gmResult }, function(data) {		gmMatch();	}, 'json');}function Odds(name, market, odds1, odds2, payout, diff) {    this.name = name;    this.market = market;    this.odds1 = odds1;    this.odds2 = odds2;    this.payout = payout;    this.diff = diff;}function OddsSet(names, markets, odds1, odds2, payouts, diffs) {    this.content = [];    for (var i = 0; i < names.length; i++) {        this.content.push(new Odds(names[i], markets[i], odds1[i], odds2[i], payouts[i], diffs[i]));    }    this.sort = function(aspect) {        this.content.sort(function(a, b) {            return ((a[aspect] < b[aspect]) ? -1 :                 ((a[aspect] > b[aspect]) ? 1 : 0));        });    };                        this.get = function(aspect) {        var r = [];        for (var i = 0; i < this.content.length; i++) {            r.push(this.content[i][aspect]);        }        return r;    }}function Books(quantity, iteration) {    this.quantity = quantity;    this.iteration = iteration;}function BooksSet(quantity, iteration) {    this.content = [];    for (var i = 0; i < quantity.length; i++) {        this.content.push(new Books(quantity[i], iteration[i]));    }    this.sort = function(aspect) {        this.content.sort(function(a, b) {            return ((a[aspect] < b[aspect]) ? -1 :                 ((a[aspect] > b[aspect]) ? 1 : 0));        });    };                        this.get = function(aspect) {        var r = [];        for (var i = 0; i < this.content.length; i++) {            r.push(this.content[i][aspect]);        }        return r;    }}");

addGlobalJS("function gmMatch() {	$.post('http://localhost/oddsportal/check.php', { a:2 }, function(data) {  		window.location.assign(data.link);	}, 'json');}");

document.addEventListener ("readystatechange", FireWhenReady, true);

function FireWhenReady () {
    this.fired  = this.fired || false;

    if (    document.readyState != "uninitialized" &&
          document.readyState != "loading" &&
          ! this.fired
    ) {
        this.fired = true;

        document.body.onload  = function () {
            if ((window.location.href != 'http://www.oddsportal.com/') && (window.location.href != 'https://www.oddsportal.com/')) {
            gmStart();
          } else {
            gmMatch();
          }
        };
    }
}