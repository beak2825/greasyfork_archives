// ==UserScript==
// @name         ВК автолайкер
// @namespace    tuxuuman:vk:autolike
// @version      0.2.5
// @description  Автолайкер для ВК
// @author       tuxuuman<tuxuuman@gmail.com>
// @match        *://vk.com/*
// @grant        GM_openInTab
// @grant        GM_registerMenuCommand
// @grant        GM_addStyle
// @grant        GM_addValueChangeListener
// @grant        GM_setValue
// @grant        GM_getValue
// @require      https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js
// @run-at       document-end
// @downloadURL https://update.greasyfork.org/scripts/38786/%D0%92%D0%9A%20%D0%B0%D0%B2%D1%82%D0%BE%D0%BB%D0%B0%D0%B9%D0%BA%D0%B5%D1%80.user.js
// @updateURL https://update.greasyfork.org/scripts/38786/%D0%92%D0%9A%20%D0%B0%D0%B2%D1%82%D0%BE%D0%BB%D0%B0%D0%B9%D0%BA%D0%B5%D1%80.meta.js
// ==/UserScript==

(function () {
    'use strict';
    var _slicedToArray=function(){function b(c,d){var e=[],f=!0,g=!1,h=void 0;try{for(var k,j=c[Symbol.iterator]();!(f=(k=j.next()).done)&&(e.push(k.value),!(d&&e.length===d));f=!0);}catch(l){g=!0,h=l}finally{try{!f&&j['return']&&j['return']()}finally{if(g)throw h}}return e}return function(c,d){if(Array.isArray(c))return c;if(Symbol.iterator in Object(c))return b(c,d);throw new TypeError('Invalid attempt to destructure non-iterable instance')}}();(function(b){b.fn.serializeFormJSON=function(){var c={},d=this.serializeArray();return b.each(d,function(){var e=parseInt(this.value),f=Number.isNaN(e)?this.value:e;c[this.name]?(!c[this.name].push&&(c[this.name]=[c[this.name]]),c[this.name].push(f)):c[this.name]=f}),c}})(jQuery);var settingsBox=null,currentTab=null,currentFriendElIdx=0,currentFriendRowEl=null,settings=Object.assign({maxPhoto:1,maxPost:1,interval:5,adminId:0,messageText:'\u041F\u0440\u0438\u0432\u0435\u0442, \u044F \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B \u0441\u0432\u043E\u044E \u0440\u0430\u0431\u043E\u0442\u0443!'},GM_getValue('settings'));GM_getValue('settings')||GM_setValue('settings',settings),GM_setValue('al_wall',null);function log(){for(var e,c=arguments.length,b=Array(c),d=0;d<c;d++)b[d]=arguments[d];(e=console.log).call.apply(e,[null,'AUTOLIKE |'].concat(b))}function sendMessage(b,c,d){function e(){setTimeout(function(){log('DONE',b),$('.placeholder').hide();var f=$('.im-chat-input--text');log('inputText',f),f.text(c);var g=$('.im-send-btn.im-chat-input--send');log('sendBtn',g),g.removeClass('im-send-btn_audio').addClass('im-send-btn_send'),setTimeout(function(){return g.click()},1e3),'function'==typeof d&&d()},1e3)}'im'==cur.module?e():nav.go('/im?sel='+b,{},{onDone:function onDone(){e()}})}function getNextFriend(){log('getNextFriend');var c=$('#friends_list .friends_user_row:eq('+currentFriendElIdx++ +')');if(log('getNextFriend userRow',c),0!=c.length){currentFriendRowEl=c,log('startAnimate',currentFriendRowEl),$('html, body').animate({scrollTop:c.offset().top-100},500),log('stopAnimate',currentFriendRowEl);var _userRow$attr$match=c.attr('id').match(/friends_user_row(\d+)/),_userRow$attr$match2=_slicedToArray(_userRow$attr$match,2),b=_userRow$attr$match2[1];return b}}function selectCurrentUserRow(){currentFriendRowEl&&currentFriendRowEl.addClass('liked')}function closeCurrentTab(){currentTab&&currentTab.close()}function startPostLike(){log('startPostLike');var b=getNextFriend();log('user_id',b),b?(currentTab=GM_openInTab('https://vk.com/wall'+b+'?own=1#al'),currentTab.onclose=function(){log('\u0412\u043A\u043B\u0430\u0434\u043A\u0430 \u0437\u0430\u043A\u0440\u044B\u0442\u0430. \u0411\u0435\u0440\u0435\u043C \u0441\u043B\u0435\u043B\u0443\u044E\u0449\u0435\u0433\u043E \u044E\u0437\u0435\u0440\u0430'),selectCurrentUserRow(),GM_setValue('al_wall',null),startPostLike()}):(log('\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 \u0437\u0430\u043A\u043E\u043D\u0447\u0438\u043B\u0438\u0441\u044C'),0<settings.adminId&&sendMessage(settings.adminId,settings.messageText))}GM_addValueChangeListener('al_wall',function(b,c,d,e){e&&(log(b,d),'finish'==d&&closeCurrentTab())});function start(){nav.go('/friends?id='+cur.options.user_id+'&section=all',null,{onDone:function onDone(){log('DONE'),startPostLike()}})}if(GM_addStyle('\n\t.friends_user_row.liked {\n\t\tbackground-color: #74f344;\n\t}\n\n\t.box_controls button:disabled {\n\t\tbackground: #d8d8d8;\n\t\tcursor: not-allowed;\n\t}\n\n\t#__al_settings table {\n\t\twidth: 100%;\n\t}\n\n\t#__al_settings table td {\n\t\ttext-align: right;\n\t}\n\n\t#__al_settings table td:first-child {\n\t\ttext-align: left;\n\t}\n\n\t#__al_settings table input {\n\t\twidth: 50%;\n\t}\n\n\t#__al_progress_container  {\n\t\ttext-align: center;\n\t}\n\t'),GM_registerMenuCommand('\u0410\u0432\u0442\u043E\u043B\u0430\u0439\u043A\u0435\u0440',function(){if(!location.hash&&'profile'==cur.module){if(!settingsBox){settingsBox=MessageBox({title:'\u0410\u0432\u0442\u043E\u043B\u0430\u0439\u043A\u0435\u0440 (\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438)',width:400,height:'auto',animSpeed:300,dark:!0,selfDestruct:!1}),settingsBox.content('\n                <div id="__al_settings">\n                    <form id="__al_settings_form">\n\t\t\t\t\t<table>\n\t\t\t\t\t\t<tr> <td>\u0417\u0430\u0434\u0435\u0440\u0436\u043A\u0430 (\u0441\u0435\u043A\u0443\u043D\u0434\u044B):</td><td><input name="interval" type="number" value="'+settings.interval+'"></td> </tr>\n\t\t\t\t\t\t<tr> <tr>  <td>\u041A\u043E\u043B-\u0432\u043E \u0437\u0430\u043F\u0438\u0441\u0435\u0439:</td><td><input name="maxPost" type="number" value="'+settings.maxPost+'" min="0"></td> </tr>\n                        <tr> <td>\u041A\u043E\u043B-\u0432\u043E \u0444\u043E\u0442\u043E: </td><td><input name="maxPhoto" type="number" value="'+settings.maxPhoto+'" min="0"></td> </tr>\n                        <tr> <td>ID \u0430\u0434\u043C\u0438\u043D\u0430: </td><td><input name="adminId" type="text" value="'+settings.adminId+'" min="0"></td> </tr>\n                        <tr> <td>\u0422\u0435\u043A\u0441\u0442 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F: </td><td><input name="messageText" type="text" value="'+settings.messageText+'"></td> </tr>\n                    </table>\n                    </form>\n\t\t\t\t</div>\n\t\t\t\t');var b=$(settingsBox.bodyNode);settingsBox.addButton('\u0417\u0430\u043F\u0443\u0441\u043A',function(){var d=b.find('#__al_settings_form').serializeFormJSON();settingsBox.hide(),settings=d,log('newSettings',d),GM_setValue('settings',d),start()})}settingsBox.show()}else alert('\u041F\u0435\u0440\u0435\u0439\u0434\u0438\u0442\u0435 \u043D\u0430\u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u043F\u0440\u043E\u0444\u0438\u043B\u044F')}),'#al'==location.hash){var finish=function(){GM_setValue('al_wall','finish')},likePhoto=function(){var b=0;log('\u0438\u0434\u0435\u043C \u043D\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0441 \u0444\u043E\u0442\u043A\u0430\u043C\u0438'),nav.go('/id'+cur.options.owner_id,null,{onDone:function onDone(){log('\u043D\u0430\u0447\u0438\u043D\u0430\u0435\u043C \u043B\u0430\u0439\u043A\u0430\u0442\u044C \u0444\u043E\u0442\u043A\u0438');var c=$('#profile_photo_link');if(0==c.length)return log('\u0424\u043E\u0442\u043E\u043A \u043D\u0435\u0442\u0443'),void finish();c.click();var d=setInterval(function(){Photoview.show(!1,b)===void 0||b>=max?(clearInterval(d),log('\u0444\u043E\u0442\u043A\u0438 \u043F\u0440\u043E\u043B\u0430\u0439\u043A\u0430\u043D\u044B'),finish()):setTimeout(function(){b++,$('#pv_like').hasClass('pv_liked')?(log('\u0444\u043E\u0442\u043A\u0430 \u0443\u0436\u0435 \u043B\u0430\u043A\u043D\u0443\u0442\u0430. \u0431\u0435\u0440\u0435\u043C \u0434\u0440\u0443\u0433\u0443\u044E'),max++):(log('\u043B\u0430\u0439\u043A\u0430\u0435\u043C \u0444\u043E\u0442\u043A\u0443'),Photoview.like())},500)},1e3*interval)}})},max=settings.maxPost,interval=settings.interval;cur.options===void 0?(log('\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0431\u043B\u043E\u0447\u0435\u043D\u0430 \u043B\u0438\u0431\u043E \u043F\u0443\u0441\u0442\u0430'),finish()):function likePost(){var b=0;log('\u043D\u0430\u0447\u0438\u043D\u0430\u0435\u043C \u043B\u0430\u0439\u043A\u0430\u0442\u044C \u0437\u0430\u043F\u0438\u0441\u0438');var c=setInterval(function(){var d=$('#page_wall_posts .post a.post_like:not(.my_like):eq('+b+')');!cur.pgCount||0==d.length||b>=max?(clearInterval(c),log('\u0437\u0430\u043F\u0438\u0441\u0438 \u043F\u0440\u043E\u043B\u0430\u0439\u043A\u0430\u043D\u044B'),likePhoto()):(b++,$('html, body').animate({scrollTop:d.offset().top},1e3),log('\u043B\u0430\u0439\u043A\u0430\u0435\u043C \u0437\u0430\u043F\u0438\u0441\u044C',d),d.click())},1e3*interval)}()}
})();