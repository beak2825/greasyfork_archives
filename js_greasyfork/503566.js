// ==UserScript==
// @name         TrackingTokenStripper
// @version      1.0
// @description  Remove most of the annoying tracking token from URL parameters
// @license      MIT
// @homepage     https://blog.miniasp.com/
// @homepageURL  https://blog.miniasp.com/
// @website      https://www.facebook.com/will.fans
// @source       https://github.com/doggy8088/TrackingTokenStripper
// @namespace    https://github.com/doggy8088/TrackingTokenStripper
// @author       Will Huang
// @match        *://*/*
// @exclude      *://developers.google.com/*
// @exclude      *://*.veritrans.co.jp/*
// @exclude      *://*.pcsc.com.tw/*
// @exclude      *://*.7-11.com.tw/MyShip/*
// @exclude      *://*.okmart.com.tw/*
// @exclude      *://*.oracle.com/*
// @exclude      *://*.expandurl.net/*
// @exclude      *://*.recaptcha.net/*
// @exclude      *://*.mail.google.com/*
// @exclude      *://contacts.google.com/*
// @exclude      *://ogs.google.com/*
// @exclude      *://accounts.google.com/*
// @exclude      *://*.ctfile.com/tokenGo.php?*
// @exclude      *://twitter.com/oauth/*
// @exclude      *://*.nat.gov.tw/*
// @exclude      *://semiphemeral.com/*
// @exclude      *://access.line.me/*
// @exclude      *://*/auth/*
// @exclude      *://shopify.com/*
// @exclude      *://takeout-pa.clients6.google.com/*
// @exclude      *://*.ruten.com.tw/system/adult_confirm.php?refer=*
// @exclude      *://apkcombo.com/*
// @exclude      *://download.apkcombo.com/*
// @exclude      *://tuetuelook.com/checkouts/*
// @exclude      *://*.plurk.com/Payment/*
// @exclude      *://*.majorgeeks.com/*
// @exclude      *://*.fisc.com.tw/*
// @exclude      *://*.tappaysdk.com/*
// @exclude      *://id.twitch.tv/*
// @exclude      *://buhitter.com/*
// @exclude      *://*.facebook.com/login/*
// @exclude      *://*.samsungcloud.com/*
// @exclude      *://*.facebook.com/v3.0/dialog/oauth?client_id=*
// @run-at       document-start
// @downloadURL https://update.greasyfork.org/scripts/503566/TrackingTokenStripper.user.js
// @updateURL https://update.greasyfork.org/scripts/503566/TrackingTokenStripper.meta.js
// ==/UserScript==

(function() {

    var s = TrackingTokenStripper(location.href)
        .remove('fbclid')
        .remove('_openstat')
        .remove('gclid')
        .remove('igshid')
        .remove('igsh')
        .remove('_hsenc')
        .remove('_hsmi')
        .remove('mc_cid')
        .remove('mc_eid')
        .remove('mkt_tok')
        .remove('utm_source')
        .remove('utm_medium')
        .remove('utm_term')
        .remove('utm_campaign')
        .remove('utm_content')
        .remove('utm_cid')
        .remove('utm_reader')
        .remove('utm_referrer')
        .remove('utm_name')
        .remove('utm_social')
        .remove('utm_social-type')
        .remove('yclid')
        .remove('notif_id')
        .remove('notif_t')
        .remove('ref')
        .remove('e_t')
        .remove('utm_campa')
        .remove('cref')
        .remove('sale_post_id')
        .remove('ref_src')
        .remove('ref_url')
        .remove('show_switched_toast')
        .remove('cid')
        .remove('liff.referrer')
        .remove('ltclid')
        .remove('subid1')
        .remove('sharedid')
        .remove('irgwc')
        .remove('irclickid')
        .remove('acontext')
        .remove('#goog_rewarded')
        .remove('fr')
        .remove('iscqry')
        .remove('hoisted_section_header_type')
        .remove('__cf_chl_captcha_tk__')
        .remove('share_medium')
        .remove('share_plat')
        .remove('share_source')
        .remove('share_tag')
        .remove('timestamp')
        .remove('unique_k')
        .remove('imgrefurl')
        .remove('extid')
        .remove('itm_source')
        .remove('itm_campaign')
        .remove('itm_content')
        .remove('itm_medium')
        .remove('cota')
        .remove('kuai_so')
        .remove('jso')
        .remove('rtc')
        .remove('sfnsn')
        .remove('preview_pb')
        .remove('sec_user_id')
        .remove('share_app_id')
        .remove('share_item_id')
        .remove('u_code')
        .remove('ugbiz_name')
        .remove('share_link_id')
        .remove('timestamp')
        .remove('is_copy_url')
        .remove('is_from_webapp')
        .remove('item_id')
        .remove('sig')
        .remove('iid')
        .remove('nid')
        .remove('uid')
        .remove('ocid')
        .remove('adsrc')
        .remove('ei')
        .remove('ts')
        .remove('aq')
        .remove('oq')
        .remove('at')
        .remove('ai')
        .remove('fr2')
        .remove('snr')
        .remove('momo')
        .remove('Area')
        .remove('mdiv')
        .remove('oid')
        .remove('#m')
        .remove('amp_client_id')
        .remove('mweb_unauth_id')
        .remove('amp_url')
        .remove('amp_expand')
        .remove('vd_source')
        .remove('freecoins')
        .remove('redirect_to')
        .remove('__xts__[0]')
        .remove('at_custom1')
        .remove('at_custom4')
        .remove('at_custom3')
        .remove('at_custom2')
        .remove('at_custom7')
        .remove('at_custom')
        .remove('at_campaign')
        .remove('at_medium')
        .remove('usg')
        .remove('fb_comment_id')
        .remove('fs')
        .remove('vm')
        .remove('show_invite_to_follow')
        .remove('show_switched_tooltip')
        .remove('show_podcast_settings')
        .remove('show_community_transition')
        .remove('show_community_review_changes')
        .remove('show_follower_visibility_disclosure')
        .remove('rid')
        .remove('ct')
        .remove('is_from_login')
        .remove('sp_atk')
        .remove('af_click_lookback')
        .remove('af_reengagement_window')
        .remove('af_siteid')
        .remove('af_sub_siteid')
        .remove('af_viewthrough_lookback')
        .remove('is_retargeting')
        .remove('stm_medium')
        .remove('stm_source')
        .remove('ust')
        .remove('fbrefresh')
        .remove('sub_confirmation')
        .remove('share_from')
        .remove('token')
        .remove('nav_ref')
        .remove('bpn_id')
        .remove('is_all')
        .remove('notif_ids[0]')
        .remove('notif_ids[1]')
        .remove('notif_ids[2]')
        .remove('notif_ids[3]')
        .remove('notif_ids[4]')
        .remove('notif_ids[5]')
        .remove('notif_ids[6]')
        .remove('notif_ids[7]')
        .remove('notif_ids[8]')
        .remove('notif_ids[9]')
        .remove('notif_ids[10]')
        .remove('scid')
        .remove('psig')
        .remove('linkId')
        .remove('referrer')
        .remove('goog_rewarded')
        .remove('offset')
        .remove('momo')
        .remove('redirect')
        .remove('provider')
        .remove('tn-str')
        .remove('src')
        .remove('vh')
        .remove('sfnsn')
        .remove('no_rd')
        .remove('no-reload')
        .remove('SourceCode')
        .remove('nic')
        .remove('ref_src')
        .remove('reload')
        .remove('spm_id_from')
        .remove('__xts__')
        .remove('__cft__[0]')
        .remove('__so__')
        .remove('brand_redir')
        .remove('additional_content')
        .remove('sale_post_id')
        .remove('comment_tracking')
        .remove('hoisted_section_header_type')
        .remove('c_open')
        .remove('external_ref')
        .remove('feature')
        .remove('amp')
        .remove('__twitter_impression')
        .remove('ltclid')
        .remove('guccounter')
        .remove('guce_referrer')
        .remove('guce_referrer_sig')
        .remove('cid')
        .remove('ts')
        .remove('rc')
        .remove('fref')
        .remove('hc_location')
        .remove('__tn__')
        .remove('hc_ref')
        .remove('eid')
        .remove('isGroup')
        .remove('utm')
        .remove('__cf_chl_captcha_tk__')
        .remove('itm_source')
        .remove('itm_campaign')
        .remove('itm_content')
        .remove('itm_medium')
        .remove('cota')
        .remove('kuai_so')
        .remove('jso')
        .remove('utm_content')
        .remove('substory_index')
        .remove('page_source')
        .remove('is_lookaside')
        .remove('sfns')
        .remove('hoisted_items')
        .remove('pageid')
        .remove('pnref')
        .remove('ftentidentifier')
        .remove('padding')
        .remove('modal')
        .remove('show_switched_toast')
        .remove('ref_url')
        .remove('prefetchtimestamp')
        .remove('shopid')
        .remove('from')
        .remove('imgrefurl')
        .remove('ui')
        .remove('rs')
        .remove('ad')
        .remove('locale_override')
        .remove('drawer')
        .remove('usp')
        .remove('exitcode')
        .remove('re')
        .remove('rcpt')
        .remove('m')
        .remove('.intl')
        .remove('.lang')
        .remove('cjevent')
        .remove('wvr')
        .remove('refer_flag')
        .remove('brand')
        .remove('sortOrder')
        .remove('provider')
        .remove('noamp')
        .remove('shortlink')
        .remove('af_xp')
        .remove('lfhs')
        .remove('show_community_rollback')
        .remove('prd')
        .remove('cxt')
        .remove('smtt')
        .remove('fbs')
        .remove('store_visit_source')
        .remove('openExternalBrowser')
        .remove('variant')
        .remove('idorvanity')
        .remove('context')
        .remove('_gl')
        .remove('_ga')
        .remove('recommended_by')
        .remove('mibextid')
        .remove('at_link_id')
        .remove('at_ptr_name')
        .remove('at_campaign_type')
        .remove('at_bbc_team')
        .remove('at_format')
        .remove('at_link_origin')
        .remove('at_link_type')
        .remove('max_id')
        .remove('is_from_webapp')
        .remove('is_copy_url')
        .remove('preventIntent')
        .remove('ogTagImageUrl')
        .remove('xptdk')
        .remove('_branch_referrer')
        .remove('_branch_match_id')
        .remove('locale2')
        .remove('tbua')
        .remove('paipv')
        .remove('eav')
        .remove('sloc')
        .remove('spm')
        .remove('mytmenu')
        .remove('user_number_id')
        .remove('mm_sycmid')
        .remove('llbPlatform')
        .remove('dim')
        .remove('oaid')
        .remove('bc_fl_src')
        .remove('llbPlatform')
        .remove('llbOsd')
        .remove('agentId')
        .remove('agentIdmm_unid')
        .remove('agentIdclickid')
        .remove('agentIdali_trackid')
        .remove('agentIdjlogid')
        .remove('wptouch_switch')
        .remove('d_id')
        .remove('_from')
        .remove('up_id')
        .remove('buvid')
        .remove('ig_rid')
        .remove('tt_medium')
        .remove('tt_email_id')
        .remove('tt_content')
        .remove('ignore_query')
        .remove('h')
        .remove('c[0]')
        .remove('sub_confirmation')
        .remove('__c')
        .remove('AFFILIATE')
        .remove('mt_nav')
        .remove('ldtag_cl')
        .remove('adid')
        .remove('advid')
        .remove('dsp')
        .remove('ev')
        .remove('ifa')
        .remove('bcmt')
        .remove('__wblt')
        .remove('oaparams')
        .remove('6__zoneid')
        .remove('1__cb')
        .remove('774eab9417__oadest')
        .remove('CLK')
        .remove('adid')
        .remove('ad_id')
        .remove('bsa_pro_url')
        .remove('dbname')
        .remove('is_recommend')
        .remove('ump')
        .remove('_i')
        .remove('subid')
        .remove('langid')
        .remove('lid')
        .remove('afl')
        .remove('bannerid')
        .remove('oaparams')
        .remove('2__bannerid')
        .remove('6__zoneid')
        .remove('1__cb')
        .remove('774eab9417__oadest')
        .remove('list_entrance')
        .remove('logTag')
        .remove('AspxAutoDetectCookieSupport')
        .remove('focus_composer')
        .remove('m_entstream_source')
        .remove('nav_source')
        .remove('cvid')
        .remove('img_index')
        .remove('game_biz')
        .remove('referral_surface')
        .remove('str_g1')
        .remove('ab_channel')
        .remove('spss')
        .remove('session_id')
        .remove('hit_type')
        .remove('ig_mid')
        .remove('fromid')
        .remove('fromtitle')
        .remove('fromModule')
        .remove('pcampaignid')
        .remove('referer_url')
        .remove('referer_video_id')
        .remove('traffic_type')
        .remove('is_from_webapp')
        .remove('sender_device')
        .remove('web_id')
        .remove('failedScript')
        .remove('mzl')
        .remove('ltsid')
        .remove('client_tracking_params')
        .remove('LIVRET')
        .remove('rdid')
        .remove('search_source')
        .remove('sender_id')
        .remove('invite_code')
        .remove('utparam')
        .remove('abbucket')
        .remove('priceTId')
        .remove('jump_opus')
        .remove('kw')
        .remove('xmt')
        .remove('si')
        .remove('gad_source')
        .toString();

    if (s && location.href !== s) {
        location.href = s;
    }

    function TrackingTokenStripper(url) {
        return {
            remove(name) {
                var [path, other] = url.split('?');
                var [query, hash] = other ? other.split('#') : [query, ''];
                if (query) {
                    let new_query = [];
                    for (let param of query.split('&')) {
                        let [key, val] = param.split('=');
                        if (key !== name) {
                            new_query.push(param);
                        }
                    }
                    query = new_query.join('&');
                }

                query = query ? query = '?' + query : '';
                hash = hash ? hash = '#' + hash : '';

                return TrackingTokenStripper(path + query + hash);
            },
            toString() {
                return url;
            }
        }
    }
})();
