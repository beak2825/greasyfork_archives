// ==UserScript==
// @name         Wszystkie ceny dla Signala
// @namespace    http://meblujdom.pl/
// @version      0.5.4
// @description  Dodaje na stronie zamówień Signala wartość brutto oraz naszą cenę po rabacie jak i po rabacie z odbiorem osobistym.
// @author       Eryk Wróbel
// @match        https://zamowienie.signal.pl/Oferta/Type/ProductDetails/ProductID/*
// @match        https://zamowienie.signal.pl/Oferta/Type/CheckOut
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/32591/Wszystkie%20ceny%20dla%20Signala.user.js
// @updateURL https://update.greasyfork.org/scripts/32591/Wszystkie%20ceny%20dla%20Signala.meta.js
// ==/UserScript==

// changelog
// v 0.5.4 removed info about self collect with netto as well
// v 0.5.3 removed info about self collect
// v 0.5.2 added function to grab quantity of elements from parameter generated by online sheet
// v 0.5.1 fix for small bug with url match
// v 0.5 added small addition to copy into clipboard ordered elements
// v 0.4 added estimated brutto price
// v 0.3 added some additional prices
// v 0.2 - added live change when quantity was changed

(function () {
    'use strict';

    $('#PDB > div > div.panel-body > div.row > div.col-md-3 > div > div.form-inline.ZH-pd-addToCart input').val(1);

    var quantity = $('#PDB > div > div.panel-body > div.row > div.col-md-3 > div > div.form-inline.ZH-pd-addToCart input').val();

    var discount_for_selfcollect = 0.03; // discount percent value for collecting goods by Yourself from company
    var tax_value = 1.23;

    var price_netto = $('#PDB > div > div.panel-body > div.row > div.col-md-3 > div > div:nth-child(1) > span:nth-child(4)').text().replace(',', '.').slice(0, -2) * 1;
    var price_netto_without_discount = $('#PDB > div > div.panel-body > div.row > div.col-md-3 > div > div:nth-child(1) > span:nth-child(2)').text().replace(',', '.').slice(0, -2) * 1;
    var self_collect_netto = price_netto - (price_netto * discount_for_selfcollect) * quantity;

    var price_brutto = (price_netto * tax_value);
    var self_collect_brutto = price_brutto - (price_brutto * discount_for_selfcollect);
    var estimated_brutto = (price_netto_without_discount * tax_value) * 1.35;
    //console.log(self_collect_brutto);

    var to_append = $('#PDB > div > div.panel-body > div.row > div.col-md-3 > div > div:nth-child(1)');

    $('#PDB > div > div.panel-body > div.row > div.col-md-3 > div > div:nth-child(1) > span:nth-child(1)').append('<span id="original_netto_by_qnt"></span>');


    //to_append.append('<strong>Cena netto odbiór osobisty:</strong> <span id="netto_self_collect" style="color:#224879; font-size:16px; font-weight:bold">' + self_collect_netto.toFixed(2) + ' zł</span><br>');
    //to_append.append('<strong>Rabat netto odbiór osobisty:</strong> <span id="rabat_netto_self_collect">' + (price_netto * discount_for_selfcollect).toFixed(2) + ' zł</span><br>');
    to_append.append('<hr style="margin: 5px 0;">');
    to_append.append('<strong>Cena brutto:</strong> <span id="brutto" style="color:#224879; font-size:16px; font-weight:bold">' + price_brutto.toFixed(2) + ' zł</span><br>');
    //to_append.append('<strong>Cena brutto odbiór osobisty:</strong> <span id="brutto_self_collect" style="color:#224879; font-size:16px; font-weight:bold">' + self_collect_brutto.toFixed(2) + ' zł</span><br>');
    //to_append.append('<strong>Rabat brutto odbiór osobisty:</strong> <span id="rabat_brutto_self_collect">' + (price_brutto * discount_for_selfcollect).toFixed(2) + ' zł</span><br>');
    to_append.append('<strong>Szacunkowa brutto :</strong> <span id="estimated_brutto" style="color:red; font-size:16px; font-weight:bold">' + estimated_brutto.toFixed(2) + ' zł</span><br>');


    // WOW this is actually the lamest solution but it works, sorry for that future me or any other developer
    $('body').on('click', '#PDB > div > div.panel-body > div.row > div.col-md-3 > div > div.form-inline.ZH-pd-addToCart > a:nth-child(3), #PDB > div > div.panel-body > div.row > div.col-md-3 > div > div.form-inline.ZH-pd-addToCart > a:nth-child(1)', function () {
        var quantity = $('#PDB > div > div.panel-body > div.row > div.col-md-3 > div > div.form-inline.ZH-pd-addToCart input').val();
        var price_netto = $('#PDB > div > div.panel-body > div.row > div.col-md-3 > div > div:nth-child(1) > span:nth-child(4)').text().replace(',', '.').slice(0, -2) * quantity;
        var self_collect_netto = (price_netto - (price_netto * discount_for_selfcollect));

        if (quantity > 1) {
            $('#original_netto_by_qnt').html('x' + quantity + ' <span style="color:#224879">' + (price_netto).toFixed(2) + ' zł</span>');
        } else {
            $('#original_netto_by_qnt').html('');
        }

        var price_brutto = (price_netto * tax_value);
        var self_collect_brutto = (self_collect_netto * tax_value) * discount_for_selfcollect;

        $('#netto_self_collect').text(self_collect_netto.toFixed(2) + ' zł');
        $('#rabat_netto_self_collect').text((price_netto * discount_for_selfcollect).toFixed(2) + ' zł');
        $('#brutto').text((price_brutto).toFixed(2) + ' zł');
        $('#brutto_self_collect').text((self_collect_brutto).toFixed(2) + ' zł');
        $('#rabat_brutto_self_collect').text((price_brutto * discount_for_selfcollect).toFixed(2) + ' zł');
    });

    $('body').append('<style>.ZH-pd-fieldValue{margin-bottom:10px !important; }.ZH-pd-fieldName{margin-bottom: 0 !important;}</style>');

    var to_copy = '';

    $('#dnn_ctr702_Main_ctl00_ctl01_lbtnSubmit').on('click', function() {
        // check how many rows of elements we have
        var ordered_rows = $('#dnn_ctr702_Main_ctl00_ctl01_lstShoppingCart tr').length;
        $('#dnn_ctr702_Main_ctl00_ctl01_lstShoppingCart tr').each(function(key, val){
            //remove first and last row because they do not contains product info
            if (key > 0 && ((key+1) != ordered_rows)) {
                $(this).each(function(elem, value) {
                    to_copy = to_copy + $('td:nth-child(1)', this).text().trim() + '\t' + $('td:nth-child(2)', this).text().trim() + '\t' + $('td:nth-child(3)', this).text().trim() + '\n';
                });
            }
        });
        copyToClipboard(to_copy);
    });

    function copyToClipboard(text) {
        var $temp = $("<textarea>");
        $("body").append($temp);
        $temp.val(text).select();
        document.execCommand("copy");
        $temp.remove();
    }


    // Grab some quantity
    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = window.location.search.substring(1),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
            }
        }
    };

    var product_quantity = getUrlParameter('quantity');

    if (product_quantity > 1){
        $('.ZH-pd-addToCart input').val(product_quantity);
    }

})();