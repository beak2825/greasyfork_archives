// ==UserScript==
// @name         damai
// @namespace    ksgx
// @version      1.1
// @description  全自动抢票
// @author       zjt
// @match        https://buy.damai.cn/*
// @match        https://detail.damai.cn/*
// @match        https://seatsvc.damai.cn/*
// @match        https://m.damai.cn/*
// @match        https://mclient.alipay.com/*
// @match        <https://mtop.damai.cn/h5/mtop.alibaba.detail.subpage.getdetail/*>
// @grant        GM_xmlhttpRequest
// @connect      api.m.taobao.com
// @require      https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js
// @license      xu991115
// @downloadURL https://update.greasyfork.org/scripts/467315/damai.user.js
// @updateURL https://update.greasyfork.org/scripts/467315/damai.meta.js
// ==/UserScript==

// @license      ksgx
var version="1.1",$style=$("<style>#control_container{margin: 20px 0;background:#e9e9e9;padding:20px;overflow: hidden;}p{margin:10px 0;}#control_container button{width:80%;height: 60px;line-height:60px;margin:10px 10%;font-size:30px;border-radius:30px}#start_btn{color:#fff;background:#ff457a;}#bp_btn{color:#fff;background: #ff457a;}#end_btn{color:#666;background: #cfcfcf;}.control_container_box{display: flex;align-items: center;flex-wrap: wrap;padding-right: 20px;border: 1px solid #ccc;}.input_wrapper{display: flex;justify-content:center;font-size: 16px; margin-bottom:10px;}.input_wrapper_box{flex: 4;}.input_wrapper_phone{display: flex;justify-content: flex-end;font-size: 25px;padding:20px 0; text-align:center;}.input_wrapper_phone input{width: 50%;}.notice{margin:10px 10px;padding:10px 10px;color:darkslategrey;}#wx{text-align: center; flex:1;color: #333;}#countdown_wrapper {display:none; font-size: 30px; text-align:center; background:#ffeaf1;}#countdown_wrapper p{width:100%;}#countdown {font-size: 50px; color:#ff1268;}.warning {color:red; font-weight:400;}h3 {font-weight:800;}</style>");function fetchGet(){var e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(){var t=arguments[1];"GET"===arguments[0].toUpperCase()&&-1!=t.indexOf("mtop.damai.cn/h5/mtop.alibaba.detail.subpage.getdetail")&&(this._url=t),e.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){this.addEventListener("readystatechange",function(){if(4===this.readyState&&200===this.status&&this._url&&-1!=this._url.indexOf("mtop.damai.cn/h5/mtop.alibaba.detail.subpage.getdetail")){var e=JSON.parse(this.responseText),t=JSON.parse(e.data.result),n=t.perform.skuList;const r=[],o=[],a=[];for(var i=0;i<n.length;i++)r.push(n[i].skuId),o.push(n[i].itemId),a.push(n[i].priceName);sessionStorage.setItem("skuIds",r),sessionStorage.setItem("itemIds",o);let p="";for(let e=0;e<a.length;e++)p+=e+" : "+a[e]+"\n";alert("请按票价前对应的序号输入: \n当前选择场次："+t.perform.performName+"\n"+p)}}),t.apply(this,arguments)}}function seat_click_buy_btn(){$("#app > div.render-result-container > div.select-result > div.tip-order-button > button").click()}function timedUpdate(){var e=Math.ceil((window.sellStartTime_timestamp-window.current_time)/1e3);null==window.current_time||e<10?syncTime(200):syncTime(2500)}function syncTime(e){GM_xmlhttpRequest({url:"https://api.m.taobao.com/rest/api3.do?api=mtop.common.getTimestamp",method:"GET",timeout:1e4,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(t){if(200==t.status){var n=JSON.parse(t.responseText.replace("fff(","").replace(")",""));window.current_time=n.data.t;var i=Math.ceil((window.sellStartTime_timestamp-window.current_time)/1e3);if(console.log("相差秒数："+i),i<2)window.location.href=window.order_url;else{var r=i.toHHMMSS();$("#countdown").text(r),window.timer=setTimeout(timedUpdate,e)}}else setTimeout(()=>{syncTime(500)},1e3)}})}function timedUpdate_phone(){var e=Math.ceil((window.sellStartTime_timestamp-window.current_time)/1e3);null==window.current_time||e<10?syncTime_phone(200):syncTime_phone(2500)}function syncTime_phone(e){GM_xmlhttpRequest({url:"https://api.m.taobao.com/rest/api3.do?api=mtop.common.getTimestamp",method:"GET",timeout:1e4,headers:{"Content-Type":"application/x-www-form-urlencoded"},onload:function(t){if(200==t.status){var n=JSON.parse(t.responseText.replace("fff(","").replace(")",""));window.current_time=n.data.t;var i=Math.ceil((window.sellStartTime_timestamp-window.current_time)/1e3);if(console.log("相差秒数："+i),i<2)window.location.href=window.phone_order_url;else{var r=i.toHHMMSS();$("#countdown").text(r),window.timer=setTimeout(timedUpdate_phone,e)}}else setTimeout(()=>{syncTime_phone(500)},1e3)}})}function generate_confirm_url(e,t,n,i){for(var r=i.performBases,o="",a=0;a<r.length;a++)for(var p=r[a].performs,d=0;d<p.length;d++){var s=p[d];if(s.performName===e){o=s.itemId,window.itemId=o;for(var l=s.skuList,u=0;u<l.length;u++){var c=l[u];if(c.skuName===t)return`https://buy.damai.cn/orderConfirm?exParams=%7B%22damai%22%3A%221%22%2C%22channel%22%3A%22damai_app%22%2C%22umpChannel%22%3A%2210002%22%2C%22atomSplit%22%3A%221%22%2C%22serviceVersion%22%3A%221.8.5%22%7D&buyParam=${o}_${n}_${c.skuId}&buyNow=true&spm=a2oeg.project.projectinfo.dbuy`}}}return null}function generate_seat_url(e,t,n,i,r){var o=[];if(e)for(var a=t.slice(0,7),p=r.calendarPerforms,d=0;d<p.length;d++){var s=p[d];s.month==a&&(o=s.performBases)}else o=r.performBases;var l="";for(d=0;d<o.length;d++)for(var u=o[d].performs,c=0;c<u.length;c++){var m=u[c],_=m.performId,f=new URLSearchParams(window.location.href).get("id");if(m.performName===t){l=m.itemId,window.itemId=l;for(var w=m.skuList,h=0;h<w.length;h++){var v=w[h];if(v.skuName===n)return`https://seatsvc.damai.cn/tms/selectSeat?itemId=${l}&performId=${_}&skuId=${v.skuId}&projectId=${f}`}}}return null}function detail_ui(){var e=$(".content-right .service"),t=$("<div id='control_container'></div>"),n=$(`<div id="wx" class="notice"><p>大麦抢票 版本号：${version}</p><p>author: 快速/高效</p></div>`),i=$('<div class="input_wrapper" id="number_input_wrapper">请输入人数：<input id="number_input" type="number" value="1" min="1" max="6"></div>'),r=$('<button id="start_btn">开始抢票</button>'),o=$('<button id="end_btn">停止抢票</button>'),a=$('<div id="notice" class="notice"><h3>使用步骤</h3><p>1.登录，填写购票人信息</p><p>2.选择场次->价格->填写人数</p><p>3.点击‘开始抢票’</p></div>'),p=$('<div id="notice2" class="notice"><p>已同步网络时间</p><p>若误差过大请刷新页面，更新时间</p></div>'),d=$('<div id="countdown_wrapper"><p id="selected_event">event1</p><p id="selected_price">price2</p><p id="selected_number">1人</p><br><p>倒计时:</p><p id="countdown">00:00:00</p></div>');t.append($style),t.append(n),t.append(i),t.append(r),t.append(o),t.append(a),t.append(p),t.insertBefore(e),d.insertBefore(t),$("#start_btn").click(function(){var e=get_event(),t=get_price(),n=$("#number_input").val(),i=JSON.parse($("#dataDefault").text());window.sellStartTime_timestamp=i.sellStartTime,$("#selected_event").text(e),$("#selected_price").text(t),$("#selected_number").text(n+"人"),$("#countdown_wrapper").show();var r=generate_confirm_url(e,t,n,i);r?(window.order_url=r,sessionStorage.setItem("order_url",r),timedUpdate()):alert("获取场次票价人数失败，请刷新再试")}),$("#end_btn").click(function(){clearTimeout(window.timer),$("#countdown_wrapper").hide(),sessionStorage.clear()})}function phone_detail_ui(){var e=$("#detail");if(null!=e&&0!=e.length||(e=$(".auto-banner")),null!=e&&0!=e.length){var t=$("<div id='control_container'></div>"),n=$(`<div id="wx" class="notice"><p>大麦抢票</p><p>版本号：${version}</p><p>author：快速/高效</p></div>`),i=$('<div class="input_wrapper_phone" id="event_input_wrapper">请输入票价前的序号：<input id="event_input" type="text" value="2" ></div>'),r=$('<div class="input_wrapper_phone" id="number_input_wrapper">请输入人数：<input id="number_input" type="number" value="2" min="1" max="4"></div>'),o=$('<div class="input_wrapper_phone" id="delayTime_input_wrapper">无优先购需延后(分)：<input id="delayTime_input" type="text" value="0"></div>'),a=$('<div class="input_wrapper_phone" id="isPackage_input_wrapper">是否为双人套票：<input id="isPackage_input" type="text" value="0"></div>'),p=$('<button id="start_btn">开始抢票</button>'),d=$('<button id="end_btn">停止抢票</button>'),s=$('<button id="bp_btn">获取bp链接</button>'),l=$('<div id="notice" class="notice"><h3>使用步骤</h3><p>1.提前登录-填写购票人,收货地址</p>\n    <p>2.请先点击右下角[即将开抢 预选场次]或[立即预定] 按钮，多个日期可点击自己想看的日期，记住弹窗中自己想看的票价前的序号，之后关闭弹窗输入票价前的序号</p>\n    <p>3.如果演出支持优先购，但你没有优先购特权，第三个输入框延后倒计时须填写优先购开抢到正点开抢的时间间隔，单位为分</p>\n    <p>>>>> 比如：优先购开始时间为13:15<br />>>>> 正点开抢时间为13:30<br />>>>> 第三项就填“15”</p>\n    <p>4.如果为双人套票，第四项填1（是），默认为0（否）</p>\n    <p>5.点击“开始抢票”</p></div>'),u=$('<div id="notice2" class="notice"><p>注：倒计时开抢前差几秒无影响，开抢前10秒才会快速同步；默认自动勾选2个观演人（页面可修改）；自动提交</p></div>'),c=$('<div id="countdown_wrapper"><p id="selected_event">场次</p><p id="selected_price">自动勾选人数</p><p id="selected_number">2人</p><br><p>倒计时:</p><p id="countdown">00:00:00</p></div>'),m=$('<div class="input_wrapper_box"></div>'),_=$('<div class="control_container_box"></div>');t.append($style),_.append(n),m.append(i),m.append(r),m.append(o),m.append(a),_.append(m),_.append(p),_.append(s),_.append(d),t.append(_),t.append(l),t.append(u),t.insertBefore(e),c.insertBefore(t),$("#start_btn").click(function(){var e=$("#event_input").val();if(""!=e&&null!=e){var t=sessionStorage.getItem("skuIds"),n=sessionStorage.getItem("itemIds");if(null!=t&&null!=n&&0!=t.length&&0!=n.length)if(t=t.split(","),n=n.split(","),t.length<=Number(e))alert("序号错误，无该序号对应场次");else{var i=t[e],r=n[e],o=$("#number_input").val(),a=phone_confirm_url(r,i,o);window.phone_order_url=a,window.phone_people_num=o,sessionStorage.setItem("phone_order_url",a),sessionStorage.setItem("phone_people_num",o),sessionStorage.setItem("reload_cnt",0);var p=$(".count-down-date"),d="";if(null==p||0==p.length)d=(new Date).getTime();else{var s=(p=null==p.innerText?p[0].innerText:p.innerText).replace("月","-").replace("日","").replace("开抢","")+":00";s=(new Date).getFullYear()+"-"+s,-1!=navigator.userAgent.indexOf("Safari")&&(s=s.replace(/-/g,"/")),d=new Date(s).getTime()+6e4*Number($("#delayTime_input").val())}window.sellStartTime_timestamp=d,$("#selected_event").text(timestampToTime(d)),$("#selected_number").text(o+"人"),$("#countdown_wrapper").show(),timedUpdate_phone()}else alert("请先点击右下角[即将开抢 预选场次]或[立即购买] 按钮获取票档，再按提示输入票价前的序号")}else alert("请先输入票价对应的序号")}),$("#bp_btn").click(function(){var e=$("#event_input").val();if(""!=e&&null!=e){var t=sessionStorage.getItem("skuIds"),n=sessionStorage.getItem("itemIds");if(null!=t&&null!=n&&0!=t.length&&0!=n.length)if(t=t.split(","),n=n.split(","),t.length<=Number(e))alert("序号错误，无该序号对应场次");else{var i=t[e],r=phone_confirm_url(n[e],i,$("#number_input").val());console.log("result",r),copyToClipboard(r)}else alert("请先点击右下角[即将开抢 预选场次]或[立即购买] 按钮获取票档，再按提示输入票价前的序号")}else alert("请先输入票价对应的序号")}),$("#end_btn").click(function(){clearTimeout(window.timer),$("#countdown_wrapper").hide(),sessionStorage.clear()})}else setTimeout(phone_detail_ui,200)}function copyToClipboard(e,t="bp链接已复制到剪切板"){const n=document.createElement("input");n.setAttribute("value",e),n.setAttribute("readonly","readonly"),document.body.appendChild(n),n.select(),n.setSelectionRange(0,n.value.length),document.execCommand("Copy"),document.body.removeChild(n),"string"==typeof t&&t.trim().length&&alert(t)}function timestampToTime(e){var t=new Date(e);return t.getFullYear()+"-"+((t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1)+"-")+((t.getDate()<10?"0"+t.getDate():t.getDate())+" ")+(t.getHours()+":")+(t.getMinutes()+":")+t.getSeconds()}function phone_confirm_url(e,t,n){return`https://m.damai.cn/app/dmfe/h5-ultron-buy/index.html?buyParam=${e}_${n=1==$("#isPackage_input").val()?1:n}_${t}&buyNow=true&exParams=%257B%2522channel%2522%253A%2522damai_app%2522%252C%2522damai%2522%253A%25221%2522%252C%2522umpChannel%2522%253A%2522100031004%2522%252C%2522subChannel%2522%253A%2522damai%2540damaih5_h5%2522%252C%2522atomSplit%2522%253A1%257D&spm=a2o71.project.0.bottom&sqm=dianying.h5.unknown.value`}function get_text_exclude_children(e){return $(e).contents().not($(e).children()).text().trim()}function get_event(){return get_text_exclude_children(".perform__order__select.perform__order__select__performs .select_right_list .active>*")}function get_price(){return get_text_exclude_children(".select_right_list_item.sku_item.active .skuname")}function detail_seat_ui(){var e=$(".content-right .service"),t=$("<div id='control_container'></div>"),n=$(`<div id="wx" class="notice"><p>大麦抢票 版本号：${version}</p><p>author: 快速/高效</p></div>`),i=$('<div class="input_wrapper" id="number_input_wrapper">请输入人数：<input id="number_input" type="number" value="1" min="1" max="6"></div>'),r=$('<button id="start_btn">开始抢票</button>'),o=$('<button id="end_btn">停止抢票</button>'),a=$('<div id="notice" class="notice"><h3>使用步骤</h3><p>1.提前登录-填写购票人,收货地址</p>\n    <p>2.请先点击右下角[即将开抢 预选场次]或[立即预定] 按钮，多个日期可点击自己想看的日期，记住弹窗中自己想看的票价前的序号，之后关闭弹窗输入票价前的序号</p>\n    <p>3.如果演出支持优先购，但你没有优先购特权，第三个输入框延后倒计时须填写优先购开抢到正点开抢的时间间隔，单位为分</p>\n    <p>>>>> 比如：优先购开始时间为13:15<br />>>>> 正点开抢时间为13:30<br />>>>> 第三项就填“15”</p>\n    <p>4.点击“开始抢票”</p></div>'),p=$('<div id="notice" class="notice warning"><h3>注意</h3><p>若人数为1，选座页面手动选座后自动进入下一步</p><p>人数多于1时，选座页面手动选座后点击“确认选座”按钮或按下空格键进入下一步</p></div>'),d=$('<div id="notice2" class="notice"><p>已同步网络时间</p><p>若误差过大请刷新页面，更新时间</p></div>'),s=$('<div id="countdown_wrapper"><p id="selected_event">event1</p><p id="selected_price">price2</p><p id="selected_number">1人</p><br><p>倒计时:</p><p id="countdown">00:00:00</p></div>'),l=$('<div class="input_wrapper" id="delayTime_input_wrapper">无优先购需延后倒计时(分):<input id="delayTime_input" type="text" value="0"></div>');t.append($style),t.append(n),t.append(i),t.append(l),t.append(r),t.append(o),t.append(a),t.append(p),t.append(d),t.insertBefore(e),s.insertBefore(t),$("#start_btn").click(function(){var e=get_event(),t=get_price(),n=$("#number_input").val(),i=JSON.parse($("#dataDefault").text());if(window.sellStartTime_timestamp=i.sellStartTime+6e4*Number($("#delayTime_input").val()),$("#selected_event").text(e),$("#selected_price").text(t),$("#selected_number").text(n+"人"),$("#countdown_wrapper").show(),$("#dataDefault").text().includes("calendarPerforms"))var r=generate_seat_url(!0,e,t,n,i);else r=generate_seat_url(!1,e,t,n,i);r?(window.order_url=`${r}&people_num=${n}`,sessionStorage.setItem("seat_url",r),timedUpdate()):alert("获取场次票价人数出错了。")}),$("#end_btn").click(function(){clearTimeout(window.timer),$("#countdown_wrapper").hide(),sessionStorage.clear()})}function check_alert(){$(".next-dialog-alert").length>0||window.current_time>=window.max_time?window.location.reload():(window.current_time=window.current_time+300,setTimeout(check_alert,300))}function fill_form(){var e=parseInt($(".ticket-buyer-title em").text());window.buyer_number=e,window.curr_buyer=0,console.log("勾选下单人数："+e);for(var t=$(".buyer-list-item input"),n=0;n<e;n++)t[n].click();setTimeout(submit_order,200)}function fill_phone_form(){var e=sessionStorage.getItem("phone_people_num");null==e&&(e=2),console.log("勾选下单人数："+e);var t=$(".viewer >div >div");if(null==t||0==t.length)return check_phone_alert(),void setTimeout(fill_phone_form,100);for(var n=0;n<e;n++)t[n].click();setTimeout(submit_phone_order,200)}function submit_phone_order(){if(console.log("提交订单中..."),$("div[view-name='MColorFrameLayout']").attr("id","myOrderSubmit"),null!=$("#myOrderSubmit")[0]){var e=$("#myOrderSubmit")[0].nextSibling,t=new Event("dx_tap");e.dispatchEvent(t),setTimeout(check_phone_alert,200)}else setTimeout(submit_phone_order,200)}function check_phone_alert(){var e=$(".baxia-dialog-content");if(null!=e&&e.length>0){var t=sessionStorage.getItem("reload_cnt");null==t&&(t=0),sessionStorage.setItem("reload_cnt",Number(t)+1);var n=sessionStorage.getItem("phone_order_url");window.location.href=n}var i=$("#app >div >div");null!=i&&((i.innerHTML=null)?-1!=i.innerHTML.indexOf("系统繁忙")?window.location.reload():(window.current_time=window.current_time+200,setTimeout(submit_phone_order,200)):0!=i.length&&setTimeout(submit_phone_order,200)),setTimeout(()=>{clearTimeout(window.timer),sessionStorage.clear()},3e4)}function submit_order(){$(".submit-wrapper button").click(),setTimeout(check_alert,200)}$(document).ready(function(){var e=window.location.href;e.includes("https://detail.damai.cn/")&&((t=sessionStorage.getItem("order_url"))?window.location.href=t:"选座购买"==$("div.buybtn").text()||$(".service-note .service-note-name").text().includes("可选座")?(alert("无法全自动选座，请看“注意”部分。不要忘了先登录，填好联系人信息，删除多余联系人。"),detail_seat_ui()):detail_ui());if(e.includes("https://buy.damai.cn/"))if(e.includes("https://buy.damai.cn/multi/flow")){var t=e.substring(e.indexOf("=")+1);sessionStorage.setItem("order_url",t),window.location.href=t}else{if($(".error-msg").length>0)if($(".error-msg").text().includes("已过期"))document.getElementsByClassName("next-row error-reload")[0].children[0].click();else(t=sessionStorage.getItem("order_url"))?window.location.href=t:window.location.reload();else setTimeout(fill_form,200)}e.includes("https://seatsvc.damai.cn/")&&(1==new URLSearchParams(window.location.href).get("people_num")?new MutationObserver(function(e){document.querySelector("#app > div.render-result-container > div.select-result")&&$("#app > div.render-result-container > div.select-result").bind("DOMNodeInserted",seat_click_buy_btn)}).observe(document,{childList:!0,subtree:!0}):document.onkeydown=function(){32==window.event.keyCode&&seat_click_buy_btn()});if(e.includes("https://m.damai.cn/damai/")){var n=sessionStorage.getItem("phone_order_url");if(n){var i=sessionStorage.getItem("reload_cnt");if(Number(i)>24)return alert("抢购已自动结束，请返回查看有无订单"),void sessionStorage.clear();window.location.href=n}else fetchGet(),phone_detail_ui()}if(e.includes("https://m.damai.cn/app/dmfe/")){if(null==(i=sessionStorage.getItem("reload_cnt"))||Number(i)>24)return alert("抢购已自动结束，请返回查看有无订单"),void sessionStorage.clear();setTimeout(fill_phone_form,100);var r=$(".viewer >div >div");if(null!=r&&0!=r.length&&-1!=$("#app >div >div").innerHTML.indexOf("系统繁忙")){var o=sessionStorage.getItem("phone_order_url");window.location.href=o}}(e.includes("https://excashier.alipay.com/")||e.includes("https://mclient.alipay.com"))&&(alert("恭喜下单成功，可前往APP查看，有5分钟付款时间"),sessionStorage.clear())}),Number.prototype.toHHMMSS=function(){return(Math.floor(this/3600)<10?("00"+Math.floor(this/3600)).slice(-2):Math.floor(this/3600))+":"+("00"+Math.floor(this%3600/60)).slice(-2)+":"+("00"+this%3600%60).slice(-2)};