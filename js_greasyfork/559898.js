// ==UserScript==
// @name         Manus APIKey è‡ªåŠ¨ç®¡ç†
// @namespace    http://tampermonkey.net/
// @version      22.7
// @description  v22.7:  æ­é… Manus-webç³»ç»Ÿä½¿ç”¨ï¼Œè‡ªåŠ¨åˆ›å»ºAPI_KEYä»¥åŠè‡ªåŠ¨å¤‡ä»½ä»»åŠ¡IDå’ŒçŸ¥è¯†åº“çš„è‡ªåŠ¨å­˜å‚¨æ¢å¤
// @author       Aå˜‰æŠ€æœ¯ (Refactored)
// @match        https://manus.im/*
// @match        https://*.manus.im/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_deleteValue
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @connect      api.manus.im
// @run-at       document-start
// @license      MIT
// @downloadURL https://update.greasyfork.org/scripts/559898/Manus%20APIKey%20%E8%87%AA%E5%8A%A8%E7%AE%A1%E7%90%86.user.js
// @updateURL https://update.greasyfork.org/scripts/559898/Manus%20APIKey%20%E8%87%AA%E5%8A%A8%E7%AE%A1%E7%90%86.meta.js
// ==/UserScript==

(function(){'use strict';const CONFIG={maxKeys:4,apiKeyNamePrefix:'manus_key_',taskIdMinLength:20};const API_BASE='https://api.manus.im';const URLS={USER_INFO:'/user.v1.UserService/UserInfo',GET_SESSION:'/session.v1.SessionService/GetSession',GET_API:'/openapi.v1.OpenapiService/GetAPI',DELETE_KEY:'/openapi.v1.OpenapiService/DeleteAPIKey',CREATE_KEY:'/openapi.v1.OpenapiService/CreateAPIKey',LIST_KNOWLEDGE:'/knowledge.v1.KnowledgeService/ListKnowledge',CREATE_KNOWLEDGE:'/knowledge.v1.KnowledgeService/CreateKnowledge'};const STORAGE={TOKEN_KEY_MAP:'manus_v22_token_key_map',TASK_MAP:'manus_v22_task_data',KB_BACKUP:'manus_v22_knowledge_backup'};let __currentToken=null;let __currentApiKey=null;let __isProcessing=false;let __pendingTasks=[];let __tokenCaptured=false;let __kbLoading=false;let __lastUrl='';function log(...args){console.log('%c[Manus v22.4]','color: #10b981;font-weight: bold;',...args)}const originalFetch=window.fetch;window.fetch=async function(...args){const[resource,config]=args;let url='';if(typeof resource==='string')url=resource;else if(resource&&resource.url)url=resource.url;if(url.includes(URLS.USER_INFO)&&config&&config.headers){let auth=null;if(config.headers instanceof Headers){auth=config.headers.get('authorization')||config.headers.get('Authorization')}else if(typeof config.headers==='object'){auth=config.headers['authorization']||config.headers['Authorization']}if(auth){log('ğŸ“¡ [Fetch] æ•è· UserInfo');onTokenCaptured(auth)}}if(url.includes(URLS.GET_SESSION)&&config&&config.body){try{const body=typeof config.body==='string'?JSON.parse(config.body):config.body;if(body&&body.sessionUid){log('ğŸ“¡ [Fetch] æ•è· GetSession:',body.sessionUid);onTaskCaptured(body.sessionUid,'Fetch')}}catch(e){}}return originalFetch.apply(this,args)};(function(){const _open=XMLHttpRequest.prototype.open;const _send=XMLHttpRequest.prototype.send;const _setHeader=XMLHttpRequest.prototype.setRequestHeader;XMLHttpRequest.prototype.setRequestHeader=function(h,v){this._reqHeaders=this._reqHeaders||{};this._reqHeaders[h.toLowerCase()]=v;return _setHeader.apply(this,arguments)};XMLHttpRequest.prototype.open=function(m,url){this._reqUrl=url;return _open.apply(this,arguments)};XMLHttpRequest.prototype.send=function(body){const url=this._reqUrl||'';if(url.includes(URLS.USER_INFO)){const headers=this._reqHeaders;setTimeout(()=>{if(headers&&headers['authorization']){log('ğŸ“¡ [XHR] æ•è· UserInfo');onTokenCaptured(headers['authorization'])}},0)}if(url.includes(URLS.GET_SESSION)&&body){try{const data=typeof body==='string'?JSON.parse(body):body;if(data&&data.sessionUid){log('ğŸ“¡ [XHR] æ•è· GetSession:',data.sessionUid);onTaskCaptured(data.sessionUid,'XHR')}}catch(e){}}return _send.apply(this,arguments)}})();function getTaskIdFromUrl(url){const match=url.match(/\/app\/([a-zA-Z0-9_-]+)/);if(match&&match[1]){const id=match[1];if(id.length>=CONFIG.taskIdMinLength){return id}}return null}function checkCurrentUrl(){const currentUrl=location.href;if(currentUrl===__lastUrl)return;__lastUrl=currentUrl;const taskId=getTaskIdFromUrl(currentUrl);if(taskId){log('ğŸ”— [URL] æ£€æµ‹åˆ°ä»»åŠ¡:',taskId);onTaskCaptured(taskId,'URL')}updatePanel()}function setupUrlWatcher(){checkCurrentUrl();window.addEventListener('popstate',()=>{setTimeout(checkCurrentUrl,100)});window.addEventListener('hashchange',()=>{setTimeout(checkCurrentUrl,100)});const originalPushState=history.pushState;const originalReplaceState=history.replaceState;history.pushState=function(...args){const result=originalPushState.apply(this,args);setTimeout(checkCurrentUrl,100);return result};history.replaceState=function(...args){const result=originalReplaceState.apply(this,args);setTimeout(checkCurrentUrl,100);return result};setInterval(checkCurrentUrl,2000)}function getTokenFromCookie(){try{const cookies=document.cookie.split(';');for(const c of cookies){const[name,...rest]=c.trim().split('=');if(name==='session_id'){const val=decodeURIComponent(rest.join('='));if(val&&val.startsWith('eyJ')){log('ğŸª ä» Cookie è¯»å– Token');return val}}}}catch(e){}return null}async function onTokenCaptured(token){if(!token||__tokenCaptured)return;let normalizedToken=token.trim();if(!normalizedToken.startsWith('Bearer ')){normalizedToken='Bearer '+normalizedToken}if(__currentToken===normalizedToken)return;__currentToken=normalizedToken;__tokenCaptured=true;log('ğŸ¯ Token å·²æ•è·');updatePanel();const tokenMap=GM_getValue(STORAGE.TOKEN_KEY_MAP,{});if(tokenMap[normalizedToken]){__currentApiKey=tokenMap[normalizedToken];log('âœ… ç¼“å­˜å‘½ä¸­ ApiKey');updatePanel();processPendingTasks();return}if(!__isProcessing){__isProcessing=true;await createApiKey(normalizedToken);__isProcessing=false;processPendingTasks()}}async function createApiKey(token){log('ğŸ”„ å¼€å§‹åˆ›å»º ApiKey...');showToast('æ­£åœ¨åˆå§‹åŒ– API Key...','info');try{const listRes=await apiRequest(URLS.GET_API,token,{});const apiKeys=listRes.apiKeys||[];log('ğŸ“Š å½“å‰ ApiKey æ•°é‡:',apiKeys.length);if(apiKeys.length>=CONFIG.maxKeys){apiKeys.sort((a,b)=>new Date(a.createdAt)-new Date(b.createdAt));const oldest=apiKeys[0];log('ğŸ—‘ï¸ åˆ é™¤æœ€æ—§ Key:',oldest.name);await apiRequest(URLS.DELETE_KEY,token,{apiKeyId:oldest.apiKeyId})}const keyName=generateKeyName();log('ğŸ“¤ åˆ›å»ºæ–° Key:',keyName);const createRes=await apiRequest(URLS.CREATE_KEY,token,{name:keyName});if(createRes.apiKeyData&&createRes.apiKeyData.apiKey){const newApiKey=createRes.apiKeyData.apiKey;log('âœ… ApiKey åˆ›å»ºæˆåŠŸ');const tokenMap=GM_getValue(STORAGE.TOKEN_KEY_MAP,{});tokenMap[token]=newApiKey;GM_setValue(STORAGE.TOKEN_KEY_MAP,tokenMap);__currentApiKey=newApiKey;showToast('API Key å‡†å¤‡å°±ç»ª','success');updatePanel()}else{throw new Error('è¿”å›æ•°æ®å¼‚å¸¸');}}catch(e){log('âŒ ApiKey åˆ›å»ºå¤±è´¥:',e);showToast('API Key åˆå§‹åŒ–å¤±è´¥','error')}}function onTaskCaptured(taskId,source='unknown'){if(!taskId)return;const taskMap=GM_getValue(STORAGE.TASK_MAP,{});if(taskMap[taskId]){log(`ğŸ“‹[${source}]ä»»åŠ¡å·²å­˜åœ¨:`,taskId);return}if(!__currentToken||!__currentApiKey){log(`â³[${source}]ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—:`,taskId);if(!__pendingTasks.includes(taskId)){__pendingTasks.push(taskId)}return}saveTask(taskId,source)}function processPendingTasks(){if(!__currentToken||!__currentApiKey||__pendingTasks.length===0)return;log('ğŸ“‹ å¤„ç†å¾…å¤„ç†ä»»åŠ¡:',__pendingTasks.length);const tasks=[...__pendingTasks];__pendingTasks=[];tasks.forEach(id=>saveTask(id,'Queue'))}function saveTask(taskId,source=''){if(!taskId||!__currentToken||!__currentApiKey)return;const taskMap=GM_getValue(STORAGE.TASK_MAP,{});if(taskMap[taskId])return;taskMap[taskId]={taskId:taskId,apiKey:__currentApiKey,token:__currentToken};GM_setValue(STORAGE.TASK_MAP,taskMap);log(`âœ…[${source}]ä»»åŠ¡å·²ç¼“å­˜:`,taskId);showToast('ä»»åŠ¡å·²è‡ªåŠ¨ç¼“å­˜','success');updatePanel()}function getKnowledgeBackup(){return GM_getValue(STORAGE.KB_BACKUP,[])}function setKnowledgeBackup(list){GM_setValue(STORAGE.KB_BACKUP,list)}async function fetchCloudKnowledge(){if(!__currentToken){return{success:false,error:'Token æœªå°±ç»ª'}}try{const res=await apiRequest(URLS.LIST_KNOWLEDGE,__currentToken,{limit:300});const list=res.knowledge||res||[];return{success:true,data:Array.isArray(list)?list:[]}}catch(e){return{success:false,error:e}}}async function onKbTabActive(){if(__kbLoading)return;const numCloud=document.getElementById('num-cloud');const kbList=document.getElementById('kb-list');if(!__currentToken){if(numCloud)numCloud.textContent='-';if(kbList)kbList.innerHTML='<div style="text-align:center;color:#999;padding:10px;">è¯·ç­‰å¾… Token å°±ç»ª</div>';return}__kbLoading=true;if(numCloud)numCloud.textContent='...';if(kbList)kbList.innerHTML='<div style="text-align:center;color:#999;padding:10px;">åŠ è½½ä¸­...</div>';const result=await fetchCloudKnowledge();if(result.success){const cloudList=result.data;if(numCloud)numCloud.textContent=cloudList.length;const localList=getKnowledgeBackup();const localNames=new Set(localList.map(k=>k.name));let added=0;for(const item of cloudList){if(!localNames.has(item.name)){localList.push({name:item.name,content:item.content||'',trigger:item.trigger||'',usageType:item.usageType||'KNOWLEDGE_USAGE_TYPE_USE_WHEN'});added++}}if(added>0){setKnowledgeBackup(localList)}const numLocal=document.getElementById('num-local');if(numLocal)numLocal.textContent=localList.length;renderKnowledgeList(localList)}else{if(numCloud)numCloud.textContent='å¤±è´¥';if(kbList)kbList.innerHTML='<div style="text-align:center;color:#ef4444;padding:10px;">è·å–å¤±è´¥</div>'}__kbLoading=false}async function syncKnowledge(){if(!__currentToken){showToast('è¯·ç­‰å¾… Token å°±ç»ª','error');return}showToast('æ­£åœ¨åŒæ­¥...','info');await onKbTabActive();showToast('åŒæ­¥å®Œæˆ','success')}async function restoreKnowledge(){if(!__currentToken){showToast('è¯·ç­‰å¾… Token å°±ç»ª','error');return}const localList=getKnowledgeBackup();if(localList.length===0){showToast('æœ¬åœ°æ— å¤‡ä»½','error');return}if(!confirm(`æ¢å¤${localList.length}æ¡çŸ¥è¯†åº“ï¼Ÿ\nå·²å­˜åœ¨çš„è‡ªåŠ¨è·³è¿‡`))return;const btn=document.getElementById('btn-restore');if(btn){btn.disabled=true;btn.textContent='æ¢å¤ä¸­...'}try{const cloudResult=await fetchCloudKnowledge();const cloudNames=new Set();if(cloudResult.success){cloudResult.data.forEach(k=>cloudNames.add(k.name))}let created=0,skipped=0;for(const item of localList){if(cloudNames.has(item.name)){skipped++;continue}try{await apiRequest(URLS.CREATE_KNOWLEDGE,__currentToken,{name:item.name,content:item.content||'',trigger:item.trigger||'',enabled:true,usageType:item.usageType||'KNOWLEDGE_USAGE_TYPE_USE_WHEN'});created++;cloudNames.add(item.name);if(btn)btn.textContent=`${created}/${localList.length}`;await sleep(300)}catch(e){log('âš ï¸ åˆ›å»ºå¤±è´¥:',item.name)}}showToast(`å®Œæˆï¼æ–°å»º${created}è·³è¿‡${skipped}`,'success');await onKbTabActive()}catch(e){showToast('æ¢å¤å¤±è´¥','error')}if(btn){btn.disabled=false;btn.textContent='ğŸš€ ä¸€é”®æ¢å¤'}}function renderKnowledgeList(list){const el=document.getElementById('kb-list');if(!el)return;if(!list||list.length===0){el.innerHTML='<div style="text-align:center;color:#999;padding:10px;">æš‚æ— æ•°æ®</div>';return}el.innerHTML=list.slice(0,30).map(item=>`<div class="kb-item"title="${(item.content || '').substring(0, 100)}">${item.name||'(æ— åç§°)'}</div>`).join('')+(list.length>30?`<div style="text-align:center;color:#999;padding:5px;font-size:11px;">å…±${list.length}æ¡</div>`:'')}function apiRequest(endpoint,token,data={}){return new Promise((resolve,reject)=>{GM_xmlhttpRequest({method:'POST',url:API_BASE+endpoint,headers:{'Content-Type':'application/json','Authorization':token,'Origin':'https://manus.im','Referer':'https://manus.im/'},data:JSON.stringify(data),onload:(res)=>{if(res.status===200){try{resolve(JSON.parse(res.responseText))}catch(e){reject('JSONè§£æå¤±è´¥')}}else{reject(`HTTP ${res.status}`)}},onerror:reject})})}function resetCache(){if(!confirm('ç¡®å®šé‡ç½®æ‰€æœ‰ç¼“å­˜ï¼Ÿ\n\nâ€¢ Token/ApiKey\nâ€¢ ä»»åŠ¡ç¼“å­˜\nâ€¢ çŸ¥è¯†åº“å¤‡ä»½'))return;GM_deleteValue(STORAGE.TOKEN_KEY_MAP);GM_deleteValue(STORAGE.TASK_MAP);GM_deleteValue(STORAGE.KB_BACKUP);__currentToken=null;__currentApiKey=null;__pendingTasks=[];__tokenCaptured=false;showToast('å·²æ¸…ç©ºï¼Œåˆ·æ–°ä¸­...','success');setTimeout(()=>location.reload(),1000)}function exportTasks(){const taskMap=GM_getValue(STORAGE.TASK_MAP,{});const list=Object.values(taskMap).map(t=>({taskId:t.taskId,apiKey:t.apiKey,token:t.token}));if(list.length===0){showToast('æ— ä»»åŠ¡æ•°æ®','error');return}downloadJSON(list,`manus_tasks_${formatDate()}.json`);showToast(`å¯¼å‡º${list.length}æ¡`,'success')}function exportKnowledge(){const list=getKnowledgeBackup();if(list.length===0){showToast('æ— çŸ¥è¯†åº“æ•°æ®','error');return}downloadJSON(list,`manus_kb_${formatDate()}.json`);showToast(`å¯¼å‡º${list.length}æ¡`,'success')}function downloadJSON(data,filename){const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)}function generateKeyName(){const d=new Date();const p=n=>n.toString().padStart(2,'0');return`${CONFIG.apiKeyNamePrefix}${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`}function formatDate(){const d=new Date();const p=n=>n.toString().padStart(2,'0');return`${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`}function sleep(ms){return new Promise(r=>setTimeout(r,ms))}function showToast(msg,type='info'){if(!document.body){setTimeout(()=>showToast(msg,type),100);return}const old=document.getElementById('manus-toast');if(old)old.remove();const colors={success:'#10b981',error:'#ef4444',info:'#3b82f6'};const div=document.createElement('div');div.id='manus-toast';div.style.cssText=`position:fixed;bottom:20px;right:20px;padding:12px 20px;background:${colors[type]};color:#fff;border-radius:8px;z-index:9999999;box-shadow:0 4px 12px rgba(0,0,0,.2);font-size:14px;font-family:sans-serif;`;div.textContent=msg;document.body.appendChild(div);setTimeout(()=>div.remove(),2500)}function createUI(){GM_addStyle(`#manus-btn{position:fixed;top:80px;right:20px;width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#10b981,#059669);box-shadow:0 4px 15px rgba(16,185,129,.4);cursor:pointer;z-index:999999;display:flex;align-items:center;justify-content:center;border:none;color:#fff;font-size:18px;font-weight:700;transition:transform.2s}#manus-btn:hover{transform:scale(1.1)}#manus-panel{position:fixed;top:80px;right:80px;width:320px;background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15);z-index:999998;display:none;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;overflow:hidden;font-size:13px}.mp-head{background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:12px 16px;font-weight:600;display:flex;justify-content:space-between;align-items:center}.mp-tabs{display:flex;border-bottom:1px solid#e5e7eb}.mp-tab{flex:1;padding:10px;text-align:center;cursor:pointer;color:#6b7280;border-bottom:2px solid transparent}.mp-tab.active{color:#10b981;border-bottom-color:#10b981;font-weight:600}.mp-tab:hover{background:#f9fafb}.mp-content{padding:16px;display:none}.mp-content.active{display:block}.mp-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:#4b5563}.mp-label{color:#6b7280;font-size:12px}.mp-val{font-weight:500}.mp-tag{background:#f3f4f6;padding:2px 8px;border-radius:4px;font-family:monospace;font-size:11px}.mp-tag.ok{background:#d1fae5;color:#059669}.mp-tag.wait{background:#fef3c7;color:#d97706}.mp-btn{width:100%;padding:10px;border:none;border-radius:8px;cursor:pointer;margin-top:8px;color:#fff;font-weight:500;font-size:13px}.mp-btn:hover{opacity:.9}.mp-btn:disabled{opacity:.5;cursor:not-allowed}.mp-btn.green{background:#10b981}.mp-btn.blue{background:#3b82f6}.mp-btn.red{background:#ef4444}.mp-btn.purple{background:#8b5cf6}.mp-hr{height:1px;background:#e5e7eb;margin:12px 0}#kb-list{max-height:120px;overflow-y:auto;background:#f9fafb;border-radius:6px;margin-top:8px}.kb-item{padding:5px 10px;border-bottom:1px solid#eee;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:11px;color:#374151}`);const btn=document.createElement('button');btn.id='manus-btn';btn.textContent='M';document.body.appendChild(btn);const panel=document.createElement('div');panel.id='manus-panel';panel.innerHTML=`<div class="mp-head"><span>ğŸ”§Manus v22.4</span><span id="mp-close"style="cursor:pointer;font-size:18px">Ã—</span></div><div class="mp-tabs"><div class="mp-tab active"data-tab="task">ğŸ“‹ä»»åŠ¡</div><div class="mp-tab"data-tab="kb">ğŸ“šçŸ¥è¯†åº“</div></div><div id="tab-task"class="mp-content active"><div class="mp-row"><span class="mp-label">Token</span><span id="ui-token"class="mp-tag wait">ç­‰å¾…ä¸­</span></div><div class="mp-row"><span class="mp-label">ApiKey</span><span id="ui-apikey"class="mp-tag wait">ç­‰å¾…ä¸­</span></div><div class="mp-row"><span class="mp-label">å½“å‰é¡µé¢</span><span id="ui-page"class="mp-tag">-</span></div><div class="mp-row"><span class="mp-label">å·²ç¼“å­˜</span><span id="ui-tasks"class="mp-val"style="color:#10b981">0ä¸ªä»»åŠ¡</span></div><div class="mp-hr"></div><button id="btn-export"class="mp-btn blue">ğŸ“¥å¯¼å‡ºä»»åŠ¡</button><button id="btn-reset"class="mp-btn red">ğŸ”„é‡ç½®ç¼“å­˜</button></div><div id="tab-kb"class="mp-content"><div class="mp-row"><span class="mp-label">æœ¬åœ°å¤‡ä»½</span><span id="num-local"class="mp-val">0</span></div><div class="mp-row"><span class="mp-label">äº‘ç«¯æ•°æ®</span><span id="num-cloud"class="mp-val">-</span></div><button id="btn-sync"class="mp-btn green">â˜ï¸åŒæ­¥</button><button id="btn-restore"class="mp-btn purple">ğŸš€ä¸€é”®æ¢å¤</button><button id="btn-export-kb"class="mp-btn blue">ğŸ“¥å¯¼å‡ºå¤‡ä»½</button><div id="kb-list"></div></div>`;document.body.appendChild(panel);btn.onclick=()=>{const show=panel.style.display==='none';panel.style.display=show?'block':'none';if(show)updatePanel()};document.getElementById('mp-close').onclick=()=>panel.style.display='none';panel.querySelectorAll('.mp-tab').forEach(tab=>{tab.onclick=()=>{panel.querySelectorAll('.mp-tab').forEach(t=>t.classList.remove('active'));panel.querySelectorAll('.mp-content').forEach(c=>c.classList.remove('active'));tab.classList.add('active');document.getElementById('tab-'+tab.dataset.tab).classList.add('active');if(tab.dataset.tab==='kb')onKbTabActive()}});document.getElementById('btn-export').onclick=exportTasks;document.getElementById('btn-reset').onclick=resetCache;document.getElementById('btn-sync').onclick=syncKnowledge;document.getElementById('btn-restore').onclick=restoreKnowledge;document.getElementById('btn-export-kb').onclick=exportKnowledge}function updatePanel(){const uiToken=document.getElementById('ui-token');if(uiToken){uiToken.textContent=__currentToken?'âœ… å·²æ•è·':'â³ ç­‰å¾…ä¸­';uiToken.className='mp-tag '+(__currentToken?'ok':'wait')}const uiKey=document.getElementById('ui-apikey');if(uiKey){if(__currentApiKey){uiKey.textContent=__currentApiKey.substring(0,16)+'...';uiKey.className='mp-tag ok'}else{uiKey.textContent='â³ ç­‰å¾…ä¸­';uiKey.className='mp-tag wait'}}const uiPage=document.getElementById('ui-page');if(uiPage){const taskId=getTaskIdFromUrl(location.href);if(taskId){uiPage.textContent=taskId.substring(0,14)+'...';uiPage.className='mp-tag ok';uiPage.title=taskId}else{uiPage.textContent='éä»»åŠ¡é¡µ';uiPage.className='mp-tag';uiPage.title=''}}const uiTasks=document.getElementById('ui-tasks');if(uiTasks){const count=Object.keys(GM_getValue(STORAGE.TASK_MAP,{})).length;uiTasks.textContent=count+' ä¸ªä»»åŠ¡'}const numLocal=document.getElementById('num-local');if(numLocal){numLocal.textContent=getKnowledgeBackup().length}}function init(){log('ğŸš€ å¯åŠ¨');const cookieToken=getTokenFromCookie();if(cookieToken)onTokenCaptured(cookieToken);createUI();updatePanel();setupUrlWatcher();setTimeout(()=>{if(!__currentToken){const token=getTokenFromCookie();if(token)onTokenCaptured(token)}checkCurrentUrl()},2000)}if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init)}else{init()}})();