// ==UserScript==
// @name         TMH to Snapp & Tap30 ride
// @namespace    https://takemehome.ir
// @version      0.1
// @license      Copyright (c) 2023 TakeMeHome.ir
// @author       TMH
// @description  Export the best price ride from TakeMeHome.ir to Snapp & Tap30 web apps.
// @match        *://app.snapp.taxi/*
// @match        *://app.tapsi.cab/*
// @match        *://takemehome.ir/*
// @grant        none
// @run-at       document-start
// @require      https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js
// @downloadURL https://update.greasyfork.org/scripts/459928/TMH%20to%20Snapp%20%20Tap30%20ride.user.js
// @updateURL https://update.greasyfork.org/scripts/459928/TMH%20to%20Snapp%20%20Tap30%20ride.meta.js
// ==/UserScript==

(() => {
    const isSnapp=window.location.origin.includes("snapp"),isTapsi=window.location.origin.includes("tapsi"),isTmh=window.location.origin.includes("takemehome"),urlParams=new URLSearchParams(window.location.search),origLng=urlParams.get("origLng"),origLat=urlParams.get("origLat"),destLng=urlParams.get("destLng"),destLat=urlParams.get("destLat");if((isSnapp||isTapsi)&&(null==origLng||null==origLat||null==destLng||null==destLat))throw new Error("Stopped TMH script.");var coordState=!0,defaultLatitude=origLat,defaultLongitude=origLng,defaultAccuracy=1e-6,defaultAltitude=0,defaultAltitudeAccuracy=1,defaultHeading=0,defaultSpeed=0,locations={"www.google.com":{latitude:50.7,longitude:55,accuracy:.1,altitude:100,altitudeAccuracy:1,heading:79.9,speed:10.5}},watchInterval=1e3;function locator(){Object.keys(locations).forEach((e=>{"number"==typeof(e=locations[e]).latitude?e.latitude>90?e.latitude=90:e.latitude<-90&&(e.latitude=-90):e.latitude=defaultLatitude,"number"==typeof e.longitude?e.longitude>180?e.longitude=180:e.longitude<-180&&(e.longitude=-180):e.longitude=defaultLongitude,"number"==typeof e.accuracy?e.accuracy<=0&&(e.accuracy=defaultAccuracy):null!==e.accuracy&&(e.accuracy=defaultAccuracy),"number"!=typeof e.altitude&&(e.altitude=defaultAltitude),"number"==typeof e.altitudeAccuracy?e.altitudeAccuracy<=0&&(e.altitudeAccuracy=defaultAltitudeAccuracy):null!==e.altitudeAccuracy&&(e.altitudeAccuracy=defaultAltitudeAccuracy),"number"==typeof e.heading?e.heading>=360?e.heading=359.999999:e.heading<0&&(e.heading=0):null!==e.heading&&(e.heading=defaultHeading),"number"==typeof e.speed?e.speed<0&&(e.speed=0):null!==e.speed&&(e.speed=defaultSpeed)})),navigator.geolocation=navigator.geolocation||{},navigator.geolocation.getCurrentPosition=function(e,t){setTimeout(((t,o)=>{coordState?(defaultLatitude=origLat,defaultLongitude=origLng):(defaultLatitude=destLat,defaultLongitude=destLng),(t=locations[location.hostname])||(t={latitude:defaultLatitude,longitude:defaultLongitude,accuracy:defaultAccuracy,altitude:defaultAltitude,altitudeAccuracy:defaultAltitudeAccuracy,heading:defaultHeading,speed:defaultSpeed}),o={coords:{},timestamp:(new Date).getTime()},Object.keys(t).forEach((e=>o.coords[e]=t[e])),e(o)}),0)},navigator.geolocation.watchPosition=function(e,t){return setInterval(((e,t)=>{navigator.geolocation.getCurrentPosition(e,t)}),watchInterval,e,t)},navigator.geolocation.clearWatch=function(e){clearInterval(e)}}function sleep(e=2e3){return new Promise((t=>setTimeout(t,e)))}function loading_start(){document.getElementById("root").style.opacity=.5,document.getElementById("dialog-div").style.display="block"}function loading_stop(){document.getElementById("root").style.opacity=1,document.getElementById("dialog-div").style.display="none"}isTmh||locator(),document.onreadystatechange=function(){if("complete"===document.readyState){isTmh&&(document.getElementById("hasExtension").innerText="است ✅");const e=document.createElement("div");e.setAttribute("style","position: fixed;top: 50%;left: 50%;width: 200px;margin-left: -100px;height: 50px;margin-top: -25px;border: 3px solid #000;border-radius: 12px;background-color: white;text-align: center;font-weight: bold;vertical-align: middle;line-height: 50px;"),e.setAttribute("id","dialog-div"),e.innerText="...در حال پردازش",e.style.display="none",document.getElementsByTagName("body")[0].appendChild(e),function e(){if(isSnapp)if(document.getElementById("my-location")){const n=document.getElementById("my-location"),a=document.createElement("span");function t(){if(document.querySelectorAll('[qa-id="confirm"]')[0]){function e(){if(document.getElementById("my-location")){function t(){document.querySelectorAll('[qa-id="confirm"]')[0]?(document.querySelectorAll('[qa-id="confirm"]')[0].click(),console.log("confirm dest"),loading_stop()):setTimeout(t,2e3)}document.getElementById("my-location").click(),console.log("my-location"),sleep(4e3).then((()=>{t()}))}else setTimeout(e,2e3)}loading_start(),document.querySelectorAll('[qa-id="confirm"]')[0].click(),console.log("confirm"),sleep().then((()=>{e()}))}else setTimeout(t,2e3)}a.setAttribute("id","loc-text"),a.innerText=coordState?"برو مقصد":"برو مبدأ",a.style.marginRight="10px",a.style.fontSize="16px",n.appendChild(a),n.style.width="150px",n.onclick=function(){coordState=!coordState,b=document.getElementById("loc-text"),b.innerText=coordState?"برو مقصد":"برو مبدأ"},sleep().then((()=>{t()}))}else setTimeout(e,100);else if(isTapsi)if(coordState=!coordState,document.getElementsByClassName("search-input")[0]){function o(){if(document.getElementsByClassName("map-tag__img")[0]){function e(){if(document.getElementsByClassName("blueDot-beat-container")[0]){function t(){if(document.getElementsByClassName("BottomButton-container")[0]){function e(){if(document.getElementsByClassName("fab-container")[0]){function t(){document.getElementsByClassName("BottomButton-container")[0]?(document.getElementsByClassName("BottomButton-container")[0].click(),console.log("BottomButton-container"),loading_stop()):setTimeout(t,2e3)}document.getElementsByClassName("fab-container")[0].click(),console.log("fab-container"),sleep().then((()=>{t()}))}else setTimeout(e,2e3)}document.getElementsByClassName("BottomButton-container")[0].click(),console.log("BottomButton-container"),sleep().then((()=>{e()}))}else setTimeout(t,2e3)}document.getElementsByClassName("blueDot-beat-container")[0].click(),console.log("blueDot-beat-container"),sleep(4e3).then((()=>{t()}))}else setTimeout(e,2e3)}document.getElementsByClassName("map-tag__img")[0].click(),console.log("map-tag__img"),sleep().then((()=>{e()}))}else setTimeout(o,2e3)}loading_start(),document.getElementsByClassName("search-input")[0].click(),console.log("search-input"),sleep().then((()=>{o()}))}else setTimeout(e,2e3)}()}};
})();
