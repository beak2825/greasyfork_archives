// ==UserScript==
// @name         工单备注3
// @version      3.1.8
// @author       lzh
// @run-at       document-start
// @description  zh-cn
// @match        http://*/*/*/*/?app_act=order/order_list/do_detail&order_id=*
// @grant        GM_addStyle
// @require      https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js
// @namespace https://greasyfork.org/users/1085927
// @downloadURL https://update.greasyfork.org/scripts/483812/%E5%B7%A5%E5%8D%95%E5%A4%87%E6%B3%A83.user.js
// @updateURL https://update.greasyfork.org/scripts/483812/%E5%B7%A5%E5%8D%95%E5%A4%87%E6%B3%A83.meta.js
// ==/UserScript==

!function(){"use strict";class e{constructor(e,i){this.url=e,this.data=i}get(e){$.ajax({url:this.url,method:"get"}).done(e)}post(e){$.ajax({url:this.url,method:"post",data:this.data}).done(e)}}const i=e=>new Promise(((i,t)=>{$.ajax({url:e.url,type:e.type||"get",dataType:"json",headers:e.headers||{},data:e.data||{},success(e){i(e)},error(e){t(e)}})}));class t{constructor(e){this.text=e,this.div=this.createHtml()}closeBotton(){var e=document.createElement("div"),i=document.createElement("span");return i.innerHTML='<svg viewBox="0 0 24 24" width="15" height="15"\n        stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"\n        stroke-linejoin="round" class="css-i6dzq1">\n        <line x1="18" y1="6" x2="6" y2="18"></line>\n        <line x1="6" y1="6" x2="18" y2="18"></line>\n        </svg>',e.style="\n        position: absolute;\n        top: -15px;\n        right: 0px;\n        ",i.onclick=()=>{this.closePrompt()},e.appendChild(i),document.body.appendChild(e),e}createHtml(){var e=document.createElement("div");return e.innerText=this.text,e.id="prompt",e.style="\n        background-color: #cdcdcd;\n        position: fixed;\n        left: 50%;\n        z-index: 999;\n        top: 50%;\n        transform: translate(-50%, -50%);\n        height: 50px;\n        width: 500px;\n        border-radius: 5px;\n        text-align: center;\n        line-height: 50px;\n        ",e.appendChild(this.closeBotton()),document.body.appendChild(e),e}changeText(e){this.div||console.log("error"),this.div.innerText=e}closePrompt(){this.div&&this.div.remove()}}class d{constructor(e,i,d=1){this.prompt=new t("正在替换商品"),this.djh_data=[],this.order_id=e,this.th_id=i,this.goods_number=d}async queryItemNumber(e,t){this.prompt.changeText(`正在查询货号 ${e}`);var d={ctl_reqid:"webopm:report/custom/report_view",ctl_uid:"DataTable:DataTable1",ctl_table_id:"DataTable1",ctl_conf:"eyJsaXN0IjpbeyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTRlZDNcdTVlOTNpZCIsImZpZWxkIjoic3BrY2JfZGRkX2NrX2lkIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTRlZDNcdTVlOTNcdTU0MGRcdTc5ZjAiLCJmaWVsZCI6InNwa2NiX2RkZF9ja19pZF9uYW1lIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTRlZDNcdTVlOTNcdTRlZTNcdTc4MDEiLCJmaWVsZCI6InNwa2NiX2RkZF9ja2RtIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdThkMjdcdTUzZjciLCJmaWVsZCI6InNwa2NiX2RkZF9nb29kc19zbiIsIndpZHRoIjoiMTAwIiwiYWxpZ24iOiIiLCJvcmRlciI6IiJ9LHsidHlwZSI6InRleHQiLCJsb2NrIjoiMCIsInNob3ciOjEsInRpdGxlIjoic2t1IiwiZmllbGQiOiJzcGtjYl9kZGRfc2t1Iiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTU3MjhcdTVlOTNcdTVlOTNcdTViNTgiLCJmaWVsZCI6InNwa2NiX2RkZF9zbCIsIndpZHRoIjoiMTAwIiwiYWxpZ24iOiIiLCJvcmRlciI6IiJ9LHsidHlwZSI6InRleHQiLCJsb2NrIjoiMCIsInNob3ciOjEsInRpdGxlIjoiXHU3ODZlXHU4YmE0XHU5NTAxXHU1YjlhXHU1ZTkzXHU1YjU4IiwiZmllbGQiOiJzcGtjYl9kZGRfc2wyIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTUzZWZcdTc1MjhcdTVlOTNcdTViNTgiLCJmaWVsZCI6Imt5c2wiLCJ3aWR0aCI6IjEwMCIsImFsaWduIjoiIiwib3JkZXIiOiIifSx7InR5cGUiOiJ0ZXh0IiwibG9jayI6IjAiLCJzaG93IjoxLCJ0aXRsZSI6Ilx1NTU0Nlx1NTRjMVx1NTQwZFx1NzlmMCIsImZpZWxkIjoiZ29vZHNfZGRkX2dvb2RzX25hbWUiLCJ3aWR0aCI6IjEwMCIsImFsaWduIjoiIiwib3JkZXIiOiIifSx7InR5cGUiOiJ0ZXh0IiwibG9jayI6IjAiLCJzaG93IjoxLCJ0aXRsZSI6Ilx1OTg5Y1x1ODI3Mlx1NTQwZFx1NzlmMCIsImZpZWxkIjoic2t1X2V4X2RkZF9jb2xvcl9pZF9uYW1lIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTVjM2FcdTViZjhcdTU0MGRcdTc5ZjAiLCJmaWVsZCI6InNrdV9leF9kZGRfc2l6ZV9pZF9uYW1lIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTZlMjBcdTkwNTNcdTU0MGRcdTc5ZjAiLCJmaWVsZCI6ImZqc3hfZGRkX2Zqc3hfbmFtZSIsIndpZHRoIjoiMTAwIiwiYWxpZ24iOiIiLCJvcmRlciI6IiJ9LHsidHlwZSI6InRleHQiLCJsb2NrIjoiMCIsInNob3ciOiIwIiwidGl0bGUiOiJcdTk4NzlcdTc2ZWVcdTRlZTNcdTc4MDEiLCJmaWVsZCI6ImZqc3hfZGRkX2Zqc3hfY29kZSIsIndpZHRoIjoiMTAwIiwiYWxpZ24iOiIiLCJvcmRlciI6IiJ9XSwib3B0cyI6eyJrZXkiOiJpZCIsImVuYWJsZV9kZWxldGUiOmZhbHNlLCJlbmFibGVfY3VzdG9tX2ZpZWxkIjp0cnVlfX0=",ctl_dataset:"InJlcG9ydFwvcmVwb3J0X2RldGFpbF9tb2RlbDo6Y3VzdG9tX3NlYXJjaF9ieV9wYWdlIg==",ctl_count:"true",ctl_pager:"true",ctl_style:"",ctl_script:"true",ctl_type:"view",ctl_table:"",ctl_params:"W10=",ctl_field_set:"_field_set",ctl_tpl:"",record_count:0,page_size:2e3,page_count:0,page:1,spkcb_ddd_ckdm:"",goods_ddd_goods_sn:e,sku_ex_ddd_sku_id:"",fjsx_ddd_default_item:"",spkcb_ddd_ck_id:"",report_id:47};const o=await i({url:"?app_act=ctl/index/do_index&app_ctl=DataTable/do_get_data&ajax=1&type=1",type:"POST",data:d});var s=$(o.data.content),a=[];return $(s).find("tbody > tr").each((function(e,i){var t={ck_id:$(i).find("td:eq(0)").text(),ck_name:$(i).find("td:eq(1)").text(),goods_sn:$(i).find("td:eq(3)").text(),goods_sku:$(i).find("td:eq(4)").text(),kykc:$(i).find("td:eq(7)").text(),good_name:$(i).find("td:eq(8)").text(),color:$(i).find("td:eq(9)").text(),size:$(i).find("td:eq(10)").text()};a.push(t)})),0==a.length||"\n暂时还没有记录"==a[0].ck_id?(this.prompt.closePrompt(),alert("没有找到该货号")):this.matchColor(a,t,e)}matchColor(e,i,t){let d=i.split(/\+|和|,|，|加|换/);const o=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(o,"i"),a=d.filter((e=>-1!==e.search(s)));if(!a.length)return e.filter((e=>0!=e.kykc))[0]||e[0];const r=["黑","白","红","蓝","绿","黄","紫","橙","粉","棕","灰"].find((e=>a[0].includes(e)));return r?e.find((e=>e.color.includes(r)))||e.filter((e=>0!=e.kykc))[0]||e[0]:e.filter((e=>0!=e.kykc))[0]||e[0]}async query_huo_hao(e){const t=await i({url:"?app_act=ctl/index/do_index&app_ctl=DataTable/do_get_data&ajax=1&type=1",type:"POST",data:{ctl_reqid:"webprm:common/select/select_sku",ctl_uid:"DataTable:table",ctl_table_id:"table",ctl_conf:"ImNvbW1vblwvc2VsZWN0X3NrdSI=",ctl_dataset:"ImNvbW1vblwvc2VsZWN0X21vZGVsOjpzZWFyY2hfc2t1X2J5X3BhZ2Ui",ctl_count:"true",ctl_pager:"true",ctl_style:"",ctl_script:"true",ctl_type:"view",ctl_table:"",ctl_params:"eyJmaWx0ZXIiOnsiZ29vZHNfc24iOiIiLCJnb29kc19pZCI6IiIsImdvb2RzX2tlaHVfaWQiOiIiLCJwYWdlX3NpemUiOjEwfX0=",ctl_field_set:"select_sku_field_set",ctl_tpl:"",hasframe:"",goods_sn:e,goods_id:"",goods_kehu_id:"",page_size:"1000",page:"1",keywords:"",goods_name:"",goods_sname:"",ajax:"1",type:"1"}});if(1!=t.status)return alert(t.message),!1;const d=[];return $(t.data.content).find("tbody > tr").each(((i,t)=>{const o=$(t);if(o.find(".goods_sn_func").text()!=e)return!1;d.push({th_id:o.attr("trid"),goods_sn:o.find(".goods_sn_func").text(),sku:o.find(".sku_func").text(),goods_name:o.find(".goods_name_func").text(),color:o.find(".color_id_name_func").text(),size:o.find(".size_id_name_func").text(),jc_name:o.find(".goods_sname_func").text()})})),d}selectSku(e){this.prompt.changeText("选择等价换的商品");let i=window.pageYOffset||document.documentElement.scrollTop,t=$("<div>",{class:"openDiv el-dialog--center openDiv_el",style:`max-width: 900px; width: 900px; min-height: 600px;max-height: 600px; top: ${i+100}px;left: 50%;transform: translate(-50%, 0%); position: absolute; z-index: 10002; display: block; margin-bottom: 0px;padding: 20px;overflow-y: auto;`,id:"selectSkuDiv"});$('<div class="openDivHeader el-dialog__header" id="openDivHeaderorder_djh_101697341"><span class="el-dialog__title">等价换</span><button type="button" onclick="$(\'#selectSkuDiv\').remove()" class="el-dialog__headerbtn"><i class="el-dialog__close el-icon el-icon-close"></i></button>  </div>').appendTo(t);let d=$("<table>",{border:"1px",bordercolor:"#808080",cellspacing:"0",cellpadding:"0",style:"width: 100%;text-align: center;background-color: #f5f5f5;border-collapse: collapse;"}),o=$("<thead>",{style:"text-align: center;"}),s=$("<tbody>");["商品货号","SKU","商品名称","颜色","规格","商品简称","操作"].forEach((e=>{$("<th>",{text:e}).appendTo(o)})),o.appendTo(d),e.forEach((e=>{let i=$("<tr>"),t=$("<td>",{text:e.goods_sn}),d=$("<td>",{text:e.sku}),o=$("<td>",{text:e.name}),a=$("<td>",{text:e.color}),r=$("<td>",{text:e.size}),n=$("<td>",{text:e.jc_name}),c=$("<a>",{text:"选择",style:"color: #1890ff;cursor: pointer;",href:"javascript:void(0);"}).click((async()=>{this.djh_data.push({sku_id:e.th_id,sku:e.sku,goods_name:e.goods_name,goods_number:this.goods_number}),await this.replace_sku(),process_goods_message(),get_order_action(),$("#selectSkuDiv").remove()})),l=$("<td>");l.append(c),i.append(t,d,o,a,r,n,l),s.append(i)})),s.appendTo(d),d.appendTo(t),this.prompt.closePrompt(),$("#selectSkuDiv").length&&$("#selectSkuDiv").remove(),t.appendTo("body")}async replace_hh(e){const i=await this.query_huo_hao(e);this.selectSku(i)}is_gifts(e){if(-1!=e.search(/赠品|礼品/g))return!0}async query_sku(e){return await i({url:"?app_act=order/order_goods/select_goods_by_sku",type:"POST",data:{sku:e,order_id:this.order_id}})}async replace(e,i){this.prompt.changeText("正在查询"+e);const t=await this.query_sku(e);if(-1==t.status){if(this.is_gifts(i)){this.prompt.changeText("检测到赠品等关键词直接匹配颜色替换或替换有库存的:"+e);const t=await this.queryItemNumber(e,i),d=await this.query_sku(t.goods_sku);return-1==d.status?(alert(d.message),!1):(this.prompt.changeText(`查询货号颜色修改为: ${e} ${t.color} ${t.size}`),this.djh_data.push({sku_id:d.data.sku_id,sku:d.data.sku,goods_name:d.data.goods_name,goods_number:this.goods_number}),await this.replace_sku(),process_goods_message(),get_order_action(),this.prompt.closePrompt(),!1)}return this.prompt.changeText("sku不存在正在尝试查询货号"+e),void this.replace_hh(e)}this.prompt.changeText("等价换完毕");const d=t.data;this.djh_data.push({sku_id:d.sku_id,sku:d.sku,goods_name:d.goods_name,goods_number:this.goods_number}),await this.replace_sku(),process_goods_message(),get_order_action(),this.prompt.closePrompt()}async replace_sku(){const e={order_id:this.order_id,th_id:this.th_id,ptype:"bzsj",djh_data:JSON.stringify(this.djh_data)},t=await i({url:"?app_act=order/order_goods/djh_replace_new&ajax=1",type:"POST",data:e});1==t.status?alert("换货成功"):alert(t.message)}}class o{constructor(){this.prompt=new t("等待添加商品")}addGoods(e,i,t,d=!1){this.prompt.changeText("正在查询货号"+i),this.queryItemNumber(i,(o=>{var s=JSON.parse(o),a=$(s.data.content),r=[];if($(a).find("tbody > tr").each((function(e,i){var t={ck_id:$(i).find("td:eq(0)").text(),ck_name:$(i).find("td:eq(1)").text(),goods_sn:$(i).find("td:eq(3)").text(),goods_sku:$(i).find("td:eq(4)").text(),kykc:$(i).find("td:eq(7)").text(),good_name:$(i).find("td:eq(8)").text(),color:$(i).find("td:eq(9)").text(),size:$(i).find("td:eq(10)").text()};r.push(t)})),0==r.length||"\n暂时还没有记录"==r[0].ck_id)return this.prompt.closePrompt(),d?void window.location.replace(`http://39.103.148.141/cameloms/webopm/web/?app_act=order/order_list/do_detail&order_id=${e}`):alert("没有找到该货号");var n=this.matchColor(r,t,i);d?this.addSku(e,n.goods_sku,d):this.addSku(e,n.goods_sku)}))}_addSku(i,t){const d={goods_info:JSON.stringify([{...i,sub_deal_code:""}])};new e("?app_act=order/order_goods/batch_add&queren=1",d).post(t)}querySku(i,t,d){this.prompt.changeText(`正在查询sku ${t}`),new e(`?app_act=order/order_goods/do_detail&order_id=${i}&goods_barcode=${t}&rtype=&addtype=batch&tc_sku_id_str=`).get(d)}queryItemNumber(i,t){this.prompt.changeText(`正在查询货号 ${i}`),new e("?app_act=ctl/index/do_index&app_ctl=DataTable/do_get_data&ajax=1&type=1",{ctl_reqid:"webopm:report/custom/report_view",ctl_uid:"DataTable:DataTable1",ctl_table_id:"DataTable1",ctl_conf:"eyJsaXN0IjpbeyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTRlZDNcdTVlOTNpZCIsImZpZWxkIjoic3BrY2JfZGRkX2NrX2lkIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTRlZDNcdTVlOTNcdTU0MGRcdTc5ZjAiLCJmaWVsZCI6InNwa2NiX2RkZF9ja19pZF9uYW1lIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTRlZDNcdTVlOTNcdTRlZTNcdTc4MDEiLCJmaWVsZCI6InNwa2NiX2RkZF9ja2RtIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdThkMjdcdTUzZjciLCJmaWVsZCI6InNwa2NiX2RkZF9nb29kc19zbiIsIndpZHRoIjoiMTAwIiwiYWxpZ24iOiIiLCJvcmRlciI6IiJ9LHsidHlwZSI6InRleHQiLCJsb2NrIjoiMCIsInNob3ciOjEsInRpdGxlIjoic2t1IiwiZmllbGQiOiJzcGtjYl9kZGRfc2t1Iiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTU3MjhcdTVlOTNcdTVlOTNcdTViNTgiLCJmaWVsZCI6InNwa2NiX2RkZF9zbCIsIndpZHRoIjoiMTAwIiwiYWxpZ24iOiIiLCJvcmRlciI6IiJ9LHsidHlwZSI6InRleHQiLCJsb2NrIjoiMCIsInNob3ciOjEsInRpdGxlIjoiXHU3ODZlXHU4YmE0XHU5NTAxXHU1YjlhXHU1ZTkzXHU1YjU4IiwiZmllbGQiOiJzcGtjYl9kZGRfc2wyIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTUzZWZcdTc1MjhcdTVlOTNcdTViNTgiLCJmaWVsZCI6Imt5c2wiLCJ3aWR0aCI6IjEwMCIsImFsaWduIjoiIiwib3JkZXIiOiIifSx7InR5cGUiOiJ0ZXh0IiwibG9jayI6IjAiLCJzaG93IjoxLCJ0aXRsZSI6Ilx1NTU0Nlx1NTRjMVx1NTQwZFx1NzlmMCIsImZpZWxkIjoiZ29vZHNfZGRkX2dvb2RzX25hbWUiLCJ3aWR0aCI6IjEwMCIsImFsaWduIjoiIiwib3JkZXIiOiIifSx7InR5cGUiOiJ0ZXh0IiwibG9jayI6IjAiLCJzaG93IjoxLCJ0aXRsZSI6Ilx1OTg5Y1x1ODI3Mlx1NTQwZFx1NzlmMCIsImZpZWxkIjoic2t1X2V4X2RkZF9jb2xvcl9pZF9uYW1lIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTVjM2FcdTViZjhcdTU0MGRcdTc5ZjAiLCJmaWVsZCI6InNrdV9leF9kZGRfc2l6ZV9pZF9uYW1lIiwid2lkdGgiOiIxMDAiLCJhbGlnbiI6IiIsIm9yZGVyIjoiIn0seyJ0eXBlIjoidGV4dCIsImxvY2siOiIwIiwic2hvdyI6MSwidGl0bGUiOiJcdTZlMjBcdTkwNTNcdTU0MGRcdTc5ZjAiLCJmaWVsZCI6ImZqc3hfZGRkX2Zqc3hfbmFtZSIsIndpZHRoIjoiMTAwIiwiYWxpZ24iOiIiLCJvcmRlciI6IiJ9LHsidHlwZSI6InRleHQiLCJsb2NrIjoiMCIsInNob3ciOiIwIiwidGl0bGUiOiJcdTk4NzlcdTc2ZWVcdTRlZTNcdTc4MDEiLCJmaWVsZCI6ImZqc3hfZGRkX2Zqc3hfY29kZSIsIndpZHRoIjoiMTAwIiwiYWxpZ24iOiIiLCJvcmRlciI6IiJ9XSwib3B0cyI6eyJrZXkiOiJpZCIsImVuYWJsZV9kZWxldGUiOmZhbHNlLCJlbmFibGVfY3VzdG9tX2ZpZWxkIjp0cnVlfX0=",ctl_dataset:"InJlcG9ydFwvcmVwb3J0X2RldGFpbF9tb2RlbDo6Y3VzdG9tX3NlYXJjaF9ieV9wYWdlIg==",ctl_count:"true",ctl_pager:"true",ctl_style:"",ctl_script:"true",ctl_type:"view",ctl_table:"",ctl_params:"W10=",ctl_field_set:"_field_set",ctl_tpl:"",record_count:0,page_size:2e3,page_count:0,page:1,spkcb_ddd_ckdm:"",goods_ddd_goods_sn:i,sku_ex_ddd_sku_id:"",fjsx_ddd_default_item:"",spkcb_ddd_ck_id:"",report_id:47}).post(t)}matchColor(e,i,t){this.prompt.changeText("正在匹配颜色");let d=i.split(/\+|和|,|，|加|换/);const o=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(o,"i"),a=d.filter((e=>-1!==e.search(s)));if(!a.length)return e.filter((e=>0!=e.kykc))[0]||e[0];const r=["黑","白","红","蓝","绿","黄","紫","橙","粉","棕","灰"].find((e=>a[0].includes(e)));return r?e.find((e=>e.color.includes(r)))||e.filter((e=>0!=e.kykc))[0]||e[0]:e.filter((e=>0!=e.kykc))[0]||e[0]}order_pay(i,t){new e("?app_act=order/order_process/do_process&ajax=1&order_id=batch&type=batch_pay",{ext:i}).post(t)}addSku(e,i,t){this.querySku(e,i,(i=>{let d=JSON.parse(i);if(1200!=d.status)return t?(window.location.replace(`http://39.103.148.141/cameloms/webopm/web/?app_act=order/order_list/do_detail&order_id=${e}`),void this.prompt.closePrompt()):(this.prompt.closePrompt(),alert(d.message));let o=d.data.html,s=$(o),a=s.find(".tc_sku_id_0_add").attr("goods_id"),r={goods_id:s.find(".tc_sku_id_0_add").attr("goods_id"),order_id:s.find(".tc_sku_id_0_add").attr("order_id"),color_id:s.find(".tc_sku_id_0_add").attr("color_id"),size_id:s.find(".tc_sku_id_0_add").attr("size_id"),goods_number:s.find(`#goods_number_${e}_${a}_add`).val(),goods_price:s.find(`#goods_price_${e}_${a}_add`).val(),shop_price:s.find(`#shop_price_${e}_${a}_add`).val(),is_gift:1,tc_sku_id:s.find(`#tc_sku_id_${e}_${a}_add`).val(),rtype:"",sub_deal_code:s.find(`#sub_deal_codes_${e}_${a}_add > option`).eq(1).val(),_good_sn:s.find(`#edt_good_sn_${e}_${a}_add`).val(),payment:s.find(`#goods_total_price_${e}_${a}_add`).val(),taocan_link_sign:s.find(`#taocan_link_sign_${e}_${a}_add`).val()};this._addSku(r,(i=>{let d=JSON.parse(i);1300==d.status?t||(get_order_button("order_button_"+e,e,""),process_goods_message(),alert("添加完成")):alert(d.message),t&&this.order_pay(e,(i=>{let t=JSON.parse(i);1!=t.status&&alert(t.message),window.location.replace(`http://39.103.148.141/cameloms/webopm/web/?app_act=order/order_list/do_detail&order_id=${e}`)})),this.prompt.closePrompt()}))}))}}function s(e,i,t,d){var o,a;(o=void 0===d?$(e):$(d).contents().find(e))&&o.length>0?(a=!0,o.each((function(){var e=$(this);e.data("alreadyFound")||!1||(i(e)?a=!1:e.data("alreadyFound",!0))}))):a=!1;var r=s.controlObj||{},n=e.replace(/[^\w]/g,"_"),c=r[n];a&&t&&c?(clearInterval(c),delete r[n]):c||(c=setInterval((function(){s(e,i,t,d)}),300),r[n]=c),s.controlObj=r}function a(e){var i=$("<input>");$("body").append(i),i.val(e).select(),document.execCommand("copy"),i.remove(),alert("复制成功\n复制内容为:\t"+e)}class r{constructor(){this.prompt=new t}copy_order(i,t){new e(`?app_act=order/order_process/do_process&ajax=1&type=fzdd&order_id=${i}&force=-1`,{copy_type:"",ext:""}).post(t)}delete_goods(i,t,d){new e("?app_act=order/order_goods/batch_delete_goods",{order_goods_ids:t,order_id:i}).post(d)}get_new_order_data(i,t){new e("?app_act=order/order_list/do_goods&_do_goods_special_=0",{order_id:i,type:"get",is_auto_save:!1}).post(t)}reissue(e,i,t,d){this.prompt.changeText("正在复制订单"),this.copy_order(e,(e=>{var s=JSON.parse(e),a=s.data.order_id;if(1!=s.status)return this.prompt.closePrompt(),void alert(s.message);this.get_new_order_data(a,(e=>{this.prompt.changeText("正在获取商品信息");var s=JSON.parse(e),r=$(s.data.html),n=[];r.find("tbody > tr > td:nth-child(1) > input").each(((e,i)=>{n.push($(i).attr("value"))})),this.delete_goods(a,n.toString(),(e=>{this.prompt.changeText("正在删除商品信息");var s=JSON.parse(e);if(1300!=s.status)return this.prompt.closePrompt(),alert(s.message);this.prompt.closePrompt(),d?(new o).addSku(a,i,!0):(new o).addGoods(a,i,t,!0)}))}))}))}}GM_addStyle(".card{width:500px;}.card-container{position:fixed;top:0px;right:0px;border-bottom-left-radius:5px;border-top-left-radius:5px;font-size:18px;box-shadow:-1px 3px 10px 0px #888;z-index:998;background-color:#fff;}.card-header{padding-top:5px;position:relative;text-align:right;right:10px;font-weight:bold;line-height:50%;}.deployment{display:none;font-size:0px;}.card-fn-menu{display:none;position:absolute;top:0;left:0;background-color:#fff;box-shadow:1px 1px 2px rgba(0,0,0,0.2);border-radius:4px;z-index:1000000;}.card-fn-menu ul,.card-fn-menu li{padding:0;margin:0;}.card-fn-menu li{width:150px;height:30px;list-style:none;text-align:center;line-height:30px;border-radius:2px;}.card-fn-menu li:hover{background-color:#888;}.card-fn-menu .separate{height:3px;background-color:#888;}.card-fn-menu .separate:hover{background-color:white;}.column{display:flex;align-items:center;padding-bottom:5px;}.row{width:60px;padding-left:5px;padding-right:10px;white-space:nowrap;}.column:last-child{padding-bottom:15px;}");const n={card:"",deployment:"none"};function c(e){if($("#base_info_div > div > div:nth-child(2) > div.deteil_item_content.word_wrap > div > span").attr("title").trim()===e.out_order_no){var i=`<div id="card-body"><div class="card-container" style="z-index: 999999;"><div class="card"><div class="card-header"><span class="card-header-minimize"id="min-btn"><svg viewBox="0 0 24 24"width="18"height="18"stroke="currentColor"stroke-width="2"fill="none"stroke-linecap="round"stroke-linejoin="round"class="css-i6dzq1"><line x1="0"y1="11"x2="20"y2="11"></line></svg></span><span class="card-header-close"id="close-btn"><svg viewBox="0 0 24 24"width="20"height="20"stroke="currentColor"stroke-width="2"fill="none"stroke-linecap="round"stroke-linejoin="round"class="css-i6dzq1"><line x1="18"y1="6"x2="6"y2="18"></line><line x1="6"y1="6"x2="18"y2="18"></line></svg></span></div><div class="table-card1"><div class="column"><div class="row">交易号:</div><div id="order"title="点击复制交易号">${e.out_order_no}</div></div><div class="column"><div class="row">店铺:</div><div id="aShop"title="点击复制交易号和店铺">${e.shop_name}</div></div><div class="column"><div class="row">登记人:</div><div id="registrant"title="点击复制登记人">${e.provider}</div></div><div class="column"><div class="row"id="remarks-text"title="点击复制备注">备注:</div><div id="remarks" style="line-height: 1.3em;word-break: break-all;">${function(e){const i=["#FFC300","#3498DB","#27AE60","#9B59B6","#F1C40F","#2C3E50","#E67E22","#16A085","#2980B9","#8E44AD"];var t=[...new Set(e.match(/(\b[\w-]{5,})/g))];if(!t)return e;var d=[],o=1;$("#goods_div > div.goods_detail_wrap > div.goods_detail_tbody > table > tbody > tr").each((function(s,a){var r=$(a).find("td > ul.goods_info_right > li:nth-child(2)"),n=r.text().replace("货号：","").trim(),c=$(a).find("td > div[style='padding-left:10px;text-align:left;']"),l=c.text().trim();if(t.some((e=>e.toLocaleUpperCase()==n))){let s=new RegExp("(?![>])"+n+"(?![0-9a-zA-Z-])","gi");e=e.replace(s,`<span style="background-color: ${i[o]};border-radius: 3px;" class="copy_hh" draggable="true">${n}</span>`),$(r).css({"background-color":i[o],"border-radius":"3px"}),t=t.filter((function(e){return e.toLocaleUpperCase()!==n})),d.push({item_number:n,color:i[o],type:""}),o++}if(t.some((e=>e.toLocaleUpperCase()==l))){let s=new RegExp("(?![>])"+l+"(?![0-9a-zA-Z-])","gi");e=e.replace(s,`<span style="background-color: ${i[o]};border-radius: 3px;" class="copy_hh" draggable="true">${l}</span>`),$(c).css({"background-color":i[o],"border-radius":"3px"}),t=t.filter((function(e){return e.toLocaleUpperCase()!==l})),d.push({item_number:l,color:i[o],type:"sku"}),o++}let p=d.filter((e=>"sku"==e.type&&e.item_number==l||e.item_number==n?e:void 0));if(p.length)for(let e=0;e<p.length;e++)"sku"==p[e].type?$(c).css("background-color",p[e].color):$(r).css("background-color",p[e].color)}));for(let d=0;d<t.length;d++){let o=new RegExp("(?![>])"+t[d]+"(?![0-9a-zA-Z-])","g");e=e.replace(o,`<span style="background-color: ${i[0]};border-radius: 3px;" class="copy_hh add_hh" draggable="true">${t[d]}</span>`)}return e}(e.remarks)}</div></div></div></div><div class="deployment"><svg viewBox="0 0 24 24"width="24"height="24"stroke="currentColor"stroke-width="1"fill="none"stroke-linecap="round"stroke-linejoin="round"class="css-i6dzq1"><rect x="3"y="3"width="18"height="18"rx="2"ry="2"></rect><line x1="12"y1="8"x2="12"y2="16"></line><line x1="8"y1="12"x2="16"y2="12"></line></svg></div></div><div class="card-fn-menu"id="card-menu"><ul><li class="add-item-number">添加货号</li><li class="add-order-sku">添加sku</li><li class="separate"></li><li class="copy-item-number">补发货号</li><li class="copy-order-sku">补发sku</li></ul></div></div>`;$("#card-body").length>0&&$("#card-body").remove(),$(document.body).append(i),$(".card").css("display",n.card),$(".deployment").css("display",n.deployment)}}$(document).ready((function(){let e=!1;const i=djh_goods_new;djh_goods_new=function(){i.apply(this,arguments);const t=setInterval((()=>{if(document.getElementById("djh_goods")&&!e){e=!0,clearInterval(t),$("#djh_goods > div.cmd > button.el-button.el-button--primary.el-button--small").click((function(){app._data.djh_result.map((e=>e.goods_number)).reduce(((e,i)=>e+i))!=tableData[0].goods_number&&alert("商品数量对不上,请检查")}));const i=openDiv.close;openDiv.close=function(){arguments[0].includes("order_djh_")&&(e=!1),i.apply(this,arguments)}}}),100)}})),s("#base_info_div > div > div:nth-child(2) > div.deteil_item_content.word_wrap > div > span",(function(){s("#goods_div > div.goods_detail_wrap > div.goods_detail_tbody > table",(function(){var e=JSON.parse(localStorage.getItem("work_data"));e&&(c(e),$(".table-card1").on("click","#order",(function(e){a(this.innerText)})).on("click","#aShop",(function(){a(`${this.innerText}\t${$("#order").text()}`)})).on("click","#remarks-text",(function(){a(e.remarks)})).on("click","#registrant",(function(){a(this.innerText)})),$("#min-btn").on("click",(function(){$(".card").css("display","none"),$(".deployment").css("display","block"),n.card="none",n.deployment="block"})),$("#close-btn").on("click",(function(){$(".card-container").remove()})),$(".deployment").click((function(){$(".deployment").css("display","none"),$(".card").css("display","block"),n.card="block",n.deployment="none"})),$(".card").on("click",".copy_hh",(function(e){e.preventDefault(),a(e.target.innerText)})).on("contextmenu",".copy_hh",(function(i){i.preventDefault(),$("#card-menu").css({display:"block",left:i.pageX,top:i.pageY}),$(".add-item-number, .add-order-sku, .copy-item-number, .copy-order-sku").off("click").on("click",(function(t){switch(t.stopPropagation(),$("#card-menu").css("display","none"),t.target.className){case"add-item-number":(new o).addGoods(order_id,i.target.innerText,e.remarks);break;case"add-order-sku":(new o).addSku(order_id,i.target.innerText);break;case"copy-item-number":0==$(`#order_qr_${order_id}`).length&&"取消发货"!=$(`#order_wtzph_${order_id}`).attr("title")&&0==$(`#order_czddzt_${order_id}`).length?(new r).reissue(order_id,i.target.innerText,e.remarks,!1):alert("订单不是发货或者无效状态不符合补发状态");break;case"copy-order-sku":0==$(`#order_qr_${order_id}`).length&&"取消发货"!=$(`#order_wtzph_${order_id}`).attr("title")&&0==$(`#order_czddzt_${order_id}`).length?(new r).reissue(order_id,i.target.innerText,e.remarks,!0):alert("订单不是发货或者无效状态不符合补发状态")}})),$(".card-container").off().on("click",(function(){$("#card-menu").css("display","none")}))})),$(".copy_hh").on("dragstart",(e=>{e.originalEvent.dataTransfer.setData("itemData",e.target.innerText)})),$("#goods_div > div.goods_detail_wrap > div.goods_detail_tbody > table > tbody > tr").off("dragover").on("dragover",(e=>{$(e.currentTarget).css("border","2px solid blue"),e.preventDefault()})).off("dragleave").on("dragleave",(e=>{$(e.currentTarget).css("border",""),e.preventDefault()})).off("drop").on("drop",(i=>{$(i.currentTarget).css("border",""),i.preventDefault();var t=i.originalEvent.dataTransfer.getData("itemData");if(!t)return void alert("没有拖拽到要替换的数据");var o=$(i.currentTarget);if("INPUT"!==o.find("td").eq(0)[0].lastElementChild.nodeName)return void alert("商品是不可选中状态,不可替换");if(!o.find(".goods_detail_tags").text().includes("礼品")&&-1!==e.remarks.search(/赠品|礼品|赠|送/))return void alert("备注包含有赠品|礼品|赠|送等关键词,替换的不是赠品需要手动替换");var s=o.find(".sticky_right a").eq(2).attr("onclick").match(/\((.*)\)/)[1].replace(/\'/g,"").split(","),a=o.find("td > a > span").text().match(/.*\t(\d+).*\(.*\)/);new d(order_id,s[0],a[1]).replace(t,e.remarks)})))}))}))}();