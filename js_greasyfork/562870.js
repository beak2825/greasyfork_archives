// ==UserScript==
// @name         Gemini: Enter to Newline & Ctrl+Enter to Send
// @namespace    https://github.com/namespace_not_found_404/gemini-tweaks
// @version      1.0.0
// @description  Enter inserts a newline (via native Shift+Enter proxy), Ctrl+Enter sends the message. Fully compatible with Firefox & Chrome.
// @author       Code generated by Google Gemini, polished by Ooldjin
// @match        https://gemini.google.com/*
// @grant        none
// @license      MIT
// @icon         https://www.google.com/s2/favicons?sz=64&domain=gemini.google.com
// @run-at       document-start
// @downloadURL https://update.greasyfork.org/scripts/562870/Gemini%3A%20Enter%20to%20Newline%20%20Ctrl%2BEnter%20to%20Send.user.js
// @updateURL https://update.greasyfork.org/scripts/562870/Gemini%3A%20Enter%20to%20Newline%20%20Ctrl%2BEnter%20to%20Send.meta.js
// ==/UserScript==

(function() {
    'use strict';

    // ========================================================================
    // Utility Functions
    // ========================================================================

    /**
     * Find the specific Send button based on current UI structure.
     * Strategies: Class name, ARIA label, or Material Icon.
     */
    function findExactSendButton() {
        let btn = document.querySelector('button.send-button');
        if (isValidBtn(btn)) return btn;

        btn = document.querySelector('button[aria-label="Send message"]');
        if (isValidBtn(btn)) return btn;

        const icon = document.querySelector('mat-icon[data-mat-icon-name="send"]');
        if (icon) {
            btn = icon.closest('button');
            if (isValidBtn(btn)) return btn;
        }
        return null;
    }

    function isValidBtn(btn) {
        return btn && !btn.disabled && btn.offsetParent !== null;
    }

    // ========================================================================
    // Main Event Listener
    // ========================================================================
    document.addEventListener('keydown', function(e) {
        const target = e.target;
        // Only active inside the content editable area
        if (target.getAttribute('contenteditable') !== 'true') return;

        // IME Protection: Do not intercept when using Input Method Editor (e.g., CJK composition)
        if (e.isComposing || e.keyCode === 229) return;

        // --------------------------------------------------------------------
        // 1. Send Logic: Ctrl+Enter (Win/Linux) or Cmd+Enter (Mac)
        // --------------------------------------------------------------------
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            // Prevent default behavior (newline)
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation(); // Aggressively stop other handlers

            const btn = findExactSendButton();
            if (btn) {
                // console.log('Gemini Script: Triggering Send Click');
                btn.click();
            }
        }
        // --------------------------------------------------------------------
        // 2. Newline Logic: Enter key alone (without modifiers)
        // --------------------------------------------------------------------
        else if (e.key === 'Enter' && !e.shiftKey && !e.altKey) {
            // A. Intercept: Strictly prevent Gemini from capturing this "Enter" and triggering Send
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation(); // Critical Fix: Stop other listeners (fixes Firefox issues)

            // console.log('Gemini Script: Intercepted Enter. Dispatching Fake Shift+Enter...');

            // B. Proxy: Dispatch a fake "Shift + Enter" event to the current element.
            // Gemini natively handles "Shift+Enter" as a newline. We exploit this behavior
            // to avoid complex DOM manipulation issues across browsers.
            const fakeShiftEnter = new KeyboardEvent('keydown', {
                key: 'Enter',
                code: 'Enter',
                keyCode: 13,
                which: 13,
                shiftKey: true, // Key point: Mock the Shift key state
                ctrlKey: false,
                metaKey: false,
                altKey: false,
                bubbles: true,
                cancelable: true,
                composed: true
            });

            target.dispatchEvent(fakeShiftEnter);

            // C. Scroll: Ensure cursor visibility
            setTimeout(() => {
                target.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }, 10);
        }

        // Note: When the script dispatches 'fakeShiftEnter', this listener will trigger again.
        // However, since 'fakeShiftEnter.shiftKey' is true, it will bypass the "else if" block above
        // and be handled by Gemini's native logic, creating a perfect loop.

    }, true); // Capture Phase = true (Intercept before bubbling)
})();