// ==UserScript==
// @name        KameSame Open Framework
// @version     0.4
// @author      Robin Findley, Timberpile
// @description Framework for writing scripts for KameSame
// @homepage    https://github.com/timberpile/kamesame-open-framework#readme
// @supportURL  https://github.com/timberpile/kamesame-open-framework/issues
// @match       http*://*.kamesame.com/*
// @copyright   2022+, Robin Findley, Timberpile
// @namespace   timberpile@proton.me
// @run-at      document-start
// @grant       none
// @license     MIT
// @downloadURL https://update.greasyfork.org/scripts/452573/KameSame%20Open%20Framework.user.js
// @updateURL https://update.greasyfork.org/scripts/452573/KameSame%20Open%20Framework.meta.js
// ==/UserScript==

(()=>{"use strict";class e{get answerCorrect(){const e=document.querySelector("#app.kamesame #study .input-area input");if(!e)return null;const t=["exactly_correct","reading_correct","alternative_match_completion","alternative_match","incorrect"];for(const s of t)if(e.classList.contains(s))return s;return null}get reviewType(){const e=document.querySelector("#app.kamesame #study .input-area input");return e?e.classList.contains("production")?"production":e.classList.contains("recognition")?"recognition":null:null}}class t{get on(){const e=[{tag:"review",matcher:/kamesame\.com\/app\/reviews\/study\/[a-z0-9]+/},{tag:"review",matcher:/kamesame\.com\/app\/lessons\/study\/[a-z0-9]+/},{tag:"review_summary",matcher:/kamesame\.com\/app\/reviews\/summary/},{tag:"lessons_summary",matcher:/kamesame\.com\/app\/lessons\/summary/},{tag:"item_page",matcher:/kamesame\.com\/app\/items\/\d+/},{tag:"lessons",matcher:/kamesame\.com\/app\/lessons$/},{tag:"search",matcher:/kamesame\.com\/app\/search$/},{tag:"search_result",matcher:/kamesame\.com\/app\/search\//},{tag:"account",matcher:/kamesame\.com\/app\/account/},{tag:"home",matcher:/kamesame\.com\/app$/}];for(const t of e)if(document.URL.match(t.matcher))return t.tag;return null}}const s="぀-ヿｦ-ﾟ",n=`${s}㐀-䶿一-鿿豈-﫿`,r=()=>window.ksof;class o{get variations(){return"item_page"===r().pageInfo.on&&"vocabulary"===this.type?this.facts.Variations.split("、"):null}get partsOfSpeech(){return"item_page"===r().pageInfo.on&&"vocabulary"===this.type?this.facts["Parts of Speech"].split(", "):null}get wanikaniLevel(){return"item_page"===r().pageInfo.on&&"vocabulary"===this.type?parseInt(this.facts["WaniKani Level"],10):null}get tags(){return"item_page"===r().pageInfo.on&&"vocabulary"===this.type?this.facts.Tags.split(", "):null}get id(){let e="";if("review"==r().pageInfo.on){const t=document.querySelector("#app.kamesame #study .outcome p a.item");if(!t)return null;e=t.href}else"item_page"==r().pageInfo.on&&(e=document.URL);const t=RegExp(/app\/items\/(\d+)/).exec(e);return t?t.length<2?null:Number(t[1]):null}get characters(){if("review"==r().pageInfo.on){const e=document.querySelector("#app.kamesame #study .outcome p")?.textContent;if(!e)return null;const t=[RegExp(`([${n}]+)\\(read as`),RegExp(`looking for ([${n}]+)[\\s⏯]* instead`),RegExp(`Indeed, ([${n}]+)[\\s⏯]*`),RegExp(`That's right! ([${n}]+)[\\s⏯]*`),RegExp(`we were actually looking for ([${n}]+)[\\s⏯]*`)];for(const s of t){const t=s.exec(e);if(t)return t[1]}return null}return"item_page"==r().pageInfo.on&&"vocabulary"==this.type&&document.querySelector(".name.vocabulary")?.textContent||null}get meanings(){if("review"==r().pageInfo.on){const e=document.querySelector("#app.kamesame #study .outcome p")?.textContent;if(!e)return null;const t=[/does(?: not)? mean[\s\n]*((?:".*?"[, or]*)+)/g,/We'd have accepted[\s\n]*((?:".*?"[, or]*)+)/g],s=[];for(const n of t){const t=n.exec(e);if(t){const e=t[1].replaceAll(" or ",",").split(",");for(const t of e)s.push(t.replaceAll('"',"").trim())}}return s}return"item_page"==r().pageInfo.on&&"vocabulary"==this.type?this.facts.Meanings.split(", "):null}get readings(){if("review"==r().pageInfo.on){const e=document.querySelector("#app.kamesame #study .outcome p")?.textContent;if(!e)return null;const t=[];let n=new RegExp(`\\(read as ([${s},a-z\\s⏯]+)\\)`).exec(e);if(n){const e=n[1],r=new RegExp(`[${s}]+`,"g");for(n=r.exec(e);null!=n;)t.push(n[0]),n=r.exec(e)}if(0==t.length){const e=this.characters||"";RegExp(`[${s}]`).test(e)&&t.push(e)}return t}return"item_page"==r().pageInfo.on&&"vocabulary"==this.type?this.facts.Readings.replaceAll(" ⏯","").split("、"):null}get facts(){const e={};for(const t of document.querySelectorAll("#item .facts .fact")){const s=t.querySelector(".key")?.textContent||"";let n="";if("Tags"==s){const e=[];for(const s of t.querySelectorAll(".value .item-tag"))s.textContent&&e.push(s.textContent);n=e.join(", ")}else n=t.querySelector(".value")?.textContent||"";e[s]=n}return e}get type(){if("review"==r().pageInfo.on);else if("item_page"==r().pageInfo.on){if("Vocabulary summary"==document.querySelector("#item h2")?.textContent)return"vocabulary";if("Kanji summary"==document.querySelector("#item h2")?.textContent)return"kanji"}return null}get summary(){return{characters:this.characters,meanings:this.meanings,readings:this.readings,variations:this.variations,partsOfSpeech:this.partsOfSpeech,wanikaniLevel:this.wanikaniLevel,tags:this.tags,on:r().pageInfo.on,type:this.type}}}class a{value;constructor(e){this.value=e}compareTo(e){const t=e.split(".").map((e=>Number(e))),s=this.value.split(".").map((e=>Number(e))),n=Math.max(t.length,s.length);for(let e=0;e<n;e++){const n=t[e]||0,r=s[e]||0;if(n!==r)return n<r?"newer":"older"}return"same"}}class i{promise;resolve;reject;constructor(){this.resolve=()=>{},this.reject=()=>{},this.promise=new Promise(((e,t)=>{this.reject=t,this.resolve=e}))}}const c=e=>e.replace(/、/g,",").replace(/[\s　]+/g," ").trim().replace(/ *, */g,",").split(",").filter((e=>e.length>0)),l={Jquery:{url:"https://greasyfork.org/scripts/451523-kamesame-open-framework-jquery-module/code/KameSame%20Open%20Framework%20-%20Jquery%20module.js?version=1113601"},Menu:{url:"https://greasyfork.org/scripts/451522-kamesame-open-framework-menu-module/code/KameSame%20Open%20Framework%20-%20Menu%20module.js?version=1113603"},Settings:{url:"https://greasyfork.org/scripts/451521-kamesame-open-framework-settings-module/code/KameSame%20Open%20Framework%20-%20Settings%20module.js?version=1113605"}};class u{openPromise;dir;syncTimer;constructor(){this.dir={}}async open(){if(this.openPromise)return this.openPromise;const e=new i,t=e=>{if(!(e.target instanceof IDBRequest))return;const t=e.target.result;this.dir=void 0===t?{}:JSON.parse(t.content)};this.openPromise=e.promise;const s=indexedDB.open("ksof.fileCache");return s.onupgradeneeded=e=>{e.target instanceof IDBOpenDBRequest&&e.target.result.createObjectStore("files",{keyPath:"name"})},s.onsuccess=s=>{if(!(s.target instanceof IDBOpenDBRequest))return;const n=s.target.result,r=n.transaction("files","readonly");r.objectStore("files").get("[dir]").onsuccess=t,r.oncomplete=e.resolve.bind(null,n),e.promise.then(setTimeout.bind(null,this.cleanup,1e4))},s.onerror=()=>{console.log("indexedDB could not open!"),this.dir={},e.reject()},e.promise}cleanup(){const e=(e=>{const t=new Date;return t.setTime(t.getTime()+-12096e5),t})(),t=[];for(const s in this.dir)s.match(/^ksof\.settings\./)||new Date(this.dir[s].lastLoaded)<e&&t.push(s);if(0!==t.length){console.log(`Cleaning out ${t.length} old file(s) from "ksof.fileCache":`);for(const e in t)console.log(`  ${Number(e)+1}: ${t[e]}}`),this.delete(t[e])}}ls(){console.log(Object.keys(this.dir).sort().join("\n"))}async clear(){const e=await this.open(),t=new i;if(this.dir={},null===e)return t.resolve();const s=e.transaction("files","readwrite");return s.objectStore("files").clear(),s.oncomplete=t.resolve,t.promise}async delete(e){const t=await this.open(),s=new i;if(null===t)return s.resolve([]);const n=t.transaction("files","readwrite"),r=n.objectStore("files"),o=Object.keys(this.dir).filter((t=>e instanceof RegExp?null!==t.match(e):t===e));return o.forEach((e=>{r.delete(e),delete this.dir[e]})),this.dirSave(),n.oncomplete=s.resolve.bind(null,o),s.promise}dirSave(e=!1){const t=e?0:2e3;this.syncTimer&&clearTimeout(this.syncTimer),this.syncTimer=setTimeout((()=>{this.open().then((e=>{e&&(this.syncTimer=void 0,e.transaction("files","readwrite").objectStore("files").put({name:"[dir]",content:JSON.stringify(this.dir)}))}))}),t)}flush(){this.dirSave(!0)}async load(e){const t=await this.open();if(!t)return Promise.reject();if(void 0===this.dir[e])return Promise.reject(e);const s=new i,n=t.transaction("files","readonly").objectStore("files").get(e);return this.dir[e].lastLoaded=(new Date).toISOString(),this.dirSave(),n.onsuccess=t=>{t.target instanceof IDBRequest&&(void 0===t.target.result?s.reject(e):s.resolve(t.target.result.content))},n.onerror=()=>{s.reject(e)},s.promise}async save(e,t,s={}){const n=await this.open();if(null===n)return Promise.resolve(e);const r=new i,o=n.transaction("files","readwrite");o.objectStore("files").put({name:e,content:t});const a=(new Date).toISOString();return this.dir[e]=Object.assign({added:a,lastLoaded:a},s),this.dirSave(!0),o.oncomplete=r.resolve.bind(null,e),r.promise}fileNocache(e){if(void 0===e)e=(e=c(localStorage.getItem("ksof.include.nocache")||"")).concat(c(localStorage.getItem("ksof.load_file.nocache")||"")),console.log(e.join(","));else if("string"==typeof e){const t=c(e),s=[],n=[];for(let e=0;e<t.length;e++){const r=t[e];void 0!==l[r]?s.push(r):n.push(r)}console.log(`Modules: ${s.join(",")}`),console.log(`   URLs: ${n.join(",")}`),localStorage.setItem("ksof.include.nocache",s.join(",")),localStorage.setItem("ksof.load_file.nocache",n.join(","))}}}const m=()=>window.ksof;class p{observers;mutationObserver;constructor(){this.observers=[],this.mutationObserver=new MutationObserver(this.onBodyMutated)}init(){this.mutationObserver.observe(document.body,{childList:!0,subtree:!0}),this.add({name:"study_outcome",query:"#app.kamesame #study .outcome p a.item"});const e=()=>{this.mutationObserver.takeRecords().length>0&&this.onBodyMutated(),setTimeout(e,100)};e(),this.addPageLoadObservers()}addPageLoadObservers(){const e=new Map([["item_page","#app.kamesame #item .facts .fact"],["review","#app.kamesame #study .meaning"],["review_summary","#app.kamesame #reviews #reviewsSummary .level-bars"],["lessons_summary","#app.kamesame #summary .item-list li a.item"],["lessons","#app.kamesame #lessons #lessonsFromLists.section"],["search","#app.kamesame #search form .search-bar #searchQuery"],["search_result","#app.kamesame #search .fancy-item-list .actions"],["home","#app.kamesame #home .section .stats"],["account","#app.kamesame #account .fun-stuff"]]),t=()=>{m().setState("ksof.document","ready")};for(const s of e){const e={name:`page.${s[0]}`,query:s[1]};this.add(e),m().waitState(this.stateName(e),"present",t)}}add(e){for(const t of this.observers){if(t.name==e.name)throw new Error(`Observer with the name ${e.name} already exists`);if(t.query==e.query)throw new Error(`Observer with the query ${e.query} already exists under the name ${e.name}`)}this.observers.push(e),this.update(e)}stateName(e){return`ksof.dom_observer.${e.name}`}onBodyMutated(){if(this.observers)for(const e of this.observers)this.update(e)}update(e){const t=null!=document.querySelector(e.query);m().setState(this.stateName(e),t?"present":"absent")}}class h{fileCache;supportFiles;version;stateListeners;stateValues;eventListeners;domObserver;includePromises;itemInfo;reviewInfo;pageInfo;constructor(){this.fileCache=new u,this.version=new a("0.4"),this.stateListeners={},this.stateValues={},this.eventListeners={},this.domObserver=new p,this.includePromises={},this.itemInfo=new o,this.reviewInfo=new e,this.pageInfo=new t,this.supportFiles={"jquery.js":"https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js","jquery_ui.js":"https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js","jqui_ksmain.css":"https://raw.githubusercontent.com/timberpile/kamesame-open-framework/master/src/jqui-ksmain.css"}}async loadFile(e,t){const s=new i,n=c(localStorage.getItem("ksof.load_file.nocache")||"");if((n.indexOf(e)>=0||n.indexOf("*")>=0)&&(t=!1),!0===t)try{return await this.fileCache.load(e)}catch(e){}const r=new XMLHttpRequest;return r.onreadystatechange=async n=>{n.target==r&&4===r.readyState&&(r.status>=400||0===r.status?s.reject(r.status):t?(await this.fileCache.save(e,r.response),s.resolve.bind(null,r.response)):s.resolve(r.response))},r.open("GET",e,!0),r.send(),r.onerror=e=>{e.target==r&&s.reject(r.status)},s.promise}getState(e){return this.stateValues[e]}setState(e,t){const s=this.stateValues[e];if(s===t)return;this.stateValues[e]=t;const n=this.stateListeners[e],r=[];for(const e in n){const o=n[e];let a=!0;if(o.value===t||"*"===o.value){a=o.persistent;try{o.callback&&o.callback(t,s)}catch(e){}}a&&r.push(o)}this.stateListeners[e]=r}waitState(e,t,s,n=!1){const r=new i,o=s?(e,t)=>{s(e,t),r.resolve(e)}:r.resolve;void 0===this.stateListeners[e]&&(this.stateListeners[e]=[]);const a=this.stateValues[e];if((n||t!==a)&&this.stateListeners[e].push({callback:o,persistent:n,value:t}),t===a)try{o(t,a)}catch(e){}return r.promise}trigger(e,...t){const s=this.eventListeners[e];if(void 0===s)return this;const n=[];Array.prototype.push.apply(n,t),n.shift();for(const e in s)try{s[e].apply(null,n)}catch(e){}}on(e,t){void 0===this.eventListeners[e]&&(this.eventListeners[e]=[]),this.eventListeners[e].push(t)}async#e(e,t,s,n){if(e=e.replace(/"/g,"'"),null!==document.querySelector(`${t}[uid="${e}"]`))return Promise.resolve(e);let r;try{r=await this.loadFile(e,n)}catch(t){return Promise.reject(e)}const o=document.createElement(t);o.innerHTML=r,o.setAttribute("uid",e);const a=document.querySelector(s);return a&&a.appendChild(o),Promise.resolve(e)}async loadScript(e,t){return this.#e(e,"script","body",t)}async loadCSS(e,t){return this.#e(e,"style","head",t)}async include(e){await this.ready("ksof");const t=new i,s=c(e),n=s.length;if(0===n)return t.resolve({loaded:[],failed:[]}),t.promise;const r=()=>{++u<n||(0===p.length?t.resolve({loaded:m,failed:p}):t.reject({error:"Failure loading module",loaded:m,failed:p}))},o=e=>{m.push(e),r()},a=e=>{p.push({url:e}),r()};let u=0;const m=[],p=[],h=c(localStorage.getItem("ksof.include.nocache")||"");for(const e of s){const t=l[e];if(!t){p.push({name:e}),r();continue}let s=this.includePromises[e];const n=h.indexOf(e)<0&&h.indexOf("*")<0;n||this.fileCache.delete(t.url),void 0===s&&(this.includePromises[e]=s=this.loadScript(t.url,n)),s.then(o,a)}return t.promise}ready(e){const t=c(e),s=[];for(const e in t){const n=t[e];s.push(this.waitState(`ksof.${n}`,"ready"))}return 0===s.length?Promise.resolve("ready"):1===s.length?s[0]:Promise.all(s)}}const d=()=>{const e=history.pushState;history.pushState=function(){const t=e.apply(this,arguments);return window.dispatchEvent(new Event("pushstate")),window.dispatchEvent(new Event("locationchange")),t};const t=history.replaceState;history.replaceState=function(){const e=t.apply(this,arguments);return window.dispatchEvent(new Event("replacestate")),window.dispatchEvent(new Event("locationchange")),e},window.addEventListener("popstate",(()=>{window.dispatchEvent(new Event("locationchange"))}))};(e=>{d();const t=()=>{s.domObserver.init(),window.addEventListener("locationchange",(()=>{s.setState("ksof.document",""),setTimeout((()=>{s.setState("ksof.document","ready")}),2e3),s.trigger("ksof.page_changed")}))};e.ksof=new h;const s=e.ksof;"complete"===document.readyState?t():window.addEventListener("load",t,!1),s.fileCache.open(),s.setState("ksof.ksof","ready")})(window)})();