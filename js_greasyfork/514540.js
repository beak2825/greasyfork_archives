// ==UserScript==
// @name         vSprint Analytics+ raporty
// @namespace    http://tampermonkey.net/
// @version      1.25
// @description  Masowy raport trendów dla danego konta
// @author       Paweł Kaczmarek
// @match        https://allegro.pl/moje-allegro/sprzedaz/allegro-analytics/sprzedaz-kategorii
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/514540/vSprint%20Analytics%2B%20raporty.user.js
// @updateURL https://update.greasyfork.org/scripts/514540/vSprint%20Analytics%2B%20raporty.meta.js
// ==/UserScript==
!function(){"use strict";const e=document.createElement("style");e.textContent='\n        #download-button {\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        z-index: 1000;\n        padding: 12px 24px;\n        background-color: #ff5a00;\n        color: #fff;\n        border: none;\n        border-radius: 5px;\n        cursor: pointer;\n        font-size: 16px;\n        font-weight: bold;\n    }\n    #modal {\n        position: fixed;\n        top: 80px;\n        right: 20px;\n        width: 400px;\n        background-color: rgba(255, 255, 255, 0.95);\n        border-radius: 5px;\n        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n        z-index: 2000;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        flex-direction: column;\n    }\n    #modal-content {\n        padding: 20px;\n        text-align: center;\n        position: relative;\n        width: 80%;\n        margin-top: 20px;\n    }\n        .modal-button {\n            padding: 15px 20px;\n            border: none;\n            border-radius: 5px;\n            cursor: pointer;\n            margin-top: 10px;\n            margin-left: 5px;\n            margin-right:5px;\n            font-size: 15px;\n        }\n        .fetch-button {\n            background-color: #28a745;\n            color: #fff;\n        }\n        .next-fetch-button {\n            background-color: #28a745;\n            color: #fff;\n        }\n        .close-button {\n            position: absolute;\n            top: 0px;\n            right: 0px;\n            background-color: transparent;\n            border: none;\n            font-size: 20px;\n            cursor: pointer;\n            color:black;\n            margin-top:-10px;\n        }\n        #account-select {\n        width: 100%;\n        padding: 10px;\n        border: 2px solid black;\n        border-radius: 5px;\n        color: black;\n        font-size: 16px;\n        background-color: rgba(255, 255, 255, 0.9);\n        appearance: none;\n        background-image: url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="black" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.293 7.293a1 1 0 0 1 1.414 0L8 9.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-3 3a1 1 0 0 1-1.414 0l-3-3a1 1 0 0 1 0-1.414z"/></svg>\');\n        background-repeat: no-repeat;\n        background-position: right 10px center;\n        background-size: 16px;\n    }\n\n    #account-select:focus {\n        outline: none;\n        border-color: #007bff;\n        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);\n    }\n    ',document.head.appendChild(e);const t=document.createElement("button");function o(){const e=function(){const e=new Date,t=new Date(e.setDate(e.getDate()-1));return{startDate:new Date(e.setDate(e.getDate()-89)).toISOString().split("T")[0]+"T00:00:00.000Z",endDate:t.toISOString().split("T")[0]+"T23:59:59.999Z"}}();console.log("Otwieram modal i ładuję konta...");const t=document.createElement("div");t.id="modal";const o=document.createElement("div");o.id="modal-content";const n=document.createElement("button");n.innerText="✖",n.classList.add("close-button"),n.onclick=function(){document.body.removeChild(t)};const a=document.querySelector("account-filter");if(console.log("Sprawdzam element account-filter:",a),a){const r=a.querySelectorAll("option");console.log("Znaleziono opcje kont:",r.length);const i=document.createElement("select");i.id="account-select",r.forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.textContent,i.appendChild(t)})),o.appendChild(i),console.log("Dodano pole wyboru kont do modala.");const c=document.createElement("button");c.innerText="Pobierz",c.classList.add("modal-button","fetch-button");let s=[],l=[];c.onclick=async function(){const t=i.value;if(t)try{const n=await fetch("https://edge.allegro.pl/analytics/reports/sale/bycategory",{headers:{accept:"application/vnd.allegro.internal.v1+json","accept-language":"pl-PL","content-type":"application/vnd.allegro.internal.v1+json",priority:"u=1, i","sec-ch-ua":'"Chromium";v="130", "Google Chrome";v="130", "Not?A_Brand";v="99"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site"},referrer:"https://allegro.pl/",referrerPolicy:"strict-origin-when-cross-origin",body:JSON.stringify({sellerIds:[t],skip:0,take:1e3,marketplaceIds:["allegro-pl"],startDate:e.startDate,endDate:e.endDate,reportCode:"LASTFULL7DAYS"}),method:"POST",mode:"cors",credentials:"include"});if(!n.ok)throw new Error("Network response was not ok: "+n.statusText);const a=await n.json();console.log(a),alert("Wszystko w porządku, teraz pobierz dane dzienne");const r=a.result.entries;if(r&&Array.isArray(r)){const e=r.sort(((e,t)=>t.saleParticipation.sale-e.saleParticipation.sale)).slice(0,10).map((e=>e.category.id));console.log("Top 10 kategorii pod względem wartości sale w saleParticipation:"),console.log(e);const t=document.createElement("button");t.innerText="Pobierz dane kategorii",t.classList.add("modal-button","next-fetch-button"),t.onclick=async function(){const{startDate:t,endDate:o}=function(){const e=new Date;e.setDate(1),e.setHours(0,0,0,0);const t=new Date(e);return t.setMonth(e.getMonth()-13),t.setDate(2),{startDate:t.toISOString().split("T")[0],endDate:e.toISOString().split("T")[0]}}();function n(e){return new Promise((t=>setTimeout(t,e)))}l=[],s=[];for(let a=0;a<10;a++){const r=e[a];try{const e=await fetch("https://edge.allegro.pl/analytics/reports/sale/byday",{headers:{accept:"application/vnd.allegro.internal.v1+json","accept-language":"pl-PL","content-type":"application/vnd.allegro.internal.v1+json",priority:"u=1, i","sec-ch-ua":'"Chromium";v="130", "Google Chrome";v="130", "Not?A_Brand";v="99"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site"},referrer:"https://allegro.pl/",referrerPolicy:"strict-origin-when-cross-origin",body:JSON.stringify({includePhrasesMode:"OfferOrProduct",excludePhrasesMode:"OfferOrProduct",categories:[r],categoryId:r,sellerIds:[],includeCancelledAndReturned:!0,marketplaceIds:["allegro-pl"],periods:[{startDate:t+"T00:00:00.000Z",endDate:o+"T00:00:00.000Z"}],reportCode:"LASTFULL7DAYS"}),method:"POST",mode:"cors",credentials:"include"});if(!e.ok)throw new Error("Network response was not ok: "+e.statusText);const n=await e.json();console.log("Otrzymane dane:",n);const a=n.result.saleAggregations;if("object"==typeof a&&null!==a){for(const[e,t]of Object.entries(a))l.push({categoryId:r,date:e,saleParticipation:t.saleParticipation.sale});console.log(`Dane dzienne pobrane dla kategorii ${r}:`,l);const e=Object.entries(a).map((([e,t])=>({categoryId:r,date:e,saleParticipation:t.saleParticipation.sale})));s.push(...e),console.log(`Sformatowane dane dla kategorii ${r}:`,e)}else console.error("Oczekiwana tablica, ale otrzymano: "+typeof a,a)}catch(e){console.error(`Błąd podczas pobierania danych dziennych dla kategorii ${r}:`,e),alert(`Wystąpił błąd podczas pobierania danych dziennych dla kategorii ${r}.`)}const i=Math.floor(500*Math.random())+1e3;await n(i)}console.log("Zebrane dane dzienne:",l),console.log("Dane do eksportu:",s),alert("Wszystko ok, możesz pobrać plik Excel")},o.appendChild(t)}else console.error("Brak danych do pobrania top 10 kategorii.");const i=document.createElement("button");i.innerText="Pobierz Excel",i.classList.add("modal-button","excel-button"),i.onclick=function(){if(!r||!Array.isArray(r))return void alert("Brak danych do pobrania w formacie Excel.");console.log("Zawartość dailyDataCollection:",l);const e=XLSX.utils.book_new(),t=r.map((e=>({"ID kategorii":e.category.id,"Nazwa kategorii":e.category.name,"Wartość sprzedaży":isNaN(e.overallSale.sale)?0:e.overallSale.sale,"Udział sprzedaży (%)":isNaN(e.saleParticipation.sale)?"0%":(100*e.saleParticipation.sale).toFixed(2)+"%"}))),o=XLSX.utils.json_to_sheet(t);XLSX.utils.book_append_sheet(e,o,"Dane");const n=new Set,a={};l.forEach((e=>{const t=e.categoryId,o=new Date(e.date),r=o.getMonth()+1,i=o.getFullYear(),c=`${String(r).padStart(2,"0")}.${i}`;n.add(c),a[t]||(a[t]={}),a[t][c]=(a[t][c]||0)+(isNaN(e.saleParticipation)?0:e.saleParticipation)}));const i=Array.from(n).sort(((e,t)=>new Date(e)-new Date(t))),c=[["ID kategorii",...i]];Object.entries(a).forEach((([e,t])=>{const o=[e];i.forEach((e=>{o.push(t[e]||0)})),c.push(o)}));const s=XLSX.utils.aoa_to_sheet(c);XLSX.utils.book_append_sheet(e,s,"Kategorie");const d=[["ID kategorii",...i]];Object.entries(a).forEach((([e,t])=>{const o=Math.max(...Object.values(t)),n=[e];i.forEach((e=>{const a=t[e]||0,r=o>0?(a/o*100).toFixed(2)+"%":"0%";n.push(r)})),d.push(n)}));const p=XLSX.utils.aoa_to_sheet(d);XLSX.utils.book_append_sheet(e,p,"Trendy Kategorii"),XLSX.writeFile(e,"dane.xlsx"),alert("Plik Excel został wygenerowany.")},o.appendChild(i)}catch(e){console.error("Błąd podczas pobierania danych:",e),alert("Wystąpił błąd podczas pobierania danych.")}else alert("Proszę wybrać konto.")},o.appendChild(c),o.appendChild(n),t.appendChild(o),document.body.appendChild(t)}else console.error("Element account-filter nie został znaleziony."),alert("Poczekaj Pan, daj się załadować")}t.id="download-button",t.innerText="Pobierz dane",document.body.appendChild(t);const n=document.createElement("script");n.src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",n.onload=function(){console.log("Biblioteka XLSX została załadowana."),t.onclick=o},document.head.appendChild(n)}();