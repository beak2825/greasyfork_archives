// ==UserScript==
// @name         DDDD OCR WEB - éªŒè¯ç è‡ªåŠ¨è¯†åˆ«
// @namespace    https://github.com/MakotoArai-CN/ddddocr-webjs
// @version      1.0.2-beta-build1764699797247
// @author       MakotoArai-CN
// @description  è‡ªåŠ¨æ£€æµ‹å¹¶è¯†åˆ«é¡µé¢éªŒè¯ç ï¼Œè‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†ã€‚é¦–æ¬¡ä½¿ç”¨éœ€è®¾ç½®ç™½åå•ï¼Œä¼šè‡ªåŠ¨ä¸‹è½½çº¦50MBæ¨¡å‹æ–‡ä»¶ä»¥åŠ20MBå·¦å³çš„ONNXæ¨ç†è¿è¡Œæ—¶æ–‡ä»¶ï¼Œä½†æ˜¯ä¸æ¨èè‡ªåŠ¨ä¸‹è½½ï¼Œå¯èƒ½å¾ˆæ…¢ï¼Œå»ºè®®æ‰‹åŠ¨ä¸‹è½½å¹¶ä¸Šä¼ ï¼ˆè¯¦è§é¡¹ç›®æ–‡æ¡£ï¼‰ã€‚å¦‚æœå¼¹å‡ºçª—å£æç¤ºæˆæƒè¯·æˆæƒç»™è„šæœ¬ã€‚
// @license      MIT
// @icon         data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">ğŸ”¤</text></svg>
// @match        *://*/*
// @require      https://cdnjs.cloudflare.com/ajax/libs/onnxruntime-web/1.17.0/ort.min.js
// @connect      cdn.jsdelivr.net
// @connect      unpkg.com
// @connect      cdnjs.cloudflare.com
// @connect      fastly.jsdelivr.net
// @connect      registry.npmmirror.com
// @connect      raw.githubusercontent.com
// @connect      ghproxy.com
// @connect      ghfast.top
// @connect      mirror.ghproxy.com
// @connect      raw.kkgithub.com
// @connect      github.moeyy.xyz
// @connect      ghps.cc
// @connect      cors.isteed.cc
// @connect      raw.githubusercontents.com
// @grant        GM_getValue
// @grant        GM_notification
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @downloadURL https://update.greasyfork.org/scripts/557678/DDDD%20OCR%20WEB%20-%20%E9%AA%8C%E8%AF%81%E7%A0%81%E8%87%AA%E5%8A%A8%E8%AF%86%E5%88%AB.user.js
// @updateURL https://update.greasyfork.org/scripts/557678/DDDD%20OCR%20WEB%20-%20%E9%AA%8C%E8%AF%81%E7%A0%81%E8%87%AA%E5%8A%A8%E8%AF%86%E5%88%AB.meta.js
// ==/UserScript==

(function () {
	'use strict';

	const t={MODEL_VERSION:"1.0.2",MODEL_REPO:"MakotoArai-CN/ddddocr-webjs",MODEL_BRANCH:"main",MODEL_PATH:"public/common.onnx",CHARSETS_PATH:"public/charsets.json",WASM_VERSION:"1.17.0",CACHE_DURATION:2592e6,CAPTCHA_KEYWORDS:["captcha","verify","code","vcode","authcode","éªŒè¯ç ","checkcode","yzm","capimg","signCaptcha"],MIN_CAPTCHA_WIDTH:40,MIN_CAPTCHA_HEIGHT:20,MAX_CAPTCHA_WIDTH:500,MAX_CAPTCHA_HEIGHT:200,AUTO_DETECT_INTERVAL:2e3,GITHUB_MIRRORS:["https://raw.githubusercontent.com","https://ghproxy.com/https://raw.githubusercontent.com","https://ghfast.top/https://raw.githubusercontent.com","https://mirror.ghproxy.com/https://raw.githubusercontent.com","https://raw.kkgithub.com","https://github.moeyy.xyz/https://raw.githubusercontent.com","https://ghps.cc/https://raw.githubusercontent.com","https://cors.isteed.cc/github.com/J3n5en/ddddocr-js/raw/main","https://raw.githubusercontents.com"],CDN_SOURCES:["https://cdn.jsdelivr.net","https://unpkg.com","https://cdnjs.cloudflare.com","https://fastly.jsdelivr.net","https://registry.npmmirror.com"]},e={autoDetect:false,captchaSelector:"",inputSelector:"",useLocalModel:false,localModelPath:"",localCharsetsPath:"",autoDownload:true,enableWhitelist:true,whitelist:[],useUploadedModel:false,enableSlideCaptcha:false,enableRotateCaptcha:false,enableClickCaptcha:false,slideDebugMode:false},n="ddddocr_config";function getConfig(){const t=GM_getValue(n);return t?{...e,...t}:e}function saveConfig(t){const e=getConfig();GM_setValue(n,{...e,...t});}function isWhitelisted(){const t=getConfig();if(!t.enableWhitelist)return  true;if(!t.whitelist||0===t.whitelist.length)return  false;const e=window.location.hostname;return t.whitelist.some(t=>new RegExp("^"+t.replace(/\*/g,".*")+"$","i").test(e))}function shouldExecuteScript(){const t=getConfig();if(t.enableWhitelist){if(!t.whitelist||0===t.whitelist.length)return  false;if(!isWhitelisted())return  false}return  true}const i="ddddocr_model_cache",o="ddddocr_uploaded_model";class ModelCache{constructor(){this.dbName="DdddOCRDB",this.storeName="modelStore",this.db=null;}async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onerror=()=>e(n.error),n.onsuccess=()=>{this.db=n.result,t();},n.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.storeName)||e.createObjectStore(this.storeName);};})}async get(){return this.db||await this.init(),new Promise((e,n)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(i);o.onerror=()=>n(o.error),o.onsuccess=()=>{const n=o.result;if(n)return Date.now()-n.timestamp>t.CACHE_DURATION||n.version!==t.MODEL_VERSION?(this.delete(),void e(null)):void e(n);e(null);};})}async set(e,n){this.db||await this.init();const o={model:e,charsets:n,timestamp:Date.now(),version:t.MODEL_VERSION};return new Promise((t,e)=>{const n=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(o,i);n.onerror=()=>e(n.error),n.onsuccess=()=>t();})}async delete(){return this.db||await this.init(),new Promise((t,e)=>{const n=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(i);n.onerror=()=>e(n.error),n.onsuccess=()=>t();})}async getUploadedModel(){return this.db||await this.init(),new Promise((t,e)=>{const n=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(o);n.onerror=()=>e(n.error),n.onsuccess=()=>{t(n.result||null);};})}async setUploadedModel(t,e){this.db||await this.init();const n={model:t,charsets:e,timestamp:Date.now(),version:"uploaded"};return new Promise((t,e)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(n,o);i.onerror=()=>e(i.error),i.onsuccess=()=>t();})}async deleteUploadedModel(){return this.db||await this.init(),new Promise((t,e)=>{const n=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(o);n.onerror=()=>e(n.error),n.onsuccess=()=>t();})}}function downloadFile(t,e=3e4){return new Promise((n,i)=>{GM_xmlhttpRequest({method:"GET",url:t,responseType:"arraybuffer",timeout:e,headers:{"Cache-Control":"max-age=2592000"},onload:t=>{200===t.status?n(t.response):i(new Error(`HTTP ${t.status}`));},onerror:t=>i(t),ontimeout:()=>i(new Error("ä¸‹è½½è¶…æ—¶"))});})}function downloadJSON(t,e=3e4){return new Promise((n,i)=>{GM_xmlhttpRequest({method:"GET",url:t,responseType:"json",timeout:e,headers:{"Cache-Control":"max-age=2592000"},onload:t=>{200===t.status?n(t.response):i(new Error(`HTTP ${t.status}`));},onerror:t=>i(t),ontimeout:()=>i(new Error("ä¸‹è½½è¶…æ—¶"))});})}function buildURL(e,n){return e.includes("jsdelivr")?`${e}/${t.MODEL_REPO}@${t.MODEL_BRANCH}/${n}`:`${e}/${t.MODEL_REPO}/${t.MODEL_BRANCH}/${n}`}class ImageProcessor{static extractImageFromElement(t){const e=document.createElement("canvas");e.width=t.naturalWidth||t.width,e.height=t.naturalHeight||t.height;const n=e.getContext("2d");n.fillStyle="#FFFFFF",n.fillRect(0,0,e.width,e.height),n.drawImage(t,0,0);const i=n.getImageData(0,0,e.width,e.height);return {data:this.toGrayscale(i.data),width:e.width,height:e.height}}static async loadImage(t){if(t instanceof HTMLImageElement)return this.extractImageFromElement(t);const e=new Image;if(e.crossOrigin="anonymous","string"==typeof t)try{const n=await this.fetchImageAsBlob(t);e.src=URL.createObjectURL(n);}catch(r){e.src=t;}else e.src=URL.createObjectURL(t);await new Promise((t,n)=>{e.onload=t,e.onerror=()=>n(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥")),setTimeout(()=>n(new Error("å›¾ç‰‡åŠ è½½è¶…æ—¶")),1e4);});const n=document.createElement("canvas");n.width=e.width,n.height=e.height;const i=n.getContext("2d");i.fillStyle="#FFFFFF",i.fillRect(0,0,e.width,e.height),i.drawImage(e,0,0);const o=i.getImageData(0,0,e.width,e.height),s=this.toGrayscale(o.data);return "string"!=typeof t&&URL.revokeObjectURL(e.src),{data:s,width:e.width,height:e.height}}static fetchImageAsBlob(t){return new Promise((e,n)=>{GM_xmlhttpRequest({method:"GET",url:t,responseType:"blob",headers:{Referer:window.location.href},timeout:1e4,onload:t=>{200===t.status?e(t.response):n(new Error(`HTTP ${t.status}`));},onerror:n,ontimeout:()=>n(new Error("è·å–å›¾ç‰‡è¶…æ—¶"))});})}static toGrayscale(t){const e=new Uint8ClampedArray(t.length/4);for(let n=0;n<t.length;n+=4){const i=t[n],o=t[n+1],s=t[n+2],r=t[n+3]/255,a=i*r+255*(1-r),d=o*r+255*(1-r),c=s*r+255*(1-r);e[n/4]=Math.round(.2126*a+.7152*d+.0722*c);}return e}static resize(t,e,n,i,o){const s=new Uint8ClampedArray(i*o),r=e/i,a=n/o;for(let d=0;d<o;d++)for(let o=0;o<i;o++){const c=o*r,l=d*a,h=Math.floor(c),u=Math.min(h+1,e-1),m=Math.floor(l),g=Math.min(m+1,n-1),p=c-h,f=l-m,b=t[m*e+h]*(1-p)*(1-f)+t[m*e+u]*p*(1-f)+t[g*e+h]*(1-p)*f+t[g*e+u]*p*f;s[d*i+o]=Math.round(b);}return s}static normalize(t){const e=new Float32Array(t.length);for(let n=0;n<t.length;n++)e[n]=t[n]/255;return e}}const s=t.CDN_SOURCES.map(e=>e.includes("jsdelivr")?`${e}/npm/onnxruntime-web@${t.WASM_VERSION}/dist/`:e.includes("unpkg")?`${e}/onnxruntime-web@${t.WASM_VERSION}/dist/`:e.includes("cdnjs")?`${e}/ajax/libs/onnxruntime-web/${t.WASM_VERSION}/`:e.includes("npmmirror")?`${e}/onnxruntime-web/${t.WASM_VERSION}/files/dist/`:`${e}/onnxruntime-web@${t.WASM_VERSION}/dist/`),r=["ort-wasm.wasm","ort-wasm-simd.wasm","ort-wasm-threaded.wasm","ort-wasm-simd-threaded.wasm"],a=new class{constructor(){this.dbName="WASMCacheDB",this.storeName="wasmStore",this.db=null,this.memoryCache=new Map;}async init(){return new Promise((t,e)=>{const n=indexedDB.open(this.dbName,2);n.onerror=()=>e(n.error),n.onsuccess=()=>{this.db=n.result,t();},n.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.storeName)||e.createObjectStore(this.storeName);};})}async get(e){return this.memoryCache.has(e)?this.memoryCache.get(e):(this.db||await this.init(),new Promise((n,i)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);o.onerror=()=>i(o.error),o.onsuccess=()=>{const i=o.result;if(i){if(Date.now()-i.timestamp>t.CACHE_DURATION||i.version!==t.WASM_VERSION)return this.delete(e),void n(null);this.memoryCache.set(e,i.data),n(i.data);}else n(null);};}))}async set(e,n){this.db||await this.init(),this.memoryCache.set(e,n);const i={data:n,timestamp:Date.now(),version:t.WASM_VERSION};return new Promise((t,n)=>{const o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(i,e);o.onerror=()=>n(o.error),o.onsuccess=()=>{t();};})}async delete(t){return this.memoryCache.delete(t),this.db||await this.init(),new Promise((e,n)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(t);i.onerror=()=>n(i.error),i.onsuccess=()=>e();})}async clear(){return this.memoryCache.clear(),this.db||await this.init(),new Promise((t,e)=>{const n=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();n.onerror=()=>e(n.error),n.onsuccess=()=>{t();};})}};async function downloadWASM(t){for(let n=0;n<s.length;n++){const i=s[n]+t;try{return await new Promise((t,e)=>{GM_xmlhttpRequest({method:"GET",url:i,responseType:"arraybuffer",timeout:3e4,headers:{Accept:"application/wasm","Cache-Control":"max-age=2592000"},onload:n=>{200===n.status?t(n.response):e(new Error(`HTTP ${n.status}`));},onerror:e,ontimeout:()=>e(new Error("ä¸‹è½½è¶…æ—¶"))});})}catch(e){if(n===s.length-1)throw new Error(`æ‰€æœ‰ WASM CDN å‡ä¸‹è½½å¤±è´¥: ${t}`)}}throw new Error(`ä¸‹è½½ WASM å¤±è´¥: ${t}`)}class DdddOCR{constructor(){this.session=null,this.charsets=[],this.initialized=false,this.ort=null;}async init(){if(!this.initialized)try{if(await async function(){await a.init(),async function(){(await Promise.allSettled(r.map(async t=>{if(await a.get(t))return {filename:t,cached:!0};try{const e=await downloadWASM(t);return await a.set(t,e),{filename:t,cached:!1}}catch(e){return {filename:t,error:e}}}))).filter(t=>"fulfilled"===t.status).length;}().catch(t=>{});const t=window.fetch;window.fetch=async function(e,n){const i="string"==typeof e?e:e instanceof URL?e.href:e.url,o=r.find(t=>i.includes(t));if(!o)return t.call(this,e,n);try{let t=await a.get(o);return t||(t=await downloadWASM(o),a.set(o,t).catch(t=>{})),new Response(t,{status:200,headers:{"Content-Type":"application/wasm","Content-Length":String(t.byteLength)}})}catch(s){return t.call(this,e,n)}};}(),this.ort=await async function(){if("undefined"!=typeof ort)return ort;for(let e=0;e<100;e++){await new Promise(t=>setTimeout(t,100));try{if("undefined"!=typeof ort)return ort}catch(t){}}throw new Error("ç­‰å¾… ort è¶…æ—¶")}(),!this.ort)throw new Error("ONNX Runtime æœªæ‰¾åˆ°");this.ort.env.wasm.wasmPaths="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.17.0/dist/",this.ort.env.wasm.numThreads=1,this.ort.env.wasm.simd=!0,this.ort.env.logLevel="warning";const{model:e,charsets:n}=await async function(){const e=getConfig(),n=new ModelCache;if(e.useUploadedModel){const t=await n.getUploadedModel();if(t)return {model:t.model,charsets:t.charsets}}if(!e.autoDownload)throw new Error("è‡ªåŠ¨ä¸‹è½½å·²ç¦ç”¨ï¼Œè¯·ä¸Šä¼ æ¨¡å‹æ–‡ä»¶æˆ–å¯ç”¨è‡ªåŠ¨ä¸‹è½½");const i=await n.get();if(i)return {model:i.model,charsets:i.charsets};let o=null,s=null,r="";for(let d=0;d<t.GITHUB_MIRRORS.length;d++){const e=t.GITHUB_MIRRORS[d];try{const n=new URL(e.includes("raw.githubusercontent")?`https://${e.split("/")[2]}`:e).hostname,[i,a]=await Promise.all([downloadFile(buildURL(e,t.MODEL_PATH)),downloadJSON(buildURL(e,t.CHARSETS_PATH))]);o=i,s=a,r=n;break}catch(a){if(d===t.GITHUB_MIRRORS.length-1)throw new Error("æ‰€æœ‰é•œåƒå‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ä¸Šä¼ æ¨¡å‹æ–‡ä»¶")}}if(!o||!s)throw new Error("æ¨¡å‹ä¸‹è½½å¤±è´¥");return await n.set(o,s),"undefined"!=typeof GM_notification&&GM_notification({title:"DDDD OCR",text:`æ¨¡å‹ä¸‹è½½æˆåŠŸ (${r})`,timeout:3e3}),{model:o,charsets:s}}();this.charsets=n,this.session=await this.ort.InferenceSession.create(e,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),this.initialized=!0;}catch(e){throw e}}async recognize(t){this.initialized&&this.session||await this.init();try{HTMLImageElement,Date.now();const{data:e,width:n,height:i}=await ImageProcessor.loadImage(t),o=64,s=Math.floor(n*(o/i)),r=ImageProcessor.resize(e,n,i,s,o),a=ImageProcessor.normalize(r),d=new this.ort.Tensor("float32",a,[1,1,o,s]),c=(Date.now(),{input1:d}),l=(await this.session.run(c)).output;return {text:this.decodeOutput(l)}}catch(e){throw e}}convertToNumberArray(t){if(!t||!t.length)return [];const e=[];for(let n=0;n<t.length;n++){const i=t[n];"bigint"==typeof i?e.push(Number(i)):"number"==typeof i?e.push(Math.round(i)):e.push(0);}return e}decodeOutput(t){const e=this.convertToNumberArray(t.data),n=[];let i="";for(const o of e){if(o<=0||o>=this.charsets.length)continue;const t=this.charsets[o];t&&t!==i&&(n.push(t),i=t);}return n.join("")}async destroy(){this.session&&(await this.session.release(),this.session=null),this.initialized=false;}}class AutoDetector{constructor(t,e){this.observer=null,this.processedElements=new WeakMap,this.enabled=false,this.checkInterval=null,this.eventEmitter=null,this.ocr=t,this.eventEmitter=e||null;}start(){this.enabled||(this.enabled=true,this.detectExistingCaptchas(),this.observer=new MutationObserver(t=>{for(const e of t){if(e.addedNodes.forEach(t=>{t instanceof HTMLElement&&this.checkElement(t);}),"attributes"===e.type){const t=e.target;t instanceof HTMLElement&&(t instanceof HTMLImageElement&&"src"===e.attributeName?this.recheckImage(t):t instanceof HTMLCanvasElement?this.recheckCanvas(t):"style"===e.attributeName&&t.style.backgroundImage&&this.recheckDiv(t));}"childList"===e.type&&e.target instanceof SVGElement&&this.recheckSVG(e.target);}}),this.observer.observe(document.body,{childList:true,subtree:true,attributes:true,attributeFilter:["src","style","data-src","href"],characterData:true}),this.startIntervalCheck());}stop(){this.enabled&&(this.enabled=false,this.observer?.disconnect(),this.observer=null,this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null));}startIntervalCheck(){this.checkInterval=window.setInterval(()=>{document.querySelectorAll("canvas").forEach(t=>{this.isCaptchaCanvas(t)&&this.recheckCanvas(t);});},t.AUTO_DETECT_INTERVAL);}getElementHash(t){if(t instanceof HTMLImageElement)return t.src+"_"+t.naturalWidth+"_"+t.naturalHeight;if(t instanceof HTMLCanvasElement)try{return t.toDataURL()}catch(e){return "canvas_"+Date.now()}else {if(t instanceof SVGElement)return t.outerHTML;if(t instanceof HTMLElement&&t.style.backgroundImage)return t.style.backgroundImage}return ""}hasElementChanged(t){const e=this.getElementHash(t),n=this.processedElements.get(t);return !n||e!==n}markElementProcessed(t){const e=this.getElementHash(t);this.processedElements.set(t,e);}detectExistingCaptchas(){document.querySelectorAll("img").forEach(t=>this.checkImage(t)),document.querySelectorAll("canvas").forEach(t=>this.checkCanvas(t)),document.querySelectorAll("svg").forEach(t=>this.checkSVG(t)),document.querySelectorAll('div[style*="background"]').forEach(t=>this.checkDiv(t));}checkElement(t){t instanceof HTMLImageElement&&this.checkImage(t),t instanceof HTMLCanvasElement&&this.checkCanvas(t),t instanceof SVGElement&&this.checkSVG(t),t.style.backgroundImage&&this.checkDiv(t),t.querySelectorAll("img").forEach(t=>this.checkImage(t)),t.querySelectorAll("canvas").forEach(t=>this.checkCanvas(t)),t.querySelectorAll("svg").forEach(t=>this.checkSVG(t)),t.querySelectorAll('div[style*="background"]').forEach(t=>this.checkDiv(t));}async waitForImageLoad(t,e=5e3){return !!(t.complete&&t.naturalWidth>0)||new Promise(n=>{const i=setTimeout(()=>{cleanup(),n(false);},e),onLoad=()=>{cleanup(),n(true);},onError=()=>{cleanup(),n(false);},cleanup=()=>{clearTimeout(i),t.removeEventListener("load",onLoad),t.removeEventListener("error",onError);};t.addEventListener("load",onLoad),t.addEventListener("error",onError),t.complete&&t.naturalWidth>0&&(cleanup(),n(true));})}async recheckImage(t){await this.waitForImageLoad(t)&&t.complete&&t.naturalWidth&&t.naturalHeight&&await this.checkImage(t);}async recheckCanvas(t){await new Promise(t=>requestAnimationFrame(t)),await this.checkCanvas(t);}async recheckSVG(t){await new Promise(t=>requestAnimationFrame(t)),await this.checkSVG(t);}async recheckDiv(t){await new Promise(t=>requestAnimationFrame(t)),await this.checkDiv(t);}async checkImage(t){const e=getConfig();if(e.captchaSelector){if(!t.matches(e.captchaSelector))return}else if(!this.isCaptchaImage(t))return;if(!this.hasElementChanged(t))return;this.eventEmitter?.emit("detect:found",{element:t,type:"img"});const n=this.findNearbyInput(t);if(n&&n.value.trim()&&(n.value="",n.dispatchEvent(new Event("input",{bubbles:true})),n.dispatchEvent(new Event("change",{bubbles:true}))),await this.waitForImageLoad(t)&&t.naturalWidth&&t.naturalHeight)try{this.eventEmitter?.emit("recognize:start",{element:t});const e=await this.ocr.recognize(t);this.markElementProcessed(t),this.eventEmitter?.emit("recognize:complete",{element:t,result:e}),this.fillCaptcha(t,e.text);}catch(i){this.eventEmitter?.emit("recognize:error",{element:t,error:i});}}async checkCanvas(t){const e=getConfig();if(e.captchaSelector){if(!t.matches(e.captchaSelector))return}else if(!this.isCaptchaCanvas(t))return;if(!this.hasElementChanged(t))return;this.eventEmitter?.emit("detect:found",{element:t,type:"canvas"});const n=this.findNearbyInput(t);n&&n.value.trim()&&(n.value="",n.dispatchEvent(new Event("input",{bubbles:true})),n.dispatchEvent(new Event("change",{bubbles:true}))),await new Promise(t=>requestAnimationFrame(t));try{this.eventEmitter?.emit("recognize:start",{element:t});const e=await new Promise((e,n)=>{t.toBlob(t=>{t?e(t):n(new Error("Canvasè½¬æ¢å¤±è´¥"));},"image/png");}),n=await this.ocr.recognize(e);this.markElementProcessed(t),this.eventEmitter?.emit("recognize:complete",{element:t,result:n}),this.fillCaptcha(t,n.text);}catch(i){this.eventEmitter?.emit("recognize:error",{element:t,error:i});}}async checkSVG(t){const e=getConfig();if(e.captchaSelector){if(!t.matches(e.captchaSelector))return}else if(!this.isCaptchaSVG(t))return;if(!this.hasElementChanged(t))return;this.eventEmitter?.emit("detect:found",{element:t,type:"svg"});const n=this.findNearbyInput(t);n&&n.value.trim()&&(n.value="",n.dispatchEvent(new Event("input",{bubbles:true})),n.dispatchEvent(new Event("change",{bubbles:true})));try{this.eventEmitter?.emit("recognize:start",{element:t});const e=(new XMLSerializer).serializeToString(t),n=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),i=URL.createObjectURL(n),o=new Image;o.src=i,await new Promise((t,e)=>{o.onload=t,o.onerror=e,setTimeout(e,5e3);});const s=document.createElement("canvas");s.width=t.clientWidth||150,s.height=t.clientHeight||50,s.getContext("2d").drawImage(o,0,0),URL.revokeObjectURL(i);const r=await new Promise((t,e)=>{s.toBlob(n=>{n?t(n):e(new Error("SVGè½¬æ¢å¤±è´¥"));},"image/png");}),a=await this.ocr.recognize(r);this.markElementProcessed(t),this.eventEmitter?.emit("recognize:complete",{element:t,result:a}),this.fillCaptcha(t,a.text);}catch(i){this.eventEmitter?.emit("recognize:error",{element:t,error:i});}}async checkDiv(t){const e=getConfig();if(e.captchaSelector){if(!t.matches(e.captchaSelector))return}else if(!this.isCaptchaDiv(t))return;const n=t.style.backgroundImage;if(!n)return;if(!this.hasElementChanged(t))return;this.eventEmitter?.emit("detect:found",{element:t,type:"div"});const i=this.findNearbyInput(t);i&&i.value.trim()&&(i.value="",i.dispatchEvent(new Event("input",{bubbles:true})),i.dispatchEvent(new Event("change",{bubbles:true})));try{this.eventEmitter?.emit("recognize:start",{element:t});const e=n.match(/url\(['"]?(.+?)['"]?\)/);if(!e)return;const i=e[1];if(i.startsWith("data:")){const e=i.split(",")[1],n=atob(e),o=new Uint8Array(n.length);for(let t=0;t<n.length;t++)o[t]=n.charCodeAt(t);const s=new Blob([o],{type:"image/png"}),r=await this.ocr.recognize(s);this.markElementProcessed(t),this.eventEmitter?.emit("recognize:complete",{element:t,result:r}),this.fillCaptcha(t,r.text);}else {const e=await this.ocr.recognize(i);this.markElementProcessed(t),this.eventEmitter?.emit("recognize:complete",{element:t,result:e}),this.fillCaptcha(t,e.text);}}catch(o){this.eventEmitter?.emit("recognize:error",{element:t,error:o});}}isCaptchaImage(e){const n=e.naturalWidth||e.width,i=e.naturalHeight||e.height;if(n<t.MIN_CAPTCHA_WIDTH||i<t.MIN_CAPTCHA_HEIGHT)return  false;if(n>t.MAX_CAPTCHA_WIDTH||i>t.MAX_CAPTCHA_HEIGHT)return  false;const o=(e.src+e.className+e.id+e.alt+(e.getAttribute("data-src")||"")).toLowerCase();return t.CAPTCHA_KEYWORDS.some(t=>o.includes(t))}isCaptchaCanvas(e){const n=e.width,i=e.height;if(n<t.MIN_CAPTCHA_WIDTH||i<t.MIN_CAPTCHA_HEIGHT)return  false;if(n>t.MAX_CAPTCHA_WIDTH||i>t.MAX_CAPTCHA_HEIGHT)return  false;const o=(e.className+e.id+(e.getAttribute("data-type")||"")).toLowerCase();return t.CAPTCHA_KEYWORDS.some(t=>o.includes(t))}isCaptchaSVG(e){const n=e.clientWidth||parseInt(e.getAttribute("width")||"0"),i=e.clientHeight||parseInt(e.getAttribute("height")||"0");if(n<t.MIN_CAPTCHA_WIDTH||i<t.MIN_CAPTCHA_HEIGHT)return  false;if(n>t.MAX_CAPTCHA_WIDTH||i>t.MAX_CAPTCHA_HEIGHT)return  false;const o=(e.className.baseVal+e.id).toLowerCase();return t.CAPTCHA_KEYWORDS.some(t=>o.includes(t))}isCaptchaDiv(e){const n=e.clientWidth,i=e.clientHeight;if(n<t.MIN_CAPTCHA_WIDTH||i<t.MIN_CAPTCHA_HEIGHT)return  false;if(n>t.MAX_CAPTCHA_WIDTH||i>t.MAX_CAPTCHA_HEIGHT)return  false;const o=(e.className+e.id).toLowerCase();return t.CAPTCHA_KEYWORDS.some(t=>o.includes(t))}fillCaptcha(t,e){const n=getConfig();let i=null;n.inputSelector&&(i=document.querySelector(n.inputSelector)),i||(i=this.findNearbyInput(t)),i&&(i.value=e,i.dispatchEvent(new Event("input",{bubbles:true})),i.dispatchEvent(new Event("change",{bubbles:true})),this.highlightInput(i),"undefined"!=typeof GM_notification&&GM_notification({title:"éªŒè¯ç å·²è‡ªåŠ¨å¡«å……",text:`è¯†åˆ«ç»“æœ: ${e}`,timeout:3e3}));}findNearbyInput(t){const e=t.closest("form");if(e){const t=e.querySelectorAll('input[type="text"], input[type="password"], input:not([type])');for(const e of t)if(this.isLikelyCaptchaInput(e))return e}let n=t.parentElement;for(let a=0;a<5&&n;a++){const t=n.querySelectorAll('input[type="text"], input[type="password"], input:not([type])');for(const e of t)if(this.isLikelyCaptchaInput(e))return e;n=n.parentElement;}const i=document.querySelectorAll('input[type="text"], input[type="password"], input:not([type])');let o=null,s=Infinity;const r=t.getBoundingClientRect();for(const a of i){if(!this.isLikelyCaptchaInput(a))continue;const t=a.getBoundingClientRect(),e=Math.sqrt(Math.pow(t.left-r.left,2)+Math.pow(t.top-r.top,2));e<s&&(s=e,o=a);}return o}isLikelyCaptchaInput(e){const n=(e.name+e.id+e.className+e.placeholder).toLowerCase();return t.CAPTCHA_KEYWORDS.some(t=>n.includes(t))}highlightInput(t){const e=t.style.cssText;t.style.cssText+="\n      transition: all 0.3s ease;\n      box-shadow: 0 0 10px rgba(255, 105, 180, 0.8);\n      border-color: #FF69B4 !important;\n    ",setTimeout(()=>{t.style.cssText=e;},2e3);}}const d=class{static injectStyles(){if(this.stylesInjected)return;const t=document.createElement("style");t.textContent="\n      .ddddocr-dialog-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        background: rgba(0, 0, 0, 0.5);\n        z-index: 2147483647;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        animation: ddddocr-fade-in 0.3s ease;\n      }\n\n      .ddddocr-dialog {\n        background: white;\n        border-radius: 16px;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n        max-width: 500px;\n        width: 90%;\n        max-height: 80vh;\n        overflow: hidden;\n        animation: ddddocr-scale-in 0.3s ease;\n      }\n\n      .ddddocr-dialog-header {\n        background: #4A90E2;\n        color: white;\n        padding: 20px 24px;\n        font-size: 18px;\n        font-weight: 600;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n      }\n\n      .ddddocr-dialog-body {\n        padding: 24px;\n        max-height: calc(80vh - 140px);\n        overflow-y: auto;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      }\n\n      .ddddocr-dialog-content {\n        color: #333;\n        font-size: 14px;\n        line-height: 1.6;\n        white-space: pre-wrap;\n      }\n\n      .ddddocr-dialog-footer {\n        padding: 16px 24px;\n        border-top: 1px solid #E8F0FE;\n        display: flex;\n        justify-content: flex-end;\n        gap: 12px;\n      }\n\n      .ddddocr-dialog-button {\n        padding: 10px 24px;\n        border: none;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 0.3s;\n      }\n\n      .ddddocr-dialog-button.primary {\n        background: #4A90E2;\n        color: white;\n      }\n\n      .ddddocr-dialog-button.primary:hover {\n        background: #357ABD;\n      }\n\n      .ddddocr-dialog-button.secondary {\n        background: #E8F0FE;\n        color: #4A90E2;\n      }\n\n      .ddddocr-dialog-button.secondary:hover {\n        background: #D0E2F5;\n      }\n\n      @keyframes ddddocr-fade-in {\n        from { opacity: 0; }\n        to { opacity: 1; }\n      }\n\n      @keyframes ddddocr-scale-in {\n        from {\n          opacity: 0;\n          transform: scale(0.9);\n        }\n        to {\n          opacity: 1;\n          transform: scale(1);\n        }\n      }\n    ",document.head.appendChild(t),this.stylesInjected=true;}static show(t){this.injectStyles(),this.close();const e=document.createElement("div");e.className="ddddocr-dialog-overlay";const n=document.createElement("div");n.className="ddddocr-dialog",n.innerHTML=`\n      <div class="ddddocr-dialog-header">\n        ${t.icon||"â„¹ï¸"} ${t.title}\n      </div>\n      <div class="ddddocr-dialog-body">\n        <div class="ddddocr-dialog-content">${t.content}</div>\n      </div>\n      <div class="ddddocr-dialog-footer">\n        <button class="ddddocr-dialog-button primary">\n          ${t.confirmText||"ç¡®å®š"}\n        </button>\n      </div>\n    `,e.appendChild(n),document.body.appendChild(e),this.container=e;const i=n.querySelector(".ddddocr-dialog-button");i?.addEventListener("click",()=>{t.onConfirm?.(),this.close();}),e.addEventListener("click",t=>{t.target===e&&this.close();});}static confirm(t){this.injectStyles(),this.close();const e=document.createElement("div");e.className="ddddocr-dialog-overlay";const n=document.createElement("div");n.className="ddddocr-dialog",n.innerHTML=`\n      <div class="ddddocr-dialog-header">\n        ${t.icon||"â“"} ${t.title}\n      </div>\n      <div class="ddddocr-dialog-body">\n        <div class="ddddocr-dialog-content">${t.content}</div>\n      </div>\n      <div class="ddddocr-dialog-footer">\n        <button class="ddddocr-dialog-button secondary cancel-btn">\n          ${t.cancelText||"å–æ¶ˆ"}\n        </button>\n        <button class="ddddocr-dialog-button primary confirm-btn">\n          ${t.confirmText||"ç¡®å®š"}\n        </button>\n      </div>\n    `,e.appendChild(n),document.body.appendChild(e),this.container=e;const i=n.querySelector(".confirm-btn"),o=n.querySelector(".cancel-btn");i?.addEventListener("click",()=>{t.onConfirm?.(),this.close();}),o?.addEventListener("click",()=>{t.onCancel?.(),this.close();}),e.addEventListener("click",n=>{n.target===e&&(t.onCancel?.(),this.close());});}static close(){this.container?.remove(),this.container=null;}};d.container=null,d.stylesInjected=false;let c=d;class SettingsUI{constructor(){this.container=null,this.isVisible=false,this.onConfigChange=()=>{},this.createStyles();}createStyles(){const t=document.createElement("style");t.textContent="\n      .ddddocr-settings-container {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 480px;\n        max-height: 80vh;\n        background: #FFFFFF;\n        border-radius: 16px;\n        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);\n        z-index: 2147483647;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n        overflow: hidden;\n        display: none;\n      }\n      .ddddocr-settings-header {\n        background: #4A90E2;\n        color: white;\n        padding: 20px 24px;\n        font-size: 18px;\n        font-weight: 600;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      }\n      .ddddocr-settings-close {\n        width: 32px;\n        height: 32px;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, 0.2);\n        border: none;\n        color: white;\n        font-size: 20px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: background 0.3s;\n      }\n      .ddddocr-settings-close:hover {\n        background: rgba(255, 255, 255, 0.3);\n      }\n      .ddddocr-settings-body {\n        padding: 24px;\n        max-height: calc(80vh - 80px);\n        overflow-y: auto;\n      }\n      .ddddocr-setting-group {\n        margin-bottom: 24px;\n        padding: 16px;\n        background: #F8FBFF;\n        border-radius: 12px;\n        border: 1px solid #E8F0FE;\n      }\n      .ddddocr-setting-group-title {\n        font-size: 14px;\n        font-weight: 600;\n        color: #4A90E2;\n        margin-bottom: 12px;\n        text-transform: uppercase;\n        letter-spacing: 0.5px;\n      }\n      .ddddocr-setting-item {\n        margin-bottom: 16px;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n      }\n      .ddddocr-setting-item:last-child {\n        margin-bottom: 0;\n      }\n      .ddddocr-setting-label {\n        font-size: 14px;\n        color: #333;\n        flex: 1;\n      }\n      .ddddocr-setting-desc {\n        font-size: 12px;\n        color: #666;\n        margin-top: 4px;\n      }\n      .ddddocr-switch {\n        position: relative;\n        width: 48px;\n        height: 24px;\n        background: #CBD5E0;\n        border-radius: 12px;\n        cursor: pointer;\n        transition: background 0.3s;\n      }\n      .ddddocr-switch.active {\n        background: #FF69B4;\n      }\n      .ddddocr-switch-slider {\n        position: absolute;\n        top: 2px;\n        left: 2px;\n        width: 20px;\n        height: 20px;\n        background: white;\n        border-radius: 50%;\n        transition: transform 0.3s;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n      }\n      .ddddocr-switch.active .ddddocr-switch-slider {\n        transform: translateX(24px);\n      }\n      .ddddocr-input {\n        padding: 8px 12px;\n        border: 2px solid #E8F0FE;\n        border-radius: 8px;\n        font-size: 14px;\n        width: 100%;\n        margin-top: 8px;\n        transition: border-color 0.3s;\n      }\n      .ddddocr-input:focus {\n        outline: none;\n        border-color: #4A90E2;\n      }\n      .ddddocr-file-input {\n        display: none;\n      }\n      .ddddocr-file-label {\n        display: inline-block;\n        padding: 8px 16px;\n        background: #E8F0FE;\n        color: #4A90E2;\n        border-radius: 8px;\n        font-size: 13px;\n        cursor: pointer;\n        transition: background 0.3s;\n        margin-top: 8px;\n      }\n      .ddddocr-file-label:hover {\n        background: #D0E2F5;\n      }\n      .ddddocr-file-name {\n        font-size: 12px;\n        color: #666;\n        margin-top: 6px;\n      }\n      .ddddocr-textarea {\n        padding: 8px 12px;\n        border: 2px solid #E8F0FE;\n        border-radius: 8px;\n        font-size: 14px;\n        width: 100%;\n        margin-top: 8px;\n        min-height: 80px;\n        resize: vertical;\n        font-family: 'Courier New', monospace;\n        transition: border-color 0.3s;\n      }\n      .ddddocr-textarea:focus {\n        outline: none;\n        border-color: #4A90E2;\n      }\n      .ddddocr-button {\n        padding: 10px 20px;\n        background: #4A90E2;\n        color: white;\n        border: none;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: background 0.3s;\n      }\n      .ddddocr-button:hover {\n        background: #357ABD;\n      }\n      .ddddocr-button.secondary {\n        background: #FF69B4;\n      }\n      .ddddocr-button.secondary:hover {\n        background: #FF1493;\n      }\n      .ddddocr-button.danger {\n        background: #E74C3C;\n      }\n      .ddddocr-button.danger:hover {\n        background: #C0392B;\n      }\n      .ddddocr-button-group {\n        display: flex;\n        gap: 12px;\n        margin-top: 16px;\n      }\n      .ddddocr-info {\n        padding: 12px;\n        background: #FFF0F5;\n        border: 1px solid #FFB6C1;\n        border-radius: 8px;\n        font-size: 12px;\n        color: #666;\n        margin-top: 12px;\n      }\n      .ddddocr-settings-visible {\n        display: block !important;\n        animation: ddddocr-fade-in 0.3s ease;\n      }\n      @keyframes ddddocr-fade-in {\n        from {\n          opacity: 0;\n          transform: translate(-50%, -50%) scale(0.9);\n        }\n        to {\n          opacity: 1;\n          transform: translate(-50%, -50%) scale(1);\n        }\n      }\n    ",document.head.appendChild(t);}async createContainer(){this.container=document.createElement("div"),this.container.className="ddddocr-settings-container";const t=getConfig(),e=new ModelCache,n=await e.getUploadedModel(),i=!!n;this.container.innerHTML=`\n      <div class="ddddocr-settings-header">\n        <span>ğŸ”§ DDDD OCR è®¾ç½®</span>\n        <button class="ddddocr-settings-close">Ã—</button>\n      </div>\n      <div class="ddddocr-settings-body">\n        <div class="ddddocr-setting-group">\n          <div class="ddddocr-setting-group-title">æ¨¡å‹è®¾ç½®</div>\n          \n          ${i?`\n          <div class="ddddocr-info" style="background: #E8F5E9; border-color: #4CAF50; margin-bottom: 12px;">\n            âœ… å·²ä¸Šä¼ æ¨¡å‹: ${(n.model.byteLength/1024/1024).toFixed(2)} MB\n          </div>\n          `:""}\n          \n          <div class="ddddocr-setting-item">\n            <div>\n              <div class="ddddocr-setting-label">ä½¿ç”¨ä¸Šä¼ çš„æ¨¡å‹</div>\n              <div class="ddddocr-setting-desc">ä¸Šä¼  common.onnx å’Œ charsets.json</div>\n            </div>\n            <div class="ddddocr-switch ${t.useUploadedModel?"active":""}" data-setting="useUploadedModel">\n              <div class="ddddocr-switch-slider"></div>\n            </div>\n          </div>\n          <div id="uploadModelArea" style="display: ${t.useUploadedModel?"block":"none"}">\n            <label class="ddddocr-file-label">\n              ğŸ“ é€‰æ‹©æ¨¡å‹æ–‡ä»¶ (common.onnx)\n              <input type="file" class="ddddocr-file-input" id="modelFileInput" accept=".onnx">\n            </label>\n            <div class="ddddocr-file-name" id="modelFileName">æœªé€‰æ‹©æ–‡ä»¶</div>\n            <label class="ddddocr-file-label" style="margin-top: 12px;">\n              ğŸ“„ é€‰æ‹©å­—ç¬¦é›†æ–‡ä»¶ (charsets.json)\n              <input type="file" class="ddddocr-file-input" id="charsetsFileInput" accept=".json">\n            </label>\n            <div class="ddddocr-file-name" id="charsetsFileName">æœªé€‰æ‹©æ–‡ä»¶</div>\n            <div class="ddddocr-button-group">\n              <button class="ddddocr-button" id="uploadModelBtn">ä¿å­˜ä¸Šä¼ çš„æ¨¡å‹</button>\n              <button class="ddddocr-button danger" id="deleteUploadedBtn">åˆ é™¤å·²ä¸Šä¼ æ¨¡å‹</button>\n            </div>\n          </div>\n          <div class="ddddocr-setting-item" id="autoDownloadItem" style="display: ${t.useUploadedModel?"none":"flex"}; margin-top: 12px;">\n            <div>\n              <div class="ddddocr-setting-label">è‡ªåŠ¨ä¸‹è½½æ¨¡å‹</div>\n              <div class="ddddocr-setting-desc">é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶</div>\n            </div>\n            <div class="ddddocr-switch ${t.autoDownload?"active":""}" data-setting="autoDownload">\n              <div class="ddddocr-switch-slider"></div>\n            </div>\n          </div>\n        </div>\n        <div class="ddddocr-setting-group">\n          <div class="ddddocr-setting-group-title">åŠŸèƒ½è®¾ç½®</div>\n          <div class="ddddocr-setting-item">\n            <div>\n              <div class="ddddocr-setting-label">è‡ªåŠ¨æ£€æµ‹å¹¶å¡«å……éªŒè¯ç </div>\n              <div class="ddddocr-setting-desc">è‡ªåŠ¨è¯†åˆ«é¡µé¢ä¸­çš„éªŒè¯ç å¹¶å¡«å……</div>\n            </div>\n            <div class="ddddocr-switch ${t.autoDetect?"active":""}" data-setting="autoDetect">\n              <div class="ddddocr-switch-slider"></div>\n            </div>\n          </div>\n          <div class="ddddocr-setting-item">\n            <div>\n              <div class="ddddocr-setting-label">éªŒè¯ç é€‰æ‹©å™¨</div>\n              <div class="ddddocr-setting-desc">CSSé€‰æ‹©å™¨ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨æ£€æµ‹</div>\n            </div>\n          </div>\n          <input type="text" class="ddddocr-input" placeholder="ä¾‹å¦‚: img.captcha, #captchaImage" \n                 value="${t.captchaSelector||""}" data-setting="captchaSelector">\n          <div class="ddddocr-setting-item">\n            <div>\n              <div class="ddddocr-setting-label">è¾“å…¥æ¡†é€‰æ‹©å™¨</div>\n              <div class="ddddocr-setting-desc">CSSé€‰æ‹©å™¨ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨æŸ¥æ‰¾</div>\n            </div>\n          </div>\n          <input type="text" class="ddddocr-input" placeholder="ä¾‹å¦‚: input#captcha, .captcha-input" \n                 value="${t.inputSelector||""}" data-setting="inputSelector">\n        </div>\n        <div class="ddddocr-setting-group">\n          <div class="ddddocr-setting-group-title">ç«™ç‚¹ç™½åå•</div>\n          <div class="ddddocr-setting-item">\n            <div>\n              <div class="ddddocr-setting-label">å¯ç”¨ç™½åå•</div>\n              <div class="ddddocr-setting-desc">ä»…åœ¨æŒ‡å®šç«™ç‚¹å¯ç”¨è„šæœ¬</div>\n            </div>\n            <div class="ddddocr-switch ${t.enableWhitelist?"active":""}" data-setting="enableWhitelist">\n              <div class="ddddocr-switch-slider"></div>\n            </div>\n          </div>\n          <div id="whitelistSettings" style="display: ${t.enableWhitelist?"block":"none"}">\n            <textarea class="ddddocr-textarea" placeholder="æ¯è¡Œä¸€ä¸ªåŸŸåï¼Œä¾‹å¦‚ï¼š&#10;example.com&#10;*.example.com&#10;sub.example.com" \n                      data-setting="whitelist">${(t.whitelist||[]).join("\n")}</textarea>\n            <div class="ddddocr-info">\n              æ”¯æŒé€šé…ç¬¦ * åŒ¹é…å­åŸŸåã€‚å½“å‰ç«™ç‚¹ï¼š${window.location.hostname}\n            </div>\n          </div>\n        </div>\n        <div class="ddddocr-button-group">\n          <button class="ddddocr-button" id="saveSettingsBtn">ä¿å­˜è®¾ç½®</button>\n          <button class="ddddocr-button secondary" id="resetSettingsBtn">é‡ç½®è®¾ç½®</button>\n        </div>\n      </div>\n    `,document.body.appendChild(this.container),this.bindEvents();}bindEvents(){this.container&&(this.container.querySelector(".ddddocr-settings-close")?.addEventListener("click",()=>{this.hide();}),this.container.querySelectorAll(".ddddocr-switch").forEach(t=>{t.addEventListener("click",t=>{const e=t.currentTarget,n=e.dataset.setting,i=e.classList.toggle("active");if("useUploadedModel"===n){const t=this.container.querySelector("#uploadModelArea"),e=this.container.querySelector("#autoDownloadItem");t.style.display=i?"block":"none",e.style.display=i?"none":"flex";}"enableWhitelist"===n&&(this.container.querySelector("#whitelistSettings").style.display=i?"block":"none");});}),this.container.querySelector("#modelFileInput")?.addEventListener("change",t=>{const e=t.target.files?.[0],n=this.container.querySelector("#modelFileName");e&&(n.textContent=`âœ… ${e.name} (${(e.size/1024/1024).toFixed(2)} MB)`);}),this.container.querySelector("#charsetsFileInput")?.addEventListener("change",t=>{const e=t.target.files?.[0],n=this.container.querySelector("#charsetsFileName");e&&(n.textContent=`âœ… ${e.name}`);}),this.container.querySelector("#uploadModelBtn")?.addEventListener("click",async()=>{const t=this.container.querySelector("#modelFileInput").files?.[0],e=this.container.querySelector("#charsetsFileInput").files?.[0];if(t&&e)try{await async function(t,e){const n=await t.arrayBuffer(),i=await e.text(),o=JSON.parse(i),s=new ModelCache;await s.setUploadedModel(n,o);}(t,e),saveConfig({useUploadedModel:!0}),c.show({title:"ä¸Šä¼ æˆåŠŸ",content:"æ¨¡å‹æ–‡ä»¶å·²ä¿å­˜ï¼Œè¯·åˆ·æ–°é¡µé¢ä»¥åº”ç”¨",icon:"âœ…"});}catch(n){c.show({title:"ä¸Šä¼ å¤±è´¥",content:String(n),icon:"âŒ"});}else c.show({title:"ç¼ºå°‘æ–‡ä»¶",content:"è¯·é€‰æ‹©æ¨¡å‹æ–‡ä»¶å’Œå­—ç¬¦é›†æ–‡ä»¶",icon:"âš ï¸"});}),this.container.querySelector("#deleteUploadedBtn")?.addEventListener("click",()=>{c.confirm({title:"åˆ é™¤æ¨¡å‹",content:"ç¡®å®šè¦åˆ é™¤å·²ä¸Šä¼ çš„æ¨¡å‹å—ï¼Ÿ",icon:"ğŸ—‘ï¸",confirmText:"ç¡®å®šåˆ é™¤",cancelText:"å–æ¶ˆ",onConfirm:async()=>{try{await async function(){const t=new ModelCache;await t.deleteUploadedModel();}(),saveConfig({useUploadedModel:!1}),c.show({title:"åˆ é™¤æˆåŠŸ",content:"å·²åˆ é™¤ä¸Šä¼ çš„æ¨¡å‹",icon:"âœ…"}),this.hide();}catch(t){c.show({title:"åˆ é™¤å¤±è´¥",content:String(t),icon:"âŒ"});}}});}),this.container.querySelector("#saveSettingsBtn")?.addEventListener("click",()=>{this.saveSettings();}),this.container.querySelector("#resetSettingsBtn")?.addEventListener("click",()=>{c.confirm({title:"é‡ç½®è®¾ç½®",content:"ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿé¡µé¢å°†è‡ªåŠ¨åˆ·æ–°ã€‚",icon:"âš ï¸",confirmText:"ç¡®å®šé‡ç½®",cancelText:"å–æ¶ˆ",onConfirm:()=>{this.resetSettings();}});}));}saveSettings(){if(!this.container)return;const t={};this.container.querySelectorAll(".ddddocr-switch").forEach(e=>{const n=e.dataset.setting;n&&(t[n]=e.classList.contains("active"));}),this.container.querySelectorAll("input[data-setting]").forEach(e=>{const n=e.dataset.setting;n&&(t[n]=e.value);}),this.container.querySelectorAll("textarea[data-setting]").forEach(e=>{if("whitelist"===e.dataset.setting){const n=e.value;t.whitelist=n.split("\n").filter(t=>t.trim());}}),saveConfig(t),this.onConfigChange(getConfig()),"undefined"!=typeof GM_notification&&GM_notification({title:"è®¾ç½®å·²ä¿å­˜",text:"é…ç½®å·²æˆåŠŸä¿å­˜",timeout:2e3}),this.hide();}resetSettings(){saveConfig({autoDetect:false,captchaSelector:"",inputSelector:"",useUploadedModel:false,autoDownload:true,enableWhitelist:false,whitelist:[]}),this.hide(),window.location.reload();}async show(){this.container||await this.createContainer(),this.isVisible=true,this.container.classList.add("ddddocr-settings-visible");}hide(){this.container&&(this.isVisible=false,this.container.classList.remove("ddddocr-settings-visible"));}toggle(){this.isVisible?this.hide():this.show();}setOnConfigChange(t){this.onConfigChange=t;}}class LoadingIndicator{constructor(){this.container=null,this.isVisible=false,this.create();}create(){const t=document.createElement("style");t.textContent="\n      .ddddocr-loading-indicator {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 4px;\n        z-index: 2147483647;\n        overflow: hidden;\n        background: linear-gradient(90deg, \n          #4A90E2 0%, \n          #FF69B4 25%, \n          #87CEEB 50%, \n          #FF69B4 75%, \n          #4A90E2 100%);\n        background-size: 200% 100%;\n        animation: ddddocr-wave 3s linear infinite;\n        opacity: 0;\n        transition: opacity 0.3s;\n      }\n\n      .ddddocr-loading-indicator.visible {\n        opacity: 1;\n      }\n\n      @keyframes ddddocr-wave {\n        0% {\n          background-position: 0% 50%;\n        }\n        100% {\n          background-position: 200% 50%;\n        }\n      }\n\n      .ddddocr-loading-text {\n        position: fixed;\n        top: 8px;\n        left: 50%;\n        transform: translateX(-50%);\n        background: #4A90E2;\n        color: white;\n        padding: 6px 16px;\n        border-radius: 20px;\n        font-size: 12px;\n        font-weight: 500;\n        z-index: 2147483647;\n        opacity: 0;\n        transition: opacity 0.3s;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\n      }\n\n      .ddddocr-loading-text.visible {\n        opacity: 1;\n      }\n    ",document.head.appendChild(t),this.container=document.createElement("div"),this.container.className="ddddocr-loading-indicator",document.body.appendChild(this.container);const e=document.createElement("div");e.className="ddddocr-loading-text",e.id="ddddocr-loading-text",e.textContent="æ­£åœ¨åˆå§‹åŒ– DDDD OCR...",document.body.appendChild(e);}show(t){if(!this.container)return;this.isVisible=true,this.container.classList.add("visible");const e=document.getElementById("ddddocr-loading-text");e&&(t&&(e.textContent=t),e.classList.add("visible"));}updateText(t){const e=document.getElementById("ddddocr-loading-text");e&&(e.textContent=t);}hide(){if(!this.container)return;this.isVisible=false,this.container.classList.remove("visible");const t=document.getElementById("ddddocr-loading-text");t&&t.classList.remove("visible"),setTimeout(()=>{this.container?.remove(),t?.remove(),this.container=null;},300);}}class EventEmitter{constructor(){this.listeners=new Map;}on(t,e){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e);}off(t,e){this.listeners.get(t)?.delete(e);}emit(t,e){this.listeners.get(t)?.forEach(t=>{try{t(e);}catch(n){}});}clear(){this.listeners.clear();}}class OCRApp{constructor(){this.loadingIndicator=null,this.initialized=false,this.eventEmitter=new EventEmitter,this.ocr=new DdddOCR,this.detector=new AutoDetector(this.ocr,this.eventEmitter),this.settingsUI=new SettingsUI,this.registerMenuCommands(),this.settingsUI.setOnConfigChange(t=>{this.handleConfigChange(t);});}async init(){if(!shouldExecuteScript())return;if(this.initialized)return;const t=getConfig();this.initialized=true,this.loadingIndicator=new LoadingIndicator;try{this.loadingIndicator.show("æ­£åœ¨åˆå§‹åŒ– DDDD OCR"),this.loadingIndicator.updateText("æ­£åœ¨åŠ è½½æ¨¡å‹æ–‡ä»¶"),await this.ocr.init(),this.loadingIndicator.updateText("DDDD OCR å·²å°±ç»ª"),t.autoDetect&&this.detector.start(),setTimeout(()=>{this.loadingIndicator?.hide();},2e3),this.showNotification("DDDD OCR å·²å°±ç»ª",t.autoDetect?"è‡ªåŠ¨æ£€æµ‹å·²å¯ç”¨":"ç‚¹å‡»èœå•å¯ç”¨è‡ªåŠ¨æ£€æµ‹");}catch(e){this.loadingIndicator&&(this.loadingIndicator.updateText("åˆå§‹åŒ–å¤±è´¥: "+String(e)),setTimeout(()=>{this.loadingIndicator?.hide();},3e3)),this.showNotification("åˆå§‹åŒ–å¤±è´¥",String(e),true);}}registerMenuCommands(){GM_registerMenuCommand("âš™ï¸ æ‰“å¼€è®¾ç½®",()=>this.settingsUI.show(),"s"),GM_registerMenuCommand("ğŸ¤– åˆ‡æ¢è‡ªåŠ¨æ£€æµ‹",()=>this.toggleAutoDetect(),"a"),GM_registerMenuCommand("ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç¼“å­˜",async()=>{c.confirm({title:"æ¸…é™¤ç¼“å­˜",content:"ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼ˆåŒ…æ‹¬æ¨¡å‹å’Œ WASMï¼‰ï¼Ÿä¸‹æ¬¡å¯åŠ¨å°†é‡æ–°ä¸‹è½½ã€‚",icon:"ğŸ—‘ï¸",confirmText:"ç¡®å®šæ¸…é™¤",cancelText:"å–æ¶ˆ",onConfirm:async()=>{await async function(){const t=new ModelCache;await t.delete();}(),await async function(){await a.clear();}(),this.showNotification("ç¼“å­˜å·²æ¸…é™¤","è¯·åˆ·æ–°é¡µé¢");}});},"d"),GM_registerMenuCommand("â„¹ï¸ æŸ¥çœ‹çŠ¶æ€",()=>this.showStatus(),"i");}showStatus(){const t=getConfig(),e=isWhitelisted();let n=`\n<b>è„šæœ¬çŠ¶æ€:</b> ${this.initialized?"âœ… å·²åˆå§‹åŒ–":"âŒ æœªåˆå§‹åŒ–"}\n<b>å½“å‰ç«™ç‚¹:</b> ${window.location.hostname}\n<b>ç™½åå•çŠ¶æ€:</b> ${t.enableWhitelist?"âœ… å·²å¯ç”¨":"âŒ å·²ç¦ç”¨"}\n<b>ç™½åå•æ•°é‡:</b> ${t.whitelist?.length||0} ä¸ªç«™ç‚¹\n<b>å½“å‰ç«™ç‚¹åŒ¹é…:</b> ${e?"âœ… åœ¨ç™½åå•ä¸­":"âŒ ä¸åœ¨ç™½åå•ä¸­"}\n<b>è‡ªåŠ¨æ£€æµ‹:</b> ${t.autoDetect?"âœ… å·²å¯ç”¨":"âŒ å·²ç¦ç”¨"}\n<b>ä¸Šä¼ æ¨¡å‹:</b> ${t.useUploadedModel?"âœ… å·²å¯ç”¨":"âŒ æœªå¯ç”¨"}\n<b>è‡ªåŠ¨ä¸‹è½½:</b> ${t.autoDownload?"âœ… å·²å¯ç”¨":"âŒ å·²ç¦ç”¨"}`;this.initialized||(n+='\n\n<b style="color: #FF6B6B;">âš ï¸ è„šæœ¬æœªåˆå§‹åŒ–åŸå› ï¼š</b>\n'+this.getInitFailureReason()),c.show({title:"å½“å‰çŠ¶æ€",content:n,icon:"â„¹ï¸"});}getInitFailureReason(){const t=getConfig();if(t.enableWhitelist){if(!t.whitelist||0===t.whitelist.length)return "â€¢ ç™½åå•ä¸ºç©º\nâ€¢ è¯·åœ¨è®¾ç½®ä¸­æ·»åŠ ç«™ç‚¹åˆ°ç™½åå•";if(!isWhitelisted())return `â€¢ å½“å‰ç«™ç‚¹ ${window.location.hostname} ä¸åœ¨ç™½åå•ä¸­\nâ€¢ è¯·å°†å½“å‰ç«™ç‚¹æ·»åŠ åˆ°ç™½åå•`}return "â€¢ æœªçŸ¥åŸå› ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—"}toggleAutoDetect(){const t=!getConfig().autoDetect;t?this.initialized?(this.detector.start(),this.showNotification("è‡ªåŠ¨æ£€æµ‹å·²å¯ç”¨","å°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……éªŒè¯ç ")):(c.show({title:"éœ€è¦åˆå§‹åŒ–",content:"å¯ç”¨è‡ªåŠ¨æ£€æµ‹éœ€è¦å…ˆåˆå§‹åŒ– OCR å¼•æ“ï¼Œè¯·ç¨å€™",icon:"â³"}),this.init().then(()=>{this.detector.start(),this.showNotification("è‡ªåŠ¨æ£€æµ‹å·²å¯ç”¨","å°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……éªŒè¯ç ");}).catch(t=>{this.showNotification("å¯ç”¨å¤±è´¥",String(t),true);})):(this.detector.stop(),this.showNotification("è‡ªåŠ¨æ£€æµ‹å·²å…³é—­","ä¸å†è‡ªåŠ¨å¤„ç†éªŒè¯ç ")),saveConfig({autoDetect:t});}handleConfigChange(t){t.autoDetect&&!this.detector.enabled?(this.initialized||this.init(),this.detector.start()):!t.autoDetect&&this.detector.enabled&&this.detector.stop(),this.checkNeedsRefresh(t)&&c.show({title:"é…ç½®å·²æ›´æ”¹",content:"éƒ¨åˆ†é…ç½®éœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½ç”Ÿæ•ˆï¼Œæ˜¯å¦ç°åœ¨åˆ·æ–°ï¼Ÿ",icon:"ğŸ”„",confirmText:"åˆ·æ–°é¡µé¢",onConfirm:()=>{window.location.reload();}});}checkNeedsRefresh(t){const e=getConfig();return t.useUploadedModel!==e.useUploadedModel||t.enableWhitelist!==e.enableWhitelist}showNotification(t,e,n=false){"undefined"!=typeof GM_notification&&GM_notification({title:t,text:e,timeout:n?5e3:3e3});}}function bootstrap(){const t=new OCRApp;shouldExecuteScript()&&setTimeout(()=>{t.init();},500);}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",bootstrap):bootstrap();

})();