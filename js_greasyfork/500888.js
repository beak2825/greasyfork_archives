// ==UserScript==
// @name         内蒙高报-天神验证码识别系统
// @namespace    http://tampermonkey.net/
// @version      4.5.3
// @description  本产品仅供交流学习，如用于非法用途自行承担责任，针对内蒙古高报场景
// @author       You
// @match        https://www1.nm.zsks.cn/*
// @icon
// @require
// @antifeature  tracking
// @license      MIT
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/500888/%E5%86%85%E8%92%99%E9%AB%98%E6%8A%A5-%E5%A4%A9%E7%A5%9E%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F.user.js
// @updateURL https://update.greasyfork.org/scripts/500888/%E5%86%85%E8%92%99%E9%AB%98%E6%8A%A5-%E5%A4%A9%E7%A5%9E%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F.meta.js
// ==/UserScript==

// Your code here...

$(function () {
  //渲染DOM元素
  $(
    '<div id="contain" style="position: absolute;z-index: 9999;width: 480px;min-height: 200px;border-radius: 10px;background-color: #BEFBFF;display: flex;flex-direction: column;"> <div id="headerss" style="width: 100%;height: 40px;background-color: #92DDE6;cursor: move;border-radius: 10px 10px 0 0;display: flex;flex-direction: column;justify-content: center;align-items: center;"> <p style="margin: 0;padding: 0;font-size: 15px;">天神验证码识别系统 单次识别验证码（F4）</p> <p style="color: #ff7f00;font-weight: bold;font-size: 18px;" id="currentTime">当前时间：加载中...</p> </div> <div style="display: flex;flex-direction: column;justify-content: center;align-items: center;"> <div style="width: 100%;height: 40px;display: flex;flex-direction: row;justify-content: center;align-items: center;" id="formss"> <input id="text1" style="width: 70px;height: 20px;" placeholder="院校代码" maxlength="3" type="text" /> <input id="text2" style="width: 50px;height: 20px;" placeholder="专业一" maxlength="2" type="text" /> <input id="text3" style="width: 50px;height: 20px;" placeholder="专业二" maxlength="2" type="text" /> <input id="text4" style="width: 50px;height: 20px;" placeholder="专业三" maxlength="2" type="text" /> <select style="width: 50px;height: 25px;" id="selectone"> <option value="0">是</option> <option value="1">否</option> </select> <select style="width: 50px;height: 25px;" id="selecttwo"> <option value="0">是</option> <option value="1">否</option> </select> <button id="inputdata" style="height: 25px;margin-left: 10px;width: 80px;cursor: pointer;">增加院校</button> </div> <div style="width: 100%;height: 30px;display: flex;flex-direction: row;align-items: center;justify-content: center;"> <input id="username" style="width: 100px;height: 20px;" placeholder="考生号" type="text" /> <input id="pswd" style="width: 100px;height: 20px;margin-left: 15px;" placeholder="密码" type="text" /> <button id="loginUp" style="height: 25px;margin-left: 10px;width: 50px;">登录</button> <button id="logout" style="height: 25px;margin-left: 10px;width: 50px;">注销</button> </div> <div style="width: 100%;font-size: 12px;"> <ul style="padding: 0;margin: 0;list-style: none;height: 20px;width: 100%;display: flex;justify-content: center;align-items: center;"> <li style="float: left;display: flex; flex: 1;justify-content: center;align-items: center;">院校代码</li> <li style="float: left;display: flex; flex: 1;justify-content: center;align-items: center;">专业一</li> <li style="float: left;display: flex; flex: 1;justify-content: center;align-items: center;">专业二</li> <li style="float: left;display: flex; flex: 1;justify-content: center;align-items: center;">专业三</li> <li style="float: left;display: flex; flex: 1;justify-content: center;align-items: center;">是/否</li> <li style="float: left;display: flex; flex: 1;justify-content: center;align-items: center;">是/否</li> <li style="float: left;display: flex; flex: 1;justify-content: center;align-items: center;">操作</li> </ul> </div> <nav style="width: 100%;font-size: 10px;display: flex;flex-direction:column;justify-content: center;align-items: center;" id="navs"> </nav> </div> </div>'
  ).prependTo("body");
  //引入人工输入组件
  // Generated by CoffeeScript 1.7.1
  $.fn.extend({
    backspace: function (num, options) {
      var settings;
      settings = $.extend(
        {
          callback: function () {},
          keypress: function () {},
          t: 100,
          e: 0.04,
        },
        options
      );
      return this.each(function () {
        var elem;
        elem = this;
        $(elem).queue(function () {
          var append, backsp;
          backsp = function (n, fakeparam) {
            if (n) {
              elem[/(np|x)/i.test(elem.tagName) ? "value" : "innerHTML"] = elem[
                /(np|x)/i.test(elem.tagName) ? "value" : "innerHTML"
              ].slice(0, -1);
              settings.keypress.call(elem);
              setTimeout(function () {
                backsp(n - 1, fakeparam);
              }, settings.t);
            } else {
              settings.callback.call(elem);
              $(elem).dequeue();
            }
          };
          append = function (fake, fakeyness) {
            if (fake) {
              elem[/(np|x)/i.test(elem.tagName) ? "value" : "innerHTML"] +=
                fake[0];
              settings.keypress.call(elem);
              setTimeout(function () {
                append(fake.slice(1), fakeyness);
              }, settings.t);
            } else {
              fakeyness();
            }
          };
          backsp(num);
        });
      });
    },
    typetype: function (txt, options) {
      var settings;
      settings = $.extend(
        {
          callback: function () {},
          keypress: function () {},
          t: 100,
          e: 0.04,
        },
        options
      );
      return this.each(function () {
        var elem;
        elem = this;
        $(elem).queue(function () {
          var append, backsp, typeTo;
          backsp = function (num, cont) {
            if (num) {
              elem[/(np|x)/i.test(elem.tagName) ? "value" : "innerHTML"] = elem[
                /(np|x)/i.test(elem.tagName) ? "value" : "innerHTML"
              ].slice(0, -1);
              settings.keypress.call(elem);
              setTimeout(function () {
                backsp(num - 1, cont);
              }, settings.t);
            } else {
              cont();
            }
          };
          append = function (str, cont) {
            if (str) {
              elem[/(np|x)/i.test(elem.tagName) ? "value" : "innerHTML"] +=
                str[0];
              settings.keypress.call(elem);
              setTimeout(function () {
                append(str.slice(1), cont);
              }, settings.t);
            } else {
              cont();
            }
          };
          typeTo = function (i) {
            var afterErr, r;
            afterErr = function () {
              return setTimeout(function () {
                typeTo(i);
              }, Math.random() *
                settings.t *
                (txt[i - 1] === txt[i]
                  ? 1.6
                  : txt[i - 1] === "."
                  ? 12
                  : txt[i - 1] === "!"
                  ? 12
                  : txt[i - 1] === "?"
                  ? 12
                  : txt[i - 1] === "\n"
                  ? 12
                  : txt[i - 1] === ","
                  ? 8
                  : txt[i - 1] === ";"
                  ? 8
                  : txt[i - 1] === ":"
                  ? 8
                  : txt[i - 1] === " "
                  ? 3
                  : 2));
            };
            r = Math.random() / settings.e;
            if (txt.length >= i) {
              if (0.3 > r && txt[i - 1] !== txt[i] && txt.length > i + 4) {
                append(txt.slice(i, i + 4), function () {
                  backsp(4, afterErr);
                });
              } else if (
                0.7 > r &&
                i > 1 &&
                /[A-Z]/.test(txt[i - 2] && txt.length > i + 4)
              ) {
                append(
                  txt[i - 1].toUpperCase() + txt.slice(i, i + 4),
                  function () {
                    backsp(5, afterErr);
                  }
                );
              } else if (0.5 > r && txt[i - 1] !== txt[i] && txt.length > i) {
                append(txt[i], function () {
                  backsp(1, afterErr);
                });
              } else if (1.0 > r && txt[i - 1] !== txt[i] && txt.length > i) {
                append(txt[i] + txt[i - 1], function () {
                  backsp(2, afterErr);
                });
              } else if (0.5 > r && /[A-Z]/.test(txt[i])) {
                append(txt[i].toLowerCase(), function () {
                  backsp(1, afterErr);
                });
              } else {
                elem[/(np|x)/i.test(elem.tagName) ? "value" : "innerHTML"] +=
                  txt[i - 1];
                settings.keypress.call(elem);
                setTimeout(function () {
                  typeTo(i + 1);
                }, Math.random() *
                  settings.t *
                  (txt[i - 1] === txt[i]
                    ? 1.6
                    : txt[i - 1] === "."
                    ? 12
                    : txt[i - 1] === "!"
                    ? 12
                    : txt[i - 1] === "?"
                    ? 12
                    : txt[i - 1] === "\n"
                    ? 12
                    : txt[i - 1] === ","
                    ? 8
                    : txt[i - 1] === ";"
                    ? 8
                    : txt[i - 1] === ":"
                    ? 8
                    : txt[i - 1] === " "
                    ? 3
                    : 2));
              }
            } else {
              settings.callback.call(elem);
              $(elem).dequeue();
            }
          };
          typeTo(1);
        });
      });
    },
  });
  //设置自动拖拽相关
  let container = document.getElementById("contain");
  let header = document.getElementById("headerss");
  let saveleft = localStorage.getItem("left");
  let savetop = localStorage.getItem("top");
  if (saveleft === null && savetop === null) {
    container.style.left = "0px";
    container.style.top = "0px";
  } else {
    container.style.left = JSON.parse(saveleft);
    container.style.top = JSON.parse(savetop);
  }
  //监听鼠标按下，进行拖拽
  function handleMouseDown(event) {
    let clientX = parseInt(event.clientX);
    let clientY = parseInt(event.clientY);
    let currentLeft = parseInt(container.style.left);
    let currentTop = parseInt(container.style.top);
    function handleMouseMove(event) {
      let left = event.clientX - clientX + currentLeft;
      let top = event.clientY - clientY + currentTop;
      container.style.left = left + "px";
      container.style.top = top + "px";
    }
    function handleMouseUp() {
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
      localStorage.setItem("left", JSON.stringify(container.style.left));
      localStorage.setItem("top", JSON.stringify(container.style.top));
    }
    document.addEventListener("mousemove", handleMouseMove);
    document.addEventListener("mouseup", handleMouseUp);
  }
  header.addEventListener("mousedown", handleMouseDown);

  //北京时间展示
  setInterval(function() {
    var now = new Date();
    var year = now.getFullYear().toString()
    var month = (now.getMonth() + 1).toString().padStart(2, '0'); // getMonth() 返回的月份从 0 开始，所以需要 +1
    var day = now.getDate().toString().padStart(2, '0');
    var hours = now.getHours().toString().padStart(2, '0');
    var minutes = now.getMinutes().toString().padStart(2, '0');
    var seconds = now.getSeconds().toString().padStart(2, '0');
    var milliseconds = now.getMilliseconds().toString().padStart(3, '0');
    var timeString =year+'年'+month+'月'+day+'日'+ ' ' +hours + ' : ' + minutes + ' : ' + seconds + '.' + milliseconds;
    $('#currentTime').text('当前时间：' + timeString);
}, 1); // 每毫秒更新一次时间
  //节流阀
  var farm = 0;

  //接口识别验证码返回方法
  function setCode() {
    return new Promise((resolve, reject) => {
      // 创建 canvas 元素
      var canvas = $("<canvas></canvas>");
      // 设置 canvas 的属性
      canvas.attr("width", 120);
      canvas.attr("height", 25);
      canvas.attr("id", "myCanvas");
      canvas.attr("z-index", "999999");
      // 将 canvas 添加到文档中
      canvas.appendTo("body");
      //获取屏幕验证码
      // 获取页面上的 img 标签
      var image = new Image();
      let imgsrc = $(".randomImage").attr("src") || $(".randomImg").attr("src");
      image.src = imgsrc;
      image.onload = function () {
        // 获取 canvas 上下文
        var ctx = document.getElementById("myCanvas").getContext("2d");
        // 在 canvas 上绘制图像
        ctx.drawImage(image, 0, 0);
        //转为base64
        var dataUrl = document
          .getElementById("myCanvas")
          .toDataURL("image/png");
        var base64Code = dataUrl.substr(22);
        //接口调用
        $.ajax({
          url: "https://upload.chaojiying.net/Upload/Processing.php",
          type: "POST",
          data: {
            user: "jonelsy",
            pass: "jone@233",
            softid: 950102,
            codetype: 1005,
            len_min: 0,
            file_base64: base64Code,
          },
          cache: false,
          contentType: "application/x-www-form-urlencoded",
          timeout:3000,
          success: function (res) {
            resolve(res.pic_str);
          },
          error: function (e) {
            console.log(e);
            reject(e);
          },
        });
      };
    });
  }

  //自动读取账号密码展示,获取保底展示
  var getpwd = function () {
    let pwd = localStorage.getItem("pwd");
    let username = localStorage.getItem("username");
    $("#pswd").val(pwd);
    $("#username").val(username);
  };
  //初始获取本地列表数据，查
  function getData() {
    let data = localStorage.getItem("datas");
    if (data !== null) {
      data = JSON.parse(data);
      return data;
    } else {
      return [];
    }
  }
  //保存列表数据方法，增
  function saveData(datas) {
    localStorage.setItem("datas", JSON.stringify(datas));
  }
  //渲染页面列表
  var loaddatas = function () {
    $("#navs").empty();
    let data = getData();
    $.each(data, function (index, item) {
      $("#navs").append(
        "<ul style='width: 100%;padding: 0;list-style: none;height: 15px;display: flex; flex: 1;justify-content: center;align-items: center;margin-top: 10px'> <li style='display: flex; flex: 1;justify-content: center;align-items: center;'>" +
          item.school +
          "</li> <li style='display: flex; flex: 1;justify-content: center;align-items: center;'>" +
          item.judge1 +
          "</li> <li style='display: flex; flex: 1;justify-content: center;align-items: center;'>" +
          item.judge2 +
          "</li> <li style='display: flex; flex: 1;justify-content: center;align-items: center;'>" +
          item.judge3 +
          "</li> <li style='display: flex; flex: 1;justify-content: center;align-items: center;'>" +
          (Number(item.select1)?'否':'是') +
          "</li> <li style='display: flex; flex: 1;justify-content: center;align-items: center;'>" +
          (Number(item.select2)?'否':'是') +
          "</li> <li style='display: flex; flex: 1;justify-content: center;align-items: center;'><button id='inputs' style='height: 25px;width:50%;font-size: 10px;padding: 0;cursor: pointer;background-color: #2ecc71;color: white;border: none;border-radius: 4px;' index=" +
          index +
          ">填入</button><button id='deletas' style='height: 25px;width:50%;font-size: 10px;padding: 0;margin-left:5px;cursor: pointer; background-color: #e74c3c;color: white;border: none;border-radius: 4px;' index=" +
          index +
          ">删除</button></li> </ul>"
      );
    });
  };
  //点击增加事件
  $("#inputdata").click(function () {
    let datar = getData();
    //获取输入框中数据并形成对象添加到data数组中
    //获取
    let inputs = $("#formss").children();
    //判断是否输入为空，拦截
    if (inputs[0].value == "" || inputs[1].value == "") {
      alert("请输入有效信息");
    } else {
      //创建对象
      let data = {
        school: inputs[0].value, //院校代码
        judge1: inputs[1].value, //专业一
        judge2: inputs[2].value, //专业二
        judge3: inputs[3].value, //专业三
        select1: inputs[4].value, //选择一
        select2: inputs[5].value, //选择二
      };
      datar.push(data);
      saveData(datar);
      loaddatas();
      $("#formss").children("input").val("");
    }
  });
  //点击删除
  $("#navs").on("click", "#deletas", function () {
    let datas = getData();
    let index = $(this).attr("index");
    datas.splice(index, 1);
    saveData(datas);
    loaddatas();
  });
  //点击全自动填入
  $("#navs").on("click", "#inputs", function () {
    if (farm === 0) {
      if (localStorage.getItem("beginGage") == 1) {
        farm = 1;
        let datas = getData();
        let index = $(this).attr("index");
        personInput(
          datas[index].school,
          datas[index].judge1,
          datas[index].judge2,
          datas[index].judge3,
          datas[index].select1,
          datas[index].select2
        );
      } else {
        alert("请先登录");
        return 0;
      }
    }
  });
  //拟人输入
  function personInput(school, judge1, judge2, judge3, select1, select2) {
    //先清除所有输入框内容
    $('input[name="yxdh"]').val("");
    $('input[name="zydh1"]').val("");
    $('input[name="zydh2"]').val("");
    $('input[name="zydh3"]').val("");
    $("#addcode").val("");
    $("#pwd").val("");
    let time = Math.random() * (250 - 200 + 1) + 200;

      if (select1 == 0) {
        
          $('input[name="zyzytj"]').first().focus();
          $('input[name="zyzytj"]').first().prop("checked", true);
        
      } else if (select1 == 1) {
        
          $('input[name="zyzytj"]:last').first().focus();
          $('input[name="zyzytj"]:last').first().prop("checked", true);
       
      }
      if (select2 == 0) {
        
          $('input[name="gsftj"]').first().focus();
          $('input[name="gsftj"]').first().prop("checked", true);
       
      } else if (select2 == 1) {
        
          $('input[name="gsftj"]:last').first().focus();
          $('input[name="gsftj"]:last').first().prop("checked", true);
       
      }
   
    //逐行输入
    $('input[name="yxdh"]').focus();
    $('input[name="yxdh"]').typetype(
      school, // 模拟文本
      {
        e: 0, // 错误率 ( e=0 表示没有错误)
        t: Math.floor(Math.random() * (250 - 200 + 1)) + 200, // 打字间隔时间 （毫秒）
        keypress: function () {
          // 每打一个字之后调用该方法（包括出错回退的时候）。
        },
        callback: function () {
          // 完成后调用
          $('input[name="yxdh"]').blur();
          text2();
        },
      }
    );
    function text2() {
      $('input[name="zydh1"]').focus();
      $('input[name="zydh1"]').typetype(
        judge1, // 模拟文本
        {
          e: 0, // 错误率 ( e=0 表示没有错误)
          t: Math.floor(Math.random() * (250 - 200 + 1)) + 200, // 打字间隔时间 （毫秒）
          keypress: function () {
            // 每打一个字之后调用该方法（包括出错回退的时候）。
          },
          callback: function () {
            // 完成后调用
            $('input[name="zydh1"]').blur();
            text3();
          },
        }
      );
    }
    function text3() {
      $('input[name="zydh2"]').focus();
      $('input[name="zydh2"]').typetype(
        judge2, // 模拟文本
        {
          e: 0, // 错误率 ( e=0 表示没有错误)
          t: Math.floor(Math.random() * (250 - 200 + 1)) + 200, // 打字间隔时间 （毫秒）
          keypress: function () {
            // 每打一个字之后调用该方法（包括出错回退的时候）。
          },
          callback: function () {
            // 完成后调用
            $('input[name="zydh2"]').blur();
            text4();
          },
        }
      );
    }
    function text4() {
      $('input[name="zydh3"]').focus();
      $('input[name="zydh3"]').typetype(
        judge3, // 模拟文本
        {
          e: 0, // 错误率 ( e=0 表示没有错误)
          t: Math.floor(Math.random() * (250 - 200 + 1)) + 200, // 打字间隔时间 （毫秒）
          keypress: function () {
            // 每打一个字之后调用该方法（包括出错回退的时候）。
          },
          callback: function () {
            // 完成后调用
            //进行选择框判断与点击
            $('input[name="zydh3"]').blur();
            //判断是否需要选项
            text5();
          },
        }
      );
    }
    //自动填入密码
    function text5() {
      $("#pwd").focus();
      $("#pwd").typetype(
        localStorage.getItem("pwd"), // 模拟文本
        {
          e: 0, // 错误率 ( e=0 表示没有错误)
          t: Math.floor(Math.random() * (15 - 10 + 1)) + 10, // 打字间隔时间 （毫秒）
          keypress: function () {
            // 每打一个字之后调用该方法（包括出错回退的时候）。
          },
          callback: function () {
            // 完成后调用
            text6();
          },
        }
      );
    }
    //自动填入验证码
    function text6() {
      setCode().then(function (res) {
        $("#addcode").focus();
        $("#addcode").typetype(
          res, // 模拟文本
          {
            e: 0, // 错误率 ( e=0 表示没有错误)
            t: Math.floor(Math.random() * (250 - 200 + 1)) + 200, // 打字间隔时间 （毫秒）
            keypress: function () {
              // 每打一个字之后调用该方法（包括出错回退的时候）。
            },
            callback: function () {
              // 完成后调用,自动点击，有问题已禁用
              //$("#sure").trigger("click");
              //自动获取焦点，测试
              // $("#sure").focus();
              return 0;
            },
          }
        );
        farm = 0;
        //节流阀关闭
        return;
      });
    }
  }
  //单词识别快捷键F4
  $(document).on("keydown", function (e) {
    //输出按下的键码
    if (e.which == 115) {
      e.preventDefault();
      if (localStorage.getItem("beginGage") == 1) {
        $("#addcode").val('');
        $("#addcode").focus();
        //F4
        setCode().then(function (res) {
          $("#addcode").typetype(
            res, // 模拟文本
            {
              e: 0, // 错误率 ( e=0 表示没有错误)
              t: Math.floor(Math.random() * (250 - 200 + 1)) + 200, // 打字间隔时间 （毫秒）
              keypress: function () {
                // 每打一个字之后调用该方法（包括出错回退的时候）。
              },
              callback: function () {
                //测试tab
                // $.Event('keydown', { keyCode: 9, which: 9 })
                // $.Event('keydown', { keyCode: 9, which: 9 })
                return 0;
              },
            }
          );
        });
        farm = 0;
        return;
      } else {
        alert("请先登录");
      }
    }
  });
  //登录系统
  $("#loginUp").click(function () {
    let username = $("#username").val();
    //接口
    $.post(
      "https://www.boxs.club:443/STUlogin",
      {
        username: username,
      },
      function (res) {
        if (res.status == 1) {
          console.log(res);
          let beginGage = 1;
          localStorage.removeItem("beginGage");
          localStorage.setItem("beginGage", beginGage);
          alert(res.message);
          //登陆后标识为1，将登录按钮隐藏，展示注销按钮
          $("#loginUp").hide();
          $("#logout").show();
          //锁定考生号与密码
          $("#username").prop("disabled", true);
          $("#pswd").prop("disabled", true);
          localStorage.removeItem("pwd");
          localStorage.setItem("pwd", $("#pswd").val());
          localStorage.removeItem("username");
          localStorage.setItem("username", $("#username").val());
        } else {
          let beginGage = 0;
          localStorage.removeItem("beginGage");
          localStorage.setItem("beginGage", beginGage);
          alert(res.message);
        }
      }
    );
  });
  //注销系统
  $("#logout").click(function () {
    //将登录按钮展示，隐藏注销按钮,清空所有数据
    let beginGage = 0;
    localStorage.removeItem("beginGage");
    localStorage.setItem("beginGage", beginGage);
    alert("注销成功");
    $("#logout").hide();
    $("#loginUp").show();
    //解除锁定考生号与密码
    $("#username").prop("disabled", false);
    $("#pswd").prop("disabled", false);
    //清空考生相关信息
    localStorage.removeItem("username");
    localStorage.removeItem("pwd");
    getpwd();
  });
  //识别登录状态
  function checkLogin() {
    let beginGage = localStorage.getItem("beginGage");
    if (beginGage == null || beginGage == 0 || beginGage == undefined) {
      $("#logout").hide();
      $("#loginUp").show();
      $("#username").prop("disabled", false);
      $("#pswd").prop("disabled", false);
    } else {
      $("#loginUp").hide();
      $("#logout").show();
      $("#username").prop("disabled", true);
      $("#pswd").prop("disabled", true);
    }
  }
  //监听选项第一项与第二项是否合法
  $("#selectone").change(function () {
    if ($("#selectone").val() == 1) {
      $("#selecttwo").prop("disabled", true);
      $("#selecttwo").val("1");
    } else {
      $("#selecttwo").prop("disabled", false);
    }
  });
  //脚本开始先获取密码展示，获取院校展示，获取登陆状态
  getpwd();
  loaddatas();
  checkLogin();
});
