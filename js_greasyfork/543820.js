// ==UserScript==
// @name         Babel Master (Iframe)
// @namespace    http://violentmonkey.net/
// @version      3.0
// @description  A consolidated script for all iframe functionalities: Zoom, Panner, Cursor Line, Key Forwarding (From iframe to Parent Page), Reset Sequence (Ctrl+Click on 'Reset'), Initial Scroll (Automatic Scroll on New ID), and Save + Counter.
// @author       happyglue
// @match        https://retool-edge.com/custom-component-collections.html
// @grant        GM_addStyle
// @downloadURL https://update.greasyfork.org/scripts/543820/Babel%20Master%20%28Iframe%29.user.js
// @updateURL https://update.greasyfork.org/scripts/543820/Babel%20Master%20%28Iframe%29.meta.js
// ==/UserScript==

function _0x4273(){let $=["cursorLine","rgba(199, 21, 133, 0.5)","zIndex","573moAucV","mouseup","isThreeSpeaker","documentElement",'" did not have a colon.',"left","SCROLL_DURATION_MS","log","Iframe Debug: Zoom slider not found. Check SELECTORS.zoomSlider.","transparent","207080LEstPN","wait_for_audio_and_report_back","div","cursorLine_mainContainer","babel-iframe-dark-mode","bottom","ZOOM_VALUES","pannerSlider2","50%","transition","type","babel_settings","pointerEvents","parent_keydown","CURSOR_LINE_COLOR","Minus","m41","display","Iframe Debug: Got playhead position ","#root > div > div > div.channels-container > div.channels-visualizations-wrapper > div > div.all-visualizations-container","#root > div > div > div.loading-overlay","boxShadow","key","querySelector","loadingOverlay",'TIMER DEBUG: timeToSeconds failed to split. Input "',"enhancedReset","scrollLeft","INPUT","isThreeSpeakerCall","getBoundingClientRect","Numpad6","NumpadEnter",'TIMER DEBUG: timeToSeconds failed to parse. Input "',"keydown","classList","4528712zTrcui","2147483647","clientY","out","reverse","linear-gradient(to right, transparent calc(50% - 0.75px), #ffbf00 calc(50% - 0.75px), #ffbf00 calc(50% + 0.75px), transparent calc(50% + 0.75px))","translateX(","px on attempt #","backgroundColor","lastCalculatedMinutes","timerContainer","get_work_duration","change","borderRadius","CURSOR_GLOW_BORDER_COLOR","#root > div > div > div.channels-container > div.channels-visualizations-wrapper > div > div.all-visualizations-container > div:nth-child(1) > div.waveform-container","elementFromPoint","#global-cursor","6351681WoImGh","CURSOR_LINE_X_OFFSET","data","right","Comma","pannerSlider3","12px","tagName","startsWith","mousemove","click","height","box-shadow 0.3s ease, border-color 0.3s ease","Iframe Debug: Calculation failed. Could not find the timer element. Check SELECTORS.timerDisplay.","position","shadowRoot","pannerSlider5","refreshButton","DOUBLE_PRESS_THRESHOLD","scrollWindowPath","clientX","Space","split","zoomAndNavigation","MAX_ZOOM","isFourSpeakerCall","contains","Numpad5","isFiveSpeakerCall","stopPropagation","Iframe Debug: Sending duration to parent, but the calculated value is still 0. The calculation likely failed or was never triggered.","set","toFixed","mouseleave","2742UpERaX","top","1025eRdwSh","timerDisplay","some","#root > div > div > div.player-toolbar > div.toolbar-group.always-visible > div > div.time-display","#root > div > div > div.channels-container > div.channels-controls-sidebar > div:nth-child(4) > div.volume-slider-container > input","pannerSlider4","observe","parent","style","MIN_ZOOM","div.player-toolbar","metaKey","rejump_to_topic","getOwnPropertyDescriptor","Enter","boxSizing","playheadPath","ArrowUp","value","transform","KeyN","Numpad2","TIMER DEBUG: Final calculation resulted in NaN! Check the timeToSeconds logs.","KeyB","isFourSpeaker","mousedown","#root > div > div > div.channels-container > div.channels-visualizations-wrapper > div > div.all-visualizations-container > div:nth-child(1) > div.spectrogram-container","ArrowDown","start_sequence","addEventListener","NumpadMultiply","getComputedStyle","24554925Wtxtie","backgroundImage","preventDefault","appendChild","#root > div > div > div.channels-container > div.channels-visualizations-wrapper > div > div.all-visualizations-container > div:nth-child(2) > div.spectrogram-container","pressTimers","CURSOR_GLOW_SHADOW_COLOR","ctrlKey","Slash","body","postMessage","zoomSliderElement","Numpad0",'TIMER DEBUG: performCalculation stopped. Text was invalid or still "00:00".',"ArrowLeft","dispatchEvent","KeyM","Iframe Debug: FAILED to get a valid playhead position. Scrolling to start as a fallback.","focus","px)","work_duration_response","keyup","background","border","1px solid ","rgb(150, 21, 133)","dark_mode_change","settings","00:00","cursor-glow-dot","border-box","Babel Iframe: Ctrl+Click on Reset detected. Starting sequence.","25314OIEPXu","find","#root > div > div > div.channels-container > div.channels-visualizations-wrapper > div","#root > div > div > div.player-toolbar > div.toolbar-group.always-visible > button.play-button","#root > div > div > div.channels-container > div.channels-controls-sidebar > div:nth-child(3) > div.volume-slider-container > input","659805jOWhgV","toggle","TEXTAREA","Period","blur","0.03","none","map","code","parentNode","Numpad7","pannerSlider1","999999","fixed","playButton","pan_","Numpad4","error","#root > div > div > div.channels-container > div.channels-visualizations-wrapper > div > div.all-visualizations-container > div:nth-child(2) > div.waveform-container","includes","✅ Babel Master (iframe)","#root > div > div > div.player-toolbar > div.toolbar-group.always-visible > button.reset-button","Numpad1","ArrowRight","disconnect","-0.9","width","trim","length","borderColor","0 0 2px 2px ","block","Iframe Debug: Could not find Play button in sequence. Check SELECTORS.playButton.","0.9","createElement",":hover * {\n            cursor: none !important;\n        }\n    ","textContent","stopImmediatePropagation"];return(_0x4273=function(){return $})()}function _0x432e($,x){let e=_0x4273();return(_0x432e=function($,x){return e[$-=128]})($,x)}(function($,x){let e=_0x432e,t=$();for(;;)try{let a=parseInt(e(225))/1+-parseInt(e(154))/2*(-parseInt(e(266))/3)+-parseInt(e(276))/4+parseInt(e(156))/5*(parseInt(e(220))/6)+parseInt(e(330))/7+parseInt(e(312))/8+-parseInt(e(188))/9;if(479938===a)break;t.push(t.shift())}catch(i){t.push(t.shift())}})(_0x4273,479938),function(){"use strict";let $=_0x432e,x={zoomSlider:"#root > div > div > div.player-toolbar > div:nth-child(2) > label > input",pannerSlider1:"#root > div > div > div.channels-container > div.channels-controls-sidebar > div:nth-child(1) > div.volume-slider-container > input",pannerSlider2:"#root > div > div > div.channels-container > div.channels-controls-sidebar > div:nth-child(2) > div.volume-slider-container > input",pannerSlider3:$(224),pannerSlider4:$(160),pannerSlider5:"#root > div > div > div.channels-container > div.channels-controls-sidebar > div:nth-child(5) > div.volume-slider-container > input",cursorLine_mainContainer:$(295),loadingOverlay:$(296),playButton:$(223),refreshButton:$(246),timerDisplay:$(159),timerContainer:$(166),scrollWindowPath:[$(222)],playheadPath:[$(329)]},e={DOUBLE_PRESS_THRESHOLD:200,ZOOM_VALUES:["7","14","22"],MIN_ZOOM:7,MAX_ZOOM:22,PAN_VALUES:{left:"-1",right:"1",center:"0",doublePressLeft:$(250),doublePressRight:$(258)},CURSOR_LINE_COLOR:"rgba(255, 191, 0, 1)",CURSOR_LINE_WIDTH:1.5,CURSOR_LINE_X_OFFSET:2,CURSOR_GLOW_BORDER_COLOR:$(213),CURSOR_GLOW_SHADOW_COLOR:$(264),SCROLL_DURATION_MS:200},t={settings:{cursorLine:!0,enhancedReset:!0,panner:!0,zoomAndNavigation:!0},zoomSliderElement:null,pressTimers:{zoom_in:null,zoom_out:null,pan_left:null,pan_right:null},lastCalculatedMinutes:0,isThreeSpeakerCall:!1,isFourSpeakerCall:!1,isFiveSpeakerCall:!1},a=null;GM_addStyle("\n        /* --- Babel Iframe Dark Theme --- */\n        html.babel-iframe-dark-mode,\n        html.babel-iframe-dark-mode body {\n            background-color: #121212 !important;\n        }\n\n        /* This targets the canvas where the waveform is drawn */\n        html.babel-iframe-dark-mode canvas {\n            background-color: #121212 !important;\n        }\n\n        /* When hovering over the waveform area, force the cursor to be hidden for ALL elements inside it */\n        "+x[$(279)]+$(260));let i=document[$(259)]($(278));i.id="lowest-latency-cursor-line",i[$(164)].position=$(238),i[$(164)][$(251)]=e.CURSOR_LINE_WIDTH+"px",i[$(164)][$(320)]=e[$(290)],i[$(164)][$(265)]=$(237),i[$(164)][$(288)]=$(231),i[$(164)][$(293)]=$(231),i.style[$(175)]="translateX(-20px)",document[$(197)][$(191)](i);let n=document[$(259)]($(278));function r(x,e){let t=$;if(!x||void 0===e)return;x[t(206)]();let a=Object[t(169)](window.HTMLInputElement.prototype,t(174))[t(151)];a.call(x,e),x[t(203)](new MouseEvent(t(181),{bubbles:!0})),x.dispatchEvent(new Event("input",{bubbles:!0})),x.dispatchEvent(new MouseEvent(t(267),{bubbles:!0})),x[t(203)](new Event(t(324),{bubbles:!0})),x[t(229)]()}n.id=$(217),n[$(164)][$(134)]=$(238),n.style[$(251)]=$(336),n[$(164)][$(131)]="12px",n.style[$(210)]=$(275),n[$(164)][$(189)]=$(317),n.style[$(211)]=$(212)+e[$(326)],n[$(164)][$(171)]=$(218),n[$(164)][$(325)]=$(284),n[$(164)][$(297)]=$(231),n[$(164)][$(265)]=$(313),n[$(164)][$(288)]=$(231),n[$(164)][$(293)]=$(231),document.body[$(191)](n);let l=$=>new Promise(x=>setTimeout(x,$));function o(x){let a=$;if(!t[a(215)][a(143)]||!t[a(199)])return;let i="zoom_"+x;if(t[a(193)][i]){clearTimeout(t[a(193)][i]),t.pressTimers[i]=null;let n="in"===x?String(e[a(144)]):String(e[a(165)]);r(t[a(199)],n);return}t[a(193)][i]=setTimeout(()=>{let $=a,n=parseInt(t[$(199)][$(174)],10),l;"in"===x?(l=e[$(282)].find($=>parseInt($)>n),n<e[$(165)]?l=String(e[$(165)]):l||(l=String(e[$(144)]))):(l=[...e.ZOOM_VALUES].reverse()[$(221)]($=>parseInt($)<n),l=[...e[$(282)]][$(316)]()[$(221)]($=>parseInt($)<n),n>e.MAX_ZOOM?l=String(e[$(144)]):l||(l=String(e[$(165)]))),r(t[$(199)],l),t[$(193)][i]=null},e.DOUBLE_PRESS_THRESHOLD)}function d(a){let i=$;"Equal"===a.code?o("in"):a[i(233)]===i(291)&&o(i(315)),[i(179),i(176),i(204),i(334),i(228),i(196)][i(244)](a[i(233)])&&function a(i){let n=$;if(!t.settings.panner)return;let l=n(240)+i;if(t[n(148)]){let o=document.querySelector(x.pannerSlider1),d=document.querySelector(x.pannerSlider2),c=document[n(299)](x[n(335)]),s=document[n(299)](x[n(161)]),_=document[n(299)](x[n(136)]);if(!o||!d||!c||!s||!_)return;let u=[n(179),n(176),n(204),n(334),n(228)],f=u.find($=>$===i);if(f){let b=n(240)+i;t[n(193)][b]?(clearTimeout(t.pressTimers[b]),t.pressTimers[b]=null,r(o,i===n(179)?"1":"0.03"),r(d,i===n(176)?"1":"0.03"),r(c,"KeyM"===i?"1":n(230)),r(s,i===n(334)?"1":n(230)),r(_,i===n(228)?"1":n(230))):t[n(193)][b]=setTimeout(()=>{let $=n;r(o,"KeyB"===i?"1":"0"),r(d,i===$(176)?"1":"0"),r(c,i===$(204)?"1":"0"),r(s,i===$(334)?"1":"0"),r(_,i===$(228)?"1":"0"),t[$(193)][b]=null},e[n(138)])}else i===n(196)&&(r(o,"1"),r(d,"1"),r(c,"1"),r(s,"1"),r(_,"1"));return}if(t.isFourSpeakerCall){let p=document[n(299)](x[n(236)]),v=document[n(299)](x[n(283)]),m=document.querySelector(x[n(335)]),h=document.querySelector(x[n(161)]);if(!p||!v||!m||!h)return;let S=[n(179),"KeyN",n(204),n(334)][n(221)]($=>$===i);S?t[n(193)][l]?(clearTimeout(t.pressTimers[l]),t[n(193)][l]=null,r(p,i===n(179)?"1":n(230)),r(v,i===n(176)?"1":n(230)),r(m,i===n(204)?"1":n(230)),r(h,i===n(334)?"1":n(230))):t[n(193)][l]=setTimeout(()=>{let $=n;r(p,i===$(179)?"1":"0"),r(v,i===$(176)?"1":"0"),r(m,i===$(204)?"1":"0"),r(h,i===$(334)?"1":"0"),t.pressTimers[l]=null},e[n(138)]):i===n(196)&&(r(p,"1"),r(v,"1"),r(m,"1"),r(h,"1"));return}if(t[n(305)]){let y=document[n(299)](x[n(236)]),g=document.querySelector(x[n(283)]),O=document[n(299)](x[n(335)]);if(!y||!g||!O)return;let E=[n(179),n(176),n(204)].find($=>$===i);if(E){if(t[n(193)][l]){clearTimeout(t[n(193)][l]),t.pressTimers[l]=null,r(y,"KeyB"===i?"1":n(230)),r(g,i===n(176)?"1":n(230)),r(O,i===n(204)?"1":n(230));return}t.pressTimers[l]=setTimeout(()=>{let $=n;r(y,i===$(179)?"1":"0"),r(g,i===$(176)?"1":"0"),r(O,i===$(204)?"1":"0"),t[$(193)][l]=null},e.DOUBLE_PRESS_THRESHOLD)}"Slash"===i&&(r(y,"1"),r(g,"1"),r(O,"1"))}else{let C=document[n(299)](x[n(236)]),R=document[n(299)](x[n(283)]);if(!C||!R)return;if("KeyB"===i||"KeyN"===i){if(t[n(193)][l]){clearTimeout(t.pressTimers[l]),t.pressTimers[l]=null,r(C,i===n(179)?"1":n(230)),r(R,i===n(176)?"1":n(230));return}t[n(193)][l]=setTimeout(()=>{let $=n;r(C,i===$(179)?"1":"0"),r(R,"KeyN"===i?"1":"0"),t[$(193)][l]=null},e[n(138)])}i===n(196)&&(r(C,"1"),r(R,"1"))}}(a.code)}function c(x){let e=$,t=document;for(let a=0;a<x[e(253)];a++){let i=x[a];if(a>0&&!(t=t[e(135)])||!(t=t[e(299)](i)))return null}return t}function s($,x,e){return new Promise(t=>{let a=$.scrollLeft,i=x-a,n=0,r=$=>$<.5?2*$*$:-1+(4-2*$)*$,l=x=>{let o=_0x432e;0===n&&(n=x);let d=x-n,c=r(Math.min(d/e,1));$[o(303)]=a+i*c,d<e?requestAnimationFrame(l):t()};requestAnimationFrame(l)})}function _(x){let e=$;if(!x)return 0;let t=window[e(187)](x),a=new DOMMatrix(t[e(175)]);return a[e(292)]}async function u(){let i=$,n=document[i(299)](x[i(137)]);if(!n)return console[i(242)]("Iframe Debug: Could not find Refresh button in sequence. Check SELECTORS.refreshButton.");n[i(130)](),await l(200),await new Promise($=>{a=$,window.parent.postMessage(i(168),"*")}),a=null;let r=document.querySelector(x[i(239)]);if(r){let o=c(x[i(139)]),d=c(x[i(172)]);if(o&&d){let u=0,b=0;for(;b<20;){if((u=_(d))>1){console[i(273)](i(294)+u+i(319)+(b+1));break}b++,await l(50)}if(u>1){let p=u-50;await s(o,Math.max(0,p),e[i(272)])}else console[i(242)](i(205)),await s(o,0,e[i(272)])}await l(50),r.click(),function e(){let a=$,i=document[a(299)](x.timerDisplay);if(!i)return console.error(a(133));if(!i||!i[a(261)][a(244)]("/"))return;let n=$=>{let x=a,e=$.textContent[x(142)]("/");if(e[x(253)]<2||e[0][x(252)]()===x(216)){console[x(242)](x(201));return}let i=f(e[0].trim()),n=f(e[1][x(252)]()),r=(n-i)/60;if(isNaN(r)){console[x(242)](x(178)),t[x(321)]=0;return}t.lastCalculatedMinutes=r,console[x(273)]("\uD83D\uDD70️ New duration calculated "+r[x(152)](2)+" minutes.")};if(i[a(261)][a(244)]("/")&&!i[a(261)][a(128)](a(216)))n(i);else{let r=document[a(299)](x[a(322)]);if(!r)return console[a(242)]("Iframe Debug: Could not find the stable PARENT (timerContainer) to watch for time changes.");let l=new MutationObserver(($,e)=>{let t=a,i=r[t(299)](x[t(157)]);i&&!i.textContent[t(128)](t(216))&&(n(i),e[t(249)]())});l.observe(r,{childList:!0,subtree:!0})}}()}else console[i(242)](i(257))}function f(x=$(216)){let e=$,t=String(x)[e(142)](":")[e(232)](Number);if(t[e(158)](isNaN))return console[e(242)](e(309)+x+'" resulted in NaN.'),0;if(2===t[e(253)]){let a=60*t[0]+t[1];return a}return console[e(242)](e(301)+x+e(270)),0}let b=new MutationObserver((r,o)=>{let c=$,s=document[c(299)](x.pannerSlider1),_=document[c(299)](x[c(283)]);t[c(199)]=document[c(299)](x.zoomSlider);let f=document[c(299)](x[c(279)]);s||_||console.error("Iframe Debug: Panner sliders not found. Check SELECTORS.pannerSlider1 and SELECTORS.pannerSlider2."),t.zoomSliderElement||console[c(242)](c(274)),f||console.error("Iframe Debug: Main container for cursor line not found. Check SELECTORS.cursorLine_mainContainer."),s&&_&&t.zoomSliderElement&&f&&(function e(){let r=$,o=new MutationObserver(($,e)=>{let a=_0x432e,i=document[a(299)](x[a(137)]);i&&(i.addEventListener(a(130),$=>{let x=a;($[x(195)]||$[x(167)])&&t[x(215)][x(302)]&&(console[x(273)](x(219)),$[x(190)](),$[x(149)](),u())}),e.disconnect())});o.observe(document[r(197)],{childList:!0,subtree:!0}),document[r(185)]("keydown",$=>{let e=r;if("Space"===$.code){$[e(262)](),$[e(190)]();let t=document.querySelector(x[e(239)]);t&&t[e(130)]();return}let a=[e(173),e(183)][e(244)]($[e(233)]),i=($[e(233)]===e(170)||$[e(233)]===e(308))&&($.ctrlKey||$.metaKey);(a||i)&&($[e(190)](),$.stopPropagation());let n=[e(200),e(247),e(177),e(241),e(147),e(307),e(235),"Numpad8","NumpadDivide",e(186)];if(n[e(244)]($[e(233)])&&$[e(190)](),$.target[e(337)]===e(304)||$.target[e(337)]===e(227))return;let l={type:"iframe_keydown",code:$.code};window[e(163)][e(198)](l,"*"),d($)},!0),document[r(185)](r(209),$=>{let x=r,e={type:"iframe_keyup",code:$[x(233)]};window[x(163)][x(198)](e,"*")}),window[r(185)]("message",async e=>{let o=r;if(e[o(332)]&&e[o(332)][o(286)]===o(287)){t[o(215)]=Object.assign({},t.settings,e[o(332)][o(215)]),i&&(i[o(164)].display=o(t.settings[o(263)]?256:231),n[o(164)][o(293)]=t.settings[o(263)]?"block":o(231));return}if(e[o(332)]&&e.data.type===o(214))document[o(269)][o(311)][o(226)](o(280),e.data.isDark);else if(e[o(332)]&&"session_info"===e[o(332)].type)t[o(305)]=e[o(332)][o(268)],t[o(145)]=e.data[o(180)],t[o(148)]=e.data.isFiveSpeaker;else if(e.data&&e.data.type===o(289)){let c=e[o(332)],s=[o(141),o(202),o(248)];if(s[o(244)](c[o(233)])){let _=new KeyboardEvent(o(310),{key:c[o(298)],code:c[o(233)],bubbles:!0,cancelable:!0});document[o(203)](_)}else d(e[o(332)])}else e[o(332)]===o(184)?u():"rejump_complete"===e[o(332)]?a&&a():e[o(332)]===o(277)?(await new Promise($=>{let e=_0x432e,t=e=>{let t=_0x432e,a=new MutationObserver(()=>{let e=_0x432e;document.querySelector(x[e(300)])||(a[e(249)](),$())});e[t(234)]&&a[t(162)](e.parentNode,{childList:!0})},a=document[e(299)](x[e(300)]);a?t(a):setTimeout(()=>{let i=e;(a=document[i(299)](x[i(300)]))?t(a):$()},500)}),await l(200),window[o(163)][o(198)]("audio_is_ready","*")):e[o(332)]===o(323)&&function x(){let e=$;0===t[e(321)]&&console[e(242)](e(150)),window[e(163)][e(198)]({type:e(208),minutes:t.lastCalculatedMinutes},"*")}()})}(),function x(a){let r=$,l=new ResizeObserver(()=>{let $=_0x432e,x=a[$(306)]();i[$(164)].top=x.top+"px";let e=x[$(131)];i[$(164)][$(131)]=e+"px"});l[r(162)](a),a[r(185)]("mouseenter",()=>{let $=r;t[$(215)][$(263)]&&(i[$(164)].display=$(256),n[$(164)][$(293)]="block")}),a[r(185)](r(129),$=>{let x=r;if(!t.settings.cursorLine)return;let l=document[x(299)](x(182)),o=document[x(299)](x(192)),d=document[x(299)](x(327)),c=document[x(299)](x(243)),s=null,_=document[x(328)]($.clientX,$[x(314)]);l?.contains(_)||d?.[x(146)](_)?s=x(271):(o?.[x(146)](_)||c?.[x(146)](_))&&(s=x(333)),s===x(271)?(n.style.transition=x(132),n[x(164)][x(297)]=x(255)+e[x(194)],n[x(164)][x(254)]=e[x(326)]):"right"===s?(n.style[x(285)]=x(132),n[x(164)][x(297)]="0 0 2px 2px "+e[x(194)],n[x(164)][x(254)]=e[x(326)]):(n[x(164)].boxShadow=x(255)+e[x(194)],n[x(164)][x(254)]=e[x(326)]);let u=a.getBoundingClientRect();i[x(164)][x(175)]=x(318)+($[x(140)]+e[x(331)])+x(207),n.style.left=$[x(140)]-3.25+"px",$[x(314)]>=u[x(155)]&&$[x(314)]<=u[x(281)]&&(n.style[x(155)]=$[x(314)]-6+"px")}),a[r(185)](r(153),()=>{})}(f),o.disconnect(),window.parent.postMessage({type:"iframe_ready"},"*"),console.log(c(245)))});b[$(162)](document[$(197)],{childList:!0,subtree:!0})}();