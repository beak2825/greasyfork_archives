// ==UserScript==
// @name         Neopets: Auto-Buyer (Stamp)
// @namespace    https://greasyfork.org/en/users/248719-rotomdex
// @version      0.1
// @description  A Neopets Post Office stamp auto-clicker. To be used in conjunction with a Neopets Main Shop auto-haggler.
// @author       twitter.com/RotomDex
// @match        http://www.neopets.com/objects.phtml?type=shop&obj_type=58*
// @match        http://www.neopets.com/objects.phtml?obj_type=58*
// @grant        none
// @require      http://code.jquery.com/jquery-3.3.1.min.js
// @downloadURL https://update.greasyfork.org/scripts/390726/Neopets%3A%20Auto-Buyer%20%28Stamp%29.user.js
// @updateURL https://update.greasyfork.org/scripts/390726/Neopets%3A%20Auto-Buyer%20%28Stamp%29.meta.js
// ==/UserScript==

// mirror of https://raw.githubusercontent.com/hectorvazc/jsfun/master/jsfun.min.js
// just slap this in @require up there https://raw.githubusercontent.com/nerkmid/neo/master/jsfun.js
function find_selector(e,t) {var n=void 0===t?document.querySelectorAll(e):t.querySelectorAll(e);return console.assert(n.length,["find_selector:",e,t,"is undefined"].join(" ")),0===n.length?void 0:1===n.length?n[0]:n}
function isNode(e){return e instanceof Node}
function isNodeList(e){return e instanceof NodeList}
function fn(e){void 0!==e&&function(){e()}(this)}
function foreach(e,t){return void 0!==e&&void $array(e).forEach(function(e,n,i){t(e,n,i)})}
function $array(e){if(void 0===e)return[];var t=[],n=/^\[object (string)\]$/gi.test({}.toString.call(e))||/^\[object (htmlselectelement)\]$/gi.test({}.toString.call(e));return void 0===e.length||n?t.push(e):t=Array.from(e),t}
function $detach(e){var t=e.parentNode;if(t)return t.removeChild(e),e}
function bind_event(e,t,n,i){var i=i||"events",o="",s=[],r=$data(e,i);if(void 0!==r&&(o=e.dataset[i]),empty(o))s=[];else var s=getJSON(o);s.length>0&&s.indexOf(t)!==-1||(s.push(t),e.dataset[i]=setJSON(s),e.addEventListener(t,n))}
function empty(e){return 0===e.length||!e.trim()}
function $data(e,t){return e.dataset[t]}
function newElement(e){return document.createElement(e)}
function key_code(e){return parseInt(e.keyCode||e.which)}
function setJSON(e){return JSON.stringify(e)}function getJSON(e){return JSON.parse(e)}
function parent(e,t){if(void 0===t)return e.parentNode;for(var n=0;n<Number(t);n++)e=e.parentNode;return e}
function ajax(e,t,n){return new Promise(function(i,o){var s;s=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),s.open(e,t,!0),s.onload=i,s.onerror=o,void 0!==n?s.send(n):s.send()})}
function getObjectSession(e,t){var n=sessionStorage.getItem(e);return null===n?(void 0!==t&&(console.log("Saving default value"),setObjectSession(e,t)),t):getJSON(n)}
function removeObjectSession(e){void 0!==getObjectSession(e)&&(sessionStorage.removeItem(e),void 0===getObjectSession(e)&&console.log("object removed"))}
function setObjectSession(e,t){sessionStorage.setItem(e,setJSON(t))}
function getObject(e,t){var n=localStorage.getItem(e);return null===n?(void 0!==t&&(console.log("Saving default value"),setObject(e,t)),t):getJSON(n)}
function removeObject(e){void 0!==getObject(e)&&(localStorage.removeItem(e),void 0===getObject(e)&&console.log("object removed"))}
function setObject(e,t){localStorage.setItem(e,setJSON(t))}
var debFlag=!0,log=function(e,t){(void 0===t||t)&&debFlag&&console.log(e)},
    js=function e(t){return this instanceof e?(void 0!==t&&(isNode(t)||(t=find_selector(t))),this.element=t,this.context=void 0,this):new e(t)};
    js.prototype.get=function(){return this.context=void 0,this.element},
    js.prototype.getNode=function(e){var t=find_selector(e,this.context);return this.context=void 0,t},
    js.prototype.find=function(e){return this.element=find_selector(e,this.context),this.context=void 0,this},
    js.prototype.here=function(e){if(isNode(e))this.context=e;else{var t=find_selector(e);void 0===t?this.context=void 0:isNodeList(t)?this.context=t[0]:this.context=t}return this},
    js.prototype.html=function(e){return void 0===e?this.element.innerHTML:(this.element.innerHTML=e,this)},
    js.prototype.empty=function(){return this.element.innerHTML="",this},
    js.prototype.append=function(e){return this.element.innerHTML=[this.element.innerHTML,e].join(" "),this},
    js.prototype.exist=function(e){return void 0!==this.element},
    js.prototype.val=function(e){if(void 0!==this.element)return void 0===e?this.element.value:(this.element.value=e,this)},
    js.prototype.clean=function(){this.element=void 0,this.context=void 0},
    js.prototype.first=function(){return this.element=$array(this.element)[0],this},
    js.prototype.setAttribute=function(e){return"object"==typeof e&&(void 0!==this.element?foreach(this.element,function(t){for(var n in e)t.setAttribute(n,e[n])}):log("this.element is undefined. setAttribute call."),this)},
    js.prototype.removeAttribute=function(e){return void 0!==this.element?foreach(this.element,function(t){foreach(e,function(e){t.removeAttribute(e)})}):log("this.element is undefined. removeAttribute call."),this},
    js.prototype.addStyle=function(e){return"object"==typeof e&&(void 0!==this.element?foreach(this.element,function(t){for(var n in e)t.style.setProperty(n,e[n])}):log("this.element is undefined. addStyle call."),this)},
    js.prototype.removeStyle=function(e){return void 0!==this.element?foreach(this.element,function(t){foreach(e,function(e){t.style.removeProperty(e)})}):log("this.element is undefined. removeStyle call."),this},
    js.prototype.addClass=function(e){return void 0!==this.element?foreach(this.element,function(t){foreach(e,function(e){t.classList.add(e)})}):log("this.element is undefined. addClass call."),this},
    js.prototype.removeClass=function(e){return void 0!==this.element?foreach(this.element,function(t){foreach(e,function(e){t.classList.contains(e)&&t.classList.remove(e)})}):log("this.element is undefined. removeClass call."),this},
    js.prototype.hide=function(){return void 0!==this.element?foreach(this.element,function(e){e.style.setProperty("display","none")}):log("this.element is undefined. hide call."),this},
    js.prototype.show=function(){return void 0!==this.element?foreach(this.element,function(e){e.style.removeProperty("display")}):log("this.element is undefined. show call."),this},
    js.prototype.resize=function(){if(void 0!==this.element)return this.element.style.height="1px",this.element.style.height=this.element.scrollHeight+"px",this},
    js.prototype.text=function(){return void 0===this.element?"":this.element.innerText||this.element.textContent},
    js.prototype.insertFirst=function(e){if(void 0!==this.element)return this.element.insertAdjacentElement("afterbegin",e),this},
    js.prototype.insertLast=function(e){if(void 0!==this.element)return this.element.insertAdjacentElement("beforeend",e),this},
    js.prototype.insertBefore=function(e){if(void 0!==this.element)return this.element.insertAdjacentElement("beforebegin",e),this},
    js.prototype.insertAfter=function(e){if(void 0!==this.element)return this.element.insertAdjacentElement("afterend",e),this},
    js.prototype.detach=function(){if(void 0!==this.element){var e=[];return foreach(this.element,function(t){e.push($detach(t))}),e}},
    js.prototype.visible=function(){if(void 0!==this.element)return"none"!==this.element.style.display},
    js.prototype.hidden=function(){if(void 0!==this.element)return!this.visible()},
    js.prototype.each=function(e){void 0!==this.element?(foreach(this.element,e),this.clean()):log("this.element is undefined. show call.")},
    js.prototype.event=function(e,t,n){return void 0===this.element?(log("this.element is undefined. event call."),this):(foreach(this.element,function(i){foreach(e,function(e){bind_event(i,e,t,n)})}),void this.clean())};
// end required shit

var ItemsToIgnore = [
"Maraquan Troops Stamp",
"Shenkuu Lunar Temple Stamp",
"Shenkuu City Stamp",
"Kentari Stamp",
"Maraquan Defenders Stamp",
"Moonlit Esophagor Stamp",
"Pirate Attack Stamp",
"Linae Stamp",
"Fauna Stamp",
"Igneot Stamp",
"Snowbunny Stamp",
"Advert Attack Stamp",
"Nova Storm Stamp",
"Advisor Wessle Stamp",
"Dice-A-Roo Stamp",
"First Edition Altador Petpet Stamp",
"Grackle Bug Stamp",
"Lost Desert Grarrl Stamp",
"Destruct-O-Match Stamp",
"Archmagus of Roo Stamp",
"Book Shop Nimmo Stamp",
"Plains Aisha Stamp",
"Slorg Flakes Stamp",
"Wishing Well Stamp",
"Faerie Techo Plushie Stamp",
"Mr Irgo Stamp",
"Snowball Fight Stamp",
"Wintery Petpet Shop Stamp",
"Huberts Hot Dogs Stamp",
"Healing Springs Stamp",
"Money Tree Stamp",
"Petpet Growth Syrup Stamp",
"Senator Palpus Stamp",
"Temple Of The Sky Stamp",
"Christmas Uni Stamp",
"Altador Food Stamp",
"Second Edition Altador Petpet Stamp",
"Esophagor Stamp",
"Fetch! Stamp",
"Halloween Aisha Stamp",
"Zeenana Stamp",
"Kazeriu Stamp",
"Haiku Stamp",
"Triangular Flotsam Stamp",
"Halloween Ona Stamp",
"Master Vex Stamp",
"Mystery Island Heads Stamp",
"Gelert Prince Stamp",
"Roast Gargapple Stamp",
"Anshu Stamp",
"Captain Tuan Stamp",
"Spooky Gravestone Stamp",
"Island Mystic Stamp",
"Mystery Island Hut Stamp",
"Orange Draik Stamp",
"Island Native Stamp",
"Assorted Fruits Stamp",
"Ryshu Stamp",
"Jhuidah Stamp",
"Everlasting Crystal Apple Stamp",
"Korbats Lab Stamp",
"The Arcanium Stamp",
"Commemorative Defenders Stamp #1",
"Frosty Snowman Stamp",
"Jerdana Stamp",
"Leirobas Stamp",
"Petty Crewmate Stamp",
"Two Rings Crusader Stamp",
"Attack Pea Stamp",
"Commemorative Defenders Stamp #2",
"Grimilix Stamp",
"Piraket Stamp",
"Sword of Skardsen Stamp",
"Snow Faerie Stamp",
"Christmas Kougra Stamp",
"Rotting Skeleton Stamp",
"Gordos Stamp",
"Negg Noodles Stamp",
"Tug Of War Stamp",
"Boraxis the Healer Stamp",
"New Maraqua Stamp",
"Chunk of Meat Stamp",
"Enchanted Pudao Stamp",
"Slime Titan Stamp",
"The Wave Stamp",
"Two Rings Archmagus Stamp",
"Orange Skeith Stamp",
"Shenkuu Draik Stamp",
"Golden Khamette Stamp",
"Rainbow Slushie Stamp",
"Terror Mountain Scene Stamp",
"Hubrids Puzzle Box Stamp",
"Gormball Stamp",
"Gallion Stamp",
"Black Bearog Stamp",
"Mystery Island Kougra Stamp",
"Robot Skeith Stamp",
"Tyrannian Korbat Stamp",
"Veggie Pizza Stamp",
"Purple Grundo Stamp",
"Stone Armchair Stamp",
"Tyrannian JubJub Stamp",
"Rampaging Grundonoil Stamp",
"Desert Petpet Stamp",
"Drooling Quadrapus Stamp",
"Faerie Slingshot Stamp",
"Grinning Sloth Stamp",
"Mist Kougra Stamp",
"Pyramid Sun Rise Stamp",
"Entrance to Moltara Stamp",
"Snow Wars Catapult Stamp",
"Angry Janitor Stamp",
"Lord Darigan Stamp",
"Christmas Meerca Stamp",
"Goregas Stamp",
"Jhudoras Bewitched Ring Stamp",
"Neopet Version 2 Stamp",
"Stocking Stamp",
"Sword of the Air Faerie Stamp",
"Cyodrakes Gaze Logo Stamp",
"Ruins of Qasala Stamp",
"Kelland Stamp",
"Kou-Jong Tile Stamp",
"Osiris Pottery Stamp",
"Draik Guard Stamp",
"Perfectly Flat Rock Stamp",
"Qasalan Delights Stamp",
"Rohane Stamp",
"Thyoras Tear Stamp",
"Words of Antiquity Stamp",
"The Lighthouse Stamp",
"Faerieland Justice Stamp",
"Grand Theft Ummagine Stamp",
"Quiggle Scout Stamp",
"Suteks Tomb Stamp",
"Psellia Stamp",
"Velm Stamp",
"Darigan Eyrie Stamp",
"Zafara Princess Stamp",
"Geb Stamp",
"Grundo Snow Throw Stamp",
"Jeran Stamp",
"Library Faerie Stamp",
"Wintery Bruce Stamp",
"Morax Dorangis Stamp",
"Ancient Contract Stamp",
"The Black Pawkeet Stamp",
"Neolodge Stamp",
"Alien Aisha Vending Stamp",
"Altadorian Farmer Stamp",
"Riches of Krawk Island Stamp",
"Young Sophie Stamp",
"Fruit Bomb Stamp",
"Seaweed Necklace Stamp",
"Pirate Troops Stamp",
"Faerie City Stamp",
"Lost Desert Sphinx Stamp",
"Tyrannian Kyrii Stamp",
"Maractite Dagger Stamp",
"Siyana Stamp",
"Skeith Bank Manager Stamp",
"Blarthrox Stamp",
"Chasm Beast Stamp",
"Marak Stamp",
"Rohanes Mother Stamp",
"Scurvy Island Stamp",
"Usukiland Stamp",
"Wand Of The Dark Faerie Stamp",
"Christmas Zafara Stamp",
"Splat-A-Sloth Stamp",
"Coco Stamp",
"Illusens Staff Stamp",
"Neopian Hospital Stamp",
"Peopatra Stamp",
"Pomanna Stamp",
"Kolvars Stamp",
"Neovia Stamp",
"Ski Lodge Stamp",
"Faerie Foods Stamp",
"Rusty Door Stamp",
"Maraquan Charger Stamp",
"Midnight Desert Lupe Stamp",
"Mutant Grundo Stamp",
"Plesio Stamp",
"Sakhmet Palace Stamp",
"Snowglobe Faerie Stamp",
"Faerieland Petpet Shopkeeper Stamp",
"N4 Bot Stamp",
"Meridell Gardens Stamp",
"Monoceraptor Claw Stamp",
"Tyrannian Grarrl Stamp",
"Trestin Stamp",
"Bone Chair Stamp",
"Exploding Space Bugs Stamp",
"King Skarl Stamp",
"Rock Stamp",
"Scratchcard Kiosk Stamp",
"Captain of Fyoras Guards Stamp",
"Mutant Usul Stamp",
"Zygorax Stamp",
"Dark Graspberry Stamp",
"Fruit Machine Stamp",
"Golden Orb Stamp",
"Magma Pool Stamp",
"Maraquan Blade Specialist Stamp",
"Bonju Stamp",
"Rink Runner Stamp",
"Librarian Stamp",
"Pineapple Dessert Stamp",
"Alien Aisha Ray Gun Stamp",
"Giant Leaf Curtains Stamp",
"Trapped Tomos Stamp",
"Devilpuss Stamp",
"Rod Of Dark Nova Stamp",
"Kauvara Stamp",
"Florin Stamp",
"Hubrid Nox Stamp",
"Qasalan Tablet Stamp",
"Scarab Stamp",
"Christmas Scene Stamp",
"Deluxe Money Tree Stamp",
"105 Castle Secrets Stamp",
"Underwater Chef Stamp",
"Chocolate Factory Stamp",
"Turmaculus Stamp",
"Cliffhanger Stamp",
"Jewelled Scarab Stamp",
"Senator Barca Stamp",
"Alien Aisha Myriad Stamp",
"Edna the Zafara Stamp",
"Brain Tree Stamp",
"Tasu Stamp",
"Crumpetmonger Stamp",
"Delina Stamp",
"Eraser of the Dark Faerie Stamp",
"Glowing Brain Tree Stamp",
"Guard Zomutt Stamp",
"Meridell Shield Stamp",
"Shield Of Pion Troect Stamp",
"Tyrannian Usul Stamp",
"Attack of the Slorgs Stamp",
"Molten Morsels Stamp",
"Jelly Pop Stamp",
"Shop Wizard Stamp",
"Zombie Faleinn Stamp",
"Celestial Talisman Stamp",
"Kings Lens Stamp",
"Hubrid Noxs Mountain Fortress Stamp",
"Mystery Island Travel Stamp",
"Darigan Shield Stamp",
"Shenkuu Bridge Stamp",
"Igloo Garage Sale Stamp",
"Commemorative Defenders Stamp #3",
"Faerie Bubbles Stamp",
"Qasalan Coffee Set Stamp",
"The Drenched Stamp",
"Darigan Elemental Stamp",
"Moonlit Werelupe Stamp",
"Pile of Dung Stamp",
"SHFISS Stamp",
"NeoQuest II Logo StampEvil Fuzzles Stamp",
"Lady Frostbite Stamp",
"Caylis Stamp",
"Yes-Boy Ice Cream Stamp",
"Charms Stamp",
"Bringer of Night Stamp",
"Hanso Stamp",
"Lost Desert Scroll Stamp",
"Plushie Slorg Stamp",
"Illusen Stamp",
"Dubloon-O-Matic Stamp",
"Usul-in-waiting Stamp",
"Smugglers Cove Stamp",
"Exploding Acorns Stamp",
"Faerie Furniture Shopkeeper Stamp",
"Mayor of Moltara Stamp",
"Castle Defender Stamp",
"Lisha vs Zombie Lisha Stamp",
"Sunblade Stamp",
"Super Bright Rainbow Pool Stamp",
"Gatekeeper Stamp",
"Kreai Stamp",
"Holographic Sakhmet City Stamp",
"Battle Eyrie Stamp",
"Docked Ship Stamp",
"Hoban Stamp",
"Bottled Faerie Stamp",
"Garin To The Rescue Stamp",
"Flying Korbats Stamp",
"King Skarl Plushie Stamp",
"Tyrannian Plateau Stamp",
"Family Portrait Stamp",
"Kentari Spyglass Stamp",
"Desert Arms Stamp",
"Scorchio Mummy Stamp",
"Boris Stamp",
"Jade Scorchstone Stamp",
"Krawk Island Governor Stamp",
"Ruins of Faerieland Stamp",
"Mutant Techo Plushie Stamp",
"Bug Eye McGee Stamp",
"Mokti and Rikti Stamp",
"Princess Sankara Stamp",
"Qasalan Mummy Stamp",
"Tazzalor Stamp",
"Yiko Stamp",
"Tyrannian Blumaroo Stamp",
"Carnival of Terror Stamp",
"Tylix Stamp",
"Snowager Stamp",
"Evil Fuzzles Stamp",
"Lady Frostbite Stamp",
"Caylis Stamp",
"Yes-Boy Ice Cream Stamp",
"Charms Stamp",
"Bringer of Night Stamp",
"Hanso Stamp",
"Lost Desert Scroll Stamp",
"Plushie Slorg Stamp",
"Illusen Stamp",
"Dubloon-O-Matic Stamp",
"Usul-in-waiting Stamp",
"Smugglers Cove Stamp",
"Exploding Acorns Stamp",
"Faerie Furniture Shopkeeper Stamp",
"Mayor of Moltara Stamp",
"Castle Defender Stamp",
"Lisha vs Zombie Lisha Stamp",
"Sunblade Stamp",
"Super Bright Rainbow Pool Stamp",
"Gatekeeper Stamp",
"Kreai Stamp",
"Holographic Sakhmet City Stamp",
"Battle Eyrie Stamp",
"Docked Ship Stamp",
"Hoban Stamp",
"Bottled Faerie Stamp",
"Garin To The Rescue Stamp",
"Flying Korbats Stamp",
"King Skarl Plushie Stamp",
"Tyrannian Plateau Stamp",
"Family Portrait Stamp",
"Kentari Spyglass Stamp",
"Desert Arms Stamp",
"Scorchio Mummy Stamp",
"Boris Stamp",
"Jade Scorchstone Stamp",
"Krawk Island Governor Stamp",
"Ruins of Faerieland Stamp",
"Mutant Techo Plushie Stamp",
"Bug Eye McGee Stamp",
"Mokti and Rikti Stamp",
"Princess Sankara Stamp",
"Qasalan Mummy Stamp",
"Tazzalor Stamp",
"Yiko Stamp",
"Tyrannian Blumaroo Stamp",
"Carnival of Terror Stamp",
"Tylix Stamp",
"Snowager Stamp",
"Talinia Stamp",
"Luperus Centre Head Stamp",
"Dark Qasala Stamp",
"Destruction of Faerieland Stamp",
"Haunted Mansion Stamp",
"Meridell Castle Stamp",
"Luperus Left Head Stamp",
"Zombified Heroes Stamp",
"Moltara Town Hall Stamp",
"Gargarox Isafuhlarg Stamp",
"The Krawken Stamp",
"Buried Treasure Stamp",
"Fyora Faerie Doll Stamp",
"Razul Stamp",
"Orrin Stamp",
"Thoughtful Linae Stamp",
"Blumaroo Court Jester Stamp",
"Lava Monster Stamp",
"Ruler of the Five Seas Stamp",
"Dorak Stamp",
"Zyrolon Stamp",
"Cogs Togs Stamp",
"RIP Lucy Stamp",
"Hot Dog Hero Stamp",
"Dr. Sloth Stamp",
"Tangor Stamp",
"The Revenge Stamp",
"Lupe Shopkeeper Stamp",
"Hubrid Nox Commemorative Stamp",
"Finneus Stamp",
"Negg Faerie Stamp",
"Sentient Headstones Stamp",
"Green Knight Stamp",
"Astronomy Club Stamp",
"Hannah Stamp",
"Petpet Cannonball Stamp",
"Shenkuu Mask Stamp",
"Mellow Marauders Plushie Stamp",
"Neopia Central Scene Stamp",
"Desert Paint Brush Stamp",
"Rainbow Pool Stamp",
"Sliding Darblat Stamp",
"Fountain Faerie Stamp",
"Zurroball Stamp",
"Eleus Stamp",
"Spyder Stamp",
"Magma Pool Guard Stamp",
"Jelly World Stamp",
"Bruno Stamp",
"Spirit of Slumber Stamp"];

var DelayMax = 2300;
var DelayMin = 1000;

var ignore = [];
for (var i = 0; i < ItemsToIgnore.length; i++)
{
    ignore.push(new RegExp(ItemsToIgnore[i].replace(/\x20+/g, "\\x20+"), "i"));
}

var shopContents = document.body.textContent || document.body.innerText;
var emptyshop = shopContents.indexOf("Sorry, we are sold out of everything!")!==-1;

if (!emptyshop)
{
    var content = js().getNode('table[align="center"][cellpadding="4"][border="0"]');
    js().here(content).find('tr').each(function(tr){
        js().here(tr).find('td').each(function(td){
            var a = js().here(td).find('a').detach()[0];
            js(a).removeAttribute('onclick');
            js(td).insertFirst(a);
        });
    });

    var items = $("a[href*='haggle']").toArray();

    for (var v = 0, j; v < items.length;)
    {
        for (j = 0; j < ignore.length; j++)
        {
            if (ignore[j].test($(items[v]).siblings("b:first").text()))
            {
                break;
            }
        }
        if (j == ignore.length)
        {
            v++;
        }
        else
        {
            items.splice(v, 1);
        }
    }
    if (items.length)
    {
        items[Math.round(Math.random() * (items.length - 1))].click();
    }
    else
    {
        setTimeout
        (
            function () { $("img[src*='shopkeepers']").parent()[0].click(); },
            (Math.round(Math.random() * (DelayMax - DelayMin)) + DelayMin)
        );
    }
}
else
{
    setTimeout
    (
        function () { $("img[src*='shopkeepers']").parent()[0].click(); },
        (Math.round(Math.random() * (DelayMax - DelayMin)) + DelayMin)
    );
}