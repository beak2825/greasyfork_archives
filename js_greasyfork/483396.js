// ==UserScript==
// @name      海角社区脚本
// @namespace    haijiao-script
// @version      0.1.2
// @author       memopac
// @description  海角社区视频解析
// @license      MIT
// @icon         https://pomf2.lain.la/f/erejxtfo.ico
// @supportURL   https://sleazyfork.org/zh-CN/scripts/462265-%E6%B5%B7%E8%A7%92%E7%A4%BE%E5%8C%BA%E8%84%9A%E6%9C%AC
// @match        *://*.haijiao.com/*
// @match        *://hj91acfc.top/*
// @match        *://*/post/details*
// @require      https://cdn.jsdelivr.net/npm/jquery@3.7.1
// @grant        GM_addStyle
// @grant        GM_xmlhttpRequest
// @run-at       document-start
// @downloadURL https://update.greasyfork.org/scripts/483396/%E6%B5%B7%E8%A7%92%E7%A4%BE%E5%8C%BA%E8%84%9A%E6%9C%AC.user.js
// @updateURL https://update.greasyfork.org/scripts/483396/%E6%B5%B7%E8%A7%92%E7%A4%BE%E5%8C%BA%E8%84%9A%E6%9C%AC.meta.js
// ==/UserScript==
(t=>{if(typeof GM_addStyle=="function")
{GM_addStyle(t);return}const
e=document.createElement("style");e.textContent=t,document.head.append(e)})
(" .crack_container{position:fixed;top:80px;right:20px;background-color:#ebebeb}.crack_title{font-size:20px;font-weight:700;text-align:center;border:1px solid #000;cursor:pointer;display:block}.crack_player{position:fixed;top:0;bottom:0;left:0;right:0}.crack_player .iframeBox{width:70vw;margin:auto} ");
(function (l) {  'use strict';  var v=(()=>typeof GM_xmlhttpRequest<"u"?GM_xmlhttpRequest:void 0)();function E(){var t="ABCD*EFGHIJKLMNOPQRSTUVWX#YZabcdefghijklmnopqrstuvwxyz1234567890",o=(this.encode=function(e){var r,a,c,s,i,x,u="",p=0;for(e=o(e);p<e.length;)c=(r=e.charCodeAt(p++))>>2,s=(3&r)<<4|(r=e.charCodeAt(p++))>>4,i=(15&r)<<2|(a=e.charCodeAt(p++))>>6,x=63&a,isNaN(r)?i=x=64:isNaN(a)&&(x=64),u=u+t.charAt(c)+t.charAt(s)+t.charAt(i)+t.charAt(x);return u},this.decode=function(e){var r,a,c,s,i,x,u="",p=0;for(e=e.replace(/[^A-Za-z0-9\*\#]/g,"");p<e.length;)c=t.indexOf(e.charAt(p++)),r=(15&(s=t.indexOf(e.charAt(p++))))<<4|(i=t.indexOf(e.charAt(p++)))>>2,a=(3&i)<<6|(x=t.indexOf(e.charAt(p++))),u+=String.fromCharCode(c<<2|s>>4),i!=64&&(u+=String.fromCharCode(r)),x!=64&&(u+=String.fromCharCode(a));return n(u)},function(e){e=e.replace(/\r\n/g,``);for(var r="",a=0;a<e.length;a++){var c=e.charCodeAt(a);c<128?r+=String.fromCharCode(c):r=127<c&&c<2048?(r+=String.fromCharCode(c>>6|192))+String.fromCharCode(63&c|128):(r=(r+=String.fromCharCode(c>>12|224))+String.fromCharCode(c>>6&63|128))+String.fromCharCode(63&c|128);}return r}),n=function(e){for(var r,a,c="",s=0,i=0;s<e.length;)(r=e.charCodeAt(s))<128?(c+=String.fromCharCode(r),s++):191<r&&r<224?(i=e.charCodeAt(s+1),c+=String.fromCharCode((31&r)<<6|63&i),s+=2):(i=e.charCodeAt(s+1),a=e.charCodeAt(s+2),c+=String.fromCharCode((15&r)<<12|(63&i)<<6|63&a),s+=3);return c};}const O=()=>{_("脚本更新地址：https://sleazyfork.org/zh-CN/scripts/462265-%E6%B5%B7%E8%A7%92%E7%A4%BE%E5%8C%BA%E8%84%9A%E6%9C%AC");},_=(...t)=>{console.log("\x1B[42m%s\x1B[0m","HAIJIAO-SCRIPT",...t);},U=t=>Object.prototype.toString.call(t)==="[object String]",q=t=>Object.prototype.toString.call(t)==="[object Object]",H=(t,o)=>`https://tools.thatwind.com/tool/m3u8downloader#m3u8=${encodeURIComponent(t)}&referer=${window.location.href}&filename=${o}`,M=()=>/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase());(function(t,o){const n=f,e=t();for(;[];)try{if(-parseInt(n(118))/1+parseInt(n(113))/2*(parseInt(n(112))/3)+parseInt(n(120))/4*(-parseInt(n(121))/5)+parseInt(n(127))/6*(parseInt(n(123))/7)+-parseInt(n(122))/8+parseInt(n(126))/9+-parseInt(n(119))/10*(-parseInt(n(124))/11)===o)break;e.push(e.shift());}catch{e.push(e.shift());}})(b,124906);const B=function(){let t=!![];return function(o,n){const e=t?function(){const r=f;if(n){const a=n[r(116)](o,arguments);return n=null,a}}:function(){};return t=![],e}}(),I=B(globalThis,function(){const t=f;return I[t(110)]().search("(((.+)+)+)+$").toString()[t(114)](I)[t(111)](t(115))});I();function b(){const t=["解密失败","629982qCMCIp","6eBxJTU","toString","search","33qjTkai","5962QPbcpz","constructor","(((.+)+)+)+$","apply","data","50590MhtKly","20oXGBpe","4raUXAT","839700FlONdT","981280bqYHeP","974827ohAdGu","1232253LbokHk"];return b=function(){return t},b()}function f(t,o){const n=b();return f=function(e,r){return e=e-110,n[e]},f(t,o)}const R=t=>{const o=f,n=U(t);let e=t;try{if(n){const r=JSON.parse(t);q(r)&&(e=JSON.parse(atob(atob(atob(r==null?void 0:r[o(117)])))));}}catch{_(o(125));}return e};(function(t,o){const n=d,e=t();for(;[];)try{if(-parseInt(n(286))/1+parseInt(n(266))/2*(-parseInt(n(279))/3)+-parseInt(n(271))/4+-parseInt(n(263))/5*(-parseInt(n(287))/6)+-parseInt(n(275))/7*(-parseInt(n(278))/8)+parseInt(n(285))/9+parseInt(n(269))/10===o)break;e.push(e.shift());}catch{e.push(e.shift());}})(g,713540);const T=function(){let t=!![];return function(o,n){const e=t?function(){const r=d;if(n){const a=n[r(281)](o,arguments);return n=null,a}}:function(){};return t=![],e}}(),S=T(globalThis,function(){const t=d;return S[t(272)]()[t(267)](t(284))[t(272)]()[t(273)](S)[t(267)]("(((.+)+)+)+$")});S();function g(){const t=["4797352YxJZLC","toString","constructor","test","37429SWYYMR","reload","defineProperty","1016AELVxl","524571vXFIDA","includes","apply","response","prototype","(((.+)+)+)+$","8179308dFbPUo","583785HchkpG","54mrqdvj","getOwnPropertyDescriptor","call","476590tlFUDe","get","responseText","4jZqYFs","search","ontimeout","4006340kScvDY","open"];return g=function(){return t},g()}function d(t,o){const n=g();return d=function(e,r){return e=e-262,n[e]},d(t,o)}function L(t,o){const n=d;if(!Object)return;const e=XMLHttpRequest.prototype.open;XMLHttpRequest[n(283)][n(270)]=function(r,a){const c=n;if(a=String(a),this[c(268)]=function(){const s=c;window.location[s(276)]();},/\/api\/topic\/\d+/[c(274)](a)){const s=this,i=Object[c(288)](XMLHttpRequest[c(283)],c(282)).get;Object[c(277)](s,c(265),{get:()=>{let u=i[c(262)](s);return t(u),u}});}if(String(a)[c(280)]("/api/address/")){const s=this,i=Object[c(288)](XMLHttpRequest.prototype,"response")[c(264)];Object[c(277)](s,c(265),{get:()=>{let u=i[c(262)](s);return o(u),u}});}e[c(281)](this,arguments);};}function m(){const t=["16HQzMym","12mSHowu",".m3u8","474772EpdAiM","split","apply","2967730HPvYqT","2xjKHHH","2800827XPKqUR","constructor","19017660zgEkws","(((.+)+)+)+$","146868QOmFmv","4165126saIUvN","match","replace","search","21239sDaWPy"];return m=function(){return t},m()}(function(t,o){const n=h,e=t();for(;[];)try{if(-parseInt(n(442))/1*(parseInt(n(450))/2)+-parseInt(n(444))/3*(-parseInt(n(446))/4)+parseInt(n(449))/5+parseInt(n(437))/6+parseInt(n(438))/7+parseInt(n(443))/8*(parseInt(n(451))/9)+-parseInt(n(453))/10===o)break;e.push(e.shift());}catch{e.push(e.shift());}})(m,387215);const N=function(){let t=!![];return function(o,n){const e=t?function(){const r=h;if(n){const a=n[r(448)](o,arguments);return n=null,a}}:function(){};return t=![],e}}(),y=N(globalThis,function(){const t=h;return y.toString().search("(((.+)+)+)+$").toString()[t(452)](y)[t(441)](t(436))});function h(t,o){const n=m();return h=function(e,r){return e=e-436,n[e]},h(t,o)}y();const P=t=>{const o=h;try{let n=t[o(447)](``)[6],e=n[o(439)](/([\w_]+_?)[\d]+.ts/);if(e)return n[o(440)](e[0],e[1]+o(445))}catch{return ""}return ""};function A(){const t=document.querySelector("span.sell-btn")||document.querySelector("div.pagecontainer")||document.querySelector("div.publicContainer");return t&&($(t).attr("crack")||$(t).html("").attr("crack","crack")),t}const C=l(`<div class="crack_container" id="crack_container">    <a class="crack_title crack_jump_link" target="_blank" href="https://sleazyfork.org/zh-CN/scripts/462265-%E6%B5%B7%E8%A7%92%E7%A4%BE%E5%8C%BA%E8%84%9A%E6%9C%AC">脚本说明</a>  </div>`);l("body").append(C);const z="https://hits.dwyl.com/memopac/haijiao-script.svg?style=flat-square",k=()=>{if(C.find("#successImg").length)return;const t=l(`<div class="crack_title" id="successImg"><img src="${z}" width="94"/></div>`);C.children().first().after(t);},X=t=>{k();const o=`https://m3u8play.dev/?url=${t}`,n=l('<a class="crack_title crack_jump_link" target="_blank">跳转播放1</a>').attr("href",o),e=`https://m3u8play.com/?play=${encodeURIComponent(t)}`,r=l('<a class="crack_title crack_jump_link" target="_blank">跳转播放2</a>').attr("href",e),a=`https://m.auok.run/player/#${t}`,c=l('<a class="crack_title crack_jump_link" target="_blank">跳转播放3</a>').attr("href",a),s=l("#details-page > div.header > h2 > span").text(),i=H(t,s),x=l('<a class="crack_title crack_jump_link" target="_blank" data-type="download">下载视频</a>').attr("href",i);C.append(n).append(r).append(c).append(x);},D=t=>{k();const o=A();o&&t.forEach(n=>{const e=l(`<audio src="${n.remoteUrl}" controls="controls"></audio>`);l(o).append(e);});},G=t=>{k();const o=A();if(!o)return;const n=`https://m.auok.run/player/#${t}`,e=l(`<iframe width="100%" height='400' frameborder='0' align='center' allow="fullscreen" allow="autoplay" id='iframe' src="${n}"></iframe>`).css({width:"100%"});l(o).append(e);};function Y(t,o){k();const n=A();if(!n)return;const e=l(`<img src="${t}" data-id="${o}"  title="点击查看大图">`);e.on("error",()=>{e.remove();}),l(n).append(e);}function j(){l("button:contains('点击展开完整贴文')").click();}O();const F=t=>{const o=R(t),n=o.attachments,e=[],r=[],a=[];n.forEach(c=>{c.category==="images"?e.push(c):c.category==="audio"?a.push(c):c.category==="video"&&r.push(c);}),setTimeout(()=>{if(j(),(e==null?void 0:e.length)>0){const c=e.filter(s=>!o.content.includes(`data-id="${s.id}"`));c.length&&c.forEach(s=>{v({method:"GET",url:s.remoteUrl,onload:function({response:i}){let x=new E().decode(i);x=x.replace(/\0.*$/g,""),Y(x,s.id);}});});}(a==null?void 0:a.length)>0&&D(a),M()&&(r==null?void 0:r.length)>0&&r.forEach(async c=>{const s=c==null?void 0:c.remoteUrl;if(s){const x=await(await fetch(s)).text();w(x);}});},5e3);},w=t=>{_("开始解析视频");const o=P(t);if(!o){_("解析视频失败");return}_("解析视频成功"),setTimeout(()=>{j(),X(o),G(o);},5e3);};L(F,w);})(jQuery);