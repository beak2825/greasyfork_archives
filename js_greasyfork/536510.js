// ==UserScript==
// @name         vSprint Analytics+ addFeature
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  Feature do vSprint Analytics+
// @author       Paweł Kaczmarek
// @match        https://allegro.pl/moje-allegro/sprzedaz/allegro-analytics/sprzedaz-dni
// @grant        none
// @require      https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js
// @downloadURL https://update.greasyfork.org/scripts/536510/vSprint%20Analytics%2B%20addFeature.user.js
// @updateURL https://update.greasyfork.org/scripts/536510/vSprint%20Analytics%2B%20addFeature.meta.js
// ==/UserScript==

!function(){"use strict";function n(){document.getElementById("modal").style.display="block",document.getElementById("overlay").style.display="block",a()}function e(){document.getElementById("modal").style.display="none",document.getElementById("overlay").style.display="none"}function t(n){document.cookie=`savedAccounts=${JSON.stringify(n)}; path=/; max-age=31536000`}function o(){const n=document.cookie.match(/savedAccounts=([^;]*)/);return n?JSON.parse(n[1]):[]}function a(){const n=o(),e=document.getElementById("savedAccountsList");e.innerHTML="",n.forEach(((o,r)=>{const d=document.createElement("li");d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="space-between",d.style.color="black";const l=document.createElement("span");l.textContent=o.name;const c=document.createElement("button");c.textContent="x",c.style.color="black",c.style.background="none",c.style.border="none",c.style.cursor="pointer",c.style.fontWeight="bold",c.addEventListener("click",(()=>{n.splice(r,1),t(n),a()})),d.appendChild(l),d.appendChild(c),e.appendChild(d)}))}function r(){const n=document.getElementById("account-select"),e=n.options[n.selectedIndex];if(!e.value)return;const r=o();r.push({name:e.textContent,value:e.value}),t(r),a()}function d(){document.cookie="savedAccounts=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;",a()}function l(){let n=null,e=!1;const t=o(),a=new Date;a.setDate(1);const r=a.toISOString().split("T")[0]+"T00:00:00.000Z";let d=new Date,l="",c="";const i=document.querySelector('input[name="dateMode"]:checked')?.value;if("current"===i){const n=new Date;d=new Date(n.getTime()-3e5);const e=d.toISOString().split("T")[0],t=d.toTimeString().split(" ")[0].slice(0,5);l=e+"T00:00:00.000Z",c=`${e}T${t}:00.000Z`}else{d.setDate(d.getDate()-1);const n=d.toISOString().split("T")[0];l=n+"T00:00:00.000Z",c=n+"T01:00:00.000Z"}const s=[{code:"allegro-pl",label:"Allegro PL"},{code:"allegro-cz",label:"Allegro CZ"},{code:"allegro-sk",label:"Allegro SK"},{code:"allegro-hu",label:"Allegro HU"}],p={};let u=0;const m=t.length*s.length,b=document.getElementById("progressContainer"),g=document.getElementById("progressBar"),y=document.getElementById("progressText"),f=b.querySelector(".warning-message");f&&f.remove(),b&&g&&y&&(b.style.display="block",g.style.width="0%",y.style.color="#333",y.style.fontWeight="normal",y.textContent=`0/${m}`,setTimeout((()=>{u<m&&!e&&(n=document.createElement("div"),n.classList.add("warning-message"),n.textContent="⚠️ Analytics może być przeciążony. Spróbuj ponownie później, poczekaj jeszcze chwilę lub zrestartuj stronę.",n.style.color="#cc0000",n.style.fontSize="14px",n.style.marginTop="10px",n.style.textAlign="center",b.appendChild(n))}),15e3)),t.forEach((t=>{const o=t.name;p[o]={},s.forEach((a=>{const d=JSON.stringify({includePhrasesMode:"OfferOrProduct",excludePhrasesMode:"OfferOrProduct",sellerIds:[t.value],includeCancelledAndReturned:!0,skip:0,take:1e3,marketplaceIds:[a.code],startDate:r,endDate:l,startDateTime:r.replace("00:00:00.000Z","01:00:00.000Z"),endDateTime:c,reportCode:"LASTFULL7DAYS"});fetch("https://edge.allegro.pl/analytics/reports/sale/byday",{method:"POST",headers:{accept:"application/vnd.allegro.internal.v1+json","accept-language":"pl-PL","content-type":"application/vnd.allegro.internal.v1+json"},body:d,mode:"cors",credentials:"include"}).then((n=>n.json())).then((n=>{const e=(n.result?.overallSale??0).toFixed(2).replace(".",",");p[o][a.label]=e})).catch((n=>{console.error(`Błąd dla konta ${o} (${a.code}):`,n),p[o][a.label]="0,00",e=!0})).finally((()=>{u++,function(n,e,t=!1){const o=document.getElementById("progressBar"),a=document.getElementById("progressText");if(o&&a){const r=Math.round(n/e*100);o.style.width=`${r}%`,n===e?t?(a.textContent="❌ Nie udało się pobrać wszystkich raportów.",a.style.color="red",a.style.fontWeight="bold",o.style.width="0%"):(a.textContent="Pobrano raport!",a.style.color="green",a.style.fontWeight="bold"):(a.textContent=`${n}/${e}`,a.style.color="#333",a.style.fontWeight="normal")}}(u,m,e),u===m&&(n&&(n.remove(),n=null),e?(y.textContent="❌ Nie udało się pobrać wszystkich raportów.",y.style.color="red",y.style.fontWeight="bold",g.style.width="0%"):function(n,e){const t=[["Konto",...e]];for(const o in n){const a=[o];e.forEach((e=>{const t=n[o][e],r="0,00"===t||void 0===t?"":t;a.push(r)})),t.push(a)}const o=XLSX.utils.aoa_to_sheet(t),a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,o,"Sprzedaż"),XLSX.writeFile(a,"Sprzedaz_zestawienie.xlsx")}(p,s.map((n=>n.label))))}))}))}))}function c(){const n=document.querySelector("account-filter");if(!n)return;const e=n.querySelector("select");if(!e)return;const t=o().map((n=>n.value));if(!t.length)return;const a=Array.from(e.options),r=[],d=[];for(a.forEach((n=>{t.includes(n.value)?(r.push(n),n.classList.add("saved-account-bold")):(d.push(n),n.classList.remove("saved-account-bold"))})),r.sort(((n,e)=>t.indexOf(n.value)-t.indexOf(e.value)));e.options.length>0;)e.remove(0);r.forEach((n=>e.add(n))),d.forEach((n=>e.add(n))),e.selectedIndex=0}!function(){const n=document.createElement("style");n.textContent='\n        /* Przycisk otwierający modal */\n        #downloadDataButton {\n            position: fixed;\n            top: 10px;\n            right: 10px;\n            background-color: #ff5a00;\n            color: white;\n            border: none;\n            padding: 10px 15px;\n            font-size: 14px;\n            cursor: pointer;\n            border-radius: 5px;\n            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);\n            z-index: 1000;\n        }\n\n        #downloadDataButton:hover {\n            background-color: #e04e00;\n        }\n\n        /* Overlay */\n        #overlay {\n            display: none;\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            z-index: 1000;\n        }\n\n        /* Modal */\n        #modal {\n            display: none;\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: #ffffff;\n            padding: 30px;\n            border-radius: 12px;\n            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);\n            z-index: 2000;\n            min-width: 300px;\n            max-width: 400px;\n            font-family: Arial, sans-serif;\n        }\n\n        #modal h2, #modal h3 {\n            color: #000;\n            margin-bottom: 10px;\n        }\n\n        #modal select {\n            width: 100%;\n            padding: 8px;\n            margin-bottom: 15px;\n            border: 1px solid #ccc;\n            border-radius: 5px;\n            font-size: 14px;\n        }\n\n        #modal ul {\n            padding: 0;\n            list-style: none;\n            margin-top: 10px;\n            margin-bottom: 15px;\n            color: black;\n        }\n\n        #modal ul li {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 5px 8px;\n            border-bottom: 1px solid #eee;\n        }\n\n        .delete-account-btn {\n            background: none;\n            color: black;\n            border: none;\n            font-weight: bold;\n            cursor: pointer;\n            font-size: 16px;\n        }\n\n        .delete-account-btn:hover {\n            color: red;\n        }\n\n        /* Przyciski */\n        #modal button {\n            padding: 8px 16px;\n            margin-top: 10px;\n            margin-right: 5px;\n            cursor: pointer;\n            background-color: #ff5a00;\n            color: white;\n            border: none;\n            border-radius: 5px;\n            font-size: 14px;\n        }\n\n        #modal button:hover {\n            background-color: #e04e00;\n        }\n\n#account-select {\n    width: 100%;\n    padding: 8px 12px;\n    font-size: 14px;\n    border: 1px solid #ccc;\n    border-radius: 5px;\n    background-color: #fff;\n    color: black;\n    appearance: none;\n    -webkit-appearance: none;\n    -moz-appearance: none;\n    cursor: pointer;\n\n    background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 4 5\'><path fill=\'%23333\' d=\'M2 0L0 2h4L2 0z\'/></svg>");\n    background-repeat: no-repeat;\n    background-position: right 10px center;\n    background-size: 8px 10px;\n}\n\n\n\n.date-mode-container {\n    display: flex;\n    gap: 25px;\n    margin-bottom: 15px;\n    align-items: center; /* pionowe wyśrodkowanie */\n    justify-content: center;\n    width: 100%; /* zajmuje całą szerokość */\n    box-sizing: border-box;\n}\n\n/* label wyśrodkowany pionowo */\n.date-mode-container label {\n    display: flex;\n    align-items: center;\n    cursor: pointer;\n    font-size: 14px;\n    color: #000;\n    user-select: none;\n}\n\n/* styl radio */\n.date-mode-container input[type="radio"] {\n    appearance: none;\n    -webkit-appearance: none;\n    -moz-appearance: none;\n    width: 24px;          /* zwiększona szerokość */\n    height: 24px;         /* zwiększona wysokość */\n    border: 2px solid #ccc;\n    border-radius: 50%;\n    margin-right: 8px;\n    position: relative;\n    cursor: pointer;\n    background-color: #fff;\n    transition: border-color 0.3s ease, background-color 0.3s ease;\n    flex-shrink: 0;       /* nie pozwala się kurczyć */\n}\n\n.date-mode-container input[type="radio"]:checked {\n    border-color: #ff5a00;\n    background-color: #ff5a00;\n}\n\n.date-mode-container input[type="radio"]:checked::after {\n    content: "";\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    width: 12px;\n    height: 12px;\n    background: white;\n    border-radius: 50%;\n    transform: translate(-50%, -50%);\n}\n\n\n\n.date-mode-container label:hover input[type="radio"] {\n    border-color: #e04e00;\n}\n\n/* Sekcje modalowe - wizualne oddzielenie */\n#modal .section {\n  border: 1px solid #ddd;\n  padding: 15px 20px;\n  margin-bottom: 15px;\n  border-radius: 8px;\n  background-color: #fafafa;\n}\n\n/* Sekcja przycisków bez ramki, z wyrównaniem do prawej */\n#modal .section.buttons {\n  border: none;\n  background: none;\n  padding: 0;\n  margin-bottom: 0;\n  display: flex;\n  justify-content: flex-end;\n  gap: 10px;\n}\n\n/* Przycisków nie trzeba zmieniać, ale można doprecyzować margines */\n#modal button {\n  padding: 8px 16px;\n  cursor: pointer;\n  background-color: #ff5a00;\n  color: white;\n  border: none;\n  border-radius: 5px;\n  font-size: 14px;\n  transition: background-color 0.3s ease;\n}\n           .saved-account-bold {\n    font-weight: 400 !important;\n    color:#ff5a00;\n}\n#modal button:hover {\n  background-color: #e04e00;\n}\n\n#savedAccountsList {\n    max-height: 350px;\n    overflow-y: auto;\n    scrollbar-width: thin; /* Firefox */\n    scrollbar-color: #ff5a00 transparent; /* Firefox - kolor paska i tła */\n}\n\n/* Dla Chrome, Edge i Safari - niestandardowy scrollbar */\n#savedAccountsList::-webkit-scrollbar {\n    width: 6px; /* bardzo wąski pasek */\n}\n\n#savedAccountsList::-webkit-scrollbar-track {\n    background: transparent; /* przezroczysty */\n    border-radius: 3px;\n}\n\n#savedAccountsList::-webkit-scrollbar-thumb {\n    background-color: #ff5a00; /* kolor paska przewijania */\n    border-radius: 3px;\n}\n\n#savedAccountsList::-webkit-scrollbar-thumb:hover {\n    background-color: #e04e00; /* kolor po najechaniu */\n}\n\n\n    ',document.head.appendChild(n)}(),function(){if(document.getElementById("downloadDataButton"))return;const e=document.createElement("button");e.id="downloadDataButton",e.textContent="Pobierz dane",e.addEventListener("click",n),document.body.appendChild(e)}(),function(){const n=document.createElement("div");n.id="overlay",n.addEventListener("click",e),document.body.appendChild(n);const t=document.createElement("div");t.id="modal",t.innerHTML='\n  <div class="section">\n    <h2>Wybierz konto</h2>\n    <select id="account-select"></select>\n    <button id="addAccount">Dodaj</button>\n  </div>\n\n  <div class="section">\n    <h3>Zapisane konta:</h3>\n    <ul id="savedAccountsList"></ul>\n  </div>\n\n<div class="section">\n  <h3>Zakres dat</h3>\n  <div class="date-mode-container">\n    <label><input type="radio" name="dateMode" value="yesterday" checked> Do wczoraj</label>\n    <label><input type="radio" name="dateMode" value="current"> Aktualne</label>\n  </div>\n</div>\n\n\n  <div class="section" id="progressContainer" style="display:none;">\n    <div style="width: 100%; background-color: #eee; border-radius: 5px; overflow: hidden; height: 20px; margin-bottom: 5px;">\n      <div id="progressBar" style="height: 100%; width: 0%; background-color: #ff5a00; transition: width 0.3s ease;"></div>\n    </div>\n    <div id="progressText" style="text-align: center; font-size: 14px; color: #333;">0/0</div>\n  </div>\n\n  <div class="section buttons">\n    <button id="clearAccounts">Usuń wszystko</button>\n    <button id="downloadData">Pobierz dane</button>\n    <button id="closeModal">Zamknij</button>\n  </div>\n',document.body.appendChild(t),document.getElementById("addAccount").addEventListener("click",r),document.getElementById("clearAccounts").addEventListener("click",d),document.getElementById("closeModal").addEventListener("click",e),document.getElementById("downloadData").addEventListener("click",l)}(),function n(e,t){const o=document.querySelector(e);o?(console.log(`Element ${e} znaleziony.`),t(o)):(console.log(`Czekam na ${e}...`),setTimeout((()=>n(e,t)),500))}("account-filter",(n=>{!function(){console.log("Próba pobrania listy kont...");const n=document.querySelector("account-filter");if(!n)return void console.error("Nie znaleziono listy kont.");const e=n.querySelectorAll("option"),t=document.getElementById("account-select");t.innerHTML="",e.forEach((n=>{if(n.value){const e=document.createElement("option");e.value=n.value,e.textContent=n.textContent,t.appendChild(e)}}))}(),n.addEventListener("mousedown",c)}))}();