// ==UserScript==
// @name        YGG Bypass Turbo Limit
// @namespace   Violentmonkey Scripts
// @match       https://www.yggtorrent.org/torrent/*/*/*-*
// @match       https://www.yggtorrent.org/user/account
// @grant       GM_setValue
// @grant       GM_getValue
// @grant       GM_registerMenuCommand
// @version     1.1
// @author      Hoax017
// @description Genere une lien magnet pour le telechargement au lieu de subir la limite
// @license MIT
// @downloadURL https://update.greasyfork.org/scripts/559729/YGG%20Bypass%20Turbo%20Limit.user.js
// @updateURL https://update.greasyfork.org/scripts/559729/YGG%20Bypass%20Turbo%20Limit.meta.js
// ==/UserScript==


(async function() {
    'use strict';

    // --- LOGIQUE POUR LA PAGE PROFIL ---
    if (window.location.pathname.includes('/user/account')) {

        const passkeyElement = document.querySelector("#profile_passkey");
        if (passkeyElement) {
            const retrievedKey = passkeyElement.innerText.trim();
            if (retrievedKey) {
                GM_setValue("userKey", retrievedKey);
                alert("Passkey r√©cup√©r√©e et enregistr√©e !");
                setTimeout(() => {
                  window.close();
                }, 500);
            }
        }
        return;
    }

    // --- 1. V√©rification et R√©cup√©ration de la cl√© ---
    async function getUserKey() {
      let userKey = GM_getValue("userKey");

      if (!userKey) {
        if (confirm("Cl√© API manquante. Voulez-vous ouvrir votre profil pour la r√©cup√©rer automatiquement ?")) {
          const authWindow = window.open("/user/account", "_blank");

          await new Promise((resolve) => {
            const checkWindow = setInterval(() => {
              if (authWindow.closed) {
                clearInterval(checkWindow);
                resolve();
              }
            }, 500);
          });


          userKey = GM_getValue("userKey");


          if (!userKey) {
            alert("La cl√© n'a pas pu √™tre r√©cup√©r√©e. Veuillez r√©essayer.");
          }
        } else {
          userKey = prompt("Veuillez saisir la cle manuellement");
          if (userKey) {
            GM_setValue("userKey", userKey);
          }
        }
      }
      return userKey
    }


    // --- 2. Fonction pour obtenir le hash ---
    function getHash() {
        const hash = document.querySelector(".informations > tbody:nth-child(1) > tr:nth-child(5) > td:nth-child(2)")?.innerText.trim()
        const regex = /^[a-f0-9]{40}$/i;
        return regex.test(hash) ? hash : null;
    }

    function getTorrentName() {
        return document.querySelector("#title > h1:nth-child(1)")?.innerText.trim()
    }

    // --- 3. G√©n√©ration du Magnet ---
    async function generateMagnet() {
        const userKey = await getUserKey()
        const hash = getHash();
        const rawName = getTorrentName();

        if (!hash || !userKey) return;

        // Construction du nom personnalis√©
        const customName = `Torrent ${rawName} generated by Hoax`;

        // URL du tracker avec la cl√©
        const trackerUrl = `http://tracker.p2p-world.net:8080/${userKey}/announce`;

        // Assemblage du Magnet (avec encodage des caract√®res sp√©ciaux)
        const magnetLink = `magnet:?xt=urn:btih:${hash}` +
                           `&dn=${encodeURIComponent(customName)}` +
                           `&tr=${encodeURIComponent(trackerUrl)}`;

        console.log("Lien g√©n√©r√© :", magnetLink);
        return magnetLink;
    }

    // Menu pour changer la cl√©
    GM_registerMenuCommand("Modifier la cl√© API", getUserKey);


  // --- 4. Fonction pour injecter le bouton ---
    function injectButton() {
        // Cible l'√©l√©ment td sp√©cifique
        const targetCell = document.querySelector(".infos-torrent > tbody:nth-child(3) > tr:nth-child(1) > td:nth-child(2)");

        if (!targetCell || document.getElementById("bypass-turbo-btn")) return;

        // Cr√©ation du bouton
        const btn = document.createElement("a");
        btn.id = "bypass-turbo-btn";
        btn.innerText = "üß≤ G√©n√©rer Magnet Custom";

        // Petit style pour qu'il soit visible (inspir√© du site)
        btn.style.marginLeft = "10px";
        btn.style.padding = "2px 8px";
        btn.style.backgroundColor = "#008cba";
        btn.style.color = "white";
        btn.style.borderRadius = "4px";
        btn.style.cursor = "pointer";
        btn.style.fontSize = "12px";
        btn.style.textDecoration = "none";
        btn.style.display = "inline-block";

        // Action au clic
        btn.onclick = async function(e) {
            e.preventDefault();
            const magnet = await generateMagnet();
            if (magnet) {
                // Copie dans le presse-papier
                navigator.clipboard.writeText(magnet).then(() => {
                    btn.innerText = "‚úÖ Copi√© !";
                    btn.style.backgroundColor = "#28a745";

                    // Remet le bouton normal apr√®s 2 secondes
                    setTimeout(() => {
                        btn.innerText = "üß≤ G√©n√©rer Magnet Custom";
                        btn.style.backgroundColor = "#008cba";
                    }, 2000);
                });

                // Ouvre le lien (optionnel)
                // window.location.href = magnet;
            } else {
                alert("Erreur : Impossible de r√©cup√©rer les informations n√©cessaire");
            }
        };

        // Ajout du bouton dans la cellule
        targetCell.appendChild(btn);
    }

    // --- 5. Ex√©cution ---
    injectButton();
})();