// ==UserScript==
// @name         Apple USDZ Finder + Preview + Download（离线/在线 混合版）
// @namespace    http://tampermonkey.net/
// @version      2.0.1 // 版本号已更新
// @description  在 Apple 页面查找 USDZ 文件，支持下载、预览、Quick Look。**强制使用内联 Base64**，绕过 CSP 限制。
// @author       Your Name
// @match        https://www.apple.com/*
// @match        https://www.apple.com.cn/*
// @grant        GM_addStyle
// @grant        GM_registerMenuCommand
// @run-at       document-idle
// @downloadURL https://update.greasyfork.org/scripts/558036/Apple%20USDZ%20Finder%20%2B%20Preview%20%2B%20Download%EF%BC%88%E7%A6%BB%E7%BA%BF%E5%9C%A8%E7%BA%BF%20%E6%B7%B7%E5%90%88%E7%89%88%EF%BC%89.user.js
// @updateURL https://update.greasyfork.org/scripts/558036/Apple%20USDZ%20Finder%20%2B%20Preview%20%2B%20Download%EF%BC%88%E7%A6%BB%E7%BA%BF%E5%9C%A8%E7%BA%BF%20%E6%B7%B7%E5%90%88%E7%89%88%EF%BC%89.meta.js
// ==/UserScript==

(function () {
    'use strict';

    /* ----------------- 配置 ----------------- */
    const CONFIG = {
        SCAN_DELAY: 800,
        PANEL_ID: 'tm-usdz-panel-v0',
        MODAL_ID: 'tm-usdz-modal',
        Z_INDEX: 2147483646,
        // 如果你已经准备好 three.min.js / OrbitControls.js / USDZLoader.js 的 base64 内容，可填入下面变量。
        // 注意：将完整内联会使脚本体积非常大（几十KB~几MB），建议仅在确实需要离线运行或 CDN 受限时使用。
        INLINE_THREE_BASE64: "LyoqCiAqIEBsaWNlbnNlCiAqIENvcHlyaWdodCAyMDEwLTIwMjMgVGhyZWUuanMgQXV0aG9ycwogKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTUlUCiAqLwpjb25zdCBSRVZJU0lPTiA9ICcxNjEnOwoKY29uc3QgTU9VU0UgPSB7IExFRlQ6IDAsIE1JRERMRTogMSwgUklHSFQ6IDIsIFJPVEFURTogMCwgRE9MTFk6IDEsIFBBTjogMiB9Owpjb25zdCBUT1VDSCA9IHsgUk9UQVRFOiAwLCBQQU46IDEsIERPTExZX1BBTjogMiwgRE9MTFlfUk9UQVRFOiAzIH07CmNvbnN0IEN1bGxGYWNlTm9uZSA9IDA7CmNvbnN0IEN1bGxGYWNlQmFjayA9IDE7CmNvbnN0IEN1bGxGYWNlRnJvbnQgPSAyOwpjb25zdCBDdWxsRmFjZUZyb250QmFjayA9IDM7CmNvbnN0IEJhc2ljU2hhZG93TWFwID0gMDsKY29uc3QgUENGU2hhZG93TWFwID0gMTsKY29uc3QgUENGU29mdFNoYWRvd01hcCA9IDI7CmNvbnN0IFZTTVNoYWRvd01hcCA9IDM7CmNvbnN0IEZyb250U2lkZSA9IDA7CmNvbnN0IEJhY2tTaWRlID0gMTsKY29uc3QgRG91YmxlU2lkZSA9IDI7CmNvbnN0IE5vQmxlbmRpbmcgPSAwOwpjb25zdCBOb3JtYWxCbGVuZGluZyA9IDE7CmNvbnN0IEFkZGl0aXZlQmxlbmRpbmcgPSAyOwpjb25zdCBTdWJ0cmFjdGl2ZUJsZW5kaW5nID0gMzsKY29uc3QgTXVsdGlwbHlCbGVuZGluZyA9IDQ7CmNvbnN0IEN1c3RvbUJsZW5kaW5nID0gNTsKY29uc3QgQWRkRXF1YXRpb24gPSAxMDA7CmNvbnN0IFN1YnRyYWN0RXF1YXRpb24gPSAxMDE7CmNvbnN0IFJldmVyc2VTdWJ0cmFjdEVxdWF0aW9uID0gMTAyOwpjb25zdCBNaW5FcXVhdGlvbiA9IDEwMzsKY29uc3QgTWF4RXF1YXRpb24gPSAxMDQ7CmNvbnN0IFplcm9GYWN0b3IgPSAyMDA7CmNvbnN0IE9uZUZhY3RvciA9IDIwMTsKY29uc3QgU3JjQ29sb3JGYWN0b3IgPSAyMDI7CmNvbnN0IE9uZU1pbnVzU3JjQ29sb3JGYWN0b3IgPSAyMDM7CmNvbnN0IFNyY0FscGhhRmFjdG9yID0gMjA0Owpjb25zdCBPbmVNaW51c1NyY0FscGhhRmFjdG9yID0gMjA1Owpjb25zdCBEc3RBbHBoYUZhY3RvciA9IDIwNjsKY29uc3QgT25lTWludXNEc3RBbHBoYUZhY3RvciA9IDIwNzsKY29uc3QgRHN0Q29sb3JGYWN0b3IgPSAyMDg7CmNvbnN0IE9uZU1pbnVzRHN0Q29sb3JGYWN0b3IgPSAyMDk7CmNvbnN0IFNyY0FscGhhU2F0dXJhdGVGYWN0b3IgPSAyMTA7CmNvbnN0IENvbnN0YW50Q29sb3JGYWN0b3IgPSAyMTE7CmNvbnN0IE9uZU1pbnVzQ29uc3RhbnRDb2xvckZhY3RvciA9IDIxMjsKY29uc3QgQ29uc3RhbnRBbHBoYUZhY3RvciA9IDIxMzsKY29uc3QgT25lTWludXNDb25zdGFudEFscGhhRmFjdG9yID0gMjE0Owpjb25zdCBOZXZlckRlcHRoID0gMDsKY29uc3QgQWx3YXlzRGVwdGggPSAxOwpjb25zdCBMZXNzRGVwdGggPSAyOwpjb25zdCBMZXNzRXF1YWxEZXB0aCA9IDM7CmNvbnN0IEVxdWFsRGVwdGggPSA0Owpjb25zdCBHcmVhdGVyRXF1YWxEZXB0aCA9IDU7CmNvbnN0IEdyZWF0ZXJEZXB0aCA9IDY7CmNvbnN0IE5vdEVxdWFsRGVwdGggPSA3Owpjb25zdCBNdWx0aXBseU9wZXJhdGlvbiA9IDA7CmNvbnN0IE1peE9wZXJhdGlvbiA9IDE7CmNvbnN0IEFkZE9wZXJhdGlvbiA9IDI7CmNvbnN0IE5vVG9uZU1hcHBpbmcgPSAwOwpjb25zdCBMaW5lYXJUb25lTWFwcGluZyA9IDE7CmNvbnN0IFJlaW5oYXJkVG9uZU1hcHBpbmcgPSAyOwpjb25zdCBDaW5lb25Ub25lTWFwcGluZyA9IDM7CmNvbnN0IEFDRVNGaWxtaWNUb25lTWFwcGluZyA9IDQ7CmNvbnN0IEN1c3RvbVRvbmVNYXBwaW5nID0gNTsKY29uc3QgQWdYVG9uZU1hcHBpbmcgPSA2Owpjb25zdCBBdHRhY2hlZEJpbmRNb2RlID0gJ2F0dGFjaGVkJzsKY29uc3QgRGV0YWNoZWRCaW5kTW9kZSA9ICdkZXRhY2hlZCc7Cgpjb25zdCBVVk1hcHBpbmcgPSAzMDA7CmNvbnN0IEN1YmVSZWZsZWN0aW9uTWFwcGluZyA9IDMwMTsKY29uc3QgQ3ViZVJlZnJhY3Rpb25NYXBwaW5nID0gMzAyOwpjb25zdCBFcXVpcmVjdGFuZ3VsYXJSZWZsZWN0aW9uTWFwcGluZyA9IDMwMzsKY29uc3QgRXF1aXJlY3Rhbmd1bGFyUmVmcmFjdGlvbk1hcHBpbmcgPSAzMDQ7CmNvbnN0IEN1YmVVVlJlZmxlY3Rpb25NYXBwaW5nID0gMzA2Owpjb25zdCBSZXBlYXRXcmFwcGluZyA9IDEwMDA7CmNvbnN0IENsYW1wVG9FZGdlV3JhcHBpbmcgPSAxMDAxOwpjb25zdCBNaXJyb3JlZFJlcGVhdFdyYXBwaW5nID0gMTAwMjsKY29uc3QgTmVhcmVzdEZpbHRlciA9IDEwMDM7CmNvbnN0IE5lYXJlc3RNaXBtYXBOZWFyZXN0RmlsdGVyID0gMTAwNDsKY29uc3QgTmVhcmVzdE1pcE1hcE5lYXJlc3RGaWx0ZXIgPSAxMDA0Owpjb25zdCBOZWFyZXN0TWlwbWFwTGluZWFyRmlsdGVyID0gMTAwNTsKY29uc3QgTmVhcmVzdE1pcE1hcExpbmVhckZpbHRlciA9IDEwMDU7CmNvbnN0IExpbmVhckZpbHRlciA9IDEwMDY7CmNvbnN0IExpbmVhck1pcG1hcE5lYXJlc3RGaWx0ZXIgPSAxMDA3Owpjb25zdCBMaW5lYXJNaXBNYXBOZWFyZXN0RmlsdGVyID0gMTAwNzsKY29uc3QgTGluZWFyTWlwbWFwTGluZWFyRmlsdGVyID0gMTAwODsKY29uc3QgTGluZWFyTWlwTWFwTGluZWFyRmlsdGVyID0gMTAwODsKY29uc3QgVW5zaWduZWRCeXRlVHlwZSA9IDEwMDk7CmNvbnN0IEJ5dGVUeXBlID0gMTAxMDsKY29uc3QgU2hvcnRUeXBlID0gMTAxMTsKY29uc3QgVW5zaWduZWRTaG9ydFR5cGUgPSAxMDEyOwpjb25zdCBJbnRUeXBlID0gMTAxMzsKY29uc3QgVW5zaWduZWRJbnRUeXBlID0gMTAxNDsKY29uc3QgRmxvYXRUeXBlID0gMTAxNTsKY29uc3QgSGFsZkZsb2F0VHlwZSA9IDEwMTY7CmNvbnN0IFVuc2lnbmVkU2hvcnQ0NDQ0VHlwZSA9IDEwMTc7CmNvbnN0IFVuc2lnbmVkU2hvcnQ1NTUxVHlwZSA9IDEwMTg7CmNvbnN0IFVuc2lnbmVkSW50MjQ4VHlwZSA9IDEwMjA7CmNvbnN0IEFscGhhRm9ybWF0ID0gMTAyMTsKY29uc3QgUkdCQUZvcm1hdCA9IDEwMjM7CmNvbnN0IEx1bWluYW5jZUZvcm1hdCA9IDEwMjQ7CmNvbnN0IEx1bWluYW5jZUFscGhhRm9ybWF0ID0gMTAyNTsKY29uc3QgRGVwdGhGb3JtYXQgPSAxMDI2Owpjb25zdCBEZXB0aFN0ZW5jaWxGb3JtYXQgPSAxMDI3Owpjb25zdCBSZWRGb3JtYXQgPSAxMDI4Owpjb25zdCBSZWRJbnRlZ2VyRm9ybWF0ID0gMTAyOTsKY29uc3QgUkdGb3JtYXQgPSAxMDMwOwpjb25zdCBSR0ludGVnZXJGb3JtYXQgPSAxMDMxOwpjb25zdCBSR0JBSW50ZWdlckZvcm1hdCA9IDEwMzM7Cgpjb25zdCBSR0JfUzNUQ19EWFQxX0Zvcm1hdCA9IDMzNzc2Owpjb25zdCBSR0JBX1MzVENfRFhUMV9Gb3JtYXQgPSAzMzc3NzsKY29uc3QgUkdCQV9TM1RDX0RYVDNfRm9ybWF0ID0gMzM3Nzg7CmNvbnN0IFJHQkFfUzNUQ19EWFQ1X0Zvcm1hdCA9IDMzNzc5Owpjb25zdCBSR0JfUFZSVENfNEJQUFYxX0Zvcm1hdCA9IDM1ODQwOwpjb25zdCBSR0JfUFZSVENfMkJQUFYxX0Zvcm1hdCA9IDM1ODQxOwpjb25zdCBSR0JBX1BWUlRDXzRCUFBWMV9Gb3JtYXQgPSAzNTg0MjsKY29uc3QgUkdCQV9QVlJUQ18yQlBQVjFfRm9ybWF0ID0gMzU4NDM7CmNvbnN0IFJHQl9FVEMxX0Zvcm1hdCA9IDM2MTk2Owpjb25zdCBSR0JfRVRDMl9Gb3JtYXQgPSAzNzQ5MjsKY29uc3QgUkdCQV9FVEMyX0VBQ19Gb3JtYXQgPSAzNzQ5NjsKY29uc3QgUkdCQV9BU1RDXzR4NF9Gb3JtYXQgPSAzNzgwODsKY29uc3QgUkdCQV9BU1RDXzV4NF9Gb3JtYXQgPSAzNzgwOTsKY29uc3QgUkdCQV9BU1RDXzV4NV9Gb3JtYXQgPSAzNzgxMDsKY29uc3QgUkdCQV9BU1RDXzZ4NV9Gb3JtYXQgPSAzNzgxMTsKY29uc3QgUkdCQV9BU1RDXzZ4Nl9Gb3JtYXQgPSAzNzgxMjsKY29uc3QgUkdCQV9BU1RDXzh4NV9Gb3JtYXQgPSAzNzgxMzsKY29uc3QgUkdCQV9BU1RDXzh4Nl9Gb3JtYXQgPSAzNzgxNDsKY29uc3QgUkdCQV9BU1RDXzh4OF9Gb3JtYXQgPSAzNzgxNTsKY29uc3QgUkdCQV9BU1RDXzEweDVfRm9ybWF0ID0gMzc4MTY7CmNvbnN0IFJHQkFfQVNUQ18xMHg2X0Zvcm1hdCA9IDM3ODE3Owpjb25zdCBSR0JBX0FTVENfMTB4OF9Gb3JtYXQgPSAzNzgxODsKY29uc3QgUkdCQV9BU1RDXzEweDEwX0Zvcm1hdCA9IDM3ODE5Owpjb25zdCBSR0JBX0FTVENfMTJ4MTBfRm9ybWF0ID0gMzc4MjA7CmNvbnN0IFJHQkFfQVNUQ18xMngxMl9Gb3JtYXQgPSAzNzgyMTsKY29uc3QgUkdCQV9CUFRDX0Zvcm1hdCA9IDM2NDkyOwpjb25zdCBSR0JfQlBUQ19TSUdORURfRm9ybWF0ID0gMzY0OTQ7CmNvbnN0IFJHQl9CUFRDX1VOU0lHTkVEX0Zvcm1hdCA9IDM2NDk1Owpjb25zdCBSRURfUkdUQzFfRm9ybWF0ID0gMzYyODM7CmNvbnN0IFNJR05FRF9SRURfUkdUQzFfRm9ybWF0ID0gMzYyODQ7CmNvbnN0IFJFRF9HUkVFTl9SR1RDMl9Gb3JtYXQgPSAzNjI4NTsKY29uc3QgU0lHTkVEX1JFRF9HUkVFTl9SR1RDMl9Gb3JtYXQgPSAzNjI4NjsKY29uc3QgTG9vcE9uY2UgPSAyMjAwOwpjb25zdCBMb29wUmVwZWF0ID0gMjIwMTsKY29uc3QgTG9vcFBpbmdQb25nID0gMjIwMjsKY29uc3QgSW50ZXJwb2xhdGVEaXNjcmV0ZSA9IDIzMDA7CmNvbnN0IEludGVycG9sYXRlTGluZWFyID0gMjMwMTsKY29uc3QgSW50ZXJwb2xhdGVTbW9vdGggPSAyMzAyOwpjb25zdCBaZXJvQ3VydmF0dXJlRW5kaW5nID0gMjQwMDsKY29uc3QgWmVyb1Nsb3BlRW5kaW5nID0gMjQwMTsKY29uc3QgV3JhcEFyb3VuZEVuZGluZyA9IDI0MDI7CmNvbnN0IE5vcm1hbEFuaW1hdGlvbkJsZW5kTW9kZSA9IDI1MDA7CmNvbnN0IEFkZGl0aXZlQW5pbWF0aW9uQmxlbmRNb2RlID0gMjUwMTsKY29uc3QgVHJpYW5nbGVzRHJhd01vZGUgPSAwOwpjb25zdCBUcmlhbmdsZVN0cmlwRHJhd01vZGUgPSAxOwpjb25zdCBUcmlhbmdsZUZhbkRyYXdNb2RlID0gMjsKLyoqIEBkZXByZWNhdGVkIFVzZSBMaW5lYXJTUkdCQ29sb3JTcGFjZSBvciBOb0NvbG9yU3BhY2UgaW4gdGhyZWUuanMgcjE1MisuICovCmNvbnN0IExpbmVhckVuY29kaW5nID0gMzAwMDsKLyoqIEBkZXByZWNhdGVkIFVzZSBTUkdCQ29sb3JTcGFjZSBpbiB0aHJlZS5qcyByMTUyKy4gKi8KY29uc3Qgc1JHQkVuY29kaW5nID0gMzAwMTsKY29uc3QgQmFzaWNEZXB0aFBhY2tpbmcgPSAzMjAwOwpjb25zdCBSR0JBRGVwdGhQYWNraW5nID0gMzIwMTsKY29uc3QgVGFuZ2VudFNwYWNlTm9ybWFsTWFwID0gMDsKY29uc3QgT2JqZWN0U3BhY2VOb3JtYWxNYXAgPSAxOwoKLy8gQ29sb3Igc3BhY2Ugc3RyaW5nIGlkZW50aWZpZXJzLCBtYXRjaGluZyBDU1MgQ29sb3IgTW9kdWxlIExldmVsIDQgYW5kIFdlYkdQVSBuYW1lcyB3aGVyZSBhdmFpbGFibGUuCmNvbnN0IE5vQ29sb3JTcGFjZSA9ICcnOwpjb25zdCBTUkdCQ29sb3JTcGFjZSA9ICdzcmdiJzsKY29uc3QgTGluZWFyU1JHQkNvbG9yU3BhY2UgPSAnc3JnYi1saW5lYXInOwpjb25zdCBEaXNwbGF5UDNDb2xvclNwYWNlID0gJ2Rpc3BsYXktcDMnOwpjb25zdCBMaW5lYXJEaXNwbGF5UDNDb2xvclNwYWNlID0gJ2Rpc3BsYXktcDMtbGluZWFyJzsKCmNvbnN0IExpbmVhclRyYW5zZmVyID0gJ2xpbmVhcic7CmNvbnN0IFNSR0JUcmFuc2ZlciA9ICdzcmdiJzsKCmNvbnN0IFJlYzcwOVByaW1hcmllcyA9ICdyZWM3MDknOwpjb25zdCBQM1ByaW1hcmllcyA9ICdwMyc7Cgpjb25zdCBaZXJvU3RlbmNpbE9wID0gMDsKY29uc3QgS2VlcFN0ZW5jaWxPcCA9IDc2ODA7CmNvbnN0IFJlcGxhY2VTdGVuY2lsT3AgPSA3NjgxOwpjb25zdCBJbmNyZW1lbnRTdGVuY2lsT3AgPSA3NjgyOwpjb25zdCBEZWNyZW1lbnRTdGVuY2lsT3AgPSA3NjgzOwpjb25zdCBJbmNyZW1lbnRXcmFwU3RlbmNpbE9wID0gMzQwNTU7CmNvbnN0IERlY3JlbWVudFdyYXBTdGVuY2lsT3AgPSAzNDA1NjsKY29uc3QgSW52ZXJ0U3RlbmNpbE9wID0gNTM4NjsKCmNvbnN0IE5ldmVyU3RlbmNpbEZ1bmMgPSA1MTI7CmNvbnN0IExlc3NTdGVuY2lsRnVuYyA9IDUxMzsKY29uc3QgRXF1YWxTdGVuY2lsRnVuYyA9IDUxNDsKY29uc3QgTGVzc0VxdWFsU3RlbmNpbEZ1bmMgPSA1MTU7CmNvbnN0IEdyZWF0ZXJTdGVuY2lsRnVuYyA9IDUxNjsKY29uc3QgTm90RXF1YWxTdGVuY2lsRnVuYyA9IDUxNzsKY29uc3QgR3JlYXRlckVxdWFsU3RlbmNpbEZ1bmMgPSA1MTg7CmNvbnN0IEFsd2F5c1N0ZW5jaWxGdW5jID0gNTE5OwoKY29uc3QgTmV2ZXJDb21wYXJlID0gNTEyOwpjb25zdCBMZXNzQ29tcGFyZSA9IDUxMzsKY29uc3QgRXF1YWxDb21wYXJlID0gNTE0Owpjb25zdCBMZXNzRXF1YWxDb21wYXJlID0gNTE1Owpjb25zdCBHcmVhdGVyQ29tcGFyZSA9IDUxNjsKY29uc3QgTm90RXF1YWxDb21wYXJlID0gNTE3Owpjb25zdCBHcmVhdGVyRXF1YWxDb21wYXJlID0gNTE4Owpjb25zdCBBbHdheXNDb21wYXJlID0gNTE5OwoKY29uc3QgU3RhdGljRHJhd1VzYWdlID0gMzUwNDQ7CmNvbnN0IER5bmFtaWNEcmF3VXNhZ2UgPSAzNTA0ODsKY29uc3QgU3RyZWFtRHJhd1VzYWdlID0gMzUwNDA7CmNvbnN0IFN0YXRpY1JlYWRVc2FnZSA9IDM1MDQ1Owpjb25zdCBEeW5hbWljUmVhZFVzYWdlID0gMzUwNDk7CmNvbnN0IFN0cmVhbVJlYWRVc2FnZSA9IDM1MDQxOwpjb25zdCBTdGF0aWNDb3B5VXNhZ2UgPSAzNTA0NjsKY29uc3QgRHluYW1pY0NvcHlVc2FnZSA9IDM1MDUwOwpjb25zdCBTdHJlYW1Db3B5VXNhZ2UgPSAzNTA0MjsKCmNvbnN0IEdMU0wxID0gJzEwMCc7CmNvbnN0IEdMU0wzID0gJzMwMCBlcyc7Cgpjb25zdCBfU1JHQkFGb3JtYXQgPSAxMDM1OyAvLyBmYWxsYmFjayBmb3IgV2ViR0wgMQoKY29uc3QgV2ViR0xDb29yZGluYXRlU3lzdGVtID0gMjAwMDsKY29uc3QgV2ViR1BVQ29vcmRpbmF0ZVN5c3RlbSA9IDIwMDE7CgovKioKICogaHR0cHM6Ly9naXRodWIuY29tL21yZG9vYi9ldmVudGRpc3BhdGNoZXIuanMvCiAqLwoKY2xhc3MgRXZlbnREaXNwYXRjaGVyIHsKCglhZGRFdmVudExpc3RlbmVyKCB0eXBlLCBsaXN0ZW5lciApIHsKCgkJaWYgKCB0aGlzLl9saXN0ZW5lcnMgPT09IHVuZGVmaW5lZCApIHRoaXMuX2xpc3RlbmVycyA9IHt9OwoKCQljb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CgoJCWlmICggbGlzdGVuZXJzWyB0eXBlIF0gPT09IHVuZGVmaW5lZCApIHsKCgkJCWxpc3RlbmVyc1sgdHlwZSBdID0gW107CgoJCX0KCgkJaWYgKCBsaXN0ZW5lcnNbIHR5cGUgXS5pbmRleE9mKCBsaXN0ZW5lciApID09PSAtIDEgKSB7CgoJCQlsaXN0ZW5lcnNbIHR5cGUgXS5wdXNoKCBsaXN0ZW5lciApOwoKCQl9CgoJfQoKCWhhc0V2ZW50TGlzdGVuZXIoIHR5cGUsIGxpc3RlbmVyICkgewoKCQlpZiAoIHRoaXMuX2xpc3RlbmVycyA9PT0gdW5kZWZpbmVkICkgcmV0dXJuIGZhbHNlOwoKCQljb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CgoJCXJldHVybiBsaXN0ZW5lcnNbIHR5cGUgXSAhPT0gdW5kZWZpbmVkICYmIGxpc3RlbmVyc1sgdHlwZSBdLmluZGV4T2YoIGxpc3RlbmVyICkgIT09IC0gMTsKCgl9CgoJcmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgbGlzdGVuZXIgKSB7CgoJCWlmICggdGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQgKSByZXR1cm47CgoJCWNvbnN0IGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKCQljb25zdCBsaXN0ZW5lckFycmF5ID0gbGlzdGVuZXJzWyB0eXBlIF07CgoJCWlmICggbGlzdGVuZXJBcnJheSAhPT0gdW5kZWZpbmVkICkgewoKCQkJY29uc3QgaW5kZXggPSBsaXN0ZW5lckFycmF5LmluZGV4T2YoIGxpc3RlbmVyICk7CgoJCQlpZiAoIGluZGV4ICE9PSAtIDEgKSB7CgoJCQkJbGlzdGVuZXJBcnJheS5zcGxpY2UoIGluZGV4LCAxICk7CgoJCQl9CgoJCX0KCgl9CgoJZGlzcGF0Y2hFdmVudCggZXZlbnQgKSB7CgoJCWlmICggdGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQgKSByZXR1cm47CgoJCWNvbnN0IGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsKCQljb25zdCBsaXN0ZW5lckFycmF5ID0gbGlzdGVuZXJzWyBldmVudC50eXBlIF07CgoJCWlmICggbGlzdGVuZXJBcnJheSAhPT0gdW5kZWZpbmVkICkgewoKCQkJZXZlbnQudGFyZ2V0ID0gdGhpczsKCgkJCS8vIE1ha2UgYSBjb3B5LCBpbiBjYXNlIGxpc3RlbmVycyBhcmUgcmVtb3ZlZCB3aGlsZSBpdGVyYXRpbmcuCgkJCWNvbnN0IGFycmF5ID0gbGlzdGVuZXJBcnJheS5zbGljZSggMCApOwoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQlhcnJheVsgaSBdLmNhbGwoIHRoaXMsIGV2ZW50ICk7CgoJCQl9CgoJCQlldmVudC50YXJnZXQgPSBudWxsOwoKCQl9CgoJfQoKfQoKY29uc3QgX2x1dCA9IFsgJzAwJywgJzAxJywgJzAyJywgJzAzJywgJzA0JywgJzA1JywgJzA2JywgJzA3JywgJzA4JywgJzA5JywgJzBhJywgJzBiJywgJzBjJywgJzBkJywgJzBlJywgJzBmJywgJzEwJywgJzExJywgJzEyJywgJzEzJywgJzE0JywgJzE1JywgJzE2JywgJzE3JywgJzE4JywgJzE5JywgJzFhJywgJzFiJywgJzFjJywgJzFkJywgJzFlJywgJzFmJywgJzIwJywgJzIxJywgJzIyJywgJzIzJywgJzI0JywgJzI1JywgJzI2JywgJzI3JywgJzI4JywgJzI5JywgJzJhJywgJzJiJywgJzJjJywgJzJkJywgJzJlJywgJzJmJywgJzMwJywgJzMxJywgJzMyJywgJzMzJywgJzM0JywgJzM1JywgJzM2JywgJzM3JywgJzM4JywgJzM5JywgJzNhJywgJzNiJywgJzNjJywgJzNkJywgJzNlJywgJzNmJywgJzQwJywgJzQxJywgJzQyJywgJzQzJywgJzQ0JywgJzQ1JywgJzQ2JywgJzQ3JywgJzQ4JywgJzQ5JywgJzRhJywgJzRiJywgJzRjJywgJzRkJywgJzRlJywgJzRmJywgJzUwJywgJzUxJywgJzUyJywgJzUzJywgJzU0JywgJzU1JywgJzU2JywgJzU3JywgJzU4JywgJzU5JywgJzVhJywgJzViJywgJzVjJywgJzVkJywgJzVlJywgJzVmJywgJzYwJywgJzYxJywgJzYyJywgJzYzJywgJzY0JywgJzY1JywgJzY2JywgJzY3JywgJzY4JywgJzY5JywgJzZhJywgJzZiJywgJzZjJywgJzZkJywgJzZlJywgJzZmJywgJzcwJywgJzcxJywgJzcyJywgJzczJywgJzc0JywgJzc1JywgJzc2JywgJzc3JywgJzc4JywgJzc5JywgJzdhJywgJzdiJywgJzdjJywgJzdkJywgJzdlJywgJzdmJywgJzgwJywgJzgxJywgJzgyJywgJzgzJywgJzg0JywgJzg1JywgJzg2JywgJzg3JywgJzg4JywgJzg5JywgJzhhJywgJzhiJywgJzhjJywgJzhkJywgJzhlJywgJzhmJywgJzkwJywgJzkxJywgJzkyJywgJzkzJywgJzk0JywgJzk1JywgJzk2JywgJzk3JywgJzk4JywgJzk5JywgJzlhJywgJzliJywgJzljJywgJzlkJywgJzllJywgJzlmJywgJ2EwJywgJ2ExJywgJ2EyJywgJ2EzJywgJ2E0JywgJ2E1JywgJ2E2JywgJ2E3JywgJ2E4JywgJ2E5JywgJ2FhJywgJ2FiJywgJ2FjJywgJ2FkJywgJ2FlJywgJ2FmJywgJ2IwJywgJ2IxJywgJ2IyJywgJ2IzJywgJ2I0JywgJ2I1JywgJ2I2JywgJ2I3JywgJ2I4JywgJ2I5JywgJ2JhJywgJ2JiJywgJ2JjJywgJ2JkJywgJ2JlJywgJ2JmJywgJ2MwJywgJ2MxJywgJ2MyJywgJ2MzJywgJ2M0JywgJ2M1JywgJ2M2JywgJ2M3JywgJ2M4JywgJ2M5JywgJ2NhJywgJ2NiJywgJ2NjJywgJ2NkJywgJ2NlJywgJ2NmJywgJ2QwJywgJ2QxJywgJ2QyJywgJ2QzJywgJ2Q0JywgJ2Q1JywgJ2Q2JywgJ2Q3JywgJ2Q4JywgJ2Q5JywgJ2RhJywgJ2RiJywgJ2RjJywgJ2RkJywgJ2RlJywgJ2RmJywgJ2UwJywgJ2UxJywgJ2UyJywgJ2UzJywgJ2U0JywgJ2U1JywgJ2U2JywgJ2U3JywgJ2U4JywgJ2U5JywgJ2VhJywgJ2ViJywgJ2VjJywgJ2VkJywgJ2VlJywgJ2VmJywgJ2YwJywgJ2YxJywgJ2YyJywgJ2YzJywgJ2Y0JywgJ2Y1JywgJ2Y2JywgJ2Y3JywgJ2Y4JywgJ2Y5JywgJ2ZhJywgJ2ZiJywgJ2ZjJywgJ2ZkJywgJ2ZlJywgJ2ZmJyBdOwoKbGV0IF9zZWVkID0gMTIzNDU2NzsKCgpjb25zdCBERUcyUkFEID0gTWF0aC5QSSAvIDE4MDsKY29uc3QgUkFEMkRFRyA9IDE4MCAvIE1hdGguUEk7CgovLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzEwNTAzNC9ob3ctdG8tY3JlYXRlLWEtZ3VpZC11dWlkLWluLWphdmFzY3JpcHQvMjE5NjMxMzYjMjE5NjMxMzYKZnVuY3Rpb24gZ2VuZXJhdGVVVUlEKCkgewoKCWNvbnN0IGQwID0gTWF0aC5yYW5kb20oKSAqIDB4ZmZmZmZmZmYgfCAwOwoJY29uc3QgZDEgPSBNYXRoLnJhbmRvbSgpICogMHhmZmZmZmZmZiB8IDA7Cgljb25zdCBkMiA9IE1hdGgucmFuZG9tKCkgKiAweGZmZmZmZmZmIHwgMDsKCWNvbnN0IGQzID0gTWF0aC5yYW5kb20oKSAqIDB4ZmZmZmZmZmYgfCAwOwoJY29uc3QgdXVpZCA9IF9sdXRbIGQwICYgMHhmZiBdICsgX2x1dFsgZDAgPj4gOCAmIDB4ZmYgXSArIF9sdXRbIGQwID4+IDE2ICYgMHhmZiBdICsgX2x1dFsgZDAgPj4gMjQgJiAweGZmIF0gKyAnLScgKwoJCQlfbHV0WyBkMSAmIDB4ZmYgXSArIF9sdXRbIGQxID4+IDggJiAweGZmIF0gKyAnLScgKyBfbHV0WyBkMSA+PiAxNiAmIDB4MGYgfCAweDQwIF0gKyBfbHV0WyBkMSA+PiAyNCAmIDB4ZmYgXSArICctJyArCgkJCV9sdXRbIGQyICYgMHgzZiB8IDB4ODAgXSArIF9sdXRbIGQyID4+IDggJiAweGZmIF0gKyAnLScgKyBfbHV0WyBkMiA+PiAxNiAmIDB4ZmYgXSArIF9sdXRbIGQyID4+IDI0ICYgMHhmZiBdICsKCQkJX2x1dFsgZDMgJiAweGZmIF0gKyBfbHV0WyBkMyA+PiA4ICYgMHhmZiBdICsgX2x1dFsgZDMgPj4gMTYgJiAweGZmIF0gKyBfbHV0WyBkMyA+PiAyNCAmIDB4ZmYgXTsKCgkvLyAudG9Mb3dlckNhc2UoKSBoZXJlIGZsYXR0ZW5zIGNvbmNhdGVuYXRlZCBzdHJpbmdzIHRvIHNhdmUgaGVhcCBtZW1vcnkgc3BhY2UuCglyZXR1cm4gdXVpZC50b0xvd2VyQ2FzZSgpOwoKfQoKZnVuY3Rpb24gY2xhbXAoIHZhbHVlLCBtaW4sIG1heCApIHsKCglyZXR1cm4gTWF0aC5tYXgoIG1pbiwgTWF0aC5taW4oIG1heCwgdmFsdWUgKSApOwoKfQoKLy8gY29tcHV0ZSBldWNsaWRlYW4gbW9kdWxvIG9mIG0gJSBuCi8vIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL01vZHVsb19vcGVyYXRpb24KZnVuY3Rpb24gZXVjbGlkZWFuTW9kdWxvKCBuLCBtICkgewoKCXJldHVybiAoICggbiAlIG0gKSArIG0gKSAlIG07Cgp9CgovLyBMaW5lYXIgbWFwcGluZyBmcm9tIHJhbmdlIDxhMSwgYTI+IHRvIHJhbmdlIDxiMSwgYjI+CmZ1bmN0aW9uIG1hcExpbmVhciggeCwgYTEsIGEyLCBiMSwgYjIgKSB7CgoJcmV0dXJuIGIxICsgKCB4IC0gYTEgKSAqICggYjIgLSBiMSApIC8gKCBhMiAtIGExICk7Cgp9CgovLyBodHRwczovL3d3dy5nYW1lZGV2Lm5ldC90dXRvcmlhbHMvcHJvZ3JhbW1pbmcvZ2VuZXJhbC1hbmQtZ2FtZXBsYXktcHJvZ3JhbW1pbmcvaW52ZXJzZS1sZXJwLWEtc3VwZXItdXNlZnVsLXlldC1vZnRlbi1vdmVybG9va2VkLWZ1bmN0aW9uLXI1MjMwLwpmdW5jdGlvbiBpbnZlcnNlTGVycCggeCwgeSwgdmFsdWUgKSB7CgoJaWYgKCB4ICE9PSB5ICkgewoKCQlyZXR1cm4gKCB2YWx1ZSAtIHggKSAvICggeSAtIHggKTsKCgl9IGVsc2UgewoKCQlyZXR1cm4gMDsKCgl9Cgp9CgovLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9MaW5lYXJfaW50ZXJwb2xhdGlvbgpmdW5jdGlvbiBsZXJwKCB4LCB5LCB0ICkgewoKCXJldHVybiAoIDEgLSB0ICkgKiB4ICsgdCAqIHk7Cgp9CgovLyBodHRwOi8vd3d3LnJvcnlkcmlzY29sbC5jb20vMjAxNi8wMy8wNy9mcmFtZS1yYXRlLWluZGVwZW5kZW50LWRhbXBpbmctdXNpbmctbGVycC8KZnVuY3Rpb24gZGFtcCggeCwgeSwgbGFtYmRhLCBkdCApIHsKCglyZXR1cm4gbGVycCggeCwgeSwgMSAtIE1hdGguZXhwKCAtIGxhbWJkYSAqIGR0ICkgKTsKCn0KCi8vIGh0dHBzOi8vd3d3LmRlc21vcy5jb20vY2FsY3VsYXRvci92Y3Nqbnl6N3g0CmZ1bmN0aW9uIHBpbmdwb25nKCB4LCBsZW5ndGggPSAxICkgewoKCXJldHVybiBsZW5ndGggLSBNYXRoLmFicyggZXVjbGlkZWFuTW9kdWxvKCB4LCBsZW5ndGggKiAyICkgLSBsZW5ndGggKTsKCn0KCi8vIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU21vb3Roc3RlcApmdW5jdGlvbiBzbW9vdGhzdGVwKCB4LCBtaW4sIG1heCApIHsKCglpZiAoIHggPD0gbWluICkgcmV0dXJuIDA7CglpZiAoIHggPj0gbWF4ICkgcmV0dXJuIDE7CgoJeCA9ICggeCAtIG1pbiApIC8gKCBtYXggLSBtaW4gKTsKCglyZXR1cm4geCAqIHggKiAoIDMgLSAyICogeCApOwoKfQoKZnVuY3Rpb24gc21vb3RoZXJzdGVwKCB4LCBtaW4sIG1heCApIHsKCglpZiAoIHggPD0gbWluICkgcmV0dXJuIDA7CglpZiAoIHggPj0gbWF4ICkgcmV0dXJuIDE7CgoJeCA9ICggeCAtIG1pbiApIC8gKCBtYXggLSBtaW4gKTsKCglyZXR1cm4geCAqIHggKiB4ICogKCB4ICogKCB4ICogNiAtIDE1ICkgKyAxMCApOwoKfQoKLy8gUmFuZG9tIGludGVnZXIgZnJvbSA8bG93LCBoaWdoPiBpbnRlcnZhbApmdW5jdGlvbiByYW5kSW50KCBsb3csIGhpZ2ggKSB7CgoJcmV0dXJuIGxvdyArIE1hdGguZmxvb3IoIE1hdGgucmFuZG9tKCkgKiAoIGhpZ2ggLSBsb3cgKyAxICkgKTsKCn0KCi8vIFJhbmRvbSBmbG9hdCBmcm9tIDxsb3csIGhpZ2g+IGludGVydmFsCmZ1bmN0aW9uIHJhbmRGbG9hdCggbG93LCBoaWdoICkgewoKCXJldHVybiBsb3cgKyBNYXRoLnJhbmRvbSgpICogKCBoaWdoIC0gbG93ICk7Cgp9CgovLyBSYW5kb20gZmxvYXQgZnJvbSA8LXJhbmdlLzIsIHJhbmdlLzI+IGludGVydmFsCmZ1bmN0aW9uIHJhbmRGbG9hdFNwcmVhZCggcmFuZ2UgKSB7CgoJcmV0dXJuIHJhbmdlICogKCAwLjUgLSBNYXRoLnJhbmRvbSgpICk7Cgp9CgovLyBEZXRlcm1pbmlzdGljIHBzZXVkby1yYW5kb20gZmxvYXQgaW4gdGhlIGludGVydmFsIFsgMCwgMSBdCmZ1bmN0aW9uIHNlZWRlZFJhbmRvbSggcyApIHsKCglpZiAoIHMgIT09IHVuZGVmaW5lZCApIF9zZWVkID0gczsKCgkvLyBNdWxiZXJyeTMyIGdlbmVyYXRvcgoKCWxldCB0ID0gX3NlZWQgKz0gMHg2RDJCNzlGNTsKCgl0ID0gTWF0aC5pbXVsKCB0IF4gdCA+Pj4gMTUsIHQgfCAxICk7CgoJdCBePSB0ICsgTWF0aC5pbXVsKCB0IF4gdCA+Pj4gNywgdCB8IDYxICk7CgoJcmV0dXJuICggKCB0IF4gdCA+Pj4gMTQgKSA+Pj4gMCApIC8gNDI5NDk2NzI5NjsKCn0KCmZ1bmN0aW9uIGRlZ1RvUmFkKCBkZWdyZWVzICkgewoKCXJldHVybiBkZWdyZWVzICogREVHMlJBRDsKCn0KCmZ1bmN0aW9uIHJhZFRvRGVnKCByYWRpYW5zICkgewoKCXJldHVybiByYWRpYW5zICogUkFEMkRFRzsKCn0KCmZ1bmN0aW9uIGlzUG93ZXJPZlR3byggdmFsdWUgKSB7CgoJcmV0dXJuICggdmFsdWUgJiAoIHZhbHVlIC0gMSApICkgPT09IDAgJiYgdmFsdWUgIT09IDA7Cgp9CgpmdW5jdGlvbiBjZWlsUG93ZXJPZlR3byggdmFsdWUgKSB7CgoJcmV0dXJuIE1hdGgucG93KCAyLCBNYXRoLmNlaWwoIE1hdGgubG9nKCB2YWx1ZSApIC8gTWF0aC5MTjIgKSApOwoKfQoKZnVuY3Rpb24gZmxvb3JQb3dlck9mVHdvKCB2YWx1ZSApIHsKCglyZXR1cm4gTWF0aC5wb3coIDIsIE1hdGguZmxvb3IoIE1hdGgubG9nKCB2YWx1ZSApIC8gTWF0aC5MTjIgKSApOwoKfQoKZnVuY3Rpb24gc2V0UXVhdGVybmlvbkZyb21Qcm9wZXJFdWxlciggcSwgYSwgYiwgYywgb3JkZXIgKSB7CgoJLy8gSW50cmluc2ljIFByb3BlciBFdWxlciBBbmdsZXMgLSBzZWUgaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRXVsZXJfYW5nbGVzCgoJLy8gcm90YXRpb25zIGFyZSBhcHBsaWVkIHRvIHRoZSBheGVzIGluIHRoZSBvcmRlciBzcGVjaWZpZWQgYnkgJ29yZGVyJwoJLy8gcm90YXRpb24gYnkgYW5nbGUgJ2EnIGlzIGFwcGxpZWQgZmlyc3QsIHRoZW4gYnkgYW5nbGUgJ2InLCB0aGVuIGJ5IGFuZ2xlICdjJwoJLy8gYW5nbGVzIGFyZSBpbiByYWRpYW5zCgoJY29uc3QgY29zID0gTWF0aC5jb3M7Cgljb25zdCBzaW4gPSBNYXRoLnNpbjsKCgljb25zdCBjMiA9IGNvcyggYiAvIDIgKTsKCWNvbnN0IHMyID0gc2luKCBiIC8gMiApOwoKCWNvbnN0IGMxMyA9IGNvcyggKCBhICsgYyApIC8gMiApOwoJY29uc3QgczEzID0gc2luKCAoIGEgKyBjICkgLyAyICk7CgoJY29uc3QgYzFfMyA9IGNvcyggKCBhIC0gYyApIC8gMiApOwoJY29uc3QgczFfMyA9IHNpbiggKCBhIC0gYyApIC8gMiApOwoKCWNvbnN0IGMzXzEgPSBjb3MoICggYyAtIGEgKSAvIDIgKTsKCWNvbnN0IHMzXzEgPSBzaW4oICggYyAtIGEgKSAvIDIgKTsKCglzd2l0Y2ggKCBvcmRlciApIHsKCgkJY2FzZSAnWFlYJzoKCQkJcS5zZXQoIGMyICogczEzLCBzMiAqIGMxXzMsIHMyICogczFfMywgYzIgKiBjMTMgKTsKCQkJYnJlYWs7CgoJCWNhc2UgJ1laWSc6CgkJCXEuc2V0KCBzMiAqIHMxXzMsIGMyICogczEzLCBzMiAqIGMxXzMsIGMyICogYzEzICk7CgkJCWJyZWFrOwoKCQljYXNlICdaWFonOgoJCQlxLnNldCggczIgKiBjMV8zLCBzMiAqIHMxXzMsIGMyICogczEzLCBjMiAqIGMxMyApOwoJCQlicmVhazsKCgkJY2FzZSAnWFpYJzoKCQkJcS5zZXQoIGMyICogczEzLCBzMiAqIHMzXzEsIHMyICogYzNfMSwgYzIgKiBjMTMgKTsKCQkJYnJlYWs7CgoJCWNhc2UgJ1lYWSc6CgkJCXEuc2V0KCBzMiAqIGMzXzEsIGMyICogczEzLCBzMiAqIHMzXzEsIGMyICogYzEzICk7CgkJCWJyZWFrOwoKCQljYXNlICdaWVonOgoJCQlxLnNldCggczIgKiBzM18xLCBzMiAqIGMzXzEsIGMyICogczEzLCBjMiAqIGMxMyApOwoJCQlicmVhazsKCgkJZGVmYXVsdDoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuTWF0aFV0aWxzOiAuc2V0UXVhdGVybmlvbkZyb21Qcm9wZXJFdWxlcigpIGVuY291bnRlcmVkIGFuIHVua25vd24gb3JkZXI6ICcgKyBvcmRlciApOwoKCX0KCn0KCmZ1bmN0aW9uIGRlbm9ybWFsaXplKCB2YWx1ZSwgYXJyYXkgKSB7CgoJc3dpdGNoICggYXJyYXkuY29uc3RydWN0b3IgKSB7CgoJCWNhc2UgRmxvYXQzMkFycmF5OgoKCQkJcmV0dXJuIHZhbHVlOwoKCQljYXNlIFVpbnQzMkFycmF5OgoKCQkJcmV0dXJuIHZhbHVlIC8gNDI5NDk2NzI5NS4wOwoKCQljYXNlIFVpbnQxNkFycmF5OgoKCQkJcmV0dXJuIHZhbHVlIC8gNjU1MzUuMDsKCgkJY2FzZSBVaW50OEFycmF5OgoKCQkJcmV0dXJuIHZhbHVlIC8gMjU1LjA7CgoJCWNhc2UgSW50MzJBcnJheToKCgkJCXJldHVybiBNYXRoLm1heCggdmFsdWUgLyAyMTQ3NDgzNjQ3LjAsIC0gMS4wICk7CgoJCWNhc2UgSW50MTZBcnJheToKCgkJCXJldHVybiBNYXRoLm1heCggdmFsdWUgLyAzMjc2Ny4wLCAtIDEuMCApOwoKCQljYXNlIEludDhBcnJheToKCgkJCXJldHVybiBNYXRoLm1heCggdmFsdWUgLyAxMjcuMCwgLSAxLjAgKTsKCgkJZGVmYXVsdDoKCgkJCXRocm93IG5ldyBFcnJvciggJ0ludmFsaWQgY29tcG9uZW50IHR5cGUuJyApOwoKCX0KCn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZSggdmFsdWUsIGFycmF5ICkgewoKCXN3aXRjaCAoIGFycmF5LmNvbnN0cnVjdG9yICkgewoKCQljYXNlIEZsb2F0MzJBcnJheToKCgkJCXJldHVybiB2YWx1ZTsKCgkJY2FzZSBVaW50MzJBcnJheToKCgkJCXJldHVybiBNYXRoLnJvdW5kKCB2YWx1ZSAqIDQyOTQ5NjcyOTUuMCApOwoKCQljYXNlIFVpbnQxNkFycmF5OgoKCQkJcmV0dXJuIE1hdGgucm91bmQoIHZhbHVlICogNjU1MzUuMCApOwoKCQljYXNlIFVpbnQ4QXJyYXk6CgoJCQlyZXR1cm4gTWF0aC5yb3VuZCggdmFsdWUgKiAyNTUuMCApOwoKCQljYXNlIEludDMyQXJyYXk6CgoJCQlyZXR1cm4gTWF0aC5yb3VuZCggdmFsdWUgKiAyMTQ3NDgzNjQ3LjAgKTsKCgkJY2FzZSBJbnQxNkFycmF5OgoKCQkJcmV0dXJuIE1hdGgucm91bmQoIHZhbHVlICogMzI3NjcuMCApOwoKCQljYXNlIEludDhBcnJheToKCgkJCXJldHVybiBNYXRoLnJvdW5kKCB2YWx1ZSAqIDEyNy4wICk7CgoJCWRlZmF1bHQ6CgoJCQl0aHJvdyBuZXcgRXJyb3IoICdJbnZhbGlkIGNvbXBvbmVudCB0eXBlLicgKTsKCgl9Cgp9Cgpjb25zdCBNYXRoVXRpbHMgPSB7CglERUcyUkFEOiBERUcyUkFELAoJUkFEMkRFRzogUkFEMkRFRywKCWdlbmVyYXRlVVVJRDogZ2VuZXJhdGVVVUlELAoJY2xhbXA6IGNsYW1wLAoJZXVjbGlkZWFuTW9kdWxvOiBldWNsaWRlYW5Nb2R1bG8sCgltYXBMaW5lYXI6IG1hcExpbmVhciwKCWludmVyc2VMZXJwOiBpbnZlcnNlTGVycCwKCWxlcnA6IGxlcnAsCglkYW1wOiBkYW1wLAoJcGluZ3Bvbmc6IHBpbmdwb25nLAoJc21vb3Roc3RlcDogc21vb3Roc3RlcCwKCXNtb290aGVyc3RlcDogc21vb3RoZXJzdGVwLAoJcmFuZEludDogcmFuZEludCwKCXJhbmRGbG9hdDogcmFuZEZsb2F0LAoJcmFuZEZsb2F0U3ByZWFkOiByYW5kRmxvYXRTcHJlYWQsCglzZWVkZWRSYW5kb206IHNlZWRlZFJhbmRvbSwKCWRlZ1RvUmFkOiBkZWdUb1JhZCwKCXJhZFRvRGVnOiByYWRUb0RlZywKCWlzUG93ZXJPZlR3bzogaXNQb3dlck9mVHdvLAoJY2VpbFBvd2VyT2ZUd286IGNlaWxQb3dlck9mVHdvLAoJZmxvb3JQb3dlck9mVHdvOiBmbG9vclBvd2VyT2ZUd28sCglzZXRRdWF0ZXJuaW9uRnJvbVByb3BlckV1bGVyOiBzZXRRdWF0ZXJuaW9uRnJvbVByb3BlckV1bGVyLAoJbm9ybWFsaXplOiBub3JtYWxpemUsCglkZW5vcm1hbGl6ZTogZGVub3JtYWxpemUKfTsKCmNsYXNzIFZlY3RvcjIgewoKCWNvbnN0cnVjdG9yKCB4ID0gMCwgeSA9IDAgKSB7CgoJCVZlY3RvcjIucHJvdG90eXBlLmlzVmVjdG9yMiA9IHRydWU7CgoJCXRoaXMueCA9IHg7CgkJdGhpcy55ID0geTsKCgl9CgoJZ2V0IHdpZHRoKCkgewoKCQlyZXR1cm4gdGhpcy54OwoKCX0KCglzZXQgd2lkdGgoIHZhbHVlICkgewoKCQl0aGlzLnggPSB2YWx1ZTsKCgl9CgoJZ2V0IGhlaWdodCgpIHsKCgkJcmV0dXJuIHRoaXMueTsKCgl9CgoJc2V0IGhlaWdodCggdmFsdWUgKSB7CgoJCXRoaXMueSA9IHZhbHVlOwoKCX0KCglzZXQoIHgsIHkgKSB7CgoJCXRoaXMueCA9IHg7CgkJdGhpcy55ID0geTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFNjYWxhciggc2NhbGFyICkgewoKCQl0aGlzLnggPSBzY2FsYXI7CgkJdGhpcy55ID0gc2NhbGFyOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0WCggeCApIHsKCgkJdGhpcy54ID0geDsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFkoIHkgKSB7CgoJCXRoaXMueSA9IHk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRDb21wb25lbnQoIGluZGV4LCB2YWx1ZSApIHsKCgkJc3dpdGNoICggaW5kZXggKSB7CgoJCQljYXNlIDA6IHRoaXMueCA9IHZhbHVlOyBicmVhazsKCQkJY2FzZSAxOiB0aGlzLnkgPSB2YWx1ZTsgYnJlYWs7CgkJCWRlZmF1bHQ6IHRocm93IG5ldyBFcnJvciggJ2luZGV4IGlzIG91dCBvZiByYW5nZTogJyArIGluZGV4ICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldENvbXBvbmVudCggaW5kZXggKSB7CgoJCXN3aXRjaCAoIGluZGV4ICkgewoKCQkJY2FzZSAwOiByZXR1cm4gdGhpcy54OwoJCQljYXNlIDE6IHJldHVybiB0aGlzLnk7CgkJCWRlZmF1bHQ6IHRocm93IG5ldyBFcnJvciggJ2luZGV4IGlzIG91dCBvZiByYW5nZTogJyArIGluZGV4ICk7CgoJCX0KCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvciggdGhpcy54LCB0aGlzLnkgKTsKCgl9CgoJY29weSggdiApIHsKCgkJdGhpcy54ID0gdi54OwoJCXRoaXMueSA9IHYueTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFkZCggdiApIHsKCgkJdGhpcy54ICs9IHYueDsKCQl0aGlzLnkgKz0gdi55OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJYWRkU2NhbGFyKCBzICkgewoKCQl0aGlzLnggKz0gczsKCQl0aGlzLnkgKz0gczsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFkZFZlY3RvcnMoIGEsIGIgKSB7CgoJCXRoaXMueCA9IGEueCArIGIueDsKCQl0aGlzLnkgPSBhLnkgKyBiLnk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglhZGRTY2FsZWRWZWN0b3IoIHYsIHMgKSB7CgoJCXRoaXMueCArPSB2LnggKiBzOwoJCXRoaXMueSArPSB2LnkgKiBzOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3ViKCB2ICkgewoKCQl0aGlzLnggLT0gdi54OwoJCXRoaXMueSAtPSB2Lnk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzdWJTY2FsYXIoIHMgKSB7CgoJCXRoaXMueCAtPSBzOwoJCXRoaXMueSAtPSBzOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3ViVmVjdG9ycyggYSwgYiApIHsKCgkJdGhpcy54ID0gYS54IC0gYi54OwoJCXRoaXMueSA9IGEueSAtIGIueTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW11bHRpcGx5KCB2ICkgewoKCQl0aGlzLnggKj0gdi54OwoJCXRoaXMueSAqPSB2Lnk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltdWx0aXBseVNjYWxhciggc2NhbGFyICkgewoKCQl0aGlzLnggKj0gc2NhbGFyOwoJCXRoaXMueSAqPSBzY2FsYXI7CgoJCXJldHVybiB0aGlzOwoKCX0KCglkaXZpZGUoIHYgKSB7CgoJCXRoaXMueCAvPSB2Lng7CgkJdGhpcy55IC89IHYueTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWRpdmlkZVNjYWxhciggc2NhbGFyICkgewoKCQlyZXR1cm4gdGhpcy5tdWx0aXBseVNjYWxhciggMSAvIHNjYWxhciApOwoKCX0KCglhcHBseU1hdHJpeDMoIG0gKSB7CgoJCWNvbnN0IHggPSB0aGlzLngsIHkgPSB0aGlzLnk7CgkJY29uc3QgZSA9IG0uZWxlbWVudHM7CgoJCXRoaXMueCA9IGVbIDAgXSAqIHggKyBlWyAzIF0gKiB5ICsgZVsgNiBdOwoJCXRoaXMueSA9IGVbIDEgXSAqIHggKyBlWyA0IF0gKiB5ICsgZVsgNyBdOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbWluKCB2ICkgewoKCQl0aGlzLnggPSBNYXRoLm1pbiggdGhpcy54LCB2LnggKTsKCQl0aGlzLnkgPSBNYXRoLm1pbiggdGhpcy55LCB2LnkgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW1heCggdiApIHsKCgkJdGhpcy54ID0gTWF0aC5tYXgoIHRoaXMueCwgdi54ICk7CgkJdGhpcy55ID0gTWF0aC5tYXgoIHRoaXMueSwgdi55ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljbGFtcCggbWluLCBtYXggKSB7CgoJCS8vIGFzc3VtZXMgbWluIDwgbWF4LCBjb21wb25lbnR3aXNlCgoJCXRoaXMueCA9IE1hdGgubWF4KCBtaW4ueCwgTWF0aC5taW4oIG1heC54LCB0aGlzLnggKSApOwoJCXRoaXMueSA9IE1hdGgubWF4KCBtaW4ueSwgTWF0aC5taW4oIG1heC55LCB0aGlzLnkgKSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xhbXBTY2FsYXIoIG1pblZhbCwgbWF4VmFsICkgewoKCQl0aGlzLnggPSBNYXRoLm1heCggbWluVmFsLCBNYXRoLm1pbiggbWF4VmFsLCB0aGlzLnggKSApOwoJCXRoaXMueSA9IE1hdGgubWF4KCBtaW5WYWwsIE1hdGgubWluKCBtYXhWYWwsIHRoaXMueSApICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljbGFtcExlbmd0aCggbWluLCBtYXggKSB7CgoJCWNvbnN0IGxlbmd0aCA9IHRoaXMubGVuZ3RoKCk7CgoJCXJldHVybiB0aGlzLmRpdmlkZVNjYWxhciggbGVuZ3RoIHx8IDEgKS5tdWx0aXBseVNjYWxhciggTWF0aC5tYXgoIG1pbiwgTWF0aC5taW4oIG1heCwgbGVuZ3RoICkgKSApOwoKCX0KCglmbG9vcigpIHsKCgkJdGhpcy54ID0gTWF0aC5mbG9vciggdGhpcy54ICk7CgkJdGhpcy55ID0gTWF0aC5mbG9vciggdGhpcy55ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljZWlsKCkgewoKCQl0aGlzLnggPSBNYXRoLmNlaWwoIHRoaXMueCApOwoJCXRoaXMueSA9IE1hdGguY2VpbCggdGhpcy55ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglyb3VuZCgpIHsKCgkJdGhpcy54ID0gTWF0aC5yb3VuZCggdGhpcy54ICk7CgkJdGhpcy55ID0gTWF0aC5yb3VuZCggdGhpcy55ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglyb3VuZFRvWmVybygpIHsKCgkJdGhpcy54ID0gTWF0aC50cnVuYyggdGhpcy54ICk7CgkJdGhpcy55ID0gTWF0aC50cnVuYyggdGhpcy55ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgluZWdhdGUoKSB7CgoJCXRoaXMueCA9IC0gdGhpcy54OwoJCXRoaXMueSA9IC0gdGhpcy55OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZG90KCB2ICkgewoKCQlyZXR1cm4gdGhpcy54ICogdi54ICsgdGhpcy55ICogdi55OwoKCX0KCgljcm9zcyggdiApIHsKCgkJcmV0dXJuIHRoaXMueCAqIHYueSAtIHRoaXMueSAqIHYueDsKCgl9CgoJbGVuZ3RoU3EoKSB7CgoJCXJldHVybiB0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnk7CgoJfQoKCWxlbmd0aCgpIHsKCgkJcmV0dXJuIE1hdGguc3FydCggdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICk7CgoJfQoKCW1hbmhhdHRhbkxlbmd0aCgpIHsKCgkJcmV0dXJuIE1hdGguYWJzKCB0aGlzLnggKSArIE1hdGguYWJzKCB0aGlzLnkgKTsKCgl9CgoJbm9ybWFsaXplKCkgewoKCQlyZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIoIHRoaXMubGVuZ3RoKCkgfHwgMSApOwoKCX0KCglhbmdsZSgpIHsKCgkJLy8gY29tcHV0ZXMgdGhlIGFuZ2xlIGluIHJhZGlhbnMgd2l0aCByZXNwZWN0IHRvIHRoZSBwb3NpdGl2ZSB4LWF4aXMKCgkJY29uc3QgYW5nbGUgPSBNYXRoLmF0YW4yKCAtIHRoaXMueSwgLSB0aGlzLnggKSArIE1hdGguUEk7CgoJCXJldHVybiBhbmdsZTsKCgl9CgoJYW5nbGVUbyggdiApIHsKCgkJY29uc3QgZGVub21pbmF0b3IgPSBNYXRoLnNxcnQoIHRoaXMubGVuZ3RoU3EoKSAqIHYubGVuZ3RoU3EoKSApOwoKCQlpZiAoIGRlbm9taW5hdG9yID09PSAwICkgcmV0dXJuIE1hdGguUEkgLyAyOwoKCQljb25zdCB0aGV0YSA9IHRoaXMuZG90KCB2ICkgLyBkZW5vbWluYXRvcjsKCgkJLy8gY2xhbXAsIHRvIGhhbmRsZSBudW1lcmljYWwgcHJvYmxlbXMKCgkJcmV0dXJuIE1hdGguYWNvcyggY2xhbXAoIHRoZXRhLCAtIDEsIDEgKSApOwoKCX0KCglkaXN0YW5jZVRvKCB2ICkgewoKCQlyZXR1cm4gTWF0aC5zcXJ0KCB0aGlzLmRpc3RhbmNlVG9TcXVhcmVkKCB2ICkgKTsKCgl9CgoJZGlzdGFuY2VUb1NxdWFyZWQoIHYgKSB7CgoJCWNvbnN0IGR4ID0gdGhpcy54IC0gdi54LCBkeSA9IHRoaXMueSAtIHYueTsKCQlyZXR1cm4gZHggKiBkeCArIGR5ICogZHk7CgoJfQoKCW1hbmhhdHRhbkRpc3RhbmNlVG8oIHYgKSB7CgoJCXJldHVybiBNYXRoLmFicyggdGhpcy54IC0gdi54ICkgKyBNYXRoLmFicyggdGhpcy55IC0gdi55ICk7CgoJfQoKCXNldExlbmd0aCggbGVuZ3RoICkgewoKCQlyZXR1cm4gdGhpcy5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhciggbGVuZ3RoICk7CgoJfQoKCWxlcnAoIHYsIGFscGhhICkgewoKCQl0aGlzLnggKz0gKCB2LnggLSB0aGlzLnggKSAqIGFscGhhOwoJCXRoaXMueSArPSAoIHYueSAtIHRoaXMueSApICogYWxwaGE7CgoJCXJldHVybiB0aGlzOwoKCX0KCglsZXJwVmVjdG9ycyggdjEsIHYyLCBhbHBoYSApIHsKCgkJdGhpcy54ID0gdjEueCArICggdjIueCAtIHYxLnggKSAqIGFscGhhOwoJCXRoaXMueSA9IHYxLnkgKyAoIHYyLnkgLSB2MS55ICkgKiBhbHBoYTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWVxdWFscyggdiApIHsKCgkJcmV0dXJuICggKCB2LnggPT09IHRoaXMueCApICYmICggdi55ID09PSB0aGlzLnkgKSApOwoKCX0KCglmcm9tQXJyYXkoIGFycmF5LCBvZmZzZXQgPSAwICkgewoKCQl0aGlzLnggPSBhcnJheVsgb2Zmc2V0IF07CgkJdGhpcy55ID0gYXJyYXlbIG9mZnNldCArIDEgXTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvQXJyYXkoIGFycmF5ID0gW10sIG9mZnNldCA9IDAgKSB7CgoJCWFycmF5WyBvZmZzZXQgXSA9IHRoaXMueDsKCQlhcnJheVsgb2Zmc2V0ICsgMSBdID0gdGhpcy55OwoKCQlyZXR1cm4gYXJyYXk7CgoJfQoKCWZyb21CdWZmZXJBdHRyaWJ1dGUoIGF0dHJpYnV0ZSwgaW5kZXggKSB7CgoJCXRoaXMueCA9IGF0dHJpYnV0ZS5nZXRYKCBpbmRleCApOwoJCXRoaXMueSA9IGF0dHJpYnV0ZS5nZXRZKCBpbmRleCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcm90YXRlQXJvdW5kKCBjZW50ZXIsIGFuZ2xlICkgewoKCQljb25zdCBjID0gTWF0aC5jb3MoIGFuZ2xlICksIHMgPSBNYXRoLnNpbiggYW5nbGUgKTsKCgkJY29uc3QgeCA9IHRoaXMueCAtIGNlbnRlci54OwoJCWNvbnN0IHkgPSB0aGlzLnkgLSBjZW50ZXIueTsKCgkJdGhpcy54ID0geCAqIGMgLSB5ICogcyArIGNlbnRlci54OwoJCXRoaXMueSA9IHggKiBzICsgeSAqIGMgKyBjZW50ZXIueTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJhbmRvbSgpIHsKCgkJdGhpcy54ID0gTWF0aC5yYW5kb20oKTsKCQl0aGlzLnkgPSBNYXRoLnJhbmRvbSgpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJKlsgU3ltYm9sLml0ZXJhdG9yIF0oKSB7CgoJCXlpZWxkIHRoaXMueDsKCQl5aWVsZCB0aGlzLnk7CgoJfQoKfQoKY2xhc3MgTWF0cml4MyB7CgoJY29uc3RydWN0b3IoIG4xMSwgbjEyLCBuMTMsIG4yMSwgbjIyLCBuMjMsIG4zMSwgbjMyLCBuMzMgKSB7CgoJCU1hdHJpeDMucHJvdG90eXBlLmlzTWF0cml4MyA9IHRydWU7CgoJCXRoaXMuZWxlbWVudHMgPSBbCgoJCQkxLCAwLCAwLAoJCQkwLCAxLCAwLAoJCQkwLCAwLCAxCgoJCV07CgoJCWlmICggbjExICE9PSB1bmRlZmluZWQgKSB7CgoJCQl0aGlzLnNldCggbjExLCBuMTIsIG4xMywgbjIxLCBuMjIsIG4yMywgbjMxLCBuMzIsIG4zMyApOwoKCQl9CgoJfQoKCXNldCggbjExLCBuMTIsIG4xMywgbjIxLCBuMjIsIG4yMywgbjMxLCBuMzIsIG4zMyApIHsKCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoKCQl0ZVsgMCBdID0gbjExOyB0ZVsgMSBdID0gbjIxOyB0ZVsgMiBdID0gbjMxOwoJCXRlWyAzIF0gPSBuMTI7IHRlWyA0IF0gPSBuMjI7IHRlWyA1IF0gPSBuMzI7CgkJdGVbIDYgXSA9IG4xMzsgdGVbIDcgXSA9IG4yMzsgdGVbIDggXSA9IG4zMzsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWlkZW50aXR5KCkgewoKCQl0aGlzLnNldCgKCgkJCTEsIDAsIDAsCgkJCTAsIDEsIDAsCgkJCTAsIDAsIDEKCgkJKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvcHkoIG0gKSB7CgoJCWNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKCQljb25zdCBtZSA9IG0uZWxlbWVudHM7CgoJCXRlWyAwIF0gPSBtZVsgMCBdOyB0ZVsgMSBdID0gbWVbIDEgXTsgdGVbIDIgXSA9IG1lWyAyIF07CgkJdGVbIDMgXSA9IG1lWyAzIF07IHRlWyA0IF0gPSBtZVsgNCBdOyB0ZVsgNSBdID0gbWVbIDUgXTsKCQl0ZVsgNiBdID0gbWVbIDYgXTsgdGVbIDcgXSA9IG1lWyA3IF07IHRlWyA4IF0gPSBtZVsgOCBdOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXh0cmFjdEJhc2lzKCB4QXhpcywgeUF4aXMsIHpBeGlzICkgewoKCQl4QXhpcy5zZXRGcm9tTWF0cml4M0NvbHVtbiggdGhpcywgMCApOwoJCXlBeGlzLnNldEZyb21NYXRyaXgzQ29sdW1uKCB0aGlzLCAxICk7CgkJekF4aXMuc2V0RnJvbU1hdHJpeDNDb2x1bW4oIHRoaXMsIDIgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEZyb21NYXRyaXg0KCBtICkgewoKCQljb25zdCBtZSA9IG0uZWxlbWVudHM7CgoJCXRoaXMuc2V0KAoKCQkJbWVbIDAgXSwgbWVbIDQgXSwgbWVbIDggXSwKCQkJbWVbIDEgXSwgbWVbIDUgXSwgbWVbIDkgXSwKCQkJbWVbIDIgXSwgbWVbIDYgXSwgbWVbIDEwIF0KCgkJKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW11bHRpcGx5KCBtICkgewoKCQlyZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKCB0aGlzLCBtICk7CgoJfQoKCXByZW11bHRpcGx5KCBtICkgewoKCQlyZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKCBtLCB0aGlzICk7CgoJfQoKCW11bHRpcGx5TWF0cmljZXMoIGEsIGIgKSB7CgoJCWNvbnN0IGFlID0gYS5lbGVtZW50czsKCQljb25zdCBiZSA9IGIuZWxlbWVudHM7CgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoKCQljb25zdCBhMTEgPSBhZVsgMCBdLCBhMTIgPSBhZVsgMyBdLCBhMTMgPSBhZVsgNiBdOwoJCWNvbnN0IGEyMSA9IGFlWyAxIF0sIGEyMiA9IGFlWyA0IF0sIGEyMyA9IGFlWyA3IF07CgkJY29uc3QgYTMxID0gYWVbIDIgXSwgYTMyID0gYWVbIDUgXSwgYTMzID0gYWVbIDggXTsKCgkJY29uc3QgYjExID0gYmVbIDAgXSwgYjEyID0gYmVbIDMgXSwgYjEzID0gYmVbIDYgXTsKCQljb25zdCBiMjEgPSBiZVsgMSBdLCBiMjIgPSBiZVsgNCBdLCBiMjMgPSBiZVsgNyBdOwoJCWNvbnN0IGIzMSA9IGJlWyAyIF0sIGIzMiA9IGJlWyA1IF0sIGIzMyA9IGJlWyA4IF07CgoJCXRlWyAwIF0gPSBhMTEgKiBiMTEgKyBhMTIgKiBiMjEgKyBhMTMgKiBiMzE7CgkJdGVbIDMgXSA9IGExMSAqIGIxMiArIGExMiAqIGIyMiArIGExMyAqIGIzMjsKCQl0ZVsgNiBdID0gYTExICogYjEzICsgYTEyICogYjIzICsgYTEzICogYjMzOwoKCQl0ZVsgMSBdID0gYTIxICogYjExICsgYTIyICogYjIxICsgYTIzICogYjMxOwoJCXRlWyA0IF0gPSBhMjEgKiBiMTIgKyBhMjIgKiBiMjIgKyBhMjMgKiBiMzI7CgkJdGVbIDcgXSA9IGEyMSAqIGIxMyArIGEyMiAqIGIyMyArIGEyMyAqIGIzMzsKCgkJdGVbIDIgXSA9IGEzMSAqIGIxMSArIGEzMiAqIGIyMSArIGEzMyAqIGIzMTsKCQl0ZVsgNSBdID0gYTMxICogYjEyICsgYTMyICogYjIyICsgYTMzICogYjMyOwoJCXRlWyA4IF0gPSBhMzEgKiBiMTMgKyBhMzIgKiBiMjMgKyBhMzMgKiBiMzM7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltdWx0aXBseVNjYWxhciggcyApIHsKCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoKCQl0ZVsgMCBdICo9IHM7IHRlWyAzIF0gKj0gczsgdGVbIDYgXSAqPSBzOwoJCXRlWyAxIF0gKj0gczsgdGVbIDQgXSAqPSBzOyB0ZVsgNyBdICo9IHM7CgkJdGVbIDIgXSAqPSBzOyB0ZVsgNSBdICo9IHM7IHRlWyA4IF0gKj0gczsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWRldGVybWluYW50KCkgewoKCQljb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CgoJCWNvbnN0IGEgPSB0ZVsgMCBdLCBiID0gdGVbIDEgXSwgYyA9IHRlWyAyIF0sCgkJCWQgPSB0ZVsgMyBdLCBlID0gdGVbIDQgXSwgZiA9IHRlWyA1IF0sCgkJCWcgPSB0ZVsgNiBdLCBoID0gdGVbIDcgXSwgaSA9IHRlWyA4IF07CgoJCXJldHVybiBhICogZSAqIGkgLSBhICogZiAqIGggLSBiICogZCAqIGkgKyBiICogZiAqIGcgKyBjICogZCAqIGggLSBjICogZSAqIGc7CgoJfQoKCWludmVydCgpIHsKCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzLAoKCQkJbjExID0gdGVbIDAgXSwgbjIxID0gdGVbIDEgXSwgbjMxID0gdGVbIDIgXSwKCQkJbjEyID0gdGVbIDMgXSwgbjIyID0gdGVbIDQgXSwgbjMyID0gdGVbIDUgXSwKCQkJbjEzID0gdGVbIDYgXSwgbjIzID0gdGVbIDcgXSwgbjMzID0gdGVbIDggXSwKCgkJCXQxMSA9IG4zMyAqIG4yMiAtIG4zMiAqIG4yMywKCQkJdDEyID0gbjMyICogbjEzIC0gbjMzICogbjEyLAoJCQl0MTMgPSBuMjMgKiBuMTIgLSBuMjIgKiBuMTMsCgoJCQlkZXQgPSBuMTEgKiB0MTEgKyBuMjEgKiB0MTIgKyBuMzEgKiB0MTM7CgoJCWlmICggZGV0ID09PSAwICkgcmV0dXJuIHRoaXMuc2V0KCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwICk7CgoJCWNvbnN0IGRldEludiA9IDEgLyBkZXQ7CgoJCXRlWyAwIF0gPSB0MTEgKiBkZXRJbnY7CgkJdGVbIDEgXSA9ICggbjMxICogbjIzIC0gbjMzICogbjIxICkgKiBkZXRJbnY7CgkJdGVbIDIgXSA9ICggbjMyICogbjIxIC0gbjMxICogbjIyICkgKiBkZXRJbnY7CgoJCXRlWyAzIF0gPSB0MTIgKiBkZXRJbnY7CgkJdGVbIDQgXSA9ICggbjMzICogbjExIC0gbjMxICogbjEzICkgKiBkZXRJbnY7CgkJdGVbIDUgXSA9ICggbjMxICogbjEyIC0gbjMyICogbjExICkgKiBkZXRJbnY7CgoJCXRlWyA2IF0gPSB0MTMgKiBkZXRJbnY7CgkJdGVbIDcgXSA9ICggbjIxICogbjEzIC0gbjIzICogbjExICkgKiBkZXRJbnY7CgkJdGVbIDggXSA9ICggbjIyICogbjExIC0gbjIxICogbjEyICkgKiBkZXRJbnY7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0cmFuc3Bvc2UoKSB7CgoJCWxldCB0bXA7CgkJY29uc3QgbSA9IHRoaXMuZWxlbWVudHM7CgoJCXRtcCA9IG1bIDEgXTsgbVsgMSBdID0gbVsgMyBdOyBtWyAzIF0gPSB0bXA7CgkJdG1wID0gbVsgMiBdOyBtWyAyIF0gPSBtWyA2IF07IG1bIDYgXSA9IHRtcDsKCQl0bXAgPSBtWyA1IF07IG1bIDUgXSA9IG1bIDcgXTsgbVsgNyBdID0gdG1wOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0Tm9ybWFsTWF0cml4KCBtYXRyaXg0ICkgewoKCQlyZXR1cm4gdGhpcy5zZXRGcm9tTWF0cml4NCggbWF0cml4NCApLmludmVydCgpLnRyYW5zcG9zZSgpOwoKCX0KCgl0cmFuc3Bvc2VJbnRvQXJyYXkoIHIgKSB7CgoJCWNvbnN0IG0gPSB0aGlzLmVsZW1lbnRzOwoKCQlyWyAwIF0gPSBtWyAwIF07CgkJclsgMSBdID0gbVsgMyBdOwoJCXJbIDIgXSA9IG1bIDYgXTsKCQlyWyAzIF0gPSBtWyAxIF07CgkJclsgNCBdID0gbVsgNCBdOwoJCXJbIDUgXSA9IG1bIDcgXTsKCQlyWyA2IF0gPSBtWyAyIF07CgkJclsgNyBdID0gbVsgNSBdOwoJCXJbIDggXSA9IG1bIDggXTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFV2VHJhbnNmb3JtKCB0eCwgdHksIHN4LCBzeSwgcm90YXRpb24sIGN4LCBjeSApIHsKCgkJY29uc3QgYyA9IE1hdGguY29zKCByb3RhdGlvbiApOwoJCWNvbnN0IHMgPSBNYXRoLnNpbiggcm90YXRpb24gKTsKCgkJdGhpcy5zZXQoCgkJCXN4ICogYywgc3ggKiBzLCAtIHN4ICogKCBjICogY3ggKyBzICogY3kgKSArIGN4ICsgdHgsCgkJCS0gc3kgKiBzLCBzeSAqIGMsIC0gc3kgKiAoIC0gcyAqIGN4ICsgYyAqIGN5ICkgKyBjeSArIHR5LAoJCQkwLCAwLCAxCgkJKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCS8vCgoJc2NhbGUoIHN4LCBzeSApIHsKCgkJdGhpcy5wcmVtdWx0aXBseSggX20zLm1ha2VTY2FsZSggc3gsIHN5ICkgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJvdGF0ZSggdGhldGEgKSB7CgoJCXRoaXMucHJlbXVsdGlwbHkoIF9tMy5tYWtlUm90YXRpb24oIC0gdGhldGEgKSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdHJhbnNsYXRlKCB0eCwgdHkgKSB7CgoJCXRoaXMucHJlbXVsdGlwbHkoIF9tMy5tYWtlVHJhbnNsYXRpb24oIHR4LCB0eSApICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgkvLyBmb3IgMkQgVHJhbnNmb3JtcwoKCW1ha2VUcmFuc2xhdGlvbiggeCwgeSApIHsKCgkJaWYgKCB4LmlzVmVjdG9yMiApIHsKCgkJCXRoaXMuc2V0KAoKCQkJCTEsIDAsIHgueCwKCQkJCTAsIDEsIHgueSwKCQkJCTAsIDAsIDEKCgkJCSk7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLnNldCgKCgkJCQkxLCAwLCB4LAoJCQkJMCwgMSwgeSwKCQkJCTAsIDAsIDEKCgkJCSk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW1ha2VSb3RhdGlvbiggdGhldGEgKSB7CgoJCS8vIGNvdW50ZXJjbG9ja3dpc2UKCgkJY29uc3QgYyA9IE1hdGguY29zKCB0aGV0YSApOwoJCWNvbnN0IHMgPSBNYXRoLnNpbiggdGhldGEgKTsKCgkJdGhpcy5zZXQoCgoJCQljLCAtIHMsIDAsCgkJCXMsIGMsIDAsCgkJCTAsIDAsIDEKCgkJKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW1ha2VTY2FsZSggeCwgeSApIHsKCgkJdGhpcy5zZXQoCgoJCQl4LCAwLCAwLAoJCQkwLCB5LCAwLAoJCQkwLCAwLCAxCgoJCSk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgkvLwoKCWVxdWFscyggbWF0cml4ICkgewoKCQljb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CgkJY29uc3QgbWUgPSBtYXRyaXguZWxlbWVudHM7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IDk7IGkgKysgKSB7CgoJCQlpZiAoIHRlWyBpIF0gIT09IG1lWyBpIF0gKSByZXR1cm4gZmFsc2U7CgoJCX0KCgkJcmV0dXJuIHRydWU7CgoJfQoKCWZyb21BcnJheSggYXJyYXksIG9mZnNldCA9IDAgKSB7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IDk7IGkgKysgKSB7CgoJCQl0aGlzLmVsZW1lbnRzWyBpIF0gPSBhcnJheVsgaSArIG9mZnNldCBdOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0FycmF5KCBhcnJheSA9IFtdLCBvZmZzZXQgPSAwICkgewoKCQljb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CgoJCWFycmF5WyBvZmZzZXQgXSA9IHRlWyAwIF07CgkJYXJyYXlbIG9mZnNldCArIDEgXSA9IHRlWyAxIF07CgkJYXJyYXlbIG9mZnNldCArIDIgXSA9IHRlWyAyIF07CgoJCWFycmF5WyBvZmZzZXQgKyAzIF0gPSB0ZVsgMyBdOwoJCWFycmF5WyBvZmZzZXQgKyA0IF0gPSB0ZVsgNCBdOwoJCWFycmF5WyBvZmZzZXQgKyA1IF0gPSB0ZVsgNSBdOwoKCQlhcnJheVsgb2Zmc2V0ICsgNiBdID0gdGVbIDYgXTsKCQlhcnJheVsgb2Zmc2V0ICsgNyBdID0gdGVbIDcgXTsKCQlhcnJheVsgb2Zmc2V0ICsgOCBdID0gdGVbIDggXTsKCgkJcmV0dXJuIGFycmF5OwoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuZnJvbUFycmF5KCB0aGlzLmVsZW1lbnRzICk7CgoJfQoKfQoKY29uc3QgX20zID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpOwoKZnVuY3Rpb24gYXJyYXlOZWVkc1VpbnQzMiggYXJyYXkgKSB7CgoJLy8gYXNzdW1lcyBsYXJnZXIgdmFsdWVzIHVzdWFsbHkgb24gbGFzdAoKCWZvciAoIGxldCBpID0gYXJyYXkubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLSBpICkgewoKCQlpZiAoIGFycmF5WyBpIF0gPj0gNjU1MzUgKSByZXR1cm4gdHJ1ZTsgLy8gYWNjb3VudCBmb3IgUFJJTUlUSVZFX1JFU1RBUlRfRklYRURfSU5ERVgsICMyNDU2NQoKCX0KCglyZXR1cm4gZmFsc2U7Cgp9Cgpjb25zdCBUWVBFRF9BUlJBWVMgPSB7CglJbnQ4QXJyYXk6IEludDhBcnJheSwKCVVpbnQ4QXJyYXk6IFVpbnQ4QXJyYXksCglVaW50OENsYW1wZWRBcnJheTogVWludDhDbGFtcGVkQXJyYXksCglJbnQxNkFycmF5OiBJbnQxNkFycmF5LAoJVWludDE2QXJyYXk6IFVpbnQxNkFycmF5LAoJSW50MzJBcnJheTogSW50MzJBcnJheSwKCVVpbnQzMkFycmF5OiBVaW50MzJBcnJheSwKCUZsb2F0MzJBcnJheTogRmxvYXQzMkFycmF5LAoJRmxvYXQ2NEFycmF5OiBGbG9hdDY0QXJyYXkKfTsKCmZ1bmN0aW9uIGdldFR5cGVkQXJyYXkoIHR5cGUsIGJ1ZmZlciApIHsKCglyZXR1cm4gbmV3IFRZUEVEX0FSUkFZU1sgdHlwZSBdKCBidWZmZXIgKTsKCn0KCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnROUyggbmFtZSApIHsKCglyZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKCAnaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcsIG5hbWUgKTsKCn0KCmZ1bmN0aW9uIGNyZWF0ZUNhbnZhc0VsZW1lbnQoKSB7CgoJY29uc3QgY2FudmFzID0gY3JlYXRlRWxlbWVudE5TKCAnY2FudmFzJyApOwoJY2FudmFzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwoJcmV0dXJuIGNhbnZhczsKCn0KCmNvbnN0IF9jYWNoZSA9IHt9OwoKZnVuY3Rpb24gd2Fybk9uY2UoIG1lc3NhZ2UgKSB7CgoJaWYgKCBtZXNzYWdlIGluIF9jYWNoZSApIHJldHVybjsKCglfY2FjaGVbIG1lc3NhZ2UgXSA9IHRydWU7CgoJY29uc29sZS53YXJuKCBtZXNzYWdlICk7Cgp9CgovKioKICogTWF0cmljZXMgY29udmVydGluZyBQMyA8LT4gUmVjLiA3MDkgcHJpbWFyaWVzLCB3aXRob3V0IGdhbXV0IG1hcHBpbmcKICogb3IgY2xpcHBpbmcuIEJhc2VkIG9uIFczQyBzcGVjaWZpY2F0aW9ucyBmb3Igc1JHQiBhbmQgRGlzcGxheSBQMywKICogYW5kIElDQyBzcGVjaWZpY2F0aW9ucyBmb3IgdGhlIEQ1MCBjb25uZWN0aW9uIHNwYWNlLiBWYWx1ZXMgaW4vb3V0CiAqIGFyZSBfbGluZWFyXyBzUkdCIGFuZCBfbGluZWFyXyBEaXNwbGF5IFAzLgogKgogKiBOb3RlIHRoYXQgYm90aCBzUkdCIGFuZCBEaXNwbGF5IFAzIHVzZSB0aGUgc1JHQiB0cmFuc2ZlciBmdW5jdGlvbnMuCiAqCiAqIFJlZmVyZW5jZToKICogLSBodHRwOi8vd3d3LnJ1c3NlbGxjb3R0cmVsbC5jb20vcGhvdG8vbWF0cml4Q2FsY3VsYXRvci5odG0KICovCgpjb25zdCBMSU5FQVJfU1JHQl9UT19MSU5FQVJfRElTUExBWV9QMyA9IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDMoKS5zZXQoCgkwLjgyMjQ2MjEsIDAuMTc3NTM4LCAwLjAsCgkwLjAzMzE5NDEsIDAuOTY2ODA1OCwgMC4wLAoJMC4wMTcwODI3LCAwLjA3MjM5NzQsIDAuOTEwNTE5OSwKKTsKCmNvbnN0IExJTkVBUl9ESVNQTEFZX1AzX1RPX0xJTkVBUl9TUkdCID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpLnNldCgKCTEuMjI0OTQwMSwgLSAwLjIyNDk0MDQsIDAuMCwKCS0gMC4wNDIwNTY5LCAxLjA0MjA1NzEsIDAuMCwKCS0gMC4wMTk2Mzc2LCAtIDAuMDc4NjM2MSwgMS4wOTgyNzM1Cik7CgovKioKICogRGVmaW5lcyBzdXBwb3J0ZWQgY29sb3Igc3BhY2VzIGJ5IHRyYW5zZmVyIGZ1bmN0aW9uIGFuZCBwcmltYXJpZXMsCiAqIGFuZCBwcm92aWRlcyBjb252ZXJzaW9ucyB0by9mcm9tIHRoZSBMaW5lYXItc1JHQiByZWZlcmVuY2Ugc3BhY2UuCiAqLwpjb25zdCBDT0xPUl9TUEFDRVMgPSB7CglbIExpbmVhclNSR0JDb2xvclNwYWNlIF06IHsKCQl0cmFuc2ZlcjogTGluZWFyVHJhbnNmZXIsCgkJcHJpbWFyaWVzOiBSZWM3MDlQcmltYXJpZXMsCgkJdG9SZWZlcmVuY2U6ICggY29sb3IgKSA9PiBjb2xvciwKCQlmcm9tUmVmZXJlbmNlOiAoIGNvbG9yICkgPT4gY29sb3IsCgl9LAoJWyBTUkdCQ29sb3JTcGFjZSBdOiB7CgkJdHJhbnNmZXI6IFNSR0JUcmFuc2ZlciwKCQlwcmltYXJpZXM6IFJlYzcwOVByaW1hcmllcywKCQl0b1JlZmVyZW5jZTogKCBjb2xvciApID0+IGNvbG9yLmNvbnZlcnRTUkdCVG9MaW5lYXIoKSwKCQlmcm9tUmVmZXJlbmNlOiAoIGNvbG9yICkgPT4gY29sb3IuY29udmVydExpbmVhclRvU1JHQigpLAoJfSwKCVsgTGluZWFyRGlzcGxheVAzQ29sb3JTcGFjZSBdOiB7CgkJdHJhbnNmZXI6IExpbmVhclRyYW5zZmVyLAoJCXByaW1hcmllczogUDNQcmltYXJpZXMsCgkJdG9SZWZlcmVuY2U6ICggY29sb3IgKSA9PiBjb2xvci5hcHBseU1hdHJpeDMoIExJTkVBUl9ESVNQTEFZX1AzX1RPX0xJTkVBUl9TUkdCICksCgkJZnJvbVJlZmVyZW5jZTogKCBjb2xvciApID0+IGNvbG9yLmFwcGx5TWF0cml4MyggTElORUFSX1NSR0JfVE9fTElORUFSX0RJU1BMQVlfUDMgKSwKCX0sCglbIERpc3BsYXlQM0NvbG9yU3BhY2UgXTogewoJCXRyYW5zZmVyOiBTUkdCVHJhbnNmZXIsCgkJcHJpbWFyaWVzOiBQM1ByaW1hcmllcywKCQl0b1JlZmVyZW5jZTogKCBjb2xvciApID0+IGNvbG9yLmNvbnZlcnRTUkdCVG9MaW5lYXIoKS5hcHBseU1hdHJpeDMoIExJTkVBUl9ESVNQTEFZX1AzX1RPX0xJTkVBUl9TUkdCICksCgkJZnJvbVJlZmVyZW5jZTogKCBjb2xvciApID0+IGNvbG9yLmFwcGx5TWF0cml4MyggTElORUFSX1NSR0JfVE9fTElORUFSX0RJU1BMQVlfUDMgKS5jb252ZXJ0TGluZWFyVG9TUkdCKCksCgl9LAp9OwoKY29uc3QgU1VQUE9SVEVEX1dPUktJTkdfQ09MT1JfU1BBQ0VTID0gbmV3IFNldCggWyBMaW5lYXJTUkdCQ29sb3JTcGFjZSwgTGluZWFyRGlzcGxheVAzQ29sb3JTcGFjZSBdICk7Cgpjb25zdCBDb2xvck1hbmFnZW1lbnQgPSB7CgoJZW5hYmxlZDogdHJ1ZSwKCglfd29ya2luZ0NvbG9yU3BhY2U6IExpbmVhclNSR0JDb2xvclNwYWNlLAoKCWdldCB3b3JraW5nQ29sb3JTcGFjZSgpIHsKCgkJcmV0dXJuIHRoaXMuX3dvcmtpbmdDb2xvclNwYWNlOwoKCX0sCgoJc2V0IHdvcmtpbmdDb2xvclNwYWNlKCBjb2xvclNwYWNlICkgewoKCQlpZiAoICEgU1VQUE9SVEVEX1dPUktJTkdfQ09MT1JfU1BBQ0VTLmhhcyggY29sb3JTcGFjZSApICkgewoKCQkJdGhyb3cgbmV3IEVycm9yKCBgVW5zdXBwb3J0ZWQgd29ya2luZyBjb2xvciBzcGFjZSwgIiR7IGNvbG9yU3BhY2UgfSIuYCApOwoKCQl9CgoJCXRoaXMuX3dvcmtpbmdDb2xvclNwYWNlID0gY29sb3JTcGFjZTsKCgl9LAoKCWNvbnZlcnQ6IGZ1bmN0aW9uICggY29sb3IsIHNvdXJjZUNvbG9yU3BhY2UsIHRhcmdldENvbG9yU3BhY2UgKSB7CgoJCWlmICggdGhpcy5lbmFibGVkID09PSBmYWxzZSB8fCBzb3VyY2VDb2xvclNwYWNlID09PSB0YXJnZXRDb2xvclNwYWNlIHx8ICEgc291cmNlQ29sb3JTcGFjZSB8fCAhIHRhcmdldENvbG9yU3BhY2UgKSB7CgoJCQlyZXR1cm4gY29sb3I7CgoJCX0KCgkJY29uc3Qgc291cmNlVG9SZWZlcmVuY2UgPSBDT0xPUl9TUEFDRVNbIHNvdXJjZUNvbG9yU3BhY2UgXS50b1JlZmVyZW5jZTsKCQljb25zdCB0YXJnZXRGcm9tUmVmZXJlbmNlID0gQ09MT1JfU1BBQ0VTWyB0YXJnZXRDb2xvclNwYWNlIF0uZnJvbVJlZmVyZW5jZTsKCgkJcmV0dXJuIHRhcmdldEZyb21SZWZlcmVuY2UoIHNvdXJjZVRvUmVmZXJlbmNlKCBjb2xvciApICk7CgoJfSwKCglmcm9tV29ya2luZ0NvbG9yU3BhY2U6IGZ1bmN0aW9uICggY29sb3IsIHRhcmdldENvbG9yU3BhY2UgKSB7CgoJCXJldHVybiB0aGlzLmNvbnZlcnQoIGNvbG9yLCB0aGlzLl93b3JraW5nQ29sb3JTcGFjZSwgdGFyZ2V0Q29sb3JTcGFjZSApOwoKCX0sCgoJdG9Xb3JraW5nQ29sb3JTcGFjZTogZnVuY3Rpb24gKCBjb2xvciwgc291cmNlQ29sb3JTcGFjZSApIHsKCgkJcmV0dXJuIHRoaXMuY29udmVydCggY29sb3IsIHNvdXJjZUNvbG9yU3BhY2UsIHRoaXMuX3dvcmtpbmdDb2xvclNwYWNlICk7CgoJfSwKCglnZXRQcmltYXJpZXM6IGZ1bmN0aW9uICggY29sb3JTcGFjZSApIHsKCgkJcmV0dXJuIENPTE9SX1NQQUNFU1sgY29sb3JTcGFjZSBdLnByaW1hcmllczsKCgl9LAoKCWdldFRyYW5zZmVyOiBmdW5jdGlvbiAoIGNvbG9yU3BhY2UgKSB7CgoJCWlmICggY29sb3JTcGFjZSA9PT0gTm9Db2xvclNwYWNlICkgcmV0dXJuIExpbmVhclRyYW5zZmVyOwoKCQlyZXR1cm4gQ09MT1JfU1BBQ0VTWyBjb2xvclNwYWNlIF0udHJhbnNmZXI7CgoJfSwKCn07CgoKZnVuY3Rpb24gU1JHQlRvTGluZWFyKCBjICkgewoKCXJldHVybiAoIGMgPCAwLjA0MDQ1ICkgPyBjICogMC4wNzczOTkzODA4IDogTWF0aC5wb3coIGMgKiAwLjk0Nzg2NzI5ODYgKyAwLjA1MjEzMjcwMTQsIDIuNCApOwoKfQoKZnVuY3Rpb24gTGluZWFyVG9TUkdCKCBjICkgewoKCXJldHVybiAoIGMgPCAwLjAwMzEzMDggKSA/IGMgKiAxMi45MiA6IDEuMDU1ICogKCBNYXRoLnBvdyggYywgMC40MTY2NiApICkgLSAwLjA1NTsKCn0KCmxldCBfY2FudmFzOwoKY2xhc3MgSW1hZ2VVdGlscyB7CgoJc3RhdGljIGdldERhdGFVUkwoIGltYWdlICkgewoKCQlpZiAoIC9eZGF0YTovaS50ZXN0KCBpbWFnZS5zcmMgKSApIHsKCgkJCXJldHVybiBpbWFnZS5zcmM7CgoJCX0KCgkJaWYgKCB0eXBlb2YgSFRNTENhbnZhc0VsZW1lbnQgPT09ICd1bmRlZmluZWQnICkgewoKCQkJcmV0dXJuIGltYWdlLnNyYzsKCgkJfQoKCQlsZXQgY2FudmFzOwoKCQlpZiAoIGltYWdlIGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQgKSB7CgoJCQljYW52YXMgPSBpbWFnZTsKCgkJfSBlbHNlIHsKCgkJCWlmICggX2NhbnZhcyA9PT0gdW5kZWZpbmVkICkgX2NhbnZhcyA9IGNyZWF0ZUVsZW1lbnROUyggJ2NhbnZhcycgKTsKCgkJCV9jYW52YXMud2lkdGggPSBpbWFnZS53aWR0aDsKCQkJX2NhbnZhcy5oZWlnaHQgPSBpbWFnZS5oZWlnaHQ7CgoJCQljb25zdCBjb250ZXh0ID0gX2NhbnZhcy5nZXRDb250ZXh0KCAnMmQnICk7CgoJCQlpZiAoIGltYWdlIGluc3RhbmNlb2YgSW1hZ2VEYXRhICkgewoKCQkJCWNvbnRleHQucHV0SW1hZ2VEYXRhKCBpbWFnZSwgMCwgMCApOwoKCQkJfSBlbHNlIHsKCgkJCQljb250ZXh0LmRyYXdJbWFnZSggaW1hZ2UsIDAsIDAsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQgKTsKCgkJCX0KCgkJCWNhbnZhcyA9IF9jYW52YXM7CgoJCX0KCgkJaWYgKCBjYW52YXMud2lkdGggPiAyMDQ4IHx8IGNhbnZhcy5oZWlnaHQgPiAyMDQ4ICkgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuSW1hZ2VVdGlscy5nZXREYXRhVVJMOiBJbWFnZSBjb252ZXJ0ZWQgdG8ganBnIGZvciBwZXJmb3JtYW5jZSByZWFzb25zJywgaW1hZ2UgKTsKCgkJCXJldHVybiBjYW52YXMudG9EYXRhVVJMKCAnaW1hZ2UvanBlZycsIDAuNiApOwoKCQl9IGVsc2UgewoKCQkJcmV0dXJuIGNhbnZhcy50b0RhdGFVUkwoICdpbWFnZS9wbmcnICk7CgoJCX0KCgl9CgoJc3RhdGljIHNSR0JUb0xpbmVhciggaW1hZ2UgKSB7CgoJCWlmICggKCB0eXBlb2YgSFRNTEltYWdlRWxlbWVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgaW1hZ2UgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50ICkgfHwKCQkJKCB0eXBlb2YgSFRNTENhbnZhc0VsZW1lbnQgIT09ICd1bmRlZmluZWQnICYmIGltYWdlIGluc3RhbmNlb2YgSFRNTENhbnZhc0VsZW1lbnQgKSB8fAoJCQkoIHR5cGVvZiBJbWFnZUJpdG1hcCAhPT0gJ3VuZGVmaW5lZCcgJiYgaW1hZ2UgaW5zdGFuY2VvZiBJbWFnZUJpdG1hcCApICkgewoKCQkJY29uc3QgY2FudmFzID0gY3JlYXRlRWxlbWVudE5TKCAnY2FudmFzJyApOwoKCQkJY2FudmFzLndpZHRoID0gaW1hZ2Uud2lkdGg7CgkJCWNhbnZhcy5oZWlnaHQgPSBpbWFnZS5oZWlnaHQ7CgoJCQljb25zdCBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoICcyZCcgKTsKCQkJY29udGV4dC5kcmF3SW1hZ2UoIGltYWdlLCAwLCAwLCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0ICk7CgoJCQljb25zdCBpbWFnZURhdGEgPSBjb250ZXh0LmdldEltYWdlRGF0YSggMCwgMCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCApOwoJCQljb25zdCBkYXRhID0gaW1hZ2VEYXRhLmRhdGE7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArKyApIHsKCgkJCQlkYXRhWyBpIF0gPSBTUkdCVG9MaW5lYXIoIGRhdGFbIGkgXSAvIDI1NSApICogMjU1OwoKCQkJfQoKCQkJY29udGV4dC5wdXRJbWFnZURhdGEoIGltYWdlRGF0YSwgMCwgMCApOwoKCQkJcmV0dXJuIGNhbnZhczsKCgkJfSBlbHNlIGlmICggaW1hZ2UuZGF0YSApIHsKCgkJCWNvbnN0IGRhdGEgPSBpbWFnZS5kYXRhLnNsaWNlKCAwICk7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArKyApIHsKCgkJCQlpZiAoIGRhdGEgaW5zdGFuY2VvZiBVaW50OEFycmF5IHx8IGRhdGEgaW5zdGFuY2VvZiBVaW50OENsYW1wZWRBcnJheSApIHsKCgkJCQkJZGF0YVsgaSBdID0gTWF0aC5mbG9vciggU1JHQlRvTGluZWFyKCBkYXRhWyBpIF0gLyAyNTUgKSAqIDI1NSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vIGFzc3VtaW5nIGZsb2F0CgoJCQkJCWRhdGFbIGkgXSA9IFNSR0JUb0xpbmVhciggZGF0YVsgaSBdICk7CgoJCQkJfQoKCQkJfQoKCQkJcmV0dXJuIHsKCQkJCWRhdGE6IGRhdGEsCgkJCQl3aWR0aDogaW1hZ2Uud2lkdGgsCgkJCQloZWlnaHQ6IGltYWdlLmhlaWdodAoJCQl9OwoKCQl9IGVsc2UgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuSW1hZ2VVdGlscy5zUkdCVG9MaW5lYXIoKTogVW5zdXBwb3J0ZWQgaW1hZ2UgdHlwZS4gTm8gY29sb3Igc3BhY2UgY29udmVyc2lvbiBhcHBsaWVkLicgKTsKCQkJcmV0dXJuIGltYWdlOwoKCQl9CgoJfQoKfQoKbGV0IF9zb3VyY2VJZCA9IDA7CgpjbGFzcyBTb3VyY2UgewoKCWNvbnN0cnVjdG9yKCBkYXRhID0gbnVsbCApIHsKCgkJdGhpcy5pc1NvdXJjZSA9IHRydWU7CgoJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcywgJ2lkJywgeyB2YWx1ZTogX3NvdXJjZUlkICsrIH0gKTsKCgkJdGhpcy51dWlkID0gZ2VuZXJhdGVVVUlEKCk7CgoJCXRoaXMuZGF0YSA9IGRhdGE7CgkJdGhpcy5kYXRhUmVhZHkgPSB0cnVlOwoKCQl0aGlzLnZlcnNpb24gPSAwOwoKCX0KCglzZXQgbmVlZHNVcGRhdGUoIHZhbHVlICkgewoKCQlpZiAoIHZhbHVlID09PSB0cnVlICkgdGhpcy52ZXJzaW9uICsrOwoKCX0KCgl0b0pTT04oIG1ldGEgKSB7CgoJCWNvbnN0IGlzUm9vdE9iamVjdCA9ICggbWV0YSA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBtZXRhID09PSAnc3RyaW5nJyApOwoKCQlpZiAoICEgaXNSb290T2JqZWN0ICYmIG1ldGEuaW1hZ2VzWyB0aGlzLnV1aWQgXSAhPT0gdW5kZWZpbmVkICkgewoKCQkJcmV0dXJuIG1ldGEuaW1hZ2VzWyB0aGlzLnV1aWQgXTsKCgkJfQoKCQljb25zdCBvdXRwdXQgPSB7CgkJCXV1aWQ6IHRoaXMudXVpZCwKCQkJdXJsOiAnJwoJCX07CgoJCWNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CgoJCWlmICggZGF0YSAhPT0gbnVsbCApIHsKCgkJCWxldCB1cmw7CgoJCQlpZiAoIEFycmF5LmlzQXJyYXkoIGRhdGEgKSApIHsKCgkJCQkvLyBjdWJlIHRleHR1cmUKCgkJCQl1cmwgPSBbXTsKCgkJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBkYXRhLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJCWlmICggZGF0YVsgaSBdLmlzRGF0YVRleHR1cmUgKSB7CgoJCQkJCQl1cmwucHVzaCggc2VyaWFsaXplSW1hZ2UoIGRhdGFbIGkgXS5pbWFnZSApICk7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQl1cmwucHVzaCggc2VyaWFsaXplSW1hZ2UoIGRhdGFbIGkgXSApICk7CgoJCQkJCX0KCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCS8vIHRleHR1cmUKCgkJCQl1cmwgPSBzZXJpYWxpemVJbWFnZSggZGF0YSApOwoKCQkJfQoKCQkJb3V0cHV0LnVybCA9IHVybDsKCgkJfQoKCQlpZiAoICEgaXNSb290T2JqZWN0ICkgewoKCQkJbWV0YS5pbWFnZXNbIHRoaXMudXVpZCBdID0gb3V0cHV0OwoKCQl9CgoJCXJldHVybiBvdXRwdXQ7CgoJfQoKfQoKZnVuY3Rpb24gc2VyaWFsaXplSW1hZ2UoIGltYWdlICkgewoKCWlmICggKCB0eXBlb2YgSFRNTEltYWdlRWxlbWVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgaW1hZ2UgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50ICkgfHwKCQkoIHR5cGVvZiBIVE1MQ2FudmFzRWxlbWVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgaW1hZ2UgaW5zdGFuY2VvZiBIVE1MQ2FudmFzRWxlbWVudCApIHx8CgkJKCB0eXBlb2YgSW1hZ2VCaXRtYXAgIT09ICd1bmRlZmluZWQnICYmIGltYWdlIGluc3RhbmNlb2YgSW1hZ2VCaXRtYXAgKSApIHsKCgkJLy8gZGVmYXVsdCBpbWFnZXMKCgkJcmV0dXJuIEltYWdlVXRpbHMuZ2V0RGF0YVVSTCggaW1hZ2UgKTsKCgl9IGVsc2UgewoKCQlpZiAoIGltYWdlLmRhdGEgKSB7CgoJCQkvLyBpbWFnZXMgb2YgRGF0YVRleHR1cmUKCgkJCXJldHVybiB7CgkJCQlkYXRhOiBBcnJheS5mcm9tKCBpbWFnZS5kYXRhICksCgkJCQl3aWR0aDogaW1hZ2Uud2lkdGgsCgkJCQloZWlnaHQ6IGltYWdlLmhlaWdodCwKCQkJCXR5cGU6IGltYWdlLmRhdGEuY29uc3RydWN0b3IubmFtZQoJCQl9OwoKCQl9IGVsc2UgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuVGV4dHVyZTogVW5hYmxlIHRvIHNlcmlhbGl6ZSBUZXh0dXJlLicgKTsKCQkJcmV0dXJuIHt9OwoKCQl9CgoJfQoKfQoKbGV0IF90ZXh0dXJlSWQgPSAwOwoKY2xhc3MgVGV4dHVyZSBleHRlbmRzIEV2ZW50RGlzcGF0Y2hlciB7CgoJY29uc3RydWN0b3IoIGltYWdlID0gVGV4dHVyZS5ERUZBVUxUX0lNQUdFLCBtYXBwaW5nID0gVGV4dHVyZS5ERUZBVUxUX01BUFBJTkcsIHdyYXBTID0gQ2xhbXBUb0VkZ2VXcmFwcGluZywgd3JhcFQgPSBDbGFtcFRvRWRnZVdyYXBwaW5nLCBtYWdGaWx0ZXIgPSBMaW5lYXJGaWx0ZXIsIG1pbkZpbHRlciA9IExpbmVhck1pcG1hcExpbmVhckZpbHRlciwgZm9ybWF0ID0gUkdCQUZvcm1hdCwgdHlwZSA9IFVuc2lnbmVkQnl0ZVR5cGUsIGFuaXNvdHJvcHkgPSBUZXh0dXJlLkRFRkFVTFRfQU5JU09UUk9QWSwgY29sb3JTcGFjZSA9IE5vQ29sb3JTcGFjZSApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc1RleHR1cmUgPSB0cnVlOwoKCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRoaXMsICdpZCcsIHsgdmFsdWU6IF90ZXh0dXJlSWQgKysgfSApOwoKCQl0aGlzLnV1aWQgPSBnZW5lcmF0ZVVVSUQoKTsKCgkJdGhpcy5uYW1lID0gJyc7CgoJCXRoaXMuc291cmNlID0gbmV3IFNvdXJjZSggaW1hZ2UgKTsKCQl0aGlzLm1pcG1hcHMgPSBbXTsKCgkJdGhpcy5tYXBwaW5nID0gbWFwcGluZzsKCQl0aGlzLmNoYW5uZWwgPSAwOwoKCQl0aGlzLndyYXBTID0gd3JhcFM7CgkJdGhpcy53cmFwVCA9IHdyYXBUOwoKCQl0aGlzLm1hZ0ZpbHRlciA9IG1hZ0ZpbHRlcjsKCQl0aGlzLm1pbkZpbHRlciA9IG1pbkZpbHRlcjsKCgkJdGhpcy5hbmlzb3Ryb3B5ID0gYW5pc290cm9weTsKCgkJdGhpcy5mb3JtYXQgPSBmb3JtYXQ7CgkJdGhpcy5pbnRlcm5hbEZvcm1hdCA9IG51bGw7CgkJdGhpcy50eXBlID0gdHlwZTsKCgkJdGhpcy5vZmZzZXQgPSBuZXcgVmVjdG9yMiggMCwgMCApOwoJCXRoaXMucmVwZWF0ID0gbmV3IFZlY3RvcjIoIDEsIDEgKTsKCQl0aGlzLmNlbnRlciA9IG5ldyBWZWN0b3IyKCAwLCAwICk7CgkJdGhpcy5yb3RhdGlvbiA9IDA7CgoJCXRoaXMubWF0cml4QXV0b1VwZGF0ZSA9IHRydWU7CgkJdGhpcy5tYXRyaXggPSBuZXcgTWF0cml4MygpOwoKCQl0aGlzLmdlbmVyYXRlTWlwbWFwcyA9IHRydWU7CgkJdGhpcy5wcmVtdWx0aXBseUFscGhhID0gZmFsc2U7CgkJdGhpcy5mbGlwWSA9IHRydWU7CgkJdGhpcy51bnBhY2tBbGlnbm1lbnQgPSA0OwkvLyB2YWxpZCB2YWx1ZXM6IDEsIDIsIDQsIDggKHNlZSBodHRwOi8vd3d3Lmtocm9ub3Mub3JnL29wZW5nbGVzL3Nkay9kb2NzL21hbi94aHRtbC9nbFBpeGVsU3RvcmVpLnhtbCkKCgkJaWYgKCB0eXBlb2YgY29sb3JTcGFjZSA9PT0gJ3N0cmluZycgKSB7CgoJCQl0aGlzLmNvbG9yU3BhY2UgPSBjb2xvclNwYWNlOwoKCQl9IGVsc2UgeyAvLyBAZGVwcmVjYXRlZCwgcjE1MgoKCQkJd2Fybk9uY2UoICdUSFJFRS5UZXh0dXJlOiBQcm9wZXJ0eSAuZW5jb2RpbmcgaGFzIGJlZW4gcmVwbGFjZWQgYnkgLmNvbG9yU3BhY2UuJyApOwoJCQl0aGlzLmNvbG9yU3BhY2UgPSBjb2xvclNwYWNlID09PSBzUkdCRW5jb2RpbmcgPyBTUkdCQ29sb3JTcGFjZSA6IE5vQ29sb3JTcGFjZTsKCgkJfQoKCgkJdGhpcy51c2VyRGF0YSA9IHt9OwoKCQl0aGlzLnZlcnNpb24gPSAwOwoJCXRoaXMub25VcGRhdGUgPSBudWxsOwoKCQl0aGlzLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9IGZhbHNlOyAvLyBpbmRpY2F0ZXMgd2hldGhlciBhIHRleHR1cmUgYmVsb25ncyB0byBhIHJlbmRlciB0YXJnZXQgb3Igbm90CgkJdGhpcy5uZWVkc1BNUkVNVXBkYXRlID0gZmFsc2U7IC8vIGluZGljYXRlcyB3aGV0aGVyIHRoaXMgdGV4dHVyZSBzaG91bGQgYmUgcHJvY2Vzc2VkIGJ5IFBNUkVNR2VuZXJhdG9yIG9yIG5vdCAob25seSByZWxldmFudCBmb3IgcmVuZGVyIHRhcmdldCB0ZXh0dXJlcykKCgl9CgoJZ2V0IGltYWdlKCkgewoKCQlyZXR1cm4gdGhpcy5zb3VyY2UuZGF0YTsKCgl9CgoJc2V0IGltYWdlKCB2YWx1ZSA9IG51bGwgKSB7CgoJCXRoaXMuc291cmNlLmRhdGEgPSB2YWx1ZTsKCgl9CgoJdXBkYXRlTWF0cml4KCkgewoKCQl0aGlzLm1hdHJpeC5zZXRVdlRyYW5zZm9ybSggdGhpcy5vZmZzZXQueCwgdGhpcy5vZmZzZXQueSwgdGhpcy5yZXBlYXQueCwgdGhpcy5yZXBlYXQueSwgdGhpcy5yb3RhdGlvbiwgdGhpcy5jZW50ZXIueCwgdGhpcy5jZW50ZXIueSApOwoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSggdGhpcyApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXRoaXMubmFtZSA9IHNvdXJjZS5uYW1lOwoKCQl0aGlzLnNvdXJjZSA9IHNvdXJjZS5zb3VyY2U7CgkJdGhpcy5taXBtYXBzID0gc291cmNlLm1pcG1hcHMuc2xpY2UoIDAgKTsKCgkJdGhpcy5tYXBwaW5nID0gc291cmNlLm1hcHBpbmc7CgkJdGhpcy5jaGFubmVsID0gc291cmNlLmNoYW5uZWw7CgoJCXRoaXMud3JhcFMgPSBzb3VyY2Uud3JhcFM7CgkJdGhpcy53cmFwVCA9IHNvdXJjZS53cmFwVDsKCgkJdGhpcy5tYWdGaWx0ZXIgPSBzb3VyY2UubWFnRmlsdGVyOwoJCXRoaXMubWluRmlsdGVyID0gc291cmNlLm1pbkZpbHRlcjsKCgkJdGhpcy5hbmlzb3Ryb3B5ID0gc291cmNlLmFuaXNvdHJvcHk7CgoJCXRoaXMuZm9ybWF0ID0gc291cmNlLmZvcm1hdDsKCQl0aGlzLmludGVybmFsRm9ybWF0ID0gc291cmNlLmludGVybmFsRm9ybWF0OwoJCXRoaXMudHlwZSA9IHNvdXJjZS50eXBlOwoKCQl0aGlzLm9mZnNldC5jb3B5KCBzb3VyY2Uub2Zmc2V0ICk7CgkJdGhpcy5yZXBlYXQuY29weSggc291cmNlLnJlcGVhdCApOwoJCXRoaXMuY2VudGVyLmNvcHkoIHNvdXJjZS5jZW50ZXIgKTsKCQl0aGlzLnJvdGF0aW9uID0gc291cmNlLnJvdGF0aW9uOwoKCQl0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSBzb3VyY2UubWF0cml4QXV0b1VwZGF0ZTsKCQl0aGlzLm1hdHJpeC5jb3B5KCBzb3VyY2UubWF0cml4ICk7CgoJCXRoaXMuZ2VuZXJhdGVNaXBtYXBzID0gc291cmNlLmdlbmVyYXRlTWlwbWFwczsKCQl0aGlzLnByZW11bHRpcGx5QWxwaGEgPSBzb3VyY2UucHJlbXVsdGlwbHlBbHBoYTsKCQl0aGlzLmZsaXBZID0gc291cmNlLmZsaXBZOwoJCXRoaXMudW5wYWNrQWxpZ25tZW50ID0gc291cmNlLnVucGFja0FsaWdubWVudDsKCQl0aGlzLmNvbG9yU3BhY2UgPSBzb3VyY2UuY29sb3JTcGFjZTsKCgkJdGhpcy51c2VyRGF0YSA9IEpTT04ucGFyc2UoIEpTT04uc3RyaW5naWZ5KCBzb3VyY2UudXNlckRhdGEgKSApOwoKCQl0aGlzLm5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTiggbWV0YSApIHsKCgkJY29uc3QgaXNSb290T2JqZWN0ID0gKCBtZXRhID09PSB1bmRlZmluZWQgfHwgdHlwZW9mIG1ldGEgPT09ICdzdHJpbmcnICk7CgoJCWlmICggISBpc1Jvb3RPYmplY3QgJiYgbWV0YS50ZXh0dXJlc1sgdGhpcy51dWlkIF0gIT09IHVuZGVmaW5lZCApIHsKCgkJCXJldHVybiBtZXRhLnRleHR1cmVzWyB0aGlzLnV1aWQgXTsKCgkJfQoKCQljb25zdCBvdXRwdXQgPSB7CgoJCQltZXRhZGF0YTogewoJCQkJdmVyc2lvbjogNC42LAoJCQkJdHlwZTogJ1RleHR1cmUnLAoJCQkJZ2VuZXJhdG9yOiAnVGV4dHVyZS50b0pTT04nCgkJCX0sCgoJCQl1dWlkOiB0aGlzLnV1aWQsCgkJCW5hbWU6IHRoaXMubmFtZSwKCgkJCWltYWdlOiB0aGlzLnNvdXJjZS50b0pTT04oIG1ldGEgKS51dWlkLAoKCQkJbWFwcGluZzogdGhpcy5tYXBwaW5nLAoJCQljaGFubmVsOiB0aGlzLmNoYW5uZWwsCgoJCQlyZXBlYXQ6IFsgdGhpcy5yZXBlYXQueCwgdGhpcy5yZXBlYXQueSBdLAoJCQlvZmZzZXQ6IFsgdGhpcy5vZmZzZXQueCwgdGhpcy5vZmZzZXQueSBdLAoJCQljZW50ZXI6IFsgdGhpcy5jZW50ZXIueCwgdGhpcy5jZW50ZXIueSBdLAoJCQlyb3RhdGlvbjogdGhpcy5yb3RhdGlvbiwKCgkJCXdyYXA6IFsgdGhpcy53cmFwUywgdGhpcy53cmFwVCBdLAoKCQkJZm9ybWF0OiB0aGlzLmZvcm1hdCwKCQkJaW50ZXJuYWxGb3JtYXQ6IHRoaXMuaW50ZXJuYWxGb3JtYXQsCgkJCXR5cGU6IHRoaXMudHlwZSwKCQkJY29sb3JTcGFjZTogdGhpcy5jb2xvclNwYWNlLAoKCQkJbWluRmlsdGVyOiB0aGlzLm1pbkZpbHRlciwKCQkJbWFnRmlsdGVyOiB0aGlzLm1hZ0ZpbHRlciwKCQkJYW5pc290cm9weTogdGhpcy5hbmlzb3Ryb3B5LAoKCQkJZmxpcFk6IHRoaXMuZmxpcFksCgoJCQlnZW5lcmF0ZU1pcG1hcHM6IHRoaXMuZ2VuZXJhdGVNaXBtYXBzLAoJCQlwcmVtdWx0aXBseUFscGhhOiB0aGlzLnByZW11bHRpcGx5QWxwaGEsCgkJCXVucGFja0FsaWdubWVudDogdGhpcy51bnBhY2tBbGlnbm1lbnQKCgkJfTsKCgkJaWYgKCBPYmplY3Qua2V5cyggdGhpcy51c2VyRGF0YSApLmxlbmd0aCA+IDAgKSBvdXRwdXQudXNlckRhdGEgPSB0aGlzLnVzZXJEYXRhOwoKCQlpZiAoICEgaXNSb290T2JqZWN0ICkgewoKCQkJbWV0YS50ZXh0dXJlc1sgdGhpcy51dWlkIF0gPSBvdXRwdXQ7CgoJCX0KCgkJcmV0dXJuIG91dHB1dDsKCgl9CgoJZGlzcG9zZSgpIHsKCgkJdGhpcy5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICdkaXNwb3NlJyB9ICk7CgoJfQoKCXRyYW5zZm9ybVV2KCB1diApIHsKCgkJaWYgKCB0aGlzLm1hcHBpbmcgIT09IFVWTWFwcGluZyApIHJldHVybiB1djsKCgkJdXYuYXBwbHlNYXRyaXgzKCB0aGlzLm1hdHJpeCApOwoKCQlpZiAoIHV2LnggPCAwIHx8IHV2LnggPiAxICkgewoKCQkJc3dpdGNoICggdGhpcy53cmFwUyApIHsKCgkJCQljYXNlIFJlcGVhdFdyYXBwaW5nOgoKCQkJCQl1di54ID0gdXYueCAtIE1hdGguZmxvb3IoIHV2LnggKTsKCQkJCQlicmVhazsKCgkJCQljYXNlIENsYW1wVG9FZGdlV3JhcHBpbmc6CgoJCQkJCXV2LnggPSB1di54IDwgMCA/IDAgOiAxOwoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgTWlycm9yZWRSZXBlYXRXcmFwcGluZzoKCgkJCQkJaWYgKCBNYXRoLmFicyggTWF0aC5mbG9vciggdXYueCApICUgMiApID09PSAxICkgewoKCQkJCQkJdXYueCA9IE1hdGguY2VpbCggdXYueCApIC0gdXYueDsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXV2LnggPSB1di54IC0gTWF0aC5mbG9vciggdXYueCApOwoKCQkJCQl9CgoJCQkJCWJyZWFrOwoKCQkJfQoKCQl9CgoJCWlmICggdXYueSA8IDAgfHwgdXYueSA+IDEgKSB7CgoJCQlzd2l0Y2ggKCB0aGlzLndyYXBUICkgewoKCQkJCWNhc2UgUmVwZWF0V3JhcHBpbmc6CgoJCQkJCXV2LnkgPSB1di55IC0gTWF0aC5mbG9vciggdXYueSApOwoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgQ2xhbXBUb0VkZ2VXcmFwcGluZzoKCgkJCQkJdXYueSA9IHV2LnkgPCAwID8gMCA6IDE7CgkJCQkJYnJlYWs7CgoJCQkJY2FzZSBNaXJyb3JlZFJlcGVhdFdyYXBwaW5nOgoKCQkJCQlpZiAoIE1hdGguYWJzKCBNYXRoLmZsb29yKCB1di55ICkgJSAyICkgPT09IDEgKSB7CgoJCQkJCQl1di55ID0gTWF0aC5jZWlsKCB1di55ICkgLSB1di55OwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJdXYueSA9IHV2LnkgLSBNYXRoLmZsb29yKCB1di55ICk7CgoJCQkJCX0KCgkJCQkJYnJlYWs7CgoJCQl9CgoJCX0KCgkJaWYgKCB0aGlzLmZsaXBZICkgewoKCQkJdXYueSA9IDEgLSB1di55OwoKCQl9CgoJCXJldHVybiB1djsKCgl9CgoJc2V0IG5lZWRzVXBkYXRlKCB2YWx1ZSApIHsKCgkJaWYgKCB2YWx1ZSA9PT0gdHJ1ZSApIHsKCgkJCXRoaXMudmVyc2lvbiArKzsKCQkJdGhpcy5zb3VyY2UubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQl9CgoJfQoKCWdldCBlbmNvZGluZygpIHsgLy8gQGRlcHJlY2F0ZWQsIHIxNTIKCgkJd2Fybk9uY2UoICdUSFJFRS5UZXh0dXJlOiBQcm9wZXJ0eSAuZW5jb2RpbmcgaGFzIGJlZW4gcmVwbGFjZWQgYnkgLmNvbG9yU3BhY2UuJyApOwoJCXJldHVybiB0aGlzLmNvbG9yU3BhY2UgPT09IFNSR0JDb2xvclNwYWNlID8gc1JHQkVuY29kaW5nIDogTGluZWFyRW5jb2Rpbmc7CgoJfQoKCXNldCBlbmNvZGluZyggZW5jb2RpbmcgKSB7IC8vIEBkZXByZWNhdGVkLCByMTUyCgoJCXdhcm5PbmNlKCAnVEhSRUUuVGV4dHVyZTogUHJvcGVydHkgLmVuY29kaW5nIGhhcyBiZWVuIHJlcGxhY2VkIGJ5IC5jb2xvclNwYWNlLicgKTsKCQl0aGlzLmNvbG9yU3BhY2UgPSBlbmNvZGluZyA9PT0gc1JHQkVuY29kaW5nID8gU1JHQkNvbG9yU3BhY2UgOiBOb0NvbG9yU3BhY2U7CgoJfQoKfQoKVGV4dHVyZS5ERUZBVUxUX0lNQUdFID0gbnVsbDsKVGV4dHVyZS5ERUZBVUxUX01BUFBJTkcgPSBVVk1hcHBpbmc7ClRleHR1cmUuREVGQVVMVF9BTklTT1RST1BZID0gMTsKCmNsYXNzIFZlY3RvcjQgewoKCWNvbnN0cnVjdG9yKCB4ID0gMCwgeSA9IDAsIHogPSAwLCB3ID0gMSApIHsKCgkJVmVjdG9yNC5wcm90b3R5cGUuaXNWZWN0b3I0ID0gdHJ1ZTsKCgkJdGhpcy54ID0geDsKCQl0aGlzLnkgPSB5OwoJCXRoaXMueiA9IHo7CgkJdGhpcy53ID0gdzsKCgl9CgoJZ2V0IHdpZHRoKCkgewoKCQlyZXR1cm4gdGhpcy56OwoKCX0KCglzZXQgd2lkdGgoIHZhbHVlICkgewoKCQl0aGlzLnogPSB2YWx1ZTsKCgl9CgoJZ2V0IGhlaWdodCgpIHsKCgkJcmV0dXJuIHRoaXMudzsKCgl9CgoJc2V0IGhlaWdodCggdmFsdWUgKSB7CgoJCXRoaXMudyA9IHZhbHVlOwoKCX0KCglzZXQoIHgsIHksIHosIHcgKSB7CgoJCXRoaXMueCA9IHg7CgkJdGhpcy55ID0geTsKCQl0aGlzLnogPSB6OwoJCXRoaXMudyA9IHc7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRTY2FsYXIoIHNjYWxhciApIHsKCgkJdGhpcy54ID0gc2NhbGFyOwoJCXRoaXMueSA9IHNjYWxhcjsKCQl0aGlzLnogPSBzY2FsYXI7CgkJdGhpcy53ID0gc2NhbGFyOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0WCggeCApIHsKCgkJdGhpcy54ID0geDsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFkoIHkgKSB7CgoJCXRoaXMueSA9IHk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRaKCB6ICkgewoKCQl0aGlzLnogPSB6OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0VyggdyApIHsKCgkJdGhpcy53ID0gdzsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldENvbXBvbmVudCggaW5kZXgsIHZhbHVlICkgewoKCQlzd2l0Y2ggKCBpbmRleCApIHsKCgkJCWNhc2UgMDogdGhpcy54ID0gdmFsdWU7IGJyZWFrOwoJCQljYXNlIDE6IHRoaXMueSA9IHZhbHVlOyBicmVhazsKCQkJY2FzZSAyOiB0aGlzLnogPSB2YWx1ZTsgYnJlYWs7CgkJCWNhc2UgMzogdGhpcy53ID0gdmFsdWU7IGJyZWFrOwoJCQlkZWZhdWx0OiB0aHJvdyBuZXcgRXJyb3IoICdpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICcgKyBpbmRleCApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRDb21wb25lbnQoIGluZGV4ICkgewoKCQlzd2l0Y2ggKCBpbmRleCApIHsKCgkJCWNhc2UgMDogcmV0dXJuIHRoaXMueDsKCQkJY2FzZSAxOiByZXR1cm4gdGhpcy55OwoJCQljYXNlIDI6IHJldHVybiB0aGlzLno7CgkJCWNhc2UgMzogcmV0dXJuIHRoaXMudzsKCQkJZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKCAnaW5kZXggaXMgb3V0IG9mIHJhbmdlOiAnICsgaW5kZXggKTsKCgkJfQoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCB0aGlzLngsIHRoaXMueSwgdGhpcy56LCB0aGlzLncgKTsKCgl9CgoJY29weSggdiApIHsKCgkJdGhpcy54ID0gdi54OwoJCXRoaXMueSA9IHYueTsKCQl0aGlzLnogPSB2Lno7CgkJdGhpcy53ID0gKCB2LncgIT09IHVuZGVmaW5lZCApID8gdi53IDogMTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFkZCggdiApIHsKCgkJdGhpcy54ICs9IHYueDsKCQl0aGlzLnkgKz0gdi55OwoJCXRoaXMueiArPSB2Lno7CgkJdGhpcy53ICs9IHYudzsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFkZFNjYWxhciggcyApIHsKCgkJdGhpcy54ICs9IHM7CgkJdGhpcy55ICs9IHM7CgkJdGhpcy56ICs9IHM7CgkJdGhpcy53ICs9IHM7CgoJCXJldHVybiB0aGlzOwoKCX0KCglhZGRWZWN0b3JzKCBhLCBiICkgewoKCQl0aGlzLnggPSBhLnggKyBiLng7CgkJdGhpcy55ID0gYS55ICsgYi55OwoJCXRoaXMueiA9IGEueiArIGIuejsKCQl0aGlzLncgPSBhLncgKyBiLnc7CgoJCXJldHVybiB0aGlzOwoKCX0KCglhZGRTY2FsZWRWZWN0b3IoIHYsIHMgKSB7CgoJCXRoaXMueCArPSB2LnggKiBzOwoJCXRoaXMueSArPSB2LnkgKiBzOwoJCXRoaXMueiArPSB2LnogKiBzOwoJCXRoaXMudyArPSB2LncgKiBzOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3ViKCB2ICkgewoKCQl0aGlzLnggLT0gdi54OwoJCXRoaXMueSAtPSB2Lnk7CgkJdGhpcy56IC09IHYuejsKCQl0aGlzLncgLT0gdi53OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3ViU2NhbGFyKCBzICkgewoKCQl0aGlzLnggLT0gczsKCQl0aGlzLnkgLT0gczsKCQl0aGlzLnogLT0gczsKCQl0aGlzLncgLT0gczsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXN1YlZlY3RvcnMoIGEsIGIgKSB7CgoJCXRoaXMueCA9IGEueCAtIGIueDsKCQl0aGlzLnkgPSBhLnkgLSBiLnk7CgkJdGhpcy56ID0gYS56IC0gYi56OwoJCXRoaXMudyA9IGEudyAtIGIudzsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW11bHRpcGx5KCB2ICkgewoKCQl0aGlzLnggKj0gdi54OwoJCXRoaXMueSAqPSB2Lnk7CgkJdGhpcy56ICo9IHYuejsKCQl0aGlzLncgKj0gdi53OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbXVsdGlwbHlTY2FsYXIoIHNjYWxhciApIHsKCgkJdGhpcy54ICo9IHNjYWxhcjsKCQl0aGlzLnkgKj0gc2NhbGFyOwoJCXRoaXMueiAqPSBzY2FsYXI7CgkJdGhpcy53ICo9IHNjYWxhcjsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFwcGx5TWF0cml4NCggbSApIHsKCgkJY29uc3QgeCA9IHRoaXMueCwgeSA9IHRoaXMueSwgeiA9IHRoaXMueiwgdyA9IHRoaXMudzsKCQljb25zdCBlID0gbS5lbGVtZW50czsKCgkJdGhpcy54ID0gZVsgMCBdICogeCArIGVbIDQgXSAqIHkgKyBlWyA4IF0gKiB6ICsgZVsgMTIgXSAqIHc7CgkJdGhpcy55ID0gZVsgMSBdICogeCArIGVbIDUgXSAqIHkgKyBlWyA5IF0gKiB6ICsgZVsgMTMgXSAqIHc7CgkJdGhpcy56ID0gZVsgMiBdICogeCArIGVbIDYgXSAqIHkgKyBlWyAxMCBdICogeiArIGVbIDE0IF0gKiB3OwoJCXRoaXMudyA9IGVbIDMgXSAqIHggKyBlWyA3IF0gKiB5ICsgZVsgMTEgXSAqIHogKyBlWyAxNSBdICogdzsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWRpdmlkZVNjYWxhciggc2NhbGFyICkgewoKCQlyZXR1cm4gdGhpcy5tdWx0aXBseVNjYWxhciggMSAvIHNjYWxhciApOwoKCX0KCglzZXRBeGlzQW5nbGVGcm9tUXVhdGVybmlvbiggcSApIHsKCgkJLy8gaHR0cDovL3d3dy5ldWNsaWRlYW5zcGFjZS5jb20vbWF0aHMvZ2VvbWV0cnkvcm90YXRpb25zL2NvbnZlcnNpb25zL3F1YXRlcm5pb25Ub0FuZ2xlL2luZGV4Lmh0bQoKCQkvLyBxIGlzIGFzc3VtZWQgdG8gYmUgbm9ybWFsaXplZAoKCQl0aGlzLncgPSAyICogTWF0aC5hY29zKCBxLncgKTsKCgkJY29uc3QgcyA9IE1hdGguc3FydCggMSAtIHEudyAqIHEudyApOwoKCQlpZiAoIHMgPCAwLjAwMDEgKSB7CgoJCQl0aGlzLnggPSAxOwoJCQl0aGlzLnkgPSAwOwoJCQl0aGlzLnogPSAwOwoKCQl9IGVsc2UgewoKCQkJdGhpcy54ID0gcS54IC8gczsKCQkJdGhpcy55ID0gcS55IC8gczsKCQkJdGhpcy56ID0gcS56IC8gczsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0QXhpc0FuZ2xlRnJvbVJvdGF0aW9uTWF0cml4KCBtICkgewoKCQkvLyBodHRwOi8vd3d3LmV1Y2xpZGVhbnNwYWNlLmNvbS9tYXRocy9nZW9tZXRyeS9yb3RhdGlvbnMvY29udmVyc2lvbnMvbWF0cml4VG9BbmdsZS9pbmRleC5odG0KCgkJLy8gYXNzdW1lcyB0aGUgdXBwZXIgM3gzIG9mIG0gaXMgYSBwdXJlIHJvdGF0aW9uIG1hdHJpeCAoaS5lLCB1bnNjYWxlZCkKCgkJbGV0IGFuZ2xlLCB4LCB5LCB6OyAvLyB2YXJpYWJsZXMgZm9yIHJlc3VsdAoJCWNvbnN0IGVwc2lsb24gPSAwLjAxLAkJLy8gbWFyZ2luIHRvIGFsbG93IGZvciByb3VuZGluZyBlcnJvcnMKCQkJZXBzaWxvbjIgPSAwLjEsCQkvLyBtYXJnaW4gdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiAwIGFuZCAxODAgZGVncmVlcwoKCQkJdGUgPSBtLmVsZW1lbnRzLAoKCQkJbTExID0gdGVbIDAgXSwgbTEyID0gdGVbIDQgXSwgbTEzID0gdGVbIDggXSwKCQkJbTIxID0gdGVbIDEgXSwgbTIyID0gdGVbIDUgXSwgbTIzID0gdGVbIDkgXSwKCQkJbTMxID0gdGVbIDIgXSwgbTMyID0gdGVbIDYgXSwgbTMzID0gdGVbIDEwIF07CgoJCWlmICggKCBNYXRoLmFicyggbTEyIC0gbTIxICkgPCBlcHNpbG9uICkgJiYKCQkgICAgICggTWF0aC5hYnMoIG0xMyAtIG0zMSApIDwgZXBzaWxvbiApICYmCgkJICAgICAoIE1hdGguYWJzKCBtMjMgLSBtMzIgKSA8IGVwc2lsb24gKSApIHsKCgkJCS8vIHNpbmd1bGFyaXR5IGZvdW5kCgkJCS8vIGZpcnN0IGNoZWNrIGZvciBpZGVudGl0eSBtYXRyaXggd2hpY2ggbXVzdCBoYXZlICsxIGZvciBhbGwgdGVybXMKCQkJLy8gaW4gbGVhZGluZyBkaWFnb25hbCBhbmQgemVybyBpbiBvdGhlciB0ZXJtcwoKCQkJaWYgKCAoIE1hdGguYWJzKCBtMTIgKyBtMjEgKSA8IGVwc2lsb24yICkgJiYKCQkJICAgICAoIE1hdGguYWJzKCBtMTMgKyBtMzEgKSA8IGVwc2lsb24yICkgJiYKCQkJICAgICAoIE1hdGguYWJzKCBtMjMgKyBtMzIgKSA8IGVwc2lsb24yICkgJiYKCQkJICAgICAoIE1hdGguYWJzKCBtMTEgKyBtMjIgKyBtMzMgLSAzICkgPCBlcHNpbG9uMiApICkgewoKCQkJCS8vIHRoaXMgc2luZ3VsYXJpdHkgaXMgaWRlbnRpdHkgbWF0cml4IHNvIGFuZ2xlID0gMAoKCQkJCXRoaXMuc2V0KCAxLCAwLCAwLCAwICk7CgoJCQkJcmV0dXJuIHRoaXM7IC8vIHplcm8gYW5nbGUsIGFyYml0cmFyeSBheGlzCgoJCQl9CgoJCQkvLyBvdGhlcndpc2UgdGhpcyBzaW5ndWxhcml0eSBpcyBhbmdsZSA9IDE4MAoKCQkJYW5nbGUgPSBNYXRoLlBJOwoKCQkJY29uc3QgeHggPSAoIG0xMSArIDEgKSAvIDI7CgkJCWNvbnN0IHl5ID0gKCBtMjIgKyAxICkgLyAyOwoJCQljb25zdCB6eiA9ICggbTMzICsgMSApIC8gMjsKCQkJY29uc3QgeHkgPSAoIG0xMiArIG0yMSApIC8gNDsKCQkJY29uc3QgeHogPSAoIG0xMyArIG0zMSApIC8gNDsKCQkJY29uc3QgeXogPSAoIG0yMyArIG0zMiApIC8gNDsKCgkJCWlmICggKCB4eCA+IHl5ICkgJiYgKCB4eCA+IHp6ICkgKSB7CgoJCQkJLy8gbTExIGlzIHRoZSBsYXJnZXN0IGRpYWdvbmFsIHRlcm0KCgkJCQlpZiAoIHh4IDwgZXBzaWxvbiApIHsKCgkJCQkJeCA9IDA7CgkJCQkJeSA9IDAuNzA3MTA2NzgxOwoJCQkJCXogPSAwLjcwNzEwNjc4MTsKCgkJCQl9IGVsc2UgewoKCQkJCQl4ID0gTWF0aC5zcXJ0KCB4eCApOwoJCQkJCXkgPSB4eSAvIHg7CgkJCQkJeiA9IHh6IC8geDsKCgkJCQl9CgoJCQl9IGVsc2UgaWYgKCB5eSA+IHp6ICkgewoKCQkJCS8vIG0yMiBpcyB0aGUgbGFyZ2VzdCBkaWFnb25hbCB0ZXJtCgoJCQkJaWYgKCB5eSA8IGVwc2lsb24gKSB7CgoJCQkJCXggPSAwLjcwNzEwNjc4MTsKCQkJCQl5ID0gMDsKCQkJCQl6ID0gMC43MDcxMDY3ODE7CgoJCQkJfSBlbHNlIHsKCgkJCQkJeSA9IE1hdGguc3FydCggeXkgKTsKCQkJCQl4ID0geHkgLyB5OwoJCQkJCXogPSB5eiAvIHk7CgoJCQkJfQoKCQkJfSBlbHNlIHsKCgkJCQkvLyBtMzMgaXMgdGhlIGxhcmdlc3QgZGlhZ29uYWwgdGVybSBzbyBiYXNlIHJlc3VsdCBvbiB0aGlzCgoJCQkJaWYgKCB6eiA8IGVwc2lsb24gKSB7CgoJCQkJCXggPSAwLjcwNzEwNjc4MTsKCQkJCQl5ID0gMC43MDcxMDY3ODE7CgkJCQkJeiA9IDA7CgoJCQkJfSBlbHNlIHsKCgkJCQkJeiA9IE1hdGguc3FydCggenogKTsKCQkJCQl4ID0geHogLyB6OwoJCQkJCXkgPSB5eiAvIHo7CgoJCQkJfQoKCQkJfQoKCQkJdGhpcy5zZXQoIHgsIHksIHosIGFuZ2xlICk7CgoJCQlyZXR1cm4gdGhpczsgLy8gcmV0dXJuIDE4MCBkZWcgcm90YXRpb24KCgkJfQoKCQkvLyBhcyB3ZSBoYXZlIHJlYWNoZWQgaGVyZSB0aGVyZSBhcmUgbm8gc2luZ3VsYXJpdGllcyBzbyB3ZSBjYW4gaGFuZGxlIG5vcm1hbGx5CgoJCWxldCBzID0gTWF0aC5zcXJ0KCAoIG0zMiAtIG0yMyApICogKCBtMzIgLSBtMjMgKSArCgkJCSggbTEzIC0gbTMxICkgKiAoIG0xMyAtIG0zMSApICsKCQkJKCBtMjEgLSBtMTIgKSAqICggbTIxIC0gbTEyICkgKTsgLy8gdXNlZCB0byBub3JtYWxpemUKCgkJaWYgKCBNYXRoLmFicyggcyApIDwgMC4wMDEgKSBzID0gMTsKCgkJLy8gcHJldmVudCBkaXZpZGUgYnkgemVybywgc2hvdWxkIG5vdCBoYXBwZW4gaWYgbWF0cml4IGlzIG9ydGhvZ29uYWwgYW5kIHNob3VsZCBiZQoJCS8vIGNhdWdodCBieSBzaW5ndWxhcml0eSB0ZXN0IGFib3ZlLCBidXQgSSd2ZSBsZWZ0IGl0IGluIGp1c3QgaW4gY2FzZQoKCQl0aGlzLnggPSAoIG0zMiAtIG0yMyApIC8gczsKCQl0aGlzLnkgPSAoIG0xMyAtIG0zMSApIC8gczsKCQl0aGlzLnogPSAoIG0yMSAtIG0xMiApIC8gczsKCQl0aGlzLncgPSBNYXRoLmFjb3MoICggbTExICsgbTIyICsgbTMzIC0gMSApIC8gMiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbWluKCB2ICkgewoKCQl0aGlzLnggPSBNYXRoLm1pbiggdGhpcy54LCB2LnggKTsKCQl0aGlzLnkgPSBNYXRoLm1pbiggdGhpcy55LCB2LnkgKTsKCQl0aGlzLnogPSBNYXRoLm1pbiggdGhpcy56LCB2LnogKTsKCQl0aGlzLncgPSBNYXRoLm1pbiggdGhpcy53LCB2LncgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW1heCggdiApIHsKCgkJdGhpcy54ID0gTWF0aC5tYXgoIHRoaXMueCwgdi54ICk7CgkJdGhpcy55ID0gTWF0aC5tYXgoIHRoaXMueSwgdi55ICk7CgkJdGhpcy56ID0gTWF0aC5tYXgoIHRoaXMueiwgdi56ICk7CgkJdGhpcy53ID0gTWF0aC5tYXgoIHRoaXMudywgdi53ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljbGFtcCggbWluLCBtYXggKSB7CgoJCS8vIGFzc3VtZXMgbWluIDwgbWF4LCBjb21wb25lbnR3aXNlCgoJCXRoaXMueCA9IE1hdGgubWF4KCBtaW4ueCwgTWF0aC5taW4oIG1heC54LCB0aGlzLnggKSApOwoJCXRoaXMueSA9IE1hdGgubWF4KCBtaW4ueSwgTWF0aC5taW4oIG1heC55LCB0aGlzLnkgKSApOwoJCXRoaXMueiA9IE1hdGgubWF4KCBtaW4ueiwgTWF0aC5taW4oIG1heC56LCB0aGlzLnogKSApOwoJCXRoaXMudyA9IE1hdGgubWF4KCBtaW4udywgTWF0aC5taW4oIG1heC53LCB0aGlzLncgKSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xhbXBTY2FsYXIoIG1pblZhbCwgbWF4VmFsICkgewoKCQl0aGlzLnggPSBNYXRoLm1heCggbWluVmFsLCBNYXRoLm1pbiggbWF4VmFsLCB0aGlzLnggKSApOwoJCXRoaXMueSA9IE1hdGgubWF4KCBtaW5WYWwsIE1hdGgubWluKCBtYXhWYWwsIHRoaXMueSApICk7CgkJdGhpcy56ID0gTWF0aC5tYXgoIG1pblZhbCwgTWF0aC5taW4oIG1heFZhbCwgdGhpcy56ICkgKTsKCQl0aGlzLncgPSBNYXRoLm1heCggbWluVmFsLCBNYXRoLm1pbiggbWF4VmFsLCB0aGlzLncgKSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xhbXBMZW5ndGgoIG1pbiwgbWF4ICkgewoKCQljb25zdCBsZW5ndGggPSB0aGlzLmxlbmd0aCgpOwoKCQlyZXR1cm4gdGhpcy5kaXZpZGVTY2FsYXIoIGxlbmd0aCB8fCAxICkubXVsdGlwbHlTY2FsYXIoIE1hdGgubWF4KCBtaW4sIE1hdGgubWluKCBtYXgsIGxlbmd0aCApICkgKTsKCgl9CgoJZmxvb3IoKSB7CgoJCXRoaXMueCA9IE1hdGguZmxvb3IoIHRoaXMueCApOwoJCXRoaXMueSA9IE1hdGguZmxvb3IoIHRoaXMueSApOwoJCXRoaXMueiA9IE1hdGguZmxvb3IoIHRoaXMueiApOwoJCXRoaXMudyA9IE1hdGguZmxvb3IoIHRoaXMudyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2VpbCgpIHsKCgkJdGhpcy54ID0gTWF0aC5jZWlsKCB0aGlzLnggKTsKCQl0aGlzLnkgPSBNYXRoLmNlaWwoIHRoaXMueSApOwoJCXRoaXMueiA9IE1hdGguY2VpbCggdGhpcy56ICk7CgkJdGhpcy53ID0gTWF0aC5jZWlsKCB0aGlzLncgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJvdW5kKCkgewoKCQl0aGlzLnggPSBNYXRoLnJvdW5kKCB0aGlzLnggKTsKCQl0aGlzLnkgPSBNYXRoLnJvdW5kKCB0aGlzLnkgKTsKCQl0aGlzLnogPSBNYXRoLnJvdW5kKCB0aGlzLnogKTsKCQl0aGlzLncgPSBNYXRoLnJvdW5kKCB0aGlzLncgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJvdW5kVG9aZXJvKCkgewoKCQl0aGlzLnggPSBNYXRoLnRydW5jKCB0aGlzLnggKTsKCQl0aGlzLnkgPSBNYXRoLnRydW5jKCB0aGlzLnkgKTsKCQl0aGlzLnogPSBNYXRoLnRydW5jKCB0aGlzLnogKTsKCQl0aGlzLncgPSBNYXRoLnRydW5jKCB0aGlzLncgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW5lZ2F0ZSgpIHsKCgkJdGhpcy54ID0gLSB0aGlzLng7CgkJdGhpcy55ID0gLSB0aGlzLnk7CgkJdGhpcy56ID0gLSB0aGlzLno7CgkJdGhpcy53ID0gLSB0aGlzLnc7CgoJCXJldHVybiB0aGlzOwoKCX0KCglkb3QoIHYgKSB7CgoJCXJldHVybiB0aGlzLnggKiB2LnggKyB0aGlzLnkgKiB2LnkgKyB0aGlzLnogKiB2LnogKyB0aGlzLncgKiB2Lnc7CgoJfQoKCWxlbmd0aFNxKCkgewoKCQlyZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICsgdGhpcy56ICogdGhpcy56ICsgdGhpcy53ICogdGhpcy53OwoKCX0KCglsZW5ndGgoKSB7CgoJCXJldHVybiBNYXRoLnNxcnQoIHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMueiArIHRoaXMudyAqIHRoaXMudyApOwoKCX0KCgltYW5oYXR0YW5MZW5ndGgoKSB7CgoJCXJldHVybiBNYXRoLmFicyggdGhpcy54ICkgKyBNYXRoLmFicyggdGhpcy55ICkgKyBNYXRoLmFicyggdGhpcy56ICkgKyBNYXRoLmFicyggdGhpcy53ICk7CgoJfQoKCW5vcm1hbGl6ZSgpIHsKCgkJcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKCB0aGlzLmxlbmd0aCgpIHx8IDEgKTsKCgl9CgoJc2V0TGVuZ3RoKCBsZW5ndGggKSB7CgoJCXJldHVybiB0aGlzLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKCBsZW5ndGggKTsKCgl9CgoJbGVycCggdiwgYWxwaGEgKSB7CgoJCXRoaXMueCArPSAoIHYueCAtIHRoaXMueCApICogYWxwaGE7CgkJdGhpcy55ICs9ICggdi55IC0gdGhpcy55ICkgKiBhbHBoYTsKCQl0aGlzLnogKz0gKCB2LnogLSB0aGlzLnogKSAqIGFscGhhOwoJCXRoaXMudyArPSAoIHYudyAtIHRoaXMudyApICogYWxwaGE7CgoJCXJldHVybiB0aGlzOwoKCX0KCglsZXJwVmVjdG9ycyggdjEsIHYyLCBhbHBoYSApIHsKCgkJdGhpcy54ID0gdjEueCArICggdjIueCAtIHYxLnggKSAqIGFscGhhOwoJCXRoaXMueSA9IHYxLnkgKyAoIHYyLnkgLSB2MS55ICkgKiBhbHBoYTsKCQl0aGlzLnogPSB2MS56ICsgKCB2Mi56IC0gdjEueiApICogYWxwaGE7CgkJdGhpcy53ID0gdjEudyArICggdjIudyAtIHYxLncgKSAqIGFscGhhOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXF1YWxzKCB2ICkgewoKCQlyZXR1cm4gKCAoIHYueCA9PT0gdGhpcy54ICkgJiYgKCB2LnkgPT09IHRoaXMueSApICYmICggdi56ID09PSB0aGlzLnogKSAmJiAoIHYudyA9PT0gdGhpcy53ICkgKTsKCgl9CgoJZnJvbUFycmF5KCBhcnJheSwgb2Zmc2V0ID0gMCApIHsKCgkJdGhpcy54ID0gYXJyYXlbIG9mZnNldCBdOwoJCXRoaXMueSA9IGFycmF5WyBvZmZzZXQgKyAxIF07CgkJdGhpcy56ID0gYXJyYXlbIG9mZnNldCArIDIgXTsKCQl0aGlzLncgPSBhcnJheVsgb2Zmc2V0ICsgMyBdOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9BcnJheSggYXJyYXkgPSBbXSwgb2Zmc2V0ID0gMCApIHsKCgkJYXJyYXlbIG9mZnNldCBdID0gdGhpcy54OwoJCWFycmF5WyBvZmZzZXQgKyAxIF0gPSB0aGlzLnk7CgkJYXJyYXlbIG9mZnNldCArIDIgXSA9IHRoaXMuejsKCQlhcnJheVsgb2Zmc2V0ICsgMyBdID0gdGhpcy53OwoKCQlyZXR1cm4gYXJyYXk7CgoJfQoKCWZyb21CdWZmZXJBdHRyaWJ1dGUoIGF0dHJpYnV0ZSwgaW5kZXggKSB7CgoJCXRoaXMueCA9IGF0dHJpYnV0ZS5nZXRYKCBpbmRleCApOwoJCXRoaXMueSA9IGF0dHJpYnV0ZS5nZXRZKCBpbmRleCApOwoJCXRoaXMueiA9IGF0dHJpYnV0ZS5nZXRaKCBpbmRleCApOwoJCXRoaXMudyA9IGF0dHJpYnV0ZS5nZXRXKCBpbmRleCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcmFuZG9tKCkgewoKCQl0aGlzLnggPSBNYXRoLnJhbmRvbSgpOwoJCXRoaXMueSA9IE1hdGgucmFuZG9tKCk7CgkJdGhpcy56ID0gTWF0aC5yYW5kb20oKTsKCQl0aGlzLncgPSBNYXRoLnJhbmRvbSgpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJKlsgU3ltYm9sLml0ZXJhdG9yIF0oKSB7CgoJCXlpZWxkIHRoaXMueDsKCQl5aWVsZCB0aGlzLnk7CgkJeWllbGQgdGhpcy56OwoJCXlpZWxkIHRoaXMudzsKCgl9Cgp9CgovKgogSW4gb3B0aW9ucywgd2UgY2FuIHNwZWNpZnk6CiAqIFRleHR1cmUgcGFyYW1ldGVycyBmb3IgYW4gYXV0by1nZW5lcmF0ZWQgdGFyZ2V0IHRleHR1cmUKICogZGVwdGhCdWZmZXIvc3RlbmNpbEJ1ZmZlcjogQm9vbGVhbnMgdG8gaW5kaWNhdGUgaWYgd2Ugc2hvdWxkIGdlbmVyYXRlIHRoZXNlIGJ1ZmZlcnMKKi8KY2xhc3MgUmVuZGVyVGFyZ2V0IGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyIHsKCgljb25zdHJ1Y3Rvciggd2lkdGggPSAxLCBoZWlnaHQgPSAxLCBvcHRpb25zID0ge30gKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNSZW5kZXJUYXJnZXQgPSB0cnVlOwoKCQl0aGlzLndpZHRoID0gd2lkdGg7CgkJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgkJdGhpcy5kZXB0aCA9IDE7CgoJCXRoaXMuc2Npc3NvciA9IG5ldyBWZWN0b3I0KCAwLCAwLCB3aWR0aCwgaGVpZ2h0ICk7CgkJdGhpcy5zY2lzc29yVGVzdCA9IGZhbHNlOwoKCQl0aGlzLnZpZXdwb3J0ID0gbmV3IFZlY3RvcjQoIDAsIDAsIHdpZHRoLCBoZWlnaHQgKTsKCgkJY29uc3QgaW1hZ2UgPSB7IHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQsIGRlcHRoOiAxIH07CgoJCWlmICggb3B0aW9ucy5lbmNvZGluZyAhPT0gdW5kZWZpbmVkICkgewoKCQkJLy8gQGRlcHJlY2F0ZWQsIHIxNTIKCQkJd2Fybk9uY2UoICdUSFJFRS5XZWJHTFJlbmRlclRhcmdldDogb3B0aW9uLmVuY29kaW5nIGhhcyBiZWVuIHJlcGxhY2VkIGJ5IG9wdGlvbi5jb2xvclNwYWNlLicgKTsKCQkJb3B0aW9ucy5jb2xvclNwYWNlID0gb3B0aW9ucy5lbmNvZGluZyA9PT0gc1JHQkVuY29kaW5nID8gU1JHQkNvbG9yU3BhY2UgOiBOb0NvbG9yU3BhY2U7CgoJCX0KCgkJb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oIHsKCQkJZ2VuZXJhdGVNaXBtYXBzOiBmYWxzZSwKCQkJaW50ZXJuYWxGb3JtYXQ6IG51bGwsCgkJCW1pbkZpbHRlcjogTGluZWFyRmlsdGVyLAoJCQlkZXB0aEJ1ZmZlcjogdHJ1ZSwKCQkJc3RlbmNpbEJ1ZmZlcjogZmFsc2UsCgkJCWRlcHRoVGV4dHVyZTogbnVsbCwKCQkJc2FtcGxlczogMAoJCX0sIG9wdGlvbnMgKTsKCgkJdGhpcy50ZXh0dXJlID0gbmV3IFRleHR1cmUoIGltYWdlLCBvcHRpb25zLm1hcHBpbmcsIG9wdGlvbnMud3JhcFMsIG9wdGlvbnMud3JhcFQsIG9wdGlvbnMubWFnRmlsdGVyLCBvcHRpb25zLm1pbkZpbHRlciwgb3B0aW9ucy5mb3JtYXQsIG9wdGlvbnMudHlwZSwgb3B0aW9ucy5hbmlzb3Ryb3B5LCBvcHRpb25zLmNvbG9yU3BhY2UgKTsKCQl0aGlzLnRleHR1cmUuaXNSZW5kZXJUYXJnZXRUZXh0dXJlID0gdHJ1ZTsKCgkJdGhpcy50ZXh0dXJlLmZsaXBZID0gZmFsc2U7CgkJdGhpcy50ZXh0dXJlLmdlbmVyYXRlTWlwbWFwcyA9IG9wdGlvbnMuZ2VuZXJhdGVNaXBtYXBzOwoJCXRoaXMudGV4dHVyZS5pbnRlcm5hbEZvcm1hdCA9IG9wdGlvbnMuaW50ZXJuYWxGb3JtYXQ7CgoJCXRoaXMuZGVwdGhCdWZmZXIgPSBvcHRpb25zLmRlcHRoQnVmZmVyOwoJCXRoaXMuc3RlbmNpbEJ1ZmZlciA9IG9wdGlvbnMuc3RlbmNpbEJ1ZmZlcjsKCgkJdGhpcy5kZXB0aFRleHR1cmUgPSBvcHRpb25zLmRlcHRoVGV4dHVyZTsKCgkJdGhpcy5zYW1wbGVzID0gb3B0aW9ucy5zYW1wbGVzOwoKCX0KCglzZXRTaXplKCB3aWR0aCwgaGVpZ2h0LCBkZXB0aCA9IDEgKSB7CgoJCWlmICggdGhpcy53aWR0aCAhPT0gd2lkdGggfHwgdGhpcy5oZWlnaHQgIT09IGhlaWdodCB8fCB0aGlzLmRlcHRoICE9PSBkZXB0aCApIHsKCgkJCXRoaXMud2lkdGggPSB3aWR0aDsKCQkJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgkJCXRoaXMuZGVwdGggPSBkZXB0aDsKCgkJCXRoaXMudGV4dHVyZS5pbWFnZS53aWR0aCA9IHdpZHRoOwoJCQl0aGlzLnRleHR1cmUuaW1hZ2UuaGVpZ2h0ID0gaGVpZ2h0OwoJCQl0aGlzLnRleHR1cmUuaW1hZ2UuZGVwdGggPSBkZXB0aDsKCgkJCXRoaXMuZGlzcG9zZSgpOwoKCQl9CgoJCXRoaXMudmlld3BvcnQuc2V0KCAwLCAwLCB3aWR0aCwgaGVpZ2h0ICk7CgkJdGhpcy5zY2lzc29yLnNldCggMCwgMCwgd2lkdGgsIGhlaWdodCApOwoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSggdGhpcyApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXRoaXMud2lkdGggPSBzb3VyY2Uud2lkdGg7CgkJdGhpcy5oZWlnaHQgPSBzb3VyY2UuaGVpZ2h0OwoJCXRoaXMuZGVwdGggPSBzb3VyY2UuZGVwdGg7CgoJCXRoaXMuc2Npc3Nvci5jb3B5KCBzb3VyY2Uuc2Npc3NvciApOwoJCXRoaXMuc2Npc3NvclRlc3QgPSBzb3VyY2Uuc2Npc3NvclRlc3Q7CgoJCXRoaXMudmlld3BvcnQuY29weSggc291cmNlLnZpZXdwb3J0ICk7CgoJCXRoaXMudGV4dHVyZSA9IHNvdXJjZS50ZXh0dXJlLmNsb25lKCk7CgkJdGhpcy50ZXh0dXJlLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9IHRydWU7CgoJCS8vIGVuc3VyZSBpbWFnZSBvYmplY3QgaXMgbm90IHNoYXJlZCwgc2VlICMyMDMyOAoKCQljb25zdCBpbWFnZSA9IE9iamVjdC5hc3NpZ24oIHt9LCBzb3VyY2UudGV4dHVyZS5pbWFnZSApOwoJCXRoaXMudGV4dHVyZS5zb3VyY2UgPSBuZXcgU291cmNlKCBpbWFnZSApOwoKCQl0aGlzLmRlcHRoQnVmZmVyID0gc291cmNlLmRlcHRoQnVmZmVyOwoJCXRoaXMuc3RlbmNpbEJ1ZmZlciA9IHNvdXJjZS5zdGVuY2lsQnVmZmVyOwoKCQlpZiAoIHNvdXJjZS5kZXB0aFRleHR1cmUgIT09IG51bGwgKSB0aGlzLmRlcHRoVGV4dHVyZSA9IHNvdXJjZS5kZXB0aFRleHR1cmUuY2xvbmUoKTsKCgkJdGhpcy5zYW1wbGVzID0gc291cmNlLnNhbXBsZXM7CgoJCXJldHVybiB0aGlzOwoKCX0KCglkaXNwb3NlKCkgewoKCQl0aGlzLmRpc3BhdGNoRXZlbnQoIHsgdHlwZTogJ2Rpc3Bvc2UnIH0gKTsKCgl9Cgp9CgpjbGFzcyBXZWJHTFJlbmRlclRhcmdldCBleHRlbmRzIFJlbmRlclRhcmdldCB7CgoJY29uc3RydWN0b3IoIHdpZHRoID0gMSwgaGVpZ2h0ID0gMSwgb3B0aW9ucyA9IHt9ICkgewoKCQlzdXBlciggd2lkdGgsIGhlaWdodCwgb3B0aW9ucyApOwoKCQl0aGlzLmlzV2ViR0xSZW5kZXJUYXJnZXQgPSB0cnVlOwoKCX0KCn0KCmNsYXNzIERhdGFBcnJheVRleHR1cmUgZXh0ZW5kcyBUZXh0dXJlIHsKCgljb25zdHJ1Y3RvciggZGF0YSA9IG51bGwsIHdpZHRoID0gMSwgaGVpZ2h0ID0gMSwgZGVwdGggPSAxICkgewoKCQlzdXBlciggbnVsbCApOwoKCQl0aGlzLmlzRGF0YUFycmF5VGV4dHVyZSA9IHRydWU7CgoJCXRoaXMuaW1hZ2UgPSB7IGRhdGEsIHdpZHRoLCBoZWlnaHQsIGRlcHRoIH07CgoJCXRoaXMubWFnRmlsdGVyID0gTmVhcmVzdEZpbHRlcjsKCQl0aGlzLm1pbkZpbHRlciA9IE5lYXJlc3RGaWx0ZXI7CgoJCXRoaXMud3JhcFIgPSBDbGFtcFRvRWRnZVdyYXBwaW5nOwoKCQl0aGlzLmdlbmVyYXRlTWlwbWFwcyA9IGZhbHNlOwoJCXRoaXMuZmxpcFkgPSBmYWxzZTsKCQl0aGlzLnVucGFja0FsaWdubWVudCA9IDE7CgoJfQoKfQoKY2xhc3MgV2ViR0xBcnJheVJlbmRlclRhcmdldCBleHRlbmRzIFdlYkdMUmVuZGVyVGFyZ2V0IHsKCgljb25zdHJ1Y3Rvciggd2lkdGggPSAxLCBoZWlnaHQgPSAxLCBkZXB0aCA9IDEsIG9wdGlvbnMgPSB7fSApIHsKCgkJc3VwZXIoIHdpZHRoLCBoZWlnaHQsIG9wdGlvbnMgKTsKCgkJdGhpcy5pc1dlYkdMQXJyYXlSZW5kZXJUYXJnZXQgPSB0cnVlOwoKCQl0aGlzLmRlcHRoID0gZGVwdGg7CgoJCXRoaXMudGV4dHVyZSA9IG5ldyBEYXRhQXJyYXlUZXh0dXJlKCBudWxsLCB3aWR0aCwgaGVpZ2h0LCBkZXB0aCApOwoKCQl0aGlzLnRleHR1cmUuaXNSZW5kZXJUYXJnZXRUZXh0dXJlID0gdHJ1ZTsKCgl9Cgp9CgpjbGFzcyBEYXRhM0RUZXh0dXJlIGV4dGVuZHMgVGV4dHVyZSB7CgoJY29uc3RydWN0b3IoIGRhdGEgPSBudWxsLCB3aWR0aCA9IDEsIGhlaWdodCA9IDEsIGRlcHRoID0gMSApIHsKCgkJLy8gV2UncmUgZ29pbmcgdG8gYWRkIC5zZXRYWFgoKSBtZXRob2RzIGZvciBzZXR0aW5nIHByb3BlcnRpZXMgbGF0ZXIuCgkJLy8gVXNlcnMgY2FuIHN0aWxsIHNldCBpbiBEYXRhVGV4dHVyZTNEIGRpcmVjdGx5LgoJCS8vCgkJLy8JY29uc3QgdGV4dHVyZSA9IG5ldyBUSFJFRS5EYXRhVGV4dHVyZTNEKCBkYXRhLCB3aWR0aCwgaGVpZ2h0LCBkZXB0aCApOwoJCS8vIAl0ZXh0dXJlLmFuaXNvdHJvcHkgPSAxNjsKCQkvLwoJCS8vIFNlZSAjMTQ4MzkKCgkJc3VwZXIoIG51bGwgKTsKCgkJdGhpcy5pc0RhdGEzRFRleHR1cmUgPSB0cnVlOwoKCQl0aGlzLmltYWdlID0geyBkYXRhLCB3aWR0aCwgaGVpZ2h0LCBkZXB0aCB9OwoKCQl0aGlzLm1hZ0ZpbHRlciA9IE5lYXJlc3RGaWx0ZXI7CgkJdGhpcy5taW5GaWx0ZXIgPSBOZWFyZXN0RmlsdGVyOwoKCQl0aGlzLndyYXBSID0gQ2xhbXBUb0VkZ2VXcmFwcGluZzsKCgkJdGhpcy5nZW5lcmF0ZU1pcG1hcHMgPSBmYWxzZTsKCQl0aGlzLmZsaXBZID0gZmFsc2U7CgkJdGhpcy51bnBhY2tBbGlnbm1lbnQgPSAxOwoKCX0KCn0KCmNsYXNzIFdlYkdMM0RSZW5kZXJUYXJnZXQgZXh0ZW5kcyBXZWJHTFJlbmRlclRhcmdldCB7CgoJY29uc3RydWN0b3IoIHdpZHRoID0gMSwgaGVpZ2h0ID0gMSwgZGVwdGggPSAxLCBvcHRpb25zID0ge30gKSB7CgoJCXN1cGVyKCB3aWR0aCwgaGVpZ2h0LCBvcHRpb25zICk7CgoJCXRoaXMuaXNXZWJHTDNEUmVuZGVyVGFyZ2V0ID0gdHJ1ZTsKCgkJdGhpcy5kZXB0aCA9IGRlcHRoOwoKCQl0aGlzLnRleHR1cmUgPSBuZXcgRGF0YTNEVGV4dHVyZSggbnVsbCwgd2lkdGgsIGhlaWdodCwgZGVwdGggKTsKCgkJdGhpcy50ZXh0dXJlLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9IHRydWU7CgoJfQoKfQoKY2xhc3MgV2ViR0xNdWx0aXBsZVJlbmRlclRhcmdldHMgZXh0ZW5kcyBXZWJHTFJlbmRlclRhcmdldCB7CgoJY29uc3RydWN0b3IoIHdpZHRoID0gMSwgaGVpZ2h0ID0gMSwgY291bnQgPSAxLCBvcHRpb25zID0ge30gKSB7CgoJCXN1cGVyKCB3aWR0aCwgaGVpZ2h0LCBvcHRpb25zICk7CgoJCXRoaXMuaXNXZWJHTE11bHRpcGxlUmVuZGVyVGFyZ2V0cyA9IHRydWU7CgoJCWNvbnN0IHRleHR1cmUgPSB0aGlzLnRleHR1cmU7CgoJCXRoaXMudGV4dHVyZSA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSArKyApIHsKCgkJCXRoaXMudGV4dHVyZVsgaSBdID0gdGV4dHVyZS5jbG9uZSgpOwoJCQl0aGlzLnRleHR1cmVbIGkgXS5pc1JlbmRlclRhcmdldFRleHR1cmUgPSB0cnVlOwoKCQl9CgoJfQoKCXNldFNpemUoIHdpZHRoLCBoZWlnaHQsIGRlcHRoID0gMSApIHsKCgkJaWYgKCB0aGlzLndpZHRoICE9PSB3aWR0aCB8fCB0aGlzLmhlaWdodCAhPT0gaGVpZ2h0IHx8IHRoaXMuZGVwdGggIT09IGRlcHRoICkgewoKCQkJdGhpcy53aWR0aCA9IHdpZHRoOwoJCQl0aGlzLmhlaWdodCA9IGhlaWdodDsKCQkJdGhpcy5kZXB0aCA9IGRlcHRoOwoKCQkJZm9yICggbGV0IGkgPSAwLCBpbCA9IHRoaXMudGV4dHVyZS5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCQl0aGlzLnRleHR1cmVbIGkgXS5pbWFnZS53aWR0aCA9IHdpZHRoOwoJCQkJdGhpcy50ZXh0dXJlWyBpIF0uaW1hZ2UuaGVpZ2h0ID0gaGVpZ2h0OwoJCQkJdGhpcy50ZXh0dXJlWyBpIF0uaW1hZ2UuZGVwdGggPSBkZXB0aDsKCgkJCX0KCgkJCXRoaXMuZGlzcG9zZSgpOwoKCQl9CgoJCXRoaXMudmlld3BvcnQuc2V0KCAwLCAwLCB3aWR0aCwgaGVpZ2h0ICk7CgkJdGhpcy5zY2lzc29yLnNldCggMCwgMCwgd2lkdGgsIGhlaWdodCApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXRoaXMuZGlzcG9zZSgpOwoKCQl0aGlzLndpZHRoID0gc291cmNlLndpZHRoOwoJCXRoaXMuaGVpZ2h0ID0gc291cmNlLmhlaWdodDsKCQl0aGlzLmRlcHRoID0gc291cmNlLmRlcHRoOwoKCQl0aGlzLnNjaXNzb3IuY29weSggc291cmNlLnNjaXNzb3IgKTsKCQl0aGlzLnNjaXNzb3JUZXN0ID0gc291cmNlLnNjaXNzb3JUZXN0OwoKCQl0aGlzLnZpZXdwb3J0LmNvcHkoIHNvdXJjZS52aWV3cG9ydCApOwoKCQl0aGlzLmRlcHRoQnVmZmVyID0gc291cmNlLmRlcHRoQnVmZmVyOwoJCXRoaXMuc3RlbmNpbEJ1ZmZlciA9IHNvdXJjZS5zdGVuY2lsQnVmZmVyOwoKCQlpZiAoIHNvdXJjZS5kZXB0aFRleHR1cmUgIT09IG51bGwgKSB0aGlzLmRlcHRoVGV4dHVyZSA9IHNvdXJjZS5kZXB0aFRleHR1cmUuY2xvbmUoKTsKCgkJdGhpcy50ZXh0dXJlLmxlbmd0aCA9IDA7CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSBzb3VyY2UudGV4dHVyZS5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCXRoaXMudGV4dHVyZVsgaSBdID0gc291cmNlLnRleHR1cmVbIGkgXS5jbG9uZSgpOwoJCQl0aGlzLnRleHR1cmVbIGkgXS5pc1JlbmRlclRhcmdldFRleHR1cmUgPSB0cnVlOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIFF1YXRlcm5pb24gewoKCWNvbnN0cnVjdG9yKCB4ID0gMCwgeSA9IDAsIHogPSAwLCB3ID0gMSApIHsKCgkJdGhpcy5pc1F1YXRlcm5pb24gPSB0cnVlOwoKCQl0aGlzLl94ID0geDsKCQl0aGlzLl95ID0geTsKCQl0aGlzLl96ID0gejsKCQl0aGlzLl93ID0gdzsKCgl9CgoJc3RhdGljIHNsZXJwRmxhdCggZHN0LCBkc3RPZmZzZXQsIHNyYzAsIHNyY09mZnNldDAsIHNyYzEsIHNyY09mZnNldDEsIHQgKSB7CgoJCS8vIGZ1enotZnJlZSwgYXJyYXktYmFzZWQgUXVhdGVybmlvbiBTTEVSUCBvcGVyYXRpb24KCgkJbGV0IHgwID0gc3JjMFsgc3JjT2Zmc2V0MCArIDAgXSwKCQkJeTAgPSBzcmMwWyBzcmNPZmZzZXQwICsgMSBdLAoJCQl6MCA9IHNyYzBbIHNyY09mZnNldDAgKyAyIF0sCgkJCXcwID0gc3JjMFsgc3JjT2Zmc2V0MCArIDMgXTsKCgkJY29uc3QgeDEgPSBzcmMxWyBzcmNPZmZzZXQxICsgMCBdLAoJCQl5MSA9IHNyYzFbIHNyY09mZnNldDEgKyAxIF0sCgkJCXoxID0gc3JjMVsgc3JjT2Zmc2V0MSArIDIgXSwKCQkJdzEgPSBzcmMxWyBzcmNPZmZzZXQxICsgMyBdOwoKCQlpZiAoIHQgPT09IDAgKSB7CgoJCQlkc3RbIGRzdE9mZnNldCArIDAgXSA9IHgwOwoJCQlkc3RbIGRzdE9mZnNldCArIDEgXSA9IHkwOwoJCQlkc3RbIGRzdE9mZnNldCArIDIgXSA9IHowOwoJCQlkc3RbIGRzdE9mZnNldCArIDMgXSA9IHcwOwoJCQlyZXR1cm47CgoJCX0KCgkJaWYgKCB0ID09PSAxICkgewoKCQkJZHN0WyBkc3RPZmZzZXQgKyAwIF0gPSB4MTsKCQkJZHN0WyBkc3RPZmZzZXQgKyAxIF0gPSB5MTsKCQkJZHN0WyBkc3RPZmZzZXQgKyAyIF0gPSB6MTsKCQkJZHN0WyBkc3RPZmZzZXQgKyAzIF0gPSB3MTsKCQkJcmV0dXJuOwoKCQl9CgoJCWlmICggdzAgIT09IHcxIHx8IHgwICE9PSB4MSB8fCB5MCAhPT0geTEgfHwgejAgIT09IHoxICkgewoKCQkJbGV0IHMgPSAxIC0gdDsKCQkJY29uc3QgY29zID0geDAgKiB4MSArIHkwICogeTEgKyB6MCAqIHoxICsgdzAgKiB3MSwKCQkJCWRpciA9ICggY29zID49IDAgPyAxIDogLSAxICksCgkJCQlzcXJTaW4gPSAxIC0gY29zICogY29zOwoKCQkJLy8gU2tpcCB0aGUgU2xlcnAgZm9yIHRpbnkgc3RlcHMgdG8gYXZvaWQgbnVtZXJpYyBwcm9ibGVtczoKCQkJaWYgKCBzcXJTaW4gPiBOdW1iZXIuRVBTSUxPTiApIHsKCgkJCQljb25zdCBzaW4gPSBNYXRoLnNxcnQoIHNxclNpbiApLAoJCQkJCWxlbiA9IE1hdGguYXRhbjIoIHNpbiwgY29zICogZGlyICk7CgoJCQkJcyA9IE1hdGguc2luKCBzICogbGVuICkgLyBzaW47CgkJCQl0ID0gTWF0aC5zaW4oIHQgKiBsZW4gKSAvIHNpbjsKCgkJCX0KCgkJCWNvbnN0IHREaXIgPSB0ICogZGlyOwoKCQkJeDAgPSB4MCAqIHMgKyB4MSAqIHREaXI7CgkJCXkwID0geTAgKiBzICsgeTEgKiB0RGlyOwoJCQl6MCA9IHowICogcyArIHoxICogdERpcjsKCQkJdzAgPSB3MCAqIHMgKyB3MSAqIHREaXI7CgoJCQkvLyBOb3JtYWxpemUgaW4gY2FzZSB3ZSBqdXN0IGRpZCBhIGxlcnA6CgkJCWlmICggcyA9PT0gMSAtIHQgKSB7CgoJCQkJY29uc3QgZiA9IDEgLyBNYXRoLnNxcnQoIHgwICogeDAgKyB5MCAqIHkwICsgejAgKiB6MCArIHcwICogdzAgKTsKCgkJCQl4MCAqPSBmOwoJCQkJeTAgKj0gZjsKCQkJCXowICo9IGY7CgkJCQl3MCAqPSBmOwoKCQkJfQoKCQl9CgoJCWRzdFsgZHN0T2Zmc2V0IF0gPSB4MDsKCQlkc3RbIGRzdE9mZnNldCArIDEgXSA9IHkwOwoJCWRzdFsgZHN0T2Zmc2V0ICsgMiBdID0gejA7CgkJZHN0WyBkc3RPZmZzZXQgKyAzIF0gPSB3MDsKCgl9CgoJc3RhdGljIG11bHRpcGx5UXVhdGVybmlvbnNGbGF0KCBkc3QsIGRzdE9mZnNldCwgc3JjMCwgc3JjT2Zmc2V0MCwgc3JjMSwgc3JjT2Zmc2V0MSApIHsKCgkJY29uc3QgeDAgPSBzcmMwWyBzcmNPZmZzZXQwIF07CgkJY29uc3QgeTAgPSBzcmMwWyBzcmNPZmZzZXQwICsgMSBdOwoJCWNvbnN0IHowID0gc3JjMFsgc3JjT2Zmc2V0MCArIDIgXTsKCQljb25zdCB3MCA9IHNyYzBbIHNyY09mZnNldDAgKyAzIF07CgoJCWNvbnN0IHgxID0gc3JjMVsgc3JjT2Zmc2V0MSBdOwoJCWNvbnN0IHkxID0gc3JjMVsgc3JjT2Zmc2V0MSArIDEgXTsKCQljb25zdCB6MSA9IHNyYzFbIHNyY09mZnNldDEgKyAyIF07CgkJY29uc3QgdzEgPSBzcmMxWyBzcmNPZmZzZXQxICsgMyBdOwoKCQlkc3RbIGRzdE9mZnNldCBdID0geDAgKiB3MSArIHcwICogeDEgKyB5MCAqIHoxIC0gejAgKiB5MTsKCQlkc3RbIGRzdE9mZnNldCArIDEgXSA9IHkwICogdzEgKyB3MCAqIHkxICsgejAgKiB4MSAtIHgwICogejE7CgkJZHN0WyBkc3RPZmZzZXQgKyAyIF0gPSB6MCAqIHcxICsgdzAgKiB6MSArIHgwICogeTEgLSB5MCAqIHgxOwoJCWRzdFsgZHN0T2Zmc2V0ICsgMyBdID0gdzAgKiB3MSAtIHgwICogeDEgLSB5MCAqIHkxIC0gejAgKiB6MTsKCgkJcmV0dXJuIGRzdDsKCgl9CgoJZ2V0IHgoKSB7CgoJCXJldHVybiB0aGlzLl94OwoKCX0KCglzZXQgeCggdmFsdWUgKSB7CgoJCXRoaXMuX3ggPSB2YWx1ZTsKCQl0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CgoJfQoKCWdldCB5KCkgewoKCQlyZXR1cm4gdGhpcy5feTsKCgl9CgoJc2V0IHkoIHZhbHVlICkgewoKCQl0aGlzLl95ID0gdmFsdWU7CgkJdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwoKCX0KCglnZXQgeigpIHsKCgkJcmV0dXJuIHRoaXMuX3o7CgoJfQoKCXNldCB6KCB2YWx1ZSApIHsKCgkJdGhpcy5feiA9IHZhbHVlOwoJCXRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKCgl9CgoJZ2V0IHcoKSB7CgoJCXJldHVybiB0aGlzLl93OwoKCX0KCglzZXQgdyggdmFsdWUgKSB7CgoJCXRoaXMuX3cgPSB2YWx1ZTsKCQl0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CgoJfQoKCXNldCggeCwgeSwgeiwgdyApIHsKCgkJdGhpcy5feCA9IHg7CgkJdGhpcy5feSA9IHk7CgkJdGhpcy5feiA9IHo7CgkJdGhpcy5fdyA9IHc7CgoJCXRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoIHRoaXMuX3gsIHRoaXMuX3ksIHRoaXMuX3osIHRoaXMuX3cgKTsKCgl9CgoJY29weSggcXVhdGVybmlvbiApIHsKCgkJdGhpcy5feCA9IHF1YXRlcm5pb24ueDsKCQl0aGlzLl95ID0gcXVhdGVybmlvbi55OwoJCXRoaXMuX3ogPSBxdWF0ZXJuaW9uLno7CgkJdGhpcy5fdyA9IHF1YXRlcm5pb24udzsKCgkJdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbUV1bGVyKCBldWxlciwgdXBkYXRlID0gdHJ1ZSApIHsKCgkJY29uc3QgeCA9IGV1bGVyLl94LCB5ID0gZXVsZXIuX3ksIHogPSBldWxlci5feiwgb3JkZXIgPSBldWxlci5fb3JkZXI7CgoJCS8vIGh0dHA6Ly93d3cubWF0aHdvcmtzLmNvbS9tYXRsYWJjZW50cmFsL2ZpbGVleGNoYW5nZS8KCQkvLyAJMjA2OTYtZnVuY3Rpb24tdG8tY29udmVydC1iZXR3ZWVuLWRjbS1ldWxlci1hbmdsZXMtcXVhdGVybmlvbnMtYW5kLWV1bGVyLXZlY3RvcnMvCgkJLy8JY29udGVudC9TcGluQ2FsYy5tCgoJCWNvbnN0IGNvcyA9IE1hdGguY29zOwoJCWNvbnN0IHNpbiA9IE1hdGguc2luOwoKCQljb25zdCBjMSA9IGNvcyggeCAvIDIgKTsKCQljb25zdCBjMiA9IGNvcyggeSAvIDIgKTsKCQljb25zdCBjMyA9IGNvcyggeiAvIDIgKTsKCgkJY29uc3QgczEgPSBzaW4oIHggLyAyICk7CgkJY29uc3QgczIgPSBzaW4oIHkgLyAyICk7CgkJY29uc3QgczMgPSBzaW4oIHogLyAyICk7CgoJCXN3aXRjaCAoIG9yZGVyICkgewoKCQkJY2FzZSAnWFlaJzoKCQkJCXRoaXMuX3ggPSBzMSAqIGMyICogYzMgKyBjMSAqIHMyICogczM7CgkJCQl0aGlzLl95ID0gYzEgKiBzMiAqIGMzIC0gczEgKiBjMiAqIHMzOwoJCQkJdGhpcy5feiA9IGMxICogYzIgKiBzMyArIHMxICogczIgKiBjMzsKCQkJCXRoaXMuX3cgPSBjMSAqIGMyICogYzMgLSBzMSAqIHMyICogczM7CgkJCQlicmVhazsKCgkJCWNhc2UgJ1lYWic6CgkJCQl0aGlzLl94ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwoJCQkJdGhpcy5feSA9IGMxICogczIgKiBjMyAtIHMxICogYzIgKiBzMzsKCQkJCXRoaXMuX3ogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CgkJCQl0aGlzLl93ID0gYzEgKiBjMiAqIGMzICsgczEgKiBzMiAqIHMzOwoJCQkJYnJlYWs7CgoJCQljYXNlICdaWFknOgoJCQkJdGhpcy5feCA9IHMxICogYzIgKiBjMyAtIGMxICogczIgKiBzMzsKCQkJCXRoaXMuX3kgPSBjMSAqIHMyICogYzMgKyBzMSAqIGMyICogczM7CgkJCQl0aGlzLl96ID0gYzEgKiBjMiAqIHMzICsgczEgKiBzMiAqIGMzOwoJCQkJdGhpcy5fdyA9IGMxICogYzIgKiBjMyAtIHMxICogczIgKiBzMzsKCQkJCWJyZWFrOwoKCQkJY2FzZSAnWllYJzoKCQkJCXRoaXMuX3ggPSBzMSAqIGMyICogYzMgLSBjMSAqIHMyICogczM7CgkJCQl0aGlzLl95ID0gYzEgKiBzMiAqIGMzICsgczEgKiBjMiAqIHMzOwoJCQkJdGhpcy5feiA9IGMxICogYzIgKiBzMyAtIHMxICogczIgKiBjMzsKCQkJCXRoaXMuX3cgPSBjMSAqIGMyICogYzMgKyBzMSAqIHMyICogczM7CgkJCQlicmVhazsKCgkJCWNhc2UgJ1laWCc6CgkJCQl0aGlzLl94ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwoJCQkJdGhpcy5feSA9IGMxICogczIgKiBjMyArIHMxICogYzIgKiBzMzsKCQkJCXRoaXMuX3ogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CgkJCQl0aGlzLl93ID0gYzEgKiBjMiAqIGMzIC0gczEgKiBzMiAqIHMzOwoJCQkJYnJlYWs7CgoJCQljYXNlICdYWlknOgoJCQkJdGhpcy5feCA9IHMxICogYzIgKiBjMyAtIGMxICogczIgKiBzMzsKCQkJCXRoaXMuX3kgPSBjMSAqIHMyICogYzMgLSBzMSAqIGMyICogczM7CgkJCQl0aGlzLl96ID0gYzEgKiBjMiAqIHMzICsgczEgKiBzMiAqIGMzOwoJCQkJdGhpcy5fdyA9IGMxICogYzIgKiBjMyArIHMxICogczIgKiBzMzsKCQkJCWJyZWFrOwoKCQkJZGVmYXVsdDoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLlF1YXRlcm5pb246IC5zZXRGcm9tRXVsZXIoKSBlbmNvdW50ZXJlZCBhbiB1bmtub3duIG9yZGVyOiAnICsgb3JkZXIgKTsKCgkJfQoKCQlpZiAoIHVwZGF0ZSA9PT0gdHJ1ZSApIHRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEZyb21BeGlzQW5nbGUoIGF4aXMsIGFuZ2xlICkgewoKCQkvLyBodHRwOi8vd3d3LmV1Y2xpZGVhbnNwYWNlLmNvbS9tYXRocy9nZW9tZXRyeS9yb3RhdGlvbnMvY29udmVyc2lvbnMvYW5nbGVUb1F1YXRlcm5pb24vaW5kZXguaHRtCgoJCS8vIGFzc3VtZXMgYXhpcyBpcyBub3JtYWxpemVkCgoJCWNvbnN0IGhhbGZBbmdsZSA9IGFuZ2xlIC8gMiwgcyA9IE1hdGguc2luKCBoYWxmQW5nbGUgKTsKCgkJdGhpcy5feCA9IGF4aXMueCAqIHM7CgkJdGhpcy5feSA9IGF4aXMueSAqIHM7CgkJdGhpcy5feiA9IGF4aXMueiAqIHM7CgkJdGhpcy5fdyA9IE1hdGguY29zKCBoYWxmQW5nbGUgKTsKCgkJdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbVJvdGF0aW9uTWF0cml4KCBtICkgewoKCQkvLyBodHRwOi8vd3d3LmV1Y2xpZGVhbnNwYWNlLmNvbS9tYXRocy9nZW9tZXRyeS9yb3RhdGlvbnMvY29udmVyc2lvbnMvbWF0cml4VG9RdWF0ZXJuaW9uL2luZGV4Lmh0bQoKCQkvLyBhc3N1bWVzIHRoZSB1cHBlciAzeDMgb2YgbSBpcyBhIHB1cmUgcm90YXRpb24gbWF0cml4IChpLmUsIHVuc2NhbGVkKQoKCQljb25zdCB0ZSA9IG0uZWxlbWVudHMsCgoJCQltMTEgPSB0ZVsgMCBdLCBtMTIgPSB0ZVsgNCBdLCBtMTMgPSB0ZVsgOCBdLAoJCQltMjEgPSB0ZVsgMSBdLCBtMjIgPSB0ZVsgNSBdLCBtMjMgPSB0ZVsgOSBdLAoJCQltMzEgPSB0ZVsgMiBdLCBtMzIgPSB0ZVsgNiBdLCBtMzMgPSB0ZVsgMTAgXSwKCgkJCXRyYWNlID0gbTExICsgbTIyICsgbTMzOwoKCQlpZiAoIHRyYWNlID4gMCApIHsKCgkJCWNvbnN0IHMgPSAwLjUgLyBNYXRoLnNxcnQoIHRyYWNlICsgMS4wICk7CgoJCQl0aGlzLl93ID0gMC4yNSAvIHM7CgkJCXRoaXMuX3ggPSAoIG0zMiAtIG0yMyApICogczsKCQkJdGhpcy5feSA9ICggbTEzIC0gbTMxICkgKiBzOwoJCQl0aGlzLl96ID0gKCBtMjEgLSBtMTIgKSAqIHM7CgoJCX0gZWxzZSBpZiAoIG0xMSA+IG0yMiAmJiBtMTEgPiBtMzMgKSB7CgoJCQljb25zdCBzID0gMi4wICogTWF0aC5zcXJ0KCAxLjAgKyBtMTEgLSBtMjIgLSBtMzMgKTsKCgkJCXRoaXMuX3cgPSAoIG0zMiAtIG0yMyApIC8gczsKCQkJdGhpcy5feCA9IDAuMjUgKiBzOwoJCQl0aGlzLl95ID0gKCBtMTIgKyBtMjEgKSAvIHM7CgkJCXRoaXMuX3ogPSAoIG0xMyArIG0zMSApIC8gczsKCgkJfSBlbHNlIGlmICggbTIyID4gbTMzICkgewoKCQkJY29uc3QgcyA9IDIuMCAqIE1hdGguc3FydCggMS4wICsgbTIyIC0gbTExIC0gbTMzICk7CgoJCQl0aGlzLl93ID0gKCBtMTMgLSBtMzEgKSAvIHM7CgkJCXRoaXMuX3ggPSAoIG0xMiArIG0yMSApIC8gczsKCQkJdGhpcy5feSA9IDAuMjUgKiBzOwoJCQl0aGlzLl96ID0gKCBtMjMgKyBtMzIgKSAvIHM7CgoJCX0gZWxzZSB7CgoJCQljb25zdCBzID0gMi4wICogTWF0aC5zcXJ0KCAxLjAgKyBtMzMgLSBtMTEgLSBtMjIgKTsKCgkJCXRoaXMuX3cgPSAoIG0yMSAtIG0xMiApIC8gczsKCQkJdGhpcy5feCA9ICggbTEzICsgbTMxICkgLyBzOwoJCQl0aGlzLl95ID0gKCBtMjMgKyBtMzIgKSAvIHM7CgkJCXRoaXMuX3ogPSAwLjI1ICogczsKCgkJfQoKCQl0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tVW5pdFZlY3RvcnMoIHZGcm9tLCB2VG8gKSB7CgoJCS8vIGFzc3VtZXMgZGlyZWN0aW9uIHZlY3RvcnMgdkZyb20gYW5kIHZUbyBhcmUgbm9ybWFsaXplZAoKCQlsZXQgciA9IHZGcm9tLmRvdCggdlRvICkgKyAxOwoKCQlpZiAoIHIgPCBOdW1iZXIuRVBTSUxPTiApIHsKCgkJCS8vIHZGcm9tIGFuZCB2VG8gcG9pbnQgaW4gb3Bwb3NpdGUgZGlyZWN0aW9ucwoKCQkJciA9IDA7CgoJCQlpZiAoIE1hdGguYWJzKCB2RnJvbS54ICkgPiBNYXRoLmFicyggdkZyb20ueiApICkgewoKCQkJCXRoaXMuX3ggPSAtIHZGcm9tLnk7CgkJCQl0aGlzLl95ID0gdkZyb20ueDsKCQkJCXRoaXMuX3ogPSAwOwoJCQkJdGhpcy5fdyA9IHI7CgoJCQl9IGVsc2UgewoKCQkJCXRoaXMuX3ggPSAwOwoJCQkJdGhpcy5feSA9IC0gdkZyb20uejsKCQkJCXRoaXMuX3ogPSB2RnJvbS55OwoJCQkJdGhpcy5fdyA9IHI7CgoJCQl9CgoJCX0gZWxzZSB7CgoJCQkvLyBjcm9zc1ZlY3RvcnMoIHZGcm9tLCB2VG8gKTsgLy8gaW5saW5lZCB0byBhdm9pZCBjeWNsaWMgZGVwZW5kZW5jeSBvbiBWZWN0b3IzCgoJCQl0aGlzLl94ID0gdkZyb20ueSAqIHZUby56IC0gdkZyb20ueiAqIHZUby55OwoJCQl0aGlzLl95ID0gdkZyb20ueiAqIHZUby54IC0gdkZyb20ueCAqIHZUby56OwoJCQl0aGlzLl96ID0gdkZyb20ueCAqIHZUby55IC0gdkZyb20ueSAqIHZUby54OwoJCQl0aGlzLl93ID0gcjsKCgkJfQoKCQlyZXR1cm4gdGhpcy5ub3JtYWxpemUoKTsKCgl9CgoJYW5nbGVUbyggcSApIHsKCgkJcmV0dXJuIDIgKiBNYXRoLmFjb3MoIE1hdGguYWJzKCBjbGFtcCggdGhpcy5kb3QoIHEgKSwgLSAxLCAxICkgKSApOwoKCX0KCglyb3RhdGVUb3dhcmRzKCBxLCBzdGVwICkgewoKCQljb25zdCBhbmdsZSA9IHRoaXMuYW5nbGVUbyggcSApOwoKCQlpZiAoIGFuZ2xlID09PSAwICkgcmV0dXJuIHRoaXM7CgoJCWNvbnN0IHQgPSBNYXRoLm1pbiggMSwgc3RlcCAvIGFuZ2xlICk7CgoJCXRoaXMuc2xlcnAoIHEsIHQgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWlkZW50aXR5KCkgewoKCQlyZXR1cm4gdGhpcy5zZXQoIDAsIDAsIDAsIDEgKTsKCgl9CgoJaW52ZXJ0KCkgewoKCQkvLyBxdWF0ZXJuaW9uIGlzIGFzc3VtZWQgdG8gaGF2ZSB1bml0IGxlbmd0aAoKCQlyZXR1cm4gdGhpcy5jb25qdWdhdGUoKTsKCgl9CgoJY29uanVnYXRlKCkgewoKCQl0aGlzLl94ICo9IC0gMTsKCQl0aGlzLl95ICo9IC0gMTsKCQl0aGlzLl96ICo9IC0gMTsKCgkJdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZG90KCB2ICkgewoKCQlyZXR1cm4gdGhpcy5feCAqIHYuX3ggKyB0aGlzLl95ICogdi5feSArIHRoaXMuX3ogKiB2Ll96ICsgdGhpcy5fdyAqIHYuX3c7CgoJfQoKCWxlbmd0aFNxKCkgewoKCQlyZXR1cm4gdGhpcy5feCAqIHRoaXMuX3ggKyB0aGlzLl95ICogdGhpcy5feSArIHRoaXMuX3ogKiB0aGlzLl96ICsgdGhpcy5fdyAqIHRoaXMuX3c7CgoJfQoKCWxlbmd0aCgpIHsKCgkJcmV0dXJuIE1hdGguc3FydCggdGhpcy5feCAqIHRoaXMuX3ggKyB0aGlzLl95ICogdGhpcy5feSArIHRoaXMuX3ogKiB0aGlzLl96ICsgdGhpcy5fdyAqIHRoaXMuX3cgKTsKCgl9CgoJbm9ybWFsaXplKCkgewoKCQlsZXQgbCA9IHRoaXMubGVuZ3RoKCk7CgoJCWlmICggbCA9PT0gMCApIHsKCgkJCXRoaXMuX3ggPSAwOwoJCQl0aGlzLl95ID0gMDsKCQkJdGhpcy5feiA9IDA7CgkJCXRoaXMuX3cgPSAxOwoKCQl9IGVsc2UgewoKCQkJbCA9IDEgLyBsOwoKCQkJdGhpcy5feCA9IHRoaXMuX3ggKiBsOwoJCQl0aGlzLl95ID0gdGhpcy5feSAqIGw7CgkJCXRoaXMuX3ogPSB0aGlzLl96ICogbDsKCQkJdGhpcy5fdyA9IHRoaXMuX3cgKiBsOwoKCQl9CgoJCXRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW11bHRpcGx5KCBxICkgewoKCQlyZXR1cm4gdGhpcy5tdWx0aXBseVF1YXRlcm5pb25zKCB0aGlzLCBxICk7CgoJfQoKCXByZW11bHRpcGx5KCBxICkgewoKCQlyZXR1cm4gdGhpcy5tdWx0aXBseVF1YXRlcm5pb25zKCBxLCB0aGlzICk7CgoJfQoKCW11bHRpcGx5UXVhdGVybmlvbnMoIGEsIGIgKSB7CgoJCS8vIGZyb20gaHR0cDovL3d3dy5ldWNsaWRlYW5zcGFjZS5jb20vbWF0aHMvYWxnZWJyYS9yZWFsTm9ybWVkQWxnZWJyYS9xdWF0ZXJuaW9ucy9jb2RlL2luZGV4Lmh0bQoKCQljb25zdCBxYXggPSBhLl94LCBxYXkgPSBhLl95LCBxYXogPSBhLl96LCBxYXcgPSBhLl93OwoJCWNvbnN0IHFieCA9IGIuX3gsIHFieSA9IGIuX3ksIHFieiA9IGIuX3osIHFidyA9IGIuX3c7CgoJCXRoaXMuX3ggPSBxYXggKiBxYncgKyBxYXcgKiBxYnggKyBxYXkgKiBxYnogLSBxYXogKiBxYnk7CgkJdGhpcy5feSA9IHFheSAqIHFidyArIHFhdyAqIHFieSArIHFheiAqIHFieCAtIHFheCAqIHFiejsKCQl0aGlzLl96ID0gcWF6ICogcWJ3ICsgcWF3ICogcWJ6ICsgcWF4ICogcWJ5IC0gcWF5ICogcWJ4OwoJCXRoaXMuX3cgPSBxYXcgKiBxYncgLSBxYXggKiBxYnggLSBxYXkgKiBxYnkgLSBxYXogKiBxYno7CgoJCXRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNsZXJwKCBxYiwgdCApIHsKCgkJaWYgKCB0ID09PSAwICkgcmV0dXJuIHRoaXM7CgkJaWYgKCB0ID09PSAxICkgcmV0dXJuIHRoaXMuY29weSggcWIgKTsKCgkJY29uc3QgeCA9IHRoaXMuX3gsIHkgPSB0aGlzLl95LCB6ID0gdGhpcy5feiwgdyA9IHRoaXMuX3c7CgoJCS8vIGh0dHA6Ly93d3cuZXVjbGlkZWFuc3BhY2UuY29tL21hdGhzL2FsZ2VicmEvcmVhbE5vcm1lZEFsZ2VicmEvcXVhdGVybmlvbnMvc2xlcnAvCgoJCWxldCBjb3NIYWxmVGhldGEgPSB3ICogcWIuX3cgKyB4ICogcWIuX3ggKyB5ICogcWIuX3kgKyB6ICogcWIuX3o7CgoJCWlmICggY29zSGFsZlRoZXRhIDwgMCApIHsKCgkJCXRoaXMuX3cgPSAtIHFiLl93OwoJCQl0aGlzLl94ID0gLSBxYi5feDsKCQkJdGhpcy5feSA9IC0gcWIuX3k7CgkJCXRoaXMuX3ogPSAtIHFiLl96OwoKCQkJY29zSGFsZlRoZXRhID0gLSBjb3NIYWxmVGhldGE7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLmNvcHkoIHFiICk7CgoJCX0KCgkJaWYgKCBjb3NIYWxmVGhldGEgPj0gMS4wICkgewoKCQkJdGhpcy5fdyA9IHc7CgkJCXRoaXMuX3ggPSB4OwoJCQl0aGlzLl95ID0geTsKCQkJdGhpcy5feiA9IHo7CgoJCQlyZXR1cm4gdGhpczsKCgkJfQoKCQljb25zdCBzcXJTaW5IYWxmVGhldGEgPSAxLjAgLSBjb3NIYWxmVGhldGEgKiBjb3NIYWxmVGhldGE7CgoJCWlmICggc3FyU2luSGFsZlRoZXRhIDw9IE51bWJlci5FUFNJTE9OICkgewoKCQkJY29uc3QgcyA9IDEgLSB0OwoJCQl0aGlzLl93ID0gcyAqIHcgKyB0ICogdGhpcy5fdzsKCQkJdGhpcy5feCA9IHMgKiB4ICsgdCAqIHRoaXMuX3g7CgkJCXRoaXMuX3kgPSBzICogeSArIHQgKiB0aGlzLl95OwoJCQl0aGlzLl96ID0gcyAqIHogKyB0ICogdGhpcy5fejsKCgkJCXRoaXMubm9ybWFsaXplKCk7IC8vIG5vcm1hbGl6ZSBjYWxscyBfb25DaGFuZ2VDYWxsYmFjaygpCgoJCQlyZXR1cm4gdGhpczsKCgkJfQoKCQljb25zdCBzaW5IYWxmVGhldGEgPSBNYXRoLnNxcnQoIHNxclNpbkhhbGZUaGV0YSApOwoJCWNvbnN0IGhhbGZUaGV0YSA9IE1hdGguYXRhbjIoIHNpbkhhbGZUaGV0YSwgY29zSGFsZlRoZXRhICk7CgkJY29uc3QgcmF0aW9BID0gTWF0aC5zaW4oICggMSAtIHQgKSAqIGhhbGZUaGV0YSApIC8gc2luSGFsZlRoZXRhLAoJCQlyYXRpb0IgPSBNYXRoLnNpbiggdCAqIGhhbGZUaGV0YSApIC8gc2luSGFsZlRoZXRhOwoKCQl0aGlzLl93ID0gKCB3ICogcmF0aW9BICsgdGhpcy5fdyAqIHJhdGlvQiApOwoJCXRoaXMuX3ggPSAoIHggKiByYXRpb0EgKyB0aGlzLl94ICogcmF0aW9CICk7CgkJdGhpcy5feSA9ICggeSAqIHJhdGlvQSArIHRoaXMuX3kgKiByYXRpb0IgKTsKCQl0aGlzLl96ID0gKCB6ICogcmF0aW9BICsgdGhpcy5feiAqIHJhdGlvQiApOwoKCQl0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzbGVycFF1YXRlcm5pb25zKCBxYSwgcWIsIHQgKSB7CgoJCXJldHVybiB0aGlzLmNvcHkoIHFhICkuc2xlcnAoIHFiLCB0ICk7CgoJfQoKCXJhbmRvbSgpIHsKCgkJLy8gRGVyaXZlZCBmcm9tIGh0dHA6Ly9wbGFubmluZy5jcy51aXVjLmVkdS9ub2RlMTk4Lmh0bWwKCQkvLyBOb3RlLCB0aGlzIHNvdXJjZSB1c2VzIHcsIHgsIHksIHogb3JkZXJpbmcsCgkJLy8gc28gd2Ugc3dhcCB0aGUgb3JkZXIgYmVsb3cuCgoJCWNvbnN0IHUxID0gTWF0aC5yYW5kb20oKTsKCQljb25zdCBzcXJ0MXUxID0gTWF0aC5zcXJ0KCAxIC0gdTEgKTsKCQljb25zdCBzcXJ0dTEgPSBNYXRoLnNxcnQoIHUxICk7CgoJCWNvbnN0IHUyID0gMiAqIE1hdGguUEkgKiBNYXRoLnJhbmRvbSgpOwoKCQljb25zdCB1MyA9IDIgKiBNYXRoLlBJICogTWF0aC5yYW5kb20oKTsKCgkJcmV0dXJuIHRoaXMuc2V0KAoJCQlzcXJ0MXUxICogTWF0aC5jb3MoIHUyICksCgkJCXNxcnR1MSAqIE1hdGguc2luKCB1MyApLAoJCQlzcXJ0dTEgKiBNYXRoLmNvcyggdTMgKSwKCQkJc3FydDF1MSAqIE1hdGguc2luKCB1MiApLAoJCSk7CgoJfQoKCWVxdWFscyggcXVhdGVybmlvbiApIHsKCgkJcmV0dXJuICggcXVhdGVybmlvbi5feCA9PT0gdGhpcy5feCApICYmICggcXVhdGVybmlvbi5feSA9PT0gdGhpcy5feSApICYmICggcXVhdGVybmlvbi5feiA9PT0gdGhpcy5feiApICYmICggcXVhdGVybmlvbi5fdyA9PT0gdGhpcy5fdyApOwoKCX0KCglmcm9tQXJyYXkoIGFycmF5LCBvZmZzZXQgPSAwICkgewoKCQl0aGlzLl94ID0gYXJyYXlbIG9mZnNldCBdOwoJCXRoaXMuX3kgPSBhcnJheVsgb2Zmc2V0ICsgMSBdOwoJCXRoaXMuX3ogPSBhcnJheVsgb2Zmc2V0ICsgMiBdOwoJCXRoaXMuX3cgPSBhcnJheVsgb2Zmc2V0ICsgMyBdOwoKCQl0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0FycmF5KCBhcnJheSA9IFtdLCBvZmZzZXQgPSAwICkgewoKCQlhcnJheVsgb2Zmc2V0IF0gPSB0aGlzLl94OwoJCWFycmF5WyBvZmZzZXQgKyAxIF0gPSB0aGlzLl95OwoJCWFycmF5WyBvZmZzZXQgKyAyIF0gPSB0aGlzLl96OwoJCWFycmF5WyBvZmZzZXQgKyAzIF0gPSB0aGlzLl93OwoKCQlyZXR1cm4gYXJyYXk7CgoJfQoKCWZyb21CdWZmZXJBdHRyaWJ1dGUoIGF0dHJpYnV0ZSwgaW5kZXggKSB7CgoJCXRoaXMuX3ggPSBhdHRyaWJ1dGUuZ2V0WCggaW5kZXggKTsKCQl0aGlzLl95ID0gYXR0cmlidXRlLmdldFkoIGluZGV4ICk7CgkJdGhpcy5feiA9IGF0dHJpYnV0ZS5nZXRaKCBpbmRleCApOwoJCXRoaXMuX3cgPSBhdHRyaWJ1dGUuZ2V0VyggaW5kZXggKTsKCgkJdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCkgewoKCQlyZXR1cm4gdGhpcy50b0FycmF5KCk7CgoJfQoKCV9vbkNoYW5nZSggY2FsbGJhY2sgKSB7CgoJCXRoaXMuX29uQ2hhbmdlQ2FsbGJhY2sgPSBjYWxsYmFjazsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCV9vbkNoYW5nZUNhbGxiYWNrKCkge30KCgkqWyBTeW1ib2wuaXRlcmF0b3IgXSgpIHsKCgkJeWllbGQgdGhpcy5feDsKCQl5aWVsZCB0aGlzLl95OwoJCXlpZWxkIHRoaXMuX3o7CgkJeWllbGQgdGhpcy5fdzsKCgl9Cgp9CgpjbGFzcyBWZWN0b3IzIHsKCgljb25zdHJ1Y3RvciggeCA9IDAsIHkgPSAwLCB6ID0gMCApIHsKCgkJVmVjdG9yMy5wcm90b3R5cGUuaXNWZWN0b3IzID0gdHJ1ZTsKCgkJdGhpcy54ID0geDsKCQl0aGlzLnkgPSB5OwoJCXRoaXMueiA9IHo7CgoJfQoKCXNldCggeCwgeSwgeiApIHsKCgkJaWYgKCB6ID09PSB1bmRlZmluZWQgKSB6ID0gdGhpcy56OyAvLyBzcHJpdGUuc2NhbGUuc2V0KHgseSkKCgkJdGhpcy54ID0geDsKCQl0aGlzLnkgPSB5OwoJCXRoaXMueiA9IHo7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRTY2FsYXIoIHNjYWxhciApIHsKCgkJdGhpcy54ID0gc2NhbGFyOwoJCXRoaXMueSA9IHNjYWxhcjsKCQl0aGlzLnogPSBzY2FsYXI7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRYKCB4ICkgewoKCQl0aGlzLnggPSB4OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0WSggeSApIHsKCgkJdGhpcy55ID0geTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFooIHogKSB7CgoJCXRoaXMueiA9IHo7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRDb21wb25lbnQoIGluZGV4LCB2YWx1ZSApIHsKCgkJc3dpdGNoICggaW5kZXggKSB7CgoJCQljYXNlIDA6IHRoaXMueCA9IHZhbHVlOyBicmVhazsKCQkJY2FzZSAxOiB0aGlzLnkgPSB2YWx1ZTsgYnJlYWs7CgkJCWNhc2UgMjogdGhpcy56ID0gdmFsdWU7IGJyZWFrOwoJCQlkZWZhdWx0OiB0aHJvdyBuZXcgRXJyb3IoICdpbmRleCBpcyBvdXQgb2YgcmFuZ2U6ICcgKyBpbmRleCApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRDb21wb25lbnQoIGluZGV4ICkgewoKCQlzd2l0Y2ggKCBpbmRleCApIHsKCgkJCWNhc2UgMDogcmV0dXJuIHRoaXMueDsKCQkJY2FzZSAxOiByZXR1cm4gdGhpcy55OwoJCQljYXNlIDI6IHJldHVybiB0aGlzLno7CgkJCWRlZmF1bHQ6IHRocm93IG5ldyBFcnJvciggJ2luZGV4IGlzIG91dCBvZiByYW5nZTogJyArIGluZGV4ICk7CgoJCX0KCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvciggdGhpcy54LCB0aGlzLnksIHRoaXMueiApOwoKCX0KCgljb3B5KCB2ICkgewoKCQl0aGlzLnggPSB2Lng7CgkJdGhpcy55ID0gdi55OwoJCXRoaXMueiA9IHYuejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFkZCggdiApIHsKCgkJdGhpcy54ICs9IHYueDsKCQl0aGlzLnkgKz0gdi55OwoJCXRoaXMueiArPSB2Lno7CgoJCXJldHVybiB0aGlzOwoKCX0KCglhZGRTY2FsYXIoIHMgKSB7CgoJCXRoaXMueCArPSBzOwoJCXRoaXMueSArPSBzOwoJCXRoaXMueiArPSBzOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJYWRkVmVjdG9ycyggYSwgYiApIHsKCgkJdGhpcy54ID0gYS54ICsgYi54OwoJCXRoaXMueSA9IGEueSArIGIueTsKCQl0aGlzLnogPSBhLnogKyBiLno7CgoJCXJldHVybiB0aGlzOwoKCX0KCglhZGRTY2FsZWRWZWN0b3IoIHYsIHMgKSB7CgoJCXRoaXMueCArPSB2LnggKiBzOwoJCXRoaXMueSArPSB2LnkgKiBzOwoJCXRoaXMueiArPSB2LnogKiBzOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3ViKCB2ICkgewoKCQl0aGlzLnggLT0gdi54OwoJCXRoaXMueSAtPSB2Lnk7CgkJdGhpcy56IC09IHYuejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXN1YlNjYWxhciggcyApIHsKCgkJdGhpcy54IC09IHM7CgkJdGhpcy55IC09IHM7CgkJdGhpcy56IC09IHM7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzdWJWZWN0b3JzKCBhLCBiICkgewoKCQl0aGlzLnggPSBhLnggLSBiLng7CgkJdGhpcy55ID0gYS55IC0gYi55OwoJCXRoaXMueiA9IGEueiAtIGIuejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW11bHRpcGx5KCB2ICkgewoKCQl0aGlzLnggKj0gdi54OwoJCXRoaXMueSAqPSB2Lnk7CgkJdGhpcy56ICo9IHYuejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW11bHRpcGx5U2NhbGFyKCBzY2FsYXIgKSB7CgoJCXRoaXMueCAqPSBzY2FsYXI7CgkJdGhpcy55ICo9IHNjYWxhcjsKCQl0aGlzLnogKj0gc2NhbGFyOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbXVsdGlwbHlWZWN0b3JzKCBhLCBiICkgewoKCQl0aGlzLnggPSBhLnggKiBiLng7CgkJdGhpcy55ID0gYS55ICogYi55OwoJCXRoaXMueiA9IGEueiAqIGIuejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFwcGx5RXVsZXIoIGV1bGVyICkgewoKCQlyZXR1cm4gdGhpcy5hcHBseVF1YXRlcm5pb24oIF9xdWF0ZXJuaW9uJDQuc2V0RnJvbUV1bGVyKCBldWxlciApICk7CgoJfQoKCWFwcGx5QXhpc0FuZ2xlKCBheGlzLCBhbmdsZSApIHsKCgkJcmV0dXJuIHRoaXMuYXBwbHlRdWF0ZXJuaW9uKCBfcXVhdGVybmlvbiQ0LnNldEZyb21BeGlzQW5nbGUoIGF4aXMsIGFuZ2xlICkgKTsKCgl9CgoJYXBwbHlNYXRyaXgzKCBtICkgewoKCQljb25zdCB4ID0gdGhpcy54LCB5ID0gdGhpcy55LCB6ID0gdGhpcy56OwoJCWNvbnN0IGUgPSBtLmVsZW1lbnRzOwoKCQl0aGlzLnggPSBlWyAwIF0gKiB4ICsgZVsgMyBdICogeSArIGVbIDYgXSAqIHo7CgkJdGhpcy55ID0gZVsgMSBdICogeCArIGVbIDQgXSAqIHkgKyBlWyA3IF0gKiB6OwoJCXRoaXMueiA9IGVbIDIgXSAqIHggKyBlWyA1IF0gKiB5ICsgZVsgOCBdICogejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFwcGx5Tm9ybWFsTWF0cml4KCBtICkgewoKCQlyZXR1cm4gdGhpcy5hcHBseU1hdHJpeDMoIG0gKS5ub3JtYWxpemUoKTsKCgl9CgoJYXBwbHlNYXRyaXg0KCBtICkgewoKCQljb25zdCB4ID0gdGhpcy54LCB5ID0gdGhpcy55LCB6ID0gdGhpcy56OwoJCWNvbnN0IGUgPSBtLmVsZW1lbnRzOwoKCQljb25zdCB3ID0gMSAvICggZVsgMyBdICogeCArIGVbIDcgXSAqIHkgKyBlWyAxMSBdICogeiArIGVbIDE1IF0gKTsKCgkJdGhpcy54ID0gKCBlWyAwIF0gKiB4ICsgZVsgNCBdICogeSArIGVbIDggXSAqIHogKyBlWyAxMiBdICkgKiB3OwoJCXRoaXMueSA9ICggZVsgMSBdICogeCArIGVbIDUgXSAqIHkgKyBlWyA5IF0gKiB6ICsgZVsgMTMgXSApICogdzsKCQl0aGlzLnogPSAoIGVbIDIgXSAqIHggKyBlWyA2IF0gKiB5ICsgZVsgMTAgXSAqIHogKyBlWyAxNCBdICkgKiB3OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJYXBwbHlRdWF0ZXJuaW9uKCBxICkgewoKCQkvLyBxdWF0ZXJuaW9uIHEgaXMgYXNzdW1lZCB0byBoYXZlIHVuaXQgbGVuZ3RoCgoJCWNvbnN0IHZ4ID0gdGhpcy54LCB2eSA9IHRoaXMueSwgdnogPSB0aGlzLno7CgkJY29uc3QgcXggPSBxLngsIHF5ID0gcS55LCBxeiA9IHEueiwgcXcgPSBxLnc7CgoJCS8vIHQgPSAyICogY3Jvc3MoIHEueHl6LCB2ICk7CgkJY29uc3QgdHggPSAyICogKCBxeSAqIHZ6IC0gcXogKiB2eSApOwoJCWNvbnN0IHR5ID0gMiAqICggcXogKiB2eCAtIHF4ICogdnogKTsKCQljb25zdCB0eiA9IDIgKiAoIHF4ICogdnkgLSBxeSAqIHZ4ICk7CgoJCS8vIHYgKyBxLncgKiB0ICsgY3Jvc3MoIHEueHl6LCB0ICk7CgkJdGhpcy54ID0gdnggKyBxdyAqIHR4ICsgcXkgKiB0eiAtIHF6ICogdHk7CgkJdGhpcy55ID0gdnkgKyBxdyAqIHR5ICsgcXogKiB0eCAtIHF4ICogdHo7CgkJdGhpcy56ID0gdnogKyBxdyAqIHR6ICsgcXggKiB0eSAtIHF5ICogdHg7CgoJCXJldHVybiB0aGlzOwoKCX0KCglwcm9qZWN0KCBjYW1lcmEgKSB7CgoJCXJldHVybiB0aGlzLmFwcGx5TWF0cml4NCggY2FtZXJhLm1hdHJpeFdvcmxkSW52ZXJzZSApLmFwcGx5TWF0cml4NCggY2FtZXJhLnByb2plY3Rpb25NYXRyaXggKTsKCgl9CgoJdW5wcm9qZWN0KCBjYW1lcmEgKSB7CgoJCXJldHVybiB0aGlzLmFwcGx5TWF0cml4NCggY2FtZXJhLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlICkuYXBwbHlNYXRyaXg0KCBjYW1lcmEubWF0cml4V29ybGQgKTsKCgl9CgoJdHJhbnNmb3JtRGlyZWN0aW9uKCBtICkgewoKCQkvLyBpbnB1dDogVEhSRUUuTWF0cml4NCBhZmZpbmUgbWF0cml4CgkJLy8gdmVjdG9yIGludGVycHJldGVkIGFzIGEgZGlyZWN0aW9uCgoJCWNvbnN0IHggPSB0aGlzLngsIHkgPSB0aGlzLnksIHogPSB0aGlzLno7CgkJY29uc3QgZSA9IG0uZWxlbWVudHM7CgoJCXRoaXMueCA9IGVbIDAgXSAqIHggKyBlWyA0IF0gKiB5ICsgZVsgOCBdICogejsKCQl0aGlzLnkgPSBlWyAxIF0gKiB4ICsgZVsgNSBdICogeSArIGVbIDkgXSAqIHo7CgkJdGhpcy56ID0gZVsgMiBdICogeCArIGVbIDYgXSAqIHkgKyBlWyAxMCBdICogejsKCgkJcmV0dXJuIHRoaXMubm9ybWFsaXplKCk7CgoJfQoKCWRpdmlkZSggdiApIHsKCgkJdGhpcy54IC89IHYueDsKCQl0aGlzLnkgLz0gdi55OwoJCXRoaXMueiAvPSB2Lno7CgoJCXJldHVybiB0aGlzOwoKCX0KCglkaXZpZGVTY2FsYXIoIHNjYWxhciApIHsKCgkJcmV0dXJuIHRoaXMubXVsdGlwbHlTY2FsYXIoIDEgLyBzY2FsYXIgKTsKCgl9CgoJbWluKCB2ICkgewoKCQl0aGlzLnggPSBNYXRoLm1pbiggdGhpcy54LCB2LnggKTsKCQl0aGlzLnkgPSBNYXRoLm1pbiggdGhpcy55LCB2LnkgKTsKCQl0aGlzLnogPSBNYXRoLm1pbiggdGhpcy56LCB2LnogKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW1heCggdiApIHsKCgkJdGhpcy54ID0gTWF0aC5tYXgoIHRoaXMueCwgdi54ICk7CgkJdGhpcy55ID0gTWF0aC5tYXgoIHRoaXMueSwgdi55ICk7CgkJdGhpcy56ID0gTWF0aC5tYXgoIHRoaXMueiwgdi56ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljbGFtcCggbWluLCBtYXggKSB7CgoJCS8vIGFzc3VtZXMgbWluIDwgbWF4LCBjb21wb25lbnR3aXNlCgoJCXRoaXMueCA9IE1hdGgubWF4KCBtaW4ueCwgTWF0aC5taW4oIG1heC54LCB0aGlzLnggKSApOwoJCXRoaXMueSA9IE1hdGgubWF4KCBtaW4ueSwgTWF0aC5taW4oIG1heC55LCB0aGlzLnkgKSApOwoJCXRoaXMueiA9IE1hdGgubWF4KCBtaW4ueiwgTWF0aC5taW4oIG1heC56LCB0aGlzLnogKSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xhbXBTY2FsYXIoIG1pblZhbCwgbWF4VmFsICkgewoKCQl0aGlzLnggPSBNYXRoLm1heCggbWluVmFsLCBNYXRoLm1pbiggbWF4VmFsLCB0aGlzLnggKSApOwoJCXRoaXMueSA9IE1hdGgubWF4KCBtaW5WYWwsIE1hdGgubWluKCBtYXhWYWwsIHRoaXMueSApICk7CgkJdGhpcy56ID0gTWF0aC5tYXgoIG1pblZhbCwgTWF0aC5taW4oIG1heFZhbCwgdGhpcy56ICkgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsYW1wTGVuZ3RoKCBtaW4sIG1heCApIHsKCgkJY29uc3QgbGVuZ3RoID0gdGhpcy5sZW5ndGgoKTsKCgkJcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKCBsZW5ndGggfHwgMSApLm11bHRpcGx5U2NhbGFyKCBNYXRoLm1heCggbWluLCBNYXRoLm1pbiggbWF4LCBsZW5ndGggKSApICk7CgoJfQoKCWZsb29yKCkgewoKCQl0aGlzLnggPSBNYXRoLmZsb29yKCB0aGlzLnggKTsKCQl0aGlzLnkgPSBNYXRoLmZsb29yKCB0aGlzLnkgKTsKCQl0aGlzLnogPSBNYXRoLmZsb29yKCB0aGlzLnogKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNlaWwoKSB7CgoJCXRoaXMueCA9IE1hdGguY2VpbCggdGhpcy54ICk7CgkJdGhpcy55ID0gTWF0aC5jZWlsKCB0aGlzLnkgKTsKCQl0aGlzLnogPSBNYXRoLmNlaWwoIHRoaXMueiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcm91bmQoKSB7CgoJCXRoaXMueCA9IE1hdGgucm91bmQoIHRoaXMueCApOwoJCXRoaXMueSA9IE1hdGgucm91bmQoIHRoaXMueSApOwoJCXRoaXMueiA9IE1hdGgucm91bmQoIHRoaXMueiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcm91bmRUb1plcm8oKSB7CgoJCXRoaXMueCA9IE1hdGgudHJ1bmMoIHRoaXMueCApOwoJCXRoaXMueSA9IE1hdGgudHJ1bmMoIHRoaXMueSApOwoJCXRoaXMueiA9IE1hdGgudHJ1bmMoIHRoaXMueiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbmVnYXRlKCkgewoKCQl0aGlzLnggPSAtIHRoaXMueDsKCQl0aGlzLnkgPSAtIHRoaXMueTsKCQl0aGlzLnogPSAtIHRoaXMuejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWRvdCggdiApIHsKCgkJcmV0dXJuIHRoaXMueCAqIHYueCArIHRoaXMueSAqIHYueSArIHRoaXMueiAqIHYuejsKCgl9CgoJLy8gVE9ETyBsZW5ndGhTcXVhcmVkPwoKCWxlbmd0aFNxKCkgewoKCQlyZXR1cm4gdGhpcy54ICogdGhpcy54ICsgdGhpcy55ICogdGhpcy55ICsgdGhpcy56ICogdGhpcy56OwoKCX0KCglsZW5ndGgoKSB7CgoJCXJldHVybiBNYXRoLnNxcnQoIHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMueiApOwoKCX0KCgltYW5oYXR0YW5MZW5ndGgoKSB7CgoJCXJldHVybiBNYXRoLmFicyggdGhpcy54ICkgKyBNYXRoLmFicyggdGhpcy55ICkgKyBNYXRoLmFicyggdGhpcy56ICk7CgoJfQoKCW5vcm1hbGl6ZSgpIHsKCgkJcmV0dXJuIHRoaXMuZGl2aWRlU2NhbGFyKCB0aGlzLmxlbmd0aCgpIHx8IDEgKTsKCgl9CgoJc2V0TGVuZ3RoKCBsZW5ndGggKSB7CgoJCXJldHVybiB0aGlzLm5vcm1hbGl6ZSgpLm11bHRpcGx5U2NhbGFyKCBsZW5ndGggKTsKCgl9CgoJbGVycCggdiwgYWxwaGEgKSB7CgoJCXRoaXMueCArPSAoIHYueCAtIHRoaXMueCApICogYWxwaGE7CgkJdGhpcy55ICs9ICggdi55IC0gdGhpcy55ICkgKiBhbHBoYTsKCQl0aGlzLnogKz0gKCB2LnogLSB0aGlzLnogKSAqIGFscGhhOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbGVycFZlY3RvcnMoIHYxLCB2MiwgYWxwaGEgKSB7CgoJCXRoaXMueCA9IHYxLnggKyAoIHYyLnggLSB2MS54ICkgKiBhbHBoYTsKCQl0aGlzLnkgPSB2MS55ICsgKCB2Mi55IC0gdjEueSApICogYWxwaGE7CgkJdGhpcy56ID0gdjEueiArICggdjIueiAtIHYxLnogKSAqIGFscGhhOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY3Jvc3MoIHYgKSB7CgoJCXJldHVybiB0aGlzLmNyb3NzVmVjdG9ycyggdGhpcywgdiApOwoKCX0KCgljcm9zc1ZlY3RvcnMoIGEsIGIgKSB7CgoJCWNvbnN0IGF4ID0gYS54LCBheSA9IGEueSwgYXogPSBhLno7CgkJY29uc3QgYnggPSBiLngsIGJ5ID0gYi55LCBieiA9IGIuejsKCgkJdGhpcy54ID0gYXkgKiBieiAtIGF6ICogYnk7CgkJdGhpcy55ID0gYXogKiBieCAtIGF4ICogYno7CgkJdGhpcy56ID0gYXggKiBieSAtIGF5ICogYng7CgoJCXJldHVybiB0aGlzOwoKCX0KCglwcm9qZWN0T25WZWN0b3IoIHYgKSB7CgoJCWNvbnN0IGRlbm9taW5hdG9yID0gdi5sZW5ndGhTcSgpOwoKCQlpZiAoIGRlbm9taW5hdG9yID09PSAwICkgcmV0dXJuIHRoaXMuc2V0KCAwLCAwLCAwICk7CgoJCWNvbnN0IHNjYWxhciA9IHYuZG90KCB0aGlzICkgLyBkZW5vbWluYXRvcjsKCgkJcmV0dXJuIHRoaXMuY29weSggdiApLm11bHRpcGx5U2NhbGFyKCBzY2FsYXIgKTsKCgl9CgoJcHJvamVjdE9uUGxhbmUoIHBsYW5lTm9ybWFsICkgewoKCQlfdmVjdG9yJGMuY29weSggdGhpcyApLnByb2plY3RPblZlY3RvciggcGxhbmVOb3JtYWwgKTsKCgkJcmV0dXJuIHRoaXMuc3ViKCBfdmVjdG9yJGMgKTsKCgl9CgoJcmVmbGVjdCggbm9ybWFsICkgewoKCQkvLyByZWZsZWN0IGluY2lkZW50IHZlY3RvciBvZmYgcGxhbmUgb3J0aG9nb25hbCB0byBub3JtYWwKCQkvLyBub3JtYWwgaXMgYXNzdW1lZCB0byBoYXZlIHVuaXQgbGVuZ3RoCgoJCXJldHVybiB0aGlzLnN1YiggX3ZlY3RvciRjLmNvcHkoIG5vcm1hbCApLm11bHRpcGx5U2NhbGFyKCAyICogdGhpcy5kb3QoIG5vcm1hbCApICkgKTsKCgl9CgoJYW5nbGVUbyggdiApIHsKCgkJY29uc3QgZGVub21pbmF0b3IgPSBNYXRoLnNxcnQoIHRoaXMubGVuZ3RoU3EoKSAqIHYubGVuZ3RoU3EoKSApOwoKCQlpZiAoIGRlbm9taW5hdG9yID09PSAwICkgcmV0dXJuIE1hdGguUEkgLyAyOwoKCQljb25zdCB0aGV0YSA9IHRoaXMuZG90KCB2ICkgLyBkZW5vbWluYXRvcjsKCgkJLy8gY2xhbXAsIHRvIGhhbmRsZSBudW1lcmljYWwgcHJvYmxlbXMKCgkJcmV0dXJuIE1hdGguYWNvcyggY2xhbXAoIHRoZXRhLCAtIDEsIDEgKSApOwoKCX0KCglkaXN0YW5jZVRvKCB2ICkgewoKCQlyZXR1cm4gTWF0aC5zcXJ0KCB0aGlzLmRpc3RhbmNlVG9TcXVhcmVkKCB2ICkgKTsKCgl9CgoJZGlzdGFuY2VUb1NxdWFyZWQoIHYgKSB7CgoJCWNvbnN0IGR4ID0gdGhpcy54IC0gdi54LCBkeSA9IHRoaXMueSAtIHYueSwgZHogPSB0aGlzLnogLSB2Lno7CgoJCXJldHVybiBkeCAqIGR4ICsgZHkgKiBkeSArIGR6ICogZHo7CgoJfQoKCW1hbmhhdHRhbkRpc3RhbmNlVG8oIHYgKSB7CgoJCXJldHVybiBNYXRoLmFicyggdGhpcy54IC0gdi54ICkgKyBNYXRoLmFicyggdGhpcy55IC0gdi55ICkgKyBNYXRoLmFicyggdGhpcy56IC0gdi56ICk7CgoJfQoKCXNldEZyb21TcGhlcmljYWwoIHMgKSB7CgoJCXJldHVybiB0aGlzLnNldEZyb21TcGhlcmljYWxDb29yZHMoIHMucmFkaXVzLCBzLnBoaSwgcy50aGV0YSApOwoKCX0KCglzZXRGcm9tU3BoZXJpY2FsQ29vcmRzKCByYWRpdXMsIHBoaSwgdGhldGEgKSB7CgoJCWNvbnN0IHNpblBoaVJhZGl1cyA9IE1hdGguc2luKCBwaGkgKSAqIHJhZGl1czsKCgkJdGhpcy54ID0gc2luUGhpUmFkaXVzICogTWF0aC5zaW4oIHRoZXRhICk7CgkJdGhpcy55ID0gTWF0aC5jb3MoIHBoaSApICogcmFkaXVzOwoJCXRoaXMueiA9IHNpblBoaVJhZGl1cyAqIE1hdGguY29zKCB0aGV0YSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbUN5bGluZHJpY2FsKCBjICkgewoKCQlyZXR1cm4gdGhpcy5zZXRGcm9tQ3lsaW5kcmljYWxDb29yZHMoIGMucmFkaXVzLCBjLnRoZXRhLCBjLnkgKTsKCgl9CgoJc2V0RnJvbUN5bGluZHJpY2FsQ29vcmRzKCByYWRpdXMsIHRoZXRhLCB5ICkgewoKCQl0aGlzLnggPSByYWRpdXMgKiBNYXRoLnNpbiggdGhldGEgKTsKCQl0aGlzLnkgPSB5OwoJCXRoaXMueiA9IHJhZGl1cyAqIE1hdGguY29zKCB0aGV0YSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCBtICkgewoKCQljb25zdCBlID0gbS5lbGVtZW50czsKCgkJdGhpcy54ID0gZVsgMTIgXTsKCQl0aGlzLnkgPSBlWyAxMyBdOwoJCXRoaXMueiA9IGVbIDE0IF07CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tTWF0cml4U2NhbGUoIG0gKSB7CgoJCWNvbnN0IHN4ID0gdGhpcy5zZXRGcm9tTWF0cml4Q29sdW1uKCBtLCAwICkubGVuZ3RoKCk7CgkJY29uc3Qgc3kgPSB0aGlzLnNldEZyb21NYXRyaXhDb2x1bW4oIG0sIDEgKS5sZW5ndGgoKTsKCQljb25zdCBzeiA9IHRoaXMuc2V0RnJvbU1hdHJpeENvbHVtbiggbSwgMiApLmxlbmd0aCgpOwoKCQl0aGlzLnggPSBzeDsKCQl0aGlzLnkgPSBzeTsKCQl0aGlzLnogPSBzejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEZyb21NYXRyaXhDb2x1bW4oIG0sIGluZGV4ICkgewoKCQlyZXR1cm4gdGhpcy5mcm9tQXJyYXkoIG0uZWxlbWVudHMsIGluZGV4ICogNCApOwoKCX0KCglzZXRGcm9tTWF0cml4M0NvbHVtbiggbSwgaW5kZXggKSB7CgoJCXJldHVybiB0aGlzLmZyb21BcnJheSggbS5lbGVtZW50cywgaW5kZXggKiAzICk7CgoJfQoKCXNldEZyb21FdWxlciggZSApIHsKCgkJdGhpcy54ID0gZS5feDsKCQl0aGlzLnkgPSBlLl95OwoJCXRoaXMueiA9IGUuX3o7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tQ29sb3IoIGMgKSB7CgoJCXRoaXMueCA9IGMucjsKCQl0aGlzLnkgPSBjLmc7CgkJdGhpcy56ID0gYy5iOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXF1YWxzKCB2ICkgewoKCQlyZXR1cm4gKCAoIHYueCA9PT0gdGhpcy54ICkgJiYgKCB2LnkgPT09IHRoaXMueSApICYmICggdi56ID09PSB0aGlzLnogKSApOwoKCX0KCglmcm9tQXJyYXkoIGFycmF5LCBvZmZzZXQgPSAwICkgewoKCQl0aGlzLnggPSBhcnJheVsgb2Zmc2V0IF07CgkJdGhpcy55ID0gYXJyYXlbIG9mZnNldCArIDEgXTsKCQl0aGlzLnogPSBhcnJheVsgb2Zmc2V0ICsgMiBdOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9BcnJheSggYXJyYXkgPSBbXSwgb2Zmc2V0ID0gMCApIHsKCgkJYXJyYXlbIG9mZnNldCBdID0gdGhpcy54OwoJCWFycmF5WyBvZmZzZXQgKyAxIF0gPSB0aGlzLnk7CgkJYXJyYXlbIG9mZnNldCArIDIgXSA9IHRoaXMuejsKCgkJcmV0dXJuIGFycmF5OwoKCX0KCglmcm9tQnVmZmVyQXR0cmlidXRlKCBhdHRyaWJ1dGUsIGluZGV4ICkgewoKCQl0aGlzLnggPSBhdHRyaWJ1dGUuZ2V0WCggaW5kZXggKTsKCQl0aGlzLnkgPSBhdHRyaWJ1dGUuZ2V0WSggaW5kZXggKTsKCQl0aGlzLnogPSBhdHRyaWJ1dGUuZ2V0WiggaW5kZXggKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJhbmRvbSgpIHsKCgkJdGhpcy54ID0gTWF0aC5yYW5kb20oKTsKCQl0aGlzLnkgPSBNYXRoLnJhbmRvbSgpOwoJCXRoaXMueiA9IE1hdGgucmFuZG9tKCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglyYW5kb21EaXJlY3Rpb24oKSB7CgoJCS8vIERlcml2ZWQgZnJvbSBodHRwczovL21hdGh3b3JsZC53b2xmcmFtLmNvbS9TcGhlcmVQb2ludFBpY2tpbmcuaHRtbAoKCQljb25zdCB1ID0gKCBNYXRoLnJhbmRvbSgpIC0gMC41ICkgKiAyOwoJCWNvbnN0IHQgPSBNYXRoLnJhbmRvbSgpICogTWF0aC5QSSAqIDI7CgkJY29uc3QgZiA9IE1hdGguc3FydCggMSAtIHUgKiogMiApOwoKCQl0aGlzLnggPSBmICogTWF0aC5jb3MoIHQgKTsKCQl0aGlzLnkgPSBmICogTWF0aC5zaW4oIHQgKTsKCQl0aGlzLnogPSB1OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJKlsgU3ltYm9sLml0ZXJhdG9yIF0oKSB7CgoJCXlpZWxkIHRoaXMueDsKCQl5aWVsZCB0aGlzLnk7CgkJeWllbGQgdGhpcy56OwoKCX0KCn0KCmNvbnN0IF92ZWN0b3IkYyA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3F1YXRlcm5pb24kNCA9IC8qQF9fUFVSRV9fKi8gbmV3IFF1YXRlcm5pb24oKTsKCmNsYXNzIEJveDMgewoKCWNvbnN0cnVjdG9yKCBtaW4gPSBuZXcgVmVjdG9yMyggKyBJbmZpbml0eSwgKyBJbmZpbml0eSwgKyBJbmZpbml0eSApLCBtYXggPSBuZXcgVmVjdG9yMyggLSBJbmZpbml0eSwgLSBJbmZpbml0eSwgLSBJbmZpbml0eSApICkgewoKCQl0aGlzLmlzQm94MyA9IHRydWU7CgoJCXRoaXMubWluID0gbWluOwoJCXRoaXMubWF4ID0gbWF4OwoKCX0KCglzZXQoIG1pbiwgbWF4ICkgewoKCQl0aGlzLm1pbi5jb3B5KCBtaW4gKTsKCQl0aGlzLm1heC5jb3B5KCBtYXggKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEZyb21BcnJheSggYXJyYXkgKSB7CgoJCXRoaXMubWFrZUVtcHR5KCk7CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSBhcnJheS5sZW5ndGg7IGkgPCBpbDsgaSArPSAzICkgewoKCQkJdGhpcy5leHBhbmRCeVBvaW50KCBfdmVjdG9yJGIuZnJvbUFycmF5KCBhcnJheSwgaSApICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEZyb21CdWZmZXJBdHRyaWJ1dGUoIGF0dHJpYnV0ZSApIHsKCgkJdGhpcy5tYWtlRW1wdHkoKTsKCgkJZm9yICggbGV0IGkgPSAwLCBpbCA9IGF0dHJpYnV0ZS5jb3VudDsgaSA8IGlsOyBpICsrICkgewoKCQkJdGhpcy5leHBhbmRCeVBvaW50KCBfdmVjdG9yJGIuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggYXR0cmlidXRlLCBpICkgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbVBvaW50cyggcG9pbnRzICkgewoKCQl0aGlzLm1ha2VFbXB0eSgpOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gcG9pbnRzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJdGhpcy5leHBhbmRCeVBvaW50KCBwb2ludHNbIGkgXSApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tQ2VudGVyQW5kU2l6ZSggY2VudGVyLCBzaXplICkgewoKCQljb25zdCBoYWxmU2l6ZSA9IF92ZWN0b3IkYi5jb3B5KCBzaXplICkubXVsdGlwbHlTY2FsYXIoIDAuNSApOwoKCQl0aGlzLm1pbi5jb3B5KCBjZW50ZXIgKS5zdWIoIGhhbGZTaXplICk7CgkJdGhpcy5tYXguY29weSggY2VudGVyICkuYWRkKCBoYWxmU2l6ZSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbU9iamVjdCggb2JqZWN0LCBwcmVjaXNlID0gZmFsc2UgKSB7CgoJCXRoaXMubWFrZUVtcHR5KCk7CgoJCXJldHVybiB0aGlzLmV4cGFuZEJ5T2JqZWN0KCBvYmplY3QsIHByZWNpc2UgKTsKCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkoIHRoaXMgKTsKCgl9CgoJY29weSggYm94ICkgewoKCQl0aGlzLm1pbi5jb3B5KCBib3gubWluICk7CgkJdGhpcy5tYXguY29weSggYm94Lm1heCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbWFrZUVtcHR5KCkgewoKCQl0aGlzLm1pbi54ID0gdGhpcy5taW4ueSA9IHRoaXMubWluLnogPSArIEluZmluaXR5OwoJCXRoaXMubWF4LnggPSB0aGlzLm1heC55ID0gdGhpcy5tYXgueiA9IC0gSW5maW5pdHk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglpc0VtcHR5KCkgewoKCQkvLyB0aGlzIGlzIGEgbW9yZSByb2J1c3QgY2hlY2sgZm9yIGVtcHR5IHRoYW4gKCB2b2x1bWUgPD0gMCApIGJlY2F1c2Ugdm9sdW1lIGNhbiBnZXQgcG9zaXRpdmUgd2l0aCB0d28gbmVnYXRpdmUgYXhlcwoKCQlyZXR1cm4gKCB0aGlzLm1heC54IDwgdGhpcy5taW4ueCApIHx8ICggdGhpcy5tYXgueSA8IHRoaXMubWluLnkgKSB8fCAoIHRoaXMubWF4LnogPCB0aGlzLm1pbi56ICk7CgoJfQoKCWdldENlbnRlciggdGFyZ2V0ICkgewoKCQlyZXR1cm4gdGhpcy5pc0VtcHR5KCkgPyB0YXJnZXQuc2V0KCAwLCAwLCAwICkgOiB0YXJnZXQuYWRkVmVjdG9ycyggdGhpcy5taW4sIHRoaXMubWF4ICkubXVsdGlwbHlTY2FsYXIoIDAuNSApOwoKCX0KCglnZXRTaXplKCB0YXJnZXQgKSB7CgoJCXJldHVybiB0aGlzLmlzRW1wdHkoKSA/IHRhcmdldC5zZXQoIDAsIDAsIDAgKSA6IHRhcmdldC5zdWJWZWN0b3JzKCB0aGlzLm1heCwgdGhpcy5taW4gKTsKCgl9CgoJZXhwYW5kQnlQb2ludCggcG9pbnQgKSB7CgoJCXRoaXMubWluLm1pbiggcG9pbnQgKTsKCQl0aGlzLm1heC5tYXgoIHBvaW50ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglleHBhbmRCeVZlY3RvciggdmVjdG9yICkgewoKCQl0aGlzLm1pbi5zdWIoIHZlY3RvciApOwoJCXRoaXMubWF4LmFkZCggdmVjdG9yICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglleHBhbmRCeVNjYWxhciggc2NhbGFyICkgewoKCQl0aGlzLm1pbi5hZGRTY2FsYXIoIC0gc2NhbGFyICk7CgkJdGhpcy5tYXguYWRkU2NhbGFyKCBzY2FsYXIgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWV4cGFuZEJ5T2JqZWN0KCBvYmplY3QsIHByZWNpc2UgPSBmYWxzZSApIHsKCgkJLy8gQ29tcHV0ZXMgdGhlIHdvcmxkLWF4aXMtYWxpZ25lZCBib3VuZGluZyBib3ggb2YgYW4gb2JqZWN0IChpbmNsdWRpbmcgaXRzIGNoaWxkcmVuKSwKCQkvLyBhY2NvdW50aW5nIGZvciBib3RoIHRoZSBvYmplY3QncywgYW5kIGNoaWxkcmVuJ3MsIHdvcmxkIHRyYW5zZm9ybXMKCgkJb2JqZWN0LnVwZGF0ZVdvcmxkTWF0cml4KCBmYWxzZSwgZmFsc2UgKTsKCgkJY29uc3QgZ2VvbWV0cnkgPSBvYmplY3QuZ2VvbWV0cnk7CgoJCWlmICggZ2VvbWV0cnkgIT09IHVuZGVmaW5lZCApIHsKCgkJCWNvbnN0IHBvc2l0aW9uQXR0cmlidXRlID0gZ2VvbWV0cnkuZ2V0QXR0cmlidXRlKCAncG9zaXRpb24nICk7CgoJCQkvLyBwcmVjaXNlIEFBQkIgY29tcHV0YXRpb24gYmFzZWQgb24gdmVydGV4IGRhdGEgcmVxdWlyZXMgYXQgbGVhc3QgYSBwb3NpdGlvbiBhdHRyaWJ1dGUuCgkJCS8vIGluc3RhbmNpbmcgaXNuJ3Qgc3VwcG9ydGVkIHNvIGZhciBhbmQgdXNlcyB0aGUgbm9ybWFsIChjb25zZXJ2YXRpdmUpIGNvZGUgcGF0aC4KCgkJCWlmICggcHJlY2lzZSA9PT0gdHJ1ZSAmJiBwb3NpdGlvbkF0dHJpYnV0ZSAhPT0gdW5kZWZpbmVkICYmIG9iamVjdC5pc0luc3RhbmNlZE1lc2ggIT09IHRydWUgKSB7CgoJCQkJZm9yICggbGV0IGkgPSAwLCBsID0gcG9zaXRpb25BdHRyaWJ1dGUuY291bnQ7IGkgPCBsOyBpICsrICkgewoKCQkJCQlpZiAoIG9iamVjdC5pc01lc2ggPT09IHRydWUgKSB7CgoJCQkJCQlvYmplY3QuZ2V0VmVydGV4UG9zaXRpb24oIGksIF92ZWN0b3IkYiApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJX3ZlY3RvciRiLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCBpICk7CgoJCQkJCX0KCgkJCQkJX3ZlY3RvciRiLmFwcGx5TWF0cml4NCggb2JqZWN0Lm1hdHJpeFdvcmxkICk7CgkJCQkJdGhpcy5leHBhbmRCeVBvaW50KCBfdmVjdG9yJGIgKTsKCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCWlmICggb2JqZWN0LmJvdW5kaW5nQm94ICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJCS8vIG9iamVjdC1sZXZlbCBib3VuZGluZyBib3gKCgkJCQkJaWYgKCBvYmplY3QuYm91bmRpbmdCb3ggPT09IG51bGwgKSB7CgoJCQkJCQlvYmplY3QuY29tcHV0ZUJvdW5kaW5nQm94KCk7CgoJCQkJCX0KCgkJCQkJX2JveCQ0LmNvcHkoIG9iamVjdC5ib3VuZGluZ0JveCApOwoKCgkJCQl9IGVsc2UgewoKCQkJCQkvLyBnZW9tZXRyeS1sZXZlbCBib3VuZGluZyBib3gKCgkJCQkJaWYgKCBnZW9tZXRyeS5ib3VuZGluZ0JveCA9PT0gbnVsbCApIHsKCgkJCQkJCWdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ0JveCgpOwoKCQkJCQl9CgoJCQkJCV9ib3gkNC5jb3B5KCBnZW9tZXRyeS5ib3VuZGluZ0JveCApOwoKCQkJCX0KCgkJCQlfYm94JDQuYXBwbHlNYXRyaXg0KCBvYmplY3QubWF0cml4V29ybGQgKTsKCgkJCQl0aGlzLnVuaW9uKCBfYm94JDQgKTsKCgkJCX0KCgkJfQoKCQljb25zdCBjaGlsZHJlbiA9IG9iamVjdC5jaGlsZHJlbjsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCXRoaXMuZXhwYW5kQnlPYmplY3QoIGNoaWxkcmVuWyBpIF0sIHByZWNpc2UgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY29udGFpbnNQb2ludCggcG9pbnQgKSB7CgoJCXJldHVybiBwb2ludC54IDwgdGhpcy5taW4ueCB8fCBwb2ludC54ID4gdGhpcy5tYXgueCB8fAoJCQlwb2ludC55IDwgdGhpcy5taW4ueSB8fCBwb2ludC55ID4gdGhpcy5tYXgueSB8fAoJCQlwb2ludC56IDwgdGhpcy5taW4ueiB8fCBwb2ludC56ID4gdGhpcy5tYXgueiA/IGZhbHNlIDogdHJ1ZTsKCgl9CgoJY29udGFpbnNCb3goIGJveCApIHsKCgkJcmV0dXJuIHRoaXMubWluLnggPD0gYm94Lm1pbi54ICYmIGJveC5tYXgueCA8PSB0aGlzLm1heC54ICYmCgkJCXRoaXMubWluLnkgPD0gYm94Lm1pbi55ICYmIGJveC5tYXgueSA8PSB0aGlzLm1heC55ICYmCgkJCXRoaXMubWluLnogPD0gYm94Lm1pbi56ICYmIGJveC5tYXgueiA8PSB0aGlzLm1heC56OwoKCX0KCglnZXRQYXJhbWV0ZXIoIHBvaW50LCB0YXJnZXQgKSB7CgoJCS8vIFRoaXMgY2FuIHBvdGVudGlhbGx5IGhhdmUgYSBkaXZpZGUgYnkgemVybyBpZiB0aGUgYm94CgkJLy8gaGFzIGEgc2l6ZSBkaW1lbnNpb24gb2YgMC4KCgkJcmV0dXJuIHRhcmdldC5zZXQoCgkJCSggcG9pbnQueCAtIHRoaXMubWluLnggKSAvICggdGhpcy5tYXgueCAtIHRoaXMubWluLnggKSwKCQkJKCBwb2ludC55IC0gdGhpcy5taW4ueSApIC8gKCB0aGlzLm1heC55IC0gdGhpcy5taW4ueSApLAoJCQkoIHBvaW50LnogLSB0aGlzLm1pbi56ICkgLyAoIHRoaXMubWF4LnogLSB0aGlzLm1pbi56ICkKCQkpOwoKCX0KCglpbnRlcnNlY3RzQm94KCBib3ggKSB7CgoJCS8vIHVzaW5nIDYgc3BsaXR0aW5nIHBsYW5lcyB0byBydWxlIG91dCBpbnRlcnNlY3Rpb25zLgoJCXJldHVybiBib3gubWF4LnggPCB0aGlzLm1pbi54IHx8IGJveC5taW4ueCA+IHRoaXMubWF4LnggfHwKCQkJYm94Lm1heC55IDwgdGhpcy5taW4ueSB8fCBib3gubWluLnkgPiB0aGlzLm1heC55IHx8CgkJCWJveC5tYXgueiA8IHRoaXMubWluLnogfHwgYm94Lm1pbi56ID4gdGhpcy5tYXgueiA/IGZhbHNlIDogdHJ1ZTsKCgl9CgoJaW50ZXJzZWN0c1NwaGVyZSggc3BoZXJlICkgewoKCQkvLyBGaW5kIHRoZSBwb2ludCBvbiB0aGUgQUFCQiBjbG9zZXN0IHRvIHRoZSBzcGhlcmUgY2VudGVyLgoJCXRoaXMuY2xhbXBQb2ludCggc3BoZXJlLmNlbnRlciwgX3ZlY3RvciRiICk7CgoJCS8vIElmIHRoYXQgcG9pbnQgaXMgaW5zaWRlIHRoZSBzcGhlcmUsIHRoZSBBQUJCIGFuZCBzcGhlcmUgaW50ZXJzZWN0LgoJCXJldHVybiBfdmVjdG9yJGIuZGlzdGFuY2VUb1NxdWFyZWQoIHNwaGVyZS5jZW50ZXIgKSA8PSAoIHNwaGVyZS5yYWRpdXMgKiBzcGhlcmUucmFkaXVzICk7CgoJfQoKCWludGVyc2VjdHNQbGFuZSggcGxhbmUgKSB7CgoJCS8vIFdlIGNvbXB1dGUgdGhlIG1pbmltdW0gYW5kIG1heGltdW0gZG90IHByb2R1Y3QgdmFsdWVzLiBJZiB0aG9zZSB2YWx1ZXMKCQkvLyBhcmUgb24gdGhlIHNhbWUgc2lkZSAoYmFjayBvciBmcm9udCkgb2YgdGhlIHBsYW5lLCB0aGVuIHRoZXJlIGlzIG5vIGludGVyc2VjdGlvbi4KCgkJbGV0IG1pbiwgbWF4OwoKCQlpZiAoIHBsYW5lLm5vcm1hbC54ID4gMCApIHsKCgkJCW1pbiA9IHBsYW5lLm5vcm1hbC54ICogdGhpcy5taW4ueDsKCQkJbWF4ID0gcGxhbmUubm9ybWFsLnggKiB0aGlzLm1heC54OwoKCQl9IGVsc2UgewoKCQkJbWluID0gcGxhbmUubm9ybWFsLnggKiB0aGlzLm1heC54OwoJCQltYXggPSBwbGFuZS5ub3JtYWwueCAqIHRoaXMubWluLng7CgoJCX0KCgkJaWYgKCBwbGFuZS5ub3JtYWwueSA+IDAgKSB7CgoJCQltaW4gKz0gcGxhbmUubm9ybWFsLnkgKiB0aGlzLm1pbi55OwoJCQltYXggKz0gcGxhbmUubm9ybWFsLnkgKiB0aGlzLm1heC55OwoKCQl9IGVsc2UgewoKCQkJbWluICs9IHBsYW5lLm5vcm1hbC55ICogdGhpcy5tYXgueTsKCQkJbWF4ICs9IHBsYW5lLm5vcm1hbC55ICogdGhpcy5taW4ueTsKCgkJfQoKCQlpZiAoIHBsYW5lLm5vcm1hbC56ID4gMCApIHsKCgkJCW1pbiArPSBwbGFuZS5ub3JtYWwueiAqIHRoaXMubWluLno7CgkJCW1heCArPSBwbGFuZS5ub3JtYWwueiAqIHRoaXMubWF4Lno7CgoJCX0gZWxzZSB7CgoJCQltaW4gKz0gcGxhbmUubm9ybWFsLnogKiB0aGlzLm1heC56OwoJCQltYXggKz0gcGxhbmUubm9ybWFsLnogKiB0aGlzLm1pbi56OwoKCQl9CgoJCXJldHVybiAoIG1pbiA8PSAtIHBsYW5lLmNvbnN0YW50ICYmIG1heCA+PSAtIHBsYW5lLmNvbnN0YW50ICk7CgoJfQoKCWludGVyc2VjdHNUcmlhbmdsZSggdHJpYW5nbGUgKSB7CgoJCWlmICggdGhpcy5pc0VtcHR5KCkgKSB7CgoJCQlyZXR1cm4gZmFsc2U7CgoJCX0KCgkJLy8gY29tcHV0ZSBib3ggY2VudGVyIGFuZCBleHRlbnRzCgkJdGhpcy5nZXRDZW50ZXIoIF9jZW50ZXIgKTsKCQlfZXh0ZW50cy5zdWJWZWN0b3JzKCB0aGlzLm1heCwgX2NlbnRlciApOwoKCQkvLyB0cmFuc2xhdGUgdHJpYW5nbGUgdG8gYWFiYiBvcmlnaW4KCQlfdjAkMi5zdWJWZWN0b3JzKCB0cmlhbmdsZS5hLCBfY2VudGVyICk7CgkJX3YxJDcuc3ViVmVjdG9ycyggdHJpYW5nbGUuYiwgX2NlbnRlciApOwoJCV92MiQ0LnN1YlZlY3RvcnMoIHRyaWFuZ2xlLmMsIF9jZW50ZXIgKTsKCgkJLy8gY29tcHV0ZSBlZGdlIHZlY3RvcnMgZm9yIHRyaWFuZ2xlCgkJX2YwLnN1YlZlY3RvcnMoIF92MSQ3LCBfdjAkMiApOwoJCV9mMS5zdWJWZWN0b3JzKCBfdjIkNCwgX3YxJDcgKTsKCQlfZjIuc3ViVmVjdG9ycyggX3YwJDIsIF92MiQ0ICk7CgoJCS8vIHRlc3QgYWdhaW5zdCBheGVzIHRoYXQgYXJlIGdpdmVuIGJ5IGNyb3NzIHByb2R1Y3QgY29tYmluYXRpb25zIG9mIHRoZSBlZGdlcyBvZiB0aGUgdHJpYW5nbGUgYW5kIHRoZSBlZGdlcyBvZiB0aGUgYWFiYgoJCS8vIG1ha2UgYW4gYXhpcyB0ZXN0aW5nIG9mIGVhY2ggb2YgdGhlIDMgc2lkZXMgb2YgdGhlIGFhYmIgYWdhaW5zdCBlYWNoIG9mIHRoZSAzIHNpZGVzIG9mIHRoZSB0cmlhbmdsZSA9IDkgYXhpcyBvZiBzZXBhcmF0aW9uCgkJLy8gYXhpc19paiA9IHVfaSB4IGZfaiAodTAsIHUxLCB1MiA9IGZhY2Ugbm9ybWFscyBvZiBhYWJiID0geCx5LHogYXhlcyB2ZWN0b3JzIHNpbmNlIGFhYmIgaXMgYXhpcyBhbGlnbmVkKQoJCWxldCBheGVzID0gWwoJCQkwLCAtIF9mMC56LCBfZjAueSwgMCwgLSBfZjEueiwgX2YxLnksIDAsIC0gX2YyLnosIF9mMi55LAoJCQlfZjAueiwgMCwgLSBfZjAueCwgX2YxLnosIDAsIC0gX2YxLngsIF9mMi56LCAwLCAtIF9mMi54LAoJCQktIF9mMC55LCBfZjAueCwgMCwgLSBfZjEueSwgX2YxLngsIDAsIC0gX2YyLnksIF9mMi54LCAwCgkJXTsKCQlpZiAoICEgc2F0Rm9yQXhlcyggYXhlcywgX3YwJDIsIF92MSQ3LCBfdjIkNCwgX2V4dGVudHMgKSApIHsKCgkJCXJldHVybiBmYWxzZTsKCgkJfQoKCQkvLyB0ZXN0IDMgZmFjZSBub3JtYWxzIGZyb20gdGhlIGFhYmIKCQlheGVzID0gWyAxLCAwLCAwLCAwLCAxLCAwLCAwLCAwLCAxIF07CgkJaWYgKCAhIHNhdEZvckF4ZXMoIGF4ZXMsIF92MCQyLCBfdjEkNywgX3YyJDQsIF9leHRlbnRzICkgKSB7CgoJCQlyZXR1cm4gZmFsc2U7CgoJCX0KCgkJLy8gZmluYWxseSB0ZXN0aW5nIHRoZSBmYWNlIG5vcm1hbCBvZiB0aGUgdHJpYW5nbGUKCQkvLyB1c2UgYWxyZWFkeSBleGlzdGluZyB0cmlhbmdsZSBlZGdlIHZlY3RvcnMgaGVyZQoJCV90cmlhbmdsZU5vcm1hbC5jcm9zc1ZlY3RvcnMoIF9mMCwgX2YxICk7CgkJYXhlcyA9IFsgX3RyaWFuZ2xlTm9ybWFsLngsIF90cmlhbmdsZU5vcm1hbC55LCBfdHJpYW5nbGVOb3JtYWwueiBdOwoKCQlyZXR1cm4gc2F0Rm9yQXhlcyggYXhlcywgX3YwJDIsIF92MSQ3LCBfdjIkNCwgX2V4dGVudHMgKTsKCgl9CgoJY2xhbXBQb2ludCggcG9pbnQsIHRhcmdldCApIHsKCgkJcmV0dXJuIHRhcmdldC5jb3B5KCBwb2ludCApLmNsYW1wKCB0aGlzLm1pbiwgdGhpcy5tYXggKTsKCgl9CgoJZGlzdGFuY2VUb1BvaW50KCBwb2ludCApIHsKCgkJcmV0dXJuIHRoaXMuY2xhbXBQb2ludCggcG9pbnQsIF92ZWN0b3IkYiApLmRpc3RhbmNlVG8oIHBvaW50ICk7CgoJfQoKCWdldEJvdW5kaW5nU3BoZXJlKCB0YXJnZXQgKSB7CgoJCWlmICggdGhpcy5pc0VtcHR5KCkgKSB7CgoJCQl0YXJnZXQubWFrZUVtcHR5KCk7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLmdldENlbnRlciggdGFyZ2V0LmNlbnRlciApOwoKCQkJdGFyZ2V0LnJhZGl1cyA9IHRoaXMuZ2V0U2l6ZSggX3ZlY3RvciRiICkubGVuZ3RoKCkgKiAwLjU7CgoJCX0KCgkJcmV0dXJuIHRhcmdldDsKCgl9CgoJaW50ZXJzZWN0KCBib3ggKSB7CgoJCXRoaXMubWluLm1heCggYm94Lm1pbiApOwoJCXRoaXMubWF4Lm1pbiggYm94Lm1heCApOwoKCQkvLyBlbnN1cmUgdGhhdCBpZiB0aGVyZSBpcyBubyBvdmVybGFwLCB0aGUgcmVzdWx0IGlzIGZ1bGx5IGVtcHR5LCBub3Qgc2xpZ2h0bHkgZW1wdHkgd2l0aCBub24taW5mLytpbmYgdmFsdWVzIHRoYXQgd2lsbCBjYXVzZSBzdWJzZXF1ZW5jZSBpbnRlcnNlY3RzIHRvIGVycm9uZW91c2x5IHJldHVybiB2YWxpZCB2YWx1ZXMuCgkJaWYgKCB0aGlzLmlzRW1wdHkoKSApIHRoaXMubWFrZUVtcHR5KCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl1bmlvbiggYm94ICkgewoKCQl0aGlzLm1pbi5taW4oIGJveC5taW4gKTsKCQl0aGlzLm1heC5tYXgoIGJveC5tYXggKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFwcGx5TWF0cml4NCggbWF0cml4ICkgewoKCQkvLyB0cmFuc2Zvcm0gb2YgZW1wdHkgYm94IGlzIGFuIGVtcHR5IGJveC4KCQlpZiAoIHRoaXMuaXNFbXB0eSgpICkgcmV0dXJuIHRoaXM7CgoJCS8vIE5PVEU6IEkgYW0gdXNpbmcgYSBiaW5hcnkgcGF0dGVybiB0byBzcGVjaWZ5IGFsbCAyXjMgY29tYmluYXRpb25zIGJlbG93CgkJX3BvaW50c1sgMCBdLnNldCggdGhpcy5taW4ueCwgdGhpcy5taW4ueSwgdGhpcy5taW4ueiApLmFwcGx5TWF0cml4NCggbWF0cml4ICk7IC8vIDAwMAoJCV9wb2ludHNbIDEgXS5zZXQoIHRoaXMubWluLngsIHRoaXMubWluLnksIHRoaXMubWF4LnogKS5hcHBseU1hdHJpeDQoIG1hdHJpeCApOyAvLyAwMDEKCQlfcG9pbnRzWyAyIF0uc2V0KCB0aGlzLm1pbi54LCB0aGlzLm1heC55LCB0aGlzLm1pbi56ICkuYXBwbHlNYXRyaXg0KCBtYXRyaXggKTsgLy8gMDEwCgkJX3BvaW50c1sgMyBdLnNldCggdGhpcy5taW4ueCwgdGhpcy5tYXgueSwgdGhpcy5tYXgueiApLmFwcGx5TWF0cml4NCggbWF0cml4ICk7IC8vIDAxMQoJCV9wb2ludHNbIDQgXS5zZXQoIHRoaXMubWF4LngsIHRoaXMubWluLnksIHRoaXMubWluLnogKS5hcHBseU1hdHJpeDQoIG1hdHJpeCApOyAvLyAxMDAKCQlfcG9pbnRzWyA1IF0uc2V0KCB0aGlzLm1heC54LCB0aGlzLm1pbi55LCB0aGlzLm1heC56ICkuYXBwbHlNYXRyaXg0KCBtYXRyaXggKTsgLy8gMTAxCgkJX3BvaW50c1sgNiBdLnNldCggdGhpcy5tYXgueCwgdGhpcy5tYXgueSwgdGhpcy5taW4ueiApLmFwcGx5TWF0cml4NCggbWF0cml4ICk7IC8vIDExMAoJCV9wb2ludHNbIDcgXS5zZXQoIHRoaXMubWF4LngsIHRoaXMubWF4LnksIHRoaXMubWF4LnogKS5hcHBseU1hdHJpeDQoIG1hdHJpeCApOyAvLyAxMTEKCgkJdGhpcy5zZXRGcm9tUG9pbnRzKCBfcG9pbnRzICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0cmFuc2xhdGUoIG9mZnNldCApIHsKCgkJdGhpcy5taW4uYWRkKCBvZmZzZXQgKTsKCQl0aGlzLm1heC5hZGQoIG9mZnNldCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXF1YWxzKCBib3ggKSB7CgoJCXJldHVybiBib3gubWluLmVxdWFscyggdGhpcy5taW4gKSAmJiBib3gubWF4LmVxdWFscyggdGhpcy5tYXggKTsKCgl9Cgp9Cgpjb25zdCBfcG9pbnRzID0gWwoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpCl07Cgpjb25zdCBfdmVjdG9yJGIgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7Cgpjb25zdCBfYm94JDQgPSAvKkBfX1BVUkVfXyovIG5ldyBCb3gzKCk7CgovLyB0cmlhbmdsZSBjZW50ZXJlZCB2ZXJ0aWNlcwoKY29uc3QgX3YwJDIgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92MSQ3ID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfdjIkNCA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCi8vIHRyaWFuZ2xlIGVkZ2UgdmVjdG9ycwoKY29uc3QgX2YwID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfZjEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9mMiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNvbnN0IF9jZW50ZXIgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9leHRlbnRzID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfdHJpYW5nbGVOb3JtYWwgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF90ZXN0QXhpcyA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmZ1bmN0aW9uIHNhdEZvckF4ZXMoIGF4ZXMsIHYwLCB2MSwgdjIsIGV4dGVudHMgKSB7CgoJZm9yICggbGV0IGkgPSAwLCBqID0gYXhlcy5sZW5ndGggLSAzOyBpIDw9IGo7IGkgKz0gMyApIHsKCgkJX3Rlc3RBeGlzLmZyb21BcnJheSggYXhlcywgaSApOwoJCS8vIHByb2plY3QgdGhlIGFhYmIgb250byB0aGUgc2VwYXJhdGluZyBheGlzCgkJY29uc3QgciA9IGV4dGVudHMueCAqIE1hdGguYWJzKCBfdGVzdEF4aXMueCApICsgZXh0ZW50cy55ICogTWF0aC5hYnMoIF90ZXN0QXhpcy55ICkgKyBleHRlbnRzLnogKiBNYXRoLmFicyggX3Rlc3RBeGlzLnogKTsKCQkvLyBwcm9qZWN0IGFsbCAzIHZlcnRpY2VzIG9mIHRoZSB0cmlhbmdsZSBvbnRvIHRoZSBzZXBhcmF0aW5nIGF4aXMKCQljb25zdCBwMCA9IHYwLmRvdCggX3Rlc3RBeGlzICk7CgkJY29uc3QgcDEgPSB2MS5kb3QoIF90ZXN0QXhpcyApOwoJCWNvbnN0IHAyID0gdjIuZG90KCBfdGVzdEF4aXMgKTsKCQkvLyBhY3R1YWwgdGVzdCwgYmFzaWNhbGx5IHNlZSBpZiBlaXRoZXIgb2YgdGhlIG1vc3QgZXh0cmVtZSBvZiB0aGUgdHJpYW5nbGUgcG9pbnRzIGludGVyc2VjdHMgcgoJCWlmICggTWF0aC5tYXgoIC0gTWF0aC5tYXgoIHAwLCBwMSwgcDIgKSwgTWF0aC5taW4oIHAwLCBwMSwgcDIgKSApID4gciApIHsKCgkJCS8vIHBvaW50cyBvZiB0aGUgcHJvamVjdGVkIHRyaWFuZ2xlIGFyZSBvdXRzaWRlIHRoZSBwcm9qZWN0ZWQgaGFsZi1sZW5ndGggb2YgdGhlIGFhYmIKCQkJLy8gdGhlIGF4aXMgaXMgc2VwYXJhdGluZyBhbmQgd2UgY2FuIGV4aXQKCQkJcmV0dXJuIGZhbHNlOwoKCQl9CgoJfQoKCXJldHVybiB0cnVlOwoKfQoKY29uc3QgX2JveCQzID0gLypAX19QVVJFX18qLyBuZXcgQm94MygpOwpjb25zdCBfdjEkNiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3YyJDMgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CgpjbGFzcyBTcGhlcmUgewoKCWNvbnN0cnVjdG9yKCBjZW50ZXIgPSBuZXcgVmVjdG9yMygpLCByYWRpdXMgPSAtIDEgKSB7CgoJCXRoaXMuaXNTcGhlcmUgPSB0cnVlOwoKCQl0aGlzLmNlbnRlciA9IGNlbnRlcjsKCQl0aGlzLnJhZGl1cyA9IHJhZGl1czsKCgl9CgoJc2V0KCBjZW50ZXIsIHJhZGl1cyApIHsKCgkJdGhpcy5jZW50ZXIuY29weSggY2VudGVyICk7CgkJdGhpcy5yYWRpdXMgPSByYWRpdXM7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tUG9pbnRzKCBwb2ludHMsIG9wdGlvbmFsQ2VudGVyICkgewoKCQljb25zdCBjZW50ZXIgPSB0aGlzLmNlbnRlcjsKCgkJaWYgKCBvcHRpb25hbENlbnRlciAhPT0gdW5kZWZpbmVkICkgewoKCQkJY2VudGVyLmNvcHkoIG9wdGlvbmFsQ2VudGVyICk7CgoJCX0gZWxzZSB7CgoJCQlfYm94JDMuc2V0RnJvbVBvaW50cyggcG9pbnRzICkuZ2V0Q2VudGVyKCBjZW50ZXIgKTsKCgkJfQoKCQlsZXQgbWF4UmFkaXVzU3EgPSAwOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gcG9pbnRzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJbWF4UmFkaXVzU3EgPSBNYXRoLm1heCggbWF4UmFkaXVzU3EsIGNlbnRlci5kaXN0YW5jZVRvU3F1YXJlZCggcG9pbnRzWyBpIF0gKSApOwoKCQl9CgoJCXRoaXMucmFkaXVzID0gTWF0aC5zcXJ0KCBtYXhSYWRpdXNTcSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY29weSggc3BoZXJlICkgewoKCQl0aGlzLmNlbnRlci5jb3B5KCBzcGhlcmUuY2VudGVyICk7CgkJdGhpcy5yYWRpdXMgPSBzcGhlcmUucmFkaXVzOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJaXNFbXB0eSgpIHsKCgkJcmV0dXJuICggdGhpcy5yYWRpdXMgPCAwICk7CgoJfQoKCW1ha2VFbXB0eSgpIHsKCgkJdGhpcy5jZW50ZXIuc2V0KCAwLCAwLCAwICk7CgkJdGhpcy5yYWRpdXMgPSAtIDE7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb250YWluc1BvaW50KCBwb2ludCApIHsKCgkJcmV0dXJuICggcG9pbnQuZGlzdGFuY2VUb1NxdWFyZWQoIHRoaXMuY2VudGVyICkgPD0gKCB0aGlzLnJhZGl1cyAqIHRoaXMucmFkaXVzICkgKTsKCgl9CgoJZGlzdGFuY2VUb1BvaW50KCBwb2ludCApIHsKCgkJcmV0dXJuICggcG9pbnQuZGlzdGFuY2VUbyggdGhpcy5jZW50ZXIgKSAtIHRoaXMucmFkaXVzICk7CgoJfQoKCWludGVyc2VjdHNTcGhlcmUoIHNwaGVyZSApIHsKCgkJY29uc3QgcmFkaXVzU3VtID0gdGhpcy5yYWRpdXMgKyBzcGhlcmUucmFkaXVzOwoKCQlyZXR1cm4gc3BoZXJlLmNlbnRlci5kaXN0YW5jZVRvU3F1YXJlZCggdGhpcy5jZW50ZXIgKSA8PSAoIHJhZGl1c1N1bSAqIHJhZGl1c1N1bSApOwoKCX0KCglpbnRlcnNlY3RzQm94KCBib3ggKSB7CgoJCXJldHVybiBib3guaW50ZXJzZWN0c1NwaGVyZSggdGhpcyApOwoKCX0KCglpbnRlcnNlY3RzUGxhbmUoIHBsYW5lICkgewoKCQlyZXR1cm4gTWF0aC5hYnMoIHBsYW5lLmRpc3RhbmNlVG9Qb2ludCggdGhpcy5jZW50ZXIgKSApIDw9IHRoaXMucmFkaXVzOwoKCX0KCgljbGFtcFBvaW50KCBwb2ludCwgdGFyZ2V0ICkgewoKCQljb25zdCBkZWx0YUxlbmd0aFNxID0gdGhpcy5jZW50ZXIuZGlzdGFuY2VUb1NxdWFyZWQoIHBvaW50ICk7CgoJCXRhcmdldC5jb3B5KCBwb2ludCApOwoKCQlpZiAoIGRlbHRhTGVuZ3RoU3EgPiAoIHRoaXMucmFkaXVzICogdGhpcy5yYWRpdXMgKSApIHsKCgkJCXRhcmdldC5zdWIoIHRoaXMuY2VudGVyICkubm9ybWFsaXplKCk7CgkJCXRhcmdldC5tdWx0aXBseVNjYWxhciggdGhpcy5yYWRpdXMgKS5hZGQoIHRoaXMuY2VudGVyICk7CgoJCX0KCgkJcmV0dXJuIHRhcmdldDsKCgl9CgoJZ2V0Qm91bmRpbmdCb3goIHRhcmdldCApIHsKCgkJaWYgKCB0aGlzLmlzRW1wdHkoKSApIHsKCgkJCS8vIEVtcHR5IHNwaGVyZSBwcm9kdWNlcyBlbXB0eSBib3VuZGluZyBib3gKCQkJdGFyZ2V0Lm1ha2VFbXB0eSgpOwoJCQlyZXR1cm4gdGFyZ2V0OwoKCQl9CgoJCXRhcmdldC5zZXQoIHRoaXMuY2VudGVyLCB0aGlzLmNlbnRlciApOwoJCXRhcmdldC5leHBhbmRCeVNjYWxhciggdGhpcy5yYWRpdXMgKTsKCgkJcmV0dXJuIHRhcmdldDsKCgl9CgoJYXBwbHlNYXRyaXg0KCBtYXRyaXggKSB7CgoJCXRoaXMuY2VudGVyLmFwcGx5TWF0cml4NCggbWF0cml4ICk7CgkJdGhpcy5yYWRpdXMgPSB0aGlzLnJhZGl1cyAqIG1hdHJpeC5nZXRNYXhTY2FsZU9uQXhpcygpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdHJhbnNsYXRlKCBvZmZzZXQgKSB7CgoJCXRoaXMuY2VudGVyLmFkZCggb2Zmc2V0ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglleHBhbmRCeVBvaW50KCBwb2ludCApIHsKCgkJaWYgKCB0aGlzLmlzRW1wdHkoKSApIHsKCgkJCXRoaXMuY2VudGVyLmNvcHkoIHBvaW50ICk7CgoJCQl0aGlzLnJhZGl1cyA9IDA7CgoJCQlyZXR1cm4gdGhpczsKCgkJfQoKCQlfdjEkNi5zdWJWZWN0b3JzKCBwb2ludCwgdGhpcy5jZW50ZXIgKTsKCgkJY29uc3QgbGVuZ3RoU3EgPSBfdjEkNi5sZW5ndGhTcSgpOwoKCQlpZiAoIGxlbmd0aFNxID4gKCB0aGlzLnJhZGl1cyAqIHRoaXMucmFkaXVzICkgKSB7CgoJCQkvLyBjYWxjdWxhdGUgdGhlIG1pbmltYWwgc3BoZXJlCgoJCQljb25zdCBsZW5ndGggPSBNYXRoLnNxcnQoIGxlbmd0aFNxICk7CgoJCQljb25zdCBkZWx0YSA9ICggbGVuZ3RoIC0gdGhpcy5yYWRpdXMgKSAqIDAuNTsKCgkJCXRoaXMuY2VudGVyLmFkZFNjYWxlZFZlY3RvciggX3YxJDYsIGRlbHRhIC8gbGVuZ3RoICk7CgoJCQl0aGlzLnJhZGl1cyArPSBkZWx0YTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdW5pb24oIHNwaGVyZSApIHsKCgkJaWYgKCBzcGhlcmUuaXNFbXB0eSgpICkgewoKCQkJcmV0dXJuIHRoaXM7CgoJCX0KCgkJaWYgKCB0aGlzLmlzRW1wdHkoKSApIHsKCgkJCXRoaXMuY29weSggc3BoZXJlICk7CgoJCQlyZXR1cm4gdGhpczsKCgkJfQoKCQlpZiAoIHRoaXMuY2VudGVyLmVxdWFscyggc3BoZXJlLmNlbnRlciApID09PSB0cnVlICkgewoKCQkJIHRoaXMucmFkaXVzID0gTWF0aC5tYXgoIHRoaXMucmFkaXVzLCBzcGhlcmUucmFkaXVzICk7CgoJCX0gZWxzZSB7CgoJCQlfdjIkMy5zdWJWZWN0b3JzKCBzcGhlcmUuY2VudGVyLCB0aGlzLmNlbnRlciApLnNldExlbmd0aCggc3BoZXJlLnJhZGl1cyApOwoKCQkJdGhpcy5leHBhbmRCeVBvaW50KCBfdjEkNi5jb3B5KCBzcGhlcmUuY2VudGVyICkuYWRkKCBfdjIkMyApICk7CgoJCQl0aGlzLmV4cGFuZEJ5UG9pbnQoIF92MSQ2LmNvcHkoIHNwaGVyZS5jZW50ZXIgKS5zdWIoIF92MiQzICkgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXF1YWxzKCBzcGhlcmUgKSB7CgoJCXJldHVybiBzcGhlcmUuY2VudGVyLmVxdWFscyggdGhpcy5jZW50ZXIgKSAmJiAoIHNwaGVyZS5yYWRpdXMgPT09IHRoaXMucmFkaXVzICk7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KCB0aGlzICk7CgoJfQoKfQoKY29uc3QgX3ZlY3RvciRhID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfc2VnQ2VudGVyID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfc2VnRGlyID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfZGlmZiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNvbnN0IF9lZGdlMSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX2VkZ2UyID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfbm9ybWFsJDEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CgpjbGFzcyBSYXkgewoKCWNvbnN0cnVjdG9yKCBvcmlnaW4gPSBuZXcgVmVjdG9yMygpLCBkaXJlY3Rpb24gPSBuZXcgVmVjdG9yMyggMCwgMCwgLSAxICkgKSB7CgoJCXRoaXMub3JpZ2luID0gb3JpZ2luOwoJCXRoaXMuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoKCX0KCglzZXQoIG9yaWdpbiwgZGlyZWN0aW9uICkgewoKCQl0aGlzLm9yaWdpbi5jb3B5KCBvcmlnaW4gKTsKCQl0aGlzLmRpcmVjdGlvbi5jb3B5KCBkaXJlY3Rpb24gKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvcHkoIHJheSApIHsKCgkJdGhpcy5vcmlnaW4uY29weSggcmF5Lm9yaWdpbiApOwoJCXRoaXMuZGlyZWN0aW9uLmNvcHkoIHJheS5kaXJlY3Rpb24gKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWF0KCB0LCB0YXJnZXQgKSB7CgoJCXJldHVybiB0YXJnZXQuY29weSggdGhpcy5vcmlnaW4gKS5hZGRTY2FsZWRWZWN0b3IoIHRoaXMuZGlyZWN0aW9uLCB0ICk7CgoJfQoKCWxvb2tBdCggdiApIHsKCgkJdGhpcy5kaXJlY3Rpb24uY29weSggdiApLnN1YiggdGhpcy5vcmlnaW4gKS5ub3JtYWxpemUoKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJlY2FzdCggdCApIHsKCgkJdGhpcy5vcmlnaW4uY29weSggdGhpcy5hdCggdCwgX3ZlY3RvciRhICkgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsb3Nlc3RQb2ludFRvUG9pbnQoIHBvaW50LCB0YXJnZXQgKSB7CgoJCXRhcmdldC5zdWJWZWN0b3JzKCBwb2ludCwgdGhpcy5vcmlnaW4gKTsKCgkJY29uc3QgZGlyZWN0aW9uRGlzdGFuY2UgPSB0YXJnZXQuZG90KCB0aGlzLmRpcmVjdGlvbiApOwoKCQlpZiAoIGRpcmVjdGlvbkRpc3RhbmNlIDwgMCApIHsKCgkJCXJldHVybiB0YXJnZXQuY29weSggdGhpcy5vcmlnaW4gKTsKCgkJfQoKCQlyZXR1cm4gdGFyZ2V0LmNvcHkoIHRoaXMub3JpZ2luICkuYWRkU2NhbGVkVmVjdG9yKCB0aGlzLmRpcmVjdGlvbiwgZGlyZWN0aW9uRGlzdGFuY2UgKTsKCgl9CgoJZGlzdGFuY2VUb1BvaW50KCBwb2ludCApIHsKCgkJcmV0dXJuIE1hdGguc3FydCggdGhpcy5kaXN0YW5jZVNxVG9Qb2ludCggcG9pbnQgKSApOwoKCX0KCglkaXN0YW5jZVNxVG9Qb2ludCggcG9pbnQgKSB7CgoJCWNvbnN0IGRpcmVjdGlvbkRpc3RhbmNlID0gX3ZlY3RvciRhLnN1YlZlY3RvcnMoIHBvaW50LCB0aGlzLm9yaWdpbiApLmRvdCggdGhpcy5kaXJlY3Rpb24gKTsKCgkJLy8gcG9pbnQgYmVoaW5kIHRoZSByYXkKCgkJaWYgKCBkaXJlY3Rpb25EaXN0YW5jZSA8IDAgKSB7CgoJCQlyZXR1cm4gdGhpcy5vcmlnaW4uZGlzdGFuY2VUb1NxdWFyZWQoIHBvaW50ICk7CgoJCX0KCgkJX3ZlY3RvciRhLmNvcHkoIHRoaXMub3JpZ2luICkuYWRkU2NhbGVkVmVjdG9yKCB0aGlzLmRpcmVjdGlvbiwgZGlyZWN0aW9uRGlzdGFuY2UgKTsKCgkJcmV0dXJuIF92ZWN0b3IkYS5kaXN0YW5jZVRvU3F1YXJlZCggcG9pbnQgKTsKCgl9CgoJZGlzdGFuY2VTcVRvU2VnbWVudCggdjAsIHYxLCBvcHRpb25hbFBvaW50T25SYXksIG9wdGlvbmFsUG9pbnRPblNlZ21lbnQgKSB7CgoJCS8vIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL3Btam9uaWFrL0dlb21ldHJpY1Rvb2xzL2Jsb2IvbWFzdGVyL0dURW5naW5lL0luY2x1ZGUvTWF0aGVtYXRpY3MvR3RlRGlzdFJheVNlZ21lbnQuaAoJCS8vIEl0IHJldHVybnMgdGhlIG1pbiBkaXN0YW5jZSBiZXR3ZWVuIHRoZSByYXkgYW5kIHRoZSBzZWdtZW50CgkJLy8gZGVmaW5lZCBieSB2MCBhbmQgdjEKCQkvLyBJdCBjYW4gYWxzbyBzZXQgdHdvIG9wdGlvbmFsIHRhcmdldHMgOgoJCS8vIC0gVGhlIGNsb3Nlc3QgcG9pbnQgb24gdGhlIHJheQoJCS8vIC0gVGhlIGNsb3Nlc3QgcG9pbnQgb24gdGhlIHNlZ21lbnQKCgkJX3NlZ0NlbnRlci5jb3B5KCB2MCApLmFkZCggdjEgKS5tdWx0aXBseVNjYWxhciggMC41ICk7CgkJX3NlZ0Rpci5jb3B5KCB2MSApLnN1YiggdjAgKS5ub3JtYWxpemUoKTsKCQlfZGlmZi5jb3B5KCB0aGlzLm9yaWdpbiApLnN1YiggX3NlZ0NlbnRlciApOwoKCQljb25zdCBzZWdFeHRlbnQgPSB2MC5kaXN0YW5jZVRvKCB2MSApICogMC41OwoJCWNvbnN0IGEwMSA9IC0gdGhpcy5kaXJlY3Rpb24uZG90KCBfc2VnRGlyICk7CgkJY29uc3QgYjAgPSBfZGlmZi5kb3QoIHRoaXMuZGlyZWN0aW9uICk7CgkJY29uc3QgYjEgPSAtIF9kaWZmLmRvdCggX3NlZ0RpciApOwoJCWNvbnN0IGMgPSBfZGlmZi5sZW5ndGhTcSgpOwoJCWNvbnN0IGRldCA9IE1hdGguYWJzKCAxIC0gYTAxICogYTAxICk7CgkJbGV0IHMwLCBzMSwgc3FyRGlzdCwgZXh0RGV0OwoKCQlpZiAoIGRldCA+IDAgKSB7CgoJCQkvLyBUaGUgcmF5IGFuZCBzZWdtZW50IGFyZSBub3QgcGFyYWxsZWwuCgoJCQlzMCA9IGEwMSAqIGIxIC0gYjA7CgkJCXMxID0gYTAxICogYjAgLSBiMTsKCQkJZXh0RGV0ID0gc2VnRXh0ZW50ICogZGV0OwoKCQkJaWYgKCBzMCA+PSAwICkgewoKCQkJCWlmICggczEgPj0gLSBleHREZXQgKSB7CgoJCQkJCWlmICggczEgPD0gZXh0RGV0ICkgewoKCQkJCQkJLy8gcmVnaW9uIDAKCQkJCQkJLy8gTWluaW11bSBhdCBpbnRlcmlvciBwb2ludHMgb2YgcmF5IGFuZCBzZWdtZW50LgoKCQkJCQkJY29uc3QgaW52RGV0ID0gMSAvIGRldDsKCQkJCQkJczAgKj0gaW52RGV0OwoJCQkJCQlzMSAqPSBpbnZEZXQ7CgkJCQkJCXNxckRpc3QgPSBzMCAqICggczAgKyBhMDEgKiBzMSArIDIgKiBiMCApICsgczEgKiAoIGEwMSAqIHMwICsgczEgKyAyICogYjEgKSArIGM7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyByZWdpb24gMQoKCQkJCQkJczEgPSBzZWdFeHRlbnQ7CgkJCQkJCXMwID0gTWF0aC5tYXgoIDAsIC0gKCBhMDEgKiBzMSArIGIwICkgKTsKCQkJCQkJc3FyRGlzdCA9IC0gczAgKiBzMCArIHMxICogKCBzMSArIDIgKiBiMSApICsgYzsKCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vIHJlZ2lvbiA1CgoJCQkJCXMxID0gLSBzZWdFeHRlbnQ7CgkJCQkJczAgPSBNYXRoLm1heCggMCwgLSAoIGEwMSAqIHMxICsgYjAgKSApOwoJCQkJCXNxckRpc3QgPSAtIHMwICogczAgKyBzMSAqICggczEgKyAyICogYjEgKSArIGM7CgoJCQkJfQoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIHMxIDw9IC0gZXh0RGV0ICkgewoKCQkJCQkvLyByZWdpb24gNAoKCQkJCQlzMCA9IE1hdGgubWF4KCAwLCAtICggLSBhMDEgKiBzZWdFeHRlbnQgKyBiMCApICk7CgkJCQkJczEgPSAoIHMwID4gMCApID8gLSBzZWdFeHRlbnQgOiBNYXRoLm1pbiggTWF0aC5tYXgoIC0gc2VnRXh0ZW50LCAtIGIxICksIHNlZ0V4dGVudCApOwoJCQkJCXNxckRpc3QgPSAtIHMwICogczAgKyBzMSAqICggczEgKyAyICogYjEgKSArIGM7CgoJCQkJfSBlbHNlIGlmICggczEgPD0gZXh0RGV0ICkgewoKCQkJCQkvLyByZWdpb24gMwoKCQkJCQlzMCA9IDA7CgkJCQkJczEgPSBNYXRoLm1pbiggTWF0aC5tYXgoIC0gc2VnRXh0ZW50LCAtIGIxICksIHNlZ0V4dGVudCApOwoJCQkJCXNxckRpc3QgPSBzMSAqICggczEgKyAyICogYjEgKSArIGM7CgoJCQkJfSBlbHNlIHsKCgkJCQkJLy8gcmVnaW9uIDIKCgkJCQkJczAgPSBNYXRoLm1heCggMCwgLSAoIGEwMSAqIHNlZ0V4dGVudCArIGIwICkgKTsKCQkJCQlzMSA9ICggczAgPiAwICkgPyBzZWdFeHRlbnQgOiBNYXRoLm1pbiggTWF0aC5tYXgoIC0gc2VnRXh0ZW50LCAtIGIxICksIHNlZ0V4dGVudCApOwoJCQkJCXNxckRpc3QgPSAtIHMwICogczAgKyBzMSAqICggczEgKyAyICogYjEgKSArIGM7CgoJCQkJfQoKCQkJfQoKCQl9IGVsc2UgewoKCQkJLy8gUmF5IGFuZCBzZWdtZW50IGFyZSBwYXJhbGxlbC4KCgkJCXMxID0gKCBhMDEgPiAwICkgPyAtIHNlZ0V4dGVudCA6IHNlZ0V4dGVudDsKCQkJczAgPSBNYXRoLm1heCggMCwgLSAoIGEwMSAqIHMxICsgYjAgKSApOwoJCQlzcXJEaXN0ID0gLSBzMCAqIHMwICsgczEgKiAoIHMxICsgMiAqIGIxICkgKyBjOwoKCQl9CgoJCWlmICggb3B0aW9uYWxQb2ludE9uUmF5ICkgewoKCQkJb3B0aW9uYWxQb2ludE9uUmF5LmNvcHkoIHRoaXMub3JpZ2luICkuYWRkU2NhbGVkVmVjdG9yKCB0aGlzLmRpcmVjdGlvbiwgczAgKTsKCgkJfQoKCQlpZiAoIG9wdGlvbmFsUG9pbnRPblNlZ21lbnQgKSB7CgoJCQlvcHRpb25hbFBvaW50T25TZWdtZW50LmNvcHkoIF9zZWdDZW50ZXIgKS5hZGRTY2FsZWRWZWN0b3IoIF9zZWdEaXIsIHMxICk7CgoJCX0KCgkJcmV0dXJuIHNxckRpc3Q7CgoJfQoKCWludGVyc2VjdFNwaGVyZSggc3BoZXJlLCB0YXJnZXQgKSB7CgoJCV92ZWN0b3IkYS5zdWJWZWN0b3JzKCBzcGhlcmUuY2VudGVyLCB0aGlzLm9yaWdpbiApOwoJCWNvbnN0IHRjYSA9IF92ZWN0b3IkYS5kb3QoIHRoaXMuZGlyZWN0aW9uICk7CgkJY29uc3QgZDIgPSBfdmVjdG9yJGEuZG90KCBfdmVjdG9yJGEgKSAtIHRjYSAqIHRjYTsKCQljb25zdCByYWRpdXMyID0gc3BoZXJlLnJhZGl1cyAqIHNwaGVyZS5yYWRpdXM7CgoJCWlmICggZDIgPiByYWRpdXMyICkgcmV0dXJuIG51bGw7CgoJCWNvbnN0IHRoYyA9IE1hdGguc3FydCggcmFkaXVzMiAtIGQyICk7CgoJCS8vIHQwID0gZmlyc3QgaW50ZXJzZWN0IHBvaW50IC0gZW50cmFuY2Ugb24gZnJvbnQgb2Ygc3BoZXJlCgkJY29uc3QgdDAgPSB0Y2EgLSB0aGM7CgoJCS8vIHQxID0gc2Vjb25kIGludGVyc2VjdCBwb2ludCAtIGV4aXQgcG9pbnQgb24gYmFjayBvZiBzcGhlcmUKCQljb25zdCB0MSA9IHRjYSArIHRoYzsKCgkJLy8gdGVzdCB0byBzZWUgaWYgdDEgaXMgYmVoaW5kIHRoZSByYXkgLSBpZiBzbywgcmV0dXJuIG51bGwKCQlpZiAoIHQxIDwgMCApIHJldHVybiBudWxsOwoKCQkvLyB0ZXN0IHRvIHNlZSBpZiB0MCBpcyBiZWhpbmQgdGhlIHJheToKCQkvLyBpZiBpdCBpcywgdGhlIHJheSBpcyBpbnNpZGUgdGhlIHNwaGVyZSwgc28gcmV0dXJuIHRoZSBzZWNvbmQgZXhpdCBwb2ludCBzY2FsZWQgYnkgdDEsCgkJLy8gaW4gb3JkZXIgdG8gYWx3YXlzIHJldHVybiBhbiBpbnRlcnNlY3QgcG9pbnQgdGhhdCBpcyBpbiBmcm9udCBvZiB0aGUgcmF5LgoJCWlmICggdDAgPCAwICkgcmV0dXJuIHRoaXMuYXQoIHQxLCB0YXJnZXQgKTsKCgkJLy8gZWxzZSB0MCBpcyBpbiBmcm9udCBvZiB0aGUgcmF5LCBzbyByZXR1cm4gdGhlIGZpcnN0IGNvbGxpc2lvbiBwb2ludCBzY2FsZWQgYnkgdDAKCQlyZXR1cm4gdGhpcy5hdCggdDAsIHRhcmdldCApOwoKCX0KCglpbnRlcnNlY3RzU3BoZXJlKCBzcGhlcmUgKSB7CgoJCXJldHVybiB0aGlzLmRpc3RhbmNlU3FUb1BvaW50KCBzcGhlcmUuY2VudGVyICkgPD0gKCBzcGhlcmUucmFkaXVzICogc3BoZXJlLnJhZGl1cyApOwoKCX0KCglkaXN0YW5jZVRvUGxhbmUoIHBsYW5lICkgewoKCQljb25zdCBkZW5vbWluYXRvciA9IHBsYW5lLm5vcm1hbC5kb3QoIHRoaXMuZGlyZWN0aW9uICk7CgoJCWlmICggZGVub21pbmF0b3IgPT09IDAgKSB7CgoJCQkvLyBsaW5lIGlzIGNvcGxhbmFyLCByZXR1cm4gb3JpZ2luCgkJCWlmICggcGxhbmUuZGlzdGFuY2VUb1BvaW50KCB0aGlzLm9yaWdpbiApID09PSAwICkgewoKCQkJCXJldHVybiAwOwoKCQkJfQoKCQkJLy8gTnVsbCBpcyBwcmVmZXJhYmxlIHRvIHVuZGVmaW5lZCBzaW5jZSB1bmRlZmluZWQgbWVhbnMuLi4uIGl0IGlzIHVuZGVmaW5lZAoKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJY29uc3QgdCA9IC0gKCB0aGlzLm9yaWdpbi5kb3QoIHBsYW5lLm5vcm1hbCApICsgcGxhbmUuY29uc3RhbnQgKSAvIGRlbm9taW5hdG9yOwoKCQkvLyBSZXR1cm4gaWYgdGhlIHJheSBuZXZlciBpbnRlcnNlY3RzIHRoZSBwbGFuZQoKCQlyZXR1cm4gdCA+PSAwID8gdCA6IG51bGw7CgoJfQoKCWludGVyc2VjdFBsYW5lKCBwbGFuZSwgdGFyZ2V0ICkgewoKCQljb25zdCB0ID0gdGhpcy5kaXN0YW5jZVRvUGxhbmUoIHBsYW5lICk7CgoJCWlmICggdCA9PT0gbnVsbCApIHsKCgkJCXJldHVybiBudWxsOwoKCQl9CgoJCXJldHVybiB0aGlzLmF0KCB0LCB0YXJnZXQgKTsKCgl9CgoJaW50ZXJzZWN0c1BsYW5lKCBwbGFuZSApIHsKCgkJLy8gY2hlY2sgaWYgdGhlIHJheSBsaWVzIG9uIHRoZSBwbGFuZSBmaXJzdAoKCQljb25zdCBkaXN0VG9Qb2ludCA9IHBsYW5lLmRpc3RhbmNlVG9Qb2ludCggdGhpcy5vcmlnaW4gKTsKCgkJaWYgKCBkaXN0VG9Qb2ludCA9PT0gMCApIHsKCgkJCXJldHVybiB0cnVlOwoKCQl9CgoJCWNvbnN0IGRlbm9taW5hdG9yID0gcGxhbmUubm9ybWFsLmRvdCggdGhpcy5kaXJlY3Rpb24gKTsKCgkJaWYgKCBkZW5vbWluYXRvciAqIGRpc3RUb1BvaW50IDwgMCApIHsKCgkJCXJldHVybiB0cnVlOwoKCQl9CgoJCS8vIHJheSBvcmlnaW4gaXMgYmVoaW5kIHRoZSBwbGFuZSAoYW5kIGlzIHBvaW50aW5nIGJlaGluZCBpdCkKCgkJcmV0dXJuIGZhbHNlOwoKCX0KCglpbnRlcnNlY3RCb3goIGJveCwgdGFyZ2V0ICkgewoKCQlsZXQgdG1pbiwgdG1heCwgdHltaW4sIHR5bWF4LCB0em1pbiwgdHptYXg7CgoJCWNvbnN0IGludmRpcnggPSAxIC8gdGhpcy5kaXJlY3Rpb24ueCwKCQkJaW52ZGlyeSA9IDEgLyB0aGlzLmRpcmVjdGlvbi55LAoJCQlpbnZkaXJ6ID0gMSAvIHRoaXMuZGlyZWN0aW9uLno7CgoJCWNvbnN0IG9yaWdpbiA9IHRoaXMub3JpZ2luOwoKCQlpZiAoIGludmRpcnggPj0gMCApIHsKCgkJCXRtaW4gPSAoIGJveC5taW4ueCAtIG9yaWdpbi54ICkgKiBpbnZkaXJ4OwoJCQl0bWF4ID0gKCBib3gubWF4LnggLSBvcmlnaW4ueCApICogaW52ZGlyeDsKCgkJfSBlbHNlIHsKCgkJCXRtaW4gPSAoIGJveC5tYXgueCAtIG9yaWdpbi54ICkgKiBpbnZkaXJ4OwoJCQl0bWF4ID0gKCBib3gubWluLnggLSBvcmlnaW4ueCApICogaW52ZGlyeDsKCgkJfQoKCQlpZiAoIGludmRpcnkgPj0gMCApIHsKCgkJCXR5bWluID0gKCBib3gubWluLnkgLSBvcmlnaW4ueSApICogaW52ZGlyeTsKCQkJdHltYXggPSAoIGJveC5tYXgueSAtIG9yaWdpbi55ICkgKiBpbnZkaXJ5OwoKCQl9IGVsc2UgewoKCQkJdHltaW4gPSAoIGJveC5tYXgueSAtIG9yaWdpbi55ICkgKiBpbnZkaXJ5OwoJCQl0eW1heCA9ICggYm94Lm1pbi55IC0gb3JpZ2luLnkgKSAqIGludmRpcnk7CgoJCX0KCgkJaWYgKCAoIHRtaW4gPiB0eW1heCApIHx8ICggdHltaW4gPiB0bWF4ICkgKSByZXR1cm4gbnVsbDsKCgkJaWYgKCB0eW1pbiA+IHRtaW4gfHwgaXNOYU4oIHRtaW4gKSApIHRtaW4gPSB0eW1pbjsKCgkJaWYgKCB0eW1heCA8IHRtYXggfHwgaXNOYU4oIHRtYXggKSApIHRtYXggPSB0eW1heDsKCgkJaWYgKCBpbnZkaXJ6ID49IDAgKSB7CgoJCQl0em1pbiA9ICggYm94Lm1pbi56IC0gb3JpZ2luLnogKSAqIGludmRpcno7CgkJCXR6bWF4ID0gKCBib3gubWF4LnogLSBvcmlnaW4ueiApICogaW52ZGlyejsKCgkJfSBlbHNlIHsKCgkJCXR6bWluID0gKCBib3gubWF4LnogLSBvcmlnaW4ueiApICogaW52ZGlyejsKCQkJdHptYXggPSAoIGJveC5taW4ueiAtIG9yaWdpbi56ICkgKiBpbnZkaXJ6OwoKCQl9CgoJCWlmICggKCB0bWluID4gdHptYXggKSB8fCAoIHR6bWluID4gdG1heCApICkgcmV0dXJuIG51bGw7CgoJCWlmICggdHptaW4gPiB0bWluIHx8IHRtaW4gIT09IHRtaW4gKSB0bWluID0gdHptaW47CgoJCWlmICggdHptYXggPCB0bWF4IHx8IHRtYXggIT09IHRtYXggKSB0bWF4ID0gdHptYXg7CgoJCS8vcmV0dXJuIHBvaW50IGNsb3Nlc3QgdG8gdGhlIHJheSAocG9zaXRpdmUgc2lkZSkKCgkJaWYgKCB0bWF4IDwgMCApIHJldHVybiBudWxsOwoKCQlyZXR1cm4gdGhpcy5hdCggdG1pbiA+PSAwID8gdG1pbiA6IHRtYXgsIHRhcmdldCApOwoKCX0KCglpbnRlcnNlY3RzQm94KCBib3ggKSB7CgoJCXJldHVybiB0aGlzLmludGVyc2VjdEJveCggYm94LCBfdmVjdG9yJGEgKSAhPT0gbnVsbDsKCgl9CgoJaW50ZXJzZWN0VHJpYW5nbGUoIGEsIGIsIGMsIGJhY2tmYWNlQ3VsbGluZywgdGFyZ2V0ICkgewoKCQkvLyBDb21wdXRlIHRoZSBvZmZzZXQgb3JpZ2luLCBlZGdlcywgYW5kIG5vcm1hbC4KCgkJLy8gZnJvbSBodHRwczovL2dpdGh1Yi5jb20vcG1qb25pYWsvR2VvbWV0cmljVG9vbHMvYmxvYi9tYXN0ZXIvR1RFbmdpbmUvSW5jbHVkZS9NYXRoZW1hdGljcy9HdGVJbnRyUmF5M1RyaWFuZ2xlMy5oCgoJCV9lZGdlMS5zdWJWZWN0b3JzKCBiLCBhICk7CgkJX2VkZ2UyLnN1YlZlY3RvcnMoIGMsIGEgKTsKCQlfbm9ybWFsJDEuY3Jvc3NWZWN0b3JzKCBfZWRnZTEsIF9lZGdlMiApOwoKCQkvLyBTb2x2ZSBRICsgdCpEID0gYjEqRTEgKyBiMipFMiAoUSA9IGtEaWZmLCBEID0gcmF5IGRpcmVjdGlvbiwKCQkvLyBFMSA9IGtFZGdlMSwgRTIgPSBrRWRnZTIsIE4gPSBDcm9zcyhFMSxFMikpIGJ5CgkJLy8gICB8RG90KEQsTil8KmIxID0gc2lnbihEb3QoRCxOKSkqRG90KEQsQ3Jvc3MoUSxFMikpCgkJLy8gICB8RG90KEQsTil8KmIyID0gc2lnbihEb3QoRCxOKSkqRG90KEQsQ3Jvc3MoRTEsUSkpCgkJLy8gICB8RG90KEQsTil8KnQgPSAtc2lnbihEb3QoRCxOKSkqRG90KFEsTikKCQlsZXQgRGROID0gdGhpcy5kaXJlY3Rpb24uZG90KCBfbm9ybWFsJDEgKTsKCQlsZXQgc2lnbjsKCgkJaWYgKCBEZE4gPiAwICkgewoKCQkJaWYgKCBiYWNrZmFjZUN1bGxpbmcgKSByZXR1cm4gbnVsbDsKCQkJc2lnbiA9IDE7CgoJCX0gZWxzZSBpZiAoIERkTiA8IDAgKSB7CgoJCQlzaWduID0gLSAxOwoJCQlEZE4gPSAtIERkTjsKCgkJfSBlbHNlIHsKCgkJCXJldHVybiBudWxsOwoKCQl9CgoJCV9kaWZmLnN1YlZlY3RvcnMoIHRoaXMub3JpZ2luLCBhICk7CgkJY29uc3QgRGRReEUyID0gc2lnbiAqIHRoaXMuZGlyZWN0aW9uLmRvdCggX2VkZ2UyLmNyb3NzVmVjdG9ycyggX2RpZmYsIF9lZGdlMiApICk7CgoJCS8vIGIxIDwgMCwgbm8gaW50ZXJzZWN0aW9uCgkJaWYgKCBEZFF4RTIgPCAwICkgewoKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJY29uc3QgRGRFMXhRID0gc2lnbiAqIHRoaXMuZGlyZWN0aW9uLmRvdCggX2VkZ2UxLmNyb3NzKCBfZGlmZiApICk7CgoJCS8vIGIyIDwgMCwgbm8gaW50ZXJzZWN0aW9uCgkJaWYgKCBEZEUxeFEgPCAwICkgewoKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJLy8gYjErYjIgPiAxLCBubyBpbnRlcnNlY3Rpb24KCQlpZiAoIERkUXhFMiArIERkRTF4USA+IERkTiApIHsKCgkJCXJldHVybiBudWxsOwoKCQl9CgoJCS8vIExpbmUgaW50ZXJzZWN0cyB0cmlhbmdsZSwgY2hlY2sgaWYgcmF5IGRvZXMuCgkJY29uc3QgUWROID0gLSBzaWduICogX2RpZmYuZG90KCBfbm9ybWFsJDEgKTsKCgkJLy8gdCA8IDAsIG5vIGludGVyc2VjdGlvbgoJCWlmICggUWROIDwgMCApIHsKCgkJCXJldHVybiBudWxsOwoKCQl9CgoJCS8vIFJheSBpbnRlcnNlY3RzIHRyaWFuZ2xlLgoJCXJldHVybiB0aGlzLmF0KCBRZE4gLyBEZE4sIHRhcmdldCApOwoKCX0KCglhcHBseU1hdHJpeDQoIG1hdHJpeDQgKSB7CgoJCXRoaXMub3JpZ2luLmFwcGx5TWF0cml4NCggbWF0cml4NCApOwoJCXRoaXMuZGlyZWN0aW9uLnRyYW5zZm9ybURpcmVjdGlvbiggbWF0cml4NCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXF1YWxzKCByYXkgKSB7CgoJCXJldHVybiByYXkub3JpZ2luLmVxdWFscyggdGhpcy5vcmlnaW4gKSAmJiByYXkuZGlyZWN0aW9uLmVxdWFscyggdGhpcy5kaXJlY3Rpb24gKTsKCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkoIHRoaXMgKTsKCgl9Cgp9CgpjbGFzcyBNYXRyaXg0IHsKCgljb25zdHJ1Y3RvciggbjExLCBuMTIsIG4xMywgbjE0LCBuMjEsIG4yMiwgbjIzLCBuMjQsIG4zMSwgbjMyLCBuMzMsIG4zNCwgbjQxLCBuNDIsIG40MywgbjQ0ICkgewoKCQlNYXRyaXg0LnByb3RvdHlwZS5pc01hdHJpeDQgPSB0cnVlOwoKCQl0aGlzLmVsZW1lbnRzID0gWwoKCQkJMSwgMCwgMCwgMCwKCQkJMCwgMSwgMCwgMCwKCQkJMCwgMCwgMSwgMCwKCQkJMCwgMCwgMCwgMQoKCQldOwoKCQlpZiAoIG4xMSAhPT0gdW5kZWZpbmVkICkgewoKCQkJdGhpcy5zZXQoIG4xMSwgbjEyLCBuMTMsIG4xNCwgbjIxLCBuMjIsIG4yMywgbjI0LCBuMzEsIG4zMiwgbjMzLCBuMzQsIG40MSwgbjQyLCBuNDMsIG40NCApOwoKCQl9CgoJfQoKCXNldCggbjExLCBuMTIsIG4xMywgbjE0LCBuMjEsIG4yMiwgbjIzLCBuMjQsIG4zMSwgbjMyLCBuMzMsIG4zNCwgbjQxLCBuNDIsIG40MywgbjQ0ICkgewoKCQljb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CgoJCXRlWyAwIF0gPSBuMTE7IHRlWyA0IF0gPSBuMTI7IHRlWyA4IF0gPSBuMTM7IHRlWyAxMiBdID0gbjE0OwoJCXRlWyAxIF0gPSBuMjE7IHRlWyA1IF0gPSBuMjI7IHRlWyA5IF0gPSBuMjM7IHRlWyAxMyBdID0gbjI0OwoJCXRlWyAyIF0gPSBuMzE7IHRlWyA2IF0gPSBuMzI7IHRlWyAxMCBdID0gbjMzOyB0ZVsgMTQgXSA9IG4zNDsKCQl0ZVsgMyBdID0gbjQxOyB0ZVsgNyBdID0gbjQyOyB0ZVsgMTEgXSA9IG40MzsgdGVbIDE1IF0gPSBuNDQ7CgoJCXJldHVybiB0aGlzOwoKCX0KCglpZGVudGl0eSgpIHsKCgkJdGhpcy5zZXQoCgoJCQkxLCAwLCAwLCAwLAoJCQkwLCAxLCAwLCAwLAoJCQkwLCAwLCAxLCAwLAoJCQkwLCAwLCAwLCAxCgoJCSk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyBNYXRyaXg0KCkuZnJvbUFycmF5KCB0aGlzLmVsZW1lbnRzICk7CgoJfQoKCWNvcHkoIG0gKSB7CgoJCWNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKCQljb25zdCBtZSA9IG0uZWxlbWVudHM7CgoJCXRlWyAwIF0gPSBtZVsgMCBdOyB0ZVsgMSBdID0gbWVbIDEgXTsgdGVbIDIgXSA9IG1lWyAyIF07IHRlWyAzIF0gPSBtZVsgMyBdOwoJCXRlWyA0IF0gPSBtZVsgNCBdOyB0ZVsgNSBdID0gbWVbIDUgXTsgdGVbIDYgXSA9IG1lWyA2IF07IHRlWyA3IF0gPSBtZVsgNyBdOwoJCXRlWyA4IF0gPSBtZVsgOCBdOyB0ZVsgOSBdID0gbWVbIDkgXTsgdGVbIDEwIF0gPSBtZVsgMTAgXTsgdGVbIDExIF0gPSBtZVsgMTEgXTsKCQl0ZVsgMTIgXSA9IG1lWyAxMiBdOyB0ZVsgMTMgXSA9IG1lWyAxMyBdOyB0ZVsgMTQgXSA9IG1lWyAxNCBdOyB0ZVsgMTUgXSA9IG1lWyAxNSBdOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY29weVBvc2l0aW9uKCBtICkgewoKCQljb25zdCB0ZSA9IHRoaXMuZWxlbWVudHMsIG1lID0gbS5lbGVtZW50czsKCgkJdGVbIDEyIF0gPSBtZVsgMTIgXTsKCQl0ZVsgMTMgXSA9IG1lWyAxMyBdOwoJCXRlWyAxNCBdID0gbWVbIDE0IF07CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tTWF0cml4MyggbSApIHsKCgkJY29uc3QgbWUgPSBtLmVsZW1lbnRzOwoKCQl0aGlzLnNldCgKCgkJCW1lWyAwIF0sIG1lWyAzIF0sIG1lWyA2IF0sIDAsCgkJCW1lWyAxIF0sIG1lWyA0IF0sIG1lWyA3IF0sIDAsCgkJCW1lWyAyIF0sIG1lWyA1IF0sIG1lWyA4IF0sIDAsCgkJCTAsIDAsIDAsIDEKCgkJKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWV4dHJhY3RCYXNpcyggeEF4aXMsIHlBeGlzLCB6QXhpcyApIHsKCgkJeEF4aXMuc2V0RnJvbU1hdHJpeENvbHVtbiggdGhpcywgMCApOwoJCXlBeGlzLnNldEZyb21NYXRyaXhDb2x1bW4oIHRoaXMsIDEgKTsKCQl6QXhpcy5zZXRGcm9tTWF0cml4Q29sdW1uKCB0aGlzLCAyICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltYWtlQmFzaXMoIHhBeGlzLCB5QXhpcywgekF4aXMgKSB7CgoJCXRoaXMuc2V0KAoJCQl4QXhpcy54LCB5QXhpcy54LCB6QXhpcy54LCAwLAoJCQl4QXhpcy55LCB5QXhpcy55LCB6QXhpcy55LCAwLAoJCQl4QXhpcy56LCB5QXhpcy56LCB6QXhpcy56LCAwLAoJCQkwLCAwLCAwLCAxCgkJKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWV4dHJhY3RSb3RhdGlvbiggbSApIHsKCgkJLy8gdGhpcyBtZXRob2QgZG9lcyBub3Qgc3VwcG9ydCByZWZsZWN0aW9uIG1hdHJpY2VzCgoJCWNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKCQljb25zdCBtZSA9IG0uZWxlbWVudHM7CgoJCWNvbnN0IHNjYWxlWCA9IDEgLyBfdjEkNS5zZXRGcm9tTWF0cml4Q29sdW1uKCBtLCAwICkubGVuZ3RoKCk7CgkJY29uc3Qgc2NhbGVZID0gMSAvIF92MSQ1LnNldEZyb21NYXRyaXhDb2x1bW4oIG0sIDEgKS5sZW5ndGgoKTsKCQljb25zdCBzY2FsZVogPSAxIC8gX3YxJDUuc2V0RnJvbU1hdHJpeENvbHVtbiggbSwgMiApLmxlbmd0aCgpOwoKCQl0ZVsgMCBdID0gbWVbIDAgXSAqIHNjYWxlWDsKCQl0ZVsgMSBdID0gbWVbIDEgXSAqIHNjYWxlWDsKCQl0ZVsgMiBdID0gbWVbIDIgXSAqIHNjYWxlWDsKCQl0ZVsgMyBdID0gMDsKCgkJdGVbIDQgXSA9IG1lWyA0IF0gKiBzY2FsZVk7CgkJdGVbIDUgXSA9IG1lWyA1IF0gKiBzY2FsZVk7CgkJdGVbIDYgXSA9IG1lWyA2IF0gKiBzY2FsZVk7CgkJdGVbIDcgXSA9IDA7CgoJCXRlWyA4IF0gPSBtZVsgOCBdICogc2NhbGVaOwoJCXRlWyA5IF0gPSBtZVsgOSBdICogc2NhbGVaOwoJCXRlWyAxMCBdID0gbWVbIDEwIF0gKiBzY2FsZVo7CgkJdGVbIDExIF0gPSAwOwoKCQl0ZVsgMTIgXSA9IDA7CgkJdGVbIDEzIF0gPSAwOwoJCXRlWyAxNCBdID0gMDsKCQl0ZVsgMTUgXSA9IDE7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltYWtlUm90YXRpb25Gcm9tRXVsZXIoIGV1bGVyICkgewoKCQljb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CgoJCWNvbnN0IHggPSBldWxlci54LCB5ID0gZXVsZXIueSwgeiA9IGV1bGVyLno7CgkJY29uc3QgYSA9IE1hdGguY29zKCB4ICksIGIgPSBNYXRoLnNpbiggeCApOwoJCWNvbnN0IGMgPSBNYXRoLmNvcyggeSApLCBkID0gTWF0aC5zaW4oIHkgKTsKCQljb25zdCBlID0gTWF0aC5jb3MoIHogKSwgZiA9IE1hdGguc2luKCB6ICk7CgoJCWlmICggZXVsZXIub3JkZXIgPT09ICdYWVonICkgewoKCQkJY29uc3QgYWUgPSBhICogZSwgYWYgPSBhICogZiwgYmUgPSBiICogZSwgYmYgPSBiICogZjsKCgkJCXRlWyAwIF0gPSBjICogZTsKCQkJdGVbIDQgXSA9IC0gYyAqIGY7CgkJCXRlWyA4IF0gPSBkOwoKCQkJdGVbIDEgXSA9IGFmICsgYmUgKiBkOwoJCQl0ZVsgNSBdID0gYWUgLSBiZiAqIGQ7CgkJCXRlWyA5IF0gPSAtIGIgKiBjOwoKCQkJdGVbIDIgXSA9IGJmIC0gYWUgKiBkOwoJCQl0ZVsgNiBdID0gYmUgKyBhZiAqIGQ7CgkJCXRlWyAxMCBdID0gYSAqIGM7CgoJCX0gZWxzZSBpZiAoIGV1bGVyLm9yZGVyID09PSAnWVhaJyApIHsKCgkJCWNvbnN0IGNlID0gYyAqIGUsIGNmID0gYyAqIGYsIGRlID0gZCAqIGUsIGRmID0gZCAqIGY7CgoJCQl0ZVsgMCBdID0gY2UgKyBkZiAqIGI7CgkJCXRlWyA0IF0gPSBkZSAqIGIgLSBjZjsKCQkJdGVbIDggXSA9IGEgKiBkOwoKCQkJdGVbIDEgXSA9IGEgKiBmOwoJCQl0ZVsgNSBdID0gYSAqIGU7CgkJCXRlWyA5IF0gPSAtIGI7CgoJCQl0ZVsgMiBdID0gY2YgKiBiIC0gZGU7CgkJCXRlWyA2IF0gPSBkZiArIGNlICogYjsKCQkJdGVbIDEwIF0gPSBhICogYzsKCgkJfSBlbHNlIGlmICggZXVsZXIub3JkZXIgPT09ICdaWFknICkgewoKCQkJY29uc3QgY2UgPSBjICogZSwgY2YgPSBjICogZiwgZGUgPSBkICogZSwgZGYgPSBkICogZjsKCgkJCXRlWyAwIF0gPSBjZSAtIGRmICogYjsKCQkJdGVbIDQgXSA9IC0gYSAqIGY7CgkJCXRlWyA4IF0gPSBkZSArIGNmICogYjsKCgkJCXRlWyAxIF0gPSBjZiArIGRlICogYjsKCQkJdGVbIDUgXSA9IGEgKiBlOwoJCQl0ZVsgOSBdID0gZGYgLSBjZSAqIGI7CgoJCQl0ZVsgMiBdID0gLSBhICogZDsKCQkJdGVbIDYgXSA9IGI7CgkJCXRlWyAxMCBdID0gYSAqIGM7CgoJCX0gZWxzZSBpZiAoIGV1bGVyLm9yZGVyID09PSAnWllYJyApIHsKCgkJCWNvbnN0IGFlID0gYSAqIGUsIGFmID0gYSAqIGYsIGJlID0gYiAqIGUsIGJmID0gYiAqIGY7CgoJCQl0ZVsgMCBdID0gYyAqIGU7CgkJCXRlWyA0IF0gPSBiZSAqIGQgLSBhZjsKCQkJdGVbIDggXSA9IGFlICogZCArIGJmOwoKCQkJdGVbIDEgXSA9IGMgKiBmOwoJCQl0ZVsgNSBdID0gYmYgKiBkICsgYWU7CgkJCXRlWyA5IF0gPSBhZiAqIGQgLSBiZTsKCgkJCXRlWyAyIF0gPSAtIGQ7CgkJCXRlWyA2IF0gPSBiICogYzsKCQkJdGVbIDEwIF0gPSBhICogYzsKCgkJfSBlbHNlIGlmICggZXVsZXIub3JkZXIgPT09ICdZWlgnICkgewoKCQkJY29uc3QgYWMgPSBhICogYywgYWQgPSBhICogZCwgYmMgPSBiICogYywgYmQgPSBiICogZDsKCgkJCXRlWyAwIF0gPSBjICogZTsKCQkJdGVbIDQgXSA9IGJkIC0gYWMgKiBmOwoJCQl0ZVsgOCBdID0gYmMgKiBmICsgYWQ7CgoJCQl0ZVsgMSBdID0gZjsKCQkJdGVbIDUgXSA9IGEgKiBlOwoJCQl0ZVsgOSBdID0gLSBiICogZTsKCgkJCXRlWyAyIF0gPSAtIGQgKiBlOwoJCQl0ZVsgNiBdID0gYWQgKiBmICsgYmM7CgkJCXRlWyAxMCBdID0gYWMgLSBiZCAqIGY7CgoJCX0gZWxzZSBpZiAoIGV1bGVyLm9yZGVyID09PSAnWFpZJyApIHsKCgkJCWNvbnN0IGFjID0gYSAqIGMsIGFkID0gYSAqIGQsIGJjID0gYiAqIGMsIGJkID0gYiAqIGQ7CgoJCQl0ZVsgMCBdID0gYyAqIGU7CgkJCXRlWyA0IF0gPSAtIGY7CgkJCXRlWyA4IF0gPSBkICogZTsKCgkJCXRlWyAxIF0gPSBhYyAqIGYgKyBiZDsKCQkJdGVbIDUgXSA9IGEgKiBlOwoJCQl0ZVsgOSBdID0gYWQgKiBmIC0gYmM7CgoJCQl0ZVsgMiBdID0gYmMgKiBmIC0gYWQ7CgkJCXRlWyA2IF0gPSBiICogZTsKCQkJdGVbIDEwIF0gPSBiZCAqIGYgKyBhYzsKCgkJfQoKCQkvLyBib3R0b20gcm93CgkJdGVbIDMgXSA9IDA7CgkJdGVbIDcgXSA9IDA7CgkJdGVbIDExIF0gPSAwOwoKCQkvLyBsYXN0IGNvbHVtbgoJCXRlWyAxMiBdID0gMDsKCQl0ZVsgMTMgXSA9IDA7CgkJdGVbIDE0IF0gPSAwOwoJCXRlWyAxNSBdID0gMTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW1ha2VSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKCBxICkgewoKCQlyZXR1cm4gdGhpcy5jb21wb3NlKCBfemVybywgcSwgX29uZSApOwoKCX0KCglsb29rQXQoIGV5ZSwgdGFyZ2V0LCB1cCApIHsKCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoKCQlfei5zdWJWZWN0b3JzKCBleWUsIHRhcmdldCApOwoKCQlpZiAoIF96Lmxlbmd0aFNxKCkgPT09IDAgKSB7CgoJCQkvLyBleWUgYW5kIHRhcmdldCBhcmUgaW4gdGhlIHNhbWUgcG9zaXRpb24KCgkJCV96LnogPSAxOwoKCQl9CgoJCV96Lm5vcm1hbGl6ZSgpOwoJCV94LmNyb3NzVmVjdG9ycyggdXAsIF96ICk7CgoJCWlmICggX3gubGVuZ3RoU3EoKSA9PT0gMCApIHsKCgkJCS8vIHVwIGFuZCB6IGFyZSBwYXJhbGxlbAoKCQkJaWYgKCBNYXRoLmFicyggdXAueiApID09PSAxICkgewoKCQkJCV96LnggKz0gMC4wMDAxOwoKCQkJfSBlbHNlIHsKCgkJCQlfei56ICs9IDAuMDAwMTsKCgkJCX0KCgkJCV96Lm5vcm1hbGl6ZSgpOwoJCQlfeC5jcm9zc1ZlY3RvcnMoIHVwLCBfeiApOwoKCQl9CgoJCV94Lm5vcm1hbGl6ZSgpOwoJCV95LmNyb3NzVmVjdG9ycyggX3osIF94ICk7CgoJCXRlWyAwIF0gPSBfeC54OyB0ZVsgNCBdID0gX3kueDsgdGVbIDggXSA9IF96Lng7CgkJdGVbIDEgXSA9IF94Lnk7IHRlWyA1IF0gPSBfeS55OyB0ZVsgOSBdID0gX3oueTsKCQl0ZVsgMiBdID0gX3guejsgdGVbIDYgXSA9IF95Lno7IHRlWyAxMCBdID0gX3ouejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW11bHRpcGx5KCBtICkgewoKCQlyZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKCB0aGlzLCBtICk7CgoJfQoKCXByZW11bHRpcGx5KCBtICkgewoKCQlyZXR1cm4gdGhpcy5tdWx0aXBseU1hdHJpY2VzKCBtLCB0aGlzICk7CgoJfQoKCW11bHRpcGx5TWF0cmljZXMoIGEsIGIgKSB7CgoJCWNvbnN0IGFlID0gYS5lbGVtZW50czsKCQljb25zdCBiZSA9IGIuZWxlbWVudHM7CgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoKCQljb25zdCBhMTEgPSBhZVsgMCBdLCBhMTIgPSBhZVsgNCBdLCBhMTMgPSBhZVsgOCBdLCBhMTQgPSBhZVsgMTIgXTsKCQljb25zdCBhMjEgPSBhZVsgMSBdLCBhMjIgPSBhZVsgNSBdLCBhMjMgPSBhZVsgOSBdLCBhMjQgPSBhZVsgMTMgXTsKCQljb25zdCBhMzEgPSBhZVsgMiBdLCBhMzIgPSBhZVsgNiBdLCBhMzMgPSBhZVsgMTAgXSwgYTM0ID0gYWVbIDE0IF07CgkJY29uc3QgYTQxID0gYWVbIDMgXSwgYTQyID0gYWVbIDcgXSwgYTQzID0gYWVbIDExIF0sIGE0NCA9IGFlWyAxNSBdOwoKCQljb25zdCBiMTEgPSBiZVsgMCBdLCBiMTIgPSBiZVsgNCBdLCBiMTMgPSBiZVsgOCBdLCBiMTQgPSBiZVsgMTIgXTsKCQljb25zdCBiMjEgPSBiZVsgMSBdLCBiMjIgPSBiZVsgNSBdLCBiMjMgPSBiZVsgOSBdLCBiMjQgPSBiZVsgMTMgXTsKCQljb25zdCBiMzEgPSBiZVsgMiBdLCBiMzIgPSBiZVsgNiBdLCBiMzMgPSBiZVsgMTAgXSwgYjM0ID0gYmVbIDE0IF07CgkJY29uc3QgYjQxID0gYmVbIDMgXSwgYjQyID0gYmVbIDcgXSwgYjQzID0gYmVbIDExIF0sIGI0NCA9IGJlWyAxNSBdOwoKCQl0ZVsgMCBdID0gYTExICogYjExICsgYTEyICogYjIxICsgYTEzICogYjMxICsgYTE0ICogYjQxOwoJCXRlWyA0IF0gPSBhMTEgKiBiMTIgKyBhMTIgKiBiMjIgKyBhMTMgKiBiMzIgKyBhMTQgKiBiNDI7CgkJdGVbIDggXSA9IGExMSAqIGIxMyArIGExMiAqIGIyMyArIGExMyAqIGIzMyArIGExNCAqIGI0MzsKCQl0ZVsgMTIgXSA9IGExMSAqIGIxNCArIGExMiAqIGIyNCArIGExMyAqIGIzNCArIGExNCAqIGI0NDsKCgkJdGVbIDEgXSA9IGEyMSAqIGIxMSArIGEyMiAqIGIyMSArIGEyMyAqIGIzMSArIGEyNCAqIGI0MTsKCQl0ZVsgNSBdID0gYTIxICogYjEyICsgYTIyICogYjIyICsgYTIzICogYjMyICsgYTI0ICogYjQyOwoJCXRlWyA5IF0gPSBhMjEgKiBiMTMgKyBhMjIgKiBiMjMgKyBhMjMgKiBiMzMgKyBhMjQgKiBiNDM7CgkJdGVbIDEzIF0gPSBhMjEgKiBiMTQgKyBhMjIgKiBiMjQgKyBhMjMgKiBiMzQgKyBhMjQgKiBiNDQ7CgoJCXRlWyAyIF0gPSBhMzEgKiBiMTEgKyBhMzIgKiBiMjEgKyBhMzMgKiBiMzEgKyBhMzQgKiBiNDE7CgkJdGVbIDYgXSA9IGEzMSAqIGIxMiArIGEzMiAqIGIyMiArIGEzMyAqIGIzMiArIGEzNCAqIGI0MjsKCQl0ZVsgMTAgXSA9IGEzMSAqIGIxMyArIGEzMiAqIGIyMyArIGEzMyAqIGIzMyArIGEzNCAqIGI0MzsKCQl0ZVsgMTQgXSA9IGEzMSAqIGIxNCArIGEzMiAqIGIyNCArIGEzMyAqIGIzNCArIGEzNCAqIGI0NDsKCgkJdGVbIDMgXSA9IGE0MSAqIGIxMSArIGE0MiAqIGIyMSArIGE0MyAqIGIzMSArIGE0NCAqIGI0MTsKCQl0ZVsgNyBdID0gYTQxICogYjEyICsgYTQyICogYjIyICsgYTQzICogYjMyICsgYTQ0ICogYjQyOwoJCXRlWyAxMSBdID0gYTQxICogYjEzICsgYTQyICogYjIzICsgYTQzICogYjMzICsgYTQ0ICogYjQzOwoJCXRlWyAxNSBdID0gYTQxICogYjE0ICsgYTQyICogYjI0ICsgYTQzICogYjM0ICsgYTQ0ICogYjQ0OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbXVsdGlwbHlTY2FsYXIoIHMgKSB7CgoJCWNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKCgkJdGVbIDAgXSAqPSBzOyB0ZVsgNCBdICo9IHM7IHRlWyA4IF0gKj0gczsgdGVbIDEyIF0gKj0gczsKCQl0ZVsgMSBdICo9IHM7IHRlWyA1IF0gKj0gczsgdGVbIDkgXSAqPSBzOyB0ZVsgMTMgXSAqPSBzOwoJCXRlWyAyIF0gKj0gczsgdGVbIDYgXSAqPSBzOyB0ZVsgMTAgXSAqPSBzOyB0ZVsgMTQgXSAqPSBzOwoJCXRlWyAzIF0gKj0gczsgdGVbIDcgXSAqPSBzOyB0ZVsgMTEgXSAqPSBzOyB0ZVsgMTUgXSAqPSBzOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZGV0ZXJtaW5hbnQoKSB7CgoJCWNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKCgkJY29uc3QgbjExID0gdGVbIDAgXSwgbjEyID0gdGVbIDQgXSwgbjEzID0gdGVbIDggXSwgbjE0ID0gdGVbIDEyIF07CgkJY29uc3QgbjIxID0gdGVbIDEgXSwgbjIyID0gdGVbIDUgXSwgbjIzID0gdGVbIDkgXSwgbjI0ID0gdGVbIDEzIF07CgkJY29uc3QgbjMxID0gdGVbIDIgXSwgbjMyID0gdGVbIDYgXSwgbjMzID0gdGVbIDEwIF0sIG4zNCA9IHRlWyAxNCBdOwoJCWNvbnN0IG40MSA9IHRlWyAzIF0sIG40MiA9IHRlWyA3IF0sIG40MyA9IHRlWyAxMSBdLCBuNDQgPSB0ZVsgMTUgXTsKCgkJLy9UT0RPOiBtYWtlIHRoaXMgbW9yZSBlZmZpY2llbnQKCQkvLyggYmFzZWQgb24gaHR0cDovL3d3dy5ldWNsaWRlYW5zcGFjZS5jb20vbWF0aHMvYWxnZWJyYS9tYXRyaXgvZnVuY3Rpb25zL2ludmVyc2UvZm91ckQvaW5kZXguaHRtICkKCgkJcmV0dXJuICgKCQkJbjQxICogKAoJCQkJKyBuMTQgKiBuMjMgKiBuMzIKCQkJCSAtIG4xMyAqIG4yNCAqIG4zMgoJCQkJIC0gbjE0ICogbjIyICogbjMzCgkJCQkgKyBuMTIgKiBuMjQgKiBuMzMKCQkJCSArIG4xMyAqIG4yMiAqIG4zNAoJCQkJIC0gbjEyICogbjIzICogbjM0CgkJCSkgKwoJCQluNDIgKiAoCgkJCQkrIG4xMSAqIG4yMyAqIG4zNAoJCQkJIC0gbjExICogbjI0ICogbjMzCgkJCQkgKyBuMTQgKiBuMjEgKiBuMzMKCQkJCSAtIG4xMyAqIG4yMSAqIG4zNAoJCQkJICsgbjEzICogbjI0ICogbjMxCgkJCQkgLSBuMTQgKiBuMjMgKiBuMzEKCQkJKSArCgkJCW40MyAqICgKCQkJCSsgbjExICogbjI0ICogbjMyCgkJCQkgLSBuMTEgKiBuMjIgKiBuMzQKCQkJCSAtIG4xNCAqIG4yMSAqIG4zMgoJCQkJICsgbjEyICogbjIxICogbjM0CgkJCQkgKyBuMTQgKiBuMjIgKiBuMzEKCQkJCSAtIG4xMiAqIG4yNCAqIG4zMQoJCQkpICsKCQkJbjQ0ICogKAoJCQkJLSBuMTMgKiBuMjIgKiBuMzEKCQkJCSAtIG4xMSAqIG4yMyAqIG4zMgoJCQkJICsgbjExICogbjIyICogbjMzCgkJCQkgKyBuMTMgKiBuMjEgKiBuMzIKCQkJCSAtIG4xMiAqIG4yMSAqIG4zMwoJCQkJICsgbjEyICogbjIzICogbjMxCgkJCSkKCgkJKTsKCgl9CgoJdHJhbnNwb3NlKCkgewoKCQljb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CgkJbGV0IHRtcDsKCgkJdG1wID0gdGVbIDEgXTsgdGVbIDEgXSA9IHRlWyA0IF07IHRlWyA0IF0gPSB0bXA7CgkJdG1wID0gdGVbIDIgXTsgdGVbIDIgXSA9IHRlWyA4IF07IHRlWyA4IF0gPSB0bXA7CgkJdG1wID0gdGVbIDYgXTsgdGVbIDYgXSA9IHRlWyA5IF07IHRlWyA5IF0gPSB0bXA7CgoJCXRtcCA9IHRlWyAzIF07IHRlWyAzIF0gPSB0ZVsgMTIgXTsgdGVbIDEyIF0gPSB0bXA7CgkJdG1wID0gdGVbIDcgXTsgdGVbIDcgXSA9IHRlWyAxMyBdOyB0ZVsgMTMgXSA9IHRtcDsKCQl0bXAgPSB0ZVsgMTEgXTsgdGVbIDExIF0gPSB0ZVsgMTQgXTsgdGVbIDE0IF0gPSB0bXA7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRQb3NpdGlvbiggeCwgeSwgeiApIHsKCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoKCQlpZiAoIHguaXNWZWN0b3IzICkgewoKCQkJdGVbIDEyIF0gPSB4Lng7CgkJCXRlWyAxMyBdID0geC55OwoJCQl0ZVsgMTQgXSA9IHguejsKCgkJfSBlbHNlIHsKCgkJCXRlWyAxMiBdID0geDsKCQkJdGVbIDEzIF0gPSB5OwoJCQl0ZVsgMTQgXSA9IHo7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWludmVydCgpIHsKCgkJLy8gYmFzZWQgb24gaHR0cDovL3d3dy5ldWNsaWRlYW5zcGFjZS5jb20vbWF0aHMvYWxnZWJyYS9tYXRyaXgvZnVuY3Rpb25zL2ludmVyc2UvZm91ckQvaW5kZXguaHRtCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzLAoKCQkJbjExID0gdGVbIDAgXSwgbjIxID0gdGVbIDEgXSwgbjMxID0gdGVbIDIgXSwgbjQxID0gdGVbIDMgXSwKCQkJbjEyID0gdGVbIDQgXSwgbjIyID0gdGVbIDUgXSwgbjMyID0gdGVbIDYgXSwgbjQyID0gdGVbIDcgXSwKCQkJbjEzID0gdGVbIDggXSwgbjIzID0gdGVbIDkgXSwgbjMzID0gdGVbIDEwIF0sIG40MyA9IHRlWyAxMSBdLAoJCQluMTQgPSB0ZVsgMTIgXSwgbjI0ID0gdGVbIDEzIF0sIG4zNCA9IHRlWyAxNCBdLCBuNDQgPSB0ZVsgMTUgXSwKCgkJCXQxMSA9IG4yMyAqIG4zNCAqIG40MiAtIG4yNCAqIG4zMyAqIG40MiArIG4yNCAqIG4zMiAqIG40MyAtIG4yMiAqIG4zNCAqIG40MyAtIG4yMyAqIG4zMiAqIG40NCArIG4yMiAqIG4zMyAqIG40NCwKCQkJdDEyID0gbjE0ICogbjMzICogbjQyIC0gbjEzICogbjM0ICogbjQyIC0gbjE0ICogbjMyICogbjQzICsgbjEyICogbjM0ICogbjQzICsgbjEzICogbjMyICogbjQ0IC0gbjEyICogbjMzICogbjQ0LAoJCQl0MTMgPSBuMTMgKiBuMjQgKiBuNDIgLSBuMTQgKiBuMjMgKiBuNDIgKyBuMTQgKiBuMjIgKiBuNDMgLSBuMTIgKiBuMjQgKiBuNDMgLSBuMTMgKiBuMjIgKiBuNDQgKyBuMTIgKiBuMjMgKiBuNDQsCgkJCXQxNCA9IG4xNCAqIG4yMyAqIG4zMiAtIG4xMyAqIG4yNCAqIG4zMiAtIG4xNCAqIG4yMiAqIG4zMyArIG4xMiAqIG4yNCAqIG4zMyArIG4xMyAqIG4yMiAqIG4zNCAtIG4xMiAqIG4yMyAqIG4zNDsKCgkJY29uc3QgZGV0ID0gbjExICogdDExICsgbjIxICogdDEyICsgbjMxICogdDEzICsgbjQxICogdDE0OwoKCQlpZiAoIGRldCA9PT0gMCApIHJldHVybiB0aGlzLnNldCggMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCApOwoKCQljb25zdCBkZXRJbnYgPSAxIC8gZGV0OwoKCQl0ZVsgMCBdID0gdDExICogZGV0SW52OwoJCXRlWyAxIF0gPSAoIG4yNCAqIG4zMyAqIG40MSAtIG4yMyAqIG4zNCAqIG40MSAtIG4yNCAqIG4zMSAqIG40MyArIG4yMSAqIG4zNCAqIG40MyArIG4yMyAqIG4zMSAqIG40NCAtIG4yMSAqIG4zMyAqIG40NCApICogZGV0SW52OwoJCXRlWyAyIF0gPSAoIG4yMiAqIG4zNCAqIG40MSAtIG4yNCAqIG4zMiAqIG40MSArIG4yNCAqIG4zMSAqIG40MiAtIG4yMSAqIG4zNCAqIG40MiAtIG4yMiAqIG4zMSAqIG40NCArIG4yMSAqIG4zMiAqIG40NCApICogZGV0SW52OwoJCXRlWyAzIF0gPSAoIG4yMyAqIG4zMiAqIG40MSAtIG4yMiAqIG4zMyAqIG40MSAtIG4yMyAqIG4zMSAqIG40MiArIG4yMSAqIG4zMyAqIG40MiArIG4yMiAqIG4zMSAqIG40MyAtIG4yMSAqIG4zMiAqIG40MyApICogZGV0SW52OwoKCQl0ZVsgNCBdID0gdDEyICogZGV0SW52OwoJCXRlWyA1IF0gPSAoIG4xMyAqIG4zNCAqIG40MSAtIG4xNCAqIG4zMyAqIG40MSArIG4xNCAqIG4zMSAqIG40MyAtIG4xMSAqIG4zNCAqIG40MyAtIG4xMyAqIG4zMSAqIG40NCArIG4xMSAqIG4zMyAqIG40NCApICogZGV0SW52OwoJCXRlWyA2IF0gPSAoIG4xNCAqIG4zMiAqIG40MSAtIG4xMiAqIG4zNCAqIG40MSAtIG4xNCAqIG4zMSAqIG40MiArIG4xMSAqIG4zNCAqIG40MiArIG4xMiAqIG4zMSAqIG40NCAtIG4xMSAqIG4zMiAqIG40NCApICogZGV0SW52OwoJCXRlWyA3IF0gPSAoIG4xMiAqIG4zMyAqIG40MSAtIG4xMyAqIG4zMiAqIG40MSArIG4xMyAqIG4zMSAqIG40MiAtIG4xMSAqIG4zMyAqIG40MiAtIG4xMiAqIG4zMSAqIG40MyArIG4xMSAqIG4zMiAqIG40MyApICogZGV0SW52OwoKCQl0ZVsgOCBdID0gdDEzICogZGV0SW52OwoJCXRlWyA5IF0gPSAoIG4xNCAqIG4yMyAqIG40MSAtIG4xMyAqIG4yNCAqIG40MSAtIG4xNCAqIG4yMSAqIG40MyArIG4xMSAqIG4yNCAqIG40MyArIG4xMyAqIG4yMSAqIG40NCAtIG4xMSAqIG4yMyAqIG40NCApICogZGV0SW52OwoJCXRlWyAxMCBdID0gKCBuMTIgKiBuMjQgKiBuNDEgLSBuMTQgKiBuMjIgKiBuNDEgKyBuMTQgKiBuMjEgKiBuNDIgLSBuMTEgKiBuMjQgKiBuNDIgLSBuMTIgKiBuMjEgKiBuNDQgKyBuMTEgKiBuMjIgKiBuNDQgKSAqIGRldEludjsKCQl0ZVsgMTEgXSA9ICggbjEzICogbjIyICogbjQxIC0gbjEyICogbjIzICogbjQxIC0gbjEzICogbjIxICogbjQyICsgbjExICogbjIzICogbjQyICsgbjEyICogbjIxICogbjQzIC0gbjExICogbjIyICogbjQzICkgKiBkZXRJbnY7CgoJCXRlWyAxMiBdID0gdDE0ICogZGV0SW52OwoJCXRlWyAxMyBdID0gKCBuMTMgKiBuMjQgKiBuMzEgLSBuMTQgKiBuMjMgKiBuMzEgKyBuMTQgKiBuMjEgKiBuMzMgLSBuMTEgKiBuMjQgKiBuMzMgLSBuMTMgKiBuMjEgKiBuMzQgKyBuMTEgKiBuMjMgKiBuMzQgKSAqIGRldEludjsKCQl0ZVsgMTQgXSA9ICggbjE0ICogbjIyICogbjMxIC0gbjEyICogbjI0ICogbjMxIC0gbjE0ICogbjIxICogbjMyICsgbjExICogbjI0ICogbjMyICsgbjEyICogbjIxICogbjM0IC0gbjExICogbjIyICogbjM0ICkgKiBkZXRJbnY7CgkJdGVbIDE1IF0gPSAoIG4xMiAqIG4yMyAqIG4zMSAtIG4xMyAqIG4yMiAqIG4zMSArIG4xMyAqIG4yMSAqIG4zMiAtIG4xMSAqIG4yMyAqIG4zMiAtIG4xMiAqIG4yMSAqIG4zMyArIG4xMSAqIG4yMiAqIG4zMyApICogZGV0SW52OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2NhbGUoIHYgKSB7CgoJCWNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKCQljb25zdCB4ID0gdi54LCB5ID0gdi55LCB6ID0gdi56OwoKCQl0ZVsgMCBdICo9IHg7IHRlWyA0IF0gKj0geTsgdGVbIDggXSAqPSB6OwoJCXRlWyAxIF0gKj0geDsgdGVbIDUgXSAqPSB5OyB0ZVsgOSBdICo9IHo7CgkJdGVbIDIgXSAqPSB4OyB0ZVsgNiBdICo9IHk7IHRlWyAxMCBdICo9IHo7CgkJdGVbIDMgXSAqPSB4OyB0ZVsgNyBdICo9IHk7IHRlWyAxMSBdICo9IHo7CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRNYXhTY2FsZU9uQXhpcygpIHsKCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoKCQljb25zdCBzY2FsZVhTcSA9IHRlWyAwIF0gKiB0ZVsgMCBdICsgdGVbIDEgXSAqIHRlWyAxIF0gKyB0ZVsgMiBdICogdGVbIDIgXTsKCQljb25zdCBzY2FsZVlTcSA9IHRlWyA0IF0gKiB0ZVsgNCBdICsgdGVbIDUgXSAqIHRlWyA1IF0gKyB0ZVsgNiBdICogdGVbIDYgXTsKCQljb25zdCBzY2FsZVpTcSA9IHRlWyA4IF0gKiB0ZVsgOCBdICsgdGVbIDkgXSAqIHRlWyA5IF0gKyB0ZVsgMTAgXSAqIHRlWyAxMCBdOwoKCQlyZXR1cm4gTWF0aC5zcXJ0KCBNYXRoLm1heCggc2NhbGVYU3EsIHNjYWxlWVNxLCBzY2FsZVpTcSApICk7CgoJfQoKCW1ha2VUcmFuc2xhdGlvbiggeCwgeSwgeiApIHsKCgkJaWYgKCB4LmlzVmVjdG9yMyApIHsKCgkJCXRoaXMuc2V0KAoKCQkJCTEsIDAsIDAsIHgueCwKCQkJCTAsIDEsIDAsIHgueSwKCQkJCTAsIDAsIDEsIHgueiwKCQkJCTAsIDAsIDAsIDEKCgkJCSk7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLnNldCgKCgkJCQkxLCAwLCAwLCB4LAoJCQkJMCwgMSwgMCwgeSwKCQkJCTAsIDAsIDEsIHosCgkJCQkwLCAwLCAwLCAxCgoJCQkpOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCgltYWtlUm90YXRpb25YKCB0aGV0YSApIHsKCgkJY29uc3QgYyA9IE1hdGguY29zKCB0aGV0YSApLCBzID0gTWF0aC5zaW4oIHRoZXRhICk7CgoJCXRoaXMuc2V0KAoKCQkJMSwgMCwgMCwgMCwKCQkJMCwgYywgLSBzLCAwLAoJCQkwLCBzLCBjLCAwLAoJCQkwLCAwLCAwLCAxCgoJCSk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltYWtlUm90YXRpb25ZKCB0aGV0YSApIHsKCgkJY29uc3QgYyA9IE1hdGguY29zKCB0aGV0YSApLCBzID0gTWF0aC5zaW4oIHRoZXRhICk7CgoJCXRoaXMuc2V0KAoKCQkJIGMsIDAsIHMsIDAsCgkJCSAwLCAxLCAwLCAwLAoJCQktIHMsIDAsIGMsIDAsCgkJCSAwLCAwLCAwLCAxCgoJCSk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltYWtlUm90YXRpb25aKCB0aGV0YSApIHsKCgkJY29uc3QgYyA9IE1hdGguY29zKCB0aGV0YSApLCBzID0gTWF0aC5zaW4oIHRoZXRhICk7CgoJCXRoaXMuc2V0KAoKCQkJYywgLSBzLCAwLCAwLAoJCQlzLCBjLCAwLCAwLAoJCQkwLCAwLCAxLCAwLAoJCQkwLCAwLCAwLCAxCgoJCSk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltYWtlUm90YXRpb25BeGlzKCBheGlzLCBhbmdsZSApIHsKCgkJLy8gQmFzZWQgb24gaHR0cDovL3d3dy5nYW1lZGV2Lm5ldC9yZWZlcmVuY2UvYXJ0aWNsZXMvYXJ0aWNsZTExOTkuYXNwCgoJCWNvbnN0IGMgPSBNYXRoLmNvcyggYW5nbGUgKTsKCQljb25zdCBzID0gTWF0aC5zaW4oIGFuZ2xlICk7CgkJY29uc3QgdCA9IDEgLSBjOwoJCWNvbnN0IHggPSBheGlzLngsIHkgPSBheGlzLnksIHogPSBheGlzLno7CgkJY29uc3QgdHggPSB0ICogeCwgdHkgPSB0ICogeTsKCgkJdGhpcy5zZXQoCgoJCQl0eCAqIHggKyBjLCB0eCAqIHkgLSBzICogeiwgdHggKiB6ICsgcyAqIHksIDAsCgkJCXR4ICogeSArIHMgKiB6LCB0eSAqIHkgKyBjLCB0eSAqIHogLSBzICogeCwgMCwKCQkJdHggKiB6IC0gcyAqIHksIHR5ICogeiArIHMgKiB4LCB0ICogeiAqIHogKyBjLCAwLAoJCQkwLCAwLCAwLCAxCgoJCSk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltYWtlU2NhbGUoIHgsIHksIHogKSB7CgoJCXRoaXMuc2V0KAoKCQkJeCwgMCwgMCwgMCwKCQkJMCwgeSwgMCwgMCwKCQkJMCwgMCwgeiwgMCwKCQkJMCwgMCwgMCwgMQoKCQkpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbWFrZVNoZWFyKCB4eSwgeHosIHl4LCB5eiwgengsIHp5ICkgewoKCQl0aGlzLnNldCgKCgkJCTEsIHl4LCB6eCwgMCwKCQkJeHksIDEsIHp5LCAwLAoJCQl4eiwgeXosIDEsIDAsCgkJCTAsIDAsIDAsIDEKCgkJKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvbXBvc2UoIHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCBzY2FsZSApIHsKCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoKCQljb25zdCB4ID0gcXVhdGVybmlvbi5feCwgeSA9IHF1YXRlcm5pb24uX3ksIHogPSBxdWF0ZXJuaW9uLl96LCB3ID0gcXVhdGVybmlvbi5fdzsKCQljb25zdCB4MiA9IHggKyB4LAl5MiA9IHkgKyB5LCB6MiA9IHogKyB6OwoJCWNvbnN0IHh4ID0geCAqIHgyLCB4eSA9IHggKiB5MiwgeHogPSB4ICogejI7CgkJY29uc3QgeXkgPSB5ICogeTIsIHl6ID0geSAqIHoyLCB6eiA9IHogKiB6MjsKCQljb25zdCB3eCA9IHcgKiB4Miwgd3kgPSB3ICogeTIsIHd6ID0gdyAqIHoyOwoKCQljb25zdCBzeCA9IHNjYWxlLngsIHN5ID0gc2NhbGUueSwgc3ogPSBzY2FsZS56OwoKCQl0ZVsgMCBdID0gKCAxIC0gKCB5eSArIHp6ICkgKSAqIHN4OwoJCXRlWyAxIF0gPSAoIHh5ICsgd3ogKSAqIHN4OwoJCXRlWyAyIF0gPSAoIHh6IC0gd3kgKSAqIHN4OwoJCXRlWyAzIF0gPSAwOwoKCQl0ZVsgNCBdID0gKCB4eSAtIHd6ICkgKiBzeTsKCQl0ZVsgNSBdID0gKCAxIC0gKCB4eCArIHp6ICkgKSAqIHN5OwoJCXRlWyA2IF0gPSAoIHl6ICsgd3ggKSAqIHN5OwoJCXRlWyA3IF0gPSAwOwoKCQl0ZVsgOCBdID0gKCB4eiArIHd5ICkgKiBzejsKCQl0ZVsgOSBdID0gKCB5eiAtIHd4ICkgKiBzejsKCQl0ZVsgMTAgXSA9ICggMSAtICggeHggKyB5eSApICkgKiBzejsKCQl0ZVsgMTEgXSA9IDA7CgoJCXRlWyAxMiBdID0gcG9zaXRpb24ueDsKCQl0ZVsgMTMgXSA9IHBvc2l0aW9uLnk7CgkJdGVbIDE0IF0gPSBwb3NpdGlvbi56OwoJCXRlWyAxNSBdID0gMTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWRlY29tcG9zZSggcG9zaXRpb24sIHF1YXRlcm5pb24sIHNjYWxlICkgewoKCQljb25zdCB0ZSA9IHRoaXMuZWxlbWVudHM7CgoJCWxldCBzeCA9IF92MSQ1LnNldCggdGVbIDAgXSwgdGVbIDEgXSwgdGVbIDIgXSApLmxlbmd0aCgpOwoJCWNvbnN0IHN5ID0gX3YxJDUuc2V0KCB0ZVsgNCBdLCB0ZVsgNSBdLCB0ZVsgNiBdICkubGVuZ3RoKCk7CgkJY29uc3Qgc3ogPSBfdjEkNS5zZXQoIHRlWyA4IF0sIHRlWyA5IF0sIHRlWyAxMCBdICkubGVuZ3RoKCk7CgoJCS8vIGlmIGRldGVybWluZSBpcyBuZWdhdGl2ZSwgd2UgbmVlZCB0byBpbnZlcnQgb25lIHNjYWxlCgkJY29uc3QgZGV0ID0gdGhpcy5kZXRlcm1pbmFudCgpOwoJCWlmICggZGV0IDwgMCApIHN4ID0gLSBzeDsKCgkJcG9zaXRpb24ueCA9IHRlWyAxMiBdOwoJCXBvc2l0aW9uLnkgPSB0ZVsgMTMgXTsKCQlwb3NpdGlvbi56ID0gdGVbIDE0IF07CgoJCS8vIHNjYWxlIHRoZSByb3RhdGlvbiBwYXJ0CgkJX20xJDIuY29weSggdGhpcyApOwoKCQljb25zdCBpbnZTWCA9IDEgLyBzeDsKCQljb25zdCBpbnZTWSA9IDEgLyBzeTsKCQljb25zdCBpbnZTWiA9IDEgLyBzejsKCgkJX20xJDIuZWxlbWVudHNbIDAgXSAqPSBpbnZTWDsKCQlfbTEkMi5lbGVtZW50c1sgMSBdICo9IGludlNYOwoJCV9tMSQyLmVsZW1lbnRzWyAyIF0gKj0gaW52U1g7CgoJCV9tMSQyLmVsZW1lbnRzWyA0IF0gKj0gaW52U1k7CgkJX20xJDIuZWxlbWVudHNbIDUgXSAqPSBpbnZTWTsKCQlfbTEkMi5lbGVtZW50c1sgNiBdICo9IGludlNZOwoKCQlfbTEkMi5lbGVtZW50c1sgOCBdICo9IGludlNaOwoJCV9tMSQyLmVsZW1lbnRzWyA5IF0gKj0gaW52U1o7CgkJX20xJDIuZWxlbWVudHNbIDEwIF0gKj0gaW52U1o7CgoJCXF1YXRlcm5pb24uc2V0RnJvbVJvdGF0aW9uTWF0cml4KCBfbTEkMiApOwoKCQlzY2FsZS54ID0gc3g7CgkJc2NhbGUueSA9IHN5OwoJCXNjYWxlLnogPSBzejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW1ha2VQZXJzcGVjdGl2ZSggbGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tLCBuZWFyLCBmYXIsIGNvb3JkaW5hdGVTeXN0ZW0gPSBXZWJHTENvb3JkaW5hdGVTeXN0ZW0gKSB7CgoJCWNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKCQljb25zdCB4ID0gMiAqIG5lYXIgLyAoIHJpZ2h0IC0gbGVmdCApOwoJCWNvbnN0IHkgPSAyICogbmVhciAvICggdG9wIC0gYm90dG9tICk7CgoJCWNvbnN0IGEgPSAoIHJpZ2h0ICsgbGVmdCApIC8gKCByaWdodCAtIGxlZnQgKTsKCQljb25zdCBiID0gKCB0b3AgKyBib3R0b20gKSAvICggdG9wIC0gYm90dG9tICk7CgoJCWxldCBjLCBkOwoKCQlpZiAoIGNvb3JkaW5hdGVTeXN0ZW0gPT09IFdlYkdMQ29vcmRpbmF0ZVN5c3RlbSApIHsKCgkJCWMgPSAtICggZmFyICsgbmVhciApIC8gKCBmYXIgLSBuZWFyICk7CgkJCWQgPSAoIC0gMiAqIGZhciAqIG5lYXIgKSAvICggZmFyIC0gbmVhciApOwoKCQl9IGVsc2UgaWYgKCBjb29yZGluYXRlU3lzdGVtID09PSBXZWJHUFVDb29yZGluYXRlU3lzdGVtICkgewoKCQkJYyA9IC0gZmFyIC8gKCBmYXIgLSBuZWFyICk7CgkJCWQgPSAoIC0gZmFyICogbmVhciApIC8gKCBmYXIgLSBuZWFyICk7CgoJCX0gZWxzZSB7CgoJCQl0aHJvdyBuZXcgRXJyb3IoICdUSFJFRS5NYXRyaXg0Lm1ha2VQZXJzcGVjdGl2ZSgpOiBJbnZhbGlkIGNvb3JkaW5hdGUgc3lzdGVtOiAnICsgY29vcmRpbmF0ZVN5c3RlbSApOwoKCQl9CgoJCXRlWyAwIF0gPSB4Owl0ZVsgNCBdID0gMDsJdGVbIDggXSA9IGE7IAl0ZVsgMTIgXSA9IDA7CgkJdGVbIDEgXSA9IDA7CXRlWyA1IF0gPSB5Owl0ZVsgOSBdID0gYjsgCXRlWyAxMyBdID0gMDsKCQl0ZVsgMiBdID0gMDsJdGVbIDYgXSA9IDA7CXRlWyAxMCBdID0gYzsgCXRlWyAxNCBdID0gZDsKCQl0ZVsgMyBdID0gMDsJdGVbIDcgXSA9IDA7CXRlWyAxMSBdID0gLSAxOwl0ZVsgMTUgXSA9IDA7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltYWtlT3J0aG9ncmFwaGljKCBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20sIG5lYXIsIGZhciwgY29vcmRpbmF0ZVN5c3RlbSA9IFdlYkdMQ29vcmRpbmF0ZVN5c3RlbSApIHsKCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoJCWNvbnN0IHcgPSAxLjAgLyAoIHJpZ2h0IC0gbGVmdCApOwoJCWNvbnN0IGggPSAxLjAgLyAoIHRvcCAtIGJvdHRvbSApOwoJCWNvbnN0IHAgPSAxLjAgLyAoIGZhciAtIG5lYXIgKTsKCgkJY29uc3QgeCA9ICggcmlnaHQgKyBsZWZ0ICkgKiB3OwoJCWNvbnN0IHkgPSAoIHRvcCArIGJvdHRvbSApICogaDsKCgkJbGV0IHosIHpJbnY7CgoJCWlmICggY29vcmRpbmF0ZVN5c3RlbSA9PT0gV2ViR0xDb29yZGluYXRlU3lzdGVtICkgewoKCQkJeiA9ICggZmFyICsgbmVhciApICogcDsKCQkJekludiA9IC0gMiAqIHA7CgoJCX0gZWxzZSBpZiAoIGNvb3JkaW5hdGVTeXN0ZW0gPT09IFdlYkdQVUNvb3JkaW5hdGVTeXN0ZW0gKSB7CgoJCQl6ID0gbmVhciAqIHA7CgkJCXpJbnYgPSAtIDEgKiBwOwoKCQl9IGVsc2UgewoKCQkJdGhyb3cgbmV3IEVycm9yKCAnVEhSRUUuTWF0cml4NC5tYWtlT3J0aG9ncmFwaGljKCk6IEludmFsaWQgY29vcmRpbmF0ZSBzeXN0ZW06ICcgKyBjb29yZGluYXRlU3lzdGVtICk7CgoJCX0KCgkJdGVbIDAgXSA9IDIgKiB3Owl0ZVsgNCBdID0gMDsJCXRlWyA4IF0gPSAwOyAJCXRlWyAxMiBdID0gLSB4OwoJCXRlWyAxIF0gPSAwOyAJCXRlWyA1IF0gPSAyICogaDsJdGVbIDkgXSA9IDA7IAkJdGVbIDEzIF0gPSAtIHk7CgkJdGVbIDIgXSA9IDA7IAkJdGVbIDYgXSA9IDA7CQl0ZVsgMTAgXSA9IHpJbnY7CXRlWyAxNCBdID0gLSB6OwoJCXRlWyAzIF0gPSAwOyAJCXRlWyA3IF0gPSAwOwkJdGVbIDExIF0gPSAwOwkJdGVbIDE1IF0gPSAxOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXF1YWxzKCBtYXRyaXggKSB7CgoJCWNvbnN0IHRlID0gdGhpcy5lbGVtZW50czsKCQljb25zdCBtZSA9IG1hdHJpeC5lbGVtZW50czsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgMTY7IGkgKysgKSB7CgoJCQlpZiAoIHRlWyBpIF0gIT09IG1lWyBpIF0gKSByZXR1cm4gZmFsc2U7CgoJCX0KCgkJcmV0dXJuIHRydWU7CgoJfQoKCWZyb21BcnJheSggYXJyYXksIG9mZnNldCA9IDAgKSB7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IDE2OyBpICsrICkgewoKCQkJdGhpcy5lbGVtZW50c1sgaSBdID0gYXJyYXlbIGkgKyBvZmZzZXQgXTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9BcnJheSggYXJyYXkgPSBbXSwgb2Zmc2V0ID0gMCApIHsKCgkJY29uc3QgdGUgPSB0aGlzLmVsZW1lbnRzOwoKCQlhcnJheVsgb2Zmc2V0IF0gPSB0ZVsgMCBdOwoJCWFycmF5WyBvZmZzZXQgKyAxIF0gPSB0ZVsgMSBdOwoJCWFycmF5WyBvZmZzZXQgKyAyIF0gPSB0ZVsgMiBdOwoJCWFycmF5WyBvZmZzZXQgKyAzIF0gPSB0ZVsgMyBdOwoKCQlhcnJheVsgb2Zmc2V0ICsgNCBdID0gdGVbIDQgXTsKCQlhcnJheVsgb2Zmc2V0ICsgNSBdID0gdGVbIDUgXTsKCQlhcnJheVsgb2Zmc2V0ICsgNiBdID0gdGVbIDYgXTsKCQlhcnJheVsgb2Zmc2V0ICsgNyBdID0gdGVbIDcgXTsKCgkJYXJyYXlbIG9mZnNldCArIDggXSA9IHRlWyA4IF07CgkJYXJyYXlbIG9mZnNldCArIDkgXSA9IHRlWyA5IF07CgkJYXJyYXlbIG9mZnNldCArIDEwIF0gPSB0ZVsgMTAgXTsKCQlhcnJheVsgb2Zmc2V0ICsgMTEgXSA9IHRlWyAxMSBdOwoKCQlhcnJheVsgb2Zmc2V0ICsgMTIgXSA9IHRlWyAxMiBdOwoJCWFycmF5WyBvZmZzZXQgKyAxMyBdID0gdGVbIDEzIF07CgkJYXJyYXlbIG9mZnNldCArIDE0IF0gPSB0ZVsgMTQgXTsKCQlhcnJheVsgb2Zmc2V0ICsgMTUgXSA9IHRlWyAxNSBdOwoKCQlyZXR1cm4gYXJyYXk7CgoJfQoKfQoKY29uc3QgX3YxJDUgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9tMSQyID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwpjb25zdCBfemVybyA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoIDAsIDAsIDAgKTsKY29uc3QgX29uZSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoIDEsIDEsIDEgKTsKY29uc3QgX3ggPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF95ID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfeiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNvbnN0IF9tYXRyaXgkMSA9IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDQoKTsKY29uc3QgX3F1YXRlcm5pb24kMyA9IC8qQF9fUFVSRV9fKi8gbmV3IFF1YXRlcm5pb24oKTsKCmNsYXNzIEV1bGVyIHsKCgljb25zdHJ1Y3RvciggeCA9IDAsIHkgPSAwLCB6ID0gMCwgb3JkZXIgPSBFdWxlci5ERUZBVUxUX09SREVSICkgewoKCQl0aGlzLmlzRXVsZXIgPSB0cnVlOwoKCQl0aGlzLl94ID0geDsKCQl0aGlzLl95ID0geTsKCQl0aGlzLl96ID0gejsKCQl0aGlzLl9vcmRlciA9IG9yZGVyOwoKCX0KCglnZXQgeCgpIHsKCgkJcmV0dXJuIHRoaXMuX3g7CgoJfQoKCXNldCB4KCB2YWx1ZSApIHsKCgkJdGhpcy5feCA9IHZhbHVlOwoJCXRoaXMuX29uQ2hhbmdlQ2FsbGJhY2soKTsKCgl9CgoJZ2V0IHkoKSB7CgoJCXJldHVybiB0aGlzLl95OwoKCX0KCglzZXQgeSggdmFsdWUgKSB7CgoJCXRoaXMuX3kgPSB2YWx1ZTsKCQl0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CgoJfQoKCWdldCB6KCkgewoKCQlyZXR1cm4gdGhpcy5fejsKCgl9CgoJc2V0IHooIHZhbHVlICkgewoKCQl0aGlzLl96ID0gdmFsdWU7CgkJdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwoKCX0KCglnZXQgb3JkZXIoKSB7CgoJCXJldHVybiB0aGlzLl9vcmRlcjsKCgl9CgoJc2V0IG9yZGVyKCB2YWx1ZSApIHsKCgkJdGhpcy5fb3JkZXIgPSB2YWx1ZTsKCQl0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CgoJfQoKCXNldCggeCwgeSwgeiwgb3JkZXIgPSB0aGlzLl9vcmRlciApIHsKCgkJdGhpcy5feCA9IHg7CgkJdGhpcy5feSA9IHk7CgkJdGhpcy5feiA9IHo7CgkJdGhpcy5fb3JkZXIgPSBvcmRlcjsKCgkJdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvciggdGhpcy5feCwgdGhpcy5feSwgdGhpcy5feiwgdGhpcy5fb3JkZXIgKTsKCgl9CgoJY29weSggZXVsZXIgKSB7CgoJCXRoaXMuX3ggPSBldWxlci5feDsKCQl0aGlzLl95ID0gZXVsZXIuX3k7CgkJdGhpcy5feiA9IGV1bGVyLl96OwoJCXRoaXMuX29yZGVyID0gZXVsZXIuX29yZGVyOwoKCQl0aGlzLl9vbkNoYW5nZUNhbGxiYWNrKCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tUm90YXRpb25NYXRyaXgoIG0sIG9yZGVyID0gdGhpcy5fb3JkZXIsIHVwZGF0ZSA9IHRydWUgKSB7CgoJCS8vIGFzc3VtZXMgdGhlIHVwcGVyIDN4MyBvZiBtIGlzIGEgcHVyZSByb3RhdGlvbiBtYXRyaXggKGkuZSwgdW5zY2FsZWQpCgoJCWNvbnN0IHRlID0gbS5lbGVtZW50czsKCQljb25zdCBtMTEgPSB0ZVsgMCBdLCBtMTIgPSB0ZVsgNCBdLCBtMTMgPSB0ZVsgOCBdOwoJCWNvbnN0IG0yMSA9IHRlWyAxIF0sIG0yMiA9IHRlWyA1IF0sIG0yMyA9IHRlWyA5IF07CgkJY29uc3QgbTMxID0gdGVbIDIgXSwgbTMyID0gdGVbIDYgXSwgbTMzID0gdGVbIDEwIF07CgoJCXN3aXRjaCAoIG9yZGVyICkgewoKCQkJY2FzZSAnWFlaJzoKCgkJCQl0aGlzLl95ID0gTWF0aC5hc2luKCBjbGFtcCggbTEzLCAtIDEsIDEgKSApOwoKCQkJCWlmICggTWF0aC5hYnMoIG0xMyApIDwgMC45OTk5OTk5ICkgewoKCQkJCQl0aGlzLl94ID0gTWF0aC5hdGFuMiggLSBtMjMsIG0zMyApOwoJCQkJCXRoaXMuX3ogPSBNYXRoLmF0YW4yKCAtIG0xMiwgbTExICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhpcy5feCA9IE1hdGguYXRhbjIoIG0zMiwgbTIyICk7CgkJCQkJdGhpcy5feiA9IDA7CgoJCQkJfQoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnWVhaJzoKCgkJCQl0aGlzLl94ID0gTWF0aC5hc2luKCAtIGNsYW1wKCBtMjMsIC0gMSwgMSApICk7CgoJCQkJaWYgKCBNYXRoLmFicyggbTIzICkgPCAwLjk5OTk5OTkgKSB7CgoJCQkJCXRoaXMuX3kgPSBNYXRoLmF0YW4yKCBtMTMsIG0zMyApOwoJCQkJCXRoaXMuX3ogPSBNYXRoLmF0YW4yKCBtMjEsIG0yMiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRoaXMuX3kgPSBNYXRoLmF0YW4yKCAtIG0zMSwgbTExICk7CgkJCQkJdGhpcy5feiA9IDA7CgoJCQkJfQoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnWlhZJzoKCgkJCQl0aGlzLl94ID0gTWF0aC5hc2luKCBjbGFtcCggbTMyLCAtIDEsIDEgKSApOwoKCQkJCWlmICggTWF0aC5hYnMoIG0zMiApIDwgMC45OTk5OTk5ICkgewoKCQkJCQl0aGlzLl95ID0gTWF0aC5hdGFuMiggLSBtMzEsIG0zMyApOwoJCQkJCXRoaXMuX3ogPSBNYXRoLmF0YW4yKCAtIG0xMiwgbTIyICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhpcy5feSA9IDA7CgkJCQkJdGhpcy5feiA9IE1hdGguYXRhbjIoIG0yMSwgbTExICk7CgoJCQkJfQoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnWllYJzoKCgkJCQl0aGlzLl95ID0gTWF0aC5hc2luKCAtIGNsYW1wKCBtMzEsIC0gMSwgMSApICk7CgoJCQkJaWYgKCBNYXRoLmFicyggbTMxICkgPCAwLjk5OTk5OTkgKSB7CgoJCQkJCXRoaXMuX3ggPSBNYXRoLmF0YW4yKCBtMzIsIG0zMyApOwoJCQkJCXRoaXMuX3ogPSBNYXRoLmF0YW4yKCBtMjEsIG0xMSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRoaXMuX3ggPSAwOwoJCQkJCXRoaXMuX3ogPSBNYXRoLmF0YW4yKCAtIG0xMiwgbTIyICk7CgoJCQkJfQoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnWVpYJzoKCgkJCQl0aGlzLl96ID0gTWF0aC5hc2luKCBjbGFtcCggbTIxLCAtIDEsIDEgKSApOwoKCQkJCWlmICggTWF0aC5hYnMoIG0yMSApIDwgMC45OTk5OTk5ICkgewoKCQkJCQl0aGlzLl94ID0gTWF0aC5hdGFuMiggLSBtMjMsIG0yMiApOwoJCQkJCXRoaXMuX3kgPSBNYXRoLmF0YW4yKCAtIG0zMSwgbTExICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhpcy5feCA9IDA7CgkJCQkJdGhpcy5feSA9IE1hdGguYXRhbjIoIG0xMywgbTMzICk7CgoJCQkJfQoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnWFpZJzoKCgkJCQl0aGlzLl96ID0gTWF0aC5hc2luKCAtIGNsYW1wKCBtMTIsIC0gMSwgMSApICk7CgoJCQkJaWYgKCBNYXRoLmFicyggbTEyICkgPCAwLjk5OTk5OTkgKSB7CgoJCQkJCXRoaXMuX3ggPSBNYXRoLmF0YW4yKCBtMzIsIG0yMiApOwoJCQkJCXRoaXMuX3kgPSBNYXRoLmF0YW4yKCBtMTMsIG0xMSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRoaXMuX3ggPSBNYXRoLmF0YW4yKCAtIG0yMywgbTMzICk7CgkJCQkJdGhpcy5feSA9IDA7CgoJCQkJfQoKCQkJCWJyZWFrOwoKCQkJZGVmYXVsdDoKCgkJCQljb25zb2xlLndhcm4oICdUSFJFRS5FdWxlcjogLnNldEZyb21Sb3RhdGlvbk1hdHJpeCgpIGVuY291bnRlcmVkIGFuIHVua25vd24gb3JkZXI6ICcgKyBvcmRlciApOwoKCQl9CgoJCXRoaXMuX29yZGVyID0gb3JkZXI7CgoJCWlmICggdXBkYXRlID09PSB0cnVlICkgdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbVF1YXRlcm5pb24oIHEsIG9yZGVyLCB1cGRhdGUgKSB7CgoJCV9tYXRyaXgkMS5tYWtlUm90YXRpb25Gcm9tUXVhdGVybmlvbiggcSApOwoKCQlyZXR1cm4gdGhpcy5zZXRGcm9tUm90YXRpb25NYXRyaXgoIF9tYXRyaXgkMSwgb3JkZXIsIHVwZGF0ZSApOwoKCX0KCglzZXRGcm9tVmVjdG9yMyggdiwgb3JkZXIgPSB0aGlzLl9vcmRlciApIHsKCgkJcmV0dXJuIHRoaXMuc2V0KCB2LngsIHYueSwgdi56LCBvcmRlciApOwoKCX0KCglyZW9yZGVyKCBuZXdPcmRlciApIHsKCgkJLy8gV0FSTklORzogdGhpcyBkaXNjYXJkcyByZXZvbHV0aW9uIGluZm9ybWF0aW9uIC1iaG91c3RvbgoKCQlfcXVhdGVybmlvbiQzLnNldEZyb21FdWxlciggdGhpcyApOwoKCQlyZXR1cm4gdGhpcy5zZXRGcm9tUXVhdGVybmlvbiggX3F1YXRlcm5pb24kMywgbmV3T3JkZXIgKTsKCgl9CgoJZXF1YWxzKCBldWxlciApIHsKCgkJcmV0dXJuICggZXVsZXIuX3ggPT09IHRoaXMuX3ggKSAmJiAoIGV1bGVyLl95ID09PSB0aGlzLl95ICkgJiYgKCBldWxlci5feiA9PT0gdGhpcy5feiApICYmICggZXVsZXIuX29yZGVyID09PSB0aGlzLl9vcmRlciApOwoKCX0KCglmcm9tQXJyYXkoIGFycmF5ICkgewoKCQl0aGlzLl94ID0gYXJyYXlbIDAgXTsKCQl0aGlzLl95ID0gYXJyYXlbIDEgXTsKCQl0aGlzLl96ID0gYXJyYXlbIDIgXTsKCQlpZiAoIGFycmF5WyAzIF0gIT09IHVuZGVmaW5lZCApIHRoaXMuX29yZGVyID0gYXJyYXlbIDMgXTsKCgkJdGhpcy5fb25DaGFuZ2VDYWxsYmFjaygpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9BcnJheSggYXJyYXkgPSBbXSwgb2Zmc2V0ID0gMCApIHsKCgkJYXJyYXlbIG9mZnNldCBdID0gdGhpcy5feDsKCQlhcnJheVsgb2Zmc2V0ICsgMSBdID0gdGhpcy5feTsKCQlhcnJheVsgb2Zmc2V0ICsgMiBdID0gdGhpcy5fejsKCQlhcnJheVsgb2Zmc2V0ICsgMyBdID0gdGhpcy5fb3JkZXI7CgoJCXJldHVybiBhcnJheTsKCgl9CgoJX29uQ2hhbmdlKCBjYWxsYmFjayApIHsKCgkJdGhpcy5fb25DaGFuZ2VDYWxsYmFjayA9IGNhbGxiYWNrOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJX29uQ2hhbmdlQ2FsbGJhY2soKSB7fQoKCSpbIFN5bWJvbC5pdGVyYXRvciBdKCkgewoKCQl5aWVsZCB0aGlzLl94OwoJCXlpZWxkIHRoaXMuX3k7CgkJeWllbGQgdGhpcy5fejsKCQl5aWVsZCB0aGlzLl9vcmRlcjsKCgl9Cgp9CgpFdWxlci5ERUZBVUxUX09SREVSID0gJ1hZWic7CgpjbGFzcyBMYXllcnMgewoKCWNvbnN0cnVjdG9yKCkgewoKCQl0aGlzLm1hc2sgPSAxIHwgMDsKCgl9CgoJc2V0KCBjaGFubmVsICkgewoKCQl0aGlzLm1hc2sgPSAoIDEgPDwgY2hhbm5lbCB8IDAgKSA+Pj4gMDsKCgl9CgoJZW5hYmxlKCBjaGFubmVsICkgewoKCQl0aGlzLm1hc2sgfD0gMSA8PCBjaGFubmVsIHwgMDsKCgl9CgoJZW5hYmxlQWxsKCkgewoKCQl0aGlzLm1hc2sgPSAweGZmZmZmZmZmIHwgMDsKCgl9CgoJdG9nZ2xlKCBjaGFubmVsICkgewoKCQl0aGlzLm1hc2sgXj0gMSA8PCBjaGFubmVsIHwgMDsKCgl9CgoJZGlzYWJsZSggY2hhbm5lbCApIHsKCgkJdGhpcy5tYXNrICY9IH4gKCAxIDw8IGNoYW5uZWwgfCAwICk7CgoJfQoKCWRpc2FibGVBbGwoKSB7CgoJCXRoaXMubWFzayA9IDA7CgoJfQoKCXRlc3QoIGxheWVycyApIHsKCgkJcmV0dXJuICggdGhpcy5tYXNrICYgbGF5ZXJzLm1hc2sgKSAhPT0gMDsKCgl9CgoJaXNFbmFibGVkKCBjaGFubmVsICkgewoKCQlyZXR1cm4gKCB0aGlzLm1hc2sgJiAoIDEgPDwgY2hhbm5lbCB8IDAgKSApICE9PSAwOwoKCX0KCn0KCmxldCBfb2JqZWN0M0RJZCA9IDA7Cgpjb25zdCBfdjEkNCA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3ExID0gLypAX19QVVJFX18qLyBuZXcgUXVhdGVybmlvbigpOwpjb25zdCBfbTEkMSA9IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDQoKTsKY29uc3QgX3RhcmdldCA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNvbnN0IF9wb3NpdGlvbiQzID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfc2NhbGUkMiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3F1YXRlcm5pb24kMiA9IC8qQF9fUFVSRV9fKi8gbmV3IFF1YXRlcm5pb24oKTsKCmNvbnN0IF94QXhpcyA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoIDEsIDAsIDAgKTsKY29uc3QgX3lBeGlzID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMyggMCwgMSwgMCApOwpjb25zdCBfekF4aXMgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCAwLCAwLCAxICk7Cgpjb25zdCBfYWRkZWRFdmVudCA9IHsgdHlwZTogJ2FkZGVkJyB9Owpjb25zdCBfcmVtb3ZlZEV2ZW50ID0geyB0eXBlOiAncmVtb3ZlZCcgfTsKCmNsYXNzIE9iamVjdDNEIGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyIHsKCgljb25zdHJ1Y3RvcigpIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc09iamVjdDNEID0gdHJ1ZTsKCgkJT2JqZWN0LmRlZmluZVByb3BlcnR5KCB0aGlzLCAnaWQnLCB7IHZhbHVlOiBfb2JqZWN0M0RJZCArKyB9ICk7CgoJCXRoaXMudXVpZCA9IGdlbmVyYXRlVVVJRCgpOwoKCQl0aGlzLm5hbWUgPSAnJzsKCQl0aGlzLnR5cGUgPSAnT2JqZWN0M0QnOwoKCQl0aGlzLnBhcmVudCA9IG51bGw7CgkJdGhpcy5jaGlsZHJlbiA9IFtdOwoKCQl0aGlzLnVwID0gT2JqZWN0M0QuREVGQVVMVF9VUC5jbG9uZSgpOwoKCQljb25zdCBwb3NpdGlvbiA9IG5ldyBWZWN0b3IzKCk7CgkJY29uc3Qgcm90YXRpb24gPSBuZXcgRXVsZXIoKTsKCQljb25zdCBxdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKCQljb25zdCBzY2FsZSA9IG5ldyBWZWN0b3IzKCAxLCAxLCAxICk7CgoJCWZ1bmN0aW9uIG9uUm90YXRpb25DaGFuZ2UoKSB7CgoJCQlxdWF0ZXJuaW9uLnNldEZyb21FdWxlciggcm90YXRpb24sIGZhbHNlICk7CgoJCX0KCgkJZnVuY3Rpb24gb25RdWF0ZXJuaW9uQ2hhbmdlKCkgewoKCQkJcm90YXRpb24uc2V0RnJvbVF1YXRlcm5pb24oIHF1YXRlcm5pb24sIHVuZGVmaW5lZCwgZmFsc2UgKTsKCgkJfQoKCQlyb3RhdGlvbi5fb25DaGFuZ2UoIG9uUm90YXRpb25DaGFuZ2UgKTsKCQlxdWF0ZXJuaW9uLl9vbkNoYW5nZSggb25RdWF0ZXJuaW9uQ2hhbmdlICk7CgoJCU9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKCB0aGlzLCB7CgkJCXBvc2l0aW9uOiB7CgkJCQljb25maWd1cmFibGU6IHRydWUsCgkJCQllbnVtZXJhYmxlOiB0cnVlLAoJCQkJdmFsdWU6IHBvc2l0aW9uCgkJCX0sCgkJCXJvdGF0aW9uOiB7CgkJCQljb25maWd1cmFibGU6IHRydWUsCgkJCQllbnVtZXJhYmxlOiB0cnVlLAoJCQkJdmFsdWU6IHJvdGF0aW9uCgkJCX0sCgkJCXF1YXRlcm5pb246IHsKCQkJCWNvbmZpZ3VyYWJsZTogdHJ1ZSwKCQkJCWVudW1lcmFibGU6IHRydWUsCgkJCQl2YWx1ZTogcXVhdGVybmlvbgoJCQl9LAoJCQlzY2FsZTogewoJCQkJY29uZmlndXJhYmxlOiB0cnVlLAoJCQkJZW51bWVyYWJsZTogdHJ1ZSwKCQkJCXZhbHVlOiBzY2FsZQoJCQl9LAoJCQltb2RlbFZpZXdNYXRyaXg6IHsKCQkJCXZhbHVlOiBuZXcgTWF0cml4NCgpCgkJCX0sCgkJCW5vcm1hbE1hdHJpeDogewoJCQkJdmFsdWU6IG5ldyBNYXRyaXgzKCkKCQkJfQoJCX0gKTsKCgkJdGhpcy5tYXRyaXggPSBuZXcgTWF0cml4NCgpOwoJCXRoaXMubWF0cml4V29ybGQgPSBuZXcgTWF0cml4NCgpOwoKCQl0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSBPYmplY3QzRC5ERUZBVUxUX01BVFJJWF9BVVRPX1VQREFURTsKCgkJdGhpcy5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPSBPYmplY3QzRC5ERUZBVUxUX01BVFJJWF9XT1JMRF9BVVRPX1VQREFURTsgLy8gY2hlY2tlZCBieSB0aGUgcmVuZGVyZXIKCQl0aGlzLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSBmYWxzZTsKCgkJdGhpcy5sYXllcnMgPSBuZXcgTGF5ZXJzKCk7CgkJdGhpcy52aXNpYmxlID0gdHJ1ZTsKCgkJdGhpcy5jYXN0U2hhZG93ID0gZmFsc2U7CgkJdGhpcy5yZWNlaXZlU2hhZG93ID0gZmFsc2U7CgoJCXRoaXMuZnJ1c3R1bUN1bGxlZCA9IHRydWU7CgkJdGhpcy5yZW5kZXJPcmRlciA9IDA7CgoJCXRoaXMuYW5pbWF0aW9ucyA9IFtdOwoKCQl0aGlzLnVzZXJEYXRhID0ge307CgoJfQoKCW9uQmVmb3JlU2hhZG93KCAvKiByZW5kZXJlciwgb2JqZWN0LCBjYW1lcmEsIHNoYWRvd0NhbWVyYSwgZ2VvbWV0cnksIGRlcHRoTWF0ZXJpYWwsIGdyb3VwICovICkge30KCglvbkFmdGVyU2hhZG93KCAvKiByZW5kZXJlciwgb2JqZWN0LCBjYW1lcmEsIHNoYWRvd0NhbWVyYSwgZ2VvbWV0cnksIGRlcHRoTWF0ZXJpYWwsIGdyb3VwICovICkge30KCglvbkJlZm9yZVJlbmRlciggLyogcmVuZGVyZXIsIHNjZW5lLCBjYW1lcmEsIGdlb21ldHJ5LCBtYXRlcmlhbCwgZ3JvdXAgKi8gKSB7fQoKCW9uQWZ0ZXJSZW5kZXIoIC8qIHJlbmRlcmVyLCBzY2VuZSwgY2FtZXJhLCBnZW9tZXRyeSwgbWF0ZXJpYWwsIGdyb3VwICovICkge30KCglhcHBseU1hdHJpeDQoIG1hdHJpeCApIHsKCgkJaWYgKCB0aGlzLm1hdHJpeEF1dG9VcGRhdGUgKSB0aGlzLnVwZGF0ZU1hdHJpeCgpOwoKCQl0aGlzLm1hdHJpeC5wcmVtdWx0aXBseSggbWF0cml4ICk7CgoJCXRoaXMubWF0cml4LmRlY29tcG9zZSggdGhpcy5wb3NpdGlvbiwgdGhpcy5xdWF0ZXJuaW9uLCB0aGlzLnNjYWxlICk7CgoJfQoKCWFwcGx5UXVhdGVybmlvbiggcSApIHsKCgkJdGhpcy5xdWF0ZXJuaW9uLnByZW11bHRpcGx5KCBxICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRSb3RhdGlvbkZyb21BeGlzQW5nbGUoIGF4aXMsIGFuZ2xlICkgewoKCQkvLyBhc3N1bWVzIGF4aXMgaXMgbm9ybWFsaXplZAoKCQl0aGlzLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZSggYXhpcywgYW5nbGUgKTsKCgl9CgoJc2V0Um90YXRpb25Gcm9tRXVsZXIoIGV1bGVyICkgewoKCQl0aGlzLnF1YXRlcm5pb24uc2V0RnJvbUV1bGVyKCBldWxlciwgdHJ1ZSApOwoKCX0KCglzZXRSb3RhdGlvbkZyb21NYXRyaXgoIG0gKSB7CgoJCS8vIGFzc3VtZXMgdGhlIHVwcGVyIDN4MyBvZiBtIGlzIGEgcHVyZSByb3RhdGlvbiBtYXRyaXggKGkuZSwgdW5zY2FsZWQpCgoJCXRoaXMucXVhdGVybmlvbi5zZXRGcm9tUm90YXRpb25NYXRyaXgoIG0gKTsKCgl9CgoJc2V0Um90YXRpb25Gcm9tUXVhdGVybmlvbiggcSApIHsKCgkJLy8gYXNzdW1lcyBxIGlzIG5vcm1hbGl6ZWQKCgkJdGhpcy5xdWF0ZXJuaW9uLmNvcHkoIHEgKTsKCgl9CgoJcm90YXRlT25BeGlzKCBheGlzLCBhbmdsZSApIHsKCgkJLy8gcm90YXRlIG9iamVjdCBvbiBheGlzIGluIG9iamVjdCBzcGFjZQoJCS8vIGF4aXMgaXMgYXNzdW1lZCB0byBiZSBub3JtYWxpemVkCgoJCV9xMS5zZXRGcm9tQXhpc0FuZ2xlKCBheGlzLCBhbmdsZSApOwoKCQl0aGlzLnF1YXRlcm5pb24ubXVsdGlwbHkoIF9xMSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcm90YXRlT25Xb3JsZEF4aXMoIGF4aXMsIGFuZ2xlICkgewoKCQkvLyByb3RhdGUgb2JqZWN0IG9uIGF4aXMgaW4gd29ybGQgc3BhY2UKCQkvLyBheGlzIGlzIGFzc3VtZWQgdG8gYmUgbm9ybWFsaXplZAoJCS8vIG1ldGhvZCBhc3N1bWVzIG5vIHJvdGF0ZWQgcGFyZW50CgoJCV9xMS5zZXRGcm9tQXhpc0FuZ2xlKCBheGlzLCBhbmdsZSApOwoKCQl0aGlzLnF1YXRlcm5pb24ucHJlbXVsdGlwbHkoIF9xMSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcm90YXRlWCggYW5nbGUgKSB7CgoJCXJldHVybiB0aGlzLnJvdGF0ZU9uQXhpcyggX3hBeGlzLCBhbmdsZSApOwoKCX0KCglyb3RhdGVZKCBhbmdsZSApIHsKCgkJcmV0dXJuIHRoaXMucm90YXRlT25BeGlzKCBfeUF4aXMsIGFuZ2xlICk7CgoJfQoKCXJvdGF0ZVooIGFuZ2xlICkgewoKCQlyZXR1cm4gdGhpcy5yb3RhdGVPbkF4aXMoIF96QXhpcywgYW5nbGUgKTsKCgl9CgoJdHJhbnNsYXRlT25BeGlzKCBheGlzLCBkaXN0YW5jZSApIHsKCgkJLy8gdHJhbnNsYXRlIG9iamVjdCBieSBkaXN0YW5jZSBhbG9uZyBheGlzIGluIG9iamVjdCBzcGFjZQoJCS8vIGF4aXMgaXMgYXNzdW1lZCB0byBiZSBub3JtYWxpemVkCgoJCV92MSQ0LmNvcHkoIGF4aXMgKS5hcHBseVF1YXRlcm5pb24oIHRoaXMucXVhdGVybmlvbiApOwoKCQl0aGlzLnBvc2l0aW9uLmFkZCggX3YxJDQubXVsdGlwbHlTY2FsYXIoIGRpc3RhbmNlICkgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRyYW5zbGF0ZVgoIGRpc3RhbmNlICkgewoKCQlyZXR1cm4gdGhpcy50cmFuc2xhdGVPbkF4aXMoIF94QXhpcywgZGlzdGFuY2UgKTsKCgl9CgoJdHJhbnNsYXRlWSggZGlzdGFuY2UgKSB7CgoJCXJldHVybiB0aGlzLnRyYW5zbGF0ZU9uQXhpcyggX3lBeGlzLCBkaXN0YW5jZSApOwoKCX0KCgl0cmFuc2xhdGVaKCBkaXN0YW5jZSApIHsKCgkJcmV0dXJuIHRoaXMudHJhbnNsYXRlT25BeGlzKCBfekF4aXMsIGRpc3RhbmNlICk7CgoJfQoKCWxvY2FsVG9Xb3JsZCggdmVjdG9yICkgewoKCQl0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoKCQlyZXR1cm4gdmVjdG9yLmFwcGx5TWF0cml4NCggdGhpcy5tYXRyaXhXb3JsZCApOwoKCX0KCgl3b3JsZFRvTG9jYWwoIHZlY3RvciApIHsKCgkJdGhpcy51cGRhdGVXb3JsZE1hdHJpeCggdHJ1ZSwgZmFsc2UgKTsKCgkJcmV0dXJuIHZlY3Rvci5hcHBseU1hdHJpeDQoIF9tMSQxLmNvcHkoIHRoaXMubWF0cml4V29ybGQgKS5pbnZlcnQoKSApOwoKCX0KCglsb29rQXQoIHgsIHksIHogKSB7CgoJCS8vIFRoaXMgbWV0aG9kIGRvZXMgbm90IHN1cHBvcnQgb2JqZWN0cyBoYXZpbmcgbm9uLXVuaWZvcm1seS1zY2FsZWQgcGFyZW50KHMpCgoJCWlmICggeC5pc1ZlY3RvcjMgKSB7CgoJCQlfdGFyZ2V0LmNvcHkoIHggKTsKCgkJfSBlbHNlIHsKCgkJCV90YXJnZXQuc2V0KCB4LCB5LCB6ICk7CgoJCX0KCgkJY29uc3QgcGFyZW50ID0gdGhpcy5wYXJlbnQ7CgoJCXRoaXMudXBkYXRlV29ybGRNYXRyaXgoIHRydWUsIGZhbHNlICk7CgoJCV9wb3NpdGlvbiQzLnNldEZyb21NYXRyaXhQb3NpdGlvbiggdGhpcy5tYXRyaXhXb3JsZCApOwoKCQlpZiAoIHRoaXMuaXNDYW1lcmEgfHwgdGhpcy5pc0xpZ2h0ICkgewoKCQkJX20xJDEubG9va0F0KCBfcG9zaXRpb24kMywgX3RhcmdldCwgdGhpcy51cCApOwoKCQl9IGVsc2UgewoKCQkJX20xJDEubG9va0F0KCBfdGFyZ2V0LCBfcG9zaXRpb24kMywgdGhpcy51cCApOwoKCQl9CgoJCXRoaXMucXVhdGVybmlvbi5zZXRGcm9tUm90YXRpb25NYXRyaXgoIF9tMSQxICk7CgoJCWlmICggcGFyZW50ICkgewoKCQkJX20xJDEuZXh0cmFjdFJvdGF0aW9uKCBwYXJlbnQubWF0cml4V29ybGQgKTsKCQkJX3ExLnNldEZyb21Sb3RhdGlvbk1hdHJpeCggX20xJDEgKTsKCQkJdGhpcy5xdWF0ZXJuaW9uLnByZW11bHRpcGx5KCBfcTEuaW52ZXJ0KCkgKTsKCgkJfQoKCX0KCglhZGQoIG9iamVjdCApIHsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID4gMSApIHsKCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkgKysgKSB7CgoJCQkJdGhpcy5hZGQoIGFyZ3VtZW50c1sgaSBdICk7CgoJCQl9CgoJCQlyZXR1cm4gdGhpczsKCgkJfQoKCQlpZiAoIG9iamVjdCA9PT0gdGhpcyApIHsKCgkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5PYmplY3QzRC5hZGQ6IG9iamVjdCBjYW5cJ3QgYmUgYWRkZWQgYXMgYSBjaGlsZCBvZiBpdHNlbGYuJywgb2JqZWN0ICk7CgkJCXJldHVybiB0aGlzOwoKCQl9CgoJCWlmICggb2JqZWN0ICYmIG9iamVjdC5pc09iamVjdDNEICkgewoKCQkJaWYgKCBvYmplY3QucGFyZW50ICE9PSBudWxsICkgewoKCQkJCW9iamVjdC5wYXJlbnQucmVtb3ZlKCBvYmplY3QgKTsKCgkJCX0KCgkJCW9iamVjdC5wYXJlbnQgPSB0aGlzOwoJCQl0aGlzLmNoaWxkcmVuLnB1c2goIG9iamVjdCApOwoKCQkJb2JqZWN0LmRpc3BhdGNoRXZlbnQoIF9hZGRlZEV2ZW50ICk7CgoJCX0gZWxzZSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuT2JqZWN0M0QuYWRkOiBvYmplY3Qgbm90IGFuIGluc3RhbmNlIG9mIFRIUkVFLk9iamVjdDNELicsIG9iamVjdCApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglyZW1vdmUoIG9iamVjdCApIHsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID4gMSApIHsKCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkgKysgKSB7CgoJCQkJdGhpcy5yZW1vdmUoIGFyZ3VtZW50c1sgaSBdICk7CgoJCQl9CgoJCQlyZXR1cm4gdGhpczsKCgkJfQoKCQljb25zdCBpbmRleCA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZiggb2JqZWN0ICk7CgoJCWlmICggaW5kZXggIT09IC0gMSApIHsKCgkJCW9iamVjdC5wYXJlbnQgPSBudWxsOwoJCQl0aGlzLmNoaWxkcmVuLnNwbGljZSggaW5kZXgsIDEgKTsKCgkJCW9iamVjdC5kaXNwYXRjaEV2ZW50KCBfcmVtb3ZlZEV2ZW50ICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJlbW92ZUZyb21QYXJlbnQoKSB7CgoJCWNvbnN0IHBhcmVudCA9IHRoaXMucGFyZW50OwoKCQlpZiAoIHBhcmVudCAhPT0gbnVsbCApIHsKCgkJCXBhcmVudC5yZW1vdmUoIHRoaXMgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xlYXIoKSB7CgoJCXJldHVybiB0aGlzLnJlbW92ZSggLi4uIHRoaXMuY2hpbGRyZW4gKTsKCgl9CgoJYXR0YWNoKCBvYmplY3QgKSB7CgoJCS8vIGFkZHMgb2JqZWN0IGFzIGEgY2hpbGQgb2YgdGhpcywgd2hpbGUgbWFpbnRhaW5pbmcgdGhlIG9iamVjdCdzIHdvcmxkIHRyYW5zZm9ybQoKCQkvLyBOb3RlOiBUaGlzIG1ldGhvZCBkb2VzIG5vdCBzdXBwb3J0IHNjZW5lIGdyYXBocyBoYXZpbmcgbm9uLXVuaWZvcm1seS1zY2FsZWQgbm9kZXMocykKCgkJdGhpcy51cGRhdGVXb3JsZE1hdHJpeCggdHJ1ZSwgZmFsc2UgKTsKCgkJX20xJDEuY29weSggdGhpcy5tYXRyaXhXb3JsZCApLmludmVydCgpOwoKCQlpZiAoIG9iamVjdC5wYXJlbnQgIT09IG51bGwgKSB7CgoJCQlvYmplY3QucGFyZW50LnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoKCQkJX20xJDEubXVsdGlwbHkoIG9iamVjdC5wYXJlbnQubWF0cml4V29ybGQgKTsKCgkJfQoKCQlvYmplY3QuYXBwbHlNYXRyaXg0KCBfbTEkMSApOwoKCQl0aGlzLmFkZCggb2JqZWN0ICk7CgoJCW9iamVjdC51cGRhdGVXb3JsZE1hdHJpeCggZmFsc2UsIHRydWUgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldE9iamVjdEJ5SWQoIGlkICkgewoKCQlyZXR1cm4gdGhpcy5nZXRPYmplY3RCeVByb3BlcnR5KCAnaWQnLCBpZCApOwoKCX0KCglnZXRPYmplY3RCeU5hbWUoIG5hbWUgKSB7CgoJCXJldHVybiB0aGlzLmdldE9iamVjdEJ5UHJvcGVydHkoICduYW1lJywgbmFtZSApOwoKCX0KCglnZXRPYmplY3RCeVByb3BlcnR5KCBuYW1lLCB2YWx1ZSApIHsKCgkJaWYgKCB0aGlzWyBuYW1lIF0gPT09IHZhbHVlICkgcmV0dXJuIHRoaXM7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWNvbnN0IGNoaWxkID0gdGhpcy5jaGlsZHJlblsgaSBdOwoJCQljb25zdCBvYmplY3QgPSBjaGlsZC5nZXRPYmplY3RCeVByb3BlcnR5KCBuYW1lLCB2YWx1ZSApOwoKCQkJaWYgKCBvYmplY3QgIT09IHVuZGVmaW5lZCApIHsKCgkJCQlyZXR1cm4gb2JqZWN0OwoKCQkJfQoKCQl9CgoJCXJldHVybiB1bmRlZmluZWQ7CgoJfQoKCWdldE9iamVjdHNCeVByb3BlcnR5KCBuYW1lLCB2YWx1ZSwgcmVzdWx0ID0gW10gKSB7CgoJCWlmICggdGhpc1sgbmFtZSBdID09PSB2YWx1ZSApIHJlc3VsdC5wdXNoKCB0aGlzICk7CgoJCWNvbnN0IGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbjsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWNoaWxkcmVuWyBpIF0uZ2V0T2JqZWN0c0J5UHJvcGVydHkoIG5hbWUsIHZhbHVlLCByZXN1bHQgKTsKCgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoKCX0KCglnZXRXb3JsZFBvc2l0aW9uKCB0YXJnZXQgKSB7CgoJCXRoaXMudXBkYXRlV29ybGRNYXRyaXgoIHRydWUsIGZhbHNlICk7CgoJCXJldHVybiB0YXJnZXQuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCB0aGlzLm1hdHJpeFdvcmxkICk7CgoJfQoKCWdldFdvcmxkUXVhdGVybmlvbiggdGFyZ2V0ICkgewoKCQl0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoKCQl0aGlzLm1hdHJpeFdvcmxkLmRlY29tcG9zZSggX3Bvc2l0aW9uJDMsIHRhcmdldCwgX3NjYWxlJDIgKTsKCgkJcmV0dXJuIHRhcmdldDsKCgl9CgoJZ2V0V29ybGRTY2FsZSggdGFyZ2V0ICkgewoKCQl0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoKCQl0aGlzLm1hdHJpeFdvcmxkLmRlY29tcG9zZSggX3Bvc2l0aW9uJDMsIF9xdWF0ZXJuaW9uJDIsIHRhcmdldCApOwoKCQlyZXR1cm4gdGFyZ2V0OwoKCX0KCglnZXRXb3JsZERpcmVjdGlvbiggdGFyZ2V0ICkgewoKCQl0aGlzLnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoKCQljb25zdCBlID0gdGhpcy5tYXRyaXhXb3JsZC5lbGVtZW50czsKCgkJcmV0dXJuIHRhcmdldC5zZXQoIGVbIDggXSwgZVsgOSBdLCBlWyAxMCBdICkubm9ybWFsaXplKCk7CgoJfQoKCXJheWNhc3QoIC8qIHJheWNhc3RlciwgaW50ZXJzZWN0cyAqLyApIHt9CgoJdHJhdmVyc2UoIGNhbGxiYWNrICkgewoKCQljYWxsYmFjayggdGhpcyApOwoKCQljb25zdCBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljaGlsZHJlblsgaSBdLnRyYXZlcnNlKCBjYWxsYmFjayApOwoKCQl9CgoJfQoKCXRyYXZlcnNlVmlzaWJsZSggY2FsbGJhY2sgKSB7CgoJCWlmICggdGhpcy52aXNpYmxlID09PSBmYWxzZSApIHJldHVybjsKCgkJY2FsbGJhY2soIHRoaXMgKTsKCgkJY29uc3QgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY2hpbGRyZW5bIGkgXS50cmF2ZXJzZVZpc2libGUoIGNhbGxiYWNrICk7CgoJCX0KCgl9CgoJdHJhdmVyc2VBbmNlc3RvcnMoIGNhbGxiYWNrICkgewoKCQljb25zdCBwYXJlbnQgPSB0aGlzLnBhcmVudDsKCgkJaWYgKCBwYXJlbnQgIT09IG51bGwgKSB7CgoJCQljYWxsYmFjayggcGFyZW50ICk7CgoJCQlwYXJlbnQudHJhdmVyc2VBbmNlc3RvcnMoIGNhbGxiYWNrICk7CgoJCX0KCgl9CgoJdXBkYXRlTWF0cml4KCkgewoKCQl0aGlzLm1hdHJpeC5jb21wb3NlKCB0aGlzLnBvc2l0aW9uLCB0aGlzLnF1YXRlcm5pb24sIHRoaXMuc2NhbGUgKTsKCgkJdGhpcy5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlID0gdHJ1ZTsKCgl9CgoJdXBkYXRlTWF0cml4V29ybGQoIGZvcmNlICkgewoKCQlpZiAoIHRoaXMubWF0cml4QXV0b1VwZGF0ZSApIHRoaXMudXBkYXRlTWF0cml4KCk7CgoJCWlmICggdGhpcy5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlIHx8IGZvcmNlICkgewoKCQkJaWYgKCB0aGlzLnBhcmVudCA9PT0gbnVsbCApIHsKCgkJCQl0aGlzLm1hdHJpeFdvcmxkLmNvcHkoIHRoaXMubWF0cml4ICk7CgoJCQl9IGVsc2UgewoKCQkJCXRoaXMubWF0cml4V29ybGQubXVsdGlwbHlNYXRyaWNlcyggdGhpcy5wYXJlbnQubWF0cml4V29ybGQsIHRoaXMubWF0cml4ICk7CgoJCQl9CgoJCQl0aGlzLm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSBmYWxzZTsKCgkJCWZvcmNlID0gdHJ1ZTsKCgkJfQoKCQkvLyB1cGRhdGUgY2hpbGRyZW4KCgkJY29uc3QgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgY2hpbGQgPSBjaGlsZHJlblsgaSBdOwoKCQkJaWYgKCBjaGlsZC5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPT09IHRydWUgfHwgZm9yY2UgPT09IHRydWUgKSB7CgoJCQkJY2hpbGQudXBkYXRlTWF0cml4V29ybGQoIGZvcmNlICk7CgoJCQl9CgoJCX0KCgl9CgoJdXBkYXRlV29ybGRNYXRyaXgoIHVwZGF0ZVBhcmVudHMsIHVwZGF0ZUNoaWxkcmVuICkgewoKCQljb25zdCBwYXJlbnQgPSB0aGlzLnBhcmVudDsKCgkJaWYgKCB1cGRhdGVQYXJlbnRzID09PSB0cnVlICYmIHBhcmVudCAhPT0gbnVsbCAmJiBwYXJlbnQubWF0cml4V29ybGRBdXRvVXBkYXRlID09PSB0cnVlICkgewoKCQkJcGFyZW50LnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoKCQl9CgoJCWlmICggdGhpcy5tYXRyaXhBdXRvVXBkYXRlICkgdGhpcy51cGRhdGVNYXRyaXgoKTsKCgkJaWYgKCB0aGlzLnBhcmVudCA9PT0gbnVsbCApIHsKCgkJCXRoaXMubWF0cml4V29ybGQuY29weSggdGhpcy5tYXRyaXggKTsKCgkJfSBlbHNlIHsKCgkJCXRoaXMubWF0cml4V29ybGQubXVsdGlwbHlNYXRyaWNlcyggdGhpcy5wYXJlbnQubWF0cml4V29ybGQsIHRoaXMubWF0cml4ICk7CgoJCX0KCgkJLy8gdXBkYXRlIGNoaWxkcmVuCgoJCWlmICggdXBkYXRlQ2hpbGRyZW4gPT09IHRydWUgKSB7CgoJCQljb25zdCBjaGlsZHJlbiA9IHRoaXMuY2hpbGRyZW47CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWNvbnN0IGNoaWxkID0gY2hpbGRyZW5bIGkgXTsKCgkJCQlpZiAoIGNoaWxkLm1hdHJpeFdvcmxkQXV0b1VwZGF0ZSA9PT0gdHJ1ZSApIHsKCgkJCQkJY2hpbGQudXBkYXRlV29ybGRNYXRyaXgoIGZhbHNlLCB0cnVlICk7CgoJCQkJfQoKCQkJfQoKCQl9CgoJfQoKCXRvSlNPTiggbWV0YSApIHsKCgkJLy8gbWV0YSBpcyBhIHN0cmluZyB3aGVuIGNhbGxlZCBmcm9tIEpTT04uc3RyaW5naWZ5CgkJY29uc3QgaXNSb290T2JqZWN0ID0gKCBtZXRhID09PSB1bmRlZmluZWQgfHwgdHlwZW9mIG1ldGEgPT09ICdzdHJpbmcnICk7CgoJCWNvbnN0IG91dHB1dCA9IHt9OwoKCQkvLyBtZXRhIGlzIGEgaGFzaCB1c2VkIHRvIGNvbGxlY3QgZ2VvbWV0cmllcywgbWF0ZXJpYWxzLgoJCS8vIG5vdCBwcm92aWRpbmcgaXQgaW1wbGllcyB0aGF0IHRoaXMgaXMgdGhlIHJvb3Qgb2JqZWN0CgkJLy8gYmVpbmcgc2VyaWFsaXplZC4KCQlpZiAoIGlzUm9vdE9iamVjdCApIHsKCgkJCS8vIGluaXRpYWxpemUgbWV0YSBvYmoKCQkJbWV0YSA9IHsKCQkJCWdlb21ldHJpZXM6IHt9LAoJCQkJbWF0ZXJpYWxzOiB7fSwKCQkJCXRleHR1cmVzOiB7fSwKCQkJCWltYWdlczoge30sCgkJCQlzaGFwZXM6IHt9LAoJCQkJc2tlbGV0b25zOiB7fSwKCQkJCWFuaW1hdGlvbnM6IHt9LAoJCQkJbm9kZXM6IHt9CgkJCX07CgoJCQlvdXRwdXQubWV0YWRhdGEgPSB7CgkJCQl2ZXJzaW9uOiA0LjYsCgkJCQl0eXBlOiAnT2JqZWN0JywKCQkJCWdlbmVyYXRvcjogJ09iamVjdDNELnRvSlNPTicKCQkJfTsKCgkJfQoKCQkvLyBzdGFuZGFyZCBPYmplY3QzRCBzZXJpYWxpemF0aW9uCgoJCWNvbnN0IG9iamVjdCA9IHt9OwoKCQlvYmplY3QudXVpZCA9IHRoaXMudXVpZDsKCQlvYmplY3QudHlwZSA9IHRoaXMudHlwZTsKCgkJaWYgKCB0aGlzLm5hbWUgIT09ICcnICkgb2JqZWN0Lm5hbWUgPSB0aGlzLm5hbWU7CgkJaWYgKCB0aGlzLmNhc3RTaGFkb3cgPT09IHRydWUgKSBvYmplY3QuY2FzdFNoYWRvdyA9IHRydWU7CgkJaWYgKCB0aGlzLnJlY2VpdmVTaGFkb3cgPT09IHRydWUgKSBvYmplY3QucmVjZWl2ZVNoYWRvdyA9IHRydWU7CgkJaWYgKCB0aGlzLnZpc2libGUgPT09IGZhbHNlICkgb2JqZWN0LnZpc2libGUgPSBmYWxzZTsKCQlpZiAoIHRoaXMuZnJ1c3R1bUN1bGxlZCA9PT0gZmFsc2UgKSBvYmplY3QuZnJ1c3R1bUN1bGxlZCA9IGZhbHNlOwoJCWlmICggdGhpcy5yZW5kZXJPcmRlciAhPT0gMCApIG9iamVjdC5yZW5kZXJPcmRlciA9IHRoaXMucmVuZGVyT3JkZXI7CgkJaWYgKCBPYmplY3Qua2V5cyggdGhpcy51c2VyRGF0YSApLmxlbmd0aCA+IDAgKSBvYmplY3QudXNlckRhdGEgPSB0aGlzLnVzZXJEYXRhOwoKCQlvYmplY3QubGF5ZXJzID0gdGhpcy5sYXllcnMubWFzazsKCQlvYmplY3QubWF0cml4ID0gdGhpcy5tYXRyaXgudG9BcnJheSgpOwoJCW9iamVjdC51cCA9IHRoaXMudXAudG9BcnJheSgpOwoKCQlpZiAoIHRoaXMubWF0cml4QXV0b1VwZGF0ZSA9PT0gZmFsc2UgKSBvYmplY3QubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwoKCQkvLyBvYmplY3Qgc3BlY2lmaWMgcHJvcGVydGllcwoKCQlpZiAoIHRoaXMuaXNJbnN0YW5jZWRNZXNoICkgewoKCQkJb2JqZWN0LnR5cGUgPSAnSW5zdGFuY2VkTWVzaCc7CgkJCW9iamVjdC5jb3VudCA9IHRoaXMuY291bnQ7CgkJCW9iamVjdC5pbnN0YW5jZU1hdHJpeCA9IHRoaXMuaW5zdGFuY2VNYXRyaXgudG9KU09OKCk7CgkJCWlmICggdGhpcy5pbnN0YW5jZUNvbG9yICE9PSBudWxsICkgb2JqZWN0Lmluc3RhbmNlQ29sb3IgPSB0aGlzLmluc3RhbmNlQ29sb3IudG9KU09OKCk7CgoJCX0KCgkJaWYgKCB0aGlzLmlzQmF0Y2hlZE1lc2ggKSB7CgoJCQlvYmplY3QudHlwZSA9ICdCYXRjaGVkTWVzaCc7CgkJCW9iamVjdC5wZXJPYmplY3RGcnVzdHVtQ3VsbGVkID0gdGhpcy5wZXJPYmplY3RGcnVzdHVtQ3VsbGVkOwoJCQlvYmplY3Quc29ydE9iamVjdHMgPSB0aGlzLnNvcnRPYmplY3RzOwoKCQkJb2JqZWN0LmRyYXdSYW5nZXMgPSB0aGlzLl9kcmF3UmFuZ2VzOwoJCQlvYmplY3QucmVzZXJ2ZWRSYW5nZXMgPSB0aGlzLl9yZXNlcnZlZFJhbmdlczsKCgkJCW9iamVjdC52aXNpYmlsaXR5ID0gdGhpcy5fdmlzaWJpbGl0eTsKCQkJb2JqZWN0LmFjdGl2ZSA9IHRoaXMuX2FjdGl2ZTsKCQkJb2JqZWN0LmJvdW5kcyA9IHRoaXMuX2JvdW5kcy5tYXAoIGJvdW5kID0+ICggewoJCQkJYm94SW5pdGlhbGl6ZWQ6IGJvdW5kLmJveEluaXRpYWxpemVkLAoJCQkJYm94TWluOiBib3VuZC5ib3gubWluLnRvQXJyYXkoKSwKCQkJCWJveE1heDogYm91bmQuYm94Lm1heC50b0FycmF5KCksCgoJCQkJc3BoZXJlSW5pdGlhbGl6ZWQ6IGJvdW5kLnNwaGVyZUluaXRpYWxpemVkLAoJCQkJc3BoZXJlUmFkaXVzOiBib3VuZC5zcGhlcmUucmFkaXVzLAoJCQkJc3BoZXJlQ2VudGVyOiBib3VuZC5zcGhlcmUuY2VudGVyLnRvQXJyYXkoKQoJCQl9ICkgKTsKCgkJCW9iamVjdC5tYXhHZW9tZXRyeUNvdW50ID0gdGhpcy5fbWF4R2VvbWV0cnlDb3VudDsKCQkJb2JqZWN0Lm1heFZlcnRleENvdW50ID0gdGhpcy5fbWF4VmVydGV4Q291bnQ7CgkJCW9iamVjdC5tYXhJbmRleENvdW50ID0gdGhpcy5fbWF4SW5kZXhDb3VudDsKCgkJCW9iamVjdC5nZW9tZXRyeUluaXRpYWxpemVkID0gdGhpcy5fZ2VvbWV0cnlJbml0aWFsaXplZDsKCQkJb2JqZWN0Lmdlb21ldHJ5Q291bnQgPSB0aGlzLl9nZW9tZXRyeUNvdW50OwoKCQkJb2JqZWN0Lm1hdHJpY2VzVGV4dHVyZSA9IHRoaXMuX21hdHJpY2VzVGV4dHVyZS50b0pTT04oIG1ldGEgKTsKCgkJCWlmICggdGhpcy5ib3VuZGluZ1NwaGVyZSAhPT0gbnVsbCApIHsKCgkJCQlvYmplY3QuYm91bmRpbmdTcGhlcmUgPSB7CgkJCQkJY2VudGVyOiBvYmplY3QuYm91bmRpbmdTcGhlcmUuY2VudGVyLnRvQXJyYXkoKSwKCQkJCQlyYWRpdXM6IG9iamVjdC5ib3VuZGluZ1NwaGVyZS5yYWRpdXMKCQkJCX07CgoJCQl9CgoJCQlpZiAoIHRoaXMuYm91bmRpbmdCb3ggIT09IG51bGwgKSB7CgoJCQkJb2JqZWN0LmJvdW5kaW5nQm94ID0gewoJCQkJCW1pbjogb2JqZWN0LmJvdW5kaW5nQm94Lm1pbi50b0FycmF5KCksCgkJCQkJbWF4OiBvYmplY3QuYm91bmRpbmdCb3gubWF4LnRvQXJyYXkoKQoJCQkJfTsKCgkJCX0KCgkJfQoKCQkvLwoKCQlmdW5jdGlvbiBzZXJpYWxpemUoIGxpYnJhcnksIGVsZW1lbnQgKSB7CgoJCQlpZiAoIGxpYnJhcnlbIGVsZW1lbnQudXVpZCBdID09PSB1bmRlZmluZWQgKSB7CgoJCQkJbGlicmFyeVsgZWxlbWVudC51dWlkIF0gPSBlbGVtZW50LnRvSlNPTiggbWV0YSApOwoKCQkJfQoKCQkJcmV0dXJuIGVsZW1lbnQudXVpZDsKCgkJfQoKCQlpZiAoIHRoaXMuaXNTY2VuZSApIHsKCgkJCWlmICggdGhpcy5iYWNrZ3JvdW5kICkgewoKCQkJCWlmICggdGhpcy5iYWNrZ3JvdW5kLmlzQ29sb3IgKSB7CgoJCQkJCW9iamVjdC5iYWNrZ3JvdW5kID0gdGhpcy5iYWNrZ3JvdW5kLnRvSlNPTigpOwoKCQkJCX0gZWxzZSBpZiAoIHRoaXMuYmFja2dyb3VuZC5pc1RleHR1cmUgKSB7CgoJCQkJCW9iamVjdC5iYWNrZ3JvdW5kID0gdGhpcy5iYWNrZ3JvdW5kLnRvSlNPTiggbWV0YSApLnV1aWQ7CgoJCQkJfQoKCQkJfQoKCQkJaWYgKCB0aGlzLmVudmlyb25tZW50ICYmIHRoaXMuZW52aXJvbm1lbnQuaXNUZXh0dXJlICYmIHRoaXMuZW52aXJvbm1lbnQuaXNSZW5kZXJUYXJnZXRUZXh0dXJlICE9PSB0cnVlICkgewoKCQkJCW9iamVjdC5lbnZpcm9ubWVudCA9IHRoaXMuZW52aXJvbm1lbnQudG9KU09OKCBtZXRhICkudXVpZDsKCgkJCX0KCgkJfSBlbHNlIGlmICggdGhpcy5pc01lc2ggfHwgdGhpcy5pc0xpbmUgfHwgdGhpcy5pc1BvaW50cyApIHsKCgkJCW9iamVjdC5nZW9tZXRyeSA9IHNlcmlhbGl6ZSggbWV0YS5nZW9tZXRyaWVzLCB0aGlzLmdlb21ldHJ5ICk7CgoJCQljb25zdCBwYXJhbWV0ZXJzID0gdGhpcy5nZW9tZXRyeS5wYXJhbWV0ZXJzOwoKCQkJaWYgKCBwYXJhbWV0ZXJzICE9PSB1bmRlZmluZWQgJiYgcGFyYW1ldGVycy5zaGFwZXMgIT09IHVuZGVmaW5lZCApIHsKCgkJCQljb25zdCBzaGFwZXMgPSBwYXJhbWV0ZXJzLnNoYXBlczsKCgkJCQlpZiAoIEFycmF5LmlzQXJyYXkoIHNoYXBlcyApICkgewoKCQkJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBzaGFwZXMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQkJCWNvbnN0IHNoYXBlID0gc2hhcGVzWyBpIF07CgoJCQkJCQlzZXJpYWxpemUoIG1ldGEuc2hhcGVzLCBzaGFwZSApOwoKCQkJCQl9CgoJCQkJfSBlbHNlIHsKCgkJCQkJc2VyaWFsaXplKCBtZXRhLnNoYXBlcywgc2hhcGVzICk7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCWlmICggdGhpcy5pc1NraW5uZWRNZXNoICkgewoKCQkJb2JqZWN0LmJpbmRNb2RlID0gdGhpcy5iaW5kTW9kZTsKCQkJb2JqZWN0LmJpbmRNYXRyaXggPSB0aGlzLmJpbmRNYXRyaXgudG9BcnJheSgpOwoKCQkJaWYgKCB0aGlzLnNrZWxldG9uICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJc2VyaWFsaXplKCBtZXRhLnNrZWxldG9ucywgdGhpcy5za2VsZXRvbiApOwoKCQkJCW9iamVjdC5za2VsZXRvbiA9IHRoaXMuc2tlbGV0b24udXVpZDsKCgkJCX0KCgkJfQoKCQlpZiAoIHRoaXMubWF0ZXJpYWwgIT09IHVuZGVmaW5lZCApIHsKCgkJCWlmICggQXJyYXkuaXNBcnJheSggdGhpcy5tYXRlcmlhbCApICkgewoKCQkJCWNvbnN0IHV1aWRzID0gW107CgoJCQkJZm9yICggbGV0IGkgPSAwLCBsID0gdGhpcy5tYXRlcmlhbC5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCQl1dWlkcy5wdXNoKCBzZXJpYWxpemUoIG1ldGEubWF0ZXJpYWxzLCB0aGlzLm1hdGVyaWFsWyBpIF0gKSApOwoKCQkJCX0KCgkJCQlvYmplY3QubWF0ZXJpYWwgPSB1dWlkczsKCgkJCX0gZWxzZSB7CgoJCQkJb2JqZWN0Lm1hdGVyaWFsID0gc2VyaWFsaXplKCBtZXRhLm1hdGVyaWFscywgdGhpcy5tYXRlcmlhbCApOwoKCQkJfQoKCQl9CgoJCS8vCgoJCWlmICggdGhpcy5jaGlsZHJlbi5sZW5ndGggPiAwICkgewoKCQkJb2JqZWN0LmNoaWxkcmVuID0gW107CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSArKyApIHsKCgkJCQlvYmplY3QuY2hpbGRyZW4ucHVzaCggdGhpcy5jaGlsZHJlblsgaSBdLnRvSlNPTiggbWV0YSApLm9iamVjdCApOwoKCQkJfQoKCQl9CgoJCS8vCgoJCWlmICggdGhpcy5hbmltYXRpb25zLmxlbmd0aCA+IDAgKSB7CgoJCQlvYmplY3QuYW5pbWF0aW9ucyA9IFtdOwoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgdGhpcy5hbmltYXRpb25zLmxlbmd0aDsgaSArKyApIHsKCgkJCQljb25zdCBhbmltYXRpb24gPSB0aGlzLmFuaW1hdGlvbnNbIGkgXTsKCgkJCQlvYmplY3QuYW5pbWF0aW9ucy5wdXNoKCBzZXJpYWxpemUoIG1ldGEuYW5pbWF0aW9ucywgYW5pbWF0aW9uICkgKTsKCgkJCX0KCgkJfQoKCQlpZiAoIGlzUm9vdE9iamVjdCApIHsKCgkJCWNvbnN0IGdlb21ldHJpZXMgPSBleHRyYWN0RnJvbUNhY2hlKCBtZXRhLmdlb21ldHJpZXMgKTsKCQkJY29uc3QgbWF0ZXJpYWxzID0gZXh0cmFjdEZyb21DYWNoZSggbWV0YS5tYXRlcmlhbHMgKTsKCQkJY29uc3QgdGV4dHVyZXMgPSBleHRyYWN0RnJvbUNhY2hlKCBtZXRhLnRleHR1cmVzICk7CgkJCWNvbnN0IGltYWdlcyA9IGV4dHJhY3RGcm9tQ2FjaGUoIG1ldGEuaW1hZ2VzICk7CgkJCWNvbnN0IHNoYXBlcyA9IGV4dHJhY3RGcm9tQ2FjaGUoIG1ldGEuc2hhcGVzICk7CgkJCWNvbnN0IHNrZWxldG9ucyA9IGV4dHJhY3RGcm9tQ2FjaGUoIG1ldGEuc2tlbGV0b25zICk7CgkJCWNvbnN0IGFuaW1hdGlvbnMgPSBleHRyYWN0RnJvbUNhY2hlKCBtZXRhLmFuaW1hdGlvbnMgKTsKCQkJY29uc3Qgbm9kZXMgPSBleHRyYWN0RnJvbUNhY2hlKCBtZXRhLm5vZGVzICk7CgoJCQlpZiAoIGdlb21ldHJpZXMubGVuZ3RoID4gMCApIG91dHB1dC5nZW9tZXRyaWVzID0gZ2VvbWV0cmllczsKCQkJaWYgKCBtYXRlcmlhbHMubGVuZ3RoID4gMCApIG91dHB1dC5tYXRlcmlhbHMgPSBtYXRlcmlhbHM7CgkJCWlmICggdGV4dHVyZXMubGVuZ3RoID4gMCApIG91dHB1dC50ZXh0dXJlcyA9IHRleHR1cmVzOwoJCQlpZiAoIGltYWdlcy5sZW5ndGggPiAwICkgb3V0cHV0LmltYWdlcyA9IGltYWdlczsKCQkJaWYgKCBzaGFwZXMubGVuZ3RoID4gMCApIG91dHB1dC5zaGFwZXMgPSBzaGFwZXM7CgkJCWlmICggc2tlbGV0b25zLmxlbmd0aCA+IDAgKSBvdXRwdXQuc2tlbGV0b25zID0gc2tlbGV0b25zOwoJCQlpZiAoIGFuaW1hdGlvbnMubGVuZ3RoID4gMCApIG91dHB1dC5hbmltYXRpb25zID0gYW5pbWF0aW9uczsKCQkJaWYgKCBub2Rlcy5sZW5ndGggPiAwICkgb3V0cHV0Lm5vZGVzID0gbm9kZXM7CgoJCX0KCgkJb3V0cHV0Lm9iamVjdCA9IG9iamVjdDsKCgkJcmV0dXJuIG91dHB1dDsKCgkJLy8gZXh0cmFjdCBkYXRhIGZyb20gdGhlIGNhY2hlIGhhc2gKCQkvLyByZW1vdmUgbWV0YWRhdGEgb24gZWFjaCBpdGVtCgkJLy8gYW5kIHJldHVybiBhcyBhcnJheQoJCWZ1bmN0aW9uIGV4dHJhY3RGcm9tQ2FjaGUoIGNhY2hlICkgewoKCQkJY29uc3QgdmFsdWVzID0gW107CgkJCWZvciAoIGNvbnN0IGtleSBpbiBjYWNoZSApIHsKCgkJCQljb25zdCBkYXRhID0gY2FjaGVbIGtleSBdOwoJCQkJZGVsZXRlIGRhdGEubWV0YWRhdGE7CgkJCQl2YWx1ZXMucHVzaCggZGF0YSApOwoKCQkJfQoKCQkJcmV0dXJuIHZhbHVlczsKCgkJfQoKCX0KCgljbG9uZSggcmVjdXJzaXZlICkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KCB0aGlzLCByZWN1cnNpdmUgKTsKCgl9CgoJY29weSggc291cmNlLCByZWN1cnNpdmUgPSB0cnVlICkgewoKCQl0aGlzLm5hbWUgPSBzb3VyY2UubmFtZTsKCgkJdGhpcy51cC5jb3B5KCBzb3VyY2UudXAgKTsKCgkJdGhpcy5wb3NpdGlvbi5jb3B5KCBzb3VyY2UucG9zaXRpb24gKTsKCQl0aGlzLnJvdGF0aW9uLm9yZGVyID0gc291cmNlLnJvdGF0aW9uLm9yZGVyOwoJCXRoaXMucXVhdGVybmlvbi5jb3B5KCBzb3VyY2UucXVhdGVybmlvbiApOwoJCXRoaXMuc2NhbGUuY29weSggc291cmNlLnNjYWxlICk7CgoJCXRoaXMubWF0cml4LmNvcHkoIHNvdXJjZS5tYXRyaXggKTsKCQl0aGlzLm1hdHJpeFdvcmxkLmNvcHkoIHNvdXJjZS5tYXRyaXhXb3JsZCApOwoKCQl0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSBzb3VyY2UubWF0cml4QXV0b1VwZGF0ZTsKCgkJdGhpcy5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPSBzb3VyY2UubWF0cml4V29ybGRBdXRvVXBkYXRlOwoJCXRoaXMubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9IHNvdXJjZS5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlOwoKCQl0aGlzLmxheWVycy5tYXNrID0gc291cmNlLmxheWVycy5tYXNrOwoJCXRoaXMudmlzaWJsZSA9IHNvdXJjZS52aXNpYmxlOwoKCQl0aGlzLmNhc3RTaGFkb3cgPSBzb3VyY2UuY2FzdFNoYWRvdzsKCQl0aGlzLnJlY2VpdmVTaGFkb3cgPSBzb3VyY2UucmVjZWl2ZVNoYWRvdzsKCgkJdGhpcy5mcnVzdHVtQ3VsbGVkID0gc291cmNlLmZydXN0dW1DdWxsZWQ7CgkJdGhpcy5yZW5kZXJPcmRlciA9IHNvdXJjZS5yZW5kZXJPcmRlcjsKCgkJdGhpcy5hbmltYXRpb25zID0gc291cmNlLmFuaW1hdGlvbnMuc2xpY2UoKTsKCgkJdGhpcy51c2VyRGF0YSA9IEpTT04ucGFyc2UoIEpTT04uc3RyaW5naWZ5KCBzb3VyY2UudXNlckRhdGEgKSApOwoKCQlpZiAoIHJlY3Vyc2l2ZSA9PT0gdHJ1ZSApIHsKCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IHNvdXJjZS5jaGlsZHJlbi5sZW5ndGg7IGkgKysgKSB7CgoJCQkJY29uc3QgY2hpbGQgPSBzb3VyY2UuY2hpbGRyZW5bIGkgXTsKCQkJCXRoaXMuYWRkKCBjaGlsZC5jbG9uZSgpICk7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKT2JqZWN0M0QuREVGQVVMVF9VUCA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoIDAsIDEsIDAgKTsKT2JqZWN0M0QuREVGQVVMVF9NQVRSSVhfQVVUT19VUERBVEUgPSB0cnVlOwpPYmplY3QzRC5ERUZBVUxUX01BVFJJWF9XT1JMRF9BVVRPX1VQREFURSA9IHRydWU7Cgpjb25zdCBfdjAkMSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3YxJDMgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92MiQyID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfdjMkMiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNvbnN0IF92YWIgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92YWMgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92YmMgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92YXAgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92YnAgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92Y3AgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CgpjbGFzcyBUcmlhbmdsZSB7CgoJY29uc3RydWN0b3IoIGEgPSBuZXcgVmVjdG9yMygpLCBiID0gbmV3IFZlY3RvcjMoKSwgYyA9IG5ldyBWZWN0b3IzKCkgKSB7CgoJCXRoaXMuYSA9IGE7CgkJdGhpcy5iID0gYjsKCQl0aGlzLmMgPSBjOwoKCX0KCglzdGF0aWMgZ2V0Tm9ybWFsKCBhLCBiLCBjLCB0YXJnZXQgKSB7CgoJCXRhcmdldC5zdWJWZWN0b3JzKCBjLCBiICk7CgkJX3YwJDEuc3ViVmVjdG9ycyggYSwgYiApOwoJCXRhcmdldC5jcm9zcyggX3YwJDEgKTsKCgkJY29uc3QgdGFyZ2V0TGVuZ3RoU3EgPSB0YXJnZXQubGVuZ3RoU3EoKTsKCQlpZiAoIHRhcmdldExlbmd0aFNxID4gMCApIHsKCgkJCXJldHVybiB0YXJnZXQubXVsdGlwbHlTY2FsYXIoIDEgLyBNYXRoLnNxcnQoIHRhcmdldExlbmd0aFNxICkgKTsKCgkJfQoKCQlyZXR1cm4gdGFyZ2V0LnNldCggMCwgMCwgMCApOwoKCX0KCgkvLyBzdGF0aWMvaW5zdGFuY2UgbWV0aG9kIHRvIGNhbGN1bGF0ZSBiYXJ5Y2VudHJpYyBjb29yZGluYXRlcwoJLy8gYmFzZWQgb246IGh0dHA6Ly93d3cuYmxhY2twYXduLmNvbS90ZXh0cy9wb2ludGlucG9seS9kZWZhdWx0Lmh0bWwKCXN0YXRpYyBnZXRCYXJ5Y29vcmQoIHBvaW50LCBhLCBiLCBjLCB0YXJnZXQgKSB7CgoJCV92MCQxLnN1YlZlY3RvcnMoIGMsIGEgKTsKCQlfdjEkMy5zdWJWZWN0b3JzKCBiLCBhICk7CgkJX3YyJDIuc3ViVmVjdG9ycyggcG9pbnQsIGEgKTsKCgkJY29uc3QgZG90MDAgPSBfdjAkMS5kb3QoIF92MCQxICk7CgkJY29uc3QgZG90MDEgPSBfdjAkMS5kb3QoIF92MSQzICk7CgkJY29uc3QgZG90MDIgPSBfdjAkMS5kb3QoIF92MiQyICk7CgkJY29uc3QgZG90MTEgPSBfdjEkMy5kb3QoIF92MSQzICk7CgkJY29uc3QgZG90MTIgPSBfdjEkMy5kb3QoIF92MiQyICk7CgoJCWNvbnN0IGRlbm9tID0gKCBkb3QwMCAqIGRvdDExIC0gZG90MDEgKiBkb3QwMSApOwoKCQkvLyBjb2xsaW5lYXIgb3Igc2luZ3VsYXIgdHJpYW5nbGUKCQlpZiAoIGRlbm9tID09PSAwICkgewoKCQkJdGFyZ2V0LnNldCggMCwgMCwgMCApOwoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQljb25zdCBpbnZEZW5vbSA9IDEgLyBkZW5vbTsKCQljb25zdCB1ID0gKCBkb3QxMSAqIGRvdDAyIC0gZG90MDEgKiBkb3QxMiApICogaW52RGVub207CgkJY29uc3QgdiA9ICggZG90MDAgKiBkb3QxMiAtIGRvdDAxICogZG90MDIgKSAqIGludkRlbm9tOwoKCQkvLyBiYXJ5Y2VudHJpYyBjb29yZGluYXRlcyBtdXN0IGFsd2F5cyBzdW0gdG8gMQoJCXJldHVybiB0YXJnZXQuc2V0KCAxIC0gdSAtIHYsIHYsIHUgKTsKCgl9CgoJc3RhdGljIGNvbnRhaW5zUG9pbnQoIHBvaW50LCBhLCBiLCBjICkgewoKCQkvLyBpZiB0aGUgdHJpYW5nbGUgaXMgZGVnZW5lcmF0ZSB0aGVuIHdlIGNhbid0IGNvbnRhaW4gYSBwb2ludAoJCWlmICggdGhpcy5nZXRCYXJ5Y29vcmQoIHBvaW50LCBhLCBiLCBjLCBfdjMkMiApID09PSBudWxsICkgewoKCQkJcmV0dXJuIGZhbHNlOwoKCQl9CgoJCXJldHVybiAoIF92MyQyLnggPj0gMCApICYmICggX3YzJDIueSA+PSAwICkgJiYgKCAoIF92MyQyLnggKyBfdjMkMi55ICkgPD0gMSApOwoKCX0KCglzdGF0aWMgZ2V0SW50ZXJwb2xhdGlvbiggcG9pbnQsIHAxLCBwMiwgcDMsIHYxLCB2MiwgdjMsIHRhcmdldCApIHsKCgkJaWYgKCB0aGlzLmdldEJhcnljb29yZCggcG9pbnQsIHAxLCBwMiwgcDMsIF92MyQyICkgPT09IG51bGwgKSB7CgoJCQl0YXJnZXQueCA9IDA7CgkJCXRhcmdldC55ID0gMDsKCQkJaWYgKCAneicgaW4gdGFyZ2V0ICkgdGFyZ2V0LnogPSAwOwoJCQlpZiAoICd3JyBpbiB0YXJnZXQgKSB0YXJnZXQudyA9IDA7CgkJCXJldHVybiBudWxsOwoKCQl9CgoJCXRhcmdldC5zZXRTY2FsYXIoIDAgKTsKCQl0YXJnZXQuYWRkU2NhbGVkVmVjdG9yKCB2MSwgX3YzJDIueCApOwoJCXRhcmdldC5hZGRTY2FsZWRWZWN0b3IoIHYyLCBfdjMkMi55ICk7CgkJdGFyZ2V0LmFkZFNjYWxlZFZlY3RvciggdjMsIF92MyQyLnogKTsKCgkJcmV0dXJuIHRhcmdldDsKCgl9CgoJc3RhdGljIGlzRnJvbnRGYWNpbmcoIGEsIGIsIGMsIGRpcmVjdGlvbiApIHsKCgkJX3YwJDEuc3ViVmVjdG9ycyggYywgYiApOwoJCV92MSQzLnN1YlZlY3RvcnMoIGEsIGIgKTsKCgkJLy8gc3RyaWN0bHkgZnJvbnQgZmFjaW5nCgkJcmV0dXJuICggX3YwJDEuY3Jvc3MoIF92MSQzICkuZG90KCBkaXJlY3Rpb24gKSA8IDAgKSA/IHRydWUgOiBmYWxzZTsKCgl9CgoJc2V0KCBhLCBiLCBjICkgewoKCQl0aGlzLmEuY29weSggYSApOwoJCXRoaXMuYi5jb3B5KCBiICk7CgkJdGhpcy5jLmNvcHkoIGMgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEZyb21Qb2ludHNBbmRJbmRpY2VzKCBwb2ludHMsIGkwLCBpMSwgaTIgKSB7CgoJCXRoaXMuYS5jb3B5KCBwb2ludHNbIGkwIF0gKTsKCQl0aGlzLmIuY29weSggcG9pbnRzWyBpMSBdICk7CgkJdGhpcy5jLmNvcHkoIHBvaW50c1sgaTIgXSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbUF0dHJpYnV0ZUFuZEluZGljZXMoIGF0dHJpYnV0ZSwgaTAsIGkxLCBpMiApIHsKCgkJdGhpcy5hLmZyb21CdWZmZXJBdHRyaWJ1dGUoIGF0dHJpYnV0ZSwgaTAgKTsKCQl0aGlzLmIuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggYXR0cmlidXRlLCBpMSApOwoJCXRoaXMuYy5mcm9tQnVmZmVyQXR0cmlidXRlKCBhdHRyaWJ1dGUsIGkyICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSggdGhpcyApOwoKCX0KCgljb3B5KCB0cmlhbmdsZSApIHsKCgkJdGhpcy5hLmNvcHkoIHRyaWFuZ2xlLmEgKTsKCQl0aGlzLmIuY29weSggdHJpYW5nbGUuYiApOwoJCXRoaXMuYy5jb3B5KCB0cmlhbmdsZS5jICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRBcmVhKCkgewoKCQlfdjAkMS5zdWJWZWN0b3JzKCB0aGlzLmMsIHRoaXMuYiApOwoJCV92MSQzLnN1YlZlY3RvcnMoIHRoaXMuYSwgdGhpcy5iICk7CgoJCXJldHVybiBfdjAkMS5jcm9zcyggX3YxJDMgKS5sZW5ndGgoKSAqIDAuNTsKCgl9CgoJZ2V0TWlkcG9pbnQoIHRhcmdldCApIHsKCgkJcmV0dXJuIHRhcmdldC5hZGRWZWN0b3JzKCB0aGlzLmEsIHRoaXMuYiApLmFkZCggdGhpcy5jICkubXVsdGlwbHlTY2FsYXIoIDEgLyAzICk7CgoJfQoKCWdldE5vcm1hbCggdGFyZ2V0ICkgewoKCQlyZXR1cm4gVHJpYW5nbGUuZ2V0Tm9ybWFsKCB0aGlzLmEsIHRoaXMuYiwgdGhpcy5jLCB0YXJnZXQgKTsKCgl9CgoJZ2V0UGxhbmUoIHRhcmdldCApIHsKCgkJcmV0dXJuIHRhcmdldC5zZXRGcm9tQ29wbGFuYXJQb2ludHMoIHRoaXMuYSwgdGhpcy5iLCB0aGlzLmMgKTsKCgl9CgoJZ2V0QmFyeWNvb3JkKCBwb2ludCwgdGFyZ2V0ICkgewoKCQlyZXR1cm4gVHJpYW5nbGUuZ2V0QmFyeWNvb3JkKCBwb2ludCwgdGhpcy5hLCB0aGlzLmIsIHRoaXMuYywgdGFyZ2V0ICk7CgoJfQoKCWdldEludGVycG9sYXRpb24oIHBvaW50LCB2MSwgdjIsIHYzLCB0YXJnZXQgKSB7CgoJCXJldHVybiBUcmlhbmdsZS5nZXRJbnRlcnBvbGF0aW9uKCBwb2ludCwgdGhpcy5hLCB0aGlzLmIsIHRoaXMuYywgdjEsIHYyLCB2MywgdGFyZ2V0ICk7CgoJfQoKCWNvbnRhaW5zUG9pbnQoIHBvaW50ICkgewoKCQlyZXR1cm4gVHJpYW5nbGUuY29udGFpbnNQb2ludCggcG9pbnQsIHRoaXMuYSwgdGhpcy5iLCB0aGlzLmMgKTsKCgl9CgoJaXNGcm9udEZhY2luZyggZGlyZWN0aW9uICkgewoKCQlyZXR1cm4gVHJpYW5nbGUuaXNGcm9udEZhY2luZyggdGhpcy5hLCB0aGlzLmIsIHRoaXMuYywgZGlyZWN0aW9uICk7CgoJfQoKCWludGVyc2VjdHNCb3goIGJveCApIHsKCgkJcmV0dXJuIGJveC5pbnRlcnNlY3RzVHJpYW5nbGUoIHRoaXMgKTsKCgl9CgoJY2xvc2VzdFBvaW50VG9Qb2ludCggcCwgdGFyZ2V0ICkgewoKCQljb25zdCBhID0gdGhpcy5hLCBiID0gdGhpcy5iLCBjID0gdGhpcy5jOwoJCWxldCB2LCB3OwoKCQkvLyBhbGdvcml0aG0gdGhhbmtzIHRvIFJlYWwtVGltZSBDb2xsaXNpb24gRGV0ZWN0aW9uIGJ5IENocmlzdGVyIEVyaWNzb24sCgkJLy8gcHVibGlzaGVkIGJ5IE1vcmdhbiBLYXVmbWFubiBQdWJsaXNoZXJzLCAoYykgMjAwNSBFbHNldmllciBJbmMuLAoJCS8vIHVuZGVyIHRoZSBhY2NvbXBhbnlpbmcgbGljZW5zZTsgc2VlIGNoYXB0ZXIgNS4xLjUgZm9yIGRldGFpbGVkIGV4cGxhbmF0aW9uLgoJCS8vIGJhc2ljYWxseSwgd2UncmUgZGlzdGluZ3Vpc2hpbmcgd2hpY2ggb2YgdGhlIHZvcm9ub2kgcmVnaW9ucyBvZiB0aGUgdHJpYW5nbGUKCQkvLyB0aGUgcG9pbnQgbGllcyBpbiB3aXRoIHRoZSBtaW5pbXVtIGFtb3VudCBvZiByZWR1bmRhbnQgY29tcHV0YXRpb24uCgoJCV92YWIuc3ViVmVjdG9ycyggYiwgYSApOwoJCV92YWMuc3ViVmVjdG9ycyggYywgYSApOwoJCV92YXAuc3ViVmVjdG9ycyggcCwgYSApOwoJCWNvbnN0IGQxID0gX3ZhYi5kb3QoIF92YXAgKTsKCQljb25zdCBkMiA9IF92YWMuZG90KCBfdmFwICk7CgkJaWYgKCBkMSA8PSAwICYmIGQyIDw9IDAgKSB7CgoJCQkvLyB2ZXJ0ZXggcmVnaW9uIG9mIEE7IGJhcnljZW50cmljIGNvb3JkcyAoMSwgMCwgMCkKCQkJcmV0dXJuIHRhcmdldC5jb3B5KCBhICk7CgoJCX0KCgkJX3ZicC5zdWJWZWN0b3JzKCBwLCBiICk7CgkJY29uc3QgZDMgPSBfdmFiLmRvdCggX3ZicCApOwoJCWNvbnN0IGQ0ID0gX3ZhYy5kb3QoIF92YnAgKTsKCQlpZiAoIGQzID49IDAgJiYgZDQgPD0gZDMgKSB7CgoJCQkvLyB2ZXJ0ZXggcmVnaW9uIG9mIEI7IGJhcnljZW50cmljIGNvb3JkcyAoMCwgMSwgMCkKCQkJcmV0dXJuIHRhcmdldC5jb3B5KCBiICk7CgoJCX0KCgkJY29uc3QgdmMgPSBkMSAqIGQ0IC0gZDMgKiBkMjsKCQlpZiAoIHZjIDw9IDAgJiYgZDEgPj0gMCAmJiBkMyA8PSAwICkgewoKCQkJdiA9IGQxIC8gKCBkMSAtIGQzICk7CgkJCS8vIGVkZ2UgcmVnaW9uIG9mIEFCOyBiYXJ5Y2VudHJpYyBjb29yZHMgKDEtdiwgdiwgMCkKCQkJcmV0dXJuIHRhcmdldC5jb3B5KCBhICkuYWRkU2NhbGVkVmVjdG9yKCBfdmFiLCB2ICk7CgoJCX0KCgkJX3ZjcC5zdWJWZWN0b3JzKCBwLCBjICk7CgkJY29uc3QgZDUgPSBfdmFiLmRvdCggX3ZjcCApOwoJCWNvbnN0IGQ2ID0gX3ZhYy5kb3QoIF92Y3AgKTsKCQlpZiAoIGQ2ID49IDAgJiYgZDUgPD0gZDYgKSB7CgoJCQkvLyB2ZXJ0ZXggcmVnaW9uIG9mIEM7IGJhcnljZW50cmljIGNvb3JkcyAoMCwgMCwgMSkKCQkJcmV0dXJuIHRhcmdldC5jb3B5KCBjICk7CgoJCX0KCgkJY29uc3QgdmIgPSBkNSAqIGQyIC0gZDEgKiBkNjsKCQlpZiAoIHZiIDw9IDAgJiYgZDIgPj0gMCAmJiBkNiA8PSAwICkgewoKCQkJdyA9IGQyIC8gKCBkMiAtIGQ2ICk7CgkJCS8vIGVkZ2UgcmVnaW9uIG9mIEFDOyBiYXJ5Y2VudHJpYyBjb29yZHMgKDEtdywgMCwgdykKCQkJcmV0dXJuIHRhcmdldC5jb3B5KCBhICkuYWRkU2NhbGVkVmVjdG9yKCBfdmFjLCB3ICk7CgoJCX0KCgkJY29uc3QgdmEgPSBkMyAqIGQ2IC0gZDUgKiBkNDsKCQlpZiAoIHZhIDw9IDAgJiYgKCBkNCAtIGQzICkgPj0gMCAmJiAoIGQ1IC0gZDYgKSA+PSAwICkgewoKCQkJX3ZiYy5zdWJWZWN0b3JzKCBjLCBiICk7CgkJCXcgPSAoIGQ0IC0gZDMgKSAvICggKCBkNCAtIGQzICkgKyAoIGQ1IC0gZDYgKSApOwoJCQkvLyBlZGdlIHJlZ2lvbiBvZiBCQzsgYmFyeWNlbnRyaWMgY29vcmRzICgwLCAxLXcsIHcpCgkJCXJldHVybiB0YXJnZXQuY29weSggYiApLmFkZFNjYWxlZFZlY3RvciggX3ZiYywgdyApOyAvLyBlZGdlIHJlZ2lvbiBvZiBCQwoKCQl9CgoJCS8vIGZhY2UgcmVnaW9uCgkJY29uc3QgZGVub20gPSAxIC8gKCB2YSArIHZiICsgdmMgKTsKCQkvLyB1ID0gdmEgKiBkZW5vbQoJCXYgPSB2YiAqIGRlbm9tOwoJCXcgPSB2YyAqIGRlbm9tOwoKCQlyZXR1cm4gdGFyZ2V0LmNvcHkoIGEgKS5hZGRTY2FsZWRWZWN0b3IoIF92YWIsIHYgKS5hZGRTY2FsZWRWZWN0b3IoIF92YWMsIHcgKTsKCgl9CgoJZXF1YWxzKCB0cmlhbmdsZSApIHsKCgkJcmV0dXJuIHRyaWFuZ2xlLmEuZXF1YWxzKCB0aGlzLmEgKSAmJiB0cmlhbmdsZS5iLmVxdWFscyggdGhpcy5iICkgJiYgdHJpYW5nbGUuYy5lcXVhbHMoIHRoaXMuYyApOwoKCX0KCn0KCmNvbnN0IF9jb2xvcktleXdvcmRzID0geyAnYWxpY2VibHVlJzogMHhGMEY4RkYsICdhbnRpcXVld2hpdGUnOiAweEZBRUJENywgJ2FxdWEnOiAweDAwRkZGRiwgJ2FxdWFtYXJpbmUnOiAweDdGRkZENCwgJ2F6dXJlJzogMHhGMEZGRkYsCgknYmVpZ2UnOiAweEY1RjVEQywgJ2Jpc3F1ZSc6IDB4RkZFNEM0LCAnYmxhY2snOiAweDAwMDAwMCwgJ2JsYW5jaGVkYWxtb25kJzogMHhGRkVCQ0QsICdibHVlJzogMHgwMDAwRkYsICdibHVldmlvbGV0JzogMHg4QTJCRTIsCgknYnJvd24nOiAweEE1MkEyQSwgJ2J1cmx5d29vZCc6IDB4REVCODg3LCAnY2FkZXRibHVlJzogMHg1RjlFQTAsICdjaGFydHJldXNlJzogMHg3RkZGMDAsICdjaG9jb2xhdGUnOiAweEQyNjkxRSwgJ2NvcmFsJzogMHhGRjdGNTAsCgknY29ybmZsb3dlcmJsdWUnOiAweDY0OTVFRCwgJ2Nvcm5zaWxrJzogMHhGRkY4REMsICdjcmltc29uJzogMHhEQzE0M0MsICdjeWFuJzogMHgwMEZGRkYsICdkYXJrYmx1ZSc6IDB4MDAwMDhCLCAnZGFya2N5YW4nOiAweDAwOEI4QiwKCSdkYXJrZ29sZGVucm9kJzogMHhCODg2MEIsICdkYXJrZ3JheSc6IDB4QTlBOUE5LCAnZGFya2dyZWVuJzogMHgwMDY0MDAsICdkYXJrZ3JleSc6IDB4QTlBOUE5LCAnZGFya2toYWtpJzogMHhCREI3NkIsICdkYXJrbWFnZW50YSc6IDB4OEIwMDhCLAoJJ2RhcmtvbGl2ZWdyZWVuJzogMHg1NTZCMkYsICdkYXJrb3JhbmdlJzogMHhGRjhDMDAsICdkYXJrb3JjaGlkJzogMHg5OTMyQ0MsICdkYXJrcmVkJzogMHg4QjAwMDAsICdkYXJrc2FsbW9uJzogMHhFOTk2N0EsICdkYXJrc2VhZ3JlZW4nOiAweDhGQkM4RiwKCSdkYXJrc2xhdGVibHVlJzogMHg0ODNEOEIsICdkYXJrc2xhdGVncmF5JzogMHgyRjRGNEYsICdkYXJrc2xhdGVncmV5JzogMHgyRjRGNEYsICdkYXJrdHVycXVvaXNlJzogMHgwMENFRDEsICdkYXJrdmlvbGV0JzogMHg5NDAwRDMsCgknZGVlcHBpbmsnOiAweEZGMTQ5MywgJ2RlZXBza3libHVlJzogMHgwMEJGRkYsICdkaW1ncmF5JzogMHg2OTY5NjksICdkaW1ncmV5JzogMHg2OTY5NjksICdkb2RnZXJibHVlJzogMHgxRTkwRkYsICdmaXJlYnJpY2snOiAweEIyMjIyMiwKCSdmbG9yYWx3aGl0ZSc6IDB4RkZGQUYwLCAnZm9yZXN0Z3JlZW4nOiAweDIyOEIyMiwgJ2Z1Y2hzaWEnOiAweEZGMDBGRiwgJ2dhaW5zYm9ybyc6IDB4RENEQ0RDLCAnZ2hvc3R3aGl0ZSc6IDB4RjhGOEZGLCAnZ29sZCc6IDB4RkZENzAwLAoJJ2dvbGRlbnJvZCc6IDB4REFBNTIwLCAnZ3JheSc6IDB4ODA4MDgwLCAnZ3JlZW4nOiAweDAwODAwMCwgJ2dyZWVueWVsbG93JzogMHhBREZGMkYsICdncmV5JzogMHg4MDgwODAsICdob25leWRldyc6IDB4RjBGRkYwLCAnaG90cGluayc6IDB4RkY2OUI0LAoJJ2luZGlhbnJlZCc6IDB4Q0Q1QzVDLCAnaW5kaWdvJzogMHg0QjAwODIsICdpdm9yeSc6IDB4RkZGRkYwLCAna2hha2knOiAweEYwRTY4QywgJ2xhdmVuZGVyJzogMHhFNkU2RkEsICdsYXZlbmRlcmJsdXNoJzogMHhGRkYwRjUsICdsYXduZ3JlZW4nOiAweDdDRkMwMCwKCSdsZW1vbmNoaWZmb24nOiAweEZGRkFDRCwgJ2xpZ2h0Ymx1ZSc6IDB4QUREOEU2LCAnbGlnaHRjb3JhbCc6IDB4RjA4MDgwLCAnbGlnaHRjeWFuJzogMHhFMEZGRkYsICdsaWdodGdvbGRlbnJvZHllbGxvdyc6IDB4RkFGQUQyLCAnbGlnaHRncmF5JzogMHhEM0QzRDMsCgknbGlnaHRncmVlbic6IDB4OTBFRTkwLCAnbGlnaHRncmV5JzogMHhEM0QzRDMsICdsaWdodHBpbmsnOiAweEZGQjZDMSwgJ2xpZ2h0c2FsbW9uJzogMHhGRkEwN0EsICdsaWdodHNlYWdyZWVuJzogMHgyMEIyQUEsICdsaWdodHNreWJsdWUnOiAweDg3Q0VGQSwKCSdsaWdodHNsYXRlZ3JheSc6IDB4Nzc4ODk5LCAnbGlnaHRzbGF0ZWdyZXknOiAweDc3ODg5OSwgJ2xpZ2h0c3RlZWxibHVlJzogMHhCMEM0REUsICdsaWdodHllbGxvdyc6IDB4RkZGRkUwLCAnbGltZSc6IDB4MDBGRjAwLCAnbGltZWdyZWVuJzogMHgzMkNEMzIsCgknbGluZW4nOiAweEZBRjBFNiwgJ21hZ2VudGEnOiAweEZGMDBGRiwgJ21hcm9vbic6IDB4ODAwMDAwLCAnbWVkaXVtYXF1YW1hcmluZSc6IDB4NjZDREFBLCAnbWVkaXVtYmx1ZSc6IDB4MDAwMENELCAnbWVkaXVtb3JjaGlkJzogMHhCQTU1RDMsCgknbWVkaXVtcHVycGxlJzogMHg5MzcwREIsICdtZWRpdW1zZWFncmVlbic6IDB4M0NCMzcxLCAnbWVkaXVtc2xhdGVibHVlJzogMHg3QjY4RUUsICdtZWRpdW1zcHJpbmdncmVlbic6IDB4MDBGQTlBLCAnbWVkaXVtdHVycXVvaXNlJzogMHg0OEQxQ0MsCgknbWVkaXVtdmlvbGV0cmVkJzogMHhDNzE1ODUsICdtaWRuaWdodGJsdWUnOiAweDE5MTk3MCwgJ21pbnRjcmVhbSc6IDB4RjVGRkZBLCAnbWlzdHlyb3NlJzogMHhGRkU0RTEsICdtb2NjYXNpbic6IDB4RkZFNEI1LCAnbmF2YWpvd2hpdGUnOiAweEZGREVBRCwKCSduYXZ5JzogMHgwMDAwODAsICdvbGRsYWNlJzogMHhGREY1RTYsICdvbGl2ZSc6IDB4ODA4MDAwLCAnb2xpdmVkcmFiJzogMHg2QjhFMjMsICdvcmFuZ2UnOiAweEZGQTUwMCwgJ29yYW5nZXJlZCc6IDB4RkY0NTAwLCAnb3JjaGlkJzogMHhEQTcwRDYsCgkncGFsZWdvbGRlbnJvZCc6IDB4RUVFOEFBLCAncGFsZWdyZWVuJzogMHg5OEZCOTgsICdwYWxldHVycXVvaXNlJzogMHhBRkVFRUUsICdwYWxldmlvbGV0cmVkJzogMHhEQjcwOTMsICdwYXBheWF3aGlwJzogMHhGRkVGRDUsICdwZWFjaHB1ZmYnOiAweEZGREFCOSwKCSdwZXJ1JzogMHhDRDg1M0YsICdwaW5rJzogMHhGRkMwQ0IsICdwbHVtJzogMHhEREEwREQsICdwb3dkZXJibHVlJzogMHhCMEUwRTYsICdwdXJwbGUnOiAweDgwMDA4MCwgJ3JlYmVjY2FwdXJwbGUnOiAweDY2MzM5OSwgJ3JlZCc6IDB4RkYwMDAwLCAncm9zeWJyb3duJzogMHhCQzhGOEYsCgkncm95YWxibHVlJzogMHg0MTY5RTEsICdzYWRkbGVicm93bic6IDB4OEI0NTEzLCAnc2FsbW9uJzogMHhGQTgwNzIsICdzYW5keWJyb3duJzogMHhGNEE0NjAsICdzZWFncmVlbic6IDB4MkU4QjU3LCAnc2Vhc2hlbGwnOiAweEZGRjVFRSwKCSdzaWVubmEnOiAweEEwNTIyRCwgJ3NpbHZlcic6IDB4QzBDMEMwLCAnc2t5Ymx1ZSc6IDB4ODdDRUVCLCAnc2xhdGVibHVlJzogMHg2QTVBQ0QsICdzbGF0ZWdyYXknOiAweDcwODA5MCwgJ3NsYXRlZ3JleSc6IDB4NzA4MDkwLCAnc25vdyc6IDB4RkZGQUZBLAoJJ3NwcmluZ2dyZWVuJzogMHgwMEZGN0YsICdzdGVlbGJsdWUnOiAweDQ2ODJCNCwgJ3Rhbic6IDB4RDJCNDhDLCAndGVhbCc6IDB4MDA4MDgwLCAndGhpc3RsZSc6IDB4RDhCRkQ4LCAndG9tYXRvJzogMHhGRjYzNDcsICd0dXJxdW9pc2UnOiAweDQwRTBEMCwKCSd2aW9sZXQnOiAweEVFODJFRSwgJ3doZWF0JzogMHhGNURFQjMsICd3aGl0ZSc6IDB4RkZGRkZGLCAnd2hpdGVzbW9rZSc6IDB4RjVGNUY1LCAneWVsbG93JzogMHhGRkZGMDAsICd5ZWxsb3dncmVlbic6IDB4OUFDRDMyIH07Cgpjb25zdCBfaHNsQSA9IHsgaDogMCwgczogMCwgbDogMCB9Owpjb25zdCBfaHNsQiA9IHsgaDogMCwgczogMCwgbDogMCB9OwoKZnVuY3Rpb24gaHVlMnJnYiggcCwgcSwgdCApIHsKCglpZiAoIHQgPCAwICkgdCArPSAxOwoJaWYgKCB0ID4gMSApIHQgLT0gMTsKCWlmICggdCA8IDEgLyA2ICkgcmV0dXJuIHAgKyAoIHEgLSBwICkgKiA2ICogdDsKCWlmICggdCA8IDEgLyAyICkgcmV0dXJuIHE7CglpZiAoIHQgPCAyIC8gMyApIHJldHVybiBwICsgKCBxIC0gcCApICogNiAqICggMiAvIDMgLSB0ICk7CglyZXR1cm4gcDsKCn0KCmNsYXNzIENvbG9yIHsKCgljb25zdHJ1Y3RvciggciwgZywgYiApIHsKCgkJdGhpcy5pc0NvbG9yID0gdHJ1ZTsKCgkJdGhpcy5yID0gMTsKCQl0aGlzLmcgPSAxOwoJCXRoaXMuYiA9IDE7CgoJCXJldHVybiB0aGlzLnNldCggciwgZywgYiApOwoKCX0KCglzZXQoIHIsIGcsIGIgKSB7CgoJCWlmICggZyA9PT0gdW5kZWZpbmVkICYmIGIgPT09IHVuZGVmaW5lZCApIHsKCgkJCS8vIHIgaXMgVEhSRUUuQ29sb3IsIGhleCBvciBzdHJpbmcKCgkJCWNvbnN0IHZhbHVlID0gcjsKCgkJCWlmICggdmFsdWUgJiYgdmFsdWUuaXNDb2xvciApIHsKCgkJCQl0aGlzLmNvcHkoIHZhbHVlICk7CgoJCQl9IGVsc2UgaWYgKCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInICkgewoKCQkJCXRoaXMuc2V0SGV4KCB2YWx1ZSApOwoKCQkJfSBlbHNlIGlmICggdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyApIHsKCgkJCQl0aGlzLnNldFN0eWxlKCB2YWx1ZSApOwoKCQkJfQoKCQl9IGVsc2UgewoKCQkJdGhpcy5zZXRSR0IoIHIsIGcsIGIgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0U2NhbGFyKCBzY2FsYXIgKSB7CgoJCXRoaXMuciA9IHNjYWxhcjsKCQl0aGlzLmcgPSBzY2FsYXI7CgkJdGhpcy5iID0gc2NhbGFyOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0SGV4KCBoZXgsIGNvbG9yU3BhY2UgPSBTUkdCQ29sb3JTcGFjZSApIHsKCgkJaGV4ID0gTWF0aC5mbG9vciggaGV4ICk7CgoJCXRoaXMuciA9ICggaGV4ID4+IDE2ICYgMjU1ICkgLyAyNTU7CgkJdGhpcy5nID0gKCBoZXggPj4gOCAmIDI1NSApIC8gMjU1OwoJCXRoaXMuYiA9ICggaGV4ICYgMjU1ICkgLyAyNTU7CgoJCUNvbG9yTWFuYWdlbWVudC50b1dvcmtpbmdDb2xvclNwYWNlKCB0aGlzLCBjb2xvclNwYWNlICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRSR0IoIHIsIGcsIGIsIGNvbG9yU3BhY2UgPSBDb2xvck1hbmFnZW1lbnQud29ya2luZ0NvbG9yU3BhY2UgKSB7CgoJCXRoaXMuciA9IHI7CgkJdGhpcy5nID0gZzsKCQl0aGlzLmIgPSBiOwoKCQlDb2xvck1hbmFnZW1lbnQudG9Xb3JraW5nQ29sb3JTcGFjZSggdGhpcywgY29sb3JTcGFjZSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0SFNMKCBoLCBzLCBsLCBjb2xvclNwYWNlID0gQ29sb3JNYW5hZ2VtZW50LndvcmtpbmdDb2xvclNwYWNlICkgewoKCQkvLyBoLHMsbCByYW5nZXMgYXJlIGluIDAuMCAtIDEuMAoJCWggPSBldWNsaWRlYW5Nb2R1bG8oIGgsIDEgKTsKCQlzID0gY2xhbXAoIHMsIDAsIDEgKTsKCQlsID0gY2xhbXAoIGwsIDAsIDEgKTsKCgkJaWYgKCBzID09PSAwICkgewoKCQkJdGhpcy5yID0gdGhpcy5nID0gdGhpcy5iID0gbDsKCgkJfSBlbHNlIHsKCgkJCWNvbnN0IHAgPSBsIDw9IDAuNSA/IGwgKiAoIDEgKyBzICkgOiBsICsgcyAtICggbCAqIHMgKTsKCQkJY29uc3QgcSA9ICggMiAqIGwgKSAtIHA7CgoJCQl0aGlzLnIgPSBodWUycmdiKCBxLCBwLCBoICsgMSAvIDMgKTsKCQkJdGhpcy5nID0gaHVlMnJnYiggcSwgcCwgaCApOwoJCQl0aGlzLmIgPSBodWUycmdiKCBxLCBwLCBoIC0gMSAvIDMgKTsKCgkJfQoKCQlDb2xvck1hbmFnZW1lbnQudG9Xb3JraW5nQ29sb3JTcGFjZSggdGhpcywgY29sb3JTcGFjZSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0U3R5bGUoIHN0eWxlLCBjb2xvclNwYWNlID0gU1JHQkNvbG9yU3BhY2UgKSB7CgoJCWZ1bmN0aW9uIGhhbmRsZUFscGhhKCBzdHJpbmcgKSB7CgoJCQlpZiAoIHN0cmluZyA9PT0gdW5kZWZpbmVkICkgcmV0dXJuOwoKCQkJaWYgKCBwYXJzZUZsb2F0KCBzdHJpbmcgKSA8IDEgKSB7CgoJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuQ29sb3I6IEFscGhhIGNvbXBvbmVudCBvZiAnICsgc3R5bGUgKyAnIHdpbGwgYmUgaWdub3JlZC4nICk7CgoJCQl9CgoJCX0KCgoJCWxldCBtOwoKCQlpZiAoIG0gPSAvXihcdyspXCgoW15cKV0qKVwpLy5leGVjKCBzdHlsZSApICkgewoKCQkJLy8gcmdiIC8gaHNsCgoJCQlsZXQgY29sb3I7CgkJCWNvbnN0IG5hbWUgPSBtWyAxIF07CgkJCWNvbnN0IGNvbXBvbmVudHMgPSBtWyAyIF07CgoJCQlzd2l0Y2ggKCBuYW1lICkgewoKCQkJCWNhc2UgJ3JnYic6CgkJCQljYXNlICdyZ2JhJzoKCgkJCQkJaWYgKCBjb2xvciA9IC9eXHMqKFxkKylccyosXHMqKFxkKylccyosXHMqKFxkKylccyooPzosXHMqKFxkKlwuP1xkKylccyopPyQvLmV4ZWMoIGNvbXBvbmVudHMgKSApIHsKCgkJCQkJCS8vIHJnYigyNTUsMCwwKSByZ2JhKDI1NSwwLDAsMC41KQoKCQkJCQkJaGFuZGxlQWxwaGEoIGNvbG9yWyA0IF0gKTsKCgkJCQkJCXJldHVybiB0aGlzLnNldFJHQigKCQkJCQkJCU1hdGgubWluKCAyNTUsIHBhcnNlSW50KCBjb2xvclsgMSBdLCAxMCApICkgLyAyNTUsCgkJCQkJCQlNYXRoLm1pbiggMjU1LCBwYXJzZUludCggY29sb3JbIDIgXSwgMTAgKSApIC8gMjU1LAoJCQkJCQkJTWF0aC5taW4oIDI1NSwgcGFyc2VJbnQoIGNvbG9yWyAzIF0sIDEwICkgKSAvIDI1NSwKCQkJCQkJCWNvbG9yU3BhY2UKCQkJCQkJKTsKCgkJCQkJfQoKCQkJCQlpZiAoIGNvbG9yID0gL15ccyooXGQrKVwlXHMqLFxzKihcZCspXCVccyosXHMqKFxkKylcJVxzKig/OixccyooXGQqXC4/XGQrKVxzKik/JC8uZXhlYyggY29tcG9uZW50cyApICkgewoKCQkJCQkJLy8gcmdiKDEwMCUsMCUsMCUpIHJnYmEoMTAwJSwwJSwwJSwwLjUpCgoJCQkJCQloYW5kbGVBbHBoYSggY29sb3JbIDQgXSApOwoKCQkJCQkJcmV0dXJuIHRoaXMuc2V0UkdCKAoJCQkJCQkJTWF0aC5taW4oIDEwMCwgcGFyc2VJbnQoIGNvbG9yWyAxIF0sIDEwICkgKSAvIDEwMCwKCQkJCQkJCU1hdGgubWluKCAxMDAsIHBhcnNlSW50KCBjb2xvclsgMiBdLCAxMCApICkgLyAxMDAsCgkJCQkJCQlNYXRoLm1pbiggMTAwLCBwYXJzZUludCggY29sb3JbIDMgXSwgMTAgKSApIC8gMTAwLAoJCQkJCQkJY29sb3JTcGFjZQoJCQkJCQkpOwoKCQkJCQl9CgoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgJ2hzbCc6CgkJCQljYXNlICdoc2xhJzoKCgkJCQkJaWYgKCBjb2xvciA9IC9eXHMqKFxkKlwuP1xkKylccyosXHMqKFxkKlwuP1xkKylcJVxzKixccyooXGQqXC4/XGQrKVwlXHMqKD86LFxzKihcZCpcLj9cZCspXHMqKT8kLy5leGVjKCBjb21wb25lbnRzICkgKSB7CgoJCQkJCQkvLyBoc2woMTIwLDUwJSw1MCUpIGhzbGEoMTIwLDUwJSw1MCUsMC41KQoKCQkJCQkJaGFuZGxlQWxwaGEoIGNvbG9yWyA0IF0gKTsKCgkJCQkJCXJldHVybiB0aGlzLnNldEhTTCgKCQkJCQkJCXBhcnNlRmxvYXQoIGNvbG9yWyAxIF0gKSAvIDM2MCwKCQkJCQkJCXBhcnNlRmxvYXQoIGNvbG9yWyAyIF0gKSAvIDEwMCwKCQkJCQkJCXBhcnNlRmxvYXQoIGNvbG9yWyAzIF0gKSAvIDEwMCwKCQkJCQkJCWNvbG9yU3BhY2UKCQkJCQkJKTsKCgkJCQkJfQoKCQkJCQlicmVhazsKCgkJCQlkZWZhdWx0OgoKCQkJCQljb25zb2xlLndhcm4oICdUSFJFRS5Db2xvcjogVW5rbm93biBjb2xvciBtb2RlbCAnICsgc3R5bGUgKTsKCgkJCX0KCgkJfSBlbHNlIGlmICggbSA9IC9eXCMoW0EtRmEtZlxkXSspJC8uZXhlYyggc3R5bGUgKSApIHsKCgkJCS8vIGhleCBjb2xvcgoKCQkJY29uc3QgaGV4ID0gbVsgMSBdOwoJCQljb25zdCBzaXplID0gaGV4Lmxlbmd0aDsKCgkJCWlmICggc2l6ZSA9PT0gMyApIHsKCgkJCQkvLyAjZmYwCgkJCQlyZXR1cm4gdGhpcy5zZXRSR0IoCgkJCQkJcGFyc2VJbnQoIGhleC5jaGFyQXQoIDAgKSwgMTYgKSAvIDE1LAoJCQkJCXBhcnNlSW50KCBoZXguY2hhckF0KCAxICksIDE2ICkgLyAxNSwKCQkJCQlwYXJzZUludCggaGV4LmNoYXJBdCggMiApLCAxNiApIC8gMTUsCgkJCQkJY29sb3JTcGFjZQoJCQkJKTsKCgkJCX0gZWxzZSBpZiAoIHNpemUgPT09IDYgKSB7CgoJCQkJLy8gI2ZmMDAwMAoJCQkJcmV0dXJuIHRoaXMuc2V0SGV4KCBwYXJzZUludCggaGV4LCAxNiApLCBjb2xvclNwYWNlICk7CgoJCQl9IGVsc2UgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLkNvbG9yOiBJbnZhbGlkIGhleCBjb2xvciAnICsgc3R5bGUgKTsKCgkJCX0KCgkJfSBlbHNlIGlmICggc3R5bGUgJiYgc3R5bGUubGVuZ3RoID4gMCApIHsKCgkJCXJldHVybiB0aGlzLnNldENvbG9yTmFtZSggc3R5bGUsIGNvbG9yU3BhY2UgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0Q29sb3JOYW1lKCBzdHlsZSwgY29sb3JTcGFjZSA9IFNSR0JDb2xvclNwYWNlICkgewoKCQkvLyBjb2xvciBrZXl3b3JkcwoJCWNvbnN0IGhleCA9IF9jb2xvcktleXdvcmRzWyBzdHlsZS50b0xvd2VyQ2FzZSgpIF07CgoJCWlmICggaGV4ICE9PSB1bmRlZmluZWQgKSB7CgoJCQkvLyByZWQKCQkJdGhpcy5zZXRIZXgoIGhleCwgY29sb3JTcGFjZSApOwoKCQl9IGVsc2UgewoKCQkJLy8gdW5rbm93biBjb2xvcgoJCQljb25zb2xlLndhcm4oICdUSFJFRS5Db2xvcjogVW5rbm93biBjb2xvciAnICsgc3R5bGUgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvciggdGhpcy5yLCB0aGlzLmcsIHRoaXMuYiApOwoKCX0KCgljb3B5KCBjb2xvciApIHsKCgkJdGhpcy5yID0gY29sb3IucjsKCQl0aGlzLmcgPSBjb2xvci5nOwoJCXRoaXMuYiA9IGNvbG9yLmI7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb3B5U1JHQlRvTGluZWFyKCBjb2xvciApIHsKCgkJdGhpcy5yID0gU1JHQlRvTGluZWFyKCBjb2xvci5yICk7CgkJdGhpcy5nID0gU1JHQlRvTGluZWFyKCBjb2xvci5nICk7CgkJdGhpcy5iID0gU1JHQlRvTGluZWFyKCBjb2xvci5iICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb3B5TGluZWFyVG9TUkdCKCBjb2xvciApIHsKCgkJdGhpcy5yID0gTGluZWFyVG9TUkdCKCBjb2xvci5yICk7CgkJdGhpcy5nID0gTGluZWFyVG9TUkdCKCBjb2xvci5nICk7CgkJdGhpcy5iID0gTGluZWFyVG9TUkdCKCBjb2xvci5iICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb252ZXJ0U1JHQlRvTGluZWFyKCkgewoKCQl0aGlzLmNvcHlTUkdCVG9MaW5lYXIoIHRoaXMgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvbnZlcnRMaW5lYXJUb1NSR0IoKSB7CgoJCXRoaXMuY29weUxpbmVhclRvU1JHQiggdGhpcyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0SGV4KCBjb2xvclNwYWNlID0gU1JHQkNvbG9yU3BhY2UgKSB7CgoJCUNvbG9yTWFuYWdlbWVudC5mcm9tV29ya2luZ0NvbG9yU3BhY2UoIF9jb2xvci5jb3B5KCB0aGlzICksIGNvbG9yU3BhY2UgKTsKCgkJcmV0dXJuIE1hdGgucm91bmQoIGNsYW1wKCBfY29sb3IuciAqIDI1NSwgMCwgMjU1ICkgKSAqIDY1NTM2ICsgTWF0aC5yb3VuZCggY2xhbXAoIF9jb2xvci5nICogMjU1LCAwLCAyNTUgKSApICogMjU2ICsgTWF0aC5yb3VuZCggY2xhbXAoIF9jb2xvci5iICogMjU1LCAwLCAyNTUgKSApOwoKCX0KCglnZXRIZXhTdHJpbmcoIGNvbG9yU3BhY2UgPSBTUkdCQ29sb3JTcGFjZSApIHsKCgkJcmV0dXJuICggJzAwMDAwMCcgKyB0aGlzLmdldEhleCggY29sb3JTcGFjZSApLnRvU3RyaW5nKCAxNiApICkuc2xpY2UoIC0gNiApOwoKCX0KCglnZXRIU0woIHRhcmdldCwgY29sb3JTcGFjZSA9IENvbG9yTWFuYWdlbWVudC53b3JraW5nQ29sb3JTcGFjZSApIHsKCgkJLy8gaCxzLGwgcmFuZ2VzIGFyZSBpbiAwLjAgLSAxLjAKCgkJQ29sb3JNYW5hZ2VtZW50LmZyb21Xb3JraW5nQ29sb3JTcGFjZSggX2NvbG9yLmNvcHkoIHRoaXMgKSwgY29sb3JTcGFjZSApOwoKCQljb25zdCByID0gX2NvbG9yLnIsIGcgPSBfY29sb3IuZywgYiA9IF9jb2xvci5iOwoKCQljb25zdCBtYXggPSBNYXRoLm1heCggciwgZywgYiApOwoJCWNvbnN0IG1pbiA9IE1hdGgubWluKCByLCBnLCBiICk7CgoJCWxldCBodWUsIHNhdHVyYXRpb247CgkJY29uc3QgbGlnaHRuZXNzID0gKCBtaW4gKyBtYXggKSAvIDIuMDsKCgkJaWYgKCBtaW4gPT09IG1heCApIHsKCgkJCWh1ZSA9IDA7CgkJCXNhdHVyYXRpb24gPSAwOwoKCQl9IGVsc2UgewoKCQkJY29uc3QgZGVsdGEgPSBtYXggLSBtaW47CgoJCQlzYXR1cmF0aW9uID0gbGlnaHRuZXNzIDw9IDAuNSA/IGRlbHRhIC8gKCBtYXggKyBtaW4gKSA6IGRlbHRhIC8gKCAyIC0gbWF4IC0gbWluICk7CgoJCQlzd2l0Y2ggKCBtYXggKSB7CgoJCQkJY2FzZSByOiBodWUgPSAoIGcgLSBiICkgLyBkZWx0YSArICggZyA8IGIgPyA2IDogMCApOyBicmVhazsKCQkJCWNhc2UgZzogaHVlID0gKCBiIC0gciApIC8gZGVsdGEgKyAyOyBicmVhazsKCQkJCWNhc2UgYjogaHVlID0gKCByIC0gZyApIC8gZGVsdGEgKyA0OyBicmVhazsKCgkJCX0KCgkJCWh1ZSAvPSA2OwoKCQl9CgoJCXRhcmdldC5oID0gaHVlOwoJCXRhcmdldC5zID0gc2F0dXJhdGlvbjsKCQl0YXJnZXQubCA9IGxpZ2h0bmVzczsKCgkJcmV0dXJuIHRhcmdldDsKCgl9CgoJZ2V0UkdCKCB0YXJnZXQsIGNvbG9yU3BhY2UgPSBDb2xvck1hbmFnZW1lbnQud29ya2luZ0NvbG9yU3BhY2UgKSB7CgoJCUNvbG9yTWFuYWdlbWVudC5mcm9tV29ya2luZ0NvbG9yU3BhY2UoIF9jb2xvci5jb3B5KCB0aGlzICksIGNvbG9yU3BhY2UgKTsKCgkJdGFyZ2V0LnIgPSBfY29sb3IucjsKCQl0YXJnZXQuZyA9IF9jb2xvci5nOwoJCXRhcmdldC5iID0gX2NvbG9yLmI7CgoJCXJldHVybiB0YXJnZXQ7CgoJfQoKCWdldFN0eWxlKCBjb2xvclNwYWNlID0gU1JHQkNvbG9yU3BhY2UgKSB7CgoJCUNvbG9yTWFuYWdlbWVudC5mcm9tV29ya2luZ0NvbG9yU3BhY2UoIF9jb2xvci5jb3B5KCB0aGlzICksIGNvbG9yU3BhY2UgKTsKCgkJY29uc3QgciA9IF9jb2xvci5yLCBnID0gX2NvbG9yLmcsIGIgPSBfY29sb3IuYjsKCgkJaWYgKCBjb2xvclNwYWNlICE9PSBTUkdCQ29sb3JTcGFjZSApIHsKCgkJCS8vIFJlcXVpcmVzIENTUyBDb2xvciBNb2R1bGUgTGV2ZWwgNCAoaHR0cHM6Ly93d3cudzMub3JnL1RSL2Nzcy1jb2xvci00LykuCgkJCXJldHVybiBgY29sb3IoJHsgY29sb3JTcGFjZSB9ICR7IHIudG9GaXhlZCggMyApIH0gJHsgZy50b0ZpeGVkKCAzICkgfSAkeyBiLnRvRml4ZWQoIDMgKSB9KWA7CgoJCX0KCgkJcmV0dXJuIGByZ2IoJHsgTWF0aC5yb3VuZCggciAqIDI1NSApIH0sJHsgTWF0aC5yb3VuZCggZyAqIDI1NSApIH0sJHsgTWF0aC5yb3VuZCggYiAqIDI1NSApIH0pYDsKCgl9CgoJb2Zmc2V0SFNMKCBoLCBzLCBsICkgewoKCQl0aGlzLmdldEhTTCggX2hzbEEgKTsKCgkJcmV0dXJuIHRoaXMuc2V0SFNMKCBfaHNsQS5oICsgaCwgX2hzbEEucyArIHMsIF9oc2xBLmwgKyBsICk7CgoJfQoKCWFkZCggY29sb3IgKSB7CgoJCXRoaXMuciArPSBjb2xvci5yOwoJCXRoaXMuZyArPSBjb2xvci5nOwoJCXRoaXMuYiArPSBjb2xvci5iOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJYWRkQ29sb3JzKCBjb2xvcjEsIGNvbG9yMiApIHsKCgkJdGhpcy5yID0gY29sb3IxLnIgKyBjb2xvcjIucjsKCQl0aGlzLmcgPSBjb2xvcjEuZyArIGNvbG9yMi5nOwoJCXRoaXMuYiA9IGNvbG9yMS5iICsgY29sb3IyLmI7CgoJCXJldHVybiB0aGlzOwoKCX0KCglhZGRTY2FsYXIoIHMgKSB7CgoJCXRoaXMuciArPSBzOwoJCXRoaXMuZyArPSBzOwoJCXRoaXMuYiArPSBzOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3ViKCBjb2xvciApIHsKCgkJdGhpcy5yID0gTWF0aC5tYXgoIDAsIHRoaXMuciAtIGNvbG9yLnIgKTsKCQl0aGlzLmcgPSBNYXRoLm1heCggMCwgdGhpcy5nIC0gY29sb3IuZyApOwoJCXRoaXMuYiA9IE1hdGgubWF4KCAwLCB0aGlzLmIgLSBjb2xvci5iICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgltdWx0aXBseSggY29sb3IgKSB7CgoJCXRoaXMuciAqPSBjb2xvci5yOwoJCXRoaXMuZyAqPSBjb2xvci5nOwoJCXRoaXMuYiAqPSBjb2xvci5iOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbXVsdGlwbHlTY2FsYXIoIHMgKSB7CgoJCXRoaXMuciAqPSBzOwoJCXRoaXMuZyAqPSBzOwoJCXRoaXMuYiAqPSBzOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbGVycCggY29sb3IsIGFscGhhICkgewoKCQl0aGlzLnIgKz0gKCBjb2xvci5yIC0gdGhpcy5yICkgKiBhbHBoYTsKCQl0aGlzLmcgKz0gKCBjb2xvci5nIC0gdGhpcy5nICkgKiBhbHBoYTsKCQl0aGlzLmIgKz0gKCBjb2xvci5iIC0gdGhpcy5iICkgKiBhbHBoYTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWxlcnBDb2xvcnMoIGNvbG9yMSwgY29sb3IyLCBhbHBoYSApIHsKCgkJdGhpcy5yID0gY29sb3IxLnIgKyAoIGNvbG9yMi5yIC0gY29sb3IxLnIgKSAqIGFscGhhOwoJCXRoaXMuZyA9IGNvbG9yMS5nICsgKCBjb2xvcjIuZyAtIGNvbG9yMS5nICkgKiBhbHBoYTsKCQl0aGlzLmIgPSBjb2xvcjEuYiArICggY29sb3IyLmIgLSBjb2xvcjEuYiApICogYWxwaGE7CgoJCXJldHVybiB0aGlzOwoKCX0KCglsZXJwSFNMKCBjb2xvciwgYWxwaGEgKSB7CgoJCXRoaXMuZ2V0SFNMKCBfaHNsQSApOwoJCWNvbG9yLmdldEhTTCggX2hzbEIgKTsKCgkJY29uc3QgaCA9IGxlcnAoIF9oc2xBLmgsIF9oc2xCLmgsIGFscGhhICk7CgkJY29uc3QgcyA9IGxlcnAoIF9oc2xBLnMsIF9oc2xCLnMsIGFscGhhICk7CgkJY29uc3QgbCA9IGxlcnAoIF9oc2xBLmwsIF9oc2xCLmwsIGFscGhhICk7CgoJCXRoaXMuc2V0SFNMKCBoLCBzLCBsICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tVmVjdG9yMyggdiApIHsKCgkJdGhpcy5yID0gdi54OwoJCXRoaXMuZyA9IHYueTsKCQl0aGlzLmIgPSB2Lno7CgoJCXJldHVybiB0aGlzOwoKCX0KCglhcHBseU1hdHJpeDMoIG0gKSB7CgoJCWNvbnN0IHIgPSB0aGlzLnIsIGcgPSB0aGlzLmcsIGIgPSB0aGlzLmI7CgkJY29uc3QgZSA9IG0uZWxlbWVudHM7CgoJCXRoaXMuciA9IGVbIDAgXSAqIHIgKyBlWyAzIF0gKiBnICsgZVsgNiBdICogYjsKCQl0aGlzLmcgPSBlWyAxIF0gKiByICsgZVsgNCBdICogZyArIGVbIDcgXSAqIGI7CgkJdGhpcy5iID0gZVsgMiBdICogciArIGVbIDUgXSAqIGcgKyBlWyA4IF0gKiBiOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXF1YWxzKCBjICkgewoKCQlyZXR1cm4gKCBjLnIgPT09IHRoaXMuciApICYmICggYy5nID09PSB0aGlzLmcgKSAmJiAoIGMuYiA9PT0gdGhpcy5iICk7CgoJfQoKCWZyb21BcnJheSggYXJyYXksIG9mZnNldCA9IDAgKSB7CgoJCXRoaXMuciA9IGFycmF5WyBvZmZzZXQgXTsKCQl0aGlzLmcgPSBhcnJheVsgb2Zmc2V0ICsgMSBdOwoJCXRoaXMuYiA9IGFycmF5WyBvZmZzZXQgKyAyIF07CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0FycmF5KCBhcnJheSA9IFtdLCBvZmZzZXQgPSAwICkgewoKCQlhcnJheVsgb2Zmc2V0IF0gPSB0aGlzLnI7CgkJYXJyYXlbIG9mZnNldCArIDEgXSA9IHRoaXMuZzsKCQlhcnJheVsgb2Zmc2V0ICsgMiBdID0gdGhpcy5iOwoKCQlyZXR1cm4gYXJyYXk7CgoJfQoKCWZyb21CdWZmZXJBdHRyaWJ1dGUoIGF0dHJpYnV0ZSwgaW5kZXggKSB7CgoJCXRoaXMuciA9IGF0dHJpYnV0ZS5nZXRYKCBpbmRleCApOwoJCXRoaXMuZyA9IGF0dHJpYnV0ZS5nZXRZKCBpbmRleCApOwoJCXRoaXMuYiA9IGF0dHJpYnV0ZS5nZXRaKCBpbmRleCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCkgewoKCQlyZXR1cm4gdGhpcy5nZXRIZXgoKTsKCgl9CgoJKlsgU3ltYm9sLml0ZXJhdG9yIF0oKSB7CgoJCXlpZWxkIHRoaXMucjsKCQl5aWVsZCB0aGlzLmc7CgkJeWllbGQgdGhpcy5iOwoKCX0KCn0KCmNvbnN0IF9jb2xvciA9IC8qQF9fUFVSRV9fKi8gbmV3IENvbG9yKCk7CgpDb2xvci5OQU1FUyA9IF9jb2xvcktleXdvcmRzOwoKbGV0IF9tYXRlcmlhbElkID0gMDsKCmNsYXNzIE1hdGVyaWFsIGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyIHsKCgljb25zdHJ1Y3RvcigpIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc01hdGVyaWFsID0gdHJ1ZTsKCgkJT2JqZWN0LmRlZmluZVByb3BlcnR5KCB0aGlzLCAnaWQnLCB7IHZhbHVlOiBfbWF0ZXJpYWxJZCArKyB9ICk7CgoJCXRoaXMudXVpZCA9IGdlbmVyYXRlVVVJRCgpOwoKCQl0aGlzLm5hbWUgPSAnJzsKCQl0aGlzLnR5cGUgPSAnTWF0ZXJpYWwnOwoKCQl0aGlzLmJsZW5kaW5nID0gTm9ybWFsQmxlbmRpbmc7CgkJdGhpcy5zaWRlID0gRnJvbnRTaWRlOwoJCXRoaXMudmVydGV4Q29sb3JzID0gZmFsc2U7CgoJCXRoaXMub3BhY2l0eSA9IDE7CgkJdGhpcy50cmFuc3BhcmVudCA9IGZhbHNlOwoJCXRoaXMuYWxwaGFIYXNoID0gZmFsc2U7CgoJCXRoaXMuYmxlbmRTcmMgPSBTcmNBbHBoYUZhY3RvcjsKCQl0aGlzLmJsZW5kRHN0ID0gT25lTWludXNTcmNBbHBoYUZhY3RvcjsKCQl0aGlzLmJsZW5kRXF1YXRpb24gPSBBZGRFcXVhdGlvbjsKCQl0aGlzLmJsZW5kU3JjQWxwaGEgPSBudWxsOwoJCXRoaXMuYmxlbmREc3RBbHBoYSA9IG51bGw7CgkJdGhpcy5ibGVuZEVxdWF0aW9uQWxwaGEgPSBudWxsOwoJCXRoaXMuYmxlbmRDb2xvciA9IG5ldyBDb2xvciggMCwgMCwgMCApOwoJCXRoaXMuYmxlbmRBbHBoYSA9IDA7CgoJCXRoaXMuZGVwdGhGdW5jID0gTGVzc0VxdWFsRGVwdGg7CgkJdGhpcy5kZXB0aFRlc3QgPSB0cnVlOwoJCXRoaXMuZGVwdGhXcml0ZSA9IHRydWU7CgoJCXRoaXMuc3RlbmNpbFdyaXRlTWFzayA9IDB4ZmY7CgkJdGhpcy5zdGVuY2lsRnVuYyA9IEFsd2F5c1N0ZW5jaWxGdW5jOwoJCXRoaXMuc3RlbmNpbFJlZiA9IDA7CgkJdGhpcy5zdGVuY2lsRnVuY01hc2sgPSAweGZmOwoJCXRoaXMuc3RlbmNpbEZhaWwgPSBLZWVwU3RlbmNpbE9wOwoJCXRoaXMuc3RlbmNpbFpGYWlsID0gS2VlcFN0ZW5jaWxPcDsKCQl0aGlzLnN0ZW5jaWxaUGFzcyA9IEtlZXBTdGVuY2lsT3A7CgkJdGhpcy5zdGVuY2lsV3JpdGUgPSBmYWxzZTsKCgkJdGhpcy5jbGlwcGluZ1BsYW5lcyA9IG51bGw7CgkJdGhpcy5jbGlwSW50ZXJzZWN0aW9uID0gZmFsc2U7CgkJdGhpcy5jbGlwU2hhZG93cyA9IGZhbHNlOwoKCQl0aGlzLnNoYWRvd1NpZGUgPSBudWxsOwoKCQl0aGlzLmNvbG9yV3JpdGUgPSB0cnVlOwoKCQl0aGlzLnByZWNpc2lvbiA9IG51bGw7IC8vIG92ZXJyaWRlIHRoZSByZW5kZXJlcidzIGRlZmF1bHQgcHJlY2lzaW9uIGZvciB0aGlzIG1hdGVyaWFsCgoJCXRoaXMucG9seWdvbk9mZnNldCA9IGZhbHNlOwoJCXRoaXMucG9seWdvbk9mZnNldEZhY3RvciA9IDA7CgkJdGhpcy5wb2x5Z29uT2Zmc2V0VW5pdHMgPSAwOwoKCQl0aGlzLmRpdGhlcmluZyA9IGZhbHNlOwoKCQl0aGlzLmFscGhhVG9Db3ZlcmFnZSA9IGZhbHNlOwoJCXRoaXMucHJlbXVsdGlwbGllZEFscGhhID0gZmFsc2U7CgkJdGhpcy5mb3JjZVNpbmdsZVBhc3MgPSBmYWxzZTsKCgkJdGhpcy52aXNpYmxlID0gdHJ1ZTsKCgkJdGhpcy50b25lTWFwcGVkID0gdHJ1ZTsKCgkJdGhpcy51c2VyRGF0YSA9IHt9OwoKCQl0aGlzLnZlcnNpb24gPSAwOwoKCQl0aGlzLl9hbHBoYVRlc3QgPSAwOwoKCX0KCglnZXQgYWxwaGFUZXN0KCkgewoKCQlyZXR1cm4gdGhpcy5fYWxwaGFUZXN0OwoKCX0KCglzZXQgYWxwaGFUZXN0KCB2YWx1ZSApIHsKCgkJaWYgKCB0aGlzLl9hbHBoYVRlc3QgPiAwICE9PSB2YWx1ZSA+IDAgKSB7CgoJCQl0aGlzLnZlcnNpb24gKys7CgoJCX0KCgkJdGhpcy5fYWxwaGFUZXN0ID0gdmFsdWU7CgoJfQoKCW9uQnVpbGQoIC8qIHNoYWRlcm9iamVjdCwgcmVuZGVyZXIgKi8gKSB7fQoKCW9uQmVmb3JlUmVuZGVyKCAvKiByZW5kZXJlciwgc2NlbmUsIGNhbWVyYSwgZ2VvbWV0cnksIG9iamVjdCwgZ3JvdXAgKi8gKSB7fQoKCW9uQmVmb3JlQ29tcGlsZSggLyogc2hhZGVyb2JqZWN0LCByZW5kZXJlciAqLyApIHt9CgoJY3VzdG9tUHJvZ3JhbUNhY2hlS2V5KCkgewoKCQlyZXR1cm4gdGhpcy5vbkJlZm9yZUNvbXBpbGUudG9TdHJpbmcoKTsKCgl9CgoJc2V0VmFsdWVzKCB2YWx1ZXMgKSB7CgoJCWlmICggdmFsdWVzID09PSB1bmRlZmluZWQgKSByZXR1cm47CgoJCWZvciAoIGNvbnN0IGtleSBpbiB2YWx1ZXMgKSB7CgoJCQljb25zdCBuZXdWYWx1ZSA9IHZhbHVlc1sga2V5IF07CgoJCQlpZiAoIG5ld1ZhbHVlID09PSB1bmRlZmluZWQgKSB7CgoJCQkJY29uc29sZS53YXJuKCBgVEhSRUUuTWF0ZXJpYWw6IHBhcmFtZXRlciAnJHsga2V5IH0nIGhhcyB2YWx1ZSBvZiB1bmRlZmluZWQuYCApOwoJCQkJY29udGludWU7CgoJCQl9CgoJCQljb25zdCBjdXJyZW50VmFsdWUgPSB0aGlzWyBrZXkgXTsKCgkJCWlmICggY3VycmVudFZhbHVlID09PSB1bmRlZmluZWQgKSB7CgoJCQkJY29uc29sZS53YXJuKCBgVEhSRUUuTWF0ZXJpYWw6ICckeyBrZXkgfScgaXMgbm90IGEgcHJvcGVydHkgb2YgVEhSRUUuJHsgdGhpcy50eXBlIH0uYCApOwoJCQkJY29udGludWU7CgoJCQl9CgoJCQlpZiAoIGN1cnJlbnRWYWx1ZSAmJiBjdXJyZW50VmFsdWUuaXNDb2xvciApIHsKCgkJCQljdXJyZW50VmFsdWUuc2V0KCBuZXdWYWx1ZSApOwoKCQkJfSBlbHNlIGlmICggKCBjdXJyZW50VmFsdWUgJiYgY3VycmVudFZhbHVlLmlzVmVjdG9yMyApICYmICggbmV3VmFsdWUgJiYgbmV3VmFsdWUuaXNWZWN0b3IzICkgKSB7CgoJCQkJY3VycmVudFZhbHVlLmNvcHkoIG5ld1ZhbHVlICk7CgoJCQl9IGVsc2UgewoKCQkJCXRoaXNbIGtleSBdID0gbmV3VmFsdWU7CgoJCQl9CgoJCX0KCgl9CgoJdG9KU09OKCBtZXRhICkgewoKCQljb25zdCBpc1Jvb3RPYmplY3QgPSAoIG1ldGEgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2YgbWV0YSA9PT0gJ3N0cmluZycgKTsKCgkJaWYgKCBpc1Jvb3RPYmplY3QgKSB7CgoJCQltZXRhID0gewoJCQkJdGV4dHVyZXM6IHt9LAoJCQkJaW1hZ2VzOiB7fQoJCQl9OwoKCQl9CgoJCWNvbnN0IGRhdGEgPSB7CgkJCW1ldGFkYXRhOiB7CgkJCQl2ZXJzaW9uOiA0LjYsCgkJCQl0eXBlOiAnTWF0ZXJpYWwnLAoJCQkJZ2VuZXJhdG9yOiAnTWF0ZXJpYWwudG9KU09OJwoJCQl9CgkJfTsKCgkJLy8gc3RhbmRhcmQgTWF0ZXJpYWwgc2VyaWFsaXphdGlvbgoJCWRhdGEudXVpZCA9IHRoaXMudXVpZDsKCQlkYXRhLnR5cGUgPSB0aGlzLnR5cGU7CgoJCWlmICggdGhpcy5uYW1lICE9PSAnJyApIGRhdGEubmFtZSA9IHRoaXMubmFtZTsKCgkJaWYgKCB0aGlzLmNvbG9yICYmIHRoaXMuY29sb3IuaXNDb2xvciApIGRhdGEuY29sb3IgPSB0aGlzLmNvbG9yLmdldEhleCgpOwoKCQlpZiAoIHRoaXMucm91Z2huZXNzICE9PSB1bmRlZmluZWQgKSBkYXRhLnJvdWdobmVzcyA9IHRoaXMucm91Z2huZXNzOwoJCWlmICggdGhpcy5tZXRhbG5lc3MgIT09IHVuZGVmaW5lZCApIGRhdGEubWV0YWxuZXNzID0gdGhpcy5tZXRhbG5lc3M7CgoJCWlmICggdGhpcy5zaGVlbiAhPT0gdW5kZWZpbmVkICkgZGF0YS5zaGVlbiA9IHRoaXMuc2hlZW47CgkJaWYgKCB0aGlzLnNoZWVuQ29sb3IgJiYgdGhpcy5zaGVlbkNvbG9yLmlzQ29sb3IgKSBkYXRhLnNoZWVuQ29sb3IgPSB0aGlzLnNoZWVuQ29sb3IuZ2V0SGV4KCk7CgkJaWYgKCB0aGlzLnNoZWVuUm91Z2huZXNzICE9PSB1bmRlZmluZWQgKSBkYXRhLnNoZWVuUm91Z2huZXNzID0gdGhpcy5zaGVlblJvdWdobmVzczsKCQlpZiAoIHRoaXMuZW1pc3NpdmUgJiYgdGhpcy5lbWlzc2l2ZS5pc0NvbG9yICkgZGF0YS5lbWlzc2l2ZSA9IHRoaXMuZW1pc3NpdmUuZ2V0SGV4KCk7CgkJaWYgKCB0aGlzLmVtaXNzaXZlSW50ZW5zaXR5ICYmIHRoaXMuZW1pc3NpdmVJbnRlbnNpdHkgIT09IDEgKSBkYXRhLmVtaXNzaXZlSW50ZW5zaXR5ID0gdGhpcy5lbWlzc2l2ZUludGVuc2l0eTsKCgkJaWYgKCB0aGlzLnNwZWN1bGFyICYmIHRoaXMuc3BlY3VsYXIuaXNDb2xvciApIGRhdGEuc3BlY3VsYXIgPSB0aGlzLnNwZWN1bGFyLmdldEhleCgpOwoJCWlmICggdGhpcy5zcGVjdWxhckludGVuc2l0eSAhPT0gdW5kZWZpbmVkICkgZGF0YS5zcGVjdWxhckludGVuc2l0eSA9IHRoaXMuc3BlY3VsYXJJbnRlbnNpdHk7CgkJaWYgKCB0aGlzLnNwZWN1bGFyQ29sb3IgJiYgdGhpcy5zcGVjdWxhckNvbG9yLmlzQ29sb3IgKSBkYXRhLnNwZWN1bGFyQ29sb3IgPSB0aGlzLnNwZWN1bGFyQ29sb3IuZ2V0SGV4KCk7CgkJaWYgKCB0aGlzLnNoaW5pbmVzcyAhPT0gdW5kZWZpbmVkICkgZGF0YS5zaGluaW5lc3MgPSB0aGlzLnNoaW5pbmVzczsKCQlpZiAoIHRoaXMuY2xlYXJjb2F0ICE9PSB1bmRlZmluZWQgKSBkYXRhLmNsZWFyY29hdCA9IHRoaXMuY2xlYXJjb2F0OwoJCWlmICggdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3MgIT09IHVuZGVmaW5lZCApIGRhdGEuY2xlYXJjb2F0Um91Z2huZXNzID0gdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3M7CgoJCWlmICggdGhpcy5jbGVhcmNvYXRNYXAgJiYgdGhpcy5jbGVhcmNvYXRNYXAuaXNUZXh0dXJlICkgewoKCQkJZGF0YS5jbGVhcmNvYXRNYXAgPSB0aGlzLmNsZWFyY29hdE1hcC50b0pTT04oIG1ldGEgKS51dWlkOwoKCQl9CgoJCWlmICggdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3NNYXAgJiYgdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3NNYXAuaXNUZXh0dXJlICkgewoKCQkJZGF0YS5jbGVhcmNvYXRSb3VnaG5lc3NNYXAgPSB0aGlzLmNsZWFyY29hdFJvdWdobmVzc01hcC50b0pTT04oIG1ldGEgKS51dWlkOwoKCQl9CgoJCWlmICggdGhpcy5jbGVhcmNvYXROb3JtYWxNYXAgJiYgdGhpcy5jbGVhcmNvYXROb3JtYWxNYXAuaXNUZXh0dXJlICkgewoKCQkJZGF0YS5jbGVhcmNvYXROb3JtYWxNYXAgPSB0aGlzLmNsZWFyY29hdE5vcm1hbE1hcC50b0pTT04oIG1ldGEgKS51dWlkOwoJCQlkYXRhLmNsZWFyY29hdE5vcm1hbFNjYWxlID0gdGhpcy5jbGVhcmNvYXROb3JtYWxTY2FsZS50b0FycmF5KCk7CgoJCX0KCgkJaWYgKCB0aGlzLmlyaWRlc2NlbmNlICE9PSB1bmRlZmluZWQgKSBkYXRhLmlyaWRlc2NlbmNlID0gdGhpcy5pcmlkZXNjZW5jZTsKCQlpZiAoIHRoaXMuaXJpZGVzY2VuY2VJT1IgIT09IHVuZGVmaW5lZCApIGRhdGEuaXJpZGVzY2VuY2VJT1IgPSB0aGlzLmlyaWRlc2NlbmNlSU9SOwoJCWlmICggdGhpcy5pcmlkZXNjZW5jZVRoaWNrbmVzc1JhbmdlICE9PSB1bmRlZmluZWQgKSBkYXRhLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2UgPSB0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2U7CgoJCWlmICggdGhpcy5pcmlkZXNjZW5jZU1hcCAmJiB0aGlzLmlyaWRlc2NlbmNlTWFwLmlzVGV4dHVyZSApIHsKCgkJCWRhdGEuaXJpZGVzY2VuY2VNYXAgPSB0aGlzLmlyaWRlc2NlbmNlTWFwLnRvSlNPTiggbWV0YSApLnV1aWQ7CgoJCX0KCgkJaWYgKCB0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwICYmIHRoaXMuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAuaXNUZXh0dXJlICkgewoKCQkJZGF0YS5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCA9IHRoaXMuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAudG9KU09OKCBtZXRhICkudXVpZDsKCgkJfQoKCQlpZiAoIHRoaXMuYW5pc290cm9weSAhPT0gdW5kZWZpbmVkICkgZGF0YS5hbmlzb3Ryb3B5ID0gdGhpcy5hbmlzb3Ryb3B5OwoJCWlmICggdGhpcy5hbmlzb3Ryb3B5Um90YXRpb24gIT09IHVuZGVmaW5lZCApIGRhdGEuYW5pc290cm9weVJvdGF0aW9uID0gdGhpcy5hbmlzb3Ryb3B5Um90YXRpb247CgoJCWlmICggdGhpcy5hbmlzb3Ryb3B5TWFwICYmIHRoaXMuYW5pc290cm9weU1hcC5pc1RleHR1cmUgKSB7CgoJCQlkYXRhLmFuaXNvdHJvcHlNYXAgPSB0aGlzLmFuaXNvdHJvcHlNYXAudG9KU09OKCBtZXRhICkudXVpZDsKCgkJfQoKCQlpZiAoIHRoaXMubWFwICYmIHRoaXMubWFwLmlzVGV4dHVyZSApIGRhdGEubWFwID0gdGhpcy5tYXAudG9KU09OKCBtZXRhICkudXVpZDsKCQlpZiAoIHRoaXMubWF0Y2FwICYmIHRoaXMubWF0Y2FwLmlzVGV4dHVyZSApIGRhdGEubWF0Y2FwID0gdGhpcy5tYXRjYXAudG9KU09OKCBtZXRhICkudXVpZDsKCQlpZiAoIHRoaXMuYWxwaGFNYXAgJiYgdGhpcy5hbHBoYU1hcC5pc1RleHR1cmUgKSBkYXRhLmFscGhhTWFwID0gdGhpcy5hbHBoYU1hcC50b0pTT04oIG1ldGEgKS51dWlkOwoKCQlpZiAoIHRoaXMubGlnaHRNYXAgJiYgdGhpcy5saWdodE1hcC5pc1RleHR1cmUgKSB7CgoJCQlkYXRhLmxpZ2h0TWFwID0gdGhpcy5saWdodE1hcC50b0pTT04oIG1ldGEgKS51dWlkOwoJCQlkYXRhLmxpZ2h0TWFwSW50ZW5zaXR5ID0gdGhpcy5saWdodE1hcEludGVuc2l0eTsKCgkJfQoKCQlpZiAoIHRoaXMuYW9NYXAgJiYgdGhpcy5hb01hcC5pc1RleHR1cmUgKSB7CgoJCQlkYXRhLmFvTWFwID0gdGhpcy5hb01hcC50b0pTT04oIG1ldGEgKS51dWlkOwoJCQlkYXRhLmFvTWFwSW50ZW5zaXR5ID0gdGhpcy5hb01hcEludGVuc2l0eTsKCgkJfQoKCQlpZiAoIHRoaXMuYnVtcE1hcCAmJiB0aGlzLmJ1bXBNYXAuaXNUZXh0dXJlICkgewoKCQkJZGF0YS5idW1wTWFwID0gdGhpcy5idW1wTWFwLnRvSlNPTiggbWV0YSApLnV1aWQ7CgkJCWRhdGEuYnVtcFNjYWxlID0gdGhpcy5idW1wU2NhbGU7CgoJCX0KCgkJaWYgKCB0aGlzLm5vcm1hbE1hcCAmJiB0aGlzLm5vcm1hbE1hcC5pc1RleHR1cmUgKSB7CgoJCQlkYXRhLm5vcm1hbE1hcCA9IHRoaXMubm9ybWFsTWFwLnRvSlNPTiggbWV0YSApLnV1aWQ7CgkJCWRhdGEubm9ybWFsTWFwVHlwZSA9IHRoaXMubm9ybWFsTWFwVHlwZTsKCQkJZGF0YS5ub3JtYWxTY2FsZSA9IHRoaXMubm9ybWFsU2NhbGUudG9BcnJheSgpOwoKCQl9CgoJCWlmICggdGhpcy5kaXNwbGFjZW1lbnRNYXAgJiYgdGhpcy5kaXNwbGFjZW1lbnRNYXAuaXNUZXh0dXJlICkgewoKCQkJZGF0YS5kaXNwbGFjZW1lbnRNYXAgPSB0aGlzLmRpc3BsYWNlbWVudE1hcC50b0pTT04oIG1ldGEgKS51dWlkOwoJCQlkYXRhLmRpc3BsYWNlbWVudFNjYWxlID0gdGhpcy5kaXNwbGFjZW1lbnRTY2FsZTsKCQkJZGF0YS5kaXNwbGFjZW1lbnRCaWFzID0gdGhpcy5kaXNwbGFjZW1lbnRCaWFzOwoKCQl9CgoJCWlmICggdGhpcy5yb3VnaG5lc3NNYXAgJiYgdGhpcy5yb3VnaG5lc3NNYXAuaXNUZXh0dXJlICkgZGF0YS5yb3VnaG5lc3NNYXAgPSB0aGlzLnJvdWdobmVzc01hcC50b0pTT04oIG1ldGEgKS51dWlkOwoJCWlmICggdGhpcy5tZXRhbG5lc3NNYXAgJiYgdGhpcy5tZXRhbG5lc3NNYXAuaXNUZXh0dXJlICkgZGF0YS5tZXRhbG5lc3NNYXAgPSB0aGlzLm1ldGFsbmVzc01hcC50b0pTT04oIG1ldGEgKS51dWlkOwoKCQlpZiAoIHRoaXMuZW1pc3NpdmVNYXAgJiYgdGhpcy5lbWlzc2l2ZU1hcC5pc1RleHR1cmUgKSBkYXRhLmVtaXNzaXZlTWFwID0gdGhpcy5lbWlzc2l2ZU1hcC50b0pTT04oIG1ldGEgKS51dWlkOwoJCWlmICggdGhpcy5zcGVjdWxhck1hcCAmJiB0aGlzLnNwZWN1bGFyTWFwLmlzVGV4dHVyZSApIGRhdGEuc3BlY3VsYXJNYXAgPSB0aGlzLnNwZWN1bGFyTWFwLnRvSlNPTiggbWV0YSApLnV1aWQ7CgkJaWYgKCB0aGlzLnNwZWN1bGFySW50ZW5zaXR5TWFwICYmIHRoaXMuc3BlY3VsYXJJbnRlbnNpdHlNYXAuaXNUZXh0dXJlICkgZGF0YS5zcGVjdWxhckludGVuc2l0eU1hcCA9IHRoaXMuc3BlY3VsYXJJbnRlbnNpdHlNYXAudG9KU09OKCBtZXRhICkudXVpZDsKCQlpZiAoIHRoaXMuc3BlY3VsYXJDb2xvck1hcCAmJiB0aGlzLnNwZWN1bGFyQ29sb3JNYXAuaXNUZXh0dXJlICkgZGF0YS5zcGVjdWxhckNvbG9yTWFwID0gdGhpcy5zcGVjdWxhckNvbG9yTWFwLnRvSlNPTiggbWV0YSApLnV1aWQ7CgoJCWlmICggdGhpcy5lbnZNYXAgJiYgdGhpcy5lbnZNYXAuaXNUZXh0dXJlICkgewoKCQkJZGF0YS5lbnZNYXAgPSB0aGlzLmVudk1hcC50b0pTT04oIG1ldGEgKS51dWlkOwoKCQkJaWYgKCB0aGlzLmNvbWJpbmUgIT09IHVuZGVmaW5lZCApIGRhdGEuY29tYmluZSA9IHRoaXMuY29tYmluZTsKCgkJfQoKCQlpZiAoIHRoaXMuZW52TWFwSW50ZW5zaXR5ICE9PSB1bmRlZmluZWQgKSBkYXRhLmVudk1hcEludGVuc2l0eSA9IHRoaXMuZW52TWFwSW50ZW5zaXR5OwoJCWlmICggdGhpcy5yZWZsZWN0aXZpdHkgIT09IHVuZGVmaW5lZCApIGRhdGEucmVmbGVjdGl2aXR5ID0gdGhpcy5yZWZsZWN0aXZpdHk7CgkJaWYgKCB0aGlzLnJlZnJhY3Rpb25SYXRpbyAhPT0gdW5kZWZpbmVkICkgZGF0YS5yZWZyYWN0aW9uUmF0aW8gPSB0aGlzLnJlZnJhY3Rpb25SYXRpbzsKCgkJaWYgKCB0aGlzLmdyYWRpZW50TWFwICYmIHRoaXMuZ3JhZGllbnRNYXAuaXNUZXh0dXJlICkgewoKCQkJZGF0YS5ncmFkaWVudE1hcCA9IHRoaXMuZ3JhZGllbnRNYXAudG9KU09OKCBtZXRhICkudXVpZDsKCgkJfQoKCQlpZiAoIHRoaXMudHJhbnNtaXNzaW9uICE9PSB1bmRlZmluZWQgKSBkYXRhLnRyYW5zbWlzc2lvbiA9IHRoaXMudHJhbnNtaXNzaW9uOwoJCWlmICggdGhpcy50cmFuc21pc3Npb25NYXAgJiYgdGhpcy50cmFuc21pc3Npb25NYXAuaXNUZXh0dXJlICkgZGF0YS50cmFuc21pc3Npb25NYXAgPSB0aGlzLnRyYW5zbWlzc2lvbk1hcC50b0pTT04oIG1ldGEgKS51dWlkOwoJCWlmICggdGhpcy50aGlja25lc3MgIT09IHVuZGVmaW5lZCApIGRhdGEudGhpY2tuZXNzID0gdGhpcy50aGlja25lc3M7CgkJaWYgKCB0aGlzLnRoaWNrbmVzc01hcCAmJiB0aGlzLnRoaWNrbmVzc01hcC5pc1RleHR1cmUgKSBkYXRhLnRoaWNrbmVzc01hcCA9IHRoaXMudGhpY2tuZXNzTWFwLnRvSlNPTiggbWV0YSApLnV1aWQ7CgkJaWYgKCB0aGlzLmF0dGVudWF0aW9uRGlzdGFuY2UgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmF0dGVudWF0aW9uRGlzdGFuY2UgIT09IEluZmluaXR5ICkgZGF0YS5hdHRlbnVhdGlvbkRpc3RhbmNlID0gdGhpcy5hdHRlbnVhdGlvbkRpc3RhbmNlOwoJCWlmICggdGhpcy5hdHRlbnVhdGlvbkNvbG9yICE9PSB1bmRlZmluZWQgKSBkYXRhLmF0dGVudWF0aW9uQ29sb3IgPSB0aGlzLmF0dGVudWF0aW9uQ29sb3IuZ2V0SGV4KCk7CgoJCWlmICggdGhpcy5zaXplICE9PSB1bmRlZmluZWQgKSBkYXRhLnNpemUgPSB0aGlzLnNpemU7CgkJaWYgKCB0aGlzLnNoYWRvd1NpZGUgIT09IG51bGwgKSBkYXRhLnNoYWRvd1NpZGUgPSB0aGlzLnNoYWRvd1NpZGU7CgkJaWYgKCB0aGlzLnNpemVBdHRlbnVhdGlvbiAhPT0gdW5kZWZpbmVkICkgZGF0YS5zaXplQXR0ZW51YXRpb24gPSB0aGlzLnNpemVBdHRlbnVhdGlvbjsKCgkJaWYgKCB0aGlzLmJsZW5kaW5nICE9PSBOb3JtYWxCbGVuZGluZyApIGRhdGEuYmxlbmRpbmcgPSB0aGlzLmJsZW5kaW5nOwoJCWlmICggdGhpcy5zaWRlICE9PSBGcm9udFNpZGUgKSBkYXRhLnNpZGUgPSB0aGlzLnNpZGU7CgkJaWYgKCB0aGlzLnZlcnRleENvbG9ycyA9PT0gdHJ1ZSApIGRhdGEudmVydGV4Q29sb3JzID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLm9wYWNpdHkgPCAxICkgZGF0YS5vcGFjaXR5ID0gdGhpcy5vcGFjaXR5OwoJCWlmICggdGhpcy50cmFuc3BhcmVudCA9PT0gdHJ1ZSApIGRhdGEudHJhbnNwYXJlbnQgPSB0cnVlOwoKCQlpZiAoIHRoaXMuYmxlbmRTcmMgIT09IFNyY0FscGhhRmFjdG9yICkgZGF0YS5ibGVuZFNyYyA9IHRoaXMuYmxlbmRTcmM7CgkJaWYgKCB0aGlzLmJsZW5kRHN0ICE9PSBPbmVNaW51c1NyY0FscGhhRmFjdG9yICkgZGF0YS5ibGVuZERzdCA9IHRoaXMuYmxlbmREc3Q7CgkJaWYgKCB0aGlzLmJsZW5kRXF1YXRpb24gIT09IEFkZEVxdWF0aW9uICkgZGF0YS5ibGVuZEVxdWF0aW9uID0gdGhpcy5ibGVuZEVxdWF0aW9uOwoJCWlmICggdGhpcy5ibGVuZFNyY0FscGhhICE9PSBudWxsICkgZGF0YS5ibGVuZFNyY0FscGhhID0gdGhpcy5ibGVuZFNyY0FscGhhOwoJCWlmICggdGhpcy5ibGVuZERzdEFscGhhICE9PSBudWxsICkgZGF0YS5ibGVuZERzdEFscGhhID0gdGhpcy5ibGVuZERzdEFscGhhOwoJCWlmICggdGhpcy5ibGVuZEVxdWF0aW9uQWxwaGEgIT09IG51bGwgKSBkYXRhLmJsZW5kRXF1YXRpb25BbHBoYSA9IHRoaXMuYmxlbmRFcXVhdGlvbkFscGhhOwoJCWlmICggdGhpcy5ibGVuZENvbG9yICYmIHRoaXMuYmxlbmRDb2xvci5pc0NvbG9yICkgZGF0YS5ibGVuZENvbG9yID0gdGhpcy5ibGVuZENvbG9yLmdldEhleCgpOwoJCWlmICggdGhpcy5ibGVuZEFscGhhICE9PSAwICkgZGF0YS5ibGVuZEFscGhhID0gdGhpcy5ibGVuZEFscGhhOwoKCQlpZiAoIHRoaXMuZGVwdGhGdW5jICE9PSBMZXNzRXF1YWxEZXB0aCApIGRhdGEuZGVwdGhGdW5jID0gdGhpcy5kZXB0aEZ1bmM7CgkJaWYgKCB0aGlzLmRlcHRoVGVzdCA9PT0gZmFsc2UgKSBkYXRhLmRlcHRoVGVzdCA9IHRoaXMuZGVwdGhUZXN0OwoJCWlmICggdGhpcy5kZXB0aFdyaXRlID09PSBmYWxzZSApIGRhdGEuZGVwdGhXcml0ZSA9IHRoaXMuZGVwdGhXcml0ZTsKCQlpZiAoIHRoaXMuY29sb3JXcml0ZSA9PT0gZmFsc2UgKSBkYXRhLmNvbG9yV3JpdGUgPSB0aGlzLmNvbG9yV3JpdGU7CgoJCWlmICggdGhpcy5zdGVuY2lsV3JpdGVNYXNrICE9PSAweGZmICkgZGF0YS5zdGVuY2lsV3JpdGVNYXNrID0gdGhpcy5zdGVuY2lsV3JpdGVNYXNrOwoJCWlmICggdGhpcy5zdGVuY2lsRnVuYyAhPT0gQWx3YXlzU3RlbmNpbEZ1bmMgKSBkYXRhLnN0ZW5jaWxGdW5jID0gdGhpcy5zdGVuY2lsRnVuYzsKCQlpZiAoIHRoaXMuc3RlbmNpbFJlZiAhPT0gMCApIGRhdGEuc3RlbmNpbFJlZiA9IHRoaXMuc3RlbmNpbFJlZjsKCQlpZiAoIHRoaXMuc3RlbmNpbEZ1bmNNYXNrICE9PSAweGZmICkgZGF0YS5zdGVuY2lsRnVuY01hc2sgPSB0aGlzLnN0ZW5jaWxGdW5jTWFzazsKCQlpZiAoIHRoaXMuc3RlbmNpbEZhaWwgIT09IEtlZXBTdGVuY2lsT3AgKSBkYXRhLnN0ZW5jaWxGYWlsID0gdGhpcy5zdGVuY2lsRmFpbDsKCQlpZiAoIHRoaXMuc3RlbmNpbFpGYWlsICE9PSBLZWVwU3RlbmNpbE9wICkgZGF0YS5zdGVuY2lsWkZhaWwgPSB0aGlzLnN0ZW5jaWxaRmFpbDsKCQlpZiAoIHRoaXMuc3RlbmNpbFpQYXNzICE9PSBLZWVwU3RlbmNpbE9wICkgZGF0YS5zdGVuY2lsWlBhc3MgPSB0aGlzLnN0ZW5jaWxaUGFzczsKCQlpZiAoIHRoaXMuc3RlbmNpbFdyaXRlID09PSB0cnVlICkgZGF0YS5zdGVuY2lsV3JpdGUgPSB0aGlzLnN0ZW5jaWxXcml0ZTsKCgkJLy8gcm90YXRpb24gKFNwcml0ZU1hdGVyaWFsKQoJCWlmICggdGhpcy5yb3RhdGlvbiAhPT0gdW5kZWZpbmVkICYmIHRoaXMucm90YXRpb24gIT09IDAgKSBkYXRhLnJvdGF0aW9uID0gdGhpcy5yb3RhdGlvbjsKCgkJaWYgKCB0aGlzLnBvbHlnb25PZmZzZXQgPT09IHRydWUgKSBkYXRhLnBvbHlnb25PZmZzZXQgPSB0cnVlOwoJCWlmICggdGhpcy5wb2x5Z29uT2Zmc2V0RmFjdG9yICE9PSAwICkgZGF0YS5wb2x5Z29uT2Zmc2V0RmFjdG9yID0gdGhpcy5wb2x5Z29uT2Zmc2V0RmFjdG9yOwoJCWlmICggdGhpcy5wb2x5Z29uT2Zmc2V0VW5pdHMgIT09IDAgKSBkYXRhLnBvbHlnb25PZmZzZXRVbml0cyA9IHRoaXMucG9seWdvbk9mZnNldFVuaXRzOwoKCQlpZiAoIHRoaXMubGluZXdpZHRoICE9PSB1bmRlZmluZWQgJiYgdGhpcy5saW5ld2lkdGggIT09IDEgKSBkYXRhLmxpbmV3aWR0aCA9IHRoaXMubGluZXdpZHRoOwoJCWlmICggdGhpcy5kYXNoU2l6ZSAhPT0gdW5kZWZpbmVkICkgZGF0YS5kYXNoU2l6ZSA9IHRoaXMuZGFzaFNpemU7CgkJaWYgKCB0aGlzLmdhcFNpemUgIT09IHVuZGVmaW5lZCApIGRhdGEuZ2FwU2l6ZSA9IHRoaXMuZ2FwU2l6ZTsKCQlpZiAoIHRoaXMuc2NhbGUgIT09IHVuZGVmaW5lZCApIGRhdGEuc2NhbGUgPSB0aGlzLnNjYWxlOwoKCQlpZiAoIHRoaXMuZGl0aGVyaW5nID09PSB0cnVlICkgZGF0YS5kaXRoZXJpbmcgPSB0cnVlOwoKCQlpZiAoIHRoaXMuYWxwaGFUZXN0ID4gMCApIGRhdGEuYWxwaGFUZXN0ID0gdGhpcy5hbHBoYVRlc3Q7CgkJaWYgKCB0aGlzLmFscGhhSGFzaCA9PT0gdHJ1ZSApIGRhdGEuYWxwaGFIYXNoID0gdHJ1ZTsKCQlpZiAoIHRoaXMuYWxwaGFUb0NvdmVyYWdlID09PSB0cnVlICkgZGF0YS5hbHBoYVRvQ292ZXJhZ2UgPSB0cnVlOwoJCWlmICggdGhpcy5wcmVtdWx0aXBsaWVkQWxwaGEgPT09IHRydWUgKSBkYXRhLnByZW11bHRpcGxpZWRBbHBoYSA9IHRydWU7CgkJaWYgKCB0aGlzLmZvcmNlU2luZ2xlUGFzcyA9PT0gdHJ1ZSApIGRhdGEuZm9yY2VTaW5nbGVQYXNzID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLndpcmVmcmFtZSA9PT0gdHJ1ZSApIGRhdGEud2lyZWZyYW1lID0gdHJ1ZTsKCQlpZiAoIHRoaXMud2lyZWZyYW1lTGluZXdpZHRoID4gMSApIGRhdGEud2lyZWZyYW1lTGluZXdpZHRoID0gdGhpcy53aXJlZnJhbWVMaW5ld2lkdGg7CgkJaWYgKCB0aGlzLndpcmVmcmFtZUxpbmVjYXAgIT09ICdyb3VuZCcgKSBkYXRhLndpcmVmcmFtZUxpbmVjYXAgPSB0aGlzLndpcmVmcmFtZUxpbmVjYXA7CgkJaWYgKCB0aGlzLndpcmVmcmFtZUxpbmVqb2luICE9PSAncm91bmQnICkgZGF0YS53aXJlZnJhbWVMaW5lam9pbiA9IHRoaXMud2lyZWZyYW1lTGluZWpvaW47CgoJCWlmICggdGhpcy5mbGF0U2hhZGluZyA9PT0gdHJ1ZSApIGRhdGEuZmxhdFNoYWRpbmcgPSB0cnVlOwoKCQlpZiAoIHRoaXMudmlzaWJsZSA9PT0gZmFsc2UgKSBkYXRhLnZpc2libGUgPSBmYWxzZTsKCgkJaWYgKCB0aGlzLnRvbmVNYXBwZWQgPT09IGZhbHNlICkgZGF0YS50b25lTWFwcGVkID0gZmFsc2U7CgoJCWlmICggdGhpcy5mb2cgPT09IGZhbHNlICkgZGF0YS5mb2cgPSBmYWxzZTsKCgkJaWYgKCBPYmplY3Qua2V5cyggdGhpcy51c2VyRGF0YSApLmxlbmd0aCA+IDAgKSBkYXRhLnVzZXJEYXRhID0gdGhpcy51c2VyRGF0YTsKCgkJLy8gVE9ETzogQ29waWVkIGZyb20gT2JqZWN0M0QudG9KU09OCgoJCWZ1bmN0aW9uIGV4dHJhY3RGcm9tQ2FjaGUoIGNhY2hlICkgewoKCQkJY29uc3QgdmFsdWVzID0gW107CgoJCQlmb3IgKCBjb25zdCBrZXkgaW4gY2FjaGUgKSB7CgoJCQkJY29uc3QgZGF0YSA9IGNhY2hlWyBrZXkgXTsKCQkJCWRlbGV0ZSBkYXRhLm1ldGFkYXRhOwoJCQkJdmFsdWVzLnB1c2goIGRhdGEgKTsKCgkJCX0KCgkJCXJldHVybiB2YWx1ZXM7CgoJCX0KCgkJaWYgKCBpc1Jvb3RPYmplY3QgKSB7CgoJCQljb25zdCB0ZXh0dXJlcyA9IGV4dHJhY3RGcm9tQ2FjaGUoIG1ldGEudGV4dHVyZXMgKTsKCQkJY29uc3QgaW1hZ2VzID0gZXh0cmFjdEZyb21DYWNoZSggbWV0YS5pbWFnZXMgKTsKCgkJCWlmICggdGV4dHVyZXMubGVuZ3RoID4gMCApIGRhdGEudGV4dHVyZXMgPSB0ZXh0dXJlczsKCQkJaWYgKCBpbWFnZXMubGVuZ3RoID4gMCApIGRhdGEuaW1hZ2VzID0gaW1hZ2VzOwoKCQl9CgoJCXJldHVybiBkYXRhOwoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSggdGhpcyApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXRoaXMubmFtZSA9IHNvdXJjZS5uYW1lOwoKCQl0aGlzLmJsZW5kaW5nID0gc291cmNlLmJsZW5kaW5nOwoJCXRoaXMuc2lkZSA9IHNvdXJjZS5zaWRlOwoJCXRoaXMudmVydGV4Q29sb3JzID0gc291cmNlLnZlcnRleENvbG9yczsKCgkJdGhpcy5vcGFjaXR5ID0gc291cmNlLm9wYWNpdHk7CgkJdGhpcy50cmFuc3BhcmVudCA9IHNvdXJjZS50cmFuc3BhcmVudDsKCgkJdGhpcy5ibGVuZFNyYyA9IHNvdXJjZS5ibGVuZFNyYzsKCQl0aGlzLmJsZW5kRHN0ID0gc291cmNlLmJsZW5kRHN0OwoJCXRoaXMuYmxlbmRFcXVhdGlvbiA9IHNvdXJjZS5ibGVuZEVxdWF0aW9uOwoJCXRoaXMuYmxlbmRTcmNBbHBoYSA9IHNvdXJjZS5ibGVuZFNyY0FscGhhOwoJCXRoaXMuYmxlbmREc3RBbHBoYSA9IHNvdXJjZS5ibGVuZERzdEFscGhhOwoJCXRoaXMuYmxlbmRFcXVhdGlvbkFscGhhID0gc291cmNlLmJsZW5kRXF1YXRpb25BbHBoYTsKCQl0aGlzLmJsZW5kQ29sb3IuY29weSggc291cmNlLmJsZW5kQ29sb3IgKTsKCQl0aGlzLmJsZW5kQWxwaGEgPSBzb3VyY2UuYmxlbmRBbHBoYTsKCgkJdGhpcy5kZXB0aEZ1bmMgPSBzb3VyY2UuZGVwdGhGdW5jOwoJCXRoaXMuZGVwdGhUZXN0ID0gc291cmNlLmRlcHRoVGVzdDsKCQl0aGlzLmRlcHRoV3JpdGUgPSBzb3VyY2UuZGVwdGhXcml0ZTsKCgkJdGhpcy5zdGVuY2lsV3JpdGVNYXNrID0gc291cmNlLnN0ZW5jaWxXcml0ZU1hc2s7CgkJdGhpcy5zdGVuY2lsRnVuYyA9IHNvdXJjZS5zdGVuY2lsRnVuYzsKCQl0aGlzLnN0ZW5jaWxSZWYgPSBzb3VyY2Uuc3RlbmNpbFJlZjsKCQl0aGlzLnN0ZW5jaWxGdW5jTWFzayA9IHNvdXJjZS5zdGVuY2lsRnVuY01hc2s7CgkJdGhpcy5zdGVuY2lsRmFpbCA9IHNvdXJjZS5zdGVuY2lsRmFpbDsKCQl0aGlzLnN0ZW5jaWxaRmFpbCA9IHNvdXJjZS5zdGVuY2lsWkZhaWw7CgkJdGhpcy5zdGVuY2lsWlBhc3MgPSBzb3VyY2Uuc3RlbmNpbFpQYXNzOwoJCXRoaXMuc3RlbmNpbFdyaXRlID0gc291cmNlLnN0ZW5jaWxXcml0ZTsKCgkJY29uc3Qgc3JjUGxhbmVzID0gc291cmNlLmNsaXBwaW5nUGxhbmVzOwoJCWxldCBkc3RQbGFuZXMgPSBudWxsOwoKCQlpZiAoIHNyY1BsYW5lcyAhPT0gbnVsbCApIHsKCgkJCWNvbnN0IG4gPSBzcmNQbGFuZXMubGVuZ3RoOwoJCQlkc3RQbGFuZXMgPSBuZXcgQXJyYXkoIG4gKTsKCgkJCWZvciAoIGxldCBpID0gMDsgaSAhPT0gbjsgKysgaSApIHsKCgkJCQlkc3RQbGFuZXNbIGkgXSA9IHNyY1BsYW5lc1sgaSBdLmNsb25lKCk7CgoJCQl9CgoJCX0KCgkJdGhpcy5jbGlwcGluZ1BsYW5lcyA9IGRzdFBsYW5lczsKCQl0aGlzLmNsaXBJbnRlcnNlY3Rpb24gPSBzb3VyY2UuY2xpcEludGVyc2VjdGlvbjsKCQl0aGlzLmNsaXBTaGFkb3dzID0gc291cmNlLmNsaXBTaGFkb3dzOwoKCQl0aGlzLnNoYWRvd1NpZGUgPSBzb3VyY2Uuc2hhZG93U2lkZTsKCgkJdGhpcy5jb2xvcldyaXRlID0gc291cmNlLmNvbG9yV3JpdGU7CgoJCXRoaXMucHJlY2lzaW9uID0gc291cmNlLnByZWNpc2lvbjsKCgkJdGhpcy5wb2x5Z29uT2Zmc2V0ID0gc291cmNlLnBvbHlnb25PZmZzZXQ7CgkJdGhpcy5wb2x5Z29uT2Zmc2V0RmFjdG9yID0gc291cmNlLnBvbHlnb25PZmZzZXRGYWN0b3I7CgkJdGhpcy5wb2x5Z29uT2Zmc2V0VW5pdHMgPSBzb3VyY2UucG9seWdvbk9mZnNldFVuaXRzOwoKCQl0aGlzLmRpdGhlcmluZyA9IHNvdXJjZS5kaXRoZXJpbmc7CgoJCXRoaXMuYWxwaGFUZXN0ID0gc291cmNlLmFscGhhVGVzdDsKCQl0aGlzLmFscGhhSGFzaCA9IHNvdXJjZS5hbHBoYUhhc2g7CgkJdGhpcy5hbHBoYVRvQ292ZXJhZ2UgPSBzb3VyY2UuYWxwaGFUb0NvdmVyYWdlOwoJCXRoaXMucHJlbXVsdGlwbGllZEFscGhhID0gc291cmNlLnByZW11bHRpcGxpZWRBbHBoYTsKCQl0aGlzLmZvcmNlU2luZ2xlUGFzcyA9IHNvdXJjZS5mb3JjZVNpbmdsZVBhc3M7CgoJCXRoaXMudmlzaWJsZSA9IHNvdXJjZS52aXNpYmxlOwoKCQl0aGlzLnRvbmVNYXBwZWQgPSBzb3VyY2UudG9uZU1hcHBlZDsKCgkJdGhpcy51c2VyRGF0YSA9IEpTT04ucGFyc2UoIEpTT04uc3RyaW5naWZ5KCBzb3VyY2UudXNlckRhdGEgKSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZGlzcG9zZSgpIHsKCgkJdGhpcy5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICdkaXNwb3NlJyB9ICk7CgoJfQoKCXNldCBuZWVkc1VwZGF0ZSggdmFsdWUgKSB7CgoJCWlmICggdmFsdWUgPT09IHRydWUgKSB0aGlzLnZlcnNpb24gKys7CgoJfQoKfQoKY2xhc3MgTWVzaEJhc2ljTWF0ZXJpYWwgZXh0ZW5kcyBNYXRlcmlhbCB7CgoJY29uc3RydWN0b3IoIHBhcmFtZXRlcnMgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNNZXNoQmFzaWNNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdNZXNoQmFzaWNNYXRlcmlhbCc7CgoJCXRoaXMuY29sb3IgPSBuZXcgQ29sb3IoIDB4ZmZmZmZmICk7IC8vIGVtaXNzaXZlCgoJCXRoaXMubWFwID0gbnVsbDsKCgkJdGhpcy5saWdodE1hcCA9IG51bGw7CgkJdGhpcy5saWdodE1hcEludGVuc2l0eSA9IDEuMDsKCgkJdGhpcy5hb01hcCA9IG51bGw7CgkJdGhpcy5hb01hcEludGVuc2l0eSA9IDEuMDsKCgkJdGhpcy5zcGVjdWxhck1hcCA9IG51bGw7CgoJCXRoaXMuYWxwaGFNYXAgPSBudWxsOwoKCQl0aGlzLmVudk1hcCA9IG51bGw7CgkJdGhpcy5jb21iaW5lID0gTXVsdGlwbHlPcGVyYXRpb247CgkJdGhpcy5yZWZsZWN0aXZpdHkgPSAxOwoJCXRoaXMucmVmcmFjdGlvblJhdGlvID0gMC45ODsKCgkJdGhpcy53aXJlZnJhbWUgPSBmYWxzZTsKCQl0aGlzLndpcmVmcmFtZUxpbmV3aWR0aCA9IDE7CgkJdGhpcy53aXJlZnJhbWVMaW5lY2FwID0gJ3JvdW5kJzsKCQl0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gJ3JvdW5kJzsKCgkJdGhpcy5mb2cgPSB0cnVlOwoKCQl0aGlzLnNldFZhbHVlcyggcGFyYW1ldGVycyApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLmNvbG9yLmNvcHkoIHNvdXJjZS5jb2xvciApOwoKCQl0aGlzLm1hcCA9IHNvdXJjZS5tYXA7CgoJCXRoaXMubGlnaHRNYXAgPSBzb3VyY2UubGlnaHRNYXA7CgkJdGhpcy5saWdodE1hcEludGVuc2l0eSA9IHNvdXJjZS5saWdodE1hcEludGVuc2l0eTsKCgkJdGhpcy5hb01hcCA9IHNvdXJjZS5hb01hcDsKCQl0aGlzLmFvTWFwSW50ZW5zaXR5ID0gc291cmNlLmFvTWFwSW50ZW5zaXR5OwoKCQl0aGlzLnNwZWN1bGFyTWFwID0gc291cmNlLnNwZWN1bGFyTWFwOwoKCQl0aGlzLmFscGhhTWFwID0gc291cmNlLmFscGhhTWFwOwoKCQl0aGlzLmVudk1hcCA9IHNvdXJjZS5lbnZNYXA7CgkJdGhpcy5jb21iaW5lID0gc291cmNlLmNvbWJpbmU7CgkJdGhpcy5yZWZsZWN0aXZpdHkgPSBzb3VyY2UucmVmbGVjdGl2aXR5OwoJCXRoaXMucmVmcmFjdGlvblJhdGlvID0gc291cmNlLnJlZnJhY3Rpb25SYXRpbzsKCgkJdGhpcy53aXJlZnJhbWUgPSBzb3VyY2Uud2lyZWZyYW1lOwoJCXRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gc291cmNlLndpcmVmcmFtZUxpbmV3aWR0aDsKCQl0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSBzb3VyY2Uud2lyZWZyYW1lTGluZWNhcDsKCQl0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gc291cmNlLndpcmVmcmFtZUxpbmVqb2luOwoKCQl0aGlzLmZvZyA9IHNvdXJjZS5mb2c7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCi8vIEZhc3QgSGFsZiBGbG9hdCBDb252ZXJzaW9ucywgaHR0cDovL3d3dy5mb3gtdG9vbGtpdC5vcmcvZnRwL2Zhc3RoYWxmZmxvYXRjb252ZXJzaW9uLnBkZgoKY29uc3QgX3RhYmxlcyA9IC8qQF9fUFVSRV9fKi8gX2dlbmVyYXRlVGFibGVzKCk7CgpmdW5jdGlvbiBfZ2VuZXJhdGVUYWJsZXMoKSB7CgoJLy8gZmxvYXQzMiB0byBmbG9hdDE2IGhlbHBlcnMKCgljb25zdCBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoIDQgKTsKCWNvbnN0IGZsb2F0VmlldyA9IG5ldyBGbG9hdDMyQXJyYXkoIGJ1ZmZlciApOwoJY29uc3QgdWludDMyVmlldyA9IG5ldyBVaW50MzJBcnJheSggYnVmZmVyICk7CgoJY29uc3QgYmFzZVRhYmxlID0gbmV3IFVpbnQzMkFycmF5KCA1MTIgKTsKCWNvbnN0IHNoaWZ0VGFibGUgPSBuZXcgVWludDMyQXJyYXkoIDUxMiApOwoKCWZvciAoIGxldCBpID0gMDsgaSA8IDI1NjsgKysgaSApIHsKCgkJY29uc3QgZSA9IGkgLSAxMjc7CgoJCS8vIHZlcnkgc21hbGwgbnVtYmVyICgwLCAtMCkKCgkJaWYgKCBlIDwgLSAyNyApIHsKCgkJCWJhc2VUYWJsZVsgaSBdID0gMHgwMDAwOwoJCQliYXNlVGFibGVbIGkgfCAweDEwMCBdID0gMHg4MDAwOwoJCQlzaGlmdFRhYmxlWyBpIF0gPSAyNDsKCQkJc2hpZnRUYWJsZVsgaSB8IDB4MTAwIF0gPSAyNDsKCgkJCS8vIHNtYWxsIG51bWJlciAoZGVub3JtKQoKCQl9IGVsc2UgaWYgKCBlIDwgLSAxNCApIHsKCgkJCWJhc2VUYWJsZVsgaSBdID0gMHgwNDAwID4+ICggLSBlIC0gMTQgKTsKCQkJYmFzZVRhYmxlWyBpIHwgMHgxMDAgXSA9ICggMHgwNDAwID4+ICggLSBlIC0gMTQgKSApIHwgMHg4MDAwOwoJCQlzaGlmdFRhYmxlWyBpIF0gPSAtIGUgLSAxOwoJCQlzaGlmdFRhYmxlWyBpIHwgMHgxMDAgXSA9IC0gZSAtIDE7CgoJCQkvLyBub3JtYWwgbnVtYmVyCgoJCX0gZWxzZSBpZiAoIGUgPD0gMTUgKSB7CgoJCQliYXNlVGFibGVbIGkgXSA9ICggZSArIDE1ICkgPDwgMTA7CgkJCWJhc2VUYWJsZVsgaSB8IDB4MTAwIF0gPSAoICggZSArIDE1ICkgPDwgMTAgKSB8IDB4ODAwMDsKCQkJc2hpZnRUYWJsZVsgaSBdID0gMTM7CgkJCXNoaWZ0VGFibGVbIGkgfCAweDEwMCBdID0gMTM7CgoJCQkvLyBsYXJnZSBudW1iZXIgKEluZmluaXR5LCAtSW5maW5pdHkpCgoJCX0gZWxzZSBpZiAoIGUgPCAxMjggKSB7CgoJCQliYXNlVGFibGVbIGkgXSA9IDB4N2MwMDsKCQkJYmFzZVRhYmxlWyBpIHwgMHgxMDAgXSA9IDB4ZmMwMDsKCQkJc2hpZnRUYWJsZVsgaSBdID0gMjQ7CgkJCXNoaWZ0VGFibGVbIGkgfCAweDEwMCBdID0gMjQ7CgoJCQkvLyBzdGF5IChOYU4sIEluZmluaXR5LCAtSW5maW5pdHkpCgoJCX0gZWxzZSB7CgoJCQliYXNlVGFibGVbIGkgXSA9IDB4N2MwMDsKCQkJYmFzZVRhYmxlWyBpIHwgMHgxMDAgXSA9IDB4ZmMwMDsKCQkJc2hpZnRUYWJsZVsgaSBdID0gMTM7CgkJCXNoaWZ0VGFibGVbIGkgfCAweDEwMCBdID0gMTM7CgoJCX0KCgl9CgoJLy8gZmxvYXQxNiB0byBmbG9hdDMyIGhlbHBlcnMKCgljb25zdCBtYW50aXNzYVRhYmxlID0gbmV3IFVpbnQzMkFycmF5KCAyMDQ4ICk7Cgljb25zdCBleHBvbmVudFRhYmxlID0gbmV3IFVpbnQzMkFycmF5KCA2NCApOwoJY29uc3Qgb2Zmc2V0VGFibGUgPSBuZXcgVWludDMyQXJyYXkoIDY0ICk7CgoJZm9yICggbGV0IGkgPSAxOyBpIDwgMTAyNDsgKysgaSApIHsKCgkJbGV0IG0gPSBpIDw8IDEzOyAvLyB6ZXJvIHBhZCBtYW50aXNzYSBiaXRzCgkJbGV0IGUgPSAwOyAvLyB6ZXJvIGV4cG9uZW50CgoJCS8vIG5vcm1hbGl6ZWQKCQl3aGlsZSAoICggbSAmIDB4MDA4MDAwMDAgKSA9PT0gMCApIHsKCgkJCW0gPDw9IDE7CgkJCWUgLT0gMHgwMDgwMDAwMDsgLy8gZGVjcmVtZW50IGV4cG9uZW50CgoJCX0KCgkJbSAmPSB+IDB4MDA4MDAwMDA7IC8vIGNsZWFyIGxlYWRpbmcgMSBiaXQKCQllICs9IDB4Mzg4MDAwMDA7IC8vIGFkanVzdCBiaWFzCgoJCW1hbnRpc3NhVGFibGVbIGkgXSA9IG0gfCBlOwoKCX0KCglmb3IgKCBsZXQgaSA9IDEwMjQ7IGkgPCAyMDQ4OyArKyBpICkgewoKCQltYW50aXNzYVRhYmxlWyBpIF0gPSAweDM4MDAwMDAwICsgKCAoIGkgLSAxMDI0ICkgPDwgMTMgKTsKCgl9CgoJZm9yICggbGV0IGkgPSAxOyBpIDwgMzE7ICsrIGkgKSB7CgoJCWV4cG9uZW50VGFibGVbIGkgXSA9IGkgPDwgMjM7CgoJfQoKCWV4cG9uZW50VGFibGVbIDMxIF0gPSAweDQ3ODAwMDAwOwoJZXhwb25lbnRUYWJsZVsgMzIgXSA9IDB4ODAwMDAwMDA7CgoJZm9yICggbGV0IGkgPSAzMzsgaSA8IDYzOyArKyBpICkgewoKCQlleHBvbmVudFRhYmxlWyBpIF0gPSAweDgwMDAwMDAwICsgKCAoIGkgLSAzMiApIDw8IDIzICk7CgoJfQoKCWV4cG9uZW50VGFibGVbIDYzIF0gPSAweGM3ODAwMDAwOwoKCWZvciAoIGxldCBpID0gMTsgaSA8IDY0OyArKyBpICkgewoKCQlpZiAoIGkgIT09IDMyICkgewoKCQkJb2Zmc2V0VGFibGVbIGkgXSA9IDEwMjQ7CgoJCX0KCgl9CgoJcmV0dXJuIHsKCQlmbG9hdFZpZXc6IGZsb2F0VmlldywKCQl1aW50MzJWaWV3OiB1aW50MzJWaWV3LAoJCWJhc2VUYWJsZTogYmFzZVRhYmxlLAoJCXNoaWZ0VGFibGU6IHNoaWZ0VGFibGUsCgkJbWFudGlzc2FUYWJsZTogbWFudGlzc2FUYWJsZSwKCQlleHBvbmVudFRhYmxlOiBleHBvbmVudFRhYmxlLAoJCW9mZnNldFRhYmxlOiBvZmZzZXRUYWJsZQoJfTsKCn0KCi8vIGZsb2F0MzIgdG8gZmxvYXQxNgoKZnVuY3Rpb24gdG9IYWxmRmxvYXQoIHZhbCApIHsKCglpZiAoIE1hdGguYWJzKCB2YWwgKSA+IDY1NTA0ICkgY29uc29sZS53YXJuKCAnVEhSRUUuRGF0YVV0aWxzLnRvSGFsZkZsb2F0KCk6IFZhbHVlIG91dCBvZiByYW5nZS4nICk7CgoJdmFsID0gY2xhbXAoIHZhbCwgLSA2NTUwNCwgNjU1MDQgKTsKCglfdGFibGVzLmZsb2F0Vmlld1sgMCBdID0gdmFsOwoJY29uc3QgZiA9IF90YWJsZXMudWludDMyVmlld1sgMCBdOwoJY29uc3QgZSA9ICggZiA+PiAyMyApICYgMHgxZmY7CglyZXR1cm4gX3RhYmxlcy5iYXNlVGFibGVbIGUgXSArICggKCBmICYgMHgwMDdmZmZmZiApID4+IF90YWJsZXMuc2hpZnRUYWJsZVsgZSBdICk7Cgp9CgovLyBmbG9hdDE2IHRvIGZsb2F0MzIKCmZ1bmN0aW9uIGZyb21IYWxmRmxvYXQoIHZhbCApIHsKCgljb25zdCBtID0gdmFsID4+IDEwOwoJX3RhYmxlcy51aW50MzJWaWV3WyAwIF0gPSBfdGFibGVzLm1hbnRpc3NhVGFibGVbIF90YWJsZXMub2Zmc2V0VGFibGVbIG0gXSArICggdmFsICYgMHgzZmYgKSBdICsgX3RhYmxlcy5leHBvbmVudFRhYmxlWyBtIF07CglyZXR1cm4gX3RhYmxlcy5mbG9hdFZpZXdbIDAgXTsKCn0KCmNvbnN0IERhdGFVdGlscyA9IHsKCXRvSGFsZkZsb2F0OiB0b0hhbGZGbG9hdCwKCWZyb21IYWxmRmxvYXQ6IGZyb21IYWxmRmxvYXQsCn07Cgpjb25zdCBfdmVjdG9yJDkgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92ZWN0b3IyJDEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCk7CgpjbGFzcyBCdWZmZXJBdHRyaWJ1dGUgewoKCWNvbnN0cnVjdG9yKCBhcnJheSwgaXRlbVNpemUsIG5vcm1hbGl6ZWQgPSBmYWxzZSApIHsKCgkJaWYgKCBBcnJheS5pc0FycmF5KCBhcnJheSApICkgewoKCQkJdGhyb3cgbmV3IFR5cGVFcnJvciggJ1RIUkVFLkJ1ZmZlckF0dHJpYnV0ZTogYXJyYXkgc2hvdWxkIGJlIGEgVHlwZWQgQXJyYXkuJyApOwoKCQl9CgoJCXRoaXMuaXNCdWZmZXJBdHRyaWJ1dGUgPSB0cnVlOwoKCQl0aGlzLm5hbWUgPSAnJzsKCgkJdGhpcy5hcnJheSA9IGFycmF5OwoJCXRoaXMuaXRlbVNpemUgPSBpdGVtU2l6ZTsKCQl0aGlzLmNvdW50ID0gYXJyYXkgIT09IHVuZGVmaW5lZCA/IGFycmF5Lmxlbmd0aCAvIGl0ZW1TaXplIDogMDsKCQl0aGlzLm5vcm1hbGl6ZWQgPSBub3JtYWxpemVkOwoKCQl0aGlzLnVzYWdlID0gU3RhdGljRHJhd1VzYWdlOwoJCXRoaXMuX3VwZGF0ZVJhbmdlID0geyBvZmZzZXQ6IDAsIGNvdW50OiAtIDEgfTsKCQl0aGlzLnVwZGF0ZVJhbmdlcyA9IFtdOwoJCXRoaXMuZ3B1VHlwZSA9IEZsb2F0VHlwZTsKCgkJdGhpcy52ZXJzaW9uID0gMDsKCgl9CgoJb25VcGxvYWRDYWxsYmFjaygpIHt9CgoJc2V0IG5lZWRzVXBkYXRlKCB2YWx1ZSApIHsKCgkJaWYgKCB2YWx1ZSA9PT0gdHJ1ZSApIHRoaXMudmVyc2lvbiArKzsKCgl9CgoJZ2V0IHVwZGF0ZVJhbmdlKCkgewoKCQl3YXJuT25jZSggJ1RIUkVFLkJ1ZmZlckF0dHJpYnV0ZTogdXBkYXRlUmFuZ2UoKSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gcjE2OS4gVXNlIGFkZFVwZGF0ZVJhbmdlKCkgaW5zdGVhZC4nICk7IC8vIEBkZXByZWNhdGVkLCByMTU5CgkJcmV0dXJuIHRoaXMuX3VwZGF0ZVJhbmdlOwoKCX0KCglzZXRVc2FnZSggdmFsdWUgKSB7CgoJCXRoaXMudXNhZ2UgPSB2YWx1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFkZFVwZGF0ZVJhbmdlKCBzdGFydCwgY291bnQgKSB7CgoJCXRoaXMudXBkYXRlUmFuZ2VzLnB1c2goIHsgc3RhcnQsIGNvdW50IH0gKTsKCgl9CgoJY2xlYXJVcGRhdGVSYW5nZXMoKSB7CgoJCXRoaXMudXBkYXRlUmFuZ2VzLmxlbmd0aCA9IDA7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJdGhpcy5uYW1lID0gc291cmNlLm5hbWU7CgkJdGhpcy5hcnJheSA9IG5ldyBzb3VyY2UuYXJyYXkuY29uc3RydWN0b3IoIHNvdXJjZS5hcnJheSApOwoJCXRoaXMuaXRlbVNpemUgPSBzb3VyY2UuaXRlbVNpemU7CgkJdGhpcy5jb3VudCA9IHNvdXJjZS5jb3VudDsKCQl0aGlzLm5vcm1hbGl6ZWQgPSBzb3VyY2Uubm9ybWFsaXplZDsKCgkJdGhpcy51c2FnZSA9IHNvdXJjZS51c2FnZTsKCQl0aGlzLmdwdVR5cGUgPSBzb3VyY2UuZ3B1VHlwZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvcHlBdCggaW5kZXgxLCBhdHRyaWJ1dGUsIGluZGV4MiApIHsKCgkJaW5kZXgxICo9IHRoaXMuaXRlbVNpemU7CgkJaW5kZXgyICo9IGF0dHJpYnV0ZS5pdGVtU2l6ZTsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gdGhpcy5pdGVtU2l6ZTsgaSA8IGw7IGkgKysgKSB7CgoJCQl0aGlzLmFycmF5WyBpbmRleDEgKyBpIF0gPSBhdHRyaWJ1dGUuYXJyYXlbIGluZGV4MiArIGkgXTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY29weUFycmF5KCBhcnJheSApIHsKCgkJdGhpcy5hcnJheS5zZXQoIGFycmF5ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglhcHBseU1hdHJpeDMoIG0gKSB7CgoJCWlmICggdGhpcy5pdGVtU2l6ZSA9PT0gMiApIHsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IHRoaXMuY291bnQ7IGkgPCBsOyBpICsrICkgewoKCQkJCV92ZWN0b3IyJDEuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggdGhpcywgaSApOwoJCQkJX3ZlY3RvcjIkMS5hcHBseU1hdHJpeDMoIG0gKTsKCgkJCQl0aGlzLnNldFhZKCBpLCBfdmVjdG9yMiQxLngsIF92ZWN0b3IyJDEueSApOwoKCQkJfQoKCQl9IGVsc2UgaWYgKCB0aGlzLml0ZW1TaXplID09PSAzICkgewoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gdGhpcy5jb3VudDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJX3ZlY3RvciQ5LmZyb21CdWZmZXJBdHRyaWJ1dGUoIHRoaXMsIGkgKTsKCQkJCV92ZWN0b3IkOS5hcHBseU1hdHJpeDMoIG0gKTsKCgkJCQl0aGlzLnNldFhZWiggaSwgX3ZlY3RvciQ5LngsIF92ZWN0b3IkOS55LCBfdmVjdG9yJDkueiApOwoKCQkJfQoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglhcHBseU1hdHJpeDQoIG0gKSB7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IHRoaXMuY291bnQ7IGkgPCBsOyBpICsrICkgewoKCQkJX3ZlY3RvciQ5LmZyb21CdWZmZXJBdHRyaWJ1dGUoIHRoaXMsIGkgKTsKCgkJCV92ZWN0b3IkOS5hcHBseU1hdHJpeDQoIG0gKTsKCgkJCXRoaXMuc2V0WFlaKCBpLCBfdmVjdG9yJDkueCwgX3ZlY3RvciQ5LnksIF92ZWN0b3IkOS56ICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFwcGx5Tm9ybWFsTWF0cml4KCBtICkgewoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSB0aGlzLmNvdW50OyBpIDwgbDsgaSArKyApIHsKCgkJCV92ZWN0b3IkOS5mcm9tQnVmZmVyQXR0cmlidXRlKCB0aGlzLCBpICk7CgoJCQlfdmVjdG9yJDkuYXBwbHlOb3JtYWxNYXRyaXgoIG0gKTsKCgkJCXRoaXMuc2V0WFlaKCBpLCBfdmVjdG9yJDkueCwgX3ZlY3RvciQ5LnksIF92ZWN0b3IkOS56ICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRyYW5zZm9ybURpcmVjdGlvbiggbSApIHsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gdGhpcy5jb3VudDsgaSA8IGw7IGkgKysgKSB7CgoJCQlfdmVjdG9yJDkuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggdGhpcywgaSApOwoKCQkJX3ZlY3RvciQ5LnRyYW5zZm9ybURpcmVjdGlvbiggbSApOwoKCQkJdGhpcy5zZXRYWVooIGksIF92ZWN0b3IkOS54LCBfdmVjdG9yJDkueSwgX3ZlY3RvciQ5LnogKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0KCB2YWx1ZSwgb2Zmc2V0ID0gMCApIHsKCgkJLy8gTWF0Y2hpbmcgQnVmZmVyQXR0cmlidXRlIGNvbnN0cnVjdG9yLCBkbyBub3Qgbm9ybWFsaXplIHRoZSBhcnJheS4KCQl0aGlzLmFycmF5LnNldCggdmFsdWUsIG9mZnNldCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0Q29tcG9uZW50KCBpbmRleCwgY29tcG9uZW50ICkgewoKCQlsZXQgdmFsdWUgPSB0aGlzLmFycmF5WyBpbmRleCAqIHRoaXMuaXRlbVNpemUgKyBjb21wb25lbnQgXTsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB2YWx1ZSA9IGRlbm9ybWFsaXplKCB2YWx1ZSwgdGhpcy5hcnJheSApOwoKCQlyZXR1cm4gdmFsdWU7CgoJfQoKCXNldENvbXBvbmVudCggaW5kZXgsIGNvbXBvbmVudCwgdmFsdWUgKSB7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgdmFsdWUgPSBub3JtYWxpemUoIHZhbHVlLCB0aGlzLmFycmF5ICk7CgoJCXRoaXMuYXJyYXlbIGluZGV4ICogdGhpcy5pdGVtU2l6ZSArIGNvbXBvbmVudCBdID0gdmFsdWU7CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRYKCBpbmRleCApIHsKCgkJbGV0IHggPSB0aGlzLmFycmF5WyBpbmRleCAqIHRoaXMuaXRlbVNpemUgXTsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB4ID0gZGVub3JtYWxpemUoIHgsIHRoaXMuYXJyYXkgKTsKCgkJcmV0dXJuIHg7CgoJfQoKCXNldFgoIGluZGV4LCB4ICkgewoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHggPSBub3JtYWxpemUoIHgsIHRoaXMuYXJyYXkgKTsKCgkJdGhpcy5hcnJheVsgaW5kZXggKiB0aGlzLml0ZW1TaXplIF0gPSB4OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0WSggaW5kZXggKSB7CgoJCWxldCB5ID0gdGhpcy5hcnJheVsgaW5kZXggKiB0aGlzLml0ZW1TaXplICsgMSBdOwoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHkgPSBkZW5vcm1hbGl6ZSggeSwgdGhpcy5hcnJheSApOwoKCQlyZXR1cm4geTsKCgl9CgoJc2V0WSggaW5kZXgsIHkgKSB7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgeSA9IG5vcm1hbGl6ZSggeSwgdGhpcy5hcnJheSApOwoKCQl0aGlzLmFycmF5WyBpbmRleCAqIHRoaXMuaXRlbVNpemUgKyAxIF0gPSB5OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0WiggaW5kZXggKSB7CgoJCWxldCB6ID0gdGhpcy5hcnJheVsgaW5kZXggKiB0aGlzLml0ZW1TaXplICsgMiBdOwoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHogPSBkZW5vcm1hbGl6ZSggeiwgdGhpcy5hcnJheSApOwoKCQlyZXR1cm4gejsKCgl9CgoJc2V0WiggaW5kZXgsIHogKSB7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgeiA9IG5vcm1hbGl6ZSggeiwgdGhpcy5hcnJheSApOwoKCQl0aGlzLmFycmF5WyBpbmRleCAqIHRoaXMuaXRlbVNpemUgKyAyIF0gPSB6OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0VyggaW5kZXggKSB7CgoJCWxldCB3ID0gdGhpcy5hcnJheVsgaW5kZXggKiB0aGlzLml0ZW1TaXplICsgMyBdOwoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHcgPSBkZW5vcm1hbGl6ZSggdywgdGhpcy5hcnJheSApOwoKCQlyZXR1cm4gdzsKCgl9CgoJc2V0VyggaW5kZXgsIHcgKSB7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgdyA9IG5vcm1hbGl6ZSggdywgdGhpcy5hcnJheSApOwoKCQl0aGlzLmFycmF5WyBpbmRleCAqIHRoaXMuaXRlbVNpemUgKyAzIF0gPSB3OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0WFkoIGluZGV4LCB4LCB5ICkgewoKCQlpbmRleCAqPSB0aGlzLml0ZW1TaXplOwoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHsKCgkJCXggPSBub3JtYWxpemUoIHgsIHRoaXMuYXJyYXkgKTsKCQkJeSA9IG5vcm1hbGl6ZSggeSwgdGhpcy5hcnJheSApOwoKCQl9CgoJCXRoaXMuYXJyYXlbIGluZGV4ICsgMCBdID0geDsKCQl0aGlzLmFycmF5WyBpbmRleCArIDEgXSA9IHk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRYWVooIGluZGV4LCB4LCB5LCB6ICkgewoKCQlpbmRleCAqPSB0aGlzLml0ZW1TaXplOwoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHsKCgkJCXggPSBub3JtYWxpemUoIHgsIHRoaXMuYXJyYXkgKTsKCQkJeSA9IG5vcm1hbGl6ZSggeSwgdGhpcy5hcnJheSApOwoJCQl6ID0gbm9ybWFsaXplKCB6LCB0aGlzLmFycmF5ICk7CgoJCX0KCgkJdGhpcy5hcnJheVsgaW5kZXggKyAwIF0gPSB4OwoJCXRoaXMuYXJyYXlbIGluZGV4ICsgMSBdID0geTsKCQl0aGlzLmFycmF5WyBpbmRleCArIDIgXSA9IHo7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRYWVpXKCBpbmRleCwgeCwgeSwgeiwgdyApIHsKCgkJaW5kZXggKj0gdGhpcy5pdGVtU2l6ZTsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB7CgoJCQl4ID0gbm9ybWFsaXplKCB4LCB0aGlzLmFycmF5ICk7CgkJCXkgPSBub3JtYWxpemUoIHksIHRoaXMuYXJyYXkgKTsKCQkJeiA9IG5vcm1hbGl6ZSggeiwgdGhpcy5hcnJheSApOwoJCQl3ID0gbm9ybWFsaXplKCB3LCB0aGlzLmFycmF5ICk7CgoJCX0KCgkJdGhpcy5hcnJheVsgaW5kZXggKyAwIF0gPSB4OwoJCXRoaXMuYXJyYXlbIGluZGV4ICsgMSBdID0geTsKCQl0aGlzLmFycmF5WyBpbmRleCArIDIgXSA9IHo7CgkJdGhpcy5hcnJheVsgaW5kZXggKyAzIF0gPSB3OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJb25VcGxvYWQoIGNhbGxiYWNrICkgewoKCQl0aGlzLm9uVXBsb2FkQ2FsbGJhY2sgPSBjYWxsYmFjazsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoIHRoaXMuYXJyYXksIHRoaXMuaXRlbVNpemUgKS5jb3B5KCB0aGlzICk7CgoJfQoKCXRvSlNPTigpIHsKCgkJY29uc3QgZGF0YSA9IHsKCQkJaXRlbVNpemU6IHRoaXMuaXRlbVNpemUsCgkJCXR5cGU6IHRoaXMuYXJyYXkuY29uc3RydWN0b3IubmFtZSwKCQkJYXJyYXk6IEFycmF5LmZyb20oIHRoaXMuYXJyYXkgKSwKCQkJbm9ybWFsaXplZDogdGhpcy5ub3JtYWxpemVkCgkJfTsKCgkJaWYgKCB0aGlzLm5hbWUgIT09ICcnICkgZGF0YS5uYW1lID0gdGhpcy5uYW1lOwoJCWlmICggdGhpcy51c2FnZSAhPT0gU3RhdGljRHJhd1VzYWdlICkgZGF0YS51c2FnZSA9IHRoaXMudXNhZ2U7CgoJCXJldHVybiBkYXRhOwoKCX0KCn0KCi8vCgpjbGFzcyBJbnQ4QnVmZmVyQXR0cmlidXRlIGV4dGVuZHMgQnVmZmVyQXR0cmlidXRlIHsKCgljb25zdHJ1Y3RvciggYXJyYXksIGl0ZW1TaXplLCBub3JtYWxpemVkICkgewoKCQlzdXBlciggbmV3IEludDhBcnJheSggYXJyYXkgKSwgaXRlbVNpemUsIG5vcm1hbGl6ZWQgKTsKCgl9Cgp9CgpjbGFzcyBVaW50OEJ1ZmZlckF0dHJpYnV0ZSBleHRlbmRzIEJ1ZmZlckF0dHJpYnV0ZSB7CgoJY29uc3RydWN0b3IoIGFycmF5LCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApIHsKCgkJc3VwZXIoIG5ldyBVaW50OEFycmF5KCBhcnJheSApLCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApOwoKCX0KCn0KCmNsYXNzIFVpbnQ4Q2xhbXBlZEJ1ZmZlckF0dHJpYnV0ZSBleHRlbmRzIEJ1ZmZlckF0dHJpYnV0ZSB7CgoJY29uc3RydWN0b3IoIGFycmF5LCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApIHsKCgkJc3VwZXIoIG5ldyBVaW50OENsYW1wZWRBcnJheSggYXJyYXkgKSwgaXRlbVNpemUsIG5vcm1hbGl6ZWQgKTsKCgl9Cgp9CgpjbGFzcyBJbnQxNkJ1ZmZlckF0dHJpYnV0ZSBleHRlbmRzIEJ1ZmZlckF0dHJpYnV0ZSB7CgoJY29uc3RydWN0b3IoIGFycmF5LCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApIHsKCgkJc3VwZXIoIG5ldyBJbnQxNkFycmF5KCBhcnJheSApLCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApOwoKCX0KCn0KCmNsYXNzIFVpbnQxNkJ1ZmZlckF0dHJpYnV0ZSBleHRlbmRzIEJ1ZmZlckF0dHJpYnV0ZSB7CgoJY29uc3RydWN0b3IoIGFycmF5LCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApIHsKCgkJc3VwZXIoIG5ldyBVaW50MTZBcnJheSggYXJyYXkgKSwgaXRlbVNpemUsIG5vcm1hbGl6ZWQgKTsKCgl9Cgp9CgpjbGFzcyBJbnQzMkJ1ZmZlckF0dHJpYnV0ZSBleHRlbmRzIEJ1ZmZlckF0dHJpYnV0ZSB7CgoJY29uc3RydWN0b3IoIGFycmF5LCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApIHsKCgkJc3VwZXIoIG5ldyBJbnQzMkFycmF5KCBhcnJheSApLCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApOwoKCX0KCn0KCmNsYXNzIFVpbnQzMkJ1ZmZlckF0dHJpYnV0ZSBleHRlbmRzIEJ1ZmZlckF0dHJpYnV0ZSB7CgoJY29uc3RydWN0b3IoIGFycmF5LCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApIHsKCgkJc3VwZXIoIG5ldyBVaW50MzJBcnJheSggYXJyYXkgKSwgaXRlbVNpemUsIG5vcm1hbGl6ZWQgKTsKCgl9Cgp9CgpjbGFzcyBGbG9hdDE2QnVmZmVyQXR0cmlidXRlIGV4dGVuZHMgQnVmZmVyQXR0cmlidXRlIHsKCgljb25zdHJ1Y3RvciggYXJyYXksIGl0ZW1TaXplLCBub3JtYWxpemVkICkgewoKCQlzdXBlciggbmV3IFVpbnQxNkFycmF5KCBhcnJheSApLCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApOwoKCQl0aGlzLmlzRmxvYXQxNkJ1ZmZlckF0dHJpYnV0ZSA9IHRydWU7CgoJfQoKCWdldFgoIGluZGV4ICkgewoKCQlsZXQgeCA9IGZyb21IYWxmRmxvYXQoIHRoaXMuYXJyYXlbIGluZGV4ICogdGhpcy5pdGVtU2l6ZSBdICk7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgeCA9IGRlbm9ybWFsaXplKCB4LCB0aGlzLmFycmF5ICk7CgoJCXJldHVybiB4OwoKCX0KCglzZXRYKCBpbmRleCwgeCApIHsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB4ID0gbm9ybWFsaXplKCB4LCB0aGlzLmFycmF5ICk7CgoJCXRoaXMuYXJyYXlbIGluZGV4ICogdGhpcy5pdGVtU2l6ZSBdID0gdG9IYWxmRmxvYXQoIHggKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldFkoIGluZGV4ICkgewoKCQlsZXQgeSA9IGZyb21IYWxmRmxvYXQoIHRoaXMuYXJyYXlbIGluZGV4ICogdGhpcy5pdGVtU2l6ZSArIDEgXSApOwoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHkgPSBkZW5vcm1hbGl6ZSggeSwgdGhpcy5hcnJheSApOwoKCQlyZXR1cm4geTsKCgl9CgoJc2V0WSggaW5kZXgsIHkgKSB7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgeSA9IG5vcm1hbGl6ZSggeSwgdGhpcy5hcnJheSApOwoKCQl0aGlzLmFycmF5WyBpbmRleCAqIHRoaXMuaXRlbVNpemUgKyAxIF0gPSB0b0hhbGZGbG9hdCggeSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0WiggaW5kZXggKSB7CgoJCWxldCB6ID0gZnJvbUhhbGZGbG9hdCggdGhpcy5hcnJheVsgaW5kZXggKiB0aGlzLml0ZW1TaXplICsgMiBdICk7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgeiA9IGRlbm9ybWFsaXplKCB6LCB0aGlzLmFycmF5ICk7CgoJCXJldHVybiB6OwoKCX0KCglzZXRaKCBpbmRleCwgeiApIHsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB6ID0gbm9ybWFsaXplKCB6LCB0aGlzLmFycmF5ICk7CgoJCXRoaXMuYXJyYXlbIGluZGV4ICogdGhpcy5pdGVtU2l6ZSArIDIgXSA9IHRvSGFsZkZsb2F0KCB6ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRXKCBpbmRleCApIHsKCgkJbGV0IHcgPSBmcm9tSGFsZkZsb2F0KCB0aGlzLmFycmF5WyBpbmRleCAqIHRoaXMuaXRlbVNpemUgKyAzIF0gKTsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB3ID0gZGVub3JtYWxpemUoIHcsIHRoaXMuYXJyYXkgKTsKCgkJcmV0dXJuIHc7CgoJfQoKCXNldFcoIGluZGV4LCB3ICkgewoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHcgPSBub3JtYWxpemUoIHcsIHRoaXMuYXJyYXkgKTsKCgkJdGhpcy5hcnJheVsgaW5kZXggKiB0aGlzLml0ZW1TaXplICsgMyBdID0gdG9IYWxmRmxvYXQoIHcgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFhZKCBpbmRleCwgeCwgeSApIHsKCgkJaW5kZXggKj0gdGhpcy5pdGVtU2l6ZTsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB7CgoJCQl4ID0gbm9ybWFsaXplKCB4LCB0aGlzLmFycmF5ICk7CgkJCXkgPSBub3JtYWxpemUoIHksIHRoaXMuYXJyYXkgKTsKCgkJfQoKCQl0aGlzLmFycmF5WyBpbmRleCArIDAgXSA9IHRvSGFsZkZsb2F0KCB4ICk7CgkJdGhpcy5hcnJheVsgaW5kZXggKyAxIF0gPSB0b0hhbGZGbG9hdCggeSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0WFlaKCBpbmRleCwgeCwgeSwgeiApIHsKCgkJaW5kZXggKj0gdGhpcy5pdGVtU2l6ZTsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB7CgoJCQl4ID0gbm9ybWFsaXplKCB4LCB0aGlzLmFycmF5ICk7CgkJCXkgPSBub3JtYWxpemUoIHksIHRoaXMuYXJyYXkgKTsKCQkJeiA9IG5vcm1hbGl6ZSggeiwgdGhpcy5hcnJheSApOwoKCQl9CgoJCXRoaXMuYXJyYXlbIGluZGV4ICsgMCBdID0gdG9IYWxmRmxvYXQoIHggKTsKCQl0aGlzLmFycmF5WyBpbmRleCArIDEgXSA9IHRvSGFsZkZsb2F0KCB5ICk7CgkJdGhpcy5hcnJheVsgaW5kZXggKyAyIF0gPSB0b0hhbGZGbG9hdCggeiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0WFlaVyggaW5kZXgsIHgsIHksIHosIHcgKSB7CgoJCWluZGV4ICo9IHRoaXMuaXRlbVNpemU7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgewoKCQkJeCA9IG5vcm1hbGl6ZSggeCwgdGhpcy5hcnJheSApOwoJCQl5ID0gbm9ybWFsaXplKCB5LCB0aGlzLmFycmF5ICk7CgkJCXogPSBub3JtYWxpemUoIHosIHRoaXMuYXJyYXkgKTsKCQkJdyA9IG5vcm1hbGl6ZSggdywgdGhpcy5hcnJheSApOwoKCQl9CgoJCXRoaXMuYXJyYXlbIGluZGV4ICsgMCBdID0gdG9IYWxmRmxvYXQoIHggKTsKCQl0aGlzLmFycmF5WyBpbmRleCArIDEgXSA9IHRvSGFsZkZsb2F0KCB5ICk7CgkJdGhpcy5hcnJheVsgaW5kZXggKyAyIF0gPSB0b0hhbGZGbG9hdCggeiApOwoJCXRoaXMuYXJyYXlbIGluZGV4ICsgMyBdID0gdG9IYWxmRmxvYXQoIHcgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKCmNsYXNzIEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUgZXh0ZW5kcyBCdWZmZXJBdHRyaWJ1dGUgewoKCWNvbnN0cnVjdG9yKCBhcnJheSwgaXRlbVNpemUsIG5vcm1hbGl6ZWQgKSB7CgoJCXN1cGVyKCBuZXcgRmxvYXQzMkFycmF5KCBhcnJheSApLCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApOwoKCX0KCn0KCmNsYXNzIEZsb2F0NjRCdWZmZXJBdHRyaWJ1dGUgZXh0ZW5kcyBCdWZmZXJBdHRyaWJ1dGUgewoKCWNvbnN0cnVjdG9yKCBhcnJheSwgaXRlbVNpemUsIG5vcm1hbGl6ZWQgKSB7CgoJCXN1cGVyKCBuZXcgRmxvYXQ2NEFycmF5KCBhcnJheSApLCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApOwoKCX0KCn0KCmxldCBfaWQkMiA9IDA7Cgpjb25zdCBfbTEgPSAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXg0KCk7CmNvbnN0IF9vYmogPSAvKkBfX1BVUkVfXyovIG5ldyBPYmplY3QzRCgpOwpjb25zdCBfb2Zmc2V0ID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfYm94JDIgPSAvKkBfX1BVUkVfXyovIG5ldyBCb3gzKCk7CmNvbnN0IF9ib3hNb3JwaFRhcmdldHMgPSAvKkBfX1BVUkVfXyovIG5ldyBCb3gzKCk7CmNvbnN0IF92ZWN0b3IkOCA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNsYXNzIEJ1ZmZlckdlb21ldHJ5IGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyIHsKCgljb25zdHJ1Y3RvcigpIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc0J1ZmZlckdlb21ldHJ5ID0gdHJ1ZTsKCgkJT2JqZWN0LmRlZmluZVByb3BlcnR5KCB0aGlzLCAnaWQnLCB7IHZhbHVlOiBfaWQkMiArKyB9ICk7CgoJCXRoaXMudXVpZCA9IGdlbmVyYXRlVVVJRCgpOwoKCQl0aGlzLm5hbWUgPSAnJzsKCQl0aGlzLnR5cGUgPSAnQnVmZmVyR2VvbWV0cnknOwoKCQl0aGlzLmluZGV4ID0gbnVsbDsKCQl0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKCgkJdGhpcy5tb3JwaEF0dHJpYnV0ZXMgPSB7fTsKCQl0aGlzLm1vcnBoVGFyZ2V0c1JlbGF0aXZlID0gZmFsc2U7CgoJCXRoaXMuZ3JvdXBzID0gW107CgoJCXRoaXMuYm91bmRpbmdCb3ggPSBudWxsOwoJCXRoaXMuYm91bmRpbmdTcGhlcmUgPSBudWxsOwoKCQl0aGlzLmRyYXdSYW5nZSA9IHsgc3RhcnQ6IDAsIGNvdW50OiBJbmZpbml0eSB9OwoKCQl0aGlzLnVzZXJEYXRhID0ge307CgoJfQoKCWdldEluZGV4KCkgewoKCQlyZXR1cm4gdGhpcy5pbmRleDsKCgl9CgoJc2V0SW5kZXgoIGluZGV4ICkgewoKCQlpZiAoIEFycmF5LmlzQXJyYXkoIGluZGV4ICkgKSB7CgoJCQl0aGlzLmluZGV4ID0gbmV3ICggYXJyYXlOZWVkc1VpbnQzMiggaW5kZXggKSA/IFVpbnQzMkJ1ZmZlckF0dHJpYnV0ZSA6IFVpbnQxNkJ1ZmZlckF0dHJpYnV0ZSApKCBpbmRleCwgMSApOwoKCQl9IGVsc2UgewoKCQkJdGhpcy5pbmRleCA9IGluZGV4OwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRBdHRyaWJ1dGUoIG5hbWUgKSB7CgoJCXJldHVybiB0aGlzLmF0dHJpYnV0ZXNbIG5hbWUgXTsKCgl9CgoJc2V0QXR0cmlidXRlKCBuYW1lLCBhdHRyaWJ1dGUgKSB7CgoJCXRoaXMuYXR0cmlidXRlc1sgbmFtZSBdID0gYXR0cmlidXRlOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZGVsZXRlQXR0cmlidXRlKCBuYW1lICkgewoKCQlkZWxldGUgdGhpcy5hdHRyaWJ1dGVzWyBuYW1lIF07CgoJCXJldHVybiB0aGlzOwoKCX0KCgloYXNBdHRyaWJ1dGUoIG5hbWUgKSB7CgoJCXJldHVybiB0aGlzLmF0dHJpYnV0ZXNbIG5hbWUgXSAhPT0gdW5kZWZpbmVkOwoKCX0KCglhZGRHcm91cCggc3RhcnQsIGNvdW50LCBtYXRlcmlhbEluZGV4ID0gMCApIHsKCgkJdGhpcy5ncm91cHMucHVzaCggewoKCQkJc3RhcnQ6IHN0YXJ0LAoJCQljb3VudDogY291bnQsCgkJCW1hdGVyaWFsSW5kZXg6IG1hdGVyaWFsSW5kZXgKCgkJfSApOwoKCX0KCgljbGVhckdyb3VwcygpIHsKCgkJdGhpcy5ncm91cHMgPSBbXTsKCgl9CgoJc2V0RHJhd1JhbmdlKCBzdGFydCwgY291bnQgKSB7CgoJCXRoaXMuZHJhd1JhbmdlLnN0YXJ0ID0gc3RhcnQ7CgkJdGhpcy5kcmF3UmFuZ2UuY291bnQgPSBjb3VudDsKCgl9CgoJYXBwbHlNYXRyaXg0KCBtYXRyaXggKSB7CgoJCWNvbnN0IHBvc2l0aW9uID0gdGhpcy5hdHRyaWJ1dGVzLnBvc2l0aW9uOwoKCQlpZiAoIHBvc2l0aW9uICE9PSB1bmRlZmluZWQgKSB7CgoJCQlwb3NpdGlvbi5hcHBseU1hdHJpeDQoIG1hdHJpeCApOwoKCQkJcG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQl9CgoJCWNvbnN0IG5vcm1hbCA9IHRoaXMuYXR0cmlidXRlcy5ub3JtYWw7CgoJCWlmICggbm9ybWFsICE9PSB1bmRlZmluZWQgKSB7CgoJCQljb25zdCBub3JtYWxNYXRyaXggPSBuZXcgTWF0cml4MygpLmdldE5vcm1hbE1hdHJpeCggbWF0cml4ICk7CgoJCQlub3JtYWwuYXBwbHlOb3JtYWxNYXRyaXgoIG5vcm1hbE1hdHJpeCApOwoKCQkJbm9ybWFsLm5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJfQoKCQljb25zdCB0YW5nZW50ID0gdGhpcy5hdHRyaWJ1dGVzLnRhbmdlbnQ7CgoJCWlmICggdGFuZ2VudCAhPT0gdW5kZWZpbmVkICkgewoKCQkJdGFuZ2VudC50cmFuc2Zvcm1EaXJlY3Rpb24oIG1hdHJpeCApOwoKCQkJdGFuZ2VudC5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCX0KCgkJaWYgKCB0aGlzLmJvdW5kaW5nQm94ICE9PSBudWxsICkgewoKCQkJdGhpcy5jb21wdXRlQm91bmRpbmdCb3goKTsKCgkJfQoKCQlpZiAoIHRoaXMuYm91bmRpbmdTcGhlcmUgIT09IG51bGwgKSB7CgoJCQl0aGlzLmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglhcHBseVF1YXRlcm5pb24oIHEgKSB7CgoJCV9tMS5tYWtlUm90YXRpb25Gcm9tUXVhdGVybmlvbiggcSApOwoKCQl0aGlzLmFwcGx5TWF0cml4NCggX20xICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglyb3RhdGVYKCBhbmdsZSApIHsKCgkJLy8gcm90YXRlIGdlb21ldHJ5IGFyb3VuZCB3b3JsZCB4LWF4aXMKCgkJX20xLm1ha2VSb3RhdGlvblgoIGFuZ2xlICk7CgoJCXRoaXMuYXBwbHlNYXRyaXg0KCBfbTEgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJvdGF0ZVkoIGFuZ2xlICkgewoKCQkvLyByb3RhdGUgZ2VvbWV0cnkgYXJvdW5kIHdvcmxkIHktYXhpcwoKCQlfbTEubWFrZVJvdGF0aW9uWSggYW5nbGUgKTsKCgkJdGhpcy5hcHBseU1hdHJpeDQoIF9tMSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcm90YXRlWiggYW5nbGUgKSB7CgoJCS8vIHJvdGF0ZSBnZW9tZXRyeSBhcm91bmQgd29ybGQgei1heGlzCgoJCV9tMS5tYWtlUm90YXRpb25aKCBhbmdsZSApOwoKCQl0aGlzLmFwcGx5TWF0cml4NCggX20xICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0cmFuc2xhdGUoIHgsIHksIHogKSB7CgoJCS8vIHRyYW5zbGF0ZSBnZW9tZXRyeQoKCQlfbTEubWFrZVRyYW5zbGF0aW9uKCB4LCB5LCB6ICk7CgoJCXRoaXMuYXBwbHlNYXRyaXg0KCBfbTEgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNjYWxlKCB4LCB5LCB6ICkgewoKCQkvLyBzY2FsZSBnZW9tZXRyeQoKCQlfbTEubWFrZVNjYWxlKCB4LCB5LCB6ICk7CgoJCXRoaXMuYXBwbHlNYXRyaXg0KCBfbTEgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWxvb2tBdCggdmVjdG9yICkgewoKCQlfb2JqLmxvb2tBdCggdmVjdG9yICk7CgoJCV9vYmoudXBkYXRlTWF0cml4KCk7CgoJCXRoaXMuYXBwbHlNYXRyaXg0KCBfb2JqLm1hdHJpeCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2VudGVyKCkgewoKCQl0aGlzLmNvbXB1dGVCb3VuZGluZ0JveCgpOwoKCQl0aGlzLmJvdW5kaW5nQm94LmdldENlbnRlciggX29mZnNldCApLm5lZ2F0ZSgpOwoKCQl0aGlzLnRyYW5zbGF0ZSggX29mZnNldC54LCBfb2Zmc2V0LnksIF9vZmZzZXQueiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbVBvaW50cyggcG9pbnRzICkgewoKCQljb25zdCBwb3NpdGlvbiA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBwb2ludHMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWNvbnN0IHBvaW50ID0gcG9pbnRzWyBpIF07CgkJCXBvc2l0aW9uLnB1c2goIHBvaW50LngsIHBvaW50LnksIHBvaW50LnogfHwgMCApOwoKCQl9CgoJCXRoaXMuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb24sIDMgKSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY29tcHV0ZUJvdW5kaW5nQm94KCkgewoKCQlpZiAoIHRoaXMuYm91bmRpbmdCb3ggPT09IG51bGwgKSB7CgoJCQl0aGlzLmJvdW5kaW5nQm94ID0gbmV3IEJveDMoKTsKCgkJfQoKCQljb25zdCBwb3NpdGlvbiA9IHRoaXMuYXR0cmlidXRlcy5wb3NpdGlvbjsKCQljb25zdCBtb3JwaEF0dHJpYnV0ZXNQb3NpdGlvbiA9IHRoaXMubW9ycGhBdHRyaWJ1dGVzLnBvc2l0aW9uOwoKCQlpZiAoIHBvc2l0aW9uICYmIHBvc2l0aW9uLmlzR0xCdWZmZXJBdHRyaWJ1dGUgKSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuQnVmZmVyR2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nQm94KCk6IEdMQnVmZmVyQXR0cmlidXRlIHJlcXVpcmVzIGEgbWFudWFsIGJvdW5kaW5nIGJveC4gQWx0ZXJuYXRpdmVseSBzZXQgIm1lc2guZnJ1c3R1bUN1bGxlZCIgdG8gImZhbHNlIi4nLCB0aGlzICk7CgoJCQl0aGlzLmJvdW5kaW5nQm94LnNldCgKCQkJCW5ldyBWZWN0b3IzKCAtIEluZmluaXR5LCAtIEluZmluaXR5LCAtIEluZmluaXR5ICksCgkJCQluZXcgVmVjdG9yMyggKyBJbmZpbml0eSwgKyBJbmZpbml0eSwgKyBJbmZpbml0eSApCgkJCSk7CgoJCQlyZXR1cm47CgoJCX0KCgkJaWYgKCBwb3NpdGlvbiAhPT0gdW5kZWZpbmVkICkgewoKCQkJdGhpcy5ib3VuZGluZ0JveC5zZXRGcm9tQnVmZmVyQXR0cmlidXRlKCBwb3NpdGlvbiApOwoKCQkJLy8gcHJvY2VzcyBtb3JwaCBhdHRyaWJ1dGVzIGlmIHByZXNlbnQKCgkJCWlmICggbW9ycGhBdHRyaWJ1dGVzUG9zaXRpb24gKSB7CgoJCQkJZm9yICggbGV0IGkgPSAwLCBpbCA9IG1vcnBoQXR0cmlidXRlc1Bvc2l0aW9uLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCQljb25zdCBtb3JwaEF0dHJpYnV0ZSA9IG1vcnBoQXR0cmlidXRlc1Bvc2l0aW9uWyBpIF07CgkJCQkJX2JveCQyLnNldEZyb21CdWZmZXJBdHRyaWJ1dGUoIG1vcnBoQXR0cmlidXRlICk7CgoJCQkJCWlmICggdGhpcy5tb3JwaFRhcmdldHNSZWxhdGl2ZSApIHsKCgkJCQkJCV92ZWN0b3IkOC5hZGRWZWN0b3JzKCB0aGlzLmJvdW5kaW5nQm94Lm1pbiwgX2JveCQyLm1pbiApOwoJCQkJCQl0aGlzLmJvdW5kaW5nQm94LmV4cGFuZEJ5UG9pbnQoIF92ZWN0b3IkOCApOwoKCQkJCQkJX3ZlY3RvciQ4LmFkZFZlY3RvcnMoIHRoaXMuYm91bmRpbmdCb3gubWF4LCBfYm94JDIubWF4ICk7CgkJCQkJCXRoaXMuYm91bmRpbmdCb3guZXhwYW5kQnlQb2ludCggX3ZlY3RvciQ4ICk7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQl0aGlzLmJvdW5kaW5nQm94LmV4cGFuZEJ5UG9pbnQoIF9ib3gkMi5taW4gKTsKCQkJCQkJdGhpcy5ib3VuZGluZ0JveC5leHBhbmRCeVBvaW50KCBfYm94JDIubWF4ICk7CgoJCQkJCX0KCgkJCQl9CgoJCQl9CgoJCX0gZWxzZSB7CgoJCQl0aGlzLmJvdW5kaW5nQm94Lm1ha2VFbXB0eSgpOwoKCQl9CgoJCWlmICggaXNOYU4oIHRoaXMuYm91bmRpbmdCb3gubWluLnggKSB8fCBpc05hTiggdGhpcy5ib3VuZGluZ0JveC5taW4ueSApIHx8IGlzTmFOKCB0aGlzLmJvdW5kaW5nQm94Lm1pbi56ICkgKSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuQnVmZmVyR2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nQm94KCk6IENvbXB1dGVkIG1pbi9tYXggaGF2ZSBOYU4gdmFsdWVzLiBUaGUgInBvc2l0aW9uIiBhdHRyaWJ1dGUgaXMgbGlrZWx5IHRvIGhhdmUgTmFOIHZhbHVlcy4nLCB0aGlzICk7CgoJCX0KCgl9CgoJY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCkgewoKCQlpZiAoIHRoaXMuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgKSB7CgoJCQl0aGlzLmJvdW5kaW5nU3BoZXJlID0gbmV3IFNwaGVyZSgpOwoKCQl9CgoJCWNvbnN0IHBvc2l0aW9uID0gdGhpcy5hdHRyaWJ1dGVzLnBvc2l0aW9uOwoJCWNvbnN0IG1vcnBoQXR0cmlidXRlc1Bvc2l0aW9uID0gdGhpcy5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb247CgoJCWlmICggcG9zaXRpb24gJiYgcG9zaXRpb24uaXNHTEJ1ZmZlckF0dHJpYnV0ZSApIHsKCgkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5CdWZmZXJHZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTogR0xCdWZmZXJBdHRyaWJ1dGUgcmVxdWlyZXMgYSBtYW51YWwgYm91bmRpbmcgc3BoZXJlLiBBbHRlcm5hdGl2ZWx5IHNldCAibWVzaC5mcnVzdHVtQ3VsbGVkIiB0byAiZmFsc2UiLicsIHRoaXMgKTsKCgkJCXRoaXMuYm91bmRpbmdTcGhlcmUuc2V0KCBuZXcgVmVjdG9yMygpLCBJbmZpbml0eSApOwoKCQkJcmV0dXJuOwoKCQl9CgoJCWlmICggcG9zaXRpb24gKSB7CgoJCQkvLyBmaXJzdCwgZmluZCB0aGUgY2VudGVyIG9mIHRoZSBib3VuZGluZyBzcGhlcmUKCgkJCWNvbnN0IGNlbnRlciA9IHRoaXMuYm91bmRpbmdTcGhlcmUuY2VudGVyOwoKCQkJX2JveCQyLnNldEZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uICk7CgoJCQkvLyBwcm9jZXNzIG1vcnBoIGF0dHJpYnV0ZXMgaWYgcHJlc2VudAoKCQkJaWYgKCBtb3JwaEF0dHJpYnV0ZXNQb3NpdGlvbiApIHsKCgkJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gbW9ycGhBdHRyaWJ1dGVzUG9zaXRpb24ubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQkJCWNvbnN0IG1vcnBoQXR0cmlidXRlID0gbW9ycGhBdHRyaWJ1dGVzUG9zaXRpb25bIGkgXTsKCQkJCQlfYm94TW9ycGhUYXJnZXRzLnNldEZyb21CdWZmZXJBdHRyaWJ1dGUoIG1vcnBoQXR0cmlidXRlICk7CgoJCQkJCWlmICggdGhpcy5tb3JwaFRhcmdldHNSZWxhdGl2ZSApIHsKCgkJCQkJCV92ZWN0b3IkOC5hZGRWZWN0b3JzKCBfYm94JDIubWluLCBfYm94TW9ycGhUYXJnZXRzLm1pbiApOwoJCQkJCQlfYm94JDIuZXhwYW5kQnlQb2ludCggX3ZlY3RvciQ4ICk7CgoJCQkJCQlfdmVjdG9yJDguYWRkVmVjdG9ycyggX2JveCQyLm1heCwgX2JveE1vcnBoVGFyZ2V0cy5tYXggKTsKCQkJCQkJX2JveCQyLmV4cGFuZEJ5UG9pbnQoIF92ZWN0b3IkOCApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJX2JveCQyLmV4cGFuZEJ5UG9pbnQoIF9ib3hNb3JwaFRhcmdldHMubWluICk7CgkJCQkJCV9ib3gkMi5leHBhbmRCeVBvaW50KCBfYm94TW9ycGhUYXJnZXRzLm1heCApOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQkJX2JveCQyLmdldENlbnRlciggY2VudGVyICk7CgoJCQkvLyBzZWNvbmQsIHRyeSB0byBmaW5kIGEgYm91bmRpbmdTcGhlcmUgd2l0aCBhIHJhZGl1cyBzbWFsbGVyIHRoYW4gdGhlCgkJCS8vIGJvdW5kaW5nU3BoZXJlIG9mIHRoZSBib3VuZGluZ0JveDogc3FydCgzKSBzbWFsbGVyIGluIHRoZSBiZXN0IGNhc2UKCgkJCWxldCBtYXhSYWRpdXNTcSA9IDA7CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gcG9zaXRpb24uY291bnQ7IGkgPCBpbDsgaSArKyApIHsKCgkJCQlfdmVjdG9yJDguZnJvbUJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb24sIGkgKTsKCgkJCQltYXhSYWRpdXNTcSA9IE1hdGgubWF4KCBtYXhSYWRpdXNTcSwgY2VudGVyLmRpc3RhbmNlVG9TcXVhcmVkKCBfdmVjdG9yJDggKSApOwoKCQkJfQoKCQkJLy8gcHJvY2VzcyBtb3JwaCBhdHRyaWJ1dGVzIGlmIHByZXNlbnQKCgkJCWlmICggbW9ycGhBdHRyaWJ1dGVzUG9zaXRpb24gKSB7CgoJCQkJZm9yICggbGV0IGkgPSAwLCBpbCA9IG1vcnBoQXR0cmlidXRlc1Bvc2l0aW9uLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCQljb25zdCBtb3JwaEF0dHJpYnV0ZSA9IG1vcnBoQXR0cmlidXRlc1Bvc2l0aW9uWyBpIF07CgkJCQkJY29uc3QgbW9ycGhUYXJnZXRzUmVsYXRpdmUgPSB0aGlzLm1vcnBoVGFyZ2V0c1JlbGF0aXZlOwoKCQkJCQlmb3IgKCBsZXQgaiA9IDAsIGpsID0gbW9ycGhBdHRyaWJ1dGUuY291bnQ7IGogPCBqbDsgaiArKyApIHsKCgkJCQkJCV92ZWN0b3IkOC5mcm9tQnVmZmVyQXR0cmlidXRlKCBtb3JwaEF0dHJpYnV0ZSwgaiApOwoKCQkJCQkJaWYgKCBtb3JwaFRhcmdldHNSZWxhdGl2ZSApIHsKCgkJCQkJCQlfb2Zmc2V0LmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uLCBqICk7CgkJCQkJCQlfdmVjdG9yJDguYWRkKCBfb2Zmc2V0ICk7CgoJCQkJCQl9CgoJCQkJCQltYXhSYWRpdXNTcSA9IE1hdGgubWF4KCBtYXhSYWRpdXNTcSwgY2VudGVyLmRpc3RhbmNlVG9TcXVhcmVkKCBfdmVjdG9yJDggKSApOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQkJdGhpcy5ib3VuZGluZ1NwaGVyZS5yYWRpdXMgPSBNYXRoLnNxcnQoIG1heFJhZGl1c1NxICk7CgoJCQlpZiAoIGlzTmFOKCB0aGlzLmJvdW5kaW5nU3BoZXJlLnJhZGl1cyApICkgewoKCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5CdWZmZXJHZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTogQ29tcHV0ZWQgcmFkaXVzIGlzIE5hTi4gVGhlICJwb3NpdGlvbiIgYXR0cmlidXRlIGlzIGxpa2VseSB0byBoYXZlIE5hTiB2YWx1ZXMuJywgdGhpcyApOwoKCQkJfQoKCQl9CgoJfQoKCWNvbXB1dGVUYW5nZW50cygpIHsKCgkJY29uc3QgaW5kZXggPSB0aGlzLmluZGV4OwoJCWNvbnN0IGF0dHJpYnV0ZXMgPSB0aGlzLmF0dHJpYnV0ZXM7CgoJCS8vIGJhc2VkIG9uIGh0dHA6Ly93d3cudGVyYXRob24uY29tL2NvZGUvdGFuZ2VudC5odG1sCgkJLy8gKHBlciB2ZXJ0ZXggdGFuZ2VudHMpCgoJCWlmICggaW5kZXggPT09IG51bGwgfHwKCQkJIGF0dHJpYnV0ZXMucG9zaXRpb24gPT09IHVuZGVmaW5lZCB8fAoJCQkgYXR0cmlidXRlcy5ub3JtYWwgPT09IHVuZGVmaW5lZCB8fAoJCQkgYXR0cmlidXRlcy51diA9PT0gdW5kZWZpbmVkICkgewoKCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLkJ1ZmZlckdlb21ldHJ5OiAuY29tcHV0ZVRhbmdlbnRzKCkgZmFpbGVkLiBNaXNzaW5nIHJlcXVpcmVkIGF0dHJpYnV0ZXMgKGluZGV4LCBwb3NpdGlvbiwgbm9ybWFsIG9yIHV2KScgKTsKCQkJcmV0dXJuOwoKCQl9CgoJCWNvbnN0IGluZGljZXMgPSBpbmRleC5hcnJheTsKCQljb25zdCBwb3NpdGlvbnMgPSBhdHRyaWJ1dGVzLnBvc2l0aW9uLmFycmF5OwoJCWNvbnN0IG5vcm1hbHMgPSBhdHRyaWJ1dGVzLm5vcm1hbC5hcnJheTsKCQljb25zdCB1dnMgPSBhdHRyaWJ1dGVzLnV2LmFycmF5OwoKCQljb25zdCBuVmVydGljZXMgPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKCgkJaWYgKCB0aGlzLmhhc0F0dHJpYnV0ZSggJ3RhbmdlbnQnICkgPT09IGZhbHNlICkgewoKCQkJdGhpcy5zZXRBdHRyaWJ1dGUoICd0YW5nZW50JywgbmV3IEJ1ZmZlckF0dHJpYnV0ZSggbmV3IEZsb2F0MzJBcnJheSggNCAqIG5WZXJ0aWNlcyApLCA0ICkgKTsKCgkJfQoKCQljb25zdCB0YW5nZW50cyA9IHRoaXMuZ2V0QXR0cmlidXRlKCAndGFuZ2VudCcgKS5hcnJheTsKCgkJY29uc3QgdGFuMSA9IFtdLCB0YW4yID0gW107CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IG5WZXJ0aWNlczsgaSArKyApIHsKCgkJCXRhbjFbIGkgXSA9IG5ldyBWZWN0b3IzKCk7CgkJCXRhbjJbIGkgXSA9IG5ldyBWZWN0b3IzKCk7CgoJCX0KCgkJY29uc3QgdkEgPSBuZXcgVmVjdG9yMygpLAoJCQl2QiA9IG5ldyBWZWN0b3IzKCksCgkJCXZDID0gbmV3IFZlY3RvcjMoKSwKCgkJCXV2QSA9IG5ldyBWZWN0b3IyKCksCgkJCXV2QiA9IG5ldyBWZWN0b3IyKCksCgkJCXV2QyA9IG5ldyBWZWN0b3IyKCksCgoJCQlzZGlyID0gbmV3IFZlY3RvcjMoKSwKCQkJdGRpciA9IG5ldyBWZWN0b3IzKCk7CgoJCWZ1bmN0aW9uIGhhbmRsZVRyaWFuZ2xlKCBhLCBiLCBjICkgewoKCQkJdkEuZnJvbUFycmF5KCBwb3NpdGlvbnMsIGEgKiAzICk7CgkJCXZCLmZyb21BcnJheSggcG9zaXRpb25zLCBiICogMyApOwoJCQl2Qy5mcm9tQXJyYXkoIHBvc2l0aW9ucywgYyAqIDMgKTsKCgkJCXV2QS5mcm9tQXJyYXkoIHV2cywgYSAqIDIgKTsKCQkJdXZCLmZyb21BcnJheSggdXZzLCBiICogMiApOwoJCQl1dkMuZnJvbUFycmF5KCB1dnMsIGMgKiAyICk7CgoJCQl2Qi5zdWIoIHZBICk7CgkJCXZDLnN1YiggdkEgKTsKCgkJCXV2Qi5zdWIoIHV2QSApOwoJCQl1dkMuc3ViKCB1dkEgKTsKCgkJCWNvbnN0IHIgPSAxLjAgLyAoIHV2Qi54ICogdXZDLnkgLSB1dkMueCAqIHV2Qi55ICk7CgoJCQkvLyBzaWxlbnRseSBpZ25vcmUgZGVnZW5lcmF0ZSB1diB0cmlhbmdsZXMgaGF2aW5nIGNvaW5jaWRlbnQgb3IgY29saW5lYXIgdmVydGljZXMKCgkJCWlmICggISBpc0Zpbml0ZSggciApICkgcmV0dXJuOwoKCQkJc2Rpci5jb3B5KCB2QiApLm11bHRpcGx5U2NhbGFyKCB1dkMueSApLmFkZFNjYWxlZFZlY3RvciggdkMsIC0gdXZCLnkgKS5tdWx0aXBseVNjYWxhciggciApOwoJCQl0ZGlyLmNvcHkoIHZDICkubXVsdGlwbHlTY2FsYXIoIHV2Qi54ICkuYWRkU2NhbGVkVmVjdG9yKCB2QiwgLSB1dkMueCApLm11bHRpcGx5U2NhbGFyKCByICk7CgoJCQl0YW4xWyBhIF0uYWRkKCBzZGlyICk7CgkJCXRhbjFbIGIgXS5hZGQoIHNkaXIgKTsKCQkJdGFuMVsgYyBdLmFkZCggc2RpciApOwoKCQkJdGFuMlsgYSBdLmFkZCggdGRpciApOwoJCQl0YW4yWyBiIF0uYWRkKCB0ZGlyICk7CgkJCXRhbjJbIGMgXS5hZGQoIHRkaXIgKTsKCgkJfQoKCQlsZXQgZ3JvdXBzID0gdGhpcy5ncm91cHM7CgoJCWlmICggZ3JvdXBzLmxlbmd0aCA9PT0gMCApIHsKCgkJCWdyb3VwcyA9IFsgewoJCQkJc3RhcnQ6IDAsCgkJCQljb3VudDogaW5kaWNlcy5sZW5ndGgKCQkJfSBdOwoKCQl9CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSBncm91cHMubGVuZ3RoOyBpIDwgaWw7ICsrIGkgKSB7CgoJCQljb25zdCBncm91cCA9IGdyb3Vwc1sgaSBdOwoKCQkJY29uc3Qgc3RhcnQgPSBncm91cC5zdGFydDsKCQkJY29uc3QgY291bnQgPSBncm91cC5jb3VudDsKCgkJCWZvciAoIGxldCBqID0gc3RhcnQsIGpsID0gc3RhcnQgKyBjb3VudDsgaiA8IGpsOyBqICs9IDMgKSB7CgoJCQkJaGFuZGxlVHJpYW5nbGUoCgkJCQkJaW5kaWNlc1sgaiArIDAgXSwKCQkJCQlpbmRpY2VzWyBqICsgMSBdLAoJCQkJCWluZGljZXNbIGogKyAyIF0KCQkJCSk7CgoJCQl9CgoJCX0KCgkJY29uc3QgdG1wID0gbmV3IFZlY3RvcjMoKSwgdG1wMiA9IG5ldyBWZWN0b3IzKCk7CgkJY29uc3QgbiA9IG5ldyBWZWN0b3IzKCksIG4yID0gbmV3IFZlY3RvcjMoKTsKCgkJZnVuY3Rpb24gaGFuZGxlVmVydGV4KCB2ICkgewoKCQkJbi5mcm9tQXJyYXkoIG5vcm1hbHMsIHYgKiAzICk7CgkJCW4yLmNvcHkoIG4gKTsKCgkJCWNvbnN0IHQgPSB0YW4xWyB2IF07CgoJCQkvLyBHcmFtLVNjaG1pZHQgb3J0aG9nb25hbGl6ZQoKCQkJdG1wLmNvcHkoIHQgKTsKCQkJdG1wLnN1Yiggbi5tdWx0aXBseVNjYWxhciggbi5kb3QoIHQgKSApICkubm9ybWFsaXplKCk7CgoJCQkvLyBDYWxjdWxhdGUgaGFuZGVkbmVzcwoKCQkJdG1wMi5jcm9zc1ZlY3RvcnMoIG4yLCB0ICk7CgkJCWNvbnN0IHRlc3QgPSB0bXAyLmRvdCggdGFuMlsgdiBdICk7CgkJCWNvbnN0IHcgPSAoIHRlc3QgPCAwLjAgKSA/IC0gMS4wIDogMS4wOwoKCQkJdGFuZ2VudHNbIHYgKiA0IF0gPSB0bXAueDsKCQkJdGFuZ2VudHNbIHYgKiA0ICsgMSBdID0gdG1wLnk7CgkJCXRhbmdlbnRzWyB2ICogNCArIDIgXSA9IHRtcC56OwoJCQl0YW5nZW50c1sgdiAqIDQgKyAzIF0gPSB3OwoKCQl9CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSBncm91cHMubGVuZ3RoOyBpIDwgaWw7ICsrIGkgKSB7CgoJCQljb25zdCBncm91cCA9IGdyb3Vwc1sgaSBdOwoKCQkJY29uc3Qgc3RhcnQgPSBncm91cC5zdGFydDsKCQkJY29uc3QgY291bnQgPSBncm91cC5jb3VudDsKCgkJCWZvciAoIGxldCBqID0gc3RhcnQsIGpsID0gc3RhcnQgKyBjb3VudDsgaiA8IGpsOyBqICs9IDMgKSB7CgoJCQkJaGFuZGxlVmVydGV4KCBpbmRpY2VzWyBqICsgMCBdICk7CgkJCQloYW5kbGVWZXJ0ZXgoIGluZGljZXNbIGogKyAxIF0gKTsKCQkJCWhhbmRsZVZlcnRleCggaW5kaWNlc1sgaiArIDIgXSApOwoKCQkJfQoKCQl9CgoJfQoKCWNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCkgewoKCQljb25zdCBpbmRleCA9IHRoaXMuaW5kZXg7CgkJY29uc3QgcG9zaXRpb25BdHRyaWJ1dGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJyApOwoKCQlpZiAoIHBvc2l0aW9uQXR0cmlidXRlICE9PSB1bmRlZmluZWQgKSB7CgoJCQlsZXQgbm9ybWFsQXR0cmlidXRlID0gdGhpcy5nZXRBdHRyaWJ1dGUoICdub3JtYWwnICk7CgoJCQlpZiAoIG5vcm1hbEF0dHJpYnV0ZSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCW5vcm1hbEF0dHJpYnV0ZSA9IG5ldyBCdWZmZXJBdHRyaWJ1dGUoIG5ldyBGbG9hdDMyQXJyYXkoIHBvc2l0aW9uQXR0cmlidXRlLmNvdW50ICogMyApLCAzICk7CgkJCQl0aGlzLnNldEF0dHJpYnV0ZSggJ25vcm1hbCcsIG5vcm1hbEF0dHJpYnV0ZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvLyByZXNldCBleGlzdGluZyBub3JtYWxzIHRvIHplcm8KCgkJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gbm9ybWFsQXR0cmlidXRlLmNvdW50OyBpIDwgaWw7IGkgKysgKSB7CgoJCQkJCW5vcm1hbEF0dHJpYnV0ZS5zZXRYWVooIGksIDAsIDAsIDAgKTsKCgkJCQl9CgoJCQl9CgoJCQljb25zdCBwQSA9IG5ldyBWZWN0b3IzKCksIHBCID0gbmV3IFZlY3RvcjMoKSwgcEMgPSBuZXcgVmVjdG9yMygpOwoJCQljb25zdCBuQSA9IG5ldyBWZWN0b3IzKCksIG5CID0gbmV3IFZlY3RvcjMoKSwgbkMgPSBuZXcgVmVjdG9yMygpOwoJCQljb25zdCBjYiA9IG5ldyBWZWN0b3IzKCksIGFiID0gbmV3IFZlY3RvcjMoKTsKCgkJCS8vIGluZGV4ZWQgZWxlbWVudHMKCgkJCWlmICggaW5kZXggKSB7CgoJCQkJZm9yICggbGV0IGkgPSAwLCBpbCA9IGluZGV4LmNvdW50OyBpIDwgaWw7IGkgKz0gMyApIHsKCgkJCQkJY29uc3QgdkEgPSBpbmRleC5nZXRYKCBpICsgMCApOwoJCQkJCWNvbnN0IHZCID0gaW5kZXguZ2V0WCggaSArIDEgKTsKCQkJCQljb25zdCB2QyA9IGluZGV4LmdldFgoIGkgKyAyICk7CgoJCQkJCXBBLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCB2QSApOwoJCQkJCXBCLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCB2QiApOwoJCQkJCXBDLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCB2QyApOwoKCQkJCQljYi5zdWJWZWN0b3JzKCBwQywgcEIgKTsKCQkJCQlhYi5zdWJWZWN0b3JzKCBwQSwgcEIgKTsKCQkJCQljYi5jcm9zcyggYWIgKTsKCgkJCQkJbkEuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggbm9ybWFsQXR0cmlidXRlLCB2QSApOwoJCQkJCW5CLmZyb21CdWZmZXJBdHRyaWJ1dGUoIG5vcm1hbEF0dHJpYnV0ZSwgdkIgKTsKCQkJCQluQy5mcm9tQnVmZmVyQXR0cmlidXRlKCBub3JtYWxBdHRyaWJ1dGUsIHZDICk7CgoJCQkJCW5BLmFkZCggY2IgKTsKCQkJCQluQi5hZGQoIGNiICk7CgkJCQkJbkMuYWRkKCBjYiApOwoKCQkJCQlub3JtYWxBdHRyaWJ1dGUuc2V0WFlaKCB2QSwgbkEueCwgbkEueSwgbkEueiApOwoJCQkJCW5vcm1hbEF0dHJpYnV0ZS5zZXRYWVooIHZCLCBuQi54LCBuQi55LCBuQi56ICk7CgkJCQkJbm9ybWFsQXR0cmlidXRlLnNldFhZWiggdkMsIG5DLngsIG5DLnksIG5DLnogKTsKCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCS8vIG5vbi1pbmRleGVkIGVsZW1lbnRzICh1bmNvbm5lY3RlZCB0cmlhbmdsZSBzb3VwKQoKCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBwb3NpdGlvbkF0dHJpYnV0ZS5jb3VudDsgaSA8IGlsOyBpICs9IDMgKSB7CgoJCQkJCXBBLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCBpICsgMCApOwoJCQkJCXBCLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCBpICsgMSApOwoJCQkJCXBDLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCBpICsgMiApOwoKCQkJCQljYi5zdWJWZWN0b3JzKCBwQywgcEIgKTsKCQkJCQlhYi5zdWJWZWN0b3JzKCBwQSwgcEIgKTsKCQkJCQljYi5jcm9zcyggYWIgKTsKCgkJCQkJbm9ybWFsQXR0cmlidXRlLnNldFhZWiggaSArIDAsIGNiLngsIGNiLnksIGNiLnogKTsKCQkJCQlub3JtYWxBdHRyaWJ1dGUuc2V0WFlaKCBpICsgMSwgY2IueCwgY2IueSwgY2IueiApOwoJCQkJCW5vcm1hbEF0dHJpYnV0ZS5zZXRYWVooIGkgKyAyLCBjYi54LCBjYi55LCBjYi56ICk7CgoJCQkJfQoKCQkJfQoKCQkJdGhpcy5ub3JtYWxpemVOb3JtYWxzKCk7CgoJCQlub3JtYWxBdHRyaWJ1dGUubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQl9CgoJfQoKCW5vcm1hbGl6ZU5vcm1hbHMoKSB7CgoJCWNvbnN0IG5vcm1hbHMgPSB0aGlzLmF0dHJpYnV0ZXMubm9ybWFsOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gbm9ybWFscy5jb3VudDsgaSA8IGlsOyBpICsrICkgewoKCQkJX3ZlY3RvciQ4LmZyb21CdWZmZXJBdHRyaWJ1dGUoIG5vcm1hbHMsIGkgKTsKCgkJCV92ZWN0b3IkOC5ub3JtYWxpemUoKTsKCgkJCW5vcm1hbHMuc2V0WFlaKCBpLCBfdmVjdG9yJDgueCwgX3ZlY3RvciQ4LnksIF92ZWN0b3IkOC56ICk7CgoJCX0KCgl9CgoJdG9Ob25JbmRleGVkKCkgewoKCQlmdW5jdGlvbiBjb252ZXJ0QnVmZmVyQXR0cmlidXRlKCBhdHRyaWJ1dGUsIGluZGljZXMgKSB7CgoJCQljb25zdCBhcnJheSA9IGF0dHJpYnV0ZS5hcnJheTsKCQkJY29uc3QgaXRlbVNpemUgPSBhdHRyaWJ1dGUuaXRlbVNpemU7CgkJCWNvbnN0IG5vcm1hbGl6ZWQgPSBhdHRyaWJ1dGUubm9ybWFsaXplZDsKCgkJCWNvbnN0IGFycmF5MiA9IG5ldyBhcnJheS5jb25zdHJ1Y3RvciggaW5kaWNlcy5sZW5ndGggKiBpdGVtU2l6ZSApOwoKCQkJbGV0IGluZGV4ID0gMCwgaW5kZXgyID0gMDsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IGluZGljZXMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQlpZiAoIGF0dHJpYnV0ZS5pc0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlICkgewoKCQkJCQlpbmRleCA9IGluZGljZXNbIGkgXSAqIGF0dHJpYnV0ZS5kYXRhLnN0cmlkZSArIGF0dHJpYnV0ZS5vZmZzZXQ7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaW5kZXggPSBpbmRpY2VzWyBpIF0gKiBpdGVtU2l6ZTsKCgkJCQl9CgoJCQkJZm9yICggbGV0IGogPSAwOyBqIDwgaXRlbVNpemU7IGogKysgKSB7CgoJCQkJCWFycmF5MlsgaW5kZXgyICsrIF0gPSBhcnJheVsgaW5kZXggKysgXTsKCgkJCQl9CgoJCQl9CgoJCQlyZXR1cm4gbmV3IEJ1ZmZlckF0dHJpYnV0ZSggYXJyYXkyLCBpdGVtU2l6ZSwgbm9ybWFsaXplZCApOwoKCQl9CgoJCS8vCgoJCWlmICggdGhpcy5pbmRleCA9PT0gbnVsbCApIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLkJ1ZmZlckdlb21ldHJ5LnRvTm9uSW5kZXhlZCgpOiBCdWZmZXJHZW9tZXRyeSBpcyBhbHJlYWR5IG5vbi1pbmRleGVkLicgKTsKCQkJcmV0dXJuIHRoaXM7CgoJCX0KCgkJY29uc3QgZ2VvbWV0cnkyID0gbmV3IEJ1ZmZlckdlb21ldHJ5KCk7CgoJCWNvbnN0IGluZGljZXMgPSB0aGlzLmluZGV4LmFycmF5OwoJCWNvbnN0IGF0dHJpYnV0ZXMgPSB0aGlzLmF0dHJpYnV0ZXM7CgoJCS8vIGF0dHJpYnV0ZXMKCgkJZm9yICggY29uc3QgbmFtZSBpbiBhdHRyaWJ1dGVzICkgewoKCQkJY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlc1sgbmFtZSBdOwoKCQkJY29uc3QgbmV3QXR0cmlidXRlID0gY29udmVydEJ1ZmZlckF0dHJpYnV0ZSggYXR0cmlidXRlLCBpbmRpY2VzICk7CgoJCQlnZW9tZXRyeTIuc2V0QXR0cmlidXRlKCBuYW1lLCBuZXdBdHRyaWJ1dGUgKTsKCgkJfQoKCQkvLyBtb3JwaCBhdHRyaWJ1dGVzCgoJCWNvbnN0IG1vcnBoQXR0cmlidXRlcyA9IHRoaXMubW9ycGhBdHRyaWJ1dGVzOwoKCQlmb3IgKCBjb25zdCBuYW1lIGluIG1vcnBoQXR0cmlidXRlcyApIHsKCgkJCWNvbnN0IG1vcnBoQXJyYXkgPSBbXTsKCQkJY29uc3QgbW9ycGhBdHRyaWJ1dGUgPSBtb3JwaEF0dHJpYnV0ZXNbIG5hbWUgXTsgLy8gbW9ycGhBdHRyaWJ1dGU6IGFycmF5IG9mIEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGVzCgoJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gbW9ycGhBdHRyaWJ1dGUubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQkJY29uc3QgYXR0cmlidXRlID0gbW9ycGhBdHRyaWJ1dGVbIGkgXTsKCgkJCQljb25zdCBuZXdBdHRyaWJ1dGUgPSBjb252ZXJ0QnVmZmVyQXR0cmlidXRlKCBhdHRyaWJ1dGUsIGluZGljZXMgKTsKCgkJCQltb3JwaEFycmF5LnB1c2goIG5ld0F0dHJpYnV0ZSApOwoKCQkJfQoKCQkJZ2VvbWV0cnkyLm1vcnBoQXR0cmlidXRlc1sgbmFtZSBdID0gbW9ycGhBcnJheTsKCgkJfQoKCQlnZW9tZXRyeTIubW9ycGhUYXJnZXRzUmVsYXRpdmUgPSB0aGlzLm1vcnBoVGFyZ2V0c1JlbGF0aXZlOwoKCQkvLyBncm91cHMKCgkJY29uc3QgZ3JvdXBzID0gdGhpcy5ncm91cHM7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IGdyb3Vwcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgZ3JvdXAgPSBncm91cHNbIGkgXTsKCQkJZ2VvbWV0cnkyLmFkZEdyb3VwKCBncm91cC5zdGFydCwgZ3JvdXAuY291bnQsIGdyb3VwLm1hdGVyaWFsSW5kZXggKTsKCgkJfQoKCQlyZXR1cm4gZ2VvbWV0cnkyOwoKCX0KCgl0b0pTT04oKSB7CgoJCWNvbnN0IGRhdGEgPSB7CgkJCW1ldGFkYXRhOiB7CgkJCQl2ZXJzaW9uOiA0LjYsCgkJCQl0eXBlOiAnQnVmZmVyR2VvbWV0cnknLAoJCQkJZ2VuZXJhdG9yOiAnQnVmZmVyR2VvbWV0cnkudG9KU09OJwoJCQl9CgkJfTsKCgkJLy8gc3RhbmRhcmQgQnVmZmVyR2VvbWV0cnkgc2VyaWFsaXphdGlvbgoKCQlkYXRhLnV1aWQgPSB0aGlzLnV1aWQ7CgkJZGF0YS50eXBlID0gdGhpcy50eXBlOwoJCWlmICggdGhpcy5uYW1lICE9PSAnJyApIGRhdGEubmFtZSA9IHRoaXMubmFtZTsKCQlpZiAoIE9iamVjdC5rZXlzKCB0aGlzLnVzZXJEYXRhICkubGVuZ3RoID4gMCApIGRhdGEudXNlckRhdGEgPSB0aGlzLnVzZXJEYXRhOwoKCQlpZiAoIHRoaXMucGFyYW1ldGVycyAhPT0gdW5kZWZpbmVkICkgewoKCQkJY29uc3QgcGFyYW1ldGVycyA9IHRoaXMucGFyYW1ldGVyczsKCgkJCWZvciAoIGNvbnN0IGtleSBpbiBwYXJhbWV0ZXJzICkgewoKCQkJCWlmICggcGFyYW1ldGVyc1sga2V5IF0gIT09IHVuZGVmaW5lZCApIGRhdGFbIGtleSBdID0gcGFyYW1ldGVyc1sga2V5IF07CgoJCQl9CgoJCQlyZXR1cm4gZGF0YTsKCgkJfQoKCQkvLyBmb3Igc2ltcGxpY2l0eSB0aGUgY29kZSBhc3N1bWVzIGF0dHJpYnV0ZXMgYXJlIG5vdCBzaGFyZWQgYWNyb3NzIGdlb21ldHJpZXMsIHNlZSAjMTU4MTEKCgkJZGF0YS5kYXRhID0geyBhdHRyaWJ1dGVzOiB7fSB9OwoKCQljb25zdCBpbmRleCA9IHRoaXMuaW5kZXg7CgoJCWlmICggaW5kZXggIT09IG51bGwgKSB7CgoJCQlkYXRhLmRhdGEuaW5kZXggPSB7CgkJCQl0eXBlOiBpbmRleC5hcnJheS5jb25zdHJ1Y3Rvci5uYW1lLAoJCQkJYXJyYXk6IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBpbmRleC5hcnJheSApCgkJCX07CgoJCX0KCgkJY29uc3QgYXR0cmlidXRlcyA9IHRoaXMuYXR0cmlidXRlczsKCgkJZm9yICggY29uc3Qga2V5IGluIGF0dHJpYnV0ZXMgKSB7CgoJCQljb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzWyBrZXkgXTsKCgkJCWRhdGEuZGF0YS5hdHRyaWJ1dGVzWyBrZXkgXSA9IGF0dHJpYnV0ZS50b0pTT04oIGRhdGEuZGF0YSApOwoKCQl9CgoJCWNvbnN0IG1vcnBoQXR0cmlidXRlcyA9IHt9OwoJCWxldCBoYXNNb3JwaEF0dHJpYnV0ZXMgPSBmYWxzZTsKCgkJZm9yICggY29uc3Qga2V5IGluIHRoaXMubW9ycGhBdHRyaWJ1dGVzICkgewoKCQkJY29uc3QgYXR0cmlidXRlQXJyYXkgPSB0aGlzLm1vcnBoQXR0cmlidXRlc1sga2V5IF07CgoJCQljb25zdCBhcnJheSA9IFtdOwoKCQkJZm9yICggbGV0IGkgPSAwLCBpbCA9IGF0dHJpYnV0ZUFycmF5Lmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCWNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZUFycmF5WyBpIF07CgoJCQkJYXJyYXkucHVzaCggYXR0cmlidXRlLnRvSlNPTiggZGF0YS5kYXRhICkgKTsKCgkJCX0KCgkJCWlmICggYXJyYXkubGVuZ3RoID4gMCApIHsKCgkJCQltb3JwaEF0dHJpYnV0ZXNbIGtleSBdID0gYXJyYXk7CgoJCQkJaGFzTW9ycGhBdHRyaWJ1dGVzID0gdHJ1ZTsKCgkJCX0KCgkJfQoKCQlpZiAoIGhhc01vcnBoQXR0cmlidXRlcyApIHsKCgkJCWRhdGEuZGF0YS5tb3JwaEF0dHJpYnV0ZXMgPSBtb3JwaEF0dHJpYnV0ZXM7CgkJCWRhdGEuZGF0YS5tb3JwaFRhcmdldHNSZWxhdGl2ZSA9IHRoaXMubW9ycGhUYXJnZXRzUmVsYXRpdmU7CgoJCX0KCgkJY29uc3QgZ3JvdXBzID0gdGhpcy5ncm91cHM7CgoJCWlmICggZ3JvdXBzLmxlbmd0aCA+IDAgKSB7CgoJCQlkYXRhLmRhdGEuZ3JvdXBzID0gSlNPTi5wYXJzZSggSlNPTi5zdHJpbmdpZnkoIGdyb3VwcyApICk7CgoJCX0KCgkJY29uc3QgYm91bmRpbmdTcGhlcmUgPSB0aGlzLmJvdW5kaW5nU3BoZXJlOwoKCQlpZiAoIGJvdW5kaW5nU3BoZXJlICE9PSBudWxsICkgewoKCQkJZGF0YS5kYXRhLmJvdW5kaW5nU3BoZXJlID0gewoJCQkJY2VudGVyOiBib3VuZGluZ1NwaGVyZS5jZW50ZXIudG9BcnJheSgpLAoJCQkJcmFkaXVzOiBib3VuZGluZ1NwaGVyZS5yYWRpdXMKCQkJfTsKCgkJfQoKCQlyZXR1cm4gZGF0YTsKCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkoIHRoaXMgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQkvLyByZXNldAoKCQl0aGlzLmluZGV4ID0gbnVsbDsKCQl0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKCQl0aGlzLm1vcnBoQXR0cmlidXRlcyA9IHt9OwoJCXRoaXMuZ3JvdXBzID0gW107CgkJdGhpcy5ib3VuZGluZ0JveCA9IG51bGw7CgkJdGhpcy5ib3VuZGluZ1NwaGVyZSA9IG51bGw7CgoJCS8vIHVzZWQgZm9yIHN0b3JpbmcgY2xvbmVkLCBzaGFyZWQgZGF0YQoKCQljb25zdCBkYXRhID0ge307CgoJCS8vIG5hbWUKCgkJdGhpcy5uYW1lID0gc291cmNlLm5hbWU7CgoJCS8vIGluZGV4CgoJCWNvbnN0IGluZGV4ID0gc291cmNlLmluZGV4OwoKCQlpZiAoIGluZGV4ICE9PSBudWxsICkgewoKCQkJdGhpcy5zZXRJbmRleCggaW5kZXguY2xvbmUoIGRhdGEgKSApOwoKCQl9CgoJCS8vIGF0dHJpYnV0ZXMKCgkJY29uc3QgYXR0cmlidXRlcyA9IHNvdXJjZS5hdHRyaWJ1dGVzOwoKCQlmb3IgKCBjb25zdCBuYW1lIGluIGF0dHJpYnV0ZXMgKSB7CgoJCQljb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzWyBuYW1lIF07CgkJCXRoaXMuc2V0QXR0cmlidXRlKCBuYW1lLCBhdHRyaWJ1dGUuY2xvbmUoIGRhdGEgKSApOwoKCQl9CgoJCS8vIG1vcnBoIGF0dHJpYnV0ZXMKCgkJY29uc3QgbW9ycGhBdHRyaWJ1dGVzID0gc291cmNlLm1vcnBoQXR0cmlidXRlczsKCgkJZm9yICggY29uc3QgbmFtZSBpbiBtb3JwaEF0dHJpYnV0ZXMgKSB7CgoJCQljb25zdCBhcnJheSA9IFtdOwoJCQljb25zdCBtb3JwaEF0dHJpYnV0ZSA9IG1vcnBoQXR0cmlidXRlc1sgbmFtZSBdOyAvLyBtb3JwaEF0dHJpYnV0ZTogYXJyYXkgb2YgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZXMKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IG1vcnBoQXR0cmlidXRlLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJYXJyYXkucHVzaCggbW9ycGhBdHRyaWJ1dGVbIGkgXS5jbG9uZSggZGF0YSApICk7CgoJCQl9CgoJCQl0aGlzLm1vcnBoQXR0cmlidXRlc1sgbmFtZSBdID0gYXJyYXk7CgoJCX0KCgkJdGhpcy5tb3JwaFRhcmdldHNSZWxhdGl2ZSA9IHNvdXJjZS5tb3JwaFRhcmdldHNSZWxhdGl2ZTsKCgkJLy8gZ3JvdXBzCgoJCWNvbnN0IGdyb3VwcyA9IHNvdXJjZS5ncm91cHM7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IGdyb3Vwcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgZ3JvdXAgPSBncm91cHNbIGkgXTsKCQkJdGhpcy5hZGRHcm91cCggZ3JvdXAuc3RhcnQsIGdyb3VwLmNvdW50LCBncm91cC5tYXRlcmlhbEluZGV4ICk7CgoJCX0KCgkJLy8gYm91bmRpbmcgYm94CgoJCWNvbnN0IGJvdW5kaW5nQm94ID0gc291cmNlLmJvdW5kaW5nQm94OwoKCQlpZiAoIGJvdW5kaW5nQm94ICE9PSBudWxsICkgewoKCQkJdGhpcy5ib3VuZGluZ0JveCA9IGJvdW5kaW5nQm94LmNsb25lKCk7CgoJCX0KCgkJLy8gYm91bmRpbmcgc3BoZXJlCgoJCWNvbnN0IGJvdW5kaW5nU3BoZXJlID0gc291cmNlLmJvdW5kaW5nU3BoZXJlOwoKCQlpZiAoIGJvdW5kaW5nU3BoZXJlICE9PSBudWxsICkgewoKCQkJdGhpcy5ib3VuZGluZ1NwaGVyZSA9IGJvdW5kaW5nU3BoZXJlLmNsb25lKCk7CgoJCX0KCgkJLy8gZHJhdyByYW5nZQoKCQl0aGlzLmRyYXdSYW5nZS5zdGFydCA9IHNvdXJjZS5kcmF3UmFuZ2Uuc3RhcnQ7CgkJdGhpcy5kcmF3UmFuZ2UuY291bnQgPSBzb3VyY2UuZHJhd1JhbmdlLmNvdW50OwoKCQkvLyB1c2VyIGRhdGEKCgkJdGhpcy51c2VyRGF0YSA9IHNvdXJjZS51c2VyRGF0YTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWRpc3Bvc2UoKSB7CgoJCXRoaXMuZGlzcGF0Y2hFdmVudCggeyB0eXBlOiAnZGlzcG9zZScgfSApOwoKCX0KCn0KCmNvbnN0IF9pbnZlcnNlTWF0cml4JDMgPSAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXg0KCk7CmNvbnN0IF9yYXkkMyA9IC8qQF9fUFVSRV9fKi8gbmV3IFJheSgpOwpjb25zdCBfc3BoZXJlJDYgPSAvKkBfX1BVUkVfXyovIG5ldyBTcGhlcmUoKTsKY29uc3QgX3NwaGVyZUhpdEF0ID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwoKY29uc3QgX3ZBJDEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92QiQxID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfdkMkMSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNvbnN0IF90ZW1wQSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX21vcnBoQSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNvbnN0IF91dkEkMSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjIoKTsKY29uc3QgX3V2QiQxID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMigpOwpjb25zdCBfdXZDJDEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCk7Cgpjb25zdCBfbm9ybWFsQSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX25vcm1hbEIgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9ub3JtYWxDID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwoKY29uc3QgX2ludGVyc2VjdGlvblBvaW50ID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfaW50ZXJzZWN0aW9uUG9pbnRXb3JsZCA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNsYXNzIE1lc2ggZXh0ZW5kcyBPYmplY3QzRCB7CgoJY29uc3RydWN0b3IoIGdlb21ldHJ5ID0gbmV3IEJ1ZmZlckdlb21ldHJ5KCksIG1hdGVyaWFsID0gbmV3IE1lc2hCYXNpY01hdGVyaWFsKCkgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNNZXNoID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ01lc2gnOwoKCQl0aGlzLmdlb21ldHJ5ID0gZ2VvbWV0cnk7CgkJdGhpcy5tYXRlcmlhbCA9IG1hdGVyaWFsOwoKCQl0aGlzLnVwZGF0ZU1vcnBoVGFyZ2V0cygpOwoKCX0KCgljb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlLCByZWN1cnNpdmUgKTsKCgkJaWYgKCBzb3VyY2UubW9ycGhUYXJnZXRJbmZsdWVuY2VzICE9PSB1bmRlZmluZWQgKSB7CgoJCQl0aGlzLm1vcnBoVGFyZ2V0SW5mbHVlbmNlcyA9IHNvdXJjZS5tb3JwaFRhcmdldEluZmx1ZW5jZXMuc2xpY2UoKTsKCgkJfQoKCQlpZiAoIHNvdXJjZS5tb3JwaFRhcmdldERpY3Rpb25hcnkgIT09IHVuZGVmaW5lZCApIHsKCgkJCXRoaXMubW9ycGhUYXJnZXREaWN0aW9uYXJ5ID0gT2JqZWN0LmFzc2lnbigge30sIHNvdXJjZS5tb3JwaFRhcmdldERpY3Rpb25hcnkgKTsKCgkJfQoKCQl0aGlzLm1hdGVyaWFsID0gQXJyYXkuaXNBcnJheSggc291cmNlLm1hdGVyaWFsICkgPyBzb3VyY2UubWF0ZXJpYWwuc2xpY2UoKSA6IHNvdXJjZS5tYXRlcmlhbDsKCQl0aGlzLmdlb21ldHJ5ID0gc291cmNlLmdlb21ldHJ5OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdXBkYXRlTW9ycGhUYXJnZXRzKCkgewoKCQljb25zdCBnZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnk7CgoJCWNvbnN0IG1vcnBoQXR0cmlidXRlcyA9IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlczsKCQljb25zdCBrZXlzID0gT2JqZWN0LmtleXMoIG1vcnBoQXR0cmlidXRlcyApOwoKCQlpZiAoIGtleXMubGVuZ3RoID4gMCApIHsKCgkJCWNvbnN0IG1vcnBoQXR0cmlidXRlID0gbW9ycGhBdHRyaWJ1dGVzWyBrZXlzWyAwIF0gXTsKCgkJCWlmICggbW9ycGhBdHRyaWJ1dGUgIT09IHVuZGVmaW5lZCApIHsKCgkJCQl0aGlzLm1vcnBoVGFyZ2V0SW5mbHVlbmNlcyA9IFtdOwoJCQkJdGhpcy5tb3JwaFRhcmdldERpY3Rpb25hcnkgPSB7fTsKCgkJCQlmb3IgKCBsZXQgbSA9IDAsIG1sID0gbW9ycGhBdHRyaWJ1dGUubGVuZ3RoOyBtIDwgbWw7IG0gKysgKSB7CgoJCQkJCWNvbnN0IG5hbWUgPSBtb3JwaEF0dHJpYnV0ZVsgbSBdLm5hbWUgfHwgU3RyaW5nKCBtICk7CgoJCQkJCXRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzLnB1c2goIDAgKTsKCQkJCQl0aGlzLm1vcnBoVGFyZ2V0RGljdGlvbmFyeVsgbmFtZSBdID0gbTsKCgkJCQl9CgoJCQl9CgoJCX0KCgl9CgoJZ2V0VmVydGV4UG9zaXRpb24oIGluZGV4LCB0YXJnZXQgKSB7CgoJCWNvbnN0IGdlb21ldHJ5ID0gdGhpcy5nZW9tZXRyeTsKCQljb25zdCBwb3NpdGlvbiA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb247CgkJY29uc3QgbW9ycGhQb3NpdGlvbiA9IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5wb3NpdGlvbjsKCQljb25zdCBtb3JwaFRhcmdldHNSZWxhdGl2ZSA9IGdlb21ldHJ5Lm1vcnBoVGFyZ2V0c1JlbGF0aXZlOwoKCQl0YXJnZXQuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb24sIGluZGV4ICk7CgoJCWNvbnN0IG1vcnBoSW5mbHVlbmNlcyA9IHRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzOwoKCQlpZiAoIG1vcnBoUG9zaXRpb24gJiYgbW9ycGhJbmZsdWVuY2VzICkgewoKCQkJX21vcnBoQS5zZXQoIDAsIDAsIDAgKTsKCgkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBtb3JwaFBvc2l0aW9uLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCWNvbnN0IGluZmx1ZW5jZSA9IG1vcnBoSW5mbHVlbmNlc1sgaSBdOwoJCQkJY29uc3QgbW9ycGhBdHRyaWJ1dGUgPSBtb3JwaFBvc2l0aW9uWyBpIF07CgoJCQkJaWYgKCBpbmZsdWVuY2UgPT09IDAgKSBjb250aW51ZTsKCgkJCQlfdGVtcEEuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggbW9ycGhBdHRyaWJ1dGUsIGluZGV4ICk7CgoJCQkJaWYgKCBtb3JwaFRhcmdldHNSZWxhdGl2ZSApIHsKCgkJCQkJX21vcnBoQS5hZGRTY2FsZWRWZWN0b3IoIF90ZW1wQSwgaW5mbHVlbmNlICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJX21vcnBoQS5hZGRTY2FsZWRWZWN0b3IoIF90ZW1wQS5zdWIoIHRhcmdldCApLCBpbmZsdWVuY2UgKTsKCgkJCQl9CgoJCQl9CgoJCQl0YXJnZXQuYWRkKCBfbW9ycGhBICk7CgoJCX0KCgkJcmV0dXJuIHRhcmdldDsKCgl9CgoJcmF5Y2FzdCggcmF5Y2FzdGVyLCBpbnRlcnNlY3RzICkgewoKCQljb25zdCBnZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnk7CgkJY29uc3QgbWF0ZXJpYWwgPSB0aGlzLm1hdGVyaWFsOwoJCWNvbnN0IG1hdHJpeFdvcmxkID0gdGhpcy5tYXRyaXhXb3JsZDsKCgkJaWYgKCBtYXRlcmlhbCA9PT0gdW5kZWZpbmVkICkgcmV0dXJuOwoKCQkvLyB0ZXN0IHdpdGggYm91bmRpbmcgc3BoZXJlIGluIHdvcmxkIHNwYWNlCgoJCWlmICggZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgKSBnZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTsKCgkJX3NwaGVyZSQ2LmNvcHkoIGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlICk7CgkJX3NwaGVyZSQ2LmFwcGx5TWF0cml4NCggbWF0cml4V29ybGQgKTsKCgkJLy8gY2hlY2sgZGlzdGFuY2UgZnJvbSByYXkgb3JpZ2luIHRvIGJvdW5kaW5nIHNwaGVyZQoKCQlfcmF5JDMuY29weSggcmF5Y2FzdGVyLnJheSApLnJlY2FzdCggcmF5Y2FzdGVyLm5lYXIgKTsKCgkJaWYgKCBfc3BoZXJlJDYuY29udGFpbnNQb2ludCggX3JheSQzLm9yaWdpbiApID09PSBmYWxzZSApIHsKCgkJCWlmICggX3JheSQzLmludGVyc2VjdFNwaGVyZSggX3NwaGVyZSQ2LCBfc3BoZXJlSGl0QXQgKSA9PT0gbnVsbCApIHJldHVybjsKCgkJCWlmICggX3JheSQzLm9yaWdpbi5kaXN0YW5jZVRvU3F1YXJlZCggX3NwaGVyZUhpdEF0ICkgPiAoIHJheWNhc3Rlci5mYXIgLSByYXljYXN0ZXIubmVhciApICoqIDIgKSByZXR1cm47CgoJCX0KCgkJLy8gY29udmVydCByYXkgdG8gbG9jYWwgc3BhY2Ugb2YgbWVzaAoKCQlfaW52ZXJzZU1hdHJpeCQzLmNvcHkoIG1hdHJpeFdvcmxkICkuaW52ZXJ0KCk7CgkJX3JheSQzLmNvcHkoIHJheWNhc3Rlci5yYXkgKS5hcHBseU1hdHJpeDQoIF9pbnZlcnNlTWF0cml4JDMgKTsKCgkJLy8gdGVzdCB3aXRoIGJvdW5kaW5nIGJveCBpbiBsb2NhbCBzcGFjZQoKCQlpZiAoIGdlb21ldHJ5LmJvdW5kaW5nQm94ICE9PSBudWxsICkgewoKCQkJaWYgKCBfcmF5JDMuaW50ZXJzZWN0c0JveCggZ2VvbWV0cnkuYm91bmRpbmdCb3ggKSA9PT0gZmFsc2UgKSByZXR1cm47CgoJCX0KCgkJLy8gdGVzdCBmb3IgaW50ZXJzZWN0aW9ucyB3aXRoIGdlb21ldHJ5CgoJCXRoaXMuX2NvbXB1dGVJbnRlcnNlY3Rpb25zKCByYXljYXN0ZXIsIGludGVyc2VjdHMsIF9yYXkkMyApOwoKCX0KCglfY29tcHV0ZUludGVyc2VjdGlvbnMoIHJheWNhc3RlciwgaW50ZXJzZWN0cywgcmF5TG9jYWxTcGFjZSApIHsKCgkJbGV0IGludGVyc2VjdGlvbjsKCgkJY29uc3QgZ2VvbWV0cnkgPSB0aGlzLmdlb21ldHJ5OwoJCWNvbnN0IG1hdGVyaWFsID0gdGhpcy5tYXRlcmlhbDsKCgkJY29uc3QgaW5kZXggPSBnZW9tZXRyeS5pbmRleDsKCQljb25zdCBwb3NpdGlvbiA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb247CgkJY29uc3QgdXYgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnV2OwoJCWNvbnN0IHV2MSA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMudXYxOwoJCWNvbnN0IG5vcm1hbCA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMubm9ybWFsOwoJCWNvbnN0IGdyb3VwcyA9IGdlb21ldHJ5Lmdyb3VwczsKCQljb25zdCBkcmF3UmFuZ2UgPSBnZW9tZXRyeS5kcmF3UmFuZ2U7CgoJCWlmICggaW5kZXggIT09IG51bGwgKSB7CgoJCQkvLyBpbmRleGVkIGJ1ZmZlciBnZW9tZXRyeQoKCQkJaWYgKCBBcnJheS5pc0FycmF5KCBtYXRlcmlhbCApICkgewoKCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBncm91cHMubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQkJCWNvbnN0IGdyb3VwID0gZ3JvdXBzWyBpIF07CgkJCQkJY29uc3QgZ3JvdXBNYXRlcmlhbCA9IG1hdGVyaWFsWyBncm91cC5tYXRlcmlhbEluZGV4IF07CgoJCQkJCWNvbnN0IHN0YXJ0ID0gTWF0aC5tYXgoIGdyb3VwLnN0YXJ0LCBkcmF3UmFuZ2Uuc3RhcnQgKTsKCQkJCQljb25zdCBlbmQgPSBNYXRoLm1pbiggaW5kZXguY291bnQsIE1hdGgubWluKCAoIGdyb3VwLnN0YXJ0ICsgZ3JvdXAuY291bnQgKSwgKCBkcmF3UmFuZ2Uuc3RhcnQgKyBkcmF3UmFuZ2UuY291bnQgKSApICk7CgoJCQkJCWZvciAoIGxldCBqID0gc3RhcnQsIGpsID0gZW5kOyBqIDwgamw7IGogKz0gMyApIHsKCgkJCQkJCWNvbnN0IGEgPSBpbmRleC5nZXRYKCBqICk7CgkJCQkJCWNvbnN0IGIgPSBpbmRleC5nZXRYKCBqICsgMSApOwoJCQkJCQljb25zdCBjID0gaW5kZXguZ2V0WCggaiArIDIgKTsKCgkJCQkJCWludGVyc2VjdGlvbiA9IGNoZWNrR2VvbWV0cnlJbnRlcnNlY3Rpb24oIHRoaXMsIGdyb3VwTWF0ZXJpYWwsIHJheWNhc3RlciwgcmF5TG9jYWxTcGFjZSwgdXYsIHV2MSwgbm9ybWFsLCBhLCBiLCBjICk7CgoJCQkJCQlpZiAoIGludGVyc2VjdGlvbiApIHsKCgkJCQkJCQlpbnRlcnNlY3Rpb24uZmFjZUluZGV4ID0gTWF0aC5mbG9vciggaiAvIDMgKTsgLy8gdHJpYW5nbGUgbnVtYmVyIGluIGluZGV4ZWQgYnVmZmVyIHNlbWFudGljcwoJCQkJCQkJaW50ZXJzZWN0aW9uLmZhY2UubWF0ZXJpYWxJbmRleCA9IGdyb3VwLm1hdGVyaWFsSW5kZXg7CgkJCQkJCQlpbnRlcnNlY3RzLnB1c2goIGludGVyc2VjdGlvbiApOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJfQoKCQkJfSBlbHNlIHsKCgkJCQljb25zdCBzdGFydCA9IE1hdGgubWF4KCAwLCBkcmF3UmFuZ2Uuc3RhcnQgKTsKCQkJCWNvbnN0IGVuZCA9IE1hdGgubWluKCBpbmRleC5jb3VudCwgKCBkcmF3UmFuZ2Uuc3RhcnQgKyBkcmF3UmFuZ2UuY291bnQgKSApOwoKCQkJCWZvciAoIGxldCBpID0gc3RhcnQsIGlsID0gZW5kOyBpIDwgaWw7IGkgKz0gMyApIHsKCgkJCQkJY29uc3QgYSA9IGluZGV4LmdldFgoIGkgKTsKCQkJCQljb25zdCBiID0gaW5kZXguZ2V0WCggaSArIDEgKTsKCQkJCQljb25zdCBjID0gaW5kZXguZ2V0WCggaSArIDIgKTsKCgkJCQkJaW50ZXJzZWN0aW9uID0gY2hlY2tHZW9tZXRyeUludGVyc2VjdGlvbiggdGhpcywgbWF0ZXJpYWwsIHJheWNhc3RlciwgcmF5TG9jYWxTcGFjZSwgdXYsIHV2MSwgbm9ybWFsLCBhLCBiLCBjICk7CgoJCQkJCWlmICggaW50ZXJzZWN0aW9uICkgewoKCQkJCQkJaW50ZXJzZWN0aW9uLmZhY2VJbmRleCA9IE1hdGguZmxvb3IoIGkgLyAzICk7IC8vIHRyaWFuZ2xlIG51bWJlciBpbiBpbmRleGVkIGJ1ZmZlciBzZW1hbnRpY3MKCQkJCQkJaW50ZXJzZWN0cy5wdXNoKCBpbnRlcnNlY3Rpb24gKTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJfSBlbHNlIGlmICggcG9zaXRpb24gIT09IHVuZGVmaW5lZCApIHsKCgkJCS8vIG5vbi1pbmRleGVkIGJ1ZmZlciBnZW9tZXRyeQoKCQkJaWYgKCBBcnJheS5pc0FycmF5KCBtYXRlcmlhbCApICkgewoKCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBncm91cHMubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQkJCWNvbnN0IGdyb3VwID0gZ3JvdXBzWyBpIF07CgkJCQkJY29uc3QgZ3JvdXBNYXRlcmlhbCA9IG1hdGVyaWFsWyBncm91cC5tYXRlcmlhbEluZGV4IF07CgoJCQkJCWNvbnN0IHN0YXJ0ID0gTWF0aC5tYXgoIGdyb3VwLnN0YXJ0LCBkcmF3UmFuZ2Uuc3RhcnQgKTsKCQkJCQljb25zdCBlbmQgPSBNYXRoLm1pbiggcG9zaXRpb24uY291bnQsIE1hdGgubWluKCAoIGdyb3VwLnN0YXJ0ICsgZ3JvdXAuY291bnQgKSwgKCBkcmF3UmFuZ2Uuc3RhcnQgKyBkcmF3UmFuZ2UuY291bnQgKSApICk7CgoJCQkJCWZvciAoIGxldCBqID0gc3RhcnQsIGpsID0gZW5kOyBqIDwgamw7IGogKz0gMyApIHsKCgkJCQkJCWNvbnN0IGEgPSBqOwoJCQkJCQljb25zdCBiID0gaiArIDE7CgkJCQkJCWNvbnN0IGMgPSBqICsgMjsKCgkJCQkJCWludGVyc2VjdGlvbiA9IGNoZWNrR2VvbWV0cnlJbnRlcnNlY3Rpb24oIHRoaXMsIGdyb3VwTWF0ZXJpYWwsIHJheWNhc3RlciwgcmF5TG9jYWxTcGFjZSwgdXYsIHV2MSwgbm9ybWFsLCBhLCBiLCBjICk7CgoJCQkJCQlpZiAoIGludGVyc2VjdGlvbiApIHsKCgkJCQkJCQlpbnRlcnNlY3Rpb24uZmFjZUluZGV4ID0gTWF0aC5mbG9vciggaiAvIDMgKTsgLy8gdHJpYW5nbGUgbnVtYmVyIGluIG5vbi1pbmRleGVkIGJ1ZmZlciBzZW1hbnRpY3MKCQkJCQkJCWludGVyc2VjdGlvbi5mYWNlLm1hdGVyaWFsSW5kZXggPSBncm91cC5tYXRlcmlhbEluZGV4OwoJCQkJCQkJaW50ZXJzZWN0cy5wdXNoKCBpbnRlcnNlY3Rpb24gKTsKCgkJCQkJCX0KCgkJCQkJfQoKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJY29uc3Qgc3RhcnQgPSBNYXRoLm1heCggMCwgZHJhd1JhbmdlLnN0YXJ0ICk7CgkJCQljb25zdCBlbmQgPSBNYXRoLm1pbiggcG9zaXRpb24uY291bnQsICggZHJhd1JhbmdlLnN0YXJ0ICsgZHJhd1JhbmdlLmNvdW50ICkgKTsKCgkJCQlmb3IgKCBsZXQgaSA9IHN0YXJ0LCBpbCA9IGVuZDsgaSA8IGlsOyBpICs9IDMgKSB7CgoJCQkJCWNvbnN0IGEgPSBpOwoJCQkJCWNvbnN0IGIgPSBpICsgMTsKCQkJCQljb25zdCBjID0gaSArIDI7CgoJCQkJCWludGVyc2VjdGlvbiA9IGNoZWNrR2VvbWV0cnlJbnRlcnNlY3Rpb24oIHRoaXMsIG1hdGVyaWFsLCByYXljYXN0ZXIsIHJheUxvY2FsU3BhY2UsIHV2LCB1djEsIG5vcm1hbCwgYSwgYiwgYyApOwoKCQkJCQlpZiAoIGludGVyc2VjdGlvbiApIHsKCgkJCQkJCWludGVyc2VjdGlvbi5mYWNlSW5kZXggPSBNYXRoLmZsb29yKCBpIC8gMyApOyAvLyB0cmlhbmdsZSBudW1iZXIgaW4gbm9uLWluZGV4ZWQgYnVmZmVyIHNlbWFudGljcwoJCQkJCQlpbnRlcnNlY3RzLnB1c2goIGludGVyc2VjdGlvbiApOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQl9CgoJfQoKfQoKZnVuY3Rpb24gY2hlY2tJbnRlcnNlY3Rpb24oIG9iamVjdCwgbWF0ZXJpYWwsIHJheWNhc3RlciwgcmF5LCBwQSwgcEIsIHBDLCBwb2ludCApIHsKCglsZXQgaW50ZXJzZWN0OwoKCWlmICggbWF0ZXJpYWwuc2lkZSA9PT0gQmFja1NpZGUgKSB7CgoJCWludGVyc2VjdCA9IHJheS5pbnRlcnNlY3RUcmlhbmdsZSggcEMsIHBCLCBwQSwgdHJ1ZSwgcG9pbnQgKTsKCgl9IGVsc2UgewoKCQlpbnRlcnNlY3QgPSByYXkuaW50ZXJzZWN0VHJpYW5nbGUoIHBBLCBwQiwgcEMsICggbWF0ZXJpYWwuc2lkZSA9PT0gRnJvbnRTaWRlICksIHBvaW50ICk7CgoJfQoKCWlmICggaW50ZXJzZWN0ID09PSBudWxsICkgcmV0dXJuIG51bGw7CgoJX2ludGVyc2VjdGlvblBvaW50V29ybGQuY29weSggcG9pbnQgKTsKCV9pbnRlcnNlY3Rpb25Qb2ludFdvcmxkLmFwcGx5TWF0cml4NCggb2JqZWN0Lm1hdHJpeFdvcmxkICk7CgoJY29uc3QgZGlzdGFuY2UgPSByYXljYXN0ZXIucmF5Lm9yaWdpbi5kaXN0YW5jZVRvKCBfaW50ZXJzZWN0aW9uUG9pbnRXb3JsZCApOwoKCWlmICggZGlzdGFuY2UgPCByYXljYXN0ZXIubmVhciB8fCBkaXN0YW5jZSA+IHJheWNhc3Rlci5mYXIgKSByZXR1cm4gbnVsbDsKCglyZXR1cm4gewoJCWRpc3RhbmNlOiBkaXN0YW5jZSwKCQlwb2ludDogX2ludGVyc2VjdGlvblBvaW50V29ybGQuY2xvbmUoKSwKCQlvYmplY3Q6IG9iamVjdAoJfTsKCn0KCmZ1bmN0aW9uIGNoZWNrR2VvbWV0cnlJbnRlcnNlY3Rpb24oIG9iamVjdCwgbWF0ZXJpYWwsIHJheWNhc3RlciwgcmF5LCB1diwgdXYxLCBub3JtYWwsIGEsIGIsIGMgKSB7CgoJb2JqZWN0LmdldFZlcnRleFBvc2l0aW9uKCBhLCBfdkEkMSApOwoJb2JqZWN0LmdldFZlcnRleFBvc2l0aW9uKCBiLCBfdkIkMSApOwoJb2JqZWN0LmdldFZlcnRleFBvc2l0aW9uKCBjLCBfdkMkMSApOwoKCWNvbnN0IGludGVyc2VjdGlvbiA9IGNoZWNrSW50ZXJzZWN0aW9uKCBvYmplY3QsIG1hdGVyaWFsLCByYXljYXN0ZXIsIHJheSwgX3ZBJDEsIF92QiQxLCBfdkMkMSwgX2ludGVyc2VjdGlvblBvaW50ICk7CgoJaWYgKCBpbnRlcnNlY3Rpb24gKSB7CgoJCWlmICggdXYgKSB7CgoJCQlfdXZBJDEuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggdXYsIGEgKTsKCQkJX3V2QiQxLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHV2LCBiICk7CgkJCV91dkMkMS5mcm9tQnVmZmVyQXR0cmlidXRlKCB1diwgYyApOwoKCQkJaW50ZXJzZWN0aW9uLnV2ID0gVHJpYW5nbGUuZ2V0SW50ZXJwb2xhdGlvbiggX2ludGVyc2VjdGlvblBvaW50LCBfdkEkMSwgX3ZCJDEsIF92QyQxLCBfdXZBJDEsIF91dkIkMSwgX3V2QyQxLCBuZXcgVmVjdG9yMigpICk7CgoJCX0KCgkJaWYgKCB1djEgKSB7CgoJCQlfdXZBJDEuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggdXYxLCBhICk7CgkJCV91dkIkMS5mcm9tQnVmZmVyQXR0cmlidXRlKCB1djEsIGIgKTsKCQkJX3V2QyQxLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHV2MSwgYyApOwoKCQkJaW50ZXJzZWN0aW9uLnV2MSA9IFRyaWFuZ2xlLmdldEludGVycG9sYXRpb24oIF9pbnRlcnNlY3Rpb25Qb2ludCwgX3ZBJDEsIF92QiQxLCBfdkMkMSwgX3V2QSQxLCBfdXZCJDEsIF91dkMkMSwgbmV3IFZlY3RvcjIoKSApOwoJCQlpbnRlcnNlY3Rpb24udXYyID0gaW50ZXJzZWN0aW9uLnV2MTsgLy8gQGRlcHJlY2F0ZWQsIHIxNTIKCgkJfQoKCQlpZiAoIG5vcm1hbCApIHsKCgkJCV9ub3JtYWxBLmZyb21CdWZmZXJBdHRyaWJ1dGUoIG5vcm1hbCwgYSApOwoJCQlfbm9ybWFsQi5mcm9tQnVmZmVyQXR0cmlidXRlKCBub3JtYWwsIGIgKTsKCQkJX25vcm1hbEMuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggbm9ybWFsLCBjICk7CgoJCQlpbnRlcnNlY3Rpb24ubm9ybWFsID0gVHJpYW5nbGUuZ2V0SW50ZXJwb2xhdGlvbiggX2ludGVyc2VjdGlvblBvaW50LCBfdkEkMSwgX3ZCJDEsIF92QyQxLCBfbm9ybWFsQSwgX25vcm1hbEIsIF9ub3JtYWxDLCBuZXcgVmVjdG9yMygpICk7CgoJCQlpZiAoIGludGVyc2VjdGlvbi5ub3JtYWwuZG90KCByYXkuZGlyZWN0aW9uICkgPiAwICkgewoKCQkJCWludGVyc2VjdGlvbi5ub3JtYWwubXVsdGlwbHlTY2FsYXIoIC0gMSApOwoKCQkJfQoKCQl9CgoJCWNvbnN0IGZhY2UgPSB7CgkJCWE6IGEsCgkJCWI6IGIsCgkJCWM6IGMsCgkJCW5vcm1hbDogbmV3IFZlY3RvcjMoKSwKCQkJbWF0ZXJpYWxJbmRleDogMAoJCX07CgoJCVRyaWFuZ2xlLmdldE5vcm1hbCggX3ZBJDEsIF92QiQxLCBfdkMkMSwgZmFjZS5ub3JtYWwgKTsKCgkJaW50ZXJzZWN0aW9uLmZhY2UgPSBmYWNlOwoKCX0KCglyZXR1cm4gaW50ZXJzZWN0aW9uOwoKfQoKY2xhc3MgQm94R2VvbWV0cnkgZXh0ZW5kcyBCdWZmZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIHdpZHRoID0gMSwgaGVpZ2h0ID0gMSwgZGVwdGggPSAxLCB3aWR0aFNlZ21lbnRzID0gMSwgaGVpZ2h0U2VnbWVudHMgPSAxLCBkZXB0aFNlZ21lbnRzID0gMSApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy50eXBlID0gJ0JveEdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQl3aWR0aDogd2lkdGgsCgkJCWhlaWdodDogaGVpZ2h0LAoJCQlkZXB0aDogZGVwdGgsCgkJCXdpZHRoU2VnbWVudHM6IHdpZHRoU2VnbWVudHMsCgkJCWhlaWdodFNlZ21lbnRzOiBoZWlnaHRTZWdtZW50cywKCQkJZGVwdGhTZWdtZW50czogZGVwdGhTZWdtZW50cwoJCX07CgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJLy8gc2VnbWVudHMKCgkJd2lkdGhTZWdtZW50cyA9IE1hdGguZmxvb3IoIHdpZHRoU2VnbWVudHMgKTsKCQloZWlnaHRTZWdtZW50cyA9IE1hdGguZmxvb3IoIGhlaWdodFNlZ21lbnRzICk7CgkJZGVwdGhTZWdtZW50cyA9IE1hdGguZmxvb3IoIGRlcHRoU2VnbWVudHMgKTsKCgkJLy8gYnVmZmVycwoKCQljb25zdCBpbmRpY2VzID0gW107CgkJY29uc3QgdmVydGljZXMgPSBbXTsKCQljb25zdCBub3JtYWxzID0gW107CgkJY29uc3QgdXZzID0gW107CgoJCS8vIGhlbHBlciB2YXJpYWJsZXMKCgkJbGV0IG51bWJlck9mVmVydGljZXMgPSAwOwoJCWxldCBncm91cFN0YXJ0ID0gMDsKCgkJLy8gYnVpbGQgZWFjaCBzaWRlIG9mIHRoZSBib3ggZ2VvbWV0cnkKCgkJYnVpbGRQbGFuZSggJ3onLCAneScsICd4JywgLSAxLCAtIDEsIGRlcHRoLCBoZWlnaHQsIHdpZHRoLCBkZXB0aFNlZ21lbnRzLCBoZWlnaHRTZWdtZW50cywgMCApOyAvLyBweAoJCWJ1aWxkUGxhbmUoICd6JywgJ3knLCAneCcsIDEsIC0gMSwgZGVwdGgsIGhlaWdodCwgLSB3aWR0aCwgZGVwdGhTZWdtZW50cywgaGVpZ2h0U2VnbWVudHMsIDEgKTsgLy8gbngKCQlidWlsZFBsYW5lKCAneCcsICd6JywgJ3knLCAxLCAxLCB3aWR0aCwgZGVwdGgsIGhlaWdodCwgd2lkdGhTZWdtZW50cywgZGVwdGhTZWdtZW50cywgMiApOyAvLyBweQoJCWJ1aWxkUGxhbmUoICd4JywgJ3onLCAneScsIDEsIC0gMSwgd2lkdGgsIGRlcHRoLCAtIGhlaWdodCwgd2lkdGhTZWdtZW50cywgZGVwdGhTZWdtZW50cywgMyApOyAvLyBueQoJCWJ1aWxkUGxhbmUoICd4JywgJ3knLCAneicsIDEsIC0gMSwgd2lkdGgsIGhlaWdodCwgZGVwdGgsIHdpZHRoU2VnbWVudHMsIGhlaWdodFNlZ21lbnRzLCA0ICk7IC8vIHB6CgkJYnVpbGRQbGFuZSggJ3gnLCAneScsICd6JywgLSAxLCAtIDEsIHdpZHRoLCBoZWlnaHQsIC0gZGVwdGgsIHdpZHRoU2VnbWVudHMsIGhlaWdodFNlZ21lbnRzLCA1ICk7IC8vIG56CgoJCS8vIGJ1aWxkIGdlb21ldHJ5CgoJCXRoaXMuc2V0SW5kZXgoIGluZGljZXMgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHZlcnRpY2VzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ25vcm1hbCcsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCBub3JtYWxzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3V2JywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHV2cywgMiApICk7CgoJCWZ1bmN0aW9uIGJ1aWxkUGxhbmUoIHUsIHYsIHcsIHVkaXIsIHZkaXIsIHdpZHRoLCBoZWlnaHQsIGRlcHRoLCBncmlkWCwgZ3JpZFksIG1hdGVyaWFsSW5kZXggKSB7CgoJCQljb25zdCBzZWdtZW50V2lkdGggPSB3aWR0aCAvIGdyaWRYOwoJCQljb25zdCBzZWdtZW50SGVpZ2h0ID0gaGVpZ2h0IC8gZ3JpZFk7CgoJCQljb25zdCB3aWR0aEhhbGYgPSB3aWR0aCAvIDI7CgkJCWNvbnN0IGhlaWdodEhhbGYgPSBoZWlnaHQgLyAyOwoJCQljb25zdCBkZXB0aEhhbGYgPSBkZXB0aCAvIDI7CgoJCQljb25zdCBncmlkWDEgPSBncmlkWCArIDE7CgkJCWNvbnN0IGdyaWRZMSA9IGdyaWRZICsgMTsKCgkJCWxldCB2ZXJ0ZXhDb3VudGVyID0gMDsKCQkJbGV0IGdyb3VwQ291bnQgPSAwOwoKCQkJY29uc3QgdmVjdG9yID0gbmV3IFZlY3RvcjMoKTsKCgkJCS8vIGdlbmVyYXRlIHZlcnRpY2VzLCBub3JtYWxzIGFuZCB1dnMKCgkJCWZvciAoIGxldCBpeSA9IDA7IGl5IDwgZ3JpZFkxOyBpeSArKyApIHsKCgkJCQljb25zdCB5ID0gaXkgKiBzZWdtZW50SGVpZ2h0IC0gaGVpZ2h0SGFsZjsKCgkJCQlmb3IgKCBsZXQgaXggPSAwOyBpeCA8IGdyaWRYMTsgaXggKysgKSB7CgoJCQkJCWNvbnN0IHggPSBpeCAqIHNlZ21lbnRXaWR0aCAtIHdpZHRoSGFsZjsKCgkJCQkJLy8gc2V0IHZhbHVlcyB0byBjb3JyZWN0IHZlY3RvciBjb21wb25lbnQKCgkJCQkJdmVjdG9yWyB1IF0gPSB4ICogdWRpcjsKCQkJCQl2ZWN0b3JbIHYgXSA9IHkgKiB2ZGlyOwoJCQkJCXZlY3RvclsgdyBdID0gZGVwdGhIYWxmOwoKCQkJCQkvLyBub3cgYXBwbHkgdmVjdG9yIHRvIHZlcnRleCBidWZmZXIKCgkJCQkJdmVydGljZXMucHVzaCggdmVjdG9yLngsIHZlY3Rvci55LCB2ZWN0b3IueiApOwoKCQkJCQkvLyBzZXQgdmFsdWVzIHRvIGNvcnJlY3QgdmVjdG9yIGNvbXBvbmVudAoKCQkJCQl2ZWN0b3JbIHUgXSA9IDA7CgkJCQkJdmVjdG9yWyB2IF0gPSAwOwoJCQkJCXZlY3RvclsgdyBdID0gZGVwdGggPiAwID8gMSA6IC0gMTsKCgkJCQkJLy8gbm93IGFwcGx5IHZlY3RvciB0byBub3JtYWwgYnVmZmVyCgoJCQkJCW5vcm1hbHMucHVzaCggdmVjdG9yLngsIHZlY3Rvci55LCB2ZWN0b3IueiApOwoKCQkJCQkvLyB1dnMKCgkJCQkJdXZzLnB1c2goIGl4IC8gZ3JpZFggKTsKCQkJCQl1dnMucHVzaCggMSAtICggaXkgLyBncmlkWSApICk7CgoJCQkJCS8vIGNvdW50ZXJzCgoJCQkJCXZlcnRleENvdW50ZXIgKz0gMTsKCgkJCQl9CgoJCQl9CgoJCQkvLyBpbmRpY2VzCgoJCQkvLyAxLiB5b3UgbmVlZCB0aHJlZSBpbmRpY2VzIHRvIGRyYXcgYSBzaW5nbGUgZmFjZQoJCQkvLyAyLiBhIHNpbmdsZSBzZWdtZW50IGNvbnNpc3RzIG9mIHR3byBmYWNlcwoJCQkvLyAzLiBzbyB3ZSBuZWVkIHRvIGdlbmVyYXRlIHNpeCAoMiozKSBpbmRpY2VzIHBlciBzZWdtZW50CgoJCQlmb3IgKCBsZXQgaXkgPSAwOyBpeSA8IGdyaWRZOyBpeSArKyApIHsKCgkJCQlmb3IgKCBsZXQgaXggPSAwOyBpeCA8IGdyaWRYOyBpeCArKyApIHsKCgkJCQkJY29uc3QgYSA9IG51bWJlck9mVmVydGljZXMgKyBpeCArIGdyaWRYMSAqIGl5OwoJCQkJCWNvbnN0IGIgPSBudW1iZXJPZlZlcnRpY2VzICsgaXggKyBncmlkWDEgKiAoIGl5ICsgMSApOwoJCQkJCWNvbnN0IGMgPSBudW1iZXJPZlZlcnRpY2VzICsgKCBpeCArIDEgKSArIGdyaWRYMSAqICggaXkgKyAxICk7CgkJCQkJY29uc3QgZCA9IG51bWJlck9mVmVydGljZXMgKyAoIGl4ICsgMSApICsgZ3JpZFgxICogaXk7CgoJCQkJCS8vIGZhY2VzCgoJCQkJCWluZGljZXMucHVzaCggYSwgYiwgZCApOwoJCQkJCWluZGljZXMucHVzaCggYiwgYywgZCApOwoKCQkJCQkvLyBpbmNyZWFzZSBjb3VudGVyCgoJCQkJCWdyb3VwQ291bnQgKz0gNjsKCgkJCQl9CgoJCQl9CgoJCQkvLyBhZGQgYSBncm91cCB0byB0aGUgZ2VvbWV0cnkuIHRoaXMgd2lsbCBlbnN1cmUgbXVsdGkgbWF0ZXJpYWwgc3VwcG9ydAoKCQkJc2NvcGUuYWRkR3JvdXAoIGdyb3VwU3RhcnQsIGdyb3VwQ291bnQsIG1hdGVyaWFsSW5kZXggKTsKCgkJCS8vIGNhbGN1bGF0ZSBuZXcgc3RhcnQgdmFsdWUgZm9yIGdyb3VwcwoKCQkJZ3JvdXBTdGFydCArPSBncm91cENvdW50OwoKCQkJLy8gdXBkYXRlIHRvdGFsIG51bWJlciBvZiB2ZXJ0aWNlcwoKCQkJbnVtYmVyT2ZWZXJ0aWNlcyArPSB2ZXJ0ZXhDb3VudGVyOwoKCQl9CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oIHt9LCBzb3VyY2UucGFyYW1ldGVycyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQlyZXR1cm4gbmV3IEJveEdlb21ldHJ5KCBkYXRhLndpZHRoLCBkYXRhLmhlaWdodCwgZGF0YS5kZXB0aCwgZGF0YS53aWR0aFNlZ21lbnRzLCBkYXRhLmhlaWdodFNlZ21lbnRzLCBkYXRhLmRlcHRoU2VnbWVudHMgKTsKCgl9Cgp9CgovKioKICogVW5pZm9ybSBVdGlsaXRpZXMKICovCgpmdW5jdGlvbiBjbG9uZVVuaWZvcm1zKCBzcmMgKSB7CgoJY29uc3QgZHN0ID0ge307CgoJZm9yICggY29uc3QgdSBpbiBzcmMgKSB7CgoJCWRzdFsgdSBdID0ge307CgoJCWZvciAoIGNvbnN0IHAgaW4gc3JjWyB1IF0gKSB7CgoJCQljb25zdCBwcm9wZXJ0eSA9IHNyY1sgdSBdWyBwIF07CgoJCQlpZiAoIHByb3BlcnR5ICYmICggcHJvcGVydHkuaXNDb2xvciB8fAoJCQkJcHJvcGVydHkuaXNNYXRyaXgzIHx8IHByb3BlcnR5LmlzTWF0cml4NCB8fAoJCQkJcHJvcGVydHkuaXNWZWN0b3IyIHx8IHByb3BlcnR5LmlzVmVjdG9yMyB8fCBwcm9wZXJ0eS5pc1ZlY3RvcjQgfHwKCQkJCXByb3BlcnR5LmlzVGV4dHVyZSB8fCBwcm9wZXJ0eS5pc1F1YXRlcm5pb24gKSApIHsKCgkJCQlpZiAoIHByb3BlcnR5LmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSApIHsKCgkJCQkJY29uc29sZS53YXJuKCAnVW5pZm9ybXNVdGlsczogVGV4dHVyZXMgb2YgcmVuZGVyIHRhcmdldHMgY2Fubm90IGJlIGNsb25lZCB2aWEgY2xvbmVVbmlmb3JtcygpIG9yIG1lcmdlVW5pZm9ybXMoKS4nICk7CgkJCQkJZHN0WyB1IF1bIHAgXSA9IG51bGw7CgoJCQkJfSBlbHNlIHsKCgkJCQkJZHN0WyB1IF1bIHAgXSA9IHByb3BlcnR5LmNsb25lKCk7CgoJCQkJfQoKCQkJfSBlbHNlIGlmICggQXJyYXkuaXNBcnJheSggcHJvcGVydHkgKSApIHsKCgkJCQlkc3RbIHUgXVsgcCBdID0gcHJvcGVydHkuc2xpY2UoKTsKCgkJCX0gZWxzZSB7CgoJCQkJZHN0WyB1IF1bIHAgXSA9IHByb3BlcnR5OwoKCQkJfQoKCQl9CgoJfQoKCXJldHVybiBkc3Q7Cgp9CgpmdW5jdGlvbiBtZXJnZVVuaWZvcm1zKCB1bmlmb3JtcyApIHsKCgljb25zdCBtZXJnZWQgPSB7fTsKCglmb3IgKCBsZXQgdSA9IDA7IHUgPCB1bmlmb3Jtcy5sZW5ndGg7IHUgKysgKSB7CgoJCWNvbnN0IHRtcCA9IGNsb25lVW5pZm9ybXMoIHVuaWZvcm1zWyB1IF0gKTsKCgkJZm9yICggY29uc3QgcCBpbiB0bXAgKSB7CgoJCQltZXJnZWRbIHAgXSA9IHRtcFsgcCBdOwoKCQl9CgoJfQoKCXJldHVybiBtZXJnZWQ7Cgp9CgpmdW5jdGlvbiBjbG9uZVVuaWZvcm1zR3JvdXBzKCBzcmMgKSB7CgoJY29uc3QgZHN0ID0gW107CgoJZm9yICggbGV0IHUgPSAwOyB1IDwgc3JjLmxlbmd0aDsgdSArKyApIHsKCgkJZHN0LnB1c2goIHNyY1sgdSBdLmNsb25lKCkgKTsKCgl9CgoJcmV0dXJuIGRzdDsKCn0KCmZ1bmN0aW9uIGdldFVubGl0VW5pZm9ybUNvbG9yU3BhY2UoIHJlbmRlcmVyICkgewoKCWlmICggcmVuZGVyZXIuZ2V0UmVuZGVyVGFyZ2V0KCkgPT09IG51bGwgKSB7CgoJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tcmRvb2IvdGhyZWUuanMvcHVsbC8yMzkzNyNpc3N1ZWNvbW1lbnQtMTExMTA2NzM5OAoJCXJldHVybiByZW5kZXJlci5vdXRwdXRDb2xvclNwYWNlOwoKCX0KCglyZXR1cm4gQ29sb3JNYW5hZ2VtZW50LndvcmtpbmdDb2xvclNwYWNlOwoKfQoKLy8gTGVnYWN5Cgpjb25zdCBVbmlmb3Jtc1V0aWxzID0geyBjbG9uZTogY2xvbmVVbmlmb3JtcywgbWVyZ2U6IG1lcmdlVW5pZm9ybXMgfTsKCnZhciBkZWZhdWx0X3ZlcnRleCA9ICJ2b2lkIG1haW4oKSB7XG5cdGdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG1vZGVsVmlld01hdHJpeCAqIHZlYzQoIHBvc2l0aW9uLCAxLjAgKTtcbn0iOwoKdmFyIGRlZmF1bHRfZnJhZ21lbnQgPSAidm9pZCBtYWluKCkge1xuXHRnbF9GcmFnQ29sb3IgPSB2ZWM0KCAxLjAsIDAuMCwgMC4wLCAxLjAgKTtcbn0iOwoKY2xhc3MgU2hhZGVyTWF0ZXJpYWwgZXh0ZW5kcyBNYXRlcmlhbCB7CgoJY29uc3RydWN0b3IoIHBhcmFtZXRlcnMgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNTaGFkZXJNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdTaGFkZXJNYXRlcmlhbCc7CgoJCXRoaXMuZGVmaW5lcyA9IHt9OwoJCXRoaXMudW5pZm9ybXMgPSB7fTsKCQl0aGlzLnVuaWZvcm1zR3JvdXBzID0gW107CgoJCXRoaXMudmVydGV4U2hhZGVyID0gZGVmYXVsdF92ZXJ0ZXg7CgkJdGhpcy5mcmFnbWVudFNoYWRlciA9IGRlZmF1bHRfZnJhZ21lbnQ7CgoJCXRoaXMubGluZXdpZHRoID0gMTsKCgkJdGhpcy53aXJlZnJhbWUgPSBmYWxzZTsKCQl0aGlzLndpcmVmcmFtZUxpbmV3aWR0aCA9IDE7CgoJCXRoaXMuZm9nID0gZmFsc2U7IC8vIHNldCB0byB1c2Ugc2NlbmUgZm9nCgkJdGhpcy5saWdodHMgPSBmYWxzZTsgLy8gc2V0IHRvIHVzZSBzY2VuZSBsaWdodHMKCQl0aGlzLmNsaXBwaW5nID0gZmFsc2U7IC8vIHNldCB0byB1c2UgdXNlci1kZWZpbmVkIGNsaXBwaW5nIHBsYW5lcwoKCQl0aGlzLmZvcmNlU2luZ2xlUGFzcyA9IHRydWU7CgoJCXRoaXMuZXh0ZW5zaW9ucyA9IHsKCQkJZGVyaXZhdGl2ZXM6IGZhbHNlLCAvLyBzZXQgdG8gdXNlIGRlcml2YXRpdmVzCgkJCWZyYWdEZXB0aDogZmFsc2UsIC8vIHNldCB0byB1c2UgZnJhZ21lbnQgZGVwdGggdmFsdWVzCgkJCWRyYXdCdWZmZXJzOiBmYWxzZSwgLy8gc2V0IHRvIHVzZSBkcmF3IGJ1ZmZlcnMKCQkJc2hhZGVyVGV4dHVyZUxPRDogZmFsc2UsIC8vIHNldCB0byB1c2Ugc2hhZGVyIHRleHR1cmUgTE9ECgkJCWNsaXBDdWxsRGlzdGFuY2U6IGZhbHNlLCAvLyBzZXQgdG8gdXNlIHZlcnRleCBzaGFkZXIgY2xpcHBpbmcKCQkJbXVsdGlEcmF3OiBmYWxzZSAvLyBzZXQgdG8gdXNlIHZlcnRleCBzaGFkZXIgbXVsdGlfZHJhdyAvIGVuYWJsZSBnbF9EcmF3SUQKCQl9OwoKCQkvLyBXaGVuIHJlbmRlcmVkIGdlb21ldHJ5IGRvZXNuJ3QgaW5jbHVkZSB0aGVzZSBhdHRyaWJ1dGVzIGJ1dCB0aGUgbWF0ZXJpYWwgZG9lcywKCQkvLyB1c2UgdGhlc2UgZGVmYXVsdCB2YWx1ZXMgaW4gV2ViR0wuIFRoaXMgYXZvaWRzIGVycm9ycyB3aGVuIGJ1ZmZlciBkYXRhIGlzIG1pc3NpbmcuCgkJdGhpcy5kZWZhdWx0QXR0cmlidXRlVmFsdWVzID0gewoJCQknY29sb3InOiBbIDEsIDEsIDEgXSwKCQkJJ3V2JzogWyAwLCAwIF0sCgkJCSd1djEnOiBbIDAsIDAgXQoJCX07CgoJCXRoaXMuaW5kZXgwQXR0cmlidXRlTmFtZSA9IHVuZGVmaW5lZDsKCQl0aGlzLnVuaWZvcm1zTmVlZFVwZGF0ZSA9IGZhbHNlOwoKCQl0aGlzLmdsc2xWZXJzaW9uID0gbnVsbDsKCgkJaWYgKCBwYXJhbWV0ZXJzICE9PSB1bmRlZmluZWQgKSB7CgoJCQl0aGlzLnNldFZhbHVlcyggcGFyYW1ldGVycyApOwoKCQl9CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuZnJhZ21lbnRTaGFkZXIgPSBzb3VyY2UuZnJhZ21lbnRTaGFkZXI7CgkJdGhpcy52ZXJ0ZXhTaGFkZXIgPSBzb3VyY2UudmVydGV4U2hhZGVyOwoKCQl0aGlzLnVuaWZvcm1zID0gY2xvbmVVbmlmb3Jtcyggc291cmNlLnVuaWZvcm1zICk7CgkJdGhpcy51bmlmb3Jtc0dyb3VwcyA9IGNsb25lVW5pZm9ybXNHcm91cHMoIHNvdXJjZS51bmlmb3Jtc0dyb3VwcyApOwoKCQl0aGlzLmRlZmluZXMgPSBPYmplY3QuYXNzaWduKCB7fSwgc291cmNlLmRlZmluZXMgKTsKCgkJdGhpcy53aXJlZnJhbWUgPSBzb3VyY2Uud2lyZWZyYW1lOwoJCXRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gc291cmNlLndpcmVmcmFtZUxpbmV3aWR0aDsKCgkJdGhpcy5mb2cgPSBzb3VyY2UuZm9nOwoJCXRoaXMubGlnaHRzID0gc291cmNlLmxpZ2h0czsKCQl0aGlzLmNsaXBwaW5nID0gc291cmNlLmNsaXBwaW5nOwoKCQl0aGlzLmV4dGVuc2lvbnMgPSBPYmplY3QuYXNzaWduKCB7fSwgc291cmNlLmV4dGVuc2lvbnMgKTsKCgkJdGhpcy5nbHNsVmVyc2lvbiA9IHNvdXJjZS5nbHNsVmVyc2lvbjsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTiggbWV0YSApIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTiggbWV0YSApOwoKCQlkYXRhLmdsc2xWZXJzaW9uID0gdGhpcy5nbHNsVmVyc2lvbjsKCQlkYXRhLnVuaWZvcm1zID0ge307CgoJCWZvciAoIGNvbnN0IG5hbWUgaW4gdGhpcy51bmlmb3JtcyApIHsKCgkJCWNvbnN0IHVuaWZvcm0gPSB0aGlzLnVuaWZvcm1zWyBuYW1lIF07CgkJCWNvbnN0IHZhbHVlID0gdW5pZm9ybS52YWx1ZTsKCgkJCWlmICggdmFsdWUgJiYgdmFsdWUuaXNUZXh0dXJlICkgewoKCQkJCWRhdGEudW5pZm9ybXNbIG5hbWUgXSA9IHsKCQkJCQl0eXBlOiAndCcsCgkJCQkJdmFsdWU6IHZhbHVlLnRvSlNPTiggbWV0YSApLnV1aWQKCQkJCX07CgoJCQl9IGVsc2UgaWYgKCB2YWx1ZSAmJiB2YWx1ZS5pc0NvbG9yICkgewoKCQkJCWRhdGEudW5pZm9ybXNbIG5hbWUgXSA9IHsKCQkJCQl0eXBlOiAnYycsCgkJCQkJdmFsdWU6IHZhbHVlLmdldEhleCgpCgkJCQl9OwoKCQkJfSBlbHNlIGlmICggdmFsdWUgJiYgdmFsdWUuaXNWZWN0b3IyICkgewoKCQkJCWRhdGEudW5pZm9ybXNbIG5hbWUgXSA9IHsKCQkJCQl0eXBlOiAndjInLAoJCQkJCXZhbHVlOiB2YWx1ZS50b0FycmF5KCkKCQkJCX07CgoJCQl9IGVsc2UgaWYgKCB2YWx1ZSAmJiB2YWx1ZS5pc1ZlY3RvcjMgKSB7CgoJCQkJZGF0YS51bmlmb3Jtc1sgbmFtZSBdID0gewoJCQkJCXR5cGU6ICd2MycsCgkJCQkJdmFsdWU6IHZhbHVlLnRvQXJyYXkoKQoJCQkJfTsKCgkJCX0gZWxzZSBpZiAoIHZhbHVlICYmIHZhbHVlLmlzVmVjdG9yNCApIHsKCgkJCQlkYXRhLnVuaWZvcm1zWyBuYW1lIF0gPSB7CgkJCQkJdHlwZTogJ3Y0JywKCQkJCQl2YWx1ZTogdmFsdWUudG9BcnJheSgpCgkJCQl9OwoKCQkJfSBlbHNlIGlmICggdmFsdWUgJiYgdmFsdWUuaXNNYXRyaXgzICkgewoKCQkJCWRhdGEudW5pZm9ybXNbIG5hbWUgXSA9IHsKCQkJCQl0eXBlOiAnbTMnLAoJCQkJCXZhbHVlOiB2YWx1ZS50b0FycmF5KCkKCQkJCX07CgoJCQl9IGVsc2UgaWYgKCB2YWx1ZSAmJiB2YWx1ZS5pc01hdHJpeDQgKSB7CgoJCQkJZGF0YS51bmlmb3Jtc1sgbmFtZSBdID0gewoJCQkJCXR5cGU6ICdtNCcsCgkJCQkJdmFsdWU6IHZhbHVlLnRvQXJyYXkoKQoJCQkJfTsKCgkJCX0gZWxzZSB7CgoJCQkJZGF0YS51bmlmb3Jtc1sgbmFtZSBdID0gewoJCQkJCXZhbHVlOiB2YWx1ZQoJCQkJfTsKCgkJCQkvLyBub3RlOiB0aGUgYXJyYXkgdmFyaWFudHMgdjJ2LCB2M3YsIHY0diwgbTR2IGFuZCB0diBhcmUgbm90IHN1cHBvcnRlZCBzbyBmYXIKCgkJCX0KCgkJfQoKCQlpZiAoIE9iamVjdC5rZXlzKCB0aGlzLmRlZmluZXMgKS5sZW5ndGggPiAwICkgZGF0YS5kZWZpbmVzID0gdGhpcy5kZWZpbmVzOwoKCQlkYXRhLnZlcnRleFNoYWRlciA9IHRoaXMudmVydGV4U2hhZGVyOwoJCWRhdGEuZnJhZ21lbnRTaGFkZXIgPSB0aGlzLmZyYWdtZW50U2hhZGVyOwoKCQlkYXRhLmxpZ2h0cyA9IHRoaXMubGlnaHRzOwoJCWRhdGEuY2xpcHBpbmcgPSB0aGlzLmNsaXBwaW5nOwoKCQljb25zdCBleHRlbnNpb25zID0ge307CgoJCWZvciAoIGNvbnN0IGtleSBpbiB0aGlzLmV4dGVuc2lvbnMgKSB7CgoJCQlpZiAoIHRoaXMuZXh0ZW5zaW9uc1sga2V5IF0gPT09IHRydWUgKSBleHRlbnNpb25zWyBrZXkgXSA9IHRydWU7CgoJCX0KCgkJaWYgKCBPYmplY3Qua2V5cyggZXh0ZW5zaW9ucyApLmxlbmd0aCA+IDAgKSBkYXRhLmV4dGVuc2lvbnMgPSBleHRlbnNpb25zOwoKCQlyZXR1cm4gZGF0YTsKCgl9Cgp9CgpjbGFzcyBDYW1lcmEgZXh0ZW5kcyBPYmplY3QzRCB7CgoJY29uc3RydWN0b3IoKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNDYW1lcmEgPSB0cnVlOwoKCQl0aGlzLnR5cGUgPSAnQ2FtZXJhJzsKCgkJdGhpcy5tYXRyaXhXb3JsZEludmVyc2UgPSBuZXcgTWF0cml4NCgpOwoKCQl0aGlzLnByb2plY3Rpb25NYXRyaXggPSBuZXcgTWF0cml4NCgpOwoJCXRoaXMucHJvamVjdGlvbk1hdHJpeEludmVyc2UgPSBuZXcgTWF0cml4NCgpOwoKCQl0aGlzLmNvb3JkaW5hdGVTeXN0ZW0gPSBXZWJHTENvb3JkaW5hdGVTeXN0ZW07CgoJfQoKCWNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApOwoKCQl0aGlzLm1hdHJpeFdvcmxkSW52ZXJzZS5jb3B5KCBzb3VyY2UubWF0cml4V29ybGRJbnZlcnNlICk7CgoJCXRoaXMucHJvamVjdGlvbk1hdHJpeC5jb3B5KCBzb3VyY2UucHJvamVjdGlvbk1hdHJpeCApOwoJCXRoaXMucHJvamVjdGlvbk1hdHJpeEludmVyc2UuY29weSggc291cmNlLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlICk7CgoJCXRoaXMuY29vcmRpbmF0ZVN5c3RlbSA9IHNvdXJjZS5jb29yZGluYXRlU3lzdGVtOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0V29ybGREaXJlY3Rpb24oIHRhcmdldCApIHsKCgkJcmV0dXJuIHN1cGVyLmdldFdvcmxkRGlyZWN0aW9uKCB0YXJnZXQgKS5uZWdhdGUoKTsKCgl9CgoJdXBkYXRlTWF0cml4V29ybGQoIGZvcmNlICkgewoKCQlzdXBlci51cGRhdGVNYXRyaXhXb3JsZCggZm9yY2UgKTsKCgkJdGhpcy5tYXRyaXhXb3JsZEludmVyc2UuY29weSggdGhpcy5tYXRyaXhXb3JsZCApLmludmVydCgpOwoKCX0KCgl1cGRhdGVXb3JsZE1hdHJpeCggdXBkYXRlUGFyZW50cywgdXBkYXRlQ2hpbGRyZW4gKSB7CgoJCXN1cGVyLnVwZGF0ZVdvcmxkTWF0cml4KCB1cGRhdGVQYXJlbnRzLCB1cGRhdGVDaGlsZHJlbiApOwoKCQl0aGlzLm1hdHJpeFdvcmxkSW52ZXJzZS5jb3B5KCB0aGlzLm1hdHJpeFdvcmxkICkuaW52ZXJ0KCk7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KCB0aGlzICk7CgoJfQoKfQoKY29uc3QgX3YzJDEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9taW5UYXJnZXQgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCk7CmNvbnN0IF9tYXhUYXJnZXQgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCk7CgoKY2xhc3MgUGVyc3BlY3RpdmVDYW1lcmEgZXh0ZW5kcyBDYW1lcmEgewoKCWNvbnN0cnVjdG9yKCBmb3YgPSA1MCwgYXNwZWN0ID0gMSwgbmVhciA9IDAuMSwgZmFyID0gMjAwMCApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc1BlcnNwZWN0aXZlQ2FtZXJhID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ1BlcnNwZWN0aXZlQ2FtZXJhJzsKCgkJdGhpcy5mb3YgPSBmb3Y7CgkJdGhpcy56b29tID0gMTsKCgkJdGhpcy5uZWFyID0gbmVhcjsKCQl0aGlzLmZhciA9IGZhcjsKCQl0aGlzLmZvY3VzID0gMTA7CgoJCXRoaXMuYXNwZWN0ID0gYXNwZWN0OwoJCXRoaXMudmlldyA9IG51bGw7CgoJCXRoaXMuZmlsbUdhdWdlID0gMzU7CS8vIHdpZHRoIG9mIHRoZSBmaWxtIChkZWZhdWx0IGluIG1pbGxpbWV0ZXJzKQoJCXRoaXMuZmlsbU9mZnNldCA9IDA7CS8vIGhvcml6b250YWwgZmlsbSBvZmZzZXQgKHNhbWUgdW5pdCBhcyBnYXVnZSkKCgkJdGhpcy51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgoJfQoKCWNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApOwoKCQl0aGlzLmZvdiA9IHNvdXJjZS5mb3Y7CgkJdGhpcy56b29tID0gc291cmNlLnpvb207CgoJCXRoaXMubmVhciA9IHNvdXJjZS5uZWFyOwoJCXRoaXMuZmFyID0gc291cmNlLmZhcjsKCQl0aGlzLmZvY3VzID0gc291cmNlLmZvY3VzOwoKCQl0aGlzLmFzcGVjdCA9IHNvdXJjZS5hc3BlY3Q7CgkJdGhpcy52aWV3ID0gc291cmNlLnZpZXcgPT09IG51bGwgPyBudWxsIDogT2JqZWN0LmFzc2lnbigge30sIHNvdXJjZS52aWV3ICk7CgoJCXRoaXMuZmlsbUdhdWdlID0gc291cmNlLmZpbG1HYXVnZTsKCQl0aGlzLmZpbG1PZmZzZXQgPSBzb3VyY2UuZmlsbU9mZnNldDsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCS8qKgoJICogU2V0cyB0aGUgRk9WIGJ5IGZvY2FsIGxlbmd0aCBpbiByZXNwZWN0IHRvIHRoZSBjdXJyZW50IC5maWxtR2F1Z2UuCgkgKgoJICogVGhlIGRlZmF1bHQgZmlsbSBnYXVnZSBpcyAzNSwgc28gdGhhdCB0aGUgZm9jYWwgbGVuZ3RoIGNhbiBiZSBzcGVjaWZpZWQgZm9yCgkgKiBhIDM1bW0gKGZ1bGwgZnJhbWUpIGNhbWVyYS4KCSAqCgkgKiBWYWx1ZXMgZm9yIGZvY2FsIGxlbmd0aCBhbmQgZmlsbSBnYXVnZSBtdXN0IGhhdmUgdGhlIHNhbWUgdW5pdC4KCSAqLwoJc2V0Rm9jYWxMZW5ndGgoIGZvY2FsTGVuZ3RoICkgewoKCQkvKiogc2VlIHtAbGluayBodHRwOi8vd3d3LmJvYmF0a2lucy5jb20vcGhvdG9ncmFwaHkvdGVjaG5pY2FsL2ZpZWxkX29mX3ZpZXcuaHRtbH0gKi8KCQljb25zdCB2RXh0ZW50U2xvcGUgPSAwLjUgKiB0aGlzLmdldEZpbG1IZWlnaHQoKSAvIGZvY2FsTGVuZ3RoOwoKCQl0aGlzLmZvdiA9IFJBRDJERUcgKiAyICogTWF0aC5hdGFuKCB2RXh0ZW50U2xvcGUgKTsKCQl0aGlzLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKCgl9CgoJLyoqCgkgKiBDYWxjdWxhdGVzIHRoZSBmb2NhbCBsZW5ndGggZnJvbSB0aGUgY3VycmVudCAuZm92IGFuZCAuZmlsbUdhdWdlLgoJICovCglnZXRGb2NhbExlbmd0aCgpIHsKCgkJY29uc3QgdkV4dGVudFNsb3BlID0gTWF0aC50YW4oIERFRzJSQUQgKiAwLjUgKiB0aGlzLmZvdiApOwoKCQlyZXR1cm4gMC41ICogdGhpcy5nZXRGaWxtSGVpZ2h0KCkgLyB2RXh0ZW50U2xvcGU7CgoJfQoKCWdldEVmZmVjdGl2ZUZPVigpIHsKCgkJcmV0dXJuIFJBRDJERUcgKiAyICogTWF0aC5hdGFuKAoJCQlNYXRoLnRhbiggREVHMlJBRCAqIDAuNSAqIHRoaXMuZm92ICkgLyB0aGlzLnpvb20gKTsKCgl9CgoJZ2V0RmlsbVdpZHRoKCkgewoKCQkvLyBmaWxtIG5vdCBjb21wbGV0ZWx5IGNvdmVyZWQgaW4gcG9ydHJhaXQgZm9ybWF0IChhc3BlY3QgPCAxKQoJCXJldHVybiB0aGlzLmZpbG1HYXVnZSAqIE1hdGgubWluKCB0aGlzLmFzcGVjdCwgMSApOwoKCX0KCglnZXRGaWxtSGVpZ2h0KCkgewoKCQkvLyBmaWxtIG5vdCBjb21wbGV0ZWx5IGNvdmVyZWQgaW4gbGFuZHNjYXBlIGZvcm1hdCAoYXNwZWN0ID4gMSkKCQlyZXR1cm4gdGhpcy5maWxtR2F1Z2UgLyBNYXRoLm1heCggdGhpcy5hc3BlY3QsIDEgKTsKCgl9CgoJLyoqCgkgKiBDb21wdXRlcyB0aGUgMkQgYm91bmRzIG9mIHRoZSBjYW1lcmEncyB2aWV3YWJsZSByZWN0YW5nbGUgYXQgYSBnaXZlbiBkaXN0YW5jZSBhbG9uZyB0aGUgdmlld2luZyBkaXJlY3Rpb24uCgkgKiBTZXRzIG1pblRhcmdldCBhbmQgbWF4VGFyZ2V0IHRvIHRoZSBjb29yZGluYXRlcyBvZiB0aGUgbG93ZXItbGVmdCBhbmQgdXBwZXItcmlnaHQgY29ybmVycyBvZiB0aGUgdmlldyByZWN0YW5nbGUuCgkgKi8KCWdldFZpZXdCb3VuZHMoIGRpc3RhbmNlLCBtaW5UYXJnZXQsIG1heFRhcmdldCApIHsKCgkJX3YzJDEuc2V0KCAtIDEsIC0gMSwgMC41ICkuYXBwbHlNYXRyaXg0KCB0aGlzLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlICk7CgoJCW1pblRhcmdldC5zZXQoIF92MyQxLngsIF92MyQxLnkgKS5tdWx0aXBseVNjYWxhciggLSBkaXN0YW5jZSAvIF92MyQxLnogKTsKCgkJX3YzJDEuc2V0KCAxLCAxLCAwLjUgKS5hcHBseU1hdHJpeDQoIHRoaXMucHJvamVjdGlvbk1hdHJpeEludmVyc2UgKTsKCgkJbWF4VGFyZ2V0LnNldCggX3YzJDEueCwgX3YzJDEueSApLm11bHRpcGx5U2NhbGFyKCAtIGRpc3RhbmNlIC8gX3YzJDEueiApOwoKCX0KCgkvKioKCSAqIENvbXB1dGVzIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBjYW1lcmEncyB2aWV3YWJsZSByZWN0YW5nbGUgYXQgYSBnaXZlbiBkaXN0YW5jZSBhbG9uZyB0aGUgdmlld2luZyBkaXJlY3Rpb24uCgkgKiBDb3BpZXMgdGhlIHJlc3VsdCBpbnRvIHRoZSB0YXJnZXQgVmVjdG9yMiwgd2hlcmUgeCBpcyB3aWR0aCBhbmQgeSBpcyBoZWlnaHQuCgkgKi8KCWdldFZpZXdTaXplKCBkaXN0YW5jZSwgdGFyZ2V0ICkgewoKCQl0aGlzLmdldFZpZXdCb3VuZHMoIGRpc3RhbmNlLCBfbWluVGFyZ2V0LCBfbWF4VGFyZ2V0ICk7CgoJCXJldHVybiB0YXJnZXQuc3ViVmVjdG9ycyggX21heFRhcmdldCwgX21pblRhcmdldCApOwoKCX0KCgkvKioKCSAqIFNldHMgYW4gb2Zmc2V0IGluIGEgbGFyZ2VyIGZydXN0dW0uIFRoaXMgaXMgdXNlZnVsIGZvciBtdWx0aS13aW5kb3cgb3IKCSAqIG11bHRpLW1vbml0b3IvbXVsdGktbWFjaGluZSBzZXR1cHMuCgkgKgoJICogRm9yIGV4YW1wbGUsIGlmIHlvdSBoYXZlIDN4MiBtb25pdG9ycyBhbmQgZWFjaCBtb25pdG9yIGlzIDE5MjB4MTA4MCBhbmQKCSAqIHRoZSBtb25pdG9ycyBhcmUgaW4gZ3JpZCBsaWtlIHRoaXMKCSAqCgkgKiAgICstLS0rLS0tKy0tLSsKCSAqICAgfCBBIHwgQiB8IEMgfAoJICogICArLS0tKy0tLSstLS0rCgkgKiAgIHwgRCB8IEUgfCBGIHwKCSAqICAgKy0tLSstLS0rLS0tKwoJICoKCSAqIHRoZW4gZm9yIGVhY2ggbW9uaXRvciB5b3Ugd291bGQgY2FsbCBpdCBsaWtlIHRoaXMKCSAqCgkgKiAgIGNvbnN0IHcgPSAxOTIwOwoJICogICBjb25zdCBoID0gMTA4MDsKCSAqICAgY29uc3QgZnVsbFdpZHRoID0gdyAqIDM7CgkgKiAgIGNvbnN0IGZ1bGxIZWlnaHQgPSBoICogMjsKCSAqCgkgKiAgIC0tQS0tCgkgKiAgIGNhbWVyYS5zZXRWaWV3T2Zmc2V0KCBmdWxsV2lkdGgsIGZ1bGxIZWlnaHQsIHcgKiAwLCBoICogMCwgdywgaCApOwoJICogICAtLUItLQoJICogICBjYW1lcmEuc2V0Vmlld09mZnNldCggZnVsbFdpZHRoLCBmdWxsSGVpZ2h0LCB3ICogMSwgaCAqIDAsIHcsIGggKTsKCSAqICAgLS1DLS0KCSAqICAgY2FtZXJhLnNldFZpZXdPZmZzZXQoIGZ1bGxXaWR0aCwgZnVsbEhlaWdodCwgdyAqIDIsIGggKiAwLCB3LCBoICk7CgkgKiAgIC0tRC0tCgkgKiAgIGNhbWVyYS5zZXRWaWV3T2Zmc2V0KCBmdWxsV2lkdGgsIGZ1bGxIZWlnaHQsIHcgKiAwLCBoICogMSwgdywgaCApOwoJICogICAtLUUtLQoJICogICBjYW1lcmEuc2V0Vmlld09mZnNldCggZnVsbFdpZHRoLCBmdWxsSGVpZ2h0LCB3ICogMSwgaCAqIDEsIHcsIGggKTsKCSAqICAgLS1GLS0KCSAqICAgY2FtZXJhLnNldFZpZXdPZmZzZXQoIGZ1bGxXaWR0aCwgZnVsbEhlaWdodCwgdyAqIDIsIGggKiAxLCB3LCBoICk7CgkgKgoJICogICBOb3RlIHRoZXJlIGlzIG5vIHJlYXNvbiBtb25pdG9ycyBoYXZlIHRvIGJlIHRoZSBzYW1lIHNpemUgb3IgaW4gYSBncmlkLgoJICovCglzZXRWaWV3T2Zmc2V0KCBmdWxsV2lkdGgsIGZ1bGxIZWlnaHQsIHgsIHksIHdpZHRoLCBoZWlnaHQgKSB7CgoJCXRoaXMuYXNwZWN0ID0gZnVsbFdpZHRoIC8gZnVsbEhlaWdodDsKCgkJaWYgKCB0aGlzLnZpZXcgPT09IG51bGwgKSB7CgoJCQl0aGlzLnZpZXcgPSB7CgkJCQllbmFibGVkOiB0cnVlLAoJCQkJZnVsbFdpZHRoOiAxLAoJCQkJZnVsbEhlaWdodDogMSwKCQkJCW9mZnNldFg6IDAsCgkJCQlvZmZzZXRZOiAwLAoJCQkJd2lkdGg6IDEsCgkJCQloZWlnaHQ6IDEKCQkJfTsKCgkJfQoKCQl0aGlzLnZpZXcuZW5hYmxlZCA9IHRydWU7CgkJdGhpcy52aWV3LmZ1bGxXaWR0aCA9IGZ1bGxXaWR0aDsKCQl0aGlzLnZpZXcuZnVsbEhlaWdodCA9IGZ1bGxIZWlnaHQ7CgkJdGhpcy52aWV3Lm9mZnNldFggPSB4OwoJCXRoaXMudmlldy5vZmZzZXRZID0geTsKCQl0aGlzLnZpZXcud2lkdGggPSB3aWR0aDsKCQl0aGlzLnZpZXcuaGVpZ2h0ID0gaGVpZ2h0OwoKCQl0aGlzLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKCgl9CgoJY2xlYXJWaWV3T2Zmc2V0KCkgewoKCQlpZiAoIHRoaXMudmlldyAhPT0gbnVsbCApIHsKCgkJCXRoaXMudmlldy5lbmFibGVkID0gZmFsc2U7CgoJCX0KCgkJdGhpcy51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgoJfQoKCXVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKSB7CgoJCWNvbnN0IG5lYXIgPSB0aGlzLm5lYXI7CgkJbGV0IHRvcCA9IG5lYXIgKiBNYXRoLnRhbiggREVHMlJBRCAqIDAuNSAqIHRoaXMuZm92ICkgLyB0aGlzLnpvb207CgkJbGV0IGhlaWdodCA9IDIgKiB0b3A7CgkJbGV0IHdpZHRoID0gdGhpcy5hc3BlY3QgKiBoZWlnaHQ7CgkJbGV0IGxlZnQgPSAtIDAuNSAqIHdpZHRoOwoJCWNvbnN0IHZpZXcgPSB0aGlzLnZpZXc7CgoJCWlmICggdGhpcy52aWV3ICE9PSBudWxsICYmIHRoaXMudmlldy5lbmFibGVkICkgewoKCQkJY29uc3QgZnVsbFdpZHRoID0gdmlldy5mdWxsV2lkdGgsCgkJCQlmdWxsSGVpZ2h0ID0gdmlldy5mdWxsSGVpZ2h0OwoKCQkJbGVmdCArPSB2aWV3Lm9mZnNldFggKiB3aWR0aCAvIGZ1bGxXaWR0aDsKCQkJdG9wIC09IHZpZXcub2Zmc2V0WSAqIGhlaWdodCAvIGZ1bGxIZWlnaHQ7CgkJCXdpZHRoICo9IHZpZXcud2lkdGggLyBmdWxsV2lkdGg7CgkJCWhlaWdodCAqPSB2aWV3LmhlaWdodCAvIGZ1bGxIZWlnaHQ7CgoJCX0KCgkJY29uc3Qgc2tldyA9IHRoaXMuZmlsbU9mZnNldDsKCQlpZiAoIHNrZXcgIT09IDAgKSBsZWZ0ICs9IG5lYXIgKiBza2V3IC8gdGhpcy5nZXRGaWxtV2lkdGgoKTsKCgkJdGhpcy5wcm9qZWN0aW9uTWF0cml4Lm1ha2VQZXJzcGVjdGl2ZSggbGVmdCwgbGVmdCArIHdpZHRoLCB0b3AsIHRvcCAtIGhlaWdodCwgbmVhciwgdGhpcy5mYXIsIHRoaXMuY29vcmRpbmF0ZVN5c3RlbSApOwoKCQl0aGlzLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlLmNvcHkoIHRoaXMucHJvamVjdGlvbk1hdHJpeCApLmludmVydCgpOwoKCX0KCgl0b0pTT04oIG1ldGEgKSB7CgoJCWNvbnN0IGRhdGEgPSBzdXBlci50b0pTT04oIG1ldGEgKTsKCgkJZGF0YS5vYmplY3QuZm92ID0gdGhpcy5mb3Y7CgkJZGF0YS5vYmplY3Quem9vbSA9IHRoaXMuem9vbTsKCgkJZGF0YS5vYmplY3QubmVhciA9IHRoaXMubmVhcjsKCQlkYXRhLm9iamVjdC5mYXIgPSB0aGlzLmZhcjsKCQlkYXRhLm9iamVjdC5mb2N1cyA9IHRoaXMuZm9jdXM7CgoJCWRhdGEub2JqZWN0LmFzcGVjdCA9IHRoaXMuYXNwZWN0OwoKCQlpZiAoIHRoaXMudmlldyAhPT0gbnVsbCApIGRhdGEub2JqZWN0LnZpZXcgPSBPYmplY3QuYXNzaWduKCB7fSwgdGhpcy52aWV3ICk7CgoJCWRhdGEub2JqZWN0LmZpbG1HYXVnZSA9IHRoaXMuZmlsbUdhdWdlOwoJCWRhdGEub2JqZWN0LmZpbG1PZmZzZXQgPSB0aGlzLmZpbG1PZmZzZXQ7CgoJCXJldHVybiBkYXRhOwoKCX0KCn0KCmNvbnN0IGZvdiA9IC0gOTA7IC8vIG5lZ2F0aXZlIGZvdiBpcyBub3QgYW4gZXJyb3IKY29uc3QgYXNwZWN0ID0gMTsKCmNsYXNzIEN1YmVDYW1lcmEgZXh0ZW5kcyBPYmplY3QzRCB7CgoJY29uc3RydWN0b3IoIG5lYXIsIGZhciwgcmVuZGVyVGFyZ2V0ICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnQ3ViZUNhbWVyYSc7CgoJCXRoaXMucmVuZGVyVGFyZ2V0ID0gcmVuZGVyVGFyZ2V0OwoJCXRoaXMuY29vcmRpbmF0ZVN5c3RlbSA9IG51bGw7CgkJdGhpcy5hY3RpdmVNaXBtYXBMZXZlbCA9IDA7CgoJCWNvbnN0IGNhbWVyYVBYID0gbmV3IFBlcnNwZWN0aXZlQ2FtZXJhKCBmb3YsIGFzcGVjdCwgbmVhciwgZmFyICk7CgkJY2FtZXJhUFgubGF5ZXJzID0gdGhpcy5sYXllcnM7CgkJdGhpcy5hZGQoIGNhbWVyYVBYICk7CgoJCWNvbnN0IGNhbWVyYU5YID0gbmV3IFBlcnNwZWN0aXZlQ2FtZXJhKCBmb3YsIGFzcGVjdCwgbmVhciwgZmFyICk7CgkJY2FtZXJhTlgubGF5ZXJzID0gdGhpcy5sYXllcnM7CgkJdGhpcy5hZGQoIGNhbWVyYU5YICk7CgoJCWNvbnN0IGNhbWVyYVBZID0gbmV3IFBlcnNwZWN0aXZlQ2FtZXJhKCBmb3YsIGFzcGVjdCwgbmVhciwgZmFyICk7CgkJY2FtZXJhUFkubGF5ZXJzID0gdGhpcy5sYXllcnM7CgkJdGhpcy5hZGQoIGNhbWVyYVBZICk7CgoJCWNvbnN0IGNhbWVyYU5ZID0gbmV3IFBlcnNwZWN0aXZlQ2FtZXJhKCBmb3YsIGFzcGVjdCwgbmVhciwgZmFyICk7CgkJY2FtZXJhTlkubGF5ZXJzID0gdGhpcy5sYXllcnM7CgkJdGhpcy5hZGQoIGNhbWVyYU5ZICk7CgoJCWNvbnN0IGNhbWVyYVBaID0gbmV3IFBlcnNwZWN0aXZlQ2FtZXJhKCBmb3YsIGFzcGVjdCwgbmVhciwgZmFyICk7CgkJY2FtZXJhUFoubGF5ZXJzID0gdGhpcy5sYXllcnM7CgkJdGhpcy5hZGQoIGNhbWVyYVBaICk7CgoJCWNvbnN0IGNhbWVyYU5aID0gbmV3IFBlcnNwZWN0aXZlQ2FtZXJhKCBmb3YsIGFzcGVjdCwgbmVhciwgZmFyICk7CgkJY2FtZXJhTloubGF5ZXJzID0gdGhpcy5sYXllcnM7CgkJdGhpcy5hZGQoIGNhbWVyYU5aICk7CgoJfQoKCXVwZGF0ZUNvb3JkaW5hdGVTeXN0ZW0oKSB7CgoJCWNvbnN0IGNvb3JkaW5hdGVTeXN0ZW0gPSB0aGlzLmNvb3JkaW5hdGVTeXN0ZW07CgoJCWNvbnN0IGNhbWVyYXMgPSB0aGlzLmNoaWxkcmVuLmNvbmNhdCgpOwoKCQljb25zdCBbIGNhbWVyYVBYLCBjYW1lcmFOWCwgY2FtZXJhUFksIGNhbWVyYU5ZLCBjYW1lcmFQWiwgY2FtZXJhTlogXSA9IGNhbWVyYXM7CgoJCWZvciAoIGNvbnN0IGNhbWVyYSBvZiBjYW1lcmFzICkgdGhpcy5yZW1vdmUoIGNhbWVyYSApOwoKCQlpZiAoIGNvb3JkaW5hdGVTeXN0ZW0gPT09IFdlYkdMQ29vcmRpbmF0ZVN5c3RlbSApIHsKCgkJCWNhbWVyYVBYLnVwLnNldCggMCwgMSwgMCApOwoJCQljYW1lcmFQWC5sb29rQXQoIDEsIDAsIDAgKTsKCgkJCWNhbWVyYU5YLnVwLnNldCggMCwgMSwgMCApOwoJCQljYW1lcmFOWC5sb29rQXQoIC0gMSwgMCwgMCApOwoKCQkJY2FtZXJhUFkudXAuc2V0KCAwLCAwLCAtIDEgKTsKCQkJY2FtZXJhUFkubG9va0F0KCAwLCAxLCAwICk7CgoJCQljYW1lcmFOWS51cC5zZXQoIDAsIDAsIDEgKTsKCQkJY2FtZXJhTlkubG9va0F0KCAwLCAtIDEsIDAgKTsKCgkJCWNhbWVyYVBaLnVwLnNldCggMCwgMSwgMCApOwoJCQljYW1lcmFQWi5sb29rQXQoIDAsIDAsIDEgKTsKCgkJCWNhbWVyYU5aLnVwLnNldCggMCwgMSwgMCApOwoJCQljYW1lcmFOWi5sb29rQXQoIDAsIDAsIC0gMSApOwoKCQl9IGVsc2UgaWYgKCBjb29yZGluYXRlU3lzdGVtID09PSBXZWJHUFVDb29yZGluYXRlU3lzdGVtICkgewoKCQkJY2FtZXJhUFgudXAuc2V0KCAwLCAtIDEsIDAgKTsKCQkJY2FtZXJhUFgubG9va0F0KCAtIDEsIDAsIDAgKTsKCgkJCWNhbWVyYU5YLnVwLnNldCggMCwgLSAxLCAwICk7CgkJCWNhbWVyYU5YLmxvb2tBdCggMSwgMCwgMCApOwoKCQkJY2FtZXJhUFkudXAuc2V0KCAwLCAwLCAxICk7CgkJCWNhbWVyYVBZLmxvb2tBdCggMCwgMSwgMCApOwoKCQkJY2FtZXJhTlkudXAuc2V0KCAwLCAwLCAtIDEgKTsKCQkJY2FtZXJhTlkubG9va0F0KCAwLCAtIDEsIDAgKTsKCgkJCWNhbWVyYVBaLnVwLnNldCggMCwgLSAxLCAwICk7CgkJCWNhbWVyYVBaLmxvb2tBdCggMCwgMCwgMSApOwoKCQkJY2FtZXJhTloudXAuc2V0KCAwLCAtIDEsIDAgKTsKCQkJY2FtZXJhTloubG9va0F0KCAwLCAwLCAtIDEgKTsKCgkJfSBlbHNlIHsKCgkJCXRocm93IG5ldyBFcnJvciggJ1RIUkVFLkN1YmVDYW1lcmEudXBkYXRlQ29vcmRpbmF0ZVN5c3RlbSgpOiBJbnZhbGlkIGNvb3JkaW5hdGUgc3lzdGVtOiAnICsgY29vcmRpbmF0ZVN5c3RlbSApOwoKCQl9CgoJCWZvciAoIGNvbnN0IGNhbWVyYSBvZiBjYW1lcmFzICkgewoKCQkJdGhpcy5hZGQoIGNhbWVyYSApOwoKCQkJY2FtZXJhLnVwZGF0ZU1hdHJpeFdvcmxkKCk7CgoJCX0KCgl9CgoJdXBkYXRlKCByZW5kZXJlciwgc2NlbmUgKSB7CgoJCWlmICggdGhpcy5wYXJlbnQgPT09IG51bGwgKSB0aGlzLnVwZGF0ZU1hdHJpeFdvcmxkKCk7CgoJCWNvbnN0IHsgcmVuZGVyVGFyZ2V0LCBhY3RpdmVNaXBtYXBMZXZlbCB9ID0gdGhpczsKCgkJaWYgKCB0aGlzLmNvb3JkaW5hdGVTeXN0ZW0gIT09IHJlbmRlcmVyLmNvb3JkaW5hdGVTeXN0ZW0gKSB7CgoJCQl0aGlzLmNvb3JkaW5hdGVTeXN0ZW0gPSByZW5kZXJlci5jb29yZGluYXRlU3lzdGVtOwoKCQkJdGhpcy51cGRhdGVDb29yZGluYXRlU3lzdGVtKCk7CgoJCX0KCgkJY29uc3QgWyBjYW1lcmFQWCwgY2FtZXJhTlgsIGNhbWVyYVBZLCBjYW1lcmFOWSwgY2FtZXJhUFosIGNhbWVyYU5aIF0gPSB0aGlzLmNoaWxkcmVuOwoKCQljb25zdCBjdXJyZW50UmVuZGVyVGFyZ2V0ID0gcmVuZGVyZXIuZ2V0UmVuZGVyVGFyZ2V0KCk7CgkJY29uc3QgY3VycmVudEFjdGl2ZUN1YmVGYWNlID0gcmVuZGVyZXIuZ2V0QWN0aXZlQ3ViZUZhY2UoKTsKCQljb25zdCBjdXJyZW50QWN0aXZlTWlwbWFwTGV2ZWwgPSByZW5kZXJlci5nZXRBY3RpdmVNaXBtYXBMZXZlbCgpOwoKCQljb25zdCBjdXJyZW50WHJFbmFibGVkID0gcmVuZGVyZXIueHIuZW5hYmxlZDsKCgkJcmVuZGVyZXIueHIuZW5hYmxlZCA9IGZhbHNlOwoKCQljb25zdCBnZW5lcmF0ZU1pcG1hcHMgPSByZW5kZXJUYXJnZXQudGV4dHVyZS5nZW5lcmF0ZU1pcG1hcHM7CgoJCXJlbmRlclRhcmdldC50ZXh0dXJlLmdlbmVyYXRlTWlwbWFwcyA9IGZhbHNlOwoKCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIHJlbmRlclRhcmdldCwgMCwgYWN0aXZlTWlwbWFwTGV2ZWwgKTsKCQlyZW5kZXJlci5yZW5kZXIoIHNjZW5lLCBjYW1lcmFQWCApOwoKCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIHJlbmRlclRhcmdldCwgMSwgYWN0aXZlTWlwbWFwTGV2ZWwgKTsKCQlyZW5kZXJlci5yZW5kZXIoIHNjZW5lLCBjYW1lcmFOWCApOwoKCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIHJlbmRlclRhcmdldCwgMiwgYWN0aXZlTWlwbWFwTGV2ZWwgKTsKCQlyZW5kZXJlci5yZW5kZXIoIHNjZW5lLCBjYW1lcmFQWSApOwoKCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIHJlbmRlclRhcmdldCwgMywgYWN0aXZlTWlwbWFwTGV2ZWwgKTsKCQlyZW5kZXJlci5yZW5kZXIoIHNjZW5lLCBjYW1lcmFOWSApOwoKCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIHJlbmRlclRhcmdldCwgNCwgYWN0aXZlTWlwbWFwTGV2ZWwgKTsKCQlyZW5kZXJlci5yZW5kZXIoIHNjZW5lLCBjYW1lcmFQWiApOwoKCQkvLyBtaXBtYXBzIGFyZSBnZW5lcmF0ZWQgZHVyaW5nIHRoZSBsYXN0IGNhbGwgb2YgcmVuZGVyKCkKCQkvLyBhdCB0aGlzIHBvaW50LCBhbGwgc2lkZXMgb2YgdGhlIGN1YmUgcmVuZGVyIHRhcmdldCBhcmUgZGVmaW5lZAoKCQlyZW5kZXJUYXJnZXQudGV4dHVyZS5nZW5lcmF0ZU1pcG1hcHMgPSBnZW5lcmF0ZU1pcG1hcHM7CgoJCXJlbmRlcmVyLnNldFJlbmRlclRhcmdldCggcmVuZGVyVGFyZ2V0LCA1LCBhY3RpdmVNaXBtYXBMZXZlbCApOwoJCXJlbmRlcmVyLnJlbmRlciggc2NlbmUsIGNhbWVyYU5aICk7CgoJCXJlbmRlcmVyLnNldFJlbmRlclRhcmdldCggY3VycmVudFJlbmRlclRhcmdldCwgY3VycmVudEFjdGl2ZUN1YmVGYWNlLCBjdXJyZW50QWN0aXZlTWlwbWFwTGV2ZWwgKTsKCgkJcmVuZGVyZXIueHIuZW5hYmxlZCA9IGN1cnJlbnRYckVuYWJsZWQ7CgoJCXJlbmRlclRhcmdldC50ZXh0dXJlLm5lZWRzUE1SRU1VcGRhdGUgPSB0cnVlOwoKCX0KCn0KCmNsYXNzIEN1YmVUZXh0dXJlIGV4dGVuZHMgVGV4dHVyZSB7CgoJY29uc3RydWN0b3IoIGltYWdlcywgbWFwcGluZywgd3JhcFMsIHdyYXBULCBtYWdGaWx0ZXIsIG1pbkZpbHRlciwgZm9ybWF0LCB0eXBlLCBhbmlzb3Ryb3B5LCBjb2xvclNwYWNlICkgewoKCQlpbWFnZXMgPSBpbWFnZXMgIT09IHVuZGVmaW5lZCA/IGltYWdlcyA6IFtdOwoJCW1hcHBpbmcgPSBtYXBwaW5nICE9PSB1bmRlZmluZWQgPyBtYXBwaW5nIDogQ3ViZVJlZmxlY3Rpb25NYXBwaW5nOwoKCQlzdXBlciggaW1hZ2VzLCBtYXBwaW5nLCB3cmFwUywgd3JhcFQsIG1hZ0ZpbHRlciwgbWluRmlsdGVyLCBmb3JtYXQsIHR5cGUsIGFuaXNvdHJvcHksIGNvbG9yU3BhY2UgKTsKCgkJdGhpcy5pc0N1YmVUZXh0dXJlID0gdHJ1ZTsKCgkJdGhpcy5mbGlwWSA9IGZhbHNlOwoKCX0KCglnZXQgaW1hZ2VzKCkgewoKCQlyZXR1cm4gdGhpcy5pbWFnZTsKCgl9CgoJc2V0IGltYWdlcyggdmFsdWUgKSB7CgoJCXRoaXMuaW1hZ2UgPSB2YWx1ZTsKCgl9Cgp9CgpjbGFzcyBXZWJHTEN1YmVSZW5kZXJUYXJnZXQgZXh0ZW5kcyBXZWJHTFJlbmRlclRhcmdldCB7CgoJY29uc3RydWN0b3IoIHNpemUgPSAxLCBvcHRpb25zID0ge30gKSB7CgoJCXN1cGVyKCBzaXplLCBzaXplLCBvcHRpb25zICk7CgoJCXRoaXMuaXNXZWJHTEN1YmVSZW5kZXJUYXJnZXQgPSB0cnVlOwoKCQljb25zdCBpbWFnZSA9IHsgd2lkdGg6IHNpemUsIGhlaWdodDogc2l6ZSwgZGVwdGg6IDEgfTsKCQljb25zdCBpbWFnZXMgPSBbIGltYWdlLCBpbWFnZSwgaW1hZ2UsIGltYWdlLCBpbWFnZSwgaW1hZ2UgXTsKCgkJaWYgKCBvcHRpb25zLmVuY29kaW5nICE9PSB1bmRlZmluZWQgKSB7CgoJCQkvLyBAZGVwcmVjYXRlZCwgcjE1MgoJCQl3YXJuT25jZSggJ1RIUkVFLldlYkdMQ3ViZVJlbmRlclRhcmdldDogb3B0aW9uLmVuY29kaW5nIGhhcyBiZWVuIHJlcGxhY2VkIGJ5IG9wdGlvbi5jb2xvclNwYWNlLicgKTsKCQkJb3B0aW9ucy5jb2xvclNwYWNlID0gb3B0aW9ucy5lbmNvZGluZyA9PT0gc1JHQkVuY29kaW5nID8gU1JHQkNvbG9yU3BhY2UgOiBOb0NvbG9yU3BhY2U7CgoJCX0KCgkJdGhpcy50ZXh0dXJlID0gbmV3IEN1YmVUZXh0dXJlKCBpbWFnZXMsIG9wdGlvbnMubWFwcGluZywgb3B0aW9ucy53cmFwUywgb3B0aW9ucy53cmFwVCwgb3B0aW9ucy5tYWdGaWx0ZXIsIG9wdGlvbnMubWluRmlsdGVyLCBvcHRpb25zLmZvcm1hdCwgb3B0aW9ucy50eXBlLCBvcHRpb25zLmFuaXNvdHJvcHksIG9wdGlvbnMuY29sb3JTcGFjZSApOwoKCQkvLyBCeSBjb252ZW50aW9uIC0tIGxpa2VseSBiYXNlZCBvbiB0aGUgUmVuZGVyTWFuIHNwZWMgZnJvbSB0aGUgMTk5MCdzIC0tIGN1YmUgbWFwcyBhcmUgc3BlY2lmaWVkIGJ5IFdlYkdMIChhbmQgdGhyZWUuanMpCgkJLy8gaW4gYSBjb29yZGluYXRlIHN5c3RlbSBpbiB3aGljaCBwb3NpdGl2ZS14IGlzIHRvIHRoZSByaWdodCB3aGVuIGxvb2tpbmcgdXAgdGhlIHBvc2l0aXZlLXogYXhpcyAtLSBpbiBvdGhlciB3b3JkcywKCQkvLyBpbiBhIGxlZnQtaGFuZGVkIGNvb3JkaW5hdGUgc3lzdGVtLiBCeSBjb250aW51aW5nIHRoaXMgY29udmVudGlvbiwgcHJlZXhpc3RpbmcgY3ViZSBtYXBzIGNvbnRpbnVlZCB0byByZW5kZXIgY29ycmVjdGx5LgoKCQkvLyB0aHJlZS5qcyB1c2VzIGEgcmlnaHQtaGFuZGVkIGNvb3JkaW5hdGUgc3lzdGVtLiBTbyBlbnZpcm9ubWVudCBtYXBzIHVzZWQgaW4gdGhyZWUuanMgYXBwZWFyIHRvIGhhdmUgcHggYW5kIG54IHN3YXBwZWQKCQkvLyBhbmQgdGhlIGZsYWcgaXNSZW5kZXJUYXJnZXRUZXh0dXJlIGNvbnRyb2xzIHRoaXMgY29udmVyc2lvbi4gVGhlIGZsaXAgaXMgbm90IHJlcXVpcmVkIHdoZW4gdXNpbmcgV2ViR0xDdWJlUmVuZGVyVGFyZ2V0LnRleHR1cmUKCQkvLyBhcyBhIGN1YmUgdGV4dHVyZSAodGhpcyBpcyBkZXRlY3RlZCB3aGVuIGlzUmVuZGVyVGFyZ2V0VGV4dHVyZSBpcyBzZXQgdG8gdHJ1ZSBmb3IgY3ViZSB0ZXh0dXJlcykuCgoJCXRoaXMudGV4dHVyZS5pc1JlbmRlclRhcmdldFRleHR1cmUgPSB0cnVlOwoKCQl0aGlzLnRleHR1cmUuZ2VuZXJhdGVNaXBtYXBzID0gb3B0aW9ucy5nZW5lcmF0ZU1pcG1hcHMgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuZ2VuZXJhdGVNaXBtYXBzIDogZmFsc2U7CgkJdGhpcy50ZXh0dXJlLm1pbkZpbHRlciA9IG9wdGlvbnMubWluRmlsdGVyICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1pbkZpbHRlciA6IExpbmVhckZpbHRlcjsKCgl9CgoJZnJvbUVxdWlyZWN0YW5ndWxhclRleHR1cmUoIHJlbmRlcmVyLCB0ZXh0dXJlICkgewoKCQl0aGlzLnRleHR1cmUudHlwZSA9IHRleHR1cmUudHlwZTsKCQl0aGlzLnRleHR1cmUuY29sb3JTcGFjZSA9IHRleHR1cmUuY29sb3JTcGFjZTsKCgkJdGhpcy50ZXh0dXJlLmdlbmVyYXRlTWlwbWFwcyA9IHRleHR1cmUuZ2VuZXJhdGVNaXBtYXBzOwoJCXRoaXMudGV4dHVyZS5taW5GaWx0ZXIgPSB0ZXh0dXJlLm1pbkZpbHRlcjsKCQl0aGlzLnRleHR1cmUubWFnRmlsdGVyID0gdGV4dHVyZS5tYWdGaWx0ZXI7CgoJCWNvbnN0IHNoYWRlciA9IHsKCgkJCXVuaWZvcm1zOiB7CgkJCQl0RXF1aXJlY3Q6IHsgdmFsdWU6IG51bGwgfSwKCQkJfSwKCgkJCXZlcnRleFNoYWRlcjogLyogZ2xzbCAqL2AKCgkJCQl2YXJ5aW5nIHZlYzMgdldvcmxkRGlyZWN0aW9uOwoKCQkJCXZlYzMgdHJhbnNmb3JtRGlyZWN0aW9uKCBpbiB2ZWMzIGRpciwgaW4gbWF0NCBtYXRyaXggKSB7CgoJCQkJCXJldHVybiBub3JtYWxpemUoICggbWF0cml4ICogdmVjNCggZGlyLCAwLjAgKSApLnh5eiApOwoKCQkJCX0KCgkJCQl2b2lkIG1haW4oKSB7CgoJCQkJCXZXb3JsZERpcmVjdGlvbiA9IHRyYW5zZm9ybURpcmVjdGlvbiggcG9zaXRpb24sIG1vZGVsTWF0cml4ICk7CgoJCQkJCSNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+CgkJCQkJI2luY2x1ZGUgPHByb2plY3RfdmVydGV4PgoKCQkJCX0KCQkJYCwKCgkJCWZyYWdtZW50U2hhZGVyOiAvKiBnbHNsICovYAoKCQkJCXVuaWZvcm0gc2FtcGxlcjJEIHRFcXVpcmVjdDsKCgkJCQl2YXJ5aW5nIHZlYzMgdldvcmxkRGlyZWN0aW9uOwoKCQkJCSNpbmNsdWRlIDxjb21tb24+CgoJCQkJdm9pZCBtYWluKCkgewoKCQkJCQl2ZWMzIGRpcmVjdGlvbiA9IG5vcm1hbGl6ZSggdldvcmxkRGlyZWN0aW9uICk7CgoJCQkJCXZlYzIgc2FtcGxlVVYgPSBlcXVpcmVjdFV2KCBkaXJlY3Rpb24gKTsKCgkJCQkJZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZTJEKCB0RXF1aXJlY3QsIHNhbXBsZVVWICk7CgoJCQkJfQoJCQlgCgkJfTsKCgkJY29uc3QgZ2VvbWV0cnkgPSBuZXcgQm94R2VvbWV0cnkoIDUsIDUsIDUgKTsKCgkJY29uc3QgbWF0ZXJpYWwgPSBuZXcgU2hhZGVyTWF0ZXJpYWwoIHsKCgkJCW5hbWU6ICdDdWJlbWFwRnJvbUVxdWlyZWN0JywKCgkJCXVuaWZvcm1zOiBjbG9uZVVuaWZvcm1zKCBzaGFkZXIudW5pZm9ybXMgKSwKCQkJdmVydGV4U2hhZGVyOiBzaGFkZXIudmVydGV4U2hhZGVyLAoJCQlmcmFnbWVudFNoYWRlcjogc2hhZGVyLmZyYWdtZW50U2hhZGVyLAoJCQlzaWRlOiBCYWNrU2lkZSwKCQkJYmxlbmRpbmc6IE5vQmxlbmRpbmcKCgkJfSApOwoKCQltYXRlcmlhbC51bmlmb3Jtcy50RXF1aXJlY3QudmFsdWUgPSB0ZXh0dXJlOwoKCQljb25zdCBtZXNoID0gbmV3IE1lc2goIGdlb21ldHJ5LCBtYXRlcmlhbCApOwoKCQljb25zdCBjdXJyZW50TWluRmlsdGVyID0gdGV4dHVyZS5taW5GaWx0ZXI7CgoJCS8vIEF2b2lkIGJsdXJyZWQgcG9sZXMKCQlpZiAoIHRleHR1cmUubWluRmlsdGVyID09PSBMaW5lYXJNaXBtYXBMaW5lYXJGaWx0ZXIgKSB0ZXh0dXJlLm1pbkZpbHRlciA9IExpbmVhckZpbHRlcjsKCgkJY29uc3QgY2FtZXJhID0gbmV3IEN1YmVDYW1lcmEoIDEsIDEwLCB0aGlzICk7CgkJY2FtZXJhLnVwZGF0ZSggcmVuZGVyZXIsIG1lc2ggKTsKCgkJdGV4dHVyZS5taW5GaWx0ZXIgPSBjdXJyZW50TWluRmlsdGVyOwoKCQltZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKTsKCQltZXNoLm1hdGVyaWFsLmRpc3Bvc2UoKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsZWFyKCByZW5kZXJlciwgY29sb3IsIGRlcHRoLCBzdGVuY2lsICkgewoKCQljb25zdCBjdXJyZW50UmVuZGVyVGFyZ2V0ID0gcmVuZGVyZXIuZ2V0UmVuZGVyVGFyZ2V0KCk7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IDY7IGkgKysgKSB7CgoJCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIHRoaXMsIGkgKTsKCgkJCXJlbmRlcmVyLmNsZWFyKCBjb2xvciwgZGVwdGgsIHN0ZW5jaWwgKTsKCgkJfQoKCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIGN1cnJlbnRSZW5kZXJUYXJnZXQgKTsKCgl9Cgp9Cgpjb25zdCBfdmVjdG9yMSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3ZlY3RvcjIgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9ub3JtYWxNYXRyaXggPSAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCk7CgpjbGFzcyBQbGFuZSB7CgoJY29uc3RydWN0b3IoIG5vcm1hbCA9IG5ldyBWZWN0b3IzKCAxLCAwLCAwICksIGNvbnN0YW50ID0gMCApIHsKCgkJdGhpcy5pc1BsYW5lID0gdHJ1ZTsKCgkJLy8gbm9ybWFsIGlzIGFzc3VtZWQgdG8gYmUgbm9ybWFsaXplZAoKCQl0aGlzLm5vcm1hbCA9IG5vcm1hbDsKCQl0aGlzLmNvbnN0YW50ID0gY29uc3RhbnQ7CgoJfQoKCXNldCggbm9ybWFsLCBjb25zdGFudCApIHsKCgkJdGhpcy5ub3JtYWwuY29weSggbm9ybWFsICk7CgkJdGhpcy5jb25zdGFudCA9IGNvbnN0YW50OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0Q29tcG9uZW50cyggeCwgeSwgeiwgdyApIHsKCgkJdGhpcy5ub3JtYWwuc2V0KCB4LCB5LCB6ICk7CgkJdGhpcy5jb25zdGFudCA9IHc7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tTm9ybWFsQW5kQ29wbGFuYXJQb2ludCggbm9ybWFsLCBwb2ludCApIHsKCgkJdGhpcy5ub3JtYWwuY29weSggbm9ybWFsICk7CgkJdGhpcy5jb25zdGFudCA9IC0gcG9pbnQuZG90KCB0aGlzLm5vcm1hbCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0RnJvbUNvcGxhbmFyUG9pbnRzKCBhLCBiLCBjICkgewoKCQljb25zdCBub3JtYWwgPSBfdmVjdG9yMS5zdWJWZWN0b3JzKCBjLCBiICkuY3Jvc3MoIF92ZWN0b3IyLnN1YlZlY3RvcnMoIGEsIGIgKSApLm5vcm1hbGl6ZSgpOwoKCQkvLyBROiBzaG91bGQgYW4gZXJyb3IgYmUgdGhyb3duIGlmIG5vcm1hbCBpcyB6ZXJvIChlLmcuIGRlZ2VuZXJhdGUgcGxhbmUpPwoKCQl0aGlzLnNldEZyb21Ob3JtYWxBbmRDb3BsYW5hclBvaW50KCBub3JtYWwsIGEgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvcHkoIHBsYW5lICkgewoKCQl0aGlzLm5vcm1hbC5jb3B5KCBwbGFuZS5ub3JtYWwgKTsKCQl0aGlzLmNvbnN0YW50ID0gcGxhbmUuY29uc3RhbnQ7CgoJCXJldHVybiB0aGlzOwoKCX0KCglub3JtYWxpemUoKSB7CgoJCS8vIE5vdGU6IHdpbGwgbGVhZCB0byBhIGRpdmlkZSBieSB6ZXJvIGlmIHRoZSBwbGFuZSBpcyBpbnZhbGlkLgoKCQljb25zdCBpbnZlcnNlTm9ybWFsTGVuZ3RoID0gMS4wIC8gdGhpcy5ub3JtYWwubGVuZ3RoKCk7CgkJdGhpcy5ub3JtYWwubXVsdGlwbHlTY2FsYXIoIGludmVyc2VOb3JtYWxMZW5ndGggKTsKCQl0aGlzLmNvbnN0YW50ICo9IGludmVyc2VOb3JtYWxMZW5ndGg7CgoJCXJldHVybiB0aGlzOwoKCX0KCgluZWdhdGUoKSB7CgoJCXRoaXMuY29uc3RhbnQgKj0gLSAxOwoJCXRoaXMubm9ybWFsLm5lZ2F0ZSgpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZGlzdGFuY2VUb1BvaW50KCBwb2ludCApIHsKCgkJcmV0dXJuIHRoaXMubm9ybWFsLmRvdCggcG9pbnQgKSArIHRoaXMuY29uc3RhbnQ7CgoJfQoKCWRpc3RhbmNlVG9TcGhlcmUoIHNwaGVyZSApIHsKCgkJcmV0dXJuIHRoaXMuZGlzdGFuY2VUb1BvaW50KCBzcGhlcmUuY2VudGVyICkgLSBzcGhlcmUucmFkaXVzOwoKCX0KCglwcm9qZWN0UG9pbnQoIHBvaW50LCB0YXJnZXQgKSB7CgoJCXJldHVybiB0YXJnZXQuY29weSggcG9pbnQgKS5hZGRTY2FsZWRWZWN0b3IoIHRoaXMubm9ybWFsLCAtIHRoaXMuZGlzdGFuY2VUb1BvaW50KCBwb2ludCApICk7CgoJfQoKCWludGVyc2VjdExpbmUoIGxpbmUsIHRhcmdldCApIHsKCgkJY29uc3QgZGlyZWN0aW9uID0gbGluZS5kZWx0YSggX3ZlY3RvcjEgKTsKCgkJY29uc3QgZGVub21pbmF0b3IgPSB0aGlzLm5vcm1hbC5kb3QoIGRpcmVjdGlvbiApOwoKCQlpZiAoIGRlbm9taW5hdG9yID09PSAwICkgewoKCQkJLy8gbGluZSBpcyBjb3BsYW5hciwgcmV0dXJuIG9yaWdpbgoJCQlpZiAoIHRoaXMuZGlzdGFuY2VUb1BvaW50KCBsaW5lLnN0YXJ0ICkgPT09IDAgKSB7CgoJCQkJcmV0dXJuIHRhcmdldC5jb3B5KCBsaW5lLnN0YXJ0ICk7CgoJCQl9CgoJCQkvLyBVbnN1cmUgaWYgdGhpcyBpcyB0aGUgY29ycmVjdCBtZXRob2QgdG8gaGFuZGxlIHRoaXMgY2FzZS4KCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJY29uc3QgdCA9IC0gKCBsaW5lLnN0YXJ0LmRvdCggdGhpcy5ub3JtYWwgKSArIHRoaXMuY29uc3RhbnQgKSAvIGRlbm9taW5hdG9yOwoKCQlpZiAoIHQgPCAwIHx8IHQgPiAxICkgewoKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJcmV0dXJuIHRhcmdldC5jb3B5KCBsaW5lLnN0YXJ0ICkuYWRkU2NhbGVkVmVjdG9yKCBkaXJlY3Rpb24sIHQgKTsKCgl9CgoJaW50ZXJzZWN0c0xpbmUoIGxpbmUgKSB7CgoJCS8vIE5vdGU6IHRoaXMgdGVzdHMgaWYgYSBsaW5lIGludGVyc2VjdHMgdGhlIHBsYW5lLCBub3Qgd2hldGhlciBpdCAob3IgaXRzIGVuZC1wb2ludHMpIGFyZSBjb3BsYW5hciB3aXRoIGl0LgoKCQljb25zdCBzdGFydFNpZ24gPSB0aGlzLmRpc3RhbmNlVG9Qb2ludCggbGluZS5zdGFydCApOwoJCWNvbnN0IGVuZFNpZ24gPSB0aGlzLmRpc3RhbmNlVG9Qb2ludCggbGluZS5lbmQgKTsKCgkJcmV0dXJuICggc3RhcnRTaWduIDwgMCAmJiBlbmRTaWduID4gMCApIHx8ICggZW5kU2lnbiA8IDAgJiYgc3RhcnRTaWduID4gMCApOwoKCX0KCglpbnRlcnNlY3RzQm94KCBib3ggKSB7CgoJCXJldHVybiBib3guaW50ZXJzZWN0c1BsYW5lKCB0aGlzICk7CgoJfQoKCWludGVyc2VjdHNTcGhlcmUoIHNwaGVyZSApIHsKCgkJcmV0dXJuIHNwaGVyZS5pbnRlcnNlY3RzUGxhbmUoIHRoaXMgKTsKCgl9CgoJY29wbGFuYXJQb2ludCggdGFyZ2V0ICkgewoKCQlyZXR1cm4gdGFyZ2V0LmNvcHkoIHRoaXMubm9ybWFsICkubXVsdGlwbHlTY2FsYXIoIC0gdGhpcy5jb25zdGFudCApOwoKCX0KCglhcHBseU1hdHJpeDQoIG1hdHJpeCwgb3B0aW9uYWxOb3JtYWxNYXRyaXggKSB7CgoJCWNvbnN0IG5vcm1hbE1hdHJpeCA9IG9wdGlvbmFsTm9ybWFsTWF0cml4IHx8IF9ub3JtYWxNYXRyaXguZ2V0Tm9ybWFsTWF0cml4KCBtYXRyaXggKTsKCgkJY29uc3QgcmVmZXJlbmNlUG9pbnQgPSB0aGlzLmNvcGxhbmFyUG9pbnQoIF92ZWN0b3IxICkuYXBwbHlNYXRyaXg0KCBtYXRyaXggKTsKCgkJY29uc3Qgbm9ybWFsID0gdGhpcy5ub3JtYWwuYXBwbHlNYXRyaXgzKCBub3JtYWxNYXRyaXggKS5ub3JtYWxpemUoKTsKCgkJdGhpcy5jb25zdGFudCA9IC0gcmVmZXJlbmNlUG9pbnQuZG90KCBub3JtYWwgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRyYW5zbGF0ZSggb2Zmc2V0ICkgewoKCQl0aGlzLmNvbnN0YW50IC09IG9mZnNldC5kb3QoIHRoaXMubm9ybWFsICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgllcXVhbHMoIHBsYW5lICkgewoKCQlyZXR1cm4gcGxhbmUubm9ybWFsLmVxdWFscyggdGhpcy5ub3JtYWwgKSAmJiAoIHBsYW5lLmNvbnN0YW50ID09PSB0aGlzLmNvbnN0YW50ICk7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KCB0aGlzICk7CgoJfQoKfQoKY29uc3QgX3NwaGVyZSQ1ID0gLypAX19QVVJFX18qLyBuZXcgU3BoZXJlKCk7CmNvbnN0IF92ZWN0b3IkNyA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNsYXNzIEZydXN0dW0gewoKCWNvbnN0cnVjdG9yKCBwMCA9IG5ldyBQbGFuZSgpLCBwMSA9IG5ldyBQbGFuZSgpLCBwMiA9IG5ldyBQbGFuZSgpLCBwMyA9IG5ldyBQbGFuZSgpLCBwNCA9IG5ldyBQbGFuZSgpLCBwNSA9IG5ldyBQbGFuZSgpICkgewoKCQl0aGlzLnBsYW5lcyA9IFsgcDAsIHAxLCBwMiwgcDMsIHA0LCBwNSBdOwoKCX0KCglzZXQoIHAwLCBwMSwgcDIsIHAzLCBwNCwgcDUgKSB7CgoJCWNvbnN0IHBsYW5lcyA9IHRoaXMucGxhbmVzOwoKCQlwbGFuZXNbIDAgXS5jb3B5KCBwMCApOwoJCXBsYW5lc1sgMSBdLmNvcHkoIHAxICk7CgkJcGxhbmVzWyAyIF0uY29weSggcDIgKTsKCQlwbGFuZXNbIDMgXS5jb3B5KCBwMyApOwoJCXBsYW5lc1sgNCBdLmNvcHkoIHA0ICk7CgkJcGxhbmVzWyA1IF0uY29weSggcDUgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvcHkoIGZydXN0dW0gKSB7CgoJCWNvbnN0IHBsYW5lcyA9IHRoaXMucGxhbmVzOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA2OyBpICsrICkgewoKCQkJcGxhbmVzWyBpIF0uY29weSggZnJ1c3R1bS5wbGFuZXNbIGkgXSApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tUHJvamVjdGlvbk1hdHJpeCggbSwgY29vcmRpbmF0ZVN5c3RlbSA9IFdlYkdMQ29vcmRpbmF0ZVN5c3RlbSApIHsKCgkJY29uc3QgcGxhbmVzID0gdGhpcy5wbGFuZXM7CgkJY29uc3QgbWUgPSBtLmVsZW1lbnRzOwoJCWNvbnN0IG1lMCA9IG1lWyAwIF0sIG1lMSA9IG1lWyAxIF0sIG1lMiA9IG1lWyAyIF0sIG1lMyA9IG1lWyAzIF07CgkJY29uc3QgbWU0ID0gbWVbIDQgXSwgbWU1ID0gbWVbIDUgXSwgbWU2ID0gbWVbIDYgXSwgbWU3ID0gbWVbIDcgXTsKCQljb25zdCBtZTggPSBtZVsgOCBdLCBtZTkgPSBtZVsgOSBdLCBtZTEwID0gbWVbIDEwIF0sIG1lMTEgPSBtZVsgMTEgXTsKCQljb25zdCBtZTEyID0gbWVbIDEyIF0sIG1lMTMgPSBtZVsgMTMgXSwgbWUxNCA9IG1lWyAxNCBdLCBtZTE1ID0gbWVbIDE1IF07CgoJCXBsYW5lc1sgMCBdLnNldENvbXBvbmVudHMoIG1lMyAtIG1lMCwgbWU3IC0gbWU0LCBtZTExIC0gbWU4LCBtZTE1IC0gbWUxMiApLm5vcm1hbGl6ZSgpOwoJCXBsYW5lc1sgMSBdLnNldENvbXBvbmVudHMoIG1lMyArIG1lMCwgbWU3ICsgbWU0LCBtZTExICsgbWU4LCBtZTE1ICsgbWUxMiApLm5vcm1hbGl6ZSgpOwoJCXBsYW5lc1sgMiBdLnNldENvbXBvbmVudHMoIG1lMyArIG1lMSwgbWU3ICsgbWU1LCBtZTExICsgbWU5LCBtZTE1ICsgbWUxMyApLm5vcm1hbGl6ZSgpOwoJCXBsYW5lc1sgMyBdLnNldENvbXBvbmVudHMoIG1lMyAtIG1lMSwgbWU3IC0gbWU1LCBtZTExIC0gbWU5LCBtZTE1IC0gbWUxMyApLm5vcm1hbGl6ZSgpOwoJCXBsYW5lc1sgNCBdLnNldENvbXBvbmVudHMoIG1lMyAtIG1lMiwgbWU3IC0gbWU2LCBtZTExIC0gbWUxMCwgbWUxNSAtIG1lMTQgKS5ub3JtYWxpemUoKTsKCgkJaWYgKCBjb29yZGluYXRlU3lzdGVtID09PSBXZWJHTENvb3JkaW5hdGVTeXN0ZW0gKSB7CgoJCQlwbGFuZXNbIDUgXS5zZXRDb21wb25lbnRzKCBtZTMgKyBtZTIsIG1lNyArIG1lNiwgbWUxMSArIG1lMTAsIG1lMTUgKyBtZTE0ICkubm9ybWFsaXplKCk7CgoJCX0gZWxzZSBpZiAoIGNvb3JkaW5hdGVTeXN0ZW0gPT09IFdlYkdQVUNvb3JkaW5hdGVTeXN0ZW0gKSB7CgoJCQlwbGFuZXNbIDUgXS5zZXRDb21wb25lbnRzKCBtZTIsIG1lNiwgbWUxMCwgbWUxNCApLm5vcm1hbGl6ZSgpOwoKCQl9IGVsc2UgewoKCQkJdGhyb3cgbmV3IEVycm9yKCAnVEhSRUUuRnJ1c3R1bS5zZXRGcm9tUHJvamVjdGlvbk1hdHJpeCgpOiBJbnZhbGlkIGNvb3JkaW5hdGUgc3lzdGVtOiAnICsgY29vcmRpbmF0ZVN5c3RlbSApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglpbnRlcnNlY3RzT2JqZWN0KCBvYmplY3QgKSB7CgoJCWlmICggb2JqZWN0LmJvdW5kaW5nU3BoZXJlICE9PSB1bmRlZmluZWQgKSB7CgoJCQlpZiAoIG9iamVjdC5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCApIG9iamVjdC5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTsKCgkJCV9zcGhlcmUkNS5jb3B5KCBvYmplY3QuYm91bmRpbmdTcGhlcmUgKS5hcHBseU1hdHJpeDQoIG9iamVjdC5tYXRyaXhXb3JsZCApOwoKCQl9IGVsc2UgewoKCQkJY29uc3QgZ2VvbWV0cnkgPSBvYmplY3QuZ2VvbWV0cnk7CgoJCQlpZiAoIGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID09PSBudWxsICkgZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CgoJCQlfc3BoZXJlJDUuY29weSggZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgKS5hcHBseU1hdHJpeDQoIG9iamVjdC5tYXRyaXhXb3JsZCApOwoKCQl9CgoJCXJldHVybiB0aGlzLmludGVyc2VjdHNTcGhlcmUoIF9zcGhlcmUkNSApOwoKCX0KCglpbnRlcnNlY3RzU3ByaXRlKCBzcHJpdGUgKSB7CgoJCV9zcGhlcmUkNS5jZW50ZXIuc2V0KCAwLCAwLCAwICk7CgkJX3NwaGVyZSQ1LnJhZGl1cyA9IDAuNzA3MTA2NzgxMTg2NTQ3NjsKCQlfc3BoZXJlJDUuYXBwbHlNYXRyaXg0KCBzcHJpdGUubWF0cml4V29ybGQgKTsKCgkJcmV0dXJuIHRoaXMuaW50ZXJzZWN0c1NwaGVyZSggX3NwaGVyZSQ1ICk7CgoJfQoKCWludGVyc2VjdHNTcGhlcmUoIHNwaGVyZSApIHsKCgkJY29uc3QgcGxhbmVzID0gdGhpcy5wbGFuZXM7CgkJY29uc3QgY2VudGVyID0gc3BoZXJlLmNlbnRlcjsKCQljb25zdCBuZWdSYWRpdXMgPSAtIHNwaGVyZS5yYWRpdXM7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IDY7IGkgKysgKSB7CgoJCQljb25zdCBkaXN0YW5jZSA9IHBsYW5lc1sgaSBdLmRpc3RhbmNlVG9Qb2ludCggY2VudGVyICk7CgoJCQlpZiAoIGRpc3RhbmNlIDwgbmVnUmFkaXVzICkgewoKCQkJCXJldHVybiBmYWxzZTsKCgkJCX0KCgkJfQoKCQlyZXR1cm4gdHJ1ZTsKCgl9CgoJaW50ZXJzZWN0c0JveCggYm94ICkgewoKCQljb25zdCBwbGFuZXMgPSB0aGlzLnBsYW5lczsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgNjsgaSArKyApIHsKCgkJCWNvbnN0IHBsYW5lID0gcGxhbmVzWyBpIF07CgoJCQkvLyBjb3JuZXIgYXQgbWF4IGRpc3RhbmNlCgoJCQlfdmVjdG9yJDcueCA9IHBsYW5lLm5vcm1hbC54ID4gMCA/IGJveC5tYXgueCA6IGJveC5taW4ueDsKCQkJX3ZlY3RvciQ3LnkgPSBwbGFuZS5ub3JtYWwueSA+IDAgPyBib3gubWF4LnkgOiBib3gubWluLnk7CgkJCV92ZWN0b3IkNy56ID0gcGxhbmUubm9ybWFsLnogPiAwID8gYm94Lm1heC56IDogYm94Lm1pbi56OwoKCQkJaWYgKCBwbGFuZS5kaXN0YW5jZVRvUG9pbnQoIF92ZWN0b3IkNyApIDwgMCApIHsKCgkJCQlyZXR1cm4gZmFsc2U7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIHRydWU7CgoJfQoKCWNvbnRhaW5zUG9pbnQoIHBvaW50ICkgewoKCQljb25zdCBwbGFuZXMgPSB0aGlzLnBsYW5lczsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgNjsgaSArKyApIHsKCgkJCWlmICggcGxhbmVzWyBpIF0uZGlzdGFuY2VUb1BvaW50KCBwb2ludCApIDwgMCApIHsKCgkJCQlyZXR1cm4gZmFsc2U7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIHRydWU7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KCB0aGlzICk7CgoJfQoKfQoKZnVuY3Rpb24gV2ViR0xBbmltYXRpb24oKSB7CgoJbGV0IGNvbnRleHQgPSBudWxsOwoJbGV0IGlzQW5pbWF0aW5nID0gZmFsc2U7CglsZXQgYW5pbWF0aW9uTG9vcCA9IG51bGw7CglsZXQgcmVxdWVzdElkID0gbnVsbDsKCglmdW5jdGlvbiBvbkFuaW1hdGlvbkZyYW1lKCB0aW1lLCBmcmFtZSApIHsKCgkJYW5pbWF0aW9uTG9vcCggdGltZSwgZnJhbWUgKTsKCgkJcmVxdWVzdElkID0gY29udGV4dC5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoIG9uQW5pbWF0aW9uRnJhbWUgKTsKCgl9CgoJcmV0dXJuIHsKCgkJc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCgkJCWlmICggaXNBbmltYXRpbmcgPT09IHRydWUgKSByZXR1cm47CgkJCWlmICggYW5pbWF0aW9uTG9vcCA9PT0gbnVsbCApIHJldHVybjsKCgkJCXJlcXVlc3RJZCA9IGNvbnRleHQucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCBvbkFuaW1hdGlvbkZyYW1lICk7CgoJCQlpc0FuaW1hdGluZyA9IHRydWU7CgoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uICgpIHsKCgkJCWNvbnRleHQuY2FuY2VsQW5pbWF0aW9uRnJhbWUoIHJlcXVlc3RJZCApOwoKCQkJaXNBbmltYXRpbmcgPSBmYWxzZTsKCgkJfSwKCgkJc2V0QW5pbWF0aW9uTG9vcDogZnVuY3Rpb24gKCBjYWxsYmFjayApIHsKCgkJCWFuaW1hdGlvbkxvb3AgPSBjYWxsYmFjazsKCgkJfSwKCgkJc2V0Q29udGV4dDogZnVuY3Rpb24gKCB2YWx1ZSApIHsKCgkJCWNvbnRleHQgPSB2YWx1ZTsKCgkJfQoKCX07Cgp9CgpmdW5jdGlvbiBXZWJHTEF0dHJpYnV0ZXMoIGdsLCBjYXBhYmlsaXRpZXMgKSB7CgoJY29uc3QgaXNXZWJHTDIgPSBjYXBhYmlsaXRpZXMuaXNXZWJHTDI7CgoJY29uc3QgYnVmZmVycyA9IG5ldyBXZWFrTWFwKCk7CgoJZnVuY3Rpb24gY3JlYXRlQnVmZmVyKCBhdHRyaWJ1dGUsIGJ1ZmZlclR5cGUgKSB7CgoJCWNvbnN0IGFycmF5ID0gYXR0cmlidXRlLmFycmF5OwoJCWNvbnN0IHVzYWdlID0gYXR0cmlidXRlLnVzYWdlOwoJCWNvbnN0IHNpemUgPSBhcnJheS5ieXRlTGVuZ3RoOwoKCQljb25zdCBidWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCgkJZ2wuYmluZEJ1ZmZlciggYnVmZmVyVHlwZSwgYnVmZmVyICk7CgkJZ2wuYnVmZmVyRGF0YSggYnVmZmVyVHlwZSwgYXJyYXksIHVzYWdlICk7CgoJCWF0dHJpYnV0ZS5vblVwbG9hZENhbGxiYWNrKCk7CgoJCWxldCB0eXBlOwoKCQlpZiAoIGFycmF5IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5ICkgewoKCQkJdHlwZSA9IGdsLkZMT0FUOwoKCQl9IGVsc2UgaWYgKCBhcnJheSBpbnN0YW5jZW9mIFVpbnQxNkFycmF5ICkgewoKCQkJaWYgKCBhdHRyaWJ1dGUuaXNGbG9hdDE2QnVmZmVyQXR0cmlidXRlICkgewoKCQkJCWlmICggaXNXZWJHTDIgKSB7CgoJCQkJCXR5cGUgPSBnbC5IQUxGX0ZMT0FUOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRocm93IG5ldyBFcnJvciggJ1RIUkVFLldlYkdMQXR0cmlidXRlczogVXNhZ2Ugb2YgRmxvYXQxNkJ1ZmZlckF0dHJpYnV0ZSByZXF1aXJlcyBXZWJHTDIuJyApOwoKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJdHlwZSA9IGdsLlVOU0lHTkVEX1NIT1JUOwoKCQkJfQoKCQl9IGVsc2UgaWYgKCBhcnJheSBpbnN0YW5jZW9mIEludDE2QXJyYXkgKSB7CgoJCQl0eXBlID0gZ2wuU0hPUlQ7CgoJCX0gZWxzZSBpZiAoIGFycmF5IGluc3RhbmNlb2YgVWludDMyQXJyYXkgKSB7CgoJCQl0eXBlID0gZ2wuVU5TSUdORURfSU5UOwoKCQl9IGVsc2UgaWYgKCBhcnJheSBpbnN0YW5jZW9mIEludDMyQXJyYXkgKSB7CgoJCQl0eXBlID0gZ2wuSU5UOwoKCQl9IGVsc2UgaWYgKCBhcnJheSBpbnN0YW5jZW9mIEludDhBcnJheSApIHsKCgkJCXR5cGUgPSBnbC5CWVRFOwoKCQl9IGVsc2UgaWYgKCBhcnJheSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgKSB7CgoJCQl0eXBlID0gZ2wuVU5TSUdORURfQllURTsKCgkJfSBlbHNlIGlmICggYXJyYXkgaW5zdGFuY2VvZiBVaW50OENsYW1wZWRBcnJheSApIHsKCgkJCXR5cGUgPSBnbC5VTlNJR05FRF9CWVRFOwoKCQl9IGVsc2UgewoKCQkJdGhyb3cgbmV3IEVycm9yKCAnVEhSRUUuV2ViR0xBdHRyaWJ1dGVzOiBVbnN1cHBvcnRlZCBidWZmZXIgZGF0YSBmb3JtYXQ6ICcgKyBhcnJheSApOwoKCQl9CgoJCXJldHVybiB7CgkJCWJ1ZmZlcjogYnVmZmVyLAoJCQl0eXBlOiB0eXBlLAoJCQlieXRlc1BlckVsZW1lbnQ6IGFycmF5LkJZVEVTX1BFUl9FTEVNRU5ULAoJCQl2ZXJzaW9uOiBhdHRyaWJ1dGUudmVyc2lvbiwKCQkJc2l6ZTogc2l6ZQoJCX07CgoJfQoKCWZ1bmN0aW9uIHVwZGF0ZUJ1ZmZlciggYnVmZmVyLCBhdHRyaWJ1dGUsIGJ1ZmZlclR5cGUgKSB7CgoJCWNvbnN0IGFycmF5ID0gYXR0cmlidXRlLmFycmF5OwoJCWNvbnN0IHVwZGF0ZVJhbmdlID0gYXR0cmlidXRlLl91cGRhdGVSYW5nZTsgLy8gQGRlcHJlY2F0ZWQsIHIxNTkKCQljb25zdCB1cGRhdGVSYW5nZXMgPSBhdHRyaWJ1dGUudXBkYXRlUmFuZ2VzOwoKCQlnbC5iaW5kQnVmZmVyKCBidWZmZXJUeXBlLCBidWZmZXIgKTsKCgkJaWYgKCB1cGRhdGVSYW5nZS5jb3VudCA9PT0gLSAxICYmIHVwZGF0ZVJhbmdlcy5sZW5ndGggPT09IDAgKSB7CgoJCQkvLyBOb3QgdXNpbmcgdXBkYXRlIHJhbmdlcwoJCQlnbC5idWZmZXJTdWJEYXRhKCBidWZmZXJUeXBlLCAwLCBhcnJheSApOwoKCQl9CgoJCWlmICggdXBkYXRlUmFuZ2VzLmxlbmd0aCAhPT0gMCApIHsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IHVwZGF0ZVJhbmdlcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWNvbnN0IHJhbmdlID0gdXBkYXRlUmFuZ2VzWyBpIF07CgkJCQlpZiAoIGlzV2ViR0wyICkgewoKCQkJCQlnbC5idWZmZXJTdWJEYXRhKCBidWZmZXJUeXBlLCByYW5nZS5zdGFydCAqIGFycmF5LkJZVEVTX1BFUl9FTEVNRU5ULAoJCQkJCQlhcnJheSwgcmFuZ2Uuc3RhcnQsIHJhbmdlLmNvdW50ICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJZ2wuYnVmZmVyU3ViRGF0YSggYnVmZmVyVHlwZSwgcmFuZ2Uuc3RhcnQgKiBhcnJheS5CWVRFU19QRVJfRUxFTUVOVCwKCQkJCQkJYXJyYXkuc3ViYXJyYXkoIHJhbmdlLnN0YXJ0LCByYW5nZS5zdGFydCArIHJhbmdlLmNvdW50ICkgKTsKCgkJCQl9CgoJCQl9CgoJCQlhdHRyaWJ1dGUuY2xlYXJVcGRhdGVSYW5nZXMoKTsKCgkJfQoKCQkvLyBAZGVwcmVjYXRlZCwgcjE1OQoJCWlmICggdXBkYXRlUmFuZ2UuY291bnQgIT09IC0gMSApIHsKCgkJCWlmICggaXNXZWJHTDIgKSB7CgoJCQkJZ2wuYnVmZmVyU3ViRGF0YSggYnVmZmVyVHlwZSwgdXBkYXRlUmFuZ2Uub2Zmc2V0ICogYXJyYXkuQllURVNfUEVSX0VMRU1FTlQsCgkJCQkJYXJyYXksIHVwZGF0ZVJhbmdlLm9mZnNldCwgdXBkYXRlUmFuZ2UuY291bnQgKTsKCgkJCX0gZWxzZSB7CgoJCQkJZ2wuYnVmZmVyU3ViRGF0YSggYnVmZmVyVHlwZSwgdXBkYXRlUmFuZ2Uub2Zmc2V0ICogYXJyYXkuQllURVNfUEVSX0VMRU1FTlQsCgkJCQkJYXJyYXkuc3ViYXJyYXkoIHVwZGF0ZVJhbmdlLm9mZnNldCwgdXBkYXRlUmFuZ2Uub2Zmc2V0ICsgdXBkYXRlUmFuZ2UuY291bnQgKSApOwoKCQkJfQoKCQkJdXBkYXRlUmFuZ2UuY291bnQgPSAtIDE7IC8vIHJlc2V0IHJhbmdlCgoJCX0KCgkJYXR0cmlidXRlLm9uVXBsb2FkQ2FsbGJhY2soKTsKCgl9CgoJLy8KCglmdW5jdGlvbiBnZXQoIGF0dHJpYnV0ZSApIHsKCgkJaWYgKCBhdHRyaWJ1dGUuaXNJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZSApIGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZS5kYXRhOwoKCQlyZXR1cm4gYnVmZmVycy5nZXQoIGF0dHJpYnV0ZSApOwoKCX0KCglmdW5jdGlvbiByZW1vdmUoIGF0dHJpYnV0ZSApIHsKCgkJaWYgKCBhdHRyaWJ1dGUuaXNJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZSApIGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZS5kYXRhOwoKCQljb25zdCBkYXRhID0gYnVmZmVycy5nZXQoIGF0dHJpYnV0ZSApOwoKCQlpZiAoIGRhdGEgKSB7CgoJCQlnbC5kZWxldGVCdWZmZXIoIGRhdGEuYnVmZmVyICk7CgoJCQlidWZmZXJzLmRlbGV0ZSggYXR0cmlidXRlICk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gdXBkYXRlKCBhdHRyaWJ1dGUsIGJ1ZmZlclR5cGUgKSB7CgoJCWlmICggYXR0cmlidXRlLmlzR0xCdWZmZXJBdHRyaWJ1dGUgKSB7CgoJCQljb25zdCBjYWNoZWQgPSBidWZmZXJzLmdldCggYXR0cmlidXRlICk7CgoJCQlpZiAoICEgY2FjaGVkIHx8IGNhY2hlZC52ZXJzaW9uIDwgYXR0cmlidXRlLnZlcnNpb24gKSB7CgoJCQkJYnVmZmVycy5zZXQoIGF0dHJpYnV0ZSwgewoJCQkJCWJ1ZmZlcjogYXR0cmlidXRlLmJ1ZmZlciwKCQkJCQl0eXBlOiBhdHRyaWJ1dGUudHlwZSwKCQkJCQlieXRlc1BlckVsZW1lbnQ6IGF0dHJpYnV0ZS5lbGVtZW50U2l6ZSwKCQkJCQl2ZXJzaW9uOiBhdHRyaWJ1dGUudmVyc2lvbgoJCQkJfSApOwoKCQkJfQoKCQkJcmV0dXJuOwoKCQl9CgoJCWlmICggYXR0cmlidXRlLmlzSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUgKSBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGUuZGF0YTsKCgkJY29uc3QgZGF0YSA9IGJ1ZmZlcnMuZ2V0KCBhdHRyaWJ1dGUgKTsKCgkJaWYgKCBkYXRhID09PSB1bmRlZmluZWQgKSB7CgoJCQlidWZmZXJzLnNldCggYXR0cmlidXRlLCBjcmVhdGVCdWZmZXIoIGF0dHJpYnV0ZSwgYnVmZmVyVHlwZSApICk7CgoJCX0gZWxzZSBpZiAoIGRhdGEudmVyc2lvbiA8IGF0dHJpYnV0ZS52ZXJzaW9uICkgewoKCQkJaWYgKCBkYXRhLnNpemUgIT09IGF0dHJpYnV0ZS5hcnJheS5ieXRlTGVuZ3RoICkgewoKCQkJCXRocm93IG5ldyBFcnJvciggJ1RIUkVFLldlYkdMQXR0cmlidXRlczogVGhlIHNpemUgb2YgdGhlIGJ1ZmZlciBhdHRyaWJ1dGVcJ3MgYXJyYXkgYnVmZmVyIGRvZXMgbm90IG1hdGNoIHRoZSBvcmlnaW5hbCBzaXplLiBSZXNpemluZyBidWZmZXIgYXR0cmlidXRlcyBpcyBub3Qgc3VwcG9ydGVkLicgKTsKCgkJCX0KCgkJCXVwZGF0ZUJ1ZmZlciggZGF0YS5idWZmZXIsIGF0dHJpYnV0ZSwgYnVmZmVyVHlwZSApOwoKCQkJZGF0YS52ZXJzaW9uID0gYXR0cmlidXRlLnZlcnNpb247CgoJCX0KCgl9CgoJcmV0dXJuIHsKCgkJZ2V0OiBnZXQsCgkJcmVtb3ZlOiByZW1vdmUsCgkJdXBkYXRlOiB1cGRhdGUKCgl9OwoKfQoKY2xhc3MgUGxhbmVHZW9tZXRyeSBleHRlbmRzIEJ1ZmZlckdlb21ldHJ5IHsKCgljb25zdHJ1Y3Rvciggd2lkdGggPSAxLCBoZWlnaHQgPSAxLCB3aWR0aFNlZ21lbnRzID0gMSwgaGVpZ2h0U2VnbWVudHMgPSAxICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnUGxhbmVHZW9tZXRyeSc7CgoJCXRoaXMucGFyYW1ldGVycyA9IHsKCQkJd2lkdGg6IHdpZHRoLAoJCQloZWlnaHQ6IGhlaWdodCwKCQkJd2lkdGhTZWdtZW50czogd2lkdGhTZWdtZW50cywKCQkJaGVpZ2h0U2VnbWVudHM6IGhlaWdodFNlZ21lbnRzCgkJfTsKCgkJY29uc3Qgd2lkdGhfaGFsZiA9IHdpZHRoIC8gMjsKCQljb25zdCBoZWlnaHRfaGFsZiA9IGhlaWdodCAvIDI7CgoJCWNvbnN0IGdyaWRYID0gTWF0aC5mbG9vciggd2lkdGhTZWdtZW50cyApOwoJCWNvbnN0IGdyaWRZID0gTWF0aC5mbG9vciggaGVpZ2h0U2VnbWVudHMgKTsKCgkJY29uc3QgZ3JpZFgxID0gZ3JpZFggKyAxOwoJCWNvbnN0IGdyaWRZMSA9IGdyaWRZICsgMTsKCgkJY29uc3Qgc2VnbWVudF93aWR0aCA9IHdpZHRoIC8gZ3JpZFg7CgkJY29uc3Qgc2VnbWVudF9oZWlnaHQgPSBoZWlnaHQgLyBncmlkWTsKCgkJLy8KCgkJY29uc3QgaW5kaWNlcyA9IFtdOwoJCWNvbnN0IHZlcnRpY2VzID0gW107CgkJY29uc3Qgbm9ybWFscyA9IFtdOwoJCWNvbnN0IHV2cyA9IFtdOwoKCQlmb3IgKCBsZXQgaXkgPSAwOyBpeSA8IGdyaWRZMTsgaXkgKysgKSB7CgoJCQljb25zdCB5ID0gaXkgKiBzZWdtZW50X2hlaWdodCAtIGhlaWdodF9oYWxmOwoKCQkJZm9yICggbGV0IGl4ID0gMDsgaXggPCBncmlkWDE7IGl4ICsrICkgewoKCQkJCWNvbnN0IHggPSBpeCAqIHNlZ21lbnRfd2lkdGggLSB3aWR0aF9oYWxmOwoKCQkJCXZlcnRpY2VzLnB1c2goIHgsIC0geSwgMCApOwoKCQkJCW5vcm1hbHMucHVzaCggMCwgMCwgMSApOwoKCQkJCXV2cy5wdXNoKCBpeCAvIGdyaWRYICk7CgkJCQl1dnMucHVzaCggMSAtICggaXkgLyBncmlkWSApICk7CgoJCQl9CgoJCX0KCgkJZm9yICggbGV0IGl5ID0gMDsgaXkgPCBncmlkWTsgaXkgKysgKSB7CgoJCQlmb3IgKCBsZXQgaXggPSAwOyBpeCA8IGdyaWRYOyBpeCArKyApIHsKCgkJCQljb25zdCBhID0gaXggKyBncmlkWDEgKiBpeTsKCQkJCWNvbnN0IGIgPSBpeCArIGdyaWRYMSAqICggaXkgKyAxICk7CgkJCQljb25zdCBjID0gKCBpeCArIDEgKSArIGdyaWRYMSAqICggaXkgKyAxICk7CgkJCQljb25zdCBkID0gKCBpeCArIDEgKSArIGdyaWRYMSAqIGl5OwoKCQkJCWluZGljZXMucHVzaCggYSwgYiwgZCApOwoJCQkJaW5kaWNlcy5wdXNoKCBiLCBjLCBkICk7CgoJCQl9CgoJCX0KCgkJdGhpcy5zZXRJbmRleCggaW5kaWNlcyApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdmVydGljZXMsIDMgKSApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAnbm9ybWFsJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIG5vcm1hbHMsIDMgKSApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAndXYnLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdXZzLCAyICkgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gT2JqZWN0LmFzc2lnbigge30sIHNvdXJjZS5wYXJhbWV0ZXJzICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzdGF0aWMgZnJvbUpTT04oIGRhdGEgKSB7CgoJCXJldHVybiBuZXcgUGxhbmVHZW9tZXRyeSggZGF0YS53aWR0aCwgZGF0YS5oZWlnaHQsIGRhdGEud2lkdGhTZWdtZW50cywgZGF0YS5oZWlnaHRTZWdtZW50cyApOwoKCX0KCn0KCnZhciBhbHBoYWhhc2hfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9BTFBIQUhBU0hcblx0aWYgKCBkaWZmdXNlQ29sb3IuYSA8IGdldEFscGhhSGFzaFRocmVzaG9sZCggdlBvc2l0aW9uICkgKSBkaXNjYXJkO1xuI2VuZGlmIjsKCnZhciBhbHBoYWhhc2hfcGFyc19mcmFnbWVudCA9ICIjaWZkZWYgVVNFX0FMUEhBSEFTSFxuXHRjb25zdCBmbG9hdCBBTFBIQV9IQVNIX1NDQUxFID0gMC4wNTtcblx0ZmxvYXQgaGFzaDJEKCB2ZWMyIHZhbHVlICkge1xuXHRcdHJldHVybiBmcmFjdCggMS4wZTQgKiBzaW4oIDE3LjAgKiB2YWx1ZS54ICsgMC4xICogdmFsdWUueSApICogKCAwLjEgKyBhYnMoIHNpbiggMTMuMCAqIHZhbHVlLnkgKyB2YWx1ZS54ICkgKSApICk7XG5cdH1cblx0ZmxvYXQgaGFzaDNEKCB2ZWMzIHZhbHVlICkge1xuXHRcdHJldHVybiBoYXNoMkQoIHZlYzIoIGhhc2gyRCggdmFsdWUueHkgKSwgdmFsdWUueiApICk7XG5cdH1cblx0ZmxvYXQgZ2V0QWxwaGFIYXNoVGhyZXNob2xkKCB2ZWMzIHBvc2l0aW9uICkge1xuXHRcdGZsb2F0IG1heERlcml2ID0gbWF4KFxuXHRcdFx0bGVuZ3RoKCBkRmR4KCBwb3NpdGlvbi54eXogKSApLFxuXHRcdFx0bGVuZ3RoKCBkRmR5KCBwb3NpdGlvbi54eXogKSApXG5cdFx0KTtcblx0XHRmbG9hdCBwaXhTY2FsZSA9IDEuMCAvICggQUxQSEFfSEFTSF9TQ0FMRSAqIG1heERlcml2ICk7XG5cdFx0dmVjMiBwaXhTY2FsZXMgPSB2ZWMyKFxuXHRcdFx0ZXhwMiggZmxvb3IoIGxvZzIoIHBpeFNjYWxlICkgKSApLFxuXHRcdFx0ZXhwMiggY2VpbCggbG9nMiggcGl4U2NhbGUgKSApIClcblx0XHQpO1xuXHRcdHZlYzIgYWxwaGEgPSB2ZWMyKFxuXHRcdFx0aGFzaDNEKCBmbG9vciggcGl4U2NhbGVzLnggKiBwb3NpdGlvbi54eXogKSApLFxuXHRcdFx0aGFzaDNEKCBmbG9vciggcGl4U2NhbGVzLnkgKiBwb3NpdGlvbi54eXogKSApXG5cdFx0KTtcblx0XHRmbG9hdCBsZXJwRmFjdG9yID0gZnJhY3QoIGxvZzIoIHBpeFNjYWxlICkgKTtcblx0XHRmbG9hdCB4ID0gKCAxLjAgLSBsZXJwRmFjdG9yICkgKiBhbHBoYS54ICsgbGVycEZhY3RvciAqIGFscGhhLnk7XG5cdFx0ZmxvYXQgYSA9IG1pbiggbGVycEZhY3RvciwgMS4wIC0gbGVycEZhY3RvciApO1xuXHRcdHZlYzMgY2FzZXMgPSB2ZWMzKFxuXHRcdFx0eCAqIHggLyAoIDIuMCAqIGEgKiAoIDEuMCAtIGEgKSApLFxuXHRcdFx0KCB4IC0gMC41ICogYSApIC8gKCAxLjAgLSBhICksXG5cdFx0XHQxLjAgLSAoICggMS4wIC0geCApICogKCAxLjAgLSB4ICkgLyAoIDIuMCAqIGEgKiAoIDEuMCAtIGEgKSApIClcblx0XHQpO1xuXHRcdGZsb2F0IHRocmVzaG9sZCA9ICggeCA8ICggMS4wIC0gYSApIClcblx0XHRcdD8gKCAoIHggPCBhICkgPyBjYXNlcy54IDogY2FzZXMueSApXG5cdFx0XHQ6IGNhc2VzLno7XG5cdFx0cmV0dXJuIGNsYW1wKCB0aHJlc2hvbGQgLCAxLjBlLTYsIDEuMCApO1xuXHR9XG4jZW5kaWYiOwoKdmFyIGFscGhhbWFwX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfQUxQSEFNQVBcblx0ZGlmZnVzZUNvbG9yLmEgKj0gdGV4dHVyZTJEKCBhbHBoYU1hcCwgdkFscGhhTWFwVXYgKS5nO1xuI2VuZGlmIjsKCnZhciBhbHBoYW1hcF9wYXJzX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfQUxQSEFNQVBcblx0dW5pZm9ybSBzYW1wbGVyMkQgYWxwaGFNYXA7XG4jZW5kaWYiOwoKdmFyIGFscGhhdGVzdF9mcmFnbWVudCA9ICIjaWZkZWYgVVNFX0FMUEhBVEVTVFxuXHQjaWZkZWYgQUxQSEFfVE9fQ09WRVJBR0Vcblx0ZGlmZnVzZUNvbG9yLmEgPSBzbW9vdGhzdGVwKCBhbHBoYVRlc3QsIGFscGhhVGVzdCArIGZ3aWR0aCggZGlmZnVzZUNvbG9yLmEgKSwgZGlmZnVzZUNvbG9yLmEgKTtcblx0aWYgKCBkaWZmdXNlQ29sb3IuYSA9PSAwLjAgKSBkaXNjYXJkO1xuXHQjZWxzZVxuXHRpZiAoIGRpZmZ1c2VDb2xvci5hIDwgYWxwaGFUZXN0ICkgZGlzY2FyZDtcblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfQUxQSEFURVNUXG5cdHVuaWZvcm0gZmxvYXQgYWxwaGFUZXN0O1xuI2VuZGlmIjsKCnZhciBhb21hcF9mcmFnbWVudCA9ICIjaWZkZWYgVVNFX0FPTUFQXG5cdGZsb2F0IGFtYmllbnRPY2NsdXNpb24gPSAoIHRleHR1cmUyRCggYW9NYXAsIHZBb01hcFV2ICkuciAtIDEuMCApICogYW9NYXBJbnRlbnNpdHkgKyAxLjA7XG5cdHJlZmxlY3RlZExpZ2h0LmluZGlyZWN0RGlmZnVzZSAqPSBhbWJpZW50T2NjbHVzaW9uO1xuXHQjaWYgZGVmaW5lZCggVVNFX0NMRUFSQ09BVCApIFxuXHRcdGNsZWFyY29hdFNwZWN1bGFySW5kaXJlY3QgKj0gYW1iaWVudE9jY2x1c2lvbjtcblx0I2VuZGlmXG5cdCNpZiBkZWZpbmVkKCBVU0VfU0hFRU4gKSBcblx0XHRzaGVlblNwZWN1bGFySW5kaXJlY3QgKj0gYW1iaWVudE9jY2x1c2lvbjtcblx0I2VuZGlmXG5cdCNpZiBkZWZpbmVkKCBVU0VfRU5WTUFQICkgJiYgZGVmaW5lZCggU1RBTkRBUkQgKVxuXHRcdGZsb2F0IGRvdE5WID0gc2F0dXJhdGUoIGRvdCggZ2VvbWV0cnlOb3JtYWwsIGdlb21ldHJ5Vmlld0RpciApICk7XG5cdFx0cmVmbGVjdGVkTGlnaHQuaW5kaXJlY3RTcGVjdWxhciAqPSBjb21wdXRlU3BlY3VsYXJPY2NsdXNpb24oIGRvdE5WLCBhbWJpZW50T2NjbHVzaW9uLCBtYXRlcmlhbC5yb3VnaG5lc3MgKTtcblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIGFvbWFwX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9BT01BUFxuXHR1bmlmb3JtIHNhbXBsZXIyRCBhb01hcDtcblx0dW5pZm9ybSBmbG9hdCBhb01hcEludGVuc2l0eTtcbiNlbmRpZiI7Cgp2YXIgYmF0Y2hpbmdfcGFyc192ZXJ0ZXggPSAiI2lmZGVmIFVTRV9CQVRDSElOR1xuXHRhdHRyaWJ1dGUgZmxvYXQgYmF0Y2hJZDtcblx0dW5pZm9ybSBoaWdocCBzYW1wbGVyMkQgYmF0Y2hpbmdUZXh0dXJlO1xuXHRtYXQ0IGdldEJhdGNoaW5nTWF0cml4KCBjb25zdCBpbiBmbG9hdCBpICkge1xuXHRcdGludCBzaXplID0gdGV4dHVyZVNpemUoIGJhdGNoaW5nVGV4dHVyZSwgMCApLng7XG5cdFx0aW50IGogPSBpbnQoIGkgKSAqIDQ7XG5cdFx0aW50IHggPSBqICUgc2l6ZTtcblx0XHRpbnQgeSA9IGogLyBzaXplO1xuXHRcdHZlYzQgdjEgPSB0ZXhlbEZldGNoKCBiYXRjaGluZ1RleHR1cmUsIGl2ZWMyKCB4LCB5ICksIDAgKTtcblx0XHR2ZWM0IHYyID0gdGV4ZWxGZXRjaCggYmF0Y2hpbmdUZXh0dXJlLCBpdmVjMiggeCArIDEsIHkgKSwgMCApO1xuXHRcdHZlYzQgdjMgPSB0ZXhlbEZldGNoKCBiYXRjaGluZ1RleHR1cmUsIGl2ZWMyKCB4ICsgMiwgeSApLCAwICk7XG5cdFx0dmVjNCB2NCA9IHRleGVsRmV0Y2goIGJhdGNoaW5nVGV4dHVyZSwgaXZlYzIoIHggKyAzLCB5ICksIDAgKTtcblx0XHRyZXR1cm4gbWF0NCggdjEsIHYyLCB2MywgdjQgKTtcblx0fVxuI2VuZGlmIjsKCnZhciBiYXRjaGluZ192ZXJ0ZXggPSAiI2lmZGVmIFVTRV9CQVRDSElOR1xuXHRtYXQ0IGJhdGNoaW5nTWF0cml4ID0gZ2V0QmF0Y2hpbmdNYXRyaXgoIGJhdGNoSWQgKTtcbiNlbmRpZiI7Cgp2YXIgYmVnaW5fdmVydGV4ID0gInZlYzMgdHJhbnNmb3JtZWQgPSB2ZWMzKCBwb3NpdGlvbiApO1xuI2lmZGVmIFVTRV9BTFBIQUhBU0hcblx0dlBvc2l0aW9uID0gdmVjMyggcG9zaXRpb24gKTtcbiNlbmRpZiI7Cgp2YXIgYmVnaW5ub3JtYWxfdmVydGV4ID0gInZlYzMgb2JqZWN0Tm9ybWFsID0gdmVjMyggbm9ybWFsICk7XG4jaWZkZWYgVVNFX1RBTkdFTlRcblx0dmVjMyBvYmplY3RUYW5nZW50ID0gdmVjMyggdGFuZ2VudC54eXogKTtcbiNlbmRpZiI7Cgp2YXIgYnNkZnMgPSAiZmxvYXQgR19CbGlublBob25nX0ltcGxpY2l0KCApIHtcblx0cmV0dXJuIDAuMjU7XG59XG5mbG9hdCBEX0JsaW5uUGhvbmcoIGNvbnN0IGluIGZsb2F0IHNoaW5pbmVzcywgY29uc3QgaW4gZmxvYXQgZG90TkggKSB7XG5cdHJldHVybiBSRUNJUFJPQ0FMX1BJICogKCBzaGluaW5lc3MgKiAwLjUgKyAxLjAgKSAqIHBvdyggZG90TkgsIHNoaW5pbmVzcyApO1xufVxudmVjMyBCUkRGX0JsaW5uUGhvbmcoIGNvbnN0IGluIHZlYzMgbGlnaHREaXIsIGNvbnN0IGluIHZlYzMgdmlld0RpciwgY29uc3QgaW4gdmVjMyBub3JtYWwsIGNvbnN0IGluIHZlYzMgc3BlY3VsYXJDb2xvciwgY29uc3QgaW4gZmxvYXQgc2hpbmluZXNzICkge1xuXHR2ZWMzIGhhbGZEaXIgPSBub3JtYWxpemUoIGxpZ2h0RGlyICsgdmlld0RpciApO1xuXHRmbG9hdCBkb3ROSCA9IHNhdHVyYXRlKCBkb3QoIG5vcm1hbCwgaGFsZkRpciApICk7XG5cdGZsb2F0IGRvdFZIID0gc2F0dXJhdGUoIGRvdCggdmlld0RpciwgaGFsZkRpciApICk7XG5cdHZlYzMgRiA9IEZfU2NobGljayggc3BlY3VsYXJDb2xvciwgMS4wLCBkb3RWSCApO1xuXHRmbG9hdCBHID0gR19CbGlublBob25nX0ltcGxpY2l0KCApO1xuXHRmbG9hdCBEID0gRF9CbGlublBob25nKCBzaGluaW5lc3MsIGRvdE5IICk7XG5cdHJldHVybiBGICogKCBHICogRCApO1xufSAvLyB2YWxpZGF0ZWQiOwoKdmFyIGlyaWRlc2NlbmNlX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfSVJJREVTQ0VOQ0Vcblx0Y29uc3QgbWF0MyBYWVpfVE9fUkVDNzA5ID0gbWF0Myhcblx0XHQgMy4yNDA0NTQyLCAtMC45NjkyNjYwLCAgMC4wNTU2NDM0LFxuXHRcdC0xLjUzNzEzODUsICAxLjg3NjAxMDgsIC0wLjIwNDAyNTksXG5cdFx0LTAuNDk4NTMxNCwgIDAuMDQxNTU2MCwgIDEuMDU3MjI1MlxuXHQpO1xuXHR2ZWMzIEZyZXNuZWwwVG9Jb3IoIHZlYzMgZnJlc25lbDAgKSB7XG5cdFx0dmVjMyBzcXJ0RjAgPSBzcXJ0KCBmcmVzbmVsMCApO1xuXHRcdHJldHVybiAoIHZlYzMoIDEuMCApICsgc3FydEYwICkgLyAoIHZlYzMoIDEuMCApIC0gc3FydEYwICk7XG5cdH1cblx0dmVjMyBJb3JUb0ZyZXNuZWwwKCB2ZWMzIHRyYW5zbWl0dGVkSW9yLCBmbG9hdCBpbmNpZGVudElvciApIHtcblx0XHRyZXR1cm4gcG93MiggKCB0cmFuc21pdHRlZElvciAtIHZlYzMoIGluY2lkZW50SW9yICkgKSAvICggdHJhbnNtaXR0ZWRJb3IgKyB2ZWMzKCBpbmNpZGVudElvciApICkgKTtcblx0fVxuXHRmbG9hdCBJb3JUb0ZyZXNuZWwwKCBmbG9hdCB0cmFuc21pdHRlZElvciwgZmxvYXQgaW5jaWRlbnRJb3IgKSB7XG5cdFx0cmV0dXJuIHBvdzIoICggdHJhbnNtaXR0ZWRJb3IgLSBpbmNpZGVudElvciApIC8gKCB0cmFuc21pdHRlZElvciArIGluY2lkZW50SW9yICkpO1xuXHR9XG5cdHZlYzMgZXZhbFNlbnNpdGl2aXR5KCBmbG9hdCBPUEQsIHZlYzMgc2hpZnQgKSB7XG5cdFx0ZmxvYXQgcGhhc2UgPSAyLjAgKiBQSSAqIE9QRCAqIDEuMGUtOTtcblx0XHR2ZWMzIHZhbCA9IHZlYzMoIDUuNDg1NmUtMTMsIDQuNDIwMWUtMTMsIDUuMjQ4MWUtMTMgKTtcblx0XHR2ZWMzIHBvcyA9IHZlYzMoIDEuNjgxMGUrMDYsIDEuNzk1M2UrMDYsIDIuMjA4NGUrMDYgKTtcblx0XHR2ZWMzIHZhciA9IHZlYzMoIDQuMzI3OGUrMDksIDkuMzA0NmUrMDksIDYuNjEyMWUrMDkgKTtcblx0XHR2ZWMzIHh5eiA9IHZhbCAqIHNxcnQoIDIuMCAqIFBJICogdmFyICkgKiBjb3MoIHBvcyAqIHBoYXNlICsgc2hpZnQgKSAqIGV4cCggLSBwb3cyKCBwaGFzZSApICogdmFyICk7XG5cdFx0eHl6LnggKz0gOS43NDcwZS0xNCAqIHNxcnQoIDIuMCAqIFBJICogNC41MjgyZSswOSApICogY29zKCAyLjIzOTllKzA2ICogcGhhc2UgKyBzaGlmdFsgMCBdICkgKiBleHAoIC0gNC41MjgyZSswOSAqIHBvdzIoIHBoYXNlICkgKTtcblx0XHR4eXogLz0gMS4wNjg1ZS03O1xuXHRcdHZlYzMgcmdiID0gWFlaX1RPX1JFQzcwOSAqIHh5ejtcblx0XHRyZXR1cm4gcmdiO1xuXHR9XG5cdHZlYzMgZXZhbElyaWRlc2NlbmNlKCBmbG9hdCBvdXRzaWRlSU9SLCBmbG9hdCBldGEyLCBmbG9hdCBjb3NUaGV0YTEsIGZsb2F0IHRoaW5GaWxtVGhpY2tuZXNzLCB2ZWMzIGJhc2VGMCApIHtcblx0XHR2ZWMzIEk7XG5cdFx0ZmxvYXQgaXJpZGVzY2VuY2VJT1IgPSBtaXgoIG91dHNpZGVJT1IsIGV0YTIsIHNtb290aHN0ZXAoIDAuMCwgMC4wMywgdGhpbkZpbG1UaGlja25lc3MgKSApO1xuXHRcdGZsb2F0IHNpblRoZXRhMlNxID0gcG93Miggb3V0c2lkZUlPUiAvIGlyaWRlc2NlbmNlSU9SICkgKiAoIDEuMCAtIHBvdzIoIGNvc1RoZXRhMSApICk7XG5cdFx0ZmxvYXQgY29zVGhldGEyU3EgPSAxLjAgLSBzaW5UaGV0YTJTcTtcblx0XHRpZiAoIGNvc1RoZXRhMlNxIDwgMC4wICkge1xuXHRcdFx0cmV0dXJuIHZlYzMoIDEuMCApO1xuXHRcdH1cblx0XHRmbG9hdCBjb3NUaGV0YTIgPSBzcXJ0KCBjb3NUaGV0YTJTcSApO1xuXHRcdGZsb2F0IFIwID0gSW9yVG9GcmVzbmVsMCggaXJpZGVzY2VuY2VJT1IsIG91dHNpZGVJT1IgKTtcblx0XHRmbG9hdCBSMTIgPSBGX1NjaGxpY2soIFIwLCAxLjAsIGNvc1RoZXRhMSApO1xuXHRcdGZsb2F0IFQxMjEgPSAxLjAgLSBSMTI7XG5cdFx0ZmxvYXQgcGhpMTIgPSAwLjA7XG5cdFx0aWYgKCBpcmlkZXNjZW5jZUlPUiA8IG91dHNpZGVJT1IgKSBwaGkxMiA9IFBJO1xuXHRcdGZsb2F0IHBoaTIxID0gUEkgLSBwaGkxMjtcblx0XHR2ZWMzIGJhc2VJT1IgPSBGcmVzbmVsMFRvSW9yKCBjbGFtcCggYmFzZUYwLCAwLjAsIDAuOTk5OSApICk7XHRcdHZlYzMgUjEgPSBJb3JUb0ZyZXNuZWwwKCBiYXNlSU9SLCBpcmlkZXNjZW5jZUlPUiApO1xuXHRcdHZlYzMgUjIzID0gRl9TY2hsaWNrKCBSMSwgMS4wLCBjb3NUaGV0YTIgKTtcblx0XHR2ZWMzIHBoaTIzID0gdmVjMyggMC4wICk7XG5cdFx0aWYgKCBiYXNlSU9SWyAwIF0gPCBpcmlkZXNjZW5jZUlPUiApIHBoaTIzWyAwIF0gPSBQSTtcblx0XHRpZiAoIGJhc2VJT1JbIDEgXSA8IGlyaWRlc2NlbmNlSU9SICkgcGhpMjNbIDEgXSA9IFBJO1xuXHRcdGlmICggYmFzZUlPUlsgMiBdIDwgaXJpZGVzY2VuY2VJT1IgKSBwaGkyM1sgMiBdID0gUEk7XG5cdFx0ZmxvYXQgT1BEID0gMi4wICogaXJpZGVzY2VuY2VJT1IgKiB0aGluRmlsbVRoaWNrbmVzcyAqIGNvc1RoZXRhMjtcblx0XHR2ZWMzIHBoaSA9IHZlYzMoIHBoaTIxICkgKyBwaGkyMztcblx0XHR2ZWMzIFIxMjMgPSBjbGFtcCggUjEyICogUjIzLCAxZS01LCAwLjk5OTkgKTtcblx0XHR2ZWMzIHIxMjMgPSBzcXJ0KCBSMTIzICk7XG5cdFx0dmVjMyBScyA9IHBvdzIoIFQxMjEgKSAqIFIyMyAvICggdmVjMyggMS4wICkgLSBSMTIzICk7XG5cdFx0dmVjMyBDMCA9IFIxMiArIFJzO1xuXHRcdEkgPSBDMDtcblx0XHR2ZWMzIENtID0gUnMgLSBUMTIxO1xuXHRcdGZvciAoIGludCBtID0gMTsgbSA8PSAyOyArKyBtICkge1xuXHRcdFx0Q20gKj0gcjEyMztcblx0XHRcdHZlYzMgU20gPSAyLjAgKiBldmFsU2Vuc2l0aXZpdHkoIGZsb2F0KCBtICkgKiBPUEQsIGZsb2F0KCBtICkgKiBwaGkgKTtcblx0XHRcdEkgKz0gQ20gKiBTbTtcblx0XHR9XG5cdFx0cmV0dXJuIG1heCggSSwgdmVjMyggMC4wICkgKTtcblx0fVxuI2VuZGlmIjsKCnZhciBidW1wbWFwX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9CVU1QTUFQXG5cdHVuaWZvcm0gc2FtcGxlcjJEIGJ1bXBNYXA7XG5cdHVuaWZvcm0gZmxvYXQgYnVtcFNjYWxlO1xuXHR2ZWMyIGRIZHh5X2Z3ZCgpIHtcblx0XHR2ZWMyIGRTVGR4ID0gZEZkeCggdkJ1bXBNYXBVdiApO1xuXHRcdHZlYzIgZFNUZHkgPSBkRmR5KCB2QnVtcE1hcFV2ICk7XG5cdFx0ZmxvYXQgSGxsID0gYnVtcFNjYWxlICogdGV4dHVyZTJEKCBidW1wTWFwLCB2QnVtcE1hcFV2ICkueDtcblx0XHRmbG9hdCBkQnggPSBidW1wU2NhbGUgKiB0ZXh0dXJlMkQoIGJ1bXBNYXAsIHZCdW1wTWFwVXYgKyBkU1RkeCApLnggLSBIbGw7XG5cdFx0ZmxvYXQgZEJ5ID0gYnVtcFNjYWxlICogdGV4dHVyZTJEKCBidW1wTWFwLCB2QnVtcE1hcFV2ICsgZFNUZHkgKS54IC0gSGxsO1xuXHRcdHJldHVybiB2ZWMyKCBkQngsIGRCeSApO1xuXHR9XG5cdHZlYzMgcGVydHVyYk5vcm1hbEFyYiggdmVjMyBzdXJmX3BvcywgdmVjMyBzdXJmX25vcm0sIHZlYzIgZEhkeHksIGZsb2F0IGZhY2VEaXJlY3Rpb24gKSB7XG5cdFx0dmVjMyB2U2lnbWFYID0gbm9ybWFsaXplKCBkRmR4KCBzdXJmX3Bvcy54eXogKSApO1xuXHRcdHZlYzMgdlNpZ21hWSA9IG5vcm1hbGl6ZSggZEZkeSggc3VyZl9wb3MueHl6ICkgKTtcblx0XHR2ZWMzIHZOID0gc3VyZl9ub3JtO1xuXHRcdHZlYzMgUjEgPSBjcm9zcyggdlNpZ21hWSwgdk4gKTtcblx0XHR2ZWMzIFIyID0gY3Jvc3MoIHZOLCB2U2lnbWFYICk7XG5cdFx0ZmxvYXQgZkRldCA9IGRvdCggdlNpZ21hWCwgUjEgKSAqIGZhY2VEaXJlY3Rpb247XG5cdFx0dmVjMyB2R3JhZCA9IHNpZ24oIGZEZXQgKSAqICggZEhkeHkueCAqIFIxICsgZEhkeHkueSAqIFIyICk7XG5cdFx0cmV0dXJuIG5vcm1hbGl6ZSggYWJzKCBmRGV0ICkgKiBzdXJmX25vcm0gLSB2R3JhZCApO1xuXHR9XG4jZW5kaWYiOwoKdmFyIGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudCA9ICIjaWYgTlVNX0NMSVBQSU5HX1BMQU5FUyA+IDBcblx0dmVjNCBwbGFuZTtcblx0I2lmZGVmIEFMUEhBX1RPX0NPVkVSQUdFXG5cdFx0ZmxvYXQgZGlzdGFuY2VUb1BsYW5lLCBkaXN0YW5jZUdyYWRpZW50O1xuXHRcdGZsb2F0IGNsaXBPcGFjaXR5ID0gMS4wO1xuXHRcdCNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnRcblx0XHRmb3IgKCBpbnQgaSA9IDA7IGkgPCBVTklPTl9DTElQUElOR19QTEFORVM7IGkgKysgKSB7XG5cdFx0XHRwbGFuZSA9IGNsaXBwaW5nUGxhbmVzWyBpIF07XG5cdFx0XHRkaXN0YW5jZVRvUGxhbmUgPSAtIGRvdCggdkNsaXBQb3NpdGlvbiwgcGxhbmUueHl6ICkgKyBwbGFuZS53O1xuXHRcdFx0ZGlzdGFuY2VHcmFkaWVudCA9IGZ3aWR0aCggZGlzdGFuY2VUb1BsYW5lICkgLyAyLjA7XG5cdFx0XHRjbGlwT3BhY2l0eSAqPSBzbW9vdGhzdGVwKCAtIGRpc3RhbmNlR3JhZGllbnQsIGRpc3RhbmNlR3JhZGllbnQsIGRpc3RhbmNlVG9QbGFuZSApO1xuXHRcdFx0aWYgKCBjbGlwT3BhY2l0eSA9PSAwLjAgKSBkaXNjYXJkO1xuXHRcdH1cblx0XHQjcHJhZ21hIHVucm9sbF9sb29wX2VuZFxuXHRcdCNpZiBVTklPTl9DTElQUElOR19QTEFORVMgPCBOVU1fQ0xJUFBJTkdfUExBTkVTXG5cdFx0XHRmbG9hdCB1bmlvbkNsaXBPcGFjaXR5ID0gMS4wO1xuXHRcdFx0I3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydFxuXHRcdFx0Zm9yICggaW50IGkgPSBVTklPTl9DTElQUElOR19QTEFORVM7IGkgPCBOVU1fQ0xJUFBJTkdfUExBTkVTOyBpICsrICkge1xuXHRcdFx0XHRwbGFuZSA9IGNsaXBwaW5nUGxhbmVzWyBpIF07XG5cdFx0XHRcdGRpc3RhbmNlVG9QbGFuZSA9IC0gZG90KCB2Q2xpcFBvc2l0aW9uLCBwbGFuZS54eXogKSArIHBsYW5lLnc7XG5cdFx0XHRcdGRpc3RhbmNlR3JhZGllbnQgPSBmd2lkdGgoIGRpc3RhbmNlVG9QbGFuZSApIC8gMi4wO1xuXHRcdFx0XHR1bmlvbkNsaXBPcGFjaXR5ICo9IDEuMCAtIHNtb290aHN0ZXAoIC0gZGlzdGFuY2VHcmFkaWVudCwgZGlzdGFuY2VHcmFkaWVudCwgZGlzdGFuY2VUb1BsYW5lICk7XG5cdFx0XHR9XG5cdFx0XHQjcHJhZ21hIHVucm9sbF9sb29wX2VuZFxuXHRcdFx0Y2xpcE9wYWNpdHkgKj0gMS4wIC0gdW5pb25DbGlwT3BhY2l0eTtcblx0XHQjZW5kaWZcblx0XHRkaWZmdXNlQ29sb3IuYSAqPSBjbGlwT3BhY2l0eTtcblx0XHRpZiAoIGRpZmZ1c2VDb2xvci5hID09IDAuMCApIGRpc2NhcmQ7XG5cdCNlbHNlXG5cdFx0I3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydFxuXHRcdGZvciAoIGludCBpID0gMDsgaSA8IFVOSU9OX0NMSVBQSU5HX1BMQU5FUzsgaSArKyApIHtcblx0XHRcdHBsYW5lID0gY2xpcHBpbmdQbGFuZXNbIGkgXTtcblx0XHRcdGlmICggZG90KCB2Q2xpcFBvc2l0aW9uLCBwbGFuZS54eXogKSA+IHBsYW5lLncgKSBkaXNjYXJkO1xuXHRcdH1cblx0XHQjcHJhZ21hIHVucm9sbF9sb29wX2VuZFxuXHRcdCNpZiBVTklPTl9DTElQUElOR19QTEFORVMgPCBOVU1fQ0xJUFBJTkdfUExBTkVTXG5cdFx0XHRib29sIGNsaXBwZWQgPSB0cnVlO1xuXHRcdFx0I3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydFxuXHRcdFx0Zm9yICggaW50IGkgPSBVTklPTl9DTElQUElOR19QTEFORVM7IGkgPCBOVU1fQ0xJUFBJTkdfUExBTkVTOyBpICsrICkge1xuXHRcdFx0XHRwbGFuZSA9IGNsaXBwaW5nUGxhbmVzWyBpIF07XG5cdFx0XHRcdGNsaXBwZWQgPSAoIGRvdCggdkNsaXBQb3NpdGlvbiwgcGxhbmUueHl6ICkgPiBwbGFuZS53ICkgJiYgY2xpcHBlZDtcblx0XHRcdH1cblx0XHRcdCNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kXG5cdFx0XHRpZiAoIGNsaXBwZWQgKSBkaXNjYXJkO1xuXHRcdCNlbmRpZlxuXHQjZW5kaWZcbiNlbmRpZiI7Cgp2YXIgY2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQgPSAiI2lmIE5VTV9DTElQUElOR19QTEFORVMgPiAwXG5cdHZhcnlpbmcgdmVjMyB2Q2xpcFBvc2l0aW9uO1xuXHR1bmlmb3JtIHZlYzQgY2xpcHBpbmdQbGFuZXNbIE5VTV9DTElQUElOR19QTEFORVMgXTtcbiNlbmRpZiI7Cgp2YXIgY2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4ID0gIiNpZiBOVU1fQ0xJUFBJTkdfUExBTkVTID4gMFxuXHR2YXJ5aW5nIHZlYzMgdkNsaXBQb3NpdGlvbjtcbiNlbmRpZiI7Cgp2YXIgY2xpcHBpbmdfcGxhbmVzX3ZlcnRleCA9ICIjaWYgTlVNX0NMSVBQSU5HX1BMQU5FUyA+IDBcblx0dkNsaXBQb3NpdGlvbiA9IC0gbXZQb3NpdGlvbi54eXo7XG4jZW5kaWYiOwoKdmFyIGNvbG9yX2ZyYWdtZW50ID0gIiNpZiBkZWZpbmVkKCBVU0VfQ09MT1JfQUxQSEEgKVxuXHRkaWZmdXNlQ29sb3IgKj0gdkNvbG9yO1xuI2VsaWYgZGVmaW5lZCggVVNFX0NPTE9SIClcblx0ZGlmZnVzZUNvbG9yLnJnYiAqPSB2Q29sb3I7XG4jZW5kaWYiOwoKdmFyIGNvbG9yX3BhcnNfZnJhZ21lbnQgPSAiI2lmIGRlZmluZWQoIFVTRV9DT0xPUl9BTFBIQSApXG5cdHZhcnlpbmcgdmVjNCB2Q29sb3I7XG4jZWxpZiBkZWZpbmVkKCBVU0VfQ09MT1IgKVxuXHR2YXJ5aW5nIHZlYzMgdkNvbG9yO1xuI2VuZGlmIjsKCnZhciBjb2xvcl9wYXJzX3ZlcnRleCA9ICIjaWYgZGVmaW5lZCggVVNFX0NPTE9SX0FMUEhBIClcblx0dmFyeWluZyB2ZWM0IHZDb2xvcjtcbiNlbGlmIGRlZmluZWQoIFVTRV9DT0xPUiApIHx8IGRlZmluZWQoIFVTRV9JTlNUQU5DSU5HX0NPTE9SIClcblx0dmFyeWluZyB2ZWMzIHZDb2xvcjtcbiNlbmRpZiI7Cgp2YXIgY29sb3JfdmVydGV4ID0gIiNpZiBkZWZpbmVkKCBVU0VfQ09MT1JfQUxQSEEgKVxuXHR2Q29sb3IgPSB2ZWM0KCAxLjAgKTtcbiNlbGlmIGRlZmluZWQoIFVTRV9DT0xPUiApIHx8IGRlZmluZWQoIFVTRV9JTlNUQU5DSU5HX0NPTE9SIClcblx0dkNvbG9yID0gdmVjMyggMS4wICk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfQ09MT1Jcblx0dkNvbG9yICo9IGNvbG9yO1xuI2VuZGlmXG4jaWZkZWYgVVNFX0lOU1RBTkNJTkdfQ09MT1Jcblx0dkNvbG9yLnh5eiAqPSBpbnN0YW5jZUNvbG9yLnh5ejtcbiNlbmRpZiI7Cgp2YXIgY29tbW9uID0gIiNkZWZpbmUgUEkgMy4xNDE1OTI2NTM1ODk3OTNcbiNkZWZpbmUgUEkyIDYuMjgzMTg1MzA3MTc5NTg2XG4jZGVmaW5lIFBJX0hBTEYgMS41NzA3OTYzMjY3OTQ4OTY2XG4jZGVmaW5lIFJFQ0lQUk9DQUxfUEkgMC4zMTgzMDk4ODYxODM3OTA3XG4jZGVmaW5lIFJFQ0lQUk9DQUxfUEkyIDAuMTU5MTU0OTQzMDkxODk1MzVcbiNkZWZpbmUgRVBTSUxPTiAxZS02XG4jaWZuZGVmIHNhdHVyYXRlXG4jZGVmaW5lIHNhdHVyYXRlKCBhICkgY2xhbXAoIGEsIDAuMCwgMS4wIClcbiNlbmRpZlxuI2RlZmluZSB3aGl0ZUNvbXBsZW1lbnQoIGEgKSAoIDEuMCAtIHNhdHVyYXRlKCBhICkgKVxuZmxvYXQgcG93MiggY29uc3QgaW4gZmxvYXQgeCApIHsgcmV0dXJuIHgqeDsgfVxudmVjMyBwb3cyKCBjb25zdCBpbiB2ZWMzIHggKSB7IHJldHVybiB4Kng7IH1cbmZsb2F0IHBvdzMoIGNvbnN0IGluIGZsb2F0IHggKSB7IHJldHVybiB4KngqeDsgfVxuZmxvYXQgcG93NCggY29uc3QgaW4gZmxvYXQgeCApIHsgZmxvYXQgeDIgPSB4Kng7IHJldHVybiB4Mip4MjsgfVxuZmxvYXQgbWF4MyggY29uc3QgaW4gdmVjMyB2ICkgeyByZXR1cm4gbWF4KCBtYXgoIHYueCwgdi55ICksIHYueiApOyB9XG5mbG9hdCBhdmVyYWdlKCBjb25zdCBpbiB2ZWMzIHYgKSB7IHJldHVybiBkb3QoIHYsIHZlYzMoIDAuMzMzMzMzMyApICk7IH1cbmhpZ2hwIGZsb2F0IHJhbmQoIGNvbnN0IGluIHZlYzIgdXYgKSB7XG5cdGNvbnN0IGhpZ2hwIGZsb2F0IGEgPSAxMi45ODk4LCBiID0gNzguMjMzLCBjID0gNDM3NTguNTQ1Mztcblx0aGlnaHAgZmxvYXQgZHQgPSBkb3QoIHV2Lnh5LCB2ZWMyKCBhLGIgKSApLCBzbiA9IG1vZCggZHQsIFBJICk7XG5cdHJldHVybiBmcmFjdCggc2luKCBzbiApICogYyApO1xufVxuI2lmZGVmIEhJR0hfUFJFQ0lTSU9OXG5cdGZsb2F0IHByZWNpc2lvblNhZmVMZW5ndGgoIHZlYzMgdiApIHsgcmV0dXJuIGxlbmd0aCggdiApOyB9XG4jZWxzZVxuXHRmbG9hdCBwcmVjaXNpb25TYWZlTGVuZ3RoKCB2ZWMzIHYgKSB7XG5cdFx0ZmxvYXQgbWF4Q29tcG9uZW50ID0gbWF4MyggYWJzKCB2ICkgKTtcblx0XHRyZXR1cm4gbGVuZ3RoKCB2IC8gbWF4Q29tcG9uZW50ICkgKiBtYXhDb21wb25lbnQ7XG5cdH1cbiNlbmRpZlxuc3RydWN0IEluY2lkZW50TGlnaHQge1xuXHR2ZWMzIGNvbG9yO1xuXHR2ZWMzIGRpcmVjdGlvbjtcblx0Ym9vbCB2aXNpYmxlO1xufTtcbnN0cnVjdCBSZWZsZWN0ZWRMaWdodCB7XG5cdHZlYzMgZGlyZWN0RGlmZnVzZTtcblx0dmVjMyBkaXJlY3RTcGVjdWxhcjtcblx0dmVjMyBpbmRpcmVjdERpZmZ1c2U7XG5cdHZlYzMgaW5kaXJlY3RTcGVjdWxhcjtcbn07XG4jaWZkZWYgVVNFX0FMUEhBSEFTSFxuXHR2YXJ5aW5nIHZlYzMgdlBvc2l0aW9uO1xuI2VuZGlmXG52ZWMzIHRyYW5zZm9ybURpcmVjdGlvbiggaW4gdmVjMyBkaXIsIGluIG1hdDQgbWF0cml4ICkge1xuXHRyZXR1cm4gbm9ybWFsaXplKCAoIG1hdHJpeCAqIHZlYzQoIGRpciwgMC4wICkgKS54eXogKTtcbn1cbnZlYzMgaW52ZXJzZVRyYW5zZm9ybURpcmVjdGlvbiggaW4gdmVjMyBkaXIsIGluIG1hdDQgbWF0cml4ICkge1xuXHRyZXR1cm4gbm9ybWFsaXplKCAoIHZlYzQoIGRpciwgMC4wICkgKiBtYXRyaXggKS54eXogKTtcbn1cbm1hdDMgdHJhbnNwb3NlTWF0MyggY29uc3QgaW4gbWF0MyBtICkge1xuXHRtYXQzIHRtcDtcblx0dG1wWyAwIF0gPSB2ZWMzKCBtWyAwIF0ueCwgbVsgMSBdLngsIG1bIDIgXS54ICk7XG5cdHRtcFsgMSBdID0gdmVjMyggbVsgMCBdLnksIG1bIDEgXS55LCBtWyAyIF0ueSApO1xuXHR0bXBbIDIgXSA9IHZlYzMoIG1bIDAgXS56LCBtWyAxIF0ueiwgbVsgMiBdLnogKTtcblx0cmV0dXJuIHRtcDtcbn1cbmZsb2F0IGx1bWluYW5jZSggY29uc3QgaW4gdmVjMyByZ2IgKSB7XG5cdGNvbnN0IHZlYzMgd2VpZ2h0cyA9IHZlYzMoIDAuMjEyNjcyOSwgMC43MTUxNTIyLCAwLjA3MjE3NTAgKTtcblx0cmV0dXJuIGRvdCggd2VpZ2h0cywgcmdiICk7XG59XG5ib29sIGlzUGVyc3BlY3RpdmVNYXRyaXgoIG1hdDQgbSApIHtcblx0cmV0dXJuIG1bIDIgXVsgMyBdID09IC0gMS4wO1xufVxudmVjMiBlcXVpcmVjdFV2KCBpbiB2ZWMzIGRpciApIHtcblx0ZmxvYXQgdSA9IGF0YW4oIGRpci56LCBkaXIueCApICogUkVDSVBST0NBTF9QSTIgKyAwLjU7XG5cdGZsb2F0IHYgPSBhc2luKCBjbGFtcCggZGlyLnksIC0gMS4wLCAxLjAgKSApICogUkVDSVBST0NBTF9QSSArIDAuNTtcblx0cmV0dXJuIHZlYzIoIHUsIHYgKTtcbn1cbnZlYzMgQlJERl9MYW1iZXJ0KCBjb25zdCBpbiB2ZWMzIGRpZmZ1c2VDb2xvciApIHtcblx0cmV0dXJuIFJFQ0lQUk9DQUxfUEkgKiBkaWZmdXNlQ29sb3I7XG59XG52ZWMzIEZfU2NobGljayggY29uc3QgaW4gdmVjMyBmMCwgY29uc3QgaW4gZmxvYXQgZjkwLCBjb25zdCBpbiBmbG9hdCBkb3RWSCApIHtcblx0ZmxvYXQgZnJlc25lbCA9IGV4cDIoICggLSA1LjU1NDczICogZG90VkggLSA2Ljk4MzE2ICkgKiBkb3RWSCApO1xuXHRyZXR1cm4gZjAgKiAoIDEuMCAtIGZyZXNuZWwgKSArICggZjkwICogZnJlc25lbCApO1xufVxuZmxvYXQgRl9TY2hsaWNrKCBjb25zdCBpbiBmbG9hdCBmMCwgY29uc3QgaW4gZmxvYXQgZjkwLCBjb25zdCBpbiBmbG9hdCBkb3RWSCApIHtcblx0ZmxvYXQgZnJlc25lbCA9IGV4cDIoICggLSA1LjU1NDczICogZG90VkggLSA2Ljk4MzE2ICkgKiBkb3RWSCApO1xuXHRyZXR1cm4gZjAgKiAoIDEuMCAtIGZyZXNuZWwgKSArICggZjkwICogZnJlc25lbCApO1xufSAvLyB2YWxpZGF0ZWQiOwoKdmFyIGN1YmVfdXZfcmVmbGVjdGlvbl9mcmFnbWVudCA9ICIjaWZkZWYgRU5WTUFQX1RZUEVfQ1VCRV9VVlxuXHQjZGVmaW5lIGN1YmVVVl9taW5NaXBMZXZlbCA0LjBcblx0I2RlZmluZSBjdWJlVVZfbWluVGlsZVNpemUgMTYuMFxuXHRmbG9hdCBnZXRGYWNlKCB2ZWMzIGRpcmVjdGlvbiApIHtcblx0XHR2ZWMzIGFic0RpcmVjdGlvbiA9IGFicyggZGlyZWN0aW9uICk7XG5cdFx0ZmxvYXQgZmFjZSA9IC0gMS4wO1xuXHRcdGlmICggYWJzRGlyZWN0aW9uLnggPiBhYnNEaXJlY3Rpb24ueiApIHtcblx0XHRcdGlmICggYWJzRGlyZWN0aW9uLnggPiBhYnNEaXJlY3Rpb24ueSApXG5cdFx0XHRcdGZhY2UgPSBkaXJlY3Rpb24ueCA+IDAuMCA/IDAuMCA6IDMuMDtcblx0XHRcdGVsc2Vcblx0XHRcdFx0ZmFjZSA9IGRpcmVjdGlvbi55ID4gMC4wID8gMS4wIDogNC4wO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRpZiAoIGFic0RpcmVjdGlvbi56ID4gYWJzRGlyZWN0aW9uLnkgKVxuXHRcdFx0XHRmYWNlID0gZGlyZWN0aW9uLnogPiAwLjAgPyAyLjAgOiA1LjA7XG5cdFx0XHRlbHNlXG5cdFx0XHRcdGZhY2UgPSBkaXJlY3Rpb24ueSA+IDAuMCA/IDEuMCA6IDQuMDtcblx0XHR9XG5cdFx0cmV0dXJuIGZhY2U7XG5cdH1cblx0dmVjMiBnZXRVViggdmVjMyBkaXJlY3Rpb24sIGZsb2F0IGZhY2UgKSB7XG5cdFx0dmVjMiB1djtcblx0XHRpZiAoIGZhY2UgPT0gMC4wICkge1xuXHRcdFx0dXYgPSB2ZWMyKCBkaXJlY3Rpb24ueiwgZGlyZWN0aW9uLnkgKSAvIGFicyggZGlyZWN0aW9uLnggKTtcblx0XHR9IGVsc2UgaWYgKCBmYWNlID09IDEuMCApIHtcblx0XHRcdHV2ID0gdmVjMiggLSBkaXJlY3Rpb24ueCwgLSBkaXJlY3Rpb24ueiApIC8gYWJzKCBkaXJlY3Rpb24ueSApO1xuXHRcdH0gZWxzZSBpZiAoIGZhY2UgPT0gMi4wICkge1xuXHRcdFx0dXYgPSB2ZWMyKCAtIGRpcmVjdGlvbi54LCBkaXJlY3Rpb24ueSApIC8gYWJzKCBkaXJlY3Rpb24ueiApO1xuXHRcdH0gZWxzZSBpZiAoIGZhY2UgPT0gMy4wICkge1xuXHRcdFx0dXYgPSB2ZWMyKCAtIGRpcmVjdGlvbi56LCBkaXJlY3Rpb24ueSApIC8gYWJzKCBkaXJlY3Rpb24ueCApO1xuXHRcdH0gZWxzZSBpZiAoIGZhY2UgPT0gNC4wICkge1xuXHRcdFx0dXYgPSB2ZWMyKCAtIGRpcmVjdGlvbi54LCBkaXJlY3Rpb24ueiApIC8gYWJzKCBkaXJlY3Rpb24ueSApO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHR1diA9IHZlYzIoIGRpcmVjdGlvbi54LCBkaXJlY3Rpb24ueSApIC8gYWJzKCBkaXJlY3Rpb24ueiApO1xuXHRcdH1cblx0XHRyZXR1cm4gMC41ICogKCB1diArIDEuMCApO1xuXHR9XG5cdHZlYzMgYmlsaW5lYXJDdWJlVVYoIHNhbXBsZXIyRCBlbnZNYXAsIHZlYzMgZGlyZWN0aW9uLCBmbG9hdCBtaXBJbnQgKSB7XG5cdFx0ZmxvYXQgZmFjZSA9IGdldEZhY2UoIGRpcmVjdGlvbiApO1xuXHRcdGZsb2F0IGZpbHRlckludCA9IG1heCggY3ViZVVWX21pbk1pcExldmVsIC0gbWlwSW50LCAwLjAgKTtcblx0XHRtaXBJbnQgPSBtYXgoIG1pcEludCwgY3ViZVVWX21pbk1pcExldmVsICk7XG5cdFx0ZmxvYXQgZmFjZVNpemUgPSBleHAyKCBtaXBJbnQgKTtcblx0XHRoaWdocCB2ZWMyIHV2ID0gZ2V0VVYoIGRpcmVjdGlvbiwgZmFjZSApICogKCBmYWNlU2l6ZSAtIDIuMCApICsgMS4wO1xuXHRcdGlmICggZmFjZSA+IDIuMCApIHtcblx0XHRcdHV2LnkgKz0gZmFjZVNpemU7XG5cdFx0XHRmYWNlIC09IDMuMDtcblx0XHR9XG5cdFx0dXYueCArPSBmYWNlICogZmFjZVNpemU7XG5cdFx0dXYueCArPSBmaWx0ZXJJbnQgKiAzLjAgKiBjdWJlVVZfbWluVGlsZVNpemU7XG5cdFx0dXYueSArPSA0LjAgKiAoIGV4cDIoIENVQkVVVl9NQVhfTUlQICkgLSBmYWNlU2l6ZSApO1xuXHRcdHV2LnggKj0gQ1VCRVVWX1RFWEVMX1dJRFRIO1xuXHRcdHV2LnkgKj0gQ1VCRVVWX1RFWEVMX0hFSUdIVDtcblx0XHQjaWZkZWYgdGV4dHVyZTJER3JhZEVYVFxuXHRcdFx0cmV0dXJuIHRleHR1cmUyREdyYWRFWFQoIGVudk1hcCwgdXYsIHZlYzIoIDAuMCApLCB2ZWMyKCAwLjAgKSApLnJnYjtcblx0XHQjZWxzZVxuXHRcdFx0cmV0dXJuIHRleHR1cmUyRCggZW52TWFwLCB1diApLnJnYjtcblx0XHQjZW5kaWZcblx0fVxuXHQjZGVmaW5lIGN1YmVVVl9yMCAxLjBcblx0I2RlZmluZSBjdWJlVVZfbTAgLSAyLjBcblx0I2RlZmluZSBjdWJlVVZfcjEgMC44XG5cdCNkZWZpbmUgY3ViZVVWX20xIC0gMS4wXG5cdCNkZWZpbmUgY3ViZVVWX3I0IDAuNFxuXHQjZGVmaW5lIGN1YmVVVl9tNCAyLjBcblx0I2RlZmluZSBjdWJlVVZfcjUgMC4zMDVcblx0I2RlZmluZSBjdWJlVVZfbTUgMy4wXG5cdCNkZWZpbmUgY3ViZVVWX3I2IDAuMjFcblx0I2RlZmluZSBjdWJlVVZfbTYgNC4wXG5cdGZsb2F0IHJvdWdobmVzc1RvTWlwKCBmbG9hdCByb3VnaG5lc3MgKSB7XG5cdFx0ZmxvYXQgbWlwID0gMC4wO1xuXHRcdGlmICggcm91Z2huZXNzID49IGN1YmVVVl9yMSApIHtcblx0XHRcdG1pcCA9ICggY3ViZVVWX3IwIC0gcm91Z2huZXNzICkgKiAoIGN1YmVVVl9tMSAtIGN1YmVVVl9tMCApIC8gKCBjdWJlVVZfcjAgLSBjdWJlVVZfcjEgKSArIGN1YmVVVl9tMDtcblx0XHR9IGVsc2UgaWYgKCByb3VnaG5lc3MgPj0gY3ViZVVWX3I0ICkge1xuXHRcdFx0bWlwID0gKCBjdWJlVVZfcjEgLSByb3VnaG5lc3MgKSAqICggY3ViZVVWX200IC0gY3ViZVVWX20xICkgLyAoIGN1YmVVVl9yMSAtIGN1YmVVVl9yNCApICsgY3ViZVVWX20xO1xuXHRcdH0gZWxzZSBpZiAoIHJvdWdobmVzcyA+PSBjdWJlVVZfcjUgKSB7XG5cdFx0XHRtaXAgPSAoIGN1YmVVVl9yNCAtIHJvdWdobmVzcyApICogKCBjdWJlVVZfbTUgLSBjdWJlVVZfbTQgKSAvICggY3ViZVVWX3I0IC0gY3ViZVVWX3I1ICkgKyBjdWJlVVZfbTQ7XG5cdFx0fSBlbHNlIGlmICggcm91Z2huZXNzID49IGN1YmVVVl9yNiApIHtcblx0XHRcdG1pcCA9ICggY3ViZVVWX3I1IC0gcm91Z2huZXNzICkgKiAoIGN1YmVVVl9tNiAtIGN1YmVVVl9tNSApIC8gKCBjdWJlVVZfcjUgLSBjdWJlVVZfcjYgKSArIGN1YmVVVl9tNTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0bWlwID0gLSAyLjAgKiBsb2cyKCAxLjE2ICogcm91Z2huZXNzICk7XHRcdH1cblx0XHRyZXR1cm4gbWlwO1xuXHR9XG5cdHZlYzQgdGV4dHVyZUN1YmVVViggc2FtcGxlcjJEIGVudk1hcCwgdmVjMyBzYW1wbGVEaXIsIGZsb2F0IHJvdWdobmVzcyApIHtcblx0XHRmbG9hdCBtaXAgPSBjbGFtcCggcm91Z2huZXNzVG9NaXAoIHJvdWdobmVzcyApLCBjdWJlVVZfbTAsIENVQkVVVl9NQVhfTUlQICk7XG5cdFx0ZmxvYXQgbWlwRiA9IGZyYWN0KCBtaXAgKTtcblx0XHRmbG9hdCBtaXBJbnQgPSBmbG9vciggbWlwICk7XG5cdFx0dmVjMyBjb2xvcjAgPSBiaWxpbmVhckN1YmVVViggZW52TWFwLCBzYW1wbGVEaXIsIG1pcEludCApO1xuXHRcdGlmICggbWlwRiA9PSAwLjAgKSB7XG5cdFx0XHRyZXR1cm4gdmVjNCggY29sb3IwLCAxLjAgKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dmVjMyBjb2xvcjEgPSBiaWxpbmVhckN1YmVVViggZW52TWFwLCBzYW1wbGVEaXIsIG1pcEludCArIDEuMCApO1xuXHRcdFx0cmV0dXJuIHZlYzQoIG1peCggY29sb3IwLCBjb2xvcjEsIG1pcEYgKSwgMS4wICk7XG5cdFx0fVxuXHR9XG4jZW5kaWYiOwoKdmFyIGRlZmF1bHRub3JtYWxfdmVydGV4ID0gInZlYzMgdHJhbnNmb3JtZWROb3JtYWwgPSBvYmplY3ROb3JtYWw7XG4jaWZkZWYgVVNFX1RBTkdFTlRcblx0dmVjMyB0cmFuc2Zvcm1lZFRhbmdlbnQgPSBvYmplY3RUYW5nZW50O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0JBVENISU5HXG5cdG1hdDMgYm0gPSBtYXQzKCBiYXRjaGluZ01hdHJpeCApO1xuXHR0cmFuc2Zvcm1lZE5vcm1hbCAvPSB2ZWMzKCBkb3QoIGJtWyAwIF0sIGJtWyAwIF0gKSwgZG90KCBibVsgMSBdLCBibVsgMSBdICksIGRvdCggYm1bIDIgXSwgYm1bIDIgXSApICk7XG5cdHRyYW5zZm9ybWVkTm9ybWFsID0gYm0gKiB0cmFuc2Zvcm1lZE5vcm1hbDtcblx0I2lmZGVmIFVTRV9UQU5HRU5UXG5cdFx0dHJhbnNmb3JtZWRUYW5nZW50ID0gYm0gKiB0cmFuc2Zvcm1lZFRhbmdlbnQ7XG5cdCNlbmRpZlxuI2VuZGlmXG4jaWZkZWYgVVNFX0lOU1RBTkNJTkdcblx0bWF0MyBpbSA9IG1hdDMoIGluc3RhbmNlTWF0cml4ICk7XG5cdHRyYW5zZm9ybWVkTm9ybWFsIC89IHZlYzMoIGRvdCggaW1bIDAgXSwgaW1bIDAgXSApLCBkb3QoIGltWyAxIF0sIGltWyAxIF0gKSwgZG90KCBpbVsgMiBdLCBpbVsgMiBdICkgKTtcblx0dHJhbnNmb3JtZWROb3JtYWwgPSBpbSAqIHRyYW5zZm9ybWVkTm9ybWFsO1xuXHQjaWZkZWYgVVNFX1RBTkdFTlRcblx0XHR0cmFuc2Zvcm1lZFRhbmdlbnQgPSBpbSAqIHRyYW5zZm9ybWVkVGFuZ2VudDtcblx0I2VuZGlmXG4jZW5kaWZcbnRyYW5zZm9ybWVkTm9ybWFsID0gbm9ybWFsTWF0cml4ICogdHJhbnNmb3JtZWROb3JtYWw7XG4jaWZkZWYgRkxJUF9TSURFRFxuXHR0cmFuc2Zvcm1lZE5vcm1hbCA9IC0gdHJhbnNmb3JtZWROb3JtYWw7XG4jZW5kaWZcbiNpZmRlZiBVU0VfVEFOR0VOVFxuXHR0cmFuc2Zvcm1lZFRhbmdlbnQgPSAoIG1vZGVsVmlld01hdHJpeCAqIHZlYzQoIHRyYW5zZm9ybWVkVGFuZ2VudCwgMC4wICkgKS54eXo7XG5cdCNpZmRlZiBGTElQX1NJREVEXG5cdFx0dHJhbnNmb3JtZWRUYW5nZW50ID0gLSB0cmFuc2Zvcm1lZFRhbmdlbnQ7XG5cdCNlbmRpZlxuI2VuZGlmIjsKCnZhciBkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXggPSAiI2lmZGVmIFVTRV9ESVNQTEFDRU1FTlRNQVBcblx0dW5pZm9ybSBzYW1wbGVyMkQgZGlzcGxhY2VtZW50TWFwO1xuXHR1bmlmb3JtIGZsb2F0IGRpc3BsYWNlbWVudFNjYWxlO1xuXHR1bmlmb3JtIGZsb2F0IGRpc3BsYWNlbWVudEJpYXM7XG4jZW5kaWYiOwoKdmFyIGRpc3BsYWNlbWVudG1hcF92ZXJ0ZXggPSAiI2lmZGVmIFVTRV9ESVNQTEFDRU1FTlRNQVBcblx0dHJhbnNmb3JtZWQgKz0gbm9ybWFsaXplKCBvYmplY3ROb3JtYWwgKSAqICggdGV4dHVyZTJEKCBkaXNwbGFjZW1lbnRNYXAsIHZEaXNwbGFjZW1lbnRNYXBVdiApLnggKiBkaXNwbGFjZW1lbnRTY2FsZSArIGRpc3BsYWNlbWVudEJpYXMgKTtcbiNlbmRpZiI7Cgp2YXIgZW1pc3NpdmVtYXBfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9FTUlTU0lWRU1BUFxuXHR2ZWM0IGVtaXNzaXZlQ29sb3IgPSB0ZXh0dXJlMkQoIGVtaXNzaXZlTWFwLCB2RW1pc3NpdmVNYXBVdiApO1xuXHR0b3RhbEVtaXNzaXZlUmFkaWFuY2UgKj0gZW1pc3NpdmVDb2xvci5yZ2I7XG4jZW5kaWYiOwoKdmFyIGVtaXNzaXZlbWFwX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9FTUlTU0lWRU1BUFxuXHR1bmlmb3JtIHNhbXBsZXIyRCBlbWlzc2l2ZU1hcDtcbiNlbmRpZiI7Cgp2YXIgY29sb3JzcGFjZV9mcmFnbWVudCA9ICJnbF9GcmFnQ29sb3IgPSBsaW5lYXJUb091dHB1dFRleGVsKCBnbF9GcmFnQ29sb3IgKTsiOwoKdmFyIGNvbG9yc3BhY2VfcGFyc19mcmFnbWVudCA9ICJcbmNvbnN0IG1hdDMgTElORUFSX1NSR0JfVE9fTElORUFSX0RJU1BMQVlfUDMgPSBtYXQzKFxuXHR2ZWMzKCAwLjgyMjQ2MjEsIDAuMTc3NTM4LCAwLjAgKSxcblx0dmVjMyggMC4wMzMxOTQxLCAwLjk2NjgwNTgsIDAuMCApLFxuXHR2ZWMzKCAwLjAxNzA4MjcsIDAuMDcyMzk3NCwgMC45MTA1MTk5IClcbik7XG5jb25zdCBtYXQzIExJTkVBUl9ESVNQTEFZX1AzX1RPX0xJTkVBUl9TUkdCID0gbWF0Myhcblx0dmVjMyggMS4yMjQ5NDAxLCAtIDAuMjI0OTQwNCwgMC4wICksXG5cdHZlYzMoIC0gMC4wNDIwNTY5LCAxLjA0MjA1NzEsIDAuMCApLFxuXHR2ZWMzKCAtIDAuMDE5NjM3NiwgLSAwLjA3ODYzNjEsIDEuMDk4MjczNSApXG4pO1xudmVjNCBMaW5lYXJTUkdCVG9MaW5lYXJEaXNwbGF5UDMoIGluIHZlYzQgdmFsdWUgKSB7XG5cdHJldHVybiB2ZWM0KCB2YWx1ZS5yZ2IgKiBMSU5FQVJfU1JHQl9UT19MSU5FQVJfRElTUExBWV9QMywgdmFsdWUuYSApO1xufVxudmVjNCBMaW5lYXJEaXNwbGF5UDNUb0xpbmVhclNSR0IoIGluIHZlYzQgdmFsdWUgKSB7XG5cdHJldHVybiB2ZWM0KCB2YWx1ZS5yZ2IgKiBMSU5FQVJfRElTUExBWV9QM19UT19MSU5FQVJfU1JHQiwgdmFsdWUuYSApO1xufVxudmVjNCBMaW5lYXJUcmFuc2Zlck9FVEYoIGluIHZlYzQgdmFsdWUgKSB7XG5cdHJldHVybiB2YWx1ZTtcbn1cbnZlYzQgc1JHQlRyYW5zZmVyT0VURiggaW4gdmVjNCB2YWx1ZSApIHtcblx0cmV0dXJuIHZlYzQoIG1peCggcG93KCB2YWx1ZS5yZ2IsIHZlYzMoIDAuNDE2NjYgKSApICogMS4wNTUgLSB2ZWMzKCAwLjA1NSApLCB2YWx1ZS5yZ2IgKiAxMi45MiwgdmVjMyggbGVzc1RoYW5FcXVhbCggdmFsdWUucmdiLCB2ZWMzKCAwLjAwMzEzMDggKSApICkgKSwgdmFsdWUuYSApO1xufVxudmVjNCBMaW5lYXJUb0xpbmVhciggaW4gdmVjNCB2YWx1ZSApIHtcblx0cmV0dXJuIHZhbHVlO1xufVxudmVjNCBMaW5lYXJUb3NSR0IoIGluIHZlYzQgdmFsdWUgKSB7XG5cdHJldHVybiBzUkdCVHJhbnNmZXJPRVRGKCB2YWx1ZSApO1xufSI7Cgp2YXIgZW52bWFwX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfRU5WTUFQXG5cdCNpZmRlZiBFTlZfV09STERQT1Ncblx0XHR2ZWMzIGNhbWVyYVRvRnJhZztcblx0XHRpZiAoIGlzT3J0aG9ncmFwaGljICkge1xuXHRcdFx0Y2FtZXJhVG9GcmFnID0gbm9ybWFsaXplKCB2ZWMzKCAtIHZpZXdNYXRyaXhbIDAgXVsgMiBdLCAtIHZpZXdNYXRyaXhbIDEgXVsgMiBdLCAtIHZpZXdNYXRyaXhbIDIgXVsgMiBdICkgKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y2FtZXJhVG9GcmFnID0gbm9ybWFsaXplKCB2V29ybGRQb3NpdGlvbiAtIGNhbWVyYVBvc2l0aW9uICk7XG5cdFx0fVxuXHRcdHZlYzMgd29ybGROb3JtYWwgPSBpbnZlcnNlVHJhbnNmb3JtRGlyZWN0aW9uKCBub3JtYWwsIHZpZXdNYXRyaXggKTtcblx0XHQjaWZkZWYgRU5WTUFQX01PREVfUkVGTEVDVElPTlxuXHRcdFx0dmVjMyByZWZsZWN0VmVjID0gcmVmbGVjdCggY2FtZXJhVG9GcmFnLCB3b3JsZE5vcm1hbCApO1xuXHRcdCNlbHNlXG5cdFx0XHR2ZWMzIHJlZmxlY3RWZWMgPSByZWZyYWN0KCBjYW1lcmFUb0ZyYWcsIHdvcmxkTm9ybWFsLCByZWZyYWN0aW9uUmF0aW8gKTtcblx0XHQjZW5kaWZcblx0I2Vsc2Vcblx0XHR2ZWMzIHJlZmxlY3RWZWMgPSB2UmVmbGVjdDtcblx0I2VuZGlmXG5cdCNpZmRlZiBFTlZNQVBfVFlQRV9DVUJFXG5cdFx0dmVjNCBlbnZDb2xvciA9IHRleHR1cmVDdWJlKCBlbnZNYXAsIHZlYzMoIGZsaXBFbnZNYXAgKiByZWZsZWN0VmVjLngsIHJlZmxlY3RWZWMueXogKSApO1xuXHQjZWxzZVxuXHRcdHZlYzQgZW52Q29sb3IgPSB2ZWM0KCAwLjAgKTtcblx0I2VuZGlmXG5cdCNpZmRlZiBFTlZNQVBfQkxFTkRJTkdfTVVMVElQTFlcblx0XHRvdXRnb2luZ0xpZ2h0ID0gbWl4KCBvdXRnb2luZ0xpZ2h0LCBvdXRnb2luZ0xpZ2h0ICogZW52Q29sb3IueHl6LCBzcGVjdWxhclN0cmVuZ3RoICogcmVmbGVjdGl2aXR5ICk7XG5cdCNlbGlmIGRlZmluZWQoIEVOVk1BUF9CTEVORElOR19NSVggKVxuXHRcdG91dGdvaW5nTGlnaHQgPSBtaXgoIG91dGdvaW5nTGlnaHQsIGVudkNvbG9yLnh5eiwgc3BlY3VsYXJTdHJlbmd0aCAqIHJlZmxlY3Rpdml0eSApO1xuXHQjZWxpZiBkZWZpbmVkKCBFTlZNQVBfQkxFTkRJTkdfQUREIClcblx0XHRvdXRnb2luZ0xpZ2h0ICs9IGVudkNvbG9yLnh5eiAqIHNwZWN1bGFyU3RyZW5ndGggKiByZWZsZWN0aXZpdHk7XG5cdCNlbmRpZlxuI2VuZGlmIjsKCnZhciBlbnZtYXBfY29tbW9uX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9FTlZNQVBcblx0dW5pZm9ybSBmbG9hdCBlbnZNYXBJbnRlbnNpdHk7XG5cdHVuaWZvcm0gZmxvYXQgZmxpcEVudk1hcDtcblx0I2lmZGVmIEVOVk1BUF9UWVBFX0NVQkVcblx0XHR1bmlmb3JtIHNhbXBsZXJDdWJlIGVudk1hcDtcblx0I2Vsc2Vcblx0XHR1bmlmb3JtIHNhbXBsZXIyRCBlbnZNYXA7XG5cdCNlbmRpZlxuXHRcbiNlbmRpZiI7Cgp2YXIgZW52bWFwX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9FTlZNQVBcblx0dW5pZm9ybSBmbG9hdCByZWZsZWN0aXZpdHk7XG5cdCNpZiBkZWZpbmVkKCBVU0VfQlVNUE1BUCApIHx8IGRlZmluZWQoIFVTRV9OT1JNQUxNQVAgKSB8fCBkZWZpbmVkKCBQSE9ORyApIHx8IGRlZmluZWQoIExBTUJFUlQgKVxuXHRcdCNkZWZpbmUgRU5WX1dPUkxEUE9TXG5cdCNlbmRpZlxuXHQjaWZkZWYgRU5WX1dPUkxEUE9TXG5cdFx0dmFyeWluZyB2ZWMzIHZXb3JsZFBvc2l0aW9uO1xuXHRcdHVuaWZvcm0gZmxvYXQgcmVmcmFjdGlvblJhdGlvO1xuXHQjZWxzZVxuXHRcdHZhcnlpbmcgdmVjMyB2UmVmbGVjdDtcblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIGVudm1hcF9wYXJzX3ZlcnRleCA9ICIjaWZkZWYgVVNFX0VOVk1BUFxuXHQjaWYgZGVmaW5lZCggVVNFX0JVTVBNQVAgKSB8fCBkZWZpbmVkKCBVU0VfTk9STUFMTUFQICkgfHwgZGVmaW5lZCggUEhPTkcgKSB8fCBkZWZpbmVkKCBMQU1CRVJUIClcblx0XHQjZGVmaW5lIEVOVl9XT1JMRFBPU1xuXHQjZW5kaWZcblx0I2lmZGVmIEVOVl9XT1JMRFBPU1xuXHRcdFxuXHRcdHZhcnlpbmcgdmVjMyB2V29ybGRQb3NpdGlvbjtcblx0I2Vsc2Vcblx0XHR2YXJ5aW5nIHZlYzMgdlJlZmxlY3Q7XG5cdFx0dW5pZm9ybSBmbG9hdCByZWZyYWN0aW9uUmF0aW87XG5cdCNlbmRpZlxuI2VuZGlmIjsKCnZhciBlbnZtYXBfdmVydGV4ID0gIiNpZmRlZiBVU0VfRU5WTUFQXG5cdCNpZmRlZiBFTlZfV09STERQT1Ncblx0XHR2V29ybGRQb3NpdGlvbiA9IHdvcmxkUG9zaXRpb24ueHl6O1xuXHQjZWxzZVxuXHRcdHZlYzMgY2FtZXJhVG9WZXJ0ZXg7XG5cdFx0aWYgKCBpc09ydGhvZ3JhcGhpYyApIHtcblx0XHRcdGNhbWVyYVRvVmVydGV4ID0gbm9ybWFsaXplKCB2ZWMzKCAtIHZpZXdNYXRyaXhbIDAgXVsgMiBdLCAtIHZpZXdNYXRyaXhbIDEgXVsgMiBdLCAtIHZpZXdNYXRyaXhbIDIgXVsgMiBdICkgKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y2FtZXJhVG9WZXJ0ZXggPSBub3JtYWxpemUoIHdvcmxkUG9zaXRpb24ueHl6IC0gY2FtZXJhUG9zaXRpb24gKTtcblx0XHR9XG5cdFx0dmVjMyB3b3JsZE5vcm1hbCA9IGludmVyc2VUcmFuc2Zvcm1EaXJlY3Rpb24oIHRyYW5zZm9ybWVkTm9ybWFsLCB2aWV3TWF0cml4ICk7XG5cdFx0I2lmZGVmIEVOVk1BUF9NT0RFX1JFRkxFQ1RJT05cblx0XHRcdHZSZWZsZWN0ID0gcmVmbGVjdCggY2FtZXJhVG9WZXJ0ZXgsIHdvcmxkTm9ybWFsICk7XG5cdFx0I2Vsc2Vcblx0XHRcdHZSZWZsZWN0ID0gcmVmcmFjdCggY2FtZXJhVG9WZXJ0ZXgsIHdvcmxkTm9ybWFsLCByZWZyYWN0aW9uUmF0aW8gKTtcblx0XHQjZW5kaWZcblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIGZvZ192ZXJ0ZXggPSAiI2lmZGVmIFVTRV9GT0dcblx0dkZvZ0RlcHRoID0gLSBtdlBvc2l0aW9uLno7XG4jZW5kaWYiOwoKdmFyIGZvZ19wYXJzX3ZlcnRleCA9ICIjaWZkZWYgVVNFX0ZPR1xuXHR2YXJ5aW5nIGZsb2F0IHZGb2dEZXB0aDtcbiNlbmRpZiI7Cgp2YXIgZm9nX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfRk9HXG5cdCNpZmRlZiBGT0dfRVhQMlxuXHRcdGZsb2F0IGZvZ0ZhY3RvciA9IDEuMCAtIGV4cCggLSBmb2dEZW5zaXR5ICogZm9nRGVuc2l0eSAqIHZGb2dEZXB0aCAqIHZGb2dEZXB0aCApO1xuXHQjZWxzZVxuXHRcdGZsb2F0IGZvZ0ZhY3RvciA9IHNtb290aHN0ZXAoIGZvZ05lYXIsIGZvZ0ZhciwgdkZvZ0RlcHRoICk7XG5cdCNlbmRpZlxuXHRnbF9GcmFnQ29sb3IucmdiID0gbWl4KCBnbF9GcmFnQ29sb3IucmdiLCBmb2dDb2xvciwgZm9nRmFjdG9yICk7XG4jZW5kaWYiOwoKdmFyIGZvZ19wYXJzX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfRk9HXG5cdHVuaWZvcm0gdmVjMyBmb2dDb2xvcjtcblx0dmFyeWluZyBmbG9hdCB2Rm9nRGVwdGg7XG5cdCNpZmRlZiBGT0dfRVhQMlxuXHRcdHVuaWZvcm0gZmxvYXQgZm9nRGVuc2l0eTtcblx0I2Vsc2Vcblx0XHR1bmlmb3JtIGZsb2F0IGZvZ05lYXI7XG5cdFx0dW5pZm9ybSBmbG9hdCBmb2dGYXI7XG5cdCNlbmRpZlxuI2VuZGlmIjsKCnZhciBncmFkaWVudG1hcF9wYXJzX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfR1JBRElFTlRNQVBcblx0dW5pZm9ybSBzYW1wbGVyMkQgZ3JhZGllbnRNYXA7XG4jZW5kaWZcbnZlYzMgZ2V0R3JhZGllbnRJcnJhZGlhbmNlKCB2ZWMzIG5vcm1hbCwgdmVjMyBsaWdodERpcmVjdGlvbiApIHtcblx0ZmxvYXQgZG90TkwgPSBkb3QoIG5vcm1hbCwgbGlnaHREaXJlY3Rpb24gKTtcblx0dmVjMiBjb29yZCA9IHZlYzIoIGRvdE5MICogMC41ICsgMC41LCAwLjAgKTtcblx0I2lmZGVmIFVTRV9HUkFESUVOVE1BUFxuXHRcdHJldHVybiB2ZWMzKCB0ZXh0dXJlMkQoIGdyYWRpZW50TWFwLCBjb29yZCApLnIgKTtcblx0I2Vsc2Vcblx0XHR2ZWMyIGZ3ID0gZndpZHRoKCBjb29yZCApICogMC41O1xuXHRcdHJldHVybiBtaXgoIHZlYzMoIDAuNyApLCB2ZWMzKCAxLjAgKSwgc21vb3Roc3RlcCggMC43IC0gZncueCwgMC43ICsgZncueCwgY29vcmQueCApICk7XG5cdCNlbmRpZlxufSI7Cgp2YXIgbGlnaHRtYXBfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9MSUdIVE1BUFxuXHR2ZWM0IGxpZ2h0TWFwVGV4ZWwgPSB0ZXh0dXJlMkQoIGxpZ2h0TWFwLCB2TGlnaHRNYXBVdiApO1xuXHR2ZWMzIGxpZ2h0TWFwSXJyYWRpYW5jZSA9IGxpZ2h0TWFwVGV4ZWwucmdiICogbGlnaHRNYXBJbnRlbnNpdHk7XG5cdHJlZmxlY3RlZExpZ2h0LmluZGlyZWN0RGlmZnVzZSArPSBsaWdodE1hcElycmFkaWFuY2U7XG4jZW5kaWYiOwoKdmFyIGxpZ2h0bWFwX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9MSUdIVE1BUFxuXHR1bmlmb3JtIHNhbXBsZXIyRCBsaWdodE1hcDtcblx0dW5pZm9ybSBmbG9hdCBsaWdodE1hcEludGVuc2l0eTtcbiNlbmRpZiI7Cgp2YXIgbGlnaHRzX2xhbWJlcnRfZnJhZ21lbnQgPSAiTGFtYmVydE1hdGVyaWFsIG1hdGVyaWFsO1xubWF0ZXJpYWwuZGlmZnVzZUNvbG9yID0gZGlmZnVzZUNvbG9yLnJnYjtcbm1hdGVyaWFsLnNwZWN1bGFyU3RyZW5ndGggPSBzcGVjdWxhclN0cmVuZ3RoOyI7Cgp2YXIgbGlnaHRzX2xhbWJlcnRfcGFyc19mcmFnbWVudCA9ICJ2YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjtcbnN0cnVjdCBMYW1iZXJ0TWF0ZXJpYWwge1xuXHR2ZWMzIGRpZmZ1c2VDb2xvcjtcblx0ZmxvYXQgc3BlY3VsYXJTdHJlbmd0aDtcbn07XG52b2lkIFJFX0RpcmVjdF9MYW1iZXJ0KCBjb25zdCBpbiBJbmNpZGVudExpZ2h0IGRpcmVjdExpZ2h0LCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5UG9zaXRpb24sIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlOb3JtYWwsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlWaWV3RGlyLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBjb25zdCBpbiBMYW1iZXJ0TWF0ZXJpYWwgbWF0ZXJpYWwsIGlub3V0IFJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ICkge1xuXHRmbG9hdCBkb3ROTCA9IHNhdHVyYXRlKCBkb3QoIGdlb21ldHJ5Tm9ybWFsLCBkaXJlY3RMaWdodC5kaXJlY3Rpb24gKSApO1xuXHR2ZWMzIGlycmFkaWFuY2UgPSBkb3ROTCAqIGRpcmVjdExpZ2h0LmNvbG9yO1xuXHRyZWZsZWN0ZWRMaWdodC5kaXJlY3REaWZmdXNlICs9IGlycmFkaWFuY2UgKiBCUkRGX0xhbWJlcnQoIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciApO1xufVxudm9pZCBSRV9JbmRpcmVjdERpZmZ1c2VfTGFtYmVydCggY29uc3QgaW4gdmVjMyBpcnJhZGlhbmNlLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5UG9zaXRpb24sIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlOb3JtYWwsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlWaWV3RGlyLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBjb25zdCBpbiBMYW1iZXJ0TWF0ZXJpYWwgbWF0ZXJpYWwsIGlub3V0IFJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ICkge1xuXHRyZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKz0gaXJyYWRpYW5jZSAqIEJSREZfTGFtYmVydCggbWF0ZXJpYWwuZGlmZnVzZUNvbG9yICk7XG59XG4jZGVmaW5lIFJFX0RpcmVjdFx0XHRcdFx0UkVfRGlyZWN0X0xhbWJlcnRcbiNkZWZpbmUgUkVfSW5kaXJlY3REaWZmdXNlXHRcdFJFX0luZGlyZWN0RGlmZnVzZV9MYW1iZXJ0IjsKCnZhciBsaWdodHNfcGFyc19iZWdpbiA9ICJ1bmlmb3JtIGJvb2wgcmVjZWl2ZVNoYWRvdztcbnVuaWZvcm0gdmVjMyBhbWJpZW50TGlnaHRDb2xvcjtcbiNpZiBkZWZpbmVkKCBVU0VfTElHSFRfUFJPQkVTIClcblx0dW5pZm9ybSB2ZWMzIGxpZ2h0UHJvYmVbIDkgXTtcbiNlbmRpZlxudmVjMyBzaEdldElycmFkaWFuY2VBdCggaW4gdmVjMyBub3JtYWwsIGluIHZlYzMgc2hDb2VmZmljaWVudHNbIDkgXSApIHtcblx0ZmxvYXQgeCA9IG5vcm1hbC54LCB5ID0gbm9ybWFsLnksIHogPSBub3JtYWwuejtcblx0dmVjMyByZXN1bHQgPSBzaENvZWZmaWNpZW50c1sgMCBdICogMC44ODYyMjc7XG5cdHJlc3VsdCArPSBzaENvZWZmaWNpZW50c1sgMSBdICogMi4wICogMC41MTE2NjQgKiB5O1xuXHRyZXN1bHQgKz0gc2hDb2VmZmljaWVudHNbIDIgXSAqIDIuMCAqIDAuNTExNjY0ICogejtcblx0cmVzdWx0ICs9IHNoQ29lZmZpY2llbnRzWyAzIF0gKiAyLjAgKiAwLjUxMTY2NCAqIHg7XG5cdHJlc3VsdCArPSBzaENvZWZmaWNpZW50c1sgNCBdICogMi4wICogMC40MjkwNDMgKiB4ICogeTtcblx0cmVzdWx0ICs9IHNoQ29lZmZpY2llbnRzWyA1IF0gKiAyLjAgKiAwLjQyOTA0MyAqIHkgKiB6O1xuXHRyZXN1bHQgKz0gc2hDb2VmZmljaWVudHNbIDYgXSAqICggMC43NDMxMjUgKiB6ICogeiAtIDAuMjQ3NzA4ICk7XG5cdHJlc3VsdCArPSBzaENvZWZmaWNpZW50c1sgNyBdICogMi4wICogMC40MjkwNDMgKiB4ICogejtcblx0cmVzdWx0ICs9IHNoQ29lZmZpY2llbnRzWyA4IF0gKiAwLjQyOTA0MyAqICggeCAqIHggLSB5ICogeSApO1xuXHRyZXR1cm4gcmVzdWx0O1xufVxudmVjMyBnZXRMaWdodFByb2JlSXJyYWRpYW5jZSggY29uc3QgaW4gdmVjMyBsaWdodFByb2JlWyA5IF0sIGNvbnN0IGluIHZlYzMgbm9ybWFsICkge1xuXHR2ZWMzIHdvcmxkTm9ybWFsID0gaW52ZXJzZVRyYW5zZm9ybURpcmVjdGlvbiggbm9ybWFsLCB2aWV3TWF0cml4ICk7XG5cdHZlYzMgaXJyYWRpYW5jZSA9IHNoR2V0SXJyYWRpYW5jZUF0KCB3b3JsZE5vcm1hbCwgbGlnaHRQcm9iZSApO1xuXHRyZXR1cm4gaXJyYWRpYW5jZTtcbn1cbnZlYzMgZ2V0QW1iaWVudExpZ2h0SXJyYWRpYW5jZSggY29uc3QgaW4gdmVjMyBhbWJpZW50TGlnaHRDb2xvciApIHtcblx0dmVjMyBpcnJhZGlhbmNlID0gYW1iaWVudExpZ2h0Q29sb3I7XG5cdHJldHVybiBpcnJhZGlhbmNlO1xufVxuZmxvYXQgZ2V0RGlzdGFuY2VBdHRlbnVhdGlvbiggY29uc3QgaW4gZmxvYXQgbGlnaHREaXN0YW5jZSwgY29uc3QgaW4gZmxvYXQgY3V0b2ZmRGlzdGFuY2UsIGNvbnN0IGluIGZsb2F0IGRlY2F5RXhwb25lbnQgKSB7XG5cdCNpZiBkZWZpbmVkICggTEVHQUNZX0xJR0hUUyApXG5cdFx0aWYgKCBjdXRvZmZEaXN0YW5jZSA+IDAuMCAmJiBkZWNheUV4cG9uZW50ID4gMC4wICkge1xuXHRcdFx0cmV0dXJuIHBvdyggc2F0dXJhdGUoIC0gbGlnaHREaXN0YW5jZSAvIGN1dG9mZkRpc3RhbmNlICsgMS4wICksIGRlY2F5RXhwb25lbnQgKTtcblx0XHR9XG5cdFx0cmV0dXJuIDEuMDtcblx0I2Vsc2Vcblx0XHRmbG9hdCBkaXN0YW5jZUZhbGxvZmYgPSAxLjAgLyBtYXgoIHBvdyggbGlnaHREaXN0YW5jZSwgZGVjYXlFeHBvbmVudCApLCAwLjAxICk7XG5cdFx0aWYgKCBjdXRvZmZEaXN0YW5jZSA+IDAuMCApIHtcblx0XHRcdGRpc3RhbmNlRmFsbG9mZiAqPSBwb3cyKCBzYXR1cmF0ZSggMS4wIC0gcG93NCggbGlnaHREaXN0YW5jZSAvIGN1dG9mZkRpc3RhbmNlICkgKSApO1xuXHRcdH1cblx0XHRyZXR1cm4gZGlzdGFuY2VGYWxsb2ZmO1xuXHQjZW5kaWZcbn1cbmZsb2F0IGdldFNwb3RBdHRlbnVhdGlvbiggY29uc3QgaW4gZmxvYXQgY29uZUNvc2luZSwgY29uc3QgaW4gZmxvYXQgcGVudW1icmFDb3NpbmUsIGNvbnN0IGluIGZsb2F0IGFuZ2xlQ29zaW5lICkge1xuXHRyZXR1cm4gc21vb3Roc3RlcCggY29uZUNvc2luZSwgcGVudW1icmFDb3NpbmUsIGFuZ2xlQ29zaW5lICk7XG59XG4jaWYgTlVNX0RJUl9MSUdIVFMgPiAwXG5cdHN0cnVjdCBEaXJlY3Rpb25hbExpZ2h0IHtcblx0XHR2ZWMzIGRpcmVjdGlvbjtcblx0XHR2ZWMzIGNvbG9yO1xuXHR9O1xuXHR1bmlmb3JtIERpcmVjdGlvbmFsTGlnaHQgZGlyZWN0aW9uYWxMaWdodHNbIE5VTV9ESVJfTElHSFRTIF07XG5cdHZvaWQgZ2V0RGlyZWN0aW9uYWxMaWdodEluZm8oIGNvbnN0IGluIERpcmVjdGlvbmFsTGlnaHQgZGlyZWN0aW9uYWxMaWdodCwgb3V0IEluY2lkZW50TGlnaHQgbGlnaHQgKSB7XG5cdFx0bGlnaHQuY29sb3IgPSBkaXJlY3Rpb25hbExpZ2h0LmNvbG9yO1xuXHRcdGxpZ2h0LmRpcmVjdGlvbiA9IGRpcmVjdGlvbmFsTGlnaHQuZGlyZWN0aW9uO1xuXHRcdGxpZ2h0LnZpc2libGUgPSB0cnVlO1xuXHR9XG4jZW5kaWZcbiNpZiBOVU1fUE9JTlRfTElHSFRTID4gMFxuXHRzdHJ1Y3QgUG9pbnRMaWdodCB7XG5cdFx0dmVjMyBwb3NpdGlvbjtcblx0XHR2ZWMzIGNvbG9yO1xuXHRcdGZsb2F0IGRpc3RhbmNlO1xuXHRcdGZsb2F0IGRlY2F5O1xuXHR9O1xuXHR1bmlmb3JtIFBvaW50TGlnaHQgcG9pbnRMaWdodHNbIE5VTV9QT0lOVF9MSUdIVFMgXTtcblx0dm9pZCBnZXRQb2ludExpZ2h0SW5mbyggY29uc3QgaW4gUG9pbnRMaWdodCBwb2ludExpZ2h0LCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5UG9zaXRpb24sIG91dCBJbmNpZGVudExpZ2h0IGxpZ2h0ICkge1xuXHRcdHZlYzMgbFZlY3RvciA9IHBvaW50TGlnaHQucG9zaXRpb24gLSBnZW9tZXRyeVBvc2l0aW9uO1xuXHRcdGxpZ2h0LmRpcmVjdGlvbiA9IG5vcm1hbGl6ZSggbFZlY3RvciApO1xuXHRcdGZsb2F0IGxpZ2h0RGlzdGFuY2UgPSBsZW5ndGgoIGxWZWN0b3IgKTtcblx0XHRsaWdodC5jb2xvciA9IHBvaW50TGlnaHQuY29sb3I7XG5cdFx0bGlnaHQuY29sb3IgKj0gZ2V0RGlzdGFuY2VBdHRlbnVhdGlvbiggbGlnaHREaXN0YW5jZSwgcG9pbnRMaWdodC5kaXN0YW5jZSwgcG9pbnRMaWdodC5kZWNheSApO1xuXHRcdGxpZ2h0LnZpc2libGUgPSAoIGxpZ2h0LmNvbG9yICE9IHZlYzMoIDAuMCApICk7XG5cdH1cbiNlbmRpZlxuI2lmIE5VTV9TUE9UX0xJR0hUUyA+IDBcblx0c3RydWN0IFNwb3RMaWdodCB7XG5cdFx0dmVjMyBwb3NpdGlvbjtcblx0XHR2ZWMzIGRpcmVjdGlvbjtcblx0XHR2ZWMzIGNvbG9yO1xuXHRcdGZsb2F0IGRpc3RhbmNlO1xuXHRcdGZsb2F0IGRlY2F5O1xuXHRcdGZsb2F0IGNvbmVDb3M7XG5cdFx0ZmxvYXQgcGVudW1icmFDb3M7XG5cdH07XG5cdHVuaWZvcm0gU3BvdExpZ2h0IHNwb3RMaWdodHNbIE5VTV9TUE9UX0xJR0hUUyBdO1xuXHR2b2lkIGdldFNwb3RMaWdodEluZm8oIGNvbnN0IGluIFNwb3RMaWdodCBzcG90TGlnaHQsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlQb3NpdGlvbiwgb3V0IEluY2lkZW50TGlnaHQgbGlnaHQgKSB7XG5cdFx0dmVjMyBsVmVjdG9yID0gc3BvdExpZ2h0LnBvc2l0aW9uIC0gZ2VvbWV0cnlQb3NpdGlvbjtcblx0XHRsaWdodC5kaXJlY3Rpb24gPSBub3JtYWxpemUoIGxWZWN0b3IgKTtcblx0XHRmbG9hdCBhbmdsZUNvcyA9IGRvdCggbGlnaHQuZGlyZWN0aW9uLCBzcG90TGlnaHQuZGlyZWN0aW9uICk7XG5cdFx0ZmxvYXQgc3BvdEF0dGVudWF0aW9uID0gZ2V0U3BvdEF0dGVudWF0aW9uKCBzcG90TGlnaHQuY29uZUNvcywgc3BvdExpZ2h0LnBlbnVtYnJhQ29zLCBhbmdsZUNvcyApO1xuXHRcdGlmICggc3BvdEF0dGVudWF0aW9uID4gMC4wICkge1xuXHRcdFx0ZmxvYXQgbGlnaHREaXN0YW5jZSA9IGxlbmd0aCggbFZlY3RvciApO1xuXHRcdFx0bGlnaHQuY29sb3IgPSBzcG90TGlnaHQuY29sb3IgKiBzcG90QXR0ZW51YXRpb247XG5cdFx0XHRsaWdodC5jb2xvciAqPSBnZXREaXN0YW5jZUF0dGVudWF0aW9uKCBsaWdodERpc3RhbmNlLCBzcG90TGlnaHQuZGlzdGFuY2UsIHNwb3RMaWdodC5kZWNheSApO1xuXHRcdFx0bGlnaHQudmlzaWJsZSA9ICggbGlnaHQuY29sb3IgIT0gdmVjMyggMC4wICkgKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0bGlnaHQuY29sb3IgPSB2ZWMzKCAwLjAgKTtcblx0XHRcdGxpZ2h0LnZpc2libGUgPSBmYWxzZTtcblx0XHR9XG5cdH1cbiNlbmRpZlxuI2lmIE5VTV9SRUNUX0FSRUFfTElHSFRTID4gMFxuXHRzdHJ1Y3QgUmVjdEFyZWFMaWdodCB7XG5cdFx0dmVjMyBjb2xvcjtcblx0XHR2ZWMzIHBvc2l0aW9uO1xuXHRcdHZlYzMgaGFsZldpZHRoO1xuXHRcdHZlYzMgaGFsZkhlaWdodDtcblx0fTtcblx0dW5pZm9ybSBzYW1wbGVyMkQgbHRjXzE7XHR1bmlmb3JtIHNhbXBsZXIyRCBsdGNfMjtcblx0dW5pZm9ybSBSZWN0QXJlYUxpZ2h0IHJlY3RBcmVhTGlnaHRzWyBOVU1fUkVDVF9BUkVBX0xJR0hUUyBdO1xuI2VuZGlmXG4jaWYgTlVNX0hFTUlfTElHSFRTID4gMFxuXHRzdHJ1Y3QgSGVtaXNwaGVyZUxpZ2h0IHtcblx0XHR2ZWMzIGRpcmVjdGlvbjtcblx0XHR2ZWMzIHNreUNvbG9yO1xuXHRcdHZlYzMgZ3JvdW5kQ29sb3I7XG5cdH07XG5cdHVuaWZvcm0gSGVtaXNwaGVyZUxpZ2h0IGhlbWlzcGhlcmVMaWdodHNbIE5VTV9IRU1JX0xJR0hUUyBdO1xuXHR2ZWMzIGdldEhlbWlzcGhlcmVMaWdodElycmFkaWFuY2UoIGNvbnN0IGluIEhlbWlzcGhlcmVMaWdodCBoZW1pTGlnaHQsIGNvbnN0IGluIHZlYzMgbm9ybWFsICkge1xuXHRcdGZsb2F0IGRvdE5MID0gZG90KCBub3JtYWwsIGhlbWlMaWdodC5kaXJlY3Rpb24gKTtcblx0XHRmbG9hdCBoZW1pRGlmZnVzZVdlaWdodCA9IDAuNSAqIGRvdE5MICsgMC41O1xuXHRcdHZlYzMgaXJyYWRpYW5jZSA9IG1peCggaGVtaUxpZ2h0Lmdyb3VuZENvbG9yLCBoZW1pTGlnaHQuc2t5Q29sb3IsIGhlbWlEaWZmdXNlV2VpZ2h0ICk7XG5cdFx0cmV0dXJuIGlycmFkaWFuY2U7XG5cdH1cbiNlbmRpZiI7Cgp2YXIgZW52bWFwX3BoeXNpY2FsX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9FTlZNQVBcblx0dmVjMyBnZXRJQkxJcnJhZGlhbmNlKCBjb25zdCBpbiB2ZWMzIG5vcm1hbCApIHtcblx0XHQjaWZkZWYgRU5WTUFQX1RZUEVfQ1VCRV9VVlxuXHRcdFx0dmVjMyB3b3JsZE5vcm1hbCA9IGludmVyc2VUcmFuc2Zvcm1EaXJlY3Rpb24oIG5vcm1hbCwgdmlld01hdHJpeCApO1xuXHRcdFx0dmVjNCBlbnZNYXBDb2xvciA9IHRleHR1cmVDdWJlVVYoIGVudk1hcCwgd29ybGROb3JtYWwsIDEuMCApO1xuXHRcdFx0cmV0dXJuIFBJICogZW52TWFwQ29sb3IucmdiICogZW52TWFwSW50ZW5zaXR5O1xuXHRcdCNlbHNlXG5cdFx0XHRyZXR1cm4gdmVjMyggMC4wICk7XG5cdFx0I2VuZGlmXG5cdH1cblx0dmVjMyBnZXRJQkxSYWRpYW5jZSggY29uc3QgaW4gdmVjMyB2aWV3RGlyLCBjb25zdCBpbiB2ZWMzIG5vcm1hbCwgY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzICkge1xuXHRcdCNpZmRlZiBFTlZNQVBfVFlQRV9DVUJFX1VWXG5cdFx0XHR2ZWMzIHJlZmxlY3RWZWMgPSByZWZsZWN0KCAtIHZpZXdEaXIsIG5vcm1hbCApO1xuXHRcdFx0cmVmbGVjdFZlYyA9IG5vcm1hbGl6ZSggbWl4KCByZWZsZWN0VmVjLCBub3JtYWwsIHJvdWdobmVzcyAqIHJvdWdobmVzcykgKTtcblx0XHRcdHJlZmxlY3RWZWMgPSBpbnZlcnNlVHJhbnNmb3JtRGlyZWN0aW9uKCByZWZsZWN0VmVjLCB2aWV3TWF0cml4ICk7XG5cdFx0XHR2ZWM0IGVudk1hcENvbG9yID0gdGV4dHVyZUN1YmVVViggZW52TWFwLCByZWZsZWN0VmVjLCByb3VnaG5lc3MgKTtcblx0XHRcdHJldHVybiBlbnZNYXBDb2xvci5yZ2IgKiBlbnZNYXBJbnRlbnNpdHk7XG5cdFx0I2Vsc2Vcblx0XHRcdHJldHVybiB2ZWMzKCAwLjAgKTtcblx0XHQjZW5kaWZcblx0fVxuXHQjaWZkZWYgVVNFX0FOSVNPVFJPUFlcblx0XHR2ZWMzIGdldElCTEFuaXNvdHJvcHlSYWRpYW5jZSggY29uc3QgaW4gdmVjMyB2aWV3RGlyLCBjb25zdCBpbiB2ZWMzIG5vcm1hbCwgY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzLCBjb25zdCBpbiB2ZWMzIGJpdGFuZ2VudCwgY29uc3QgaW4gZmxvYXQgYW5pc290cm9weSApIHtcblx0XHRcdCNpZmRlZiBFTlZNQVBfVFlQRV9DVUJFX1VWXG5cdFx0XHRcdHZlYzMgYmVudE5vcm1hbCA9IGNyb3NzKCBiaXRhbmdlbnQsIHZpZXdEaXIgKTtcblx0XHRcdFx0YmVudE5vcm1hbCA9IG5vcm1hbGl6ZSggY3Jvc3MoIGJlbnROb3JtYWwsIGJpdGFuZ2VudCApICk7XG5cdFx0XHRcdGJlbnROb3JtYWwgPSBub3JtYWxpemUoIG1peCggYmVudE5vcm1hbCwgbm9ybWFsLCBwb3cyKCBwb3cyKCAxLjAgLSBhbmlzb3Ryb3B5ICogKCAxLjAgLSByb3VnaG5lc3MgKSApICkgKSApO1xuXHRcdFx0XHRyZXR1cm4gZ2V0SUJMUmFkaWFuY2UoIHZpZXdEaXIsIGJlbnROb3JtYWwsIHJvdWdobmVzcyApO1xuXHRcdFx0I2Vsc2Vcblx0XHRcdFx0cmV0dXJuIHZlYzMoIDAuMCApO1xuXHRcdFx0I2VuZGlmXG5cdFx0fVxuXHQjZW5kaWZcbiNlbmRpZiI7Cgp2YXIgbGlnaHRzX3Rvb25fZnJhZ21lbnQgPSAiVG9vbk1hdGVyaWFsIG1hdGVyaWFsO1xubWF0ZXJpYWwuZGlmZnVzZUNvbG9yID0gZGlmZnVzZUNvbG9yLnJnYjsiOwoKdmFyIGxpZ2h0c190b29uX3BhcnNfZnJhZ21lbnQgPSAidmFyeWluZyB2ZWMzIHZWaWV3UG9zaXRpb247XG5zdHJ1Y3QgVG9vbk1hdGVyaWFsIHtcblx0dmVjMyBkaWZmdXNlQ29sb3I7XG59O1xudm9pZCBSRV9EaXJlY3RfVG9vbiggY29uc3QgaW4gSW5jaWRlbnRMaWdodCBkaXJlY3RMaWdodCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVBvc2l0aW9uLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Tm9ybWFsLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Vmlld0RpciwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgY29uc3QgaW4gVG9vbk1hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCApIHtcblx0dmVjMyBpcnJhZGlhbmNlID0gZ2V0R3JhZGllbnRJcnJhZGlhbmNlKCBnZW9tZXRyeU5vcm1hbCwgZGlyZWN0TGlnaHQuZGlyZWN0aW9uICkgKiBkaXJlY3RMaWdodC5jb2xvcjtcblx0cmVmbGVjdGVkTGlnaHQuZGlyZWN0RGlmZnVzZSArPSBpcnJhZGlhbmNlICogQlJERl9MYW1iZXJ0KCBtYXRlcmlhbC5kaWZmdXNlQ29sb3IgKTtcbn1cbnZvaWQgUkVfSW5kaXJlY3REaWZmdXNlX1Rvb24oIGNvbnN0IGluIHZlYzMgaXJyYWRpYW5jZSwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVBvc2l0aW9uLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Tm9ybWFsLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Vmlld0RpciwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgY29uc3QgaW4gVG9vbk1hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCApIHtcblx0cmVmbGVjdGVkTGlnaHQuaW5kaXJlY3REaWZmdXNlICs9IGlycmFkaWFuY2UgKiBCUkRGX0xhbWJlcnQoIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciApO1xufVxuI2RlZmluZSBSRV9EaXJlY3RcdFx0XHRcdFJFX0RpcmVjdF9Ub29uXG4jZGVmaW5lIFJFX0luZGlyZWN0RGlmZnVzZVx0XHRSRV9JbmRpcmVjdERpZmZ1c2VfVG9vbiI7Cgp2YXIgbGlnaHRzX3Bob25nX2ZyYWdtZW50ID0gIkJsaW5uUGhvbmdNYXRlcmlhbCBtYXRlcmlhbDtcbm1hdGVyaWFsLmRpZmZ1c2VDb2xvciA9IGRpZmZ1c2VDb2xvci5yZ2I7XG5tYXRlcmlhbC5zcGVjdWxhckNvbG9yID0gc3BlY3VsYXI7XG5tYXRlcmlhbC5zcGVjdWxhclNoaW5pbmVzcyA9IHNoaW5pbmVzcztcbm1hdGVyaWFsLnNwZWN1bGFyU3RyZW5ndGggPSBzcGVjdWxhclN0cmVuZ3RoOyI7Cgp2YXIgbGlnaHRzX3Bob25nX3BhcnNfZnJhZ21lbnQgPSAidmFyeWluZyB2ZWMzIHZWaWV3UG9zaXRpb247XG5zdHJ1Y3QgQmxpbm5QaG9uZ01hdGVyaWFsIHtcblx0dmVjMyBkaWZmdXNlQ29sb3I7XG5cdHZlYzMgc3BlY3VsYXJDb2xvcjtcblx0ZmxvYXQgc3BlY3VsYXJTaGluaW5lc3M7XG5cdGZsb2F0IHNwZWN1bGFyU3RyZW5ndGg7XG59O1xudm9pZCBSRV9EaXJlY3RfQmxpbm5QaG9uZyggY29uc3QgaW4gSW5jaWRlbnRMaWdodCBkaXJlY3RMaWdodCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVBvc2l0aW9uLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Tm9ybWFsLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Vmlld0RpciwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgY29uc3QgaW4gQmxpbm5QaG9uZ01hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCApIHtcblx0ZmxvYXQgZG90TkwgPSBzYXR1cmF0ZSggZG90KCBnZW9tZXRyeU5vcm1hbCwgZGlyZWN0TGlnaHQuZGlyZWN0aW9uICkgKTtcblx0dmVjMyBpcnJhZGlhbmNlID0gZG90TkwgKiBkaXJlY3RMaWdodC5jb2xvcjtcblx0cmVmbGVjdGVkTGlnaHQuZGlyZWN0RGlmZnVzZSArPSBpcnJhZGlhbmNlICogQlJERl9MYW1iZXJ0KCBtYXRlcmlhbC5kaWZmdXNlQ29sb3IgKTtcblx0cmVmbGVjdGVkTGlnaHQuZGlyZWN0U3BlY3VsYXIgKz0gaXJyYWRpYW5jZSAqIEJSREZfQmxpbm5QaG9uZyggZGlyZWN0TGlnaHQuZGlyZWN0aW9uLCBnZW9tZXRyeVZpZXdEaXIsIGdlb21ldHJ5Tm9ybWFsLCBtYXRlcmlhbC5zcGVjdWxhckNvbG9yLCBtYXRlcmlhbC5zcGVjdWxhclNoaW5pbmVzcyApICogbWF0ZXJpYWwuc3BlY3VsYXJTdHJlbmd0aDtcbn1cbnZvaWQgUkVfSW5kaXJlY3REaWZmdXNlX0JsaW5uUGhvbmcoIGNvbnN0IGluIHZlYzMgaXJyYWRpYW5jZSwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVBvc2l0aW9uLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Tm9ybWFsLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Vmlld0RpciwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgY29uc3QgaW4gQmxpbm5QaG9uZ01hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCApIHtcblx0cmVmbGVjdGVkTGlnaHQuaW5kaXJlY3REaWZmdXNlICs9IGlycmFkaWFuY2UgKiBCUkRGX0xhbWJlcnQoIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciApO1xufVxuI2RlZmluZSBSRV9EaXJlY3RcdFx0XHRcdFJFX0RpcmVjdF9CbGlublBob25nXG4jZGVmaW5lIFJFX0luZGlyZWN0RGlmZnVzZVx0XHRSRV9JbmRpcmVjdERpZmZ1c2VfQmxpbm5QaG9uZyI7Cgp2YXIgbGlnaHRzX3BoeXNpY2FsX2ZyYWdtZW50ID0gIlBoeXNpY2FsTWF0ZXJpYWwgbWF0ZXJpYWw7XG5tYXRlcmlhbC5kaWZmdXNlQ29sb3IgPSBkaWZmdXNlQ29sb3IucmdiICogKCAxLjAgLSBtZXRhbG5lc3NGYWN0b3IgKTtcbnZlYzMgZHh5ID0gbWF4KCBhYnMoIGRGZHgoIG5vblBlcnR1cmJlZE5vcm1hbCApICksIGFicyggZEZkeSggbm9uUGVydHVyYmVkTm9ybWFsICkgKSApO1xuZmxvYXQgZ2VvbWV0cnlSb3VnaG5lc3MgPSBtYXgoIG1heCggZHh5LngsIGR4eS55ICksIGR4eS56ICk7XG5tYXRlcmlhbC5yb3VnaG5lc3MgPSBtYXgoIHJvdWdobmVzc0ZhY3RvciwgMC4wNTI1ICk7bWF0ZXJpYWwucm91Z2huZXNzICs9IGdlb21ldHJ5Um91Z2huZXNzO1xubWF0ZXJpYWwucm91Z2huZXNzID0gbWluKCBtYXRlcmlhbC5yb3VnaG5lc3MsIDEuMCApO1xuI2lmZGVmIElPUlxuXHRtYXRlcmlhbC5pb3IgPSBpb3I7XG5cdCNpZmRlZiBVU0VfU1BFQ1VMQVJcblx0XHRmbG9hdCBzcGVjdWxhckludGVuc2l0eUZhY3RvciA9IHNwZWN1bGFySW50ZW5zaXR5O1xuXHRcdHZlYzMgc3BlY3VsYXJDb2xvckZhY3RvciA9IHNwZWN1bGFyQ29sb3I7XG5cdFx0I2lmZGVmIFVTRV9TUEVDVUxBUl9DT0xPUk1BUFxuXHRcdFx0c3BlY3VsYXJDb2xvckZhY3RvciAqPSB0ZXh0dXJlMkQoIHNwZWN1bGFyQ29sb3JNYXAsIHZTcGVjdWxhckNvbG9yTWFwVXYgKS5yZ2I7XG5cdFx0I2VuZGlmXG5cdFx0I2lmZGVmIFVTRV9TUEVDVUxBUl9JTlRFTlNJVFlNQVBcblx0XHRcdHNwZWN1bGFySW50ZW5zaXR5RmFjdG9yICo9IHRleHR1cmUyRCggc3BlY3VsYXJJbnRlbnNpdHlNYXAsIHZTcGVjdWxhckludGVuc2l0eU1hcFV2ICkuYTtcblx0XHQjZW5kaWZcblx0XHRtYXRlcmlhbC5zcGVjdWxhckY5MCA9IG1peCggc3BlY3VsYXJJbnRlbnNpdHlGYWN0b3IsIDEuMCwgbWV0YWxuZXNzRmFjdG9yICk7XG5cdCNlbHNlXG5cdFx0ZmxvYXQgc3BlY3VsYXJJbnRlbnNpdHlGYWN0b3IgPSAxLjA7XG5cdFx0dmVjMyBzcGVjdWxhckNvbG9yRmFjdG9yID0gdmVjMyggMS4wICk7XG5cdFx0bWF0ZXJpYWwuc3BlY3VsYXJGOTAgPSAxLjA7XG5cdCNlbmRpZlxuXHRtYXRlcmlhbC5zcGVjdWxhckNvbG9yID0gbWl4KCBtaW4oIHBvdzIoICggbWF0ZXJpYWwuaW9yIC0gMS4wICkgLyAoIG1hdGVyaWFsLmlvciArIDEuMCApICkgKiBzcGVjdWxhckNvbG9yRmFjdG9yLCB2ZWMzKCAxLjAgKSApICogc3BlY3VsYXJJbnRlbnNpdHlGYWN0b3IsIGRpZmZ1c2VDb2xvci5yZ2IsIG1ldGFsbmVzc0ZhY3RvciApO1xuI2Vsc2Vcblx0bWF0ZXJpYWwuc3BlY3VsYXJDb2xvciA9IG1peCggdmVjMyggMC4wNCApLCBkaWZmdXNlQ29sb3IucmdiLCBtZXRhbG5lc3NGYWN0b3IgKTtcblx0bWF0ZXJpYWwuc3BlY3VsYXJGOTAgPSAxLjA7XG4jZW5kaWZcbiNpZmRlZiBVU0VfQ0xFQVJDT0FUXG5cdG1hdGVyaWFsLmNsZWFyY29hdCA9IGNsZWFyY29hdDtcblx0bWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzID0gY2xlYXJjb2F0Um91Z2huZXNzO1xuXHRtYXRlcmlhbC5jbGVhcmNvYXRGMCA9IHZlYzMoIDAuMDQgKTtcblx0bWF0ZXJpYWwuY2xlYXJjb2F0RjkwID0gMS4wO1xuXHQjaWZkZWYgVVNFX0NMRUFSQ09BVE1BUFxuXHRcdG1hdGVyaWFsLmNsZWFyY29hdCAqPSB0ZXh0dXJlMkQoIGNsZWFyY29hdE1hcCwgdkNsZWFyY29hdE1hcFV2ICkueDtcblx0I2VuZGlmXG5cdCNpZmRlZiBVU0VfQ0xFQVJDT0FUX1JPVUdITkVTU01BUFxuXHRcdG1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzcyAqPSB0ZXh0dXJlMkQoIGNsZWFyY29hdFJvdWdobmVzc01hcCwgdkNsZWFyY29hdFJvdWdobmVzc01hcFV2ICkueTtcblx0I2VuZGlmXG5cdG1hdGVyaWFsLmNsZWFyY29hdCA9IHNhdHVyYXRlKCBtYXRlcmlhbC5jbGVhcmNvYXQgKTtcdG1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzcyA9IG1heCggbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzLCAwLjA1MjUgKTtcblx0bWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzICs9IGdlb21ldHJ5Um91Z2huZXNzO1xuXHRtYXRlcmlhbC5jbGVhcmNvYXRSb3VnaG5lc3MgPSBtaW4oIG1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzcywgMS4wICk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfSVJJREVTQ0VOQ0Vcblx0bWF0ZXJpYWwuaXJpZGVzY2VuY2UgPSBpcmlkZXNjZW5jZTtcblx0bWF0ZXJpYWwuaXJpZGVzY2VuY2VJT1IgPSBpcmlkZXNjZW5jZUlPUjtcblx0I2lmZGVmIFVTRV9JUklERVNDRU5DRU1BUFxuXHRcdG1hdGVyaWFsLmlyaWRlc2NlbmNlICo9IHRleHR1cmUyRCggaXJpZGVzY2VuY2VNYXAsIHZJcmlkZXNjZW5jZU1hcFV2ICkucjtcblx0I2VuZGlmXG5cdCNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VfVEhJQ0tORVNTTUFQXG5cdFx0bWF0ZXJpYWwuaXJpZGVzY2VuY2VUaGlja25lc3MgPSAoaXJpZGVzY2VuY2VUaGlja25lc3NNYXhpbXVtIC0gaXJpZGVzY2VuY2VUaGlja25lc3NNaW5pbXVtKSAqIHRleHR1cmUyRCggaXJpZGVzY2VuY2VUaGlja25lc3NNYXAsIHZJcmlkZXNjZW5jZVRoaWNrbmVzc01hcFV2ICkuZyArIGlyaWRlc2NlbmNlVGhpY2tuZXNzTWluaW11bTtcblx0I2Vsc2Vcblx0XHRtYXRlcmlhbC5pcmlkZXNjZW5jZVRoaWNrbmVzcyA9IGlyaWRlc2NlbmNlVGhpY2tuZXNzTWF4aW11bTtcblx0I2VuZGlmXG4jZW5kaWZcbiNpZmRlZiBVU0VfU0hFRU5cblx0bWF0ZXJpYWwuc2hlZW5Db2xvciA9IHNoZWVuQ29sb3I7XG5cdCNpZmRlZiBVU0VfU0hFRU5fQ09MT1JNQVBcblx0XHRtYXRlcmlhbC5zaGVlbkNvbG9yICo9IHRleHR1cmUyRCggc2hlZW5Db2xvck1hcCwgdlNoZWVuQ29sb3JNYXBVdiApLnJnYjtcblx0I2VuZGlmXG5cdG1hdGVyaWFsLnNoZWVuUm91Z2huZXNzID0gY2xhbXAoIHNoZWVuUm91Z2huZXNzLCAwLjA3LCAxLjAgKTtcblx0I2lmZGVmIFVTRV9TSEVFTl9ST1VHSE5FU1NNQVBcblx0XHRtYXRlcmlhbC5zaGVlblJvdWdobmVzcyAqPSB0ZXh0dXJlMkQoIHNoZWVuUm91Z2huZXNzTWFwLCB2U2hlZW5Sb3VnaG5lc3NNYXBVdiApLmE7XG5cdCNlbmRpZlxuI2VuZGlmXG4jaWZkZWYgVVNFX0FOSVNPVFJPUFlcblx0I2lmZGVmIFVTRV9BTklTT1RST1BZTUFQXG5cdFx0bWF0MiBhbmlzb3Ryb3B5TWF0ID0gbWF0MiggYW5pc290cm9weVZlY3Rvci54LCBhbmlzb3Ryb3B5VmVjdG9yLnksIC0gYW5pc290cm9weVZlY3Rvci55LCBhbmlzb3Ryb3B5VmVjdG9yLnggKTtcblx0XHR2ZWMzIGFuaXNvdHJvcHlQb2xhciA9IHRleHR1cmUyRCggYW5pc290cm9weU1hcCwgdkFuaXNvdHJvcHlNYXBVdiApLnJnYjtcblx0XHR2ZWMyIGFuaXNvdHJvcHlWID0gYW5pc290cm9weU1hdCAqIG5vcm1hbGl6ZSggMi4wICogYW5pc290cm9weVBvbGFyLnJnIC0gdmVjMiggMS4wICkgKSAqIGFuaXNvdHJvcHlQb2xhci5iO1xuXHQjZWxzZVxuXHRcdHZlYzIgYW5pc290cm9weVYgPSBhbmlzb3Ryb3B5VmVjdG9yO1xuXHQjZW5kaWZcblx0bWF0ZXJpYWwuYW5pc290cm9weSA9IGxlbmd0aCggYW5pc290cm9weVYgKTtcblx0aWYoIG1hdGVyaWFsLmFuaXNvdHJvcHkgPT0gMC4wICkge1xuXHRcdGFuaXNvdHJvcHlWID0gdmVjMiggMS4wLCAwLjAgKTtcblx0fSBlbHNlIHtcblx0XHRhbmlzb3Ryb3B5ViAvPSBtYXRlcmlhbC5hbmlzb3Ryb3B5O1xuXHRcdG1hdGVyaWFsLmFuaXNvdHJvcHkgPSBzYXR1cmF0ZSggbWF0ZXJpYWwuYW5pc290cm9weSApO1xuXHR9XG5cdG1hdGVyaWFsLmFscGhhVCA9IG1peCggcG93MiggbWF0ZXJpYWwucm91Z2huZXNzICksIDEuMCwgcG93MiggbWF0ZXJpYWwuYW5pc290cm9weSApICk7XG5cdG1hdGVyaWFsLmFuaXNvdHJvcHlUID0gdGJuWyAwIF0gKiBhbmlzb3Ryb3B5Vi54ICsgdGJuWyAxIF0gKiBhbmlzb3Ryb3B5Vi55O1xuXHRtYXRlcmlhbC5hbmlzb3Ryb3B5QiA9IHRiblsgMSBdICogYW5pc290cm9weVYueCAtIHRiblsgMCBdICogYW5pc290cm9weVYueTtcbiNlbmRpZiI7Cgp2YXIgbGlnaHRzX3BoeXNpY2FsX3BhcnNfZnJhZ21lbnQgPSAic3RydWN0IFBoeXNpY2FsTWF0ZXJpYWwge1xuXHR2ZWMzIGRpZmZ1c2VDb2xvcjtcblx0ZmxvYXQgcm91Z2huZXNzO1xuXHR2ZWMzIHNwZWN1bGFyQ29sb3I7XG5cdGZsb2F0IHNwZWN1bGFyRjkwO1xuXHQjaWZkZWYgVVNFX0NMRUFSQ09BVFxuXHRcdGZsb2F0IGNsZWFyY29hdDtcblx0XHRmbG9hdCBjbGVhcmNvYXRSb3VnaG5lc3M7XG5cdFx0dmVjMyBjbGVhcmNvYXRGMDtcblx0XHRmbG9hdCBjbGVhcmNvYXRGOTA7XG5cdCNlbmRpZlxuXHQjaWZkZWYgVVNFX0lSSURFU0NFTkNFXG5cdFx0ZmxvYXQgaXJpZGVzY2VuY2U7XG5cdFx0ZmxvYXQgaXJpZGVzY2VuY2VJT1I7XG5cdFx0ZmxvYXQgaXJpZGVzY2VuY2VUaGlja25lc3M7XG5cdFx0dmVjMyBpcmlkZXNjZW5jZUZyZXNuZWw7XG5cdFx0dmVjMyBpcmlkZXNjZW5jZUYwO1xuXHQjZW5kaWZcblx0I2lmZGVmIFVTRV9TSEVFTlxuXHRcdHZlYzMgc2hlZW5Db2xvcjtcblx0XHRmbG9hdCBzaGVlblJvdWdobmVzcztcblx0I2VuZGlmXG5cdCNpZmRlZiBJT1Jcblx0XHRmbG9hdCBpb3I7XG5cdCNlbmRpZlxuXHQjaWZkZWYgVVNFX1RSQU5TTUlTU0lPTlxuXHRcdGZsb2F0IHRyYW5zbWlzc2lvbjtcblx0XHRmbG9hdCB0cmFuc21pc3Npb25BbHBoYTtcblx0XHRmbG9hdCB0aGlja25lc3M7XG5cdFx0ZmxvYXQgYXR0ZW51YXRpb25EaXN0YW5jZTtcblx0XHR2ZWMzIGF0dGVudWF0aW9uQ29sb3I7XG5cdCNlbmRpZlxuXHQjaWZkZWYgVVNFX0FOSVNPVFJPUFlcblx0XHRmbG9hdCBhbmlzb3Ryb3B5O1xuXHRcdGZsb2F0IGFscGhhVDtcblx0XHR2ZWMzIGFuaXNvdHJvcHlUO1xuXHRcdHZlYzMgYW5pc290cm9weUI7XG5cdCNlbmRpZlxufTtcbnZlYzMgY2xlYXJjb2F0U3BlY3VsYXJEaXJlY3QgPSB2ZWMzKCAwLjAgKTtcbnZlYzMgY2xlYXJjb2F0U3BlY3VsYXJJbmRpcmVjdCA9IHZlYzMoIDAuMCApO1xudmVjMyBzaGVlblNwZWN1bGFyRGlyZWN0ID0gdmVjMyggMC4wICk7XG52ZWMzIHNoZWVuU3BlY3VsYXJJbmRpcmVjdCA9IHZlYzMoMC4wICk7XG52ZWMzIFNjaGxpY2tfdG9fRjAoIGNvbnN0IGluIHZlYzMgZiwgY29uc3QgaW4gZmxvYXQgZjkwLCBjb25zdCBpbiBmbG9hdCBkb3RWSCApIHtcbiAgICBmbG9hdCB4ID0gY2xhbXAoIDEuMCAtIGRvdFZILCAwLjAsIDEuMCApO1xuICAgIGZsb2F0IHgyID0geCAqIHg7XG4gICAgZmxvYXQgeDUgPSBjbGFtcCggeCAqIHgyICogeDIsIDAuMCwgMC45OTk5ICk7XG4gICAgcmV0dXJuICggZiAtIHZlYzMoIGY5MCApICogeDUgKSAvICggMS4wIC0geDUgKTtcbn1cbmZsb2F0IFZfR0dYX1NtaXRoQ29ycmVsYXRlZCggY29uc3QgaW4gZmxvYXQgYWxwaGEsIGNvbnN0IGluIGZsb2F0IGRvdE5MLCBjb25zdCBpbiBmbG9hdCBkb3ROViApIHtcblx0ZmxvYXQgYTIgPSBwb3cyKCBhbHBoYSApO1xuXHRmbG9hdCBndiA9IGRvdE5MICogc3FydCggYTIgKyAoIDEuMCAtIGEyICkgKiBwb3cyKCBkb3ROViApICk7XG5cdGZsb2F0IGdsID0gZG90TlYgKiBzcXJ0KCBhMiArICggMS4wIC0gYTIgKSAqIHBvdzIoIGRvdE5MICkgKTtcblx0cmV0dXJuIDAuNSAvIG1heCggZ3YgKyBnbCwgRVBTSUxPTiApO1xufVxuZmxvYXQgRF9HR1goIGNvbnN0IGluIGZsb2F0IGFscGhhLCBjb25zdCBpbiBmbG9hdCBkb3ROSCApIHtcblx0ZmxvYXQgYTIgPSBwb3cyKCBhbHBoYSApO1xuXHRmbG9hdCBkZW5vbSA9IHBvdzIoIGRvdE5IICkgKiAoIGEyIC0gMS4wICkgKyAxLjA7XG5cdHJldHVybiBSRUNJUFJPQ0FMX1BJICogYTIgLyBwb3cyKCBkZW5vbSApO1xufVxuI2lmZGVmIFVTRV9BTklTT1RST1BZXG5cdGZsb2F0IFZfR0dYX1NtaXRoQ29ycmVsYXRlZF9Bbmlzb3Ryb3BpYyggY29uc3QgaW4gZmxvYXQgYWxwaGFULCBjb25zdCBpbiBmbG9hdCBhbHBoYUIsIGNvbnN0IGluIGZsb2F0IGRvdFRWLCBjb25zdCBpbiBmbG9hdCBkb3RCViwgY29uc3QgaW4gZmxvYXQgZG90VEwsIGNvbnN0IGluIGZsb2F0IGRvdEJMLCBjb25zdCBpbiBmbG9hdCBkb3ROViwgY29uc3QgaW4gZmxvYXQgZG90TkwgKSB7XG5cdFx0ZmxvYXQgZ3YgPSBkb3ROTCAqIGxlbmd0aCggdmVjMyggYWxwaGFUICogZG90VFYsIGFscGhhQiAqIGRvdEJWLCBkb3ROViApICk7XG5cdFx0ZmxvYXQgZ2wgPSBkb3ROViAqIGxlbmd0aCggdmVjMyggYWxwaGFUICogZG90VEwsIGFscGhhQiAqIGRvdEJMLCBkb3ROTCApICk7XG5cdFx0ZmxvYXQgdiA9IDAuNSAvICggZ3YgKyBnbCApO1xuXHRcdHJldHVybiBzYXR1cmF0ZSh2KTtcblx0fVxuXHRmbG9hdCBEX0dHWF9Bbmlzb3Ryb3BpYyggY29uc3QgaW4gZmxvYXQgYWxwaGFULCBjb25zdCBpbiBmbG9hdCBhbHBoYUIsIGNvbnN0IGluIGZsb2F0IGRvdE5ILCBjb25zdCBpbiBmbG9hdCBkb3RUSCwgY29uc3QgaW4gZmxvYXQgZG90QkggKSB7XG5cdFx0ZmxvYXQgYTIgPSBhbHBoYVQgKiBhbHBoYUI7XG5cdFx0aGlnaHAgdmVjMyB2ID0gdmVjMyggYWxwaGFCICogZG90VEgsIGFscGhhVCAqIGRvdEJILCBhMiAqIGRvdE5IICk7XG5cdFx0aGlnaHAgZmxvYXQgdjIgPSBkb3QoIHYsIHYgKTtcblx0XHRmbG9hdCB3MiA9IGEyIC8gdjI7XG5cdFx0cmV0dXJuIFJFQ0lQUk9DQUxfUEkgKiBhMiAqIHBvdzIgKCB3MiApO1xuXHR9XG4jZW5kaWZcbiNpZmRlZiBVU0VfQ0xFQVJDT0FUXG5cdHZlYzMgQlJERl9HR1hfQ2xlYXJjb2F0KCBjb25zdCBpbiB2ZWMzIGxpZ2h0RGlyLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiBQaHlzaWNhbE1hdGVyaWFsIG1hdGVyaWFsKSB7XG5cdFx0dmVjMyBmMCA9IG1hdGVyaWFsLmNsZWFyY29hdEYwO1xuXHRcdGZsb2F0IGY5MCA9IG1hdGVyaWFsLmNsZWFyY29hdEY5MDtcblx0XHRmbG9hdCByb3VnaG5lc3MgPSBtYXRlcmlhbC5jbGVhcmNvYXRSb3VnaG5lc3M7XG5cdFx0ZmxvYXQgYWxwaGEgPSBwb3cyKCByb3VnaG5lc3MgKTtcblx0XHR2ZWMzIGhhbGZEaXIgPSBub3JtYWxpemUoIGxpZ2h0RGlyICsgdmlld0RpciApO1xuXHRcdGZsb2F0IGRvdE5MID0gc2F0dXJhdGUoIGRvdCggbm9ybWFsLCBsaWdodERpciApICk7XG5cdFx0ZmxvYXQgZG90TlYgPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIHZpZXdEaXIgKSApO1xuXHRcdGZsb2F0IGRvdE5IID0gc2F0dXJhdGUoIGRvdCggbm9ybWFsLCBoYWxmRGlyICkgKTtcblx0XHRmbG9hdCBkb3RWSCA9IHNhdHVyYXRlKCBkb3QoIHZpZXdEaXIsIGhhbGZEaXIgKSApO1xuXHRcdHZlYzMgRiA9IEZfU2NobGljayggZjAsIGY5MCwgZG90VkggKTtcblx0XHRmbG9hdCBWID0gVl9HR1hfU21pdGhDb3JyZWxhdGVkKCBhbHBoYSwgZG90TkwsIGRvdE5WICk7XG5cdFx0ZmxvYXQgRCA9IERfR0dYKCBhbHBoYSwgZG90TkggKTtcblx0XHRyZXR1cm4gRiAqICggViAqIEQgKTtcblx0fVxuI2VuZGlmXG52ZWMzIEJSREZfR0dYKCBjb25zdCBpbiB2ZWMzIGxpZ2h0RGlyLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiBQaHlzaWNhbE1hdGVyaWFsIG1hdGVyaWFsICkge1xuXHR2ZWMzIGYwID0gbWF0ZXJpYWwuc3BlY3VsYXJDb2xvcjtcblx0ZmxvYXQgZjkwID0gbWF0ZXJpYWwuc3BlY3VsYXJGOTA7XG5cdGZsb2F0IHJvdWdobmVzcyA9IG1hdGVyaWFsLnJvdWdobmVzcztcblx0ZmxvYXQgYWxwaGEgPSBwb3cyKCByb3VnaG5lc3MgKTtcblx0dmVjMyBoYWxmRGlyID0gbm9ybWFsaXplKCBsaWdodERpciArIHZpZXdEaXIgKTtcblx0ZmxvYXQgZG90TkwgPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIGxpZ2h0RGlyICkgKTtcblx0ZmxvYXQgZG90TlYgPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIHZpZXdEaXIgKSApO1xuXHRmbG9hdCBkb3ROSCA9IHNhdHVyYXRlKCBkb3QoIG5vcm1hbCwgaGFsZkRpciApICk7XG5cdGZsb2F0IGRvdFZIID0gc2F0dXJhdGUoIGRvdCggdmlld0RpciwgaGFsZkRpciApICk7XG5cdHZlYzMgRiA9IEZfU2NobGljayggZjAsIGY5MCwgZG90VkggKTtcblx0I2lmZGVmIFVTRV9JUklERVNDRU5DRVxuXHRcdEYgPSBtaXgoIEYsIG1hdGVyaWFsLmlyaWRlc2NlbmNlRnJlc25lbCwgbWF0ZXJpYWwuaXJpZGVzY2VuY2UgKTtcblx0I2VuZGlmXG5cdCNpZmRlZiBVU0VfQU5JU09UUk9QWVxuXHRcdGZsb2F0IGRvdFRMID0gZG90KCBtYXRlcmlhbC5hbmlzb3Ryb3B5VCwgbGlnaHREaXIgKTtcblx0XHRmbG9hdCBkb3RUViA9IGRvdCggbWF0ZXJpYWwuYW5pc290cm9weVQsIHZpZXdEaXIgKTtcblx0XHRmbG9hdCBkb3RUSCA9IGRvdCggbWF0ZXJpYWwuYW5pc290cm9weVQsIGhhbGZEaXIgKTtcblx0XHRmbG9hdCBkb3RCTCA9IGRvdCggbWF0ZXJpYWwuYW5pc290cm9weUIsIGxpZ2h0RGlyICk7XG5cdFx0ZmxvYXQgZG90QlYgPSBkb3QoIG1hdGVyaWFsLmFuaXNvdHJvcHlCLCB2aWV3RGlyICk7XG5cdFx0ZmxvYXQgZG90QkggPSBkb3QoIG1hdGVyaWFsLmFuaXNvdHJvcHlCLCBoYWxmRGlyICk7XG5cdFx0ZmxvYXQgViA9IFZfR0dYX1NtaXRoQ29ycmVsYXRlZF9Bbmlzb3Ryb3BpYyggbWF0ZXJpYWwuYWxwaGFULCBhbHBoYSwgZG90VFYsIGRvdEJWLCBkb3RUTCwgZG90QkwsIGRvdE5WLCBkb3ROTCApO1xuXHRcdGZsb2F0IEQgPSBEX0dHWF9Bbmlzb3Ryb3BpYyggbWF0ZXJpYWwuYWxwaGFULCBhbHBoYSwgZG90TkgsIGRvdFRILCBkb3RCSCApO1xuXHQjZWxzZVxuXHRcdGZsb2F0IFYgPSBWX0dHWF9TbWl0aENvcnJlbGF0ZWQoIGFscGhhLCBkb3ROTCwgZG90TlYgKTtcblx0XHRmbG9hdCBEID0gRF9HR1goIGFscGhhLCBkb3ROSCApO1xuXHQjZW5kaWZcblx0cmV0dXJuIEYgKiAoIFYgKiBEICk7XG59XG52ZWMyIExUQ19VdiggY29uc3QgaW4gdmVjMyBOLCBjb25zdCBpbiB2ZWMzIFYsIGNvbnN0IGluIGZsb2F0IHJvdWdobmVzcyApIHtcblx0Y29uc3QgZmxvYXQgTFVUX1NJWkUgPSA2NC4wO1xuXHRjb25zdCBmbG9hdCBMVVRfU0NBTEUgPSAoIExVVF9TSVpFIC0gMS4wICkgLyBMVVRfU0laRTtcblx0Y29uc3QgZmxvYXQgTFVUX0JJQVMgPSAwLjUgLyBMVVRfU0laRTtcblx0ZmxvYXQgZG90TlYgPSBzYXR1cmF0ZSggZG90KCBOLCBWICkgKTtcblx0dmVjMiB1diA9IHZlYzIoIHJvdWdobmVzcywgc3FydCggMS4wIC0gZG90TlYgKSApO1xuXHR1diA9IHV2ICogTFVUX1NDQUxFICsgTFVUX0JJQVM7XG5cdHJldHVybiB1djtcbn1cbmZsb2F0IExUQ19DbGlwcGVkU3BoZXJlRm9ybUZhY3RvciggY29uc3QgaW4gdmVjMyBmICkge1xuXHRmbG9hdCBsID0gbGVuZ3RoKCBmICk7XG5cdHJldHVybiBtYXgoICggbCAqIGwgKyBmLnogKSAvICggbCArIDEuMCApLCAwLjAgKTtcbn1cbnZlYzMgTFRDX0VkZ2VWZWN0b3JGb3JtRmFjdG9yKCBjb25zdCBpbiB2ZWMzIHYxLCBjb25zdCBpbiB2ZWMzIHYyICkge1xuXHRmbG9hdCB4ID0gZG90KCB2MSwgdjIgKTtcblx0ZmxvYXQgeSA9IGFicyggeCApO1xuXHRmbG9hdCBhID0gMC44NTQzOTg1ICsgKCAwLjQ5NjUxNTUgKyAwLjAxNDUyMDYgKiB5ICkgKiB5O1xuXHRmbG9hdCBiID0gMy40MTc1OTQwICsgKCA0LjE2MTY3MjQgKyB5ICkgKiB5O1xuXHRmbG9hdCB2ID0gYSAvIGI7XG5cdGZsb2F0IHRoZXRhX3NpbnRoZXRhID0gKCB4ID4gMC4wICkgPyB2IDogMC41ICogaW52ZXJzZXNxcnQoIG1heCggMS4wIC0geCAqIHgsIDFlLTcgKSApIC0gdjtcblx0cmV0dXJuIGNyb3NzKCB2MSwgdjIgKSAqIHRoZXRhX3NpbnRoZXRhO1xufVxudmVjMyBMVENfRXZhbHVhdGUoIGNvbnN0IGluIHZlYzMgTiwgY29uc3QgaW4gdmVjMyBWLCBjb25zdCBpbiB2ZWMzIFAsIGNvbnN0IGluIG1hdDMgbUludiwgY29uc3QgaW4gdmVjMyByZWN0Q29vcmRzWyA0IF0gKSB7XG5cdHZlYzMgdjEgPSByZWN0Q29vcmRzWyAxIF0gLSByZWN0Q29vcmRzWyAwIF07XG5cdHZlYzMgdjIgPSByZWN0Q29vcmRzWyAzIF0gLSByZWN0Q29vcmRzWyAwIF07XG5cdHZlYzMgbGlnaHROb3JtYWwgPSBjcm9zcyggdjEsIHYyICk7XG5cdGlmKCBkb3QoIGxpZ2h0Tm9ybWFsLCBQIC0gcmVjdENvb3Jkc1sgMCBdICkgPCAwLjAgKSByZXR1cm4gdmVjMyggMC4wICk7XG5cdHZlYzMgVDEsIFQyO1xuXHRUMSA9IG5vcm1hbGl6ZSggViAtIE4gKiBkb3QoIFYsIE4gKSApO1xuXHRUMiA9IC0gY3Jvc3MoIE4sIFQxICk7XG5cdG1hdDMgbWF0ID0gbUludiAqIHRyYW5zcG9zZU1hdDMoIG1hdDMoIFQxLCBUMiwgTiApICk7XG5cdHZlYzMgY29vcmRzWyA0IF07XG5cdGNvb3Jkc1sgMCBdID0gbWF0ICogKCByZWN0Q29vcmRzWyAwIF0gLSBQICk7XG5cdGNvb3Jkc1sgMSBdID0gbWF0ICogKCByZWN0Q29vcmRzWyAxIF0gLSBQICk7XG5cdGNvb3Jkc1sgMiBdID0gbWF0ICogKCByZWN0Q29vcmRzWyAyIF0gLSBQICk7XG5cdGNvb3Jkc1sgMyBdID0gbWF0ICogKCByZWN0Q29vcmRzWyAzIF0gLSBQICk7XG5cdGNvb3Jkc1sgMCBdID0gbm9ybWFsaXplKCBjb29yZHNbIDAgXSApO1xuXHRjb29yZHNbIDEgXSA9IG5vcm1hbGl6ZSggY29vcmRzWyAxIF0gKTtcblx0Y29vcmRzWyAyIF0gPSBub3JtYWxpemUoIGNvb3Jkc1sgMiBdICk7XG5cdGNvb3Jkc1sgMyBdID0gbm9ybWFsaXplKCBjb29yZHNbIDMgXSApO1xuXHR2ZWMzIHZlY3RvckZvcm1GYWN0b3IgPSB2ZWMzKCAwLjAgKTtcblx0dmVjdG9yRm9ybUZhY3RvciArPSBMVENfRWRnZVZlY3RvckZvcm1GYWN0b3IoIGNvb3Jkc1sgMCBdLCBjb29yZHNbIDEgXSApO1xuXHR2ZWN0b3JGb3JtRmFjdG9yICs9IExUQ19FZGdlVmVjdG9yRm9ybUZhY3RvciggY29vcmRzWyAxIF0sIGNvb3Jkc1sgMiBdICk7XG5cdHZlY3RvckZvcm1GYWN0b3IgKz0gTFRDX0VkZ2VWZWN0b3JGb3JtRmFjdG9yKCBjb29yZHNbIDIgXSwgY29vcmRzWyAzIF0gKTtcblx0dmVjdG9yRm9ybUZhY3RvciArPSBMVENfRWRnZVZlY3RvckZvcm1GYWN0b3IoIGNvb3Jkc1sgMyBdLCBjb29yZHNbIDAgXSApO1xuXHRmbG9hdCByZXN1bHQgPSBMVENfQ2xpcHBlZFNwaGVyZUZvcm1GYWN0b3IoIHZlY3RvckZvcm1GYWN0b3IgKTtcblx0cmV0dXJuIHZlYzMoIHJlc3VsdCApO1xufVxuI2lmIGRlZmluZWQoIFVTRV9TSEVFTiApXG5mbG9hdCBEX0NoYXJsaWUoIGZsb2F0IHJvdWdobmVzcywgZmxvYXQgZG90TkggKSB7XG5cdGZsb2F0IGFscGhhID0gcG93Miggcm91Z2huZXNzICk7XG5cdGZsb2F0IGludkFscGhhID0gMS4wIC8gYWxwaGE7XG5cdGZsb2F0IGNvczJoID0gZG90TkggKiBkb3ROSDtcblx0ZmxvYXQgc2luMmggPSBtYXgoIDEuMCAtIGNvczJoLCAwLjAwNzgxMjUgKTtcblx0cmV0dXJuICggMi4wICsgaW52QWxwaGEgKSAqIHBvdyggc2luMmgsIGludkFscGhhICogMC41ICkgLyAoIDIuMCAqIFBJICk7XG59XG5mbG9hdCBWX05ldWJlbHQoIGZsb2F0IGRvdE5WLCBmbG9hdCBkb3ROTCApIHtcblx0cmV0dXJuIHNhdHVyYXRlKCAxLjAgLyAoIDQuMCAqICggZG90TkwgKyBkb3ROViAtIGRvdE5MICogZG90TlYgKSApICk7XG59XG52ZWMzIEJSREZfU2hlZW4oIGNvbnN0IGluIHZlYzMgbGlnaHREaXIsIGNvbnN0IGluIHZlYzMgdmlld0RpciwgY29uc3QgaW4gdmVjMyBub3JtYWwsIHZlYzMgc2hlZW5Db2xvciwgY29uc3QgaW4gZmxvYXQgc2hlZW5Sb3VnaG5lc3MgKSB7XG5cdHZlYzMgaGFsZkRpciA9IG5vcm1hbGl6ZSggbGlnaHREaXIgKyB2aWV3RGlyICk7XG5cdGZsb2F0IGRvdE5MID0gc2F0dXJhdGUoIGRvdCggbm9ybWFsLCBsaWdodERpciApICk7XG5cdGZsb2F0IGRvdE5WID0gc2F0dXJhdGUoIGRvdCggbm9ybWFsLCB2aWV3RGlyICkgKTtcblx0ZmxvYXQgZG90TkggPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIGhhbGZEaXIgKSApO1xuXHRmbG9hdCBEID0gRF9DaGFybGllKCBzaGVlblJvdWdobmVzcywgZG90TkggKTtcblx0ZmxvYXQgViA9IFZfTmV1YmVsdCggZG90TlYsIGRvdE5MICk7XG5cdHJldHVybiBzaGVlbkNvbG9yICogKCBEICogViApO1xufVxuI2VuZGlmXG5mbG9hdCBJQkxTaGVlbkJSREYoIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIGZsb2F0IHJvdWdobmVzcyApIHtcblx0ZmxvYXQgZG90TlYgPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIHZpZXdEaXIgKSApO1xuXHRmbG9hdCByMiA9IHJvdWdobmVzcyAqIHJvdWdobmVzcztcblx0ZmxvYXQgYSA9IHJvdWdobmVzcyA8IDAuMjUgPyAtMzM5LjIgKiByMiArIDE2MS40ICogcm91Z2huZXNzIC0gMjUuOSA6IC04LjQ4ICogcjIgKyAxNC4zICogcm91Z2huZXNzIC0gOS45NTtcblx0ZmxvYXQgYiA9IHJvdWdobmVzcyA8IDAuMjUgPyA0NC4wICogcjIgLSAyMy43ICogcm91Z2huZXNzICsgMy4yNiA6IDEuOTcgKiByMiAtIDMuMjcgKiByb3VnaG5lc3MgKyAwLjcyO1xuXHRmbG9hdCBERyA9IGV4cCggYSAqIGRvdE5WICsgYiApICsgKCByb3VnaG5lc3MgPCAwLjI1ID8gMC4wIDogMC4xICogKCByb3VnaG5lc3MgLSAwLjI1ICkgKTtcblx0cmV0dXJuIHNhdHVyYXRlKCBERyAqIFJFQ0lQUk9DQUxfUEkgKTtcbn1cbnZlYzIgREZHQXBwcm94KCBjb25zdCBpbiB2ZWMzIG5vcm1hbCwgY29uc3QgaW4gdmVjMyB2aWV3RGlyLCBjb25zdCBpbiBmbG9hdCByb3VnaG5lc3MgKSB7XG5cdGZsb2F0IGRvdE5WID0gc2F0dXJhdGUoIGRvdCggbm9ybWFsLCB2aWV3RGlyICkgKTtcblx0Y29uc3QgdmVjNCBjMCA9IHZlYzQoIC0gMSwgLSAwLjAyNzUsIC0gMC41NzIsIDAuMDIyICk7XG5cdGNvbnN0IHZlYzQgYzEgPSB2ZWM0KCAxLCAwLjA0MjUsIDEuMDQsIC0gMC4wNCApO1xuXHR2ZWM0IHIgPSByb3VnaG5lc3MgKiBjMCArIGMxO1xuXHRmbG9hdCBhMDA0ID0gbWluKCByLnggKiByLngsIGV4cDIoIC0gOS4yOCAqIGRvdE5WICkgKSAqIHIueCArIHIueTtcblx0dmVjMiBmYWIgPSB2ZWMyKCAtIDEuMDQsIDEuMDQgKSAqIGEwMDQgKyByLnp3O1xuXHRyZXR1cm4gZmFiO1xufVxudmVjMyBFbnZpcm9ubWVudEJSREYoIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIHZlYzMgc3BlY3VsYXJDb2xvciwgY29uc3QgaW4gZmxvYXQgc3BlY3VsYXJGOTAsIGNvbnN0IGluIGZsb2F0IHJvdWdobmVzcyApIHtcblx0dmVjMiBmYWIgPSBERkdBcHByb3goIG5vcm1hbCwgdmlld0Rpciwgcm91Z2huZXNzICk7XG5cdHJldHVybiBzcGVjdWxhckNvbG9yICogZmFiLnggKyBzcGVjdWxhckY5MCAqIGZhYi55O1xufVxuI2lmZGVmIFVTRV9JUklERVNDRU5DRVxudm9pZCBjb21wdXRlTXVsdGlzY2F0dGVyaW5nSXJpZGVzY2VuY2UoIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIHZlYzMgc3BlY3VsYXJDb2xvciwgY29uc3QgaW4gZmxvYXQgc3BlY3VsYXJGOTAsIGNvbnN0IGluIGZsb2F0IGlyaWRlc2NlbmNlLCBjb25zdCBpbiB2ZWMzIGlyaWRlc2NlbmNlRjAsIGNvbnN0IGluIGZsb2F0IHJvdWdobmVzcywgaW5vdXQgdmVjMyBzaW5nbGVTY2F0dGVyLCBpbm91dCB2ZWMzIG11bHRpU2NhdHRlciApIHtcbiNlbHNlXG52b2lkIGNvbXB1dGVNdWx0aXNjYXR0ZXJpbmcoIGNvbnN0IGluIHZlYzMgbm9ybWFsLCBjb25zdCBpbiB2ZWMzIHZpZXdEaXIsIGNvbnN0IGluIHZlYzMgc3BlY3VsYXJDb2xvciwgY29uc3QgaW4gZmxvYXQgc3BlY3VsYXJGOTAsIGNvbnN0IGluIGZsb2F0IHJvdWdobmVzcywgaW5vdXQgdmVjMyBzaW5nbGVTY2F0dGVyLCBpbm91dCB2ZWMzIG11bHRpU2NhdHRlciApIHtcbiNlbmRpZlxuXHR2ZWMyIGZhYiA9IERGR0FwcHJveCggbm9ybWFsLCB2aWV3RGlyLCByb3VnaG5lc3MgKTtcblx0I2lmZGVmIFVTRV9JUklERVNDRU5DRVxuXHRcdHZlYzMgRnIgPSBtaXgoIHNwZWN1bGFyQ29sb3IsIGlyaWRlc2NlbmNlRjAsIGlyaWRlc2NlbmNlICk7XG5cdCNlbHNlXG5cdFx0dmVjMyBGciA9IHNwZWN1bGFyQ29sb3I7XG5cdCNlbmRpZlxuXHR2ZWMzIEZzc0VzcyA9IEZyICogZmFiLnggKyBzcGVjdWxhckY5MCAqIGZhYi55O1xuXHRmbG9hdCBFc3MgPSBmYWIueCArIGZhYi55O1xuXHRmbG9hdCBFbXMgPSAxLjAgLSBFc3M7XG5cdHZlYzMgRmF2ZyA9IEZyICsgKCAxLjAgLSBGciApICogMC4wNDc2MTk7XHR2ZWMzIEZtcyA9IEZzc0VzcyAqIEZhdmcgLyAoIDEuMCAtIEVtcyAqIEZhdmcgKTtcblx0c2luZ2xlU2NhdHRlciArPSBGc3NFc3M7XG5cdG11bHRpU2NhdHRlciArPSBGbXMgKiBFbXM7XG59XG4jaWYgTlVNX1JFQ1RfQVJFQV9MSUdIVFMgPiAwXG5cdHZvaWQgUkVfRGlyZWN0X1JlY3RBcmVhX1BoeXNpY2FsKCBjb25zdCBpbiBSZWN0QXJlYUxpZ2h0IHJlY3RBcmVhTGlnaHQsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlQb3NpdGlvbiwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeU5vcm1hbCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVZpZXdEaXIsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIGNvbnN0IGluIFBoeXNpY2FsTWF0ZXJpYWwgbWF0ZXJpYWwsIGlub3V0IFJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ICkge1xuXHRcdHZlYzMgbm9ybWFsID0gZ2VvbWV0cnlOb3JtYWw7XG5cdFx0dmVjMyB2aWV3RGlyID0gZ2VvbWV0cnlWaWV3RGlyO1xuXHRcdHZlYzMgcG9zaXRpb24gPSBnZW9tZXRyeVBvc2l0aW9uO1xuXHRcdHZlYzMgbGlnaHRQb3MgPSByZWN0QXJlYUxpZ2h0LnBvc2l0aW9uO1xuXHRcdHZlYzMgaGFsZldpZHRoID0gcmVjdEFyZWFMaWdodC5oYWxmV2lkdGg7XG5cdFx0dmVjMyBoYWxmSGVpZ2h0ID0gcmVjdEFyZWFMaWdodC5oYWxmSGVpZ2h0O1xuXHRcdHZlYzMgbGlnaHRDb2xvciA9IHJlY3RBcmVhTGlnaHQuY29sb3I7XG5cdFx0ZmxvYXQgcm91Z2huZXNzID0gbWF0ZXJpYWwucm91Z2huZXNzO1xuXHRcdHZlYzMgcmVjdENvb3Jkc1sgNCBdO1xuXHRcdHJlY3RDb29yZHNbIDAgXSA9IGxpZ2h0UG9zICsgaGFsZldpZHRoIC0gaGFsZkhlaWdodDtcdFx0cmVjdENvb3Jkc1sgMSBdID0gbGlnaHRQb3MgLSBoYWxmV2lkdGggLSBoYWxmSGVpZ2h0O1xuXHRcdHJlY3RDb29yZHNbIDIgXSA9IGxpZ2h0UG9zIC0gaGFsZldpZHRoICsgaGFsZkhlaWdodDtcblx0XHRyZWN0Q29vcmRzWyAzIF0gPSBsaWdodFBvcyArIGhhbGZXaWR0aCArIGhhbGZIZWlnaHQ7XG5cdFx0dmVjMiB1diA9IExUQ19Vdiggbm9ybWFsLCB2aWV3RGlyLCByb3VnaG5lc3MgKTtcblx0XHR2ZWM0IHQxID0gdGV4dHVyZTJEKCBsdGNfMSwgdXYgKTtcblx0XHR2ZWM0IHQyID0gdGV4dHVyZTJEKCBsdGNfMiwgdXYgKTtcblx0XHRtYXQzIG1JbnYgPSBtYXQzKFxuXHRcdFx0dmVjMyggdDEueCwgMCwgdDEueSApLFxuXHRcdFx0dmVjMyggICAgMCwgMSwgICAgMCApLFxuXHRcdFx0dmVjMyggdDEueiwgMCwgdDEudyApXG5cdFx0KTtcblx0XHR2ZWMzIGZyZXNuZWwgPSAoIG1hdGVyaWFsLnNwZWN1bGFyQ29sb3IgKiB0Mi54ICsgKCB2ZWMzKCAxLjAgKSAtIG1hdGVyaWFsLnNwZWN1bGFyQ29sb3IgKSAqIHQyLnkgKTtcblx0XHRyZWZsZWN0ZWRMaWdodC5kaXJlY3RTcGVjdWxhciArPSBsaWdodENvbG9yICogZnJlc25lbCAqIExUQ19FdmFsdWF0ZSggbm9ybWFsLCB2aWV3RGlyLCBwb3NpdGlvbiwgbUludiwgcmVjdENvb3JkcyApO1xuXHRcdHJlZmxlY3RlZExpZ2h0LmRpcmVjdERpZmZ1c2UgKz0gbGlnaHRDb2xvciAqIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciAqIExUQ19FdmFsdWF0ZSggbm9ybWFsLCB2aWV3RGlyLCBwb3NpdGlvbiwgbWF0MyggMS4wICksIHJlY3RDb29yZHMgKTtcblx0fVxuI2VuZGlmXG52b2lkIFJFX0RpcmVjdF9QaHlzaWNhbCggY29uc3QgaW4gSW5jaWRlbnRMaWdodCBkaXJlY3RMaWdodCwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVBvc2l0aW9uLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Tm9ybWFsLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Vmlld0RpciwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgY29uc3QgaW4gUGh5c2ljYWxNYXRlcmlhbCBtYXRlcmlhbCwgaW5vdXQgUmVmbGVjdGVkTGlnaHQgcmVmbGVjdGVkTGlnaHQgKSB7XG5cdGZsb2F0IGRvdE5MID0gc2F0dXJhdGUoIGRvdCggZ2VvbWV0cnlOb3JtYWwsIGRpcmVjdExpZ2h0LmRpcmVjdGlvbiApICk7XG5cdHZlYzMgaXJyYWRpYW5jZSA9IGRvdE5MICogZGlyZWN0TGlnaHQuY29sb3I7XG5cdCNpZmRlZiBVU0VfQ0xFQVJDT0FUXG5cdFx0ZmxvYXQgZG90TkxjYyA9IHNhdHVyYXRlKCBkb3QoIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBkaXJlY3RMaWdodC5kaXJlY3Rpb24gKSApO1xuXHRcdHZlYzMgY2NJcnJhZGlhbmNlID0gZG90TkxjYyAqIGRpcmVjdExpZ2h0LmNvbG9yO1xuXHRcdGNsZWFyY29hdFNwZWN1bGFyRGlyZWN0ICs9IGNjSXJyYWRpYW5jZSAqIEJSREZfR0dYX0NsZWFyY29hdCggZGlyZWN0TGlnaHQuZGlyZWN0aW9uLCBnZW9tZXRyeVZpZXdEaXIsIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBtYXRlcmlhbCApO1xuXHQjZW5kaWZcblx0I2lmZGVmIFVTRV9TSEVFTlxuXHRcdHNoZWVuU3BlY3VsYXJEaXJlY3QgKz0gaXJyYWRpYW5jZSAqIEJSREZfU2hlZW4oIGRpcmVjdExpZ2h0LmRpcmVjdGlvbiwgZ2VvbWV0cnlWaWV3RGlyLCBnZW9tZXRyeU5vcm1hbCwgbWF0ZXJpYWwuc2hlZW5Db2xvciwgbWF0ZXJpYWwuc2hlZW5Sb3VnaG5lc3MgKTtcblx0I2VuZGlmXG5cdHJlZmxlY3RlZExpZ2h0LmRpcmVjdFNwZWN1bGFyICs9IGlycmFkaWFuY2UgKiBCUkRGX0dHWCggZGlyZWN0TGlnaHQuZGlyZWN0aW9uLCBnZW9tZXRyeVZpZXdEaXIsIGdlb21ldHJ5Tm9ybWFsLCBtYXRlcmlhbCApO1xuXHRyZWZsZWN0ZWRMaWdodC5kaXJlY3REaWZmdXNlICs9IGlycmFkaWFuY2UgKiBCUkRGX0xhbWJlcnQoIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciApO1xufVxudm9pZCBSRV9JbmRpcmVjdERpZmZ1c2VfUGh5c2ljYWwoIGNvbnN0IGluIHZlYzMgaXJyYWRpYW5jZSwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeVBvc2l0aW9uLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Tm9ybWFsLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Vmlld0RpciwgY29uc3QgaW4gdmVjMyBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgY29uc3QgaW4gUGh5c2ljYWxNYXRlcmlhbCBtYXRlcmlhbCwgaW5vdXQgUmVmbGVjdGVkTGlnaHQgcmVmbGVjdGVkTGlnaHQgKSB7XG5cdHJlZmxlY3RlZExpZ2h0LmluZGlyZWN0RGlmZnVzZSArPSBpcnJhZGlhbmNlICogQlJERl9MYW1iZXJ0KCBtYXRlcmlhbC5kaWZmdXNlQ29sb3IgKTtcbn1cbnZvaWQgUkVfSW5kaXJlY3RTcGVjdWxhcl9QaHlzaWNhbCggY29uc3QgaW4gdmVjMyByYWRpYW5jZSwgY29uc3QgaW4gdmVjMyBpcnJhZGlhbmNlLCBjb25zdCBpbiB2ZWMzIGNsZWFyY29hdFJhZGlhbmNlLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5UG9zaXRpb24sIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlOb3JtYWwsIGNvbnN0IGluIHZlYzMgZ2VvbWV0cnlWaWV3RGlyLCBjb25zdCBpbiB2ZWMzIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBjb25zdCBpbiBQaHlzaWNhbE1hdGVyaWFsIG1hdGVyaWFsLCBpbm91dCBSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCkge1xuXHQjaWZkZWYgVVNFX0NMRUFSQ09BVFxuXHRcdGNsZWFyY29hdFNwZWN1bGFySW5kaXJlY3QgKz0gY2xlYXJjb2F0UmFkaWFuY2UgKiBFbnZpcm9ubWVudEJSREYoIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBnZW9tZXRyeVZpZXdEaXIsIG1hdGVyaWFsLmNsZWFyY29hdEYwLCBtYXRlcmlhbC5jbGVhcmNvYXRGOTAsIG1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzcyApO1xuXHQjZW5kaWZcblx0I2lmZGVmIFVTRV9TSEVFTlxuXHRcdHNoZWVuU3BlY3VsYXJJbmRpcmVjdCArPSBpcnJhZGlhbmNlICogbWF0ZXJpYWwuc2hlZW5Db2xvciAqIElCTFNoZWVuQlJERiggZ2VvbWV0cnlOb3JtYWwsIGdlb21ldHJ5Vmlld0RpciwgbWF0ZXJpYWwuc2hlZW5Sb3VnaG5lc3MgKTtcblx0I2VuZGlmXG5cdHZlYzMgc2luZ2xlU2NhdHRlcmluZyA9IHZlYzMoIDAuMCApO1xuXHR2ZWMzIG11bHRpU2NhdHRlcmluZyA9IHZlYzMoIDAuMCApO1xuXHR2ZWMzIGNvc2luZVdlaWdodGVkSXJyYWRpYW5jZSA9IGlycmFkaWFuY2UgKiBSRUNJUFJPQ0FMX1BJO1xuXHQjaWZkZWYgVVNFX0lSSURFU0NFTkNFXG5cdFx0Y29tcHV0ZU11bHRpc2NhdHRlcmluZ0lyaWRlc2NlbmNlKCBnZW9tZXRyeU5vcm1hbCwgZ2VvbWV0cnlWaWV3RGlyLCBtYXRlcmlhbC5zcGVjdWxhckNvbG9yLCBtYXRlcmlhbC5zcGVjdWxhckY5MCwgbWF0ZXJpYWwuaXJpZGVzY2VuY2UsIG1hdGVyaWFsLmlyaWRlc2NlbmNlRnJlc25lbCwgbWF0ZXJpYWwucm91Z2huZXNzLCBzaW5nbGVTY2F0dGVyaW5nLCBtdWx0aVNjYXR0ZXJpbmcgKTtcblx0I2Vsc2Vcblx0XHRjb21wdXRlTXVsdGlzY2F0dGVyaW5nKCBnZW9tZXRyeU5vcm1hbCwgZ2VvbWV0cnlWaWV3RGlyLCBtYXRlcmlhbC5zcGVjdWxhckNvbG9yLCBtYXRlcmlhbC5zcGVjdWxhckY5MCwgbWF0ZXJpYWwucm91Z2huZXNzLCBzaW5nbGVTY2F0dGVyaW5nLCBtdWx0aVNjYXR0ZXJpbmcgKTtcblx0I2VuZGlmXG5cdHZlYzMgdG90YWxTY2F0dGVyaW5nID0gc2luZ2xlU2NhdHRlcmluZyArIG11bHRpU2NhdHRlcmluZztcblx0dmVjMyBkaWZmdXNlID0gbWF0ZXJpYWwuZGlmZnVzZUNvbG9yICogKCAxLjAgLSBtYXgoIG1heCggdG90YWxTY2F0dGVyaW5nLnIsIHRvdGFsU2NhdHRlcmluZy5nICksIHRvdGFsU2NhdHRlcmluZy5iICkgKTtcblx0cmVmbGVjdGVkTGlnaHQuaW5kaXJlY3RTcGVjdWxhciArPSByYWRpYW5jZSAqIHNpbmdsZVNjYXR0ZXJpbmc7XG5cdHJlZmxlY3RlZExpZ2h0LmluZGlyZWN0U3BlY3VsYXIgKz0gbXVsdGlTY2F0dGVyaW5nICogY29zaW5lV2VpZ2h0ZWRJcnJhZGlhbmNlO1xuXHRyZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKz0gZGlmZnVzZSAqIGNvc2luZVdlaWdodGVkSXJyYWRpYW5jZTtcbn1cbiNkZWZpbmUgUkVfRGlyZWN0XHRcdFx0XHRSRV9EaXJlY3RfUGh5c2ljYWxcbiNkZWZpbmUgUkVfRGlyZWN0X1JlY3RBcmVhXHRcdFJFX0RpcmVjdF9SZWN0QXJlYV9QaHlzaWNhbFxuI2RlZmluZSBSRV9JbmRpcmVjdERpZmZ1c2VcdFx0UkVfSW5kaXJlY3REaWZmdXNlX1BoeXNpY2FsXG4jZGVmaW5lIFJFX0luZGlyZWN0U3BlY3VsYXJcdFx0UkVfSW5kaXJlY3RTcGVjdWxhcl9QaHlzaWNhbFxuZmxvYXQgY29tcHV0ZVNwZWN1bGFyT2NjbHVzaW9uKCBjb25zdCBpbiBmbG9hdCBkb3ROViwgY29uc3QgaW4gZmxvYXQgYW1iaWVudE9jY2x1c2lvbiwgY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzICkge1xuXHRyZXR1cm4gc2F0dXJhdGUoIHBvdyggZG90TlYgKyBhbWJpZW50T2NjbHVzaW9uLCBleHAyKCAtIDE2LjAgKiByb3VnaG5lc3MgLSAxLjAgKSApIC0gMS4wICsgYW1iaWVudE9jY2x1c2lvbiApO1xufSI7Cgp2YXIgbGlnaHRzX2ZyYWdtZW50X2JlZ2luID0gIlxudmVjMyBnZW9tZXRyeVBvc2l0aW9uID0gLSB2Vmlld1Bvc2l0aW9uO1xudmVjMyBnZW9tZXRyeU5vcm1hbCA9IG5vcm1hbDtcbnZlYzMgZ2VvbWV0cnlWaWV3RGlyID0gKCBpc09ydGhvZ3JhcGhpYyApID8gdmVjMyggMCwgMCwgMSApIDogbm9ybWFsaXplKCB2Vmlld1Bvc2l0aW9uICk7XG52ZWMzIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsID0gdmVjMyggMC4wICk7XG4jaWZkZWYgVVNFX0NMRUFSQ09BVFxuXHRnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCA9IGNsZWFyY29hdE5vcm1hbDtcbiNlbmRpZlxuI2lmZGVmIFVTRV9JUklERVNDRU5DRVxuXHRmbG9hdCBkb3ROVmkgPSBzYXR1cmF0ZSggZG90KCBub3JtYWwsIGdlb21ldHJ5Vmlld0RpciApICk7XG5cdGlmICggbWF0ZXJpYWwuaXJpZGVzY2VuY2VUaGlja25lc3MgPT0gMC4wICkge1xuXHRcdG1hdGVyaWFsLmlyaWRlc2NlbmNlID0gMC4wO1xuXHR9IGVsc2Uge1xuXHRcdG1hdGVyaWFsLmlyaWRlc2NlbmNlID0gc2F0dXJhdGUoIG1hdGVyaWFsLmlyaWRlc2NlbmNlICk7XG5cdH1cblx0aWYgKCBtYXRlcmlhbC5pcmlkZXNjZW5jZSA+IDAuMCApIHtcblx0XHRtYXRlcmlhbC5pcmlkZXNjZW5jZUZyZXNuZWwgPSBldmFsSXJpZGVzY2VuY2UoIDEuMCwgbWF0ZXJpYWwuaXJpZGVzY2VuY2VJT1IsIGRvdE5WaSwgbWF0ZXJpYWwuaXJpZGVzY2VuY2VUaGlja25lc3MsIG1hdGVyaWFsLnNwZWN1bGFyQ29sb3IgKTtcblx0XHRtYXRlcmlhbC5pcmlkZXNjZW5jZUYwID0gU2NobGlja190b19GMCggbWF0ZXJpYWwuaXJpZGVzY2VuY2VGcmVzbmVsLCAxLjAsIGRvdE5WaSApO1xuXHR9XG4jZW5kaWZcbkluY2lkZW50TGlnaHQgZGlyZWN0TGlnaHQ7XG4jaWYgKCBOVU1fUE9JTlRfTElHSFRTID4gMCApICYmIGRlZmluZWQoIFJFX0RpcmVjdCApXG5cdFBvaW50TGlnaHQgcG9pbnRMaWdodDtcblx0I2lmIGRlZmluZWQoIFVTRV9TSEFET1dNQVAgKSAmJiBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyA+IDBcblx0UG9pbnRMaWdodFNoYWRvdyBwb2ludExpZ2h0U2hhZG93O1xuXHQjZW5kaWZcblx0I3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydFxuXHRmb3IgKCBpbnQgaSA9IDA7IGkgPCBOVU1fUE9JTlRfTElHSFRTOyBpICsrICkge1xuXHRcdHBvaW50TGlnaHQgPSBwb2ludExpZ2h0c1sgaSBdO1xuXHRcdGdldFBvaW50TGlnaHRJbmZvKCBwb2ludExpZ2h0LCBnZW9tZXRyeVBvc2l0aW9uLCBkaXJlY3RMaWdodCApO1xuXHRcdCNpZiBkZWZpbmVkKCBVU0VfU0hBRE9XTUFQICkgJiYgKCBVTlJPTExFRF9MT09QX0lOREVYIDwgTlVNX1BPSU5UX0xJR0hUX1NIQURPV1MgKVxuXHRcdHBvaW50TGlnaHRTaGFkb3cgPSBwb2ludExpZ2h0U2hhZG93c1sgaSBdO1xuXHRcdGRpcmVjdExpZ2h0LmNvbG9yICo9ICggZGlyZWN0TGlnaHQudmlzaWJsZSAmJiByZWNlaXZlU2hhZG93ICkgPyBnZXRQb2ludFNoYWRvdyggcG9pbnRTaGFkb3dNYXBbIGkgXSwgcG9pbnRMaWdodFNoYWRvdy5zaGFkb3dNYXBTaXplLCBwb2ludExpZ2h0U2hhZG93LnNoYWRvd0JpYXMsIHBvaW50TGlnaHRTaGFkb3cuc2hhZG93UmFkaXVzLCB2UG9pbnRTaGFkb3dDb29yZFsgaSBdLCBwb2ludExpZ2h0U2hhZG93LnNoYWRvd0NhbWVyYU5lYXIsIHBvaW50TGlnaHRTaGFkb3cuc2hhZG93Q2FtZXJhRmFyICkgOiAxLjA7XG5cdFx0I2VuZGlmXG5cdFx0UkVfRGlyZWN0KCBkaXJlY3RMaWdodCwgZ2VvbWV0cnlQb3NpdGlvbiwgZ2VvbWV0cnlOb3JtYWwsIGdlb21ldHJ5Vmlld0RpciwgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIG1hdGVyaWFsLCByZWZsZWN0ZWRMaWdodCApO1xuXHR9XG5cdCNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kXG4jZW5kaWZcbiNpZiAoIE5VTV9TUE9UX0xJR0hUUyA+IDAgKSAmJiBkZWZpbmVkKCBSRV9EaXJlY3QgKVxuXHRTcG90TGlnaHQgc3BvdExpZ2h0O1xuXHR2ZWM0IHNwb3RDb2xvcjtcblx0dmVjMyBzcG90TGlnaHRDb29yZDtcblx0Ym9vbCBpblNwb3RMaWdodE1hcDtcblx0I2lmIGRlZmluZWQoIFVTRV9TSEFET1dNQVAgKSAmJiBOVU1fU1BPVF9MSUdIVF9TSEFET1dTID4gMFxuXHRTcG90TGlnaHRTaGFkb3cgc3BvdExpZ2h0U2hhZG93O1xuXHQjZW5kaWZcblx0I3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydFxuXHRmb3IgKCBpbnQgaSA9IDA7IGkgPCBOVU1fU1BPVF9MSUdIVFM7IGkgKysgKSB7XG5cdFx0c3BvdExpZ2h0ID0gc3BvdExpZ2h0c1sgaSBdO1xuXHRcdGdldFNwb3RMaWdodEluZm8oIHNwb3RMaWdodCwgZ2VvbWV0cnlQb3NpdGlvbiwgZGlyZWN0TGlnaHQgKTtcblx0XHQjaWYgKCBVTlJPTExFRF9MT09QX0lOREVYIDwgTlVNX1NQT1RfTElHSFRfU0hBRE9XU19XSVRIX01BUFMgKVxuXHRcdCNkZWZpbmUgU1BPVF9MSUdIVF9NQVBfSU5ERVggVU5ST0xMRURfTE9PUF9JTkRFWFxuXHRcdCNlbGlmICggVU5ST0xMRURfTE9PUF9JTkRFWCA8IE5VTV9TUE9UX0xJR0hUX1NIQURPV1MgKVxuXHRcdCNkZWZpbmUgU1BPVF9MSUdIVF9NQVBfSU5ERVggTlVNX1NQT1RfTElHSFRfTUFQU1xuXHRcdCNlbHNlXG5cdFx0I2RlZmluZSBTUE9UX0xJR0hUX01BUF9JTkRFWCAoIFVOUk9MTEVEX0xPT1BfSU5ERVggLSBOVU1fU1BPVF9MSUdIVF9TSEFET1dTICsgTlVNX1NQT1RfTElHSFRfU0hBRE9XU19XSVRIX01BUFMgKVxuXHRcdCNlbmRpZlxuXHRcdCNpZiAoIFNQT1RfTElHSFRfTUFQX0lOREVYIDwgTlVNX1NQT1RfTElHSFRfTUFQUyApXG5cdFx0XHRzcG90TGlnaHRDb29yZCA9IHZTcG90TGlnaHRDb29yZFsgaSBdLnh5eiAvIHZTcG90TGlnaHRDb29yZFsgaSBdLnc7XG5cdFx0XHRpblNwb3RMaWdodE1hcCA9IGFsbCggbGVzc1RoYW4oIGFicyggc3BvdExpZ2h0Q29vcmQgKiAyLiAtIDEuICksIHZlYzMoIDEuMCApICkgKTtcblx0XHRcdHNwb3RDb2xvciA9IHRleHR1cmUyRCggc3BvdExpZ2h0TWFwWyBTUE9UX0xJR0hUX01BUF9JTkRFWCBdLCBzcG90TGlnaHRDb29yZC54eSApO1xuXHRcdFx0ZGlyZWN0TGlnaHQuY29sb3IgPSBpblNwb3RMaWdodE1hcCA/IGRpcmVjdExpZ2h0LmNvbG9yICogc3BvdENvbG9yLnJnYiA6IGRpcmVjdExpZ2h0LmNvbG9yO1xuXHRcdCNlbmRpZlxuXHRcdCN1bmRlZiBTUE9UX0xJR0hUX01BUF9JTkRFWFxuXHRcdCNpZiBkZWZpbmVkKCBVU0VfU0hBRE9XTUFQICkgJiYgKCBVTlJPTExFRF9MT09QX0lOREVYIDwgTlVNX1NQT1RfTElHSFRfU0hBRE9XUyApXG5cdFx0c3BvdExpZ2h0U2hhZG93ID0gc3BvdExpZ2h0U2hhZG93c1sgaSBdO1xuXHRcdGRpcmVjdExpZ2h0LmNvbG9yICo9ICggZGlyZWN0TGlnaHQudmlzaWJsZSAmJiByZWNlaXZlU2hhZG93ICkgPyBnZXRTaGFkb3coIHNwb3RTaGFkb3dNYXBbIGkgXSwgc3BvdExpZ2h0U2hhZG93LnNoYWRvd01hcFNpemUsIHNwb3RMaWdodFNoYWRvdy5zaGFkb3dCaWFzLCBzcG90TGlnaHRTaGFkb3cuc2hhZG93UmFkaXVzLCB2U3BvdExpZ2h0Q29vcmRbIGkgXSApIDogMS4wO1xuXHRcdCNlbmRpZlxuXHRcdFJFX0RpcmVjdCggZGlyZWN0TGlnaHQsIGdlb21ldHJ5UG9zaXRpb24sIGdlb21ldHJ5Tm9ybWFsLCBnZW9tZXRyeVZpZXdEaXIsIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBtYXRlcmlhbCwgcmVmbGVjdGVkTGlnaHQgKTtcblx0fVxuXHQjcHJhZ21hIHVucm9sbF9sb29wX2VuZFxuI2VuZGlmXG4jaWYgKCBOVU1fRElSX0xJR0hUUyA+IDAgKSAmJiBkZWZpbmVkKCBSRV9EaXJlY3QgKVxuXHREaXJlY3Rpb25hbExpZ2h0IGRpcmVjdGlvbmFsTGlnaHQ7XG5cdCNpZiBkZWZpbmVkKCBVU0VfU0hBRE9XTUFQICkgJiYgTlVNX0RJUl9MSUdIVF9TSEFET1dTID4gMFxuXHREaXJlY3Rpb25hbExpZ2h0U2hhZG93IGRpcmVjdGlvbmFsTGlnaHRTaGFkb3c7XG5cdCNlbmRpZlxuXHQjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0XG5cdGZvciAoIGludCBpID0gMDsgaSA8IE5VTV9ESVJfTElHSFRTOyBpICsrICkge1xuXHRcdGRpcmVjdGlvbmFsTGlnaHQgPSBkaXJlY3Rpb25hbExpZ2h0c1sgaSBdO1xuXHRcdGdldERpcmVjdGlvbmFsTGlnaHRJbmZvKCBkaXJlY3Rpb25hbExpZ2h0LCBkaXJlY3RMaWdodCApO1xuXHRcdCNpZiBkZWZpbmVkKCBVU0VfU0hBRE9XTUFQICkgJiYgKCBVTlJPTExFRF9MT09QX0lOREVYIDwgTlVNX0RJUl9MSUdIVF9TSEFET1dTIClcblx0XHRkaXJlY3Rpb25hbExpZ2h0U2hhZG93ID0gZGlyZWN0aW9uYWxMaWdodFNoYWRvd3NbIGkgXTtcblx0XHRkaXJlY3RMaWdodC5jb2xvciAqPSAoIGRpcmVjdExpZ2h0LnZpc2libGUgJiYgcmVjZWl2ZVNoYWRvdyApID8gZ2V0U2hhZG93KCBkaXJlY3Rpb25hbFNoYWRvd01hcFsgaSBdLCBkaXJlY3Rpb25hbExpZ2h0U2hhZG93LnNoYWRvd01hcFNpemUsIGRpcmVjdGlvbmFsTGlnaHRTaGFkb3cuc2hhZG93QmlhcywgZGlyZWN0aW9uYWxMaWdodFNoYWRvdy5zaGFkb3dSYWRpdXMsIHZEaXJlY3Rpb25hbFNoYWRvd0Nvb3JkWyBpIF0gKSA6IDEuMDtcblx0XHQjZW5kaWZcblx0XHRSRV9EaXJlY3QoIGRpcmVjdExpZ2h0LCBnZW9tZXRyeVBvc2l0aW9uLCBnZW9tZXRyeU5vcm1hbCwgZ2VvbWV0cnlWaWV3RGlyLCBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgbWF0ZXJpYWwsIHJlZmxlY3RlZExpZ2h0ICk7XG5cdH1cblx0I3ByYWdtYSB1bnJvbGxfbG9vcF9lbmRcbiNlbmRpZlxuI2lmICggTlVNX1JFQ1RfQVJFQV9MSUdIVFMgPiAwICkgJiYgZGVmaW5lZCggUkVfRGlyZWN0X1JlY3RBcmVhIClcblx0UmVjdEFyZWFMaWdodCByZWN0QXJlYUxpZ2h0O1xuXHQjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0XG5cdGZvciAoIGludCBpID0gMDsgaSA8IE5VTV9SRUNUX0FSRUFfTElHSFRTOyBpICsrICkge1xuXHRcdHJlY3RBcmVhTGlnaHQgPSByZWN0QXJlYUxpZ2h0c1sgaSBdO1xuXHRcdFJFX0RpcmVjdF9SZWN0QXJlYSggcmVjdEFyZWFMaWdodCwgZ2VvbWV0cnlQb3NpdGlvbiwgZ2VvbWV0cnlOb3JtYWwsIGdlb21ldHJ5Vmlld0RpciwgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIG1hdGVyaWFsLCByZWZsZWN0ZWRMaWdodCApO1xuXHR9XG5cdCNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kXG4jZW5kaWZcbiNpZiBkZWZpbmVkKCBSRV9JbmRpcmVjdERpZmZ1c2UgKVxuXHR2ZWMzIGlibElycmFkaWFuY2UgPSB2ZWMzKCAwLjAgKTtcblx0dmVjMyBpcnJhZGlhbmNlID0gZ2V0QW1iaWVudExpZ2h0SXJyYWRpYW5jZSggYW1iaWVudExpZ2h0Q29sb3IgKTtcblx0I2lmIGRlZmluZWQoIFVTRV9MSUdIVF9QUk9CRVMgKVxuXHRcdGlycmFkaWFuY2UgKz0gZ2V0TGlnaHRQcm9iZUlycmFkaWFuY2UoIGxpZ2h0UHJvYmUsIGdlb21ldHJ5Tm9ybWFsICk7XG5cdCNlbmRpZlxuXHQjaWYgKCBOVU1fSEVNSV9MSUdIVFMgPiAwIClcblx0XHQjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0XG5cdFx0Zm9yICggaW50IGkgPSAwOyBpIDwgTlVNX0hFTUlfTElHSFRTOyBpICsrICkge1xuXHRcdFx0aXJyYWRpYW5jZSArPSBnZXRIZW1pc3BoZXJlTGlnaHRJcnJhZGlhbmNlKCBoZW1pc3BoZXJlTGlnaHRzWyBpIF0sIGdlb21ldHJ5Tm9ybWFsICk7XG5cdFx0fVxuXHRcdCNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kXG5cdCNlbmRpZlxuI2VuZGlmXG4jaWYgZGVmaW5lZCggUkVfSW5kaXJlY3RTcGVjdWxhciApXG5cdHZlYzMgcmFkaWFuY2UgPSB2ZWMzKCAwLjAgKTtcblx0dmVjMyBjbGVhcmNvYXRSYWRpYW5jZSA9IHZlYzMoIDAuMCApO1xuI2VuZGlmIjsKCnZhciBsaWdodHNfZnJhZ21lbnRfbWFwcyA9ICIjaWYgZGVmaW5lZCggUkVfSW5kaXJlY3REaWZmdXNlIClcblx0I2lmZGVmIFVTRV9MSUdIVE1BUFxuXHRcdHZlYzQgbGlnaHRNYXBUZXhlbCA9IHRleHR1cmUyRCggbGlnaHRNYXAsIHZMaWdodE1hcFV2ICk7XG5cdFx0dmVjMyBsaWdodE1hcElycmFkaWFuY2UgPSBsaWdodE1hcFRleGVsLnJnYiAqIGxpZ2h0TWFwSW50ZW5zaXR5O1xuXHRcdGlycmFkaWFuY2UgKz0gbGlnaHRNYXBJcnJhZGlhbmNlO1xuXHQjZW5kaWZcblx0I2lmIGRlZmluZWQoIFVTRV9FTlZNQVAgKSAmJiBkZWZpbmVkKCBTVEFOREFSRCApICYmIGRlZmluZWQoIEVOVk1BUF9UWVBFX0NVQkVfVVYgKVxuXHRcdGlibElycmFkaWFuY2UgKz0gZ2V0SUJMSXJyYWRpYW5jZSggZ2VvbWV0cnlOb3JtYWwgKTtcblx0I2VuZGlmXG4jZW5kaWZcbiNpZiBkZWZpbmVkKCBVU0VfRU5WTUFQICkgJiYgZGVmaW5lZCggUkVfSW5kaXJlY3RTcGVjdWxhciApXG5cdCNpZmRlZiBVU0VfQU5JU09UUk9QWVxuXHRcdHJhZGlhbmNlICs9IGdldElCTEFuaXNvdHJvcHlSYWRpYW5jZSggZ2VvbWV0cnlWaWV3RGlyLCBnZW9tZXRyeU5vcm1hbCwgbWF0ZXJpYWwucm91Z2huZXNzLCBtYXRlcmlhbC5hbmlzb3Ryb3B5QiwgbWF0ZXJpYWwuYW5pc290cm9weSApO1xuXHQjZWxzZVxuXHRcdHJhZGlhbmNlICs9IGdldElCTFJhZGlhbmNlKCBnZW9tZXRyeVZpZXdEaXIsIGdlb21ldHJ5Tm9ybWFsLCBtYXRlcmlhbC5yb3VnaG5lc3MgKTtcblx0I2VuZGlmXG5cdCNpZmRlZiBVU0VfQ0xFQVJDT0FUXG5cdFx0Y2xlYXJjb2F0UmFkaWFuY2UgKz0gZ2V0SUJMUmFkaWFuY2UoIGdlb21ldHJ5Vmlld0RpciwgZ2VvbWV0cnlDbGVhcmNvYXROb3JtYWwsIG1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzcyApO1xuXHQjZW5kaWZcbiNlbmRpZiI7Cgp2YXIgbGlnaHRzX2ZyYWdtZW50X2VuZCA9ICIjaWYgZGVmaW5lZCggUkVfSW5kaXJlY3REaWZmdXNlIClcblx0UkVfSW5kaXJlY3REaWZmdXNlKCBpcnJhZGlhbmNlLCBnZW9tZXRyeVBvc2l0aW9uLCBnZW9tZXRyeU5vcm1hbCwgZ2VvbWV0cnlWaWV3RGlyLCBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgbWF0ZXJpYWwsIHJlZmxlY3RlZExpZ2h0ICk7XG4jZW5kaWZcbiNpZiBkZWZpbmVkKCBSRV9JbmRpcmVjdFNwZWN1bGFyIClcblx0UkVfSW5kaXJlY3RTcGVjdWxhciggcmFkaWFuY2UsIGlibElycmFkaWFuY2UsIGNsZWFyY29hdFJhZGlhbmNlLCBnZW9tZXRyeVBvc2l0aW9uLCBnZW9tZXRyeU5vcm1hbCwgZ2VvbWV0cnlWaWV3RGlyLCBnZW9tZXRyeUNsZWFyY29hdE5vcm1hbCwgbWF0ZXJpYWwsIHJlZmxlY3RlZExpZ2h0ICk7XG4jZW5kaWYiOwoKdmFyIGxvZ2RlcHRoYnVmX2ZyYWdtZW50ID0gIiNpZiBkZWZpbmVkKCBVU0VfTE9HREVQVEhCVUYgKSAmJiBkZWZpbmVkKCBVU0VfTE9HREVQVEhCVUZfRVhUIClcblx0Z2xfRnJhZ0RlcHRoRVhUID0gdklzUGVyc3BlY3RpdmUgPT0gMC4wID8gZ2xfRnJhZ0Nvb3JkLnogOiBsb2cyKCB2RnJhZ0RlcHRoICkgKiBsb2dEZXB0aEJ1ZkZDICogMC41O1xuI2VuZGlmIjsKCnZhciBsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50ID0gIiNpZiBkZWZpbmVkKCBVU0VfTE9HREVQVEhCVUYgKSAmJiBkZWZpbmVkKCBVU0VfTE9HREVQVEhCVUZfRVhUIClcblx0dW5pZm9ybSBmbG9hdCBsb2dEZXB0aEJ1ZkZDO1xuXHR2YXJ5aW5nIGZsb2F0IHZGcmFnRGVwdGg7XG5cdHZhcnlpbmcgZmxvYXQgdklzUGVyc3BlY3RpdmU7XG4jZW5kaWYiOwoKdmFyIGxvZ2RlcHRoYnVmX3BhcnNfdmVydGV4ID0gIiNpZmRlZiBVU0VfTE9HREVQVEhCVUZcblx0I2lmZGVmIFVTRV9MT0dERVBUSEJVRl9FWFRcblx0XHR2YXJ5aW5nIGZsb2F0IHZGcmFnRGVwdGg7XG5cdFx0dmFyeWluZyBmbG9hdCB2SXNQZXJzcGVjdGl2ZTtcblx0I2Vsc2Vcblx0XHR1bmlmb3JtIGZsb2F0IGxvZ0RlcHRoQnVmRkM7XG5cdCNlbmRpZlxuI2VuZGlmIjsKCnZhciBsb2dkZXB0aGJ1Zl92ZXJ0ZXggPSAiI2lmZGVmIFVTRV9MT0dERVBUSEJVRlxuXHQjaWZkZWYgVVNFX0xPR0RFUFRIQlVGX0VYVFxuXHRcdHZGcmFnRGVwdGggPSAxLjAgKyBnbF9Qb3NpdGlvbi53O1xuXHRcdHZJc1BlcnNwZWN0aXZlID0gZmxvYXQoIGlzUGVyc3BlY3RpdmVNYXRyaXgoIHByb2plY3Rpb25NYXRyaXggKSApO1xuXHQjZWxzZVxuXHRcdGlmICggaXNQZXJzcGVjdGl2ZU1hdHJpeCggcHJvamVjdGlvbk1hdHJpeCApICkge1xuXHRcdFx0Z2xfUG9zaXRpb24ueiA9IGxvZzIoIG1heCggRVBTSUxPTiwgZ2xfUG9zaXRpb24udyArIDEuMCApICkgKiBsb2dEZXB0aEJ1ZkZDIC0gMS4wO1xuXHRcdFx0Z2xfUG9zaXRpb24ueiAqPSBnbF9Qb3NpdGlvbi53O1xuXHRcdH1cblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIG1hcF9mcmFnbWVudCA9ICIjaWZkZWYgVVNFX01BUFxuXHR2ZWM0IHNhbXBsZWREaWZmdXNlQ29sb3IgPSB0ZXh0dXJlMkQoIG1hcCwgdk1hcFV2ICk7XG5cdCNpZmRlZiBERUNPREVfVklERU9fVEVYVFVSRVxuXHRcdHNhbXBsZWREaWZmdXNlQ29sb3IgPSB2ZWM0KCBtaXgoIHBvdyggc2FtcGxlZERpZmZ1c2VDb2xvci5yZ2IgKiAwLjk0Nzg2NzI5ODYgKyB2ZWMzKCAwLjA1MjEzMjcwMTQgKSwgdmVjMyggMi40ICkgKSwgc2FtcGxlZERpZmZ1c2VDb2xvci5yZ2IgKiAwLjA3NzM5OTM4MDgsIHZlYzMoIGxlc3NUaGFuRXF1YWwoIHNhbXBsZWREaWZmdXNlQ29sb3IucmdiLCB2ZWMzKCAwLjA0MDQ1ICkgKSApICksIHNhbXBsZWREaWZmdXNlQ29sb3IudyApO1xuXHRcblx0I2VuZGlmXG5cdGRpZmZ1c2VDb2xvciAqPSBzYW1wbGVkRGlmZnVzZUNvbG9yO1xuI2VuZGlmIjsKCnZhciBtYXBfcGFyc19mcmFnbWVudCA9ICIjaWZkZWYgVVNFX01BUFxuXHR1bmlmb3JtIHNhbXBsZXIyRCBtYXA7XG4jZW5kaWYiOwoKdmFyIG1hcF9wYXJ0aWNsZV9mcmFnbWVudCA9ICIjaWYgZGVmaW5lZCggVVNFX01BUCApIHx8IGRlZmluZWQoIFVTRV9BTFBIQU1BUCApXG5cdCNpZiBkZWZpbmVkKCBVU0VfUE9JTlRTX1VWIClcblx0XHR2ZWMyIHV2ID0gdlV2O1xuXHQjZWxzZVxuXHRcdHZlYzIgdXYgPSAoIHV2VHJhbnNmb3JtICogdmVjMyggZ2xfUG9pbnRDb29yZC54LCAxLjAgLSBnbF9Qb2ludENvb3JkLnksIDEgKSApLnh5O1xuXHQjZW5kaWZcbiNlbmRpZlxuI2lmZGVmIFVTRV9NQVBcblx0ZGlmZnVzZUNvbG9yICo9IHRleHR1cmUyRCggbWFwLCB1diApO1xuI2VuZGlmXG4jaWZkZWYgVVNFX0FMUEhBTUFQXG5cdGRpZmZ1c2VDb2xvci5hICo9IHRleHR1cmUyRCggYWxwaGFNYXAsIHV2ICkuZztcbiNlbmRpZiI7Cgp2YXIgbWFwX3BhcnRpY2xlX3BhcnNfZnJhZ21lbnQgPSAiI2lmIGRlZmluZWQoIFVTRV9QT0lOVFNfVVYgKVxuXHR2YXJ5aW5nIHZlYzIgdlV2O1xuI2Vsc2Vcblx0I2lmIGRlZmluZWQoIFVTRV9NQVAgKSB8fCBkZWZpbmVkKCBVU0VfQUxQSEFNQVAgKVxuXHRcdHVuaWZvcm0gbWF0MyB1dlRyYW5zZm9ybTtcblx0I2VuZGlmXG4jZW5kaWZcbiNpZmRlZiBVU0VfTUFQXG5cdHVuaWZvcm0gc2FtcGxlcjJEIG1hcDtcbiNlbmRpZlxuI2lmZGVmIFVTRV9BTFBIQU1BUFxuXHR1bmlmb3JtIHNhbXBsZXIyRCBhbHBoYU1hcDtcbiNlbmRpZiI7Cgp2YXIgbWV0YWxuZXNzbWFwX2ZyYWdtZW50ID0gImZsb2F0IG1ldGFsbmVzc0ZhY3RvciA9IG1ldGFsbmVzcztcbiNpZmRlZiBVU0VfTUVUQUxORVNTTUFQXG5cdHZlYzQgdGV4ZWxNZXRhbG5lc3MgPSB0ZXh0dXJlMkQoIG1ldGFsbmVzc01hcCwgdk1ldGFsbmVzc01hcFV2ICk7XG5cdG1ldGFsbmVzc0ZhY3RvciAqPSB0ZXhlbE1ldGFsbmVzcy5iO1xuI2VuZGlmIjsKCnZhciBtZXRhbG5lc3NtYXBfcGFyc19mcmFnbWVudCA9ICIjaWZkZWYgVVNFX01FVEFMTkVTU01BUFxuXHR1bmlmb3JtIHNhbXBsZXIyRCBtZXRhbG5lc3NNYXA7XG4jZW5kaWYiOwoKdmFyIG1vcnBoY29sb3JfdmVydGV4ID0gIiNpZiBkZWZpbmVkKCBVU0VfTU9SUEhDT0xPUlMgKSAmJiBkZWZpbmVkKCBNT1JQSFRBUkdFVFNfVEVYVFVSRSApXG5cdHZDb2xvciAqPSBtb3JwaFRhcmdldEJhc2VJbmZsdWVuY2U7XG5cdGZvciAoIGludCBpID0gMDsgaSA8IE1PUlBIVEFSR0VUU19DT1VOVDsgaSArKyApIHtcblx0XHQjaWYgZGVmaW5lZCggVVNFX0NPTE9SX0FMUEhBIClcblx0XHRcdGlmICggbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyBpIF0gIT0gMC4wICkgdkNvbG9yICs9IGdldE1vcnBoKCBnbF9WZXJ0ZXhJRCwgaSwgMiApICogbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyBpIF07XG5cdFx0I2VsaWYgZGVmaW5lZCggVVNFX0NPTE9SIClcblx0XHRcdGlmICggbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyBpIF0gIT0gMC4wICkgdkNvbG9yICs9IGdldE1vcnBoKCBnbF9WZXJ0ZXhJRCwgaSwgMiApLnJnYiAqIG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgaSBdO1xuXHRcdCNlbmRpZlxuXHR9XG4jZW5kaWYiOwoKdmFyIG1vcnBobm9ybWFsX3ZlcnRleCA9ICIjaWZkZWYgVVNFX01PUlBITk9STUFMU1xuXHRvYmplY3ROb3JtYWwgKj0gbW9ycGhUYXJnZXRCYXNlSW5mbHVlbmNlO1xuXHQjaWZkZWYgTU9SUEhUQVJHRVRTX1RFWFRVUkVcblx0XHRmb3IgKCBpbnQgaSA9IDA7IGkgPCBNT1JQSFRBUkdFVFNfQ09VTlQ7IGkgKysgKSB7XG5cdFx0XHRpZiAoIG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgaSBdICE9IDAuMCApIG9iamVjdE5vcm1hbCArPSBnZXRNb3JwaCggZ2xfVmVydGV4SUQsIGksIDEgKS54eXogKiBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIGkgXTtcblx0XHR9XG5cdCNlbHNlXG5cdFx0b2JqZWN0Tm9ybWFsICs9IG1vcnBoTm9ybWFsMCAqIG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgMCBdO1xuXHRcdG9iamVjdE5vcm1hbCArPSBtb3JwaE5vcm1hbDEgKiBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIDEgXTtcblx0XHRvYmplY3ROb3JtYWwgKz0gbW9ycGhOb3JtYWwyICogbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyAyIF07XG5cdFx0b2JqZWN0Tm9ybWFsICs9IG1vcnBoTm9ybWFsMyAqIG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgMyBdO1xuXHQjZW5kaWZcbiNlbmRpZiI7Cgp2YXIgbW9ycGh0YXJnZXRfcGFyc192ZXJ0ZXggPSAiI2lmZGVmIFVTRV9NT1JQSFRBUkdFVFNcblx0dW5pZm9ybSBmbG9hdCBtb3JwaFRhcmdldEJhc2VJbmZsdWVuY2U7XG5cdCNpZmRlZiBNT1JQSFRBUkdFVFNfVEVYVFVSRVxuXHRcdHVuaWZvcm0gZmxvYXQgbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyBNT1JQSFRBUkdFVFNfQ09VTlQgXTtcblx0XHR1bmlmb3JtIHNhbXBsZXIyREFycmF5IG1vcnBoVGFyZ2V0c1RleHR1cmU7XG5cdFx0dW5pZm9ybSBpdmVjMiBtb3JwaFRhcmdldHNUZXh0dXJlU2l6ZTtcblx0XHR2ZWM0IGdldE1vcnBoKCBjb25zdCBpbiBpbnQgdmVydGV4SW5kZXgsIGNvbnN0IGluIGludCBtb3JwaFRhcmdldEluZGV4LCBjb25zdCBpbiBpbnQgb2Zmc2V0ICkge1xuXHRcdFx0aW50IHRleGVsSW5kZXggPSB2ZXJ0ZXhJbmRleCAqIE1PUlBIVEFSR0VUU19URVhUVVJFX1NUUklERSArIG9mZnNldDtcblx0XHRcdGludCB5ID0gdGV4ZWxJbmRleCAvIG1vcnBoVGFyZ2V0c1RleHR1cmVTaXplLng7XG5cdFx0XHRpbnQgeCA9IHRleGVsSW5kZXggLSB5ICogbW9ycGhUYXJnZXRzVGV4dHVyZVNpemUueDtcblx0XHRcdGl2ZWMzIG1vcnBoVVYgPSBpdmVjMyggeCwgeSwgbW9ycGhUYXJnZXRJbmRleCApO1xuXHRcdFx0cmV0dXJuIHRleGVsRmV0Y2goIG1vcnBoVGFyZ2V0c1RleHR1cmUsIG1vcnBoVVYsIDAgKTtcblx0XHR9XG5cdCNlbHNlXG5cdFx0I2lmbmRlZiBVU0VfTU9SUEhOT1JNQUxTXG5cdFx0XHR1bmlmb3JtIGZsb2F0IG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgOCBdO1xuXHRcdCNlbHNlXG5cdFx0XHR1bmlmb3JtIGZsb2F0IG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgNCBdO1xuXHRcdCNlbmRpZlxuXHQjZW5kaWZcbiNlbmRpZiI7Cgp2YXIgbW9ycGh0YXJnZXRfdmVydGV4ID0gIiNpZmRlZiBVU0VfTU9SUEhUQVJHRVRTXG5cdHRyYW5zZm9ybWVkICo9IG1vcnBoVGFyZ2V0QmFzZUluZmx1ZW5jZTtcblx0I2lmZGVmIE1PUlBIVEFSR0VUU19URVhUVVJFXG5cdFx0Zm9yICggaW50IGkgPSAwOyBpIDwgTU9SUEhUQVJHRVRTX0NPVU5UOyBpICsrICkge1xuXHRcdFx0aWYgKCBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIGkgXSAhPSAwLjAgKSB0cmFuc2Zvcm1lZCArPSBnZXRNb3JwaCggZ2xfVmVydGV4SUQsIGksIDAgKS54eXogKiBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIGkgXTtcblx0XHR9XG5cdCNlbHNlXG5cdFx0dHJhbnNmb3JtZWQgKz0gbW9ycGhUYXJnZXQwICogbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyAwIF07XG5cdFx0dHJhbnNmb3JtZWQgKz0gbW9ycGhUYXJnZXQxICogbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyAxIF07XG5cdFx0dHJhbnNmb3JtZWQgKz0gbW9ycGhUYXJnZXQyICogbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyAyIF07XG5cdFx0dHJhbnNmb3JtZWQgKz0gbW9ycGhUYXJnZXQzICogbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyAzIF07XG5cdFx0I2lmbmRlZiBVU0VfTU9SUEhOT1JNQUxTXG5cdFx0XHR0cmFuc2Zvcm1lZCArPSBtb3JwaFRhcmdldDQgKiBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIDQgXTtcblx0XHRcdHRyYW5zZm9ybWVkICs9IG1vcnBoVGFyZ2V0NSAqIG1vcnBoVGFyZ2V0SW5mbHVlbmNlc1sgNSBdO1xuXHRcdFx0dHJhbnNmb3JtZWQgKz0gbW9ycGhUYXJnZXQ2ICogbW9ycGhUYXJnZXRJbmZsdWVuY2VzWyA2IF07XG5cdFx0XHR0cmFuc2Zvcm1lZCArPSBtb3JwaFRhcmdldDcgKiBtb3JwaFRhcmdldEluZmx1ZW5jZXNbIDcgXTtcblx0XHQjZW5kaWZcblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIG5vcm1hbF9mcmFnbWVudF9iZWdpbiA9ICJmbG9hdCBmYWNlRGlyZWN0aW9uID0gZ2xfRnJvbnRGYWNpbmcgPyAxLjAgOiAtIDEuMDtcbiNpZmRlZiBGTEFUX1NIQURFRFxuXHR2ZWMzIGZkeCA9IGRGZHgoIHZWaWV3UG9zaXRpb24gKTtcblx0dmVjMyBmZHkgPSBkRmR5KCB2Vmlld1Bvc2l0aW9uICk7XG5cdHZlYzMgbm9ybWFsID0gbm9ybWFsaXplKCBjcm9zcyggZmR4LCBmZHkgKSApO1xuI2Vsc2Vcblx0dmVjMyBub3JtYWwgPSBub3JtYWxpemUoIHZOb3JtYWwgKTtcblx0I2lmZGVmIERPVUJMRV9TSURFRFxuXHRcdG5vcm1hbCAqPSBmYWNlRGlyZWN0aW9uO1xuXHQjZW5kaWZcbiNlbmRpZlxuI2lmIGRlZmluZWQoIFVTRV9OT1JNQUxNQVBfVEFOR0VOVFNQQUNFICkgfHwgZGVmaW5lZCggVVNFX0NMRUFSQ09BVF9OT1JNQUxNQVAgKSB8fCBkZWZpbmVkKCBVU0VfQU5JU09UUk9QWSApXG5cdCNpZmRlZiBVU0VfVEFOR0VOVFxuXHRcdG1hdDMgdGJuID0gbWF0Myggbm9ybWFsaXplKCB2VGFuZ2VudCApLCBub3JtYWxpemUoIHZCaXRhbmdlbnQgKSwgbm9ybWFsICk7XG5cdCNlbHNlXG5cdFx0bWF0MyB0Ym4gPSBnZXRUYW5nZW50RnJhbWUoIC0gdlZpZXdQb3NpdGlvbiwgbm9ybWFsLFxuXHRcdCNpZiBkZWZpbmVkKCBVU0VfTk9STUFMTUFQIClcblx0XHRcdHZOb3JtYWxNYXBVdlxuXHRcdCNlbGlmIGRlZmluZWQoIFVTRV9DTEVBUkNPQVRfTk9STUFMTUFQIClcblx0XHRcdHZDbGVhcmNvYXROb3JtYWxNYXBVdlxuXHRcdCNlbHNlXG5cdFx0XHR2VXZcblx0XHQjZW5kaWZcblx0XHQpO1xuXHQjZW5kaWZcblx0I2lmIGRlZmluZWQoIERPVUJMRV9TSURFRCApICYmICEgZGVmaW5lZCggRkxBVF9TSEFERUQgKVxuXHRcdHRiblswXSAqPSBmYWNlRGlyZWN0aW9uO1xuXHRcdHRiblsxXSAqPSBmYWNlRGlyZWN0aW9uO1xuXHQjZW5kaWZcbiNlbmRpZlxuI2lmZGVmIFVTRV9DTEVBUkNPQVRfTk9STUFMTUFQXG5cdCNpZmRlZiBVU0VfVEFOR0VOVFxuXHRcdG1hdDMgdGJuMiA9IG1hdDMoIG5vcm1hbGl6ZSggdlRhbmdlbnQgKSwgbm9ybWFsaXplKCB2Qml0YW5nZW50ICksIG5vcm1hbCApO1xuXHQjZWxzZVxuXHRcdG1hdDMgdGJuMiA9IGdldFRhbmdlbnRGcmFtZSggLSB2Vmlld1Bvc2l0aW9uLCBub3JtYWwsIHZDbGVhcmNvYXROb3JtYWxNYXBVdiApO1xuXHQjZW5kaWZcblx0I2lmIGRlZmluZWQoIERPVUJMRV9TSURFRCApICYmICEgZGVmaW5lZCggRkxBVF9TSEFERUQgKVxuXHRcdHRibjJbMF0gKj0gZmFjZURpcmVjdGlvbjtcblx0XHR0Ym4yWzFdICo9IGZhY2VEaXJlY3Rpb247XG5cdCNlbmRpZlxuI2VuZGlmXG52ZWMzIG5vblBlcnR1cmJlZE5vcm1hbCA9IG5vcm1hbDsiOwoKdmFyIG5vcm1hbF9mcmFnbWVudF9tYXBzID0gIiNpZmRlZiBVU0VfTk9STUFMTUFQX09CSkVDVFNQQUNFXG5cdG5vcm1hbCA9IHRleHR1cmUyRCggbm9ybWFsTWFwLCB2Tm9ybWFsTWFwVXYgKS54eXogKiAyLjAgLSAxLjA7XG5cdCNpZmRlZiBGTElQX1NJREVEXG5cdFx0bm9ybWFsID0gLSBub3JtYWw7XG5cdCNlbmRpZlxuXHQjaWZkZWYgRE9VQkxFX1NJREVEXG5cdFx0bm9ybWFsID0gbm9ybWFsICogZmFjZURpcmVjdGlvbjtcblx0I2VuZGlmXG5cdG5vcm1hbCA9IG5vcm1hbGl6ZSggbm9ybWFsTWF0cml4ICogbm9ybWFsICk7XG4jZWxpZiBkZWZpbmVkKCBVU0VfTk9STUFMTUFQX1RBTkdFTlRTUEFDRSApXG5cdHZlYzMgbWFwTiA9IHRleHR1cmUyRCggbm9ybWFsTWFwLCB2Tm9ybWFsTWFwVXYgKS54eXogKiAyLjAgLSAxLjA7XG5cdG1hcE4ueHkgKj0gbm9ybWFsU2NhbGU7XG5cdG5vcm1hbCA9IG5vcm1hbGl6ZSggdGJuICogbWFwTiApO1xuI2VsaWYgZGVmaW5lZCggVVNFX0JVTVBNQVAgKVxuXHRub3JtYWwgPSBwZXJ0dXJiTm9ybWFsQXJiKCAtIHZWaWV3UG9zaXRpb24sIG5vcm1hbCwgZEhkeHlfZndkKCksIGZhY2VEaXJlY3Rpb24gKTtcbiNlbmRpZiI7Cgp2YXIgbm9ybWFsX3BhcnNfZnJhZ21lbnQgPSAiI2lmbmRlZiBGTEFUX1NIQURFRFxuXHR2YXJ5aW5nIHZlYzMgdk5vcm1hbDtcblx0I2lmZGVmIFVTRV9UQU5HRU5UXG5cdFx0dmFyeWluZyB2ZWMzIHZUYW5nZW50O1xuXHRcdHZhcnlpbmcgdmVjMyB2Qml0YW5nZW50O1xuXHQjZW5kaWZcbiNlbmRpZiI7Cgp2YXIgbm9ybWFsX3BhcnNfdmVydGV4ID0gIiNpZm5kZWYgRkxBVF9TSEFERURcblx0dmFyeWluZyB2ZWMzIHZOb3JtYWw7XG5cdCNpZmRlZiBVU0VfVEFOR0VOVFxuXHRcdHZhcnlpbmcgdmVjMyB2VGFuZ2VudDtcblx0XHR2YXJ5aW5nIHZlYzMgdkJpdGFuZ2VudDtcblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIG5vcm1hbF92ZXJ0ZXggPSAiI2lmbmRlZiBGTEFUX1NIQURFRFxuXHR2Tm9ybWFsID0gbm9ybWFsaXplKCB0cmFuc2Zvcm1lZE5vcm1hbCApO1xuXHQjaWZkZWYgVVNFX1RBTkdFTlRcblx0XHR2VGFuZ2VudCA9IG5vcm1hbGl6ZSggdHJhbnNmb3JtZWRUYW5nZW50ICk7XG5cdFx0dkJpdGFuZ2VudCA9IG5vcm1hbGl6ZSggY3Jvc3MoIHZOb3JtYWwsIHZUYW5nZW50ICkgKiB0YW5nZW50LncgKTtcblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIG5vcm1hbG1hcF9wYXJzX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfTk9STUFMTUFQXG5cdHVuaWZvcm0gc2FtcGxlcjJEIG5vcm1hbE1hcDtcblx0dW5pZm9ybSB2ZWMyIG5vcm1hbFNjYWxlO1xuI2VuZGlmXG4jaWZkZWYgVVNFX05PUk1BTE1BUF9PQkpFQ1RTUEFDRVxuXHR1bmlmb3JtIG1hdDMgbm9ybWFsTWF0cml4O1xuI2VuZGlmXG4jaWYgISBkZWZpbmVkICggVVNFX1RBTkdFTlQgKSAmJiAoIGRlZmluZWQgKCBVU0VfTk9STUFMTUFQX1RBTkdFTlRTUEFDRSApIHx8IGRlZmluZWQgKCBVU0VfQ0xFQVJDT0FUX05PUk1BTE1BUCApIHx8IGRlZmluZWQoIFVTRV9BTklTT1RST1BZICkgKVxuXHRtYXQzIGdldFRhbmdlbnRGcmFtZSggdmVjMyBleWVfcG9zLCB2ZWMzIHN1cmZfbm9ybSwgdmVjMiB1diApIHtcblx0XHR2ZWMzIHEwID0gZEZkeCggZXllX3Bvcy54eXogKTtcblx0XHR2ZWMzIHExID0gZEZkeSggZXllX3Bvcy54eXogKTtcblx0XHR2ZWMyIHN0MCA9IGRGZHgoIHV2LnN0ICk7XG5cdFx0dmVjMiBzdDEgPSBkRmR5KCB1di5zdCApO1xuXHRcdHZlYzMgTiA9IHN1cmZfbm9ybTtcblx0XHR2ZWMzIHExcGVycCA9IGNyb3NzKCBxMSwgTiApO1xuXHRcdHZlYzMgcTBwZXJwID0gY3Jvc3MoIE4sIHEwICk7XG5cdFx0dmVjMyBUID0gcTFwZXJwICogc3QwLnggKyBxMHBlcnAgKiBzdDEueDtcblx0XHR2ZWMzIEIgPSBxMXBlcnAgKiBzdDAueSArIHEwcGVycCAqIHN0MS55O1xuXHRcdGZsb2F0IGRldCA9IG1heCggZG90KCBULCBUICksIGRvdCggQiwgQiApICk7XG5cdFx0ZmxvYXQgc2NhbGUgPSAoIGRldCA9PSAwLjAgKSA/IDAuMCA6IGludmVyc2VzcXJ0KCBkZXQgKTtcblx0XHRyZXR1cm4gbWF0MyggVCAqIHNjYWxlLCBCICogc2NhbGUsIE4gKTtcblx0fVxuI2VuZGlmIjsKCnZhciBjbGVhcmNvYXRfbm9ybWFsX2ZyYWdtZW50X2JlZ2luID0gIiNpZmRlZiBVU0VfQ0xFQVJDT0FUXG5cdHZlYzMgY2xlYXJjb2F0Tm9ybWFsID0gbm9uUGVydHVyYmVkTm9ybWFsO1xuI2VuZGlmIjsKCnZhciBjbGVhcmNvYXRfbm9ybWFsX2ZyYWdtZW50X21hcHMgPSAiI2lmZGVmIFVTRV9DTEVBUkNPQVRfTk9STUFMTUFQXG5cdHZlYzMgY2xlYXJjb2F0TWFwTiA9IHRleHR1cmUyRCggY2xlYXJjb2F0Tm9ybWFsTWFwLCB2Q2xlYXJjb2F0Tm9ybWFsTWFwVXYgKS54eXogKiAyLjAgLSAxLjA7XG5cdGNsZWFyY29hdE1hcE4ueHkgKj0gY2xlYXJjb2F0Tm9ybWFsU2NhbGU7XG5cdGNsZWFyY29hdE5vcm1hbCA9IG5vcm1hbGl6ZSggdGJuMiAqIGNsZWFyY29hdE1hcE4gKTtcbiNlbmRpZiI7Cgp2YXIgY2xlYXJjb2F0X3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9DTEVBUkNPQVRNQVBcblx0dW5pZm9ybSBzYW1wbGVyMkQgY2xlYXJjb2F0TWFwO1xuI2VuZGlmXG4jaWZkZWYgVVNFX0NMRUFSQ09BVF9OT1JNQUxNQVBcblx0dW5pZm9ybSBzYW1wbGVyMkQgY2xlYXJjb2F0Tm9ybWFsTWFwO1xuXHR1bmlmb3JtIHZlYzIgY2xlYXJjb2F0Tm9ybWFsU2NhbGU7XG4jZW5kaWZcbiNpZmRlZiBVU0VfQ0xFQVJDT0FUX1JPVUdITkVTU01BUFxuXHR1bmlmb3JtIHNhbXBsZXIyRCBjbGVhcmNvYXRSb3VnaG5lc3NNYXA7XG4jZW5kaWYiOwoKdmFyIGlyaWRlc2NlbmNlX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9JUklERVNDRU5DRU1BUFxuXHR1bmlmb3JtIHNhbXBsZXIyRCBpcmlkZXNjZW5jZU1hcDtcbiNlbmRpZlxuI2lmZGVmIFVTRV9JUklERVNDRU5DRV9USElDS05FU1NNQVBcblx0dW5pZm9ybSBzYW1wbGVyMkQgaXJpZGVzY2VuY2VUaGlja25lc3NNYXA7XG4jZW5kaWYiOwoKdmFyIG9wYXF1ZV9mcmFnbWVudCA9ICIjaWZkZWYgT1BBUVVFXG5kaWZmdXNlQ29sb3IuYSA9IDEuMDtcbiNlbmRpZlxuI2lmZGVmIFVTRV9UUkFOU01JU1NJT05cbmRpZmZ1c2VDb2xvci5hICo9IG1hdGVyaWFsLnRyYW5zbWlzc2lvbkFscGhhO1xuI2VuZGlmXG5nbF9GcmFnQ29sb3IgPSB2ZWM0KCBvdXRnb2luZ0xpZ2h0LCBkaWZmdXNlQ29sb3IuYSApOyI7Cgp2YXIgcGFja2luZyA9ICJ2ZWMzIHBhY2tOb3JtYWxUb1JHQiggY29uc3QgaW4gdmVjMyBub3JtYWwgKSB7XG5cdHJldHVybiBub3JtYWxpemUoIG5vcm1hbCApICogMC41ICsgMC41O1xufVxudmVjMyB1bnBhY2tSR0JUb05vcm1hbCggY29uc3QgaW4gdmVjMyByZ2IgKSB7XG5cdHJldHVybiAyLjAgKiByZ2IueHl6IC0gMS4wO1xufVxuY29uc3QgZmxvYXQgUGFja1Vwc2NhbGUgPSAyNTYuIC8gMjU1Ljtjb25zdCBmbG9hdCBVbnBhY2tEb3duc2NhbGUgPSAyNTUuIC8gMjU2LjtcbmNvbnN0IHZlYzMgUGFja0ZhY3RvcnMgPSB2ZWMzKCAyNTYuICogMjU2LiAqIDI1Ni4sIDI1Ni4gKiAyNTYuLCAyNTYuICk7XG5jb25zdCB2ZWM0IFVucGFja0ZhY3RvcnMgPSBVbnBhY2tEb3duc2NhbGUgLyB2ZWM0KCBQYWNrRmFjdG9ycywgMS4gKTtcbmNvbnN0IGZsb2F0IFNoaWZ0UmlnaHQ4ID0gMS4gLyAyNTYuO1xudmVjNCBwYWNrRGVwdGhUb1JHQkEoIGNvbnN0IGluIGZsb2F0IHYgKSB7XG5cdHZlYzQgciA9IHZlYzQoIGZyYWN0KCB2ICogUGFja0ZhY3RvcnMgKSwgdiApO1xuXHRyLnl6dyAtPSByLnh5eiAqIFNoaWZ0UmlnaHQ4O1x0cmV0dXJuIHIgKiBQYWNrVXBzY2FsZTtcbn1cbmZsb2F0IHVucGFja1JHQkFUb0RlcHRoKCBjb25zdCBpbiB2ZWM0IHYgKSB7XG5cdHJldHVybiBkb3QoIHYsIFVucGFja0ZhY3RvcnMgKTtcbn1cbnZlYzIgcGFja0RlcHRoVG9SRyggaW4gaGlnaHAgZmxvYXQgdiApIHtcblx0cmV0dXJuIHBhY2tEZXB0aFRvUkdCQSggdiApLnl4O1xufVxuZmxvYXQgdW5wYWNrUkdUb0RlcHRoKCBjb25zdCBpbiBoaWdocCB2ZWMyIHYgKSB7XG5cdHJldHVybiB1bnBhY2tSR0JBVG9EZXB0aCggdmVjNCggdi54eSwgMC4wLCAwLjAgKSApO1xufVxudmVjNCBwYWNrMkhhbGZUb1JHQkEoIHZlYzIgdiApIHtcblx0dmVjNCByID0gdmVjNCggdi54LCBmcmFjdCggdi54ICogMjU1LjAgKSwgdi55LCBmcmFjdCggdi55ICogMjU1LjAgKSApO1xuXHRyZXR1cm4gdmVjNCggci54IC0gci55IC8gMjU1LjAsIHIueSwgci56IC0gci53IC8gMjU1LjAsIHIudyApO1xufVxudmVjMiB1bnBhY2tSR0JBVG8ySGFsZiggdmVjNCB2ICkge1xuXHRyZXR1cm4gdmVjMiggdi54ICsgKCB2LnkgLyAyNTUuMCApLCB2LnogKyAoIHYudyAvIDI1NS4wICkgKTtcbn1cbmZsb2F0IHZpZXdaVG9PcnRob2dyYXBoaWNEZXB0aCggY29uc3QgaW4gZmxvYXQgdmlld1osIGNvbnN0IGluIGZsb2F0IG5lYXIsIGNvbnN0IGluIGZsb2F0IGZhciApIHtcblx0cmV0dXJuICggdmlld1ogKyBuZWFyICkgLyAoIG5lYXIgLSBmYXIgKTtcbn1cbmZsb2F0IG9ydGhvZ3JhcGhpY0RlcHRoVG9WaWV3WiggY29uc3QgaW4gZmxvYXQgZGVwdGgsIGNvbnN0IGluIGZsb2F0IG5lYXIsIGNvbnN0IGluIGZsb2F0IGZhciApIHtcblx0cmV0dXJuIGRlcHRoICogKCBuZWFyIC0gZmFyICkgLSBuZWFyO1xufVxuZmxvYXQgdmlld1pUb1BlcnNwZWN0aXZlRGVwdGgoIGNvbnN0IGluIGZsb2F0IHZpZXdaLCBjb25zdCBpbiBmbG9hdCBuZWFyLCBjb25zdCBpbiBmbG9hdCBmYXIgKSB7XG5cdHJldHVybiAoICggbmVhciArIHZpZXdaICkgKiBmYXIgKSAvICggKCBmYXIgLSBuZWFyICkgKiB2aWV3WiApO1xufVxuZmxvYXQgcGVyc3BlY3RpdmVEZXB0aFRvVmlld1ooIGNvbnN0IGluIGZsb2F0IGRlcHRoLCBjb25zdCBpbiBmbG9hdCBuZWFyLCBjb25zdCBpbiBmbG9hdCBmYXIgKSB7XG5cdHJldHVybiAoIG5lYXIgKiBmYXIgKSAvICggKCBmYXIgLSBuZWFyICkgKiBkZXB0aCAtIGZhciApO1xufSI7Cgp2YXIgcHJlbXVsdGlwbGllZF9hbHBoYV9mcmFnbWVudCA9ICIjaWZkZWYgUFJFTVVMVElQTElFRF9BTFBIQVxuXHRnbF9GcmFnQ29sb3IucmdiICo9IGdsX0ZyYWdDb2xvci5hO1xuI2VuZGlmIjsKCnZhciBwcm9qZWN0X3ZlcnRleCA9ICJ2ZWM0IG12UG9zaXRpb24gPSB2ZWM0KCB0cmFuc2Zvcm1lZCwgMS4wICk7XG4jaWZkZWYgVVNFX0JBVENISU5HXG5cdG12UG9zaXRpb24gPSBiYXRjaGluZ01hdHJpeCAqIG12UG9zaXRpb247XG4jZW5kaWZcbiNpZmRlZiBVU0VfSU5TVEFOQ0lOR1xuXHRtdlBvc2l0aW9uID0gaW5zdGFuY2VNYXRyaXggKiBtdlBvc2l0aW9uO1xuI2VuZGlmXG5tdlBvc2l0aW9uID0gbW9kZWxWaWV3TWF0cml4ICogbXZQb3NpdGlvbjtcbmdsX1Bvc2l0aW9uID0gcHJvamVjdGlvbk1hdHJpeCAqIG12UG9zaXRpb247IjsKCnZhciBkaXRoZXJpbmdfZnJhZ21lbnQgPSAiI2lmZGVmIERJVEhFUklOR1xuXHRnbF9GcmFnQ29sb3IucmdiID0gZGl0aGVyaW5nKCBnbF9GcmFnQ29sb3IucmdiICk7XG4jZW5kaWYiOwoKdmFyIGRpdGhlcmluZ19wYXJzX2ZyYWdtZW50ID0gIiNpZmRlZiBESVRIRVJJTkdcblx0dmVjMyBkaXRoZXJpbmcoIHZlYzMgY29sb3IgKSB7XG5cdFx0ZmxvYXQgZ3JpZF9wb3NpdGlvbiA9IHJhbmQoIGdsX0ZyYWdDb29yZC54eSApO1xuXHRcdHZlYzMgZGl0aGVyX3NoaWZ0X1JHQiA9IHZlYzMoIDAuMjUgLyAyNTUuMCwgLTAuMjUgLyAyNTUuMCwgMC4yNSAvIDI1NS4wICk7XG5cdFx0ZGl0aGVyX3NoaWZ0X1JHQiA9IG1peCggMi4wICogZGl0aGVyX3NoaWZ0X1JHQiwgLTIuMCAqIGRpdGhlcl9zaGlmdF9SR0IsIGdyaWRfcG9zaXRpb24gKTtcblx0XHRyZXR1cm4gY29sb3IgKyBkaXRoZXJfc2hpZnRfUkdCO1xuXHR9XG4jZW5kaWYiOwoKdmFyIHJvdWdobmVzc21hcF9mcmFnbWVudCA9ICJmbG9hdCByb3VnaG5lc3NGYWN0b3IgPSByb3VnaG5lc3M7XG4jaWZkZWYgVVNFX1JPVUdITkVTU01BUFxuXHR2ZWM0IHRleGVsUm91Z2huZXNzID0gdGV4dHVyZTJEKCByb3VnaG5lc3NNYXAsIHZSb3VnaG5lc3NNYXBVdiApO1xuXHRyb3VnaG5lc3NGYWN0b3IgKj0gdGV4ZWxSb3VnaG5lc3MuZztcbiNlbmRpZiI7Cgp2YXIgcm91Z2huZXNzbWFwX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9ST1VHSE5FU1NNQVBcblx0dW5pZm9ybSBzYW1wbGVyMkQgcm91Z2huZXNzTWFwO1xuI2VuZGlmIjsKCnZhciBzaGFkb3dtYXBfcGFyc19mcmFnbWVudCA9ICIjaWYgTlVNX1NQT1RfTElHSFRfQ09PUkRTID4gMFxuXHR2YXJ5aW5nIHZlYzQgdlNwb3RMaWdodENvb3JkWyBOVU1fU1BPVF9MSUdIVF9DT09SRFMgXTtcbiNlbmRpZlxuI2lmIE5VTV9TUE9UX0xJR0hUX01BUFMgPiAwXG5cdHVuaWZvcm0gc2FtcGxlcjJEIHNwb3RMaWdodE1hcFsgTlVNX1NQT1RfTElHSFRfTUFQUyBdO1xuI2VuZGlmXG4jaWZkZWYgVVNFX1NIQURPV01BUFxuXHQjaWYgTlVNX0RJUl9MSUdIVF9TSEFET1dTID4gMFxuXHRcdHVuaWZvcm0gc2FtcGxlcjJEIGRpcmVjdGlvbmFsU2hhZG93TWFwWyBOVU1fRElSX0xJR0hUX1NIQURPV1MgXTtcblx0XHR2YXJ5aW5nIHZlYzQgdkRpcmVjdGlvbmFsU2hhZG93Q29vcmRbIE5VTV9ESVJfTElHSFRfU0hBRE9XUyBdO1xuXHRcdHN0cnVjdCBEaXJlY3Rpb25hbExpZ2h0U2hhZG93IHtcblx0XHRcdGZsb2F0IHNoYWRvd0JpYXM7XG5cdFx0XHRmbG9hdCBzaGFkb3dOb3JtYWxCaWFzO1xuXHRcdFx0ZmxvYXQgc2hhZG93UmFkaXVzO1xuXHRcdFx0dmVjMiBzaGFkb3dNYXBTaXplO1xuXHRcdH07XG5cdFx0dW5pZm9ybSBEaXJlY3Rpb25hbExpZ2h0U2hhZG93IGRpcmVjdGlvbmFsTGlnaHRTaGFkb3dzWyBOVU1fRElSX0xJR0hUX1NIQURPV1MgXTtcblx0I2VuZGlmXG5cdCNpZiBOVU1fU1BPVF9MSUdIVF9TSEFET1dTID4gMFxuXHRcdHVuaWZvcm0gc2FtcGxlcjJEIHNwb3RTaGFkb3dNYXBbIE5VTV9TUE9UX0xJR0hUX1NIQURPV1MgXTtcblx0XHRzdHJ1Y3QgU3BvdExpZ2h0U2hhZG93IHtcblx0XHRcdGZsb2F0IHNoYWRvd0JpYXM7XG5cdFx0XHRmbG9hdCBzaGFkb3dOb3JtYWxCaWFzO1xuXHRcdFx0ZmxvYXQgc2hhZG93UmFkaXVzO1xuXHRcdFx0dmVjMiBzaGFkb3dNYXBTaXplO1xuXHRcdH07XG5cdFx0dW5pZm9ybSBTcG90TGlnaHRTaGFkb3cgc3BvdExpZ2h0U2hhZG93c1sgTlVNX1NQT1RfTElHSFRfU0hBRE9XUyBdO1xuXHQjZW5kaWZcblx0I2lmIE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTID4gMFxuXHRcdHVuaWZvcm0gc2FtcGxlcjJEIHBvaW50U2hhZG93TWFwWyBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyBdO1xuXHRcdHZhcnlpbmcgdmVjNCB2UG9pbnRTaGFkb3dDb29yZFsgTlVNX1BPSU5UX0xJR0hUX1NIQURPV1MgXTtcblx0XHRzdHJ1Y3QgUG9pbnRMaWdodFNoYWRvdyB7XG5cdFx0XHRmbG9hdCBzaGFkb3dCaWFzO1xuXHRcdFx0ZmxvYXQgc2hhZG93Tm9ybWFsQmlhcztcblx0XHRcdGZsb2F0IHNoYWRvd1JhZGl1cztcblx0XHRcdHZlYzIgc2hhZG93TWFwU2l6ZTtcblx0XHRcdGZsb2F0IHNoYWRvd0NhbWVyYU5lYXI7XG5cdFx0XHRmbG9hdCBzaGFkb3dDYW1lcmFGYXI7XG5cdFx0fTtcblx0XHR1bmlmb3JtIFBvaW50TGlnaHRTaGFkb3cgcG9pbnRMaWdodFNoYWRvd3NbIE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTIF07XG5cdCNlbmRpZlxuXHRmbG9hdCB0ZXh0dXJlMkRDb21wYXJlKCBzYW1wbGVyMkQgZGVwdGhzLCB2ZWMyIHV2LCBmbG9hdCBjb21wYXJlICkge1xuXHRcdHJldHVybiBzdGVwKCBjb21wYXJlLCB1bnBhY2tSR0JBVG9EZXB0aCggdGV4dHVyZTJEKCBkZXB0aHMsIHV2ICkgKSApO1xuXHR9XG5cdHZlYzIgdGV4dHVyZTJERGlzdHJpYnV0aW9uKCBzYW1wbGVyMkQgc2hhZG93LCB2ZWMyIHV2ICkge1xuXHRcdHJldHVybiB1bnBhY2tSR0JBVG8ySGFsZiggdGV4dHVyZTJEKCBzaGFkb3csIHV2ICkgKTtcblx0fVxuXHRmbG9hdCBWU01TaGFkb3cgKHNhbXBsZXIyRCBzaGFkb3csIHZlYzIgdXYsIGZsb2F0IGNvbXBhcmUgKXtcblx0XHRmbG9hdCBvY2NsdXNpb24gPSAxLjA7XG5cdFx0dmVjMiBkaXN0cmlidXRpb24gPSB0ZXh0dXJlMkREaXN0cmlidXRpb24oIHNoYWRvdywgdXYgKTtcblx0XHRmbG9hdCBoYXJkX3NoYWRvdyA9IHN0ZXAoIGNvbXBhcmUgLCBkaXN0cmlidXRpb24ueCApO1xuXHRcdGlmIChoYXJkX3NoYWRvdyAhPSAxLjAgKSB7XG5cdFx0XHRmbG9hdCBkaXN0YW5jZSA9IGNvbXBhcmUgLSBkaXN0cmlidXRpb24ueCA7XG5cdFx0XHRmbG9hdCB2YXJpYW5jZSA9IG1heCggMC4wMDAwMCwgZGlzdHJpYnV0aW9uLnkgKiBkaXN0cmlidXRpb24ueSApO1xuXHRcdFx0ZmxvYXQgc29mdG5lc3NfcHJvYmFiaWxpdHkgPSB2YXJpYW5jZSAvICh2YXJpYW5jZSArIGRpc3RhbmNlICogZGlzdGFuY2UgKTtcdFx0XHRzb2Z0bmVzc19wcm9iYWJpbGl0eSA9IGNsYW1wKCAoIHNvZnRuZXNzX3Byb2JhYmlsaXR5IC0gMC4zICkgLyAoIDAuOTUgLSAwLjMgKSwgMC4wLCAxLjAgKTtcdFx0XHRvY2NsdXNpb24gPSBjbGFtcCggbWF4KCBoYXJkX3NoYWRvdywgc29mdG5lc3NfcHJvYmFiaWxpdHkgKSwgMC4wLCAxLjAgKTtcblx0XHR9XG5cdFx0cmV0dXJuIG9jY2x1c2lvbjtcblx0fVxuXHRmbG9hdCBnZXRTaGFkb3coIHNhbXBsZXIyRCBzaGFkb3dNYXAsIHZlYzIgc2hhZG93TWFwU2l6ZSwgZmxvYXQgc2hhZG93QmlhcywgZmxvYXQgc2hhZG93UmFkaXVzLCB2ZWM0IHNoYWRvd0Nvb3JkICkge1xuXHRcdGZsb2F0IHNoYWRvdyA9IDEuMDtcblx0XHRzaGFkb3dDb29yZC54eXogLz0gc2hhZG93Q29vcmQudztcblx0XHRzaGFkb3dDb29yZC56ICs9IHNoYWRvd0JpYXM7XG5cdFx0Ym9vbCBpbkZydXN0dW0gPSBzaGFkb3dDb29yZC54ID49IDAuMCAmJiBzaGFkb3dDb29yZC54IDw9IDEuMCAmJiBzaGFkb3dDb29yZC55ID49IDAuMCAmJiBzaGFkb3dDb29yZC55IDw9IDEuMDtcblx0XHRib29sIGZydXN0dW1UZXN0ID0gaW5GcnVzdHVtICYmIHNoYWRvd0Nvb3JkLnogPD0gMS4wO1xuXHRcdGlmICggZnJ1c3R1bVRlc3QgKSB7XG5cdFx0I2lmIGRlZmluZWQoIFNIQURPV01BUF9UWVBFX1BDRiApXG5cdFx0XHR2ZWMyIHRleGVsU2l6ZSA9IHZlYzIoIDEuMCApIC8gc2hhZG93TWFwU2l6ZTtcblx0XHRcdGZsb2F0IGR4MCA9IC0gdGV4ZWxTaXplLnggKiBzaGFkb3dSYWRpdXM7XG5cdFx0XHRmbG9hdCBkeTAgPSAtIHRleGVsU2l6ZS55ICogc2hhZG93UmFkaXVzO1xuXHRcdFx0ZmxvYXQgZHgxID0gKyB0ZXhlbFNpemUueCAqIHNoYWRvd1JhZGl1cztcblx0XHRcdGZsb2F0IGR5MSA9ICsgdGV4ZWxTaXplLnkgKiBzaGFkb3dSYWRpdXM7XG5cdFx0XHRmbG9hdCBkeDIgPSBkeDAgLyAyLjA7XG5cdFx0XHRmbG9hdCBkeTIgPSBkeTAgLyAyLjA7XG5cdFx0XHRmbG9hdCBkeDMgPSBkeDEgLyAyLjA7XG5cdFx0XHRmbG9hdCBkeTMgPSBkeTEgLyAyLjA7XG5cdFx0XHRzaGFkb3cgPSAoXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCBkeDAsIGR5MCApLCBzaGFkb3dDb29yZC56ICkgK1xuXHRcdFx0XHR0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggMC4wLCBkeTAgKSwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIGR4MSwgZHkwICksIHNoYWRvd0Nvb3JkLnogKSArXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCBkeDIsIGR5MiApLCBzaGFkb3dDb29yZC56ICkgK1xuXHRcdFx0XHR0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggMC4wLCBkeTIgKSwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIGR4MywgZHkyICksIHNoYWRvd0Nvb3JkLnogKSArXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCBkeDAsIDAuMCApLCBzaGFkb3dDb29yZC56ICkgK1xuXHRcdFx0XHR0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggZHgyLCAwLjAgKSwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIGR4MywgMC4wICksIHNoYWRvd0Nvb3JkLnogKSArXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCBkeDEsIDAuMCApLCBzaGFkb3dDb29yZC56ICkgK1xuXHRcdFx0XHR0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggZHgyLCBkeTMgKSwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIDAuMCwgZHkzICksIHNoYWRvd0Nvb3JkLnogKSArXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCBkeDMsIGR5MyApLCBzaGFkb3dDb29yZC56ICkgK1xuXHRcdFx0XHR0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHNoYWRvd0Nvb3JkLnh5ICsgdmVjMiggZHgwLCBkeTEgKSwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSArIHZlYzIoIDAuMCwgZHkxICksIHNoYWRvd0Nvb3JkLnogKSArXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHkgKyB2ZWMyKCBkeDEsIGR5MSApLCBzaGFkb3dDb29yZC56IClcblx0XHRcdCkgKiAoIDEuMCAvIDE3LjAgKTtcblx0XHQjZWxpZiBkZWZpbmVkKCBTSEFET1dNQVBfVFlQRV9QQ0ZfU09GVCApXG5cdFx0XHR2ZWMyIHRleGVsU2l6ZSA9IHZlYzIoIDEuMCApIC8gc2hhZG93TWFwU2l6ZTtcblx0XHRcdGZsb2F0IGR4ID0gdGV4ZWxTaXplLng7XG5cdFx0XHRmbG9hdCBkeSA9IHRleGVsU2l6ZS55O1xuXHRcdFx0dmVjMiB1diA9IHNoYWRvd0Nvb3JkLnh5O1xuXHRcdFx0dmVjMiBmID0gZnJhY3QoIHV2ICogc2hhZG93TWFwU2l6ZSArIDAuNSApO1xuXHRcdFx0dXYgLT0gZiAqIHRleGVsU2l6ZTtcblx0XHRcdHNoYWRvdyA9IChcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIGR4LCAwLjAgKSwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIDAuMCwgZHkgKSwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHRleGVsU2l6ZSwgc2hhZG93Q29vcmQueiApICtcblx0XHRcdFx0bWl4KCB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHV2ICsgdmVjMiggLWR4LCAwLjAgKSwgc2hhZG93Q29vcmQueiApLFxuXHRcdFx0XHRcdCB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHV2ICsgdmVjMiggMi4wICogZHgsIDAuMCApLCBzaGFkb3dDb29yZC56ICksXG5cdFx0XHRcdFx0IGYueCApICtcblx0XHRcdFx0bWl4KCB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHV2ICsgdmVjMiggLWR4LCBkeSApLCBzaGFkb3dDb29yZC56ICksXG5cdFx0XHRcdFx0IHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB2ZWMyKCAyLjAgKiBkeCwgZHkgKSwgc2hhZG93Q29vcmQueiApLFxuXHRcdFx0XHRcdCBmLnggKSArXG5cdFx0XHRcdG1peCggdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIDAuMCwgLWR5ICksIHNoYWRvd0Nvb3JkLnogKSxcblx0XHRcdFx0XHQgdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIDAuMCwgMi4wICogZHkgKSwgc2hhZG93Q29vcmQueiApLFxuXHRcdFx0XHRcdCBmLnkgKSArXG5cdFx0XHRcdG1peCggdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIGR4LCAtZHkgKSwgc2hhZG93Q29vcmQueiApLFxuXHRcdFx0XHRcdCB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHV2ICsgdmVjMiggZHgsIDIuMCAqIGR5ICksIHNoYWRvd0Nvb3JkLnogKSxcblx0XHRcdFx0XHQgZi55ICkgK1xuXHRcdFx0XHRtaXgoIG1peCggdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIC1keCwgLWR5ICksIHNoYWRvd0Nvb3JkLnogKSxcblx0XHRcdFx0XHRcdCAgdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCB1diArIHZlYzIoIDIuMCAqIGR4LCAtZHkgKSwgc2hhZG93Q29vcmQueiApLFxuXHRcdFx0XHRcdFx0ICBmLnggKSxcblx0XHRcdFx0XHQgbWl4KCB0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIHV2ICsgdmVjMiggLWR4LCAyLjAgKiBkeSApLCBzaGFkb3dDb29yZC56ICksXG5cdFx0XHRcdFx0XHQgIHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgdXYgKyB2ZWMyKCAyLjAgKiBkeCwgMi4wICogZHkgKSwgc2hhZG93Q29vcmQueiApLFxuXHRcdFx0XHRcdFx0ICBmLnggKSxcblx0XHRcdFx0XHQgZi55IClcblx0XHRcdCkgKiAoIDEuMCAvIDkuMCApO1xuXHRcdCNlbGlmIGRlZmluZWQoIFNIQURPV01BUF9UWVBFX1ZTTSApXG5cdFx0XHRzaGFkb3cgPSBWU01TaGFkb3coIHNoYWRvd01hcCwgc2hhZG93Q29vcmQueHksIHNoYWRvd0Nvb3JkLnogKTtcblx0XHQjZWxzZVxuXHRcdFx0c2hhZG93ID0gdGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBzaGFkb3dDb29yZC54eSwgc2hhZG93Q29vcmQueiApO1xuXHRcdCNlbmRpZlxuXHRcdH1cblx0XHRyZXR1cm4gc2hhZG93O1xuXHR9XG5cdHZlYzIgY3ViZVRvVVYoIHZlYzMgdiwgZmxvYXQgdGV4ZWxTaXplWSApIHtcblx0XHR2ZWMzIGFic1YgPSBhYnMoIHYgKTtcblx0XHRmbG9hdCBzY2FsZVRvQ3ViZSA9IDEuMCAvIG1heCggYWJzVi54LCBtYXgoIGFic1YueSwgYWJzVi56ICkgKTtcblx0XHRhYnNWICo9IHNjYWxlVG9DdWJlO1xuXHRcdHYgKj0gc2NhbGVUb0N1YmUgKiAoIDEuMCAtIDIuMCAqIHRleGVsU2l6ZVkgKTtcblx0XHR2ZWMyIHBsYW5hciA9IHYueHk7XG5cdFx0ZmxvYXQgYWxtb3N0QVRleGVsID0gMS41ICogdGV4ZWxTaXplWTtcblx0XHRmbG9hdCBhbG1vc3RPbmUgPSAxLjAgLSBhbG1vc3RBVGV4ZWw7XG5cdFx0aWYgKCBhYnNWLnogPj0gYWxtb3N0T25lICkge1xuXHRcdFx0aWYgKCB2LnogPiAwLjAgKVxuXHRcdFx0XHRwbGFuYXIueCA9IDQuMCAtIHYueDtcblx0XHR9IGVsc2UgaWYgKCBhYnNWLnggPj0gYWxtb3N0T25lICkge1xuXHRcdFx0ZmxvYXQgc2lnblggPSBzaWduKCB2LnggKTtcblx0XHRcdHBsYW5hci54ID0gdi56ICogc2lnblggKyAyLjAgKiBzaWduWDtcblx0XHR9IGVsc2UgaWYgKCBhYnNWLnkgPj0gYWxtb3N0T25lICkge1xuXHRcdFx0ZmxvYXQgc2lnblkgPSBzaWduKCB2LnkgKTtcblx0XHRcdHBsYW5hci54ID0gdi54ICsgMi4wICogc2lnblkgKyAyLjA7XG5cdFx0XHRwbGFuYXIueSA9IHYueiAqIHNpZ25ZIC0gMi4wO1xuXHRcdH1cblx0XHRyZXR1cm4gdmVjMiggMC4xMjUsIDAuMjUgKSAqIHBsYW5hciArIHZlYzIoIDAuMzc1LCAwLjc1ICk7XG5cdH1cblx0ZmxvYXQgZ2V0UG9pbnRTaGFkb3coIHNhbXBsZXIyRCBzaGFkb3dNYXAsIHZlYzIgc2hhZG93TWFwU2l6ZSwgZmxvYXQgc2hhZG93QmlhcywgZmxvYXQgc2hhZG93UmFkaXVzLCB2ZWM0IHNoYWRvd0Nvb3JkLCBmbG9hdCBzaGFkb3dDYW1lcmFOZWFyLCBmbG9hdCBzaGFkb3dDYW1lcmFGYXIgKSB7XG5cdFx0dmVjMiB0ZXhlbFNpemUgPSB2ZWMyKCAxLjAgKSAvICggc2hhZG93TWFwU2l6ZSAqIHZlYzIoIDQuMCwgMi4wICkgKTtcblx0XHR2ZWMzIGxpZ2h0VG9Qb3NpdGlvbiA9IHNoYWRvd0Nvb3JkLnh5ejtcblx0XHRmbG9hdCBkcCA9ICggbGVuZ3RoKCBsaWdodFRvUG9zaXRpb24gKSAtIHNoYWRvd0NhbWVyYU5lYXIgKSAvICggc2hhZG93Q2FtZXJhRmFyIC0gc2hhZG93Q2FtZXJhTmVhciApO1x0XHRkcCArPSBzaGFkb3dCaWFzO1xuXHRcdHZlYzMgYmQzRCA9IG5vcm1hbGl6ZSggbGlnaHRUb1Bvc2l0aW9uICk7XG5cdFx0I2lmIGRlZmluZWQoIFNIQURPV01BUF9UWVBFX1BDRiApIHx8IGRlZmluZWQoIFNIQURPV01BUF9UWVBFX1BDRl9TT0ZUICkgfHwgZGVmaW5lZCggU0hBRE9XTUFQX1RZUEVfVlNNIClcblx0XHRcdHZlYzIgb2Zmc2V0ID0gdmVjMiggLSAxLCAxICkgKiBzaGFkb3dSYWRpdXMgKiB0ZXhlbFNpemUueTtcblx0XHRcdHJldHVybiAoXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgY3ViZVRvVVYoIGJkM0QgKyBvZmZzZXQueHl5LCB0ZXhlbFNpemUueSApLCBkcCApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBjdWJlVG9VViggYmQzRCArIG9mZnNldC55eXksIHRleGVsU2l6ZS55ICksIGRwICkgK1xuXHRcdFx0XHR0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIGN1YmVUb1VWKCBiZDNEICsgb2Zmc2V0Lnh5eCwgdGV4ZWxTaXplLnkgKSwgZHAgKSArXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgY3ViZVRvVVYoIGJkM0QgKyBvZmZzZXQueXl4LCB0ZXhlbFNpemUueSApLCBkcCApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBjdWJlVG9VViggYmQzRCwgdGV4ZWxTaXplLnkgKSwgZHAgKSArXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgY3ViZVRvVVYoIGJkM0QgKyBvZmZzZXQueHh5LCB0ZXhlbFNpemUueSApLCBkcCApICtcblx0XHRcdFx0dGV4dHVyZTJEQ29tcGFyZSggc2hhZG93TWFwLCBjdWJlVG9VViggYmQzRCArIG9mZnNldC55eHksIHRleGVsU2l6ZS55ICksIGRwICkgK1xuXHRcdFx0XHR0ZXh0dXJlMkRDb21wYXJlKCBzaGFkb3dNYXAsIGN1YmVUb1VWKCBiZDNEICsgb2Zmc2V0Lnh4eCwgdGV4ZWxTaXplLnkgKSwgZHAgKSArXG5cdFx0XHRcdHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgY3ViZVRvVVYoIGJkM0QgKyBvZmZzZXQueXh4LCB0ZXhlbFNpemUueSApLCBkcCApXG5cdFx0XHQpICogKCAxLjAgLyA5LjAgKTtcblx0XHQjZWxzZVxuXHRcdFx0cmV0dXJuIHRleHR1cmUyRENvbXBhcmUoIHNoYWRvd01hcCwgY3ViZVRvVVYoIGJkM0QsIHRleGVsU2l6ZS55ICksIGRwICk7XG5cdFx0I2VuZGlmXG5cdH1cbiNlbmRpZiI7Cgp2YXIgc2hhZG93bWFwX3BhcnNfdmVydGV4ID0gIiNpZiBOVU1fU1BPVF9MSUdIVF9DT09SRFMgPiAwXG5cdHVuaWZvcm0gbWF0NCBzcG90TGlnaHRNYXRyaXhbIE5VTV9TUE9UX0xJR0hUX0NPT1JEUyBdO1xuXHR2YXJ5aW5nIHZlYzQgdlNwb3RMaWdodENvb3JkWyBOVU1fU1BPVF9MSUdIVF9DT09SRFMgXTtcbiNlbmRpZlxuI2lmZGVmIFVTRV9TSEFET1dNQVBcblx0I2lmIE5VTV9ESVJfTElHSFRfU0hBRE9XUyA+IDBcblx0XHR1bmlmb3JtIG1hdDQgZGlyZWN0aW9uYWxTaGFkb3dNYXRyaXhbIE5VTV9ESVJfTElHSFRfU0hBRE9XUyBdO1xuXHRcdHZhcnlpbmcgdmVjNCB2RGlyZWN0aW9uYWxTaGFkb3dDb29yZFsgTlVNX0RJUl9MSUdIVF9TSEFET1dTIF07XG5cdFx0c3RydWN0IERpcmVjdGlvbmFsTGlnaHRTaGFkb3cge1xuXHRcdFx0ZmxvYXQgc2hhZG93Qmlhcztcblx0XHRcdGZsb2F0IHNoYWRvd05vcm1hbEJpYXM7XG5cdFx0XHRmbG9hdCBzaGFkb3dSYWRpdXM7XG5cdFx0XHR2ZWMyIHNoYWRvd01hcFNpemU7XG5cdFx0fTtcblx0XHR1bmlmb3JtIERpcmVjdGlvbmFsTGlnaHRTaGFkb3cgZGlyZWN0aW9uYWxMaWdodFNoYWRvd3NbIE5VTV9ESVJfTElHSFRfU0hBRE9XUyBdO1xuXHQjZW5kaWZcblx0I2lmIE5VTV9TUE9UX0xJR0hUX1NIQURPV1MgPiAwXG5cdFx0c3RydWN0IFNwb3RMaWdodFNoYWRvdyB7XG5cdFx0XHRmbG9hdCBzaGFkb3dCaWFzO1xuXHRcdFx0ZmxvYXQgc2hhZG93Tm9ybWFsQmlhcztcblx0XHRcdGZsb2F0IHNoYWRvd1JhZGl1cztcblx0XHRcdHZlYzIgc2hhZG93TWFwU2l6ZTtcblx0XHR9O1xuXHRcdHVuaWZvcm0gU3BvdExpZ2h0U2hhZG93IHNwb3RMaWdodFNoYWRvd3NbIE5VTV9TUE9UX0xJR0hUX1NIQURPV1MgXTtcblx0I2VuZGlmXG5cdCNpZiBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyA+IDBcblx0XHR1bmlmb3JtIG1hdDQgcG9pbnRTaGFkb3dNYXRyaXhbIE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTIF07XG5cdFx0dmFyeWluZyB2ZWM0IHZQb2ludFNoYWRvd0Nvb3JkWyBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyBdO1xuXHRcdHN0cnVjdCBQb2ludExpZ2h0U2hhZG93IHtcblx0XHRcdGZsb2F0IHNoYWRvd0JpYXM7XG5cdFx0XHRmbG9hdCBzaGFkb3dOb3JtYWxCaWFzO1xuXHRcdFx0ZmxvYXQgc2hhZG93UmFkaXVzO1xuXHRcdFx0dmVjMiBzaGFkb3dNYXBTaXplO1xuXHRcdFx0ZmxvYXQgc2hhZG93Q2FtZXJhTmVhcjtcblx0XHRcdGZsb2F0IHNoYWRvd0NhbWVyYUZhcjtcblx0XHR9O1xuXHRcdHVuaWZvcm0gUG9pbnRMaWdodFNoYWRvdyBwb2ludExpZ2h0U2hhZG93c1sgTlVNX1BPSU5UX0xJR0hUX1NIQURPV1MgXTtcblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIHNoYWRvd21hcF92ZXJ0ZXggPSAiI2lmICggZGVmaW5lZCggVVNFX1NIQURPV01BUCApICYmICggTlVNX0RJUl9MSUdIVF9TSEFET1dTID4gMCB8fCBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyA+IDAgKSApIHx8ICggTlVNX1NQT1RfTElHSFRfQ09PUkRTID4gMCApXG5cdHZlYzMgc2hhZG93V29ybGROb3JtYWwgPSBpbnZlcnNlVHJhbnNmb3JtRGlyZWN0aW9uKCB0cmFuc2Zvcm1lZE5vcm1hbCwgdmlld01hdHJpeCApO1xuXHR2ZWM0IHNoYWRvd1dvcmxkUG9zaXRpb247XG4jZW5kaWZcbiNpZiBkZWZpbmVkKCBVU0VfU0hBRE9XTUFQIClcblx0I2lmIE5VTV9ESVJfTElHSFRfU0hBRE9XUyA+IDBcblx0XHQjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0XG5cdFx0Zm9yICggaW50IGkgPSAwOyBpIDwgTlVNX0RJUl9MSUdIVF9TSEFET1dTOyBpICsrICkge1xuXHRcdFx0c2hhZG93V29ybGRQb3NpdGlvbiA9IHdvcmxkUG9zaXRpb24gKyB2ZWM0KCBzaGFkb3dXb3JsZE5vcm1hbCAqIGRpcmVjdGlvbmFsTGlnaHRTaGFkb3dzWyBpIF0uc2hhZG93Tm9ybWFsQmlhcywgMCApO1xuXHRcdFx0dkRpcmVjdGlvbmFsU2hhZG93Q29vcmRbIGkgXSA9IGRpcmVjdGlvbmFsU2hhZG93TWF0cml4WyBpIF0gKiBzaGFkb3dXb3JsZFBvc2l0aW9uO1xuXHRcdH1cblx0XHQjcHJhZ21hIHVucm9sbF9sb29wX2VuZFxuXHQjZW5kaWZcblx0I2lmIE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTID4gMFxuXHRcdCNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnRcblx0XHRmb3IgKCBpbnQgaSA9IDA7IGkgPCBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUzsgaSArKyApIHtcblx0XHRcdHNoYWRvd1dvcmxkUG9zaXRpb24gPSB3b3JsZFBvc2l0aW9uICsgdmVjNCggc2hhZG93V29ybGROb3JtYWwgKiBwb2ludExpZ2h0U2hhZG93c1sgaSBdLnNoYWRvd05vcm1hbEJpYXMsIDAgKTtcblx0XHRcdHZQb2ludFNoYWRvd0Nvb3JkWyBpIF0gPSBwb2ludFNoYWRvd01hdHJpeFsgaSBdICogc2hhZG93V29ybGRQb3NpdGlvbjtcblx0XHR9XG5cdFx0I3ByYWdtYSB1bnJvbGxfbG9vcF9lbmRcblx0I2VuZGlmXG4jZW5kaWZcbiNpZiBOVU1fU1BPVF9MSUdIVF9DT09SRFMgPiAwXG5cdCNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnRcblx0Zm9yICggaW50IGkgPSAwOyBpIDwgTlVNX1NQT1RfTElHSFRfQ09PUkRTOyBpICsrICkge1xuXHRcdHNoYWRvd1dvcmxkUG9zaXRpb24gPSB3b3JsZFBvc2l0aW9uO1xuXHRcdCNpZiAoIGRlZmluZWQoIFVTRV9TSEFET1dNQVAgKSAmJiBVTlJPTExFRF9MT09QX0lOREVYIDwgTlVNX1NQT1RfTElHSFRfU0hBRE9XUyApXG5cdFx0XHRzaGFkb3dXb3JsZFBvc2l0aW9uLnh5eiArPSBzaGFkb3dXb3JsZE5vcm1hbCAqIHNwb3RMaWdodFNoYWRvd3NbIGkgXS5zaGFkb3dOb3JtYWxCaWFzO1xuXHRcdCNlbmRpZlxuXHRcdHZTcG90TGlnaHRDb29yZFsgaSBdID0gc3BvdExpZ2h0TWF0cml4WyBpIF0gKiBzaGFkb3dXb3JsZFBvc2l0aW9uO1xuXHR9XG5cdCNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kXG4jZW5kaWYiOwoKdmFyIHNoYWRvd21hc2tfcGFyc19mcmFnbWVudCA9ICJmbG9hdCBnZXRTaGFkb3dNYXNrKCkge1xuXHRmbG9hdCBzaGFkb3cgPSAxLjA7XG5cdCNpZmRlZiBVU0VfU0hBRE9XTUFQXG5cdCNpZiBOVU1fRElSX0xJR0hUX1NIQURPV1MgPiAwXG5cdERpcmVjdGlvbmFsTGlnaHRTaGFkb3cgZGlyZWN0aW9uYWxMaWdodDtcblx0I3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydFxuXHRmb3IgKCBpbnQgaSA9IDA7IGkgPCBOVU1fRElSX0xJR0hUX1NIQURPV1M7IGkgKysgKSB7XG5cdFx0ZGlyZWN0aW9uYWxMaWdodCA9IGRpcmVjdGlvbmFsTGlnaHRTaGFkb3dzWyBpIF07XG5cdFx0c2hhZG93ICo9IHJlY2VpdmVTaGFkb3cgPyBnZXRTaGFkb3coIGRpcmVjdGlvbmFsU2hhZG93TWFwWyBpIF0sIGRpcmVjdGlvbmFsTGlnaHQuc2hhZG93TWFwU2l6ZSwgZGlyZWN0aW9uYWxMaWdodC5zaGFkb3dCaWFzLCBkaXJlY3Rpb25hbExpZ2h0LnNoYWRvd1JhZGl1cywgdkRpcmVjdGlvbmFsU2hhZG93Q29vcmRbIGkgXSApIDogMS4wO1xuXHR9XG5cdCNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kXG5cdCNlbmRpZlxuXHQjaWYgTlVNX1NQT1RfTElHSFRfU0hBRE9XUyA+IDBcblx0U3BvdExpZ2h0U2hhZG93IHNwb3RMaWdodDtcblx0I3ByYWdtYSB1bnJvbGxfbG9vcF9zdGFydFxuXHRmb3IgKCBpbnQgaSA9IDA7IGkgPCBOVU1fU1BPVF9MSUdIVF9TSEFET1dTOyBpICsrICkge1xuXHRcdHNwb3RMaWdodCA9IHNwb3RMaWdodFNoYWRvd3NbIGkgXTtcblx0XHRzaGFkb3cgKj0gcmVjZWl2ZVNoYWRvdyA/IGdldFNoYWRvdyggc3BvdFNoYWRvd01hcFsgaSBdLCBzcG90TGlnaHQuc2hhZG93TWFwU2l6ZSwgc3BvdExpZ2h0LnNoYWRvd0JpYXMsIHNwb3RMaWdodC5zaGFkb3dSYWRpdXMsIHZTcG90TGlnaHRDb29yZFsgaSBdICkgOiAxLjA7XG5cdH1cblx0I3ByYWdtYSB1bnJvbGxfbG9vcF9lbmRcblx0I2VuZGlmXG5cdCNpZiBOVU1fUE9JTlRfTElHSFRfU0hBRE9XUyA+IDBcblx0UG9pbnRMaWdodFNoYWRvdyBwb2ludExpZ2h0O1xuXHQjcHJhZ21hIHVucm9sbF9sb29wX3N0YXJ0XG5cdGZvciAoIGludCBpID0gMDsgaSA8IE5VTV9QT0lOVF9MSUdIVF9TSEFET1dTOyBpICsrICkge1xuXHRcdHBvaW50TGlnaHQgPSBwb2ludExpZ2h0U2hhZG93c1sgaSBdO1xuXHRcdHNoYWRvdyAqPSByZWNlaXZlU2hhZG93ID8gZ2V0UG9pbnRTaGFkb3coIHBvaW50U2hhZG93TWFwWyBpIF0sIHBvaW50TGlnaHQuc2hhZG93TWFwU2l6ZSwgcG9pbnRMaWdodC5zaGFkb3dCaWFzLCBwb2ludExpZ2h0LnNoYWRvd1JhZGl1cywgdlBvaW50U2hhZG93Q29vcmRbIGkgXSwgcG9pbnRMaWdodC5zaGFkb3dDYW1lcmFOZWFyLCBwb2ludExpZ2h0LnNoYWRvd0NhbWVyYUZhciApIDogMS4wO1xuXHR9XG5cdCNwcmFnbWEgdW5yb2xsX2xvb3BfZW5kXG5cdCNlbmRpZlxuXHQjZW5kaWZcblx0cmV0dXJuIHNoYWRvdztcbn0iOwoKdmFyIHNraW5iYXNlX3ZlcnRleCA9ICIjaWZkZWYgVVNFX1NLSU5OSU5HXG5cdG1hdDQgYm9uZU1hdFggPSBnZXRCb25lTWF0cml4KCBza2luSW5kZXgueCApO1xuXHRtYXQ0IGJvbmVNYXRZID0gZ2V0Qm9uZU1hdHJpeCggc2tpbkluZGV4LnkgKTtcblx0bWF0NCBib25lTWF0WiA9IGdldEJvbmVNYXRyaXgoIHNraW5JbmRleC56ICk7XG5cdG1hdDQgYm9uZU1hdFcgPSBnZXRCb25lTWF0cml4KCBza2luSW5kZXgudyApO1xuI2VuZGlmIjsKCnZhciBza2lubmluZ19wYXJzX3ZlcnRleCA9ICIjaWZkZWYgVVNFX1NLSU5OSU5HXG5cdHVuaWZvcm0gbWF0NCBiaW5kTWF0cml4O1xuXHR1bmlmb3JtIG1hdDQgYmluZE1hdHJpeEludmVyc2U7XG5cdHVuaWZvcm0gaGlnaHAgc2FtcGxlcjJEIGJvbmVUZXh0dXJlO1xuXHRtYXQ0IGdldEJvbmVNYXRyaXgoIGNvbnN0IGluIGZsb2F0IGkgKSB7XG5cdFx0aW50IHNpemUgPSB0ZXh0dXJlU2l6ZSggYm9uZVRleHR1cmUsIDAgKS54O1xuXHRcdGludCBqID0gaW50KCBpICkgKiA0O1xuXHRcdGludCB4ID0gaiAlIHNpemU7XG5cdFx0aW50IHkgPSBqIC8gc2l6ZTtcblx0XHR2ZWM0IHYxID0gdGV4ZWxGZXRjaCggYm9uZVRleHR1cmUsIGl2ZWMyKCB4LCB5ICksIDAgKTtcblx0XHR2ZWM0IHYyID0gdGV4ZWxGZXRjaCggYm9uZVRleHR1cmUsIGl2ZWMyKCB4ICsgMSwgeSApLCAwICk7XG5cdFx0dmVjNCB2MyA9IHRleGVsRmV0Y2goIGJvbmVUZXh0dXJlLCBpdmVjMiggeCArIDIsIHkgKSwgMCApO1xuXHRcdHZlYzQgdjQgPSB0ZXhlbEZldGNoKCBib25lVGV4dHVyZSwgaXZlYzIoIHggKyAzLCB5ICksIDAgKTtcblx0XHRyZXR1cm4gbWF0NCggdjEsIHYyLCB2MywgdjQgKTtcblx0fVxuI2VuZGlmIjsKCnZhciBza2lubmluZ192ZXJ0ZXggPSAiI2lmZGVmIFVTRV9TS0lOTklOR1xuXHR2ZWM0IHNraW5WZXJ0ZXggPSBiaW5kTWF0cml4ICogdmVjNCggdHJhbnNmb3JtZWQsIDEuMCApO1xuXHR2ZWM0IHNraW5uZWQgPSB2ZWM0KCAwLjAgKTtcblx0c2tpbm5lZCArPSBib25lTWF0WCAqIHNraW5WZXJ0ZXggKiBza2luV2VpZ2h0Lng7XG5cdHNraW5uZWQgKz0gYm9uZU1hdFkgKiBza2luVmVydGV4ICogc2tpbldlaWdodC55O1xuXHRza2lubmVkICs9IGJvbmVNYXRaICogc2tpblZlcnRleCAqIHNraW5XZWlnaHQuejtcblx0c2tpbm5lZCArPSBib25lTWF0VyAqIHNraW5WZXJ0ZXggKiBza2luV2VpZ2h0Lnc7XG5cdHRyYW5zZm9ybWVkID0gKCBiaW5kTWF0cml4SW52ZXJzZSAqIHNraW5uZWQgKS54eXo7XG4jZW5kaWYiOwoKdmFyIHNraW5ub3JtYWxfdmVydGV4ID0gIiNpZmRlZiBVU0VfU0tJTk5JTkdcblx0bWF0NCBza2luTWF0cml4ID0gbWF0NCggMC4wICk7XG5cdHNraW5NYXRyaXggKz0gc2tpbldlaWdodC54ICogYm9uZU1hdFg7XG5cdHNraW5NYXRyaXggKz0gc2tpbldlaWdodC55ICogYm9uZU1hdFk7XG5cdHNraW5NYXRyaXggKz0gc2tpbldlaWdodC56ICogYm9uZU1hdFo7XG5cdHNraW5NYXRyaXggKz0gc2tpbldlaWdodC53ICogYm9uZU1hdFc7XG5cdHNraW5NYXRyaXggPSBiaW5kTWF0cml4SW52ZXJzZSAqIHNraW5NYXRyaXggKiBiaW5kTWF0cml4O1xuXHRvYmplY3ROb3JtYWwgPSB2ZWM0KCBza2luTWF0cml4ICogdmVjNCggb2JqZWN0Tm9ybWFsLCAwLjAgKSApLnh5ejtcblx0I2lmZGVmIFVTRV9UQU5HRU5UXG5cdFx0b2JqZWN0VGFuZ2VudCA9IHZlYzQoIHNraW5NYXRyaXggKiB2ZWM0KCBvYmplY3RUYW5nZW50LCAwLjAgKSApLnh5ejtcblx0I2VuZGlmXG4jZW5kaWYiOwoKdmFyIHNwZWN1bGFybWFwX2ZyYWdtZW50ID0gImZsb2F0IHNwZWN1bGFyU3RyZW5ndGg7XG4jaWZkZWYgVVNFX1NQRUNVTEFSTUFQXG5cdHZlYzQgdGV4ZWxTcGVjdWxhciA9IHRleHR1cmUyRCggc3BlY3VsYXJNYXAsIHZTcGVjdWxhck1hcFV2ICk7XG5cdHNwZWN1bGFyU3RyZW5ndGggPSB0ZXhlbFNwZWN1bGFyLnI7XG4jZWxzZVxuXHRzcGVjdWxhclN0cmVuZ3RoID0gMS4wO1xuI2VuZGlmIjsKCnZhciBzcGVjdWxhcm1hcF9wYXJzX2ZyYWdtZW50ID0gIiNpZmRlZiBVU0VfU1BFQ1VMQVJNQVBcblx0dW5pZm9ybSBzYW1wbGVyMkQgc3BlY3VsYXJNYXA7XG4jZW5kaWYiOwoKdmFyIHRvbmVtYXBwaW5nX2ZyYWdtZW50ID0gIiNpZiBkZWZpbmVkKCBUT05FX01BUFBJTkcgKVxuXHRnbF9GcmFnQ29sb3IucmdiID0gdG9uZU1hcHBpbmcoIGdsX0ZyYWdDb2xvci5yZ2IgKTtcbiNlbmRpZiI7Cgp2YXIgdG9uZW1hcHBpbmdfcGFyc19mcmFnbWVudCA9ICIjaWZuZGVmIHNhdHVyYXRlXG4jZGVmaW5lIHNhdHVyYXRlKCBhICkgY2xhbXAoIGEsIDAuMCwgMS4wIClcbiNlbmRpZlxudW5pZm9ybSBmbG9hdCB0b25lTWFwcGluZ0V4cG9zdXJlO1xudmVjMyBMaW5lYXJUb25lTWFwcGluZyggdmVjMyBjb2xvciApIHtcblx0cmV0dXJuIHNhdHVyYXRlKCB0b25lTWFwcGluZ0V4cG9zdXJlICogY29sb3IgKTtcbn1cbnZlYzMgUmVpbmhhcmRUb25lTWFwcGluZyggdmVjMyBjb2xvciApIHtcblx0Y29sb3IgKj0gdG9uZU1hcHBpbmdFeHBvc3VyZTtcblx0cmV0dXJuIHNhdHVyYXRlKCBjb2xvciAvICggdmVjMyggMS4wICkgKyBjb2xvciApICk7XG59XG52ZWMzIE9wdGltaXplZENpbmVvblRvbmVNYXBwaW5nKCB2ZWMzIGNvbG9yICkge1xuXHRjb2xvciAqPSB0b25lTWFwcGluZ0V4cG9zdXJlO1xuXHRjb2xvciA9IG1heCggdmVjMyggMC4wICksIGNvbG9yIC0gMC4wMDQgKTtcblx0cmV0dXJuIHBvdyggKCBjb2xvciAqICggNi4yICogY29sb3IgKyAwLjUgKSApIC8gKCBjb2xvciAqICggNi4yICogY29sb3IgKyAxLjcgKSArIDAuMDYgKSwgdmVjMyggMi4yICkgKTtcbn1cbnZlYzMgUlJUQW5kT0RURml0KCB2ZWMzIHYgKSB7XG5cdHZlYzMgYSA9IHYgKiAoIHYgKyAwLjAyNDU3ODYgKSAtIDAuMDAwMDkwNTM3O1xuXHR2ZWMzIGIgPSB2ICogKCAwLjk4MzcyOSAqIHYgKyAwLjQzMjk1MTAgKSArIDAuMjM4MDgxO1xuXHRyZXR1cm4gYSAvIGI7XG59XG52ZWMzIEFDRVNGaWxtaWNUb25lTWFwcGluZyggdmVjMyBjb2xvciApIHtcblx0Y29uc3QgbWF0MyBBQ0VTSW5wdXRNYXQgPSBtYXQzKFxuXHRcdHZlYzMoIDAuNTk3MTksIDAuMDc2MDAsIDAuMDI4NDAgKSxcdFx0dmVjMyggMC4zNTQ1OCwgMC45MDgzNCwgMC4xMzM4MyApLFxuXHRcdHZlYzMoIDAuMDQ4MjMsIDAuMDE1NjYsIDAuODM3NzcgKVxuXHQpO1xuXHRjb25zdCBtYXQzIEFDRVNPdXRwdXRNYXQgPSBtYXQzKFxuXHRcdHZlYzMoICAxLjYwNDc1LCAtMC4xMDIwOCwgLTAuMDAzMjcgKSxcdFx0dmVjMyggLTAuNTMxMDgsICAxLjEwODEzLCAtMC4wNzI3NiApLFxuXHRcdHZlYzMoIC0wLjA3MzY3LCAtMC4wMDYwNSwgIDEuMDc2MDIgKVxuXHQpO1xuXHRjb2xvciAqPSB0b25lTWFwcGluZ0V4cG9zdXJlIC8gMC42O1xuXHRjb2xvciA9IEFDRVNJbnB1dE1hdCAqIGNvbG9yO1xuXHRjb2xvciA9IFJSVEFuZE9EVEZpdCggY29sb3IgKTtcblx0Y29sb3IgPSBBQ0VTT3V0cHV0TWF0ICogY29sb3I7XG5cdHJldHVybiBzYXR1cmF0ZSggY29sb3IgKTtcbn1cbmNvbnN0IG1hdDMgTElORUFSX1JFQzIwMjBfVE9fTElORUFSX1NSR0IgPSBtYXQzKFxuXHR2ZWMzKCAxLjY2MDUsIC0gMC4xMjQ2LCAtIDAuMDE4MiApLFxuXHR2ZWMzKCAtIDAuNTg3NiwgMS4xMzI5LCAtIDAuMTAwNiApLFxuXHR2ZWMzKCAtIDAuMDcyOCwgLSAwLjAwODMsIDEuMTE4NyApXG4pO1xuY29uc3QgbWF0MyBMSU5FQVJfU1JHQl9UT19MSU5FQVJfUkVDMjAyMCA9IG1hdDMoXG5cdHZlYzMoIDAuNjI3NCwgMC4wNjkxLCAwLjAxNjQgKSxcblx0dmVjMyggMC4zMjkzLCAwLjkxOTUsIDAuMDg4MCApLFxuXHR2ZWMzKCAwLjA0MzMsIDAuMDExMywgMC44OTU2IClcbik7XG52ZWMzIGFneERlZmF1bHRDb250cmFzdEFwcHJveCggdmVjMyB4ICkge1xuXHR2ZWMzIHgyID0geCAqIHg7XG5cdHZlYzMgeDQgPSB4MiAqIHgyO1xuXHRyZXR1cm4gKyAxNS41ICogeDQgKiB4MlxuXHRcdC0gNDAuMTQgKiB4NCAqIHhcblx0XHQrIDMxLjk2ICogeDRcblx0XHQtIDYuODY4ICogeDIgKiB4XG5cdFx0KyAwLjQyOTggKiB4MlxuXHRcdCsgMC4xMTkxICogeFxuXHRcdC0gMC4wMDIzMjtcbn1cbnZlYzMgQWdYVG9uZU1hcHBpbmcoIHZlYzMgY29sb3IgKSB7XG5cdGNvbnN0IG1hdDMgQWdYSW5zZXRNYXRyaXggPSBtYXQzKFxuXHRcdHZlYzMoIDAuODU2NjI3MTUzMzE1OTgzLCAwLjEzNzMxODk3MjkyOTg0NywgMC4xMTE4OTgyMTI5OTk5NSApLFxuXHRcdHZlYzMoIDAuMDk1MTIxMjQwNTM4MTU4OCwgMC43NjEyNDE5OTA2MDI1OTEsIDAuMDc2Nzk5NDE4NjAzMTkwMyApLFxuXHRcdHZlYzMoIDAuMDQ4MjUxNjA2MTQ1ODU4MywgMC4xMDE0MzkwMzY0Njc1NjIsIDAuODExMzAyMzY4Mzk2ODU5IClcblx0KTtcblx0Y29uc3QgbWF0MyBBZ1hPdXRzZXRNYXRyaXggPSBtYXQzKFxuXHRcdHZlYzMoIDEuMTI3MTAwNTgxODE0NDM2OCwgLSAwLjE0MTMyOTc2MzQ5ODQzODMsIC0gMC4xNDEzMjk3NjM0OTg0MzgyNiApLFxuXHRcdHZlYzMoIC0gMC4xMTA2MDY2NDMwOTY2MDMyMywgMS4xNTc4MjM3MDIyMTYyNzIsIC0gMC4xMTA2MDY2NDMwOTY2MDI5NCApLFxuXHRcdHZlYzMoIC0gMC4wMTY0OTM5Mzg3MTc4MzQ1NzMsIC0gMC4wMTY0OTM5Mzg3MTc4MzQyNTcsIDEuMjUxOTM2NDA2NTk1MDQwNSApXG5cdCk7XG5cdGNvbnN0IGZsb2F0IEFneE1pbkV2ID0gLSAxMi40NzM5MztcdGNvbnN0IGZsb2F0IEFneE1heEV2ID0gNC4wMjYwNjk7XG5cdGNvbG9yICo9IHRvbmVNYXBwaW5nRXhwb3N1cmU7XG5cdGNvbG9yID0gTElORUFSX1NSR0JfVE9fTElORUFSX1JFQzIwMjAgKiBjb2xvcjtcblx0Y29sb3IgPSBBZ1hJbnNldE1hdHJpeCAqIGNvbG9yO1xuXHRjb2xvciA9IG1heCggY29sb3IsIDFlLTEwICk7XHRjb2xvciA9IGxvZzIoIGNvbG9yICk7XG5cdGNvbG9yID0gKCBjb2xvciAtIEFneE1pbkV2ICkgLyAoIEFneE1heEV2IC0gQWd4TWluRXYgKTtcblx0Y29sb3IgPSBjbGFtcCggY29sb3IsIDAuMCwgMS4wICk7XG5cdGNvbG9yID0gYWd4RGVmYXVsdENvbnRyYXN0QXBwcm94KCBjb2xvciApO1xuXHRjb2xvciA9IEFnWE91dHNldE1hdHJpeCAqIGNvbG9yO1xuXHRjb2xvciA9IHBvdyggbWF4KCB2ZWMzKCAwLjAgKSwgY29sb3IgKSwgdmVjMyggMi4yICkgKTtcblx0Y29sb3IgPSBMSU5FQVJfUkVDMjAyMF9UT19MSU5FQVJfU1JHQiAqIGNvbG9yO1xuXHRjb2xvciA9IGNsYW1wKCBjb2xvciwgMC4wLCAxLjAgKTtcblx0cmV0dXJuIGNvbG9yO1xufVxudmVjMyBDdXN0b21Ub25lTWFwcGluZyggdmVjMyBjb2xvciApIHsgcmV0dXJuIGNvbG9yOyB9IjsKCnZhciB0cmFuc21pc3Npb25fZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9UUkFOU01JU1NJT05cblx0bWF0ZXJpYWwudHJhbnNtaXNzaW9uID0gdHJhbnNtaXNzaW9uO1xuXHRtYXRlcmlhbC50cmFuc21pc3Npb25BbHBoYSA9IDEuMDtcblx0bWF0ZXJpYWwudGhpY2tuZXNzID0gdGhpY2tuZXNzO1xuXHRtYXRlcmlhbC5hdHRlbnVhdGlvbkRpc3RhbmNlID0gYXR0ZW51YXRpb25EaXN0YW5jZTtcblx0bWF0ZXJpYWwuYXR0ZW51YXRpb25Db2xvciA9IGF0dGVudWF0aW9uQ29sb3I7XG5cdCNpZmRlZiBVU0VfVFJBTlNNSVNTSU9OTUFQXG5cdFx0bWF0ZXJpYWwudHJhbnNtaXNzaW9uICo9IHRleHR1cmUyRCggdHJhbnNtaXNzaW9uTWFwLCB2VHJhbnNtaXNzaW9uTWFwVXYgKS5yO1xuXHQjZW5kaWZcblx0I2lmZGVmIFVTRV9USElDS05FU1NNQVBcblx0XHRtYXRlcmlhbC50aGlja25lc3MgKj0gdGV4dHVyZTJEKCB0aGlja25lc3NNYXAsIHZUaGlja25lc3NNYXBVdiApLmc7XG5cdCNlbmRpZlxuXHR2ZWMzIHBvcyA9IHZXb3JsZFBvc2l0aW9uO1xuXHR2ZWMzIHYgPSBub3JtYWxpemUoIGNhbWVyYVBvc2l0aW9uIC0gcG9zICk7XG5cdHZlYzMgbiA9IGludmVyc2VUcmFuc2Zvcm1EaXJlY3Rpb24oIG5vcm1hbCwgdmlld01hdHJpeCApO1xuXHR2ZWM0IHRyYW5zbWl0dGVkID0gZ2V0SUJMVm9sdW1lUmVmcmFjdGlvbihcblx0XHRuLCB2LCBtYXRlcmlhbC5yb3VnaG5lc3MsIG1hdGVyaWFsLmRpZmZ1c2VDb2xvciwgbWF0ZXJpYWwuc3BlY3VsYXJDb2xvciwgbWF0ZXJpYWwuc3BlY3VsYXJGOTAsXG5cdFx0cG9zLCBtb2RlbE1hdHJpeCwgdmlld01hdHJpeCwgcHJvamVjdGlvbk1hdHJpeCwgbWF0ZXJpYWwuaW9yLCBtYXRlcmlhbC50aGlja25lc3MsXG5cdFx0bWF0ZXJpYWwuYXR0ZW51YXRpb25Db2xvciwgbWF0ZXJpYWwuYXR0ZW51YXRpb25EaXN0YW5jZSApO1xuXHRtYXRlcmlhbC50cmFuc21pc3Npb25BbHBoYSA9IG1peCggbWF0ZXJpYWwudHJhbnNtaXNzaW9uQWxwaGEsIHRyYW5zbWl0dGVkLmEsIG1hdGVyaWFsLnRyYW5zbWlzc2lvbiApO1xuXHR0b3RhbERpZmZ1c2UgPSBtaXgoIHRvdGFsRGlmZnVzZSwgdHJhbnNtaXR0ZWQucmdiLCBtYXRlcmlhbC50cmFuc21pc3Npb24gKTtcbiNlbmRpZiI7Cgp2YXIgdHJhbnNtaXNzaW9uX3BhcnNfZnJhZ21lbnQgPSAiI2lmZGVmIFVTRV9UUkFOU01JU1NJT05cblx0dW5pZm9ybSBmbG9hdCB0cmFuc21pc3Npb247XG5cdHVuaWZvcm0gZmxvYXQgdGhpY2tuZXNzO1xuXHR1bmlmb3JtIGZsb2F0IGF0dGVudWF0aW9uRGlzdGFuY2U7XG5cdHVuaWZvcm0gdmVjMyBhdHRlbnVhdGlvbkNvbG9yO1xuXHQjaWZkZWYgVVNFX1RSQU5TTUlTU0lPTk1BUFxuXHRcdHVuaWZvcm0gc2FtcGxlcjJEIHRyYW5zbWlzc2lvbk1hcDtcblx0I2VuZGlmXG5cdCNpZmRlZiBVU0VfVEhJQ0tORVNTTUFQXG5cdFx0dW5pZm9ybSBzYW1wbGVyMkQgdGhpY2tuZXNzTWFwO1xuXHQjZW5kaWZcblx0dW5pZm9ybSB2ZWMyIHRyYW5zbWlzc2lvblNhbXBsZXJTaXplO1xuXHR1bmlmb3JtIHNhbXBsZXIyRCB0cmFuc21pc3Npb25TYW1wbGVyTWFwO1xuXHR1bmlmb3JtIG1hdDQgbW9kZWxNYXRyaXg7XG5cdHVuaWZvcm0gbWF0NCBwcm9qZWN0aW9uTWF0cml4O1xuXHR2YXJ5aW5nIHZlYzMgdldvcmxkUG9zaXRpb247XG5cdGZsb2F0IHcwKCBmbG9hdCBhICkge1xuXHRcdHJldHVybiAoIDEuMCAvIDYuMCApICogKCBhICogKCBhICogKCAtIGEgKyAzLjAgKSAtIDMuMCApICsgMS4wICk7XG5cdH1cblx0ZmxvYXQgdzEoIGZsb2F0IGEgKSB7XG5cdFx0cmV0dXJuICggMS4wIC8gNi4wICkgKiAoIGEgKiAgYSAqICggMy4wICogYSAtIDYuMCApICsgNC4wICk7XG5cdH1cblx0ZmxvYXQgdzIoIGZsb2F0IGEgKXtcblx0XHRyZXR1cm4gKCAxLjAgLyA2LjAgKSAqICggYSAqICggYSAqICggLSAzLjAgKiBhICsgMy4wICkgKyAzLjAgKSArIDEuMCApO1xuXHR9XG5cdGZsb2F0IHczKCBmbG9hdCBhICkge1xuXHRcdHJldHVybiAoIDEuMCAvIDYuMCApICogKCBhICogYSAqIGEgKTtcblx0fVxuXHRmbG9hdCBnMCggZmxvYXQgYSApIHtcblx0XHRyZXR1cm4gdzAoIGEgKSArIHcxKCBhICk7XG5cdH1cblx0ZmxvYXQgZzEoIGZsb2F0IGEgKSB7XG5cdFx0cmV0dXJuIHcyKCBhICkgKyB3MyggYSApO1xuXHR9XG5cdGZsb2F0IGgwKCBmbG9hdCBhICkge1xuXHRcdHJldHVybiAtIDEuMCArIHcxKCBhICkgLyAoIHcwKCBhICkgKyB3MSggYSApICk7XG5cdH1cblx0ZmxvYXQgaDEoIGZsb2F0IGEgKSB7XG5cdFx0cmV0dXJuIDEuMCArIHczKCBhICkgLyAoIHcyKCBhICkgKyB3MyggYSApICk7XG5cdH1cblx0dmVjNCBiaWN1YmljKCBzYW1wbGVyMkQgdGV4LCB2ZWMyIHV2LCB2ZWM0IHRleGVsU2l6ZSwgZmxvYXQgbG9kICkge1xuXHRcdHV2ID0gdXYgKiB0ZXhlbFNpemUuencgKyAwLjU7XG5cdFx0dmVjMiBpdXYgPSBmbG9vciggdXYgKTtcblx0XHR2ZWMyIGZ1diA9IGZyYWN0KCB1diApO1xuXHRcdGZsb2F0IGcweCA9IGcwKCBmdXYueCApO1xuXHRcdGZsb2F0IGcxeCA9IGcxKCBmdXYueCApO1xuXHRcdGZsb2F0IGgweCA9IGgwKCBmdXYueCApO1xuXHRcdGZsb2F0IGgxeCA9IGgxKCBmdXYueCApO1xuXHRcdGZsb2F0IGgweSA9IGgwKCBmdXYueSApO1xuXHRcdGZsb2F0IGgxeSA9IGgxKCBmdXYueSApO1xuXHRcdHZlYzIgcDAgPSAoIHZlYzIoIGl1di54ICsgaDB4LCBpdXYueSArIGgweSApIC0gMC41ICkgKiB0ZXhlbFNpemUueHk7XG5cdFx0dmVjMiBwMSA9ICggdmVjMiggaXV2LnggKyBoMXgsIGl1di55ICsgaDB5ICkgLSAwLjUgKSAqIHRleGVsU2l6ZS54eTtcblx0XHR2ZWMyIHAyID0gKCB2ZWMyKCBpdXYueCArIGgweCwgaXV2LnkgKyBoMXkgKSAtIDAuNSApICogdGV4ZWxTaXplLnh5O1xuXHRcdHZlYzIgcDMgPSAoIHZlYzIoIGl1di54ICsgaDF4LCBpdXYueSArIGgxeSApIC0gMC41ICkgKiB0ZXhlbFNpemUueHk7XG5cdFx0cmV0dXJuIGcwKCBmdXYueSApICogKCBnMHggKiB0ZXh0dXJlTG9kKCB0ZXgsIHAwLCBsb2QgKSArIGcxeCAqIHRleHR1cmVMb2QoIHRleCwgcDEsIGxvZCApICkgK1xuXHRcdFx0ZzEoIGZ1di55ICkgKiAoIGcweCAqIHRleHR1cmVMb2QoIHRleCwgcDIsIGxvZCApICsgZzF4ICogdGV4dHVyZUxvZCggdGV4LCBwMywgbG9kICkgKTtcblx0fVxuXHR2ZWM0IHRleHR1cmVCaWN1YmljKCBzYW1wbGVyMkQgc2FtcGxlciwgdmVjMiB1diwgZmxvYXQgbG9kICkge1xuXHRcdHZlYzIgZkxvZFNpemUgPSB2ZWMyKCB0ZXh0dXJlU2l6ZSggc2FtcGxlciwgaW50KCBsb2QgKSApICk7XG5cdFx0dmVjMiBjTG9kU2l6ZSA9IHZlYzIoIHRleHR1cmVTaXplKCBzYW1wbGVyLCBpbnQoIGxvZCArIDEuMCApICkgKTtcblx0XHR2ZWMyIGZMb2RTaXplSW52ID0gMS4wIC8gZkxvZFNpemU7XG5cdFx0dmVjMiBjTG9kU2l6ZUludiA9IDEuMCAvIGNMb2RTaXplO1xuXHRcdHZlYzQgZlNhbXBsZSA9IGJpY3ViaWMoIHNhbXBsZXIsIHV2LCB2ZWM0KCBmTG9kU2l6ZUludiwgZkxvZFNpemUgKSwgZmxvb3IoIGxvZCApICk7XG5cdFx0dmVjNCBjU2FtcGxlID0gYmljdWJpYyggc2FtcGxlciwgdXYsIHZlYzQoIGNMb2RTaXplSW52LCBjTG9kU2l6ZSApLCBjZWlsKCBsb2QgKSApO1xuXHRcdHJldHVybiBtaXgoIGZTYW1wbGUsIGNTYW1wbGUsIGZyYWN0KCBsb2QgKSApO1xuXHR9XG5cdHZlYzMgZ2V0Vm9sdW1lVHJhbnNtaXNzaW9uUmF5KCBjb25zdCBpbiB2ZWMzIG4sIGNvbnN0IGluIHZlYzMgdiwgY29uc3QgaW4gZmxvYXQgdGhpY2tuZXNzLCBjb25zdCBpbiBmbG9hdCBpb3IsIGNvbnN0IGluIG1hdDQgbW9kZWxNYXRyaXggKSB7XG5cdFx0dmVjMyByZWZyYWN0aW9uVmVjdG9yID0gcmVmcmFjdCggLSB2LCBub3JtYWxpemUoIG4gKSwgMS4wIC8gaW9yICk7XG5cdFx0dmVjMyBtb2RlbFNjYWxlO1xuXHRcdG1vZGVsU2NhbGUueCA9IGxlbmd0aCggdmVjMyggbW9kZWxNYXRyaXhbIDAgXS54eXogKSApO1xuXHRcdG1vZGVsU2NhbGUueSA9IGxlbmd0aCggdmVjMyggbW9kZWxNYXRyaXhbIDEgXS54eXogKSApO1xuXHRcdG1vZGVsU2NhbGUueiA9IGxlbmd0aCggdmVjMyggbW9kZWxNYXRyaXhbIDIgXS54eXogKSApO1xuXHRcdHJldHVybiBub3JtYWxpemUoIHJlZnJhY3Rpb25WZWN0b3IgKSAqIHRoaWNrbmVzcyAqIG1vZGVsU2NhbGU7XG5cdH1cblx0ZmxvYXQgYXBwbHlJb3JUb1JvdWdobmVzcyggY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzLCBjb25zdCBpbiBmbG9hdCBpb3IgKSB7XG5cdFx0cmV0dXJuIHJvdWdobmVzcyAqIGNsYW1wKCBpb3IgKiAyLjAgLSAyLjAsIDAuMCwgMS4wICk7XG5cdH1cblx0dmVjNCBnZXRUcmFuc21pc3Npb25TYW1wbGUoIGNvbnN0IGluIHZlYzIgZnJhZ0Nvb3JkLCBjb25zdCBpbiBmbG9hdCByb3VnaG5lc3MsIGNvbnN0IGluIGZsb2F0IGlvciApIHtcblx0XHRmbG9hdCBsb2QgPSBsb2cyKCB0cmFuc21pc3Npb25TYW1wbGVyU2l6ZS54ICkgKiBhcHBseUlvclRvUm91Z2huZXNzKCByb3VnaG5lc3MsIGlvciApO1xuXHRcdHJldHVybiB0ZXh0dXJlQmljdWJpYyggdHJhbnNtaXNzaW9uU2FtcGxlck1hcCwgZnJhZ0Nvb3JkLnh5LCBsb2QgKTtcblx0fVxuXHR2ZWMzIHZvbHVtZUF0dGVudWF0aW9uKCBjb25zdCBpbiBmbG9hdCB0cmFuc21pc3Npb25EaXN0YW5jZSwgY29uc3QgaW4gdmVjMyBhdHRlbnVhdGlvbkNvbG9yLCBjb25zdCBpbiBmbG9hdCBhdHRlbnVhdGlvbkRpc3RhbmNlICkge1xuXHRcdGlmICggaXNpbmYoIGF0dGVudWF0aW9uRGlzdGFuY2UgKSApIHtcblx0XHRcdHJldHVybiB2ZWMzKCAxLjAgKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dmVjMyBhdHRlbnVhdGlvbkNvZWZmaWNpZW50ID0gLWxvZyggYXR0ZW51YXRpb25Db2xvciApIC8gYXR0ZW51YXRpb25EaXN0YW5jZTtcblx0XHRcdHZlYzMgdHJhbnNtaXR0YW5jZSA9IGV4cCggLSBhdHRlbnVhdGlvbkNvZWZmaWNpZW50ICogdHJhbnNtaXNzaW9uRGlzdGFuY2UgKTtcdFx0XHRyZXR1cm4gdHJhbnNtaXR0YW5jZTtcblx0XHR9XG5cdH1cblx0dmVjNCBnZXRJQkxWb2x1bWVSZWZyYWN0aW9uKCBjb25zdCBpbiB2ZWMzIG4sIGNvbnN0IGluIHZlYzMgdiwgY29uc3QgaW4gZmxvYXQgcm91Z2huZXNzLCBjb25zdCBpbiB2ZWMzIGRpZmZ1c2VDb2xvcixcblx0XHRjb25zdCBpbiB2ZWMzIHNwZWN1bGFyQ29sb3IsIGNvbnN0IGluIGZsb2F0IHNwZWN1bGFyRjkwLCBjb25zdCBpbiB2ZWMzIHBvc2l0aW9uLCBjb25zdCBpbiBtYXQ0IG1vZGVsTWF0cml4LFxuXHRcdGNvbnN0IGluIG1hdDQgdmlld01hdHJpeCwgY29uc3QgaW4gbWF0NCBwcm9qTWF0cml4LCBjb25zdCBpbiBmbG9hdCBpb3IsIGNvbnN0IGluIGZsb2F0IHRoaWNrbmVzcyxcblx0XHRjb25zdCBpbiB2ZWMzIGF0dGVudWF0aW9uQ29sb3IsIGNvbnN0IGluIGZsb2F0IGF0dGVudWF0aW9uRGlzdGFuY2UgKSB7XG5cdFx0dmVjMyB0cmFuc21pc3Npb25SYXkgPSBnZXRWb2x1bWVUcmFuc21pc3Npb25SYXkoIG4sIHYsIHRoaWNrbmVzcywgaW9yLCBtb2RlbE1hdHJpeCApO1xuXHRcdHZlYzMgcmVmcmFjdGVkUmF5RXhpdCA9IHBvc2l0aW9uICsgdHJhbnNtaXNzaW9uUmF5O1xuXHRcdHZlYzQgbmRjUG9zID0gcHJvak1hdHJpeCAqIHZpZXdNYXRyaXggKiB2ZWM0KCByZWZyYWN0ZWRSYXlFeGl0LCAxLjAgKTtcblx0XHR2ZWMyIHJlZnJhY3Rpb25Db29yZHMgPSBuZGNQb3MueHkgLyBuZGNQb3Mudztcblx0XHRyZWZyYWN0aW9uQ29vcmRzICs9IDEuMDtcblx0XHRyZWZyYWN0aW9uQ29vcmRzIC89IDIuMDtcblx0XHR2ZWM0IHRyYW5zbWl0dGVkTGlnaHQgPSBnZXRUcmFuc21pc3Npb25TYW1wbGUoIHJlZnJhY3Rpb25Db29yZHMsIHJvdWdobmVzcywgaW9yICk7XG5cdFx0dmVjMyB0cmFuc21pdHRhbmNlID0gZGlmZnVzZUNvbG9yICogdm9sdW1lQXR0ZW51YXRpb24oIGxlbmd0aCggdHJhbnNtaXNzaW9uUmF5ICksIGF0dGVudWF0aW9uQ29sb3IsIGF0dGVudWF0aW9uRGlzdGFuY2UgKTtcblx0XHR2ZWMzIGF0dGVudWF0ZWRDb2xvciA9IHRyYW5zbWl0dGFuY2UgKiB0cmFuc21pdHRlZExpZ2h0LnJnYjtcblx0XHR2ZWMzIEYgPSBFbnZpcm9ubWVudEJSREYoIG4sIHYsIHNwZWN1bGFyQ29sb3IsIHNwZWN1bGFyRjkwLCByb3VnaG5lc3MgKTtcblx0XHRmbG9hdCB0cmFuc21pdHRhbmNlRmFjdG9yID0gKCB0cmFuc21pdHRhbmNlLnIgKyB0cmFuc21pdHRhbmNlLmcgKyB0cmFuc21pdHRhbmNlLmIgKSAvIDMuMDtcblx0XHRyZXR1cm4gdmVjNCggKCAxLjAgLSBGICkgKiBhdHRlbnVhdGVkQ29sb3IsIDEuMCAtICggMS4wIC0gdHJhbnNtaXR0ZWRMaWdodC5hICkgKiB0cmFuc21pdHRhbmNlRmFjdG9yICk7XG5cdH1cbiNlbmRpZiI7Cgp2YXIgdXZfcGFyc19mcmFnbWVudCA9ICIjaWYgZGVmaW5lZCggVVNFX1VWICkgfHwgZGVmaW5lZCggVVNFX0FOSVNPVFJPUFkgKVxuXHR2YXJ5aW5nIHZlYzIgdlV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX01BUFxuXHR2YXJ5aW5nIHZlYzIgdk1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0FMUEhBTUFQXG5cdHZhcnlpbmcgdmVjMiB2QWxwaGFNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9MSUdIVE1BUFxuXHR2YXJ5aW5nIHZlYzIgdkxpZ2h0TWFwVXY7XG4jZW5kaWZcbiNpZmRlZiBVU0VfQU9NQVBcblx0dmFyeWluZyB2ZWMyIHZBb01hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0JVTVBNQVBcblx0dmFyeWluZyB2ZWMyIHZCdW1wTWFwVXY7XG4jZW5kaWZcbiNpZmRlZiBVU0VfTk9STUFMTUFQXG5cdHZhcnlpbmcgdmVjMiB2Tm9ybWFsTWFwVXY7XG4jZW5kaWZcbiNpZmRlZiBVU0VfRU1JU1NJVkVNQVBcblx0dmFyeWluZyB2ZWMyIHZFbWlzc2l2ZU1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX01FVEFMTkVTU01BUFxuXHR2YXJ5aW5nIHZlYzIgdk1ldGFsbmVzc01hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX1JPVUdITkVTU01BUFxuXHR2YXJ5aW5nIHZlYzIgdlJvdWdobmVzc01hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0FOSVNPVFJPUFlNQVBcblx0dmFyeWluZyB2ZWMyIHZBbmlzb3Ryb3B5TWFwVXY7XG4jZW5kaWZcbiNpZmRlZiBVU0VfQ0xFQVJDT0FUTUFQXG5cdHZhcnlpbmcgdmVjMiB2Q2xlYXJjb2F0TWFwVXY7XG4jZW5kaWZcbiNpZmRlZiBVU0VfQ0xFQVJDT0FUX05PUk1BTE1BUFxuXHR2YXJ5aW5nIHZlYzIgdkNsZWFyY29hdE5vcm1hbE1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0NMRUFSQ09BVF9ST1VHSE5FU1NNQVBcblx0dmFyeWluZyB2ZWMyIHZDbGVhcmNvYXRSb3VnaG5lc3NNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9JUklERVNDRU5DRU1BUFxuXHR2YXJ5aW5nIHZlYzIgdklyaWRlc2NlbmNlTWFwVXY7XG4jZW5kaWZcbiNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VfVEhJQ0tORVNTTUFQXG5cdHZhcnlpbmcgdmVjMiB2SXJpZGVzY2VuY2VUaGlja25lc3NNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9TSEVFTl9DT0xPUk1BUFxuXHR2YXJ5aW5nIHZlYzIgdlNoZWVuQ29sb3JNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9TSEVFTl9ST1VHSE5FU1NNQVBcblx0dmFyeWluZyB2ZWMyIHZTaGVlblJvdWdobmVzc01hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX1NQRUNVTEFSTUFQXG5cdHZhcnlpbmcgdmVjMiB2U3BlY3VsYXJNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9TUEVDVUxBUl9DT0xPUk1BUFxuXHR2YXJ5aW5nIHZlYzIgdlNwZWN1bGFyQ29sb3JNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9TUEVDVUxBUl9JTlRFTlNJVFlNQVBcblx0dmFyeWluZyB2ZWMyIHZTcGVjdWxhckludGVuc2l0eU1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX1RSQU5TTUlTU0lPTk1BUFxuXHR1bmlmb3JtIG1hdDMgdHJhbnNtaXNzaW9uTWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdlRyYW5zbWlzc2lvbk1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX1RISUNLTkVTU01BUFxuXHR1bmlmb3JtIG1hdDMgdGhpY2tuZXNzTWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdlRoaWNrbmVzc01hcFV2O1xuI2VuZGlmIjsKCnZhciB1dl9wYXJzX3ZlcnRleCA9ICIjaWYgZGVmaW5lZCggVVNFX1VWICkgfHwgZGVmaW5lZCggVVNFX0FOSVNPVFJPUFkgKVxuXHR2YXJ5aW5nIHZlYzIgdlV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX01BUFxuXHR1bmlmb3JtIG1hdDMgbWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdk1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0FMUEhBTUFQXG5cdHVuaWZvcm0gbWF0MyBhbHBoYU1hcFRyYW5zZm9ybTtcblx0dmFyeWluZyB2ZWMyIHZBbHBoYU1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0xJR0hUTUFQXG5cdHVuaWZvcm0gbWF0MyBsaWdodE1hcFRyYW5zZm9ybTtcblx0dmFyeWluZyB2ZWMyIHZMaWdodE1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0FPTUFQXG5cdHVuaWZvcm0gbWF0MyBhb01hcFRyYW5zZm9ybTtcblx0dmFyeWluZyB2ZWMyIHZBb01hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0JVTVBNQVBcblx0dW5pZm9ybSBtYXQzIGJ1bXBNYXBUcmFuc2Zvcm07XG5cdHZhcnlpbmcgdmVjMiB2QnVtcE1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX05PUk1BTE1BUFxuXHR1bmlmb3JtIG1hdDMgbm9ybWFsTWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdk5vcm1hbE1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0RJU1BMQUNFTUVOVE1BUFxuXHR1bmlmb3JtIG1hdDMgZGlzcGxhY2VtZW50TWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdkRpc3BsYWNlbWVudE1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0VNSVNTSVZFTUFQXG5cdHVuaWZvcm0gbWF0MyBlbWlzc2l2ZU1hcFRyYW5zZm9ybTtcblx0dmFyeWluZyB2ZWMyIHZFbWlzc2l2ZU1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX01FVEFMTkVTU01BUFxuXHR1bmlmb3JtIG1hdDMgbWV0YWxuZXNzTWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdk1ldGFsbmVzc01hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX1JPVUdITkVTU01BUFxuXHR1bmlmb3JtIG1hdDMgcm91Z2huZXNzTWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdlJvdWdobmVzc01hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0FOSVNPVFJPUFlNQVBcblx0dW5pZm9ybSBtYXQzIGFuaXNvdHJvcHlNYXBUcmFuc2Zvcm07XG5cdHZhcnlpbmcgdmVjMiB2QW5pc290cm9weU1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0NMRUFSQ09BVE1BUFxuXHR1bmlmb3JtIG1hdDMgY2xlYXJjb2F0TWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdkNsZWFyY29hdE1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0NMRUFSQ09BVF9OT1JNQUxNQVBcblx0dW5pZm9ybSBtYXQzIGNsZWFyY29hdE5vcm1hbE1hcFRyYW5zZm9ybTtcblx0dmFyeWluZyB2ZWMyIHZDbGVhcmNvYXROb3JtYWxNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9DTEVBUkNPQVRfUk9VR0hORVNTTUFQXG5cdHVuaWZvcm0gbWF0MyBjbGVhcmNvYXRSb3VnaG5lc3NNYXBUcmFuc2Zvcm07XG5cdHZhcnlpbmcgdmVjMiB2Q2xlYXJjb2F0Um91Z2huZXNzTWFwVXY7XG4jZW5kaWZcbiNpZmRlZiBVU0VfU0hFRU5fQ09MT1JNQVBcblx0dW5pZm9ybSBtYXQzIHNoZWVuQ29sb3JNYXBUcmFuc2Zvcm07XG5cdHZhcnlpbmcgdmVjMiB2U2hlZW5Db2xvck1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX1NIRUVOX1JPVUdITkVTU01BUFxuXHR1bmlmb3JtIG1hdDMgc2hlZW5Sb3VnaG5lc3NNYXBUcmFuc2Zvcm07XG5cdHZhcnlpbmcgdmVjMiB2U2hlZW5Sb3VnaG5lc3NNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9JUklERVNDRU5DRU1BUFxuXHR1bmlmb3JtIG1hdDMgaXJpZGVzY2VuY2VNYXBUcmFuc2Zvcm07XG5cdHZhcnlpbmcgdmVjMiB2SXJpZGVzY2VuY2VNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9JUklERVNDRU5DRV9USElDS05FU1NNQVBcblx0dW5pZm9ybSBtYXQzIGlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdklyaWRlc2NlbmNlVGhpY2tuZXNzTWFwVXY7XG4jZW5kaWZcbiNpZmRlZiBVU0VfU1BFQ1VMQVJNQVBcblx0dW5pZm9ybSBtYXQzIHNwZWN1bGFyTWFwVHJhbnNmb3JtO1xuXHR2YXJ5aW5nIHZlYzIgdlNwZWN1bGFyTWFwVXY7XG4jZW5kaWZcbiNpZmRlZiBVU0VfU1BFQ1VMQVJfQ09MT1JNQVBcblx0dW5pZm9ybSBtYXQzIHNwZWN1bGFyQ29sb3JNYXBUcmFuc2Zvcm07XG5cdHZhcnlpbmcgdmVjMiB2U3BlY3VsYXJDb2xvck1hcFV2O1xuI2VuZGlmXG4jaWZkZWYgVVNFX1NQRUNVTEFSX0lOVEVOU0lUWU1BUFxuXHR1bmlmb3JtIG1hdDMgc3BlY3VsYXJJbnRlbnNpdHlNYXBUcmFuc2Zvcm07XG5cdHZhcnlpbmcgdmVjMiB2U3BlY3VsYXJJbnRlbnNpdHlNYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9UUkFOU01JU1NJT05NQVBcblx0dW5pZm9ybSBtYXQzIHRyYW5zbWlzc2lvbk1hcFRyYW5zZm9ybTtcblx0dmFyeWluZyB2ZWMyIHZUcmFuc21pc3Npb25NYXBVdjtcbiNlbmRpZlxuI2lmZGVmIFVTRV9USElDS05FU1NNQVBcblx0dW5pZm9ybSBtYXQzIHRoaWNrbmVzc01hcFRyYW5zZm9ybTtcblx0dmFyeWluZyB2ZWMyIHZUaGlja25lc3NNYXBVdjtcbiNlbmRpZiI7Cgp2YXIgdXZfdmVydGV4ID0gIiNpZiBkZWZpbmVkKCBVU0VfVVYgKSB8fCBkZWZpbmVkKCBVU0VfQU5JU09UUk9QWSApXG5cdHZVdiA9IHZlYzMoIHV2LCAxICkueHk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfTUFQXG5cdHZNYXBVdiA9ICggbWFwVHJhbnNmb3JtICogdmVjMyggTUFQX1VWLCAxICkgKS54eTtcbiNlbmRpZlxuI2lmZGVmIFVTRV9BTFBIQU1BUFxuXHR2QWxwaGFNYXBVdiA9ICggYWxwaGFNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBBTFBIQU1BUF9VViwgMSApICkueHk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfTElHSFRNQVBcblx0dkxpZ2h0TWFwVXYgPSAoIGxpZ2h0TWFwVHJhbnNmb3JtICogdmVjMyggTElHSFRNQVBfVVYsIDEgKSApLnh5O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0FPTUFQXG5cdHZBb01hcFV2ID0gKCBhb01hcFRyYW5zZm9ybSAqIHZlYzMoIEFPTUFQX1VWLCAxICkgKS54eTtcbiNlbmRpZlxuI2lmZGVmIFVTRV9CVU1QTUFQXG5cdHZCdW1wTWFwVXYgPSAoIGJ1bXBNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBCVU1QTUFQX1VWLCAxICkgKS54eTtcbiNlbmRpZlxuI2lmZGVmIFVTRV9OT1JNQUxNQVBcblx0dk5vcm1hbE1hcFV2ID0gKCBub3JtYWxNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBOT1JNQUxNQVBfVVYsIDEgKSApLnh5O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0RJU1BMQUNFTUVOVE1BUFxuXHR2RGlzcGxhY2VtZW50TWFwVXYgPSAoIGRpc3BsYWNlbWVudE1hcFRyYW5zZm9ybSAqIHZlYzMoIERJU1BMQUNFTUVOVE1BUF9VViwgMSApICkueHk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfRU1JU1NJVkVNQVBcblx0dkVtaXNzaXZlTWFwVXYgPSAoIGVtaXNzaXZlTWFwVHJhbnNmb3JtICogdmVjMyggRU1JU1NJVkVNQVBfVVYsIDEgKSApLnh5O1xuI2VuZGlmXG4jaWZkZWYgVVNFX01FVEFMTkVTU01BUFxuXHR2TWV0YWxuZXNzTWFwVXYgPSAoIG1ldGFsbmVzc01hcFRyYW5zZm9ybSAqIHZlYzMoIE1FVEFMTkVTU01BUF9VViwgMSApICkueHk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfUk9VR0hORVNTTUFQXG5cdHZSb3VnaG5lc3NNYXBVdiA9ICggcm91Z2huZXNzTWFwVHJhbnNmb3JtICogdmVjMyggUk9VR0hORVNTTUFQX1VWLCAxICkgKS54eTtcbiNlbmRpZlxuI2lmZGVmIFVTRV9BTklTT1RST1BZTUFQXG5cdHZBbmlzb3Ryb3B5TWFwVXYgPSAoIGFuaXNvdHJvcHlNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBBTklTT1RST1BZTUFQX1VWLCAxICkgKS54eTtcbiNlbmRpZlxuI2lmZGVmIFVTRV9DTEVBUkNPQVRNQVBcblx0dkNsZWFyY29hdE1hcFV2ID0gKCBjbGVhcmNvYXRNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBDTEVBUkNPQVRNQVBfVVYsIDEgKSApLnh5O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0NMRUFSQ09BVF9OT1JNQUxNQVBcblx0dkNsZWFyY29hdE5vcm1hbE1hcFV2ID0gKCBjbGVhcmNvYXROb3JtYWxNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBDTEVBUkNPQVRfTk9STUFMTUFQX1VWLCAxICkgKS54eTtcbiNlbmRpZlxuI2lmZGVmIFVTRV9DTEVBUkNPQVRfUk9VR0hORVNTTUFQXG5cdHZDbGVhcmNvYXRSb3VnaG5lc3NNYXBVdiA9ICggY2xlYXJjb2F0Um91Z2huZXNzTWFwVHJhbnNmb3JtICogdmVjMyggQ0xFQVJDT0FUX1JPVUdITkVTU01BUF9VViwgMSApICkueHk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfSVJJREVTQ0VOQ0VNQVBcblx0dklyaWRlc2NlbmNlTWFwVXYgPSAoIGlyaWRlc2NlbmNlTWFwVHJhbnNmb3JtICogdmVjMyggSVJJREVTQ0VOQ0VNQVBfVVYsIDEgKSApLnh5O1xuI2VuZGlmXG4jaWZkZWYgVVNFX0lSSURFU0NFTkNFX1RISUNLTkVTU01BUFxuXHR2SXJpZGVzY2VuY2VUaGlja25lc3NNYXBVdiA9ICggaXJpZGVzY2VuY2VUaGlja25lc3NNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBJUklERVNDRU5DRV9USElDS05FU1NNQVBfVVYsIDEgKSApLnh5O1xuI2VuZGlmXG4jaWZkZWYgVVNFX1NIRUVOX0NPTE9STUFQXG5cdHZTaGVlbkNvbG9yTWFwVXYgPSAoIHNoZWVuQ29sb3JNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBTSEVFTl9DT0xPUk1BUF9VViwgMSApICkueHk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfU0hFRU5fUk9VR0hORVNTTUFQXG5cdHZTaGVlblJvdWdobmVzc01hcFV2ID0gKCBzaGVlblJvdWdobmVzc01hcFRyYW5zZm9ybSAqIHZlYzMoIFNIRUVOX1JPVUdITkVTU01BUF9VViwgMSApICkueHk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfU1BFQ1VMQVJNQVBcblx0dlNwZWN1bGFyTWFwVXYgPSAoIHNwZWN1bGFyTWFwVHJhbnNmb3JtICogdmVjMyggU1BFQ1VMQVJNQVBfVVYsIDEgKSApLnh5O1xuI2VuZGlmXG4jaWZkZWYgVVNFX1NQRUNVTEFSX0NPTE9STUFQXG5cdHZTcGVjdWxhckNvbG9yTWFwVXYgPSAoIHNwZWN1bGFyQ29sb3JNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBTUEVDVUxBUl9DT0xPUk1BUF9VViwgMSApICkueHk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfU1BFQ1VMQVJfSU5URU5TSVRZTUFQXG5cdHZTcGVjdWxhckludGVuc2l0eU1hcFV2ID0gKCBzcGVjdWxhckludGVuc2l0eU1hcFRyYW5zZm9ybSAqIHZlYzMoIFNQRUNVTEFSX0lOVEVOU0lUWU1BUF9VViwgMSApICkueHk7XG4jZW5kaWZcbiNpZmRlZiBVU0VfVFJBTlNNSVNTSU9OTUFQXG5cdHZUcmFuc21pc3Npb25NYXBVdiA9ICggdHJhbnNtaXNzaW9uTWFwVHJhbnNmb3JtICogdmVjMyggVFJBTlNNSVNTSU9OTUFQX1VWLCAxICkgKS54eTtcbiNlbmRpZlxuI2lmZGVmIFVTRV9USElDS05FU1NNQVBcblx0dlRoaWNrbmVzc01hcFV2ID0gKCB0aGlja25lc3NNYXBUcmFuc2Zvcm0gKiB2ZWMzKCBUSElDS05FU1NNQVBfVVYsIDEgKSApLnh5O1xuI2VuZGlmIjsKCnZhciB3b3JsZHBvc192ZXJ0ZXggPSAiI2lmIGRlZmluZWQoIFVTRV9FTlZNQVAgKSB8fCBkZWZpbmVkKCBESVNUQU5DRSApIHx8IGRlZmluZWQgKCBVU0VfU0hBRE9XTUFQICkgfHwgZGVmaW5lZCAoIFVTRV9UUkFOU01JU1NJT04gKSB8fCBOVU1fU1BPVF9MSUdIVF9DT09SRFMgPiAwXG5cdHZlYzQgd29ybGRQb3NpdGlvbiA9IHZlYzQoIHRyYW5zZm9ybWVkLCAxLjAgKTtcblx0I2lmZGVmIFVTRV9CQVRDSElOR1xuXHRcdHdvcmxkUG9zaXRpb24gPSBiYXRjaGluZ01hdHJpeCAqIHdvcmxkUG9zaXRpb247XG5cdCNlbmRpZlxuXHQjaWZkZWYgVVNFX0lOU1RBTkNJTkdcblx0XHR3b3JsZFBvc2l0aW9uID0gaW5zdGFuY2VNYXRyaXggKiB3b3JsZFBvc2l0aW9uO1xuXHQjZW5kaWZcblx0d29ybGRQb3NpdGlvbiA9IG1vZGVsTWF0cml4ICogd29ybGRQb3NpdGlvbjtcbiNlbmRpZiI7Cgpjb25zdCB2ZXJ0ZXgkaCA9ICJ2YXJ5aW5nIHZlYzIgdlV2O1xudW5pZm9ybSBtYXQzIHV2VHJhbnNmb3JtO1xudm9pZCBtYWluKCkge1xuXHR2VXYgPSAoIHV2VHJhbnNmb3JtICogdmVjMyggdXYsIDEgKSApLnh5O1xuXHRnbF9Qb3NpdGlvbiA9IHZlYzQoIHBvc2l0aW9uLnh5LCAxLjAsIDEuMCApO1xufSI7Cgpjb25zdCBmcmFnbWVudCRoID0gInVuaWZvcm0gc2FtcGxlcjJEIHQyRDtcbnVuaWZvcm0gZmxvYXQgYmFja2dyb3VuZEludGVuc2l0eTtcbnZhcnlpbmcgdmVjMiB2VXY7XG52b2lkIG1haW4oKSB7XG5cdHZlYzQgdGV4Q29sb3IgPSB0ZXh0dXJlMkQoIHQyRCwgdlV2ICk7XG5cdCNpZmRlZiBERUNPREVfVklERU9fVEVYVFVSRVxuXHRcdHRleENvbG9yID0gdmVjNCggbWl4KCBwb3coIHRleENvbG9yLnJnYiAqIDAuOTQ3ODY3Mjk4NiArIHZlYzMoIDAuMDUyMTMyNzAxNCApLCB2ZWMzKCAyLjQgKSApLCB0ZXhDb2xvci5yZ2IgKiAwLjA3NzM5OTM4MDgsIHZlYzMoIGxlc3NUaGFuRXF1YWwoIHRleENvbG9yLnJnYiwgdmVjMyggMC4wNDA0NSApICkgKSApLCB0ZXhDb2xvci53ICk7XG5cdCNlbmRpZlxuXHR0ZXhDb2xvci5yZ2IgKj0gYmFja2dyb3VuZEludGVuc2l0eTtcblx0Z2xfRnJhZ0NvbG9yID0gdGV4Q29sb3I7XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG59IjsKCmNvbnN0IHZlcnRleCRnID0gInZhcnlpbmcgdmVjMyB2V29ybGREaXJlY3Rpb247XG4jaW5jbHVkZSA8Y29tbW9uPlxudm9pZCBtYWluKCkge1xuXHR2V29ybGREaXJlY3Rpb24gPSB0cmFuc2Zvcm1EaXJlY3Rpb24oIHBvc2l0aW9uLCBtb2RlbE1hdHJpeCApO1xuXHQjaW5jbHVkZSA8YmVnaW5fdmVydGV4PlxuXHQjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+XG5cdGdsX1Bvc2l0aW9uLnogPSBnbF9Qb3NpdGlvbi53O1xufSI7Cgpjb25zdCBmcmFnbWVudCRnID0gIiNpZmRlZiBFTlZNQVBfVFlQRV9DVUJFXG5cdHVuaWZvcm0gc2FtcGxlckN1YmUgZW52TWFwO1xuI2VsaWYgZGVmaW5lZCggRU5WTUFQX1RZUEVfQ1VCRV9VViApXG5cdHVuaWZvcm0gc2FtcGxlcjJEIGVudk1hcDtcbiNlbmRpZlxudW5pZm9ybSBmbG9hdCBmbGlwRW52TWFwO1xudW5pZm9ybSBmbG9hdCBiYWNrZ3JvdW5kQmx1cnJpbmVzcztcbnVuaWZvcm0gZmxvYXQgYmFja2dyb3VuZEludGVuc2l0eTtcbnZhcnlpbmcgdmVjMyB2V29ybGREaXJlY3Rpb247XG4jaW5jbHVkZSA8Y3ViZV91dl9yZWZsZWN0aW9uX2ZyYWdtZW50Plxudm9pZCBtYWluKCkge1xuXHQjaWZkZWYgRU5WTUFQX1RZUEVfQ1VCRVxuXHRcdHZlYzQgdGV4Q29sb3IgPSB0ZXh0dXJlQ3ViZSggZW52TWFwLCB2ZWMzKCBmbGlwRW52TWFwICogdldvcmxkRGlyZWN0aW9uLngsIHZXb3JsZERpcmVjdGlvbi55eiApICk7XG5cdCNlbGlmIGRlZmluZWQoIEVOVk1BUF9UWVBFX0NVQkVfVVYgKVxuXHRcdHZlYzQgdGV4Q29sb3IgPSB0ZXh0dXJlQ3ViZVVWKCBlbnZNYXAsIHZXb3JsZERpcmVjdGlvbiwgYmFja2dyb3VuZEJsdXJyaW5lc3MgKTtcblx0I2Vsc2Vcblx0XHR2ZWM0IHRleENvbG9yID0gdmVjNCggMC4wLCAwLjAsIDAuMCwgMS4wICk7XG5cdCNlbmRpZlxuXHR0ZXhDb2xvci5yZ2IgKj0gYmFja2dyb3VuZEludGVuc2l0eTtcblx0Z2xfRnJhZ0NvbG9yID0gdGV4Q29sb3I7XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG59IjsKCmNvbnN0IHZlcnRleCRmID0gInZhcnlpbmcgdmVjMyB2V29ybGREaXJlY3Rpb247XG4jaW5jbHVkZSA8Y29tbW9uPlxudm9pZCBtYWluKCkge1xuXHR2V29ybGREaXJlY3Rpb24gPSB0cmFuc2Zvcm1EaXJlY3Rpb24oIHBvc2l0aW9uLCBtb2RlbE1hdHJpeCApO1xuXHQjaW5jbHVkZSA8YmVnaW5fdmVydGV4PlxuXHQjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+XG5cdGdsX1Bvc2l0aW9uLnogPSBnbF9Qb3NpdGlvbi53O1xufSI7Cgpjb25zdCBmcmFnbWVudCRmID0gInVuaWZvcm0gc2FtcGxlckN1YmUgdEN1YmU7XG51bmlmb3JtIGZsb2F0IHRGbGlwO1xudW5pZm9ybSBmbG9hdCBvcGFjaXR5O1xudmFyeWluZyB2ZWMzIHZXb3JsZERpcmVjdGlvbjtcbnZvaWQgbWFpbigpIHtcblx0dmVjNCB0ZXhDb2xvciA9IHRleHR1cmVDdWJlKCB0Q3ViZSwgdmVjMyggdEZsaXAgKiB2V29ybGREaXJlY3Rpb24ueCwgdldvcmxkRGlyZWN0aW9uLnl6ICkgKTtcblx0Z2xfRnJhZ0NvbG9yID0gdGV4Q29sb3I7XG5cdGdsX0ZyYWdDb2xvci5hICo9IG9wYWNpdHk7XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG59IjsKCmNvbnN0IHZlcnRleCRlID0gIiNpbmNsdWRlIDxjb21tb24+XG4jaW5jbHVkZSA8YmF0Y2hpbmdfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8dXZfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPHNraW5uaW5nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD5cbnZhcnlpbmcgdmVjMiB2SGlnaFByZWNpc2lvblpXO1xudm9pZCBtYWluKCkge1xuXHQjaW5jbHVkZSA8dXZfdmVydGV4PlxuXHQjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PlxuXHQjaWZkZWYgVVNFX0RJU1BMQUNFTUVOVE1BUFxuXHRcdCNpbmNsdWRlIDxiZWdpbm5vcm1hbF92ZXJ0ZXg+XG5cdFx0I2luY2x1ZGUgPG1vcnBobm9ybWFsX3ZlcnRleD5cblx0XHQjaW5jbHVkZSA8c2tpbm5vcm1hbF92ZXJ0ZXg+XG5cdCNlbmRpZlxuXHQjaW5jbHVkZSA8YmVnaW5fdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGh0YXJnZXRfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2tpbm5pbmdfdmVydGV4PlxuXHQjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD5cblx0I2luY2x1ZGUgPHByb2plY3RfdmVydGV4PlxuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfdmVydGV4PlxuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD5cblx0dkhpZ2hQcmVjaXNpb25aVyA9IGdsX1Bvc2l0aW9uLnp3O1xufSI7Cgpjb25zdCBmcmFnbWVudCRlID0gIiNpZiBERVBUSF9QQUNLSU5HID09IDMyMDBcblx0dW5pZm9ybSBmbG9hdCBvcGFjaXR5O1xuI2VuZGlmXG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPHBhY2tpbmc+XG4jaW5jbHVkZSA8dXZfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYW1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhaGFzaF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+XG52YXJ5aW5nIHZlYzIgdkhpZ2hQcmVjaXNpb25aVztcbnZvaWQgbWFpbigpIHtcblx0dmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCAxLjAgKTtcblx0I2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD5cblx0I2lmIERFUFRIX1BBQ0tJTkcgPT0gMzIwMFxuXHRcdGRpZmZ1c2VDb2xvci5hID0gb3BhY2l0eTtcblx0I2VuZGlmXG5cdCNpbmNsdWRlIDxtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxhbHBoYW1hcF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhdGVzdF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGxvZ2RlcHRoYnVmX2ZyYWdtZW50PlxuXHRmbG9hdCBmcmFnQ29vcmRaID0gMC41ICogdkhpZ2hQcmVjaXNpb25aV1swXSAvIHZIaWdoUHJlY2lzaW9uWldbMV0gKyAwLjU7XG5cdCNpZiBERVBUSF9QQUNLSU5HID09IDMyMDBcblx0XHRnbF9GcmFnQ29sb3IgPSB2ZWM0KCB2ZWMzKCAxLjAgLSBmcmFnQ29vcmRaICksIG9wYWNpdHkgKTtcblx0I2VsaWYgREVQVEhfUEFDS0lORyA9PSAzMjAxXG5cdFx0Z2xfRnJhZ0NvbG9yID0gcGFja0RlcHRoVG9SR0JBKCBmcmFnQ29vcmRaICk7XG5cdCNlbmRpZlxufSI7Cgpjb25zdCB2ZXJ0ZXgkZCA9ICIjZGVmaW5lIERJU1RBTkNFXG52YXJ5aW5nIHZlYzMgdldvcmxkUG9zaXRpb247XG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPHV2X3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGRpc3BsYWNlbWVudG1hcF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxtb3JwaHRhcmdldF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxza2lubmluZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc192ZXJ0ZXg+XG52b2lkIG1haW4oKSB7XG5cdCNpbmNsdWRlIDx1dl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiYXRjaGluZ192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2luYmFzZV92ZXJ0ZXg+XG5cdCNpZmRlZiBVU0VfRElTUExBQ0VNRU5UTUFQXG5cdFx0I2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD5cblx0XHQjaW5jbHVkZSA8bW9ycGhub3JtYWxfdmVydGV4PlxuXHRcdCNpbmNsdWRlIDxza2lubm9ybWFsX3ZlcnRleD5cblx0I2VuZGlmXG5cdCNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxtb3JwaHRhcmdldF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfdmVydGV4PlxuXHQjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDx3b3JsZHBvc192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfdmVydGV4PlxuXHR2V29ybGRQb3NpdGlvbiA9IHdvcmxkUG9zaXRpb24ueHl6O1xufSI7Cgpjb25zdCBmcmFnbWVudCRkID0gIiNkZWZpbmUgRElTVEFOQ0VcbnVuaWZvcm0gdmVjMyByZWZlcmVuY2VQb3NpdGlvbjtcbnVuaWZvcm0gZmxvYXQgbmVhckRpc3RhbmNlO1xudW5pZm9ybSBmbG9hdCBmYXJEaXN0YW5jZTtcbnZhcnlpbmcgdmVjMyB2V29ybGRQb3NpdGlvbjtcbiNpbmNsdWRlIDxjb21tb24+XG4jaW5jbHVkZSA8cGFja2luZz5cbiNpbmNsdWRlIDx1dl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhbWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YWxwaGF0ZXN0X3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YWxwaGFoYXNoX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+XG52b2lkIG1haW4gKCkge1xuXHR2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIDEuMCApO1xuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8YWxwaGFtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxhbHBoYXRlc3RfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxhbHBoYWhhc2hfZnJhZ21lbnQ+XG5cdGZsb2F0IGRpc3QgPSBsZW5ndGgoIHZXb3JsZFBvc2l0aW9uIC0gcmVmZXJlbmNlUG9zaXRpb24gKTtcblx0ZGlzdCA9ICggZGlzdCAtIG5lYXJEaXN0YW5jZSApIC8gKCBmYXJEaXN0YW5jZSAtIG5lYXJEaXN0YW5jZSApO1xuXHRkaXN0ID0gc2F0dXJhdGUoIGRpc3QgKTtcblx0Z2xfRnJhZ0NvbG9yID0gcGFja0RlcHRoVG9SR0JBKCBkaXN0ICk7XG59IjsKCmNvbnN0IHZlcnRleCRjID0gInZhcnlpbmcgdmVjMyB2V29ybGREaXJlY3Rpb247XG4jaW5jbHVkZSA8Y29tbW9uPlxudm9pZCBtYWluKCkge1xuXHR2V29ybGREaXJlY3Rpb24gPSB0cmFuc2Zvcm1EaXJlY3Rpb24oIHBvc2l0aW9uLCBtb2RlbE1hdHJpeCApO1xuXHQjaW5jbHVkZSA8YmVnaW5fdmVydGV4PlxuXHQjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+XG59IjsKCmNvbnN0IGZyYWdtZW50JGMgPSAidW5pZm9ybSBzYW1wbGVyMkQgdEVxdWlyZWN0O1xudmFyeWluZyB2ZWMzIHZXb3JsZERpcmVjdGlvbjtcbiNpbmNsdWRlIDxjb21tb24+XG52b2lkIG1haW4oKSB7XG5cdHZlYzMgZGlyZWN0aW9uID0gbm9ybWFsaXplKCB2V29ybGREaXJlY3Rpb24gKTtcblx0dmVjMiBzYW1wbGVVViA9IGVxdWlyZWN0VXYoIGRpcmVjdGlvbiApO1xuXHRnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQoIHRFcXVpcmVjdCwgc2FtcGxlVVYgKTtcblx0I2luY2x1ZGUgPHRvbmVtYXBwaW5nX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8Y29sb3JzcGFjZV9mcmFnbWVudD5cbn0iOwoKY29uc3QgdmVydGV4JGIgPSAidW5pZm9ybSBmbG9hdCBzY2FsZTtcbmF0dHJpYnV0ZSBmbG9hdCBsaW5lRGlzdGFuY2U7XG52YXJ5aW5nIGZsb2F0IHZMaW5lRGlzdGFuY2U7XG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPHV2X3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGNvbG9yX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxtb3JwaHRhcmdldF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc192ZXJ0ZXg+XG52b2lkIG1haW4oKSB7XG5cdHZMaW5lRGlzdGFuY2UgPSBzY2FsZSAqIGxpbmVEaXN0YW5jZTtcblx0I2luY2x1ZGUgPHV2X3ZlcnRleD5cblx0I2luY2x1ZGUgPGNvbG9yX3ZlcnRleD5cblx0I2luY2x1ZGUgPG1vcnBoY29sb3JfdmVydGV4PlxuXHQjaW5jbHVkZSA8YmVnaW5fdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGh0YXJnZXRfdmVydGV4PlxuXHQjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfdmVydGV4PlxuXHQjaW5jbHVkZSA8Zm9nX3ZlcnRleD5cbn0iOwoKY29uc3QgZnJhZ21lbnQkYiA9ICJ1bmlmb3JtIHZlYzMgZGlmZnVzZTtcbnVuaWZvcm0gZmxvYXQgb3BhY2l0eTtcbnVuaWZvcm0gZmxvYXQgZGFzaFNpemU7XG51bmlmb3JtIGZsb2F0IHRvdGFsU2l6ZTtcbnZhcnlpbmcgZmxvYXQgdkxpbmVEaXN0YW5jZTtcbiNpbmNsdWRlIDxjb21tb24+XG4jaW5jbHVkZSA8Y29sb3JfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDx1dl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGZvZ19wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+XG52b2lkIG1haW4oKSB7XG5cdHZlYzQgZGlmZnVzZUNvbG9yID0gdmVjNCggZGlmZnVzZSwgb3BhY2l0eSApO1xuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50PlxuXHRpZiAoIG1vZCggdkxpbmVEaXN0YW5jZSwgdG90YWxTaXplICkgPiBkYXNoU2l6ZSApIHtcblx0XHRkaXNjYXJkO1xuXHR9XG5cdHZlYzMgb3V0Z29pbmdMaWdodCA9IHZlYzMoIDAuMCApO1xuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD5cblx0b3V0Z29pbmdMaWdodCA9IGRpZmZ1c2VDb2xvci5yZ2I7XG5cdCNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50PlxufSI7Cgpjb25zdCB2ZXJ0ZXgkYSA9ICIjaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPHV2X3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGVudm1hcF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxmb2dfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bW9ycGh0YXJnZXRfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8c2tpbm5pbmdfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4Plxudm9pZCBtYWluKCkge1xuXHQjaW5jbHVkZSA8dXZfdmVydGV4PlxuXHQjaW5jbHVkZSA8Y29sb3JfdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiYXRjaGluZ192ZXJ0ZXg+XG5cdCNpZiBkZWZpbmVkICggVVNFX0VOVk1BUCApIHx8IGRlZmluZWQgKCBVU0VfU0tJTk5JTkcgKVxuXHRcdCNpbmNsdWRlIDxiZWdpbm5vcm1hbF92ZXJ0ZXg+XG5cdFx0I2luY2x1ZGUgPG1vcnBobm9ybWFsX3ZlcnRleD5cblx0XHQjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PlxuXHRcdCNpbmNsdWRlIDxza2lubm9ybWFsX3ZlcnRleD5cblx0XHQjaW5jbHVkZSA8ZGVmYXVsdG5vcm1hbF92ZXJ0ZXg+XG5cdCNlbmRpZlxuXHQjaW5jbHVkZSA8YmVnaW5fdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGh0YXJnZXRfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2tpbm5pbmdfdmVydGV4PlxuXHQjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfdmVydGV4PlxuXHQjaW5jbHVkZSA8d29ybGRwb3NfdmVydGV4PlxuXHQjaW5jbHVkZSA8ZW52bWFwX3ZlcnRleD5cblx0I2luY2x1ZGUgPGZvZ192ZXJ0ZXg+XG59IjsKCmNvbnN0IGZyYWdtZW50JGEgPSAidW5pZm9ybSB2ZWMzIGRpZmZ1c2U7XG51bmlmb3JtIGZsb2F0IG9wYWNpdHk7XG4jaWZuZGVmIEZMQVRfU0hBREVEXG5cdHZhcnlpbmcgdmVjMyB2Tm9ybWFsO1xuI2VuZGlmXG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPGRpdGhlcmluZ19wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGNvbG9yX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8dXZfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYW1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhaGFzaF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFvbWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bGlnaHRtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxlbnZtYXBfY29tbW9uX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8ZW52bWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Zm9nX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8c3BlY3VsYXJtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50Plxudm9pZCBtYWluKCkge1xuXHR2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTtcblx0I2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGxvZ2RlcHRoYnVmX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8Y29sb3JfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxhbHBoYW1hcF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhdGVzdF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPHNwZWN1bGFybWFwX2ZyYWdtZW50PlxuXHRSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCA9IFJlZmxlY3RlZExpZ2h0KCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICksIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSApO1xuXHQjaWZkZWYgVVNFX0xJR0hUTUFQXG5cdFx0dmVjNCBsaWdodE1hcFRleGVsID0gdGV4dHVyZTJEKCBsaWdodE1hcCwgdkxpZ2h0TWFwVXYgKTtcblx0XHRyZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKz0gbGlnaHRNYXBUZXhlbC5yZ2IgKiBsaWdodE1hcEludGVuc2l0eSAqIFJFQ0lQUk9DQUxfUEk7XG5cdCNlbHNlXG5cdFx0cmVmbGVjdGVkTGlnaHQuaW5kaXJlY3REaWZmdXNlICs9IHZlYzMoIDEuMCApO1xuXHQjZW5kaWZcblx0I2luY2x1ZGUgPGFvbWFwX2ZyYWdtZW50PlxuXHRyZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKj0gZGlmZnVzZUNvbG9yLnJnYjtcblx0dmVjMyBvdXRnb2luZ0xpZ2h0ID0gcmVmbGVjdGVkTGlnaHQuaW5kaXJlY3REaWZmdXNlO1xuXHQjaW5jbHVkZSA8ZW52bWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8b3BhcXVlX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxjb2xvcnNwYWNlX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8Zm9nX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8cHJlbXVsdGlwbGllZF9hbHBoYV9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGRpdGhlcmluZ19mcmFnbWVudD5cbn0iOwoKY29uc3QgdmVydGV4JDkgPSAiI2RlZmluZSBMQU1CRVJUXG52YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjtcbiNpbmNsdWRlIDxjb21tb24+XG4jaW5jbHVkZSA8YmF0Y2hpbmdfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8dXZfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGVudm1hcF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxmb2dfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bm9ybWFsX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPHNraW5uaW5nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPHNoYWRvd21hcF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc192ZXJ0ZXg+XG52b2lkIG1haW4oKSB7XG5cdCNpbmNsdWRlIDx1dl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxjb2xvcl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxtb3JwaGNvbG9yX3ZlcnRleD5cblx0I2luY2x1ZGUgPGJhdGNoaW5nX3ZlcnRleD5cblx0I2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPG1vcnBobm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPHNraW5iYXNlX3ZlcnRleD5cblx0I2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8ZGVmYXVsdG5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8YmVnaW5fdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGh0YXJnZXRfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2tpbm5pbmdfdmVydGV4PlxuXHQjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD5cblx0I2luY2x1ZGUgPHByb2plY3RfdmVydGV4PlxuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfdmVydGV4PlxuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD5cblx0dlZpZXdQb3NpdGlvbiA9IC0gbXZQb3NpdGlvbi54eXo7XG5cdCNpbmNsdWRlIDx3b3JsZHBvc192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxlbnZtYXBfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2hhZG93bWFwX3ZlcnRleD5cblx0I2luY2x1ZGUgPGZvZ192ZXJ0ZXg+XG59IjsKCmNvbnN0IGZyYWdtZW50JDkgPSAiI2RlZmluZSBMQU1CRVJUXG51bmlmb3JtIHZlYzMgZGlmZnVzZTtcbnVuaWZvcm0gdmVjMyBlbWlzc2l2ZTtcbnVuaWZvcm0gZmxvYXQgb3BhY2l0eTtcbiNpbmNsdWRlIDxjb21tb24+XG4jaW5jbHVkZSA8cGFja2luZz5cbiNpbmNsdWRlIDxkaXRoZXJpbmdfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxjb2xvcl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPHV2X3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YWxwaGFtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYXRlc3RfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYWhhc2hfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhb21hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGxpZ2h0bWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8ZW1pc3NpdmVtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxlbnZtYXBfY29tbW9uX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8ZW52bWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Zm9nX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YnNkZnM+XG4jaW5jbHVkZSA8bGlnaHRzX3BhcnNfYmVnaW4+XG4jaW5jbHVkZSA8bm9ybWFsX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bGlnaHRzX2xhbWJlcnRfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxidW1wbWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bm9ybWFsbWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8c3BlY3VsYXJtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50Plxudm9pZCBtYWluKCkge1xuXHR2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTtcblx0I2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD5cblx0UmVmbGVjdGVkTGlnaHQgcmVmbGVjdGVkTGlnaHQgPSBSZWZsZWN0ZWRMaWdodCggdmVjMyggMC4wICksIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICkgKTtcblx0dmVjMyB0b3RhbEVtaXNzaXZlUmFkaWFuY2UgPSBlbWlzc2l2ZTtcblx0I2luY2x1ZGUgPGxvZ2RlcHRoYnVmX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8Y29sb3JfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxhbHBoYW1hcF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhdGVzdF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPHNwZWN1bGFybWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X2JlZ2luPlxuXHQjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X21hcHM+XG5cdCNpbmNsdWRlIDxlbWlzc2l2ZW1hcF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGxpZ2h0c19sYW1iZXJ0X2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X2JlZ2luPlxuXHQjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X21hcHM+XG5cdCNpbmNsdWRlIDxsaWdodHNfZnJhZ21lbnRfZW5kPlxuXHQjaW5jbHVkZSA8YW9tYXBfZnJhZ21lbnQ+XG5cdHZlYzMgb3V0Z29pbmdMaWdodCA9IHJlZmxlY3RlZExpZ2h0LmRpcmVjdERpZmZ1c2UgKyByZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKyB0b3RhbEVtaXNzaXZlUmFkaWFuY2U7XG5cdCNpbmNsdWRlIDxlbnZtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8ZGl0aGVyaW5nX2ZyYWdtZW50PlxufSI7Cgpjb25zdCB2ZXJ0ZXgkOCA9ICIjZGVmaW5lIE1BVENBUFxudmFyeWluZyB2ZWMzIHZWaWV3UG9zaXRpb247XG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPHV2X3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGNvbG9yX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGRpc3BsYWNlbWVudG1hcF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxmb2dfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bm9ybWFsX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPHNraW5uaW5nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD5cbnZvaWQgbWFpbigpIHtcblx0I2luY2x1ZGUgPHV2X3ZlcnRleD5cblx0I2luY2x1ZGUgPGNvbG9yX3ZlcnRleD5cblx0I2luY2x1ZGUgPG1vcnBoY29sb3JfdmVydGV4PlxuXHQjaW5jbHVkZSA8YmF0Y2hpbmdfdmVydGV4PlxuXHQjaW5jbHVkZSA8YmVnaW5ub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGhub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2tpbmJhc2VfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2tpbm5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxkZWZhdWx0bm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPG5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiZWdpbl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxtb3JwaHRhcmdldF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2lubmluZ192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfdmVydGV4PlxuXHQjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfdmVydGV4PlxuXHQjaW5jbHVkZSA8Zm9nX3ZlcnRleD5cblx0dlZpZXdQb3NpdGlvbiA9IC0gbXZQb3NpdGlvbi54eXo7XG59IjsKCmNvbnN0IGZyYWdtZW50JDggPSAiI2RlZmluZSBNQVRDQVBcbnVuaWZvcm0gdmVjMyBkaWZmdXNlO1xudW5pZm9ybSBmbG9hdCBvcGFjaXR5O1xudW5pZm9ybSBzYW1wbGVyMkQgbWF0Y2FwO1xudmFyeWluZyB2ZWMzIHZWaWV3UG9zaXRpb247XG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPGRpdGhlcmluZ19wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGNvbG9yX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8dXZfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYW1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhaGFzaF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGZvZ19wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPG5vcm1hbF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGJ1bXBtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxub3JtYWxtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50Plxudm9pZCBtYWluKCkge1xuXHR2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTtcblx0I2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGxvZ2RlcHRoYnVmX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8Y29sb3JfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxhbHBoYW1hcF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhdGVzdF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPG5vcm1hbF9mcmFnbWVudF9iZWdpbj5cblx0I2luY2x1ZGUgPG5vcm1hbF9mcmFnbWVudF9tYXBzPlxuXHR2ZWMzIHZpZXdEaXIgPSBub3JtYWxpemUoIHZWaWV3UG9zaXRpb24gKTtcblx0dmVjMyB4ID0gbm9ybWFsaXplKCB2ZWMzKCB2aWV3RGlyLnosIDAuMCwgLSB2aWV3RGlyLnggKSApO1xuXHR2ZWMzIHkgPSBjcm9zcyggdmlld0RpciwgeCApO1xuXHR2ZWMyIHV2ID0gdmVjMiggZG90KCB4LCBub3JtYWwgKSwgZG90KCB5LCBub3JtYWwgKSApICogMC40OTUgKyAwLjU7XG5cdCNpZmRlZiBVU0VfTUFUQ0FQXG5cdFx0dmVjNCBtYXRjYXBDb2xvciA9IHRleHR1cmUyRCggbWF0Y2FwLCB1diApO1xuXHQjZWxzZVxuXHRcdHZlYzQgbWF0Y2FwQ29sb3IgPSB2ZWM0KCB2ZWMzKCBtaXgoIDAuMiwgMC44LCB1di55ICkgKSwgMS4wICk7XG5cdCNlbmRpZlxuXHR2ZWMzIG91dGdvaW5nTGlnaHQgPSBkaWZmdXNlQ29sb3IucmdiICogbWF0Y2FwQ29sb3IucmdiO1xuXHQjaW5jbHVkZSA8b3BhcXVlX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8dG9uZW1hcHBpbmdfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxjb2xvcnNwYWNlX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8Zm9nX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8cHJlbXVsdGlwbGllZF9hbHBoYV9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGRpdGhlcmluZ19mcmFnbWVudD5cbn0iOwoKY29uc3QgdmVydGV4JDcgPSAiI2RlZmluZSBOT1JNQUxcbiNpZiBkZWZpbmVkKCBGTEFUX1NIQURFRCApIHx8IGRlZmluZWQoIFVTRV9CVU1QTUFQICkgfHwgZGVmaW5lZCggVVNFX05PUk1BTE1BUF9UQU5HRU5UU1BBQ0UgKVxuXHR2YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjtcbiNlbmRpZlxuI2luY2x1ZGUgPGNvbW1vbj5cbiNpbmNsdWRlIDxiYXRjaGluZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDx1dl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bm9ybWFsX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPHNraW5uaW5nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX3ZlcnRleD5cbnZvaWQgbWFpbigpIHtcblx0I2luY2x1ZGUgPHV2X3ZlcnRleD5cblx0I2luY2x1ZGUgPGJhdGNoaW5nX3ZlcnRleD5cblx0I2luY2x1ZGUgPGJlZ2lubm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPG1vcnBobm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPHNraW5iYXNlX3ZlcnRleD5cblx0I2luY2x1ZGUgPHNraW5ub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8ZGVmYXVsdG5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8YmVnaW5fdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGh0YXJnZXRfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2tpbm5pbmdfdmVydGV4PlxuXHQjaW5jbHVkZSA8ZGlzcGxhY2VtZW50bWFwX3ZlcnRleD5cblx0I2luY2x1ZGUgPHByb2plY3RfdmVydGV4PlxuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfdmVydGV4PlxuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD5cbiNpZiBkZWZpbmVkKCBGTEFUX1NIQURFRCApIHx8IGRlZmluZWQoIFVTRV9CVU1QTUFQICkgfHwgZGVmaW5lZCggVVNFX05PUk1BTE1BUF9UQU5HRU5UU1BBQ0UgKVxuXHR2Vmlld1Bvc2l0aW9uID0gLSBtdlBvc2l0aW9uLnh5ejtcbiNlbmRpZlxufSI7Cgpjb25zdCBmcmFnbWVudCQ3ID0gIiNkZWZpbmUgTk9STUFMXG51bmlmb3JtIGZsb2F0IG9wYWNpdHk7XG4jaWYgZGVmaW5lZCggRkxBVF9TSEFERUQgKSB8fCBkZWZpbmVkKCBVU0VfQlVNUE1BUCApIHx8IGRlZmluZWQoIFVTRV9OT1JNQUxNQVBfVEFOR0VOVFNQQUNFIClcblx0dmFyeWluZyB2ZWMzIHZWaWV3UG9zaXRpb247XG4jZW5kaWZcbiNpbmNsdWRlIDxwYWNraW5nPlxuI2luY2x1ZGUgPHV2X3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bm9ybWFsX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YnVtcG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPG5vcm1hbG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+XG52b2lkIG1haW4oKSB7XG5cdHZlYzQgZGlmZnVzZUNvbG9yID0gdmVjNCggMC4wLCAwLjAsIDAuMCwgb3BhY2l0eSApO1xuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxub3JtYWxfZnJhZ21lbnRfYmVnaW4+XG5cdCNpbmNsdWRlIDxub3JtYWxfZnJhZ21lbnRfbWFwcz5cblx0Z2xfRnJhZ0NvbG9yID0gdmVjNCggcGFja05vcm1hbFRvUkdCKCBub3JtYWwgKSwgZGlmZnVzZUNvbG9yLmEgKTtcblx0I2lmZGVmIE9QQVFVRVxuXHRcdGdsX0ZyYWdDb2xvci5hID0gMS4wO1xuXHQjZW5kaWZcbn0iOwoKY29uc3QgdmVydGV4JDYgPSAiI2RlZmluZSBQSE9OR1xudmFyeWluZyB2ZWMzIHZWaWV3UG9zaXRpb247XG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPHV2X3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGRpc3BsYWNlbWVudG1hcF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxlbnZtYXBfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Y29sb3JfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Zm9nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPG5vcm1hbF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxtb3JwaHRhcmdldF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxza2lubmluZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4Plxudm9pZCBtYWluKCkge1xuXHQjaW5jbHVkZSA8dXZfdmVydGV4PlxuXHQjaW5jbHVkZSA8Y29sb3JfdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiYXRjaGluZ192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiZWdpbm5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2luYmFzZV92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2lubm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8bm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPGJlZ2luX3ZlcnRleD5cblx0I2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD5cblx0I2luY2x1ZGUgPHNraW5uaW5nX3ZlcnRleD5cblx0I2luY2x1ZGUgPGRpc3BsYWNlbWVudG1hcF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD5cblx0I2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3ZlcnRleD5cblx0I2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc192ZXJ0ZXg+XG5cdHZWaWV3UG9zaXRpb24gPSAtIG12UG9zaXRpb24ueHl6O1xuXHQjaW5jbHVkZSA8d29ybGRwb3NfdmVydGV4PlxuXHQjaW5jbHVkZSA8ZW52bWFwX3ZlcnRleD5cblx0I2luY2x1ZGUgPHNoYWRvd21hcF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxmb2dfdmVydGV4PlxufSI7Cgpjb25zdCBmcmFnbWVudCQ2ID0gIiNkZWZpbmUgUEhPTkdcbnVuaWZvcm0gdmVjMyBkaWZmdXNlO1xudW5pZm9ybSB2ZWMzIGVtaXNzaXZlO1xudW5pZm9ybSB2ZWMzIHNwZWN1bGFyO1xudW5pZm9ybSBmbG9hdCBzaGluaW5lc3M7XG51bmlmb3JtIGZsb2F0IG9wYWNpdHk7XG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPHBhY2tpbmc+XG4jaW5jbHVkZSA8ZGl0aGVyaW5nX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Y29sb3JfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDx1dl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhbWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YWxwaGF0ZXN0X3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YWxwaGFoYXNoX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YW9tYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxsaWdodG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGVtaXNzaXZlbWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8ZW52bWFwX2NvbW1vbl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGVudm1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGZvZ19wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGJzZGZzPlxuI2luY2x1ZGUgPGxpZ2h0c19wYXJzX2JlZ2luPlxuI2luY2x1ZGUgPG5vcm1hbF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGxpZ2h0c19waG9uZ19wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPHNoYWRvd21hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGJ1bXBtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxub3JtYWxtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxzcGVjdWxhcm1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+XG52b2lkIG1haW4oKSB7XG5cdHZlYzQgZGlmZnVzZUNvbG9yID0gdmVjNCggZGlmZnVzZSwgb3BhY2l0eSApO1xuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50PlxuXHRSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCA9IFJlZmxlY3RlZExpZ2h0KCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICksIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSApO1xuXHR2ZWMzIHRvdGFsRW1pc3NpdmVSYWRpYW5jZSA9IGVtaXNzaXZlO1xuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhbWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8YWxwaGF0ZXN0X2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8YWxwaGFoYXNoX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8c3BlY3VsYXJtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxub3JtYWxfZnJhZ21lbnRfYmVnaW4+XG5cdCNpbmNsdWRlIDxub3JtYWxfZnJhZ21lbnRfbWFwcz5cblx0I2luY2x1ZGUgPGVtaXNzaXZlbWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bGlnaHRzX3Bob25nX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X2JlZ2luPlxuXHQjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X21hcHM+XG5cdCNpbmNsdWRlIDxsaWdodHNfZnJhZ21lbnRfZW5kPlxuXHQjaW5jbHVkZSA8YW9tYXBfZnJhZ21lbnQ+XG5cdHZlYzMgb3V0Z29pbmdMaWdodCA9IHJlZmxlY3RlZExpZ2h0LmRpcmVjdERpZmZ1c2UgKyByZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKyByZWZsZWN0ZWRMaWdodC5kaXJlY3RTcGVjdWxhciArIHJlZmxlY3RlZExpZ2h0LmluZGlyZWN0U3BlY3VsYXIgKyB0b3RhbEVtaXNzaXZlUmFkaWFuY2U7XG5cdCNpbmNsdWRlIDxlbnZtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8ZGl0aGVyaW5nX2ZyYWdtZW50PlxufSI7Cgpjb25zdCB2ZXJ0ZXgkNSA9ICIjZGVmaW5lIFNUQU5EQVJEXG52YXJ5aW5nIHZlYzMgdlZpZXdQb3NpdGlvbjtcbiNpZmRlZiBVU0VfVFJBTlNNSVNTSU9OXG5cdHZhcnlpbmcgdmVjMyB2V29ybGRQb3NpdGlvbjtcbiNlbmRpZlxuI2luY2x1ZGUgPGNvbW1vbj5cbiNpbmNsdWRlIDxiYXRjaGluZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDx1dl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Y29sb3JfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Zm9nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPG5vcm1hbF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxtb3JwaHRhcmdldF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxza2lubmluZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4Plxudm9pZCBtYWluKCkge1xuXHQjaW5jbHVkZSA8dXZfdmVydGV4PlxuXHQjaW5jbHVkZSA8Y29sb3JfdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiYXRjaGluZ192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiZWdpbm5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2luYmFzZV92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2lubm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8bm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPGJlZ2luX3ZlcnRleD5cblx0I2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD5cblx0I2luY2x1ZGUgPHNraW5uaW5nX3ZlcnRleD5cblx0I2luY2x1ZGUgPGRpc3BsYWNlbWVudG1hcF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD5cblx0I2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3ZlcnRleD5cblx0I2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc192ZXJ0ZXg+XG5cdHZWaWV3UG9zaXRpb24gPSAtIG12UG9zaXRpb24ueHl6O1xuXHQjaW5jbHVkZSA8d29ybGRwb3NfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2hhZG93bWFwX3ZlcnRleD5cblx0I2luY2x1ZGUgPGZvZ192ZXJ0ZXg+XG4jaWZkZWYgVVNFX1RSQU5TTUlTU0lPTlxuXHR2V29ybGRQb3NpdGlvbiA9IHdvcmxkUG9zaXRpb24ueHl6O1xuI2VuZGlmXG59IjsKCmNvbnN0IGZyYWdtZW50JDUgPSAiI2RlZmluZSBTVEFOREFSRFxuI2lmZGVmIFBIWVNJQ0FMXG5cdCNkZWZpbmUgSU9SXG5cdCNkZWZpbmUgVVNFX1NQRUNVTEFSXG4jZW5kaWZcbnVuaWZvcm0gdmVjMyBkaWZmdXNlO1xudW5pZm9ybSB2ZWMzIGVtaXNzaXZlO1xudW5pZm9ybSBmbG9hdCByb3VnaG5lc3M7XG51bmlmb3JtIGZsb2F0IG1ldGFsbmVzcztcbnVuaWZvcm0gZmxvYXQgb3BhY2l0eTtcbiNpZmRlZiBJT1Jcblx0dW5pZm9ybSBmbG9hdCBpb3I7XG4jZW5kaWZcbiNpZmRlZiBVU0VfU1BFQ1VMQVJcblx0dW5pZm9ybSBmbG9hdCBzcGVjdWxhckludGVuc2l0eTtcblx0dW5pZm9ybSB2ZWMzIHNwZWN1bGFyQ29sb3I7XG5cdCNpZmRlZiBVU0VfU1BFQ1VMQVJfQ09MT1JNQVBcblx0XHR1bmlmb3JtIHNhbXBsZXIyRCBzcGVjdWxhckNvbG9yTWFwO1xuXHQjZW5kaWZcblx0I2lmZGVmIFVTRV9TUEVDVUxBUl9JTlRFTlNJVFlNQVBcblx0XHR1bmlmb3JtIHNhbXBsZXIyRCBzcGVjdWxhckludGVuc2l0eU1hcDtcblx0I2VuZGlmXG4jZW5kaWZcbiNpZmRlZiBVU0VfQ0xFQVJDT0FUXG5cdHVuaWZvcm0gZmxvYXQgY2xlYXJjb2F0O1xuXHR1bmlmb3JtIGZsb2F0IGNsZWFyY29hdFJvdWdobmVzcztcbiNlbmRpZlxuI2lmZGVmIFVTRV9JUklERVNDRU5DRVxuXHR1bmlmb3JtIGZsb2F0IGlyaWRlc2NlbmNlO1xuXHR1bmlmb3JtIGZsb2F0IGlyaWRlc2NlbmNlSU9SO1xuXHR1bmlmb3JtIGZsb2F0IGlyaWRlc2NlbmNlVGhpY2tuZXNzTWluaW11bTtcblx0dW5pZm9ybSBmbG9hdCBpcmlkZXNjZW5jZVRoaWNrbmVzc01heGltdW07XG4jZW5kaWZcbiNpZmRlZiBVU0VfU0hFRU5cblx0dW5pZm9ybSB2ZWMzIHNoZWVuQ29sb3I7XG5cdHVuaWZvcm0gZmxvYXQgc2hlZW5Sb3VnaG5lc3M7XG5cdCNpZmRlZiBVU0VfU0hFRU5fQ09MT1JNQVBcblx0XHR1bmlmb3JtIHNhbXBsZXIyRCBzaGVlbkNvbG9yTWFwO1xuXHQjZW5kaWZcblx0I2lmZGVmIFVTRV9TSEVFTl9ST1VHSE5FU1NNQVBcblx0XHR1bmlmb3JtIHNhbXBsZXIyRCBzaGVlblJvdWdobmVzc01hcDtcblx0I2VuZGlmXG4jZW5kaWZcbiNpZmRlZiBVU0VfQU5JU09UUk9QWVxuXHR1bmlmb3JtIHZlYzIgYW5pc290cm9weVZlY3Rvcjtcblx0I2lmZGVmIFVTRV9BTklTT1RST1BZTUFQXG5cdFx0dW5pZm9ybSBzYW1wbGVyMkQgYW5pc290cm9weU1hcDtcblx0I2VuZGlmXG4jZW5kaWZcbnZhcnlpbmcgdmVjMyB2Vmlld1Bvc2l0aW9uO1xuI2luY2x1ZGUgPGNvbW1vbj5cbiNpbmNsdWRlIDxwYWNraW5nPlxuI2luY2x1ZGUgPGRpdGhlcmluZ19wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGNvbG9yX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8dXZfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYW1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhdGVzdF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFscGhhaGFzaF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGFvbWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bGlnaHRtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxlbWlzc2l2ZW1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGlyaWRlc2NlbmNlX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGN1YmVfdXZfcmVmbGVjdGlvbl9mcmFnbWVudD5cbiNpbmNsdWRlIDxlbnZtYXBfY29tbW9uX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8ZW52bWFwX3BoeXNpY2FsX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Zm9nX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bGlnaHRzX3BhcnNfYmVnaW4+XG4jaW5jbHVkZSA8bm9ybWFsX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bGlnaHRzX3BoeXNpY2FsX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8dHJhbnNtaXNzaW9uX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8c2hhZG93bWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YnVtcG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPG5vcm1hbG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGNsZWFyY29hdF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGlyaWRlc2NlbmNlX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8cm91Z2huZXNzbWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bWV0YWxuZXNzbWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc19mcmFnbWVudD5cbnZvaWQgbWFpbigpIHtcblx0dmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7XG5cdCNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfZnJhZ21lbnQ+XG5cdFJlZmxlY3RlZExpZ2h0IHJlZmxlY3RlZExpZ2h0ID0gUmVmbGVjdGVkTGlnaHQoIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICksIHZlYzMoIDAuMCApICk7XG5cdHZlYzMgdG90YWxFbWlzc2l2ZVJhZGlhbmNlID0gZW1pc3NpdmU7XG5cdCNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9mcmFnbWVudD5cblx0I2luY2x1ZGUgPG1hcF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8YWxwaGFtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxhbHBoYXRlc3RfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxhbHBoYWhhc2hfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxyb3VnaG5lc3NtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxtZXRhbG5lc3NtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxub3JtYWxfZnJhZ21lbnRfYmVnaW4+XG5cdCNpbmNsdWRlIDxub3JtYWxfZnJhZ21lbnRfbWFwcz5cblx0I2luY2x1ZGUgPGNsZWFyY29hdF9ub3JtYWxfZnJhZ21lbnRfYmVnaW4+XG5cdCNpbmNsdWRlIDxjbGVhcmNvYXRfbm9ybWFsX2ZyYWdtZW50X21hcHM+XG5cdCNpbmNsdWRlIDxlbWlzc2l2ZW1hcF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGxpZ2h0c19waHlzaWNhbF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGxpZ2h0c19mcmFnbWVudF9iZWdpbj5cblx0I2luY2x1ZGUgPGxpZ2h0c19mcmFnbWVudF9tYXBzPlxuXHQjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X2VuZD5cblx0I2luY2x1ZGUgPGFvbWFwX2ZyYWdtZW50PlxuXHR2ZWMzIHRvdGFsRGlmZnVzZSA9IHJlZmxlY3RlZExpZ2h0LmRpcmVjdERpZmZ1c2UgKyByZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2U7XG5cdHZlYzMgdG90YWxTcGVjdWxhciA9IHJlZmxlY3RlZExpZ2h0LmRpcmVjdFNwZWN1bGFyICsgcmVmbGVjdGVkTGlnaHQuaW5kaXJlY3RTcGVjdWxhcjtcblx0I2luY2x1ZGUgPHRyYW5zbWlzc2lvbl9mcmFnbWVudD5cblx0dmVjMyBvdXRnb2luZ0xpZ2h0ID0gdG90YWxEaWZmdXNlICsgdG90YWxTcGVjdWxhciArIHRvdGFsRW1pc3NpdmVSYWRpYW5jZTtcblx0I2lmZGVmIFVTRV9TSEVFTlxuXHRcdGZsb2F0IHNoZWVuRW5lcmd5Q29tcCA9IDEuMCAtIDAuMTU3ICogbWF4MyggbWF0ZXJpYWwuc2hlZW5Db2xvciApO1xuXHRcdG91dGdvaW5nTGlnaHQgPSBvdXRnb2luZ0xpZ2h0ICogc2hlZW5FbmVyZ3lDb21wICsgc2hlZW5TcGVjdWxhckRpcmVjdCArIHNoZWVuU3BlY3VsYXJJbmRpcmVjdDtcblx0I2VuZGlmXG5cdCNpZmRlZiBVU0VfQ0xFQVJDT0FUXG5cdFx0ZmxvYXQgZG90TlZjYyA9IHNhdHVyYXRlKCBkb3QoIGdlb21ldHJ5Q2xlYXJjb2F0Tm9ybWFsLCBnZW9tZXRyeVZpZXdEaXIgKSApO1xuXHRcdHZlYzMgRmNjID0gRl9TY2hsaWNrKCBtYXRlcmlhbC5jbGVhcmNvYXRGMCwgbWF0ZXJpYWwuY2xlYXJjb2F0RjkwLCBkb3ROVmNjICk7XG5cdFx0b3V0Z29pbmdMaWdodCA9IG91dGdvaW5nTGlnaHQgKiAoIDEuMCAtIG1hdGVyaWFsLmNsZWFyY29hdCAqIEZjYyApICsgKCBjbGVhcmNvYXRTcGVjdWxhckRpcmVjdCArIGNsZWFyY29hdFNwZWN1bGFySW5kaXJlY3QgKSAqIG1hdGVyaWFsLmNsZWFyY29hdDtcblx0I2VuZGlmXG5cdCNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8ZGl0aGVyaW5nX2ZyYWdtZW50PlxufSI7Cgpjb25zdCB2ZXJ0ZXgkNCA9ICIjZGVmaW5lIFRPT05cbnZhcnlpbmcgdmVjMyB2Vmlld1Bvc2l0aW9uO1xuI2luY2x1ZGUgPGNvbW1vbj5cbiNpbmNsdWRlIDxiYXRjaGluZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDx1dl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxkaXNwbGFjZW1lbnRtYXBfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Y29sb3JfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Zm9nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPG5vcm1hbF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxtb3JwaHRhcmdldF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxza2lubmluZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4Plxudm9pZCBtYWluKCkge1xuXHQjaW5jbHVkZSA8dXZfdmVydGV4PlxuXHQjaW5jbHVkZSA8Y29sb3JfdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGhjb2xvcl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiYXRjaGluZ192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiZWdpbm5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2luYmFzZV92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2lubm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8bm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPGJlZ2luX3ZlcnRleD5cblx0I2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD5cblx0I2luY2x1ZGUgPHNraW5uaW5nX3ZlcnRleD5cblx0I2luY2x1ZGUgPGRpc3BsYWNlbWVudG1hcF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxwcm9qZWN0X3ZlcnRleD5cblx0I2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3ZlcnRleD5cblx0I2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc192ZXJ0ZXg+XG5cdHZWaWV3UG9zaXRpb24gPSAtIG12UG9zaXRpb24ueHl6O1xuXHQjaW5jbHVkZSA8d29ybGRwb3NfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2hhZG93bWFwX3ZlcnRleD5cblx0I2luY2x1ZGUgPGZvZ192ZXJ0ZXg+XG59IjsKCmNvbnN0IGZyYWdtZW50JDQgPSAiI2RlZmluZSBUT09OXG51bmlmb3JtIHZlYzMgZGlmZnVzZTtcbnVuaWZvcm0gdmVjMyBlbWlzc2l2ZTtcbnVuaWZvcm0gZmxvYXQgb3BhY2l0eTtcbiNpbmNsdWRlIDxjb21tb24+XG4jaW5jbHVkZSA8cGFja2luZz5cbiNpbmNsdWRlIDxkaXRoZXJpbmdfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxjb2xvcl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPHV2X3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YWxwaGFtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYXRlc3RfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYWhhc2hfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhb21hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGxpZ2h0bWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8ZW1pc3NpdmVtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxncmFkaWVudG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGZvZ19wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGJzZGZzPlxuI2luY2x1ZGUgPGxpZ2h0c19wYXJzX2JlZ2luPlxuI2luY2x1ZGUgPG5vcm1hbF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGxpZ2h0c190b29uX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8c2hhZG93bWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YnVtcG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPG5vcm1hbG1hcF9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ+XG52b2lkIG1haW4oKSB7XG5cdHZlYzQgZGlmZnVzZUNvbG9yID0gdmVjNCggZGlmZnVzZSwgb3BhY2l0eSApO1xuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50PlxuXHRSZWZsZWN0ZWRMaWdodCByZWZsZWN0ZWRMaWdodCA9IFJlZmxlY3RlZExpZ2h0KCB2ZWMzKCAwLjAgKSwgdmVjMyggMC4wICksIHZlYzMoIDAuMCApLCB2ZWMzKCAwLjAgKSApO1xuXHR2ZWMzIHRvdGFsRW1pc3NpdmVSYWRpYW5jZSA9IGVtaXNzaXZlO1xuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxtYXBfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhbWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8YWxwaGF0ZXN0X2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8YWxwaGFoYXNoX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X2JlZ2luPlxuXHQjaW5jbHVkZSA8bm9ybWFsX2ZyYWdtZW50X21hcHM+XG5cdCNpbmNsdWRlIDxlbWlzc2l2ZW1hcF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGxpZ2h0c190b29uX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X2JlZ2luPlxuXHQjaW5jbHVkZSA8bGlnaHRzX2ZyYWdtZW50X21hcHM+XG5cdCNpbmNsdWRlIDxsaWdodHNfZnJhZ21lbnRfZW5kPlxuXHQjaW5jbHVkZSA8YW9tYXBfZnJhZ21lbnQ+XG5cdHZlYzMgb3V0Z29pbmdMaWdodCA9IHJlZmxlY3RlZExpZ2h0LmRpcmVjdERpZmZ1c2UgKyByZWZsZWN0ZWRMaWdodC5pbmRpcmVjdERpZmZ1c2UgKyB0b3RhbEVtaXNzaXZlUmFkaWFuY2U7XG5cdCNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8ZGl0aGVyaW5nX2ZyYWdtZW50PlxufSI7Cgpjb25zdCB2ZXJ0ZXgkMyA9ICJ1bmlmb3JtIGZsb2F0IHNpemU7XG51bmlmb3JtIGZsb2F0IHNjYWxlO1xuI2luY2x1ZGUgPGNvbW1vbj5cbiNpbmNsdWRlIDxjb2xvcl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxmb2dfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bW9ycGh0YXJnZXRfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4PlxuI2lmZGVmIFVTRV9QT0lOVFNfVVZcblx0dmFyeWluZyB2ZWMyIHZVdjtcblx0dW5pZm9ybSBtYXQzIHV2VHJhbnNmb3JtO1xuI2VuZGlmXG52b2lkIG1haW4oKSB7XG5cdCNpZmRlZiBVU0VfUE9JTlRTX1VWXG5cdFx0dlV2ID0gKCB1dlRyYW5zZm9ybSAqIHZlYzMoIHV2LCAxICkgKS54eTtcblx0I2VuZGlmXG5cdCNpbmNsdWRlIDxjb2xvcl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxtb3JwaGNvbG9yX3ZlcnRleD5cblx0I2luY2x1ZGUgPGJlZ2luX3ZlcnRleD5cblx0I2luY2x1ZGUgPG1vcnBodGFyZ2V0X3ZlcnRleD5cblx0I2luY2x1ZGUgPHByb2plY3RfdmVydGV4PlxuXHRnbF9Qb2ludFNpemUgPSBzaXplO1xuXHQjaWZkZWYgVVNFX1NJWkVBVFRFTlVBVElPTlxuXHRcdGJvb2wgaXNQZXJzcGVjdGl2ZSA9IGlzUGVyc3BlY3RpdmVNYXRyaXgoIHByb2plY3Rpb25NYXRyaXggKTtcblx0XHRpZiAoIGlzUGVyc3BlY3RpdmUgKSBnbF9Qb2ludFNpemUgKj0gKCBzY2FsZSAvIC0gbXZQb3NpdGlvbi56ICk7XG5cdCNlbmRpZlxuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfdmVydGV4PlxuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD5cblx0I2luY2x1ZGUgPHdvcmxkcG9zX3ZlcnRleD5cblx0I2luY2x1ZGUgPGZvZ192ZXJ0ZXg+XG59IjsKCmNvbnN0IGZyYWdtZW50JDMgPSAidW5pZm9ybSB2ZWMzIGRpZmZ1c2U7XG51bmlmb3JtIGZsb2F0IG9wYWNpdHk7XG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPGNvbG9yX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bWFwX3BhcnRpY2xlX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YWxwaGF0ZXN0X3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YWxwaGFoYXNoX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8Zm9nX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfcGFyc19mcmFnbWVudD5cbnZvaWQgbWFpbigpIHtcblx0dmVjNCBkaWZmdXNlQ29sb3IgPSB2ZWM0KCBkaWZmdXNlLCBvcGFjaXR5ICk7XG5cdCNpbmNsdWRlIDxjbGlwcGluZ19wbGFuZXNfZnJhZ21lbnQ+XG5cdHZlYzMgb3V0Z29pbmdMaWdodCA9IHZlYzMoIDAuMCApO1xuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxtYXBfcGFydGljbGVfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxjb2xvcl9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhdGVzdF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhaGFzaF9mcmFnbWVudD5cblx0b3V0Z29pbmdMaWdodCA9IGRpZmZ1c2VDb2xvci5yZ2I7XG5cdCNpbmNsdWRlIDxvcGFxdWVfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50PlxufSI7Cgpjb25zdCB2ZXJ0ZXgkMiA9ICIjaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPGJhdGNoaW5nX3BhcnNfdmVydGV4PlxuI2luY2x1ZGUgPGZvZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxtb3JwaHRhcmdldF9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxza2lubmluZ19wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc192ZXJ0ZXg+XG52b2lkIG1haW4oKSB7XG5cdCNpbmNsdWRlIDxiYXRjaGluZ192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxiZWdpbm5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxtb3JwaG5vcm1hbF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2luYmFzZV92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxza2lubm9ybWFsX3ZlcnRleD5cblx0I2luY2x1ZGUgPGRlZmF1bHRub3JtYWxfdmVydGV4PlxuXHQjaW5jbHVkZSA8YmVnaW5fdmVydGV4PlxuXHQjaW5jbHVkZSA8bW9ycGh0YXJnZXRfdmVydGV4PlxuXHQjaW5jbHVkZSA8c2tpbm5pbmdfdmVydGV4PlxuXHQjaW5jbHVkZSA8cHJvamVjdF92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl92ZXJ0ZXg+XG5cdCNpbmNsdWRlIDx3b3JsZHBvc192ZXJ0ZXg+XG5cdCNpbmNsdWRlIDxzaGFkb3dtYXBfdmVydGV4PlxuXHQjaW5jbHVkZSA8Zm9nX3ZlcnRleD5cbn0iOwoKY29uc3QgZnJhZ21lbnQkMiA9ICJ1bmlmb3JtIHZlYzMgY29sb3I7XG51bmlmb3JtIGZsb2F0IG9wYWNpdHk7XG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPHBhY2tpbmc+XG4jaW5jbHVkZSA8Zm9nX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YnNkZnM+XG4jaW5jbHVkZSA8bGlnaHRzX3BhcnNfYmVnaW4+XG4jaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxzaGFkb3dtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxzaGFkb3dtYXNrX3BhcnNfZnJhZ21lbnQ+XG52b2lkIG1haW4oKSB7XG5cdCNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9mcmFnbWVudD5cblx0Z2xfRnJhZ0NvbG9yID0gdmVjNCggY29sb3IsIG9wYWNpdHkgKiAoIDEuMCAtIGdldFNoYWRvd01hc2soKSApICk7XG5cdCNpbmNsdWRlIDx0b25lbWFwcGluZ19mcmFnbWVudD5cblx0I2luY2x1ZGUgPGNvbG9yc3BhY2VfZnJhZ21lbnQ+XG5cdCNpbmNsdWRlIDxmb2dfZnJhZ21lbnQ+XG59IjsKCmNvbnN0IHZlcnRleCQxID0gInVuaWZvcm0gZmxvYXQgcm90YXRpb247XG51bmlmb3JtIHZlYzIgY2VudGVyO1xuI2luY2x1ZGUgPGNvbW1vbj5cbiNpbmNsdWRlIDx1dl9wYXJzX3ZlcnRleD5cbiNpbmNsdWRlIDxmb2dfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8bG9nZGVwdGhidWZfcGFyc192ZXJ0ZXg+XG4jaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4Plxudm9pZCBtYWluKCkge1xuXHQjaW5jbHVkZSA8dXZfdmVydGV4PlxuXHR2ZWM0IG12UG9zaXRpb24gPSBtb2RlbFZpZXdNYXRyaXggKiB2ZWM0KCAwLjAsIDAuMCwgMC4wLCAxLjAgKTtcblx0dmVjMiBzY2FsZTtcblx0c2NhbGUueCA9IGxlbmd0aCggdmVjMyggbW9kZWxNYXRyaXhbIDAgXS54LCBtb2RlbE1hdHJpeFsgMCBdLnksIG1vZGVsTWF0cml4WyAwIF0ueiApICk7XG5cdHNjYWxlLnkgPSBsZW5ndGgoIHZlYzMoIG1vZGVsTWF0cml4WyAxIF0ueCwgbW9kZWxNYXRyaXhbIDEgXS55LCBtb2RlbE1hdHJpeFsgMSBdLnogKSApO1xuXHQjaWZuZGVmIFVTRV9TSVpFQVRURU5VQVRJT05cblx0XHRib29sIGlzUGVyc3BlY3RpdmUgPSBpc1BlcnNwZWN0aXZlTWF0cml4KCBwcm9qZWN0aW9uTWF0cml4ICk7XG5cdFx0aWYgKCBpc1BlcnNwZWN0aXZlICkgc2NhbGUgKj0gLSBtdlBvc2l0aW9uLno7XG5cdCNlbmRpZlxuXHR2ZWMyIGFsaWduZWRQb3NpdGlvbiA9ICggcG9zaXRpb24ueHkgLSAoIGNlbnRlciAtIHZlYzIoIDAuNSApICkgKSAqIHNjYWxlO1xuXHR2ZWMyIHJvdGF0ZWRQb3NpdGlvbjtcblx0cm90YXRlZFBvc2l0aW9uLnggPSBjb3MoIHJvdGF0aW9uICkgKiBhbGlnbmVkUG9zaXRpb24ueCAtIHNpbiggcm90YXRpb24gKSAqIGFsaWduZWRQb3NpdGlvbi55O1xuXHRyb3RhdGVkUG9zaXRpb24ueSA9IHNpbiggcm90YXRpb24gKSAqIGFsaWduZWRQb3NpdGlvbi54ICsgY29zKCByb3RhdGlvbiApICogYWxpZ25lZFBvc2l0aW9uLnk7XG5cdG12UG9zaXRpb24ueHkgKz0gcm90YXRlZFBvc2l0aW9uO1xuXHRnbF9Qb3NpdGlvbiA9IHByb2plY3Rpb25NYXRyaXggKiBtdlBvc2l0aW9uO1xuXHQjaW5jbHVkZSA8bG9nZGVwdGhidWZfdmVydGV4PlxuXHQjaW5jbHVkZSA8Y2xpcHBpbmdfcGxhbmVzX3ZlcnRleD5cblx0I2luY2x1ZGUgPGZvZ192ZXJ0ZXg+XG59IjsKCmNvbnN0IGZyYWdtZW50JDEgPSAidW5pZm9ybSB2ZWMzIGRpZmZ1c2U7XG51bmlmb3JtIGZsb2F0IG9wYWNpdHk7XG4jaW5jbHVkZSA8Y29tbW9uPlxuI2luY2x1ZGUgPHV2X3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8bWFwX3BhcnNfZnJhZ21lbnQ+XG4jaW5jbHVkZSA8YWxwaGFtYXBfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYXRlc3RfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxhbHBoYWhhc2hfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxmb2dfcGFyc19mcmFnbWVudD5cbiNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9wYXJzX2ZyYWdtZW50PlxuI2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50Plxudm9pZCBtYWluKCkge1xuXHR2ZWM0IGRpZmZ1c2VDb2xvciA9IHZlYzQoIGRpZmZ1c2UsIG9wYWNpdHkgKTtcblx0I2luY2x1ZGUgPGNsaXBwaW5nX3BsYW5lc19mcmFnbWVudD5cblx0dmVjMyBvdXRnb2luZ0xpZ2h0ID0gdmVjMyggMC4wICk7XG5cdCNpbmNsdWRlIDxsb2dkZXB0aGJ1Zl9mcmFnbWVudD5cblx0I2luY2x1ZGUgPG1hcF9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGFscGhhbWFwX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8YWxwaGF0ZXN0X2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8YWxwaGFoYXNoX2ZyYWdtZW50PlxuXHRvdXRnb2luZ0xpZ2h0ID0gZGlmZnVzZUNvbG9yLnJnYjtcblx0I2luY2x1ZGUgPG9wYXF1ZV9mcmFnbWVudD5cblx0I2luY2x1ZGUgPHRvbmVtYXBwaW5nX2ZyYWdtZW50PlxuXHQjaW5jbHVkZSA8Y29sb3JzcGFjZV9mcmFnbWVudD5cblx0I2luY2x1ZGUgPGZvZ19mcmFnbWVudD5cbn0iOwoKY29uc3QgU2hhZGVyQ2h1bmsgPSB7CglhbHBoYWhhc2hfZnJhZ21lbnQ6IGFscGhhaGFzaF9mcmFnbWVudCwKCWFscGhhaGFzaF9wYXJzX2ZyYWdtZW50OiBhbHBoYWhhc2hfcGFyc19mcmFnbWVudCwKCWFscGhhbWFwX2ZyYWdtZW50OiBhbHBoYW1hcF9mcmFnbWVudCwKCWFscGhhbWFwX3BhcnNfZnJhZ21lbnQ6IGFscGhhbWFwX3BhcnNfZnJhZ21lbnQsCglhbHBoYXRlc3RfZnJhZ21lbnQ6IGFscGhhdGVzdF9mcmFnbWVudCwKCWFscGhhdGVzdF9wYXJzX2ZyYWdtZW50OiBhbHBoYXRlc3RfcGFyc19mcmFnbWVudCwKCWFvbWFwX2ZyYWdtZW50OiBhb21hcF9mcmFnbWVudCwKCWFvbWFwX3BhcnNfZnJhZ21lbnQ6IGFvbWFwX3BhcnNfZnJhZ21lbnQsCgliYXRjaGluZ19wYXJzX3ZlcnRleDogYmF0Y2hpbmdfcGFyc192ZXJ0ZXgsCgliYXRjaGluZ192ZXJ0ZXg6IGJhdGNoaW5nX3ZlcnRleCwKCWJlZ2luX3ZlcnRleDogYmVnaW5fdmVydGV4LAoJYmVnaW5ub3JtYWxfdmVydGV4OiBiZWdpbm5vcm1hbF92ZXJ0ZXgsCglic2RmczogYnNkZnMsCglpcmlkZXNjZW5jZV9mcmFnbWVudDogaXJpZGVzY2VuY2VfZnJhZ21lbnQsCglidW1wbWFwX3BhcnNfZnJhZ21lbnQ6IGJ1bXBtYXBfcGFyc19mcmFnbWVudCwKCWNsaXBwaW5nX3BsYW5lc19mcmFnbWVudDogY2xpcHBpbmdfcGxhbmVzX2ZyYWdtZW50LAoJY2xpcHBpbmdfcGxhbmVzX3BhcnNfZnJhZ21lbnQ6IGNsaXBwaW5nX3BsYW5lc19wYXJzX2ZyYWdtZW50LAoJY2xpcHBpbmdfcGxhbmVzX3BhcnNfdmVydGV4OiBjbGlwcGluZ19wbGFuZXNfcGFyc192ZXJ0ZXgsCgljbGlwcGluZ19wbGFuZXNfdmVydGV4OiBjbGlwcGluZ19wbGFuZXNfdmVydGV4LAoJY29sb3JfZnJhZ21lbnQ6IGNvbG9yX2ZyYWdtZW50LAoJY29sb3JfcGFyc19mcmFnbWVudDogY29sb3JfcGFyc19mcmFnbWVudCwKCWNvbG9yX3BhcnNfdmVydGV4OiBjb2xvcl9wYXJzX3ZlcnRleCwKCWNvbG9yX3ZlcnRleDogY29sb3JfdmVydGV4LAoJY29tbW9uOiBjb21tb24sCgljdWJlX3V2X3JlZmxlY3Rpb25fZnJhZ21lbnQ6IGN1YmVfdXZfcmVmbGVjdGlvbl9mcmFnbWVudCwKCWRlZmF1bHRub3JtYWxfdmVydGV4OiBkZWZhdWx0bm9ybWFsX3ZlcnRleCwKCWRpc3BsYWNlbWVudG1hcF9wYXJzX3ZlcnRleDogZGlzcGxhY2VtZW50bWFwX3BhcnNfdmVydGV4LAoJZGlzcGxhY2VtZW50bWFwX3ZlcnRleDogZGlzcGxhY2VtZW50bWFwX3ZlcnRleCwKCWVtaXNzaXZlbWFwX2ZyYWdtZW50OiBlbWlzc2l2ZW1hcF9mcmFnbWVudCwKCWVtaXNzaXZlbWFwX3BhcnNfZnJhZ21lbnQ6IGVtaXNzaXZlbWFwX3BhcnNfZnJhZ21lbnQsCgljb2xvcnNwYWNlX2ZyYWdtZW50OiBjb2xvcnNwYWNlX2ZyYWdtZW50LAoJY29sb3JzcGFjZV9wYXJzX2ZyYWdtZW50OiBjb2xvcnNwYWNlX3BhcnNfZnJhZ21lbnQsCgllbnZtYXBfZnJhZ21lbnQ6IGVudm1hcF9mcmFnbWVudCwKCWVudm1hcF9jb21tb25fcGFyc19mcmFnbWVudDogZW52bWFwX2NvbW1vbl9wYXJzX2ZyYWdtZW50LAoJZW52bWFwX3BhcnNfZnJhZ21lbnQ6IGVudm1hcF9wYXJzX2ZyYWdtZW50LAoJZW52bWFwX3BhcnNfdmVydGV4OiBlbnZtYXBfcGFyc192ZXJ0ZXgsCgllbnZtYXBfcGh5c2ljYWxfcGFyc19mcmFnbWVudDogZW52bWFwX3BoeXNpY2FsX3BhcnNfZnJhZ21lbnQsCgllbnZtYXBfdmVydGV4OiBlbnZtYXBfdmVydGV4LAoJZm9nX3ZlcnRleDogZm9nX3ZlcnRleCwKCWZvZ19wYXJzX3ZlcnRleDogZm9nX3BhcnNfdmVydGV4LAoJZm9nX2ZyYWdtZW50OiBmb2dfZnJhZ21lbnQsCglmb2dfcGFyc19mcmFnbWVudDogZm9nX3BhcnNfZnJhZ21lbnQsCglncmFkaWVudG1hcF9wYXJzX2ZyYWdtZW50OiBncmFkaWVudG1hcF9wYXJzX2ZyYWdtZW50LAoJbGlnaHRtYXBfZnJhZ21lbnQ6IGxpZ2h0bWFwX2ZyYWdtZW50LAoJbGlnaHRtYXBfcGFyc19mcmFnbWVudDogbGlnaHRtYXBfcGFyc19mcmFnbWVudCwKCWxpZ2h0c19sYW1iZXJ0X2ZyYWdtZW50OiBsaWdodHNfbGFtYmVydF9mcmFnbWVudCwKCWxpZ2h0c19sYW1iZXJ0X3BhcnNfZnJhZ21lbnQ6IGxpZ2h0c19sYW1iZXJ0X3BhcnNfZnJhZ21lbnQsCglsaWdodHNfcGFyc19iZWdpbjogbGlnaHRzX3BhcnNfYmVnaW4sCglsaWdodHNfdG9vbl9mcmFnbWVudDogbGlnaHRzX3Rvb25fZnJhZ21lbnQsCglsaWdodHNfdG9vbl9wYXJzX2ZyYWdtZW50OiBsaWdodHNfdG9vbl9wYXJzX2ZyYWdtZW50LAoJbGlnaHRzX3Bob25nX2ZyYWdtZW50OiBsaWdodHNfcGhvbmdfZnJhZ21lbnQsCglsaWdodHNfcGhvbmdfcGFyc19mcmFnbWVudDogbGlnaHRzX3Bob25nX3BhcnNfZnJhZ21lbnQsCglsaWdodHNfcGh5c2ljYWxfZnJhZ21lbnQ6IGxpZ2h0c19waHlzaWNhbF9mcmFnbWVudCwKCWxpZ2h0c19waHlzaWNhbF9wYXJzX2ZyYWdtZW50OiBsaWdodHNfcGh5c2ljYWxfcGFyc19mcmFnbWVudCwKCWxpZ2h0c19mcmFnbWVudF9iZWdpbjogbGlnaHRzX2ZyYWdtZW50X2JlZ2luLAoJbGlnaHRzX2ZyYWdtZW50X21hcHM6IGxpZ2h0c19mcmFnbWVudF9tYXBzLAoJbGlnaHRzX2ZyYWdtZW50X2VuZDogbGlnaHRzX2ZyYWdtZW50X2VuZCwKCWxvZ2RlcHRoYnVmX2ZyYWdtZW50OiBsb2dkZXB0aGJ1Zl9mcmFnbWVudCwKCWxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQ6IGxvZ2RlcHRoYnVmX3BhcnNfZnJhZ21lbnQsCglsb2dkZXB0aGJ1Zl9wYXJzX3ZlcnRleDogbG9nZGVwdGhidWZfcGFyc192ZXJ0ZXgsCglsb2dkZXB0aGJ1Zl92ZXJ0ZXg6IGxvZ2RlcHRoYnVmX3ZlcnRleCwKCW1hcF9mcmFnbWVudDogbWFwX2ZyYWdtZW50LAoJbWFwX3BhcnNfZnJhZ21lbnQ6IG1hcF9wYXJzX2ZyYWdtZW50LAoJbWFwX3BhcnRpY2xlX2ZyYWdtZW50OiBtYXBfcGFydGljbGVfZnJhZ21lbnQsCgltYXBfcGFydGljbGVfcGFyc19mcmFnbWVudDogbWFwX3BhcnRpY2xlX3BhcnNfZnJhZ21lbnQsCgltZXRhbG5lc3NtYXBfZnJhZ21lbnQ6IG1ldGFsbmVzc21hcF9mcmFnbWVudCwKCW1ldGFsbmVzc21hcF9wYXJzX2ZyYWdtZW50OiBtZXRhbG5lc3NtYXBfcGFyc19mcmFnbWVudCwKCW1vcnBoY29sb3JfdmVydGV4OiBtb3JwaGNvbG9yX3ZlcnRleCwKCW1vcnBobm9ybWFsX3ZlcnRleDogbW9ycGhub3JtYWxfdmVydGV4LAoJbW9ycGh0YXJnZXRfcGFyc192ZXJ0ZXg6IG1vcnBodGFyZ2V0X3BhcnNfdmVydGV4LAoJbW9ycGh0YXJnZXRfdmVydGV4OiBtb3JwaHRhcmdldF92ZXJ0ZXgsCglub3JtYWxfZnJhZ21lbnRfYmVnaW46IG5vcm1hbF9mcmFnbWVudF9iZWdpbiwKCW5vcm1hbF9mcmFnbWVudF9tYXBzOiBub3JtYWxfZnJhZ21lbnRfbWFwcywKCW5vcm1hbF9wYXJzX2ZyYWdtZW50OiBub3JtYWxfcGFyc19mcmFnbWVudCwKCW5vcm1hbF9wYXJzX3ZlcnRleDogbm9ybWFsX3BhcnNfdmVydGV4LAoJbm9ybWFsX3ZlcnRleDogbm9ybWFsX3ZlcnRleCwKCW5vcm1hbG1hcF9wYXJzX2ZyYWdtZW50OiBub3JtYWxtYXBfcGFyc19mcmFnbWVudCwKCWNsZWFyY29hdF9ub3JtYWxfZnJhZ21lbnRfYmVnaW46IGNsZWFyY29hdF9ub3JtYWxfZnJhZ21lbnRfYmVnaW4sCgljbGVhcmNvYXRfbm9ybWFsX2ZyYWdtZW50X21hcHM6IGNsZWFyY29hdF9ub3JtYWxfZnJhZ21lbnRfbWFwcywKCWNsZWFyY29hdF9wYXJzX2ZyYWdtZW50OiBjbGVhcmNvYXRfcGFyc19mcmFnbWVudCwKCWlyaWRlc2NlbmNlX3BhcnNfZnJhZ21lbnQ6IGlyaWRlc2NlbmNlX3BhcnNfZnJhZ21lbnQsCglvcGFxdWVfZnJhZ21lbnQ6IG9wYXF1ZV9mcmFnbWVudCwKCXBhY2tpbmc6IHBhY2tpbmcsCglwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50OiBwcmVtdWx0aXBsaWVkX2FscGhhX2ZyYWdtZW50LAoJcHJvamVjdF92ZXJ0ZXg6IHByb2plY3RfdmVydGV4LAoJZGl0aGVyaW5nX2ZyYWdtZW50OiBkaXRoZXJpbmdfZnJhZ21lbnQsCglkaXRoZXJpbmdfcGFyc19mcmFnbWVudDogZGl0aGVyaW5nX3BhcnNfZnJhZ21lbnQsCglyb3VnaG5lc3NtYXBfZnJhZ21lbnQ6IHJvdWdobmVzc21hcF9mcmFnbWVudCwKCXJvdWdobmVzc21hcF9wYXJzX2ZyYWdtZW50OiByb3VnaG5lc3NtYXBfcGFyc19mcmFnbWVudCwKCXNoYWRvd21hcF9wYXJzX2ZyYWdtZW50OiBzaGFkb3dtYXBfcGFyc19mcmFnbWVudCwKCXNoYWRvd21hcF9wYXJzX3ZlcnRleDogc2hhZG93bWFwX3BhcnNfdmVydGV4LAoJc2hhZG93bWFwX3ZlcnRleDogc2hhZG93bWFwX3ZlcnRleCwKCXNoYWRvd21hc2tfcGFyc19mcmFnbWVudDogc2hhZG93bWFza19wYXJzX2ZyYWdtZW50LAoJc2tpbmJhc2VfdmVydGV4OiBza2luYmFzZV92ZXJ0ZXgsCglza2lubmluZ19wYXJzX3ZlcnRleDogc2tpbm5pbmdfcGFyc192ZXJ0ZXgsCglza2lubmluZ192ZXJ0ZXg6IHNraW5uaW5nX3ZlcnRleCwKCXNraW5ub3JtYWxfdmVydGV4OiBza2lubm9ybWFsX3ZlcnRleCwKCXNwZWN1bGFybWFwX2ZyYWdtZW50OiBzcGVjdWxhcm1hcF9mcmFnbWVudCwKCXNwZWN1bGFybWFwX3BhcnNfZnJhZ21lbnQ6IHNwZWN1bGFybWFwX3BhcnNfZnJhZ21lbnQsCgl0b25lbWFwcGluZ19mcmFnbWVudDogdG9uZW1hcHBpbmdfZnJhZ21lbnQsCgl0b25lbWFwcGluZ19wYXJzX2ZyYWdtZW50OiB0b25lbWFwcGluZ19wYXJzX2ZyYWdtZW50LAoJdHJhbnNtaXNzaW9uX2ZyYWdtZW50OiB0cmFuc21pc3Npb25fZnJhZ21lbnQsCgl0cmFuc21pc3Npb25fcGFyc19mcmFnbWVudDogdHJhbnNtaXNzaW9uX3BhcnNfZnJhZ21lbnQsCgl1dl9wYXJzX2ZyYWdtZW50OiB1dl9wYXJzX2ZyYWdtZW50LAoJdXZfcGFyc192ZXJ0ZXg6IHV2X3BhcnNfdmVydGV4LAoJdXZfdmVydGV4OiB1dl92ZXJ0ZXgsCgl3b3JsZHBvc192ZXJ0ZXg6IHdvcmxkcG9zX3ZlcnRleCwKCgliYWNrZ3JvdW5kX3ZlcnQ6IHZlcnRleCRoLAoJYmFja2dyb3VuZF9mcmFnOiBmcmFnbWVudCRoLAoJYmFja2dyb3VuZEN1YmVfdmVydDogdmVydGV4JGcsCgliYWNrZ3JvdW5kQ3ViZV9mcmFnOiBmcmFnbWVudCRnLAoJY3ViZV92ZXJ0OiB2ZXJ0ZXgkZiwKCWN1YmVfZnJhZzogZnJhZ21lbnQkZiwKCWRlcHRoX3ZlcnQ6IHZlcnRleCRlLAoJZGVwdGhfZnJhZzogZnJhZ21lbnQkZSwKCWRpc3RhbmNlUkdCQV92ZXJ0OiB2ZXJ0ZXgkZCwKCWRpc3RhbmNlUkdCQV9mcmFnOiBmcmFnbWVudCRkLAoJZXF1aXJlY3RfdmVydDogdmVydGV4JGMsCgllcXVpcmVjdF9mcmFnOiBmcmFnbWVudCRjLAoJbGluZWRhc2hlZF92ZXJ0OiB2ZXJ0ZXgkYiwKCWxpbmVkYXNoZWRfZnJhZzogZnJhZ21lbnQkYiwKCW1lc2hiYXNpY192ZXJ0OiB2ZXJ0ZXgkYSwKCW1lc2hiYXNpY19mcmFnOiBmcmFnbWVudCRhLAoJbWVzaGxhbWJlcnRfdmVydDogdmVydGV4JDksCgltZXNobGFtYmVydF9mcmFnOiBmcmFnbWVudCQ5LAoJbWVzaG1hdGNhcF92ZXJ0OiB2ZXJ0ZXgkOCwKCW1lc2htYXRjYXBfZnJhZzogZnJhZ21lbnQkOCwKCW1lc2hub3JtYWxfdmVydDogdmVydGV4JDcsCgltZXNobm9ybWFsX2ZyYWc6IGZyYWdtZW50JDcsCgltZXNocGhvbmdfdmVydDogdmVydGV4JDYsCgltZXNocGhvbmdfZnJhZzogZnJhZ21lbnQkNiwKCW1lc2hwaHlzaWNhbF92ZXJ0OiB2ZXJ0ZXgkNSwKCW1lc2hwaHlzaWNhbF9mcmFnOiBmcmFnbWVudCQ1LAoJbWVzaHRvb25fdmVydDogdmVydGV4JDQsCgltZXNodG9vbl9mcmFnOiBmcmFnbWVudCQ0LAoJcG9pbnRzX3ZlcnQ6IHZlcnRleCQzLAoJcG9pbnRzX2ZyYWc6IGZyYWdtZW50JDMsCglzaGFkb3dfdmVydDogdmVydGV4JDIsCglzaGFkb3dfZnJhZzogZnJhZ21lbnQkMiwKCXNwcml0ZV92ZXJ0OiB2ZXJ0ZXgkMSwKCXNwcml0ZV9mcmFnOiBmcmFnbWVudCQxCn07CgovKioKICogVW5pZm9ybXMgbGlicmFyeSBmb3Igc2hhcmVkIHdlYmdsIHNoYWRlcnMKICovCgpjb25zdCBVbmlmb3Jtc0xpYiA9IHsKCgljb21tb246IHsKCgkJZGlmZnVzZTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgQ29sb3IoIDB4ZmZmZmZmICkgfSwKCQlvcGFjaXR5OiB7IHZhbHVlOiAxLjAgfSwKCgkJbWFwOiB7IHZhbHVlOiBudWxsIH0sCgkJbWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfSwKCgkJYWxwaGFNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQlhbHBoYU1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgoJCWFscGhhVGVzdDogeyB2YWx1ZTogMCB9CgoJfSwKCglzcGVjdWxhcm1hcDogewoKCQlzcGVjdWxhck1hcDogeyB2YWx1ZTogbnVsbCB9LAoJCXNwZWN1bGFyTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfQoKCX0sCgoJZW52bWFwOiB7CgoJCWVudk1hcDogeyB2YWx1ZTogbnVsbCB9LAoJCWZsaXBFbnZNYXA6IHsgdmFsdWU6IC0gMSB9LAoJCXJlZmxlY3Rpdml0eTogeyB2YWx1ZTogMS4wIH0sIC8vIGJhc2ljLCBsYW1iZXJ0LCBwaG9uZwoJCWlvcjogeyB2YWx1ZTogMS41IH0sIC8vIHBoeXNpY2FsCgkJcmVmcmFjdGlvblJhdGlvOiB7IHZhbHVlOiAwLjk4IH0sIC8vIGJhc2ljLCBsYW1iZXJ0LCBwaG9uZwoKCX0sCgoJYW9tYXA6IHsKCgkJYW9NYXA6IHsgdmFsdWU6IG51bGwgfSwKCQlhb01hcEludGVuc2l0eTogeyB2YWx1ZTogMSB9LAoJCWFvTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfQoKCX0sCgoJbGlnaHRtYXA6IHsKCgkJbGlnaHRNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQlsaWdodE1hcEludGVuc2l0eTogeyB2YWx1ZTogMSB9LAoJCWxpZ2h0TWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfQoKCX0sCgoJYnVtcG1hcDogewoKCQlidW1wTWFwOiB7IHZhbHVlOiBudWxsIH0sCgkJYnVtcE1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJYnVtcFNjYWxlOiB7IHZhbHVlOiAxIH0KCgl9LAoKCW5vcm1hbG1hcDogewoKCQlub3JtYWxNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQlub3JtYWxNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDMoKSB9LAoJCW5vcm1hbFNjYWxlOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCAxLCAxICkgfQoKCX0sCgoJZGlzcGxhY2VtZW50bWFwOiB7CgoJCWRpc3BsYWNlbWVudE1hcDogeyB2YWx1ZTogbnVsbCB9LAoJCWRpc3BsYWNlbWVudE1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJZGlzcGxhY2VtZW50U2NhbGU6IHsgdmFsdWU6IDEgfSwKCQlkaXNwbGFjZW1lbnRCaWFzOiB7IHZhbHVlOiAwIH0KCgl9LAoKCWVtaXNzaXZlbWFwOiB7CgoJCWVtaXNzaXZlTWFwOiB7IHZhbHVlOiBudWxsIH0sCgkJZW1pc3NpdmVNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDMoKSB9CgoJfSwKCgltZXRhbG5lc3NtYXA6IHsKCgkJbWV0YWxuZXNzTWFwOiB7IHZhbHVlOiBudWxsIH0sCgkJbWV0YWxuZXNzTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfQoKCX0sCgoJcm91Z2huZXNzbWFwOiB7CgoJCXJvdWdobmVzc01hcDogeyB2YWx1ZTogbnVsbCB9LAoJCXJvdWdobmVzc01hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0KCgl9LAoKCWdyYWRpZW50bWFwOiB7CgoJCWdyYWRpZW50TWFwOiB7IHZhbHVlOiBudWxsIH0KCgl9LAoKCWZvZzogewoKCQlmb2dEZW5zaXR5OiB7IHZhbHVlOiAwLjAwMDI1IH0sCgkJZm9nTmVhcjogeyB2YWx1ZTogMSB9LAoJCWZvZ0ZhcjogeyB2YWx1ZTogMjAwMCB9LAoJCWZvZ0NvbG9yOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBDb2xvciggMHhmZmZmZmYgKSB9CgoJfSwKCglsaWdodHM6IHsKCgkJYW1iaWVudExpZ2h0Q29sb3I6IHsgdmFsdWU6IFtdIH0sCgoJCWxpZ2h0UHJvYmU6IHsgdmFsdWU6IFtdIH0sCgoJCWRpcmVjdGlvbmFsTGlnaHRzOiB7IHZhbHVlOiBbXSwgcHJvcGVydGllczogewoJCQlkaXJlY3Rpb246IHt9LAoJCQljb2xvcjoge30KCQl9IH0sCgoJCWRpcmVjdGlvbmFsTGlnaHRTaGFkb3dzOiB7IHZhbHVlOiBbXSwgcHJvcGVydGllczogewoJCQlzaGFkb3dCaWFzOiB7fSwKCQkJc2hhZG93Tm9ybWFsQmlhczoge30sCgkJCXNoYWRvd1JhZGl1czoge30sCgkJCXNoYWRvd01hcFNpemU6IHt9CgkJfSB9LAoKCQlkaXJlY3Rpb25hbFNoYWRvd01hcDogeyB2YWx1ZTogW10gfSwKCQlkaXJlY3Rpb25hbFNoYWRvd01hdHJpeDogeyB2YWx1ZTogW10gfSwKCgkJc3BvdExpZ2h0czogeyB2YWx1ZTogW10sIHByb3BlcnRpZXM6IHsKCQkJY29sb3I6IHt9LAoJCQlwb3NpdGlvbjoge30sCgkJCWRpcmVjdGlvbjoge30sCgkJCWRpc3RhbmNlOiB7fSwKCQkJY29uZUNvczoge30sCgkJCXBlbnVtYnJhQ29zOiB7fSwKCQkJZGVjYXk6IHt9CgkJfSB9LAoKCQlzcG90TGlnaHRTaGFkb3dzOiB7IHZhbHVlOiBbXSwgcHJvcGVydGllczogewoJCQlzaGFkb3dCaWFzOiB7fSwKCQkJc2hhZG93Tm9ybWFsQmlhczoge30sCgkJCXNoYWRvd1JhZGl1czoge30sCgkJCXNoYWRvd01hcFNpemU6IHt9CgkJfSB9LAoKCQlzcG90TGlnaHRNYXA6IHsgdmFsdWU6IFtdIH0sCgkJc3BvdFNoYWRvd01hcDogeyB2YWx1ZTogW10gfSwKCQlzcG90TGlnaHRNYXRyaXg6IHsgdmFsdWU6IFtdIH0sCgoJCXBvaW50TGlnaHRzOiB7IHZhbHVlOiBbXSwgcHJvcGVydGllczogewoJCQljb2xvcjoge30sCgkJCXBvc2l0aW9uOiB7fSwKCQkJZGVjYXk6IHt9LAoJCQlkaXN0YW5jZToge30KCQl9IH0sCgoJCXBvaW50TGlnaHRTaGFkb3dzOiB7IHZhbHVlOiBbXSwgcHJvcGVydGllczogewoJCQlzaGFkb3dCaWFzOiB7fSwKCQkJc2hhZG93Tm9ybWFsQmlhczoge30sCgkJCXNoYWRvd1JhZGl1czoge30sCgkJCXNoYWRvd01hcFNpemU6IHt9LAoJCQlzaGFkb3dDYW1lcmFOZWFyOiB7fSwKCQkJc2hhZG93Q2FtZXJhRmFyOiB7fQoJCX0gfSwKCgkJcG9pbnRTaGFkb3dNYXA6IHsgdmFsdWU6IFtdIH0sCgkJcG9pbnRTaGFkb3dNYXRyaXg6IHsgdmFsdWU6IFtdIH0sCgoJCWhlbWlzcGhlcmVMaWdodHM6IHsgdmFsdWU6IFtdLCBwcm9wZXJ0aWVzOiB7CgkJCWRpcmVjdGlvbjoge30sCgkJCXNreUNvbG9yOiB7fSwKCQkJZ3JvdW5kQ29sb3I6IHt9CgkJfSB9LAoKCQkvLyBUT0RPIChhYmVsbmF0aW9uKTogUmVjdEFyZWFMaWdodCBCUkRGIGRhdGEgbmVlZHMgdG8gYmUgbW92ZWQgZnJvbSBleGFtcGxlIHRvIG1haW4gc3JjCgkJcmVjdEFyZWFMaWdodHM6IHsgdmFsdWU6IFtdLCBwcm9wZXJ0aWVzOiB7CgkJCWNvbG9yOiB7fSwKCQkJcG9zaXRpb246IHt9LAoJCQl3aWR0aDoge30sCgkJCWhlaWdodDoge30KCQl9IH0sCgoJCWx0Y18xOiB7IHZhbHVlOiBudWxsIH0sCgkJbHRjXzI6IHsgdmFsdWU6IG51bGwgfQoKCX0sCgoJcG9pbnRzOiB7CgoJCWRpZmZ1c2U6IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IENvbG9yKCAweGZmZmZmZiApIH0sCgkJb3BhY2l0eTogeyB2YWx1ZTogMS4wIH0sCgkJc2l6ZTogeyB2YWx1ZTogMS4wIH0sCgkJc2NhbGU6IHsgdmFsdWU6IDEuMCB9LAoJCW1hcDogeyB2YWx1ZTogbnVsbCB9LAoJCWFscGhhTWFwOiB7IHZhbHVlOiBudWxsIH0sCgkJYWxwaGFNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDMoKSB9LAoJCWFscGhhVGVzdDogeyB2YWx1ZTogMCB9LAoJCXV2VHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfQoKCX0sCgoJc3ByaXRlOiB7CgoJCWRpZmZ1c2U6IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IENvbG9yKCAweGZmZmZmZiApIH0sCgkJb3BhY2l0eTogeyB2YWx1ZTogMS4wIH0sCgkJY2VudGVyOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCAwLjUsIDAuNSApIH0sCgkJcm90YXRpb246IHsgdmFsdWU6IDAuMCB9LAoJCW1hcDogeyB2YWx1ZTogbnVsbCB9LAoJCW1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJYWxwaGFNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQlhbHBoYU1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJYWxwaGFUZXN0OiB7IHZhbHVlOiAwIH0KCgl9Cgp9OwoKY29uc3QgU2hhZGVyTGliID0gewoKCWJhc2ljOiB7CgoJCXVuaWZvcm1zOiAvKkBfX1BVUkVfXyovIG1lcmdlVW5pZm9ybXMoIFsKCQkJVW5pZm9ybXNMaWIuY29tbW9uLAoJCQlVbmlmb3Jtc0xpYi5zcGVjdWxhcm1hcCwKCQkJVW5pZm9ybXNMaWIuZW52bWFwLAoJCQlVbmlmb3Jtc0xpYi5hb21hcCwKCQkJVW5pZm9ybXNMaWIubGlnaHRtYXAsCgkJCVVuaWZvcm1zTGliLmZvZwoJCV0gKSwKCgkJdmVydGV4U2hhZGVyOiBTaGFkZXJDaHVuay5tZXNoYmFzaWNfdmVydCwKCQlmcmFnbWVudFNoYWRlcjogU2hhZGVyQ2h1bmsubWVzaGJhc2ljX2ZyYWcKCgl9LAoKCWxhbWJlcnQ6IHsKCgkJdW5pZm9ybXM6IC8qQF9fUFVSRV9fKi8gbWVyZ2VVbmlmb3JtcyggWwoJCQlVbmlmb3Jtc0xpYi5jb21tb24sCgkJCVVuaWZvcm1zTGliLnNwZWN1bGFybWFwLAoJCQlVbmlmb3Jtc0xpYi5lbnZtYXAsCgkJCVVuaWZvcm1zTGliLmFvbWFwLAoJCQlVbmlmb3Jtc0xpYi5saWdodG1hcCwKCQkJVW5pZm9ybXNMaWIuZW1pc3NpdmVtYXAsCgkJCVVuaWZvcm1zTGliLmJ1bXBtYXAsCgkJCVVuaWZvcm1zTGliLm5vcm1hbG1hcCwKCQkJVW5pZm9ybXNMaWIuZGlzcGxhY2VtZW50bWFwLAoJCQlVbmlmb3Jtc0xpYi5mb2csCgkJCVVuaWZvcm1zTGliLmxpZ2h0cywKCQkJewoJCQkJZW1pc3NpdmU6IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IENvbG9yKCAweDAwMDAwMCApIH0KCQkJfQoJCV0gKSwKCgkJdmVydGV4U2hhZGVyOiBTaGFkZXJDaHVuay5tZXNobGFtYmVydF92ZXJ0LAoJCWZyYWdtZW50U2hhZGVyOiBTaGFkZXJDaHVuay5tZXNobGFtYmVydF9mcmFnCgoJfSwKCglwaG9uZzogewoKCQl1bmlmb3JtczogLypAX19QVVJFX18qLyBtZXJnZVVuaWZvcm1zKCBbCgkJCVVuaWZvcm1zTGliLmNvbW1vbiwKCQkJVW5pZm9ybXNMaWIuc3BlY3VsYXJtYXAsCgkJCVVuaWZvcm1zTGliLmVudm1hcCwKCQkJVW5pZm9ybXNMaWIuYW9tYXAsCgkJCVVuaWZvcm1zTGliLmxpZ2h0bWFwLAoJCQlVbmlmb3Jtc0xpYi5lbWlzc2l2ZW1hcCwKCQkJVW5pZm9ybXNMaWIuYnVtcG1hcCwKCQkJVW5pZm9ybXNMaWIubm9ybWFsbWFwLAoJCQlVbmlmb3Jtc0xpYi5kaXNwbGFjZW1lbnRtYXAsCgkJCVVuaWZvcm1zTGliLmZvZywKCQkJVW5pZm9ybXNMaWIubGlnaHRzLAoJCQl7CgkJCQllbWlzc2l2ZTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgQ29sb3IoIDB4MDAwMDAwICkgfSwKCQkJCXNwZWN1bGFyOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBDb2xvciggMHgxMTExMTEgKSB9LAoJCQkJc2hpbmluZXNzOiB7IHZhbHVlOiAzMCB9CgkJCX0KCQldICksCgoJCXZlcnRleFNoYWRlcjogU2hhZGVyQ2h1bmsubWVzaHBob25nX3ZlcnQsCgkJZnJhZ21lbnRTaGFkZXI6IFNoYWRlckNodW5rLm1lc2hwaG9uZ19mcmFnCgoJfSwKCglzdGFuZGFyZDogewoKCQl1bmlmb3JtczogLypAX19QVVJFX18qLyBtZXJnZVVuaWZvcm1zKCBbCgkJCVVuaWZvcm1zTGliLmNvbW1vbiwKCQkJVW5pZm9ybXNMaWIuZW52bWFwLAoJCQlVbmlmb3Jtc0xpYi5hb21hcCwKCQkJVW5pZm9ybXNMaWIubGlnaHRtYXAsCgkJCVVuaWZvcm1zTGliLmVtaXNzaXZlbWFwLAoJCQlVbmlmb3Jtc0xpYi5idW1wbWFwLAoJCQlVbmlmb3Jtc0xpYi5ub3JtYWxtYXAsCgkJCVVuaWZvcm1zTGliLmRpc3BsYWNlbWVudG1hcCwKCQkJVW5pZm9ybXNMaWIucm91Z2huZXNzbWFwLAoJCQlVbmlmb3Jtc0xpYi5tZXRhbG5lc3NtYXAsCgkJCVVuaWZvcm1zTGliLmZvZywKCQkJVW5pZm9ybXNMaWIubGlnaHRzLAoJCQl7CgkJCQllbWlzc2l2ZTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgQ29sb3IoIDB4MDAwMDAwICkgfSwKCQkJCXJvdWdobmVzczogeyB2YWx1ZTogMS4wIH0sCgkJCQltZXRhbG5lc3M6IHsgdmFsdWU6IDAuMCB9LAoJCQkJZW52TWFwSW50ZW5zaXR5OiB7IHZhbHVlOiAxIH0gLy8gdGVtcG9yYXJ5CgkJCX0KCQldICksCgoJCXZlcnRleFNoYWRlcjogU2hhZGVyQ2h1bmsubWVzaHBoeXNpY2FsX3ZlcnQsCgkJZnJhZ21lbnRTaGFkZXI6IFNoYWRlckNodW5rLm1lc2hwaHlzaWNhbF9mcmFnCgoJfSwKCgl0b29uOiB7CgoJCXVuaWZvcm1zOiAvKkBfX1BVUkVfXyovIG1lcmdlVW5pZm9ybXMoIFsKCQkJVW5pZm9ybXNMaWIuY29tbW9uLAoJCQlVbmlmb3Jtc0xpYi5hb21hcCwKCQkJVW5pZm9ybXNMaWIubGlnaHRtYXAsCgkJCVVuaWZvcm1zTGliLmVtaXNzaXZlbWFwLAoJCQlVbmlmb3Jtc0xpYi5idW1wbWFwLAoJCQlVbmlmb3Jtc0xpYi5ub3JtYWxtYXAsCgkJCVVuaWZvcm1zTGliLmRpc3BsYWNlbWVudG1hcCwKCQkJVW5pZm9ybXNMaWIuZ3JhZGllbnRtYXAsCgkJCVVuaWZvcm1zTGliLmZvZywKCQkJVW5pZm9ybXNMaWIubGlnaHRzLAoJCQl7CgkJCQllbWlzc2l2ZTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgQ29sb3IoIDB4MDAwMDAwICkgfQoJCQl9CgkJXSApLAoKCQl2ZXJ0ZXhTaGFkZXI6IFNoYWRlckNodW5rLm1lc2h0b29uX3ZlcnQsCgkJZnJhZ21lbnRTaGFkZXI6IFNoYWRlckNodW5rLm1lc2h0b29uX2ZyYWcKCgl9LAoKCW1hdGNhcDogewoKCQl1bmlmb3JtczogLypAX19QVVJFX18qLyBtZXJnZVVuaWZvcm1zKCBbCgkJCVVuaWZvcm1zTGliLmNvbW1vbiwKCQkJVW5pZm9ybXNMaWIuYnVtcG1hcCwKCQkJVW5pZm9ybXNMaWIubm9ybWFsbWFwLAoJCQlVbmlmb3Jtc0xpYi5kaXNwbGFjZW1lbnRtYXAsCgkJCVVuaWZvcm1zTGliLmZvZywKCQkJewoJCQkJbWF0Y2FwOiB7IHZhbHVlOiBudWxsIH0KCQkJfQoJCV0gKSwKCgkJdmVydGV4U2hhZGVyOiBTaGFkZXJDaHVuay5tZXNobWF0Y2FwX3ZlcnQsCgkJZnJhZ21lbnRTaGFkZXI6IFNoYWRlckNodW5rLm1lc2htYXRjYXBfZnJhZwoKCX0sCgoJcG9pbnRzOiB7CgoJCXVuaWZvcm1zOiAvKkBfX1BVUkVfXyovIG1lcmdlVW5pZm9ybXMoIFsKCQkJVW5pZm9ybXNMaWIucG9pbnRzLAoJCQlVbmlmb3Jtc0xpYi5mb2cKCQldICksCgoJCXZlcnRleFNoYWRlcjogU2hhZGVyQ2h1bmsucG9pbnRzX3ZlcnQsCgkJZnJhZ21lbnRTaGFkZXI6IFNoYWRlckNodW5rLnBvaW50c19mcmFnCgoJfSwKCglkYXNoZWQ6IHsKCgkJdW5pZm9ybXM6IC8qQF9fUFVSRV9fKi8gbWVyZ2VVbmlmb3JtcyggWwoJCQlVbmlmb3Jtc0xpYi5jb21tb24sCgkJCVVuaWZvcm1zTGliLmZvZywKCQkJewoJCQkJc2NhbGU6IHsgdmFsdWU6IDEgfSwKCQkJCWRhc2hTaXplOiB7IHZhbHVlOiAxIH0sCgkJCQl0b3RhbFNpemU6IHsgdmFsdWU6IDIgfQoJCQl9CgkJXSApLAoKCQl2ZXJ0ZXhTaGFkZXI6IFNoYWRlckNodW5rLmxpbmVkYXNoZWRfdmVydCwKCQlmcmFnbWVudFNoYWRlcjogU2hhZGVyQ2h1bmsubGluZWRhc2hlZF9mcmFnCgoJfSwKCglkZXB0aDogewoKCQl1bmlmb3JtczogLypAX19QVVJFX18qLyBtZXJnZVVuaWZvcm1zKCBbCgkJCVVuaWZvcm1zTGliLmNvbW1vbiwKCQkJVW5pZm9ybXNMaWIuZGlzcGxhY2VtZW50bWFwCgkJXSApLAoKCQl2ZXJ0ZXhTaGFkZXI6IFNoYWRlckNodW5rLmRlcHRoX3ZlcnQsCgkJZnJhZ21lbnRTaGFkZXI6IFNoYWRlckNodW5rLmRlcHRoX2ZyYWcKCgl9LAoKCW5vcm1hbDogewoKCQl1bmlmb3JtczogLypAX19QVVJFX18qLyBtZXJnZVVuaWZvcm1zKCBbCgkJCVVuaWZvcm1zTGliLmNvbW1vbiwKCQkJVW5pZm9ybXNMaWIuYnVtcG1hcCwKCQkJVW5pZm9ybXNMaWIubm9ybWFsbWFwLAoJCQlVbmlmb3Jtc0xpYi5kaXNwbGFjZW1lbnRtYXAsCgkJCXsKCQkJCW9wYWNpdHk6IHsgdmFsdWU6IDEuMCB9CgkJCX0KCQldICksCgoJCXZlcnRleFNoYWRlcjogU2hhZGVyQ2h1bmsubWVzaG5vcm1hbF92ZXJ0LAoJCWZyYWdtZW50U2hhZGVyOiBTaGFkZXJDaHVuay5tZXNobm9ybWFsX2ZyYWcKCgl9LAoKCXNwcml0ZTogewoKCQl1bmlmb3JtczogLypAX19QVVJFX18qLyBtZXJnZVVuaWZvcm1zKCBbCgkJCVVuaWZvcm1zTGliLnNwcml0ZSwKCQkJVW5pZm9ybXNMaWIuZm9nCgkJXSApLAoKCQl2ZXJ0ZXhTaGFkZXI6IFNoYWRlckNodW5rLnNwcml0ZV92ZXJ0LAoJCWZyYWdtZW50U2hhZGVyOiBTaGFkZXJDaHVuay5zcHJpdGVfZnJhZwoKCX0sCgoJYmFja2dyb3VuZDogewoKCQl1bmlmb3JtczogewoJCQl1dlRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJCXQyRDogeyB2YWx1ZTogbnVsbCB9LAoJCQliYWNrZ3JvdW5kSW50ZW5zaXR5OiB7IHZhbHVlOiAxIH0KCQl9LAoKCQl2ZXJ0ZXhTaGFkZXI6IFNoYWRlckNodW5rLmJhY2tncm91bmRfdmVydCwKCQlmcmFnbWVudFNoYWRlcjogU2hhZGVyQ2h1bmsuYmFja2dyb3VuZF9mcmFnCgoJfSwKCgliYWNrZ3JvdW5kQ3ViZTogewoKCQl1bmlmb3JtczogewoJCQllbnZNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQkJZmxpcEVudk1hcDogeyB2YWx1ZTogLSAxIH0sCgkJCWJhY2tncm91bmRCbHVycmluZXNzOiB7IHZhbHVlOiAwIH0sCgkJCWJhY2tncm91bmRJbnRlbnNpdHk6IHsgdmFsdWU6IDEgfQoJCX0sCgoJCXZlcnRleFNoYWRlcjogU2hhZGVyQ2h1bmsuYmFja2dyb3VuZEN1YmVfdmVydCwKCQlmcmFnbWVudFNoYWRlcjogU2hhZGVyQ2h1bmsuYmFja2dyb3VuZEN1YmVfZnJhZwoKCX0sCgoJY3ViZTogewoKCQl1bmlmb3JtczogewoJCQl0Q3ViZTogeyB2YWx1ZTogbnVsbCB9LAoJCQl0RmxpcDogeyB2YWx1ZTogLSAxIH0sCgkJCW9wYWNpdHk6IHsgdmFsdWU6IDEuMCB9CgkJfSwKCgkJdmVydGV4U2hhZGVyOiBTaGFkZXJDaHVuay5jdWJlX3ZlcnQsCgkJZnJhZ21lbnRTaGFkZXI6IFNoYWRlckNodW5rLmN1YmVfZnJhZwoKCX0sCgoJZXF1aXJlY3Q6IHsKCgkJdW5pZm9ybXM6IHsKCQkJdEVxdWlyZWN0OiB7IHZhbHVlOiBudWxsIH0sCgkJfSwKCgkJdmVydGV4U2hhZGVyOiBTaGFkZXJDaHVuay5lcXVpcmVjdF92ZXJ0LAoJCWZyYWdtZW50U2hhZGVyOiBTaGFkZXJDaHVuay5lcXVpcmVjdF9mcmFnCgoJfSwKCglkaXN0YW5jZVJHQkE6IHsKCgkJdW5pZm9ybXM6IC8qQF9fUFVSRV9fKi8gbWVyZ2VVbmlmb3JtcyggWwoJCQlVbmlmb3Jtc0xpYi5jb21tb24sCgkJCVVuaWZvcm1zTGliLmRpc3BsYWNlbWVudG1hcCwKCQkJewoJCQkJcmVmZXJlbmNlUG9zaXRpb246IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKSB9LAoJCQkJbmVhckRpc3RhbmNlOiB7IHZhbHVlOiAxIH0sCgkJCQlmYXJEaXN0YW5jZTogeyB2YWx1ZTogMTAwMCB9CgkJCX0KCQldICksCgoJCXZlcnRleFNoYWRlcjogU2hhZGVyQ2h1bmsuZGlzdGFuY2VSR0JBX3ZlcnQsCgkJZnJhZ21lbnRTaGFkZXI6IFNoYWRlckNodW5rLmRpc3RhbmNlUkdCQV9mcmFnCgoJfSwKCglzaGFkb3c6IHsKCgkJdW5pZm9ybXM6IC8qQF9fUFVSRV9fKi8gbWVyZ2VVbmlmb3JtcyggWwoJCQlVbmlmb3Jtc0xpYi5saWdodHMsCgkJCVVuaWZvcm1zTGliLmZvZywKCQkJewoJCQkJY29sb3I6IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IENvbG9yKCAweDAwMDAwICkgfSwKCQkJCW9wYWNpdHk6IHsgdmFsdWU6IDEuMCB9CgkJCX0sCgkJXSApLAoKCQl2ZXJ0ZXhTaGFkZXI6IFNoYWRlckNodW5rLnNoYWRvd192ZXJ0LAoJCWZyYWdtZW50U2hhZGVyOiBTaGFkZXJDaHVuay5zaGFkb3dfZnJhZwoKCX0KCn07CgpTaGFkZXJMaWIucGh5c2ljYWwgPSB7CgoJdW5pZm9ybXM6IC8qQF9fUFVSRV9fKi8gbWVyZ2VVbmlmb3JtcyggWwoJCVNoYWRlckxpYi5zdGFuZGFyZC51bmlmb3JtcywKCQl7CgkJCWNsZWFyY29hdDogeyB2YWx1ZTogMCB9LAoJCQljbGVhcmNvYXRNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQkJY2xlYXJjb2F0TWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfSwKCQkJY2xlYXJjb2F0Tm9ybWFsTWFwOiB7IHZhbHVlOiBudWxsIH0sCgkJCWNsZWFyY29hdE5vcm1hbE1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJCWNsZWFyY29hdE5vcm1hbFNjYWxlOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCAxLCAxICkgfSwKCQkJY2xlYXJjb2F0Um91Z2huZXNzOiB7IHZhbHVlOiAwIH0sCgkJCWNsZWFyY29hdFJvdWdobmVzc01hcDogeyB2YWx1ZTogbnVsbCB9LAoJCQljbGVhcmNvYXRSb3VnaG5lc3NNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDMoKSB9LAoJCQlpcmlkZXNjZW5jZTogeyB2YWx1ZTogMCB9LAoJCQlpcmlkZXNjZW5jZU1hcDogeyB2YWx1ZTogbnVsbCB9LAoJCQlpcmlkZXNjZW5jZU1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJCWlyaWRlc2NlbmNlSU9SOiB7IHZhbHVlOiAxLjMgfSwKCQkJaXJpZGVzY2VuY2VUaGlja25lc3NNaW5pbXVtOiB7IHZhbHVlOiAxMDAgfSwKCQkJaXJpZGVzY2VuY2VUaGlja25lc3NNYXhpbXVtOiB7IHZhbHVlOiA0MDAgfSwKCQkJaXJpZGVzY2VuY2VUaGlja25lc3NNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQkJaXJpZGVzY2VuY2VUaGlja25lc3NNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDMoKSB9LAoJCQlzaGVlbjogeyB2YWx1ZTogMCB9LAoJCQlzaGVlbkNvbG9yOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBDb2xvciggMHgwMDAwMDAgKSB9LAoJCQlzaGVlbkNvbG9yTWFwOiB7IHZhbHVlOiBudWxsIH0sCgkJCXNoZWVuQ29sb3JNYXBUcmFuc2Zvcm06IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDMoKSB9LAoJCQlzaGVlblJvdWdobmVzczogeyB2YWx1ZTogMSB9LAoJCQlzaGVlblJvdWdobmVzc01hcDogeyB2YWx1ZTogbnVsbCB9LAoJCQlzaGVlblJvdWdobmVzc01hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJCXRyYW5zbWlzc2lvbjogeyB2YWx1ZTogMCB9LAoJCQl0cmFuc21pc3Npb25NYXA6IHsgdmFsdWU6IG51bGwgfSwKCQkJdHJhbnNtaXNzaW9uTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfSwKCQkJdHJhbnNtaXNzaW9uU2FtcGxlclNpemU6IHsgdmFsdWU6IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjIoKSB9LAoJCQl0cmFuc21pc3Npb25TYW1wbGVyTWFwOiB7IHZhbHVlOiBudWxsIH0sCgkJCXRoaWNrbmVzczogeyB2YWx1ZTogMCB9LAoJCQl0aGlja25lc3NNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQkJdGhpY2tuZXNzTWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfSwKCQkJYXR0ZW51YXRpb25EaXN0YW5jZTogeyB2YWx1ZTogMCB9LAoJCQlhdHRlbnVhdGlvbkNvbG9yOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBDb2xvciggMHgwMDAwMDAgKSB9LAoJCQlzcGVjdWxhckNvbG9yOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBDb2xvciggMSwgMSwgMSApIH0sCgkJCXNwZWN1bGFyQ29sb3JNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQkJc3BlY3VsYXJDb2xvck1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJCXNwZWN1bGFySW50ZW5zaXR5OiB7IHZhbHVlOiAxIH0sCgkJCXNwZWN1bGFySW50ZW5zaXR5TWFwOiB7IHZhbHVlOiBudWxsIH0sCgkJCXNwZWN1bGFySW50ZW5zaXR5TWFwVHJhbnNmb3JtOiB7IHZhbHVlOiAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXgzKCkgfSwKCQkJYW5pc290cm9weVZlY3RvcjogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMigpIH0sCgkJCWFuaXNvdHJvcHlNYXA6IHsgdmFsdWU6IG51bGwgfSwKCQkJYW5pc290cm9weU1hcFRyYW5zZm9ybTogeyB2YWx1ZTogLypAX19QVVJFX18qLyBuZXcgTWF0cml4MygpIH0sCgkJfQoJXSApLAoKCXZlcnRleFNoYWRlcjogU2hhZGVyQ2h1bmsubWVzaHBoeXNpY2FsX3ZlcnQsCglmcmFnbWVudFNoYWRlcjogU2hhZGVyQ2h1bmsubWVzaHBoeXNpY2FsX2ZyYWcKCn07Cgpjb25zdCBfcmdiID0geyByOiAwLCBiOiAwLCBnOiAwIH07CgpmdW5jdGlvbiBXZWJHTEJhY2tncm91bmQoIHJlbmRlcmVyLCBjdWJlbWFwcywgY3ViZXV2bWFwcywgc3RhdGUsIG9iamVjdHMsIGFscGhhLCBwcmVtdWx0aXBsaWVkQWxwaGEgKSB7CgoJY29uc3QgY2xlYXJDb2xvciA9IG5ldyBDb2xvciggMHgwMDAwMDAgKTsKCWxldCBjbGVhckFscGhhID0gYWxwaGEgPT09IHRydWUgPyAwIDogMTsKCglsZXQgcGxhbmVNZXNoOwoJbGV0IGJveE1lc2g7CgoJbGV0IGN1cnJlbnRCYWNrZ3JvdW5kID0gbnVsbDsKCWxldCBjdXJyZW50QmFja2dyb3VuZFZlcnNpb24gPSAwOwoJbGV0IGN1cnJlbnRUb25lbWFwcGluZyA9IG51bGw7CgoJZnVuY3Rpb24gcmVuZGVyKCByZW5kZXJMaXN0LCBzY2VuZSApIHsKCgkJbGV0IGZvcmNlQ2xlYXIgPSBmYWxzZTsKCQlsZXQgYmFja2dyb3VuZCA9IHNjZW5lLmlzU2NlbmUgPT09IHRydWUgPyBzY2VuZS5iYWNrZ3JvdW5kIDogbnVsbDsKCgkJaWYgKCBiYWNrZ3JvdW5kICYmIGJhY2tncm91bmQuaXNUZXh0dXJlICkgewoKCQkJY29uc3QgdXNlUE1SRU0gPSBzY2VuZS5iYWNrZ3JvdW5kQmx1cnJpbmVzcyA+IDA7IC8vIHVzZSBQTVJFTSBpZiB0aGUgdXNlciB3YW50cyB0byBibHVyIHRoZSBiYWNrZ3JvdW5kCgkJCWJhY2tncm91bmQgPSAoIHVzZVBNUkVNID8gY3ViZXV2bWFwcyA6IGN1YmVtYXBzICkuZ2V0KCBiYWNrZ3JvdW5kICk7CgoJCX0KCgkJaWYgKCBiYWNrZ3JvdW5kID09PSBudWxsICkgewoKCQkJc2V0Q2xlYXIoIGNsZWFyQ29sb3IsIGNsZWFyQWxwaGEgKTsKCgkJfSBlbHNlIGlmICggYmFja2dyb3VuZCAmJiBiYWNrZ3JvdW5kLmlzQ29sb3IgKSB7CgoJCQlzZXRDbGVhciggYmFja2dyb3VuZCwgMSApOwoJCQlmb3JjZUNsZWFyID0gdHJ1ZTsKCgkJfQoKCQljb25zdCBlbnZpcm9ubWVudEJsZW5kTW9kZSA9IHJlbmRlcmVyLnhyLmdldEVudmlyb25tZW50QmxlbmRNb2RlKCk7CgoJCWlmICggZW52aXJvbm1lbnRCbGVuZE1vZGUgPT09ICdhZGRpdGl2ZScgKSB7CgoJCQlzdGF0ZS5idWZmZXJzLmNvbG9yLnNldENsZWFyKCAwLCAwLCAwLCAxLCBwcmVtdWx0aXBsaWVkQWxwaGEgKTsKCgkJfSBlbHNlIGlmICggZW52aXJvbm1lbnRCbGVuZE1vZGUgPT09ICdhbHBoYS1ibGVuZCcgKSB7CgoJCQlzdGF0ZS5idWZmZXJzLmNvbG9yLnNldENsZWFyKCAwLCAwLCAwLCAwLCBwcmVtdWx0aXBsaWVkQWxwaGEgKTsKCgkJfQoKCQlpZiAoIHJlbmRlcmVyLmF1dG9DbGVhciB8fCBmb3JjZUNsZWFyICkgewoKCQkJcmVuZGVyZXIuY2xlYXIoIHJlbmRlcmVyLmF1dG9DbGVhckNvbG9yLCByZW5kZXJlci5hdXRvQ2xlYXJEZXB0aCwgcmVuZGVyZXIuYXV0b0NsZWFyU3RlbmNpbCApOwoKCQl9CgoJCWlmICggYmFja2dyb3VuZCAmJiAoIGJhY2tncm91bmQuaXNDdWJlVGV4dHVyZSB8fCBiYWNrZ3JvdW5kLm1hcHBpbmcgPT09IEN1YmVVVlJlZmxlY3Rpb25NYXBwaW5nICkgKSB7CgoJCQlpZiAoIGJveE1lc2ggPT09IHVuZGVmaW5lZCApIHsKCgkJCQlib3hNZXNoID0gbmV3IE1lc2goCgkJCQkJbmV3IEJveEdlb21ldHJ5KCAxLCAxLCAxICksCgkJCQkJbmV3IFNoYWRlck1hdGVyaWFsKCB7CgkJCQkJCW5hbWU6ICdCYWNrZ3JvdW5kQ3ViZU1hdGVyaWFsJywKCQkJCQkJdW5pZm9ybXM6IGNsb25lVW5pZm9ybXMoIFNoYWRlckxpYi5iYWNrZ3JvdW5kQ3ViZS51bmlmb3JtcyApLAoJCQkJCQl2ZXJ0ZXhTaGFkZXI6IFNoYWRlckxpYi5iYWNrZ3JvdW5kQ3ViZS52ZXJ0ZXhTaGFkZXIsCgkJCQkJCWZyYWdtZW50U2hhZGVyOiBTaGFkZXJMaWIuYmFja2dyb3VuZEN1YmUuZnJhZ21lbnRTaGFkZXIsCgkJCQkJCXNpZGU6IEJhY2tTaWRlLAoJCQkJCQlkZXB0aFRlc3Q6IGZhbHNlLAoJCQkJCQlkZXB0aFdyaXRlOiBmYWxzZSwKCQkJCQkJZm9nOiBmYWxzZQoJCQkJCX0gKQoJCQkJKTsKCgkJCQlib3hNZXNoLmdlb21ldHJ5LmRlbGV0ZUF0dHJpYnV0ZSggJ25vcm1hbCcgKTsKCQkJCWJveE1lc2guZ2VvbWV0cnkuZGVsZXRlQXR0cmlidXRlKCAndXYnICk7CgoJCQkJYm94TWVzaC5vbkJlZm9yZVJlbmRlciA9IGZ1bmN0aW9uICggcmVuZGVyZXIsIHNjZW5lLCBjYW1lcmEgKSB7CgoJCQkJCXRoaXMubWF0cml4V29ybGQuY29weVBvc2l0aW9uKCBjYW1lcmEubWF0cml4V29ybGQgKTsKCgkJCQl9OwoKCQkJCS8vIGFkZCAiZW52TWFwIiBtYXRlcmlhbCBwcm9wZXJ0eSBzbyB0aGUgcmVuZGVyZXIgY2FuIGV2YWx1YXRlIGl0IGxpa2UgZm9yIGJ1aWx0LWluIG1hdGVyaWFscwoJCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KCBib3hNZXNoLm1hdGVyaWFsLCAnZW52TWFwJywgewoKCQkJCQlnZXQ6IGZ1bmN0aW9uICgpIHsKCgkJCQkJCXJldHVybiB0aGlzLnVuaWZvcm1zLmVudk1hcC52YWx1ZTsKCgkJCQkJfQoKCQkJCX0gKTsKCgkJCQlvYmplY3RzLnVwZGF0ZSggYm94TWVzaCApOwoKCQkJfQoKCQkJYm94TWVzaC5tYXRlcmlhbC51bmlmb3Jtcy5lbnZNYXAudmFsdWUgPSBiYWNrZ3JvdW5kOwoJCQlib3hNZXNoLm1hdGVyaWFsLnVuaWZvcm1zLmZsaXBFbnZNYXAudmFsdWUgPSAoIGJhY2tncm91bmQuaXNDdWJlVGV4dHVyZSAmJiBiYWNrZ3JvdW5kLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9PT0gZmFsc2UgKSA/IC0gMSA6IDE7CgkJCWJveE1lc2gubWF0ZXJpYWwudW5pZm9ybXMuYmFja2dyb3VuZEJsdXJyaW5lc3MudmFsdWUgPSBzY2VuZS5iYWNrZ3JvdW5kQmx1cnJpbmVzczsKCQkJYm94TWVzaC5tYXRlcmlhbC51bmlmb3Jtcy5iYWNrZ3JvdW5kSW50ZW5zaXR5LnZhbHVlID0gc2NlbmUuYmFja2dyb3VuZEludGVuc2l0eTsKCQkJYm94TWVzaC5tYXRlcmlhbC50b25lTWFwcGVkID0gQ29sb3JNYW5hZ2VtZW50LmdldFRyYW5zZmVyKCBiYWNrZ3JvdW5kLmNvbG9yU3BhY2UgKSAhPT0gU1JHQlRyYW5zZmVyOwoKCQkJaWYgKCBjdXJyZW50QmFja2dyb3VuZCAhPT0gYmFja2dyb3VuZCB8fAoJCQkJY3VycmVudEJhY2tncm91bmRWZXJzaW9uICE9PSBiYWNrZ3JvdW5kLnZlcnNpb24gfHwKCQkJCWN1cnJlbnRUb25lbWFwcGluZyAhPT0gcmVuZGVyZXIudG9uZU1hcHBpbmcgKSB7CgoJCQkJYm94TWVzaC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCQkJY3VycmVudEJhY2tncm91bmQgPSBiYWNrZ3JvdW5kOwoJCQkJY3VycmVudEJhY2tncm91bmRWZXJzaW9uID0gYmFja2dyb3VuZC52ZXJzaW9uOwoJCQkJY3VycmVudFRvbmVtYXBwaW5nID0gcmVuZGVyZXIudG9uZU1hcHBpbmc7CgoJCQl9CgoJCQlib3hNZXNoLmxheWVycy5lbmFibGVBbGwoKTsKCgkJCS8vIHB1c2ggdG8gdGhlIHByZS1zb3J0ZWQgb3BhcXVlIHJlbmRlciBsaXN0CgkJCXJlbmRlckxpc3QudW5zaGlmdCggYm94TWVzaCwgYm94TWVzaC5nZW9tZXRyeSwgYm94TWVzaC5tYXRlcmlhbCwgMCwgMCwgbnVsbCApOwoKCQl9IGVsc2UgaWYgKCBiYWNrZ3JvdW5kICYmIGJhY2tncm91bmQuaXNUZXh0dXJlICkgewoKCQkJaWYgKCBwbGFuZU1lc2ggPT09IHVuZGVmaW5lZCApIHsKCgkJCQlwbGFuZU1lc2ggPSBuZXcgTWVzaCgKCQkJCQluZXcgUGxhbmVHZW9tZXRyeSggMiwgMiApLAoJCQkJCW5ldyBTaGFkZXJNYXRlcmlhbCggewoJCQkJCQluYW1lOiAnQmFja2dyb3VuZE1hdGVyaWFsJywKCQkJCQkJdW5pZm9ybXM6IGNsb25lVW5pZm9ybXMoIFNoYWRlckxpYi5iYWNrZ3JvdW5kLnVuaWZvcm1zICksCgkJCQkJCXZlcnRleFNoYWRlcjogU2hhZGVyTGliLmJhY2tncm91bmQudmVydGV4U2hhZGVyLAoJCQkJCQlmcmFnbWVudFNoYWRlcjogU2hhZGVyTGliLmJhY2tncm91bmQuZnJhZ21lbnRTaGFkZXIsCgkJCQkJCXNpZGU6IEZyb250U2lkZSwKCQkJCQkJZGVwdGhUZXN0OiBmYWxzZSwKCQkJCQkJZGVwdGhXcml0ZTogZmFsc2UsCgkJCQkJCWZvZzogZmFsc2UKCQkJCQl9ICkKCQkJCSk7CgoJCQkJcGxhbmVNZXNoLmdlb21ldHJ5LmRlbGV0ZUF0dHJpYnV0ZSggJ25vcm1hbCcgKTsKCgkJCQkvLyBhZGQgIm1hcCIgbWF0ZXJpYWwgcHJvcGVydHkgc28gdGhlIHJlbmRlcmVyIGNhbiBldmFsdWF0ZSBpdCBsaWtlIGZvciBidWlsdC1pbiBtYXRlcmlhbHMKCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggcGxhbmVNZXNoLm1hdGVyaWFsLCAnbWFwJywgewoKCQkJCQlnZXQ6IGZ1bmN0aW9uICgpIHsKCgkJCQkJCXJldHVybiB0aGlzLnVuaWZvcm1zLnQyRC52YWx1ZTsKCgkJCQkJfQoKCQkJCX0gKTsKCgkJCQlvYmplY3RzLnVwZGF0ZSggcGxhbmVNZXNoICk7CgoJCQl9CgoJCQlwbGFuZU1lc2gubWF0ZXJpYWwudW5pZm9ybXMudDJELnZhbHVlID0gYmFja2dyb3VuZDsKCQkJcGxhbmVNZXNoLm1hdGVyaWFsLnVuaWZvcm1zLmJhY2tncm91bmRJbnRlbnNpdHkudmFsdWUgPSBzY2VuZS5iYWNrZ3JvdW5kSW50ZW5zaXR5OwoJCQlwbGFuZU1lc2gubWF0ZXJpYWwudG9uZU1hcHBlZCA9IENvbG9yTWFuYWdlbWVudC5nZXRUcmFuc2ZlciggYmFja2dyb3VuZC5jb2xvclNwYWNlICkgIT09IFNSR0JUcmFuc2ZlcjsKCgkJCWlmICggYmFja2dyb3VuZC5tYXRyaXhBdXRvVXBkYXRlID09PSB0cnVlICkgewoKCQkJCWJhY2tncm91bmQudXBkYXRlTWF0cml4KCk7CgoJCQl9CgoJCQlwbGFuZU1lc2gubWF0ZXJpYWwudW5pZm9ybXMudXZUcmFuc2Zvcm0udmFsdWUuY29weSggYmFja2dyb3VuZC5tYXRyaXggKTsKCgkJCWlmICggY3VycmVudEJhY2tncm91bmQgIT09IGJhY2tncm91bmQgfHwKCQkJCWN1cnJlbnRCYWNrZ3JvdW5kVmVyc2lvbiAhPT0gYmFja2dyb3VuZC52ZXJzaW9uIHx8CgkJCQljdXJyZW50VG9uZW1hcHBpbmcgIT09IHJlbmRlcmVyLnRvbmVNYXBwaW5nICkgewoKCQkJCXBsYW5lTWVzaC5tYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCQkJY3VycmVudEJhY2tncm91bmQgPSBiYWNrZ3JvdW5kOwoJCQkJY3VycmVudEJhY2tncm91bmRWZXJzaW9uID0gYmFja2dyb3VuZC52ZXJzaW9uOwoJCQkJY3VycmVudFRvbmVtYXBwaW5nID0gcmVuZGVyZXIudG9uZU1hcHBpbmc7CgoJCQl9CgoJCQlwbGFuZU1lc2gubGF5ZXJzLmVuYWJsZUFsbCgpOwoKCQkJLy8gcHVzaCB0byB0aGUgcHJlLXNvcnRlZCBvcGFxdWUgcmVuZGVyIGxpc3QKCQkJcmVuZGVyTGlzdC51bnNoaWZ0KCBwbGFuZU1lc2gsIHBsYW5lTWVzaC5nZW9tZXRyeSwgcGxhbmVNZXNoLm1hdGVyaWFsLCAwLCAwLCBudWxsICk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gc2V0Q2xlYXIoIGNvbG9yLCBhbHBoYSApIHsKCgkJY29sb3IuZ2V0UkdCKCBfcmdiLCBnZXRVbmxpdFVuaWZvcm1Db2xvclNwYWNlKCByZW5kZXJlciApICk7CgoJCXN0YXRlLmJ1ZmZlcnMuY29sb3Iuc2V0Q2xlYXIoIF9yZ2IuciwgX3JnYi5nLCBfcmdiLmIsIGFscGhhLCBwcmVtdWx0aXBsaWVkQWxwaGEgKTsKCgl9CgoJcmV0dXJuIHsKCgkJZ2V0Q2xlYXJDb2xvcjogZnVuY3Rpb24gKCkgewoKCQkJcmV0dXJuIGNsZWFyQ29sb3I7CgoJCX0sCgkJc2V0Q2xlYXJDb2xvcjogZnVuY3Rpb24gKCBjb2xvciwgYWxwaGEgPSAxICkgewoKCQkJY2xlYXJDb2xvci5zZXQoIGNvbG9yICk7CgkJCWNsZWFyQWxwaGEgPSBhbHBoYTsKCQkJc2V0Q2xlYXIoIGNsZWFyQ29sb3IsIGNsZWFyQWxwaGEgKTsKCgkJfSwKCQlnZXRDbGVhckFscGhhOiBmdW5jdGlvbiAoKSB7CgoJCQlyZXR1cm4gY2xlYXJBbHBoYTsKCgkJfSwKCQlzZXRDbGVhckFscGhhOiBmdW5jdGlvbiAoIGFscGhhICkgewoKCQkJY2xlYXJBbHBoYSA9IGFscGhhOwoJCQlzZXRDbGVhciggY2xlYXJDb2xvciwgY2xlYXJBbHBoYSApOwoKCQl9LAoJCXJlbmRlcjogcmVuZGVyCgoJfTsKCn0KCmZ1bmN0aW9uIFdlYkdMQmluZGluZ1N0YXRlcyggZ2wsIGV4dGVuc2lvbnMsIGF0dHJpYnV0ZXMsIGNhcGFiaWxpdGllcyApIHsKCgljb25zdCBtYXhWZXJ0ZXhBdHRyaWJ1dGVzID0gZ2wuZ2V0UGFyYW1ldGVyKCBnbC5NQVhfVkVSVEVYX0FUVFJJQlMgKTsKCgljb25zdCBleHRlbnNpb24gPSBjYXBhYmlsaXRpZXMuaXNXZWJHTDIgPyBudWxsIDogZXh0ZW5zaW9ucy5nZXQoICdPRVNfdmVydGV4X2FycmF5X29iamVjdCcgKTsKCWNvbnN0IHZhb0F2YWlsYWJsZSA9IGNhcGFiaWxpdGllcy5pc1dlYkdMMiB8fCBleHRlbnNpb24gIT09IG51bGw7CgoJY29uc3QgYmluZGluZ1N0YXRlcyA9IHt9OwoKCWNvbnN0IGRlZmF1bHRTdGF0ZSA9IGNyZWF0ZUJpbmRpbmdTdGF0ZSggbnVsbCApOwoJbGV0IGN1cnJlbnRTdGF0ZSA9IGRlZmF1bHRTdGF0ZTsKCWxldCBmb3JjZVVwZGF0ZSA9IGZhbHNlOwoKCWZ1bmN0aW9uIHNldHVwKCBvYmplY3QsIG1hdGVyaWFsLCBwcm9ncmFtLCBnZW9tZXRyeSwgaW5kZXggKSB7CgoJCWxldCB1cGRhdGVCdWZmZXJzID0gZmFsc2U7CgoJCWlmICggdmFvQXZhaWxhYmxlICkgewoKCQkJY29uc3Qgc3RhdGUgPSBnZXRCaW5kaW5nU3RhdGUoIGdlb21ldHJ5LCBwcm9ncmFtLCBtYXRlcmlhbCApOwoKCQkJaWYgKCBjdXJyZW50U3RhdGUgIT09IHN0YXRlICkgewoKCQkJCWN1cnJlbnRTdGF0ZSA9IHN0YXRlOwoJCQkJYmluZFZlcnRleEFycmF5T2JqZWN0KCBjdXJyZW50U3RhdGUub2JqZWN0ICk7CgoJCQl9CgoJCQl1cGRhdGVCdWZmZXJzID0gbmVlZHNVcGRhdGUoIG9iamVjdCwgZ2VvbWV0cnksIHByb2dyYW0sIGluZGV4ICk7CgoJCQlpZiAoIHVwZGF0ZUJ1ZmZlcnMgKSBzYXZlQ2FjaGUoIG9iamVjdCwgZ2VvbWV0cnksIHByb2dyYW0sIGluZGV4ICk7CgoJCX0gZWxzZSB7CgoJCQljb25zdCB3aXJlZnJhbWUgPSAoIG1hdGVyaWFsLndpcmVmcmFtZSA9PT0gdHJ1ZSApOwoKCQkJaWYgKCBjdXJyZW50U3RhdGUuZ2VvbWV0cnkgIT09IGdlb21ldHJ5LmlkIHx8CgkJCQljdXJyZW50U3RhdGUucHJvZ3JhbSAhPT0gcHJvZ3JhbS5pZCB8fAoJCQkJY3VycmVudFN0YXRlLndpcmVmcmFtZSAhPT0gd2lyZWZyYW1lICkgewoKCQkJCWN1cnJlbnRTdGF0ZS5nZW9tZXRyeSA9IGdlb21ldHJ5LmlkOwoJCQkJY3VycmVudFN0YXRlLnByb2dyYW0gPSBwcm9ncmFtLmlkOwoJCQkJY3VycmVudFN0YXRlLndpcmVmcmFtZSA9IHdpcmVmcmFtZTsKCgkJCQl1cGRhdGVCdWZmZXJzID0gdHJ1ZTsKCgkJCX0KCgkJfQoKCQlpZiAoIGluZGV4ICE9PSBudWxsICkgewoKCQkJYXR0cmlidXRlcy51cGRhdGUoIGluZGV4LCBnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiApOwoKCQl9CgoJCWlmICggdXBkYXRlQnVmZmVycyB8fCBmb3JjZVVwZGF0ZSApIHsKCgkJCWZvcmNlVXBkYXRlID0gZmFsc2U7CgoJCQlzZXR1cFZlcnRleEF0dHJpYnV0ZXMoIG9iamVjdCwgbWF0ZXJpYWwsIHByb2dyYW0sIGdlb21ldHJ5ICk7CgoJCQlpZiAoIGluZGV4ICE9PSBudWxsICkgewoKCQkJCWdsLmJpbmRCdWZmZXIoIGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBhdHRyaWJ1dGVzLmdldCggaW5kZXggKS5idWZmZXIgKTsKCgkJCX0KCgkJfQoKCX0KCglmdW5jdGlvbiBjcmVhdGVWZXJ0ZXhBcnJheU9iamVjdCgpIHsKCgkJaWYgKCBjYXBhYmlsaXRpZXMuaXNXZWJHTDIgKSByZXR1cm4gZ2wuY3JlYXRlVmVydGV4QXJyYXkoKTsKCgkJcmV0dXJuIGV4dGVuc2lvbi5jcmVhdGVWZXJ0ZXhBcnJheU9FUygpOwoKCX0KCglmdW5jdGlvbiBiaW5kVmVydGV4QXJyYXlPYmplY3QoIHZhbyApIHsKCgkJaWYgKCBjYXBhYmlsaXRpZXMuaXNXZWJHTDIgKSByZXR1cm4gZ2wuYmluZFZlcnRleEFycmF5KCB2YW8gKTsKCgkJcmV0dXJuIGV4dGVuc2lvbi5iaW5kVmVydGV4QXJyYXlPRVMoIHZhbyApOwoKCX0KCglmdW5jdGlvbiBkZWxldGVWZXJ0ZXhBcnJheU9iamVjdCggdmFvICkgewoKCQlpZiAoIGNhcGFiaWxpdGllcy5pc1dlYkdMMiApIHJldHVybiBnbC5kZWxldGVWZXJ0ZXhBcnJheSggdmFvICk7CgoJCXJldHVybiBleHRlbnNpb24uZGVsZXRlVmVydGV4QXJyYXlPRVMoIHZhbyApOwoKCX0KCglmdW5jdGlvbiBnZXRCaW5kaW5nU3RhdGUoIGdlb21ldHJ5LCBwcm9ncmFtLCBtYXRlcmlhbCApIHsKCgkJY29uc3Qgd2lyZWZyYW1lID0gKCBtYXRlcmlhbC53aXJlZnJhbWUgPT09IHRydWUgKTsKCgkJbGV0IHByb2dyYW1NYXAgPSBiaW5kaW5nU3RhdGVzWyBnZW9tZXRyeS5pZCBdOwoKCQlpZiAoIHByb2dyYW1NYXAgPT09IHVuZGVmaW5lZCApIHsKCgkJCXByb2dyYW1NYXAgPSB7fTsKCQkJYmluZGluZ1N0YXRlc1sgZ2VvbWV0cnkuaWQgXSA9IHByb2dyYW1NYXA7CgoJCX0KCgkJbGV0IHN0YXRlTWFwID0gcHJvZ3JhbU1hcFsgcHJvZ3JhbS5pZCBdOwoKCQlpZiAoIHN0YXRlTWFwID09PSB1bmRlZmluZWQgKSB7CgoJCQlzdGF0ZU1hcCA9IHt9OwoJCQlwcm9ncmFtTWFwWyBwcm9ncmFtLmlkIF0gPSBzdGF0ZU1hcDsKCgkJfQoKCQlsZXQgc3RhdGUgPSBzdGF0ZU1hcFsgd2lyZWZyYW1lIF07CgoJCWlmICggc3RhdGUgPT09IHVuZGVmaW5lZCApIHsKCgkJCXN0YXRlID0gY3JlYXRlQmluZGluZ1N0YXRlKCBjcmVhdGVWZXJ0ZXhBcnJheU9iamVjdCgpICk7CgkJCXN0YXRlTWFwWyB3aXJlZnJhbWUgXSA9IHN0YXRlOwoKCQl9CgoJCXJldHVybiBzdGF0ZTsKCgl9CgoJZnVuY3Rpb24gY3JlYXRlQmluZGluZ1N0YXRlKCB2YW8gKSB7CgoJCWNvbnN0IG5ld0F0dHJpYnV0ZXMgPSBbXTsKCQljb25zdCBlbmFibGVkQXR0cmlidXRlcyA9IFtdOwoJCWNvbnN0IGF0dHJpYnV0ZURpdmlzb3JzID0gW107CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IG1heFZlcnRleEF0dHJpYnV0ZXM7IGkgKysgKSB7CgoJCQluZXdBdHRyaWJ1dGVzWyBpIF0gPSAwOwoJCQllbmFibGVkQXR0cmlidXRlc1sgaSBdID0gMDsKCQkJYXR0cmlidXRlRGl2aXNvcnNbIGkgXSA9IDA7CgoJCX0KCgkJcmV0dXJuIHsKCgkJCS8vIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5IG9uIG5vbi1WQU8gc3VwcG9ydCBicm93c2VyCgkJCWdlb21ldHJ5OiBudWxsLAoJCQlwcm9ncmFtOiBudWxsLAoJCQl3aXJlZnJhbWU6IGZhbHNlLAoKCQkJbmV3QXR0cmlidXRlczogbmV3QXR0cmlidXRlcywKCQkJZW5hYmxlZEF0dHJpYnV0ZXM6IGVuYWJsZWRBdHRyaWJ1dGVzLAoJCQlhdHRyaWJ1dGVEaXZpc29yczogYXR0cmlidXRlRGl2aXNvcnMsCgkJCW9iamVjdDogdmFvLAoJCQlhdHRyaWJ1dGVzOiB7fSwKCQkJaW5kZXg6IG51bGwKCgkJfTsKCgl9CgoJZnVuY3Rpb24gbmVlZHNVcGRhdGUoIG9iamVjdCwgZ2VvbWV0cnksIHByb2dyYW0sIGluZGV4ICkgewoKCQljb25zdCBjYWNoZWRBdHRyaWJ1dGVzID0gY3VycmVudFN0YXRlLmF0dHJpYnV0ZXM7CgkJY29uc3QgZ2VvbWV0cnlBdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKCgkJbGV0IGF0dHJpYnV0ZXNOdW0gPSAwOwoKCQljb25zdCBwcm9ncmFtQXR0cmlidXRlcyA9IHByb2dyYW0uZ2V0QXR0cmlidXRlcygpOwoKCQlmb3IgKCBjb25zdCBuYW1lIGluIHByb2dyYW1BdHRyaWJ1dGVzICkgewoKCQkJY29uc3QgcHJvZ3JhbUF0dHJpYnV0ZSA9IHByb2dyYW1BdHRyaWJ1dGVzWyBuYW1lIF07CgoJCQlpZiAoIHByb2dyYW1BdHRyaWJ1dGUubG9jYXRpb24gPj0gMCApIHsKCgkJCQljb25zdCBjYWNoZWRBdHRyaWJ1dGUgPSBjYWNoZWRBdHRyaWJ1dGVzWyBuYW1lIF07CgkJCQlsZXQgZ2VvbWV0cnlBdHRyaWJ1dGUgPSBnZW9tZXRyeUF0dHJpYnV0ZXNbIG5hbWUgXTsKCgkJCQlpZiAoIGdlb21ldHJ5QXR0cmlidXRlID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCWlmICggbmFtZSA9PT0gJ2luc3RhbmNlTWF0cml4JyAmJiBvYmplY3QuaW5zdGFuY2VNYXRyaXggKSBnZW9tZXRyeUF0dHJpYnV0ZSA9IG9iamVjdC5pbnN0YW5jZU1hdHJpeDsKCQkJCQlpZiAoIG5hbWUgPT09ICdpbnN0YW5jZUNvbG9yJyAmJiBvYmplY3QuaW5zdGFuY2VDb2xvciApIGdlb21ldHJ5QXR0cmlidXRlID0gb2JqZWN0Lmluc3RhbmNlQ29sb3I7CgoJCQkJfQoKCQkJCWlmICggY2FjaGVkQXR0cmlidXRlID09PSB1bmRlZmluZWQgKSByZXR1cm4gdHJ1ZTsKCgkJCQlpZiAoIGNhY2hlZEF0dHJpYnV0ZS5hdHRyaWJ1dGUgIT09IGdlb21ldHJ5QXR0cmlidXRlICkgcmV0dXJuIHRydWU7CgoJCQkJaWYgKCBnZW9tZXRyeUF0dHJpYnV0ZSAmJiBjYWNoZWRBdHRyaWJ1dGUuZGF0YSAhPT0gZ2VvbWV0cnlBdHRyaWJ1dGUuZGF0YSApIHJldHVybiB0cnVlOwoKCQkJCWF0dHJpYnV0ZXNOdW0gKys7CgoJCQl9CgoJCX0KCgkJaWYgKCBjdXJyZW50U3RhdGUuYXR0cmlidXRlc051bSAhPT0gYXR0cmlidXRlc051bSApIHJldHVybiB0cnVlOwoKCQlpZiAoIGN1cnJlbnRTdGF0ZS5pbmRleCAhPT0gaW5kZXggKSByZXR1cm4gdHJ1ZTsKCgkJcmV0dXJuIGZhbHNlOwoKCX0KCglmdW5jdGlvbiBzYXZlQ2FjaGUoIG9iamVjdCwgZ2VvbWV0cnksIHByb2dyYW0sIGluZGV4ICkgewoKCQljb25zdCBjYWNoZSA9IHt9OwoJCWNvbnN0IGF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwoJCWxldCBhdHRyaWJ1dGVzTnVtID0gMDsKCgkJY29uc3QgcHJvZ3JhbUF0dHJpYnV0ZXMgPSBwcm9ncmFtLmdldEF0dHJpYnV0ZXMoKTsKCgkJZm9yICggY29uc3QgbmFtZSBpbiBwcm9ncmFtQXR0cmlidXRlcyApIHsKCgkJCWNvbnN0IHByb2dyYW1BdHRyaWJ1dGUgPSBwcm9ncmFtQXR0cmlidXRlc1sgbmFtZSBdOwoKCQkJaWYgKCBwcm9ncmFtQXR0cmlidXRlLmxvY2F0aW9uID49IDAgKSB7CgoJCQkJbGV0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXNbIG5hbWUgXTsKCgkJCQlpZiAoIGF0dHJpYnV0ZSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCQlpZiAoIG5hbWUgPT09ICdpbnN0YW5jZU1hdHJpeCcgJiYgb2JqZWN0Lmluc3RhbmNlTWF0cml4ICkgYXR0cmlidXRlID0gb2JqZWN0Lmluc3RhbmNlTWF0cml4OwoJCQkJCWlmICggbmFtZSA9PT0gJ2luc3RhbmNlQ29sb3InICYmIG9iamVjdC5pbnN0YW5jZUNvbG9yICkgYXR0cmlidXRlID0gb2JqZWN0Lmluc3RhbmNlQ29sb3I7CgoJCQkJfQoKCQkJCWNvbnN0IGRhdGEgPSB7fTsKCQkJCWRhdGEuYXR0cmlidXRlID0gYXR0cmlidXRlOwoKCQkJCWlmICggYXR0cmlidXRlICYmIGF0dHJpYnV0ZS5kYXRhICkgewoKCQkJCQlkYXRhLmRhdGEgPSBhdHRyaWJ1dGUuZGF0YTsKCgkJCQl9CgoJCQkJY2FjaGVbIG5hbWUgXSA9IGRhdGE7CgoJCQkJYXR0cmlidXRlc051bSArKzsKCgkJCX0KCgkJfQoKCQljdXJyZW50U3RhdGUuYXR0cmlidXRlcyA9IGNhY2hlOwoJCWN1cnJlbnRTdGF0ZS5hdHRyaWJ1dGVzTnVtID0gYXR0cmlidXRlc051bTsKCgkJY3VycmVudFN0YXRlLmluZGV4ID0gaW5kZXg7CgoJfQoKCWZ1bmN0aW9uIGluaXRBdHRyaWJ1dGVzKCkgewoKCQljb25zdCBuZXdBdHRyaWJ1dGVzID0gY3VycmVudFN0YXRlLm5ld0F0dHJpYnV0ZXM7CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSBuZXdBdHRyaWJ1dGVzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJbmV3QXR0cmlidXRlc1sgaSBdID0gMDsKCgkJfQoKCX0KCglmdW5jdGlvbiBlbmFibGVBdHRyaWJ1dGUoIGF0dHJpYnV0ZSApIHsKCgkJZW5hYmxlQXR0cmlidXRlQW5kRGl2aXNvciggYXR0cmlidXRlLCAwICk7CgoJfQoKCWZ1bmN0aW9uIGVuYWJsZUF0dHJpYnV0ZUFuZERpdmlzb3IoIGF0dHJpYnV0ZSwgbWVzaFBlckF0dHJpYnV0ZSApIHsKCgkJY29uc3QgbmV3QXR0cmlidXRlcyA9IGN1cnJlbnRTdGF0ZS5uZXdBdHRyaWJ1dGVzOwoJCWNvbnN0IGVuYWJsZWRBdHRyaWJ1dGVzID0gY3VycmVudFN0YXRlLmVuYWJsZWRBdHRyaWJ1dGVzOwoJCWNvbnN0IGF0dHJpYnV0ZURpdmlzb3JzID0gY3VycmVudFN0YXRlLmF0dHJpYnV0ZURpdmlzb3JzOwoKCQluZXdBdHRyaWJ1dGVzWyBhdHRyaWJ1dGUgXSA9IDE7CgoJCWlmICggZW5hYmxlZEF0dHJpYnV0ZXNbIGF0dHJpYnV0ZSBdID09PSAwICkgewoKCQkJZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoIGF0dHJpYnV0ZSApOwoJCQllbmFibGVkQXR0cmlidXRlc1sgYXR0cmlidXRlIF0gPSAxOwoKCQl9CgoJCWlmICggYXR0cmlidXRlRGl2aXNvcnNbIGF0dHJpYnV0ZSBdICE9PSBtZXNoUGVyQXR0cmlidXRlICkgewoKCQkJY29uc3QgZXh0ZW5zaW9uID0gY2FwYWJpbGl0aWVzLmlzV2ViR0wyID8gZ2wgOiBleHRlbnNpb25zLmdldCggJ0FOR0xFX2luc3RhbmNlZF9hcnJheXMnICk7CgoJCQlleHRlbnNpb25bIGNhcGFiaWxpdGllcy5pc1dlYkdMMiA/ICd2ZXJ0ZXhBdHRyaWJEaXZpc29yJyA6ICd2ZXJ0ZXhBdHRyaWJEaXZpc29yQU5HTEUnIF0oIGF0dHJpYnV0ZSwgbWVzaFBlckF0dHJpYnV0ZSApOwoJCQlhdHRyaWJ1dGVEaXZpc29yc1sgYXR0cmlidXRlIF0gPSBtZXNoUGVyQXR0cmlidXRlOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIGRpc2FibGVVbnVzZWRBdHRyaWJ1dGVzKCkgewoKCQljb25zdCBuZXdBdHRyaWJ1dGVzID0gY3VycmVudFN0YXRlLm5ld0F0dHJpYnV0ZXM7CgkJY29uc3QgZW5hYmxlZEF0dHJpYnV0ZXMgPSBjdXJyZW50U3RhdGUuZW5hYmxlZEF0dHJpYnV0ZXM7CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSBlbmFibGVkQXR0cmlidXRlcy5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCWlmICggZW5hYmxlZEF0dHJpYnV0ZXNbIGkgXSAhPT0gbmV3QXR0cmlidXRlc1sgaSBdICkgewoKCQkJCWdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheSggaSApOwoJCQkJZW5hYmxlZEF0dHJpYnV0ZXNbIGkgXSA9IDA7CgoJCQl9CgoJCX0KCgl9CgoJZnVuY3Rpb24gdmVydGV4QXR0cmliUG9pbnRlciggaW5kZXgsIHNpemUsIHR5cGUsIG5vcm1hbGl6ZWQsIHN0cmlkZSwgb2Zmc2V0LCBpbnRlZ2VyICkgewoKCQlpZiAoIGludGVnZXIgPT09IHRydWUgKSB7CgoJCQlnbC52ZXJ0ZXhBdHRyaWJJUG9pbnRlciggaW5kZXgsIHNpemUsIHR5cGUsIHN0cmlkZSwgb2Zmc2V0ICk7CgoJCX0gZWxzZSB7CgoJCQlnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKCBpbmRleCwgc2l6ZSwgdHlwZSwgbm9ybWFsaXplZCwgc3RyaWRlLCBvZmZzZXQgKTsKCgkJfQoKCX0KCglmdW5jdGlvbiBzZXR1cFZlcnRleEF0dHJpYnV0ZXMoIG9iamVjdCwgbWF0ZXJpYWwsIHByb2dyYW0sIGdlb21ldHJ5ICkgewoKCQlpZiAoIGNhcGFiaWxpdGllcy5pc1dlYkdMMiA9PT0gZmFsc2UgJiYgKCBvYmplY3QuaXNJbnN0YW5jZWRNZXNoIHx8IGdlb21ldHJ5LmlzSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnkgKSApIHsKCgkJCWlmICggZXh0ZW5zaW9ucy5nZXQoICdBTkdMRV9pbnN0YW5jZWRfYXJyYXlzJyApID09PSBudWxsICkgcmV0dXJuOwoKCQl9CgoJCWluaXRBdHRyaWJ1dGVzKCk7CgoJCWNvbnN0IGdlb21ldHJ5QXR0cmlidXRlcyA9IGdlb21ldHJ5LmF0dHJpYnV0ZXM7CgoJCWNvbnN0IHByb2dyYW1BdHRyaWJ1dGVzID0gcHJvZ3JhbS5nZXRBdHRyaWJ1dGVzKCk7CgoJCWNvbnN0IG1hdGVyaWFsRGVmYXVsdEF0dHJpYnV0ZVZhbHVlcyA9IG1hdGVyaWFsLmRlZmF1bHRBdHRyaWJ1dGVWYWx1ZXM7CgoJCWZvciAoIGNvbnN0IG5hbWUgaW4gcHJvZ3JhbUF0dHJpYnV0ZXMgKSB7CgoJCQljb25zdCBwcm9ncmFtQXR0cmlidXRlID0gcHJvZ3JhbUF0dHJpYnV0ZXNbIG5hbWUgXTsKCgkJCWlmICggcHJvZ3JhbUF0dHJpYnV0ZS5sb2NhdGlvbiA+PSAwICkgewoKCQkJCWxldCBnZW9tZXRyeUF0dHJpYnV0ZSA9IGdlb21ldHJ5QXR0cmlidXRlc1sgbmFtZSBdOwoKCQkJCWlmICggZ2VvbWV0cnlBdHRyaWJ1dGUgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkJaWYgKCBuYW1lID09PSAnaW5zdGFuY2VNYXRyaXgnICYmIG9iamVjdC5pbnN0YW5jZU1hdHJpeCApIGdlb21ldHJ5QXR0cmlidXRlID0gb2JqZWN0Lmluc3RhbmNlTWF0cml4OwoJCQkJCWlmICggbmFtZSA9PT0gJ2luc3RhbmNlQ29sb3InICYmIG9iamVjdC5pbnN0YW5jZUNvbG9yICkgZ2VvbWV0cnlBdHRyaWJ1dGUgPSBvYmplY3QuaW5zdGFuY2VDb2xvcjsKCgkJCQl9CgoJCQkJaWYgKCBnZW9tZXRyeUF0dHJpYnV0ZSAhPT0gdW5kZWZpbmVkICkgewoKCQkJCQljb25zdCBub3JtYWxpemVkID0gZ2VvbWV0cnlBdHRyaWJ1dGUubm9ybWFsaXplZDsKCQkJCQljb25zdCBzaXplID0gZ2VvbWV0cnlBdHRyaWJ1dGUuaXRlbVNpemU7CgoJCQkJCWNvbnN0IGF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXMuZ2V0KCBnZW9tZXRyeUF0dHJpYnV0ZSApOwoKCQkJCQkvLyBUT0RPIEF0dHJpYnV0ZSBtYXkgbm90IGJlIGF2YWlsYWJsZSBvbiBjb250ZXh0IHJlc3RvcmUKCgkJCQkJaWYgKCBhdHRyaWJ1dGUgPT09IHVuZGVmaW5lZCApIGNvbnRpbnVlOwoKCQkJCQljb25zdCBidWZmZXIgPSBhdHRyaWJ1dGUuYnVmZmVyOwoJCQkJCWNvbnN0IHR5cGUgPSBhdHRyaWJ1dGUudHlwZTsKCQkJCQljb25zdCBieXRlc1BlckVsZW1lbnQgPSBhdHRyaWJ1dGUuYnl0ZXNQZXJFbGVtZW50OwoKCQkJCQkvLyBjaGVjayBmb3IgaW50ZWdlciBhdHRyaWJ1dGVzIChXZWJHTCAyIG9ubHkpCgoJCQkJCWNvbnN0IGludGVnZXIgPSAoIGNhcGFiaWxpdGllcy5pc1dlYkdMMiA9PT0gdHJ1ZSAmJiAoIHR5cGUgPT09IGdsLklOVCB8fCB0eXBlID09PSBnbC5VTlNJR05FRF9JTlQgfHwgZ2VvbWV0cnlBdHRyaWJ1dGUuZ3B1VHlwZSA9PT0gSW50VHlwZSApICk7CgoJCQkJCWlmICggZ2VvbWV0cnlBdHRyaWJ1dGUuaXNJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZSApIHsKCgkJCQkJCWNvbnN0IGRhdGEgPSBnZW9tZXRyeUF0dHJpYnV0ZS5kYXRhOwoJCQkJCQljb25zdCBzdHJpZGUgPSBkYXRhLnN0cmlkZTsKCQkJCQkJY29uc3Qgb2Zmc2V0ID0gZ2VvbWV0cnlBdHRyaWJ1dGUub2Zmc2V0OwoKCQkJCQkJaWYgKCBkYXRhLmlzSW5zdGFuY2VkSW50ZXJsZWF2ZWRCdWZmZXIgKSB7CgoJCQkJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgcHJvZ3JhbUF0dHJpYnV0ZS5sb2NhdGlvblNpemU7IGkgKysgKSB7CgoJCQkJCQkJCWVuYWJsZUF0dHJpYnV0ZUFuZERpdmlzb3IoIHByb2dyYW1BdHRyaWJ1dGUubG9jYXRpb24gKyBpLCBkYXRhLm1lc2hQZXJBdHRyaWJ1dGUgKTsKCgkJCQkJCQl9CgoJCQkJCQkJaWYgKCBvYmplY3QuaXNJbnN0YW5jZWRNZXNoICE9PSB0cnVlICYmIGdlb21ldHJ5Ll9tYXhJbnN0YW5jZUNvdW50ID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCQkJCWdlb21ldHJ5Ll9tYXhJbnN0YW5jZUNvdW50ID0gZGF0YS5tZXNoUGVyQXR0cmlidXRlICogZGF0YS5jb3VudDsKCgkJCQkJCQl9CgoJCQkJCQl9IGVsc2UgewoKCQkJCQkJCWZvciAoIGxldCBpID0gMDsgaSA8IHByb2dyYW1BdHRyaWJ1dGUubG9jYXRpb25TaXplOyBpICsrICkgewoKCQkJCQkJCQllbmFibGVBdHRyaWJ1dGUoIHByb2dyYW1BdHRyaWJ1dGUubG9jYXRpb24gKyBpICk7CgoJCQkJCQkJfQoKCQkJCQkJfQoKCQkJCQkJZ2wuYmluZEJ1ZmZlciggZ2wuQVJSQVlfQlVGRkVSLCBidWZmZXIgKTsKCgkJCQkJCWZvciAoIGxldCBpID0gMDsgaSA8IHByb2dyYW1BdHRyaWJ1dGUubG9jYXRpb25TaXplOyBpICsrICkgewoKCQkJCQkJCXZlcnRleEF0dHJpYlBvaW50ZXIoCgkJCQkJCQkJcHJvZ3JhbUF0dHJpYnV0ZS5sb2NhdGlvbiArIGksCgkJCQkJCQkJc2l6ZSAvIHByb2dyYW1BdHRyaWJ1dGUubG9jYXRpb25TaXplLAoJCQkJCQkJCXR5cGUsCgkJCQkJCQkJbm9ybWFsaXplZCwKCQkJCQkJCQlzdHJpZGUgKiBieXRlc1BlckVsZW1lbnQsCgkJCQkJCQkJKCBvZmZzZXQgKyAoIHNpemUgLyBwcm9ncmFtQXR0cmlidXRlLmxvY2F0aW9uU2l6ZSApICogaSApICogYnl0ZXNQZXJFbGVtZW50LAoJCQkJCQkJCWludGVnZXIKCQkJCQkJCSk7CgoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlpZiAoIGdlb21ldHJ5QXR0cmlidXRlLmlzSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlICkgewoKCQkJCQkJCWZvciAoIGxldCBpID0gMDsgaSA8IHByb2dyYW1BdHRyaWJ1dGUubG9jYXRpb25TaXplOyBpICsrICkgewoKCQkJCQkJCQllbmFibGVBdHRyaWJ1dGVBbmREaXZpc29yKCBwcm9ncmFtQXR0cmlidXRlLmxvY2F0aW9uICsgaSwgZ2VvbWV0cnlBdHRyaWJ1dGUubWVzaFBlckF0dHJpYnV0ZSApOwoKCQkJCQkJCX0KCgkJCQkJCQlpZiAoIG9iamVjdC5pc0luc3RhbmNlZE1lc2ggIT09IHRydWUgJiYgZ2VvbWV0cnkuX21heEluc3RhbmNlQ291bnQgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkJCQkJZ2VvbWV0cnkuX21heEluc3RhbmNlQ291bnQgPSBnZW9tZXRyeUF0dHJpYnV0ZS5tZXNoUGVyQXR0cmlidXRlICogZ2VvbWV0cnlBdHRyaWJ1dGUuY291bnQ7CgoJCQkJCQkJfQoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBwcm9ncmFtQXR0cmlidXRlLmxvY2F0aW9uU2l6ZTsgaSArKyApIHsKCgkJCQkJCQkJZW5hYmxlQXR0cmlidXRlKCBwcm9ncmFtQXR0cmlidXRlLmxvY2F0aW9uICsgaSApOwoKCQkJCQkJCX0KCgkJCQkJCX0KCgkJCQkJCWdsLmJpbmRCdWZmZXIoIGdsLkFSUkFZX0JVRkZFUiwgYnVmZmVyICk7CgoJCQkJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBwcm9ncmFtQXR0cmlidXRlLmxvY2F0aW9uU2l6ZTsgaSArKyApIHsKCgkJCQkJCQl2ZXJ0ZXhBdHRyaWJQb2ludGVyKAoJCQkJCQkJCXByb2dyYW1BdHRyaWJ1dGUubG9jYXRpb24gKyBpLAoJCQkJCQkJCXNpemUgLyBwcm9ncmFtQXR0cmlidXRlLmxvY2F0aW9uU2l6ZSwKCQkJCQkJCQl0eXBlLAoJCQkJCQkJCW5vcm1hbGl6ZWQsCgkJCQkJCQkJc2l6ZSAqIGJ5dGVzUGVyRWxlbWVudCwKCQkJCQkJCQkoIHNpemUgLyBwcm9ncmFtQXR0cmlidXRlLmxvY2F0aW9uU2l6ZSApICogaSAqIGJ5dGVzUGVyRWxlbWVudCwKCQkJCQkJCQlpbnRlZ2VyCgkJCQkJCQkpOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJfSBlbHNlIGlmICggbWF0ZXJpYWxEZWZhdWx0QXR0cmlidXRlVmFsdWVzICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJCWNvbnN0IHZhbHVlID0gbWF0ZXJpYWxEZWZhdWx0QXR0cmlidXRlVmFsdWVzWyBuYW1lIF07CgoJCQkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCgkJCQkJCXN3aXRjaCAoIHZhbHVlLmxlbmd0aCApIHsKCgkJCQkJCQljYXNlIDI6CgkJCQkJCQkJZ2wudmVydGV4QXR0cmliMmZ2KCBwcm9ncmFtQXR0cmlidXRlLmxvY2F0aW9uLCB2YWx1ZSApOwoJCQkJCQkJCWJyZWFrOwoKCQkJCQkJCWNhc2UgMzoKCQkJCQkJCQlnbC52ZXJ0ZXhBdHRyaWIzZnYoIHByb2dyYW1BdHRyaWJ1dGUubG9jYXRpb24sIHZhbHVlICk7CgkJCQkJCQkJYnJlYWs7CgoJCQkJCQkJY2FzZSA0OgoJCQkJCQkJCWdsLnZlcnRleEF0dHJpYjRmdiggcHJvZ3JhbUF0dHJpYnV0ZS5sb2NhdGlvbiwgdmFsdWUgKTsKCQkJCQkJCQlicmVhazsKCgkJCQkJCQlkZWZhdWx0OgoJCQkJCQkJCWdsLnZlcnRleEF0dHJpYjFmdiggcHJvZ3JhbUF0dHJpYnV0ZS5sb2NhdGlvbiwgdmFsdWUgKTsKCgkJCQkJCX0KCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJfQoKCQlkaXNhYmxlVW51c2VkQXR0cmlidXRlcygpOwoKCX0KCglmdW5jdGlvbiBkaXNwb3NlKCkgewoKCQlyZXNldCgpOwoKCQlmb3IgKCBjb25zdCBnZW9tZXRyeUlkIGluIGJpbmRpbmdTdGF0ZXMgKSB7CgoJCQljb25zdCBwcm9ncmFtTWFwID0gYmluZGluZ1N0YXRlc1sgZ2VvbWV0cnlJZCBdOwoKCQkJZm9yICggY29uc3QgcHJvZ3JhbUlkIGluIHByb2dyYW1NYXAgKSB7CgoJCQkJY29uc3Qgc3RhdGVNYXAgPSBwcm9ncmFtTWFwWyBwcm9ncmFtSWQgXTsKCgkJCQlmb3IgKCBjb25zdCB3aXJlZnJhbWUgaW4gc3RhdGVNYXAgKSB7CgoJCQkJCWRlbGV0ZVZlcnRleEFycmF5T2JqZWN0KCBzdGF0ZU1hcFsgd2lyZWZyYW1lIF0ub2JqZWN0ICk7CgoJCQkJCWRlbGV0ZSBzdGF0ZU1hcFsgd2lyZWZyYW1lIF07CgoJCQkJfQoKCQkJCWRlbGV0ZSBwcm9ncmFtTWFwWyBwcm9ncmFtSWQgXTsKCgkJCX0KCgkJCWRlbGV0ZSBiaW5kaW5nU3RhdGVzWyBnZW9tZXRyeUlkIF07CgoJCX0KCgl9CgoJZnVuY3Rpb24gcmVsZWFzZVN0YXRlc09mR2VvbWV0cnkoIGdlb21ldHJ5ICkgewoKCQlpZiAoIGJpbmRpbmdTdGF0ZXNbIGdlb21ldHJ5LmlkIF0gPT09IHVuZGVmaW5lZCApIHJldHVybjsKCgkJY29uc3QgcHJvZ3JhbU1hcCA9IGJpbmRpbmdTdGF0ZXNbIGdlb21ldHJ5LmlkIF07CgoJCWZvciAoIGNvbnN0IHByb2dyYW1JZCBpbiBwcm9ncmFtTWFwICkgewoKCQkJY29uc3Qgc3RhdGVNYXAgPSBwcm9ncmFtTWFwWyBwcm9ncmFtSWQgXTsKCgkJCWZvciAoIGNvbnN0IHdpcmVmcmFtZSBpbiBzdGF0ZU1hcCApIHsKCgkJCQlkZWxldGVWZXJ0ZXhBcnJheU9iamVjdCggc3RhdGVNYXBbIHdpcmVmcmFtZSBdLm9iamVjdCApOwoKCQkJCWRlbGV0ZSBzdGF0ZU1hcFsgd2lyZWZyYW1lIF07CgoJCQl9CgoJCQlkZWxldGUgcHJvZ3JhbU1hcFsgcHJvZ3JhbUlkIF07CgoJCX0KCgkJZGVsZXRlIGJpbmRpbmdTdGF0ZXNbIGdlb21ldHJ5LmlkIF07CgoJfQoKCWZ1bmN0aW9uIHJlbGVhc2VTdGF0ZXNPZlByb2dyYW0oIHByb2dyYW0gKSB7CgoJCWZvciAoIGNvbnN0IGdlb21ldHJ5SWQgaW4gYmluZGluZ1N0YXRlcyApIHsKCgkJCWNvbnN0IHByb2dyYW1NYXAgPSBiaW5kaW5nU3RhdGVzWyBnZW9tZXRyeUlkIF07CgoJCQlpZiAoIHByb2dyYW1NYXBbIHByb2dyYW0uaWQgXSA9PT0gdW5kZWZpbmVkICkgY29udGludWU7CgoJCQljb25zdCBzdGF0ZU1hcCA9IHByb2dyYW1NYXBbIHByb2dyYW0uaWQgXTsKCgkJCWZvciAoIGNvbnN0IHdpcmVmcmFtZSBpbiBzdGF0ZU1hcCApIHsKCgkJCQlkZWxldGVWZXJ0ZXhBcnJheU9iamVjdCggc3RhdGVNYXBbIHdpcmVmcmFtZSBdLm9iamVjdCApOwoKCQkJCWRlbGV0ZSBzdGF0ZU1hcFsgd2lyZWZyYW1lIF07CgoJCQl9CgoJCQlkZWxldGUgcHJvZ3JhbU1hcFsgcHJvZ3JhbS5pZCBdOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIHJlc2V0KCkgewoKCQlyZXNldERlZmF1bHRTdGF0ZSgpOwoJCWZvcmNlVXBkYXRlID0gdHJ1ZTsKCgkJaWYgKCBjdXJyZW50U3RhdGUgPT09IGRlZmF1bHRTdGF0ZSApIHJldHVybjsKCgkJY3VycmVudFN0YXRlID0gZGVmYXVsdFN0YXRlOwoJCWJpbmRWZXJ0ZXhBcnJheU9iamVjdCggY3VycmVudFN0YXRlLm9iamVjdCApOwoKCX0KCgkvLyBmb3IgYmFja3dhcmQtY29tcGF0aWJpbGl0eQoKCWZ1bmN0aW9uIHJlc2V0RGVmYXVsdFN0YXRlKCkgewoKCQlkZWZhdWx0U3RhdGUuZ2VvbWV0cnkgPSBudWxsOwoJCWRlZmF1bHRTdGF0ZS5wcm9ncmFtID0gbnVsbDsKCQlkZWZhdWx0U3RhdGUud2lyZWZyYW1lID0gZmFsc2U7CgoJfQoKCXJldHVybiB7CgoJCXNldHVwOiBzZXR1cCwKCQlyZXNldDogcmVzZXQsCgkJcmVzZXREZWZhdWx0U3RhdGU6IHJlc2V0RGVmYXVsdFN0YXRlLAoJCWRpc3Bvc2U6IGRpc3Bvc2UsCgkJcmVsZWFzZVN0YXRlc09mR2VvbWV0cnk6IHJlbGVhc2VTdGF0ZXNPZkdlb21ldHJ5LAoJCXJlbGVhc2VTdGF0ZXNPZlByb2dyYW06IHJlbGVhc2VTdGF0ZXNPZlByb2dyYW0sCgoJCWluaXRBdHRyaWJ1dGVzOiBpbml0QXR0cmlidXRlcywKCQllbmFibGVBdHRyaWJ1dGU6IGVuYWJsZUF0dHJpYnV0ZSwKCQlkaXNhYmxlVW51c2VkQXR0cmlidXRlczogZGlzYWJsZVVudXNlZEF0dHJpYnV0ZXMKCgl9OwoKfQoKZnVuY3Rpb24gV2ViR0xCdWZmZXJSZW5kZXJlciggZ2wsIGV4dGVuc2lvbnMsIGluZm8sIGNhcGFiaWxpdGllcyApIHsKCgljb25zdCBpc1dlYkdMMiA9IGNhcGFiaWxpdGllcy5pc1dlYkdMMjsKCglsZXQgbW9kZTsKCglmdW5jdGlvbiBzZXRNb2RlKCB2YWx1ZSApIHsKCgkJbW9kZSA9IHZhbHVlOwoKCX0KCglmdW5jdGlvbiByZW5kZXIoIHN0YXJ0LCBjb3VudCApIHsKCgkJZ2wuZHJhd0FycmF5cyggbW9kZSwgc3RhcnQsIGNvdW50ICk7CgoJCWluZm8udXBkYXRlKCBjb3VudCwgbW9kZSwgMSApOwoKCX0KCglmdW5jdGlvbiByZW5kZXJJbnN0YW5jZXMoIHN0YXJ0LCBjb3VudCwgcHJpbWNvdW50ICkgewoKCQlpZiAoIHByaW1jb3VudCA9PT0gMCApIHJldHVybjsKCgkJbGV0IGV4dGVuc2lvbiwgbWV0aG9kTmFtZTsKCgkJaWYgKCBpc1dlYkdMMiApIHsKCgkJCWV4dGVuc2lvbiA9IGdsOwoJCQltZXRob2ROYW1lID0gJ2RyYXdBcnJheXNJbnN0YW5jZWQnOwoKCQl9IGVsc2UgewoKCQkJZXh0ZW5zaW9uID0gZXh0ZW5zaW9ucy5nZXQoICdBTkdMRV9pbnN0YW5jZWRfYXJyYXlzJyApOwoJCQltZXRob2ROYW1lID0gJ2RyYXdBcnJheXNJbnN0YW5jZWRBTkdMRSc7CgoJCQlpZiAoIGV4dGVuc2lvbiA9PT0gbnVsbCApIHsKCgkJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuV2ViR0xCdWZmZXJSZW5kZXJlcjogdXNpbmcgVEhSRUUuSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnkgYnV0IGhhcmR3YXJlIGRvZXMgbm90IHN1cHBvcnQgZXh0ZW5zaW9uIEFOR0xFX2luc3RhbmNlZF9hcnJheXMuJyApOwoJCQkJcmV0dXJuOwoKCQkJfQoKCQl9CgoJCWV4dGVuc2lvblsgbWV0aG9kTmFtZSBdKCBtb2RlLCBzdGFydCwgY291bnQsIHByaW1jb3VudCApOwoKCQlpbmZvLnVwZGF0ZSggY291bnQsIG1vZGUsIHByaW1jb3VudCApOwoKCX0KCglmdW5jdGlvbiByZW5kZXJNdWx0aURyYXcoIHN0YXJ0cywgY291bnRzLCBkcmF3Q291bnQgKSB7CgoJCWlmICggZHJhd0NvdW50ID09PSAwICkgcmV0dXJuOwoKCQljb25zdCBleHRlbnNpb24gPSBleHRlbnNpb25zLmdldCggJ1dFQkdMX211bHRpX2RyYXcnICk7CgkJaWYgKCBleHRlbnNpb24gPT09IG51bGwgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBkcmF3Q291bnQ7IGkgKysgKSB7CgoJCQkJdGhpcy5yZW5kZXIoIHN0YXJ0c1sgaSBdLCBjb3VudHNbIGkgXSApOwoKCQkJfQoKCQl9IGVsc2UgewoKCQkJZXh0ZW5zaW9uLm11bHRpRHJhd0FycmF5c1dFQkdMKCBtb2RlLCBzdGFydHMsIDAsIGNvdW50cywgMCwgZHJhd0NvdW50ICk7CgoJCQlsZXQgZWxlbWVudENvdW50ID0gMDsKCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgZHJhd0NvdW50OyBpICsrICkgewoKCQkJCWVsZW1lbnRDb3VudCArPSBjb3VudHNbIGkgXTsKCgkJCX0KCgkJCWluZm8udXBkYXRlKCBlbGVtZW50Q291bnQsIG1vZGUsIDEgKTsKCgkJfQoKCX0KCgkvLwoKCXRoaXMuc2V0TW9kZSA9IHNldE1vZGU7Cgl0aGlzLnJlbmRlciA9IHJlbmRlcjsKCXRoaXMucmVuZGVySW5zdGFuY2VzID0gcmVuZGVySW5zdGFuY2VzOwoJdGhpcy5yZW5kZXJNdWx0aURyYXcgPSByZW5kZXJNdWx0aURyYXc7Cgp9CgpmdW5jdGlvbiBXZWJHTENhcGFiaWxpdGllcyggZ2wsIGV4dGVuc2lvbnMsIHBhcmFtZXRlcnMgKSB7CgoJbGV0IG1heEFuaXNvdHJvcHk7CgoJZnVuY3Rpb24gZ2V0TWF4QW5pc290cm9weSgpIHsKCgkJaWYgKCBtYXhBbmlzb3Ryb3B5ICE9PSB1bmRlZmluZWQgKSByZXR1cm4gbWF4QW5pc290cm9weTsKCgkJaWYgKCBleHRlbnNpb25zLmhhcyggJ0VYVF90ZXh0dXJlX2ZpbHRlcl9hbmlzb3Ryb3BpYycgKSA9PT0gdHJ1ZSApIHsKCgkJCWNvbnN0IGV4dGVuc2lvbiA9IGV4dGVuc2lvbnMuZ2V0KCAnRVhUX3RleHR1cmVfZmlsdGVyX2FuaXNvdHJvcGljJyApOwoKCQkJbWF4QW5pc290cm9weSA9IGdsLmdldFBhcmFtZXRlciggZXh0ZW5zaW9uLk1BWF9URVhUVVJFX01BWF9BTklTT1RST1BZX0VYVCApOwoKCQl9IGVsc2UgewoKCQkJbWF4QW5pc290cm9weSA9IDA7CgoJCX0KCgkJcmV0dXJuIG1heEFuaXNvdHJvcHk7CgoJfQoKCWZ1bmN0aW9uIGdldE1heFByZWNpc2lvbiggcHJlY2lzaW9uICkgewoKCQlpZiAoIHByZWNpc2lvbiA9PT0gJ2hpZ2hwJyApIHsKCgkJCWlmICggZ2wuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KCBnbC5WRVJURVhfU0hBREVSLCBnbC5ISUdIX0ZMT0FUICkucHJlY2lzaW9uID4gMCAmJgoJCQkJZ2wuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KCBnbC5GUkFHTUVOVF9TSEFERVIsIGdsLkhJR0hfRkxPQVQgKS5wcmVjaXNpb24gPiAwICkgewoKCQkJCXJldHVybiAnaGlnaHAnOwoKCQkJfQoKCQkJcHJlY2lzaW9uID0gJ21lZGl1bXAnOwoKCQl9CgoJCWlmICggcHJlY2lzaW9uID09PSAnbWVkaXVtcCcgKSB7CgoJCQlpZiAoIGdsLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdCggZ2wuVkVSVEVYX1NIQURFUiwgZ2wuTUVESVVNX0ZMT0FUICkucHJlY2lzaW9uID4gMCAmJgoJCQkJZ2wuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0KCBnbC5GUkFHTUVOVF9TSEFERVIsIGdsLk1FRElVTV9GTE9BVCApLnByZWNpc2lvbiA+IDAgKSB7CgoJCQkJcmV0dXJuICdtZWRpdW1wJzsKCgkJCX0KCgkJfQoKCQlyZXR1cm4gJ2xvd3AnOwoKCX0KCgljb25zdCBpc1dlYkdMMiA9IHR5cGVvZiBXZWJHTDJSZW5kZXJpbmdDb250ZXh0ICE9PSAndW5kZWZpbmVkJyAmJiBnbC5jb25zdHJ1Y3Rvci5uYW1lID09PSAnV2ViR0wyUmVuZGVyaW5nQ29udGV4dCc7CgoJbGV0IHByZWNpc2lvbiA9IHBhcmFtZXRlcnMucHJlY2lzaW9uICE9PSB1bmRlZmluZWQgPyBwYXJhbWV0ZXJzLnByZWNpc2lvbiA6ICdoaWdocCc7Cgljb25zdCBtYXhQcmVjaXNpb24gPSBnZXRNYXhQcmVjaXNpb24oIHByZWNpc2lvbiApOwoKCWlmICggbWF4UHJlY2lzaW9uICE9PSBwcmVjaXNpb24gKSB7CgoJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6JywgcHJlY2lzaW9uLCAnbm90IHN1cHBvcnRlZCwgdXNpbmcnLCBtYXhQcmVjaXNpb24sICdpbnN0ZWFkLicgKTsKCQlwcmVjaXNpb24gPSBtYXhQcmVjaXNpb247CgoJfQoKCWNvbnN0IGRyYXdCdWZmZXJzID0gaXNXZWJHTDIgfHwgZXh0ZW5zaW9ucy5oYXMoICdXRUJHTF9kcmF3X2J1ZmZlcnMnICk7CgoJY29uc3QgbG9nYXJpdGhtaWNEZXB0aEJ1ZmZlciA9IHBhcmFtZXRlcnMubG9nYXJpdGhtaWNEZXB0aEJ1ZmZlciA9PT0gdHJ1ZTsKCgljb25zdCBtYXhUZXh0dXJlcyA9IGdsLmdldFBhcmFtZXRlciggZ2wuTUFYX1RFWFRVUkVfSU1BR0VfVU5JVFMgKTsKCWNvbnN0IG1heFZlcnRleFRleHR1cmVzID0gZ2wuZ2V0UGFyYW1ldGVyKCBnbC5NQVhfVkVSVEVYX1RFWFRVUkVfSU1BR0VfVU5JVFMgKTsKCWNvbnN0IG1heFRleHR1cmVTaXplID0gZ2wuZ2V0UGFyYW1ldGVyKCBnbC5NQVhfVEVYVFVSRV9TSVpFICk7Cgljb25zdCBtYXhDdWJlbWFwU2l6ZSA9IGdsLmdldFBhcmFtZXRlciggZ2wuTUFYX0NVQkVfTUFQX1RFWFRVUkVfU0laRSApOwoKCWNvbnN0IG1heEF0dHJpYnV0ZXMgPSBnbC5nZXRQYXJhbWV0ZXIoIGdsLk1BWF9WRVJURVhfQVRUUklCUyApOwoJY29uc3QgbWF4VmVydGV4VW5pZm9ybXMgPSBnbC5nZXRQYXJhbWV0ZXIoIGdsLk1BWF9WRVJURVhfVU5JRk9STV9WRUNUT1JTICk7Cgljb25zdCBtYXhWYXJ5aW5ncyA9IGdsLmdldFBhcmFtZXRlciggZ2wuTUFYX1ZBUllJTkdfVkVDVE9SUyApOwoJY29uc3QgbWF4RnJhZ21lbnRVbmlmb3JtcyA9IGdsLmdldFBhcmFtZXRlciggZ2wuTUFYX0ZSQUdNRU5UX1VOSUZPUk1fVkVDVE9SUyApOwoKCWNvbnN0IHZlcnRleFRleHR1cmVzID0gbWF4VmVydGV4VGV4dHVyZXMgPiAwOwoJY29uc3QgZmxvYXRGcmFnbWVudFRleHR1cmVzID0gaXNXZWJHTDIgfHwgZXh0ZW5zaW9ucy5oYXMoICdPRVNfdGV4dHVyZV9mbG9hdCcgKTsKCWNvbnN0IGZsb2F0VmVydGV4VGV4dHVyZXMgPSB2ZXJ0ZXhUZXh0dXJlcyAmJiBmbG9hdEZyYWdtZW50VGV4dHVyZXM7CgoJY29uc3QgbWF4U2FtcGxlcyA9IGlzV2ViR0wyID8gZ2wuZ2V0UGFyYW1ldGVyKCBnbC5NQVhfU0FNUExFUyApIDogMDsKCglyZXR1cm4gewoKCQlpc1dlYkdMMjogaXNXZWJHTDIsCgoJCWRyYXdCdWZmZXJzOiBkcmF3QnVmZmVycywKCgkJZ2V0TWF4QW5pc290cm9weTogZ2V0TWF4QW5pc290cm9weSwKCQlnZXRNYXhQcmVjaXNpb246IGdldE1heFByZWNpc2lvbiwKCgkJcHJlY2lzaW9uOiBwcmVjaXNpb24sCgkJbG9nYXJpdGhtaWNEZXB0aEJ1ZmZlcjogbG9nYXJpdGhtaWNEZXB0aEJ1ZmZlciwKCgkJbWF4VGV4dHVyZXM6IG1heFRleHR1cmVzLAoJCW1heFZlcnRleFRleHR1cmVzOiBtYXhWZXJ0ZXhUZXh0dXJlcywKCQltYXhUZXh0dXJlU2l6ZTogbWF4VGV4dHVyZVNpemUsCgkJbWF4Q3ViZW1hcFNpemU6IG1heEN1YmVtYXBTaXplLAoKCQltYXhBdHRyaWJ1dGVzOiBtYXhBdHRyaWJ1dGVzLAoJCW1heFZlcnRleFVuaWZvcm1zOiBtYXhWZXJ0ZXhVbmlmb3JtcywKCQltYXhWYXJ5aW5nczogbWF4VmFyeWluZ3MsCgkJbWF4RnJhZ21lbnRVbmlmb3JtczogbWF4RnJhZ21lbnRVbmlmb3JtcywKCgkJdmVydGV4VGV4dHVyZXM6IHZlcnRleFRleHR1cmVzLAoJCWZsb2F0RnJhZ21lbnRUZXh0dXJlczogZmxvYXRGcmFnbWVudFRleHR1cmVzLAoJCWZsb2F0VmVydGV4VGV4dHVyZXM6IGZsb2F0VmVydGV4VGV4dHVyZXMsCgoJCW1heFNhbXBsZXM6IG1heFNhbXBsZXMKCgl9OwoKfQoKZnVuY3Rpb24gV2ViR0xDbGlwcGluZyggcHJvcGVydGllcyApIHsKCgljb25zdCBzY29wZSA9IHRoaXM7CgoJbGV0IGdsb2JhbFN0YXRlID0gbnVsbCwKCQludW1HbG9iYWxQbGFuZXMgPSAwLAoJCWxvY2FsQ2xpcHBpbmdFbmFibGVkID0gZmFsc2UsCgkJcmVuZGVyaW5nU2hhZG93cyA9IGZhbHNlOwoKCWNvbnN0IHBsYW5lID0gbmV3IFBsYW5lKCksCgkJdmlld05vcm1hbE1hdHJpeCA9IG5ldyBNYXRyaXgzKCksCgoJCXVuaWZvcm0gPSB7IHZhbHVlOiBudWxsLCBuZWVkc1VwZGF0ZTogZmFsc2UgfTsKCgl0aGlzLnVuaWZvcm0gPSB1bmlmb3JtOwoJdGhpcy5udW1QbGFuZXMgPSAwOwoJdGhpcy5udW1JbnRlcnNlY3Rpb24gPSAwOwoKCXRoaXMuaW5pdCA9IGZ1bmN0aW9uICggcGxhbmVzLCBlbmFibGVMb2NhbENsaXBwaW5nICkgewoKCQljb25zdCBlbmFibGVkID0KCQkJcGxhbmVzLmxlbmd0aCAhPT0gMCB8fAoJCQllbmFibGVMb2NhbENsaXBwaW5nIHx8CgkJCS8vIGVuYWJsZSBzdGF0ZSBvZiBwcmV2aW91cyBmcmFtZSAtIHRoZSBjbGlwcGluZyBjb2RlIGhhcyB0bwoJCQkvLyBydW4gYW5vdGhlciBmcmFtZSBpbiBvcmRlciB0byByZXNldCB0aGUgc3RhdGU6CgkJCW51bUdsb2JhbFBsYW5lcyAhPT0gMCB8fAoJCQlsb2NhbENsaXBwaW5nRW5hYmxlZDsKCgkJbG9jYWxDbGlwcGluZ0VuYWJsZWQgPSBlbmFibGVMb2NhbENsaXBwaW5nOwoKCQludW1HbG9iYWxQbGFuZXMgPSBwbGFuZXMubGVuZ3RoOwoKCQlyZXR1cm4gZW5hYmxlZDsKCgl9OwoKCXRoaXMuYmVnaW5TaGFkb3dzID0gZnVuY3Rpb24gKCkgewoKCQlyZW5kZXJpbmdTaGFkb3dzID0gdHJ1ZTsKCQlwcm9qZWN0UGxhbmVzKCBudWxsICk7CgoJfTsKCgl0aGlzLmVuZFNoYWRvd3MgPSBmdW5jdGlvbiAoKSB7CgoJCXJlbmRlcmluZ1NoYWRvd3MgPSBmYWxzZTsKCgl9OwoKCXRoaXMuc2V0R2xvYmFsU3RhdGUgPSBmdW5jdGlvbiAoIHBsYW5lcywgY2FtZXJhICkgewoKCQlnbG9iYWxTdGF0ZSA9IHByb2plY3RQbGFuZXMoIHBsYW5lcywgY2FtZXJhLCAwICk7CgoJfTsKCgl0aGlzLnNldFN0YXRlID0gZnVuY3Rpb24gKCBtYXRlcmlhbCwgY2FtZXJhLCB1c2VDYWNoZSApIHsKCgkJY29uc3QgcGxhbmVzID0gbWF0ZXJpYWwuY2xpcHBpbmdQbGFuZXMsCgkJCWNsaXBJbnRlcnNlY3Rpb24gPSBtYXRlcmlhbC5jbGlwSW50ZXJzZWN0aW9uLAoJCQljbGlwU2hhZG93cyA9IG1hdGVyaWFsLmNsaXBTaGFkb3dzOwoKCQljb25zdCBtYXRlcmlhbFByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggbWF0ZXJpYWwgKTsKCgkJaWYgKCAhIGxvY2FsQ2xpcHBpbmdFbmFibGVkIHx8IHBsYW5lcyA9PT0gbnVsbCB8fCBwbGFuZXMubGVuZ3RoID09PSAwIHx8IHJlbmRlcmluZ1NoYWRvd3MgJiYgISBjbGlwU2hhZG93cyApIHsKCgkJCS8vIHRoZXJlJ3Mgbm8gbG9jYWwgY2xpcHBpbmcKCgkJCWlmICggcmVuZGVyaW5nU2hhZG93cyApIHsKCgkJCQkvLyB0aGVyZSdzIG5vIGdsb2JhbCBjbGlwcGluZwoKCQkJCXByb2plY3RQbGFuZXMoIG51bGwgKTsKCgkJCX0gZWxzZSB7CgoJCQkJcmVzZXRHbG9iYWxTdGF0ZSgpOwoKCQkJfQoKCQl9IGVsc2UgewoKCQkJY29uc3Qgbkdsb2JhbCA9IHJlbmRlcmluZ1NoYWRvd3MgPyAwIDogbnVtR2xvYmFsUGxhbmVzLAoJCQkJbEdsb2JhbCA9IG5HbG9iYWwgKiA0OwoKCQkJbGV0IGRzdEFycmF5ID0gbWF0ZXJpYWxQcm9wZXJ0aWVzLmNsaXBwaW5nU3RhdGUgfHwgbnVsbDsKCgkJCXVuaWZvcm0udmFsdWUgPSBkc3RBcnJheTsgLy8gZW5zdXJlIHVuaXF1ZSBzdGF0ZQoKCQkJZHN0QXJyYXkgPSBwcm9qZWN0UGxhbmVzKCBwbGFuZXMsIGNhbWVyYSwgbEdsb2JhbCwgdXNlQ2FjaGUgKTsKCgkJCWZvciAoIGxldCBpID0gMDsgaSAhPT0gbEdsb2JhbDsgKysgaSApIHsKCgkJCQlkc3RBcnJheVsgaSBdID0gZ2xvYmFsU3RhdGVbIGkgXTsKCgkJCX0KCgkJCW1hdGVyaWFsUHJvcGVydGllcy5jbGlwcGluZ1N0YXRlID0gZHN0QXJyYXk7CgkJCXRoaXMubnVtSW50ZXJzZWN0aW9uID0gY2xpcEludGVyc2VjdGlvbiA/IHRoaXMubnVtUGxhbmVzIDogMDsKCQkJdGhpcy5udW1QbGFuZXMgKz0gbkdsb2JhbDsKCgkJfQoKCgl9OwoKCWZ1bmN0aW9uIHJlc2V0R2xvYmFsU3RhdGUoKSB7CgoJCWlmICggdW5pZm9ybS52YWx1ZSAhPT0gZ2xvYmFsU3RhdGUgKSB7CgoJCQl1bmlmb3JtLnZhbHVlID0gZ2xvYmFsU3RhdGU7CgkJCXVuaWZvcm0ubmVlZHNVcGRhdGUgPSBudW1HbG9iYWxQbGFuZXMgPiAwOwoKCQl9CgoJCXNjb3BlLm51bVBsYW5lcyA9IG51bUdsb2JhbFBsYW5lczsKCQlzY29wZS5udW1JbnRlcnNlY3Rpb24gPSAwOwoKCX0KCglmdW5jdGlvbiBwcm9qZWN0UGxhbmVzKCBwbGFuZXMsIGNhbWVyYSwgZHN0T2Zmc2V0LCBza2lwVHJhbnNmb3JtICkgewoKCQljb25zdCBuUGxhbmVzID0gcGxhbmVzICE9PSBudWxsID8gcGxhbmVzLmxlbmd0aCA6IDA7CgkJbGV0IGRzdEFycmF5ID0gbnVsbDsKCgkJaWYgKCBuUGxhbmVzICE9PSAwICkgewoKCQkJZHN0QXJyYXkgPSB1bmlmb3JtLnZhbHVlOwoKCQkJaWYgKCBza2lwVHJhbnNmb3JtICE9PSB0cnVlIHx8IGRzdEFycmF5ID09PSBudWxsICkgewoKCQkJCWNvbnN0IGZsYXRTaXplID0gZHN0T2Zmc2V0ICsgblBsYW5lcyAqIDQsCgkJCQkJdmlld01hdHJpeCA9IGNhbWVyYS5tYXRyaXhXb3JsZEludmVyc2U7CgoJCQkJdmlld05vcm1hbE1hdHJpeC5nZXROb3JtYWxNYXRyaXgoIHZpZXdNYXRyaXggKTsKCgkJCQlpZiAoIGRzdEFycmF5ID09PSBudWxsIHx8IGRzdEFycmF5Lmxlbmd0aCA8IGZsYXRTaXplICkgewoKCQkJCQlkc3RBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoIGZsYXRTaXplICk7CgoJCQkJfQoKCQkJCWZvciAoIGxldCBpID0gMCwgaTQgPSBkc3RPZmZzZXQ7IGkgIT09IG5QbGFuZXM7ICsrIGksIGk0ICs9IDQgKSB7CgoJCQkJCXBsYW5lLmNvcHkoIHBsYW5lc1sgaSBdICkuYXBwbHlNYXRyaXg0KCB2aWV3TWF0cml4LCB2aWV3Tm9ybWFsTWF0cml4ICk7CgoJCQkJCXBsYW5lLm5vcm1hbC50b0FycmF5KCBkc3RBcnJheSwgaTQgKTsKCQkJCQlkc3RBcnJheVsgaTQgKyAzIF0gPSBwbGFuZS5jb25zdGFudDsKCgkJCQl9CgoJCQl9CgoJCQl1bmlmb3JtLnZhbHVlID0gZHN0QXJyYXk7CgkJCXVuaWZvcm0ubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQl9CgoJCXNjb3BlLm51bVBsYW5lcyA9IG5QbGFuZXM7CgkJc2NvcGUubnVtSW50ZXJzZWN0aW9uID0gMDsKCgkJcmV0dXJuIGRzdEFycmF5OwoKCX0KCn0KCmZ1bmN0aW9uIFdlYkdMQ3ViZU1hcHMoIHJlbmRlcmVyICkgewoKCWxldCBjdWJlbWFwcyA9IG5ldyBXZWFrTWFwKCk7CgoJZnVuY3Rpb24gbWFwVGV4dHVyZU1hcHBpbmcoIHRleHR1cmUsIG1hcHBpbmcgKSB7CgoJCWlmICggbWFwcGluZyA9PT0gRXF1aXJlY3Rhbmd1bGFyUmVmbGVjdGlvbk1hcHBpbmcgKSB7CgoJCQl0ZXh0dXJlLm1hcHBpbmcgPSBDdWJlUmVmbGVjdGlvbk1hcHBpbmc7CgoJCX0gZWxzZSBpZiAoIG1hcHBpbmcgPT09IEVxdWlyZWN0YW5ndWxhclJlZnJhY3Rpb25NYXBwaW5nICkgewoKCQkJdGV4dHVyZS5tYXBwaW5nID0gQ3ViZVJlZnJhY3Rpb25NYXBwaW5nOwoKCQl9CgoJCXJldHVybiB0ZXh0dXJlOwoKCX0KCglmdW5jdGlvbiBnZXQoIHRleHR1cmUgKSB7CgoJCWlmICggdGV4dHVyZSAmJiB0ZXh0dXJlLmlzVGV4dHVyZSApIHsKCgkJCWNvbnN0IG1hcHBpbmcgPSB0ZXh0dXJlLm1hcHBpbmc7CgoJCQlpZiAoIG1hcHBpbmcgPT09IEVxdWlyZWN0YW5ndWxhclJlZmxlY3Rpb25NYXBwaW5nIHx8IG1hcHBpbmcgPT09IEVxdWlyZWN0YW5ndWxhclJlZnJhY3Rpb25NYXBwaW5nICkgewoKCQkJCWlmICggY3ViZW1hcHMuaGFzKCB0ZXh0dXJlICkgKSB7CgoJCQkJCWNvbnN0IGN1YmVtYXAgPSBjdWJlbWFwcy5nZXQoIHRleHR1cmUgKS50ZXh0dXJlOwoJCQkJCXJldHVybiBtYXBUZXh0dXJlTWFwcGluZyggY3ViZW1hcCwgdGV4dHVyZS5tYXBwaW5nICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJY29uc3QgaW1hZ2UgPSB0ZXh0dXJlLmltYWdlOwoKCQkJCQlpZiAoIGltYWdlICYmIGltYWdlLmhlaWdodCA+IDAgKSB7CgoJCQkJCQljb25zdCByZW5kZXJUYXJnZXQgPSBuZXcgV2ViR0xDdWJlUmVuZGVyVGFyZ2V0KCBpbWFnZS5oZWlnaHQgKTsKCQkJCQkJcmVuZGVyVGFyZ2V0LmZyb21FcXVpcmVjdGFuZ3VsYXJUZXh0dXJlKCByZW5kZXJlciwgdGV4dHVyZSApOwoJCQkJCQljdWJlbWFwcy5zZXQoIHRleHR1cmUsIHJlbmRlclRhcmdldCApOwoKCQkJCQkJdGV4dHVyZS5hZGRFdmVudExpc3RlbmVyKCAnZGlzcG9zZScsIG9uVGV4dHVyZURpc3Bvc2UgKTsKCgkJCQkJCXJldHVybiBtYXBUZXh0dXJlTWFwcGluZyggcmVuZGVyVGFyZ2V0LnRleHR1cmUsIHRleHR1cmUubWFwcGluZyApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gaW1hZ2Ugbm90IHlldCByZWFkeS4gdHJ5IHRoZSBjb252ZXJzaW9uIG5leHQgZnJhbWUKCgkJCQkJCXJldHVybiBudWxsOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQl9CgoJCXJldHVybiB0ZXh0dXJlOwoKCX0KCglmdW5jdGlvbiBvblRleHR1cmVEaXNwb3NlKCBldmVudCApIHsKCgkJY29uc3QgdGV4dHVyZSA9IGV2ZW50LnRhcmdldDsKCgkJdGV4dHVyZS5yZW1vdmVFdmVudExpc3RlbmVyKCAnZGlzcG9zZScsIG9uVGV4dHVyZURpc3Bvc2UgKTsKCgkJY29uc3QgY3ViZW1hcCA9IGN1YmVtYXBzLmdldCggdGV4dHVyZSApOwoKCQlpZiAoIGN1YmVtYXAgIT09IHVuZGVmaW5lZCApIHsKCgkJCWN1YmVtYXBzLmRlbGV0ZSggdGV4dHVyZSApOwoJCQljdWJlbWFwLmRpc3Bvc2UoKTsKCgkJfQoKCX0KCglmdW5jdGlvbiBkaXNwb3NlKCkgewoKCQljdWJlbWFwcyA9IG5ldyBXZWFrTWFwKCk7CgoJfQoKCXJldHVybiB7CgkJZ2V0OiBnZXQsCgkJZGlzcG9zZTogZGlzcG9zZQoJfTsKCn0KCmNsYXNzIE9ydGhvZ3JhcGhpY0NhbWVyYSBleHRlbmRzIENhbWVyYSB7CgoJY29uc3RydWN0b3IoIGxlZnQgPSAtIDEsIHJpZ2h0ID0gMSwgdG9wID0gMSwgYm90dG9tID0gLSAxLCBuZWFyID0gMC4xLCBmYXIgPSAyMDAwICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzT3J0aG9ncmFwaGljQ2FtZXJhID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ09ydGhvZ3JhcGhpY0NhbWVyYSc7CgoJCXRoaXMuem9vbSA9IDE7CgkJdGhpcy52aWV3ID0gbnVsbDsKCgkJdGhpcy5sZWZ0ID0gbGVmdDsKCQl0aGlzLnJpZ2h0ID0gcmlnaHQ7CgkJdGhpcy50b3AgPSB0b3A7CgkJdGhpcy5ib3R0b20gPSBib3R0b207CgoJCXRoaXMubmVhciA9IG5lYXI7CgkJdGhpcy5mYXIgPSBmYXI7CgoJCXRoaXMudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKCX0KCgljb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlLCByZWN1cnNpdmUgKTsKCgkJdGhpcy5sZWZ0ID0gc291cmNlLmxlZnQ7CgkJdGhpcy5yaWdodCA9IHNvdXJjZS5yaWdodDsKCQl0aGlzLnRvcCA9IHNvdXJjZS50b3A7CgkJdGhpcy5ib3R0b20gPSBzb3VyY2UuYm90dG9tOwoJCXRoaXMubmVhciA9IHNvdXJjZS5uZWFyOwoJCXRoaXMuZmFyID0gc291cmNlLmZhcjsKCgkJdGhpcy56b29tID0gc291cmNlLnpvb207CgkJdGhpcy52aWV3ID0gc291cmNlLnZpZXcgPT09IG51bGwgPyBudWxsIDogT2JqZWN0LmFzc2lnbigge30sIHNvdXJjZS52aWV3ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRWaWV3T2Zmc2V0KCBmdWxsV2lkdGgsIGZ1bGxIZWlnaHQsIHgsIHksIHdpZHRoLCBoZWlnaHQgKSB7CgoJCWlmICggdGhpcy52aWV3ID09PSBudWxsICkgewoKCQkJdGhpcy52aWV3ID0gewoJCQkJZW5hYmxlZDogdHJ1ZSwKCQkJCWZ1bGxXaWR0aDogMSwKCQkJCWZ1bGxIZWlnaHQ6IDEsCgkJCQlvZmZzZXRYOiAwLAoJCQkJb2Zmc2V0WTogMCwKCQkJCXdpZHRoOiAxLAoJCQkJaGVpZ2h0OiAxCgkJCX07CgoJCX0KCgkJdGhpcy52aWV3LmVuYWJsZWQgPSB0cnVlOwoJCXRoaXMudmlldy5mdWxsV2lkdGggPSBmdWxsV2lkdGg7CgkJdGhpcy52aWV3LmZ1bGxIZWlnaHQgPSBmdWxsSGVpZ2h0OwoJCXRoaXMudmlldy5vZmZzZXRYID0geDsKCQl0aGlzLnZpZXcub2Zmc2V0WSA9IHk7CgkJdGhpcy52aWV3LndpZHRoID0gd2lkdGg7CgkJdGhpcy52aWV3LmhlaWdodCA9IGhlaWdodDsKCgkJdGhpcy51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgoJfQoKCWNsZWFyVmlld09mZnNldCgpIHsKCgkJaWYgKCB0aGlzLnZpZXcgIT09IG51bGwgKSB7CgoJCQl0aGlzLnZpZXcuZW5hYmxlZCA9IGZhbHNlOwoKCQl9CgoJCXRoaXMudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoKCX0KCgl1cGRhdGVQcm9qZWN0aW9uTWF0cml4KCkgewoKCQljb25zdCBkeCA9ICggdGhpcy5yaWdodCAtIHRoaXMubGVmdCApIC8gKCAyICogdGhpcy56b29tICk7CgkJY29uc3QgZHkgPSAoIHRoaXMudG9wIC0gdGhpcy5ib3R0b20gKSAvICggMiAqIHRoaXMuem9vbSApOwoJCWNvbnN0IGN4ID0gKCB0aGlzLnJpZ2h0ICsgdGhpcy5sZWZ0ICkgLyAyOwoJCWNvbnN0IGN5ID0gKCB0aGlzLnRvcCArIHRoaXMuYm90dG9tICkgLyAyOwoKCQlsZXQgbGVmdCA9IGN4IC0gZHg7CgkJbGV0IHJpZ2h0ID0gY3ggKyBkeDsKCQlsZXQgdG9wID0gY3kgKyBkeTsKCQlsZXQgYm90dG9tID0gY3kgLSBkeTsKCgkJaWYgKCB0aGlzLnZpZXcgIT09IG51bGwgJiYgdGhpcy52aWV3LmVuYWJsZWQgKSB7CgoJCQljb25zdCBzY2FsZVcgPSAoIHRoaXMucmlnaHQgLSB0aGlzLmxlZnQgKSAvIHRoaXMudmlldy5mdWxsV2lkdGggLyB0aGlzLnpvb207CgkJCWNvbnN0IHNjYWxlSCA9ICggdGhpcy50b3AgLSB0aGlzLmJvdHRvbSApIC8gdGhpcy52aWV3LmZ1bGxIZWlnaHQgLyB0aGlzLnpvb207CgoJCQlsZWZ0ICs9IHNjYWxlVyAqIHRoaXMudmlldy5vZmZzZXRYOwoJCQlyaWdodCA9IGxlZnQgKyBzY2FsZVcgKiB0aGlzLnZpZXcud2lkdGg7CgkJCXRvcCAtPSBzY2FsZUggKiB0aGlzLnZpZXcub2Zmc2V0WTsKCQkJYm90dG9tID0gdG9wIC0gc2NhbGVIICogdGhpcy52aWV3LmhlaWdodDsKCgkJfQoKCQl0aGlzLnByb2plY3Rpb25NYXRyaXgubWFrZU9ydGhvZ3JhcGhpYyggbGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tLCB0aGlzLm5lYXIsIHRoaXMuZmFyLCB0aGlzLmNvb3JkaW5hdGVTeXN0ZW0gKTsKCgkJdGhpcy5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZS5jb3B5KCB0aGlzLnByb2plY3Rpb25NYXRyaXggKS5pbnZlcnQoKTsKCgl9CgoJdG9KU09OKCBtZXRhICkgewoKCQljb25zdCBkYXRhID0gc3VwZXIudG9KU09OKCBtZXRhICk7CgoJCWRhdGEub2JqZWN0Lnpvb20gPSB0aGlzLnpvb207CgkJZGF0YS5vYmplY3QubGVmdCA9IHRoaXMubGVmdDsKCQlkYXRhLm9iamVjdC5yaWdodCA9IHRoaXMucmlnaHQ7CgkJZGF0YS5vYmplY3QudG9wID0gdGhpcy50b3A7CgkJZGF0YS5vYmplY3QuYm90dG9tID0gdGhpcy5ib3R0b207CgkJZGF0YS5vYmplY3QubmVhciA9IHRoaXMubmVhcjsKCQlkYXRhLm9iamVjdC5mYXIgPSB0aGlzLmZhcjsKCgkJaWYgKCB0aGlzLnZpZXcgIT09IG51bGwgKSBkYXRhLm9iamVjdC52aWV3ID0gT2JqZWN0LmFzc2lnbigge30sIHRoaXMudmlldyApOwoKCQlyZXR1cm4gZGF0YTsKCgl9Cgp9Cgpjb25zdCBMT0RfTUlOID0gNDsKCi8vIFRoZSBzdGFuZGFyZCBkZXZpYXRpb25zIChyYWRpYW5zKSBhc3NvY2lhdGVkIHdpdGggdGhlIGV4dHJhIG1pcHMuIFRoZXNlIGFyZQovLyBjaG9zZW4gdG8gYXBwcm94aW1hdGUgYSBUcm93YnJpZGdlLVJlaXR6IGRpc3RyaWJ1dGlvbiBmdW5jdGlvbiB0aW1lcyB0aGUKLy8gZ2VvbWV0cmljIHNoYWRvd2luZyBmdW5jdGlvbi4gVGhlc2Ugc2lnbWEgdmFsdWVzIHNxdWFyZWQgbXVzdCBtYXRjaCB0aGUKLy8gdmFyaWFuY2UgI2RlZmluZXMgaW4gY3ViZV91dl9yZWZsZWN0aW9uX2ZyYWdtZW50Lmdsc2wuanMuCmNvbnN0IEVYVFJBX0xPRF9TSUdNQSA9IFsgMC4xMjUsIDAuMjE1LCAwLjM1LCAwLjQ0NiwgMC41MjYsIDAuNTgyIF07CgovLyBUaGUgbWF4aW11bSBsZW5ndGggb2YgdGhlIGJsdXIgZm9yIGxvb3AuIFNtYWxsZXIgc2lnbWFzIHdpbGwgdXNlIGZld2VyCi8vIHNhbXBsZXMgYW5kIGV4aXQgZWFybHksIGJ1dCBub3QgcmVjb21waWxlIHRoZSBzaGFkZXIuCmNvbnN0IE1BWF9TQU1QTEVTID0gMjA7Cgpjb25zdCBfZmxhdENhbWVyYSA9IC8qQF9fUFVSRV9fKi8gbmV3IE9ydGhvZ3JhcGhpY0NhbWVyYSgpOwpjb25zdCBfY2xlYXJDb2xvciA9IC8qQF9fUFVSRV9fKi8gbmV3IENvbG9yKCk7CmxldCBfb2xkVGFyZ2V0ID0gbnVsbDsKbGV0IF9vbGRBY3RpdmVDdWJlRmFjZSA9IDA7CmxldCBfb2xkQWN0aXZlTWlwbWFwTGV2ZWwgPSAwOwoKLy8gR29sZGVuIFJhdGlvCmNvbnN0IFBISSA9ICggMSArIE1hdGguc3FydCggNSApICkgLyAyOwpjb25zdCBJTlZfUEhJID0gMSAvIFBISTsKCi8vIFZlcnRpY2VzIG9mIGEgZG9kZWNhaGVkcm9uIChleGNlcHQgdGhlIG9wcG9zaXRlcywgd2hpY2ggcmVwcmVzZW50IHRoZQovLyBzYW1lIGF4aXMpLCB1c2VkIGFzIGF4aXMgZGlyZWN0aW9ucyBldmVubHkgc3ByZWFkIG9uIGEgc3BoZXJlLgpjb25zdCBfYXhpc0RpcmVjdGlvbnMgPSBbCgkvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCAxLCAxLCAxICksCgkvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCAtIDEsIDEsIDEgKSwKCS8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoIDEsIDEsIC0gMSApLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMyggLSAxLCAxLCAtIDEgKSwKCS8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoIDAsIFBISSwgSU5WX1BISSApLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMyggMCwgUEhJLCAtIElOVl9QSEkgKSwKCS8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoIElOVl9QSEksIDAsIFBISSApLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMyggLSBJTlZfUEhJLCAwLCBQSEkgKSwKCS8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoIFBISSwgSU5WX1BISSwgMCApLAoJLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMyggLSBQSEksIElOVl9QSEksIDAgKSBdOwoKLyoqCiAqIFRoaXMgY2xhc3MgZ2VuZXJhdGVzIGEgUHJlZmlsdGVyZWQsIE1pcG1hcHBlZCBSYWRpYW5jZSBFbnZpcm9ubWVudCBNYXAKICogKFBNUkVNKSBmcm9tIGEgY3ViZU1hcCBlbnZpcm9ubWVudCB0ZXh0dXJlLiBUaGlzIGFsbG93cyBkaWZmZXJlbnQgbGV2ZWxzIG9mCiAqIGJsdXIgdG8gYmUgcXVpY2tseSBhY2Nlc3NlZCBiYXNlZCBvbiBtYXRlcmlhbCByb3VnaG5lc3MuIEl0IGlzIHBhY2tlZCBpbnRvIGEKICogc3BlY2lhbCBDdWJlVVYgZm9ybWF0IHRoYXQgYWxsb3dzIHVzIHRvIHBlcmZvcm0gY3VzdG9tIGludGVycG9sYXRpb24gc28gdGhhdAogKiB3ZSBjYW4gc3VwcG9ydCBub25saW5lYXIgZm9ybWF0cyBzdWNoIGFzIFJHQkUuIFVubGlrZSBhIHRyYWRpdGlvbmFsIG1pcG1hcAogKiBjaGFpbiwgaXQgb25seSBnb2VzIGRvd24gdG8gdGhlIExPRF9NSU4gbGV2ZWwgKGFib3ZlKSwgYW5kIHRoZW4gY3JlYXRlcyBleHRyYQogKiBldmVuIG1vcmUgZmlsdGVyZWQgJ21pcHMnIGF0IHRoZSBzYW1lIExPRF9NSU4gcmVzb2x1dGlvbiwgYXNzb2NpYXRlZCB3aXRoCiAqIGhpZ2hlciByb3VnaG5lc3MgbGV2ZWxzLiBJbiB0aGlzIHdheSB3ZSBtYWludGFpbiByZXNvbHV0aW9uIHRvIHNtb290aGx5CiAqIGludGVycG9sYXRlIGRpZmZ1c2UgbGlnaHRpbmcgd2hpbGUgbGltaXRpbmcgc2FtcGxpbmcgY29tcHV0YXRpb24uCiAqCiAqIFBhcGVyOiBGYXN0LCBBY2N1cmF0ZSBJbWFnZS1CYXNlZCBMaWdodGluZwogKiBodHRwczovL2RyaXZlLmdvb2dsZS5jb20vZmlsZS9kLzE1eThyX1VwS2xVOVN2VjRJTGIwQzNxQ1BlY1M4cHZMei92aWV3CiovCgpjbGFzcyBQTVJFTUdlbmVyYXRvciB7CgoJY29uc3RydWN0b3IoIHJlbmRlcmVyICkgewoKCQl0aGlzLl9yZW5kZXJlciA9IHJlbmRlcmVyOwoJCXRoaXMuX3BpbmdQb25nUmVuZGVyVGFyZ2V0ID0gbnVsbDsKCgkJdGhpcy5fbG9kTWF4ID0gMDsKCQl0aGlzLl9jdWJlU2l6ZSA9IDA7CgkJdGhpcy5fbG9kUGxhbmVzID0gW107CgkJdGhpcy5fc2l6ZUxvZHMgPSBbXTsKCQl0aGlzLl9zaWdtYXMgPSBbXTsKCgkJdGhpcy5fYmx1ck1hdGVyaWFsID0gbnVsbDsKCQl0aGlzLl9jdWJlbWFwTWF0ZXJpYWwgPSBudWxsOwoJCXRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwgPSBudWxsOwoKCQl0aGlzLl9jb21waWxlTWF0ZXJpYWwoIHRoaXMuX2JsdXJNYXRlcmlhbCApOwoKCX0KCgkvKioKCSAqIEdlbmVyYXRlcyBhIFBNUkVNIGZyb20gYSBzdXBwbGllZCBTY2VuZSwgd2hpY2ggY2FuIGJlIGZhc3RlciB0aGFuIHVzaW5nIGFuCgkgKiBpbWFnZSBpZiBuZXR3b3JraW5nIGJhbmR3aWR0aCBpcyBsb3cuIE9wdGlvbmFsIHNpZ21hIHNwZWNpZmllcyBhIGJsdXIgcmFkaXVzCgkgKiBpbiByYWRpYW5zIHRvIGJlIGFwcGxpZWQgdG8gdGhlIHNjZW5lIGJlZm9yZSBQTVJFTSBnZW5lcmF0aW9uLiBPcHRpb25hbCBuZWFyCgkgKiBhbmQgZmFyIHBsYW5lcyBlbnN1cmUgdGhlIHNjZW5lIGlzIHJlbmRlcmVkIGluIGl0cyBlbnRpcmV0eSAodGhlIGN1YmVDYW1lcmEKCSAqIGlzIHBsYWNlZCBhdCB0aGUgb3JpZ2luKS4KCSAqLwoJZnJvbVNjZW5lKCBzY2VuZSwgc2lnbWEgPSAwLCBuZWFyID0gMC4xLCBmYXIgPSAxMDAgKSB7CgoJCV9vbGRUYXJnZXQgPSB0aGlzLl9yZW5kZXJlci5nZXRSZW5kZXJUYXJnZXQoKTsKCQlfb2xkQWN0aXZlQ3ViZUZhY2UgPSB0aGlzLl9yZW5kZXJlci5nZXRBY3RpdmVDdWJlRmFjZSgpOwoJCV9vbGRBY3RpdmVNaXBtYXBMZXZlbCA9IHRoaXMuX3JlbmRlcmVyLmdldEFjdGl2ZU1pcG1hcExldmVsKCk7CgoJCXRoaXMuX3NldFNpemUoIDI1NiApOwoKCQljb25zdCBjdWJlVVZSZW5kZXJUYXJnZXQgPSB0aGlzLl9hbGxvY2F0ZVRhcmdldHMoKTsKCQljdWJlVVZSZW5kZXJUYXJnZXQuZGVwdGhCdWZmZXIgPSB0cnVlOwoKCQl0aGlzLl9zY2VuZVRvQ3ViZVVWKCBzY2VuZSwgbmVhciwgZmFyLCBjdWJlVVZSZW5kZXJUYXJnZXQgKTsKCgkJaWYgKCBzaWdtYSA+IDAgKSB7CgoJCQl0aGlzLl9ibHVyKCBjdWJlVVZSZW5kZXJUYXJnZXQsIDAsIDAsIHNpZ21hICk7CgoJCX0KCgkJdGhpcy5fYXBwbHlQTVJFTSggY3ViZVVWUmVuZGVyVGFyZ2V0ICk7CgkJdGhpcy5fY2xlYW51cCggY3ViZVVWUmVuZGVyVGFyZ2V0ICk7CgoJCXJldHVybiBjdWJlVVZSZW5kZXJUYXJnZXQ7CgoJfQoKCS8qKgoJICogR2VuZXJhdGVzIGEgUE1SRU0gZnJvbSBhbiBlcXVpcmVjdGFuZ3VsYXIgdGV4dHVyZSwgd2hpY2ggY2FuIGJlIGVpdGhlciBMRFIKCSAqIG9yIEhEUi4gVGhlIGlkZWFsIGlucHV0IGltYWdlIHNpemUgaXMgMWsgKDEwMjQgeCA1MTIpLAoJICogYXMgdGhpcyBtYXRjaGVzIGJlc3Qgd2l0aCB0aGUgMjU2IHggMjU2IGN1YmVtYXAgb3V0cHV0LgoJICovCglmcm9tRXF1aXJlY3Rhbmd1bGFyKCBlcXVpcmVjdGFuZ3VsYXIsIHJlbmRlclRhcmdldCA9IG51bGwgKSB7CgoJCXJldHVybiB0aGlzLl9mcm9tVGV4dHVyZSggZXF1aXJlY3Rhbmd1bGFyLCByZW5kZXJUYXJnZXQgKTsKCgl9CgoJLyoqCgkgKiBHZW5lcmF0ZXMgYSBQTVJFTSBmcm9tIGFuIGN1YmVtYXAgdGV4dHVyZSwgd2hpY2ggY2FuIGJlIGVpdGhlciBMRFIKCSAqIG9yIEhEUi4gVGhlIGlkZWFsIGlucHV0IGN1YmUgc2l6ZSBpcyAyNTYgeCAyNTYsCgkgKiBhcyB0aGlzIG1hdGNoZXMgYmVzdCB3aXRoIHRoZSAyNTYgeCAyNTYgY3ViZW1hcCBvdXRwdXQuCgkgKi8KCWZyb21DdWJlbWFwKCBjdWJlbWFwLCByZW5kZXJUYXJnZXQgPSBudWxsICkgewoKCQlyZXR1cm4gdGhpcy5fZnJvbVRleHR1cmUoIGN1YmVtYXAsIHJlbmRlclRhcmdldCApOwoKCX0KCgkvKioKCSAqIFByZS1jb21waWxlcyB0aGUgY3ViZW1hcCBzaGFkZXIuIFlvdSBjYW4gZ2V0IGZhc3RlciBzdGFydC11cCBieSBpbnZva2luZyB0aGlzIG1ldGhvZCBkdXJpbmcKCSAqIHlvdXIgdGV4dHVyZSdzIG5ldHdvcmsgZmV0Y2ggZm9yIGluY3JlYXNlZCBjb25jdXJyZW5jeS4KCSAqLwoJY29tcGlsZUN1YmVtYXBTaGFkZXIoKSB7CgoJCWlmICggdGhpcy5fY3ViZW1hcE1hdGVyaWFsID09PSBudWxsICkgewoKCQkJdGhpcy5fY3ViZW1hcE1hdGVyaWFsID0gX2dldEN1YmVtYXBNYXRlcmlhbCgpOwoJCQl0aGlzLl9jb21waWxlTWF0ZXJpYWwoIHRoaXMuX2N1YmVtYXBNYXRlcmlhbCApOwoKCQl9CgoJfQoKCS8qKgoJICogUHJlLWNvbXBpbGVzIHRoZSBlcXVpcmVjdGFuZ3VsYXIgc2hhZGVyLiBZb3UgY2FuIGdldCBmYXN0ZXIgc3RhcnQtdXAgYnkgaW52b2tpbmcgdGhpcyBtZXRob2QgZHVyaW5nCgkgKiB5b3VyIHRleHR1cmUncyBuZXR3b3JrIGZldGNoIGZvciBpbmNyZWFzZWQgY29uY3VycmVuY3kuCgkgKi8KCWNvbXBpbGVFcXVpcmVjdGFuZ3VsYXJTaGFkZXIoKSB7CgoJCWlmICggdGhpcy5fZXF1aXJlY3RNYXRlcmlhbCA9PT0gbnVsbCApIHsKCgkJCXRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwgPSBfZ2V0RXF1aXJlY3RNYXRlcmlhbCgpOwoJCQl0aGlzLl9jb21waWxlTWF0ZXJpYWwoIHRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwgKTsKCgkJfQoKCX0KCgkvKioKCSAqIERpc3Bvc2VzIG9mIHRoZSBQTVJFTUdlbmVyYXRvcidzIGludGVybmFsIG1lbW9yeS4gTm90ZSB0aGF0IFBNUkVNR2VuZXJhdG9yIGlzIGEgc3RhdGljIGNsYXNzLAoJICogc28geW91IHNob3VsZCBub3QgbmVlZCBtb3JlIHRoYW4gb25lIFBNUkVNR2VuZXJhdG9yIG9iamVjdC4gSWYgeW91IGRvLCBjYWxsaW5nIGRpc3Bvc2UoKSBvbgoJICogb25lIG9mIHRoZW0gd2lsbCBjYXVzZSBhbnkgb3RoZXJzIHRvIGFsc28gYmVjb21lIHVudXNhYmxlLgoJICovCglkaXNwb3NlKCkgewoKCQl0aGlzLl9kaXNwb3NlKCk7CgoJCWlmICggdGhpcy5fY3ViZW1hcE1hdGVyaWFsICE9PSBudWxsICkgdGhpcy5fY3ViZW1hcE1hdGVyaWFsLmRpc3Bvc2UoKTsKCQlpZiAoIHRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwgIT09IG51bGwgKSB0aGlzLl9lcXVpcmVjdE1hdGVyaWFsLmRpc3Bvc2UoKTsKCgl9CgoJLy8gcHJpdmF0ZSBpbnRlcmZhY2UKCglfc2V0U2l6ZSggY3ViZVNpemUgKSB7CgoJCXRoaXMuX2xvZE1heCA9IE1hdGguZmxvb3IoIE1hdGgubG9nMiggY3ViZVNpemUgKSApOwoJCXRoaXMuX2N1YmVTaXplID0gTWF0aC5wb3coIDIsIHRoaXMuX2xvZE1heCApOwoKCX0KCglfZGlzcG9zZSgpIHsKCgkJaWYgKCB0aGlzLl9ibHVyTWF0ZXJpYWwgIT09IG51bGwgKSB0aGlzLl9ibHVyTWF0ZXJpYWwuZGlzcG9zZSgpOwoKCQlpZiAoIHRoaXMuX3BpbmdQb25nUmVuZGVyVGFyZ2V0ICE9PSBudWxsICkgdGhpcy5fcGluZ1BvbmdSZW5kZXJUYXJnZXQuZGlzcG9zZSgpOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLl9sb2RQbGFuZXMubGVuZ3RoOyBpICsrICkgewoKCQkJdGhpcy5fbG9kUGxhbmVzWyBpIF0uZGlzcG9zZSgpOwoKCQl9CgoJfQoKCV9jbGVhbnVwKCBvdXRwdXRUYXJnZXQgKSB7CgoJCXRoaXMuX3JlbmRlcmVyLnNldFJlbmRlclRhcmdldCggX29sZFRhcmdldCwgX29sZEFjdGl2ZUN1YmVGYWNlLCBfb2xkQWN0aXZlTWlwbWFwTGV2ZWwgKTsKCQlvdXRwdXRUYXJnZXQuc2Npc3NvclRlc3QgPSBmYWxzZTsKCQlfc2V0Vmlld3BvcnQoIG91dHB1dFRhcmdldCwgMCwgMCwgb3V0cHV0VGFyZ2V0LndpZHRoLCBvdXRwdXRUYXJnZXQuaGVpZ2h0ICk7CgoJfQoKCV9mcm9tVGV4dHVyZSggdGV4dHVyZSwgcmVuZGVyVGFyZ2V0ICkgewoKCQlpZiAoIHRleHR1cmUubWFwcGluZyA9PT0gQ3ViZVJlZmxlY3Rpb25NYXBwaW5nIHx8IHRleHR1cmUubWFwcGluZyA9PT0gQ3ViZVJlZnJhY3Rpb25NYXBwaW5nICkgewoKCQkJdGhpcy5fc2V0U2l6ZSggdGV4dHVyZS5pbWFnZS5sZW5ndGggPT09IDAgPyAxNiA6ICggdGV4dHVyZS5pbWFnZVsgMCBdLndpZHRoIHx8IHRleHR1cmUuaW1hZ2VbIDAgXS5pbWFnZS53aWR0aCApICk7CgoJCX0gZWxzZSB7IC8vIEVxdWlyZWN0YW5ndWxhcgoKCQkJdGhpcy5fc2V0U2l6ZSggdGV4dHVyZS5pbWFnZS53aWR0aCAvIDQgKTsKCgkJfQoKCQlfb2xkVGFyZ2V0ID0gdGhpcy5fcmVuZGVyZXIuZ2V0UmVuZGVyVGFyZ2V0KCk7CgkJX29sZEFjdGl2ZUN1YmVGYWNlID0gdGhpcy5fcmVuZGVyZXIuZ2V0QWN0aXZlQ3ViZUZhY2UoKTsKCQlfb2xkQWN0aXZlTWlwbWFwTGV2ZWwgPSB0aGlzLl9yZW5kZXJlci5nZXRBY3RpdmVNaXBtYXBMZXZlbCgpOwoKCQljb25zdCBjdWJlVVZSZW5kZXJUYXJnZXQgPSByZW5kZXJUYXJnZXQgfHwgdGhpcy5fYWxsb2NhdGVUYXJnZXRzKCk7CgkJdGhpcy5fdGV4dHVyZVRvQ3ViZVVWKCB0ZXh0dXJlLCBjdWJlVVZSZW5kZXJUYXJnZXQgKTsKCQl0aGlzLl9hcHBseVBNUkVNKCBjdWJlVVZSZW5kZXJUYXJnZXQgKTsKCQl0aGlzLl9jbGVhbnVwKCBjdWJlVVZSZW5kZXJUYXJnZXQgKTsKCgkJcmV0dXJuIGN1YmVVVlJlbmRlclRhcmdldDsKCgl9CgoJX2FsbG9jYXRlVGFyZ2V0cygpIHsKCgkJY29uc3Qgd2lkdGggPSAzICogTWF0aC5tYXgoIHRoaXMuX2N1YmVTaXplLCAxNiAqIDcgKTsKCQljb25zdCBoZWlnaHQgPSA0ICogdGhpcy5fY3ViZVNpemU7CgoJCWNvbnN0IHBhcmFtcyA9IHsKCQkJbWFnRmlsdGVyOiBMaW5lYXJGaWx0ZXIsCgkJCW1pbkZpbHRlcjogTGluZWFyRmlsdGVyLAoJCQlnZW5lcmF0ZU1pcG1hcHM6IGZhbHNlLAoJCQl0eXBlOiBIYWxmRmxvYXRUeXBlLAoJCQlmb3JtYXQ6IFJHQkFGb3JtYXQsCgkJCWNvbG9yU3BhY2U6IExpbmVhclNSR0JDb2xvclNwYWNlLAoJCQlkZXB0aEJ1ZmZlcjogZmFsc2UKCQl9OwoKCQljb25zdCBjdWJlVVZSZW5kZXJUYXJnZXQgPSBfY3JlYXRlUmVuZGVyVGFyZ2V0KCB3aWR0aCwgaGVpZ2h0LCBwYXJhbXMgKTsKCgkJaWYgKCB0aGlzLl9waW5nUG9uZ1JlbmRlclRhcmdldCA9PT0gbnVsbCB8fCB0aGlzLl9waW5nUG9uZ1JlbmRlclRhcmdldC53aWR0aCAhPT0gd2lkdGggfHwgdGhpcy5fcGluZ1BvbmdSZW5kZXJUYXJnZXQuaGVpZ2h0ICE9PSBoZWlnaHQgKSB7CgoJCQlpZiAoIHRoaXMuX3BpbmdQb25nUmVuZGVyVGFyZ2V0ICE9PSBudWxsICkgewoKCQkJCXRoaXMuX2Rpc3Bvc2UoKTsKCgkJCX0KCgkJCXRoaXMuX3BpbmdQb25nUmVuZGVyVGFyZ2V0ID0gX2NyZWF0ZVJlbmRlclRhcmdldCggd2lkdGgsIGhlaWdodCwgcGFyYW1zICk7CgoJCQljb25zdCB7IF9sb2RNYXggfSA9IHRoaXM7CgkJCSggeyBzaXplTG9kczogdGhpcy5fc2l6ZUxvZHMsIGxvZFBsYW5lczogdGhpcy5fbG9kUGxhbmVzLCBzaWdtYXM6IHRoaXMuX3NpZ21hcyB9ID0gX2NyZWF0ZVBsYW5lcyggX2xvZE1heCApICk7CgoJCQl0aGlzLl9ibHVyTWF0ZXJpYWwgPSBfZ2V0Qmx1clNoYWRlciggX2xvZE1heCwgd2lkdGgsIGhlaWdodCApOwoKCQl9CgoJCXJldHVybiBjdWJlVVZSZW5kZXJUYXJnZXQ7CgoJfQoKCV9jb21waWxlTWF0ZXJpYWwoIG1hdGVyaWFsICkgewoKCQljb25zdCB0bXBNZXNoID0gbmV3IE1lc2goIHRoaXMuX2xvZFBsYW5lc1sgMCBdLCBtYXRlcmlhbCApOwoJCXRoaXMuX3JlbmRlcmVyLmNvbXBpbGUoIHRtcE1lc2gsIF9mbGF0Q2FtZXJhICk7CgoJfQoKCV9zY2VuZVRvQ3ViZVVWKCBzY2VuZSwgbmVhciwgZmFyLCBjdWJlVVZSZW5kZXJUYXJnZXQgKSB7CgoJCWNvbnN0IGZvdiA9IDkwOwoJCWNvbnN0IGFzcGVjdCA9IDE7CgkJY29uc3QgY3ViZUNhbWVyYSA9IG5ldyBQZXJzcGVjdGl2ZUNhbWVyYSggZm92LCBhc3BlY3QsIG5lYXIsIGZhciApOwoJCWNvbnN0IHVwU2lnbiA9IFsgMSwgLSAxLCAxLCAxLCAxLCAxIF07CgkJY29uc3QgZm9yd2FyZFNpZ24gPSBbIDEsIDEsIDEsIC0gMSwgLSAxLCAtIDEgXTsKCQljb25zdCByZW5kZXJlciA9IHRoaXMuX3JlbmRlcmVyOwoKCQljb25zdCBvcmlnaW5hbEF1dG9DbGVhciA9IHJlbmRlcmVyLmF1dG9DbGVhcjsKCQljb25zdCB0b25lTWFwcGluZyA9IHJlbmRlcmVyLnRvbmVNYXBwaW5nOwoJCXJlbmRlcmVyLmdldENsZWFyQ29sb3IoIF9jbGVhckNvbG9yICk7CgoJCXJlbmRlcmVyLnRvbmVNYXBwaW5nID0gTm9Ub25lTWFwcGluZzsKCQlyZW5kZXJlci5hdXRvQ2xlYXIgPSBmYWxzZTsKCgkJY29uc3QgYmFja2dyb3VuZE1hdGVyaWFsID0gbmV3IE1lc2hCYXNpY01hdGVyaWFsKCB7CgkJCW5hbWU6ICdQTVJFTS5CYWNrZ3JvdW5kJywKCQkJc2lkZTogQmFja1NpZGUsCgkJCWRlcHRoV3JpdGU6IGZhbHNlLAoJCQlkZXB0aFRlc3Q6IGZhbHNlLAoJCX0gKTsKCgkJY29uc3QgYmFja2dyb3VuZEJveCA9IG5ldyBNZXNoKCBuZXcgQm94R2VvbWV0cnkoKSwgYmFja2dyb3VuZE1hdGVyaWFsICk7CgoJCWxldCB1c2VTb2xpZENvbG9yID0gZmFsc2U7CgkJY29uc3QgYmFja2dyb3VuZCA9IHNjZW5lLmJhY2tncm91bmQ7CgoJCWlmICggYmFja2dyb3VuZCApIHsKCgkJCWlmICggYmFja2dyb3VuZC5pc0NvbG9yICkgewoKCQkJCWJhY2tncm91bmRNYXRlcmlhbC5jb2xvci5jb3B5KCBiYWNrZ3JvdW5kICk7CgkJCQlzY2VuZS5iYWNrZ3JvdW5kID0gbnVsbDsKCQkJCXVzZVNvbGlkQ29sb3IgPSB0cnVlOwoKCQkJfQoKCQl9IGVsc2UgewoKCQkJYmFja2dyb3VuZE1hdGVyaWFsLmNvbG9yLmNvcHkoIF9jbGVhckNvbG9yICk7CgkJCXVzZVNvbGlkQ29sb3IgPSB0cnVlOwoKCQl9CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IDY7IGkgKysgKSB7CgoJCQljb25zdCBjb2wgPSBpICUgMzsKCgkJCWlmICggY29sID09PSAwICkgewoKCQkJCWN1YmVDYW1lcmEudXAuc2V0KCAwLCB1cFNpZ25bIGkgXSwgMCApOwoJCQkJY3ViZUNhbWVyYS5sb29rQXQoIGZvcndhcmRTaWduWyBpIF0sIDAsIDAgKTsKCgkJCX0gZWxzZSBpZiAoIGNvbCA9PT0gMSApIHsKCgkJCQljdWJlQ2FtZXJhLnVwLnNldCggMCwgMCwgdXBTaWduWyBpIF0gKTsKCQkJCWN1YmVDYW1lcmEubG9va0F0KCAwLCBmb3J3YXJkU2lnblsgaSBdLCAwICk7CgoJCQl9IGVsc2UgewoKCQkJCWN1YmVDYW1lcmEudXAuc2V0KCAwLCB1cFNpZ25bIGkgXSwgMCApOwoJCQkJY3ViZUNhbWVyYS5sb29rQXQoIDAsIDAsIGZvcndhcmRTaWduWyBpIF0gKTsKCgkJCX0KCgkJCWNvbnN0IHNpemUgPSB0aGlzLl9jdWJlU2l6ZTsKCgkJCV9zZXRWaWV3cG9ydCggY3ViZVVWUmVuZGVyVGFyZ2V0LCBjb2wgKiBzaXplLCBpID4gMiA/IHNpemUgOiAwLCBzaXplLCBzaXplICk7CgoJCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIGN1YmVVVlJlbmRlclRhcmdldCApOwoKCQkJaWYgKCB1c2VTb2xpZENvbG9yICkgewoKCQkJCXJlbmRlcmVyLnJlbmRlciggYmFja2dyb3VuZEJveCwgY3ViZUNhbWVyYSApOwoKCQkJfQoKCQkJcmVuZGVyZXIucmVuZGVyKCBzY2VuZSwgY3ViZUNhbWVyYSApOwoKCQl9CgoJCWJhY2tncm91bmRCb3guZ2VvbWV0cnkuZGlzcG9zZSgpOwoJCWJhY2tncm91bmRCb3gubWF0ZXJpYWwuZGlzcG9zZSgpOwoKCQlyZW5kZXJlci50b25lTWFwcGluZyA9IHRvbmVNYXBwaW5nOwoJCXJlbmRlcmVyLmF1dG9DbGVhciA9IG9yaWdpbmFsQXV0b0NsZWFyOwoJCXNjZW5lLmJhY2tncm91bmQgPSBiYWNrZ3JvdW5kOwoKCX0KCglfdGV4dHVyZVRvQ3ViZVVWKCB0ZXh0dXJlLCBjdWJlVVZSZW5kZXJUYXJnZXQgKSB7CgoJCWNvbnN0IHJlbmRlcmVyID0gdGhpcy5fcmVuZGVyZXI7CgoJCWNvbnN0IGlzQ3ViZVRleHR1cmUgPSAoIHRleHR1cmUubWFwcGluZyA9PT0gQ3ViZVJlZmxlY3Rpb25NYXBwaW5nIHx8IHRleHR1cmUubWFwcGluZyA9PT0gQ3ViZVJlZnJhY3Rpb25NYXBwaW5nICk7CgoJCWlmICggaXNDdWJlVGV4dHVyZSApIHsKCgkJCWlmICggdGhpcy5fY3ViZW1hcE1hdGVyaWFsID09PSBudWxsICkgewoKCQkJCXRoaXMuX2N1YmVtYXBNYXRlcmlhbCA9IF9nZXRDdWJlbWFwTWF0ZXJpYWwoKTsKCgkJCX0KCgkJCXRoaXMuX2N1YmVtYXBNYXRlcmlhbC51bmlmb3Jtcy5mbGlwRW52TWFwLnZhbHVlID0gKCB0ZXh0dXJlLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9PT0gZmFsc2UgKSA/IC0gMSA6IDE7CgoJCX0gZWxzZSB7CgoJCQlpZiAoIHRoaXMuX2VxdWlyZWN0TWF0ZXJpYWwgPT09IG51bGwgKSB7CgoJCQkJdGhpcy5fZXF1aXJlY3RNYXRlcmlhbCA9IF9nZXRFcXVpcmVjdE1hdGVyaWFsKCk7CgoJCQl9CgoJCX0KCgkJY29uc3QgbWF0ZXJpYWwgPSBpc0N1YmVUZXh0dXJlID8gdGhpcy5fY3ViZW1hcE1hdGVyaWFsIDogdGhpcy5fZXF1aXJlY3RNYXRlcmlhbDsKCQljb25zdCBtZXNoID0gbmV3IE1lc2goIHRoaXMuX2xvZFBsYW5lc1sgMCBdLCBtYXRlcmlhbCApOwoKCQljb25zdCB1bmlmb3JtcyA9IG1hdGVyaWFsLnVuaWZvcm1zOwoKCQl1bmlmb3Jtc1sgJ2Vudk1hcCcgXS52YWx1ZSA9IHRleHR1cmU7CgoJCWNvbnN0IHNpemUgPSB0aGlzLl9jdWJlU2l6ZTsKCgkJX3NldFZpZXdwb3J0KCBjdWJlVVZSZW5kZXJUYXJnZXQsIDAsIDAsIDMgKiBzaXplLCAyICogc2l6ZSApOwoKCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIGN1YmVVVlJlbmRlclRhcmdldCApOwoJCXJlbmRlcmVyLnJlbmRlciggbWVzaCwgX2ZsYXRDYW1lcmEgKTsKCgl9CgoJX2FwcGx5UE1SRU0oIGN1YmVVVlJlbmRlclRhcmdldCApIHsKCgkJY29uc3QgcmVuZGVyZXIgPSB0aGlzLl9yZW5kZXJlcjsKCQljb25zdCBhdXRvQ2xlYXIgPSByZW5kZXJlci5hdXRvQ2xlYXI7CgkJcmVuZGVyZXIuYXV0b0NsZWFyID0gZmFsc2U7CgoJCWZvciAoIGxldCBpID0gMTsgaSA8IHRoaXMuX2xvZFBsYW5lcy5sZW5ndGg7IGkgKysgKSB7CgoJCQljb25zdCBzaWdtYSA9IE1hdGguc3FydCggdGhpcy5fc2lnbWFzWyBpIF0gKiB0aGlzLl9zaWdtYXNbIGkgXSAtIHRoaXMuX3NpZ21hc1sgaSAtIDEgXSAqIHRoaXMuX3NpZ21hc1sgaSAtIDEgXSApOwoKCQkJY29uc3QgcG9sZUF4aXMgPSBfYXhpc0RpcmVjdGlvbnNbICggaSAtIDEgKSAlIF9heGlzRGlyZWN0aW9ucy5sZW5ndGggXTsKCgkJCXRoaXMuX2JsdXIoIGN1YmVVVlJlbmRlclRhcmdldCwgaSAtIDEsIGksIHNpZ21hLCBwb2xlQXhpcyApOwoKCQl9CgoJCXJlbmRlcmVyLmF1dG9DbGVhciA9IGF1dG9DbGVhcjsKCgl9CgoJLyoqCgkgKiBUaGlzIGlzIGEgdHdvLXBhc3MgR2F1c3NpYW4gYmx1ciBmb3IgYSBjdWJlbWFwLiBOb3JtYWxseSB0aGlzIGlzIGRvbmUKCSAqIHZlcnRpY2FsbHkgYW5kIGhvcml6b250YWxseSwgYnV0IHRoaXMgYnJlYWtzIGRvd24gb24gYSBjdWJlLiBIZXJlIHdlIGFwcGx5CgkgKiB0aGUgYmx1ciBsYXRpdHVkaW5hbGx5IChhcm91bmQgdGhlIHBvbGVzKSwgYW5kIHRoZW4gbG9uZ2l0dWRpbmFsbHkgKHRvd2FyZHMKCSAqIHRoZSBwb2xlcykgdG8gYXBwcm94aW1hdGUgdGhlIG9ydGhvZ29uYWxseS1zZXBhcmFibGUgYmx1ci4gSXQgaXMgbGVhc3QKCSAqIGFjY3VyYXRlIGF0IHRoZSBwb2xlcywgYnV0IHN0aWxsIGRvZXMgYSBkZWNlbnQgam9iLgoJICovCglfYmx1ciggY3ViZVVWUmVuZGVyVGFyZ2V0LCBsb2RJbiwgbG9kT3V0LCBzaWdtYSwgcG9sZUF4aXMgKSB7CgoJCWNvbnN0IHBpbmdQb25nUmVuZGVyVGFyZ2V0ID0gdGhpcy5fcGluZ1BvbmdSZW5kZXJUYXJnZXQ7CgoJCXRoaXMuX2hhbGZCbHVyKAoJCQljdWJlVVZSZW5kZXJUYXJnZXQsCgkJCXBpbmdQb25nUmVuZGVyVGFyZ2V0LAoJCQlsb2RJbiwKCQkJbG9kT3V0LAoJCQlzaWdtYSwKCQkJJ2xhdGl0dWRpbmFsJywKCQkJcG9sZUF4aXMgKTsKCgkJdGhpcy5faGFsZkJsdXIoCgkJCXBpbmdQb25nUmVuZGVyVGFyZ2V0LAoJCQljdWJlVVZSZW5kZXJUYXJnZXQsCgkJCWxvZE91dCwKCQkJbG9kT3V0LAoJCQlzaWdtYSwKCQkJJ2xvbmdpdHVkaW5hbCcsCgkJCXBvbGVBeGlzICk7CgoJfQoKCV9oYWxmQmx1ciggdGFyZ2V0SW4sIHRhcmdldE91dCwgbG9kSW4sIGxvZE91dCwgc2lnbWFSYWRpYW5zLCBkaXJlY3Rpb24sIHBvbGVBeGlzICkgewoKCQljb25zdCByZW5kZXJlciA9IHRoaXMuX3JlbmRlcmVyOwoJCWNvbnN0IGJsdXJNYXRlcmlhbCA9IHRoaXMuX2JsdXJNYXRlcmlhbDsKCgkJaWYgKCBkaXJlY3Rpb24gIT09ICdsYXRpdHVkaW5hbCcgJiYgZGlyZWN0aW9uICE9PSAnbG9uZ2l0dWRpbmFsJyApIHsKCgkJCWNvbnNvbGUuZXJyb3IoCgkJCQknYmx1ciBkaXJlY3Rpb24gbXVzdCBiZSBlaXRoZXIgbGF0aXR1ZGluYWwgb3IgbG9uZ2l0dWRpbmFsIScgKTsKCgkJfQoKCQkvLyBOdW1iZXIgb2Ygc3RhbmRhcmQgZGV2aWF0aW9ucyBhdCB3aGljaCB0byBjdXQgb2ZmIHRoZSBkaXNjcmV0ZSBhcHByb3hpbWF0aW9uLgoJCWNvbnN0IFNUQU5EQVJEX0RFVklBVElPTlMgPSAzOwoKCQljb25zdCBibHVyTWVzaCA9IG5ldyBNZXNoKCB0aGlzLl9sb2RQbGFuZXNbIGxvZE91dCBdLCBibHVyTWF0ZXJpYWwgKTsKCQljb25zdCBibHVyVW5pZm9ybXMgPSBibHVyTWF0ZXJpYWwudW5pZm9ybXM7CgoJCWNvbnN0IHBpeGVscyA9IHRoaXMuX3NpemVMb2RzWyBsb2RJbiBdIC0gMTsKCQljb25zdCByYWRpYW5zUGVyUGl4ZWwgPSBpc0Zpbml0ZSggc2lnbWFSYWRpYW5zICkgPyBNYXRoLlBJIC8gKCAyICogcGl4ZWxzICkgOiAyICogTWF0aC5QSSAvICggMiAqIE1BWF9TQU1QTEVTIC0gMSApOwoJCWNvbnN0IHNpZ21hUGl4ZWxzID0gc2lnbWFSYWRpYW5zIC8gcmFkaWFuc1BlclBpeGVsOwoJCWNvbnN0IHNhbXBsZXMgPSBpc0Zpbml0ZSggc2lnbWFSYWRpYW5zICkgPyAxICsgTWF0aC5mbG9vciggU1RBTkRBUkRfREVWSUFUSU9OUyAqIHNpZ21hUGl4ZWxzICkgOiBNQVhfU0FNUExFUzsKCgkJaWYgKCBzYW1wbGVzID4gTUFYX1NBTVBMRVMgKSB7CgoJCQljb25zb2xlLndhcm4oIGBzaWdtYVJhZGlhbnMsICR7CgkJCQlzaWdtYVJhZGlhbnN9LCBpcyB0b28gbGFyZ2UgYW5kIHdpbGwgY2xpcCwgYXMgaXQgcmVxdWVzdGVkICR7CgkJCQlzYW1wbGVzfSBzYW1wbGVzIHdoZW4gdGhlIG1heGltdW0gaXMgc2V0IHRvICR7TUFYX1NBTVBMRVN9YCApOwoKCQl9CgoJCWNvbnN0IHdlaWdodHMgPSBbXTsKCQlsZXQgc3VtID0gMDsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgTUFYX1NBTVBMRVM7ICsrIGkgKSB7CgoJCQljb25zdCB4ID0gaSAvIHNpZ21hUGl4ZWxzOwoJCQljb25zdCB3ZWlnaHQgPSBNYXRoLmV4cCggLSB4ICogeCAvIDIgKTsKCQkJd2VpZ2h0cy5wdXNoKCB3ZWlnaHQgKTsKCgkJCWlmICggaSA9PT0gMCApIHsKCgkJCQlzdW0gKz0gd2VpZ2h0OwoKCQkJfSBlbHNlIGlmICggaSA8IHNhbXBsZXMgKSB7CgoJCQkJc3VtICs9IDIgKiB3ZWlnaHQ7CgoJCQl9CgoJCX0KCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgd2VpZ2h0cy5sZW5ndGg7IGkgKysgKSB7CgoJCQl3ZWlnaHRzWyBpIF0gPSB3ZWlnaHRzWyBpIF0gLyBzdW07CgoJCX0KCgkJYmx1clVuaWZvcm1zWyAnZW52TWFwJyBdLnZhbHVlID0gdGFyZ2V0SW4udGV4dHVyZTsKCQlibHVyVW5pZm9ybXNbICdzYW1wbGVzJyBdLnZhbHVlID0gc2FtcGxlczsKCQlibHVyVW5pZm9ybXNbICd3ZWlnaHRzJyBdLnZhbHVlID0gd2VpZ2h0czsKCQlibHVyVW5pZm9ybXNbICdsYXRpdHVkaW5hbCcgXS52YWx1ZSA9IGRpcmVjdGlvbiA9PT0gJ2xhdGl0dWRpbmFsJzsKCgkJaWYgKCBwb2xlQXhpcyApIHsKCgkJCWJsdXJVbmlmb3Jtc1sgJ3BvbGVBeGlzJyBdLnZhbHVlID0gcG9sZUF4aXM7CgoJCX0KCgkJY29uc3QgeyBfbG9kTWF4IH0gPSB0aGlzOwoJCWJsdXJVbmlmb3Jtc1sgJ2RUaGV0YScgXS52YWx1ZSA9IHJhZGlhbnNQZXJQaXhlbDsKCQlibHVyVW5pZm9ybXNbICdtaXBJbnQnIF0udmFsdWUgPSBfbG9kTWF4IC0gbG9kSW47CgoJCWNvbnN0IG91dHB1dFNpemUgPSB0aGlzLl9zaXplTG9kc1sgbG9kT3V0IF07CgkJY29uc3QgeCA9IDMgKiBvdXRwdXRTaXplICogKCBsb2RPdXQgPiBfbG9kTWF4IC0gTE9EX01JTiA/IGxvZE91dCAtIF9sb2RNYXggKyBMT0RfTUlOIDogMCApOwoJCWNvbnN0IHkgPSA0ICogKCB0aGlzLl9jdWJlU2l6ZSAtIG91dHB1dFNpemUgKTsKCgkJX3NldFZpZXdwb3J0KCB0YXJnZXRPdXQsIHgsIHksIDMgKiBvdXRwdXRTaXplLCAyICogb3V0cHV0U2l6ZSApOwoJCXJlbmRlcmVyLnNldFJlbmRlclRhcmdldCggdGFyZ2V0T3V0ICk7CgkJcmVuZGVyZXIucmVuZGVyKCBibHVyTWVzaCwgX2ZsYXRDYW1lcmEgKTsKCgl9Cgp9CgoKCmZ1bmN0aW9uIF9jcmVhdGVQbGFuZXMoIGxvZE1heCApIHsKCgljb25zdCBsb2RQbGFuZXMgPSBbXTsKCWNvbnN0IHNpemVMb2RzID0gW107Cgljb25zdCBzaWdtYXMgPSBbXTsKCglsZXQgbG9kID0gbG9kTWF4OwoKCWNvbnN0IHRvdGFsTG9kcyA9IGxvZE1heCAtIExPRF9NSU4gKyAxICsgRVhUUkFfTE9EX1NJR01BLmxlbmd0aDsKCglmb3IgKCBsZXQgaSA9IDA7IGkgPCB0b3RhbExvZHM7IGkgKysgKSB7CgoJCWNvbnN0IHNpemVMb2QgPSBNYXRoLnBvdyggMiwgbG9kICk7CgkJc2l6ZUxvZHMucHVzaCggc2l6ZUxvZCApOwoJCWxldCBzaWdtYSA9IDEuMCAvIHNpemVMb2Q7CgoJCWlmICggaSA+IGxvZE1heCAtIExPRF9NSU4gKSB7CgoJCQlzaWdtYSA9IEVYVFJBX0xPRF9TSUdNQVsgaSAtIGxvZE1heCArIExPRF9NSU4gLSAxIF07CgoJCX0gZWxzZSBpZiAoIGkgPT09IDAgKSB7CgoJCQlzaWdtYSA9IDA7CgoJCX0KCgkJc2lnbWFzLnB1c2goIHNpZ21hICk7CgoJCWNvbnN0IHRleGVsU2l6ZSA9IDEuMCAvICggc2l6ZUxvZCAtIDIgKTsKCQljb25zdCBtaW4gPSAtIHRleGVsU2l6ZTsKCQljb25zdCBtYXggPSAxICsgdGV4ZWxTaXplOwoJCWNvbnN0IHV2MSA9IFsgbWluLCBtaW4sIG1heCwgbWluLCBtYXgsIG1heCwgbWluLCBtaW4sIG1heCwgbWF4LCBtaW4sIG1heCBdOwoKCQljb25zdCBjdWJlRmFjZXMgPSA2OwoJCWNvbnN0IHZlcnRpY2VzID0gNjsKCQljb25zdCBwb3NpdGlvblNpemUgPSAzOwoJCWNvbnN0IHV2U2l6ZSA9IDI7CgkJY29uc3QgZmFjZUluZGV4U2l6ZSA9IDE7CgoJCWNvbnN0IHBvc2l0aW9uID0gbmV3IEZsb2F0MzJBcnJheSggcG9zaXRpb25TaXplICogdmVydGljZXMgKiBjdWJlRmFjZXMgKTsKCQljb25zdCB1diA9IG5ldyBGbG9hdDMyQXJyYXkoIHV2U2l6ZSAqIHZlcnRpY2VzICogY3ViZUZhY2VzICk7CgkJY29uc3QgZmFjZUluZGV4ID0gbmV3IEZsb2F0MzJBcnJheSggZmFjZUluZGV4U2l6ZSAqIHZlcnRpY2VzICogY3ViZUZhY2VzICk7CgoJCWZvciAoIGxldCBmYWNlID0gMDsgZmFjZSA8IGN1YmVGYWNlczsgZmFjZSArKyApIHsKCgkJCWNvbnN0IHggPSAoIGZhY2UgJSAzICkgKiAyIC8gMyAtIDE7CgkJCWNvbnN0IHkgPSBmYWNlID4gMiA/IDAgOiAtIDE7CgkJCWNvbnN0IGNvb3JkaW5hdGVzID0gWwoJCQkJeCwgeSwgMCwKCQkJCXggKyAyIC8gMywgeSwgMCwKCQkJCXggKyAyIC8gMywgeSArIDEsIDAsCgkJCQl4LCB5LCAwLAoJCQkJeCArIDIgLyAzLCB5ICsgMSwgMCwKCQkJCXgsIHkgKyAxLCAwCgkJCV07CgkJCXBvc2l0aW9uLnNldCggY29vcmRpbmF0ZXMsIHBvc2l0aW9uU2l6ZSAqIHZlcnRpY2VzICogZmFjZSApOwoJCQl1di5zZXQoIHV2MSwgdXZTaXplICogdmVydGljZXMgKiBmYWNlICk7CgkJCWNvbnN0IGZpbGwgPSBbIGZhY2UsIGZhY2UsIGZhY2UsIGZhY2UsIGZhY2UsIGZhY2UgXTsKCQkJZmFjZUluZGV4LnNldCggZmlsbCwgZmFjZUluZGV4U2l6ZSAqIHZlcnRpY2VzICogZmFjZSApOwoKCQl9CgoJCWNvbnN0IHBsYW5lcyA9IG5ldyBCdWZmZXJHZW9tZXRyeSgpOwoJCXBsYW5lcy5zZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicsIG5ldyBCdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uLCBwb3NpdGlvblNpemUgKSApOwoJCXBsYW5lcy5zZXRBdHRyaWJ1dGUoICd1dicsIG5ldyBCdWZmZXJBdHRyaWJ1dGUoIHV2LCB1dlNpemUgKSApOwoJCXBsYW5lcy5zZXRBdHRyaWJ1dGUoICdmYWNlSW5kZXgnLCBuZXcgQnVmZmVyQXR0cmlidXRlKCBmYWNlSW5kZXgsIGZhY2VJbmRleFNpemUgKSApOwoJCWxvZFBsYW5lcy5wdXNoKCBwbGFuZXMgKTsKCgkJaWYgKCBsb2QgPiBMT0RfTUlOICkgewoKCQkJbG9kIC0tOwoKCQl9CgoJfQoKCXJldHVybiB7IGxvZFBsYW5lcywgc2l6ZUxvZHMsIHNpZ21hcyB9OwoKfQoKZnVuY3Rpb24gX2NyZWF0ZVJlbmRlclRhcmdldCggd2lkdGgsIGhlaWdodCwgcGFyYW1zICkgewoKCWNvbnN0IGN1YmVVVlJlbmRlclRhcmdldCA9IG5ldyBXZWJHTFJlbmRlclRhcmdldCggd2lkdGgsIGhlaWdodCwgcGFyYW1zICk7CgljdWJlVVZSZW5kZXJUYXJnZXQudGV4dHVyZS5tYXBwaW5nID0gQ3ViZVVWUmVmbGVjdGlvbk1hcHBpbmc7CgljdWJlVVZSZW5kZXJUYXJnZXQudGV4dHVyZS5uYW1lID0gJ1BNUkVNLmN1YmVVdic7CgljdWJlVVZSZW5kZXJUYXJnZXQuc2Npc3NvclRlc3QgPSB0cnVlOwoJcmV0dXJuIGN1YmVVVlJlbmRlclRhcmdldDsKCn0KCmZ1bmN0aW9uIF9zZXRWaWV3cG9ydCggdGFyZ2V0LCB4LCB5LCB3aWR0aCwgaGVpZ2h0ICkgewoKCXRhcmdldC52aWV3cG9ydC5zZXQoIHgsIHksIHdpZHRoLCBoZWlnaHQgKTsKCXRhcmdldC5zY2lzc29yLnNldCggeCwgeSwgd2lkdGgsIGhlaWdodCApOwoKfQoKZnVuY3Rpb24gX2dldEJsdXJTaGFkZXIoIGxvZE1heCwgd2lkdGgsIGhlaWdodCApIHsKCgljb25zdCB3ZWlnaHRzID0gbmV3IEZsb2F0MzJBcnJheSggTUFYX1NBTVBMRVMgKTsKCWNvbnN0IHBvbGVBeGlzID0gbmV3IFZlY3RvcjMoIDAsIDEsIDAgKTsKCWNvbnN0IHNoYWRlck1hdGVyaWFsID0gbmV3IFNoYWRlck1hdGVyaWFsKCB7CgoJCW5hbWU6ICdTcGhlcmljYWxHYXVzc2lhbkJsdXInLAoKCQlkZWZpbmVzOiB7CgkJCSduJzogTUFYX1NBTVBMRVMsCgkJCSdDVUJFVVZfVEVYRUxfV0lEVEgnOiAxLjAgLyB3aWR0aCwKCQkJJ0NVQkVVVl9URVhFTF9IRUlHSFQnOiAxLjAgLyBoZWlnaHQsCgkJCSdDVUJFVVZfTUFYX01JUCc6IGAke2xvZE1heH0uMGAsCgkJfSwKCgkJdW5pZm9ybXM6IHsKCQkJJ2Vudk1hcCc6IHsgdmFsdWU6IG51bGwgfSwKCQkJJ3NhbXBsZXMnOiB7IHZhbHVlOiAxIH0sCgkJCSd3ZWlnaHRzJzogeyB2YWx1ZTogd2VpZ2h0cyB9LAoJCQknbGF0aXR1ZGluYWwnOiB7IHZhbHVlOiBmYWxzZSB9LAoJCQknZFRoZXRhJzogeyB2YWx1ZTogMCB9LAoJCQknbWlwSW50JzogeyB2YWx1ZTogMCB9LAoJCQkncG9sZUF4aXMnOiB7IHZhbHVlOiBwb2xlQXhpcyB9CgkJfSwKCgkJdmVydGV4U2hhZGVyOiBfZ2V0Q29tbW9uVmVydGV4U2hhZGVyKCksCgoJCWZyYWdtZW50U2hhZGVyOiAvKiBnbHNsICovYAoKCQkJcHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7CgkJCXByZWNpc2lvbiBtZWRpdW1wIGludDsKCgkJCXZhcnlpbmcgdmVjMyB2T3V0cHV0RGlyZWN0aW9uOwoKCQkJdW5pZm9ybSBzYW1wbGVyMkQgZW52TWFwOwoJCQl1bmlmb3JtIGludCBzYW1wbGVzOwoJCQl1bmlmb3JtIGZsb2F0IHdlaWdodHNbIG4gXTsKCQkJdW5pZm9ybSBib29sIGxhdGl0dWRpbmFsOwoJCQl1bmlmb3JtIGZsb2F0IGRUaGV0YTsKCQkJdW5pZm9ybSBmbG9hdCBtaXBJbnQ7CgkJCXVuaWZvcm0gdmVjMyBwb2xlQXhpczsKCgkJCSNkZWZpbmUgRU5WTUFQX1RZUEVfQ1VCRV9VVgoJCQkjaW5jbHVkZSA8Y3ViZV91dl9yZWZsZWN0aW9uX2ZyYWdtZW50PgoKCQkJdmVjMyBnZXRTYW1wbGUoIGZsb2F0IHRoZXRhLCB2ZWMzIGF4aXMgKSB7CgoJCQkJZmxvYXQgY29zVGhldGEgPSBjb3MoIHRoZXRhICk7CgkJCQkvLyBSb2RyaWd1ZXMnIGF4aXMtYW5nbGUgcm90YXRpb24KCQkJCXZlYzMgc2FtcGxlRGlyZWN0aW9uID0gdk91dHB1dERpcmVjdGlvbiAqIGNvc1RoZXRhCgkJCQkJKyBjcm9zcyggYXhpcywgdk91dHB1dERpcmVjdGlvbiApICogc2luKCB0aGV0YSApCgkJCQkJKyBheGlzICogZG90KCBheGlzLCB2T3V0cHV0RGlyZWN0aW9uICkgKiAoIDEuMCAtIGNvc1RoZXRhICk7CgoJCQkJcmV0dXJuIGJpbGluZWFyQ3ViZVVWKCBlbnZNYXAsIHNhbXBsZURpcmVjdGlvbiwgbWlwSW50ICk7CgoJCQl9CgoJCQl2b2lkIG1haW4oKSB7CgoJCQkJdmVjMyBheGlzID0gbGF0aXR1ZGluYWwgPyBwb2xlQXhpcyA6IGNyb3NzKCBwb2xlQXhpcywgdk91dHB1dERpcmVjdGlvbiApOwoKCQkJCWlmICggYWxsKCBlcXVhbCggYXhpcywgdmVjMyggMC4wICkgKSApICkgewoKCQkJCQlheGlzID0gdmVjMyggdk91dHB1dERpcmVjdGlvbi56LCAwLjAsIC0gdk91dHB1dERpcmVjdGlvbi54ICk7CgoJCQkJfQoKCQkJCWF4aXMgPSBub3JtYWxpemUoIGF4aXMgKTsKCgkJCQlnbF9GcmFnQ29sb3IgPSB2ZWM0KCAwLjAsIDAuMCwgMC4wLCAxLjAgKTsKCQkJCWdsX0ZyYWdDb2xvci5yZ2IgKz0gd2VpZ2h0c1sgMCBdICogZ2V0U2FtcGxlKCAwLjAsIGF4aXMgKTsKCgkJCQlmb3IgKCBpbnQgaSA9IDE7IGkgPCBuOyBpKysgKSB7CgoJCQkJCWlmICggaSA+PSBzYW1wbGVzICkgewoKCQkJCQkJYnJlYWs7CgoJCQkJCX0KCgkJCQkJZmxvYXQgdGhldGEgPSBkVGhldGEgKiBmbG9hdCggaSApOwoJCQkJCWdsX0ZyYWdDb2xvci5yZ2IgKz0gd2VpZ2h0c1sgaSBdICogZ2V0U2FtcGxlKCAtMS4wICogdGhldGEsIGF4aXMgKTsKCQkJCQlnbF9GcmFnQ29sb3IucmdiICs9IHdlaWdodHNbIGkgXSAqIGdldFNhbXBsZSggdGhldGEsIGF4aXMgKTsKCgkJCQl9CgoJCQl9CgkJYCwKCgkJYmxlbmRpbmc6IE5vQmxlbmRpbmcsCgkJZGVwdGhUZXN0OiBmYWxzZSwKCQlkZXB0aFdyaXRlOiBmYWxzZQoKCX0gKTsKCglyZXR1cm4gc2hhZGVyTWF0ZXJpYWw7Cgp9CgpmdW5jdGlvbiBfZ2V0RXF1aXJlY3RNYXRlcmlhbCgpIHsKCglyZXR1cm4gbmV3IFNoYWRlck1hdGVyaWFsKCB7CgoJCW5hbWU6ICdFcXVpcmVjdGFuZ3VsYXJUb0N1YmVVVicsCgoJCXVuaWZvcm1zOiB7CgkJCSdlbnZNYXAnOiB7IHZhbHVlOiBudWxsIH0KCQl9LAoKCQl2ZXJ0ZXhTaGFkZXI6IF9nZXRDb21tb25WZXJ0ZXhTaGFkZXIoKSwKCgkJZnJhZ21lbnRTaGFkZXI6IC8qIGdsc2wgKi9gCgoJCQlwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsKCQkJcHJlY2lzaW9uIG1lZGl1bXAgaW50OwoKCQkJdmFyeWluZyB2ZWMzIHZPdXRwdXREaXJlY3Rpb247CgoJCQl1bmlmb3JtIHNhbXBsZXIyRCBlbnZNYXA7CgoJCQkjaW5jbHVkZSA8Y29tbW9uPgoKCQkJdm9pZCBtYWluKCkgewoKCQkJCXZlYzMgb3V0cHV0RGlyZWN0aW9uID0gbm9ybWFsaXplKCB2T3V0cHV0RGlyZWN0aW9uICk7CgkJCQl2ZWMyIHV2ID0gZXF1aXJlY3RVdiggb3V0cHV0RGlyZWN0aW9uICk7CgoJCQkJZ2xfRnJhZ0NvbG9yID0gdmVjNCggdGV4dHVyZTJEICggZW52TWFwLCB1diApLnJnYiwgMS4wICk7CgoJCQl9CgkJYCwKCgkJYmxlbmRpbmc6IE5vQmxlbmRpbmcsCgkJZGVwdGhUZXN0OiBmYWxzZSwKCQlkZXB0aFdyaXRlOiBmYWxzZQoKCX0gKTsKCn0KCmZ1bmN0aW9uIF9nZXRDdWJlbWFwTWF0ZXJpYWwoKSB7CgoJcmV0dXJuIG5ldyBTaGFkZXJNYXRlcmlhbCggewoKCQluYW1lOiAnQ3ViZW1hcFRvQ3ViZVVWJywKCgkJdW5pZm9ybXM6IHsKCQkJJ2Vudk1hcCc6IHsgdmFsdWU6IG51bGwgfSwKCQkJJ2ZsaXBFbnZNYXAnOiB7IHZhbHVlOiAtIDEgfQoJCX0sCgoJCXZlcnRleFNoYWRlcjogX2dldENvbW1vblZlcnRleFNoYWRlcigpLAoKCQlmcmFnbWVudFNoYWRlcjogLyogZ2xzbCAqL2AKCgkJCXByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OwoJCQlwcmVjaXNpb24gbWVkaXVtcCBpbnQ7CgoJCQl1bmlmb3JtIGZsb2F0IGZsaXBFbnZNYXA7CgoJCQl2YXJ5aW5nIHZlYzMgdk91dHB1dERpcmVjdGlvbjsKCgkJCXVuaWZvcm0gc2FtcGxlckN1YmUgZW52TWFwOwoKCQkJdm9pZCBtYWluKCkgewoKCQkJCWdsX0ZyYWdDb2xvciA9IHRleHR1cmVDdWJlKCBlbnZNYXAsIHZlYzMoIGZsaXBFbnZNYXAgKiB2T3V0cHV0RGlyZWN0aW9uLngsIHZPdXRwdXREaXJlY3Rpb24ueXogKSApOwoKCQkJfQoJCWAsCgoJCWJsZW5kaW5nOiBOb0JsZW5kaW5nLAoJCWRlcHRoVGVzdDogZmFsc2UsCgkJZGVwdGhXcml0ZTogZmFsc2UKCgl9ICk7Cgp9CgpmdW5jdGlvbiBfZ2V0Q29tbW9uVmVydGV4U2hhZGVyKCkgewoKCXJldHVybiAvKiBnbHNsICovYAoKCQlwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsKCQlwcmVjaXNpb24gbWVkaXVtcCBpbnQ7CgoJCWF0dHJpYnV0ZSBmbG9hdCBmYWNlSW5kZXg7CgoJCXZhcnlpbmcgdmVjMyB2T3V0cHV0RGlyZWN0aW9uOwoKCQkvLyBSSCBjb29yZGluYXRlIHN5c3RlbTsgUE1SRU0gZmFjZS1pbmRleGluZyBjb252ZW50aW9uCgkJdmVjMyBnZXREaXJlY3Rpb24oIHZlYzIgdXYsIGZsb2F0IGZhY2UgKSB7CgoJCQl1diA9IDIuMCAqIHV2IC0gMS4wOwoKCQkJdmVjMyBkaXJlY3Rpb24gPSB2ZWMzKCB1diwgMS4wICk7CgoJCQlpZiAoIGZhY2UgPT0gMC4wICkgewoKCQkJCWRpcmVjdGlvbiA9IGRpcmVjdGlvbi56eXg7IC8vICggMSwgdiwgdSApIHBvcyB4CgoJCQl9IGVsc2UgaWYgKCBmYWNlID09IDEuMCApIHsKCgkJCQlkaXJlY3Rpb24gPSBkaXJlY3Rpb24ueHp5OwoJCQkJZGlyZWN0aW9uLnh6ICo9IC0xLjA7IC8vICggLXUsIDEsIC12ICkgcG9zIHkKCgkJCX0gZWxzZSBpZiAoIGZhY2UgPT0gMi4wICkgewoKCQkJCWRpcmVjdGlvbi54ICo9IC0xLjA7IC8vICggLXUsIHYsIDEgKSBwb3MgegoKCQkJfSBlbHNlIGlmICggZmFjZSA9PSAzLjAgKSB7CgoJCQkJZGlyZWN0aW9uID0gZGlyZWN0aW9uLnp5eDsKCQkJCWRpcmVjdGlvbi54eiAqPSAtMS4wOyAvLyAoIC0xLCB2LCAtdSApIG5lZyB4CgoJCQl9IGVsc2UgaWYgKCBmYWNlID09IDQuMCApIHsKCgkJCQlkaXJlY3Rpb24gPSBkaXJlY3Rpb24ueHp5OwoJCQkJZGlyZWN0aW9uLnh5ICo9IC0xLjA7IC8vICggLXUsIC0xLCB2ICkgbmVnIHkKCgkJCX0gZWxzZSBpZiAoIGZhY2UgPT0gNS4wICkgewoKCQkJCWRpcmVjdGlvbi56ICo9IC0xLjA7IC8vICggdSwgdiwgLTEgKSBuZWcgegoKCQkJfQoKCQkJcmV0dXJuIGRpcmVjdGlvbjsKCgkJfQoKCQl2b2lkIG1haW4oKSB7CgoJCQl2T3V0cHV0RGlyZWN0aW9uID0gZ2V0RGlyZWN0aW9uKCB1diwgZmFjZUluZGV4ICk7CgkJCWdsX1Bvc2l0aW9uID0gdmVjNCggcG9zaXRpb24sIDEuMCApOwoKCQl9CglgOwoKfQoKZnVuY3Rpb24gV2ViR0xDdWJlVVZNYXBzKCByZW5kZXJlciApIHsKCglsZXQgY3ViZVVWbWFwcyA9IG5ldyBXZWFrTWFwKCk7CgoJbGV0IHBtcmVtR2VuZXJhdG9yID0gbnVsbDsKCglmdW5jdGlvbiBnZXQoIHRleHR1cmUgKSB7CgoJCWlmICggdGV4dHVyZSAmJiB0ZXh0dXJlLmlzVGV4dHVyZSApIHsKCgkJCWNvbnN0IG1hcHBpbmcgPSB0ZXh0dXJlLm1hcHBpbmc7CgoJCQljb25zdCBpc0VxdWlyZWN0TWFwID0gKCBtYXBwaW5nID09PSBFcXVpcmVjdGFuZ3VsYXJSZWZsZWN0aW9uTWFwcGluZyB8fCBtYXBwaW5nID09PSBFcXVpcmVjdGFuZ3VsYXJSZWZyYWN0aW9uTWFwcGluZyApOwoJCQljb25zdCBpc0N1YmVNYXAgPSAoIG1hcHBpbmcgPT09IEN1YmVSZWZsZWN0aW9uTWFwcGluZyB8fCBtYXBwaW5nID09PSBDdWJlUmVmcmFjdGlvbk1hcHBpbmcgKTsKCgkJCS8vIGVxdWlyZWN0L2N1YmUgbWFwIHRvIGN1YmVVViBjb252ZXJzaW9uCgoJCQlpZiAoIGlzRXF1aXJlY3RNYXAgfHwgaXNDdWJlTWFwICkgewoKCQkJCWlmICggdGV4dHVyZS5pc1JlbmRlclRhcmdldFRleHR1cmUgJiYgdGV4dHVyZS5uZWVkc1BNUkVNVXBkYXRlID09PSB0cnVlICkgewoKCQkJCQl0ZXh0dXJlLm5lZWRzUE1SRU1VcGRhdGUgPSBmYWxzZTsKCgkJCQkJbGV0IHJlbmRlclRhcmdldCA9IGN1YmVVVm1hcHMuZ2V0KCB0ZXh0dXJlICk7CgoJCQkJCWlmICggcG1yZW1HZW5lcmF0b3IgPT09IG51bGwgKSBwbXJlbUdlbmVyYXRvciA9IG5ldyBQTVJFTUdlbmVyYXRvciggcmVuZGVyZXIgKTsKCgkJCQkJcmVuZGVyVGFyZ2V0ID0gaXNFcXVpcmVjdE1hcCA/IHBtcmVtR2VuZXJhdG9yLmZyb21FcXVpcmVjdGFuZ3VsYXIoIHRleHR1cmUsIHJlbmRlclRhcmdldCApIDogcG1yZW1HZW5lcmF0b3IuZnJvbUN1YmVtYXAoIHRleHR1cmUsIHJlbmRlclRhcmdldCApOwoJCQkJCWN1YmVVVm1hcHMuc2V0KCB0ZXh0dXJlLCByZW5kZXJUYXJnZXQgKTsKCgkJCQkJcmV0dXJuIHJlbmRlclRhcmdldC50ZXh0dXJlOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggY3ViZVVWbWFwcy5oYXMoIHRleHR1cmUgKSApIHsKCgkJCQkJCXJldHVybiBjdWJlVVZtYXBzLmdldCggdGV4dHVyZSApLnRleHR1cmU7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQljb25zdCBpbWFnZSA9IHRleHR1cmUuaW1hZ2U7CgoJCQkJCQlpZiAoICggaXNFcXVpcmVjdE1hcCAmJiBpbWFnZSAmJiBpbWFnZS5oZWlnaHQgPiAwICkgfHwgKCBpc0N1YmVNYXAgJiYgaW1hZ2UgJiYgaXNDdWJlVGV4dHVyZUNvbXBsZXRlKCBpbWFnZSApICkgKSB7CgoJCQkJCQkJaWYgKCBwbXJlbUdlbmVyYXRvciA9PT0gbnVsbCApIHBtcmVtR2VuZXJhdG9yID0gbmV3IFBNUkVNR2VuZXJhdG9yKCByZW5kZXJlciApOwoKCQkJCQkJCWNvbnN0IHJlbmRlclRhcmdldCA9IGlzRXF1aXJlY3RNYXAgPyBwbXJlbUdlbmVyYXRvci5mcm9tRXF1aXJlY3Rhbmd1bGFyKCB0ZXh0dXJlICkgOiBwbXJlbUdlbmVyYXRvci5mcm9tQ3ViZW1hcCggdGV4dHVyZSApOwoJCQkJCQkJY3ViZVVWbWFwcy5zZXQoIHRleHR1cmUsIHJlbmRlclRhcmdldCApOwoKCQkJCQkJCXRleHR1cmUuYWRkRXZlbnRMaXN0ZW5lciggJ2Rpc3Bvc2UnLCBvblRleHR1cmVEaXNwb3NlICk7CgoJCQkJCQkJcmV0dXJuIHJlbmRlclRhcmdldC50ZXh0dXJlOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkvLyBpbWFnZSBub3QgeWV0IHJlYWR5LiB0cnkgdGhlIGNvbnZlcnNpb24gbmV4dCBmcmFtZQoKCQkJCQkJCXJldHVybiBudWxsOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQl9CgoJCXJldHVybiB0ZXh0dXJlOwoKCX0KCglmdW5jdGlvbiBpc0N1YmVUZXh0dXJlQ29tcGxldGUoIGltYWdlICkgewoKCQlsZXQgY291bnQgPSAwOwoJCWNvbnN0IGxlbmd0aCA9IDY7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArKyApIHsKCgkJCWlmICggaW1hZ2VbIGkgXSAhPT0gdW5kZWZpbmVkICkgY291bnQgKys7CgoJCX0KCgkJcmV0dXJuIGNvdW50ID09PSBsZW5ndGg7CgoKCX0KCglmdW5jdGlvbiBvblRleHR1cmVEaXNwb3NlKCBldmVudCApIHsKCgkJY29uc3QgdGV4dHVyZSA9IGV2ZW50LnRhcmdldDsKCgkJdGV4dHVyZS5yZW1vdmVFdmVudExpc3RlbmVyKCAnZGlzcG9zZScsIG9uVGV4dHVyZURpc3Bvc2UgKTsKCgkJY29uc3QgY3ViZW1hcFVWID0gY3ViZVVWbWFwcy5nZXQoIHRleHR1cmUgKTsKCgkJaWYgKCBjdWJlbWFwVVYgIT09IHVuZGVmaW5lZCApIHsKCgkJCWN1YmVVVm1hcHMuZGVsZXRlKCB0ZXh0dXJlICk7CgkJCWN1YmVtYXBVVi5kaXNwb3NlKCk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gZGlzcG9zZSgpIHsKCgkJY3ViZVVWbWFwcyA9IG5ldyBXZWFrTWFwKCk7CgoJCWlmICggcG1yZW1HZW5lcmF0b3IgIT09IG51bGwgKSB7CgoJCQlwbXJlbUdlbmVyYXRvci5kaXNwb3NlKCk7CgkJCXBtcmVtR2VuZXJhdG9yID0gbnVsbDsKCgkJfQoKCX0KCglyZXR1cm4gewoJCWdldDogZ2V0LAoJCWRpc3Bvc2U6IGRpc3Bvc2UKCX07Cgp9CgpmdW5jdGlvbiBXZWJHTEV4dGVuc2lvbnMoIGdsICkgewoKCWNvbnN0IGV4dGVuc2lvbnMgPSB7fTsKCglmdW5jdGlvbiBnZXRFeHRlbnNpb24oIG5hbWUgKSB7CgoJCWlmICggZXh0ZW5zaW9uc1sgbmFtZSBdICE9PSB1bmRlZmluZWQgKSB7CgoJCQlyZXR1cm4gZXh0ZW5zaW9uc1sgbmFtZSBdOwoKCQl9CgoJCWxldCBleHRlbnNpb247CgoJCXN3aXRjaCAoIG5hbWUgKSB7CgoJCQljYXNlICdXRUJHTF9kZXB0aF90ZXh0dXJlJzoKCQkJCWV4dGVuc2lvbiA9IGdsLmdldEV4dGVuc2lvbiggJ1dFQkdMX2RlcHRoX3RleHR1cmUnICkgfHwgZ2wuZ2V0RXh0ZW5zaW9uKCAnTU9aX1dFQkdMX2RlcHRoX3RleHR1cmUnICkgfHwgZ2wuZ2V0RXh0ZW5zaW9uKCAnV0VCS0lUX1dFQkdMX2RlcHRoX3RleHR1cmUnICk7CgkJCQlicmVhazsKCgkJCWNhc2UgJ0VYVF90ZXh0dXJlX2ZpbHRlcl9hbmlzb3Ryb3BpYyc6CgkJCQlleHRlbnNpb24gPSBnbC5nZXRFeHRlbnNpb24oICdFWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMnICkgfHwgZ2wuZ2V0RXh0ZW5zaW9uKCAnTU9aX0VYVF90ZXh0dXJlX2ZpbHRlcl9hbmlzb3Ryb3BpYycgKSB8fCBnbC5nZXRFeHRlbnNpb24oICdXRUJLSVRfRVhUX3RleHR1cmVfZmlsdGVyX2FuaXNvdHJvcGljJyApOwoJCQkJYnJlYWs7CgoJCQljYXNlICdXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0Yyc6CgkJCQlleHRlbnNpb24gPSBnbC5nZXRFeHRlbnNpb24oICdXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0YycgKSB8fCBnbC5nZXRFeHRlbnNpb24oICdNT1pfV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX3MzdGMnICkgfHwgZ2wuZ2V0RXh0ZW5zaW9uKCAnV0VCS0lUX1dFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9zM3RjJyApOwoJCQkJYnJlYWs7CgoJCQljYXNlICdXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfcHZydGMnOgoJCQkJZXh0ZW5zaW9uID0gZ2wuZ2V0RXh0ZW5zaW9uKCAnV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX3B2cnRjJyApIHx8IGdsLmdldEV4dGVuc2lvbiggJ1dFQktJVF9XRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfcHZydGMnICk7CgkJCQlicmVhazsKCgkJCWRlZmF1bHQ6CgkJCQlleHRlbnNpb24gPSBnbC5nZXRFeHRlbnNpb24oIG5hbWUgKTsKCgkJfQoKCQlleHRlbnNpb25zWyBuYW1lIF0gPSBleHRlbnNpb247CgoJCXJldHVybiBleHRlbnNpb247CgoJfQoKCXJldHVybiB7CgoJCWhhczogZnVuY3Rpb24gKCBuYW1lICkgewoKCQkJcmV0dXJuIGdldEV4dGVuc2lvbiggbmFtZSApICE9PSBudWxsOwoKCQl9LAoKCQlpbml0OiBmdW5jdGlvbiAoIGNhcGFiaWxpdGllcyApIHsKCgkJCWlmICggY2FwYWJpbGl0aWVzLmlzV2ViR0wyICkgewoKCQkJCWdldEV4dGVuc2lvbiggJ0VYVF9jb2xvcl9idWZmZXJfZmxvYXQnICk7CgkJCQlnZXRFeHRlbnNpb24oICdXRUJHTF9jbGlwX2N1bGxfZGlzdGFuY2UnICk7CgoJCQl9IGVsc2UgewoKCQkJCWdldEV4dGVuc2lvbiggJ1dFQkdMX2RlcHRoX3RleHR1cmUnICk7CgkJCQlnZXRFeHRlbnNpb24oICdPRVNfdGV4dHVyZV9mbG9hdCcgKTsKCQkJCWdldEV4dGVuc2lvbiggJ09FU190ZXh0dXJlX2hhbGZfZmxvYXQnICk7CgkJCQlnZXRFeHRlbnNpb24oICdPRVNfdGV4dHVyZV9oYWxmX2Zsb2F0X2xpbmVhcicgKTsKCQkJCWdldEV4dGVuc2lvbiggJ09FU19zdGFuZGFyZF9kZXJpdmF0aXZlcycgKTsKCQkJCWdldEV4dGVuc2lvbiggJ09FU19lbGVtZW50X2luZGV4X3VpbnQnICk7CgkJCQlnZXRFeHRlbnNpb24oICdPRVNfdmVydGV4X2FycmF5X29iamVjdCcgKTsKCQkJCWdldEV4dGVuc2lvbiggJ0FOR0xFX2luc3RhbmNlZF9hcnJheXMnICk7CgoJCQl9CgoJCQlnZXRFeHRlbnNpb24oICdPRVNfdGV4dHVyZV9mbG9hdF9saW5lYXInICk7CgkJCWdldEV4dGVuc2lvbiggJ0VYVF9jb2xvcl9idWZmZXJfaGFsZl9mbG9hdCcgKTsKCQkJZ2V0RXh0ZW5zaW9uKCAnV0VCR0xfbXVsdGlzYW1wbGVkX3JlbmRlcl90b190ZXh0dXJlJyApOwoKCQl9LAoKCQlnZXQ6IGZ1bmN0aW9uICggbmFtZSApIHsKCgkJCWNvbnN0IGV4dGVuc2lvbiA9IGdldEV4dGVuc2lvbiggbmFtZSApOwoKCQkJaWYgKCBleHRlbnNpb24gPT09IG51bGwgKSB7CgoJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogJyArIG5hbWUgKyAnIGV4dGVuc2lvbiBub3Qgc3VwcG9ydGVkLicgKTsKCgkJCX0KCgkJCXJldHVybiBleHRlbnNpb247CgoJCX0KCgl9OwoKfQoKZnVuY3Rpb24gV2ViR0xHZW9tZXRyaWVzKCBnbCwgYXR0cmlidXRlcywgaW5mbywgYmluZGluZ1N0YXRlcyApIHsKCgljb25zdCBnZW9tZXRyaWVzID0ge307Cgljb25zdCB3aXJlZnJhbWVBdHRyaWJ1dGVzID0gbmV3IFdlYWtNYXAoKTsKCglmdW5jdGlvbiBvbkdlb21ldHJ5RGlzcG9zZSggZXZlbnQgKSB7CgoJCWNvbnN0IGdlb21ldHJ5ID0gZXZlbnQudGFyZ2V0OwoKCQlpZiAoIGdlb21ldHJ5LmluZGV4ICE9PSBudWxsICkgewoKCQkJYXR0cmlidXRlcy5yZW1vdmUoIGdlb21ldHJ5LmluZGV4ICk7CgoJCX0KCgkJZm9yICggY29uc3QgbmFtZSBpbiBnZW9tZXRyeS5hdHRyaWJ1dGVzICkgewoKCQkJYXR0cmlidXRlcy5yZW1vdmUoIGdlb21ldHJ5LmF0dHJpYnV0ZXNbIG5hbWUgXSApOwoKCQl9CgoJCWZvciAoIGNvbnN0IG5hbWUgaW4gZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzICkgewoKCQkJY29uc3QgYXJyYXkgPSBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXNbIG5hbWUgXTsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJYXR0cmlidXRlcy5yZW1vdmUoIGFycmF5WyBpIF0gKTsKCgkJCX0KCgkJfQoKCQlnZW9tZXRyeS5yZW1vdmVFdmVudExpc3RlbmVyKCAnZGlzcG9zZScsIG9uR2VvbWV0cnlEaXNwb3NlICk7CgoJCWRlbGV0ZSBnZW9tZXRyaWVzWyBnZW9tZXRyeS5pZCBdOwoKCQljb25zdCBhdHRyaWJ1dGUgPSB3aXJlZnJhbWVBdHRyaWJ1dGVzLmdldCggZ2VvbWV0cnkgKTsKCgkJaWYgKCBhdHRyaWJ1dGUgKSB7CgoJCQlhdHRyaWJ1dGVzLnJlbW92ZSggYXR0cmlidXRlICk7CgkJCXdpcmVmcmFtZUF0dHJpYnV0ZXMuZGVsZXRlKCBnZW9tZXRyeSApOwoKCQl9CgoJCWJpbmRpbmdTdGF0ZXMucmVsZWFzZVN0YXRlc09mR2VvbWV0cnkoIGdlb21ldHJ5ICk7CgoJCWlmICggZ2VvbWV0cnkuaXNJbnN0YW5jZWRCdWZmZXJHZW9tZXRyeSA9PT0gdHJ1ZSApIHsKCgkJCWRlbGV0ZSBnZW9tZXRyeS5fbWF4SW5zdGFuY2VDb3VudDsKCgkJfQoKCQkvLwoKCQlpbmZvLm1lbW9yeS5nZW9tZXRyaWVzIC0tOwoKCX0KCglmdW5jdGlvbiBnZXQoIG9iamVjdCwgZ2VvbWV0cnkgKSB7CgoJCWlmICggZ2VvbWV0cmllc1sgZ2VvbWV0cnkuaWQgXSA9PT0gdHJ1ZSApIHJldHVybiBnZW9tZXRyeTsKCgkJZ2VvbWV0cnkuYWRkRXZlbnRMaXN0ZW5lciggJ2Rpc3Bvc2UnLCBvbkdlb21ldHJ5RGlzcG9zZSApOwoKCQlnZW9tZXRyaWVzWyBnZW9tZXRyeS5pZCBdID0gdHJ1ZTsKCgkJaW5mby5tZW1vcnkuZ2VvbWV0cmllcyArKzsKCgkJcmV0dXJuIGdlb21ldHJ5OwoKCX0KCglmdW5jdGlvbiB1cGRhdGUoIGdlb21ldHJ5ICkgewoKCQljb25zdCBnZW9tZXRyeUF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzOwoKCQkvLyBVcGRhdGluZyBpbmRleCBidWZmZXIgaW4gVkFPIG5vdy4gU2VlIFdlYkdMQmluZGluZ1N0YXRlcy4KCgkJZm9yICggY29uc3QgbmFtZSBpbiBnZW9tZXRyeUF0dHJpYnV0ZXMgKSB7CgoJCQlhdHRyaWJ1dGVzLnVwZGF0ZSggZ2VvbWV0cnlBdHRyaWJ1dGVzWyBuYW1lIF0sIGdsLkFSUkFZX0JVRkZFUiApOwoKCQl9CgoJCS8vIG1vcnBoIHRhcmdldHMKCgkJY29uc3QgbW9ycGhBdHRyaWJ1dGVzID0gZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzOwoKCQlmb3IgKCBjb25zdCBuYW1lIGluIG1vcnBoQXR0cmlidXRlcyApIHsKCgkJCWNvbnN0IGFycmF5ID0gbW9ycGhBdHRyaWJ1dGVzWyBuYW1lIF07CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWF0dHJpYnV0ZXMudXBkYXRlKCBhcnJheVsgaSBdLCBnbC5BUlJBWV9CVUZGRVIgKTsKCgkJCX0KCgkJfQoKCX0KCglmdW5jdGlvbiB1cGRhdGVXaXJlZnJhbWVBdHRyaWJ1dGUoIGdlb21ldHJ5ICkgewoKCQljb25zdCBpbmRpY2VzID0gW107CgoJCWNvbnN0IGdlb21ldHJ5SW5kZXggPSBnZW9tZXRyeS5pbmRleDsKCQljb25zdCBnZW9tZXRyeVBvc2l0aW9uID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKCQlsZXQgdmVyc2lvbiA9IDA7CgoJCWlmICggZ2VvbWV0cnlJbmRleCAhPT0gbnVsbCApIHsKCgkJCWNvbnN0IGFycmF5ID0gZ2VvbWV0cnlJbmRleC5hcnJheTsKCQkJdmVyc2lvbiA9IGdlb21ldHJ5SW5kZXgudmVyc2lvbjsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkgKz0gMyApIHsKCgkJCQljb25zdCBhID0gYXJyYXlbIGkgKyAwIF07CgkJCQljb25zdCBiID0gYXJyYXlbIGkgKyAxIF07CgkJCQljb25zdCBjID0gYXJyYXlbIGkgKyAyIF07CgoJCQkJaW5kaWNlcy5wdXNoKCBhLCBiLCBiLCBjLCBjLCBhICk7CgoJCQl9CgoJCX0gZWxzZSBpZiAoIGdlb21ldHJ5UG9zaXRpb24gIT09IHVuZGVmaW5lZCApIHsKCgkJCWNvbnN0IGFycmF5ID0gZ2VvbWV0cnlQb3NpdGlvbi5hcnJheTsKCQkJdmVyc2lvbiA9IGdlb21ldHJ5UG9zaXRpb24udmVyc2lvbjsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9ICggYXJyYXkubGVuZ3RoIC8gMyApIC0gMTsgaSA8IGw7IGkgKz0gMyApIHsKCgkJCQljb25zdCBhID0gaSArIDA7CgkJCQljb25zdCBiID0gaSArIDE7CgkJCQljb25zdCBjID0gaSArIDI7CgoJCQkJaW5kaWNlcy5wdXNoKCBhLCBiLCBiLCBjLCBjLCBhICk7CgoJCQl9CgoJCX0gZWxzZSB7CgoJCQlyZXR1cm47CgoJCX0KCgkJY29uc3QgYXR0cmlidXRlID0gbmV3ICggYXJyYXlOZWVkc1VpbnQzMiggaW5kaWNlcyApID8gVWludDMyQnVmZmVyQXR0cmlidXRlIDogVWludDE2QnVmZmVyQXR0cmlidXRlICkoIGluZGljZXMsIDEgKTsKCQlhdHRyaWJ1dGUudmVyc2lvbiA9IHZlcnNpb247CgoJCS8vIFVwZGF0aW5nIGluZGV4IGJ1ZmZlciBpbiBWQU8gbm93LiBTZWUgV2ViR0xCaW5kaW5nU3RhdGVzCgoJCS8vCgoJCWNvbnN0IHByZXZpb3VzQXR0cmlidXRlID0gd2lyZWZyYW1lQXR0cmlidXRlcy5nZXQoIGdlb21ldHJ5ICk7CgoJCWlmICggcHJldmlvdXNBdHRyaWJ1dGUgKSBhdHRyaWJ1dGVzLnJlbW92ZSggcHJldmlvdXNBdHRyaWJ1dGUgKTsKCgkJLy8KCgkJd2lyZWZyYW1lQXR0cmlidXRlcy5zZXQoIGdlb21ldHJ5LCBhdHRyaWJ1dGUgKTsKCgl9CgoJZnVuY3Rpb24gZ2V0V2lyZWZyYW1lQXR0cmlidXRlKCBnZW9tZXRyeSApIHsKCgkJY29uc3QgY3VycmVudEF0dHJpYnV0ZSA9IHdpcmVmcmFtZUF0dHJpYnV0ZXMuZ2V0KCBnZW9tZXRyeSApOwoKCQlpZiAoIGN1cnJlbnRBdHRyaWJ1dGUgKSB7CgoJCQljb25zdCBnZW9tZXRyeUluZGV4ID0gZ2VvbWV0cnkuaW5kZXg7CgoJCQlpZiAoIGdlb21ldHJ5SW5kZXggIT09IG51bGwgKSB7CgoJCQkJLy8gaWYgdGhlIGF0dHJpYnV0ZSBpcyBvYnNvbGV0ZSwgY3JlYXRlIGEgbmV3IG9uZQoKCQkJCWlmICggY3VycmVudEF0dHJpYnV0ZS52ZXJzaW9uIDwgZ2VvbWV0cnlJbmRleC52ZXJzaW9uICkgewoKCQkJCQl1cGRhdGVXaXJlZnJhbWVBdHRyaWJ1dGUoIGdlb21ldHJ5ICk7CgoJCQkJfQoKCQkJfQoKCQl9IGVsc2UgewoKCQkJdXBkYXRlV2lyZWZyYW1lQXR0cmlidXRlKCBnZW9tZXRyeSApOwoKCQl9CgoJCXJldHVybiB3aXJlZnJhbWVBdHRyaWJ1dGVzLmdldCggZ2VvbWV0cnkgKTsKCgl9CgoJcmV0dXJuIHsKCgkJZ2V0OiBnZXQsCgkJdXBkYXRlOiB1cGRhdGUsCgoJCWdldFdpcmVmcmFtZUF0dHJpYnV0ZTogZ2V0V2lyZWZyYW1lQXR0cmlidXRlCgoJfTsKCn0KCmZ1bmN0aW9uIFdlYkdMSW5kZXhlZEJ1ZmZlclJlbmRlcmVyKCBnbCwgZXh0ZW5zaW9ucywgaW5mbywgY2FwYWJpbGl0aWVzICkgewoKCWNvbnN0IGlzV2ViR0wyID0gY2FwYWJpbGl0aWVzLmlzV2ViR0wyOwoKCWxldCBtb2RlOwoKCWZ1bmN0aW9uIHNldE1vZGUoIHZhbHVlICkgewoKCQltb2RlID0gdmFsdWU7CgoJfQoKCWxldCB0eXBlLCBieXRlc1BlckVsZW1lbnQ7CgoJZnVuY3Rpb24gc2V0SW5kZXgoIHZhbHVlICkgewoKCQl0eXBlID0gdmFsdWUudHlwZTsKCQlieXRlc1BlckVsZW1lbnQgPSB2YWx1ZS5ieXRlc1BlckVsZW1lbnQ7CgoJfQoKCWZ1bmN0aW9uIHJlbmRlciggc3RhcnQsIGNvdW50ICkgewoKCQlnbC5kcmF3RWxlbWVudHMoIG1vZGUsIGNvdW50LCB0eXBlLCBzdGFydCAqIGJ5dGVzUGVyRWxlbWVudCApOwoKCQlpbmZvLnVwZGF0ZSggY291bnQsIG1vZGUsIDEgKTsKCgl9CgoJZnVuY3Rpb24gcmVuZGVySW5zdGFuY2VzKCBzdGFydCwgY291bnQsIHByaW1jb3VudCApIHsKCgkJaWYgKCBwcmltY291bnQgPT09IDAgKSByZXR1cm47CgoJCWxldCBleHRlbnNpb24sIG1ldGhvZE5hbWU7CgoJCWlmICggaXNXZWJHTDIgKSB7CgoJCQlleHRlbnNpb24gPSBnbDsKCQkJbWV0aG9kTmFtZSA9ICdkcmF3RWxlbWVudHNJbnN0YW5jZWQnOwoKCQl9IGVsc2UgewoKCQkJZXh0ZW5zaW9uID0gZXh0ZW5zaW9ucy5nZXQoICdBTkdMRV9pbnN0YW5jZWRfYXJyYXlzJyApOwoJCQltZXRob2ROYW1lID0gJ2RyYXdFbGVtZW50c0luc3RhbmNlZEFOR0xFJzsKCgkJCWlmICggZXh0ZW5zaW9uID09PSBudWxsICkgewoKCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTEluZGV4ZWRCdWZmZXJSZW5kZXJlcjogdXNpbmcgVEhSRUUuSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnkgYnV0IGhhcmR3YXJlIGRvZXMgbm90IHN1cHBvcnQgZXh0ZW5zaW9uIEFOR0xFX2luc3RhbmNlZF9hcnJheXMuJyApOwoJCQkJcmV0dXJuOwoKCQkJfQoKCQl9CgoJCWV4dGVuc2lvblsgbWV0aG9kTmFtZSBdKCBtb2RlLCBjb3VudCwgdHlwZSwgc3RhcnQgKiBieXRlc1BlckVsZW1lbnQsIHByaW1jb3VudCApOwoKCQlpbmZvLnVwZGF0ZSggY291bnQsIG1vZGUsIHByaW1jb3VudCApOwoKCX0KCglmdW5jdGlvbiByZW5kZXJNdWx0aURyYXcoIHN0YXJ0cywgY291bnRzLCBkcmF3Q291bnQgKSB7CgoJCWlmICggZHJhd0NvdW50ID09PSAwICkgcmV0dXJuOwoKCQljb25zdCBleHRlbnNpb24gPSBleHRlbnNpb25zLmdldCggJ1dFQkdMX211bHRpX2RyYXcnICk7CgkJaWYgKCBleHRlbnNpb24gPT09IG51bGwgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBkcmF3Q291bnQ7IGkgKysgKSB7CgoJCQkJdGhpcy5yZW5kZXIoIHN0YXJ0c1sgaSBdIC8gYnl0ZXNQZXJFbGVtZW50LCBjb3VudHNbIGkgXSApOwoKCQkJfQoKCQl9IGVsc2UgewoKCQkJZXh0ZW5zaW9uLm11bHRpRHJhd0VsZW1lbnRzV0VCR0woIG1vZGUsIGNvdW50cywgMCwgdHlwZSwgc3RhcnRzLCAwLCBkcmF3Q291bnQgKTsKCgkJCWxldCBlbGVtZW50Q291bnQgPSAwOwoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBkcmF3Q291bnQ7IGkgKysgKSB7CgoJCQkJZWxlbWVudENvdW50ICs9IGNvdW50c1sgaSBdOwoKCQkJfQoKCQkJaW5mby51cGRhdGUoIGVsZW1lbnRDb3VudCwgbW9kZSwgMSApOwoKCQl9CgoJfQoKCS8vCgoJdGhpcy5zZXRNb2RlID0gc2V0TW9kZTsKCXRoaXMuc2V0SW5kZXggPSBzZXRJbmRleDsKCXRoaXMucmVuZGVyID0gcmVuZGVyOwoJdGhpcy5yZW5kZXJJbnN0YW5jZXMgPSByZW5kZXJJbnN0YW5jZXM7Cgl0aGlzLnJlbmRlck11bHRpRHJhdyA9IHJlbmRlck11bHRpRHJhdzsKCn0KCmZ1bmN0aW9uIFdlYkdMSW5mbyggZ2wgKSB7CgoJY29uc3QgbWVtb3J5ID0gewoJCWdlb21ldHJpZXM6IDAsCgkJdGV4dHVyZXM6IDAKCX07CgoJY29uc3QgcmVuZGVyID0gewoJCWZyYW1lOiAwLAoJCWNhbGxzOiAwLAoJCXRyaWFuZ2xlczogMCwKCQlwb2ludHM6IDAsCgkJbGluZXM6IDAKCX07CgoJZnVuY3Rpb24gdXBkYXRlKCBjb3VudCwgbW9kZSwgaW5zdGFuY2VDb3VudCApIHsKCgkJcmVuZGVyLmNhbGxzICsrOwoKCQlzd2l0Y2ggKCBtb2RlICkgewoKCQkJY2FzZSBnbC5UUklBTkdMRVM6CgkJCQlyZW5kZXIudHJpYW5nbGVzICs9IGluc3RhbmNlQ291bnQgKiAoIGNvdW50IC8gMyApOwoJCQkJYnJlYWs7CgoJCQljYXNlIGdsLkxJTkVTOgoJCQkJcmVuZGVyLmxpbmVzICs9IGluc3RhbmNlQ291bnQgKiAoIGNvdW50IC8gMiApOwoJCQkJYnJlYWs7CgoJCQljYXNlIGdsLkxJTkVfU1RSSVA6CgkJCQlyZW5kZXIubGluZXMgKz0gaW5zdGFuY2VDb3VudCAqICggY291bnQgLSAxICk7CgkJCQlicmVhazsKCgkJCWNhc2UgZ2wuTElORV9MT09QOgoJCQkJcmVuZGVyLmxpbmVzICs9IGluc3RhbmNlQ291bnQgKiBjb3VudDsKCQkJCWJyZWFrOwoKCQkJY2FzZSBnbC5QT0lOVFM6CgkJCQlyZW5kZXIucG9pbnRzICs9IGluc3RhbmNlQ291bnQgKiBjb3VudDsKCQkJCWJyZWFrOwoKCQkJZGVmYXVsdDoKCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTEluZm86IFVua25vd24gZHJhdyBtb2RlOicsIG1vZGUgKTsKCQkJCWJyZWFrOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIHJlc2V0KCkgewoKCQlyZW5kZXIuY2FsbHMgPSAwOwoJCXJlbmRlci50cmlhbmdsZXMgPSAwOwoJCXJlbmRlci5wb2ludHMgPSAwOwoJCXJlbmRlci5saW5lcyA9IDA7CgoJfQoKCXJldHVybiB7CgkJbWVtb3J5OiBtZW1vcnksCgkJcmVuZGVyOiByZW5kZXIsCgkJcHJvZ3JhbXM6IG51bGwsCgkJYXV0b1Jlc2V0OiB0cnVlLAoJCXJlc2V0OiByZXNldCwKCQl1cGRhdGU6IHVwZGF0ZQoJfTsKCn0KCmZ1bmN0aW9uIG51bWVyaWNhbFNvcnQoIGEsIGIgKSB7CgoJcmV0dXJuIGFbIDAgXSAtIGJbIDAgXTsKCn0KCmZ1bmN0aW9uIGFic051bWVyaWNhbFNvcnQoIGEsIGIgKSB7CgoJcmV0dXJuIE1hdGguYWJzKCBiWyAxIF0gKSAtIE1hdGguYWJzKCBhWyAxIF0gKTsKCn0KCmZ1bmN0aW9uIFdlYkdMTW9ycGh0YXJnZXRzKCBnbCwgY2FwYWJpbGl0aWVzLCB0ZXh0dXJlcyApIHsKCgljb25zdCBpbmZsdWVuY2VzTGlzdCA9IHt9OwoJY29uc3QgbW9ycGhJbmZsdWVuY2VzID0gbmV3IEZsb2F0MzJBcnJheSggOCApOwoJY29uc3QgbW9ycGhUZXh0dXJlcyA9IG5ldyBXZWFrTWFwKCk7Cgljb25zdCBtb3JwaCA9IG5ldyBWZWN0b3I0KCk7CgoJY29uc3Qgd29ya0luZmx1ZW5jZXMgPSBbXTsKCglmb3IgKCBsZXQgaSA9IDA7IGkgPCA4OyBpICsrICkgewoKCQl3b3JrSW5mbHVlbmNlc1sgaSBdID0gWyBpLCAwIF07CgoJfQoKCWZ1bmN0aW9uIHVwZGF0ZSggb2JqZWN0LCBnZW9tZXRyeSwgcHJvZ3JhbSApIHsKCgkJY29uc3Qgb2JqZWN0SW5mbHVlbmNlcyA9IG9iamVjdC5tb3JwaFRhcmdldEluZmx1ZW5jZXM7CgoJCWlmICggY2FwYWJpbGl0aWVzLmlzV2ViR0wyID09PSB0cnVlICkgewoKCQkJLy8gaW5zdGVhZCBvZiB1c2luZyBhdHRyaWJ1dGVzLCB0aGUgV2ViR0wgMiBjb2RlIHBhdGggZW5jb2RlcyBtb3JwaCB0YXJnZXRzCgkJCS8vIGludG8gYW4gYXJyYXkgb2YgZGF0YSB0ZXh0dXJlcy4gRWFjaCBsYXllciByZXByZXNlbnRzIGEgc2luZ2xlIG1vcnBoIHRhcmdldC4KCgkJCWNvbnN0IG1vcnBoQXR0cmlidXRlID0gZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzLnBvc2l0aW9uIHx8IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5ub3JtYWwgfHwgZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzLmNvbG9yOwoJCQljb25zdCBtb3JwaFRhcmdldHNDb3VudCA9ICggbW9ycGhBdHRyaWJ1dGUgIT09IHVuZGVmaW5lZCApID8gbW9ycGhBdHRyaWJ1dGUubGVuZ3RoIDogMDsKCgkJCWxldCBlbnRyeSA9IG1vcnBoVGV4dHVyZXMuZ2V0KCBnZW9tZXRyeSApOwoKCQkJaWYgKCBlbnRyeSA9PT0gdW5kZWZpbmVkIHx8IGVudHJ5LmNvdW50ICE9PSBtb3JwaFRhcmdldHNDb3VudCApIHsKCgkJCQlpZiAoIGVudHJ5ICE9PSB1bmRlZmluZWQgKSBlbnRyeS50ZXh0dXJlLmRpc3Bvc2UoKTsKCgkJCQljb25zdCBoYXNNb3JwaFBvc2l0aW9uID0gZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzLnBvc2l0aW9uICE9PSB1bmRlZmluZWQ7CgkJCQljb25zdCBoYXNNb3JwaE5vcm1hbHMgPSBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMubm9ybWFsICE9PSB1bmRlZmluZWQ7CgkJCQljb25zdCBoYXNNb3JwaENvbG9ycyA9IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5jb2xvciAhPT0gdW5kZWZpbmVkOwoKCQkJCWNvbnN0IG1vcnBoVGFyZ2V0cyA9IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5wb3NpdGlvbiB8fCBbXTsKCQkJCWNvbnN0IG1vcnBoTm9ybWFscyA9IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5ub3JtYWwgfHwgW107CgkJCQljb25zdCBtb3JwaENvbG9ycyA9IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5jb2xvciB8fCBbXTsKCgkJCQlsZXQgdmVydGV4RGF0YUNvdW50ID0gMDsKCgkJCQlpZiAoIGhhc01vcnBoUG9zaXRpb24gPT09IHRydWUgKSB2ZXJ0ZXhEYXRhQ291bnQgPSAxOwoJCQkJaWYgKCBoYXNNb3JwaE5vcm1hbHMgPT09IHRydWUgKSB2ZXJ0ZXhEYXRhQ291bnQgPSAyOwoJCQkJaWYgKCBoYXNNb3JwaENvbG9ycyA9PT0gdHJ1ZSApIHZlcnRleERhdGFDb3VudCA9IDM7CgoJCQkJbGV0IHdpZHRoID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5jb3VudCAqIHZlcnRleERhdGFDb3VudDsKCQkJCWxldCBoZWlnaHQgPSAxOwoKCQkJCWlmICggd2lkdGggPiBjYXBhYmlsaXRpZXMubWF4VGV4dHVyZVNpemUgKSB7CgoJCQkJCWhlaWdodCA9IE1hdGguY2VpbCggd2lkdGggLyBjYXBhYmlsaXRpZXMubWF4VGV4dHVyZVNpemUgKTsKCQkJCQl3aWR0aCA9IGNhcGFiaWxpdGllcy5tYXhUZXh0dXJlU2l6ZTsKCgkJCQl9CgoJCQkJY29uc3QgYnVmZmVyID0gbmV3IEZsb2F0MzJBcnJheSggd2lkdGggKiBoZWlnaHQgKiA0ICogbW9ycGhUYXJnZXRzQ291bnQgKTsKCgkJCQljb25zdCB0ZXh0dXJlID0gbmV3IERhdGFBcnJheVRleHR1cmUoIGJ1ZmZlciwgd2lkdGgsIGhlaWdodCwgbW9ycGhUYXJnZXRzQ291bnQgKTsKCQkJCXRleHR1cmUudHlwZSA9IEZsb2F0VHlwZTsKCQkJCXRleHR1cmUubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQkJCS8vIGZpbGwgYnVmZmVyCgoJCQkJY29uc3QgdmVydGV4RGF0YVN0cmlkZSA9IHZlcnRleERhdGFDb3VudCAqIDQ7CgoJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgbW9ycGhUYXJnZXRzQ291bnQ7IGkgKysgKSB7CgoJCQkJCWNvbnN0IG1vcnBoVGFyZ2V0ID0gbW9ycGhUYXJnZXRzWyBpIF07CgkJCQkJY29uc3QgbW9ycGhOb3JtYWwgPSBtb3JwaE5vcm1hbHNbIGkgXTsKCQkJCQljb25zdCBtb3JwaENvbG9yID0gbW9ycGhDb2xvcnNbIGkgXTsKCgkJCQkJY29uc3Qgb2Zmc2V0ID0gd2lkdGggKiBoZWlnaHQgKiA0ICogaTsKCgkJCQkJZm9yICggbGV0IGogPSAwOyBqIDwgbW9ycGhUYXJnZXQuY291bnQ7IGogKysgKSB7CgoJCQkJCQljb25zdCBzdHJpZGUgPSBqICogdmVydGV4RGF0YVN0cmlkZTsKCgkJCQkJCWlmICggaGFzTW9ycGhQb3NpdGlvbiA9PT0gdHJ1ZSApIHsKCgkJCQkJCQltb3JwaC5mcm9tQnVmZmVyQXR0cmlidXRlKCBtb3JwaFRhcmdldCwgaiApOwoKCQkJCQkJCWJ1ZmZlclsgb2Zmc2V0ICsgc3RyaWRlICsgMCBdID0gbW9ycGgueDsKCQkJCQkJCWJ1ZmZlclsgb2Zmc2V0ICsgc3RyaWRlICsgMSBdID0gbW9ycGgueTsKCQkJCQkJCWJ1ZmZlclsgb2Zmc2V0ICsgc3RyaWRlICsgMiBdID0gbW9ycGguejsKCQkJCQkJCWJ1ZmZlclsgb2Zmc2V0ICsgc3RyaWRlICsgMyBdID0gMDsKCgkJCQkJCX0KCgkJCQkJCWlmICggaGFzTW9ycGhOb3JtYWxzID09PSB0cnVlICkgewoKCQkJCQkJCW1vcnBoLmZyb21CdWZmZXJBdHRyaWJ1dGUoIG1vcnBoTm9ybWFsLCBqICk7CgoJCQkJCQkJYnVmZmVyWyBvZmZzZXQgKyBzdHJpZGUgKyA0IF0gPSBtb3JwaC54OwoJCQkJCQkJYnVmZmVyWyBvZmZzZXQgKyBzdHJpZGUgKyA1IF0gPSBtb3JwaC55OwoJCQkJCQkJYnVmZmVyWyBvZmZzZXQgKyBzdHJpZGUgKyA2IF0gPSBtb3JwaC56OwoJCQkJCQkJYnVmZmVyWyBvZmZzZXQgKyBzdHJpZGUgKyA3IF0gPSAwOwoKCQkJCQkJfQoKCQkJCQkJaWYgKCBoYXNNb3JwaENvbG9ycyA9PT0gdHJ1ZSApIHsKCgkJCQkJCQltb3JwaC5mcm9tQnVmZmVyQXR0cmlidXRlKCBtb3JwaENvbG9yLCBqICk7CgoJCQkJCQkJYnVmZmVyWyBvZmZzZXQgKyBzdHJpZGUgKyA4IF0gPSBtb3JwaC54OwoJCQkJCQkJYnVmZmVyWyBvZmZzZXQgKyBzdHJpZGUgKyA5IF0gPSBtb3JwaC55OwoJCQkJCQkJYnVmZmVyWyBvZmZzZXQgKyBzdHJpZGUgKyAxMCBdID0gbW9ycGguejsKCQkJCQkJCWJ1ZmZlclsgb2Zmc2V0ICsgc3RyaWRlICsgMTEgXSA9ICggbW9ycGhDb2xvci5pdGVtU2l6ZSA9PT0gNCApID8gbW9ycGgudyA6IDE7CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQl9CgoJCQkJZW50cnkgPSB7CgkJCQkJY291bnQ6IG1vcnBoVGFyZ2V0c0NvdW50LAoJCQkJCXRleHR1cmU6IHRleHR1cmUsCgkJCQkJc2l6ZTogbmV3IFZlY3RvcjIoIHdpZHRoLCBoZWlnaHQgKQoJCQkJfTsKCgkJCQltb3JwaFRleHR1cmVzLnNldCggZ2VvbWV0cnksIGVudHJ5ICk7CgoJCQkJZnVuY3Rpb24gZGlzcG9zZVRleHR1cmUoKSB7CgoJCQkJCXRleHR1cmUuZGlzcG9zZSgpOwoKCQkJCQltb3JwaFRleHR1cmVzLmRlbGV0ZSggZ2VvbWV0cnkgKTsKCgkJCQkJZ2VvbWV0cnkucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ2Rpc3Bvc2UnLCBkaXNwb3NlVGV4dHVyZSApOwoKCQkJCX0KCgkJCQlnZW9tZXRyeS5hZGRFdmVudExpc3RlbmVyKCAnZGlzcG9zZScsIGRpc3Bvc2VUZXh0dXJlICk7CgoJCQl9CgoJCQkvLwoKCQkJbGV0IG1vcnBoSW5mbHVlbmNlc1N1bSA9IDA7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBvYmplY3RJbmZsdWVuY2VzLmxlbmd0aDsgaSArKyApIHsKCgkJCQltb3JwaEluZmx1ZW5jZXNTdW0gKz0gb2JqZWN0SW5mbHVlbmNlc1sgaSBdOwoKCQkJfQoKCQkJY29uc3QgbW9ycGhCYXNlSW5mbHVlbmNlID0gZ2VvbWV0cnkubW9ycGhUYXJnZXRzUmVsYXRpdmUgPyAxIDogMSAtIG1vcnBoSW5mbHVlbmNlc1N1bTsKCgkJCXByb2dyYW0uZ2V0VW5pZm9ybXMoKS5zZXRWYWx1ZSggZ2wsICdtb3JwaFRhcmdldEJhc2VJbmZsdWVuY2UnLCBtb3JwaEJhc2VJbmZsdWVuY2UgKTsKCQkJcHJvZ3JhbS5nZXRVbmlmb3JtcygpLnNldFZhbHVlKCBnbCwgJ21vcnBoVGFyZ2V0SW5mbHVlbmNlcycsIG9iamVjdEluZmx1ZW5jZXMgKTsKCgkJCXByb2dyYW0uZ2V0VW5pZm9ybXMoKS5zZXRWYWx1ZSggZ2wsICdtb3JwaFRhcmdldHNUZXh0dXJlJywgZW50cnkudGV4dHVyZSwgdGV4dHVyZXMgKTsKCQkJcHJvZ3JhbS5nZXRVbmlmb3JtcygpLnNldFZhbHVlKCBnbCwgJ21vcnBoVGFyZ2V0c1RleHR1cmVTaXplJywgZW50cnkuc2l6ZSApOwoKCgkJfSBlbHNlIHsKCgkJCS8vIFdoZW4gb2JqZWN0IGRvZXNuJ3QgaGF2ZSBtb3JwaCB0YXJnZXQgaW5mbHVlbmNlcyBkZWZpbmVkLCB3ZSB0cmVhdCBpdCBhcyBhIDAtbGVuZ3RoIGFycmF5CgkJCS8vIFRoaXMgaXMgaW1wb3J0YW50IHRvIG1ha2Ugc3VyZSB3ZSBzZXQgdXAgbW9ycGhUYXJnZXRCYXNlSW5mbHVlbmNlIC8gbW9ycGhUYXJnZXRJbmZsdWVuY2VzCgoJCQljb25zdCBsZW5ndGggPSBvYmplY3RJbmZsdWVuY2VzID09PSB1bmRlZmluZWQgPyAwIDogb2JqZWN0SW5mbHVlbmNlcy5sZW5ndGg7CgoJCQlsZXQgaW5mbHVlbmNlcyA9IGluZmx1ZW5jZXNMaXN0WyBnZW9tZXRyeS5pZCBdOwoKCQkJaWYgKCBpbmZsdWVuY2VzID09PSB1bmRlZmluZWQgfHwgaW5mbHVlbmNlcy5sZW5ndGggIT09IGxlbmd0aCApIHsKCgkJCQkvLyBpbml0aWFsaXNlIGxpc3QKCgkJCQlpbmZsdWVuY2VzID0gW107CgoJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpICsrICkgewoKCQkJCQlpbmZsdWVuY2VzWyBpIF0gPSBbIGksIDAgXTsKCgkJCQl9CgoJCQkJaW5mbHVlbmNlc0xpc3RbIGdlb21ldHJ5LmlkIF0gPSBpbmZsdWVuY2VzOwoKCQkJfQoKCQkJLy8gQ29sbGVjdCBpbmZsdWVuY2VzCgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkgKysgKSB7CgoJCQkJY29uc3QgaW5mbHVlbmNlID0gaW5mbHVlbmNlc1sgaSBdOwoKCQkJCWluZmx1ZW5jZVsgMCBdID0gaTsKCQkJCWluZmx1ZW5jZVsgMSBdID0gb2JqZWN0SW5mbHVlbmNlc1sgaSBdOwoKCQkJfQoKCQkJaW5mbHVlbmNlcy5zb3J0KCBhYnNOdW1lcmljYWxTb3J0ICk7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA4OyBpICsrICkgewoKCQkJCWlmICggaSA8IGxlbmd0aCAmJiBpbmZsdWVuY2VzWyBpIF1bIDEgXSApIHsKCgkJCQkJd29ya0luZmx1ZW5jZXNbIGkgXVsgMCBdID0gaW5mbHVlbmNlc1sgaSBdWyAwIF07CgkJCQkJd29ya0luZmx1ZW5jZXNbIGkgXVsgMSBdID0gaW5mbHVlbmNlc1sgaSBdWyAxIF07CgoJCQkJfSBlbHNlIHsKCgkJCQkJd29ya0luZmx1ZW5jZXNbIGkgXVsgMCBdID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVI7CgkJCQkJd29ya0luZmx1ZW5jZXNbIGkgXVsgMSBdID0gMDsKCgkJCQl9CgoJCQl9CgoJCQl3b3JrSW5mbHVlbmNlcy5zb3J0KCBudW1lcmljYWxTb3J0ICk7CgoJCQljb25zdCBtb3JwaFRhcmdldHMgPSBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb247CgkJCWNvbnN0IG1vcnBoTm9ybWFscyA9IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5ub3JtYWw7CgoJCQlsZXQgbW9ycGhJbmZsdWVuY2VzU3VtID0gMDsKCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IDg7IGkgKysgKSB7CgoJCQkJY29uc3QgaW5mbHVlbmNlID0gd29ya0luZmx1ZW5jZXNbIGkgXTsKCQkJCWNvbnN0IGluZGV4ID0gaW5mbHVlbmNlWyAwIF07CgkJCQljb25zdCB2YWx1ZSA9IGluZmx1ZW5jZVsgMSBdOwoKCQkJCWlmICggaW5kZXggIT09IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSICYmIHZhbHVlICkgewoKCQkJCQlpZiAoIG1vcnBoVGFyZ2V0cyAmJiBnZW9tZXRyeS5nZXRBdHRyaWJ1dGUoICdtb3JwaFRhcmdldCcgKyBpICkgIT09IG1vcnBoVGFyZ2V0c1sgaW5kZXggXSApIHsKCgkJCQkJCWdlb21ldHJ5LnNldEF0dHJpYnV0ZSggJ21vcnBoVGFyZ2V0JyArIGksIG1vcnBoVGFyZ2V0c1sgaW5kZXggXSApOwoKCQkJCQl9CgoJCQkJCWlmICggbW9ycGhOb3JtYWxzICYmIGdlb21ldHJ5LmdldEF0dHJpYnV0ZSggJ21vcnBoTm9ybWFsJyArIGkgKSAhPT0gbW9ycGhOb3JtYWxzWyBpbmRleCBdICkgewoKCQkJCQkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAnbW9ycGhOb3JtYWwnICsgaSwgbW9ycGhOb3JtYWxzWyBpbmRleCBdICk7CgoJCQkJCX0KCgkJCQkJbW9ycGhJbmZsdWVuY2VzWyBpIF0gPSB2YWx1ZTsKCQkJCQltb3JwaEluZmx1ZW5jZXNTdW0gKz0gdmFsdWU7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBtb3JwaFRhcmdldHMgJiYgZ2VvbWV0cnkuaGFzQXR0cmlidXRlKCAnbW9ycGhUYXJnZXQnICsgaSApID09PSB0cnVlICkgewoKCQkJCQkJZ2VvbWV0cnkuZGVsZXRlQXR0cmlidXRlKCAnbW9ycGhUYXJnZXQnICsgaSApOwoKCQkJCQl9CgoJCQkJCWlmICggbW9ycGhOb3JtYWxzICYmIGdlb21ldHJ5Lmhhc0F0dHJpYnV0ZSggJ21vcnBoTm9ybWFsJyArIGkgKSA9PT0gdHJ1ZSApIHsKCgkJCQkJCWdlb21ldHJ5LmRlbGV0ZUF0dHJpYnV0ZSggJ21vcnBoTm9ybWFsJyArIGkgKTsKCgkJCQkJfQoKCQkJCQltb3JwaEluZmx1ZW5jZXNbIGkgXSA9IDA7CgoJCQkJfQoKCQkJfQoKCQkJLy8gR0xTTCBzaGFkZXIgdXNlcyBmb3JtdWxhIGJhc2VpbmZsdWVuY2UgKiBiYXNlICsgc3VtKHRhcmdldCAqIGluZmx1ZW5jZSkKCQkJLy8gVGhpcyBhbGxvd3MgdXMgdG8gc3dpdGNoIGJldHdlZW4gYWJzb2x1dGUgbW9ycGhzIGFuZCByZWxhdGl2ZSBtb3JwaHMgd2l0aG91dCBjaGFuZ2luZyBzaGFkZXIgY29kZQoJCQkvLyBXaGVuIGJhc2VpbmZsdWVuY2UgPSAxIC0gc3VtKGluZmx1ZW5jZSksIHRoZSBhYm92ZSBpcyBlcXVpdmFsZW50IHRvIHN1bSgodGFyZ2V0IC0gYmFzZSkgKiBpbmZsdWVuY2UpCgkJCWNvbnN0IG1vcnBoQmFzZUluZmx1ZW5jZSA9IGdlb21ldHJ5Lm1vcnBoVGFyZ2V0c1JlbGF0aXZlID8gMSA6IDEgLSBtb3JwaEluZmx1ZW5jZXNTdW07CgoJCQlwcm9ncmFtLmdldFVuaWZvcm1zKCkuc2V0VmFsdWUoIGdsLCAnbW9ycGhUYXJnZXRCYXNlSW5mbHVlbmNlJywgbW9ycGhCYXNlSW5mbHVlbmNlICk7CgkJCXByb2dyYW0uZ2V0VW5pZm9ybXMoKS5zZXRWYWx1ZSggZ2wsICdtb3JwaFRhcmdldEluZmx1ZW5jZXMnLCBtb3JwaEluZmx1ZW5jZXMgKTsKCgkJfQoKCX0KCglyZXR1cm4gewoKCQl1cGRhdGU6IHVwZGF0ZQoKCX07Cgp9CgpmdW5jdGlvbiBXZWJHTE9iamVjdHMoIGdsLCBnZW9tZXRyaWVzLCBhdHRyaWJ1dGVzLCBpbmZvICkgewoKCWxldCB1cGRhdGVNYXAgPSBuZXcgV2Vha01hcCgpOwoKCWZ1bmN0aW9uIHVwZGF0ZSggb2JqZWN0ICkgewoKCQljb25zdCBmcmFtZSA9IGluZm8ucmVuZGVyLmZyYW1lOwoKCQljb25zdCBnZW9tZXRyeSA9IG9iamVjdC5nZW9tZXRyeTsKCQljb25zdCBidWZmZXJnZW9tZXRyeSA9IGdlb21ldHJpZXMuZ2V0KCBvYmplY3QsIGdlb21ldHJ5ICk7CgoJCS8vIFVwZGF0ZSBvbmNlIHBlciBmcmFtZQoKCQlpZiAoIHVwZGF0ZU1hcC5nZXQoIGJ1ZmZlcmdlb21ldHJ5ICkgIT09IGZyYW1lICkgewoKCQkJZ2VvbWV0cmllcy51cGRhdGUoIGJ1ZmZlcmdlb21ldHJ5ICk7CgoJCQl1cGRhdGVNYXAuc2V0KCBidWZmZXJnZW9tZXRyeSwgZnJhbWUgKTsKCgkJfQoKCQlpZiAoIG9iamVjdC5pc0luc3RhbmNlZE1lc2ggKSB7CgoJCQlpZiAoIG9iamVjdC5oYXNFdmVudExpc3RlbmVyKCAnZGlzcG9zZScsIG9uSW5zdGFuY2VkTWVzaERpc3Bvc2UgKSA9PT0gZmFsc2UgKSB7CgoJCQkJb2JqZWN0LmFkZEV2ZW50TGlzdGVuZXIoICdkaXNwb3NlJywgb25JbnN0YW5jZWRNZXNoRGlzcG9zZSApOwoKCQkJfQoKCQkJaWYgKCB1cGRhdGVNYXAuZ2V0KCBvYmplY3QgKSAhPT0gZnJhbWUgKSB7CgoJCQkJYXR0cmlidXRlcy51cGRhdGUoIG9iamVjdC5pbnN0YW5jZU1hdHJpeCwgZ2wuQVJSQVlfQlVGRkVSICk7CgoJCQkJaWYgKCBvYmplY3QuaW5zdGFuY2VDb2xvciAhPT0gbnVsbCApIHsKCgkJCQkJYXR0cmlidXRlcy51cGRhdGUoIG9iamVjdC5pbnN0YW5jZUNvbG9yLCBnbC5BUlJBWV9CVUZGRVIgKTsKCgkJCQl9CgoJCQkJdXBkYXRlTWFwLnNldCggb2JqZWN0LCBmcmFtZSApOwoKCQkJfQoKCQl9CgoJCWlmICggb2JqZWN0LmlzU2tpbm5lZE1lc2ggKSB7CgoJCQljb25zdCBza2VsZXRvbiA9IG9iamVjdC5za2VsZXRvbjsKCgkJCWlmICggdXBkYXRlTWFwLmdldCggc2tlbGV0b24gKSAhPT0gZnJhbWUgKSB7CgoJCQkJc2tlbGV0b24udXBkYXRlKCk7CgoJCQkJdXBkYXRlTWFwLnNldCggc2tlbGV0b24sIGZyYW1lICk7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIGJ1ZmZlcmdlb21ldHJ5OwoKCX0KCglmdW5jdGlvbiBkaXNwb3NlKCkgewoKCQl1cGRhdGVNYXAgPSBuZXcgV2Vha01hcCgpOwoKCX0KCglmdW5jdGlvbiBvbkluc3RhbmNlZE1lc2hEaXNwb3NlKCBldmVudCApIHsKCgkJY29uc3QgaW5zdGFuY2VkTWVzaCA9IGV2ZW50LnRhcmdldDsKCgkJaW5zdGFuY2VkTWVzaC5yZW1vdmVFdmVudExpc3RlbmVyKCAnZGlzcG9zZScsIG9uSW5zdGFuY2VkTWVzaERpc3Bvc2UgKTsKCgkJYXR0cmlidXRlcy5yZW1vdmUoIGluc3RhbmNlZE1lc2guaW5zdGFuY2VNYXRyaXggKTsKCgkJaWYgKCBpbnN0YW5jZWRNZXNoLmluc3RhbmNlQ29sb3IgIT09IG51bGwgKSBhdHRyaWJ1dGVzLnJlbW92ZSggaW5zdGFuY2VkTWVzaC5pbnN0YW5jZUNvbG9yICk7CgoJfQoKCXJldHVybiB7CgoJCXVwZGF0ZTogdXBkYXRlLAoJCWRpc3Bvc2U6IGRpc3Bvc2UKCgl9OwoKfQoKY2xhc3MgRGVwdGhUZXh0dXJlIGV4dGVuZHMgVGV4dHVyZSB7CgoJY29uc3RydWN0b3IoIHdpZHRoLCBoZWlnaHQsIHR5cGUsIG1hcHBpbmcsIHdyYXBTLCB3cmFwVCwgbWFnRmlsdGVyLCBtaW5GaWx0ZXIsIGFuaXNvdHJvcHksIGZvcm1hdCApIHsKCgkJZm9ybWF0ID0gZm9ybWF0ICE9PSB1bmRlZmluZWQgPyBmb3JtYXQgOiBEZXB0aEZvcm1hdDsKCgkJaWYgKCBmb3JtYXQgIT09IERlcHRoRm9ybWF0ICYmIGZvcm1hdCAhPT0gRGVwdGhTdGVuY2lsRm9ybWF0ICkgewoKCQkJdGhyb3cgbmV3IEVycm9yKCAnRGVwdGhUZXh0dXJlIGZvcm1hdCBtdXN0IGJlIGVpdGhlciBUSFJFRS5EZXB0aEZvcm1hdCBvciBUSFJFRS5EZXB0aFN0ZW5jaWxGb3JtYXQnICk7CgoJCX0KCgkJaWYgKCB0eXBlID09PSB1bmRlZmluZWQgJiYgZm9ybWF0ID09PSBEZXB0aEZvcm1hdCApIHR5cGUgPSBVbnNpZ25lZEludFR5cGU7CgkJaWYgKCB0eXBlID09PSB1bmRlZmluZWQgJiYgZm9ybWF0ID09PSBEZXB0aFN0ZW5jaWxGb3JtYXQgKSB0eXBlID0gVW5zaWduZWRJbnQyNDhUeXBlOwoKCQlzdXBlciggbnVsbCwgbWFwcGluZywgd3JhcFMsIHdyYXBULCBtYWdGaWx0ZXIsIG1pbkZpbHRlciwgZm9ybWF0LCB0eXBlLCBhbmlzb3Ryb3B5ICk7CgoJCXRoaXMuaXNEZXB0aFRleHR1cmUgPSB0cnVlOwoKCQl0aGlzLmltYWdlID0geyB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0IH07CgoJCXRoaXMubWFnRmlsdGVyID0gbWFnRmlsdGVyICE9PSB1bmRlZmluZWQgPyBtYWdGaWx0ZXIgOiBOZWFyZXN0RmlsdGVyOwoJCXRoaXMubWluRmlsdGVyID0gbWluRmlsdGVyICE9PSB1bmRlZmluZWQgPyBtaW5GaWx0ZXIgOiBOZWFyZXN0RmlsdGVyOwoKCQl0aGlzLmZsaXBZID0gZmFsc2U7CgkJdGhpcy5nZW5lcmF0ZU1pcG1hcHMgPSBmYWxzZTsKCgkJdGhpcy5jb21wYXJlRnVuY3Rpb24gPSBudWxsOwoKCX0KCgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5jb21wYXJlRnVuY3Rpb24gPSBzb3VyY2UuY29tcGFyZUZ1bmN0aW9uOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCBtZXRhICkgewoKCQljb25zdCBkYXRhID0gc3VwZXIudG9KU09OKCBtZXRhICk7CgoJCWlmICggdGhpcy5jb21wYXJlRnVuY3Rpb24gIT09IG51bGwgKSBkYXRhLmNvbXBhcmVGdW5jdGlvbiA9IHRoaXMuY29tcGFyZUZ1bmN0aW9uOwoKCQlyZXR1cm4gZGF0YTsKCgl9Cgp9CgovKioKICogVW5pZm9ybXMgb2YgYSBwcm9ncmFtLgogKiBUaG9zZSBmb3JtIGEgdHJlZSBzdHJ1Y3R1cmUgd2l0aCBhIHNwZWNpYWwgdG9wLWxldmVsIGNvbnRhaW5lciBmb3IgdGhlIHJvb3QsCiAqIHdoaWNoIHlvdSBnZXQgYnkgY2FsbGluZyAnbmV3IFdlYkdMVW5pZm9ybXMoIGdsLCBwcm9ncmFtICknLgogKgogKgogKiBQcm9wZXJ0aWVzIG9mIGlubmVyIG5vZGVzIGluY2x1ZGluZyB0aGUgdG9wLWxldmVsIGNvbnRhaW5lcjoKICoKICogLnNlcSAtIGFycmF5IG9mIG5lc3RlZCB1bmlmb3JtcwogKiAubWFwIC0gbmVzdGVkIHVuaWZvcm1zIGJ5IG5hbWUKICoKICoKICogTWV0aG9kcyBvZiBhbGwgbm9kZXMgZXhjZXB0IHRoZSB0b3AtbGV2ZWwgY29udGFpbmVyOgogKgogKiAuc2V0VmFsdWUoIGdsLCB2YWx1ZSwgW3RleHR1cmVzXSApCiAqCiAqIAkJdXBsb2FkcyBhIHVuaWZvcm0gdmFsdWUocykKICogIAl0aGUgJ3RleHR1cmVzJyBwYXJhbWV0ZXIgaXMgbmVlZGVkIGZvciBzYW1wbGVyIHVuaWZvcm1zCiAqCiAqCiAqIFN0YXRpYyBtZXRob2RzIG9mIHRoZSB0b3AtbGV2ZWwgY29udGFpbmVyICh0ZXh0dXJlcyBmYWN0b3JpemF0aW9ucyk6CiAqCiAqIC51cGxvYWQoIGdsLCBzZXEsIHZhbHVlcywgdGV4dHVyZXMgKQogKgogKiAJCXNldHMgdW5pZm9ybXMgaW4gJ3NlcScgdG8gJ3ZhbHVlc1tpZF0udmFsdWUnCiAqCiAqIC5zZXFXaXRoVmFsdWUoIHNlcSwgdmFsdWVzICkgOiBmaWx0ZXJlZFNlcQogKgogKiAJCWZpbHRlcnMgJ3NlcScgZW50cmllcyB3aXRoIGNvcnJlc3BvbmRpbmcgZW50cnkgaW4gdmFsdWVzCiAqCiAqCiAqIE1ldGhvZHMgb2YgdGhlIHRvcC1sZXZlbCBjb250YWluZXIgKHRleHR1cmVzIGZhY3Rvcml6YXRpb25zKToKICoKICogLnNldFZhbHVlKCBnbCwgbmFtZSwgdmFsdWUsIHRleHR1cmVzICkKICoKICogCQlzZXRzIHVuaWZvcm0gd2l0aCAgbmFtZSAnbmFtZScgdG8gJ3ZhbHVlJwogKgogKiAuc2V0T3B0aW9uYWwoIGdsLCBvYmosIHByb3AgKQogKgogKiAJCWxpa2UgLnNldCBmb3IgYW4gb3B0aW9uYWwgcHJvcGVydHkgb2YgdGhlIG9iamVjdAogKgogKi8KCgpjb25zdCBlbXB0eVRleHR1cmUgPSAvKkBfX1BVUkVfXyovIG5ldyBUZXh0dXJlKCk7Cgpjb25zdCBlbXB0eVNoYWRvd1RleHR1cmUgPSAvKkBfX1BVUkVfXyovIG5ldyBEZXB0aFRleHR1cmUoIDEsIDEgKTsKZW1wdHlTaGFkb3dUZXh0dXJlLmNvbXBhcmVGdW5jdGlvbiA9IExlc3NFcXVhbENvbXBhcmU7Cgpjb25zdCBlbXB0eUFycmF5VGV4dHVyZSA9IC8qQF9fUFVSRV9fKi8gbmV3IERhdGFBcnJheVRleHR1cmUoKTsKY29uc3QgZW1wdHkzZFRleHR1cmUgPSAvKkBfX1BVUkVfXyovIG5ldyBEYXRhM0RUZXh0dXJlKCk7CmNvbnN0IGVtcHR5Q3ViZVRleHR1cmUgPSAvKkBfX1BVUkVfXyovIG5ldyBDdWJlVGV4dHVyZSgpOwoKLy8gLS0tIFV0aWxpdGllcyAtLS0KCi8vIEFycmF5IENhY2hlcyAocHJvdmlkZSB0eXBlZCBhcnJheXMgZm9yIHRlbXBvcmFyeSBieSBzaXplKQoKY29uc3QgYXJyYXlDYWNoZUYzMiA9IFtdOwpjb25zdCBhcnJheUNhY2hlSTMyID0gW107CgovLyBGbG9hdDMyQXJyYXkgY2FjaGVzIHVzZWQgZm9yIHVwbG9hZGluZyBNYXRyaXggdW5pZm9ybXMKCmNvbnN0IG1hdDRhcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoIDE2ICk7CmNvbnN0IG1hdDNhcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoIDkgKTsKY29uc3QgbWF0MmFycmF5ID0gbmV3IEZsb2F0MzJBcnJheSggNCApOwoKLy8gRmxhdHRlbmluZyBmb3IgYXJyYXlzIG9mIHZlY3RvcnMgYW5kIG1hdHJpY2VzCgpmdW5jdGlvbiBmbGF0dGVuKCBhcnJheSwgbkJsb2NrcywgYmxvY2tTaXplICkgewoKCWNvbnN0IGZpcnN0RWxlbSA9IGFycmF5WyAwIF07CgoJaWYgKCBmaXJzdEVsZW0gPD0gMCB8fCBmaXJzdEVsZW0gPiAwICkgcmV0dXJuIGFycmF5OwoJLy8gdW5vcHRpbWl6ZWQ6ICEgaXNOYU4oIGZpcnN0RWxlbSApCgkvLyBzZWUgaHR0cDovL2phY2tzb25kdW5zdGFuLmNvbS9hcnRpY2xlcy85ODMKCgljb25zdCBuID0gbkJsb2NrcyAqIGJsb2NrU2l6ZTsKCWxldCByID0gYXJyYXlDYWNoZUYzMlsgbiBdOwoKCWlmICggciA9PT0gdW5kZWZpbmVkICkgewoKCQlyID0gbmV3IEZsb2F0MzJBcnJheSggbiApOwoJCWFycmF5Q2FjaGVGMzJbIG4gXSA9IHI7CgoJfQoKCWlmICggbkJsb2NrcyAhPT0gMCApIHsKCgkJZmlyc3RFbGVtLnRvQXJyYXkoIHIsIDAgKTsKCgkJZm9yICggbGV0IGkgPSAxLCBvZmZzZXQgPSAwOyBpICE9PSBuQmxvY2tzOyArKyBpICkgewoKCQkJb2Zmc2V0ICs9IGJsb2NrU2l6ZTsKCQkJYXJyYXlbIGkgXS50b0FycmF5KCByLCBvZmZzZXQgKTsKCgkJfQoKCX0KCglyZXR1cm4gcjsKCn0KCmZ1bmN0aW9uIGFycmF5c0VxdWFsKCBhLCBiICkgewoKCWlmICggYS5sZW5ndGggIT09IGIubGVuZ3RoICkgcmV0dXJuIGZhbHNlOwoKCWZvciAoIGxldCBpID0gMCwgbCA9IGEubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJaWYgKCBhWyBpIF0gIT09IGJbIGkgXSApIHJldHVybiBmYWxzZTsKCgl9CgoJcmV0dXJuIHRydWU7Cgp9CgpmdW5jdGlvbiBjb3B5QXJyYXkoIGEsIGIgKSB7CgoJZm9yICggbGV0IGkgPSAwLCBsID0gYi5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQlhWyBpIF0gPSBiWyBpIF07CgoJfQoKfQoKLy8gVGV4dHVyZSB1bml0IGFsbG9jYXRpb24KCmZ1bmN0aW9uIGFsbG9jVGV4VW5pdHMoIHRleHR1cmVzLCBuICkgewoKCWxldCByID0gYXJyYXlDYWNoZUkzMlsgbiBdOwoKCWlmICggciA9PT0gdW5kZWZpbmVkICkgewoKCQlyID0gbmV3IEludDMyQXJyYXkoIG4gKTsKCQlhcnJheUNhY2hlSTMyWyBuIF0gPSByOwoKCX0KCglmb3IgKCBsZXQgaSA9IDA7IGkgIT09IG47ICsrIGkgKSB7CgoJCXJbIGkgXSA9IHRleHR1cmVzLmFsbG9jYXRlVGV4dHVyZVVuaXQoKTsKCgl9CgoJcmV0dXJuIHI7Cgp9CgovLyAtLS0gU2V0dGVycyAtLS0KCi8vIE5vdGU6IERlZmluaW5nIHRoZXNlIG1ldGhvZHMgZXh0ZXJuYWxseSwgYmVjYXVzZSB0aGV5IGNvbWUgaW4gYSBidW5jaAovLyBhbmQgdGhpcyB3YXkgdGhlaXIgbmFtZXMgbWluaWZ5LgoKLy8gU2luZ2xlIHNjYWxhcgoKZnVuY3Rpb24gc2V0VmFsdWVWMWYoIGdsLCB2ICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCglpZiAoIGNhY2hlWyAwIF0gPT09IHYgKSByZXR1cm47CgoJZ2wudW5pZm9ybTFmKCB0aGlzLmFkZHIsIHYgKTsKCgljYWNoZVsgMCBdID0gdjsKCn0KCi8vIFNpbmdsZSBmbG9hdCB2ZWN0b3IgKGZyb20gZmxhdCBhcnJheSBvciBUSFJFRS5WZWN0b3JOKQoKZnVuY3Rpb24gc2V0VmFsdWVWMmYoIGdsLCB2ICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCglpZiAoIHYueCAhPT0gdW5kZWZpbmVkICkgewoKCQlpZiAoIGNhY2hlWyAwIF0gIT09IHYueCB8fCBjYWNoZVsgMSBdICE9PSB2LnkgKSB7CgoJCQlnbC51bmlmb3JtMmYoIHRoaXMuYWRkciwgdi54LCB2LnkgKTsKCgkJCWNhY2hlWyAwIF0gPSB2Lng7CgkJCWNhY2hlWyAxIF0gPSB2Lnk7CgoJCX0KCgl9IGVsc2UgewoKCQlpZiAoIGFycmF5c0VxdWFsKCBjYWNoZSwgdiApICkgcmV0dXJuOwoKCQlnbC51bmlmb3JtMmZ2KCB0aGlzLmFkZHIsIHYgKTsKCgkJY29weUFycmF5KCBjYWNoZSwgdiApOwoKCX0KCn0KCmZ1bmN0aW9uIHNldFZhbHVlVjNmKCBnbCwgdiApIHsKCgljb25zdCBjYWNoZSA9IHRoaXMuY2FjaGU7CgoJaWYgKCB2LnggIT09IHVuZGVmaW5lZCApIHsKCgkJaWYgKCBjYWNoZVsgMCBdICE9PSB2LnggfHwgY2FjaGVbIDEgXSAhPT0gdi55IHx8IGNhY2hlWyAyIF0gIT09IHYueiApIHsKCgkJCWdsLnVuaWZvcm0zZiggdGhpcy5hZGRyLCB2LngsIHYueSwgdi56ICk7CgoJCQljYWNoZVsgMCBdID0gdi54OwoJCQljYWNoZVsgMSBdID0gdi55OwoJCQljYWNoZVsgMiBdID0gdi56OwoKCQl9CgoJfSBlbHNlIGlmICggdi5yICE9PSB1bmRlZmluZWQgKSB7CgoJCWlmICggY2FjaGVbIDAgXSAhPT0gdi5yIHx8IGNhY2hlWyAxIF0gIT09IHYuZyB8fCBjYWNoZVsgMiBdICE9PSB2LmIgKSB7CgoJCQlnbC51bmlmb3JtM2YoIHRoaXMuYWRkciwgdi5yLCB2LmcsIHYuYiApOwoKCQkJY2FjaGVbIDAgXSA9IHYucjsKCQkJY2FjaGVbIDEgXSA9IHYuZzsKCQkJY2FjaGVbIDIgXSA9IHYuYjsKCgkJfQoKCX0gZWxzZSB7CgoJCWlmICggYXJyYXlzRXF1YWwoIGNhY2hlLCB2ICkgKSByZXR1cm47CgoJCWdsLnVuaWZvcm0zZnYoIHRoaXMuYWRkciwgdiApOwoKCQljb3B5QXJyYXkoIGNhY2hlLCB2ICk7CgoJfQoKfQoKZnVuY3Rpb24gc2V0VmFsdWVWNGYoIGdsLCB2ICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCglpZiAoIHYueCAhPT0gdW5kZWZpbmVkICkgewoKCQlpZiAoIGNhY2hlWyAwIF0gIT09IHYueCB8fCBjYWNoZVsgMSBdICE9PSB2LnkgfHwgY2FjaGVbIDIgXSAhPT0gdi56IHx8IGNhY2hlWyAzIF0gIT09IHYudyApIHsKCgkJCWdsLnVuaWZvcm00ZiggdGhpcy5hZGRyLCB2LngsIHYueSwgdi56LCB2LncgKTsKCgkJCWNhY2hlWyAwIF0gPSB2Lng7CgkJCWNhY2hlWyAxIF0gPSB2Lnk7CgkJCWNhY2hlWyAyIF0gPSB2Lno7CgkJCWNhY2hlWyAzIF0gPSB2Lnc7CgoJCX0KCgl9IGVsc2UgewoKCQlpZiAoIGFycmF5c0VxdWFsKCBjYWNoZSwgdiApICkgcmV0dXJuOwoKCQlnbC51bmlmb3JtNGZ2KCB0aGlzLmFkZHIsIHYgKTsKCgkJY29weUFycmF5KCBjYWNoZSwgdiApOwoKCX0KCn0KCi8vIFNpbmdsZSBtYXRyaXggKGZyb20gZmxhdCBhcnJheSBvciBUSFJFRS5NYXRyaXhOKQoKZnVuY3Rpb24gc2V0VmFsdWVNMiggZ2wsIHYgKSB7CgoJY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlOwoJY29uc3QgZWxlbWVudHMgPSB2LmVsZW1lbnRzOwoKCWlmICggZWxlbWVudHMgPT09IHVuZGVmaW5lZCApIHsKCgkJaWYgKCBhcnJheXNFcXVhbCggY2FjaGUsIHYgKSApIHJldHVybjsKCgkJZ2wudW5pZm9ybU1hdHJpeDJmdiggdGhpcy5hZGRyLCBmYWxzZSwgdiApOwoKCQljb3B5QXJyYXkoIGNhY2hlLCB2ICk7CgoJfSBlbHNlIHsKCgkJaWYgKCBhcnJheXNFcXVhbCggY2FjaGUsIGVsZW1lbnRzICkgKSByZXR1cm47CgoJCW1hdDJhcnJheS5zZXQoIGVsZW1lbnRzICk7CgoJCWdsLnVuaWZvcm1NYXRyaXgyZnYoIHRoaXMuYWRkciwgZmFsc2UsIG1hdDJhcnJheSApOwoKCQljb3B5QXJyYXkoIGNhY2hlLCBlbGVtZW50cyApOwoKCX0KCn0KCmZ1bmN0aW9uIHNldFZhbHVlTTMoIGdsLCB2ICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCWNvbnN0IGVsZW1lbnRzID0gdi5lbGVtZW50czsKCglpZiAoIGVsZW1lbnRzID09PSB1bmRlZmluZWQgKSB7CgoJCWlmICggYXJyYXlzRXF1YWwoIGNhY2hlLCB2ICkgKSByZXR1cm47CgoJCWdsLnVuaWZvcm1NYXRyaXgzZnYoIHRoaXMuYWRkciwgZmFsc2UsIHYgKTsKCgkJY29weUFycmF5KCBjYWNoZSwgdiApOwoKCX0gZWxzZSB7CgoJCWlmICggYXJyYXlzRXF1YWwoIGNhY2hlLCBlbGVtZW50cyApICkgcmV0dXJuOwoKCQltYXQzYXJyYXkuc2V0KCBlbGVtZW50cyApOwoKCQlnbC51bmlmb3JtTWF0cml4M2Z2KCB0aGlzLmFkZHIsIGZhbHNlLCBtYXQzYXJyYXkgKTsKCgkJY29weUFycmF5KCBjYWNoZSwgZWxlbWVudHMgKTsKCgl9Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZU00KCBnbCwgdiApIHsKCgljb25zdCBjYWNoZSA9IHRoaXMuY2FjaGU7Cgljb25zdCBlbGVtZW50cyA9IHYuZWxlbWVudHM7CgoJaWYgKCBlbGVtZW50cyA9PT0gdW5kZWZpbmVkICkgewoKCQlpZiAoIGFycmF5c0VxdWFsKCBjYWNoZSwgdiApICkgcmV0dXJuOwoKCQlnbC51bmlmb3JtTWF0cml4NGZ2KCB0aGlzLmFkZHIsIGZhbHNlLCB2ICk7CgoJCWNvcHlBcnJheSggY2FjaGUsIHYgKTsKCgl9IGVsc2UgewoKCQlpZiAoIGFycmF5c0VxdWFsKCBjYWNoZSwgZWxlbWVudHMgKSApIHJldHVybjsKCgkJbWF0NGFycmF5LnNldCggZWxlbWVudHMgKTsKCgkJZ2wudW5pZm9ybU1hdHJpeDRmdiggdGhpcy5hZGRyLCBmYWxzZSwgbWF0NGFycmF5ICk7CgoJCWNvcHlBcnJheSggY2FjaGUsIGVsZW1lbnRzICk7CgoJfQoKfQoKLy8gU2luZ2xlIGludGVnZXIgLyBib29sZWFuCgpmdW5jdGlvbiBzZXRWYWx1ZVYxaSggZ2wsIHYgKSB7CgoJY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlOwoKCWlmICggY2FjaGVbIDAgXSA9PT0gdiApIHJldHVybjsKCglnbC51bmlmb3JtMWkoIHRoaXMuYWRkciwgdiApOwoKCWNhY2hlWyAwIF0gPSB2OwoKfQoKLy8gU2luZ2xlIGludGVnZXIgLyBib29sZWFuIHZlY3RvciAoZnJvbSBmbGF0IGFycmF5IG9yIFRIUkVFLlZlY3Rvck4pCgpmdW5jdGlvbiBzZXRWYWx1ZVYyaSggZ2wsIHYgKSB7CgoJY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlOwoKCWlmICggdi54ICE9PSB1bmRlZmluZWQgKSB7CgoJCWlmICggY2FjaGVbIDAgXSAhPT0gdi54IHx8IGNhY2hlWyAxIF0gIT09IHYueSApIHsKCgkJCWdsLnVuaWZvcm0yaSggdGhpcy5hZGRyLCB2LngsIHYueSApOwoKCQkJY2FjaGVbIDAgXSA9IHYueDsKCQkJY2FjaGVbIDEgXSA9IHYueTsKCgkJfQoKCX0gZWxzZSB7CgoJCWlmICggYXJyYXlzRXF1YWwoIGNhY2hlLCB2ICkgKSByZXR1cm47CgoJCWdsLnVuaWZvcm0yaXYoIHRoaXMuYWRkciwgdiApOwoKCQljb3B5QXJyYXkoIGNhY2hlLCB2ICk7CgoJfQoKfQoKZnVuY3Rpb24gc2V0VmFsdWVWM2koIGdsLCB2ICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCglpZiAoIHYueCAhPT0gdW5kZWZpbmVkICkgewoKCQlpZiAoIGNhY2hlWyAwIF0gIT09IHYueCB8fCBjYWNoZVsgMSBdICE9PSB2LnkgfHwgY2FjaGVbIDIgXSAhPT0gdi56ICkgewoKCQkJZ2wudW5pZm9ybTNpKCB0aGlzLmFkZHIsIHYueCwgdi55LCB2LnogKTsKCgkJCWNhY2hlWyAwIF0gPSB2Lng7CgkJCWNhY2hlWyAxIF0gPSB2Lnk7CgkJCWNhY2hlWyAyIF0gPSB2Lno7CgoJCX0KCgl9IGVsc2UgewoKCQlpZiAoIGFycmF5c0VxdWFsKCBjYWNoZSwgdiApICkgcmV0dXJuOwoKCQlnbC51bmlmb3JtM2l2KCB0aGlzLmFkZHIsIHYgKTsKCgkJY29weUFycmF5KCBjYWNoZSwgdiApOwoKCX0KCn0KCmZ1bmN0aW9uIHNldFZhbHVlVjRpKCBnbCwgdiApIHsKCgljb25zdCBjYWNoZSA9IHRoaXMuY2FjaGU7CgoJaWYgKCB2LnggIT09IHVuZGVmaW5lZCApIHsKCgkJaWYgKCBjYWNoZVsgMCBdICE9PSB2LnggfHwgY2FjaGVbIDEgXSAhPT0gdi55IHx8IGNhY2hlWyAyIF0gIT09IHYueiB8fCBjYWNoZVsgMyBdICE9PSB2LncgKSB7CgoJCQlnbC51bmlmb3JtNGkoIHRoaXMuYWRkciwgdi54LCB2LnksIHYueiwgdi53ICk7CgoJCQljYWNoZVsgMCBdID0gdi54OwoJCQljYWNoZVsgMSBdID0gdi55OwoJCQljYWNoZVsgMiBdID0gdi56OwoJCQljYWNoZVsgMyBdID0gdi53OwoKCQl9CgoJfSBlbHNlIHsKCgkJaWYgKCBhcnJheXNFcXVhbCggY2FjaGUsIHYgKSApIHJldHVybjsKCgkJZ2wudW5pZm9ybTRpdiggdGhpcy5hZGRyLCB2ICk7CgoJCWNvcHlBcnJheSggY2FjaGUsIHYgKTsKCgl9Cgp9CgovLyBTaW5nbGUgdW5zaWduZWQgaW50ZWdlcgoKZnVuY3Rpb24gc2V0VmFsdWVWMXVpKCBnbCwgdiApIHsKCgljb25zdCBjYWNoZSA9IHRoaXMuY2FjaGU7CgoJaWYgKCBjYWNoZVsgMCBdID09PSB2ICkgcmV0dXJuOwoKCWdsLnVuaWZvcm0xdWkoIHRoaXMuYWRkciwgdiApOwoKCWNhY2hlWyAwIF0gPSB2OwoKfQoKLy8gU2luZ2xlIHVuc2lnbmVkIGludGVnZXIgdmVjdG9yIChmcm9tIGZsYXQgYXJyYXkgb3IgVEhSRUUuVmVjdG9yTikKCmZ1bmN0aW9uIHNldFZhbHVlVjJ1aSggZ2wsIHYgKSB7CgoJY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlOwoKCWlmICggdi54ICE9PSB1bmRlZmluZWQgKSB7CgoJCWlmICggY2FjaGVbIDAgXSAhPT0gdi54IHx8IGNhY2hlWyAxIF0gIT09IHYueSApIHsKCgkJCWdsLnVuaWZvcm0ydWkoIHRoaXMuYWRkciwgdi54LCB2LnkgKTsKCgkJCWNhY2hlWyAwIF0gPSB2Lng7CgkJCWNhY2hlWyAxIF0gPSB2Lnk7CgoJCX0KCgl9IGVsc2UgewoKCQlpZiAoIGFycmF5c0VxdWFsKCBjYWNoZSwgdiApICkgcmV0dXJuOwoKCQlnbC51bmlmb3JtMnVpdiggdGhpcy5hZGRyLCB2ICk7CgoJCWNvcHlBcnJheSggY2FjaGUsIHYgKTsKCgl9Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZVYzdWkoIGdsLCB2ICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCglpZiAoIHYueCAhPT0gdW5kZWZpbmVkICkgewoKCQlpZiAoIGNhY2hlWyAwIF0gIT09IHYueCB8fCBjYWNoZVsgMSBdICE9PSB2LnkgfHwgY2FjaGVbIDIgXSAhPT0gdi56ICkgewoKCQkJZ2wudW5pZm9ybTN1aSggdGhpcy5hZGRyLCB2LngsIHYueSwgdi56ICk7CgoJCQljYWNoZVsgMCBdID0gdi54OwoJCQljYWNoZVsgMSBdID0gdi55OwoJCQljYWNoZVsgMiBdID0gdi56OwoKCQl9CgoJfSBlbHNlIHsKCgkJaWYgKCBhcnJheXNFcXVhbCggY2FjaGUsIHYgKSApIHJldHVybjsKCgkJZ2wudW5pZm9ybTN1aXYoIHRoaXMuYWRkciwgdiApOwoKCQljb3B5QXJyYXkoIGNhY2hlLCB2ICk7CgoJfQoKfQoKZnVuY3Rpb24gc2V0VmFsdWVWNHVpKCBnbCwgdiApIHsKCgljb25zdCBjYWNoZSA9IHRoaXMuY2FjaGU7CgoJaWYgKCB2LnggIT09IHVuZGVmaW5lZCApIHsKCgkJaWYgKCBjYWNoZVsgMCBdICE9PSB2LnggfHwgY2FjaGVbIDEgXSAhPT0gdi55IHx8IGNhY2hlWyAyIF0gIT09IHYueiB8fCBjYWNoZVsgMyBdICE9PSB2LncgKSB7CgoJCQlnbC51bmlmb3JtNHVpKCB0aGlzLmFkZHIsIHYueCwgdi55LCB2LnosIHYudyApOwoKCQkJY2FjaGVbIDAgXSA9IHYueDsKCQkJY2FjaGVbIDEgXSA9IHYueTsKCQkJY2FjaGVbIDIgXSA9IHYuejsKCQkJY2FjaGVbIDMgXSA9IHYudzsKCgkJfQoKCX0gZWxzZSB7CgoJCWlmICggYXJyYXlzRXF1YWwoIGNhY2hlLCB2ICkgKSByZXR1cm47CgoJCWdsLnVuaWZvcm00dWl2KCB0aGlzLmFkZHIsIHYgKTsKCgkJY29weUFycmF5KCBjYWNoZSwgdiApOwoKCX0KCn0KCgovLyBTaW5nbGUgdGV4dHVyZSAoMkQgLyBDdWJlKQoKZnVuY3Rpb24gc2V0VmFsdWVUMSggZ2wsIHYsIHRleHR1cmVzICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCWNvbnN0IHVuaXQgPSB0ZXh0dXJlcy5hbGxvY2F0ZVRleHR1cmVVbml0KCk7CgoJaWYgKCBjYWNoZVsgMCBdICE9PSB1bml0ICkgewoKCQlnbC51bmlmb3JtMWkoIHRoaXMuYWRkciwgdW5pdCApOwoJCWNhY2hlWyAwIF0gPSB1bml0OwoKCX0KCgljb25zdCBlbXB0eVRleHR1cmUyRCA9ICggdGhpcy50eXBlID09PSBnbC5TQU1QTEVSXzJEX1NIQURPVyApID8gZW1wdHlTaGFkb3dUZXh0dXJlIDogZW1wdHlUZXh0dXJlOwoKCXRleHR1cmVzLnNldFRleHR1cmUyRCggdiB8fCBlbXB0eVRleHR1cmUyRCwgdW5pdCApOwoKfQoKZnVuY3Rpb24gc2V0VmFsdWVUM0QxKCBnbCwgdiwgdGV4dHVyZXMgKSB7CgoJY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlOwoJY29uc3QgdW5pdCA9IHRleHR1cmVzLmFsbG9jYXRlVGV4dHVyZVVuaXQoKTsKCglpZiAoIGNhY2hlWyAwIF0gIT09IHVuaXQgKSB7CgoJCWdsLnVuaWZvcm0xaSggdGhpcy5hZGRyLCB1bml0ICk7CgkJY2FjaGVbIDAgXSA9IHVuaXQ7CgoJfQoKCXRleHR1cmVzLnNldFRleHR1cmUzRCggdiB8fCBlbXB0eTNkVGV4dHVyZSwgdW5pdCApOwoKfQoKZnVuY3Rpb24gc2V0VmFsdWVUNiggZ2wsIHYsIHRleHR1cmVzICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCWNvbnN0IHVuaXQgPSB0ZXh0dXJlcy5hbGxvY2F0ZVRleHR1cmVVbml0KCk7CgoJaWYgKCBjYWNoZVsgMCBdICE9PSB1bml0ICkgewoKCQlnbC51bmlmb3JtMWkoIHRoaXMuYWRkciwgdW5pdCApOwoJCWNhY2hlWyAwIF0gPSB1bml0OwoKCX0KCgl0ZXh0dXJlcy5zZXRUZXh0dXJlQ3ViZSggdiB8fCBlbXB0eUN1YmVUZXh0dXJlLCB1bml0ICk7Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZVQyREFycmF5MSggZ2wsIHYsIHRleHR1cmVzICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCWNvbnN0IHVuaXQgPSB0ZXh0dXJlcy5hbGxvY2F0ZVRleHR1cmVVbml0KCk7CgoJaWYgKCBjYWNoZVsgMCBdICE9PSB1bml0ICkgewoKCQlnbC51bmlmb3JtMWkoIHRoaXMuYWRkciwgdW5pdCApOwoJCWNhY2hlWyAwIF0gPSB1bml0OwoKCX0KCgl0ZXh0dXJlcy5zZXRUZXh0dXJlMkRBcnJheSggdiB8fCBlbXB0eUFycmF5VGV4dHVyZSwgdW5pdCApOwoKfQoKLy8gSGVscGVyIHRvIHBpY2sgdGhlIHJpZ2h0IHNldHRlciBmb3IgdGhlIHNpbmd1bGFyIGNhc2UKCmZ1bmN0aW9uIGdldFNpbmd1bGFyU2V0dGVyKCB0eXBlICkgewoKCXN3aXRjaCAoIHR5cGUgKSB7CgoJCWNhc2UgMHgxNDA2OiByZXR1cm4gc2V0VmFsdWVWMWY7IC8vIEZMT0FUCgkJY2FzZSAweDhiNTA6IHJldHVybiBzZXRWYWx1ZVYyZjsgLy8gX1ZFQzIKCQljYXNlIDB4OGI1MTogcmV0dXJuIHNldFZhbHVlVjNmOyAvLyBfVkVDMwoJCWNhc2UgMHg4YjUyOiByZXR1cm4gc2V0VmFsdWVWNGY7IC8vIF9WRUM0CgoJCWNhc2UgMHg4YjVhOiByZXR1cm4gc2V0VmFsdWVNMjsgLy8gX01BVDIKCQljYXNlIDB4OGI1YjogcmV0dXJuIHNldFZhbHVlTTM7IC8vIF9NQVQzCgkJY2FzZSAweDhiNWM6IHJldHVybiBzZXRWYWx1ZU00OyAvLyBfTUFUNAoKCQljYXNlIDB4MTQwNDogY2FzZSAweDhiNTY6IHJldHVybiBzZXRWYWx1ZVYxaTsgLy8gSU5ULCBCT09MCgkJY2FzZSAweDhiNTM6IGNhc2UgMHg4YjU3OiByZXR1cm4gc2V0VmFsdWVWMmk7IC8vIF9WRUMyCgkJY2FzZSAweDhiNTQ6IGNhc2UgMHg4YjU4OiByZXR1cm4gc2V0VmFsdWVWM2k7IC8vIF9WRUMzCgkJY2FzZSAweDhiNTU6IGNhc2UgMHg4YjU5OiByZXR1cm4gc2V0VmFsdWVWNGk7IC8vIF9WRUM0CgoJCWNhc2UgMHgxNDA1OiByZXR1cm4gc2V0VmFsdWVWMXVpOyAvLyBVSU5UCgkJY2FzZSAweDhkYzY6IHJldHVybiBzZXRWYWx1ZVYydWk7IC8vIF9WRUMyCgkJY2FzZSAweDhkYzc6IHJldHVybiBzZXRWYWx1ZVYzdWk7IC8vIF9WRUMzCgkJY2FzZSAweDhkYzg6IHJldHVybiBzZXRWYWx1ZVY0dWk7IC8vIF9WRUM0CgoJCWNhc2UgMHg4YjVlOiAvLyBTQU1QTEVSXzJECgkJY2FzZSAweDhkNjY6IC8vIFNBTVBMRVJfRVhURVJOQUxfT0VTCgkJY2FzZSAweDhkY2E6IC8vIElOVF9TQU1QTEVSXzJECgkJY2FzZSAweDhkZDI6IC8vIFVOU0lHTkVEX0lOVF9TQU1QTEVSXzJECgkJY2FzZSAweDhiNjI6IC8vIFNBTVBMRVJfMkRfU0hBRE9XCgkJCXJldHVybiBzZXRWYWx1ZVQxOwoKCQljYXNlIDB4OGI1ZjogLy8gU0FNUExFUl8zRAoJCWNhc2UgMHg4ZGNiOiAvLyBJTlRfU0FNUExFUl8zRAoJCWNhc2UgMHg4ZGQzOiAvLyBVTlNJR05FRF9JTlRfU0FNUExFUl8zRAoJCQlyZXR1cm4gc2V0VmFsdWVUM0QxOwoKCQljYXNlIDB4OGI2MDogLy8gU0FNUExFUl9DVUJFCgkJY2FzZSAweDhkY2M6IC8vIElOVF9TQU1QTEVSX0NVQkUKCQljYXNlIDB4OGRkNDogLy8gVU5TSUdORURfSU5UX1NBTVBMRVJfQ1VCRQoJCWNhc2UgMHg4ZGM1OiAvLyBTQU1QTEVSX0NVQkVfU0hBRE9XCgkJCXJldHVybiBzZXRWYWx1ZVQ2OwoKCQljYXNlIDB4OGRjMTogLy8gU0FNUExFUl8yRF9BUlJBWQoJCWNhc2UgMHg4ZGNmOiAvLyBJTlRfU0FNUExFUl8yRF9BUlJBWQoJCWNhc2UgMHg4ZGQ3OiAvLyBVTlNJR05FRF9JTlRfU0FNUExFUl8yRF9BUlJBWQoJCWNhc2UgMHg4ZGM0OiAvLyBTQU1QTEVSXzJEX0FSUkFZX1NIQURPVwoJCQlyZXR1cm4gc2V0VmFsdWVUMkRBcnJheTE7CgoJfQoKfQoKCi8vIEFycmF5IG9mIHNjYWxhcnMKCmZ1bmN0aW9uIHNldFZhbHVlVjFmQXJyYXkoIGdsLCB2ICkgewoKCWdsLnVuaWZvcm0xZnYoIHRoaXMuYWRkciwgdiApOwoKfQoKLy8gQXJyYXkgb2YgdmVjdG9ycyAoZnJvbSBmbGF0IGFycmF5IG9yIGFycmF5IG9mIFRIUkVFLlZlY3Rvck4pCgpmdW5jdGlvbiBzZXRWYWx1ZVYyZkFycmF5KCBnbCwgdiApIHsKCgljb25zdCBkYXRhID0gZmxhdHRlbiggdiwgdGhpcy5zaXplLCAyICk7CgoJZ2wudW5pZm9ybTJmdiggdGhpcy5hZGRyLCBkYXRhICk7Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZVYzZkFycmF5KCBnbCwgdiApIHsKCgljb25zdCBkYXRhID0gZmxhdHRlbiggdiwgdGhpcy5zaXplLCAzICk7CgoJZ2wudW5pZm9ybTNmdiggdGhpcy5hZGRyLCBkYXRhICk7Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZVY0ZkFycmF5KCBnbCwgdiApIHsKCgljb25zdCBkYXRhID0gZmxhdHRlbiggdiwgdGhpcy5zaXplLCA0ICk7CgoJZ2wudW5pZm9ybTRmdiggdGhpcy5hZGRyLCBkYXRhICk7Cgp9CgovLyBBcnJheSBvZiBtYXRyaWNlcyAoZnJvbSBmbGF0IGFycmF5IG9yIGFycmF5IG9mIFRIUkVFLk1hdHJpeE4pCgpmdW5jdGlvbiBzZXRWYWx1ZU0yQXJyYXkoIGdsLCB2ICkgewoKCWNvbnN0IGRhdGEgPSBmbGF0dGVuKCB2LCB0aGlzLnNpemUsIDQgKTsKCglnbC51bmlmb3JtTWF0cml4MmZ2KCB0aGlzLmFkZHIsIGZhbHNlLCBkYXRhICk7Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZU0zQXJyYXkoIGdsLCB2ICkgewoKCWNvbnN0IGRhdGEgPSBmbGF0dGVuKCB2LCB0aGlzLnNpemUsIDkgKTsKCglnbC51bmlmb3JtTWF0cml4M2Z2KCB0aGlzLmFkZHIsIGZhbHNlLCBkYXRhICk7Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZU00QXJyYXkoIGdsLCB2ICkgewoKCWNvbnN0IGRhdGEgPSBmbGF0dGVuKCB2LCB0aGlzLnNpemUsIDE2ICk7CgoJZ2wudW5pZm9ybU1hdHJpeDRmdiggdGhpcy5hZGRyLCBmYWxzZSwgZGF0YSApOwoKfQoKLy8gQXJyYXkgb2YgaW50ZWdlciAvIGJvb2xlYW4KCmZ1bmN0aW9uIHNldFZhbHVlVjFpQXJyYXkoIGdsLCB2ICkgewoKCWdsLnVuaWZvcm0xaXYoIHRoaXMuYWRkciwgdiApOwoKfQoKLy8gQXJyYXkgb2YgaW50ZWdlciAvIGJvb2xlYW4gdmVjdG9ycyAoZnJvbSBmbGF0IGFycmF5KQoKZnVuY3Rpb24gc2V0VmFsdWVWMmlBcnJheSggZ2wsIHYgKSB7CgoJZ2wudW5pZm9ybTJpdiggdGhpcy5hZGRyLCB2ICk7Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZVYzaUFycmF5KCBnbCwgdiApIHsKCglnbC51bmlmb3JtM2l2KCB0aGlzLmFkZHIsIHYgKTsKCn0KCmZ1bmN0aW9uIHNldFZhbHVlVjRpQXJyYXkoIGdsLCB2ICkgewoKCWdsLnVuaWZvcm00aXYoIHRoaXMuYWRkciwgdiApOwoKfQoKLy8gQXJyYXkgb2YgdW5zaWduZWQgaW50ZWdlcgoKZnVuY3Rpb24gc2V0VmFsdWVWMXVpQXJyYXkoIGdsLCB2ICkgewoKCWdsLnVuaWZvcm0xdWl2KCB0aGlzLmFkZHIsIHYgKTsKCn0KCi8vIEFycmF5IG9mIHVuc2lnbmVkIGludGVnZXIgdmVjdG9ycyAoZnJvbSBmbGF0IGFycmF5KQoKZnVuY3Rpb24gc2V0VmFsdWVWMnVpQXJyYXkoIGdsLCB2ICkgewoKCWdsLnVuaWZvcm0ydWl2KCB0aGlzLmFkZHIsIHYgKTsKCn0KCmZ1bmN0aW9uIHNldFZhbHVlVjN1aUFycmF5KCBnbCwgdiApIHsKCglnbC51bmlmb3JtM3VpdiggdGhpcy5hZGRyLCB2ICk7Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZVY0dWlBcnJheSggZ2wsIHYgKSB7CgoJZ2wudW5pZm9ybTR1aXYoIHRoaXMuYWRkciwgdiApOwoKfQoKCi8vIEFycmF5IG9mIHRleHR1cmVzICgyRCAvIDNEIC8gQ3ViZSAvIDJEQXJyYXkpCgpmdW5jdGlvbiBzZXRWYWx1ZVQxQXJyYXkoIGdsLCB2LCB0ZXh0dXJlcyApIHsKCgljb25zdCBjYWNoZSA9IHRoaXMuY2FjaGU7CgoJY29uc3QgbiA9IHYubGVuZ3RoOwoKCWNvbnN0IHVuaXRzID0gYWxsb2NUZXhVbml0cyggdGV4dHVyZXMsIG4gKTsKCglpZiAoICEgYXJyYXlzRXF1YWwoIGNhY2hlLCB1bml0cyApICkgewoKCQlnbC51bmlmb3JtMWl2KCB0aGlzLmFkZHIsIHVuaXRzICk7CgoJCWNvcHlBcnJheSggY2FjaGUsIHVuaXRzICk7CgoJfQoKCWZvciAoIGxldCBpID0gMDsgaSAhPT0gbjsgKysgaSApIHsKCgkJdGV4dHVyZXMuc2V0VGV4dHVyZTJEKCB2WyBpIF0gfHwgZW1wdHlUZXh0dXJlLCB1bml0c1sgaSBdICk7CgoJfQoKfQoKZnVuY3Rpb24gc2V0VmFsdWVUM0RBcnJheSggZ2wsIHYsIHRleHR1cmVzICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCgljb25zdCBuID0gdi5sZW5ndGg7CgoJY29uc3QgdW5pdHMgPSBhbGxvY1RleFVuaXRzKCB0ZXh0dXJlcywgbiApOwoKCWlmICggISBhcnJheXNFcXVhbCggY2FjaGUsIHVuaXRzICkgKSB7CgoJCWdsLnVuaWZvcm0xaXYoIHRoaXMuYWRkciwgdW5pdHMgKTsKCgkJY29weUFycmF5KCBjYWNoZSwgdW5pdHMgKTsKCgl9CgoJZm9yICggbGV0IGkgPSAwOyBpICE9PSBuOyArKyBpICkgewoKCQl0ZXh0dXJlcy5zZXRUZXh0dXJlM0QoIHZbIGkgXSB8fCBlbXB0eTNkVGV4dHVyZSwgdW5pdHNbIGkgXSApOwoKCX0KCn0KCmZ1bmN0aW9uIHNldFZhbHVlVDZBcnJheSggZ2wsIHYsIHRleHR1cmVzICkgewoKCWNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZTsKCgljb25zdCBuID0gdi5sZW5ndGg7CgoJY29uc3QgdW5pdHMgPSBhbGxvY1RleFVuaXRzKCB0ZXh0dXJlcywgbiApOwoKCWlmICggISBhcnJheXNFcXVhbCggY2FjaGUsIHVuaXRzICkgKSB7CgoJCWdsLnVuaWZvcm0xaXYoIHRoaXMuYWRkciwgdW5pdHMgKTsKCgkJY29weUFycmF5KCBjYWNoZSwgdW5pdHMgKTsKCgl9CgoJZm9yICggbGV0IGkgPSAwOyBpICE9PSBuOyArKyBpICkgewoKCQl0ZXh0dXJlcy5zZXRUZXh0dXJlQ3ViZSggdlsgaSBdIHx8IGVtcHR5Q3ViZVRleHR1cmUsIHVuaXRzWyBpIF0gKTsKCgl9Cgp9CgpmdW5jdGlvbiBzZXRWYWx1ZVQyREFycmF5QXJyYXkoIGdsLCB2LCB0ZXh0dXJlcyApIHsKCgljb25zdCBjYWNoZSA9IHRoaXMuY2FjaGU7CgoJY29uc3QgbiA9IHYubGVuZ3RoOwoKCWNvbnN0IHVuaXRzID0gYWxsb2NUZXhVbml0cyggdGV4dHVyZXMsIG4gKTsKCglpZiAoICEgYXJyYXlzRXF1YWwoIGNhY2hlLCB1bml0cyApICkgewoKCQlnbC51bmlmb3JtMWl2KCB0aGlzLmFkZHIsIHVuaXRzICk7CgoJCWNvcHlBcnJheSggY2FjaGUsIHVuaXRzICk7CgoJfQoKCWZvciAoIGxldCBpID0gMDsgaSAhPT0gbjsgKysgaSApIHsKCgkJdGV4dHVyZXMuc2V0VGV4dHVyZTJEQXJyYXkoIHZbIGkgXSB8fCBlbXB0eUFycmF5VGV4dHVyZSwgdW5pdHNbIGkgXSApOwoKCX0KCn0KCgovLyBIZWxwZXIgdG8gcGljayB0aGUgcmlnaHQgc2V0dGVyIGZvciBhIHB1cmUgKGJvdHRvbS1sZXZlbCkgYXJyYXkKCmZ1bmN0aW9uIGdldFB1cmVBcnJheVNldHRlciggdHlwZSApIHsKCglzd2l0Y2ggKCB0eXBlICkgewoKCQljYXNlIDB4MTQwNjogcmV0dXJuIHNldFZhbHVlVjFmQXJyYXk7IC8vIEZMT0FUCgkJY2FzZSAweDhiNTA6IHJldHVybiBzZXRWYWx1ZVYyZkFycmF5OyAvLyBfVkVDMgoJCWNhc2UgMHg4YjUxOiByZXR1cm4gc2V0VmFsdWVWM2ZBcnJheTsgLy8gX1ZFQzMKCQljYXNlIDB4OGI1MjogcmV0dXJuIHNldFZhbHVlVjRmQXJyYXk7IC8vIF9WRUM0CgoJCWNhc2UgMHg4YjVhOiByZXR1cm4gc2V0VmFsdWVNMkFycmF5OyAvLyBfTUFUMgoJCWNhc2UgMHg4YjViOiByZXR1cm4gc2V0VmFsdWVNM0FycmF5OyAvLyBfTUFUMwoJCWNhc2UgMHg4YjVjOiByZXR1cm4gc2V0VmFsdWVNNEFycmF5OyAvLyBfTUFUNAoKCQljYXNlIDB4MTQwNDogY2FzZSAweDhiNTY6IHJldHVybiBzZXRWYWx1ZVYxaUFycmF5OyAvLyBJTlQsIEJPT0wKCQljYXNlIDB4OGI1MzogY2FzZSAweDhiNTc6IHJldHVybiBzZXRWYWx1ZVYyaUFycmF5OyAvLyBfVkVDMgoJCWNhc2UgMHg4YjU0OiBjYXNlIDB4OGI1ODogcmV0dXJuIHNldFZhbHVlVjNpQXJyYXk7IC8vIF9WRUMzCgkJY2FzZSAweDhiNTU6IGNhc2UgMHg4YjU5OiByZXR1cm4gc2V0VmFsdWVWNGlBcnJheTsgLy8gX1ZFQzQKCgkJY2FzZSAweDE0MDU6IHJldHVybiBzZXRWYWx1ZVYxdWlBcnJheTsgLy8gVUlOVAoJCWNhc2UgMHg4ZGM2OiByZXR1cm4gc2V0VmFsdWVWMnVpQXJyYXk7IC8vIF9WRUMyCgkJY2FzZSAweDhkYzc6IHJldHVybiBzZXRWYWx1ZVYzdWlBcnJheTsgLy8gX1ZFQzMKCQljYXNlIDB4OGRjODogcmV0dXJuIHNldFZhbHVlVjR1aUFycmF5OyAvLyBfVkVDNAoKCQljYXNlIDB4OGI1ZTogLy8gU0FNUExFUl8yRAoJCWNhc2UgMHg4ZDY2OiAvLyBTQU1QTEVSX0VYVEVSTkFMX09FUwoJCWNhc2UgMHg4ZGNhOiAvLyBJTlRfU0FNUExFUl8yRAoJCWNhc2UgMHg4ZGQyOiAvLyBVTlNJR05FRF9JTlRfU0FNUExFUl8yRAoJCWNhc2UgMHg4YjYyOiAvLyBTQU1QTEVSXzJEX1NIQURPVwoJCQlyZXR1cm4gc2V0VmFsdWVUMUFycmF5OwoKCQljYXNlIDB4OGI1ZjogLy8gU0FNUExFUl8zRAoJCWNhc2UgMHg4ZGNiOiAvLyBJTlRfU0FNUExFUl8zRAoJCWNhc2UgMHg4ZGQzOiAvLyBVTlNJR05FRF9JTlRfU0FNUExFUl8zRAoJCQlyZXR1cm4gc2V0VmFsdWVUM0RBcnJheTsKCgkJY2FzZSAweDhiNjA6IC8vIFNBTVBMRVJfQ1VCRQoJCWNhc2UgMHg4ZGNjOiAvLyBJTlRfU0FNUExFUl9DVUJFCgkJY2FzZSAweDhkZDQ6IC8vIFVOU0lHTkVEX0lOVF9TQU1QTEVSX0NVQkUKCQljYXNlIDB4OGRjNTogLy8gU0FNUExFUl9DVUJFX1NIQURPVwoJCQlyZXR1cm4gc2V0VmFsdWVUNkFycmF5OwoKCQljYXNlIDB4OGRjMTogLy8gU0FNUExFUl8yRF9BUlJBWQoJCWNhc2UgMHg4ZGNmOiAvLyBJTlRfU0FNUExFUl8yRF9BUlJBWQoJCWNhc2UgMHg4ZGQ3OiAvLyBVTlNJR05FRF9JTlRfU0FNUExFUl8yRF9BUlJBWQoJCWNhc2UgMHg4ZGM0OiAvLyBTQU1QTEVSXzJEX0FSUkFZX1NIQURPVwoJCQlyZXR1cm4gc2V0VmFsdWVUMkRBcnJheUFycmF5OwoKCX0KCn0KCi8vIC0tLSBVbmlmb3JtIENsYXNzZXMgLS0tCgpjbGFzcyBTaW5nbGVVbmlmb3JtIHsKCgljb25zdHJ1Y3RvciggaWQsIGFjdGl2ZUluZm8sIGFkZHIgKSB7CgoJCXRoaXMuaWQgPSBpZDsKCQl0aGlzLmFkZHIgPSBhZGRyOwoJCXRoaXMuY2FjaGUgPSBbXTsKCQl0aGlzLnR5cGUgPSBhY3RpdmVJbmZvLnR5cGU7CgkJdGhpcy5zZXRWYWx1ZSA9IGdldFNpbmd1bGFyU2V0dGVyKCBhY3RpdmVJbmZvLnR5cGUgKTsKCgkJLy8gdGhpcy5wYXRoID0gYWN0aXZlSW5mby5uYW1lOyAvLyBERUJVRwoKCX0KCn0KCmNsYXNzIFB1cmVBcnJheVVuaWZvcm0gewoKCWNvbnN0cnVjdG9yKCBpZCwgYWN0aXZlSW5mbywgYWRkciApIHsKCgkJdGhpcy5pZCA9IGlkOwoJCXRoaXMuYWRkciA9IGFkZHI7CgkJdGhpcy5jYWNoZSA9IFtdOwoJCXRoaXMudHlwZSA9IGFjdGl2ZUluZm8udHlwZTsKCQl0aGlzLnNpemUgPSBhY3RpdmVJbmZvLnNpemU7CgkJdGhpcy5zZXRWYWx1ZSA9IGdldFB1cmVBcnJheVNldHRlciggYWN0aXZlSW5mby50eXBlICk7CgoJCS8vIHRoaXMucGF0aCA9IGFjdGl2ZUluZm8ubmFtZTsgLy8gREVCVUcKCgl9Cgp9CgpjbGFzcyBTdHJ1Y3R1cmVkVW5pZm9ybSB7CgoJY29uc3RydWN0b3IoIGlkICkgewoKCQl0aGlzLmlkID0gaWQ7CgoJCXRoaXMuc2VxID0gW107CgkJdGhpcy5tYXAgPSB7fTsKCgl9CgoJc2V0VmFsdWUoIGdsLCB2YWx1ZSwgdGV4dHVyZXMgKSB7CgoJCWNvbnN0IHNlcSA9IHRoaXMuc2VxOwoKCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSBzZXEubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJY29uc3QgdSA9IHNlcVsgaSBdOwoJCQl1LnNldFZhbHVlKCBnbCwgdmFsdWVbIHUuaWQgXSwgdGV4dHVyZXMgKTsKCgkJfQoKCX0KCn0KCi8vIC0tLSBUb3AtbGV2ZWwgLS0tCgovLyBQYXJzZXIgLSBidWlsZHMgdXAgdGhlIHByb3BlcnR5IHRyZWUgZnJvbSB0aGUgcGF0aCBzdHJpbmdzCgpjb25zdCBSZVBhdGhQYXJ0ID0gLyhcdyspKFxdKT8oXFt8XC4pPy9nOwoKLy8gZXh0cmFjdHMKLy8gCS0gdGhlIGlkZW50aWZpZXIgKG1lbWJlciBuYW1lIG9yIGFycmF5IGluZGV4KQovLyAgLSBmb2xsb3dlZCBieSBhbiBvcHRpb25hbCByaWdodCBicmFja2V0IChmb3VuZCB3aGVuIGFycmF5IGluZGV4KQovLyAgLSBmb2xsb3dlZCBieSBhbiBvcHRpb25hbCBsZWZ0IGJyYWNrZXQgb3IgZG90ICh0eXBlIG9mIHN1YnNjcmlwdCkKLy8KLy8gTm90ZTogVGhlc2UgcG9ydGlvbnMgY2FuIGJlIHJlYWQgaW4gYSBub24tb3ZlcmxhcHBpbmcgZmFzaGlvbiBhbmQKLy8gYWxsb3cgc3RyYWlnaHRmb3J3YXJkIHBhcnNpbmcgb2YgdGhlIGhpZXJhcmNoeSB0aGF0IFdlYkdMIGVuY29kZXMKLy8gaW4gdGhlIHVuaWZvcm0gbmFtZXMuCgpmdW5jdGlvbiBhZGRVbmlmb3JtKCBjb250YWluZXIsIHVuaWZvcm1PYmplY3QgKSB7CgoJY29udGFpbmVyLnNlcS5wdXNoKCB1bmlmb3JtT2JqZWN0ICk7Cgljb250YWluZXIubWFwWyB1bmlmb3JtT2JqZWN0LmlkIF0gPSB1bmlmb3JtT2JqZWN0OwoKfQoKZnVuY3Rpb24gcGFyc2VVbmlmb3JtKCBhY3RpdmVJbmZvLCBhZGRyLCBjb250YWluZXIgKSB7CgoJY29uc3QgcGF0aCA9IGFjdGl2ZUluZm8ubmFtZSwKCQlwYXRoTGVuZ3RoID0gcGF0aC5sZW5ndGg7CgoJLy8gcmVzZXQgUmVnRXhwIG9iamVjdCwgYmVjYXVzZSBvZiB0aGUgZWFybHkgZXhpdCBvZiBhIHByZXZpb3VzIHJ1bgoJUmVQYXRoUGFydC5sYXN0SW5kZXggPSAwOwoKCXdoaWxlICggdHJ1ZSApIHsKCgkJY29uc3QgbWF0Y2ggPSBSZVBhdGhQYXJ0LmV4ZWMoIHBhdGggKSwKCQkJbWF0Y2hFbmQgPSBSZVBhdGhQYXJ0Lmxhc3RJbmRleDsKCgkJbGV0IGlkID0gbWF0Y2hbIDEgXTsKCQljb25zdCBpZElzSW5kZXggPSBtYXRjaFsgMiBdID09PSAnXScsCgkJCXN1YnNjcmlwdCA9IG1hdGNoWyAzIF07CgoJCWlmICggaWRJc0luZGV4ICkgaWQgPSBpZCB8IDA7IC8vIGNvbnZlcnQgdG8gaW50ZWdlcgoKCQlpZiAoIHN1YnNjcmlwdCA9PT0gdW5kZWZpbmVkIHx8IHN1YnNjcmlwdCA9PT0gJ1snICYmIG1hdGNoRW5kICsgMiA9PT0gcGF0aExlbmd0aCApIHsKCgkJCS8vIGJhcmUgbmFtZSBvciAicHVyZSIgYm90dG9tLWxldmVsIGFycmF5ICJbMF0iIHN1ZmZpeAoKCQkJYWRkVW5pZm9ybSggY29udGFpbmVyLCBzdWJzY3JpcHQgPT09IHVuZGVmaW5lZCA/CgkJCQluZXcgU2luZ2xlVW5pZm9ybSggaWQsIGFjdGl2ZUluZm8sIGFkZHIgKSA6CgkJCQluZXcgUHVyZUFycmF5VW5pZm9ybSggaWQsIGFjdGl2ZUluZm8sIGFkZHIgKSApOwoKCQkJYnJlYWs7CgoJCX0gZWxzZSB7CgoJCQkvLyBzdGVwIGludG8gaW5uZXIgbm9kZSAvIGNyZWF0ZSBpdCBpbiBjYXNlIGl0IGRvZXNuJ3QgZXhpc3QKCgkJCWNvbnN0IG1hcCA9IGNvbnRhaW5lci5tYXA7CgkJCWxldCBuZXh0ID0gbWFwWyBpZCBdOwoKCQkJaWYgKCBuZXh0ID09PSB1bmRlZmluZWQgKSB7CgoJCQkJbmV4dCA9IG5ldyBTdHJ1Y3R1cmVkVW5pZm9ybSggaWQgKTsKCQkJCWFkZFVuaWZvcm0oIGNvbnRhaW5lciwgbmV4dCApOwoKCQkJfQoKCQkJY29udGFpbmVyID0gbmV4dDsKCgkJfQoKCX0KCn0KCi8vIFJvb3QgQ29udGFpbmVyCgpjbGFzcyBXZWJHTFVuaWZvcm1zIHsKCgljb25zdHJ1Y3RvciggZ2wsIHByb2dyYW0gKSB7CgoJCXRoaXMuc2VxID0gW107CgkJdGhpcy5tYXAgPSB7fTsKCgkJY29uc3QgbiA9IGdsLmdldFByb2dyYW1QYXJhbWV0ZXIoIHByb2dyYW0sIGdsLkFDVElWRV9VTklGT1JNUyApOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBuOyArKyBpICkgewoKCQkJY29uc3QgaW5mbyA9IGdsLmdldEFjdGl2ZVVuaWZvcm0oIHByb2dyYW0sIGkgKSwKCQkJCWFkZHIgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24oIHByb2dyYW0sIGluZm8ubmFtZSApOwoKCQkJcGFyc2VVbmlmb3JtKCBpbmZvLCBhZGRyLCB0aGlzICk7CgoJCX0KCgl9CgoJc2V0VmFsdWUoIGdsLCBuYW1lLCB2YWx1ZSwgdGV4dHVyZXMgKSB7CgoJCWNvbnN0IHUgPSB0aGlzLm1hcFsgbmFtZSBdOwoKCQlpZiAoIHUgIT09IHVuZGVmaW5lZCApIHUuc2V0VmFsdWUoIGdsLCB2YWx1ZSwgdGV4dHVyZXMgKTsKCgl9CgoJc2V0T3B0aW9uYWwoIGdsLCBvYmplY3QsIG5hbWUgKSB7CgoJCWNvbnN0IHYgPSBvYmplY3RbIG5hbWUgXTsKCgkJaWYgKCB2ICE9PSB1bmRlZmluZWQgKSB0aGlzLnNldFZhbHVlKCBnbCwgbmFtZSwgdiApOwoKCX0KCglzdGF0aWMgdXBsb2FkKCBnbCwgc2VxLCB2YWx1ZXMsIHRleHR1cmVzICkgewoKCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSBzZXEubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJY29uc3QgdSA9IHNlcVsgaSBdLAoJCQkJdiA9IHZhbHVlc1sgdS5pZCBdOwoKCQkJaWYgKCB2Lm5lZWRzVXBkYXRlICE9PSBmYWxzZSApIHsKCgkJCQkvLyBub3RlOiBhbHdheXMgdXBkYXRpbmcgd2hlbiAubmVlZHNVcGRhdGUgaXMgdW5kZWZpbmVkCgkJCQl1LnNldFZhbHVlKCBnbCwgdi52YWx1ZSwgdGV4dHVyZXMgKTsKCgkJCX0KCgkJfQoKCX0KCglzdGF0aWMgc2VxV2l0aFZhbHVlKCBzZXEsIHZhbHVlcyApIHsKCgkJY29uc3QgciA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSBzZXEubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJY29uc3QgdSA9IHNlcVsgaSBdOwoJCQlpZiAoIHUuaWQgaW4gdmFsdWVzICkgci5wdXNoKCB1ICk7CgoJCX0KCgkJcmV0dXJuIHI7CgoJfQoKfQoKZnVuY3Rpb24gV2ViR0xTaGFkZXIoIGdsLCB0eXBlLCBzdHJpbmcgKSB7CgoJY29uc3Qgc2hhZGVyID0gZ2wuY3JlYXRlU2hhZGVyKCB0eXBlICk7CgoJZ2wuc2hhZGVyU291cmNlKCBzaGFkZXIsIHN0cmluZyApOwoJZ2wuY29tcGlsZVNoYWRlciggc2hhZGVyICk7CgoJcmV0dXJuIHNoYWRlcjsKCn0KCi8vIEZyb20gaHR0cHM6Ly93d3cua2hyb25vcy5vcmcvcmVnaXN0cnkvd2ViZ2wvZXh0ZW5zaW9ucy9LSFJfcGFyYWxsZWxfc2hhZGVyX2NvbXBpbGUvCmNvbnN0IENPTVBMRVRJT05fU1RBVFVTX0tIUiA9IDB4OTFCMTsKCmxldCBwcm9ncmFtSWRDb3VudCA9IDA7CgpmdW5jdGlvbiBoYW5kbGVTb3VyY2UoIHN0cmluZywgZXJyb3JMaW5lICkgewoKCWNvbnN0IGxpbmVzID0gc3RyaW5nLnNwbGl0KCAnXG4nICk7Cgljb25zdCBsaW5lczIgPSBbXTsKCgljb25zdCBmcm9tID0gTWF0aC5tYXgoIGVycm9yTGluZSAtIDYsIDAgKTsKCWNvbnN0IHRvID0gTWF0aC5taW4oIGVycm9yTGluZSArIDYsIGxpbmVzLmxlbmd0aCApOwoKCWZvciAoIGxldCBpID0gZnJvbTsgaSA8IHRvOyBpICsrICkgewoKCQljb25zdCBsaW5lID0gaSArIDE7CgkJbGluZXMyLnB1c2goIGAke2xpbmUgPT09IGVycm9yTGluZSA/ICc+JyA6ICcgJ30gJHtsaW5lfTogJHtsaW5lc1sgaSBdfWAgKTsKCgl9CgoJcmV0dXJuIGxpbmVzMi5qb2luKCAnXG4nICk7Cgp9CgpmdW5jdGlvbiBnZXRFbmNvZGluZ0NvbXBvbmVudHMoIGNvbG9yU3BhY2UgKSB7CgoJY29uc3Qgd29ya2luZ1ByaW1hcmllcyA9IENvbG9yTWFuYWdlbWVudC5nZXRQcmltYXJpZXMoIENvbG9yTWFuYWdlbWVudC53b3JraW5nQ29sb3JTcGFjZSApOwoJY29uc3QgZW5jb2RpbmdQcmltYXJpZXMgPSBDb2xvck1hbmFnZW1lbnQuZ2V0UHJpbWFyaWVzKCBjb2xvclNwYWNlICk7CgoJbGV0IGdhbXV0TWFwcGluZzsKCglpZiAoIHdvcmtpbmdQcmltYXJpZXMgPT09IGVuY29kaW5nUHJpbWFyaWVzICkgewoKCQlnYW11dE1hcHBpbmcgPSAnJzsKCgl9IGVsc2UgaWYgKCB3b3JraW5nUHJpbWFyaWVzID09PSBQM1ByaW1hcmllcyAmJiBlbmNvZGluZ1ByaW1hcmllcyA9PT0gUmVjNzA5UHJpbWFyaWVzICkgewoKCQlnYW11dE1hcHBpbmcgPSAnTGluZWFyRGlzcGxheVAzVG9MaW5lYXJTUkdCJzsKCgl9IGVsc2UgaWYgKCB3b3JraW5nUHJpbWFyaWVzID09PSBSZWM3MDlQcmltYXJpZXMgJiYgZW5jb2RpbmdQcmltYXJpZXMgPT09IFAzUHJpbWFyaWVzICkgewoKCQlnYW11dE1hcHBpbmcgPSAnTGluZWFyU1JHQlRvTGluZWFyRGlzcGxheVAzJzsKCgl9CgoJc3dpdGNoICggY29sb3JTcGFjZSApIHsKCgkJY2FzZSBMaW5lYXJTUkdCQ29sb3JTcGFjZToKCQljYXNlIExpbmVhckRpc3BsYXlQM0NvbG9yU3BhY2U6CgkJCXJldHVybiBbIGdhbXV0TWFwcGluZywgJ0xpbmVhclRyYW5zZmVyT0VURicgXTsKCgkJY2FzZSBTUkdCQ29sb3JTcGFjZToKCQljYXNlIERpc3BsYXlQM0NvbG9yU3BhY2U6CgkJCXJldHVybiBbIGdhbXV0TWFwcGluZywgJ3NSR0JUcmFuc2Zlck9FVEYnIF07CgoJCWRlZmF1bHQ6CgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUHJvZ3JhbTogVW5zdXBwb3J0ZWQgY29sb3Igc3BhY2U6JywgY29sb3JTcGFjZSApOwoJCQlyZXR1cm4gWyBnYW11dE1hcHBpbmcsICdMaW5lYXJUcmFuc2Zlck9FVEYnIF07CgoJfQoKfQoKZnVuY3Rpb24gZ2V0U2hhZGVyRXJyb3JzKCBnbCwgc2hhZGVyLCB0eXBlICkgewoKCWNvbnN0IHN0YXR1cyA9IGdsLmdldFNoYWRlclBhcmFtZXRlciggc2hhZGVyLCBnbC5DT01QSUxFX1NUQVRVUyApOwoJY29uc3QgZXJyb3JzID0gZ2wuZ2V0U2hhZGVySW5mb0xvZyggc2hhZGVyICkudHJpbSgpOwoKCWlmICggc3RhdHVzICYmIGVycm9ycyA9PT0gJycgKSByZXR1cm4gJyc7CgoJY29uc3QgZXJyb3JNYXRjaGVzID0gL0VSUk9SOiAwOihcZCspLy5leGVjKCBlcnJvcnMgKTsKCWlmICggZXJyb3JNYXRjaGVzICkgewoKCQkvLyAtLWVuYWJsZS1wcml2aWxlZ2VkLXdlYmdsLWV4dGVuc2lvbgoJCS8vIGNvbnNvbGUubG9nKCAnKionICsgdHlwZSArICcqKicsIGdsLmdldEV4dGVuc2lvbiggJ1dFQkdMX2RlYnVnX3NoYWRlcnMnICkuZ2V0VHJhbnNsYXRlZFNoYWRlclNvdXJjZSggc2hhZGVyICkgKTsKCgkJY29uc3QgZXJyb3JMaW5lID0gcGFyc2VJbnQoIGVycm9yTWF0Y2hlc1sgMSBdICk7CgkJcmV0dXJuIHR5cGUudG9VcHBlckNhc2UoKSArICdcblxuJyArIGVycm9ycyArICdcblxuJyArIGhhbmRsZVNvdXJjZSggZ2wuZ2V0U2hhZGVyU291cmNlKCBzaGFkZXIgKSwgZXJyb3JMaW5lICk7CgoJfSBlbHNlIHsKCgkJcmV0dXJuIGVycm9yczsKCgl9Cgp9CgpmdW5jdGlvbiBnZXRUZXhlbEVuY29kaW5nRnVuY3Rpb24oIGZ1bmN0aW9uTmFtZSwgY29sb3JTcGFjZSApIHsKCgljb25zdCBjb21wb25lbnRzID0gZ2V0RW5jb2RpbmdDb21wb25lbnRzKCBjb2xvclNwYWNlICk7CglyZXR1cm4gYHZlYzQgJHtmdW5jdGlvbk5hbWV9KCB2ZWM0IHZhbHVlICkgeyByZXR1cm4gJHtjb21wb25lbnRzWyAwIF19KCAke2NvbXBvbmVudHNbIDEgXX0oIHZhbHVlICkgKTsgfWA7Cgp9CgpmdW5jdGlvbiBnZXRUb25lTWFwcGluZ0Z1bmN0aW9uKCBmdW5jdGlvbk5hbWUsIHRvbmVNYXBwaW5nICkgewoKCWxldCB0b25lTWFwcGluZ05hbWU7CgoJc3dpdGNoICggdG9uZU1hcHBpbmcgKSB7CgoJCWNhc2UgTGluZWFyVG9uZU1hcHBpbmc6CgkJCXRvbmVNYXBwaW5nTmFtZSA9ICdMaW5lYXInOwoJCQlicmVhazsKCgkJY2FzZSBSZWluaGFyZFRvbmVNYXBwaW5nOgoJCQl0b25lTWFwcGluZ05hbWUgPSAnUmVpbmhhcmQnOwoJCQlicmVhazsKCgkJY2FzZSBDaW5lb25Ub25lTWFwcGluZzoKCQkJdG9uZU1hcHBpbmdOYW1lID0gJ09wdGltaXplZENpbmVvbic7CgkJCWJyZWFrOwoKCQljYXNlIEFDRVNGaWxtaWNUb25lTWFwcGluZzoKCQkJdG9uZU1hcHBpbmdOYW1lID0gJ0FDRVNGaWxtaWMnOwoJCQlicmVhazsKCgkJY2FzZSBBZ1hUb25lTWFwcGluZzoKCQkJdG9uZU1hcHBpbmdOYW1lID0gJ0FnWCc7CgkJCWJyZWFrOwoKCQljYXNlIEN1c3RvbVRvbmVNYXBwaW5nOgoJCQl0b25lTWFwcGluZ05hbWUgPSAnQ3VzdG9tJzsKCQkJYnJlYWs7CgoJCWRlZmF1bHQ6CgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUHJvZ3JhbTogVW5zdXBwb3J0ZWQgdG9uZU1hcHBpbmc6JywgdG9uZU1hcHBpbmcgKTsKCQkJdG9uZU1hcHBpbmdOYW1lID0gJ0xpbmVhcic7CgoJfQoKCXJldHVybiAndmVjMyAnICsgZnVuY3Rpb25OYW1lICsgJyggdmVjMyBjb2xvciApIHsgcmV0dXJuICcgKyB0b25lTWFwcGluZ05hbWUgKyAnVG9uZU1hcHBpbmcoIGNvbG9yICk7IH0nOwoKfQoKZnVuY3Rpb24gZ2VuZXJhdGVFeHRlbnNpb25zKCBwYXJhbWV0ZXJzICkgewoKCWNvbnN0IGNodW5rcyA9IFsKCQkoIHBhcmFtZXRlcnMuZXh0ZW5zaW9uRGVyaXZhdGl2ZXMgfHwgISEgcGFyYW1ldGVycy5lbnZNYXBDdWJlVVZIZWlnaHQgfHwgcGFyYW1ldGVycy5idW1wTWFwIHx8IHBhcmFtZXRlcnMubm9ybWFsTWFwVGFuZ2VudFNwYWNlIHx8IHBhcmFtZXRlcnMuY2xlYXJjb2F0Tm9ybWFsTWFwIHx8IHBhcmFtZXRlcnMuZmxhdFNoYWRpbmcgfHwgcGFyYW1ldGVycy5hbHBoYVRvQ292ZXJhZ2UgfHwgcGFyYW1ldGVycy5zaGFkZXJJRCA9PT0gJ3BoeXNpY2FsJyApID8gJyNleHRlbnNpb24gR0xfT0VTX3N0YW5kYXJkX2Rlcml2YXRpdmVzIDogZW5hYmxlJyA6ICcnLAoJCSggcGFyYW1ldGVycy5leHRlbnNpb25GcmFnRGVwdGggfHwgcGFyYW1ldGVycy5sb2dhcml0aG1pY0RlcHRoQnVmZmVyICkgJiYgcGFyYW1ldGVycy5yZW5kZXJlckV4dGVuc2lvbkZyYWdEZXB0aCA/ICcjZXh0ZW5zaW9uIEdMX0VYVF9mcmFnX2RlcHRoIDogZW5hYmxlJyA6ICcnLAoJCSggcGFyYW1ldGVycy5leHRlbnNpb25EcmF3QnVmZmVycyAmJiBwYXJhbWV0ZXJzLnJlbmRlcmVyRXh0ZW5zaW9uRHJhd0J1ZmZlcnMgKSA/ICcjZXh0ZW5zaW9uIEdMX0VYVF9kcmF3X2J1ZmZlcnMgOiByZXF1aXJlJyA6ICcnLAoJCSggcGFyYW1ldGVycy5leHRlbnNpb25TaGFkZXJUZXh0dXJlTE9EIHx8IHBhcmFtZXRlcnMuZW52TWFwIHx8IHBhcmFtZXRlcnMudHJhbnNtaXNzaW9uICkgJiYgcGFyYW1ldGVycy5yZW5kZXJlckV4dGVuc2lvblNoYWRlclRleHR1cmVMb2QgPyAnI2V4dGVuc2lvbiBHTF9FWFRfc2hhZGVyX3RleHR1cmVfbG9kIDogZW5hYmxlJyA6ICcnCgldOwoKCXJldHVybiBjaHVua3MuZmlsdGVyKCBmaWx0ZXJFbXB0eUxpbmUgKS5qb2luKCAnXG4nICk7Cgp9CgpmdW5jdGlvbiBnZW5lcmF0ZVZlcnRleEV4dGVuc2lvbnMoIHBhcmFtZXRlcnMgKSB7CgoJY29uc3QgY2h1bmtzID0gWwoJCXBhcmFtZXRlcnMuZXh0ZW5zaW9uQ2xpcEN1bGxEaXN0YW5jZSA/ICcjZXh0ZW5zaW9uIEdMX0FOR0xFX2NsaXBfY3VsbF9kaXN0YW5jZSA6IHJlcXVpcmUnIDogJycsCgkJcGFyYW1ldGVycy5leHRlbnNpb25NdWx0aURyYXcgPyAnI2V4dGVuc2lvbiBHTF9BTkdMRV9tdWx0aV9kcmF3IDogcmVxdWlyZScgOiAnJywKCV07CgoJcmV0dXJuIGNodW5rcy5maWx0ZXIoIGZpbHRlckVtcHR5TGluZSApLmpvaW4oICdcbicgKTsKCn0KCmZ1bmN0aW9uIGdlbmVyYXRlRGVmaW5lcyggZGVmaW5lcyApIHsKCgljb25zdCBjaHVua3MgPSBbXTsKCglmb3IgKCBjb25zdCBuYW1lIGluIGRlZmluZXMgKSB7CgoJCWNvbnN0IHZhbHVlID0gZGVmaW5lc1sgbmFtZSBdOwoKCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIGNvbnRpbnVlOwoKCQljaHVua3MucHVzaCggJyNkZWZpbmUgJyArIG5hbWUgKyAnICcgKyB2YWx1ZSApOwoKCX0KCglyZXR1cm4gY2h1bmtzLmpvaW4oICdcbicgKTsKCn0KCmZ1bmN0aW9uIGZldGNoQXR0cmlidXRlTG9jYXRpb25zKCBnbCwgcHJvZ3JhbSApIHsKCgljb25zdCBhdHRyaWJ1dGVzID0ge307CgoJY29uc3QgbiA9IGdsLmdldFByb2dyYW1QYXJhbWV0ZXIoIHByb2dyYW0sIGdsLkFDVElWRV9BVFRSSUJVVEVTICk7CgoJZm9yICggbGV0IGkgPSAwOyBpIDwgbjsgaSArKyApIHsKCgkJY29uc3QgaW5mbyA9IGdsLmdldEFjdGl2ZUF0dHJpYiggcHJvZ3JhbSwgaSApOwoJCWNvbnN0IG5hbWUgPSBpbmZvLm5hbWU7CgoJCWxldCBsb2NhdGlvblNpemUgPSAxOwoJCWlmICggaW5mby50eXBlID09PSBnbC5GTE9BVF9NQVQyICkgbG9jYXRpb25TaXplID0gMjsKCQlpZiAoIGluZm8udHlwZSA9PT0gZ2wuRkxPQVRfTUFUMyApIGxvY2F0aW9uU2l6ZSA9IDM7CgkJaWYgKCBpbmZvLnR5cGUgPT09IGdsLkZMT0FUX01BVDQgKSBsb2NhdGlvblNpemUgPSA0OwoKCQkvLyBjb25zb2xlLmxvZyggJ1RIUkVFLldlYkdMUHJvZ3JhbTogQUNUSVZFIFZFUlRFWCBBVFRSSUJVVEU6JywgbmFtZSwgaSApOwoKCQlhdHRyaWJ1dGVzWyBuYW1lIF0gPSB7CgkJCXR5cGU6IGluZm8udHlwZSwKCQkJbG9jYXRpb246IGdsLmdldEF0dHJpYkxvY2F0aW9uKCBwcm9ncmFtLCBuYW1lICksCgkJCWxvY2F0aW9uU2l6ZTogbG9jYXRpb25TaXplCgkJfTsKCgl9CgoJcmV0dXJuIGF0dHJpYnV0ZXM7Cgp9CgpmdW5jdGlvbiBmaWx0ZXJFbXB0eUxpbmUoIHN0cmluZyApIHsKCglyZXR1cm4gc3RyaW5nICE9PSAnJzsKCn0KCmZ1bmN0aW9uIHJlcGxhY2VMaWdodE51bXMoIHN0cmluZywgcGFyYW1ldGVycyApIHsKCgljb25zdCBudW1TcG90TGlnaHRDb29yZHMgPSBwYXJhbWV0ZXJzLm51bVNwb3RMaWdodFNoYWRvd3MgKyBwYXJhbWV0ZXJzLm51bVNwb3RMaWdodE1hcHMgLSBwYXJhbWV0ZXJzLm51bVNwb3RMaWdodFNoYWRvd3NXaXRoTWFwczsKCglyZXR1cm4gc3RyaW5nCgkJLnJlcGxhY2UoIC9OVU1fRElSX0xJR0hUUy9nLCBwYXJhbWV0ZXJzLm51bURpckxpZ2h0cyApCgkJLnJlcGxhY2UoIC9OVU1fU1BPVF9MSUdIVFMvZywgcGFyYW1ldGVycy5udW1TcG90TGlnaHRzICkKCQkucmVwbGFjZSggL05VTV9TUE9UX0xJR0hUX01BUFMvZywgcGFyYW1ldGVycy5udW1TcG90TGlnaHRNYXBzICkKCQkucmVwbGFjZSggL05VTV9TUE9UX0xJR0hUX0NPT1JEUy9nLCBudW1TcG90TGlnaHRDb29yZHMgKQoJCS5yZXBsYWNlKCAvTlVNX1JFQ1RfQVJFQV9MSUdIVFMvZywgcGFyYW1ldGVycy5udW1SZWN0QXJlYUxpZ2h0cyApCgkJLnJlcGxhY2UoIC9OVU1fUE9JTlRfTElHSFRTL2csIHBhcmFtZXRlcnMubnVtUG9pbnRMaWdodHMgKQoJCS5yZXBsYWNlKCAvTlVNX0hFTUlfTElHSFRTL2csIHBhcmFtZXRlcnMubnVtSGVtaUxpZ2h0cyApCgkJLnJlcGxhY2UoIC9OVU1fRElSX0xJR0hUX1NIQURPV1MvZywgcGFyYW1ldGVycy5udW1EaXJMaWdodFNoYWRvd3MgKQoJCS5yZXBsYWNlKCAvTlVNX1NQT1RfTElHSFRfU0hBRE9XU19XSVRIX01BUFMvZywgcGFyYW1ldGVycy5udW1TcG90TGlnaHRTaGFkb3dzV2l0aE1hcHMgKQoJCS5yZXBsYWNlKCAvTlVNX1NQT1RfTElHSFRfU0hBRE9XUy9nLCBwYXJhbWV0ZXJzLm51bVNwb3RMaWdodFNoYWRvd3MgKQoJCS5yZXBsYWNlKCAvTlVNX1BPSU5UX0xJR0hUX1NIQURPV1MvZywgcGFyYW1ldGVycy5udW1Qb2ludExpZ2h0U2hhZG93cyApOwoKfQoKZnVuY3Rpb24gcmVwbGFjZUNsaXBwaW5nUGxhbmVOdW1zKCBzdHJpbmcsIHBhcmFtZXRlcnMgKSB7CgoJcmV0dXJuIHN0cmluZwoJCS5yZXBsYWNlKCAvTlVNX0NMSVBQSU5HX1BMQU5FUy9nLCBwYXJhbWV0ZXJzLm51bUNsaXBwaW5nUGxhbmVzICkKCQkucmVwbGFjZSggL1VOSU9OX0NMSVBQSU5HX1BMQU5FUy9nLCAoIHBhcmFtZXRlcnMubnVtQ2xpcHBpbmdQbGFuZXMgLSBwYXJhbWV0ZXJzLm51bUNsaXBJbnRlcnNlY3Rpb24gKSApOwoKfQoKLy8gUmVzb2x2ZSBJbmNsdWRlcwoKY29uc3QgaW5jbHVkZVBhdHRlcm4gPSAvXlsgXHRdKiNpbmNsdWRlICs8KFtcd1xkLi9dKyk+L2dtOwoKZnVuY3Rpb24gcmVzb2x2ZUluY2x1ZGVzKCBzdHJpbmcgKSB7CgoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKCBpbmNsdWRlUGF0dGVybiwgaW5jbHVkZVJlcGxhY2VyICk7Cgp9Cgpjb25zdCBzaGFkZXJDaHVua01hcCA9IG5ldyBNYXAoIFsKCVsgJ2VuY29kaW5nc19mcmFnbWVudCcsICdjb2xvcnNwYWNlX2ZyYWdtZW50JyBdLCAvLyBAZGVwcmVjYXRlZCwgcjE1NAoJWyAnZW5jb2RpbmdzX3BhcnNfZnJhZ21lbnQnLCAnY29sb3JzcGFjZV9wYXJzX2ZyYWdtZW50JyBdLCAvLyBAZGVwcmVjYXRlZCwgcjE1NAoJWyAnb3V0cHV0X2ZyYWdtZW50JywgJ29wYXF1ZV9mcmFnbWVudCcgXSwgLy8gQGRlcHJlY2F0ZWQsIHIxNTQKXSApOwoKZnVuY3Rpb24gaW5jbHVkZVJlcGxhY2VyKCBtYXRjaCwgaW5jbHVkZSApIHsKCglsZXQgc3RyaW5nID0gU2hhZGVyQ2h1bmtbIGluY2x1ZGUgXTsKCglpZiAoIHN0cmluZyA9PT0gdW5kZWZpbmVkICkgewoKCQljb25zdCBuZXdJbmNsdWRlID0gc2hhZGVyQ2h1bmtNYXAuZ2V0KCBpbmNsdWRlICk7CgoJCWlmICggbmV3SW5jbHVkZSAhPT0gdW5kZWZpbmVkICkgewoKCQkJc3RyaW5nID0gU2hhZGVyQ2h1bmtbIG5ld0luY2x1ZGUgXTsKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogU2hhZGVyIGNodW5rICIlcyIgaGFzIGJlZW4gZGVwcmVjYXRlZC4gVXNlICIlcyIgaW5zdGVhZC4nLCBpbmNsdWRlLCBuZXdJbmNsdWRlICk7CgoJCX0gZWxzZSB7CgoJCQl0aHJvdyBuZXcgRXJyb3IoICdDYW4gbm90IHJlc29sdmUgI2luY2x1ZGUgPCcgKyBpbmNsdWRlICsgJz4nICk7CgoJCX0KCgl9CgoJcmV0dXJuIHJlc29sdmVJbmNsdWRlcyggc3RyaW5nICk7Cgp9CgovLyBVbnJvbGwgTG9vcHMKCmNvbnN0IHVucm9sbExvb3BQYXR0ZXJuID0gLyNwcmFnbWEgdW5yb2xsX2xvb3Bfc3RhcnRccytmb3JccypcKFxzKmludFxzK2lccyo9XHMqKFxkKylccyo7XHMqaVxzKjxccyooXGQrKVxzKjtccyppXHMqXCtcK1xzKlwpXHMqeyhbXHNcU10rPyl9XHMrI3ByYWdtYSB1bnJvbGxfbG9vcF9lbmQvZzsKCmZ1bmN0aW9uIHVucm9sbExvb3BzKCBzdHJpbmcgKSB7CgoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKCB1bnJvbGxMb29wUGF0dGVybiwgbG9vcFJlcGxhY2VyICk7Cgp9CgpmdW5jdGlvbiBsb29wUmVwbGFjZXIoIG1hdGNoLCBzdGFydCwgZW5kLCBzbmlwcGV0ICkgewoKCWxldCBzdHJpbmcgPSAnJzsKCglmb3IgKCBsZXQgaSA9IHBhcnNlSW50KCBzdGFydCApOyBpIDwgcGFyc2VJbnQoIGVuZCApOyBpICsrICkgewoKCQlzdHJpbmcgKz0gc25pcHBldAoJCQkucmVwbGFjZSggL1xbXHMqaVxzKlxdL2csICdbICcgKyBpICsgJyBdJyApCgkJCS5yZXBsYWNlKCAvVU5ST0xMRURfTE9PUF9JTkRFWC9nLCBpICk7CgoJfQoKCXJldHVybiBzdHJpbmc7Cgp9CgovLwoKZnVuY3Rpb24gZ2VuZXJhdGVQcmVjaXNpb24oIHBhcmFtZXRlcnMgKSB7CgoJbGV0IHByZWNpc2lvbnN0cmluZyA9IGBwcmVjaXNpb24gJHtwYXJhbWV0ZXJzLnByZWNpc2lvbn0gZmxvYXQ7CglwcmVjaXNpb24gJHtwYXJhbWV0ZXJzLnByZWNpc2lvbn0gaW50OwoJcHJlY2lzaW9uICR7cGFyYW1ldGVycy5wcmVjaXNpb259IHNhbXBsZXIyRDsKCXByZWNpc2lvbiAke3BhcmFtZXRlcnMucHJlY2lzaW9ufSBzYW1wbGVyQ3ViZTsKCWA7CgoJaWYgKCBwYXJhbWV0ZXJzLmlzV2ViR0wyICkgewoKCQlwcmVjaXNpb25zdHJpbmcgKz0gYHByZWNpc2lvbiAke3BhcmFtZXRlcnMucHJlY2lzaW9ufSBzYW1wbGVyM0Q7CgkJcHJlY2lzaW9uICR7cGFyYW1ldGVycy5wcmVjaXNpb259IHNhbXBsZXIyREFycmF5OwoJCXByZWNpc2lvbiAke3BhcmFtZXRlcnMucHJlY2lzaW9ufSBzYW1wbGVyMkRTaGFkb3c7CgkJcHJlY2lzaW9uICR7cGFyYW1ldGVycy5wcmVjaXNpb259IHNhbXBsZXJDdWJlU2hhZG93OwoJCXByZWNpc2lvbiAke3BhcmFtZXRlcnMucHJlY2lzaW9ufSBzYW1wbGVyMkRBcnJheVNoYWRvdzsKCQlwcmVjaXNpb24gJHtwYXJhbWV0ZXJzLnByZWNpc2lvbn0gaXNhbXBsZXIyRDsKCQlwcmVjaXNpb24gJHtwYXJhbWV0ZXJzLnByZWNpc2lvbn0gaXNhbXBsZXIzRDsKCQlwcmVjaXNpb24gJHtwYXJhbWV0ZXJzLnByZWNpc2lvbn0gaXNhbXBsZXJDdWJlOwoJCXByZWNpc2lvbiAke3BhcmFtZXRlcnMucHJlY2lzaW9ufSBpc2FtcGxlcjJEQXJyYXk7CgkJcHJlY2lzaW9uICR7cGFyYW1ldGVycy5wcmVjaXNpb259IHVzYW1wbGVyMkQ7CgkJcHJlY2lzaW9uICR7cGFyYW1ldGVycy5wcmVjaXNpb259IHVzYW1wbGVyM0Q7CgkJcHJlY2lzaW9uICR7cGFyYW1ldGVycy5wcmVjaXNpb259IHVzYW1wbGVyQ3ViZTsKCQlwcmVjaXNpb24gJHtwYXJhbWV0ZXJzLnByZWNpc2lvbn0gdXNhbXBsZXIyREFycmF5OwoJCWA7CgoJfQoKCWlmICggcGFyYW1ldGVycy5wcmVjaXNpb24gPT09ICdoaWdocCcgKSB7CgoJCXByZWNpc2lvbnN0cmluZyArPSAnXG4jZGVmaW5lIEhJR0hfUFJFQ0lTSU9OJzsKCgl9IGVsc2UgaWYgKCBwYXJhbWV0ZXJzLnByZWNpc2lvbiA9PT0gJ21lZGl1bXAnICkgewoKCQlwcmVjaXNpb25zdHJpbmcgKz0gJ1xuI2RlZmluZSBNRURJVU1fUFJFQ0lTSU9OJzsKCgl9IGVsc2UgaWYgKCBwYXJhbWV0ZXJzLnByZWNpc2lvbiA9PT0gJ2xvd3AnICkgewoKCQlwcmVjaXNpb25zdHJpbmcgKz0gJ1xuI2RlZmluZSBMT1dfUFJFQ0lTSU9OJzsKCgl9CgoJcmV0dXJuIHByZWNpc2lvbnN0cmluZzsKCn0KCmZ1bmN0aW9uIGdlbmVyYXRlU2hhZG93TWFwVHlwZURlZmluZSggcGFyYW1ldGVycyApIHsKCglsZXQgc2hhZG93TWFwVHlwZURlZmluZSA9ICdTSEFET1dNQVBfVFlQRV9CQVNJQyc7CgoJaWYgKCBwYXJhbWV0ZXJzLnNoYWRvd01hcFR5cGUgPT09IFBDRlNoYWRvd01hcCApIHsKCgkJc2hhZG93TWFwVHlwZURlZmluZSA9ICdTSEFET1dNQVBfVFlQRV9QQ0YnOwoKCX0gZWxzZSBpZiAoIHBhcmFtZXRlcnMuc2hhZG93TWFwVHlwZSA9PT0gUENGU29mdFNoYWRvd01hcCApIHsKCgkJc2hhZG93TWFwVHlwZURlZmluZSA9ICdTSEFET1dNQVBfVFlQRV9QQ0ZfU09GVCc7CgoJfSBlbHNlIGlmICggcGFyYW1ldGVycy5zaGFkb3dNYXBUeXBlID09PSBWU01TaGFkb3dNYXAgKSB7CgoJCXNoYWRvd01hcFR5cGVEZWZpbmUgPSAnU0hBRE9XTUFQX1RZUEVfVlNNJzsKCgl9CgoJcmV0dXJuIHNoYWRvd01hcFR5cGVEZWZpbmU7Cgp9CgpmdW5jdGlvbiBnZW5lcmF0ZUVudk1hcFR5cGVEZWZpbmUoIHBhcmFtZXRlcnMgKSB7CgoJbGV0IGVudk1hcFR5cGVEZWZpbmUgPSAnRU5WTUFQX1RZUEVfQ1VCRSc7CgoJaWYgKCBwYXJhbWV0ZXJzLmVudk1hcCApIHsKCgkJc3dpdGNoICggcGFyYW1ldGVycy5lbnZNYXBNb2RlICkgewoKCQkJY2FzZSBDdWJlUmVmbGVjdGlvbk1hcHBpbmc6CgkJCWNhc2UgQ3ViZVJlZnJhY3Rpb25NYXBwaW5nOgoJCQkJZW52TWFwVHlwZURlZmluZSA9ICdFTlZNQVBfVFlQRV9DVUJFJzsKCQkJCWJyZWFrOwoKCQkJY2FzZSBDdWJlVVZSZWZsZWN0aW9uTWFwcGluZzoKCQkJCWVudk1hcFR5cGVEZWZpbmUgPSAnRU5WTUFQX1RZUEVfQ1VCRV9VVic7CgkJCQlicmVhazsKCgkJfQoKCX0KCglyZXR1cm4gZW52TWFwVHlwZURlZmluZTsKCn0KCmZ1bmN0aW9uIGdlbmVyYXRlRW52TWFwTW9kZURlZmluZSggcGFyYW1ldGVycyApIHsKCglsZXQgZW52TWFwTW9kZURlZmluZSA9ICdFTlZNQVBfTU9ERV9SRUZMRUNUSU9OJzsKCglpZiAoIHBhcmFtZXRlcnMuZW52TWFwICkgewoKCQlzd2l0Y2ggKCBwYXJhbWV0ZXJzLmVudk1hcE1vZGUgKSB7CgoJCQljYXNlIEN1YmVSZWZyYWN0aW9uTWFwcGluZzoKCgkJCQllbnZNYXBNb2RlRGVmaW5lID0gJ0VOVk1BUF9NT0RFX1JFRlJBQ1RJT04nOwoJCQkJYnJlYWs7CgoJCX0KCgl9CgoJcmV0dXJuIGVudk1hcE1vZGVEZWZpbmU7Cgp9CgpmdW5jdGlvbiBnZW5lcmF0ZUVudk1hcEJsZW5kaW5nRGVmaW5lKCBwYXJhbWV0ZXJzICkgewoKCWxldCBlbnZNYXBCbGVuZGluZ0RlZmluZSA9ICdFTlZNQVBfQkxFTkRJTkdfTk9ORSc7CgoJaWYgKCBwYXJhbWV0ZXJzLmVudk1hcCApIHsKCgkJc3dpdGNoICggcGFyYW1ldGVycy5jb21iaW5lICkgewoKCQkJY2FzZSBNdWx0aXBseU9wZXJhdGlvbjoKCQkJCWVudk1hcEJsZW5kaW5nRGVmaW5lID0gJ0VOVk1BUF9CTEVORElOR19NVUxUSVBMWSc7CgkJCQlicmVhazsKCgkJCWNhc2UgTWl4T3BlcmF0aW9uOgoJCQkJZW52TWFwQmxlbmRpbmdEZWZpbmUgPSAnRU5WTUFQX0JMRU5ESU5HX01JWCc7CgkJCQlicmVhazsKCgkJCWNhc2UgQWRkT3BlcmF0aW9uOgoJCQkJZW52TWFwQmxlbmRpbmdEZWZpbmUgPSAnRU5WTUFQX0JMRU5ESU5HX0FERCc7CgkJCQlicmVhazsKCgkJfQoKCX0KCglyZXR1cm4gZW52TWFwQmxlbmRpbmdEZWZpbmU7Cgp9CgpmdW5jdGlvbiBnZW5lcmF0ZUN1YmVVVlNpemUoIHBhcmFtZXRlcnMgKSB7CgoJY29uc3QgaW1hZ2VIZWlnaHQgPSBwYXJhbWV0ZXJzLmVudk1hcEN1YmVVVkhlaWdodDsKCglpZiAoIGltYWdlSGVpZ2h0ID09PSBudWxsICkgcmV0dXJuIG51bGw7CgoJY29uc3QgbWF4TWlwID0gTWF0aC5sb2cyKCBpbWFnZUhlaWdodCApIC0gMjsKCgljb25zdCB0ZXhlbEhlaWdodCA9IDEuMCAvIGltYWdlSGVpZ2h0OwoKCWNvbnN0IHRleGVsV2lkdGggPSAxLjAgLyAoIDMgKiBNYXRoLm1heCggTWF0aC5wb3coIDIsIG1heE1pcCApLCA3ICogMTYgKSApOwoKCXJldHVybiB7IHRleGVsV2lkdGgsIHRleGVsSGVpZ2h0LCBtYXhNaXAgfTsKCn0KCmZ1bmN0aW9uIFdlYkdMUHJvZ3JhbSggcmVuZGVyZXIsIGNhY2hlS2V5LCBwYXJhbWV0ZXJzLCBiaW5kaW5nU3RhdGVzICkgewoKCS8vIFRPRE8gU2VuZCB0aGlzIGV2ZW50IHRvIFRocmVlLmpzIERldlRvb2xzCgkvLyBjb25zb2xlLmxvZyggJ1dlYkdMUHJvZ3JhbScsIGNhY2hlS2V5ICk7CgoJY29uc3QgZ2wgPSByZW5kZXJlci5nZXRDb250ZXh0KCk7CgoJY29uc3QgZGVmaW5lcyA9IHBhcmFtZXRlcnMuZGVmaW5lczsKCglsZXQgdmVydGV4U2hhZGVyID0gcGFyYW1ldGVycy52ZXJ0ZXhTaGFkZXI7CglsZXQgZnJhZ21lbnRTaGFkZXIgPSBwYXJhbWV0ZXJzLmZyYWdtZW50U2hhZGVyOwoKCWNvbnN0IHNoYWRvd01hcFR5cGVEZWZpbmUgPSBnZW5lcmF0ZVNoYWRvd01hcFR5cGVEZWZpbmUoIHBhcmFtZXRlcnMgKTsKCWNvbnN0IGVudk1hcFR5cGVEZWZpbmUgPSBnZW5lcmF0ZUVudk1hcFR5cGVEZWZpbmUoIHBhcmFtZXRlcnMgKTsKCWNvbnN0IGVudk1hcE1vZGVEZWZpbmUgPSBnZW5lcmF0ZUVudk1hcE1vZGVEZWZpbmUoIHBhcmFtZXRlcnMgKTsKCWNvbnN0IGVudk1hcEJsZW5kaW5nRGVmaW5lID0gZ2VuZXJhdGVFbnZNYXBCbGVuZGluZ0RlZmluZSggcGFyYW1ldGVycyApOwoJY29uc3QgZW52TWFwQ3ViZVVWU2l6ZSA9IGdlbmVyYXRlQ3ViZVVWU2l6ZSggcGFyYW1ldGVycyApOwoKCWNvbnN0IGN1c3RvbUV4dGVuc2lvbnMgPSBwYXJhbWV0ZXJzLmlzV2ViR0wyID8gJycgOiBnZW5lcmF0ZUV4dGVuc2lvbnMoIHBhcmFtZXRlcnMgKTsKCgljb25zdCBjdXN0b21WZXJ0ZXhFeHRlbnNpb25zID0gZ2VuZXJhdGVWZXJ0ZXhFeHRlbnNpb25zKCBwYXJhbWV0ZXJzICk7CgoJY29uc3QgY3VzdG9tRGVmaW5lcyA9IGdlbmVyYXRlRGVmaW5lcyggZGVmaW5lcyApOwoKCWNvbnN0IHByb2dyYW0gPSBnbC5jcmVhdGVQcm9ncmFtKCk7CgoJbGV0IHByZWZpeFZlcnRleCwgcHJlZml4RnJhZ21lbnQ7CglsZXQgdmVyc2lvblN0cmluZyA9IHBhcmFtZXRlcnMuZ2xzbFZlcnNpb24gPyAnI3ZlcnNpb24gJyArIHBhcmFtZXRlcnMuZ2xzbFZlcnNpb24gKyAnXG4nIDogJyc7CgoJaWYgKCBwYXJhbWV0ZXJzLmlzUmF3U2hhZGVyTWF0ZXJpYWwgKSB7CgoJCXByZWZpeFZlcnRleCA9IFsKCgkJCScjZGVmaW5lIFNIQURFUl9UWVBFICcgKyBwYXJhbWV0ZXJzLnNoYWRlclR5cGUsCgkJCScjZGVmaW5lIFNIQURFUl9OQU1FICcgKyBwYXJhbWV0ZXJzLnNoYWRlck5hbWUsCgoJCQljdXN0b21EZWZpbmVzCgoJCV0uZmlsdGVyKCBmaWx0ZXJFbXB0eUxpbmUgKS5qb2luKCAnXG4nICk7CgoJCWlmICggcHJlZml4VmVydGV4Lmxlbmd0aCA+IDAgKSB7CgoJCQlwcmVmaXhWZXJ0ZXggKz0gJ1xuJzsKCgkJfQoKCQlwcmVmaXhGcmFnbWVudCA9IFsKCgkJCWN1c3RvbUV4dGVuc2lvbnMsCgoJCQknI2RlZmluZSBTSEFERVJfVFlQRSAnICsgcGFyYW1ldGVycy5zaGFkZXJUeXBlLAoJCQknI2RlZmluZSBTSEFERVJfTkFNRSAnICsgcGFyYW1ldGVycy5zaGFkZXJOYW1lLAoKCQkJY3VzdG9tRGVmaW5lcwoKCQldLmZpbHRlciggZmlsdGVyRW1wdHlMaW5lICkuam9pbiggJ1xuJyApOwoKCQlpZiAoIHByZWZpeEZyYWdtZW50Lmxlbmd0aCA+IDAgKSB7CgoJCQlwcmVmaXhGcmFnbWVudCArPSAnXG4nOwoKCQl9CgoJfSBlbHNlIHsKCgkJcHJlZml4VmVydGV4ID0gWwoKCQkJZ2VuZXJhdGVQcmVjaXNpb24oIHBhcmFtZXRlcnMgKSwKCgkJCScjZGVmaW5lIFNIQURFUl9UWVBFICcgKyBwYXJhbWV0ZXJzLnNoYWRlclR5cGUsCgkJCScjZGVmaW5lIFNIQURFUl9OQU1FICcgKyBwYXJhbWV0ZXJzLnNoYWRlck5hbWUsCgoJCQljdXN0b21EZWZpbmVzLAoKCQkJcGFyYW1ldGVycy5leHRlbnNpb25DbGlwQ3VsbERpc3RhbmNlID8gJyNkZWZpbmUgVVNFX0NMSVBfRElTVEFOQ0UnIDogJycsCgkJCXBhcmFtZXRlcnMuYmF0Y2hpbmcgPyAnI2RlZmluZSBVU0VfQkFUQ0hJTkcnIDogJycsCgkJCXBhcmFtZXRlcnMuaW5zdGFuY2luZyA/ICcjZGVmaW5lIFVTRV9JTlNUQU5DSU5HJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmluc3RhbmNpbmdDb2xvciA/ICcjZGVmaW5lIFVTRV9JTlNUQU5DSU5HX0NPTE9SJyA6ICcnLAoKCQkJcGFyYW1ldGVycy51c2VGb2cgJiYgcGFyYW1ldGVycy5mb2cgPyAnI2RlZmluZSBVU0VfRk9HJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLnVzZUZvZyAmJiBwYXJhbWV0ZXJzLmZvZ0V4cDIgPyAnI2RlZmluZSBGT0dfRVhQMicgOiAnJywKCgkJCXBhcmFtZXRlcnMubWFwID8gJyNkZWZpbmUgVVNFX01BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5lbnZNYXAgPyAnI2RlZmluZSBVU0VfRU5WTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmVudk1hcCA/ICcjZGVmaW5lICcgKyBlbnZNYXBNb2RlRGVmaW5lIDogJycsCgkJCXBhcmFtZXRlcnMubGlnaHRNYXAgPyAnI2RlZmluZSBVU0VfTElHSFRNQVAnIDogJycsCgkJCXBhcmFtZXRlcnMuYW9NYXAgPyAnI2RlZmluZSBVU0VfQU9NQVAnIDogJycsCgkJCXBhcmFtZXRlcnMuYnVtcE1hcCA/ICcjZGVmaW5lIFVTRV9CVU1QTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLm5vcm1hbE1hcCA/ICcjZGVmaW5lIFVTRV9OT1JNQUxNQVAnIDogJycsCgkJCXBhcmFtZXRlcnMubm9ybWFsTWFwT2JqZWN0U3BhY2UgPyAnI2RlZmluZSBVU0VfTk9STUFMTUFQX09CSkVDVFNQQUNFJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLm5vcm1hbE1hcFRhbmdlbnRTcGFjZSA/ICcjZGVmaW5lIFVTRV9OT1JNQUxNQVBfVEFOR0VOVFNQQUNFJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmRpc3BsYWNlbWVudE1hcCA/ICcjZGVmaW5lIFVTRV9ESVNQTEFDRU1FTlRNQVAnIDogJycsCgkJCXBhcmFtZXRlcnMuZW1pc3NpdmVNYXAgPyAnI2RlZmluZSBVU0VfRU1JU1NJVkVNQVAnIDogJycsCgoJCQlwYXJhbWV0ZXJzLmFuaXNvdHJvcHkgPyAnI2RlZmluZSBVU0VfQU5JU09UUk9QWScgOiAnJywKCQkJcGFyYW1ldGVycy5hbmlzb3Ryb3B5TWFwID8gJyNkZWZpbmUgVVNFX0FOSVNPVFJPUFlNQVAnIDogJycsCgoJCQlwYXJhbWV0ZXJzLmNsZWFyY29hdE1hcCA/ICcjZGVmaW5lIFVTRV9DTEVBUkNPQVRNQVAnIDogJycsCgkJCXBhcmFtZXRlcnMuY2xlYXJjb2F0Um91Z2huZXNzTWFwID8gJyNkZWZpbmUgVVNFX0NMRUFSQ09BVF9ST1VHSE5FU1NNQVAnIDogJycsCgkJCXBhcmFtZXRlcnMuY2xlYXJjb2F0Tm9ybWFsTWFwID8gJyNkZWZpbmUgVVNFX0NMRUFSQ09BVF9OT1JNQUxNQVAnIDogJycsCgoJCQlwYXJhbWV0ZXJzLmlyaWRlc2NlbmNlTWFwID8gJyNkZWZpbmUgVVNFX0lSSURFU0NFTkNFTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwID8gJyNkZWZpbmUgVVNFX0lSSURFU0NFTkNFX1RISUNLTkVTU01BUCcgOiAnJywKCgkJCXBhcmFtZXRlcnMuc3BlY3VsYXJNYXAgPyAnI2RlZmluZSBVU0VfU1BFQ1VMQVJNQVAnIDogJycsCgkJCXBhcmFtZXRlcnMuc3BlY3VsYXJDb2xvck1hcCA/ICcjZGVmaW5lIFVTRV9TUEVDVUxBUl9DT0xPUk1BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5zcGVjdWxhckludGVuc2l0eU1hcCA/ICcjZGVmaW5lIFVTRV9TUEVDVUxBUl9JTlRFTlNJVFlNQVAnIDogJycsCgoJCQlwYXJhbWV0ZXJzLnJvdWdobmVzc01hcCA/ICcjZGVmaW5lIFVTRV9ST1VHSE5FU1NNQVAnIDogJycsCgkJCXBhcmFtZXRlcnMubWV0YWxuZXNzTWFwID8gJyNkZWZpbmUgVVNFX01FVEFMTkVTU01BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5hbHBoYU1hcCA/ICcjZGVmaW5lIFVTRV9BTFBIQU1BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5hbHBoYUhhc2ggPyAnI2RlZmluZSBVU0VfQUxQSEFIQVNIJyA6ICcnLAoKCQkJcGFyYW1ldGVycy50cmFuc21pc3Npb24gPyAnI2RlZmluZSBVU0VfVFJBTlNNSVNTSU9OJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLnRyYW5zbWlzc2lvbk1hcCA/ICcjZGVmaW5lIFVTRV9UUkFOU01JU1NJT05NQVAnIDogJycsCgkJCXBhcmFtZXRlcnMudGhpY2tuZXNzTWFwID8gJyNkZWZpbmUgVVNFX1RISUNLTkVTU01BUCcgOiAnJywKCgkJCXBhcmFtZXRlcnMuc2hlZW5Db2xvck1hcCA/ICcjZGVmaW5lIFVTRV9TSEVFTl9DT0xPUk1BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5zaGVlblJvdWdobmVzc01hcCA/ICcjZGVmaW5lIFVTRV9TSEVFTl9ST1VHSE5FU1NNQVAnIDogJycsCgoJCQkvLwoKCQkJcGFyYW1ldGVycy5tYXBVdiA/ICcjZGVmaW5lIE1BUF9VViAnICsgcGFyYW1ldGVycy5tYXBVdiA6ICcnLAoJCQlwYXJhbWV0ZXJzLmFscGhhTWFwVXYgPyAnI2RlZmluZSBBTFBIQU1BUF9VViAnICsgcGFyYW1ldGVycy5hbHBoYU1hcFV2IDogJycsCgkJCXBhcmFtZXRlcnMubGlnaHRNYXBVdiA/ICcjZGVmaW5lIExJR0hUTUFQX1VWICcgKyBwYXJhbWV0ZXJzLmxpZ2h0TWFwVXYgOiAnJywKCQkJcGFyYW1ldGVycy5hb01hcFV2ID8gJyNkZWZpbmUgQU9NQVBfVVYgJyArIHBhcmFtZXRlcnMuYW9NYXBVdiA6ICcnLAoJCQlwYXJhbWV0ZXJzLmVtaXNzaXZlTWFwVXYgPyAnI2RlZmluZSBFTUlTU0lWRU1BUF9VViAnICsgcGFyYW1ldGVycy5lbWlzc2l2ZU1hcFV2IDogJycsCgkJCXBhcmFtZXRlcnMuYnVtcE1hcFV2ID8gJyNkZWZpbmUgQlVNUE1BUF9VViAnICsgcGFyYW1ldGVycy5idW1wTWFwVXYgOiAnJywKCQkJcGFyYW1ldGVycy5ub3JtYWxNYXBVdiA/ICcjZGVmaW5lIE5PUk1BTE1BUF9VViAnICsgcGFyYW1ldGVycy5ub3JtYWxNYXBVdiA6ICcnLAoJCQlwYXJhbWV0ZXJzLmRpc3BsYWNlbWVudE1hcFV2ID8gJyNkZWZpbmUgRElTUExBQ0VNRU5UTUFQX1VWICcgKyBwYXJhbWV0ZXJzLmRpc3BsYWNlbWVudE1hcFV2IDogJycsCgoJCQlwYXJhbWV0ZXJzLm1ldGFsbmVzc01hcFV2ID8gJyNkZWZpbmUgTUVUQUxORVNTTUFQX1VWICcgKyBwYXJhbWV0ZXJzLm1ldGFsbmVzc01hcFV2IDogJycsCgkJCXBhcmFtZXRlcnMucm91Z2huZXNzTWFwVXYgPyAnI2RlZmluZSBST1VHSE5FU1NNQVBfVVYgJyArIHBhcmFtZXRlcnMucm91Z2huZXNzTWFwVXYgOiAnJywKCgkJCXBhcmFtZXRlcnMuYW5pc290cm9weU1hcFV2ID8gJyNkZWZpbmUgQU5JU09UUk9QWU1BUF9VViAnICsgcGFyYW1ldGVycy5hbmlzb3Ryb3B5TWFwVXYgOiAnJywKCgkJCXBhcmFtZXRlcnMuY2xlYXJjb2F0TWFwVXYgPyAnI2RlZmluZSBDTEVBUkNPQVRNQVBfVVYgJyArIHBhcmFtZXRlcnMuY2xlYXJjb2F0TWFwVXYgOiAnJywKCQkJcGFyYW1ldGVycy5jbGVhcmNvYXROb3JtYWxNYXBVdiA/ICcjZGVmaW5lIENMRUFSQ09BVF9OT1JNQUxNQVBfVVYgJyArIHBhcmFtZXRlcnMuY2xlYXJjb2F0Tm9ybWFsTWFwVXYgOiAnJywKCQkJcGFyYW1ldGVycy5jbGVhcmNvYXRSb3VnaG5lc3NNYXBVdiA/ICcjZGVmaW5lIENMRUFSQ09BVF9ST1VHSE5FU1NNQVBfVVYgJyArIHBhcmFtZXRlcnMuY2xlYXJjb2F0Um91Z2huZXNzTWFwVXYgOiAnJywKCgkJCXBhcmFtZXRlcnMuaXJpZGVzY2VuY2VNYXBVdiA/ICcjZGVmaW5lIElSSURFU0NFTkNFTUFQX1VWICcgKyBwYXJhbWV0ZXJzLmlyaWRlc2NlbmNlTWFwVXYgOiAnJywKCQkJcGFyYW1ldGVycy5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcFV2ID8gJyNkZWZpbmUgSVJJREVTQ0VOQ0VfVEhJQ0tORVNTTUFQX1VWICcgKyBwYXJhbWV0ZXJzLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwVXYgOiAnJywKCgkJCXBhcmFtZXRlcnMuc2hlZW5Db2xvck1hcFV2ID8gJyNkZWZpbmUgU0hFRU5fQ09MT1JNQVBfVVYgJyArIHBhcmFtZXRlcnMuc2hlZW5Db2xvck1hcFV2IDogJycsCgkJCXBhcmFtZXRlcnMuc2hlZW5Sb3VnaG5lc3NNYXBVdiA/ICcjZGVmaW5lIFNIRUVOX1JPVUdITkVTU01BUF9VViAnICsgcGFyYW1ldGVycy5zaGVlblJvdWdobmVzc01hcFV2IDogJycsCgoJCQlwYXJhbWV0ZXJzLnNwZWN1bGFyTWFwVXYgPyAnI2RlZmluZSBTUEVDVUxBUk1BUF9VViAnICsgcGFyYW1ldGVycy5zcGVjdWxhck1hcFV2IDogJycsCgkJCXBhcmFtZXRlcnMuc3BlY3VsYXJDb2xvck1hcFV2ID8gJyNkZWZpbmUgU1BFQ1VMQVJfQ09MT1JNQVBfVVYgJyArIHBhcmFtZXRlcnMuc3BlY3VsYXJDb2xvck1hcFV2IDogJycsCgkJCXBhcmFtZXRlcnMuc3BlY3VsYXJJbnRlbnNpdHlNYXBVdiA/ICcjZGVmaW5lIFNQRUNVTEFSX0lOVEVOU0lUWU1BUF9VViAnICsgcGFyYW1ldGVycy5zcGVjdWxhckludGVuc2l0eU1hcFV2IDogJycsCgoJCQlwYXJhbWV0ZXJzLnRyYW5zbWlzc2lvbk1hcFV2ID8gJyNkZWZpbmUgVFJBTlNNSVNTSU9OTUFQX1VWICcgKyBwYXJhbWV0ZXJzLnRyYW5zbWlzc2lvbk1hcFV2IDogJycsCgkJCXBhcmFtZXRlcnMudGhpY2tuZXNzTWFwVXYgPyAnI2RlZmluZSBUSElDS05FU1NNQVBfVVYgJyArIHBhcmFtZXRlcnMudGhpY2tuZXNzTWFwVXYgOiAnJywKCgkJCS8vCgoJCQlwYXJhbWV0ZXJzLnZlcnRleFRhbmdlbnRzICYmIHBhcmFtZXRlcnMuZmxhdFNoYWRpbmcgPT09IGZhbHNlID8gJyNkZWZpbmUgVVNFX1RBTkdFTlQnIDogJycsCgkJCXBhcmFtZXRlcnMudmVydGV4Q29sb3JzID8gJyNkZWZpbmUgVVNFX0NPTE9SJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLnZlcnRleEFscGhhcyA/ICcjZGVmaW5lIFVTRV9DT0xPUl9BTFBIQScgOiAnJywKCQkJcGFyYW1ldGVycy52ZXJ0ZXhVdjFzID8gJyNkZWZpbmUgVVNFX1VWMScgOiAnJywKCQkJcGFyYW1ldGVycy52ZXJ0ZXhVdjJzID8gJyNkZWZpbmUgVVNFX1VWMicgOiAnJywKCQkJcGFyYW1ldGVycy52ZXJ0ZXhVdjNzID8gJyNkZWZpbmUgVVNFX1VWMycgOiAnJywKCgkJCXBhcmFtZXRlcnMucG9pbnRzVXZzID8gJyNkZWZpbmUgVVNFX1BPSU5UU19VVicgOiAnJywKCgkJCXBhcmFtZXRlcnMuZmxhdFNoYWRpbmcgPyAnI2RlZmluZSBGTEFUX1NIQURFRCcgOiAnJywKCgkJCXBhcmFtZXRlcnMuc2tpbm5pbmcgPyAnI2RlZmluZSBVU0VfU0tJTk5JTkcnIDogJycsCgoJCQlwYXJhbWV0ZXJzLm1vcnBoVGFyZ2V0cyA/ICcjZGVmaW5lIFVTRV9NT1JQSFRBUkdFVFMnIDogJycsCgkJCXBhcmFtZXRlcnMubW9ycGhOb3JtYWxzICYmIHBhcmFtZXRlcnMuZmxhdFNoYWRpbmcgPT09IGZhbHNlID8gJyNkZWZpbmUgVVNFX01PUlBITk9STUFMUycgOiAnJywKCQkJKCBwYXJhbWV0ZXJzLm1vcnBoQ29sb3JzICYmIHBhcmFtZXRlcnMuaXNXZWJHTDIgKSA/ICcjZGVmaW5lIFVTRV9NT1JQSENPTE9SUycgOiAnJywKCQkJKCBwYXJhbWV0ZXJzLm1vcnBoVGFyZ2V0c0NvdW50ID4gMCAmJiBwYXJhbWV0ZXJzLmlzV2ViR0wyICkgPyAnI2RlZmluZSBNT1JQSFRBUkdFVFNfVEVYVFVSRScgOiAnJywKCQkJKCBwYXJhbWV0ZXJzLm1vcnBoVGFyZ2V0c0NvdW50ID4gMCAmJiBwYXJhbWV0ZXJzLmlzV2ViR0wyICkgPyAnI2RlZmluZSBNT1JQSFRBUkdFVFNfVEVYVFVSRV9TVFJJREUgJyArIHBhcmFtZXRlcnMubW9ycGhUZXh0dXJlU3RyaWRlIDogJycsCgkJCSggcGFyYW1ldGVycy5tb3JwaFRhcmdldHNDb3VudCA+IDAgJiYgcGFyYW1ldGVycy5pc1dlYkdMMiApID8gJyNkZWZpbmUgTU9SUEhUQVJHRVRTX0NPVU5UICcgKyBwYXJhbWV0ZXJzLm1vcnBoVGFyZ2V0c0NvdW50IDogJycsCgkJCXBhcmFtZXRlcnMuZG91YmxlU2lkZWQgPyAnI2RlZmluZSBET1VCTEVfU0lERUQnIDogJycsCgkJCXBhcmFtZXRlcnMuZmxpcFNpZGVkID8gJyNkZWZpbmUgRkxJUF9TSURFRCcgOiAnJywKCgkJCXBhcmFtZXRlcnMuc2hhZG93TWFwRW5hYmxlZCA/ICcjZGVmaW5lIFVTRV9TSEFET1dNQVAnIDogJycsCgkJCXBhcmFtZXRlcnMuc2hhZG93TWFwRW5hYmxlZCA/ICcjZGVmaW5lICcgKyBzaGFkb3dNYXBUeXBlRGVmaW5lIDogJycsCgoJCQlwYXJhbWV0ZXJzLnNpemVBdHRlbnVhdGlvbiA/ICcjZGVmaW5lIFVTRV9TSVpFQVRURU5VQVRJT04nIDogJycsCgoJCQlwYXJhbWV0ZXJzLm51bUxpZ2h0UHJvYmVzID4gMCA/ICcjZGVmaW5lIFVTRV9MSUdIVF9QUk9CRVMnIDogJycsCgoJCQlwYXJhbWV0ZXJzLnVzZUxlZ2FjeUxpZ2h0cyA/ICcjZGVmaW5lIExFR0FDWV9MSUdIVFMnIDogJycsCgoJCQlwYXJhbWV0ZXJzLmxvZ2FyaXRobWljRGVwdGhCdWZmZXIgPyAnI2RlZmluZSBVU0VfTE9HREVQVEhCVUYnIDogJycsCgkJCSggcGFyYW1ldGVycy5sb2dhcml0aG1pY0RlcHRoQnVmZmVyICYmIHBhcmFtZXRlcnMucmVuZGVyZXJFeHRlbnNpb25GcmFnRGVwdGggKSA/ICcjZGVmaW5lIFVTRV9MT0dERVBUSEJVRl9FWFQnIDogJycsCgoJCQkndW5pZm9ybSBtYXQ0IG1vZGVsTWF0cml4OycsCgkJCSd1bmlmb3JtIG1hdDQgbW9kZWxWaWV3TWF0cml4OycsCgkJCSd1bmlmb3JtIG1hdDQgcHJvamVjdGlvbk1hdHJpeDsnLAoJCQkndW5pZm9ybSBtYXQ0IHZpZXdNYXRyaXg7JywKCQkJJ3VuaWZvcm0gbWF0MyBub3JtYWxNYXRyaXg7JywKCQkJJ3VuaWZvcm0gdmVjMyBjYW1lcmFQb3NpdGlvbjsnLAoJCQkndW5pZm9ybSBib29sIGlzT3J0aG9ncmFwaGljOycsCgoJCQknI2lmZGVmIFVTRV9JTlNUQU5DSU5HJywKCgkJCScJYXR0cmlidXRlIG1hdDQgaW5zdGFuY2VNYXRyaXg7JywKCgkJCScjZW5kaWYnLAoKCQkJJyNpZmRlZiBVU0VfSU5TVEFOQ0lOR19DT0xPUicsCgoJCQknCWF0dHJpYnV0ZSB2ZWMzIGluc3RhbmNlQ29sb3I7JywKCgkJCScjZW5kaWYnLAoKCQkJJ2F0dHJpYnV0ZSB2ZWMzIHBvc2l0aW9uOycsCgkJCSdhdHRyaWJ1dGUgdmVjMyBub3JtYWw7JywKCQkJJ2F0dHJpYnV0ZSB2ZWMyIHV2OycsCgoJCQknI2lmZGVmIFVTRV9VVjEnLAoKCQkJJwlhdHRyaWJ1dGUgdmVjMiB1djE7JywKCgkJCScjZW5kaWYnLAoKCQkJJyNpZmRlZiBVU0VfVVYyJywKCgkJCScJYXR0cmlidXRlIHZlYzIgdXYyOycsCgoJCQknI2VuZGlmJywKCgkJCScjaWZkZWYgVVNFX1VWMycsCgoJCQknCWF0dHJpYnV0ZSB2ZWMyIHV2MzsnLAoKCQkJJyNlbmRpZicsCgoJCQknI2lmZGVmIFVTRV9UQU5HRU5UJywKCgkJCScJYXR0cmlidXRlIHZlYzQgdGFuZ2VudDsnLAoKCQkJJyNlbmRpZicsCgoJCQknI2lmIGRlZmluZWQoIFVTRV9DT0xPUl9BTFBIQSApJywKCgkJCScJYXR0cmlidXRlIHZlYzQgY29sb3I7JywKCgkJCScjZWxpZiBkZWZpbmVkKCBVU0VfQ09MT1IgKScsCgoJCQknCWF0dHJpYnV0ZSB2ZWMzIGNvbG9yOycsCgoJCQknI2VuZGlmJywKCgkJCScjaWYgKCBkZWZpbmVkKCBVU0VfTU9SUEhUQVJHRVRTICkgJiYgISBkZWZpbmVkKCBNT1JQSFRBUkdFVFNfVEVYVFVSRSApICknLAoKCQkJJwlhdHRyaWJ1dGUgdmVjMyBtb3JwaFRhcmdldDA7JywKCQkJJwlhdHRyaWJ1dGUgdmVjMyBtb3JwaFRhcmdldDE7JywKCQkJJwlhdHRyaWJ1dGUgdmVjMyBtb3JwaFRhcmdldDI7JywKCQkJJwlhdHRyaWJ1dGUgdmVjMyBtb3JwaFRhcmdldDM7JywKCgkJCScJI2lmZGVmIFVTRV9NT1JQSE5PUk1BTFMnLAoKCQkJJwkJYXR0cmlidXRlIHZlYzMgbW9ycGhOb3JtYWwwOycsCgkJCScJCWF0dHJpYnV0ZSB2ZWMzIG1vcnBoTm9ybWFsMTsnLAoJCQknCQlhdHRyaWJ1dGUgdmVjMyBtb3JwaE5vcm1hbDI7JywKCQkJJwkJYXR0cmlidXRlIHZlYzMgbW9ycGhOb3JtYWwzOycsCgoJCQknCSNlbHNlJywKCgkJCScJCWF0dHJpYnV0ZSB2ZWMzIG1vcnBoVGFyZ2V0NDsnLAoJCQknCQlhdHRyaWJ1dGUgdmVjMyBtb3JwaFRhcmdldDU7JywKCQkJJwkJYXR0cmlidXRlIHZlYzMgbW9ycGhUYXJnZXQ2OycsCgkJCScJCWF0dHJpYnV0ZSB2ZWMzIG1vcnBoVGFyZ2V0NzsnLAoKCQkJJwkjZW5kaWYnLAoKCQkJJyNlbmRpZicsCgoJCQknI2lmZGVmIFVTRV9TS0lOTklORycsCgoJCQknCWF0dHJpYnV0ZSB2ZWM0IHNraW5JbmRleDsnLAoJCQknCWF0dHJpYnV0ZSB2ZWM0IHNraW5XZWlnaHQ7JywKCgkJCScjZW5kaWYnLAoKCQkJJ1xuJwoKCQldLmZpbHRlciggZmlsdGVyRW1wdHlMaW5lICkuam9pbiggJ1xuJyApOwoKCQlwcmVmaXhGcmFnbWVudCA9IFsKCgkJCWN1c3RvbUV4dGVuc2lvbnMsCgoJCQlnZW5lcmF0ZVByZWNpc2lvbiggcGFyYW1ldGVycyApLAoKCQkJJyNkZWZpbmUgU0hBREVSX1RZUEUgJyArIHBhcmFtZXRlcnMuc2hhZGVyVHlwZSwKCQkJJyNkZWZpbmUgU0hBREVSX05BTUUgJyArIHBhcmFtZXRlcnMuc2hhZGVyTmFtZSwKCgkJCWN1c3RvbURlZmluZXMsCgoJCQlwYXJhbWV0ZXJzLnVzZUZvZyAmJiBwYXJhbWV0ZXJzLmZvZyA/ICcjZGVmaW5lIFVTRV9GT0cnIDogJycsCgkJCXBhcmFtZXRlcnMudXNlRm9nICYmIHBhcmFtZXRlcnMuZm9nRXhwMiA/ICcjZGVmaW5lIEZPR19FWFAyJyA6ICcnLAoKCQkJcGFyYW1ldGVycy5hbHBoYVRvQ292ZXJhZ2UgPyAnI2RlZmluZSBBTFBIQV9UT19DT1ZFUkFHRScgOiAnJywKCQkJcGFyYW1ldGVycy5tYXAgPyAnI2RlZmluZSBVU0VfTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLm1hdGNhcCA/ICcjZGVmaW5lIFVTRV9NQVRDQVAnIDogJycsCgkJCXBhcmFtZXRlcnMuZW52TWFwID8gJyNkZWZpbmUgVVNFX0VOVk1BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5lbnZNYXAgPyAnI2RlZmluZSAnICsgZW52TWFwVHlwZURlZmluZSA6ICcnLAoJCQlwYXJhbWV0ZXJzLmVudk1hcCA/ICcjZGVmaW5lICcgKyBlbnZNYXBNb2RlRGVmaW5lIDogJycsCgkJCXBhcmFtZXRlcnMuZW52TWFwID8gJyNkZWZpbmUgJyArIGVudk1hcEJsZW5kaW5nRGVmaW5lIDogJycsCgkJCWVudk1hcEN1YmVVVlNpemUgPyAnI2RlZmluZSBDVUJFVVZfVEVYRUxfV0lEVEggJyArIGVudk1hcEN1YmVVVlNpemUudGV4ZWxXaWR0aCA6ICcnLAoJCQllbnZNYXBDdWJlVVZTaXplID8gJyNkZWZpbmUgQ1VCRVVWX1RFWEVMX0hFSUdIVCAnICsgZW52TWFwQ3ViZVVWU2l6ZS50ZXhlbEhlaWdodCA6ICcnLAoJCQllbnZNYXBDdWJlVVZTaXplID8gJyNkZWZpbmUgQ1VCRVVWX01BWF9NSVAgJyArIGVudk1hcEN1YmVVVlNpemUubWF4TWlwICsgJy4wJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmxpZ2h0TWFwID8gJyNkZWZpbmUgVVNFX0xJR0hUTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmFvTWFwID8gJyNkZWZpbmUgVVNFX0FPTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmJ1bXBNYXAgPyAnI2RlZmluZSBVU0VfQlVNUE1BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5ub3JtYWxNYXAgPyAnI2RlZmluZSBVU0VfTk9STUFMTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLm5vcm1hbE1hcE9iamVjdFNwYWNlID8gJyNkZWZpbmUgVVNFX05PUk1BTE1BUF9PQkpFQ1RTUEFDRScgOiAnJywKCQkJcGFyYW1ldGVycy5ub3JtYWxNYXBUYW5nZW50U3BhY2UgPyAnI2RlZmluZSBVU0VfTk9STUFMTUFQX1RBTkdFTlRTUEFDRScgOiAnJywKCQkJcGFyYW1ldGVycy5lbWlzc2l2ZU1hcCA/ICcjZGVmaW5lIFVTRV9FTUlTU0lWRU1BUCcgOiAnJywKCgkJCXBhcmFtZXRlcnMuYW5pc290cm9weSA/ICcjZGVmaW5lIFVTRV9BTklTT1RST1BZJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmFuaXNvdHJvcHlNYXAgPyAnI2RlZmluZSBVU0VfQU5JU09UUk9QWU1BUCcgOiAnJywKCgkJCXBhcmFtZXRlcnMuY2xlYXJjb2F0ID8gJyNkZWZpbmUgVVNFX0NMRUFSQ09BVCcgOiAnJywKCQkJcGFyYW1ldGVycy5jbGVhcmNvYXRNYXAgPyAnI2RlZmluZSBVU0VfQ0xFQVJDT0FUTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmNsZWFyY29hdFJvdWdobmVzc01hcCA/ICcjZGVmaW5lIFVTRV9DTEVBUkNPQVRfUk9VR0hORVNTTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmNsZWFyY29hdE5vcm1hbE1hcCA/ICcjZGVmaW5lIFVTRV9DTEVBUkNPQVRfTk9STUFMTUFQJyA6ICcnLAoKCQkJcGFyYW1ldGVycy5pcmlkZXNjZW5jZSA/ICcjZGVmaW5lIFVTRV9JUklERVNDRU5DRScgOiAnJywKCQkJcGFyYW1ldGVycy5pcmlkZXNjZW5jZU1hcCA/ICcjZGVmaW5lIFVTRV9JUklERVNDRU5DRU1BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCA/ICcjZGVmaW5lIFVTRV9JUklERVNDRU5DRV9USElDS05FU1NNQVAnIDogJycsCgoJCQlwYXJhbWV0ZXJzLnNwZWN1bGFyTWFwID8gJyNkZWZpbmUgVVNFX1NQRUNVTEFSTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLnNwZWN1bGFyQ29sb3JNYXAgPyAnI2RlZmluZSBVU0VfU1BFQ1VMQVJfQ09MT1JNQVAnIDogJycsCgkJCXBhcmFtZXRlcnMuc3BlY3VsYXJJbnRlbnNpdHlNYXAgPyAnI2RlZmluZSBVU0VfU1BFQ1VMQVJfSU5URU5TSVRZTUFQJyA6ICcnLAoKCQkJcGFyYW1ldGVycy5yb3VnaG5lc3NNYXAgPyAnI2RlZmluZSBVU0VfUk9VR0hORVNTTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLm1ldGFsbmVzc01hcCA/ICcjZGVmaW5lIFVTRV9NRVRBTE5FU1NNQVAnIDogJycsCgoJCQlwYXJhbWV0ZXJzLmFscGhhTWFwID8gJyNkZWZpbmUgVVNFX0FMUEhBTUFQJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLmFscGhhVGVzdCA/ICcjZGVmaW5lIFVTRV9BTFBIQVRFU1QnIDogJycsCgkJCXBhcmFtZXRlcnMuYWxwaGFIYXNoID8gJyNkZWZpbmUgVVNFX0FMUEhBSEFTSCcgOiAnJywKCgkJCXBhcmFtZXRlcnMuc2hlZW4gPyAnI2RlZmluZSBVU0VfU0hFRU4nIDogJycsCgkJCXBhcmFtZXRlcnMuc2hlZW5Db2xvck1hcCA/ICcjZGVmaW5lIFVTRV9TSEVFTl9DT0xPUk1BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5zaGVlblJvdWdobmVzc01hcCA/ICcjZGVmaW5lIFVTRV9TSEVFTl9ST1VHSE5FU1NNQVAnIDogJycsCgoJCQlwYXJhbWV0ZXJzLnRyYW5zbWlzc2lvbiA/ICcjZGVmaW5lIFVTRV9UUkFOU01JU1NJT04nIDogJycsCgkJCXBhcmFtZXRlcnMudHJhbnNtaXNzaW9uTWFwID8gJyNkZWZpbmUgVVNFX1RSQU5TTUlTU0lPTk1BUCcgOiAnJywKCQkJcGFyYW1ldGVycy50aGlja25lc3NNYXAgPyAnI2RlZmluZSBVU0VfVEhJQ0tORVNTTUFQJyA6ICcnLAoKCQkJcGFyYW1ldGVycy52ZXJ0ZXhUYW5nZW50cyAmJiBwYXJhbWV0ZXJzLmZsYXRTaGFkaW5nID09PSBmYWxzZSA/ICcjZGVmaW5lIFVTRV9UQU5HRU5UJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLnZlcnRleENvbG9ycyB8fCBwYXJhbWV0ZXJzLmluc3RhbmNpbmdDb2xvciA/ICcjZGVmaW5lIFVTRV9DT0xPUicgOiAnJywKCQkJcGFyYW1ldGVycy52ZXJ0ZXhBbHBoYXMgPyAnI2RlZmluZSBVU0VfQ09MT1JfQUxQSEEnIDogJycsCgkJCXBhcmFtZXRlcnMudmVydGV4VXYxcyA/ICcjZGVmaW5lIFVTRV9VVjEnIDogJycsCgkJCXBhcmFtZXRlcnMudmVydGV4VXYycyA/ICcjZGVmaW5lIFVTRV9VVjInIDogJycsCgkJCXBhcmFtZXRlcnMudmVydGV4VXYzcyA/ICcjZGVmaW5lIFVTRV9VVjMnIDogJycsCgoJCQlwYXJhbWV0ZXJzLnBvaW50c1V2cyA/ICcjZGVmaW5lIFVTRV9QT0lOVFNfVVYnIDogJycsCgoJCQlwYXJhbWV0ZXJzLmdyYWRpZW50TWFwID8gJyNkZWZpbmUgVVNFX0dSQURJRU5UTUFQJyA6ICcnLAoKCQkJcGFyYW1ldGVycy5mbGF0U2hhZGluZyA/ICcjZGVmaW5lIEZMQVRfU0hBREVEJyA6ICcnLAoKCQkJcGFyYW1ldGVycy5kb3VibGVTaWRlZCA/ICcjZGVmaW5lIERPVUJMRV9TSURFRCcgOiAnJywKCQkJcGFyYW1ldGVycy5mbGlwU2lkZWQgPyAnI2RlZmluZSBGTElQX1NJREVEJyA6ICcnLAoKCQkJcGFyYW1ldGVycy5zaGFkb3dNYXBFbmFibGVkID8gJyNkZWZpbmUgVVNFX1NIQURPV01BUCcgOiAnJywKCQkJcGFyYW1ldGVycy5zaGFkb3dNYXBFbmFibGVkID8gJyNkZWZpbmUgJyArIHNoYWRvd01hcFR5cGVEZWZpbmUgOiAnJywKCgkJCXBhcmFtZXRlcnMucHJlbXVsdGlwbGllZEFscGhhID8gJyNkZWZpbmUgUFJFTVVMVElQTElFRF9BTFBIQScgOiAnJywKCgkJCXBhcmFtZXRlcnMubnVtTGlnaHRQcm9iZXMgPiAwID8gJyNkZWZpbmUgVVNFX0xJR0hUX1BST0JFUycgOiAnJywKCgkJCXBhcmFtZXRlcnMudXNlTGVnYWN5TGlnaHRzID8gJyNkZWZpbmUgTEVHQUNZX0xJR0hUUycgOiAnJywKCgkJCXBhcmFtZXRlcnMuZGVjb2RlVmlkZW9UZXh0dXJlID8gJyNkZWZpbmUgREVDT0RFX1ZJREVPX1RFWFRVUkUnIDogJycsCgoJCQlwYXJhbWV0ZXJzLmxvZ2FyaXRobWljRGVwdGhCdWZmZXIgPyAnI2RlZmluZSBVU0VfTE9HREVQVEhCVUYnIDogJycsCgkJCSggcGFyYW1ldGVycy5sb2dhcml0aG1pY0RlcHRoQnVmZmVyICYmIHBhcmFtZXRlcnMucmVuZGVyZXJFeHRlbnNpb25GcmFnRGVwdGggKSA/ICcjZGVmaW5lIFVTRV9MT0dERVBUSEJVRl9FWFQnIDogJycsCgoJCQkndW5pZm9ybSBtYXQ0IHZpZXdNYXRyaXg7JywKCQkJJ3VuaWZvcm0gdmVjMyBjYW1lcmFQb3NpdGlvbjsnLAoJCQkndW5pZm9ybSBib29sIGlzT3J0aG9ncmFwaGljOycsCgoJCQkoIHBhcmFtZXRlcnMudG9uZU1hcHBpbmcgIT09IE5vVG9uZU1hcHBpbmcgKSA/ICcjZGVmaW5lIFRPTkVfTUFQUElORycgOiAnJywKCQkJKCBwYXJhbWV0ZXJzLnRvbmVNYXBwaW5nICE9PSBOb1RvbmVNYXBwaW5nICkgPyBTaGFkZXJDaHVua1sgJ3RvbmVtYXBwaW5nX3BhcnNfZnJhZ21lbnQnIF0gOiAnJywgLy8gdGhpcyBjb2RlIGlzIHJlcXVpcmVkIGhlcmUgYmVjYXVzZSBpdCBpcyB1c2VkIGJ5IHRoZSB0b25lTWFwcGluZygpIGZ1bmN0aW9uIGRlZmluZWQgYmVsb3cKCQkJKCBwYXJhbWV0ZXJzLnRvbmVNYXBwaW5nICE9PSBOb1RvbmVNYXBwaW5nICkgPyBnZXRUb25lTWFwcGluZ0Z1bmN0aW9uKCAndG9uZU1hcHBpbmcnLCBwYXJhbWV0ZXJzLnRvbmVNYXBwaW5nICkgOiAnJywKCgkJCXBhcmFtZXRlcnMuZGl0aGVyaW5nID8gJyNkZWZpbmUgRElUSEVSSU5HJyA6ICcnLAoJCQlwYXJhbWV0ZXJzLm9wYXF1ZSA/ICcjZGVmaW5lIE9QQVFVRScgOiAnJywKCgkJCVNoYWRlckNodW5rWyAnY29sb3JzcGFjZV9wYXJzX2ZyYWdtZW50JyBdLCAvLyB0aGlzIGNvZGUgaXMgcmVxdWlyZWQgaGVyZSBiZWNhdXNlIGl0IGlzIHVzZWQgYnkgdGhlIHZhcmlvdXMgZW5jb2RpbmcvZGVjb2RpbmcgZnVuY3Rpb24gZGVmaW5lZCBiZWxvdwoJCQlnZXRUZXhlbEVuY29kaW5nRnVuY3Rpb24oICdsaW5lYXJUb091dHB1dFRleGVsJywgcGFyYW1ldGVycy5vdXRwdXRDb2xvclNwYWNlICksCgoJCQlwYXJhbWV0ZXJzLnVzZURlcHRoUGFja2luZyA/ICcjZGVmaW5lIERFUFRIX1BBQ0tJTkcgJyArIHBhcmFtZXRlcnMuZGVwdGhQYWNraW5nIDogJycsCgoJCQknXG4nCgoJCV0uZmlsdGVyKCBmaWx0ZXJFbXB0eUxpbmUgKS5qb2luKCAnXG4nICk7CgoJfQoKCXZlcnRleFNoYWRlciA9IHJlc29sdmVJbmNsdWRlcyggdmVydGV4U2hhZGVyICk7Cgl2ZXJ0ZXhTaGFkZXIgPSByZXBsYWNlTGlnaHROdW1zKCB2ZXJ0ZXhTaGFkZXIsIHBhcmFtZXRlcnMgKTsKCXZlcnRleFNoYWRlciA9IHJlcGxhY2VDbGlwcGluZ1BsYW5lTnVtcyggdmVydGV4U2hhZGVyLCBwYXJhbWV0ZXJzICk7CgoJZnJhZ21lbnRTaGFkZXIgPSByZXNvbHZlSW5jbHVkZXMoIGZyYWdtZW50U2hhZGVyICk7CglmcmFnbWVudFNoYWRlciA9IHJlcGxhY2VMaWdodE51bXMoIGZyYWdtZW50U2hhZGVyLCBwYXJhbWV0ZXJzICk7CglmcmFnbWVudFNoYWRlciA9IHJlcGxhY2VDbGlwcGluZ1BsYW5lTnVtcyggZnJhZ21lbnRTaGFkZXIsIHBhcmFtZXRlcnMgKTsKCgl2ZXJ0ZXhTaGFkZXIgPSB1bnJvbGxMb29wcyggdmVydGV4U2hhZGVyICk7CglmcmFnbWVudFNoYWRlciA9IHVucm9sbExvb3BzKCBmcmFnbWVudFNoYWRlciApOwoKCWlmICggcGFyYW1ldGVycy5pc1dlYkdMMiAmJiBwYXJhbWV0ZXJzLmlzUmF3U2hhZGVyTWF0ZXJpYWwgIT09IHRydWUgKSB7CgoJCS8vIEdMU0wgMy4wIGNvbnZlcnNpb24gZm9yIGJ1aWx0LWluIG1hdGVyaWFscyBhbmQgU2hhZGVyTWF0ZXJpYWwKCgkJdmVyc2lvblN0cmluZyA9ICcjdmVyc2lvbiAzMDAgZXNcbic7CgoJCXByZWZpeFZlcnRleCA9IFsKCQkJY3VzdG9tVmVydGV4RXh0ZW5zaW9ucywKCQkJJ3ByZWNpc2lvbiBtZWRpdW1wIHNhbXBsZXIyREFycmF5OycsCgkJCScjZGVmaW5lIGF0dHJpYnV0ZSBpbicsCgkJCScjZGVmaW5lIHZhcnlpbmcgb3V0JywKCQkJJyNkZWZpbmUgdGV4dHVyZTJEIHRleHR1cmUnCgkJXS5qb2luKCAnXG4nICkgKyAnXG4nICsgcHJlZml4VmVydGV4OwoKCQlwcmVmaXhGcmFnbWVudCA9IFsKCQkJJ3ByZWNpc2lvbiBtZWRpdW1wIHNhbXBsZXIyREFycmF5OycsCgkJCScjZGVmaW5lIHZhcnlpbmcgaW4nLAoJCQkoIHBhcmFtZXRlcnMuZ2xzbFZlcnNpb24gPT09IEdMU0wzICkgPyAnJyA6ICdsYXlvdXQobG9jYXRpb24gPSAwKSBvdXQgaGlnaHAgdmVjNCBwY19mcmFnQ29sb3I7JywKCQkJKCBwYXJhbWV0ZXJzLmdsc2xWZXJzaW9uID09PSBHTFNMMyApID8gJycgOiAnI2RlZmluZSBnbF9GcmFnQ29sb3IgcGNfZnJhZ0NvbG9yJywKCQkJJyNkZWZpbmUgZ2xfRnJhZ0RlcHRoRVhUIGdsX0ZyYWdEZXB0aCcsCgkJCScjZGVmaW5lIHRleHR1cmUyRCB0ZXh0dXJlJywKCQkJJyNkZWZpbmUgdGV4dHVyZUN1YmUgdGV4dHVyZScsCgkJCScjZGVmaW5lIHRleHR1cmUyRFByb2ogdGV4dHVyZVByb2onLAoJCQknI2RlZmluZSB0ZXh0dXJlMkRMb2RFWFQgdGV4dHVyZUxvZCcsCgkJCScjZGVmaW5lIHRleHR1cmUyRFByb2pMb2RFWFQgdGV4dHVyZVByb2pMb2QnLAoJCQknI2RlZmluZSB0ZXh0dXJlQ3ViZUxvZEVYVCB0ZXh0dXJlTG9kJywKCQkJJyNkZWZpbmUgdGV4dHVyZTJER3JhZEVYVCB0ZXh0dXJlR3JhZCcsCgkJCScjZGVmaW5lIHRleHR1cmUyRFByb2pHcmFkRVhUIHRleHR1cmVQcm9qR3JhZCcsCgkJCScjZGVmaW5lIHRleHR1cmVDdWJlR3JhZEVYVCB0ZXh0dXJlR3JhZCcKCQldLmpvaW4oICdcbicgKSArICdcbicgKyBwcmVmaXhGcmFnbWVudDsKCgl9CgoJY29uc3QgdmVydGV4R2xzbCA9IHZlcnNpb25TdHJpbmcgKyBwcmVmaXhWZXJ0ZXggKyB2ZXJ0ZXhTaGFkZXI7Cgljb25zdCBmcmFnbWVudEdsc2wgPSB2ZXJzaW9uU3RyaW5nICsgcHJlZml4RnJhZ21lbnQgKyBmcmFnbWVudFNoYWRlcjsKCgkvLyBjb25zb2xlLmxvZyggJypWRVJURVgqJywgdmVydGV4R2xzbCApOwoJLy8gY29uc29sZS5sb2coICcqRlJBR01FTlQqJywgZnJhZ21lbnRHbHNsICk7CgoJY29uc3QgZ2xWZXJ0ZXhTaGFkZXIgPSBXZWJHTFNoYWRlciggZ2wsIGdsLlZFUlRFWF9TSEFERVIsIHZlcnRleEdsc2wgKTsKCWNvbnN0IGdsRnJhZ21lbnRTaGFkZXIgPSBXZWJHTFNoYWRlciggZ2wsIGdsLkZSQUdNRU5UX1NIQURFUiwgZnJhZ21lbnRHbHNsICk7CgoJZ2wuYXR0YWNoU2hhZGVyKCBwcm9ncmFtLCBnbFZlcnRleFNoYWRlciApOwoJZ2wuYXR0YWNoU2hhZGVyKCBwcm9ncmFtLCBnbEZyYWdtZW50U2hhZGVyICk7CgoJLy8gRm9yY2UgYSBwYXJ0aWN1bGFyIGF0dHJpYnV0ZSB0byBpbmRleCAwLgoKCWlmICggcGFyYW1ldGVycy5pbmRleDBBdHRyaWJ1dGVOYW1lICE9PSB1bmRlZmluZWQgKSB7CgoJCWdsLmJpbmRBdHRyaWJMb2NhdGlvbiggcHJvZ3JhbSwgMCwgcGFyYW1ldGVycy5pbmRleDBBdHRyaWJ1dGVOYW1lICk7CgoJfSBlbHNlIGlmICggcGFyYW1ldGVycy5tb3JwaFRhcmdldHMgPT09IHRydWUgKSB7CgoJCS8vIHByb2dyYW1zIHdpdGggbW9ycGhUYXJnZXRzIGRpc3BsYWNlIHBvc2l0aW9uIG91dCBvZiBhdHRyaWJ1dGUgMAoJCWdsLmJpbmRBdHRyaWJMb2NhdGlvbiggcHJvZ3JhbSwgMCwgJ3Bvc2l0aW9uJyApOwoKCX0KCglnbC5saW5rUHJvZ3JhbSggcHJvZ3JhbSApOwoKCWZ1bmN0aW9uIG9uRmlyc3RVc2UoIHNlbGYgKSB7CgoJCS8vIGNoZWNrIGZvciBsaW5rIGVycm9ycwoJCWlmICggcmVuZGVyZXIuZGVidWcuY2hlY2tTaGFkZXJFcnJvcnMgKSB7CgoJCQljb25zdCBwcm9ncmFtTG9nID0gZ2wuZ2V0UHJvZ3JhbUluZm9Mb2coIHByb2dyYW0gKS50cmltKCk7CgkJCWNvbnN0IHZlcnRleExvZyA9IGdsLmdldFNoYWRlckluZm9Mb2coIGdsVmVydGV4U2hhZGVyICkudHJpbSgpOwoJCQljb25zdCBmcmFnbWVudExvZyA9IGdsLmdldFNoYWRlckluZm9Mb2coIGdsRnJhZ21lbnRTaGFkZXIgKS50cmltKCk7CgoJCQlsZXQgcnVubmFibGUgPSB0cnVlOwoJCQlsZXQgaGF2ZURpYWdub3N0aWNzID0gdHJ1ZTsKCgkJCWlmICggZ2wuZ2V0UHJvZ3JhbVBhcmFtZXRlciggcHJvZ3JhbSwgZ2wuTElOS19TVEFUVVMgKSA9PT0gZmFsc2UgKSB7CgoJCQkJcnVubmFibGUgPSBmYWxzZTsKCgkJCQlpZiAoIHR5cGVvZiByZW5kZXJlci5kZWJ1Zy5vblNoYWRlckVycm9yID09PSAnZnVuY3Rpb24nICkgewoKCQkJCQlyZW5kZXJlci5kZWJ1Zy5vblNoYWRlckVycm9yKCBnbCwgcHJvZ3JhbSwgZ2xWZXJ0ZXhTaGFkZXIsIGdsRnJhZ21lbnRTaGFkZXIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQkvLyBkZWZhdWx0IGVycm9yIHJlcG9ydGluZwoKCQkJCQljb25zdCB2ZXJ0ZXhFcnJvcnMgPSBnZXRTaGFkZXJFcnJvcnMoIGdsLCBnbFZlcnRleFNoYWRlciwgJ3ZlcnRleCcgKTsKCQkJCQljb25zdCBmcmFnbWVudEVycm9ycyA9IGdldFNoYWRlckVycm9ycyggZ2wsIGdsRnJhZ21lbnRTaGFkZXIsICdmcmFnbWVudCcgKTsKCgkJCQkJY29uc29sZS5lcnJvcigKCQkJCQkJJ1RIUkVFLldlYkdMUHJvZ3JhbTogU2hhZGVyIEVycm9yICcgKyBnbC5nZXRFcnJvcigpICsgJyAtICcgKwoJCQkJCQknVkFMSURBVEVfU1RBVFVTICcgKyBnbC5nZXRQcm9ncmFtUGFyYW1ldGVyKCBwcm9ncmFtLCBnbC5WQUxJREFURV9TVEFUVVMgKSArICdcblxuJyArCgkJCQkJCSdNYXRlcmlhbCBOYW1lOiAnICsgc2VsZi5uYW1lICsgJ1xuJyArCgkJCQkJCSdNYXRlcmlhbCBUeXBlOiAnICsgc2VsZi50eXBlICsgJ1xuXG4nICsKCQkJCQkJJ1Byb2dyYW0gSW5mbyBMb2c6ICcgKyBwcm9ncmFtTG9nICsgJ1xuJyArCgkJCQkJCXZlcnRleEVycm9ycyArICdcbicgKwoJCQkJCQlmcmFnbWVudEVycm9ycwoJCQkJCSk7CgoJCQkJfQoKCQkJfSBlbHNlIGlmICggcHJvZ3JhbUxvZyAhPT0gJycgKSB7CgoJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xQcm9ncmFtOiBQcm9ncmFtIEluZm8gTG9nOicsIHByb2dyYW1Mb2cgKTsKCgkJCX0gZWxzZSBpZiAoIHZlcnRleExvZyA9PT0gJycgfHwgZnJhZ21lbnRMb2cgPT09ICcnICkgewoKCQkJCWhhdmVEaWFnbm9zdGljcyA9IGZhbHNlOwoKCQkJfQoKCQkJaWYgKCBoYXZlRGlhZ25vc3RpY3MgKSB7CgoJCQkJc2VsZi5kaWFnbm9zdGljcyA9IHsKCgkJCQkJcnVubmFibGU6IHJ1bm5hYmxlLAoKCQkJCQlwcm9ncmFtTG9nOiBwcm9ncmFtTG9nLAoKCQkJCQl2ZXJ0ZXhTaGFkZXI6IHsKCgkJCQkJCWxvZzogdmVydGV4TG9nLAoJCQkJCQlwcmVmaXg6IHByZWZpeFZlcnRleAoKCQkJCQl9LAoKCQkJCQlmcmFnbWVudFNoYWRlcjogewoKCQkJCQkJbG9nOiBmcmFnbWVudExvZywKCQkJCQkJcHJlZml4OiBwcmVmaXhGcmFnbWVudAoKCQkJCQl9CgoJCQkJfTsKCgkJCX0KCgkJfQoKCQkvLyBDbGVhbiB1cAoKCQkvLyBDcmFzaGVzIGluIGlPUzkgYW5kIGlPUzEwLiAjMTg0MDIKCQkvLyBnbC5kZXRhY2hTaGFkZXIoIHByb2dyYW0sIGdsVmVydGV4U2hhZGVyICk7CgkJLy8gZ2wuZGV0YWNoU2hhZGVyKCBwcm9ncmFtLCBnbEZyYWdtZW50U2hhZGVyICk7CgoJCWdsLmRlbGV0ZVNoYWRlciggZ2xWZXJ0ZXhTaGFkZXIgKTsKCQlnbC5kZWxldGVTaGFkZXIoIGdsRnJhZ21lbnRTaGFkZXIgKTsKCgkJY2FjaGVkVW5pZm9ybXMgPSBuZXcgV2ViR0xVbmlmb3JtcyggZ2wsIHByb2dyYW0gKTsKCQljYWNoZWRBdHRyaWJ1dGVzID0gZmV0Y2hBdHRyaWJ1dGVMb2NhdGlvbnMoIGdsLCBwcm9ncmFtICk7CgoJfQoKCS8vIHNldCB1cCBjYWNoaW5nIGZvciB1bmlmb3JtIGxvY2F0aW9ucwoKCWxldCBjYWNoZWRVbmlmb3JtczsKCgl0aGlzLmdldFVuaWZvcm1zID0gZnVuY3Rpb24gKCkgewoKCQlpZiAoIGNhY2hlZFVuaWZvcm1zID09PSB1bmRlZmluZWQgKSB7CgoJCQkvLyBQb3B1bGF0ZXMgY2FjaGVkVW5pZm9ybXMgYW5kIGNhY2hlZEF0dHJpYnV0ZXMKCQkJb25GaXJzdFVzZSggdGhpcyApOwoKCQl9CgoJCXJldHVybiBjYWNoZWRVbmlmb3JtczsKCgl9OwoKCS8vIHNldCB1cCBjYWNoaW5nIGZvciBhdHRyaWJ1dGUgbG9jYXRpb25zCgoJbGV0IGNhY2hlZEF0dHJpYnV0ZXM7CgoJdGhpcy5nZXRBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKCkgewoKCQlpZiAoIGNhY2hlZEF0dHJpYnV0ZXMgPT09IHVuZGVmaW5lZCApIHsKCgkJCS8vIFBvcHVsYXRlcyBjYWNoZWRBdHRyaWJ1dGVzIGFuZCBjYWNoZWRVbmlmb3JtcwoJCQlvbkZpcnN0VXNlKCB0aGlzICk7CgoJCX0KCgkJcmV0dXJuIGNhY2hlZEF0dHJpYnV0ZXM7CgoJfTsKCgkvLyBpbmRpY2F0ZSB3aGVuIHRoZSBwcm9ncmFtIGlzIHJlYWR5IHRvIGJlIHVzZWQuIGlmIHRoZSBLSFJfcGFyYWxsZWxfc2hhZGVyX2NvbXBpbGUgZXh0ZW5zaW9uIGlzbid0IHN1cHBvcnRlZCwKCS8vIGZsYWcgdGhlIHByb2dyYW0gYXMgcmVhZHkgaW1tZWRpYXRlbHkuIEl0IG1heSBjYXVzZSBhIHN0YWxsIHdoZW4gaXQncyBmaXJzdCB1c2VkLgoKCWxldCBwcm9ncmFtUmVhZHkgPSAoIHBhcmFtZXRlcnMucmVuZGVyZXJFeHRlbnNpb25QYXJhbGxlbFNoYWRlckNvbXBpbGUgPT09IGZhbHNlICk7CgoJdGhpcy5pc1JlYWR5ID0gZnVuY3Rpb24gKCkgewoKCQlpZiAoIHByb2dyYW1SZWFkeSA9PT0gZmFsc2UgKSB7CgoJCQlwcm9ncmFtUmVhZHkgPSBnbC5nZXRQcm9ncmFtUGFyYW1ldGVyKCBwcm9ncmFtLCBDT01QTEVUSU9OX1NUQVRVU19LSFIgKTsKCgkJfQoKCQlyZXR1cm4gcHJvZ3JhbVJlYWR5OwoKCX07CgoJLy8gZnJlZSByZXNvdXJjZQoKCXRoaXMuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKCgkJYmluZGluZ1N0YXRlcy5yZWxlYXNlU3RhdGVzT2ZQcm9ncmFtKCB0aGlzICk7CgoJCWdsLmRlbGV0ZVByb2dyYW0oIHByb2dyYW0gKTsKCQl0aGlzLnByb2dyYW0gPSB1bmRlZmluZWQ7CgoJfTsKCgkvLwoKCXRoaXMudHlwZSA9IHBhcmFtZXRlcnMuc2hhZGVyVHlwZTsKCXRoaXMubmFtZSA9IHBhcmFtZXRlcnMuc2hhZGVyTmFtZTsKCXRoaXMuaWQgPSBwcm9ncmFtSWRDb3VudCArKzsKCXRoaXMuY2FjaGVLZXkgPSBjYWNoZUtleTsKCXRoaXMudXNlZFRpbWVzID0gMTsKCXRoaXMucHJvZ3JhbSA9IHByb2dyYW07Cgl0aGlzLnZlcnRleFNoYWRlciA9IGdsVmVydGV4U2hhZGVyOwoJdGhpcy5mcmFnbWVudFNoYWRlciA9IGdsRnJhZ21lbnRTaGFkZXI7CgoJcmV0dXJuIHRoaXM7Cgp9CgpsZXQgX2lkJDEgPSAwOwoKY2xhc3MgV2ViR0xTaGFkZXJDYWNoZSB7CgoJY29uc3RydWN0b3IoKSB7CgoJCXRoaXMuc2hhZGVyQ2FjaGUgPSBuZXcgTWFwKCk7CgkJdGhpcy5tYXRlcmlhbENhY2hlID0gbmV3IE1hcCgpOwoKCX0KCgl1cGRhdGUoIG1hdGVyaWFsICkgewoKCQljb25zdCB2ZXJ0ZXhTaGFkZXIgPSBtYXRlcmlhbC52ZXJ0ZXhTaGFkZXI7CgkJY29uc3QgZnJhZ21lbnRTaGFkZXIgPSBtYXRlcmlhbC5mcmFnbWVudFNoYWRlcjsKCgkJY29uc3QgdmVydGV4U2hhZGVyU3RhZ2UgPSB0aGlzLl9nZXRTaGFkZXJTdGFnZSggdmVydGV4U2hhZGVyICk7CgkJY29uc3QgZnJhZ21lbnRTaGFkZXJTdGFnZSA9IHRoaXMuX2dldFNoYWRlclN0YWdlKCBmcmFnbWVudFNoYWRlciApOwoKCQljb25zdCBtYXRlcmlhbFNoYWRlcnMgPSB0aGlzLl9nZXRTaGFkZXJDYWNoZUZvck1hdGVyaWFsKCBtYXRlcmlhbCApOwoKCQlpZiAoIG1hdGVyaWFsU2hhZGVycy5oYXMoIHZlcnRleFNoYWRlclN0YWdlICkgPT09IGZhbHNlICkgewoKCQkJbWF0ZXJpYWxTaGFkZXJzLmFkZCggdmVydGV4U2hhZGVyU3RhZ2UgKTsKCQkJdmVydGV4U2hhZGVyU3RhZ2UudXNlZFRpbWVzICsrOwoKCQl9CgoJCWlmICggbWF0ZXJpYWxTaGFkZXJzLmhhcyggZnJhZ21lbnRTaGFkZXJTdGFnZSApID09PSBmYWxzZSApIHsKCgkJCW1hdGVyaWFsU2hhZGVycy5hZGQoIGZyYWdtZW50U2hhZGVyU3RhZ2UgKTsKCQkJZnJhZ21lbnRTaGFkZXJTdGFnZS51c2VkVGltZXMgKys7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJlbW92ZSggbWF0ZXJpYWwgKSB7CgoJCWNvbnN0IG1hdGVyaWFsU2hhZGVycyA9IHRoaXMubWF0ZXJpYWxDYWNoZS5nZXQoIG1hdGVyaWFsICk7CgoJCWZvciAoIGNvbnN0IHNoYWRlclN0YWdlIG9mIG1hdGVyaWFsU2hhZGVycyApIHsKCgkJCXNoYWRlclN0YWdlLnVzZWRUaW1lcyAtLTsKCgkJCWlmICggc2hhZGVyU3RhZ2UudXNlZFRpbWVzID09PSAwICkgdGhpcy5zaGFkZXJDYWNoZS5kZWxldGUoIHNoYWRlclN0YWdlLmNvZGUgKTsKCgkJfQoKCQl0aGlzLm1hdGVyaWFsQ2FjaGUuZGVsZXRlKCBtYXRlcmlhbCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0VmVydGV4U2hhZGVySUQoIG1hdGVyaWFsICkgewoKCQlyZXR1cm4gdGhpcy5fZ2V0U2hhZGVyU3RhZ2UoIG1hdGVyaWFsLnZlcnRleFNoYWRlciApLmlkOwoKCX0KCglnZXRGcmFnbWVudFNoYWRlcklEKCBtYXRlcmlhbCApIHsKCgkJcmV0dXJuIHRoaXMuX2dldFNoYWRlclN0YWdlKCBtYXRlcmlhbC5mcmFnbWVudFNoYWRlciApLmlkOwoKCX0KCglkaXNwb3NlKCkgewoKCQl0aGlzLnNoYWRlckNhY2hlLmNsZWFyKCk7CgkJdGhpcy5tYXRlcmlhbENhY2hlLmNsZWFyKCk7CgoJfQoKCV9nZXRTaGFkZXJDYWNoZUZvck1hdGVyaWFsKCBtYXRlcmlhbCApIHsKCgkJY29uc3QgY2FjaGUgPSB0aGlzLm1hdGVyaWFsQ2FjaGU7CgkJbGV0IHNldCA9IGNhY2hlLmdldCggbWF0ZXJpYWwgKTsKCgkJaWYgKCBzZXQgPT09IHVuZGVmaW5lZCApIHsKCgkJCXNldCA9IG5ldyBTZXQoKTsKCQkJY2FjaGUuc2V0KCBtYXRlcmlhbCwgc2V0ICk7CgoJCX0KCgkJcmV0dXJuIHNldDsKCgl9CgoJX2dldFNoYWRlclN0YWdlKCBjb2RlICkgewoKCQljb25zdCBjYWNoZSA9IHRoaXMuc2hhZGVyQ2FjaGU7CgkJbGV0IHN0YWdlID0gY2FjaGUuZ2V0KCBjb2RlICk7CgoJCWlmICggc3RhZ2UgPT09IHVuZGVmaW5lZCApIHsKCgkJCXN0YWdlID0gbmV3IFdlYkdMU2hhZGVyU3RhZ2UoIGNvZGUgKTsKCQkJY2FjaGUuc2V0KCBjb2RlLCBzdGFnZSApOwoKCQl9CgoJCXJldHVybiBzdGFnZTsKCgl9Cgp9CgpjbGFzcyBXZWJHTFNoYWRlclN0YWdlIHsKCgljb25zdHJ1Y3RvciggY29kZSApIHsKCgkJdGhpcy5pZCA9IF9pZCQxICsrOwoKCQl0aGlzLmNvZGUgPSBjb2RlOwoJCXRoaXMudXNlZFRpbWVzID0gMDsKCgl9Cgp9CgpmdW5jdGlvbiBXZWJHTFByb2dyYW1zKCByZW5kZXJlciwgY3ViZW1hcHMsIGN1YmV1dm1hcHMsIGV4dGVuc2lvbnMsIGNhcGFiaWxpdGllcywgYmluZGluZ1N0YXRlcywgY2xpcHBpbmcgKSB7CgoJY29uc3QgX3Byb2dyYW1MYXllcnMgPSBuZXcgTGF5ZXJzKCk7Cgljb25zdCBfY3VzdG9tU2hhZGVycyA9IG5ldyBXZWJHTFNoYWRlckNhY2hlKCk7Cgljb25zdCBfYWN0aXZlQ2hhbm5lbHMgPSBuZXcgU2V0KCk7Cgljb25zdCBwcm9ncmFtcyA9IFtdOwoKCWNvbnN0IElTX1dFQkdMMiA9IGNhcGFiaWxpdGllcy5pc1dlYkdMMjsKCWNvbnN0IGxvZ2FyaXRobWljRGVwdGhCdWZmZXIgPSBjYXBhYmlsaXRpZXMubG9nYXJpdGhtaWNEZXB0aEJ1ZmZlcjsKCWNvbnN0IFNVUFBPUlRTX1ZFUlRFWF9URVhUVVJFUyA9IGNhcGFiaWxpdGllcy52ZXJ0ZXhUZXh0dXJlczsKCglsZXQgcHJlY2lzaW9uID0gY2FwYWJpbGl0aWVzLnByZWNpc2lvbjsKCgljb25zdCBzaGFkZXJJRHMgPSB7CgkJTWVzaERlcHRoTWF0ZXJpYWw6ICdkZXB0aCcsCgkJTWVzaERpc3RhbmNlTWF0ZXJpYWw6ICdkaXN0YW5jZVJHQkEnLAoJCU1lc2hOb3JtYWxNYXRlcmlhbDogJ25vcm1hbCcsCgkJTWVzaEJhc2ljTWF0ZXJpYWw6ICdiYXNpYycsCgkJTWVzaExhbWJlcnRNYXRlcmlhbDogJ2xhbWJlcnQnLAoJCU1lc2hQaG9uZ01hdGVyaWFsOiAncGhvbmcnLAoJCU1lc2hUb29uTWF0ZXJpYWw6ICd0b29uJywKCQlNZXNoU3RhbmRhcmRNYXRlcmlhbDogJ3BoeXNpY2FsJywKCQlNZXNoUGh5c2ljYWxNYXRlcmlhbDogJ3BoeXNpY2FsJywKCQlNZXNoTWF0Y2FwTWF0ZXJpYWw6ICdtYXRjYXAnLAoJCUxpbmVCYXNpY01hdGVyaWFsOiAnYmFzaWMnLAoJCUxpbmVEYXNoZWRNYXRlcmlhbDogJ2Rhc2hlZCcsCgkJUG9pbnRzTWF0ZXJpYWw6ICdwb2ludHMnLAoJCVNoYWRvd01hdGVyaWFsOiAnc2hhZG93JywKCQlTcHJpdGVNYXRlcmlhbDogJ3Nwcml0ZScKCX07CgoJZnVuY3Rpb24gZ2V0Q2hhbm5lbCggdmFsdWUgKSB7CgoJCV9hY3RpdmVDaGFubmVscy5hZGQoIHZhbHVlICk7CgoJCWlmICggdmFsdWUgPT09IDAgKSByZXR1cm4gJ3V2JzsKCgkJcmV0dXJuIGB1diR7IHZhbHVlIH1gOwoKCX0KCglmdW5jdGlvbiBnZXRQYXJhbWV0ZXJzKCBtYXRlcmlhbCwgbGlnaHRzLCBzaGFkb3dzLCBzY2VuZSwgb2JqZWN0ICkgewoKCQljb25zdCBmb2cgPSBzY2VuZS5mb2c7CgkJY29uc3QgZ2VvbWV0cnkgPSBvYmplY3QuZ2VvbWV0cnk7CgkJY29uc3QgZW52aXJvbm1lbnQgPSBtYXRlcmlhbC5pc01lc2hTdGFuZGFyZE1hdGVyaWFsID8gc2NlbmUuZW52aXJvbm1lbnQgOiBudWxsOwoKCQljb25zdCBlbnZNYXAgPSAoIG1hdGVyaWFsLmlzTWVzaFN0YW5kYXJkTWF0ZXJpYWwgPyBjdWJldXZtYXBzIDogY3ViZW1hcHMgKS5nZXQoIG1hdGVyaWFsLmVudk1hcCB8fCBlbnZpcm9ubWVudCApOwoJCWNvbnN0IGVudk1hcEN1YmVVVkhlaWdodCA9ICggISEgZW52TWFwICkgJiYgKCBlbnZNYXAubWFwcGluZyA9PT0gQ3ViZVVWUmVmbGVjdGlvbk1hcHBpbmcgKSA/IGVudk1hcC5pbWFnZS5oZWlnaHQgOiBudWxsOwoKCQljb25zdCBzaGFkZXJJRCA9IHNoYWRlcklEc1sgbWF0ZXJpYWwudHlwZSBdOwoKCQkvLyBoZXVyaXN0aWNzIHRvIGNyZWF0ZSBzaGFkZXIgcGFyYW1ldGVycyBhY2NvcmRpbmcgdG8gbGlnaHRzIGluIHRoZSBzY2VuZQoJCS8vIChub3QgdG8gYmxvdyBvdmVyIG1heExpZ2h0cyBidWRnZXQpCgoJCWlmICggbWF0ZXJpYWwucHJlY2lzaW9uICE9PSBudWxsICkgewoKCQkJcHJlY2lzaW9uID0gY2FwYWJpbGl0aWVzLmdldE1heFByZWNpc2lvbiggbWF0ZXJpYWwucHJlY2lzaW9uICk7CgoJCQlpZiAoIHByZWNpc2lvbiAhPT0gbWF0ZXJpYWwucHJlY2lzaW9uICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUHJvZ3JhbS5nZXRQYXJhbWV0ZXJzOicsIG1hdGVyaWFsLnByZWNpc2lvbiwgJ25vdCBzdXBwb3J0ZWQsIHVzaW5nJywgcHJlY2lzaW9uLCAnaW5zdGVhZC4nICk7CgoJCQl9CgoJCX0KCgkJLy8KCgkJY29uc3QgbW9ycGhBdHRyaWJ1dGUgPSBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb24gfHwgZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzLm5vcm1hbCB8fCBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMuY29sb3I7CgkJY29uc3QgbW9ycGhUYXJnZXRzQ291bnQgPSAoIG1vcnBoQXR0cmlidXRlICE9PSB1bmRlZmluZWQgKSA/IG1vcnBoQXR0cmlidXRlLmxlbmd0aCA6IDA7CgoJCWxldCBtb3JwaFRleHR1cmVTdHJpZGUgPSAwOwoKCQlpZiAoIGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5wb3NpdGlvbiAhPT0gdW5kZWZpbmVkICkgbW9ycGhUZXh0dXJlU3RyaWRlID0gMTsKCQlpZiAoIGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5ub3JtYWwgIT09IHVuZGVmaW5lZCApIG1vcnBoVGV4dHVyZVN0cmlkZSA9IDI7CgkJaWYgKCBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMuY29sb3IgIT09IHVuZGVmaW5lZCApIG1vcnBoVGV4dHVyZVN0cmlkZSA9IDM7CgoJCS8vCgoJCWxldCB2ZXJ0ZXhTaGFkZXIsIGZyYWdtZW50U2hhZGVyOwoJCWxldCBjdXN0b21WZXJ0ZXhTaGFkZXJJRCwgY3VzdG9tRnJhZ21lbnRTaGFkZXJJRDsKCgkJaWYgKCBzaGFkZXJJRCApIHsKCgkJCWNvbnN0IHNoYWRlciA9IFNoYWRlckxpYlsgc2hhZGVySUQgXTsKCgkJCXZlcnRleFNoYWRlciA9IHNoYWRlci52ZXJ0ZXhTaGFkZXI7CgkJCWZyYWdtZW50U2hhZGVyID0gc2hhZGVyLmZyYWdtZW50U2hhZGVyOwoKCQl9IGVsc2UgewoKCQkJdmVydGV4U2hhZGVyID0gbWF0ZXJpYWwudmVydGV4U2hhZGVyOwoJCQlmcmFnbWVudFNoYWRlciA9IG1hdGVyaWFsLmZyYWdtZW50U2hhZGVyOwoKCQkJX2N1c3RvbVNoYWRlcnMudXBkYXRlKCBtYXRlcmlhbCApOwoKCQkJY3VzdG9tVmVydGV4U2hhZGVySUQgPSBfY3VzdG9tU2hhZGVycy5nZXRWZXJ0ZXhTaGFkZXJJRCggbWF0ZXJpYWwgKTsKCQkJY3VzdG9tRnJhZ21lbnRTaGFkZXJJRCA9IF9jdXN0b21TaGFkZXJzLmdldEZyYWdtZW50U2hhZGVySUQoIG1hdGVyaWFsICk7CgoJCX0KCgkJY29uc3QgY3VycmVudFJlbmRlclRhcmdldCA9IHJlbmRlcmVyLmdldFJlbmRlclRhcmdldCgpOwoKCQljb25zdCBJU19JTlNUQU5DRURNRVNIID0gb2JqZWN0LmlzSW5zdGFuY2VkTWVzaCA9PT0gdHJ1ZTsKCQljb25zdCBJU19CQVRDSEVETUVTSCA9IG9iamVjdC5pc0JhdGNoZWRNZXNoID09PSB0cnVlOwoKCQljb25zdCBIQVNfTUFQID0gISEgbWF0ZXJpYWwubWFwOwoJCWNvbnN0IEhBU19NQVRDQVAgPSAhISBtYXRlcmlhbC5tYXRjYXA7CgkJY29uc3QgSEFTX0VOVk1BUCA9ICEhIGVudk1hcDsKCQljb25zdCBIQVNfQU9NQVAgPSAhISBtYXRlcmlhbC5hb01hcDsKCQljb25zdCBIQVNfTElHSFRNQVAgPSAhISBtYXRlcmlhbC5saWdodE1hcDsKCQljb25zdCBIQVNfQlVNUE1BUCA9ICEhIG1hdGVyaWFsLmJ1bXBNYXA7CgkJY29uc3QgSEFTX05PUk1BTE1BUCA9ICEhIG1hdGVyaWFsLm5vcm1hbE1hcDsKCQljb25zdCBIQVNfRElTUExBQ0VNRU5UTUFQID0gISEgbWF0ZXJpYWwuZGlzcGxhY2VtZW50TWFwOwoJCWNvbnN0IEhBU19FTUlTU0lWRU1BUCA9ICEhIG1hdGVyaWFsLmVtaXNzaXZlTWFwOwoKCQljb25zdCBIQVNfTUVUQUxORVNTTUFQID0gISEgbWF0ZXJpYWwubWV0YWxuZXNzTWFwOwoJCWNvbnN0IEhBU19ST1VHSE5FU1NNQVAgPSAhISBtYXRlcmlhbC5yb3VnaG5lc3NNYXA7CgoJCWNvbnN0IEhBU19BTklTT1RST1BZID0gbWF0ZXJpYWwuYW5pc290cm9weSA+IDA7CgkJY29uc3QgSEFTX0NMRUFSQ09BVCA9IG1hdGVyaWFsLmNsZWFyY29hdCA+IDA7CgkJY29uc3QgSEFTX0lSSURFU0NFTkNFID0gbWF0ZXJpYWwuaXJpZGVzY2VuY2UgPiAwOwoJCWNvbnN0IEhBU19TSEVFTiA9IG1hdGVyaWFsLnNoZWVuID4gMDsKCQljb25zdCBIQVNfVFJBTlNNSVNTSU9OID0gbWF0ZXJpYWwudHJhbnNtaXNzaW9uID4gMDsKCgkJY29uc3QgSEFTX0FOSVNPVFJPUFlNQVAgPSBIQVNfQU5JU09UUk9QWSAmJiAhISBtYXRlcmlhbC5hbmlzb3Ryb3B5TWFwOwoKCQljb25zdCBIQVNfQ0xFQVJDT0FUTUFQID0gSEFTX0NMRUFSQ09BVCAmJiAhISBtYXRlcmlhbC5jbGVhcmNvYXRNYXA7CgkJY29uc3QgSEFTX0NMRUFSQ09BVF9OT1JNQUxNQVAgPSBIQVNfQ0xFQVJDT0FUICYmICEhIG1hdGVyaWFsLmNsZWFyY29hdE5vcm1hbE1hcDsKCQljb25zdCBIQVNfQ0xFQVJDT0FUX1JPVUdITkVTU01BUCA9IEhBU19DTEVBUkNPQVQgJiYgISEgbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzTWFwOwoKCQljb25zdCBIQVNfSVJJREVTQ0VOQ0VNQVAgPSBIQVNfSVJJREVTQ0VOQ0UgJiYgISEgbWF0ZXJpYWwuaXJpZGVzY2VuY2VNYXA7CgkJY29uc3QgSEFTX0lSSURFU0NFTkNFX1RISUNLTkVTU01BUCA9IEhBU19JUklERVNDRU5DRSAmJiAhISBtYXRlcmlhbC5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcDsKCgkJY29uc3QgSEFTX1NIRUVOX0NPTE9STUFQID0gSEFTX1NIRUVOICYmICEhIG1hdGVyaWFsLnNoZWVuQ29sb3JNYXA7CgkJY29uc3QgSEFTX1NIRUVOX1JPVUdITkVTU01BUCA9IEhBU19TSEVFTiAmJiAhISBtYXRlcmlhbC5zaGVlblJvdWdobmVzc01hcDsKCgkJY29uc3QgSEFTX1NQRUNVTEFSTUFQID0gISEgbWF0ZXJpYWwuc3BlY3VsYXJNYXA7CgkJY29uc3QgSEFTX1NQRUNVTEFSX0NPTE9STUFQID0gISEgbWF0ZXJpYWwuc3BlY3VsYXJDb2xvck1hcDsKCQljb25zdCBIQVNfU1BFQ1VMQVJfSU5URU5TSVRZTUFQID0gISEgbWF0ZXJpYWwuc3BlY3VsYXJJbnRlbnNpdHlNYXA7CgoJCWNvbnN0IEhBU19UUkFOU01JU1NJT05NQVAgPSBIQVNfVFJBTlNNSVNTSU9OICYmICEhIG1hdGVyaWFsLnRyYW5zbWlzc2lvbk1hcDsKCQljb25zdCBIQVNfVEhJQ0tORVNTTUFQID0gSEFTX1RSQU5TTUlTU0lPTiAmJiAhISBtYXRlcmlhbC50aGlja25lc3NNYXA7CgoJCWNvbnN0IEhBU19HUkFESUVOVE1BUCA9ICEhIG1hdGVyaWFsLmdyYWRpZW50TWFwOwoKCQljb25zdCBIQVNfQUxQSEFNQVAgPSAhISBtYXRlcmlhbC5hbHBoYU1hcDsKCgkJY29uc3QgSEFTX0FMUEhBVEVTVCA9IG1hdGVyaWFsLmFscGhhVGVzdCA+IDA7CgoJCWNvbnN0IEhBU19BTFBIQUhBU0ggPSAhISBtYXRlcmlhbC5hbHBoYUhhc2g7CgoJCWNvbnN0IEhBU19FWFRFTlNJT05TID0gISEgbWF0ZXJpYWwuZXh0ZW5zaW9uczsKCgkJbGV0IHRvbmVNYXBwaW5nID0gTm9Ub25lTWFwcGluZzsKCgkJaWYgKCBtYXRlcmlhbC50b25lTWFwcGVkICkgewoKCQkJaWYgKCBjdXJyZW50UmVuZGVyVGFyZ2V0ID09PSBudWxsIHx8IGN1cnJlbnRSZW5kZXJUYXJnZXQuaXNYUlJlbmRlclRhcmdldCA9PT0gdHJ1ZSApIHsKCgkJCQl0b25lTWFwcGluZyA9IHJlbmRlcmVyLnRvbmVNYXBwaW5nOwoKCQkJfQoKCQl9CgoJCWNvbnN0IHBhcmFtZXRlcnMgPSB7CgoJCQlpc1dlYkdMMjogSVNfV0VCR0wyLAoKCQkJc2hhZGVySUQ6IHNoYWRlcklELAoJCQlzaGFkZXJUeXBlOiBtYXRlcmlhbC50eXBlLAoJCQlzaGFkZXJOYW1lOiBtYXRlcmlhbC5uYW1lLAoKCQkJdmVydGV4U2hhZGVyOiB2ZXJ0ZXhTaGFkZXIsCgkJCWZyYWdtZW50U2hhZGVyOiBmcmFnbWVudFNoYWRlciwKCQkJZGVmaW5lczogbWF0ZXJpYWwuZGVmaW5lcywKCgkJCWN1c3RvbVZlcnRleFNoYWRlcklEOiBjdXN0b21WZXJ0ZXhTaGFkZXJJRCwKCQkJY3VzdG9tRnJhZ21lbnRTaGFkZXJJRDogY3VzdG9tRnJhZ21lbnRTaGFkZXJJRCwKCgkJCWlzUmF3U2hhZGVyTWF0ZXJpYWw6IG1hdGVyaWFsLmlzUmF3U2hhZGVyTWF0ZXJpYWwgPT09IHRydWUsCgkJCWdsc2xWZXJzaW9uOiBtYXRlcmlhbC5nbHNsVmVyc2lvbiwKCgkJCXByZWNpc2lvbjogcHJlY2lzaW9uLAoKCQkJYmF0Y2hpbmc6IElTX0JBVENIRURNRVNILAoJCQlpbnN0YW5jaW5nOiBJU19JTlNUQU5DRURNRVNILAoJCQlpbnN0YW5jaW5nQ29sb3I6IElTX0lOU1RBTkNFRE1FU0ggJiYgb2JqZWN0Lmluc3RhbmNlQ29sb3IgIT09IG51bGwsCgoJCQlzdXBwb3J0c1ZlcnRleFRleHR1cmVzOiBTVVBQT1JUU19WRVJURVhfVEVYVFVSRVMsCgkJCW91dHB1dENvbG9yU3BhY2U6ICggY3VycmVudFJlbmRlclRhcmdldCA9PT0gbnVsbCApID8gcmVuZGVyZXIub3V0cHV0Q29sb3JTcGFjZSA6ICggY3VycmVudFJlbmRlclRhcmdldC5pc1hSUmVuZGVyVGFyZ2V0ID09PSB0cnVlID8gY3VycmVudFJlbmRlclRhcmdldC50ZXh0dXJlLmNvbG9yU3BhY2UgOiBMaW5lYXJTUkdCQ29sb3JTcGFjZSApLAoJCQlhbHBoYVRvQ292ZXJhZ2U6ICEhIG1hdGVyaWFsLmFscGhhVG9Db3ZlcmFnZSwKCgkJCW1hcDogSEFTX01BUCwKCQkJbWF0Y2FwOiBIQVNfTUFUQ0FQLAoJCQllbnZNYXA6IEhBU19FTlZNQVAsCgkJCWVudk1hcE1vZGU6IEhBU19FTlZNQVAgJiYgZW52TWFwLm1hcHBpbmcsCgkJCWVudk1hcEN1YmVVVkhlaWdodDogZW52TWFwQ3ViZVVWSGVpZ2h0LAoJCQlhb01hcDogSEFTX0FPTUFQLAoJCQlsaWdodE1hcDogSEFTX0xJR0hUTUFQLAoJCQlidW1wTWFwOiBIQVNfQlVNUE1BUCwKCQkJbm9ybWFsTWFwOiBIQVNfTk9STUFMTUFQLAoJCQlkaXNwbGFjZW1lbnRNYXA6IFNVUFBPUlRTX1ZFUlRFWF9URVhUVVJFUyAmJiBIQVNfRElTUExBQ0VNRU5UTUFQLAoJCQllbWlzc2l2ZU1hcDogSEFTX0VNSVNTSVZFTUFQLAoKCQkJbm9ybWFsTWFwT2JqZWN0U3BhY2U6IEhBU19OT1JNQUxNQVAgJiYgbWF0ZXJpYWwubm9ybWFsTWFwVHlwZSA9PT0gT2JqZWN0U3BhY2VOb3JtYWxNYXAsCgkJCW5vcm1hbE1hcFRhbmdlbnRTcGFjZTogSEFTX05PUk1BTE1BUCAmJiBtYXRlcmlhbC5ub3JtYWxNYXBUeXBlID09PSBUYW5nZW50U3BhY2VOb3JtYWxNYXAsCgoJCQltZXRhbG5lc3NNYXA6IEhBU19NRVRBTE5FU1NNQVAsCgkJCXJvdWdobmVzc01hcDogSEFTX1JPVUdITkVTU01BUCwKCgkJCWFuaXNvdHJvcHk6IEhBU19BTklTT1RST1BZLAoJCQlhbmlzb3Ryb3B5TWFwOiBIQVNfQU5JU09UUk9QWU1BUCwKCgkJCWNsZWFyY29hdDogSEFTX0NMRUFSQ09BVCwKCQkJY2xlYXJjb2F0TWFwOiBIQVNfQ0xFQVJDT0FUTUFQLAoJCQljbGVhcmNvYXROb3JtYWxNYXA6IEhBU19DTEVBUkNPQVRfTk9STUFMTUFQLAoJCQljbGVhcmNvYXRSb3VnaG5lc3NNYXA6IEhBU19DTEVBUkNPQVRfUk9VR0hORVNTTUFQLAoKCQkJaXJpZGVzY2VuY2U6IEhBU19JUklERVNDRU5DRSwKCQkJaXJpZGVzY2VuY2VNYXA6IEhBU19JUklERVNDRU5DRU1BUCwKCQkJaXJpZGVzY2VuY2VUaGlja25lc3NNYXA6IEhBU19JUklERVNDRU5DRV9USElDS05FU1NNQVAsCgoJCQlzaGVlbjogSEFTX1NIRUVOLAoJCQlzaGVlbkNvbG9yTWFwOiBIQVNfU0hFRU5fQ09MT1JNQVAsCgkJCXNoZWVuUm91Z2huZXNzTWFwOiBIQVNfU0hFRU5fUk9VR0hORVNTTUFQLAoKCQkJc3BlY3VsYXJNYXA6IEhBU19TUEVDVUxBUk1BUCwKCQkJc3BlY3VsYXJDb2xvck1hcDogSEFTX1NQRUNVTEFSX0NPTE9STUFQLAoJCQlzcGVjdWxhckludGVuc2l0eU1hcDogSEFTX1NQRUNVTEFSX0lOVEVOU0lUWU1BUCwKCgkJCXRyYW5zbWlzc2lvbjogSEFTX1RSQU5TTUlTU0lPTiwKCQkJdHJhbnNtaXNzaW9uTWFwOiBIQVNfVFJBTlNNSVNTSU9OTUFQLAoJCQl0aGlja25lc3NNYXA6IEhBU19USElDS05FU1NNQVAsCgoJCQlncmFkaWVudE1hcDogSEFTX0dSQURJRU5UTUFQLAoKCQkJb3BhcXVlOiBtYXRlcmlhbC50cmFuc3BhcmVudCA9PT0gZmFsc2UgJiYgbWF0ZXJpYWwuYmxlbmRpbmcgPT09IE5vcm1hbEJsZW5kaW5nICYmIG1hdGVyaWFsLmFscGhhVG9Db3ZlcmFnZSA9PT0gZmFsc2UsCgoJCQlhbHBoYU1hcDogSEFTX0FMUEhBTUFQLAoJCQlhbHBoYVRlc3Q6IEhBU19BTFBIQVRFU1QsCgkJCWFscGhhSGFzaDogSEFTX0FMUEhBSEFTSCwKCgkJCWNvbWJpbmU6IG1hdGVyaWFsLmNvbWJpbmUsCgoJCQkvLwoKCQkJbWFwVXY6IEhBU19NQVAgJiYgZ2V0Q2hhbm5lbCggbWF0ZXJpYWwubWFwLmNoYW5uZWwgKSwKCQkJYW9NYXBVdjogSEFTX0FPTUFQICYmIGdldENoYW5uZWwoIG1hdGVyaWFsLmFvTWFwLmNoYW5uZWwgKSwKCQkJbGlnaHRNYXBVdjogSEFTX0xJR0hUTUFQICYmIGdldENoYW5uZWwoIG1hdGVyaWFsLmxpZ2h0TWFwLmNoYW5uZWwgKSwKCQkJYnVtcE1hcFV2OiBIQVNfQlVNUE1BUCAmJiBnZXRDaGFubmVsKCBtYXRlcmlhbC5idW1wTWFwLmNoYW5uZWwgKSwKCQkJbm9ybWFsTWFwVXY6IEhBU19OT1JNQUxNQVAgJiYgZ2V0Q2hhbm5lbCggbWF0ZXJpYWwubm9ybWFsTWFwLmNoYW5uZWwgKSwKCQkJZGlzcGxhY2VtZW50TWFwVXY6IEhBU19ESVNQTEFDRU1FTlRNQVAgJiYgZ2V0Q2hhbm5lbCggbWF0ZXJpYWwuZGlzcGxhY2VtZW50TWFwLmNoYW5uZWwgKSwKCQkJZW1pc3NpdmVNYXBVdjogSEFTX0VNSVNTSVZFTUFQICYmIGdldENoYW5uZWwoIG1hdGVyaWFsLmVtaXNzaXZlTWFwLmNoYW5uZWwgKSwKCgkJCW1ldGFsbmVzc01hcFV2OiBIQVNfTUVUQUxORVNTTUFQICYmIGdldENoYW5uZWwoIG1hdGVyaWFsLm1ldGFsbmVzc01hcC5jaGFubmVsICksCgkJCXJvdWdobmVzc01hcFV2OiBIQVNfUk9VR0hORVNTTUFQICYmIGdldENoYW5uZWwoIG1hdGVyaWFsLnJvdWdobmVzc01hcC5jaGFubmVsICksCgoJCQlhbmlzb3Ryb3B5TWFwVXY6IEhBU19BTklTT1RST1BZTUFQICYmIGdldENoYW5uZWwoIG1hdGVyaWFsLmFuaXNvdHJvcHlNYXAuY2hhbm5lbCApLAoKCQkJY2xlYXJjb2F0TWFwVXY6IEhBU19DTEVBUkNPQVRNQVAgJiYgZ2V0Q2hhbm5lbCggbWF0ZXJpYWwuY2xlYXJjb2F0TWFwLmNoYW5uZWwgKSwKCQkJY2xlYXJjb2F0Tm9ybWFsTWFwVXY6IEhBU19DTEVBUkNPQVRfTk9STUFMTUFQICYmIGdldENoYW5uZWwoIG1hdGVyaWFsLmNsZWFyY29hdE5vcm1hbE1hcC5jaGFubmVsICksCgkJCWNsZWFyY29hdFJvdWdobmVzc01hcFV2OiBIQVNfQ0xFQVJDT0FUX1JPVUdITkVTU01BUCAmJiBnZXRDaGFubmVsKCBtYXRlcmlhbC5jbGVhcmNvYXRSb3VnaG5lc3NNYXAuY2hhbm5lbCApLAoKCQkJaXJpZGVzY2VuY2VNYXBVdjogSEFTX0lSSURFU0NFTkNFTUFQICYmIGdldENoYW5uZWwoIG1hdGVyaWFsLmlyaWRlc2NlbmNlTWFwLmNoYW5uZWwgKSwKCQkJaXJpZGVzY2VuY2VUaGlja25lc3NNYXBVdjogSEFTX0lSSURFU0NFTkNFX1RISUNLTkVTU01BUCAmJiBnZXRDaGFubmVsKCBtYXRlcmlhbC5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcC5jaGFubmVsICksCgoJCQlzaGVlbkNvbG9yTWFwVXY6IEhBU19TSEVFTl9DT0xPUk1BUCAmJiBnZXRDaGFubmVsKCBtYXRlcmlhbC5zaGVlbkNvbG9yTWFwLmNoYW5uZWwgKSwKCQkJc2hlZW5Sb3VnaG5lc3NNYXBVdjogSEFTX1NIRUVOX1JPVUdITkVTU01BUCAmJiBnZXRDaGFubmVsKCBtYXRlcmlhbC5zaGVlblJvdWdobmVzc01hcC5jaGFubmVsICksCgoJCQlzcGVjdWxhck1hcFV2OiBIQVNfU1BFQ1VMQVJNQVAgJiYgZ2V0Q2hhbm5lbCggbWF0ZXJpYWwuc3BlY3VsYXJNYXAuY2hhbm5lbCApLAoJCQlzcGVjdWxhckNvbG9yTWFwVXY6IEhBU19TUEVDVUxBUl9DT0xPUk1BUCAmJiBnZXRDaGFubmVsKCBtYXRlcmlhbC5zcGVjdWxhckNvbG9yTWFwLmNoYW5uZWwgKSwKCQkJc3BlY3VsYXJJbnRlbnNpdHlNYXBVdjogSEFTX1NQRUNVTEFSX0lOVEVOU0lUWU1BUCAmJiBnZXRDaGFubmVsKCBtYXRlcmlhbC5zcGVjdWxhckludGVuc2l0eU1hcC5jaGFubmVsICksCgoJCQl0cmFuc21pc3Npb25NYXBVdjogSEFTX1RSQU5TTUlTU0lPTk1BUCAmJiBnZXRDaGFubmVsKCBtYXRlcmlhbC50cmFuc21pc3Npb25NYXAuY2hhbm5lbCApLAoJCQl0aGlja25lc3NNYXBVdjogSEFTX1RISUNLTkVTU01BUCAmJiBnZXRDaGFubmVsKCBtYXRlcmlhbC50aGlja25lc3NNYXAuY2hhbm5lbCApLAoKCQkJYWxwaGFNYXBVdjogSEFTX0FMUEhBTUFQICYmIGdldENoYW5uZWwoIG1hdGVyaWFsLmFscGhhTWFwLmNoYW5uZWwgKSwKCgkJCS8vCgoJCQl2ZXJ0ZXhUYW5nZW50czogISEgZ2VvbWV0cnkuYXR0cmlidXRlcy50YW5nZW50ICYmICggSEFTX05PUk1BTE1BUCB8fCBIQVNfQU5JU09UUk9QWSApLAoJCQl2ZXJ0ZXhDb2xvcnM6IG1hdGVyaWFsLnZlcnRleENvbG9ycywKCQkJdmVydGV4QWxwaGFzOiBtYXRlcmlhbC52ZXJ0ZXhDb2xvcnMgPT09IHRydWUgJiYgISEgZ2VvbWV0cnkuYXR0cmlidXRlcy5jb2xvciAmJiBnZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbG9yLml0ZW1TaXplID09PSA0LAoKCQkJcG9pbnRzVXZzOiBvYmplY3QuaXNQb2ludHMgPT09IHRydWUgJiYgISEgZ2VvbWV0cnkuYXR0cmlidXRlcy51diAmJiAoIEhBU19NQVAgfHwgSEFTX0FMUEhBTUFQICksCgoJCQlmb2c6ICEhIGZvZywKCQkJdXNlRm9nOiBtYXRlcmlhbC5mb2cgPT09IHRydWUsCgkJCWZvZ0V4cDI6ICggISEgZm9nICYmIGZvZy5pc0ZvZ0V4cDIgKSwKCgkJCWZsYXRTaGFkaW5nOiBtYXRlcmlhbC5mbGF0U2hhZGluZyA9PT0gdHJ1ZSwKCgkJCXNpemVBdHRlbnVhdGlvbjogbWF0ZXJpYWwuc2l6ZUF0dGVudWF0aW9uID09PSB0cnVlLAoJCQlsb2dhcml0aG1pY0RlcHRoQnVmZmVyOiBsb2dhcml0aG1pY0RlcHRoQnVmZmVyLAoKCQkJc2tpbm5pbmc6IG9iamVjdC5pc1NraW5uZWRNZXNoID09PSB0cnVlLAoKCQkJbW9ycGhUYXJnZXRzOiBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb24gIT09IHVuZGVmaW5lZCwKCQkJbW9ycGhOb3JtYWxzOiBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMubm9ybWFsICE9PSB1bmRlZmluZWQsCgkJCW1vcnBoQ29sb3JzOiBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMuY29sb3IgIT09IHVuZGVmaW5lZCwKCQkJbW9ycGhUYXJnZXRzQ291bnQ6IG1vcnBoVGFyZ2V0c0NvdW50LAoJCQltb3JwaFRleHR1cmVTdHJpZGU6IG1vcnBoVGV4dHVyZVN0cmlkZSwKCgkJCW51bURpckxpZ2h0czogbGlnaHRzLmRpcmVjdGlvbmFsLmxlbmd0aCwKCQkJbnVtUG9pbnRMaWdodHM6IGxpZ2h0cy5wb2ludC5sZW5ndGgsCgkJCW51bVNwb3RMaWdodHM6IGxpZ2h0cy5zcG90Lmxlbmd0aCwKCQkJbnVtU3BvdExpZ2h0TWFwczogbGlnaHRzLnNwb3RMaWdodE1hcC5sZW5ndGgsCgkJCW51bVJlY3RBcmVhTGlnaHRzOiBsaWdodHMucmVjdEFyZWEubGVuZ3RoLAoJCQludW1IZW1pTGlnaHRzOiBsaWdodHMuaGVtaS5sZW5ndGgsCgoJCQludW1EaXJMaWdodFNoYWRvd3M6IGxpZ2h0cy5kaXJlY3Rpb25hbFNoYWRvd01hcC5sZW5ndGgsCgkJCW51bVBvaW50TGlnaHRTaGFkb3dzOiBsaWdodHMucG9pbnRTaGFkb3dNYXAubGVuZ3RoLAoJCQludW1TcG90TGlnaHRTaGFkb3dzOiBsaWdodHMuc3BvdFNoYWRvd01hcC5sZW5ndGgsCgkJCW51bVNwb3RMaWdodFNoYWRvd3NXaXRoTWFwczogbGlnaHRzLm51bVNwb3RMaWdodFNoYWRvd3NXaXRoTWFwcywKCgkJCW51bUxpZ2h0UHJvYmVzOiBsaWdodHMubnVtTGlnaHRQcm9iZXMsCgoJCQludW1DbGlwcGluZ1BsYW5lczogY2xpcHBpbmcubnVtUGxhbmVzLAoJCQludW1DbGlwSW50ZXJzZWN0aW9uOiBjbGlwcGluZy5udW1JbnRlcnNlY3Rpb24sCgoJCQlkaXRoZXJpbmc6IG1hdGVyaWFsLmRpdGhlcmluZywKCgkJCXNoYWRvd01hcEVuYWJsZWQ6IHJlbmRlcmVyLnNoYWRvd01hcC5lbmFibGVkICYmIHNoYWRvd3MubGVuZ3RoID4gMCwKCQkJc2hhZG93TWFwVHlwZTogcmVuZGVyZXIuc2hhZG93TWFwLnR5cGUsCgoJCQl0b25lTWFwcGluZzogdG9uZU1hcHBpbmcsCgkJCXVzZUxlZ2FjeUxpZ2h0czogcmVuZGVyZXIuX3VzZUxlZ2FjeUxpZ2h0cywKCgkJCWRlY29kZVZpZGVvVGV4dHVyZTogSEFTX01BUCAmJiAoIG1hdGVyaWFsLm1hcC5pc1ZpZGVvVGV4dHVyZSA9PT0gdHJ1ZSApICYmICggQ29sb3JNYW5hZ2VtZW50LmdldFRyYW5zZmVyKCBtYXRlcmlhbC5tYXAuY29sb3JTcGFjZSApID09PSBTUkdCVHJhbnNmZXIgKSwKCgkJCXByZW11bHRpcGxpZWRBbHBoYTogbWF0ZXJpYWwucHJlbXVsdGlwbGllZEFscGhhLAoKCQkJZG91YmxlU2lkZWQ6IG1hdGVyaWFsLnNpZGUgPT09IERvdWJsZVNpZGUsCgkJCWZsaXBTaWRlZDogbWF0ZXJpYWwuc2lkZSA9PT0gQmFja1NpZGUsCgoJCQl1c2VEZXB0aFBhY2tpbmc6IG1hdGVyaWFsLmRlcHRoUGFja2luZyA+PSAwLAoJCQlkZXB0aFBhY2tpbmc6IG1hdGVyaWFsLmRlcHRoUGFja2luZyB8fCAwLAoKCQkJaW5kZXgwQXR0cmlidXRlTmFtZTogbWF0ZXJpYWwuaW5kZXgwQXR0cmlidXRlTmFtZSwKCgkJCWV4dGVuc2lvbkRlcml2YXRpdmVzOiBIQVNfRVhURU5TSU9OUyAmJiBtYXRlcmlhbC5leHRlbnNpb25zLmRlcml2YXRpdmVzID09PSB0cnVlLAoJCQlleHRlbnNpb25GcmFnRGVwdGg6IEhBU19FWFRFTlNJT05TICYmIG1hdGVyaWFsLmV4dGVuc2lvbnMuZnJhZ0RlcHRoID09PSB0cnVlLAoJCQlleHRlbnNpb25EcmF3QnVmZmVyczogSEFTX0VYVEVOU0lPTlMgJiYgbWF0ZXJpYWwuZXh0ZW5zaW9ucy5kcmF3QnVmZmVycyA9PT0gdHJ1ZSwKCQkJZXh0ZW5zaW9uU2hhZGVyVGV4dHVyZUxPRDogSEFTX0VYVEVOU0lPTlMgJiYgbWF0ZXJpYWwuZXh0ZW5zaW9ucy5zaGFkZXJUZXh0dXJlTE9EID09PSB0cnVlLAoJCQlleHRlbnNpb25DbGlwQ3VsbERpc3RhbmNlOiBIQVNfRVhURU5TSU9OUyAmJiBtYXRlcmlhbC5leHRlbnNpb25zLmNsaXBDdWxsRGlzdGFuY2UgPT09IHRydWUgJiYgZXh0ZW5zaW9ucy5oYXMoICdXRUJHTF9jbGlwX2N1bGxfZGlzdGFuY2UnICksCgkJCWV4dGVuc2lvbk11bHRpRHJhdzogSEFTX0VYVEVOU0lPTlMgJiYgbWF0ZXJpYWwuZXh0ZW5zaW9ucy5tdWx0aURyYXcgPT09IHRydWUgJiYgZXh0ZW5zaW9ucy5oYXMoICdXRUJHTF9tdWx0aV9kcmF3JyApLAoKCQkJcmVuZGVyZXJFeHRlbnNpb25GcmFnRGVwdGg6IElTX1dFQkdMMiB8fCBleHRlbnNpb25zLmhhcyggJ0VYVF9mcmFnX2RlcHRoJyApLAoJCQlyZW5kZXJlckV4dGVuc2lvbkRyYXdCdWZmZXJzOiBJU19XRUJHTDIgfHwgZXh0ZW5zaW9ucy5oYXMoICdXRUJHTF9kcmF3X2J1ZmZlcnMnICksCgkJCXJlbmRlcmVyRXh0ZW5zaW9uU2hhZGVyVGV4dHVyZUxvZDogSVNfV0VCR0wyIHx8IGV4dGVuc2lvbnMuaGFzKCAnRVhUX3NoYWRlcl90ZXh0dXJlX2xvZCcgKSwKCQkJcmVuZGVyZXJFeHRlbnNpb25QYXJhbGxlbFNoYWRlckNvbXBpbGU6IGV4dGVuc2lvbnMuaGFzKCAnS0hSX3BhcmFsbGVsX3NoYWRlcl9jb21waWxlJyApLAoKCQkJY3VzdG9tUHJvZ3JhbUNhY2hlS2V5OiBtYXRlcmlhbC5jdXN0b21Qcm9ncmFtQ2FjaGVLZXkoKQoKCQl9OwoKCQkvLyB0aGUgdXNhZ2Ugb2YgZ2V0Q2hhbm5lbCgpIGRldGVybWluZXMgdGhlIGFjdGl2ZSB0ZXh0dXJlIGNoYW5uZWxzIGZvciB0aGlzIHNoYWRlcgoKCQlwYXJhbWV0ZXJzLnZlcnRleFV2MXMgPSBfYWN0aXZlQ2hhbm5lbHMuaGFzKCAxICk7CgkJcGFyYW1ldGVycy52ZXJ0ZXhVdjJzID0gX2FjdGl2ZUNoYW5uZWxzLmhhcyggMiApOwoJCXBhcmFtZXRlcnMudmVydGV4VXYzcyA9IF9hY3RpdmVDaGFubmVscy5oYXMoIDMgKTsKCgkJX2FjdGl2ZUNoYW5uZWxzLmNsZWFyKCk7CgoJCXJldHVybiBwYXJhbWV0ZXJzOwoKCX0KCglmdW5jdGlvbiBnZXRQcm9ncmFtQ2FjaGVLZXkoIHBhcmFtZXRlcnMgKSB7CgoJCWNvbnN0IGFycmF5ID0gW107CgoJCWlmICggcGFyYW1ldGVycy5zaGFkZXJJRCApIHsKCgkJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuc2hhZGVySUQgKTsKCgkJfSBlbHNlIHsKCgkJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuY3VzdG9tVmVydGV4U2hhZGVySUQgKTsKCQkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5jdXN0b21GcmFnbWVudFNoYWRlcklEICk7CgoJCX0KCgkJaWYgKCBwYXJhbWV0ZXJzLmRlZmluZXMgIT09IHVuZGVmaW5lZCApIHsKCgkJCWZvciAoIGNvbnN0IG5hbWUgaW4gcGFyYW1ldGVycy5kZWZpbmVzICkgewoKCQkJCWFycmF5LnB1c2goIG5hbWUgKTsKCQkJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuZGVmaW5lc1sgbmFtZSBdICk7CgoJCQl9CgoJCX0KCgkJaWYgKCBwYXJhbWV0ZXJzLmlzUmF3U2hhZGVyTWF0ZXJpYWwgPT09IGZhbHNlICkgewoKCQkJZ2V0UHJvZ3JhbUNhY2hlS2V5UGFyYW1ldGVycyggYXJyYXksIHBhcmFtZXRlcnMgKTsKCQkJZ2V0UHJvZ3JhbUNhY2hlS2V5Qm9vbGVhbnMoIGFycmF5LCBwYXJhbWV0ZXJzICk7CgkJCWFycmF5LnB1c2goIHJlbmRlcmVyLm91dHB1dENvbG9yU3BhY2UgKTsKCgkJfQoKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmN1c3RvbVByb2dyYW1DYWNoZUtleSApOwoKCQlyZXR1cm4gYXJyYXkuam9pbigpOwoKCX0KCglmdW5jdGlvbiBnZXRQcm9ncmFtQ2FjaGVLZXlQYXJhbWV0ZXJzKCBhcnJheSwgcGFyYW1ldGVycyApIHsKCgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5wcmVjaXNpb24gKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLm91dHB1dENvbG9yU3BhY2UgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmVudk1hcE1vZGUgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmVudk1hcEN1YmVVVkhlaWdodCApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubWFwVXYgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmFscGhhTWFwVXYgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmxpZ2h0TWFwVXYgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmFvTWFwVXYgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmJ1bXBNYXBVdiApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubm9ybWFsTWFwVXYgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmRpc3BsYWNlbWVudE1hcFV2ICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5lbWlzc2l2ZU1hcFV2ICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5tZXRhbG5lc3NNYXBVdiApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMucm91Z2huZXNzTWFwVXYgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmFuaXNvdHJvcHlNYXBVdiApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuY2xlYXJjb2F0TWFwVXYgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLmNsZWFyY29hdE5vcm1hbE1hcFV2ICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5jbGVhcmNvYXRSb3VnaG5lc3NNYXBVdiApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuaXJpZGVzY2VuY2VNYXBVdiApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuaXJpZGVzY2VuY2VUaGlja25lc3NNYXBVdiApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuc2hlZW5Db2xvck1hcFV2ICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5zaGVlblJvdWdobmVzc01hcFV2ICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5zcGVjdWxhck1hcFV2ICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5zcGVjdWxhckNvbG9yTWFwVXYgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLnNwZWN1bGFySW50ZW5zaXR5TWFwVXYgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLnRyYW5zbWlzc2lvbk1hcFV2ICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy50aGlja25lc3NNYXBVdiApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuY29tYmluZSApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuZm9nRXhwMiApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuc2l6ZUF0dGVudWF0aW9uICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5tb3JwaFRhcmdldHNDb3VudCApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubW9ycGhBdHRyaWJ1dGVDb3VudCApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubnVtRGlyTGlnaHRzICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5udW1Qb2ludExpZ2h0cyApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubnVtU3BvdExpZ2h0cyApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubnVtU3BvdExpZ2h0TWFwcyApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubnVtSGVtaUxpZ2h0cyApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubnVtUmVjdEFyZWFMaWdodHMgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLm51bURpckxpZ2h0U2hhZG93cyApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubnVtUG9pbnRMaWdodFNoYWRvd3MgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLm51bVNwb3RMaWdodFNoYWRvd3MgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLm51bVNwb3RMaWdodFNoYWRvd3NXaXRoTWFwcyApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubnVtTGlnaHRQcm9iZXMgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLnNoYWRvd01hcFR5cGUgKTsKCQlhcnJheS5wdXNoKCBwYXJhbWV0ZXJzLnRvbmVNYXBwaW5nICk7CgkJYXJyYXkucHVzaCggcGFyYW1ldGVycy5udW1DbGlwcGluZ1BsYW5lcyApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMubnVtQ2xpcEludGVyc2VjdGlvbiApOwoJCWFycmF5LnB1c2goIHBhcmFtZXRlcnMuZGVwdGhQYWNraW5nICk7CgoJfQoKCWZ1bmN0aW9uIGdldFByb2dyYW1DYWNoZUtleUJvb2xlYW5zKCBhcnJheSwgcGFyYW1ldGVycyApIHsKCgkJX3Byb2dyYW1MYXllcnMuZGlzYWJsZUFsbCgpOwoKCQlpZiAoIHBhcmFtZXRlcnMuaXNXZWJHTDIgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDAgKTsKCQlpZiAoIHBhcmFtZXRlcnMuc3VwcG9ydHNWZXJ0ZXhUZXh0dXJlcyApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggMSApOwoJCWlmICggcGFyYW1ldGVycy5pbnN0YW5jaW5nICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCAyICk7CgkJaWYgKCBwYXJhbWV0ZXJzLmluc3RhbmNpbmdDb2xvciApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggMyApOwoJCWlmICggcGFyYW1ldGVycy5tYXRjYXAgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDQgKTsKCQlpZiAoIHBhcmFtZXRlcnMuZW52TWFwICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCA1ICk7CgkJaWYgKCBwYXJhbWV0ZXJzLm5vcm1hbE1hcE9iamVjdFNwYWNlICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCA2ICk7CgkJaWYgKCBwYXJhbWV0ZXJzLm5vcm1hbE1hcFRhbmdlbnRTcGFjZSApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggNyApOwoJCWlmICggcGFyYW1ldGVycy5jbGVhcmNvYXQgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDggKTsKCQlpZiAoIHBhcmFtZXRlcnMuaXJpZGVzY2VuY2UgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDkgKTsKCQlpZiAoIHBhcmFtZXRlcnMuYWxwaGFUZXN0ICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCAxMCApOwoJCWlmICggcGFyYW1ldGVycy52ZXJ0ZXhDb2xvcnMgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDExICk7CgkJaWYgKCBwYXJhbWV0ZXJzLnZlcnRleEFscGhhcyApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggMTIgKTsKCQlpZiAoIHBhcmFtZXRlcnMudmVydGV4VXYxcyApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggMTMgKTsKCQlpZiAoIHBhcmFtZXRlcnMudmVydGV4VXYycyApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggMTQgKTsKCQlpZiAoIHBhcmFtZXRlcnMudmVydGV4VXYzcyApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggMTUgKTsKCQlpZiAoIHBhcmFtZXRlcnMudmVydGV4VGFuZ2VudHMgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDE2ICk7CgkJaWYgKCBwYXJhbWV0ZXJzLmFuaXNvdHJvcHkgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDE3ICk7CgkJaWYgKCBwYXJhbWV0ZXJzLmFscGhhSGFzaCApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggMTggKTsKCQlpZiAoIHBhcmFtZXRlcnMuYmF0Y2hpbmcgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDE5ICk7CgoJCWFycmF5LnB1c2goIF9wcm9ncmFtTGF5ZXJzLm1hc2sgKTsKCQlfcHJvZ3JhbUxheWVycy5kaXNhYmxlQWxsKCk7CgoJCWlmICggcGFyYW1ldGVycy5mb2cgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDAgKTsKCQlpZiAoIHBhcmFtZXRlcnMudXNlRm9nICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCAxICk7CgkJaWYgKCBwYXJhbWV0ZXJzLmZsYXRTaGFkaW5nICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCAyICk7CgkJaWYgKCBwYXJhbWV0ZXJzLmxvZ2FyaXRobWljRGVwdGhCdWZmZXIgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDMgKTsKCQlpZiAoIHBhcmFtZXRlcnMuc2tpbm5pbmcgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDQgKTsKCQlpZiAoIHBhcmFtZXRlcnMubW9ycGhUYXJnZXRzICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCA1ICk7CgkJaWYgKCBwYXJhbWV0ZXJzLm1vcnBoTm9ybWFscyApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggNiApOwoJCWlmICggcGFyYW1ldGVycy5tb3JwaENvbG9ycyApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggNyApOwoJCWlmICggcGFyYW1ldGVycy5wcmVtdWx0aXBsaWVkQWxwaGEgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDggKTsKCQlpZiAoIHBhcmFtZXRlcnMuc2hhZG93TWFwRW5hYmxlZCApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggOSApOwoJCWlmICggcGFyYW1ldGVycy51c2VMZWdhY3lMaWdodHMgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDEwICk7CgkJaWYgKCBwYXJhbWV0ZXJzLmRvdWJsZVNpZGVkICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCAxMSApOwoJCWlmICggcGFyYW1ldGVycy5mbGlwU2lkZWQgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDEyICk7CgkJaWYgKCBwYXJhbWV0ZXJzLnVzZURlcHRoUGFja2luZyApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggMTMgKTsKCQlpZiAoIHBhcmFtZXRlcnMuZGl0aGVyaW5nICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCAxNCApOwoJCWlmICggcGFyYW1ldGVycy50cmFuc21pc3Npb24gKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDE1ICk7CgkJaWYgKCBwYXJhbWV0ZXJzLnNoZWVuICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCAxNiApOwoJCWlmICggcGFyYW1ldGVycy5vcGFxdWUgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDE3ICk7CgkJaWYgKCBwYXJhbWV0ZXJzLnBvaW50c1V2cyApCgkJCV9wcm9ncmFtTGF5ZXJzLmVuYWJsZSggMTggKTsKCQlpZiAoIHBhcmFtZXRlcnMuZGVjb2RlVmlkZW9UZXh0dXJlICkKCQkJX3Byb2dyYW1MYXllcnMuZW5hYmxlKCAxOSApOwoJCWlmICggcGFyYW1ldGVycy5hbHBoYVRvQ292ZXJhZ2UgKQoJCQlfcHJvZ3JhbUxheWVycy5lbmFibGUoIDIwICk7CgoJCWFycmF5LnB1c2goIF9wcm9ncmFtTGF5ZXJzLm1hc2sgKTsKCgl9CgoJZnVuY3Rpb24gZ2V0VW5pZm9ybXMoIG1hdGVyaWFsICkgewoKCQljb25zdCBzaGFkZXJJRCA9IHNoYWRlcklEc1sgbWF0ZXJpYWwudHlwZSBdOwoJCWxldCB1bmlmb3JtczsKCgkJaWYgKCBzaGFkZXJJRCApIHsKCgkJCWNvbnN0IHNoYWRlciA9IFNoYWRlckxpYlsgc2hhZGVySUQgXTsKCQkJdW5pZm9ybXMgPSBVbmlmb3Jtc1V0aWxzLmNsb25lKCBzaGFkZXIudW5pZm9ybXMgKTsKCgkJfSBlbHNlIHsKCgkJCXVuaWZvcm1zID0gbWF0ZXJpYWwudW5pZm9ybXM7CgoJCX0KCgkJcmV0dXJuIHVuaWZvcm1zOwoKCX0KCglmdW5jdGlvbiBhY3F1aXJlUHJvZ3JhbSggcGFyYW1ldGVycywgY2FjaGVLZXkgKSB7CgoJCWxldCBwcm9ncmFtOwoKCQkvLyBDaGVjayBpZiBjb2RlIGhhcyBiZWVuIGFscmVhZHkgY29tcGlsZWQKCQlmb3IgKCBsZXQgcCA9IDAsIHBsID0gcHJvZ3JhbXMubGVuZ3RoOyBwIDwgcGw7IHAgKysgKSB7CgoJCQljb25zdCBwcmVleGlzdGluZ1Byb2dyYW0gPSBwcm9ncmFtc1sgcCBdOwoKCQkJaWYgKCBwcmVleGlzdGluZ1Byb2dyYW0uY2FjaGVLZXkgPT09IGNhY2hlS2V5ICkgewoKCQkJCXByb2dyYW0gPSBwcmVleGlzdGluZ1Byb2dyYW07CgkJCQkrKyBwcm9ncmFtLnVzZWRUaW1lczsKCgkJCQlicmVhazsKCgkJCX0KCgkJfQoKCQlpZiAoIHByb2dyYW0gPT09IHVuZGVmaW5lZCApIHsKCgkJCXByb2dyYW0gPSBuZXcgV2ViR0xQcm9ncmFtKCByZW5kZXJlciwgY2FjaGVLZXksIHBhcmFtZXRlcnMsIGJpbmRpbmdTdGF0ZXMgKTsKCQkJcHJvZ3JhbXMucHVzaCggcHJvZ3JhbSApOwoKCQl9CgoJCXJldHVybiBwcm9ncmFtOwoKCX0KCglmdW5jdGlvbiByZWxlYXNlUHJvZ3JhbSggcHJvZ3JhbSApIHsKCgkJaWYgKCAtLSBwcm9ncmFtLnVzZWRUaW1lcyA9PT0gMCApIHsKCgkJCS8vIFJlbW92ZSBmcm9tIHVub3JkZXJlZCBzZXQKCQkJY29uc3QgaSA9IHByb2dyYW1zLmluZGV4T2YoIHByb2dyYW0gKTsKCQkJcHJvZ3JhbXNbIGkgXSA9IHByb2dyYW1zWyBwcm9ncmFtcy5sZW5ndGggLSAxIF07CgkJCXByb2dyYW1zLnBvcCgpOwoKCQkJLy8gRnJlZSBXZWJHTCByZXNvdXJjZXMKCQkJcHJvZ3JhbS5kZXN0cm95KCk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gcmVsZWFzZVNoYWRlckNhY2hlKCBtYXRlcmlhbCApIHsKCgkJX2N1c3RvbVNoYWRlcnMucmVtb3ZlKCBtYXRlcmlhbCApOwoKCX0KCglmdW5jdGlvbiBkaXNwb3NlKCkgewoKCQlfY3VzdG9tU2hhZGVycy5kaXNwb3NlKCk7CgoJfQoKCXJldHVybiB7CgkJZ2V0UGFyYW1ldGVyczogZ2V0UGFyYW1ldGVycywKCQlnZXRQcm9ncmFtQ2FjaGVLZXk6IGdldFByb2dyYW1DYWNoZUtleSwKCQlnZXRVbmlmb3JtczogZ2V0VW5pZm9ybXMsCgkJYWNxdWlyZVByb2dyYW06IGFjcXVpcmVQcm9ncmFtLAoJCXJlbGVhc2VQcm9ncmFtOiByZWxlYXNlUHJvZ3JhbSwKCQlyZWxlYXNlU2hhZGVyQ2FjaGU6IHJlbGVhc2VTaGFkZXJDYWNoZSwKCQkvLyBFeHBvc2VkIGZvciByZXNvdXJjZSBtb25pdG9yaW5nICYgZXJyb3IgZmVlZGJhY2sgdmlhIHJlbmRlcmVyLmluZm86CgkJcHJvZ3JhbXM6IHByb2dyYW1zLAoJCWRpc3Bvc2U6IGRpc3Bvc2UKCX07Cgp9CgpmdW5jdGlvbiBXZWJHTFByb3BlcnRpZXMoKSB7CgoJbGV0IHByb3BlcnRpZXMgPSBuZXcgV2Vha01hcCgpOwoKCWZ1bmN0aW9uIGdldCggb2JqZWN0ICkgewoKCQlsZXQgbWFwID0gcHJvcGVydGllcy5nZXQoIG9iamVjdCApOwoKCQlpZiAoIG1hcCA9PT0gdW5kZWZpbmVkICkgewoKCQkJbWFwID0ge307CgkJCXByb3BlcnRpZXMuc2V0KCBvYmplY3QsIG1hcCApOwoKCQl9CgoJCXJldHVybiBtYXA7CgoJfQoKCWZ1bmN0aW9uIHJlbW92ZSggb2JqZWN0ICkgewoKCQlwcm9wZXJ0aWVzLmRlbGV0ZSggb2JqZWN0ICk7CgoJfQoKCWZ1bmN0aW9uIHVwZGF0ZSggb2JqZWN0LCBrZXksIHZhbHVlICkgewoKCQlwcm9wZXJ0aWVzLmdldCggb2JqZWN0IClbIGtleSBdID0gdmFsdWU7CgoJfQoKCWZ1bmN0aW9uIGRpc3Bvc2UoKSB7CgoJCXByb3BlcnRpZXMgPSBuZXcgV2Vha01hcCgpOwoKCX0KCglyZXR1cm4gewoJCWdldDogZ2V0LAoJCXJlbW92ZTogcmVtb3ZlLAoJCXVwZGF0ZTogdXBkYXRlLAoJCWRpc3Bvc2U6IGRpc3Bvc2UKCX07Cgp9CgpmdW5jdGlvbiBwYWludGVyU29ydFN0YWJsZSggYSwgYiApIHsKCglpZiAoIGEuZ3JvdXBPcmRlciAhPT0gYi5ncm91cE9yZGVyICkgewoKCQlyZXR1cm4gYS5ncm91cE9yZGVyIC0gYi5ncm91cE9yZGVyOwoKCX0gZWxzZSBpZiAoIGEucmVuZGVyT3JkZXIgIT09IGIucmVuZGVyT3JkZXIgKSB7CgoJCXJldHVybiBhLnJlbmRlck9yZGVyIC0gYi5yZW5kZXJPcmRlcjsKCgl9IGVsc2UgaWYgKCBhLm1hdGVyaWFsLmlkICE9PSBiLm1hdGVyaWFsLmlkICkgewoKCQlyZXR1cm4gYS5tYXRlcmlhbC5pZCAtIGIubWF0ZXJpYWwuaWQ7CgoJfSBlbHNlIGlmICggYS56ICE9PSBiLnogKSB7CgoJCXJldHVybiBhLnogLSBiLno7CgoJfSBlbHNlIHsKCgkJcmV0dXJuIGEuaWQgLSBiLmlkOwoKCX0KCn0KCmZ1bmN0aW9uIHJldmVyc2VQYWludGVyU29ydFN0YWJsZSggYSwgYiApIHsKCglpZiAoIGEuZ3JvdXBPcmRlciAhPT0gYi5ncm91cE9yZGVyICkgewoKCQlyZXR1cm4gYS5ncm91cE9yZGVyIC0gYi5ncm91cE9yZGVyOwoKCX0gZWxzZSBpZiAoIGEucmVuZGVyT3JkZXIgIT09IGIucmVuZGVyT3JkZXIgKSB7CgoJCXJldHVybiBhLnJlbmRlck9yZGVyIC0gYi5yZW5kZXJPcmRlcjsKCgl9IGVsc2UgaWYgKCBhLnogIT09IGIueiApIHsKCgkJcmV0dXJuIGIueiAtIGEuejsKCgl9IGVsc2UgewoKCQlyZXR1cm4gYS5pZCAtIGIuaWQ7CgoJfQoKfQoKCmZ1bmN0aW9uIFdlYkdMUmVuZGVyTGlzdCgpIHsKCgljb25zdCByZW5kZXJJdGVtcyA9IFtdOwoJbGV0IHJlbmRlckl0ZW1zSW5kZXggPSAwOwoKCWNvbnN0IG9wYXF1ZSA9IFtdOwoJY29uc3QgdHJhbnNtaXNzaXZlID0gW107Cgljb25zdCB0cmFuc3BhcmVudCA9IFtdOwoKCWZ1bmN0aW9uIGluaXQoKSB7CgoJCXJlbmRlckl0ZW1zSW5kZXggPSAwOwoKCQlvcGFxdWUubGVuZ3RoID0gMDsKCQl0cmFuc21pc3NpdmUubGVuZ3RoID0gMDsKCQl0cmFuc3BhcmVudC5sZW5ndGggPSAwOwoKCX0KCglmdW5jdGlvbiBnZXROZXh0UmVuZGVySXRlbSggb2JqZWN0LCBnZW9tZXRyeSwgbWF0ZXJpYWwsIGdyb3VwT3JkZXIsIHosIGdyb3VwICkgewoKCQlsZXQgcmVuZGVySXRlbSA9IHJlbmRlckl0ZW1zWyByZW5kZXJJdGVtc0luZGV4IF07CgoJCWlmICggcmVuZGVySXRlbSA9PT0gdW5kZWZpbmVkICkgewoKCQkJcmVuZGVySXRlbSA9IHsKCQkJCWlkOiBvYmplY3QuaWQsCgkJCQlvYmplY3Q6IG9iamVjdCwKCQkJCWdlb21ldHJ5OiBnZW9tZXRyeSwKCQkJCW1hdGVyaWFsOiBtYXRlcmlhbCwKCQkJCWdyb3VwT3JkZXI6IGdyb3VwT3JkZXIsCgkJCQlyZW5kZXJPcmRlcjogb2JqZWN0LnJlbmRlck9yZGVyLAoJCQkJejogeiwKCQkJCWdyb3VwOiBncm91cAoJCQl9OwoKCQkJcmVuZGVySXRlbXNbIHJlbmRlckl0ZW1zSW5kZXggXSA9IHJlbmRlckl0ZW07CgoJCX0gZWxzZSB7CgoJCQlyZW5kZXJJdGVtLmlkID0gb2JqZWN0LmlkOwoJCQlyZW5kZXJJdGVtLm9iamVjdCA9IG9iamVjdDsKCQkJcmVuZGVySXRlbS5nZW9tZXRyeSA9IGdlb21ldHJ5OwoJCQlyZW5kZXJJdGVtLm1hdGVyaWFsID0gbWF0ZXJpYWw7CgkJCXJlbmRlckl0ZW0uZ3JvdXBPcmRlciA9IGdyb3VwT3JkZXI7CgkJCXJlbmRlckl0ZW0ucmVuZGVyT3JkZXIgPSBvYmplY3QucmVuZGVyT3JkZXI7CgkJCXJlbmRlckl0ZW0ueiA9IHo7CgkJCXJlbmRlckl0ZW0uZ3JvdXAgPSBncm91cDsKCgkJfQoKCQlyZW5kZXJJdGVtc0luZGV4ICsrOwoKCQlyZXR1cm4gcmVuZGVySXRlbTsKCgl9CgoJZnVuY3Rpb24gcHVzaCggb2JqZWN0LCBnZW9tZXRyeSwgbWF0ZXJpYWwsIGdyb3VwT3JkZXIsIHosIGdyb3VwICkgewoKCQljb25zdCByZW5kZXJJdGVtID0gZ2V0TmV4dFJlbmRlckl0ZW0oIG9iamVjdCwgZ2VvbWV0cnksIG1hdGVyaWFsLCBncm91cE9yZGVyLCB6LCBncm91cCApOwoKCQlpZiAoIG1hdGVyaWFsLnRyYW5zbWlzc2lvbiA+IDAuMCApIHsKCgkJCXRyYW5zbWlzc2l2ZS5wdXNoKCByZW5kZXJJdGVtICk7CgoJCX0gZWxzZSBpZiAoIG1hdGVyaWFsLnRyYW5zcGFyZW50ID09PSB0cnVlICkgewoKCQkJdHJhbnNwYXJlbnQucHVzaCggcmVuZGVySXRlbSApOwoKCQl9IGVsc2UgewoKCQkJb3BhcXVlLnB1c2goIHJlbmRlckl0ZW0gKTsKCgkJfQoKCX0KCglmdW5jdGlvbiB1bnNoaWZ0KCBvYmplY3QsIGdlb21ldHJ5LCBtYXRlcmlhbCwgZ3JvdXBPcmRlciwgeiwgZ3JvdXAgKSB7CgoJCWNvbnN0IHJlbmRlckl0ZW0gPSBnZXROZXh0UmVuZGVySXRlbSggb2JqZWN0LCBnZW9tZXRyeSwgbWF0ZXJpYWwsIGdyb3VwT3JkZXIsIHosIGdyb3VwICk7CgoJCWlmICggbWF0ZXJpYWwudHJhbnNtaXNzaW9uID4gMC4wICkgewoKCQkJdHJhbnNtaXNzaXZlLnVuc2hpZnQoIHJlbmRlckl0ZW0gKTsKCgkJfSBlbHNlIGlmICggbWF0ZXJpYWwudHJhbnNwYXJlbnQgPT09IHRydWUgKSB7CgoJCQl0cmFuc3BhcmVudC51bnNoaWZ0KCByZW5kZXJJdGVtICk7CgoJCX0gZWxzZSB7CgoJCQlvcGFxdWUudW5zaGlmdCggcmVuZGVySXRlbSApOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIHNvcnQoIGN1c3RvbU9wYXF1ZVNvcnQsIGN1c3RvbVRyYW5zcGFyZW50U29ydCApIHsKCgkJaWYgKCBvcGFxdWUubGVuZ3RoID4gMSApIG9wYXF1ZS5zb3J0KCBjdXN0b21PcGFxdWVTb3J0IHx8IHBhaW50ZXJTb3J0U3RhYmxlICk7CgkJaWYgKCB0cmFuc21pc3NpdmUubGVuZ3RoID4gMSApIHRyYW5zbWlzc2l2ZS5zb3J0KCBjdXN0b21UcmFuc3BhcmVudFNvcnQgfHwgcmV2ZXJzZVBhaW50ZXJTb3J0U3RhYmxlICk7CgkJaWYgKCB0cmFuc3BhcmVudC5sZW5ndGggPiAxICkgdHJhbnNwYXJlbnQuc29ydCggY3VzdG9tVHJhbnNwYXJlbnRTb3J0IHx8IHJldmVyc2VQYWludGVyU29ydFN0YWJsZSApOwoKCX0KCglmdW5jdGlvbiBmaW5pc2goKSB7CgoJCS8vIENsZWFyIHJlZmVyZW5jZXMgZnJvbSBpbmFjdGl2ZSByZW5kZXJJdGVtcyBpbiB0aGUgbGlzdAoKCQlmb3IgKCBsZXQgaSA9IHJlbmRlckl0ZW1zSW5kZXgsIGlsID0gcmVuZGVySXRlbXMubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQljb25zdCByZW5kZXJJdGVtID0gcmVuZGVySXRlbXNbIGkgXTsKCgkJCWlmICggcmVuZGVySXRlbS5pZCA9PT0gbnVsbCApIGJyZWFrOwoKCQkJcmVuZGVySXRlbS5pZCA9IG51bGw7CgkJCXJlbmRlckl0ZW0ub2JqZWN0ID0gbnVsbDsKCQkJcmVuZGVySXRlbS5nZW9tZXRyeSA9IG51bGw7CgkJCXJlbmRlckl0ZW0ubWF0ZXJpYWwgPSBudWxsOwoJCQlyZW5kZXJJdGVtLmdyb3VwID0gbnVsbDsKCgkJfQoKCX0KCglyZXR1cm4gewoKCQlvcGFxdWU6IG9wYXF1ZSwKCQl0cmFuc21pc3NpdmU6IHRyYW5zbWlzc2l2ZSwKCQl0cmFuc3BhcmVudDogdHJhbnNwYXJlbnQsCgoJCWluaXQ6IGluaXQsCgkJcHVzaDogcHVzaCwKCQl1bnNoaWZ0OiB1bnNoaWZ0LAoJCWZpbmlzaDogZmluaXNoLAoKCQlzb3J0OiBzb3J0Cgl9OwoKfQoKZnVuY3Rpb24gV2ViR0xSZW5kZXJMaXN0cygpIHsKCglsZXQgbGlzdHMgPSBuZXcgV2Vha01hcCgpOwoKCWZ1bmN0aW9uIGdldCggc2NlbmUsIHJlbmRlckNhbGxEZXB0aCApIHsKCgkJY29uc3QgbGlzdEFycmF5ID0gbGlzdHMuZ2V0KCBzY2VuZSApOwoJCWxldCBsaXN0OwoKCQlpZiAoIGxpc3RBcnJheSA9PT0gdW5kZWZpbmVkICkgewoKCQkJbGlzdCA9IG5ldyBXZWJHTFJlbmRlckxpc3QoKTsKCQkJbGlzdHMuc2V0KCBzY2VuZSwgWyBsaXN0IF0gKTsKCgkJfSBlbHNlIHsKCgkJCWlmICggcmVuZGVyQ2FsbERlcHRoID49IGxpc3RBcnJheS5sZW5ndGggKSB7CgoJCQkJbGlzdCA9IG5ldyBXZWJHTFJlbmRlckxpc3QoKTsKCQkJCWxpc3RBcnJheS5wdXNoKCBsaXN0ICk7CgoJCQl9IGVsc2UgewoKCQkJCWxpc3QgPSBsaXN0QXJyYXlbIHJlbmRlckNhbGxEZXB0aCBdOwoKCQkJfQoKCQl9CgoJCXJldHVybiBsaXN0OwoKCX0KCglmdW5jdGlvbiBkaXNwb3NlKCkgewoKCQlsaXN0cyA9IG5ldyBXZWFrTWFwKCk7CgoJfQoKCXJldHVybiB7CgkJZ2V0OiBnZXQsCgkJZGlzcG9zZTogZGlzcG9zZQoJfTsKCn0KCmZ1bmN0aW9uIFVuaWZvcm1zQ2FjaGUoKSB7CgoJY29uc3QgbGlnaHRzID0ge307CgoJcmV0dXJuIHsKCgkJZ2V0OiBmdW5jdGlvbiAoIGxpZ2h0ICkgewoKCQkJaWYgKCBsaWdodHNbIGxpZ2h0LmlkIF0gIT09IHVuZGVmaW5lZCApIHsKCgkJCQlyZXR1cm4gbGlnaHRzWyBsaWdodC5pZCBdOwoKCQkJfQoKCQkJbGV0IHVuaWZvcm1zOwoKCQkJc3dpdGNoICggbGlnaHQudHlwZSApIHsKCgkJCQljYXNlICdEaXJlY3Rpb25hbExpZ2h0JzoKCQkJCQl1bmlmb3JtcyA9IHsKCQkJCQkJZGlyZWN0aW9uOiBuZXcgVmVjdG9yMygpLAoJCQkJCQljb2xvcjogbmV3IENvbG9yKCkKCQkJCQl9OwoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgJ1Nwb3RMaWdodCc6CgkJCQkJdW5pZm9ybXMgPSB7CgkJCQkJCXBvc2l0aW9uOiBuZXcgVmVjdG9yMygpLAoJCQkJCQlkaXJlY3Rpb246IG5ldyBWZWN0b3IzKCksCgkJCQkJCWNvbG9yOiBuZXcgQ29sb3IoKSwKCQkJCQkJZGlzdGFuY2U6IDAsCgkJCQkJCWNvbmVDb3M6IDAsCgkJCQkJCXBlbnVtYnJhQ29zOiAwLAoJCQkJCQlkZWNheTogMAoJCQkJCX07CgkJCQkJYnJlYWs7CgoJCQkJY2FzZSAnUG9pbnRMaWdodCc6CgkJCQkJdW5pZm9ybXMgPSB7CgkJCQkJCXBvc2l0aW9uOiBuZXcgVmVjdG9yMygpLAoJCQkJCQljb2xvcjogbmV3IENvbG9yKCksCgkJCQkJCWRpc3RhbmNlOiAwLAoJCQkJCQlkZWNheTogMAoJCQkJCX07CgkJCQkJYnJlYWs7CgoJCQkJY2FzZSAnSGVtaXNwaGVyZUxpZ2h0JzoKCQkJCQl1bmlmb3JtcyA9IHsKCQkJCQkJZGlyZWN0aW9uOiBuZXcgVmVjdG9yMygpLAoJCQkJCQlza3lDb2xvcjogbmV3IENvbG9yKCksCgkJCQkJCWdyb3VuZENvbG9yOiBuZXcgQ29sb3IoKQoJCQkJCX07CgkJCQkJYnJlYWs7CgoJCQkJY2FzZSAnUmVjdEFyZWFMaWdodCc6CgkJCQkJdW5pZm9ybXMgPSB7CgkJCQkJCWNvbG9yOiBuZXcgQ29sb3IoKSwKCQkJCQkJcG9zaXRpb246IG5ldyBWZWN0b3IzKCksCgkJCQkJCWhhbGZXaWR0aDogbmV3IFZlY3RvcjMoKSwKCQkJCQkJaGFsZkhlaWdodDogbmV3IFZlY3RvcjMoKQoJCQkJCX07CgkJCQkJYnJlYWs7CgoJCQl9CgoJCQlsaWdodHNbIGxpZ2h0LmlkIF0gPSB1bmlmb3JtczsKCgkJCXJldHVybiB1bmlmb3JtczsKCgkJfQoKCX07Cgp9CgpmdW5jdGlvbiBTaGFkb3dVbmlmb3Jtc0NhY2hlKCkgewoKCWNvbnN0IGxpZ2h0cyA9IHt9OwoKCXJldHVybiB7CgoJCWdldDogZnVuY3Rpb24gKCBsaWdodCApIHsKCgkJCWlmICggbGlnaHRzWyBsaWdodC5pZCBdICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJcmV0dXJuIGxpZ2h0c1sgbGlnaHQuaWQgXTsKCgkJCX0KCgkJCWxldCB1bmlmb3JtczsKCgkJCXN3aXRjaCAoIGxpZ2h0LnR5cGUgKSB7CgoJCQkJY2FzZSAnRGlyZWN0aW9uYWxMaWdodCc6CgkJCQkJdW5pZm9ybXMgPSB7CgkJCQkJCXNoYWRvd0JpYXM6IDAsCgkJCQkJCXNoYWRvd05vcm1hbEJpYXM6IDAsCgkJCQkJCXNoYWRvd1JhZGl1czogMSwKCQkJCQkJc2hhZG93TWFwU2l6ZTogbmV3IFZlY3RvcjIoKQoJCQkJCX07CgkJCQkJYnJlYWs7CgoJCQkJY2FzZSAnU3BvdExpZ2h0JzoKCQkJCQl1bmlmb3JtcyA9IHsKCQkJCQkJc2hhZG93QmlhczogMCwKCQkJCQkJc2hhZG93Tm9ybWFsQmlhczogMCwKCQkJCQkJc2hhZG93UmFkaXVzOiAxLAoJCQkJCQlzaGFkb3dNYXBTaXplOiBuZXcgVmVjdG9yMigpCgkJCQkJfTsKCQkJCQlicmVhazsKCgkJCQljYXNlICdQb2ludExpZ2h0JzoKCQkJCQl1bmlmb3JtcyA9IHsKCQkJCQkJc2hhZG93QmlhczogMCwKCQkJCQkJc2hhZG93Tm9ybWFsQmlhczogMCwKCQkJCQkJc2hhZG93UmFkaXVzOiAxLAoJCQkJCQlzaGFkb3dNYXBTaXplOiBuZXcgVmVjdG9yMigpLAoJCQkJCQlzaGFkb3dDYW1lcmFOZWFyOiAxLAoJCQkJCQlzaGFkb3dDYW1lcmFGYXI6IDEwMDAKCQkJCQl9OwoJCQkJCWJyZWFrOwoKCQkJCS8vIFRPRE8gKGFiZWxuYXRpb24pOiBzZXQgUmVjdEFyZWFMaWdodCBzaGFkb3cgdW5pZm9ybXMKCgkJCX0KCgkJCWxpZ2h0c1sgbGlnaHQuaWQgXSA9IHVuaWZvcm1zOwoKCQkJcmV0dXJuIHVuaWZvcm1zOwoKCQl9CgoJfTsKCn0KCgoKbGV0IG5leHRWZXJzaW9uID0gMDsKCmZ1bmN0aW9uIHNoYWRvd0Nhc3RpbmdBbmRUZXh0dXJpbmdMaWdodHNGaXJzdCggbGlnaHRBLCBsaWdodEIgKSB7CgoJcmV0dXJuICggbGlnaHRCLmNhc3RTaGFkb3cgPyAyIDogMCApIC0gKCBsaWdodEEuY2FzdFNoYWRvdyA/IDIgOiAwICkgKyAoIGxpZ2h0Qi5tYXAgPyAxIDogMCApIC0gKCBsaWdodEEubWFwID8gMSA6IDAgKTsKCn0KCmZ1bmN0aW9uIFdlYkdMTGlnaHRzKCBleHRlbnNpb25zLCBjYXBhYmlsaXRpZXMgKSB7CgoJY29uc3QgY2FjaGUgPSBuZXcgVW5pZm9ybXNDYWNoZSgpOwoKCWNvbnN0IHNoYWRvd0NhY2hlID0gU2hhZG93VW5pZm9ybXNDYWNoZSgpOwoKCWNvbnN0IHN0YXRlID0gewoKCQl2ZXJzaW9uOiAwLAoKCQloYXNoOiB7CgkJCWRpcmVjdGlvbmFsTGVuZ3RoOiAtIDEsCgkJCXBvaW50TGVuZ3RoOiAtIDEsCgkJCXNwb3RMZW5ndGg6IC0gMSwKCQkJcmVjdEFyZWFMZW5ndGg6IC0gMSwKCQkJaGVtaUxlbmd0aDogLSAxLAoKCQkJbnVtRGlyZWN0aW9uYWxTaGFkb3dzOiAtIDEsCgkJCW51bVBvaW50U2hhZG93czogLSAxLAoJCQludW1TcG90U2hhZG93czogLSAxLAoJCQludW1TcG90TWFwczogLSAxLAoKCQkJbnVtTGlnaHRQcm9iZXM6IC0gMQoJCX0sCgoJCWFtYmllbnQ6IFsgMCwgMCwgMCBdLAoJCXByb2JlOiBbXSwKCQlkaXJlY3Rpb25hbDogW10sCgkJZGlyZWN0aW9uYWxTaGFkb3c6IFtdLAoJCWRpcmVjdGlvbmFsU2hhZG93TWFwOiBbXSwKCQlkaXJlY3Rpb25hbFNoYWRvd01hdHJpeDogW10sCgkJc3BvdDogW10sCgkJc3BvdExpZ2h0TWFwOiBbXSwKCQlzcG90U2hhZG93OiBbXSwKCQlzcG90U2hhZG93TWFwOiBbXSwKCQlzcG90TGlnaHRNYXRyaXg6IFtdLAoJCXJlY3RBcmVhOiBbXSwKCQlyZWN0QXJlYUxUQzE6IG51bGwsCgkJcmVjdEFyZWFMVEMyOiBudWxsLAoJCXBvaW50OiBbXSwKCQlwb2ludFNoYWRvdzogW10sCgkJcG9pbnRTaGFkb3dNYXA6IFtdLAoJCXBvaW50U2hhZG93TWF0cml4OiBbXSwKCQloZW1pOiBbXSwKCQludW1TcG90TGlnaHRTaGFkb3dzV2l0aE1hcHM6IDAsCgkJbnVtTGlnaHRQcm9iZXM6IDAKCgl9OwoKCWZvciAoIGxldCBpID0gMDsgaSA8IDk7IGkgKysgKSBzdGF0ZS5wcm9iZS5wdXNoKCBuZXcgVmVjdG9yMygpICk7CgoJY29uc3QgdmVjdG9yMyA9IG5ldyBWZWN0b3IzKCk7Cgljb25zdCBtYXRyaXg0ID0gbmV3IE1hdHJpeDQoKTsKCWNvbnN0IG1hdHJpeDQyID0gbmV3IE1hdHJpeDQoKTsKCglmdW5jdGlvbiBzZXR1cCggbGlnaHRzLCB1c2VMZWdhY3lMaWdodHMgKSB7CgoJCWxldCByID0gMCwgZyA9IDAsIGIgPSAwOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA5OyBpICsrICkgc3RhdGUucHJvYmVbIGkgXS5zZXQoIDAsIDAsIDAgKTsKCgkJbGV0IGRpcmVjdGlvbmFsTGVuZ3RoID0gMDsKCQlsZXQgcG9pbnRMZW5ndGggPSAwOwoJCWxldCBzcG90TGVuZ3RoID0gMDsKCQlsZXQgcmVjdEFyZWFMZW5ndGggPSAwOwoJCWxldCBoZW1pTGVuZ3RoID0gMDsKCgkJbGV0IG51bURpcmVjdGlvbmFsU2hhZG93cyA9IDA7CgkJbGV0IG51bVBvaW50U2hhZG93cyA9IDA7CgkJbGV0IG51bVNwb3RTaGFkb3dzID0gMDsKCQlsZXQgbnVtU3BvdE1hcHMgPSAwOwoJCWxldCBudW1TcG90U2hhZG93c1dpdGhNYXBzID0gMDsKCgkJbGV0IG51bUxpZ2h0UHJvYmVzID0gMDsKCgkJLy8gb3JkZXJpbmcgOiBbc2hhZG93IGNhc3RpbmcgKyBtYXAgdGV4dHVyaW5nLCBtYXAgdGV4dHVyaW5nLCBzaGFkb3cgY2FzdGluZywgbm9uZSBdCgkJbGlnaHRzLnNvcnQoIHNoYWRvd0Nhc3RpbmdBbmRUZXh0dXJpbmdMaWdodHNGaXJzdCApOwoKCQkvLyBhcnRpc3QtZnJpZW5kbHkgbGlnaHQgaW50ZW5zaXR5IHNjYWxpbmcgZmFjdG9yCgkJY29uc3Qgc2NhbGVGYWN0b3IgPSAoIHVzZUxlZ2FjeUxpZ2h0cyA9PT0gdHJ1ZSApID8gTWF0aC5QSSA6IDE7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IGxpZ2h0cy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgbGlnaHQgPSBsaWdodHNbIGkgXTsKCgkJCWNvbnN0IGNvbG9yID0gbGlnaHQuY29sb3I7CgkJCWNvbnN0IGludGVuc2l0eSA9IGxpZ2h0LmludGVuc2l0eTsKCQkJY29uc3QgZGlzdGFuY2UgPSBsaWdodC5kaXN0YW5jZTsKCgkJCWNvbnN0IHNoYWRvd01hcCA9ICggbGlnaHQuc2hhZG93ICYmIGxpZ2h0LnNoYWRvdy5tYXAgKSA/IGxpZ2h0LnNoYWRvdy5tYXAudGV4dHVyZSA6IG51bGw7CgoJCQlpZiAoIGxpZ2h0LmlzQW1iaWVudExpZ2h0ICkgewoKCQkJCXIgKz0gY29sb3IuciAqIGludGVuc2l0eSAqIHNjYWxlRmFjdG9yOwoJCQkJZyArPSBjb2xvci5nICogaW50ZW5zaXR5ICogc2NhbGVGYWN0b3I7CgkJCQliICs9IGNvbG9yLmIgKiBpbnRlbnNpdHkgKiBzY2FsZUZhY3RvcjsKCgkJCX0gZWxzZSBpZiAoIGxpZ2h0LmlzTGlnaHRQcm9iZSApIHsKCgkJCQlmb3IgKCBsZXQgaiA9IDA7IGogPCA5OyBqICsrICkgewoKCQkJCQlzdGF0ZS5wcm9iZVsgaiBdLmFkZFNjYWxlZFZlY3RvciggbGlnaHQuc2guY29lZmZpY2llbnRzWyBqIF0sIGludGVuc2l0eSApOwoKCQkJCX0KCgkJCQludW1MaWdodFByb2JlcyArKzsKCgkJCX0gZWxzZSBpZiAoIGxpZ2h0LmlzRGlyZWN0aW9uYWxMaWdodCApIHsKCgkJCQljb25zdCB1bmlmb3JtcyA9IGNhY2hlLmdldCggbGlnaHQgKTsKCgkJCQl1bmlmb3Jtcy5jb2xvci5jb3B5KCBsaWdodC5jb2xvciApLm11bHRpcGx5U2NhbGFyKCBsaWdodC5pbnRlbnNpdHkgKiBzY2FsZUZhY3RvciApOwoKCQkJCWlmICggbGlnaHQuY2FzdFNoYWRvdyApIHsKCgkJCQkJY29uc3Qgc2hhZG93ID0gbGlnaHQuc2hhZG93OwoKCQkJCQljb25zdCBzaGFkb3dVbmlmb3JtcyA9IHNoYWRvd0NhY2hlLmdldCggbGlnaHQgKTsKCgkJCQkJc2hhZG93VW5pZm9ybXMuc2hhZG93QmlhcyA9IHNoYWRvdy5iaWFzOwoJCQkJCXNoYWRvd1VuaWZvcm1zLnNoYWRvd05vcm1hbEJpYXMgPSBzaGFkb3cubm9ybWFsQmlhczsKCQkJCQlzaGFkb3dVbmlmb3Jtcy5zaGFkb3dSYWRpdXMgPSBzaGFkb3cucmFkaXVzOwoJCQkJCXNoYWRvd1VuaWZvcm1zLnNoYWRvd01hcFNpemUgPSBzaGFkb3cubWFwU2l6ZTsKCgkJCQkJc3RhdGUuZGlyZWN0aW9uYWxTaGFkb3dbIGRpcmVjdGlvbmFsTGVuZ3RoIF0gPSBzaGFkb3dVbmlmb3JtczsKCQkJCQlzdGF0ZS5kaXJlY3Rpb25hbFNoYWRvd01hcFsgZGlyZWN0aW9uYWxMZW5ndGggXSA9IHNoYWRvd01hcDsKCQkJCQlzdGF0ZS5kaXJlY3Rpb25hbFNoYWRvd01hdHJpeFsgZGlyZWN0aW9uYWxMZW5ndGggXSA9IGxpZ2h0LnNoYWRvdy5tYXRyaXg7CgoJCQkJCW51bURpcmVjdGlvbmFsU2hhZG93cyArKzsKCgkJCQl9CgoJCQkJc3RhdGUuZGlyZWN0aW9uYWxbIGRpcmVjdGlvbmFsTGVuZ3RoIF0gPSB1bmlmb3JtczsKCgkJCQlkaXJlY3Rpb25hbExlbmd0aCArKzsKCgkJCX0gZWxzZSBpZiAoIGxpZ2h0LmlzU3BvdExpZ2h0ICkgewoKCQkJCWNvbnN0IHVuaWZvcm1zID0gY2FjaGUuZ2V0KCBsaWdodCApOwoKCQkJCXVuaWZvcm1zLnBvc2l0aW9uLnNldEZyb21NYXRyaXhQb3NpdGlvbiggbGlnaHQubWF0cml4V29ybGQgKTsKCgkJCQl1bmlmb3Jtcy5jb2xvci5jb3B5KCBjb2xvciApLm11bHRpcGx5U2NhbGFyKCBpbnRlbnNpdHkgKiBzY2FsZUZhY3RvciApOwoJCQkJdW5pZm9ybXMuZGlzdGFuY2UgPSBkaXN0YW5jZTsKCgkJCQl1bmlmb3Jtcy5jb25lQ29zID0gTWF0aC5jb3MoIGxpZ2h0LmFuZ2xlICk7CgkJCQl1bmlmb3Jtcy5wZW51bWJyYUNvcyA9IE1hdGguY29zKCBsaWdodC5hbmdsZSAqICggMSAtIGxpZ2h0LnBlbnVtYnJhICkgKTsKCQkJCXVuaWZvcm1zLmRlY2F5ID0gbGlnaHQuZGVjYXk7CgoJCQkJc3RhdGUuc3BvdFsgc3BvdExlbmd0aCBdID0gdW5pZm9ybXM7CgoJCQkJY29uc3Qgc2hhZG93ID0gbGlnaHQuc2hhZG93OwoKCQkJCWlmICggbGlnaHQubWFwICkgewoKCQkJCQlzdGF0ZS5zcG90TGlnaHRNYXBbIG51bVNwb3RNYXBzIF0gPSBsaWdodC5tYXA7CgkJCQkJbnVtU3BvdE1hcHMgKys7CgoJCQkJCS8vIG1ha2Ugc3VyZSB0aGUgbGlnaHRNYXRyaXggaXMgdXAgdG8gZGF0ZQoJCQkJCS8vIFRPRE8gOiBkbyBpdCBpZiByZXF1aXJlZCBvbmx5CgkJCQkJc2hhZG93LnVwZGF0ZU1hdHJpY2VzKCBsaWdodCApOwoKCQkJCQlpZiAoIGxpZ2h0LmNhc3RTaGFkb3cgKSBudW1TcG90U2hhZG93c1dpdGhNYXBzICsrOwoKCQkJCX0KCgkJCQlzdGF0ZS5zcG90TGlnaHRNYXRyaXhbIHNwb3RMZW5ndGggXSA9IHNoYWRvdy5tYXRyaXg7CgoJCQkJaWYgKCBsaWdodC5jYXN0U2hhZG93ICkgewoKCQkJCQljb25zdCBzaGFkb3dVbmlmb3JtcyA9IHNoYWRvd0NhY2hlLmdldCggbGlnaHQgKTsKCgkJCQkJc2hhZG93VW5pZm9ybXMuc2hhZG93QmlhcyA9IHNoYWRvdy5iaWFzOwoJCQkJCXNoYWRvd1VuaWZvcm1zLnNoYWRvd05vcm1hbEJpYXMgPSBzaGFkb3cubm9ybWFsQmlhczsKCQkJCQlzaGFkb3dVbmlmb3Jtcy5zaGFkb3dSYWRpdXMgPSBzaGFkb3cucmFkaXVzOwoJCQkJCXNoYWRvd1VuaWZvcm1zLnNoYWRvd01hcFNpemUgPSBzaGFkb3cubWFwU2l6ZTsKCgkJCQkJc3RhdGUuc3BvdFNoYWRvd1sgc3BvdExlbmd0aCBdID0gc2hhZG93VW5pZm9ybXM7CgkJCQkJc3RhdGUuc3BvdFNoYWRvd01hcFsgc3BvdExlbmd0aCBdID0gc2hhZG93TWFwOwoKCQkJCQludW1TcG90U2hhZG93cyArKzsKCgkJCQl9CgoJCQkJc3BvdExlbmd0aCArKzsKCgkJCX0gZWxzZSBpZiAoIGxpZ2h0LmlzUmVjdEFyZWFMaWdodCApIHsKCgkJCQljb25zdCB1bmlmb3JtcyA9IGNhY2hlLmdldCggbGlnaHQgKTsKCgkJCQl1bmlmb3Jtcy5jb2xvci5jb3B5KCBjb2xvciApLm11bHRpcGx5U2NhbGFyKCBpbnRlbnNpdHkgKTsKCgkJCQl1bmlmb3Jtcy5oYWxmV2lkdGguc2V0KCBsaWdodC53aWR0aCAqIDAuNSwgMC4wLCAwLjAgKTsKCQkJCXVuaWZvcm1zLmhhbGZIZWlnaHQuc2V0KCAwLjAsIGxpZ2h0LmhlaWdodCAqIDAuNSwgMC4wICk7CgoJCQkJc3RhdGUucmVjdEFyZWFbIHJlY3RBcmVhTGVuZ3RoIF0gPSB1bmlmb3JtczsKCgkJCQlyZWN0QXJlYUxlbmd0aCArKzsKCgkJCX0gZWxzZSBpZiAoIGxpZ2h0LmlzUG9pbnRMaWdodCApIHsKCgkJCQljb25zdCB1bmlmb3JtcyA9IGNhY2hlLmdldCggbGlnaHQgKTsKCgkJCQl1bmlmb3Jtcy5jb2xvci5jb3B5KCBsaWdodC5jb2xvciApLm11bHRpcGx5U2NhbGFyKCBsaWdodC5pbnRlbnNpdHkgKiBzY2FsZUZhY3RvciApOwoJCQkJdW5pZm9ybXMuZGlzdGFuY2UgPSBsaWdodC5kaXN0YW5jZTsKCQkJCXVuaWZvcm1zLmRlY2F5ID0gbGlnaHQuZGVjYXk7CgoJCQkJaWYgKCBsaWdodC5jYXN0U2hhZG93ICkgewoKCQkJCQljb25zdCBzaGFkb3cgPSBsaWdodC5zaGFkb3c7CgoJCQkJCWNvbnN0IHNoYWRvd1VuaWZvcm1zID0gc2hhZG93Q2FjaGUuZ2V0KCBsaWdodCApOwoKCQkJCQlzaGFkb3dVbmlmb3Jtcy5zaGFkb3dCaWFzID0gc2hhZG93LmJpYXM7CgkJCQkJc2hhZG93VW5pZm9ybXMuc2hhZG93Tm9ybWFsQmlhcyA9IHNoYWRvdy5ub3JtYWxCaWFzOwoJCQkJCXNoYWRvd1VuaWZvcm1zLnNoYWRvd1JhZGl1cyA9IHNoYWRvdy5yYWRpdXM7CgkJCQkJc2hhZG93VW5pZm9ybXMuc2hhZG93TWFwU2l6ZSA9IHNoYWRvdy5tYXBTaXplOwoJCQkJCXNoYWRvd1VuaWZvcm1zLnNoYWRvd0NhbWVyYU5lYXIgPSBzaGFkb3cuY2FtZXJhLm5lYXI7CgkJCQkJc2hhZG93VW5pZm9ybXMuc2hhZG93Q2FtZXJhRmFyID0gc2hhZG93LmNhbWVyYS5mYXI7CgoJCQkJCXN0YXRlLnBvaW50U2hhZG93WyBwb2ludExlbmd0aCBdID0gc2hhZG93VW5pZm9ybXM7CgkJCQkJc3RhdGUucG9pbnRTaGFkb3dNYXBbIHBvaW50TGVuZ3RoIF0gPSBzaGFkb3dNYXA7CgkJCQkJc3RhdGUucG9pbnRTaGFkb3dNYXRyaXhbIHBvaW50TGVuZ3RoIF0gPSBsaWdodC5zaGFkb3cubWF0cml4OwoKCQkJCQludW1Qb2ludFNoYWRvd3MgKys7CgoJCQkJfQoKCQkJCXN0YXRlLnBvaW50WyBwb2ludExlbmd0aCBdID0gdW5pZm9ybXM7CgoJCQkJcG9pbnRMZW5ndGggKys7CgoJCQl9IGVsc2UgaWYgKCBsaWdodC5pc0hlbWlzcGhlcmVMaWdodCApIHsKCgkJCQljb25zdCB1bmlmb3JtcyA9IGNhY2hlLmdldCggbGlnaHQgKTsKCgkJCQl1bmlmb3Jtcy5za3lDb2xvci5jb3B5KCBsaWdodC5jb2xvciApLm11bHRpcGx5U2NhbGFyKCBpbnRlbnNpdHkgKiBzY2FsZUZhY3RvciApOwoJCQkJdW5pZm9ybXMuZ3JvdW5kQ29sb3IuY29weSggbGlnaHQuZ3JvdW5kQ29sb3IgKS5tdWx0aXBseVNjYWxhciggaW50ZW5zaXR5ICogc2NhbGVGYWN0b3IgKTsKCgkJCQlzdGF0ZS5oZW1pWyBoZW1pTGVuZ3RoIF0gPSB1bmlmb3JtczsKCgkJCQloZW1pTGVuZ3RoICsrOwoKCQkJfQoKCQl9CgoJCWlmICggcmVjdEFyZWFMZW5ndGggPiAwICkgewoKCQkJaWYgKCBjYXBhYmlsaXRpZXMuaXNXZWJHTDIgKSB7CgoJCQkJLy8gV2ViR0wgMgoKCQkJCWlmICggZXh0ZW5zaW9ucy5oYXMoICdPRVNfdGV4dHVyZV9mbG9hdF9saW5lYXInICkgPT09IHRydWUgKSB7CgoJCQkJCXN0YXRlLnJlY3RBcmVhTFRDMSA9IFVuaWZvcm1zTGliLkxUQ19GTE9BVF8xOwoJCQkJCXN0YXRlLnJlY3RBcmVhTFRDMiA9IFVuaWZvcm1zTGliLkxUQ19GTE9BVF8yOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXN0YXRlLnJlY3RBcmVhTFRDMSA9IFVuaWZvcm1zTGliLkxUQ19IQUxGXzE7CgkJCQkJc3RhdGUucmVjdEFyZWFMVEMyID0gVW5pZm9ybXNMaWIuTFRDX0hBTEZfMjsKCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCS8vIFdlYkdMIDEKCgkJCQlpZiAoIGV4dGVuc2lvbnMuaGFzKCAnT0VTX3RleHR1cmVfZmxvYXRfbGluZWFyJyApID09PSB0cnVlICkgewoKCQkJCQlzdGF0ZS5yZWN0QXJlYUxUQzEgPSBVbmlmb3Jtc0xpYi5MVENfRkxPQVRfMTsKCQkJCQlzdGF0ZS5yZWN0QXJlYUxUQzIgPSBVbmlmb3Jtc0xpYi5MVENfRkxPQVRfMjsKCgkJCQl9IGVsc2UgaWYgKCBleHRlbnNpb25zLmhhcyggJ09FU190ZXh0dXJlX2hhbGZfZmxvYXRfbGluZWFyJyApID09PSB0cnVlICkgewoKCQkJCQlzdGF0ZS5yZWN0QXJlYUxUQzEgPSBVbmlmb3Jtc0xpYi5MVENfSEFMRl8xOwoJCQkJCXN0YXRlLnJlY3RBcmVhTFRDMiA9IFVuaWZvcm1zTGliLkxUQ19IQUxGXzI7CgoJCQkJfSBlbHNlIHsKCgkJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IFVuYWJsZSB0byB1c2UgUmVjdEFyZWFMaWdodC4gTWlzc2luZyBXZWJHTCBleHRlbnNpb25zLicgKTsKCgkJCQl9CgoJCQl9CgoJCX0KCgkJc3RhdGUuYW1iaWVudFsgMCBdID0gcjsKCQlzdGF0ZS5hbWJpZW50WyAxIF0gPSBnOwoJCXN0YXRlLmFtYmllbnRbIDIgXSA9IGI7CgoJCWNvbnN0IGhhc2ggPSBzdGF0ZS5oYXNoOwoKCQlpZiAoIGhhc2guZGlyZWN0aW9uYWxMZW5ndGggIT09IGRpcmVjdGlvbmFsTGVuZ3RoIHx8CgkJCWhhc2gucG9pbnRMZW5ndGggIT09IHBvaW50TGVuZ3RoIHx8CgkJCWhhc2guc3BvdExlbmd0aCAhPT0gc3BvdExlbmd0aCB8fAoJCQloYXNoLnJlY3RBcmVhTGVuZ3RoICE9PSByZWN0QXJlYUxlbmd0aCB8fAoJCQloYXNoLmhlbWlMZW5ndGggIT09IGhlbWlMZW5ndGggfHwKCQkJaGFzaC5udW1EaXJlY3Rpb25hbFNoYWRvd3MgIT09IG51bURpcmVjdGlvbmFsU2hhZG93cyB8fAoJCQloYXNoLm51bVBvaW50U2hhZG93cyAhPT0gbnVtUG9pbnRTaGFkb3dzIHx8CgkJCWhhc2gubnVtU3BvdFNoYWRvd3MgIT09IG51bVNwb3RTaGFkb3dzIHx8CgkJCWhhc2gubnVtU3BvdE1hcHMgIT09IG51bVNwb3RNYXBzIHx8CgkJCWhhc2gubnVtTGlnaHRQcm9iZXMgIT09IG51bUxpZ2h0UHJvYmVzICkgewoKCQkJc3RhdGUuZGlyZWN0aW9uYWwubGVuZ3RoID0gZGlyZWN0aW9uYWxMZW5ndGg7CgkJCXN0YXRlLnNwb3QubGVuZ3RoID0gc3BvdExlbmd0aDsKCQkJc3RhdGUucmVjdEFyZWEubGVuZ3RoID0gcmVjdEFyZWFMZW5ndGg7CgkJCXN0YXRlLnBvaW50Lmxlbmd0aCA9IHBvaW50TGVuZ3RoOwoJCQlzdGF0ZS5oZW1pLmxlbmd0aCA9IGhlbWlMZW5ndGg7CgoJCQlzdGF0ZS5kaXJlY3Rpb25hbFNoYWRvdy5sZW5ndGggPSBudW1EaXJlY3Rpb25hbFNoYWRvd3M7CgkJCXN0YXRlLmRpcmVjdGlvbmFsU2hhZG93TWFwLmxlbmd0aCA9IG51bURpcmVjdGlvbmFsU2hhZG93czsKCQkJc3RhdGUucG9pbnRTaGFkb3cubGVuZ3RoID0gbnVtUG9pbnRTaGFkb3dzOwoJCQlzdGF0ZS5wb2ludFNoYWRvd01hcC5sZW5ndGggPSBudW1Qb2ludFNoYWRvd3M7CgkJCXN0YXRlLnNwb3RTaGFkb3cubGVuZ3RoID0gbnVtU3BvdFNoYWRvd3M7CgkJCXN0YXRlLnNwb3RTaGFkb3dNYXAubGVuZ3RoID0gbnVtU3BvdFNoYWRvd3M7CgkJCXN0YXRlLmRpcmVjdGlvbmFsU2hhZG93TWF0cml4Lmxlbmd0aCA9IG51bURpcmVjdGlvbmFsU2hhZG93czsKCQkJc3RhdGUucG9pbnRTaGFkb3dNYXRyaXgubGVuZ3RoID0gbnVtUG9pbnRTaGFkb3dzOwoJCQlzdGF0ZS5zcG90TGlnaHRNYXRyaXgubGVuZ3RoID0gbnVtU3BvdFNoYWRvd3MgKyBudW1TcG90TWFwcyAtIG51bVNwb3RTaGFkb3dzV2l0aE1hcHM7CgkJCXN0YXRlLnNwb3RMaWdodE1hcC5sZW5ndGggPSBudW1TcG90TWFwczsKCQkJc3RhdGUubnVtU3BvdExpZ2h0U2hhZG93c1dpdGhNYXBzID0gbnVtU3BvdFNoYWRvd3NXaXRoTWFwczsKCQkJc3RhdGUubnVtTGlnaHRQcm9iZXMgPSBudW1MaWdodFByb2JlczsKCgkJCWhhc2guZGlyZWN0aW9uYWxMZW5ndGggPSBkaXJlY3Rpb25hbExlbmd0aDsKCQkJaGFzaC5wb2ludExlbmd0aCA9IHBvaW50TGVuZ3RoOwoJCQloYXNoLnNwb3RMZW5ndGggPSBzcG90TGVuZ3RoOwoJCQloYXNoLnJlY3RBcmVhTGVuZ3RoID0gcmVjdEFyZWFMZW5ndGg7CgkJCWhhc2guaGVtaUxlbmd0aCA9IGhlbWlMZW5ndGg7CgoJCQloYXNoLm51bURpcmVjdGlvbmFsU2hhZG93cyA9IG51bURpcmVjdGlvbmFsU2hhZG93czsKCQkJaGFzaC5udW1Qb2ludFNoYWRvd3MgPSBudW1Qb2ludFNoYWRvd3M7CgkJCWhhc2gubnVtU3BvdFNoYWRvd3MgPSBudW1TcG90U2hhZG93czsKCQkJaGFzaC5udW1TcG90TWFwcyA9IG51bVNwb3RNYXBzOwoKCQkJaGFzaC5udW1MaWdodFByb2JlcyA9IG51bUxpZ2h0UHJvYmVzOwoKCQkJc3RhdGUudmVyc2lvbiA9IG5leHRWZXJzaW9uICsrOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIHNldHVwVmlldyggbGlnaHRzLCBjYW1lcmEgKSB7CgoJCWxldCBkaXJlY3Rpb25hbExlbmd0aCA9IDA7CgkJbGV0IHBvaW50TGVuZ3RoID0gMDsKCQlsZXQgc3BvdExlbmd0aCA9IDA7CgkJbGV0IHJlY3RBcmVhTGVuZ3RoID0gMDsKCQlsZXQgaGVtaUxlbmd0aCA9IDA7CgoJCWNvbnN0IHZpZXdNYXRyaXggPSBjYW1lcmEubWF0cml4V29ybGRJbnZlcnNlOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBsaWdodHMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWNvbnN0IGxpZ2h0ID0gbGlnaHRzWyBpIF07CgoJCQlpZiAoIGxpZ2h0LmlzRGlyZWN0aW9uYWxMaWdodCApIHsKCgkJCQljb25zdCB1bmlmb3JtcyA9IHN0YXRlLmRpcmVjdGlvbmFsWyBkaXJlY3Rpb25hbExlbmd0aCBdOwoKCQkJCXVuaWZvcm1zLmRpcmVjdGlvbi5zZXRGcm9tTWF0cml4UG9zaXRpb24oIGxpZ2h0Lm1hdHJpeFdvcmxkICk7CgkJCQl2ZWN0b3IzLnNldEZyb21NYXRyaXhQb3NpdGlvbiggbGlnaHQudGFyZ2V0Lm1hdHJpeFdvcmxkICk7CgkJCQl1bmlmb3Jtcy5kaXJlY3Rpb24uc3ViKCB2ZWN0b3IzICk7CgkJCQl1bmlmb3Jtcy5kaXJlY3Rpb24udHJhbnNmb3JtRGlyZWN0aW9uKCB2aWV3TWF0cml4ICk7CgoJCQkJZGlyZWN0aW9uYWxMZW5ndGggKys7CgoJCQl9IGVsc2UgaWYgKCBsaWdodC5pc1Nwb3RMaWdodCApIHsKCgkJCQljb25zdCB1bmlmb3JtcyA9IHN0YXRlLnNwb3RbIHNwb3RMZW5ndGggXTsKCgkJCQl1bmlmb3Jtcy5wb3NpdGlvbi5zZXRGcm9tTWF0cml4UG9zaXRpb24oIGxpZ2h0Lm1hdHJpeFdvcmxkICk7CgkJCQl1bmlmb3Jtcy5wb3NpdGlvbi5hcHBseU1hdHJpeDQoIHZpZXdNYXRyaXggKTsKCgkJCQl1bmlmb3Jtcy5kaXJlY3Rpb24uc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCBsaWdodC5tYXRyaXhXb3JsZCApOwoJCQkJdmVjdG9yMy5zZXRGcm9tTWF0cml4UG9zaXRpb24oIGxpZ2h0LnRhcmdldC5tYXRyaXhXb3JsZCApOwoJCQkJdW5pZm9ybXMuZGlyZWN0aW9uLnN1YiggdmVjdG9yMyApOwoJCQkJdW5pZm9ybXMuZGlyZWN0aW9uLnRyYW5zZm9ybURpcmVjdGlvbiggdmlld01hdHJpeCApOwoKCQkJCXNwb3RMZW5ndGggKys7CgoJCQl9IGVsc2UgaWYgKCBsaWdodC5pc1JlY3RBcmVhTGlnaHQgKSB7CgoJCQkJY29uc3QgdW5pZm9ybXMgPSBzdGF0ZS5yZWN0QXJlYVsgcmVjdEFyZWFMZW5ndGggXTsKCgkJCQl1bmlmb3Jtcy5wb3NpdGlvbi5zZXRGcm9tTWF0cml4UG9zaXRpb24oIGxpZ2h0Lm1hdHJpeFdvcmxkICk7CgkJCQl1bmlmb3Jtcy5wb3NpdGlvbi5hcHBseU1hdHJpeDQoIHZpZXdNYXRyaXggKTsKCgkJCQkvLyBleHRyYWN0IGxvY2FsIHJvdGF0aW9uIG9mIGxpZ2h0IHRvIGRlcml2ZSB3aWR0aC9oZWlnaHQgaGFsZiB2ZWN0b3JzCgkJCQltYXRyaXg0Mi5pZGVudGl0eSgpOwoJCQkJbWF0cml4NC5jb3B5KCBsaWdodC5tYXRyaXhXb3JsZCApOwoJCQkJbWF0cml4NC5wcmVtdWx0aXBseSggdmlld01hdHJpeCApOwoJCQkJbWF0cml4NDIuZXh0cmFjdFJvdGF0aW9uKCBtYXRyaXg0ICk7CgoJCQkJdW5pZm9ybXMuaGFsZldpZHRoLnNldCggbGlnaHQud2lkdGggKiAwLjUsIDAuMCwgMC4wICk7CgkJCQl1bmlmb3Jtcy5oYWxmSGVpZ2h0LnNldCggMC4wLCBsaWdodC5oZWlnaHQgKiAwLjUsIDAuMCApOwoKCQkJCXVuaWZvcm1zLmhhbGZXaWR0aC5hcHBseU1hdHJpeDQoIG1hdHJpeDQyICk7CgkJCQl1bmlmb3Jtcy5oYWxmSGVpZ2h0LmFwcGx5TWF0cml4NCggbWF0cml4NDIgKTsKCgkJCQlyZWN0QXJlYUxlbmd0aCArKzsKCgkJCX0gZWxzZSBpZiAoIGxpZ2h0LmlzUG9pbnRMaWdodCApIHsKCgkJCQljb25zdCB1bmlmb3JtcyA9IHN0YXRlLnBvaW50WyBwb2ludExlbmd0aCBdOwoKCQkJCXVuaWZvcm1zLnBvc2l0aW9uLnNldEZyb21NYXRyaXhQb3NpdGlvbiggbGlnaHQubWF0cml4V29ybGQgKTsKCQkJCXVuaWZvcm1zLnBvc2l0aW9uLmFwcGx5TWF0cml4NCggdmlld01hdHJpeCApOwoKCQkJCXBvaW50TGVuZ3RoICsrOwoKCQkJfSBlbHNlIGlmICggbGlnaHQuaXNIZW1pc3BoZXJlTGlnaHQgKSB7CgoJCQkJY29uc3QgdW5pZm9ybXMgPSBzdGF0ZS5oZW1pWyBoZW1pTGVuZ3RoIF07CgoJCQkJdW5pZm9ybXMuZGlyZWN0aW9uLnNldEZyb21NYXRyaXhQb3NpdGlvbiggbGlnaHQubWF0cml4V29ybGQgKTsKCQkJCXVuaWZvcm1zLmRpcmVjdGlvbi50cmFuc2Zvcm1EaXJlY3Rpb24oIHZpZXdNYXRyaXggKTsKCgkJCQloZW1pTGVuZ3RoICsrOwoKCQkJfQoKCQl9CgoJfQoKCXJldHVybiB7CgkJc2V0dXA6IHNldHVwLAoJCXNldHVwVmlldzogc2V0dXBWaWV3LAoJCXN0YXRlOiBzdGF0ZQoJfTsKCn0KCmZ1bmN0aW9uIFdlYkdMUmVuZGVyU3RhdGUoIGV4dGVuc2lvbnMsIGNhcGFiaWxpdGllcyApIHsKCgljb25zdCBsaWdodHMgPSBuZXcgV2ViR0xMaWdodHMoIGV4dGVuc2lvbnMsIGNhcGFiaWxpdGllcyApOwoKCWNvbnN0IGxpZ2h0c0FycmF5ID0gW107Cgljb25zdCBzaGFkb3dzQXJyYXkgPSBbXTsKCglmdW5jdGlvbiBpbml0KCkgewoKCQlsaWdodHNBcnJheS5sZW5ndGggPSAwOwoJCXNoYWRvd3NBcnJheS5sZW5ndGggPSAwOwoKCX0KCglmdW5jdGlvbiBwdXNoTGlnaHQoIGxpZ2h0ICkgewoKCQlsaWdodHNBcnJheS5wdXNoKCBsaWdodCApOwoKCX0KCglmdW5jdGlvbiBwdXNoU2hhZG93KCBzaGFkb3dMaWdodCApIHsKCgkJc2hhZG93c0FycmF5LnB1c2goIHNoYWRvd0xpZ2h0ICk7CgoJfQoKCWZ1bmN0aW9uIHNldHVwTGlnaHRzKCB1c2VMZWdhY3lMaWdodHMgKSB7CgoJCWxpZ2h0cy5zZXR1cCggbGlnaHRzQXJyYXksIHVzZUxlZ2FjeUxpZ2h0cyApOwoKCX0KCglmdW5jdGlvbiBzZXR1cExpZ2h0c1ZpZXcoIGNhbWVyYSApIHsKCgkJbGlnaHRzLnNldHVwVmlldyggbGlnaHRzQXJyYXksIGNhbWVyYSApOwoKCX0KCgljb25zdCBzdGF0ZSA9IHsKCQlsaWdodHNBcnJheTogbGlnaHRzQXJyYXksCgkJc2hhZG93c0FycmF5OiBzaGFkb3dzQXJyYXksCgoJCWxpZ2h0czogbGlnaHRzCgl9OwoKCXJldHVybiB7CgkJaW5pdDogaW5pdCwKCQlzdGF0ZTogc3RhdGUsCgkJc2V0dXBMaWdodHM6IHNldHVwTGlnaHRzLAoJCXNldHVwTGlnaHRzVmlldzogc2V0dXBMaWdodHNWaWV3LAoKCQlwdXNoTGlnaHQ6IHB1c2hMaWdodCwKCQlwdXNoU2hhZG93OiBwdXNoU2hhZG93Cgl9OwoKfQoKZnVuY3Rpb24gV2ViR0xSZW5kZXJTdGF0ZXMoIGV4dGVuc2lvbnMsIGNhcGFiaWxpdGllcyApIHsKCglsZXQgcmVuZGVyU3RhdGVzID0gbmV3IFdlYWtNYXAoKTsKCglmdW5jdGlvbiBnZXQoIHNjZW5lLCByZW5kZXJDYWxsRGVwdGggPSAwICkgewoKCQljb25zdCByZW5kZXJTdGF0ZUFycmF5ID0gcmVuZGVyU3RhdGVzLmdldCggc2NlbmUgKTsKCQlsZXQgcmVuZGVyU3RhdGU7CgoJCWlmICggcmVuZGVyU3RhdGVBcnJheSA9PT0gdW5kZWZpbmVkICkgewoKCQkJcmVuZGVyU3RhdGUgPSBuZXcgV2ViR0xSZW5kZXJTdGF0ZSggZXh0ZW5zaW9ucywgY2FwYWJpbGl0aWVzICk7CgkJCXJlbmRlclN0YXRlcy5zZXQoIHNjZW5lLCBbIHJlbmRlclN0YXRlIF0gKTsKCgkJfSBlbHNlIHsKCgkJCWlmICggcmVuZGVyQ2FsbERlcHRoID49IHJlbmRlclN0YXRlQXJyYXkubGVuZ3RoICkgewoKCQkJCXJlbmRlclN0YXRlID0gbmV3IFdlYkdMUmVuZGVyU3RhdGUoIGV4dGVuc2lvbnMsIGNhcGFiaWxpdGllcyApOwoJCQkJcmVuZGVyU3RhdGVBcnJheS5wdXNoKCByZW5kZXJTdGF0ZSApOwoKCQkJfSBlbHNlIHsKCgkJCQlyZW5kZXJTdGF0ZSA9IHJlbmRlclN0YXRlQXJyYXlbIHJlbmRlckNhbGxEZXB0aCBdOwoKCQkJfQoKCQl9CgoJCXJldHVybiByZW5kZXJTdGF0ZTsKCgl9CgoJZnVuY3Rpb24gZGlzcG9zZSgpIHsKCgkJcmVuZGVyU3RhdGVzID0gbmV3IFdlYWtNYXAoKTsKCgl9CgoJcmV0dXJuIHsKCQlnZXQ6IGdldCwKCQlkaXNwb3NlOiBkaXNwb3NlCgl9OwoKfQoKY2xhc3MgTWVzaERlcHRoTWF0ZXJpYWwgZXh0ZW5kcyBNYXRlcmlhbCB7CgoJY29uc3RydWN0b3IoIHBhcmFtZXRlcnMgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNNZXNoRGVwdGhNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdNZXNoRGVwdGhNYXRlcmlhbCc7CgoJCXRoaXMuZGVwdGhQYWNraW5nID0gQmFzaWNEZXB0aFBhY2tpbmc7CgoJCXRoaXMubWFwID0gbnVsbDsKCgkJdGhpcy5hbHBoYU1hcCA9IG51bGw7CgoJCXRoaXMuZGlzcGxhY2VtZW50TWFwID0gbnVsbDsKCQl0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gMTsKCQl0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSAwOwoKCQl0aGlzLndpcmVmcmFtZSA9IGZhbHNlOwoJCXRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gMTsKCgkJdGhpcy5zZXRWYWx1ZXMoIHBhcmFtZXRlcnMgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5kZXB0aFBhY2tpbmcgPSBzb3VyY2UuZGVwdGhQYWNraW5nOwoKCQl0aGlzLm1hcCA9IHNvdXJjZS5tYXA7CgoJCXRoaXMuYWxwaGFNYXAgPSBzb3VyY2UuYWxwaGFNYXA7CgoJCXRoaXMuZGlzcGxhY2VtZW50TWFwID0gc291cmNlLmRpc3BsYWNlbWVudE1hcDsKCQl0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gc291cmNlLmRpc3BsYWNlbWVudFNjYWxlOwoJCXRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IHNvdXJjZS5kaXNwbGFjZW1lbnRCaWFzOwoKCQl0aGlzLndpcmVmcmFtZSA9IHNvdXJjZS53aXJlZnJhbWU7CgkJdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSBzb3VyY2Uud2lyZWZyYW1lTGluZXdpZHRoOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBNZXNoRGlzdGFuY2VNYXRlcmlhbCBleHRlbmRzIE1hdGVyaWFsIHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVycyApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc01lc2hEaXN0YW5jZU1hdGVyaWFsID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ01lc2hEaXN0YW5jZU1hdGVyaWFsJzsKCgkJdGhpcy5tYXAgPSBudWxsOwoKCQl0aGlzLmFscGhhTWFwID0gbnVsbDsKCgkJdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBudWxsOwoJCXRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSAxOwoJCXRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IDA7CgoJCXRoaXMuc2V0VmFsdWVzKCBwYXJhbWV0ZXJzICk7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMubWFwID0gc291cmNlLm1hcDsKCgkJdGhpcy5hbHBoYU1hcCA9IHNvdXJjZS5hbHBoYU1hcDsKCgkJdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBzb3VyY2UuZGlzcGxhY2VtZW50TWFwOwoJCXRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSBzb3VyY2UuZGlzcGxhY2VtZW50U2NhbGU7CgkJdGhpcy5kaXNwbGFjZW1lbnRCaWFzID0gc291cmNlLmRpc3BsYWNlbWVudEJpYXM7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNvbnN0IHZlcnRleCA9ICJ2b2lkIG1haW4oKSB7XG5cdGdsX1Bvc2l0aW9uID0gdmVjNCggcG9zaXRpb24sIDEuMCApO1xufSI7Cgpjb25zdCBmcmFnbWVudCA9ICJ1bmlmb3JtIHNhbXBsZXIyRCBzaGFkb3dfcGFzcztcbnVuaWZvcm0gdmVjMiByZXNvbHV0aW9uO1xudW5pZm9ybSBmbG9hdCByYWRpdXM7XG4jaW5jbHVkZSA8cGFja2luZz5cbnZvaWQgbWFpbigpIHtcblx0Y29uc3QgZmxvYXQgc2FtcGxlcyA9IGZsb2F0KCBWU01fU0FNUExFUyApO1xuXHRmbG9hdCBtZWFuID0gMC4wO1xuXHRmbG9hdCBzcXVhcmVkX21lYW4gPSAwLjA7XG5cdGZsb2F0IHV2U3RyaWRlID0gc2FtcGxlcyA8PSAxLjAgPyAwLjAgOiAyLjAgLyAoIHNhbXBsZXMgLSAxLjAgKTtcblx0ZmxvYXQgdXZTdGFydCA9IHNhbXBsZXMgPD0gMS4wID8gMC4wIDogLSAxLjA7XG5cdGZvciAoIGZsb2F0IGkgPSAwLjA7IGkgPCBzYW1wbGVzOyBpICsrICkge1xuXHRcdGZsb2F0IHV2T2Zmc2V0ID0gdXZTdGFydCArIGkgKiB1dlN0cmlkZTtcblx0XHQjaWZkZWYgSE9SSVpPTlRBTF9QQVNTXG5cdFx0XHR2ZWMyIGRpc3RyaWJ1dGlvbiA9IHVucGFja1JHQkFUbzJIYWxmKCB0ZXh0dXJlMkQoIHNoYWRvd19wYXNzLCAoIGdsX0ZyYWdDb29yZC54eSArIHZlYzIoIHV2T2Zmc2V0LCAwLjAgKSAqIHJhZGl1cyApIC8gcmVzb2x1dGlvbiApICk7XG5cdFx0XHRtZWFuICs9IGRpc3RyaWJ1dGlvbi54O1xuXHRcdFx0c3F1YXJlZF9tZWFuICs9IGRpc3RyaWJ1dGlvbi55ICogZGlzdHJpYnV0aW9uLnkgKyBkaXN0cmlidXRpb24ueCAqIGRpc3RyaWJ1dGlvbi54O1xuXHRcdCNlbHNlXG5cdFx0XHRmbG9hdCBkZXB0aCA9IHVucGFja1JHQkFUb0RlcHRoKCB0ZXh0dXJlMkQoIHNoYWRvd19wYXNzLCAoIGdsX0ZyYWdDb29yZC54eSArIHZlYzIoIDAuMCwgdXZPZmZzZXQgKSAqIHJhZGl1cyApIC8gcmVzb2x1dGlvbiApICk7XG5cdFx0XHRtZWFuICs9IGRlcHRoO1xuXHRcdFx0c3F1YXJlZF9tZWFuICs9IGRlcHRoICogZGVwdGg7XG5cdFx0I2VuZGlmXG5cdH1cblx0bWVhbiA9IG1lYW4gLyBzYW1wbGVzO1xuXHRzcXVhcmVkX21lYW4gPSBzcXVhcmVkX21lYW4gLyBzYW1wbGVzO1xuXHRmbG9hdCBzdGRfZGV2ID0gc3FydCggc3F1YXJlZF9tZWFuIC0gbWVhbiAqIG1lYW4gKTtcblx0Z2xfRnJhZ0NvbG9yID0gcGFjazJIYWxmVG9SR0JBKCB2ZWMyKCBtZWFuLCBzdGRfZGV2ICkgKTtcbn0iOwoKZnVuY3Rpb24gV2ViR0xTaGFkb3dNYXAoIF9yZW5kZXJlciwgX29iamVjdHMsIF9jYXBhYmlsaXRpZXMgKSB7CgoJbGV0IF9mcnVzdHVtID0gbmV3IEZydXN0dW0oKTsKCgljb25zdCBfc2hhZG93TWFwU2l6ZSA9IG5ldyBWZWN0b3IyKCksCgkJX3ZpZXdwb3J0U2l6ZSA9IG5ldyBWZWN0b3IyKCksCgoJCV92aWV3cG9ydCA9IG5ldyBWZWN0b3I0KCksCgoJCV9kZXB0aE1hdGVyaWFsID0gbmV3IE1lc2hEZXB0aE1hdGVyaWFsKCB7IGRlcHRoUGFja2luZzogUkdCQURlcHRoUGFja2luZyB9ICksCgkJX2Rpc3RhbmNlTWF0ZXJpYWwgPSBuZXcgTWVzaERpc3RhbmNlTWF0ZXJpYWwoKSwKCgkJX21hdGVyaWFsQ2FjaGUgPSB7fSwKCgkJX21heFRleHR1cmVTaXplID0gX2NhcGFiaWxpdGllcy5tYXhUZXh0dXJlU2l6ZTsKCgljb25zdCBzaGFkb3dTaWRlID0geyBbIEZyb250U2lkZSBdOiBCYWNrU2lkZSwgWyBCYWNrU2lkZSBdOiBGcm9udFNpZGUsIFsgRG91YmxlU2lkZSBdOiBEb3VibGVTaWRlIH07CgoJY29uc3Qgc2hhZG93TWF0ZXJpYWxWZXJ0aWNhbCA9IG5ldyBTaGFkZXJNYXRlcmlhbCggewoJCWRlZmluZXM6IHsKCQkJVlNNX1NBTVBMRVM6IDgKCQl9LAoJCXVuaWZvcm1zOiB7CgkJCXNoYWRvd19wYXNzOiB7IHZhbHVlOiBudWxsIH0sCgkJCXJlc29sdXRpb246IHsgdmFsdWU6IG5ldyBWZWN0b3IyKCkgfSwKCQkJcmFkaXVzOiB7IHZhbHVlOiA0LjAgfQoJCX0sCgoJCXZlcnRleFNoYWRlcjogdmVydGV4LAoJCWZyYWdtZW50U2hhZGVyOiBmcmFnbWVudAoKCX0gKTsKCgljb25zdCBzaGFkb3dNYXRlcmlhbEhvcml6b250YWwgPSBzaGFkb3dNYXRlcmlhbFZlcnRpY2FsLmNsb25lKCk7CglzaGFkb3dNYXRlcmlhbEhvcml6b250YWwuZGVmaW5lcy5IT1JJWk9OVEFMX1BBU1MgPSAxOwoKCWNvbnN0IGZ1bGxTY3JlZW5UcmkgPSBuZXcgQnVmZmVyR2VvbWV0cnkoKTsKCWZ1bGxTY3JlZW5Ucmkuc2V0QXR0cmlidXRlKAoJCSdwb3NpdGlvbicsCgkJbmV3IEJ1ZmZlckF0dHJpYnV0ZSgKCQkJbmV3IEZsb2F0MzJBcnJheSggWyAtIDEsIC0gMSwgMC41LCAzLCAtIDEsIDAuNSwgLSAxLCAzLCAwLjUgXSApLAoJCQkzCgkJKQoJKTsKCgljb25zdCBmdWxsU2NyZWVuTWVzaCA9IG5ldyBNZXNoKCBmdWxsU2NyZWVuVHJpLCBzaGFkb3dNYXRlcmlhbFZlcnRpY2FsICk7CgoJY29uc3Qgc2NvcGUgPSB0aGlzOwoKCXRoaXMuZW5hYmxlZCA9IGZhbHNlOwoKCXRoaXMuYXV0b1VwZGF0ZSA9IHRydWU7Cgl0aGlzLm5lZWRzVXBkYXRlID0gZmFsc2U7CgoJdGhpcy50eXBlID0gUENGU2hhZG93TWFwOwoJbGV0IF9wcmV2aW91c1R5cGUgPSB0aGlzLnR5cGU7CgoJdGhpcy5yZW5kZXIgPSBmdW5jdGlvbiAoIGxpZ2h0cywgc2NlbmUsIGNhbWVyYSApIHsKCgkJaWYgKCBzY29wZS5lbmFibGVkID09PSBmYWxzZSApIHJldHVybjsKCQlpZiAoIHNjb3BlLmF1dG9VcGRhdGUgPT09IGZhbHNlICYmIHNjb3BlLm5lZWRzVXBkYXRlID09PSBmYWxzZSApIHJldHVybjsKCgkJaWYgKCBsaWdodHMubGVuZ3RoID09PSAwICkgcmV0dXJuOwoKCQljb25zdCBjdXJyZW50UmVuZGVyVGFyZ2V0ID0gX3JlbmRlcmVyLmdldFJlbmRlclRhcmdldCgpOwoJCWNvbnN0IGFjdGl2ZUN1YmVGYWNlID0gX3JlbmRlcmVyLmdldEFjdGl2ZUN1YmVGYWNlKCk7CgkJY29uc3QgYWN0aXZlTWlwbWFwTGV2ZWwgPSBfcmVuZGVyZXIuZ2V0QWN0aXZlTWlwbWFwTGV2ZWwoKTsKCgkJY29uc3QgX3N0YXRlID0gX3JlbmRlcmVyLnN0YXRlOwoKCQkvLyBTZXQgR0wgc3RhdGUgZm9yIGRlcHRoIG1hcC4KCQlfc3RhdGUuc2V0QmxlbmRpbmcoIE5vQmxlbmRpbmcgKTsKCQlfc3RhdGUuYnVmZmVycy5jb2xvci5zZXRDbGVhciggMSwgMSwgMSwgMSApOwoJCV9zdGF0ZS5idWZmZXJzLmRlcHRoLnNldFRlc3QoIHRydWUgKTsKCQlfc3RhdGUuc2V0U2Npc3NvclRlc3QoIGZhbHNlICk7CgoJCS8vIGNoZWNrIGZvciBzaGFkb3cgbWFwIHR5cGUgY2hhbmdlcwoKCQljb25zdCB0b1ZTTSA9ICggX3ByZXZpb3VzVHlwZSAhPT0gVlNNU2hhZG93TWFwICYmIHRoaXMudHlwZSA9PT0gVlNNU2hhZG93TWFwICk7CgkJY29uc3QgZnJvbVZTTSA9ICggX3ByZXZpb3VzVHlwZSA9PT0gVlNNU2hhZG93TWFwICYmIHRoaXMudHlwZSAhPT0gVlNNU2hhZG93TWFwICk7CgoJCS8vIHJlbmRlciBkZXB0aCBtYXAKCgkJZm9yICggbGV0IGkgPSAwLCBpbCA9IGxpZ2h0cy5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCWNvbnN0IGxpZ2h0ID0gbGlnaHRzWyBpIF07CgkJCWNvbnN0IHNoYWRvdyA9IGxpZ2h0LnNoYWRvdzsKCgkJCWlmICggc2hhZG93ID09PSB1bmRlZmluZWQgKSB7CgoJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xTaGFkb3dNYXA6JywgbGlnaHQsICdoYXMgbm8gc2hhZG93LicgKTsKCQkJCWNvbnRpbnVlOwoKCQkJfQoKCQkJaWYgKCBzaGFkb3cuYXV0b1VwZGF0ZSA9PT0gZmFsc2UgJiYgc2hhZG93Lm5lZWRzVXBkYXRlID09PSBmYWxzZSApIGNvbnRpbnVlOwoKCQkJX3NoYWRvd01hcFNpemUuY29weSggc2hhZG93Lm1hcFNpemUgKTsKCgkJCWNvbnN0IHNoYWRvd0ZyYW1lRXh0ZW50cyA9IHNoYWRvdy5nZXRGcmFtZUV4dGVudHMoKTsKCgkJCV9zaGFkb3dNYXBTaXplLm11bHRpcGx5KCBzaGFkb3dGcmFtZUV4dGVudHMgKTsKCgkJCV92aWV3cG9ydFNpemUuY29weSggc2hhZG93Lm1hcFNpemUgKTsKCgkJCWlmICggX3NoYWRvd01hcFNpemUueCA+IF9tYXhUZXh0dXJlU2l6ZSB8fCBfc2hhZG93TWFwU2l6ZS55ID4gX21heFRleHR1cmVTaXplICkgewoKCQkJCWlmICggX3NoYWRvd01hcFNpemUueCA+IF9tYXhUZXh0dXJlU2l6ZSApIHsKCgkJCQkJX3ZpZXdwb3J0U2l6ZS54ID0gTWF0aC5mbG9vciggX21heFRleHR1cmVTaXplIC8gc2hhZG93RnJhbWVFeHRlbnRzLnggKTsKCQkJCQlfc2hhZG93TWFwU2l6ZS54ID0gX3ZpZXdwb3J0U2l6ZS54ICogc2hhZG93RnJhbWVFeHRlbnRzLng7CgkJCQkJc2hhZG93Lm1hcFNpemUueCA9IF92aWV3cG9ydFNpemUueDsKCgkJCQl9CgoJCQkJaWYgKCBfc2hhZG93TWFwU2l6ZS55ID4gX21heFRleHR1cmVTaXplICkgewoKCQkJCQlfdmlld3BvcnRTaXplLnkgPSBNYXRoLmZsb29yKCBfbWF4VGV4dHVyZVNpemUgLyBzaGFkb3dGcmFtZUV4dGVudHMueSApOwoJCQkJCV9zaGFkb3dNYXBTaXplLnkgPSBfdmlld3BvcnRTaXplLnkgKiBzaGFkb3dGcmFtZUV4dGVudHMueTsKCQkJCQlzaGFkb3cubWFwU2l6ZS55ID0gX3ZpZXdwb3J0U2l6ZS55OwoKCQkJCX0KCgkJCX0KCgkJCWlmICggc2hhZG93Lm1hcCA9PT0gbnVsbCB8fCB0b1ZTTSA9PT0gdHJ1ZSB8fCBmcm9tVlNNID09PSB0cnVlICkgewoKCQkJCWNvbnN0IHBhcnMgPSAoIHRoaXMudHlwZSAhPT0gVlNNU2hhZG93TWFwICkgPyB7IG1pbkZpbHRlcjogTmVhcmVzdEZpbHRlciwgbWFnRmlsdGVyOiBOZWFyZXN0RmlsdGVyIH0gOiB7fTsKCgkJCQlpZiAoIHNoYWRvdy5tYXAgIT09IG51bGwgKSB7CgoJCQkJCXNoYWRvdy5tYXAuZGlzcG9zZSgpOwoKCQkJCX0KCgkJCQlzaGFkb3cubWFwID0gbmV3IFdlYkdMUmVuZGVyVGFyZ2V0KCBfc2hhZG93TWFwU2l6ZS54LCBfc2hhZG93TWFwU2l6ZS55LCBwYXJzICk7CgkJCQlzaGFkb3cubWFwLnRleHR1cmUubmFtZSA9IGxpZ2h0Lm5hbWUgKyAnLnNoYWRvd01hcCc7CgoJCQkJc2hhZG93LmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgoJCQl9CgoJCQlfcmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KCBzaGFkb3cubWFwICk7CgkJCV9yZW5kZXJlci5jbGVhcigpOwoKCQkJY29uc3Qgdmlld3BvcnRDb3VudCA9IHNoYWRvdy5nZXRWaWV3cG9ydENvdW50KCk7CgoJCQlmb3IgKCBsZXQgdnAgPSAwOyB2cCA8IHZpZXdwb3J0Q291bnQ7IHZwICsrICkgewoKCQkJCWNvbnN0IHZpZXdwb3J0ID0gc2hhZG93LmdldFZpZXdwb3J0KCB2cCApOwoKCQkJCV92aWV3cG9ydC5zZXQoCgkJCQkJX3ZpZXdwb3J0U2l6ZS54ICogdmlld3BvcnQueCwKCQkJCQlfdmlld3BvcnRTaXplLnkgKiB2aWV3cG9ydC55LAoJCQkJCV92aWV3cG9ydFNpemUueCAqIHZpZXdwb3J0LnosCgkJCQkJX3ZpZXdwb3J0U2l6ZS55ICogdmlld3BvcnQudwoJCQkJKTsKCgkJCQlfc3RhdGUudmlld3BvcnQoIF92aWV3cG9ydCApOwoKCQkJCXNoYWRvdy51cGRhdGVNYXRyaWNlcyggbGlnaHQsIHZwICk7CgoJCQkJX2ZydXN0dW0gPSBzaGFkb3cuZ2V0RnJ1c3R1bSgpOwoKCQkJCXJlbmRlck9iamVjdCggc2NlbmUsIGNhbWVyYSwgc2hhZG93LmNhbWVyYSwgbGlnaHQsIHRoaXMudHlwZSApOwoKCQkJfQoKCQkJLy8gZG8gYmx1ciBwYXNzIGZvciBWU00KCgkJCWlmICggc2hhZG93LmlzUG9pbnRMaWdodFNoYWRvdyAhPT0gdHJ1ZSAmJiB0aGlzLnR5cGUgPT09IFZTTVNoYWRvd01hcCApIHsKCgkJCQlWU01QYXNzKCBzaGFkb3csIGNhbWVyYSApOwoKCQkJfQoKCQkJc2hhZG93Lm5lZWRzVXBkYXRlID0gZmFsc2U7CgoJCX0KCgkJX3ByZXZpb3VzVHlwZSA9IHRoaXMudHlwZTsKCgkJc2NvcGUubmVlZHNVcGRhdGUgPSBmYWxzZTsKCgkJX3JlbmRlcmVyLnNldFJlbmRlclRhcmdldCggY3VycmVudFJlbmRlclRhcmdldCwgYWN0aXZlQ3ViZUZhY2UsIGFjdGl2ZU1pcG1hcExldmVsICk7CgoJfTsKCglmdW5jdGlvbiBWU01QYXNzKCBzaGFkb3csIGNhbWVyYSApIHsKCgkJY29uc3QgZ2VvbWV0cnkgPSBfb2JqZWN0cy51cGRhdGUoIGZ1bGxTY3JlZW5NZXNoICk7CgoJCWlmICggc2hhZG93TWF0ZXJpYWxWZXJ0aWNhbC5kZWZpbmVzLlZTTV9TQU1QTEVTICE9PSBzaGFkb3cuYmx1clNhbXBsZXMgKSB7CgoJCQlzaGFkb3dNYXRlcmlhbFZlcnRpY2FsLmRlZmluZXMuVlNNX1NBTVBMRVMgPSBzaGFkb3cuYmx1clNhbXBsZXM7CgkJCXNoYWRvd01hdGVyaWFsSG9yaXpvbnRhbC5kZWZpbmVzLlZTTV9TQU1QTEVTID0gc2hhZG93LmJsdXJTYW1wbGVzOwoKCQkJc2hhZG93TWF0ZXJpYWxWZXJ0aWNhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CgkJCXNoYWRvd01hdGVyaWFsSG9yaXpvbnRhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCX0KCgkJaWYgKCBzaGFkb3cubWFwUGFzcyA9PT0gbnVsbCApIHsKCgkJCXNoYWRvdy5tYXBQYXNzID0gbmV3IFdlYkdMUmVuZGVyVGFyZ2V0KCBfc2hhZG93TWFwU2l6ZS54LCBfc2hhZG93TWFwU2l6ZS55ICk7CgoJCX0KCgkJLy8gdmVydGljYWwgcGFzcwoKCQlzaGFkb3dNYXRlcmlhbFZlcnRpY2FsLnVuaWZvcm1zLnNoYWRvd19wYXNzLnZhbHVlID0gc2hhZG93Lm1hcC50ZXh0dXJlOwoJCXNoYWRvd01hdGVyaWFsVmVydGljYWwudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZSA9IHNoYWRvdy5tYXBTaXplOwoJCXNoYWRvd01hdGVyaWFsVmVydGljYWwudW5pZm9ybXMucmFkaXVzLnZhbHVlID0gc2hhZG93LnJhZGl1czsKCQlfcmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KCBzaGFkb3cubWFwUGFzcyApOwoJCV9yZW5kZXJlci5jbGVhcigpOwoJCV9yZW5kZXJlci5yZW5kZXJCdWZmZXJEaXJlY3QoIGNhbWVyYSwgbnVsbCwgZ2VvbWV0cnksIHNoYWRvd01hdGVyaWFsVmVydGljYWwsIGZ1bGxTY3JlZW5NZXNoLCBudWxsICk7CgoJCS8vIGhvcml6b250YWwgcGFzcwoKCQlzaGFkb3dNYXRlcmlhbEhvcml6b250YWwudW5pZm9ybXMuc2hhZG93X3Bhc3MudmFsdWUgPSBzaGFkb3cubWFwUGFzcy50ZXh0dXJlOwoJCXNoYWRvd01hdGVyaWFsSG9yaXpvbnRhbC51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlID0gc2hhZG93Lm1hcFNpemU7CgkJc2hhZG93TWF0ZXJpYWxIb3Jpem9udGFsLnVuaWZvcm1zLnJhZGl1cy52YWx1ZSA9IHNoYWRvdy5yYWRpdXM7CgkJX3JlbmRlcmVyLnNldFJlbmRlclRhcmdldCggc2hhZG93Lm1hcCApOwoJCV9yZW5kZXJlci5jbGVhcigpOwoJCV9yZW5kZXJlci5yZW5kZXJCdWZmZXJEaXJlY3QoIGNhbWVyYSwgbnVsbCwgZ2VvbWV0cnksIHNoYWRvd01hdGVyaWFsSG9yaXpvbnRhbCwgZnVsbFNjcmVlbk1lc2gsIG51bGwgKTsKCgl9CgoJZnVuY3Rpb24gZ2V0RGVwdGhNYXRlcmlhbCggb2JqZWN0LCBtYXRlcmlhbCwgbGlnaHQsIHR5cGUgKSB7CgoJCWxldCByZXN1bHQgPSBudWxsOwoKCQljb25zdCBjdXN0b21NYXRlcmlhbCA9ICggbGlnaHQuaXNQb2ludExpZ2h0ID09PSB0cnVlICkgPyBvYmplY3QuY3VzdG9tRGlzdGFuY2VNYXRlcmlhbCA6IG9iamVjdC5jdXN0b21EZXB0aE1hdGVyaWFsOwoKCQlpZiAoIGN1c3RvbU1hdGVyaWFsICE9PSB1bmRlZmluZWQgKSB7CgoJCQlyZXN1bHQgPSBjdXN0b21NYXRlcmlhbDsKCgkJfSBlbHNlIHsKCgkJCXJlc3VsdCA9ICggbGlnaHQuaXNQb2ludExpZ2h0ID09PSB0cnVlICkgPyBfZGlzdGFuY2VNYXRlcmlhbCA6IF9kZXB0aE1hdGVyaWFsOwoKCQkJaWYgKCAoIF9yZW5kZXJlci5sb2NhbENsaXBwaW5nRW5hYmxlZCAmJiBtYXRlcmlhbC5jbGlwU2hhZG93cyA9PT0gdHJ1ZSAmJiBBcnJheS5pc0FycmF5KCBtYXRlcmlhbC5jbGlwcGluZ1BsYW5lcyApICYmIG1hdGVyaWFsLmNsaXBwaW5nUGxhbmVzLmxlbmd0aCAhPT0gMCApIHx8CgkJCQkoIG1hdGVyaWFsLmRpc3BsYWNlbWVudE1hcCAmJiBtYXRlcmlhbC5kaXNwbGFjZW1lbnRTY2FsZSAhPT0gMCApIHx8CgkJCQkoIG1hdGVyaWFsLmFscGhhTWFwICYmIG1hdGVyaWFsLmFscGhhVGVzdCA+IDAgKSB8fAoJCQkJKCBtYXRlcmlhbC5tYXAgJiYgbWF0ZXJpYWwuYWxwaGFUZXN0ID4gMCApICkgewoKCQkJCS8vIGluIHRoaXMgY2FzZSB3ZSBuZWVkIGEgdW5pcXVlIG1hdGVyaWFsIGluc3RhbmNlIHJlZmxlY3RpbmcgdGhlCgkJCQkvLyBhcHByb3ByaWF0ZSBzdGF0ZQoKCQkJCWNvbnN0IGtleUEgPSByZXN1bHQudXVpZCwga2V5QiA9IG1hdGVyaWFsLnV1aWQ7CgoJCQkJbGV0IG1hdGVyaWFsc0ZvclZhcmlhbnQgPSBfbWF0ZXJpYWxDYWNoZVsga2V5QSBdOwoKCQkJCWlmICggbWF0ZXJpYWxzRm9yVmFyaWFudCA9PT0gdW5kZWZpbmVkICkgewoKCQkJCQltYXRlcmlhbHNGb3JWYXJpYW50ID0ge307CgkJCQkJX21hdGVyaWFsQ2FjaGVbIGtleUEgXSA9IG1hdGVyaWFsc0ZvclZhcmlhbnQ7CgoJCQkJfQoKCQkJCWxldCBjYWNoZWRNYXRlcmlhbCA9IG1hdGVyaWFsc0ZvclZhcmlhbnRbIGtleUIgXTsKCgkJCQlpZiAoIGNhY2hlZE1hdGVyaWFsID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCWNhY2hlZE1hdGVyaWFsID0gcmVzdWx0LmNsb25lKCk7CgkJCQkJbWF0ZXJpYWxzRm9yVmFyaWFudFsga2V5QiBdID0gY2FjaGVkTWF0ZXJpYWw7CgkJCQkJbWF0ZXJpYWwuYWRkRXZlbnRMaXN0ZW5lciggJ2Rpc3Bvc2UnLCBvbk1hdGVyaWFsRGlzcG9zZSApOwoKCQkJCX0KCgkJCQlyZXN1bHQgPSBjYWNoZWRNYXRlcmlhbDsKCgkJCX0KCgkJfQoKCQlyZXN1bHQudmlzaWJsZSA9IG1hdGVyaWFsLnZpc2libGU7CgkJcmVzdWx0LndpcmVmcmFtZSA9IG1hdGVyaWFsLndpcmVmcmFtZTsKCgkJaWYgKCB0eXBlID09PSBWU01TaGFkb3dNYXAgKSB7CgoJCQlyZXN1bHQuc2lkZSA9ICggbWF0ZXJpYWwuc2hhZG93U2lkZSAhPT0gbnVsbCApID8gbWF0ZXJpYWwuc2hhZG93U2lkZSA6IG1hdGVyaWFsLnNpZGU7CgoJCX0gZWxzZSB7CgoJCQlyZXN1bHQuc2lkZSA9ICggbWF0ZXJpYWwuc2hhZG93U2lkZSAhPT0gbnVsbCApID8gbWF0ZXJpYWwuc2hhZG93U2lkZSA6IHNoYWRvd1NpZGVbIG1hdGVyaWFsLnNpZGUgXTsKCgkJfQoKCQlyZXN1bHQuYWxwaGFNYXAgPSBtYXRlcmlhbC5hbHBoYU1hcDsKCQlyZXN1bHQuYWxwaGFUZXN0ID0gbWF0ZXJpYWwuYWxwaGFUZXN0OwoJCXJlc3VsdC5tYXAgPSBtYXRlcmlhbC5tYXA7CgoJCXJlc3VsdC5jbGlwU2hhZG93cyA9IG1hdGVyaWFsLmNsaXBTaGFkb3dzOwoJCXJlc3VsdC5jbGlwcGluZ1BsYW5lcyA9IG1hdGVyaWFsLmNsaXBwaW5nUGxhbmVzOwoJCXJlc3VsdC5jbGlwSW50ZXJzZWN0aW9uID0gbWF0ZXJpYWwuY2xpcEludGVyc2VjdGlvbjsKCgkJcmVzdWx0LmRpc3BsYWNlbWVudE1hcCA9IG1hdGVyaWFsLmRpc3BsYWNlbWVudE1hcDsKCQlyZXN1bHQuZGlzcGxhY2VtZW50U2NhbGUgPSBtYXRlcmlhbC5kaXNwbGFjZW1lbnRTY2FsZTsKCQlyZXN1bHQuZGlzcGxhY2VtZW50QmlhcyA9IG1hdGVyaWFsLmRpc3BsYWNlbWVudEJpYXM7CgoJCXJlc3VsdC53aXJlZnJhbWVMaW5ld2lkdGggPSBtYXRlcmlhbC53aXJlZnJhbWVMaW5ld2lkdGg7CgkJcmVzdWx0LmxpbmV3aWR0aCA9IG1hdGVyaWFsLmxpbmV3aWR0aDsKCgkJaWYgKCBsaWdodC5pc1BvaW50TGlnaHQgPT09IHRydWUgJiYgcmVzdWx0LmlzTWVzaERpc3RhbmNlTWF0ZXJpYWwgPT09IHRydWUgKSB7CgoJCQljb25zdCBtYXRlcmlhbFByb3BlcnRpZXMgPSBfcmVuZGVyZXIucHJvcGVydGllcy5nZXQoIHJlc3VsdCApOwoJCQltYXRlcmlhbFByb3BlcnRpZXMubGlnaHQgPSBsaWdodDsKCgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoKCX0KCglmdW5jdGlvbiByZW5kZXJPYmplY3QoIG9iamVjdCwgY2FtZXJhLCBzaGFkb3dDYW1lcmEsIGxpZ2h0LCB0eXBlICkgewoKCQlpZiAoIG9iamVjdC52aXNpYmxlID09PSBmYWxzZSApIHJldHVybjsKCgkJY29uc3QgdmlzaWJsZSA9IG9iamVjdC5sYXllcnMudGVzdCggY2FtZXJhLmxheWVycyApOwoKCQlpZiAoIHZpc2libGUgJiYgKCBvYmplY3QuaXNNZXNoIHx8IG9iamVjdC5pc0xpbmUgfHwgb2JqZWN0LmlzUG9pbnRzICkgKSB7CgoJCQlpZiAoICggb2JqZWN0LmNhc3RTaGFkb3cgfHwgKCBvYmplY3QucmVjZWl2ZVNoYWRvdyAmJiB0eXBlID09PSBWU01TaGFkb3dNYXAgKSApICYmICggISBvYmplY3QuZnJ1c3R1bUN1bGxlZCB8fCBfZnJ1c3R1bS5pbnRlcnNlY3RzT2JqZWN0KCBvYmplY3QgKSApICkgewoKCQkJCW9iamVjdC5tb2RlbFZpZXdNYXRyaXgubXVsdGlwbHlNYXRyaWNlcyggc2hhZG93Q2FtZXJhLm1hdHJpeFdvcmxkSW52ZXJzZSwgb2JqZWN0Lm1hdHJpeFdvcmxkICk7CgoJCQkJY29uc3QgZ2VvbWV0cnkgPSBfb2JqZWN0cy51cGRhdGUoIG9iamVjdCApOwoJCQkJY29uc3QgbWF0ZXJpYWwgPSBvYmplY3QubWF0ZXJpYWw7CgoJCQkJaWYgKCBBcnJheS5pc0FycmF5KCBtYXRlcmlhbCApICkgewoKCQkJCQljb25zdCBncm91cHMgPSBnZW9tZXRyeS5ncm91cHM7CgoJCQkJCWZvciAoIGxldCBrID0gMCwga2wgPSBncm91cHMubGVuZ3RoOyBrIDwga2w7IGsgKysgKSB7CgoJCQkJCQljb25zdCBncm91cCA9IGdyb3Vwc1sgayBdOwoJCQkJCQljb25zdCBncm91cE1hdGVyaWFsID0gbWF0ZXJpYWxbIGdyb3VwLm1hdGVyaWFsSW5kZXggXTsKCgkJCQkJCWlmICggZ3JvdXBNYXRlcmlhbCAmJiBncm91cE1hdGVyaWFsLnZpc2libGUgKSB7CgoJCQkJCQkJY29uc3QgZGVwdGhNYXRlcmlhbCA9IGdldERlcHRoTWF0ZXJpYWwoIG9iamVjdCwgZ3JvdXBNYXRlcmlhbCwgbGlnaHQsIHR5cGUgKTsKCgkJCQkJCQlvYmplY3Qub25CZWZvcmVTaGFkb3coIF9yZW5kZXJlciwgb2JqZWN0LCBjYW1lcmEsIHNoYWRvd0NhbWVyYSwgZ2VvbWV0cnksIGRlcHRoTWF0ZXJpYWwsIGdyb3VwICk7CgoJCQkJCQkJX3JlbmRlcmVyLnJlbmRlckJ1ZmZlckRpcmVjdCggc2hhZG93Q2FtZXJhLCBudWxsLCBnZW9tZXRyeSwgZGVwdGhNYXRlcmlhbCwgb2JqZWN0LCBncm91cCApOwoKCQkJCQkJCW9iamVjdC5vbkFmdGVyU2hhZG93KCBfcmVuZGVyZXIsIG9iamVjdCwgY2FtZXJhLCBzaGFkb3dDYW1lcmEsIGdlb21ldHJ5LCBkZXB0aE1hdGVyaWFsLCBncm91cCApOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJfSBlbHNlIGlmICggbWF0ZXJpYWwudmlzaWJsZSApIHsKCgkJCQkJY29uc3QgZGVwdGhNYXRlcmlhbCA9IGdldERlcHRoTWF0ZXJpYWwoIG9iamVjdCwgbWF0ZXJpYWwsIGxpZ2h0LCB0eXBlICk7CgoJCQkJCW9iamVjdC5vbkJlZm9yZVNoYWRvdyggX3JlbmRlcmVyLCBvYmplY3QsIGNhbWVyYSwgc2hhZG93Q2FtZXJhLCBnZW9tZXRyeSwgZGVwdGhNYXRlcmlhbCwgbnVsbCApOwoKCQkJCQlfcmVuZGVyZXIucmVuZGVyQnVmZmVyRGlyZWN0KCBzaGFkb3dDYW1lcmEsIG51bGwsIGdlb21ldHJ5LCBkZXB0aE1hdGVyaWFsLCBvYmplY3QsIG51bGwgKTsKCgkJCQkJb2JqZWN0Lm9uQWZ0ZXJTaGFkb3coIF9yZW5kZXJlciwgb2JqZWN0LCBjYW1lcmEsIHNoYWRvd0NhbWVyYSwgZ2VvbWV0cnksIGRlcHRoTWF0ZXJpYWwsIG51bGwgKTsKCgkJCQl9CgoJCQl9CgoJCX0KCgkJY29uc3QgY2hpbGRyZW4gPSBvYmplY3QuY2hpbGRyZW47CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQlyZW5kZXJPYmplY3QoIGNoaWxkcmVuWyBpIF0sIGNhbWVyYSwgc2hhZG93Q2FtZXJhLCBsaWdodCwgdHlwZSApOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIG9uTWF0ZXJpYWxEaXNwb3NlKCBldmVudCApIHsKCgkJY29uc3QgbWF0ZXJpYWwgPSBldmVudC50YXJnZXQ7CgoJCW1hdGVyaWFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdkaXNwb3NlJywgb25NYXRlcmlhbERpc3Bvc2UgKTsKCgkJLy8gbWFrZSBzdXJlIHRvIHJlbW92ZSB0aGUgdW5pcXVlIGRpc3RhbmNlL2RlcHRoIG1hdGVyaWFscyB1c2VkIGZvciBzaGFkb3cgbWFwIHJlbmRlcmluZwoKCQlmb3IgKCBjb25zdCBpZCBpbiBfbWF0ZXJpYWxDYWNoZSApIHsKCgkJCWNvbnN0IGNhY2hlID0gX21hdGVyaWFsQ2FjaGVbIGlkIF07CgoJCQljb25zdCB1dWlkID0gZXZlbnQudGFyZ2V0LnV1aWQ7CgoJCQlpZiAoIHV1aWQgaW4gY2FjaGUgKSB7CgoJCQkJY29uc3Qgc2hhZG93TWF0ZXJpYWwgPSBjYWNoZVsgdXVpZCBdOwoJCQkJc2hhZG93TWF0ZXJpYWwuZGlzcG9zZSgpOwoJCQkJZGVsZXRlIGNhY2hlWyB1dWlkIF07CgoJCQl9CgoJCX0KCgl9Cgp9CgpmdW5jdGlvbiBXZWJHTFN0YXRlKCBnbCwgZXh0ZW5zaW9ucywgY2FwYWJpbGl0aWVzICkgewoKCWNvbnN0IGlzV2ViR0wyID0gY2FwYWJpbGl0aWVzLmlzV2ViR0wyOwoKCWZ1bmN0aW9uIENvbG9yQnVmZmVyKCkgewoKCQlsZXQgbG9ja2VkID0gZmFsc2U7CgoJCWNvbnN0IGNvbG9yID0gbmV3IFZlY3RvcjQoKTsKCQlsZXQgY3VycmVudENvbG9yTWFzayA9IG51bGw7CgkJY29uc3QgY3VycmVudENvbG9yQ2xlYXIgPSBuZXcgVmVjdG9yNCggMCwgMCwgMCwgMCApOwoKCQlyZXR1cm4gewoKCQkJc2V0TWFzazogZnVuY3Rpb24gKCBjb2xvck1hc2sgKSB7CgoJCQkJaWYgKCBjdXJyZW50Q29sb3JNYXNrICE9PSBjb2xvck1hc2sgJiYgISBsb2NrZWQgKSB7CgoJCQkJCWdsLmNvbG9yTWFzayggY29sb3JNYXNrLCBjb2xvck1hc2ssIGNvbG9yTWFzaywgY29sb3JNYXNrICk7CgkJCQkJY3VycmVudENvbG9yTWFzayA9IGNvbG9yTWFzazsKCgkJCQl9CgoJCQl9LAoKCQkJc2V0TG9ja2VkOiBmdW5jdGlvbiAoIGxvY2sgKSB7CgoJCQkJbG9ja2VkID0gbG9jazsKCgkJCX0sCgoJCQlzZXRDbGVhcjogZnVuY3Rpb24gKCByLCBnLCBiLCBhLCBwcmVtdWx0aXBsaWVkQWxwaGEgKSB7CgoJCQkJaWYgKCBwcmVtdWx0aXBsaWVkQWxwaGEgPT09IHRydWUgKSB7CgoJCQkJCXIgKj0gYTsgZyAqPSBhOyBiICo9IGE7CgoJCQkJfQoKCQkJCWNvbG9yLnNldCggciwgZywgYiwgYSApOwoKCQkJCWlmICggY3VycmVudENvbG9yQ2xlYXIuZXF1YWxzKCBjb2xvciApID09PSBmYWxzZSApIHsKCgkJCQkJZ2wuY2xlYXJDb2xvciggciwgZywgYiwgYSApOwoJCQkJCWN1cnJlbnRDb2xvckNsZWFyLmNvcHkoIGNvbG9yICk7CgoJCQkJfQoKCQkJfSwKCgkJCXJlc2V0OiBmdW5jdGlvbiAoKSB7CgoJCQkJbG9ja2VkID0gZmFsc2U7CgoJCQkJY3VycmVudENvbG9yTWFzayA9IG51bGw7CgkJCQljdXJyZW50Q29sb3JDbGVhci5zZXQoIC0gMSwgMCwgMCwgMCApOyAvLyBzZXQgdG8gaW52YWxpZCBzdGF0ZQoKCQkJfQoKCQl9OwoKCX0KCglmdW5jdGlvbiBEZXB0aEJ1ZmZlcigpIHsKCgkJbGV0IGxvY2tlZCA9IGZhbHNlOwoKCQlsZXQgY3VycmVudERlcHRoTWFzayA9IG51bGw7CgkJbGV0IGN1cnJlbnREZXB0aEZ1bmMgPSBudWxsOwoJCWxldCBjdXJyZW50RGVwdGhDbGVhciA9IG51bGw7CgoJCXJldHVybiB7CgoJCQlzZXRUZXN0OiBmdW5jdGlvbiAoIGRlcHRoVGVzdCApIHsKCgkJCQlpZiAoIGRlcHRoVGVzdCApIHsKCgkJCQkJZW5hYmxlKCBnbC5ERVBUSF9URVNUICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJZGlzYWJsZSggZ2wuREVQVEhfVEVTVCApOwoKCQkJCX0KCgkJCX0sCgoJCQlzZXRNYXNrOiBmdW5jdGlvbiAoIGRlcHRoTWFzayApIHsKCgkJCQlpZiAoIGN1cnJlbnREZXB0aE1hc2sgIT09IGRlcHRoTWFzayAmJiAhIGxvY2tlZCApIHsKCgkJCQkJZ2wuZGVwdGhNYXNrKCBkZXB0aE1hc2sgKTsKCQkJCQljdXJyZW50RGVwdGhNYXNrID0gZGVwdGhNYXNrOwoKCQkJCX0KCgkJCX0sCgoJCQlzZXRGdW5jOiBmdW5jdGlvbiAoIGRlcHRoRnVuYyApIHsKCgkJCQlpZiAoIGN1cnJlbnREZXB0aEZ1bmMgIT09IGRlcHRoRnVuYyApIHsKCgkJCQkJc3dpdGNoICggZGVwdGhGdW5jICkgewoKCQkJCQkJY2FzZSBOZXZlckRlcHRoOgoKCQkJCQkJCWdsLmRlcHRoRnVuYyggZ2wuTkVWRVIgKTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJY2FzZSBBbHdheXNEZXB0aDoKCgkJCQkJCQlnbC5kZXB0aEZ1bmMoIGdsLkFMV0FZUyApOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQljYXNlIExlc3NEZXB0aDoKCgkJCQkJCQlnbC5kZXB0aEZ1bmMoIGdsLkxFU1MgKTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJY2FzZSBMZXNzRXF1YWxEZXB0aDoKCgkJCQkJCQlnbC5kZXB0aEZ1bmMoIGdsLkxFUVVBTCApOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQljYXNlIEVxdWFsRGVwdGg6CgoJCQkJCQkJZ2wuZGVwdGhGdW5jKCBnbC5FUVVBTCApOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQljYXNlIEdyZWF0ZXJFcXVhbERlcHRoOgoKCQkJCQkJCWdsLmRlcHRoRnVuYyggZ2wuR0VRVUFMICk7CgkJCQkJCQlicmVhazsKCgkJCQkJCWNhc2UgR3JlYXRlckRlcHRoOgoKCQkJCQkJCWdsLmRlcHRoRnVuYyggZ2wuR1JFQVRFUiApOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQljYXNlIE5vdEVxdWFsRGVwdGg6CgoJCQkJCQkJZ2wuZGVwdGhGdW5jKCBnbC5OT1RFUVVBTCApOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQlkZWZhdWx0OgoKCQkJCQkJCWdsLmRlcHRoRnVuYyggZ2wuTEVRVUFMICk7CgoJCQkJCX0KCgkJCQkJY3VycmVudERlcHRoRnVuYyA9IGRlcHRoRnVuYzsKCgkJCQl9CgoJCQl9LAoKCQkJc2V0TG9ja2VkOiBmdW5jdGlvbiAoIGxvY2sgKSB7CgoJCQkJbG9ja2VkID0gbG9jazsKCgkJCX0sCgoJCQlzZXRDbGVhcjogZnVuY3Rpb24gKCBkZXB0aCApIHsKCgkJCQlpZiAoIGN1cnJlbnREZXB0aENsZWFyICE9PSBkZXB0aCApIHsKCgkJCQkJZ2wuY2xlYXJEZXB0aCggZGVwdGggKTsKCQkJCQljdXJyZW50RGVwdGhDbGVhciA9IGRlcHRoOwoKCQkJCX0KCgkJCX0sCgoJCQlyZXNldDogZnVuY3Rpb24gKCkgewoKCQkJCWxvY2tlZCA9IGZhbHNlOwoKCQkJCWN1cnJlbnREZXB0aE1hc2sgPSBudWxsOwoJCQkJY3VycmVudERlcHRoRnVuYyA9IG51bGw7CgkJCQljdXJyZW50RGVwdGhDbGVhciA9IG51bGw7CgoJCQl9CgoJCX07CgoJfQoKCWZ1bmN0aW9uIFN0ZW5jaWxCdWZmZXIoKSB7CgoJCWxldCBsb2NrZWQgPSBmYWxzZTsKCgkJbGV0IGN1cnJlbnRTdGVuY2lsTWFzayA9IG51bGw7CgkJbGV0IGN1cnJlbnRTdGVuY2lsRnVuYyA9IG51bGw7CgkJbGV0IGN1cnJlbnRTdGVuY2lsUmVmID0gbnVsbDsKCQlsZXQgY3VycmVudFN0ZW5jaWxGdW5jTWFzayA9IG51bGw7CgkJbGV0IGN1cnJlbnRTdGVuY2lsRmFpbCA9IG51bGw7CgkJbGV0IGN1cnJlbnRTdGVuY2lsWkZhaWwgPSBudWxsOwoJCWxldCBjdXJyZW50U3RlbmNpbFpQYXNzID0gbnVsbDsKCQlsZXQgY3VycmVudFN0ZW5jaWxDbGVhciA9IG51bGw7CgoJCXJldHVybiB7CgoJCQlzZXRUZXN0OiBmdW5jdGlvbiAoIHN0ZW5jaWxUZXN0ICkgewoKCQkJCWlmICggISBsb2NrZWQgKSB7CgoJCQkJCWlmICggc3RlbmNpbFRlc3QgKSB7CgoJCQkJCQllbmFibGUoIGdsLlNURU5DSUxfVEVTVCApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJZGlzYWJsZSggZ2wuU1RFTkNJTF9URVNUICk7CgoJCQkJCX0KCgkJCQl9CgoJCQl9LAoKCQkJc2V0TWFzazogZnVuY3Rpb24gKCBzdGVuY2lsTWFzayApIHsKCgkJCQlpZiAoIGN1cnJlbnRTdGVuY2lsTWFzayAhPT0gc3RlbmNpbE1hc2sgJiYgISBsb2NrZWQgKSB7CgoJCQkJCWdsLnN0ZW5jaWxNYXNrKCBzdGVuY2lsTWFzayApOwoJCQkJCWN1cnJlbnRTdGVuY2lsTWFzayA9IHN0ZW5jaWxNYXNrOwoKCQkJCX0KCgkJCX0sCgoJCQlzZXRGdW5jOiBmdW5jdGlvbiAoIHN0ZW5jaWxGdW5jLCBzdGVuY2lsUmVmLCBzdGVuY2lsTWFzayApIHsKCgkJCQlpZiAoIGN1cnJlbnRTdGVuY2lsRnVuYyAhPT0gc3RlbmNpbEZ1bmMgfHwKCQkJCSAgICAgY3VycmVudFN0ZW5jaWxSZWYgIT09IHN0ZW5jaWxSZWYgfHwKCQkJCSAgICAgY3VycmVudFN0ZW5jaWxGdW5jTWFzayAhPT0gc3RlbmNpbE1hc2sgKSB7CgoJCQkJCWdsLnN0ZW5jaWxGdW5jKCBzdGVuY2lsRnVuYywgc3RlbmNpbFJlZiwgc3RlbmNpbE1hc2sgKTsKCgkJCQkJY3VycmVudFN0ZW5jaWxGdW5jID0gc3RlbmNpbEZ1bmM7CgkJCQkJY3VycmVudFN0ZW5jaWxSZWYgPSBzdGVuY2lsUmVmOwoJCQkJCWN1cnJlbnRTdGVuY2lsRnVuY01hc2sgPSBzdGVuY2lsTWFzazsKCgkJCQl9CgoJCQl9LAoKCQkJc2V0T3A6IGZ1bmN0aW9uICggc3RlbmNpbEZhaWwsIHN0ZW5jaWxaRmFpbCwgc3RlbmNpbFpQYXNzICkgewoKCQkJCWlmICggY3VycmVudFN0ZW5jaWxGYWlsICE9PSBzdGVuY2lsRmFpbCB8fAoJCQkJICAgICBjdXJyZW50U3RlbmNpbFpGYWlsICE9PSBzdGVuY2lsWkZhaWwgfHwKCQkJCSAgICAgY3VycmVudFN0ZW5jaWxaUGFzcyAhPT0gc3RlbmNpbFpQYXNzICkgewoKCQkJCQlnbC5zdGVuY2lsT3AoIHN0ZW5jaWxGYWlsLCBzdGVuY2lsWkZhaWwsIHN0ZW5jaWxaUGFzcyApOwoKCQkJCQljdXJyZW50U3RlbmNpbEZhaWwgPSBzdGVuY2lsRmFpbDsKCQkJCQljdXJyZW50U3RlbmNpbFpGYWlsID0gc3RlbmNpbFpGYWlsOwoJCQkJCWN1cnJlbnRTdGVuY2lsWlBhc3MgPSBzdGVuY2lsWlBhc3M7CgoJCQkJfQoKCQkJfSwKCgkJCXNldExvY2tlZDogZnVuY3Rpb24gKCBsb2NrICkgewoKCQkJCWxvY2tlZCA9IGxvY2s7CgoJCQl9LAoKCQkJc2V0Q2xlYXI6IGZ1bmN0aW9uICggc3RlbmNpbCApIHsKCgkJCQlpZiAoIGN1cnJlbnRTdGVuY2lsQ2xlYXIgIT09IHN0ZW5jaWwgKSB7CgoJCQkJCWdsLmNsZWFyU3RlbmNpbCggc3RlbmNpbCApOwoJCQkJCWN1cnJlbnRTdGVuY2lsQ2xlYXIgPSBzdGVuY2lsOwoKCQkJCX0KCgkJCX0sCgoJCQlyZXNldDogZnVuY3Rpb24gKCkgewoKCQkJCWxvY2tlZCA9IGZhbHNlOwoKCQkJCWN1cnJlbnRTdGVuY2lsTWFzayA9IG51bGw7CgkJCQljdXJyZW50U3RlbmNpbEZ1bmMgPSBudWxsOwoJCQkJY3VycmVudFN0ZW5jaWxSZWYgPSBudWxsOwoJCQkJY3VycmVudFN0ZW5jaWxGdW5jTWFzayA9IG51bGw7CgkJCQljdXJyZW50U3RlbmNpbEZhaWwgPSBudWxsOwoJCQkJY3VycmVudFN0ZW5jaWxaRmFpbCA9IG51bGw7CgkJCQljdXJyZW50U3RlbmNpbFpQYXNzID0gbnVsbDsKCQkJCWN1cnJlbnRTdGVuY2lsQ2xlYXIgPSBudWxsOwoKCQkJfQoKCQl9OwoKCX0KCgkvLwoKCWNvbnN0IGNvbG9yQnVmZmVyID0gbmV3IENvbG9yQnVmZmVyKCk7Cgljb25zdCBkZXB0aEJ1ZmZlciA9IG5ldyBEZXB0aEJ1ZmZlcigpOwoJY29uc3Qgc3RlbmNpbEJ1ZmZlciA9IG5ldyBTdGVuY2lsQnVmZmVyKCk7CgoJY29uc3QgdWJvQmluZGluZ3MgPSBuZXcgV2Vha01hcCgpOwoJY29uc3QgdWJvUHJvZ3JhbU1hcCA9IG5ldyBXZWFrTWFwKCk7CgoJbGV0IGVuYWJsZWRDYXBhYmlsaXRpZXMgPSB7fTsKCglsZXQgY3VycmVudEJvdW5kRnJhbWVidWZmZXJzID0ge307CglsZXQgY3VycmVudERyYXdidWZmZXJzID0gbmV3IFdlYWtNYXAoKTsKCWxldCBkZWZhdWx0RHJhd2J1ZmZlcnMgPSBbXTsKCglsZXQgY3VycmVudFByb2dyYW0gPSBudWxsOwoKCWxldCBjdXJyZW50QmxlbmRpbmdFbmFibGVkID0gZmFsc2U7CglsZXQgY3VycmVudEJsZW5kaW5nID0gbnVsbDsKCWxldCBjdXJyZW50QmxlbmRFcXVhdGlvbiA9IG51bGw7CglsZXQgY3VycmVudEJsZW5kU3JjID0gbnVsbDsKCWxldCBjdXJyZW50QmxlbmREc3QgPSBudWxsOwoJbGV0IGN1cnJlbnRCbGVuZEVxdWF0aW9uQWxwaGEgPSBudWxsOwoJbGV0IGN1cnJlbnRCbGVuZFNyY0FscGhhID0gbnVsbDsKCWxldCBjdXJyZW50QmxlbmREc3RBbHBoYSA9IG51bGw7CglsZXQgY3VycmVudEJsZW5kQ29sb3IgPSBuZXcgQ29sb3IoIDAsIDAsIDAgKTsKCWxldCBjdXJyZW50QmxlbmRBbHBoYSA9IDA7CglsZXQgY3VycmVudFByZW11bHRpcGxlZEFscGhhID0gZmFsc2U7CgoJbGV0IGN1cnJlbnRGbGlwU2lkZWQgPSBudWxsOwoJbGV0IGN1cnJlbnRDdWxsRmFjZSA9IG51bGw7CgoJbGV0IGN1cnJlbnRMaW5lV2lkdGggPSBudWxsOwoKCWxldCBjdXJyZW50UG9seWdvbk9mZnNldEZhY3RvciA9IG51bGw7CglsZXQgY3VycmVudFBvbHlnb25PZmZzZXRVbml0cyA9IG51bGw7CgoJY29uc3QgbWF4VGV4dHVyZXMgPSBnbC5nZXRQYXJhbWV0ZXIoIGdsLk1BWF9DT01CSU5FRF9URVhUVVJFX0lNQUdFX1VOSVRTICk7CgoJbGV0IGxpbmVXaWR0aEF2YWlsYWJsZSA9IGZhbHNlOwoJbGV0IHZlcnNpb24gPSAwOwoJY29uc3QgZ2xWZXJzaW9uID0gZ2wuZ2V0UGFyYW1ldGVyKCBnbC5WRVJTSU9OICk7CgoJaWYgKCBnbFZlcnNpb24uaW5kZXhPZiggJ1dlYkdMJyApICE9PSAtIDEgKSB7CgoJCXZlcnNpb24gPSBwYXJzZUZsb2F0KCAvXldlYkdMIChcZCkvLmV4ZWMoIGdsVmVyc2lvbiApWyAxIF0gKTsKCQlsaW5lV2lkdGhBdmFpbGFibGUgPSAoIHZlcnNpb24gPj0gMS4wICk7CgoJfSBlbHNlIGlmICggZ2xWZXJzaW9uLmluZGV4T2YoICdPcGVuR0wgRVMnICkgIT09IC0gMSApIHsKCgkJdmVyc2lvbiA9IHBhcnNlRmxvYXQoIC9eT3BlbkdMIEVTIChcZCkvLmV4ZWMoIGdsVmVyc2lvbiApWyAxIF0gKTsKCQlsaW5lV2lkdGhBdmFpbGFibGUgPSAoIHZlcnNpb24gPj0gMi4wICk7CgoJfQoKCWxldCBjdXJyZW50VGV4dHVyZVNsb3QgPSBudWxsOwoJbGV0IGN1cnJlbnRCb3VuZFRleHR1cmVzID0ge307CgoJY29uc3Qgc2Npc3NvclBhcmFtID0gZ2wuZ2V0UGFyYW1ldGVyKCBnbC5TQ0lTU09SX0JPWCApOwoJY29uc3Qgdmlld3BvcnRQYXJhbSA9IGdsLmdldFBhcmFtZXRlciggZ2wuVklFV1BPUlQgKTsKCgljb25zdCBjdXJyZW50U2Npc3NvciA9IG5ldyBWZWN0b3I0KCkuZnJvbUFycmF5KCBzY2lzc29yUGFyYW0gKTsKCWNvbnN0IGN1cnJlbnRWaWV3cG9ydCA9IG5ldyBWZWN0b3I0KCkuZnJvbUFycmF5KCB2aWV3cG9ydFBhcmFtICk7CgoJZnVuY3Rpb24gY3JlYXRlVGV4dHVyZSggdHlwZSwgdGFyZ2V0LCBjb3VudCwgZGltZW5zaW9ucyApIHsKCgkJY29uc3QgZGF0YSA9IG5ldyBVaW50OEFycmF5KCA0ICk7IC8vIDQgaXMgcmVxdWlyZWQgdG8gbWF0Y2ggZGVmYXVsdCB1bnBhY2sgYWxpZ25tZW50IG9mIDQuCgkJY29uc3QgdGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKCgkJZ2wuYmluZFRleHR1cmUoIHR5cGUsIHRleHR1cmUgKTsKCQlnbC50ZXhQYXJhbWV0ZXJpKCB0eXBlLCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLk5FQVJFU1QgKTsKCQlnbC50ZXhQYXJhbWV0ZXJpKCB0eXBlLCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLk5FQVJFU1QgKTsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgY291bnQ7IGkgKysgKSB7CgoJCQlpZiAoIGlzV2ViR0wyICYmICggdHlwZSA9PT0gZ2wuVEVYVFVSRV8zRCB8fCB0eXBlID09PSBnbC5URVhUVVJFXzJEX0FSUkFZICkgKSB7CgoJCQkJZ2wudGV4SW1hZ2UzRCggdGFyZ2V0LCAwLCBnbC5SR0JBLCAxLCAxLCBkaW1lbnNpb25zLCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBkYXRhICk7CgoJCQl9IGVsc2UgewoKCQkJCWdsLnRleEltYWdlMkQoIHRhcmdldCArIGksIDAsIGdsLlJHQkEsIDEsIDEsIDAsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIGRhdGEgKTsKCgkJCX0KCgkJfQoKCQlyZXR1cm4gdGV4dHVyZTsKCgl9CgoJY29uc3QgZW1wdHlUZXh0dXJlcyA9IHt9OwoJZW1wdHlUZXh0dXJlc1sgZ2wuVEVYVFVSRV8yRCBdID0gY3JlYXRlVGV4dHVyZSggZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV8yRCwgMSApOwoJZW1wdHlUZXh0dXJlc1sgZ2wuVEVYVFVSRV9DVUJFX01BUCBdID0gY3JlYXRlVGV4dHVyZSggZ2wuVEVYVFVSRV9DVUJFX01BUCwgZ2wuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YLCA2ICk7CgoJaWYgKCBpc1dlYkdMMiApIHsKCgkJZW1wdHlUZXh0dXJlc1sgZ2wuVEVYVFVSRV8yRF9BUlJBWSBdID0gY3JlYXRlVGV4dHVyZSggZ2wuVEVYVFVSRV8yRF9BUlJBWSwgZ2wuVEVYVFVSRV8yRF9BUlJBWSwgMSwgMSApOwoJCWVtcHR5VGV4dHVyZXNbIGdsLlRFWFRVUkVfM0QgXSA9IGNyZWF0ZVRleHR1cmUoIGdsLlRFWFRVUkVfM0QsIGdsLlRFWFRVUkVfM0QsIDEsIDEgKTsKCgl9CgoJLy8gaW5pdAoKCWNvbG9yQnVmZmVyLnNldENsZWFyKCAwLCAwLCAwLCAxICk7CglkZXB0aEJ1ZmZlci5zZXRDbGVhciggMSApOwoJc3RlbmNpbEJ1ZmZlci5zZXRDbGVhciggMCApOwoKCWVuYWJsZSggZ2wuREVQVEhfVEVTVCApOwoJZGVwdGhCdWZmZXIuc2V0RnVuYyggTGVzc0VxdWFsRGVwdGggKTsKCglzZXRGbGlwU2lkZWQoIGZhbHNlICk7CglzZXRDdWxsRmFjZSggQ3VsbEZhY2VCYWNrICk7CgllbmFibGUoIGdsLkNVTExfRkFDRSApOwoKCXNldEJsZW5kaW5nKCBOb0JsZW5kaW5nICk7CgoJLy8KCglmdW5jdGlvbiBlbmFibGUoIGlkICkgewoKCQlpZiAoIGVuYWJsZWRDYXBhYmlsaXRpZXNbIGlkIF0gIT09IHRydWUgKSB7CgoJCQlnbC5lbmFibGUoIGlkICk7CgkJCWVuYWJsZWRDYXBhYmlsaXRpZXNbIGlkIF0gPSB0cnVlOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIGRpc2FibGUoIGlkICkgewoKCQlpZiAoIGVuYWJsZWRDYXBhYmlsaXRpZXNbIGlkIF0gIT09IGZhbHNlICkgewoKCQkJZ2wuZGlzYWJsZSggaWQgKTsKCQkJZW5hYmxlZENhcGFiaWxpdGllc1sgaWQgXSA9IGZhbHNlOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIGJpbmRGcmFtZWJ1ZmZlciggdGFyZ2V0LCBmcmFtZWJ1ZmZlciApIHsKCgkJaWYgKCBjdXJyZW50Qm91bmRGcmFtZWJ1ZmZlcnNbIHRhcmdldCBdICE9PSBmcmFtZWJ1ZmZlciApIHsKCgkJCWdsLmJpbmRGcmFtZWJ1ZmZlciggdGFyZ2V0LCBmcmFtZWJ1ZmZlciApOwoKCQkJY3VycmVudEJvdW5kRnJhbWVidWZmZXJzWyB0YXJnZXQgXSA9IGZyYW1lYnVmZmVyOwoKCQkJaWYgKCBpc1dlYkdMMiApIHsKCgkJCQkvLyBnbC5EUkFXX0ZSQU1FQlVGRkVSIGlzIGVxdWl2YWxlbnQgdG8gZ2wuRlJBTUVCVUZGRVIKCgkJCQlpZiAoIHRhcmdldCA9PT0gZ2wuRFJBV19GUkFNRUJVRkZFUiApIHsKCgkJCQkJY3VycmVudEJvdW5kRnJhbWVidWZmZXJzWyBnbC5GUkFNRUJVRkZFUiBdID0gZnJhbWVidWZmZXI7CgoJCQkJfQoKCQkJCWlmICggdGFyZ2V0ID09PSBnbC5GUkFNRUJVRkZFUiApIHsKCgkJCQkJY3VycmVudEJvdW5kRnJhbWVidWZmZXJzWyBnbC5EUkFXX0ZSQU1FQlVGRkVSIF0gPSBmcmFtZWJ1ZmZlcjsKCgkJCQl9CgoJCQl9CgoJCQlyZXR1cm4gdHJ1ZTsKCgkJfQoKCQlyZXR1cm4gZmFsc2U7CgoJfQoKCWZ1bmN0aW9uIGRyYXdCdWZmZXJzKCByZW5kZXJUYXJnZXQsIGZyYW1lYnVmZmVyICkgewoKCQlsZXQgZHJhd0J1ZmZlcnMgPSBkZWZhdWx0RHJhd2J1ZmZlcnM7CgoJCWxldCBuZWVkc1VwZGF0ZSA9IGZhbHNlOwoKCQlpZiAoIHJlbmRlclRhcmdldCApIHsKCgkJCWRyYXdCdWZmZXJzID0gY3VycmVudERyYXdidWZmZXJzLmdldCggZnJhbWVidWZmZXIgKTsKCgkJCWlmICggZHJhd0J1ZmZlcnMgPT09IHVuZGVmaW5lZCApIHsKCgkJCQlkcmF3QnVmZmVycyA9IFtdOwoJCQkJY3VycmVudERyYXdidWZmZXJzLnNldCggZnJhbWVidWZmZXIsIGRyYXdCdWZmZXJzICk7CgoJCQl9CgoJCQlpZiAoIHJlbmRlclRhcmdldC5pc1dlYkdMTXVsdGlwbGVSZW5kZXJUYXJnZXRzICkgewoKCQkJCWNvbnN0IHRleHR1cmVzID0gcmVuZGVyVGFyZ2V0LnRleHR1cmU7CgoJCQkJaWYgKCBkcmF3QnVmZmVycy5sZW5ndGggIT09IHRleHR1cmVzLmxlbmd0aCB8fCBkcmF3QnVmZmVyc1sgMCBdICE9PSBnbC5DT0xPUl9BVFRBQ0hNRU5UMCApIHsKCgkJCQkJZm9yICggbGV0IGkgPSAwLCBpbCA9IHRleHR1cmVzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCQkJZHJhd0J1ZmZlcnNbIGkgXSA9IGdsLkNPTE9SX0FUVEFDSE1FTlQwICsgaTsKCgkJCQkJfQoKCQkJCQlkcmF3QnVmZmVycy5sZW5ndGggPSB0ZXh0dXJlcy5sZW5ndGg7CgoJCQkJCW5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCWlmICggZHJhd0J1ZmZlcnNbIDAgXSAhPT0gZ2wuQ09MT1JfQVRUQUNITUVOVDAgKSB7CgoJCQkJCWRyYXdCdWZmZXJzWyAwIF0gPSBnbC5DT0xPUl9BVFRBQ0hNRU5UMDsKCgkJCQkJbmVlZHNVcGRhdGUgPSB0cnVlOwoKCQkJCX0KCgkJCX0KCgkJfSBlbHNlIHsKCgkJCWlmICggZHJhd0J1ZmZlcnNbIDAgXSAhPT0gZ2wuQkFDSyApIHsKCgkJCQlkcmF3QnVmZmVyc1sgMCBdID0gZ2wuQkFDSzsKCgkJCQluZWVkc1VwZGF0ZSA9IHRydWU7CgoJCQl9CgoJCX0KCgkJaWYgKCBuZWVkc1VwZGF0ZSApIHsKCgkJCWlmICggY2FwYWJpbGl0aWVzLmlzV2ViR0wyICkgewoKCQkJCWdsLmRyYXdCdWZmZXJzKCBkcmF3QnVmZmVycyApOwoKCQkJfSBlbHNlIHsKCgkJCQlleHRlbnNpb25zLmdldCggJ1dFQkdMX2RyYXdfYnVmZmVycycgKS5kcmF3QnVmZmVyc1dFQkdMKCBkcmF3QnVmZmVycyApOwoKCQkJfQoKCQl9CgoKCX0KCglmdW5jdGlvbiB1c2VQcm9ncmFtKCBwcm9ncmFtICkgewoKCQlpZiAoIGN1cnJlbnRQcm9ncmFtICE9PSBwcm9ncmFtICkgewoKCQkJZ2wudXNlUHJvZ3JhbSggcHJvZ3JhbSApOwoKCQkJY3VycmVudFByb2dyYW0gPSBwcm9ncmFtOwoKCQkJcmV0dXJuIHRydWU7CgoJCX0KCgkJcmV0dXJuIGZhbHNlOwoKCX0KCgljb25zdCBlcXVhdGlvblRvR0wgPSB7CgkJWyBBZGRFcXVhdGlvbiBdOiBnbC5GVU5DX0FERCwKCQlbIFN1YnRyYWN0RXF1YXRpb24gXTogZ2wuRlVOQ19TVUJUUkFDVCwKCQlbIFJldmVyc2VTdWJ0cmFjdEVxdWF0aW9uIF06IGdsLkZVTkNfUkVWRVJTRV9TVUJUUkFDVAoJfTsKCglpZiAoIGlzV2ViR0wyICkgewoKCQllcXVhdGlvblRvR0xbIE1pbkVxdWF0aW9uIF0gPSBnbC5NSU47CgkJZXF1YXRpb25Ub0dMWyBNYXhFcXVhdGlvbiBdID0gZ2wuTUFYOwoKCX0gZWxzZSB7CgoJCWNvbnN0IGV4dGVuc2lvbiA9IGV4dGVuc2lvbnMuZ2V0KCAnRVhUX2JsZW5kX21pbm1heCcgKTsKCgkJaWYgKCBleHRlbnNpb24gIT09IG51bGwgKSB7CgoJCQllcXVhdGlvblRvR0xbIE1pbkVxdWF0aW9uIF0gPSBleHRlbnNpb24uTUlOX0VYVDsKCQkJZXF1YXRpb25Ub0dMWyBNYXhFcXVhdGlvbiBdID0gZXh0ZW5zaW9uLk1BWF9FWFQ7CgoJCX0KCgl9CgoJY29uc3QgZmFjdG9yVG9HTCA9IHsKCQlbIFplcm9GYWN0b3IgXTogZ2wuWkVSTywKCQlbIE9uZUZhY3RvciBdOiBnbC5PTkUsCgkJWyBTcmNDb2xvckZhY3RvciBdOiBnbC5TUkNfQ09MT1IsCgkJWyBTcmNBbHBoYUZhY3RvciBdOiBnbC5TUkNfQUxQSEEsCgkJWyBTcmNBbHBoYVNhdHVyYXRlRmFjdG9yIF06IGdsLlNSQ19BTFBIQV9TQVRVUkFURSwKCQlbIERzdENvbG9yRmFjdG9yIF06IGdsLkRTVF9DT0xPUiwKCQlbIERzdEFscGhhRmFjdG9yIF06IGdsLkRTVF9BTFBIQSwKCQlbIE9uZU1pbnVzU3JjQ29sb3JGYWN0b3IgXTogZ2wuT05FX01JTlVTX1NSQ19DT0xPUiwKCQlbIE9uZU1pbnVzU3JjQWxwaGFGYWN0b3IgXTogZ2wuT05FX01JTlVTX1NSQ19BTFBIQSwKCQlbIE9uZU1pbnVzRHN0Q29sb3JGYWN0b3IgXTogZ2wuT05FX01JTlVTX0RTVF9DT0xPUiwKCQlbIE9uZU1pbnVzRHN0QWxwaGFGYWN0b3IgXTogZ2wuT05FX01JTlVTX0RTVF9BTFBIQSwKCQlbIENvbnN0YW50Q29sb3JGYWN0b3IgXTogZ2wuQ09OU1RBTlRfQ09MT1IsCgkJWyBPbmVNaW51c0NvbnN0YW50Q29sb3JGYWN0b3IgXTogZ2wuT05FX01JTlVTX0NPTlNUQU5UX0NPTE9SLAoJCVsgQ29uc3RhbnRBbHBoYUZhY3RvciBdOiBnbC5DT05TVEFOVF9BTFBIQSwKCQlbIE9uZU1pbnVzQ29uc3RhbnRBbHBoYUZhY3RvciBdOiBnbC5PTkVfTUlOVVNfQ09OU1RBTlRfQUxQSEEKCX07CgoJZnVuY3Rpb24gc2V0QmxlbmRpbmcoIGJsZW5kaW5nLCBibGVuZEVxdWF0aW9uLCBibGVuZFNyYywgYmxlbmREc3QsIGJsZW5kRXF1YXRpb25BbHBoYSwgYmxlbmRTcmNBbHBoYSwgYmxlbmREc3RBbHBoYSwgYmxlbmRDb2xvciwgYmxlbmRBbHBoYSwgcHJlbXVsdGlwbGllZEFscGhhICkgewoKCQlpZiAoIGJsZW5kaW5nID09PSBOb0JsZW5kaW5nICkgewoKCQkJaWYgKCBjdXJyZW50QmxlbmRpbmdFbmFibGVkID09PSB0cnVlICkgewoKCQkJCWRpc2FibGUoIGdsLkJMRU5EICk7CgkJCQljdXJyZW50QmxlbmRpbmdFbmFibGVkID0gZmFsc2U7CgoJCQl9CgoJCQlyZXR1cm47CgoJCX0KCgkJaWYgKCBjdXJyZW50QmxlbmRpbmdFbmFibGVkID09PSBmYWxzZSApIHsKCgkJCWVuYWJsZSggZ2wuQkxFTkQgKTsKCQkJY3VycmVudEJsZW5kaW5nRW5hYmxlZCA9IHRydWU7CgoJCX0KCgkJaWYgKCBibGVuZGluZyAhPT0gQ3VzdG9tQmxlbmRpbmcgKSB7CgoJCQlpZiAoIGJsZW5kaW5nICE9PSBjdXJyZW50QmxlbmRpbmcgfHwgcHJlbXVsdGlwbGllZEFscGhhICE9PSBjdXJyZW50UHJlbXVsdGlwbGVkQWxwaGEgKSB7CgoJCQkJaWYgKCBjdXJyZW50QmxlbmRFcXVhdGlvbiAhPT0gQWRkRXF1YXRpb24gfHwgY3VycmVudEJsZW5kRXF1YXRpb25BbHBoYSAhPT0gQWRkRXF1YXRpb24gKSB7CgoJCQkJCWdsLmJsZW5kRXF1YXRpb24oIGdsLkZVTkNfQUREICk7CgoJCQkJCWN1cnJlbnRCbGVuZEVxdWF0aW9uID0gQWRkRXF1YXRpb247CgkJCQkJY3VycmVudEJsZW5kRXF1YXRpb25BbHBoYSA9IEFkZEVxdWF0aW9uOwoKCQkJCX0KCgkJCQlpZiAoIHByZW11bHRpcGxpZWRBbHBoYSApIHsKCgkJCQkJc3dpdGNoICggYmxlbmRpbmcgKSB7CgoJCQkJCQljYXNlIE5vcm1hbEJsZW5kaW5nOgoJCQkJCQkJZ2wuYmxlbmRGdW5jU2VwYXJhdGUoIGdsLk9ORSwgZ2wuT05FX01JTlVTX1NSQ19BTFBIQSwgZ2wuT05FLCBnbC5PTkVfTUlOVVNfU1JDX0FMUEhBICk7CgkJCQkJCQlicmVhazsKCgkJCQkJCWNhc2UgQWRkaXRpdmVCbGVuZGluZzoKCQkJCQkJCWdsLmJsZW5kRnVuYyggZ2wuT05FLCBnbC5PTkUgKTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJY2FzZSBTdWJ0cmFjdGl2ZUJsZW5kaW5nOgoJCQkJCQkJZ2wuYmxlbmRGdW5jU2VwYXJhdGUoIGdsLlpFUk8sIGdsLk9ORV9NSU5VU19TUkNfQ09MT1IsIGdsLlpFUk8sIGdsLk9ORSApOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQljYXNlIE11bHRpcGx5QmxlbmRpbmc6CgkJCQkJCQlnbC5ibGVuZEZ1bmNTZXBhcmF0ZSggZ2wuWkVSTywgZ2wuU1JDX0NPTE9SLCBnbC5aRVJPLCBnbC5TUkNfQUxQSEEgKTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFN0YXRlOiBJbnZhbGlkIGJsZW5kaW5nOiAnLCBibGVuZGluZyApOwoJCQkJCQkJYnJlYWs7CgoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQlzd2l0Y2ggKCBibGVuZGluZyApIHsKCgkJCQkJCWNhc2UgTm9ybWFsQmxlbmRpbmc6CgkJCQkJCQlnbC5ibGVuZEZ1bmNTZXBhcmF0ZSggZ2wuU1JDX0FMUEhBLCBnbC5PTkVfTUlOVVNfU1JDX0FMUEhBLCBnbC5PTkUsIGdsLk9ORV9NSU5VU19TUkNfQUxQSEEgKTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJY2FzZSBBZGRpdGl2ZUJsZW5kaW5nOgoJCQkJCQkJZ2wuYmxlbmRGdW5jKCBnbC5TUkNfQUxQSEEsIGdsLk9ORSApOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQljYXNlIFN1YnRyYWN0aXZlQmxlbmRpbmc6CgkJCQkJCQlnbC5ibGVuZEZ1bmNTZXBhcmF0ZSggZ2wuWkVSTywgZ2wuT05FX01JTlVTX1NSQ19DT0xPUiwgZ2wuWkVSTywgZ2wuT05FICk7CgkJCQkJCQlicmVhazsKCgkJCQkJCWNhc2UgTXVsdGlwbHlCbGVuZGluZzoKCQkJCQkJCWdsLmJsZW5kRnVuYyggZ2wuWkVSTywgZ2wuU1JDX0NPTE9SICk7CgkJCQkJCQlicmVhazsKCgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuV2ViR0xTdGF0ZTogSW52YWxpZCBibGVuZGluZzogJywgYmxlbmRpbmcgKTsKCQkJCQkJCWJyZWFrOwoKCQkJCQl9CgoJCQkJfQoKCQkJCWN1cnJlbnRCbGVuZFNyYyA9IG51bGw7CgkJCQljdXJyZW50QmxlbmREc3QgPSBudWxsOwoJCQkJY3VycmVudEJsZW5kU3JjQWxwaGEgPSBudWxsOwoJCQkJY3VycmVudEJsZW5kRHN0QWxwaGEgPSBudWxsOwoJCQkJY3VycmVudEJsZW5kQ29sb3Iuc2V0KCAwLCAwLCAwICk7CgkJCQljdXJyZW50QmxlbmRBbHBoYSA9IDA7CgoJCQkJY3VycmVudEJsZW5kaW5nID0gYmxlbmRpbmc7CgkJCQljdXJyZW50UHJlbXVsdGlwbGVkQWxwaGEgPSBwcmVtdWx0aXBsaWVkQWxwaGE7CgoJCQl9CgoJCQlyZXR1cm47CgoJCX0KCgkJLy8gY3VzdG9tIGJsZW5kaW5nCgoJCWJsZW5kRXF1YXRpb25BbHBoYSA9IGJsZW5kRXF1YXRpb25BbHBoYSB8fCBibGVuZEVxdWF0aW9uOwoJCWJsZW5kU3JjQWxwaGEgPSBibGVuZFNyY0FscGhhIHx8IGJsZW5kU3JjOwoJCWJsZW5kRHN0QWxwaGEgPSBibGVuZERzdEFscGhhIHx8IGJsZW5kRHN0OwoKCQlpZiAoIGJsZW5kRXF1YXRpb24gIT09IGN1cnJlbnRCbGVuZEVxdWF0aW9uIHx8IGJsZW5kRXF1YXRpb25BbHBoYSAhPT0gY3VycmVudEJsZW5kRXF1YXRpb25BbHBoYSApIHsKCgkJCWdsLmJsZW5kRXF1YXRpb25TZXBhcmF0ZSggZXF1YXRpb25Ub0dMWyBibGVuZEVxdWF0aW9uIF0sIGVxdWF0aW9uVG9HTFsgYmxlbmRFcXVhdGlvbkFscGhhIF0gKTsKCgkJCWN1cnJlbnRCbGVuZEVxdWF0aW9uID0gYmxlbmRFcXVhdGlvbjsKCQkJY3VycmVudEJsZW5kRXF1YXRpb25BbHBoYSA9IGJsZW5kRXF1YXRpb25BbHBoYTsKCgkJfQoKCQlpZiAoIGJsZW5kU3JjICE9PSBjdXJyZW50QmxlbmRTcmMgfHwgYmxlbmREc3QgIT09IGN1cnJlbnRCbGVuZERzdCB8fCBibGVuZFNyY0FscGhhICE9PSBjdXJyZW50QmxlbmRTcmNBbHBoYSB8fCBibGVuZERzdEFscGhhICE9PSBjdXJyZW50QmxlbmREc3RBbHBoYSApIHsKCgkJCWdsLmJsZW5kRnVuY1NlcGFyYXRlKCBmYWN0b3JUb0dMWyBibGVuZFNyYyBdLCBmYWN0b3JUb0dMWyBibGVuZERzdCBdLCBmYWN0b3JUb0dMWyBibGVuZFNyY0FscGhhIF0sIGZhY3RvclRvR0xbIGJsZW5kRHN0QWxwaGEgXSApOwoKCQkJY3VycmVudEJsZW5kU3JjID0gYmxlbmRTcmM7CgkJCWN1cnJlbnRCbGVuZERzdCA9IGJsZW5kRHN0OwoJCQljdXJyZW50QmxlbmRTcmNBbHBoYSA9IGJsZW5kU3JjQWxwaGE7CgkJCWN1cnJlbnRCbGVuZERzdEFscGhhID0gYmxlbmREc3RBbHBoYTsKCgkJfQoKCQlpZiAoIGJsZW5kQ29sb3IuZXF1YWxzKCBjdXJyZW50QmxlbmRDb2xvciApID09PSBmYWxzZSB8fCBibGVuZEFscGhhICE9PSBjdXJyZW50QmxlbmRBbHBoYSApIHsKCgkJCWdsLmJsZW5kQ29sb3IoIGJsZW5kQ29sb3IuciwgYmxlbmRDb2xvci5nLCBibGVuZENvbG9yLmIsIGJsZW5kQWxwaGEgKTsKCgkJCWN1cnJlbnRCbGVuZENvbG9yLmNvcHkoIGJsZW5kQ29sb3IgKTsKCQkJY3VycmVudEJsZW5kQWxwaGEgPSBibGVuZEFscGhhOwoKCQl9CgoJCWN1cnJlbnRCbGVuZGluZyA9IGJsZW5kaW5nOwoJCWN1cnJlbnRQcmVtdWx0aXBsZWRBbHBoYSA9IGZhbHNlOwoKCX0KCglmdW5jdGlvbiBzZXRNYXRlcmlhbCggbWF0ZXJpYWwsIGZyb250RmFjZUNXICkgewoKCQltYXRlcmlhbC5zaWRlID09PSBEb3VibGVTaWRlCgkJCT8gZGlzYWJsZSggZ2wuQ1VMTF9GQUNFICkKCQkJOiBlbmFibGUoIGdsLkNVTExfRkFDRSApOwoKCQlsZXQgZmxpcFNpZGVkID0gKCBtYXRlcmlhbC5zaWRlID09PSBCYWNrU2lkZSApOwoJCWlmICggZnJvbnRGYWNlQ1cgKSBmbGlwU2lkZWQgPSAhIGZsaXBTaWRlZDsKCgkJc2V0RmxpcFNpZGVkKCBmbGlwU2lkZWQgKTsKCgkJKCBtYXRlcmlhbC5ibGVuZGluZyA9PT0gTm9ybWFsQmxlbmRpbmcgJiYgbWF0ZXJpYWwudHJhbnNwYXJlbnQgPT09IGZhbHNlICkKCQkJPyBzZXRCbGVuZGluZyggTm9CbGVuZGluZyApCgkJCTogc2V0QmxlbmRpbmcoIG1hdGVyaWFsLmJsZW5kaW5nLCBtYXRlcmlhbC5ibGVuZEVxdWF0aW9uLCBtYXRlcmlhbC5ibGVuZFNyYywgbWF0ZXJpYWwuYmxlbmREc3QsIG1hdGVyaWFsLmJsZW5kRXF1YXRpb25BbHBoYSwgbWF0ZXJpYWwuYmxlbmRTcmNBbHBoYSwgbWF0ZXJpYWwuYmxlbmREc3RBbHBoYSwgbWF0ZXJpYWwuYmxlbmRDb2xvciwgbWF0ZXJpYWwuYmxlbmRBbHBoYSwgbWF0ZXJpYWwucHJlbXVsdGlwbGllZEFscGhhICk7CgoJCWRlcHRoQnVmZmVyLnNldEZ1bmMoIG1hdGVyaWFsLmRlcHRoRnVuYyApOwoJCWRlcHRoQnVmZmVyLnNldFRlc3QoIG1hdGVyaWFsLmRlcHRoVGVzdCApOwoJCWRlcHRoQnVmZmVyLnNldE1hc2soIG1hdGVyaWFsLmRlcHRoV3JpdGUgKTsKCQljb2xvckJ1ZmZlci5zZXRNYXNrKCBtYXRlcmlhbC5jb2xvcldyaXRlICk7CgoJCWNvbnN0IHN0ZW5jaWxXcml0ZSA9IG1hdGVyaWFsLnN0ZW5jaWxXcml0ZTsKCQlzdGVuY2lsQnVmZmVyLnNldFRlc3QoIHN0ZW5jaWxXcml0ZSApOwoJCWlmICggc3RlbmNpbFdyaXRlICkgewoKCQkJc3RlbmNpbEJ1ZmZlci5zZXRNYXNrKCBtYXRlcmlhbC5zdGVuY2lsV3JpdGVNYXNrICk7CgkJCXN0ZW5jaWxCdWZmZXIuc2V0RnVuYyggbWF0ZXJpYWwuc3RlbmNpbEZ1bmMsIG1hdGVyaWFsLnN0ZW5jaWxSZWYsIG1hdGVyaWFsLnN0ZW5jaWxGdW5jTWFzayApOwoJCQlzdGVuY2lsQnVmZmVyLnNldE9wKCBtYXRlcmlhbC5zdGVuY2lsRmFpbCwgbWF0ZXJpYWwuc3RlbmNpbFpGYWlsLCBtYXRlcmlhbC5zdGVuY2lsWlBhc3MgKTsKCgkJfQoKCQlzZXRQb2x5Z29uT2Zmc2V0KCBtYXRlcmlhbC5wb2x5Z29uT2Zmc2V0LCBtYXRlcmlhbC5wb2x5Z29uT2Zmc2V0RmFjdG9yLCBtYXRlcmlhbC5wb2x5Z29uT2Zmc2V0VW5pdHMgKTsKCgkJbWF0ZXJpYWwuYWxwaGFUb0NvdmVyYWdlID09PSB0cnVlCgkJCT8gZW5hYmxlKCBnbC5TQU1QTEVfQUxQSEFfVE9fQ09WRVJBR0UgKQoJCQk6IGRpc2FibGUoIGdsLlNBTVBMRV9BTFBIQV9UT19DT1ZFUkFHRSApOwoKCX0KCgkvLwoKCWZ1bmN0aW9uIHNldEZsaXBTaWRlZCggZmxpcFNpZGVkICkgewoKCQlpZiAoIGN1cnJlbnRGbGlwU2lkZWQgIT09IGZsaXBTaWRlZCApIHsKCgkJCWlmICggZmxpcFNpZGVkICkgewoKCQkJCWdsLmZyb250RmFjZSggZ2wuQ1cgKTsKCgkJCX0gZWxzZSB7CgoJCQkJZ2wuZnJvbnRGYWNlKCBnbC5DQ1cgKTsKCgkJCX0KCgkJCWN1cnJlbnRGbGlwU2lkZWQgPSBmbGlwU2lkZWQ7CgoJCX0KCgl9CgoJZnVuY3Rpb24gc2V0Q3VsbEZhY2UoIGN1bGxGYWNlICkgewoKCQlpZiAoIGN1bGxGYWNlICE9PSBDdWxsRmFjZU5vbmUgKSB7CgoJCQllbmFibGUoIGdsLkNVTExfRkFDRSApOwoKCQkJaWYgKCBjdWxsRmFjZSAhPT0gY3VycmVudEN1bGxGYWNlICkgewoKCQkJCWlmICggY3VsbEZhY2UgPT09IEN1bGxGYWNlQmFjayApIHsKCgkJCQkJZ2wuY3VsbEZhY2UoIGdsLkJBQ0sgKTsKCgkJCQl9IGVsc2UgaWYgKCBjdWxsRmFjZSA9PT0gQ3VsbEZhY2VGcm9udCApIHsKCgkJCQkJZ2wuY3VsbEZhY2UoIGdsLkZST05UICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJZ2wuY3VsbEZhY2UoIGdsLkZST05UX0FORF9CQUNLICk7CgoJCQkJfQoKCQkJfQoKCQl9IGVsc2UgewoKCQkJZGlzYWJsZSggZ2wuQ1VMTF9GQUNFICk7CgoJCX0KCgkJY3VycmVudEN1bGxGYWNlID0gY3VsbEZhY2U7CgoJfQoKCWZ1bmN0aW9uIHNldExpbmVXaWR0aCggd2lkdGggKSB7CgoJCWlmICggd2lkdGggIT09IGN1cnJlbnRMaW5lV2lkdGggKSB7CgoJCQlpZiAoIGxpbmVXaWR0aEF2YWlsYWJsZSApIGdsLmxpbmVXaWR0aCggd2lkdGggKTsKCgkJCWN1cnJlbnRMaW5lV2lkdGggPSB3aWR0aDsKCgkJfQoKCX0KCglmdW5jdGlvbiBzZXRQb2x5Z29uT2Zmc2V0KCBwb2x5Z29uT2Zmc2V0LCBmYWN0b3IsIHVuaXRzICkgewoKCQlpZiAoIHBvbHlnb25PZmZzZXQgKSB7CgoJCQllbmFibGUoIGdsLlBPTFlHT05fT0ZGU0VUX0ZJTEwgKTsKCgkJCWlmICggY3VycmVudFBvbHlnb25PZmZzZXRGYWN0b3IgIT09IGZhY3RvciB8fCBjdXJyZW50UG9seWdvbk9mZnNldFVuaXRzICE9PSB1bml0cyApIHsKCgkJCQlnbC5wb2x5Z29uT2Zmc2V0KCBmYWN0b3IsIHVuaXRzICk7CgoJCQkJY3VycmVudFBvbHlnb25PZmZzZXRGYWN0b3IgPSBmYWN0b3I7CgkJCQljdXJyZW50UG9seWdvbk9mZnNldFVuaXRzID0gdW5pdHM7CgoJCQl9CgoJCX0gZWxzZSB7CgoJCQlkaXNhYmxlKCBnbC5QT0xZR09OX09GRlNFVF9GSUxMICk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gc2V0U2Npc3NvclRlc3QoIHNjaXNzb3JUZXN0ICkgewoKCQlpZiAoIHNjaXNzb3JUZXN0ICkgewoKCQkJZW5hYmxlKCBnbC5TQ0lTU09SX1RFU1QgKTsKCgkJfSBlbHNlIHsKCgkJCWRpc2FibGUoIGdsLlNDSVNTT1JfVEVTVCApOwoKCQl9CgoJfQoKCS8vIHRleHR1cmUKCglmdW5jdGlvbiBhY3RpdmVUZXh0dXJlKCB3ZWJnbFNsb3QgKSB7CgoJCWlmICggd2ViZ2xTbG90ID09PSB1bmRlZmluZWQgKSB3ZWJnbFNsb3QgPSBnbC5URVhUVVJFMCArIG1heFRleHR1cmVzIC0gMTsKCgkJaWYgKCBjdXJyZW50VGV4dHVyZVNsb3QgIT09IHdlYmdsU2xvdCApIHsKCgkJCWdsLmFjdGl2ZVRleHR1cmUoIHdlYmdsU2xvdCApOwoJCQljdXJyZW50VGV4dHVyZVNsb3QgPSB3ZWJnbFNsb3Q7CgoJCX0KCgl9CgoJZnVuY3Rpb24gYmluZFRleHR1cmUoIHdlYmdsVHlwZSwgd2ViZ2xUZXh0dXJlLCB3ZWJnbFNsb3QgKSB7CgoJCWlmICggd2ViZ2xTbG90ID09PSB1bmRlZmluZWQgKSB7CgoJCQlpZiAoIGN1cnJlbnRUZXh0dXJlU2xvdCA9PT0gbnVsbCApIHsKCgkJCQl3ZWJnbFNsb3QgPSBnbC5URVhUVVJFMCArIG1heFRleHR1cmVzIC0gMTsKCgkJCX0gZWxzZSB7CgoJCQkJd2ViZ2xTbG90ID0gY3VycmVudFRleHR1cmVTbG90OwoKCQkJfQoKCQl9CgoJCWxldCBib3VuZFRleHR1cmUgPSBjdXJyZW50Qm91bmRUZXh0dXJlc1sgd2ViZ2xTbG90IF07CgoJCWlmICggYm91bmRUZXh0dXJlID09PSB1bmRlZmluZWQgKSB7CgoJCQlib3VuZFRleHR1cmUgPSB7IHR5cGU6IHVuZGVmaW5lZCwgdGV4dHVyZTogdW5kZWZpbmVkIH07CgkJCWN1cnJlbnRCb3VuZFRleHR1cmVzWyB3ZWJnbFNsb3QgXSA9IGJvdW5kVGV4dHVyZTsKCgkJfQoKCQlpZiAoIGJvdW5kVGV4dHVyZS50eXBlICE9PSB3ZWJnbFR5cGUgfHwgYm91bmRUZXh0dXJlLnRleHR1cmUgIT09IHdlYmdsVGV4dHVyZSApIHsKCgkJCWlmICggY3VycmVudFRleHR1cmVTbG90ICE9PSB3ZWJnbFNsb3QgKSB7CgoJCQkJZ2wuYWN0aXZlVGV4dHVyZSggd2ViZ2xTbG90ICk7CgkJCQljdXJyZW50VGV4dHVyZVNsb3QgPSB3ZWJnbFNsb3Q7CgoJCQl9CgoJCQlnbC5iaW5kVGV4dHVyZSggd2ViZ2xUeXBlLCB3ZWJnbFRleHR1cmUgfHwgZW1wdHlUZXh0dXJlc1sgd2ViZ2xUeXBlIF0gKTsKCgkJCWJvdW5kVGV4dHVyZS50eXBlID0gd2ViZ2xUeXBlOwoJCQlib3VuZFRleHR1cmUudGV4dHVyZSA9IHdlYmdsVGV4dHVyZTsKCgkJfQoKCX0KCglmdW5jdGlvbiB1bmJpbmRUZXh0dXJlKCkgewoKCQljb25zdCBib3VuZFRleHR1cmUgPSBjdXJyZW50Qm91bmRUZXh0dXJlc1sgY3VycmVudFRleHR1cmVTbG90IF07CgoJCWlmICggYm91bmRUZXh0dXJlICE9PSB1bmRlZmluZWQgJiYgYm91bmRUZXh0dXJlLnR5cGUgIT09IHVuZGVmaW5lZCApIHsKCgkJCWdsLmJpbmRUZXh0dXJlKCBib3VuZFRleHR1cmUudHlwZSwgbnVsbCApOwoKCQkJYm91bmRUZXh0dXJlLnR5cGUgPSB1bmRlZmluZWQ7CgkJCWJvdW5kVGV4dHVyZS50ZXh0dXJlID0gdW5kZWZpbmVkOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIGNvbXByZXNzZWRUZXhJbWFnZTJEKCkgewoKCQl0cnkgewoKCQkJZ2wuY29tcHJlc3NlZFRleEltYWdlMkQuYXBwbHkoIGdsLCBhcmd1bWVudHMgKTsKCgkJfSBjYXRjaCAoIGVycm9yICkgewoKCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLldlYkdMU3RhdGU6JywgZXJyb3IgKTsKCgkJfQoKCX0KCglmdW5jdGlvbiBjb21wcmVzc2VkVGV4SW1hZ2UzRCgpIHsKCgkJdHJ5IHsKCgkJCWdsLmNvbXByZXNzZWRUZXhJbWFnZTNELmFwcGx5KCBnbCwgYXJndW1lbnRzICk7CgoJCX0gY2F0Y2ggKCBlcnJvciApIHsKCgkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFN0YXRlOicsIGVycm9yICk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gdGV4U3ViSW1hZ2UyRCgpIHsKCgkJdHJ5IHsKCgkJCWdsLnRleFN1YkltYWdlMkQuYXBwbHkoIGdsLCBhcmd1bWVudHMgKTsKCgkJfSBjYXRjaCAoIGVycm9yICkgewoKCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLldlYkdMU3RhdGU6JywgZXJyb3IgKTsKCgkJfQoKCX0KCglmdW5jdGlvbiB0ZXhTdWJJbWFnZTNEKCkgewoKCQl0cnkgewoKCQkJZ2wudGV4U3ViSW1hZ2UzRC5hcHBseSggZ2wsIGFyZ3VtZW50cyApOwoKCQl9IGNhdGNoICggZXJyb3IgKSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuV2ViR0xTdGF0ZTonLCBlcnJvciApOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIGNvbXByZXNzZWRUZXhTdWJJbWFnZTJEKCkgewoKCQl0cnkgewoKCQkJZ2wuY29tcHJlc3NlZFRleFN1YkltYWdlMkQuYXBwbHkoIGdsLCBhcmd1bWVudHMgKTsKCgkJfSBjYXRjaCAoIGVycm9yICkgewoKCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLldlYkdMU3RhdGU6JywgZXJyb3IgKTsKCgkJfQoKCX0KCglmdW5jdGlvbiBjb21wcmVzc2VkVGV4U3ViSW1hZ2UzRCgpIHsKCgkJdHJ5IHsKCgkJCWdsLmNvbXByZXNzZWRUZXhTdWJJbWFnZTNELmFwcGx5KCBnbCwgYXJndW1lbnRzICk7CgoJCX0gY2F0Y2ggKCBlcnJvciApIHsKCgkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFN0YXRlOicsIGVycm9yICk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gdGV4U3RvcmFnZTJEKCkgewoKCQl0cnkgewoKCQkJZ2wudGV4U3RvcmFnZTJELmFwcGx5KCBnbCwgYXJndW1lbnRzICk7CgoJCX0gY2F0Y2ggKCBlcnJvciApIHsKCgkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFN0YXRlOicsIGVycm9yICk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gdGV4U3RvcmFnZTNEKCkgewoKCQl0cnkgewoKCQkJZ2wudGV4U3RvcmFnZTNELmFwcGx5KCBnbCwgYXJndW1lbnRzICk7CgoJCX0gY2F0Y2ggKCBlcnJvciApIHsKCgkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFN0YXRlOicsIGVycm9yICk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gdGV4SW1hZ2UyRCgpIHsKCgkJdHJ5IHsKCgkJCWdsLnRleEltYWdlMkQuYXBwbHkoIGdsLCBhcmd1bWVudHMgKTsKCgkJfSBjYXRjaCAoIGVycm9yICkgewoKCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLldlYkdMU3RhdGU6JywgZXJyb3IgKTsKCgkJfQoKCX0KCglmdW5jdGlvbiB0ZXhJbWFnZTNEKCkgewoKCQl0cnkgewoKCQkJZ2wudGV4SW1hZ2UzRC5hcHBseSggZ2wsIGFyZ3VtZW50cyApOwoKCQl9IGNhdGNoICggZXJyb3IgKSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuV2ViR0xTdGF0ZTonLCBlcnJvciApOwoKCQl9CgoJfQoKCS8vCgoJZnVuY3Rpb24gc2Npc3Nvciggc2Npc3NvciApIHsKCgkJaWYgKCBjdXJyZW50U2Npc3Nvci5lcXVhbHMoIHNjaXNzb3IgKSA9PT0gZmFsc2UgKSB7CgoJCQlnbC5zY2lzc29yKCBzY2lzc29yLngsIHNjaXNzb3IueSwgc2Npc3Nvci56LCBzY2lzc29yLncgKTsKCQkJY3VycmVudFNjaXNzb3IuY29weSggc2Npc3NvciApOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIHZpZXdwb3J0KCB2aWV3cG9ydCApIHsKCgkJaWYgKCBjdXJyZW50Vmlld3BvcnQuZXF1YWxzKCB2aWV3cG9ydCApID09PSBmYWxzZSApIHsKCgkJCWdsLnZpZXdwb3J0KCB2aWV3cG9ydC54LCB2aWV3cG9ydC55LCB2aWV3cG9ydC56LCB2aWV3cG9ydC53ICk7CgkJCWN1cnJlbnRWaWV3cG9ydC5jb3B5KCB2aWV3cG9ydCApOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIHVwZGF0ZVVCT01hcHBpbmcoIHVuaWZvcm1zR3JvdXAsIHByb2dyYW0gKSB7CgoJCWxldCBtYXBwaW5nID0gdWJvUHJvZ3JhbU1hcC5nZXQoIHByb2dyYW0gKTsKCgkJaWYgKCBtYXBwaW5nID09PSB1bmRlZmluZWQgKSB7CgoJCQltYXBwaW5nID0gbmV3IFdlYWtNYXAoKTsKCgkJCXVib1Byb2dyYW1NYXAuc2V0KCBwcm9ncmFtLCBtYXBwaW5nICk7CgoJCX0KCgkJbGV0IGJsb2NrSW5kZXggPSBtYXBwaW5nLmdldCggdW5pZm9ybXNHcm91cCApOwoKCQlpZiAoIGJsb2NrSW5kZXggPT09IHVuZGVmaW5lZCApIHsKCgkJCWJsb2NrSW5kZXggPSBnbC5nZXRVbmlmb3JtQmxvY2tJbmRleCggcHJvZ3JhbSwgdW5pZm9ybXNHcm91cC5uYW1lICk7CgoJCQltYXBwaW5nLnNldCggdW5pZm9ybXNHcm91cCwgYmxvY2tJbmRleCApOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIHVuaWZvcm1CbG9ja0JpbmRpbmcoIHVuaWZvcm1zR3JvdXAsIHByb2dyYW0gKSB7CgoJCWNvbnN0IG1hcHBpbmcgPSB1Ym9Qcm9ncmFtTWFwLmdldCggcHJvZ3JhbSApOwoJCWNvbnN0IGJsb2NrSW5kZXggPSBtYXBwaW5nLmdldCggdW5pZm9ybXNHcm91cCApOwoKCQlpZiAoIHVib0JpbmRpbmdzLmdldCggcHJvZ3JhbSApICE9PSBibG9ja0luZGV4ICkgewoKCQkJLy8gYmluZCBzaGFkZXIgc3BlY2lmaWMgYmxvY2sgaW5kZXggdG8gZ2xvYmFsIGJsb2NrIHBvaW50CgkJCWdsLnVuaWZvcm1CbG9ja0JpbmRpbmcoIHByb2dyYW0sIGJsb2NrSW5kZXgsIHVuaWZvcm1zR3JvdXAuX19iaW5kaW5nUG9pbnRJbmRleCApOwoKCQkJdWJvQmluZGluZ3Muc2V0KCBwcm9ncmFtLCBibG9ja0luZGV4ICk7CgoJCX0KCgl9CgoJLy8KCglmdW5jdGlvbiByZXNldCgpIHsKCgkJLy8gcmVzZXQgc3RhdGUKCgkJZ2wuZGlzYWJsZSggZ2wuQkxFTkQgKTsKCQlnbC5kaXNhYmxlKCBnbC5DVUxMX0ZBQ0UgKTsKCQlnbC5kaXNhYmxlKCBnbC5ERVBUSF9URVNUICk7CgkJZ2wuZGlzYWJsZSggZ2wuUE9MWUdPTl9PRkZTRVRfRklMTCApOwoJCWdsLmRpc2FibGUoIGdsLlNDSVNTT1JfVEVTVCApOwoJCWdsLmRpc2FibGUoIGdsLlNURU5DSUxfVEVTVCApOwoJCWdsLmRpc2FibGUoIGdsLlNBTVBMRV9BTFBIQV9UT19DT1ZFUkFHRSApOwoKCQlnbC5ibGVuZEVxdWF0aW9uKCBnbC5GVU5DX0FERCApOwoJCWdsLmJsZW5kRnVuYyggZ2wuT05FLCBnbC5aRVJPICk7CgkJZ2wuYmxlbmRGdW5jU2VwYXJhdGUoIGdsLk9ORSwgZ2wuWkVSTywgZ2wuT05FLCBnbC5aRVJPICk7CgkJZ2wuYmxlbmRDb2xvciggMCwgMCwgMCwgMCApOwoKCQlnbC5jb2xvck1hc2soIHRydWUsIHRydWUsIHRydWUsIHRydWUgKTsKCQlnbC5jbGVhckNvbG9yKCAwLCAwLCAwLCAwICk7CgoJCWdsLmRlcHRoTWFzayggdHJ1ZSApOwoJCWdsLmRlcHRoRnVuYyggZ2wuTEVTUyApOwoJCWdsLmNsZWFyRGVwdGgoIDEgKTsKCgkJZ2wuc3RlbmNpbE1hc2soIDB4ZmZmZmZmZmYgKTsKCQlnbC5zdGVuY2lsRnVuYyggZ2wuQUxXQVlTLCAwLCAweGZmZmZmZmZmICk7CgkJZ2wuc3RlbmNpbE9wKCBnbC5LRUVQLCBnbC5LRUVQLCBnbC5LRUVQICk7CgkJZ2wuY2xlYXJTdGVuY2lsKCAwICk7CgoJCWdsLmN1bGxGYWNlKCBnbC5CQUNLICk7CgkJZ2wuZnJvbnRGYWNlKCBnbC5DQ1cgKTsKCgkJZ2wucG9seWdvbk9mZnNldCggMCwgMCApOwoKCQlnbC5hY3RpdmVUZXh0dXJlKCBnbC5URVhUVVJFMCApOwoKCQlnbC5iaW5kRnJhbWVidWZmZXIoIGdsLkZSQU1FQlVGRkVSLCBudWxsICk7CgoJCWlmICggaXNXZWJHTDIgPT09IHRydWUgKSB7CgoJCQlnbC5iaW5kRnJhbWVidWZmZXIoIGdsLkRSQVdfRlJBTUVCVUZGRVIsIG51bGwgKTsKCQkJZ2wuYmluZEZyYW1lYnVmZmVyKCBnbC5SRUFEX0ZSQU1FQlVGRkVSLCBudWxsICk7CgoJCX0KCgkJZ2wudXNlUHJvZ3JhbSggbnVsbCApOwoKCQlnbC5saW5lV2lkdGgoIDEgKTsKCgkJZ2wuc2Npc3NvciggMCwgMCwgZ2wuY2FudmFzLndpZHRoLCBnbC5jYW52YXMuaGVpZ2h0ICk7CgkJZ2wudmlld3BvcnQoIDAsIDAsIGdsLmNhbnZhcy53aWR0aCwgZ2wuY2FudmFzLmhlaWdodCApOwoKCQkvLyByZXNldCBpbnRlcm5hbHMKCgkJZW5hYmxlZENhcGFiaWxpdGllcyA9IHt9OwoKCQljdXJyZW50VGV4dHVyZVNsb3QgPSBudWxsOwoJCWN1cnJlbnRCb3VuZFRleHR1cmVzID0ge307CgoJCWN1cnJlbnRCb3VuZEZyYW1lYnVmZmVycyA9IHt9OwoJCWN1cnJlbnREcmF3YnVmZmVycyA9IG5ldyBXZWFrTWFwKCk7CgkJZGVmYXVsdERyYXdidWZmZXJzID0gW107CgoJCWN1cnJlbnRQcm9ncmFtID0gbnVsbDsKCgkJY3VycmVudEJsZW5kaW5nRW5hYmxlZCA9IGZhbHNlOwoJCWN1cnJlbnRCbGVuZGluZyA9IG51bGw7CgkJY3VycmVudEJsZW5kRXF1YXRpb24gPSBudWxsOwoJCWN1cnJlbnRCbGVuZFNyYyA9IG51bGw7CgkJY3VycmVudEJsZW5kRHN0ID0gbnVsbDsKCQljdXJyZW50QmxlbmRFcXVhdGlvbkFscGhhID0gbnVsbDsKCQljdXJyZW50QmxlbmRTcmNBbHBoYSA9IG51bGw7CgkJY3VycmVudEJsZW5kRHN0QWxwaGEgPSBudWxsOwoJCWN1cnJlbnRCbGVuZENvbG9yID0gbmV3IENvbG9yKCAwLCAwLCAwICk7CgkJY3VycmVudEJsZW5kQWxwaGEgPSAwOwoJCWN1cnJlbnRQcmVtdWx0aXBsZWRBbHBoYSA9IGZhbHNlOwoKCQljdXJyZW50RmxpcFNpZGVkID0gbnVsbDsKCQljdXJyZW50Q3VsbEZhY2UgPSBudWxsOwoKCQljdXJyZW50TGluZVdpZHRoID0gbnVsbDsKCgkJY3VycmVudFBvbHlnb25PZmZzZXRGYWN0b3IgPSBudWxsOwoJCWN1cnJlbnRQb2x5Z29uT2Zmc2V0VW5pdHMgPSBudWxsOwoKCQljdXJyZW50U2Npc3Nvci5zZXQoIDAsIDAsIGdsLmNhbnZhcy53aWR0aCwgZ2wuY2FudmFzLmhlaWdodCApOwoJCWN1cnJlbnRWaWV3cG9ydC5zZXQoIDAsIDAsIGdsLmNhbnZhcy53aWR0aCwgZ2wuY2FudmFzLmhlaWdodCApOwoKCQljb2xvckJ1ZmZlci5yZXNldCgpOwoJCWRlcHRoQnVmZmVyLnJlc2V0KCk7CgkJc3RlbmNpbEJ1ZmZlci5yZXNldCgpOwoKCX0KCglyZXR1cm4gewoKCQlidWZmZXJzOiB7CgkJCWNvbG9yOiBjb2xvckJ1ZmZlciwKCQkJZGVwdGg6IGRlcHRoQnVmZmVyLAoJCQlzdGVuY2lsOiBzdGVuY2lsQnVmZmVyCgkJfSwKCgkJZW5hYmxlOiBlbmFibGUsCgkJZGlzYWJsZTogZGlzYWJsZSwKCgkJYmluZEZyYW1lYnVmZmVyOiBiaW5kRnJhbWVidWZmZXIsCgkJZHJhd0J1ZmZlcnM6IGRyYXdCdWZmZXJzLAoKCQl1c2VQcm9ncmFtOiB1c2VQcm9ncmFtLAoKCQlzZXRCbGVuZGluZzogc2V0QmxlbmRpbmcsCgkJc2V0TWF0ZXJpYWw6IHNldE1hdGVyaWFsLAoKCQlzZXRGbGlwU2lkZWQ6IHNldEZsaXBTaWRlZCwKCQlzZXRDdWxsRmFjZTogc2V0Q3VsbEZhY2UsCgoJCXNldExpbmVXaWR0aDogc2V0TGluZVdpZHRoLAoJCXNldFBvbHlnb25PZmZzZXQ6IHNldFBvbHlnb25PZmZzZXQsCgoJCXNldFNjaXNzb3JUZXN0OiBzZXRTY2lzc29yVGVzdCwKCgkJYWN0aXZlVGV4dHVyZTogYWN0aXZlVGV4dHVyZSwKCQliaW5kVGV4dHVyZTogYmluZFRleHR1cmUsCgkJdW5iaW5kVGV4dHVyZTogdW5iaW5kVGV4dHVyZSwKCQljb21wcmVzc2VkVGV4SW1hZ2UyRDogY29tcHJlc3NlZFRleEltYWdlMkQsCgkJY29tcHJlc3NlZFRleEltYWdlM0Q6IGNvbXByZXNzZWRUZXhJbWFnZTNELAoJCXRleEltYWdlMkQ6IHRleEltYWdlMkQsCgkJdGV4SW1hZ2UzRDogdGV4SW1hZ2UzRCwKCgkJdXBkYXRlVUJPTWFwcGluZzogdXBkYXRlVUJPTWFwcGluZywKCQl1bmlmb3JtQmxvY2tCaW5kaW5nOiB1bmlmb3JtQmxvY2tCaW5kaW5nLAoKCQl0ZXhTdG9yYWdlMkQ6IHRleFN0b3JhZ2UyRCwKCQl0ZXhTdG9yYWdlM0Q6IHRleFN0b3JhZ2UzRCwKCQl0ZXhTdWJJbWFnZTJEOiB0ZXhTdWJJbWFnZTJELAoJCXRleFN1YkltYWdlM0Q6IHRleFN1YkltYWdlM0QsCgkJY29tcHJlc3NlZFRleFN1YkltYWdlMkQ6IGNvbXByZXNzZWRUZXhTdWJJbWFnZTJELAoJCWNvbXByZXNzZWRUZXhTdWJJbWFnZTNEOiBjb21wcmVzc2VkVGV4U3ViSW1hZ2UzRCwKCgkJc2Npc3Nvcjogc2Npc3NvciwKCQl2aWV3cG9ydDogdmlld3BvcnQsCgoJCXJlc2V0OiByZXNldAoKCX07Cgp9CgpmdW5jdGlvbiBXZWJHTFRleHR1cmVzKCBfZ2wsIGV4dGVuc2lvbnMsIHN0YXRlLCBwcm9wZXJ0aWVzLCBjYXBhYmlsaXRpZXMsIHV0aWxzLCBpbmZvICkgewoKCWNvbnN0IGlzV2ViR0wyID0gY2FwYWJpbGl0aWVzLmlzV2ViR0wyOwoJY29uc3QgbXVsdGlzYW1wbGVkUlRURXh0ID0gZXh0ZW5zaW9ucy5oYXMoICdXRUJHTF9tdWx0aXNhbXBsZWRfcmVuZGVyX3RvX3RleHR1cmUnICkgPyBleHRlbnNpb25zLmdldCggJ1dFQkdMX211bHRpc2FtcGxlZF9yZW5kZXJfdG9fdGV4dHVyZScgKSA6IG51bGw7Cgljb25zdCBzdXBwb3J0c0ludmFsaWRhdGVGcmFtZWJ1ZmZlciA9IHR5cGVvZiBuYXZpZ2F0b3IgPT09ICd1bmRlZmluZWQnID8gZmFsc2UgOiAvT2N1bHVzQnJvd3Nlci9nLnRlc3QoIG5hdmlnYXRvci51c2VyQWdlbnQgKTsKCgljb25zdCBfdmlkZW9UZXh0dXJlcyA9IG5ldyBXZWFrTWFwKCk7CglsZXQgX2NhbnZhczsKCgljb25zdCBfc291cmNlcyA9IG5ldyBXZWFrTWFwKCk7IC8vIG1hcHMgV2ViZ2xUZXh0dXJlIG9iamVjdHMgdG8gaW5zdGFuY2VzIG9mIFNvdXJjZQoKCS8vIGNvcmRvdmEgaU9TIChhcyBvZiA1LjApIHN0aWxsIHVzZXMgVUlXZWJWaWV3LCB3aGljaCBwcm92aWRlcyBPZmZzY3JlZW5DYW52YXMsCgkvLyBhbHNvIE9mZnNjcmVlbkNhbnZhcy5nZXRDb250ZXh0KCJ3ZWJnbCIpLCBidXQgbm90IE9mZnNjcmVlbkNhbnZhcy5nZXRDb250ZXh0KCIyZCIpIQoJLy8gU29tZSBpbXBsZW1lbnRhdGlvbnMgbWF5IG9ubHkgaW1wbGVtZW50IE9mZnNjcmVlbkNhbnZhcyBwYXJ0aWFsbHkgKGUuZy4gbGFja2luZyAyZCkuCgoJbGV0IHVzZU9mZnNjcmVlbkNhbnZhcyA9IGZhbHNlOwoKCXRyeSB7CgoJCXVzZU9mZnNjcmVlbkNhbnZhcyA9IHR5cGVvZiBPZmZzY3JlZW5DYW52YXMgIT09ICd1bmRlZmluZWQnCgkJCS8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjb21wYXQvY29tcGF0CgkJCSYmICggbmV3IE9mZnNjcmVlbkNhbnZhcyggMSwgMSApLmdldENvbnRleHQoICcyZCcgKSApICE9PSBudWxsOwoKCX0gY2F0Y2ggKCBlcnIgKSB7CgoJCS8vIElnbm9yZSBhbnkgZXJyb3JzCgoJfQoKCWZ1bmN0aW9uIGNyZWF0ZUNhbnZhcyggd2lkdGgsIGhlaWdodCApIHsKCgkJLy8gVXNlIE9mZnNjcmVlbkNhbnZhcyB3aGVuIGF2YWlsYWJsZS4gU3BlY2lhbGx5IG5lZWRlZCBpbiB3ZWIgd29ya2VycwoKCQlyZXR1cm4gdXNlT2Zmc2NyZWVuQ2FudmFzID8KCQkJLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbXBhdC9jb21wYXQKCQkJbmV3IE9mZnNjcmVlbkNhbnZhcyggd2lkdGgsIGhlaWdodCApIDogY3JlYXRlRWxlbWVudE5TKCAnY2FudmFzJyApOwoKCX0KCglmdW5jdGlvbiByZXNpemVJbWFnZSggaW1hZ2UsIG5lZWRzUG93ZXJPZlR3bywgbmVlZHNOZXdDYW52YXMsIG1heFNpemUgKSB7CgoJCWxldCBzY2FsZSA9IDE7CgoJCS8vIGhhbmRsZSBjYXNlIGlmIHRleHR1cmUgZXhjZWVkcyBtYXggc2l6ZQoKCQlpZiAoIGltYWdlLndpZHRoID4gbWF4U2l6ZSB8fCBpbWFnZS5oZWlnaHQgPiBtYXhTaXplICkgewoKCQkJc2NhbGUgPSBtYXhTaXplIC8gTWF0aC5tYXgoIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQgKTsKCgkJfQoKCQkvLyBvbmx5IHBlcmZvcm0gcmVzaXplIGlmIG5lY2Vzc2FyeQoKCQlpZiAoIHNjYWxlIDwgMSB8fCBuZWVkc1Bvd2VyT2ZUd28gPT09IHRydWUgKSB7CgoJCQkvLyBvbmx5IHBlcmZvcm0gcmVzaXplIGZvciBjZXJ0YWluIGltYWdlIHR5cGVzCgoJCQlpZiAoICggdHlwZW9mIEhUTUxJbWFnZUVsZW1lbnQgIT09ICd1bmRlZmluZWQnICYmIGltYWdlIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCApIHx8CgkJCQkoIHR5cGVvZiBIVE1MQ2FudmFzRWxlbWVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgaW1hZ2UgaW5zdGFuY2VvZiBIVE1MQ2FudmFzRWxlbWVudCApIHx8CgkJCQkoIHR5cGVvZiBJbWFnZUJpdG1hcCAhPT0gJ3VuZGVmaW5lZCcgJiYgaW1hZ2UgaW5zdGFuY2VvZiBJbWFnZUJpdG1hcCApICkgewoKCQkJCWNvbnN0IGZsb29yID0gbmVlZHNQb3dlck9mVHdvID8gZmxvb3JQb3dlck9mVHdvIDogTWF0aC5mbG9vcjsKCgkJCQljb25zdCB3aWR0aCA9IGZsb29yKCBzY2FsZSAqIGltYWdlLndpZHRoICk7CgkJCQljb25zdCBoZWlnaHQgPSBmbG9vciggc2NhbGUgKiBpbWFnZS5oZWlnaHQgKTsKCgkJCQlpZiAoIF9jYW52YXMgPT09IHVuZGVmaW5lZCApIF9jYW52YXMgPSBjcmVhdGVDYW52YXMoIHdpZHRoLCBoZWlnaHQgKTsKCgkJCQkvLyBjdWJlIHRleHR1cmVzIGNhbid0IHJldXNlIHRoZSBzYW1lIGNhbnZhcwoKCQkJCWNvbnN0IGNhbnZhcyA9IG5lZWRzTmV3Q2FudmFzID8gY3JlYXRlQ2FudmFzKCB3aWR0aCwgaGVpZ2h0ICkgOiBfY2FudmFzOwoKCQkJCWNhbnZhcy53aWR0aCA9IHdpZHRoOwoJCQkJY2FudmFzLmhlaWdodCA9IGhlaWdodDsKCgkJCQljb25zdCBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoICcyZCcgKTsKCQkJCWNvbnRleHQuZHJhd0ltYWdlKCBpbWFnZSwgMCwgMCwgd2lkdGgsIGhlaWdodCApOwoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IFRleHR1cmUgaGFzIGJlZW4gcmVzaXplZCBmcm9tICgnICsgaW1hZ2Uud2lkdGggKyAneCcgKyBpbWFnZS5oZWlnaHQgKyAnKSB0byAoJyArIHdpZHRoICsgJ3gnICsgaGVpZ2h0ICsgJykuJyApOwoKCQkJCXJldHVybiBjYW52YXM7CgoJCQl9IGVsc2UgewoKCQkJCWlmICggJ2RhdGEnIGluIGltYWdlICkgewoKCQkJCQljb25zb2xlLndhcm4oICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBJbWFnZSBpbiBEYXRhVGV4dHVyZSBpcyB0b28gYmlnICgnICsgaW1hZ2Uud2lkdGggKyAneCcgKyBpbWFnZS5oZWlnaHQgKyAnKS4nICk7CgoJCQkJfQoKCQkJCXJldHVybiBpbWFnZTsKCgkJCX0KCgkJfQoKCQlyZXR1cm4gaW1hZ2U7CgoJfQoKCWZ1bmN0aW9uIGlzUG93ZXJPZlR3byQxKCBpbWFnZSApIHsKCgkJcmV0dXJuIGlzUG93ZXJPZlR3byggaW1hZ2Uud2lkdGggKSAmJiBpc1Bvd2VyT2ZUd28oIGltYWdlLmhlaWdodCApOwoKCX0KCglmdW5jdGlvbiB0ZXh0dXJlTmVlZHNQb3dlck9mVHdvKCB0ZXh0dXJlICkgewoKCQlpZiAoIGlzV2ViR0wyICkgcmV0dXJuIGZhbHNlOwoKCQlyZXR1cm4gKCB0ZXh0dXJlLndyYXBTICE9PSBDbGFtcFRvRWRnZVdyYXBwaW5nIHx8IHRleHR1cmUud3JhcFQgIT09IENsYW1wVG9FZGdlV3JhcHBpbmcgKSB8fAoJCQkoIHRleHR1cmUubWluRmlsdGVyICE9PSBOZWFyZXN0RmlsdGVyICYmIHRleHR1cmUubWluRmlsdGVyICE9PSBMaW5lYXJGaWx0ZXIgKTsKCgl9CgoJZnVuY3Rpb24gdGV4dHVyZU5lZWRzR2VuZXJhdGVNaXBtYXBzKCB0ZXh0dXJlLCBzdXBwb3J0c01pcHMgKSB7CgoJCXJldHVybiB0ZXh0dXJlLmdlbmVyYXRlTWlwbWFwcyAmJiBzdXBwb3J0c01pcHMgJiYKCQkJdGV4dHVyZS5taW5GaWx0ZXIgIT09IE5lYXJlc3RGaWx0ZXIgJiYgdGV4dHVyZS5taW5GaWx0ZXIgIT09IExpbmVhckZpbHRlcjsKCgl9CgoJZnVuY3Rpb24gZ2VuZXJhdGVNaXBtYXAoIHRhcmdldCApIHsKCgkJX2dsLmdlbmVyYXRlTWlwbWFwKCB0YXJnZXQgKTsKCgl9CgoJZnVuY3Rpb24gZ2V0SW50ZXJuYWxGb3JtYXQoIGludGVybmFsRm9ybWF0TmFtZSwgZ2xGb3JtYXQsIGdsVHlwZSwgY29sb3JTcGFjZSwgZm9yY2VMaW5lYXJUcmFuc2ZlciA9IGZhbHNlICkgewoKCQlpZiAoIGlzV2ViR0wyID09PSBmYWxzZSApIHJldHVybiBnbEZvcm1hdDsKCgkJaWYgKCBpbnRlcm5hbEZvcm1hdE5hbWUgIT09IG51bGwgKSB7CgoJCQlpZiAoIF9nbFsgaW50ZXJuYWxGb3JtYXROYW1lIF0gIT09IHVuZGVmaW5lZCApIHJldHVybiBfZ2xbIGludGVybmFsRm9ybWF0TmFtZSBdOwoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogQXR0ZW1wdCB0byB1c2Ugbm9uLWV4aXN0aW5nIFdlYkdMIGludGVybmFsIGZvcm1hdCBcJycgKyBpbnRlcm5hbEZvcm1hdE5hbWUgKyAnXCcnICk7CgoJCX0KCgkJbGV0IGludGVybmFsRm9ybWF0ID0gZ2xGb3JtYXQ7CgoJCWlmICggZ2xGb3JtYXQgPT09IF9nbC5SRUQgKSB7CgoJCQlpZiAoIGdsVHlwZSA9PT0gX2dsLkZMT0FUICkgaW50ZXJuYWxGb3JtYXQgPSBfZ2wuUjMyRjsKCQkJaWYgKCBnbFR5cGUgPT09IF9nbC5IQUxGX0ZMT0FUICkgaW50ZXJuYWxGb3JtYXQgPSBfZ2wuUjE2RjsKCQkJaWYgKCBnbFR5cGUgPT09IF9nbC5VTlNJR05FRF9CWVRFICkgaW50ZXJuYWxGb3JtYXQgPSBfZ2wuUjg7CgoJCX0KCgkJaWYgKCBnbEZvcm1hdCA9PT0gX2dsLlJFRF9JTlRFR0VSICkgewoKCQkJaWYgKCBnbFR5cGUgPT09IF9nbC5VTlNJR05FRF9CWVRFICkgaW50ZXJuYWxGb3JtYXQgPSBfZ2wuUjhVSTsKCQkJaWYgKCBnbFR5cGUgPT09IF9nbC5VTlNJR05FRF9TSE9SVCApIGludGVybmFsRm9ybWF0ID0gX2dsLlIxNlVJOwoJCQlpZiAoIGdsVHlwZSA9PT0gX2dsLlVOU0lHTkVEX0lOVCApIGludGVybmFsRm9ybWF0ID0gX2dsLlIzMlVJOwoJCQlpZiAoIGdsVHlwZSA9PT0gX2dsLkJZVEUgKSBpbnRlcm5hbEZvcm1hdCA9IF9nbC5SOEk7CgkJCWlmICggZ2xUeXBlID09PSBfZ2wuU0hPUlQgKSBpbnRlcm5hbEZvcm1hdCA9IF9nbC5SMTZJOwoJCQlpZiAoIGdsVHlwZSA9PT0gX2dsLklOVCApIGludGVybmFsRm9ybWF0ID0gX2dsLlIzMkk7CgoJCX0KCgkJaWYgKCBnbEZvcm1hdCA9PT0gX2dsLlJHICkgewoKCQkJaWYgKCBnbFR5cGUgPT09IF9nbC5GTE9BVCApIGludGVybmFsRm9ybWF0ID0gX2dsLlJHMzJGOwoJCQlpZiAoIGdsVHlwZSA9PT0gX2dsLkhBTEZfRkxPQVQgKSBpbnRlcm5hbEZvcm1hdCA9IF9nbC5SRzE2RjsKCQkJaWYgKCBnbFR5cGUgPT09IF9nbC5VTlNJR05FRF9CWVRFICkgaW50ZXJuYWxGb3JtYXQgPSBfZ2wuUkc4OwoKCQl9CgoJCWlmICggZ2xGb3JtYXQgPT09IF9nbC5SR0JBICkgewoKCQkJY29uc3QgdHJhbnNmZXIgPSBmb3JjZUxpbmVhclRyYW5zZmVyID8gTGluZWFyVHJhbnNmZXIgOiBDb2xvck1hbmFnZW1lbnQuZ2V0VHJhbnNmZXIoIGNvbG9yU3BhY2UgKTsKCgkJCWlmICggZ2xUeXBlID09PSBfZ2wuRkxPQVQgKSBpbnRlcm5hbEZvcm1hdCA9IF9nbC5SR0JBMzJGOwoJCQlpZiAoIGdsVHlwZSA9PT0gX2dsLkhBTEZfRkxPQVQgKSBpbnRlcm5hbEZvcm1hdCA9IF9nbC5SR0JBMTZGOwoJCQlpZiAoIGdsVHlwZSA9PT0gX2dsLlVOU0lHTkVEX0JZVEUgKSBpbnRlcm5hbEZvcm1hdCA9ICggdHJhbnNmZXIgPT09IFNSR0JUcmFuc2ZlciApID8gX2dsLlNSR0I4X0FMUEhBOCA6IF9nbC5SR0JBODsKCQkJaWYgKCBnbFR5cGUgPT09IF9nbC5VTlNJR05FRF9TSE9SVF80XzRfNF80ICkgaW50ZXJuYWxGb3JtYXQgPSBfZ2wuUkdCQTQ7CgkJCWlmICggZ2xUeXBlID09PSBfZ2wuVU5TSUdORURfU0hPUlRfNV81XzVfMSApIGludGVybmFsRm9ybWF0ID0gX2dsLlJHQjVfQTE7CgoJCX0KCgkJaWYgKCBpbnRlcm5hbEZvcm1hdCA9PT0gX2dsLlIxNkYgfHwgaW50ZXJuYWxGb3JtYXQgPT09IF9nbC5SMzJGIHx8CgkJCWludGVybmFsRm9ybWF0ID09PSBfZ2wuUkcxNkYgfHwgaW50ZXJuYWxGb3JtYXQgPT09IF9nbC5SRzMyRiB8fAoJCQlpbnRlcm5hbEZvcm1hdCA9PT0gX2dsLlJHQkExNkYgfHwgaW50ZXJuYWxGb3JtYXQgPT09IF9nbC5SR0JBMzJGICkgewoKCQkJZXh0ZW5zaW9ucy5nZXQoICdFWFRfY29sb3JfYnVmZmVyX2Zsb2F0JyApOwoKCQl9CgoJCXJldHVybiBpbnRlcm5hbEZvcm1hdDsKCgl9CgoJZnVuY3Rpb24gZ2V0TWlwTGV2ZWxzKCB0ZXh0dXJlLCBpbWFnZSwgc3VwcG9ydHNNaXBzICkgewoKCQlpZiAoIHRleHR1cmVOZWVkc0dlbmVyYXRlTWlwbWFwcyggdGV4dHVyZSwgc3VwcG9ydHNNaXBzICkgPT09IHRydWUgfHwgKCB0ZXh0dXJlLmlzRnJhbWVidWZmZXJUZXh0dXJlICYmIHRleHR1cmUubWluRmlsdGVyICE9PSBOZWFyZXN0RmlsdGVyICYmIHRleHR1cmUubWluRmlsdGVyICE9PSBMaW5lYXJGaWx0ZXIgKSApIHsKCgkJCXJldHVybiBNYXRoLmxvZzIoIE1hdGgubWF4KCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0ICkgKSArIDE7CgoJCX0gZWxzZSBpZiAoIHRleHR1cmUubWlwbWFwcyAhPT0gdW5kZWZpbmVkICYmIHRleHR1cmUubWlwbWFwcy5sZW5ndGggPiAwICkgewoKCQkJLy8gdXNlci1kZWZpbmVkIG1pcG1hcHMKCgkJCXJldHVybiB0ZXh0dXJlLm1pcG1hcHMubGVuZ3RoOwoKCQl9IGVsc2UgaWYgKCB0ZXh0dXJlLmlzQ29tcHJlc3NlZFRleHR1cmUgJiYgQXJyYXkuaXNBcnJheSggdGV4dHVyZS5pbWFnZSApICkgewoKCQkJcmV0dXJuIGltYWdlLm1pcG1hcHMubGVuZ3RoOwoKCQl9IGVsc2UgewoKCQkJLy8gdGV4dHVyZSB3aXRob3V0IG1pcG1hcHMgKG9ubHkgYmFzZSBsZXZlbCkKCgkJCXJldHVybiAxOwoKCQl9CgoJfQoKCS8vIEZhbGxiYWNrIGZpbHRlcnMgZm9yIG5vbi1wb3dlci1vZi0yIHRleHR1cmVzCgoJZnVuY3Rpb24gZmlsdGVyRmFsbGJhY2soIGYgKSB7CgoJCWlmICggZiA9PT0gTmVhcmVzdEZpbHRlciB8fCBmID09PSBOZWFyZXN0TWlwbWFwTmVhcmVzdEZpbHRlciB8fCBmID09PSBOZWFyZXN0TWlwbWFwTGluZWFyRmlsdGVyICkgewoKCQkJcmV0dXJuIF9nbC5ORUFSRVNUOwoKCQl9CgoJCXJldHVybiBfZ2wuTElORUFSOwoKCX0KCgkvLwoKCWZ1bmN0aW9uIG9uVGV4dHVyZURpc3Bvc2UoIGV2ZW50ICkgewoKCQljb25zdCB0ZXh0dXJlID0gZXZlbnQudGFyZ2V0OwoKCQl0ZXh0dXJlLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdkaXNwb3NlJywgb25UZXh0dXJlRGlzcG9zZSApOwoKCQlkZWFsbG9jYXRlVGV4dHVyZSggdGV4dHVyZSApOwoKCQlpZiAoIHRleHR1cmUuaXNWaWRlb1RleHR1cmUgKSB7CgoJCQlfdmlkZW9UZXh0dXJlcy5kZWxldGUoIHRleHR1cmUgKTsKCgkJfQoKCX0KCglmdW5jdGlvbiBvblJlbmRlclRhcmdldERpc3Bvc2UoIGV2ZW50ICkgewoKCQljb25zdCByZW5kZXJUYXJnZXQgPSBldmVudC50YXJnZXQ7CgoJCXJlbmRlclRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKCAnZGlzcG9zZScsIG9uUmVuZGVyVGFyZ2V0RGlzcG9zZSApOwoKCQlkZWFsbG9jYXRlUmVuZGVyVGFyZ2V0KCByZW5kZXJUYXJnZXQgKTsKCgl9CgoJLy8KCglmdW5jdGlvbiBkZWFsbG9jYXRlVGV4dHVyZSggdGV4dHVyZSApIHsKCgkJY29uc3QgdGV4dHVyZVByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggdGV4dHVyZSApOwoKCQlpZiAoIHRleHR1cmVQcm9wZXJ0aWVzLl9fd2ViZ2xJbml0ID09PSB1bmRlZmluZWQgKSByZXR1cm47CgoJCS8vIGNoZWNrIGlmIGl0J3MgbmVjZXNzYXJ5IHRvIHJlbW92ZSB0aGUgV2ViR0xUZXh0dXJlIG9iamVjdAoKCQljb25zdCBzb3VyY2UgPSB0ZXh0dXJlLnNvdXJjZTsKCQljb25zdCB3ZWJnbFRleHR1cmVzID0gX3NvdXJjZXMuZ2V0KCBzb3VyY2UgKTsKCgkJaWYgKCB3ZWJnbFRleHR1cmVzICkgewoKCQkJY29uc3Qgd2ViZ2xUZXh0dXJlID0gd2ViZ2xUZXh0dXJlc1sgdGV4dHVyZVByb3BlcnRpZXMuX19jYWNoZUtleSBdOwoJCQl3ZWJnbFRleHR1cmUudXNlZFRpbWVzIC0tOwoKCQkJLy8gdGhlIFdlYkdMVGV4dHVyZSBvYmplY3QgaXMgbm90IHVzZWQgYW55bW9yZSwgcmVtb3ZlIGl0CgoJCQlpZiAoIHdlYmdsVGV4dHVyZS51c2VkVGltZXMgPT09IDAgKSB7CgoJCQkJZGVsZXRlVGV4dHVyZSggdGV4dHVyZSApOwoKCQkJfQoKCQkJLy8gcmVtb3ZlIHRoZSB3ZWFrIG1hcCBlbnRyeSBpZiBubyBXZWJHTFRleHR1cmUgdXNlcyB0aGUgc291cmNlIGFueW1vcmUKCgkJCWlmICggT2JqZWN0LmtleXMoIHdlYmdsVGV4dHVyZXMgKS5sZW5ndGggPT09IDAgKSB7CgoJCQkJX3NvdXJjZXMuZGVsZXRlKCBzb3VyY2UgKTsKCgkJCX0KCgkJfQoKCQlwcm9wZXJ0aWVzLnJlbW92ZSggdGV4dHVyZSApOwoKCX0KCglmdW5jdGlvbiBkZWxldGVUZXh0dXJlKCB0ZXh0dXJlICkgewoKCQljb25zdCB0ZXh0dXJlUHJvcGVydGllcyA9IHByb3BlcnRpZXMuZ2V0KCB0ZXh0dXJlICk7CgkJX2dsLmRlbGV0ZVRleHR1cmUoIHRleHR1cmVQcm9wZXJ0aWVzLl9fd2ViZ2xUZXh0dXJlICk7CgoJCWNvbnN0IHNvdXJjZSA9IHRleHR1cmUuc291cmNlOwoJCWNvbnN0IHdlYmdsVGV4dHVyZXMgPSBfc291cmNlcy5nZXQoIHNvdXJjZSApOwoJCWRlbGV0ZSB3ZWJnbFRleHR1cmVzWyB0ZXh0dXJlUHJvcGVydGllcy5fX2NhY2hlS2V5IF07CgoJCWluZm8ubWVtb3J5LnRleHR1cmVzIC0tOwoKCX0KCglmdW5jdGlvbiBkZWFsbG9jYXRlUmVuZGVyVGFyZ2V0KCByZW5kZXJUYXJnZXQgKSB7CgoJCWNvbnN0IHRleHR1cmUgPSByZW5kZXJUYXJnZXQudGV4dHVyZTsKCgkJY29uc3QgcmVuZGVyVGFyZ2V0UHJvcGVydGllcyA9IHByb3BlcnRpZXMuZ2V0KCByZW5kZXJUYXJnZXQgKTsKCQljb25zdCB0ZXh0dXJlUHJvcGVydGllcyA9IHByb3BlcnRpZXMuZ2V0KCB0ZXh0dXJlICk7CgoJCWlmICggdGV4dHVyZVByb3BlcnRpZXMuX193ZWJnbFRleHR1cmUgIT09IHVuZGVmaW5lZCApIHsKCgkJCV9nbC5kZWxldGVUZXh0dXJlKCB0ZXh0dXJlUHJvcGVydGllcy5fX3dlYmdsVGV4dHVyZSApOwoKCQkJaW5mby5tZW1vcnkudGV4dHVyZXMgLS07CgoJCX0KCgkJaWYgKCByZW5kZXJUYXJnZXQuZGVwdGhUZXh0dXJlICkgewoKCQkJcmVuZGVyVGFyZ2V0LmRlcHRoVGV4dHVyZS5kaXNwb3NlKCk7CgoJCX0KCgkJaWYgKCByZW5kZXJUYXJnZXQuaXNXZWJHTEN1YmVSZW5kZXJUYXJnZXQgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA2OyBpICsrICkgewoKCQkJCWlmICggQXJyYXkuaXNBcnJheSggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRnJhbWVidWZmZXJbIGkgXSApICkgewoKCQkJCQlmb3IgKCBsZXQgbGV2ZWwgPSAwOyBsZXZlbCA8IHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbEZyYW1lYnVmZmVyWyBpIF0ubGVuZ3RoOyBsZXZlbCArKyApIF9nbC5kZWxldGVGcmFtZWJ1ZmZlciggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRnJhbWVidWZmZXJbIGkgXVsgbGV2ZWwgXSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCV9nbC5kZWxldGVGcmFtZWJ1ZmZlciggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRnJhbWVidWZmZXJbIGkgXSApOwoKCQkJCX0KCgkJCQlpZiAoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbERlcHRoYnVmZmVyICkgX2dsLmRlbGV0ZVJlbmRlcmJ1ZmZlciggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRGVwdGhidWZmZXJbIGkgXSApOwoKCQkJfQoKCQl9IGVsc2UgewoKCQkJaWYgKCBBcnJheS5pc0FycmF5KCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlciApICkgewoKCQkJCWZvciAoIGxldCBsZXZlbCA9IDA7IGxldmVsIDwgcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRnJhbWVidWZmZXIubGVuZ3RoOyBsZXZlbCArKyApIF9nbC5kZWxldGVGcmFtZWJ1ZmZlciggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRnJhbWVidWZmZXJbIGxldmVsIF0gKTsKCgkJCX0gZWxzZSB7CgoJCQkJX2dsLmRlbGV0ZUZyYW1lYnVmZmVyKCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlciApOwoKCQkJfQoKCQkJaWYgKCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xEZXB0aGJ1ZmZlciApIF9nbC5kZWxldGVSZW5kZXJidWZmZXIoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbERlcHRoYnVmZmVyICk7CgkJCWlmICggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsTXVsdGlzYW1wbGVkRnJhbWVidWZmZXIgKSBfZ2wuZGVsZXRlRnJhbWVidWZmZXIoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyICk7CgoJCQlpZiAoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbENvbG9yUmVuZGVyYnVmZmVyICkgewoKCQkJCWZvciAoIGxldCBpID0gMDsgaSA8IHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbENvbG9yUmVuZGVyYnVmZmVyLmxlbmd0aDsgaSArKyApIHsKCgkJCQkJaWYgKCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xDb2xvclJlbmRlcmJ1ZmZlclsgaSBdICkgX2dsLmRlbGV0ZVJlbmRlcmJ1ZmZlciggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsQ29sb3JSZW5kZXJidWZmZXJbIGkgXSApOwoKCQkJCX0KCgkJCX0KCgkJCWlmICggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRGVwdGhSZW5kZXJidWZmZXIgKSBfZ2wuZGVsZXRlUmVuZGVyYnVmZmVyKCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xEZXB0aFJlbmRlcmJ1ZmZlciApOwoKCQl9CgoJCWlmICggcmVuZGVyVGFyZ2V0LmlzV2ViR0xNdWx0aXBsZVJlbmRlclRhcmdldHMgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gdGV4dHVyZS5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCQljb25zdCBhdHRhY2htZW50UHJvcGVydGllcyA9IHByb3BlcnRpZXMuZ2V0KCB0ZXh0dXJlWyBpIF0gKTsKCgkJCQlpZiAoIGF0dGFjaG1lbnRQcm9wZXJ0aWVzLl9fd2ViZ2xUZXh0dXJlICkgewoKCQkJCQlfZ2wuZGVsZXRlVGV4dHVyZSggYXR0YWNobWVudFByb3BlcnRpZXMuX193ZWJnbFRleHR1cmUgKTsKCgkJCQkJaW5mby5tZW1vcnkudGV4dHVyZXMgLS07CgoJCQkJfQoKCQkJCXByb3BlcnRpZXMucmVtb3ZlKCB0ZXh0dXJlWyBpIF0gKTsKCgkJCX0KCgkJfQoKCQlwcm9wZXJ0aWVzLnJlbW92ZSggdGV4dHVyZSApOwoJCXByb3BlcnRpZXMucmVtb3ZlKCByZW5kZXJUYXJnZXQgKTsKCgl9CgoJLy8KCglsZXQgdGV4dHVyZVVuaXRzID0gMDsKCglmdW5jdGlvbiByZXNldFRleHR1cmVVbml0cygpIHsKCgkJdGV4dHVyZVVuaXRzID0gMDsKCgl9CgoJZnVuY3Rpb24gYWxsb2NhdGVUZXh0dXJlVW5pdCgpIHsKCgkJY29uc3QgdGV4dHVyZVVuaXQgPSB0ZXh0dXJlVW5pdHM7CgoJCWlmICggdGV4dHVyZVVuaXQgPj0gY2FwYWJpbGl0aWVzLm1heFRleHR1cmVzICkgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xUZXh0dXJlczogVHJ5aW5nIHRvIHVzZSAnICsgdGV4dHVyZVVuaXQgKyAnIHRleHR1cmUgdW5pdHMgd2hpbGUgdGhpcyBHUFUgc3VwcG9ydHMgb25seSAnICsgY2FwYWJpbGl0aWVzLm1heFRleHR1cmVzICk7CgoJCX0KCgkJdGV4dHVyZVVuaXRzICs9IDE7CgoJCXJldHVybiB0ZXh0dXJlVW5pdDsKCgl9CgoJZnVuY3Rpb24gZ2V0VGV4dHVyZUNhY2hlS2V5KCB0ZXh0dXJlICkgewoKCQljb25zdCBhcnJheSA9IFtdOwoKCQlhcnJheS5wdXNoKCB0ZXh0dXJlLndyYXBTICk7CgkJYXJyYXkucHVzaCggdGV4dHVyZS53cmFwVCApOwoJCWFycmF5LnB1c2goIHRleHR1cmUud3JhcFIgfHwgMCApOwoJCWFycmF5LnB1c2goIHRleHR1cmUubWFnRmlsdGVyICk7CgkJYXJyYXkucHVzaCggdGV4dHVyZS5taW5GaWx0ZXIgKTsKCQlhcnJheS5wdXNoKCB0ZXh0dXJlLmFuaXNvdHJvcHkgKTsKCQlhcnJheS5wdXNoKCB0ZXh0dXJlLmludGVybmFsRm9ybWF0ICk7CgkJYXJyYXkucHVzaCggdGV4dHVyZS5mb3JtYXQgKTsKCQlhcnJheS5wdXNoKCB0ZXh0dXJlLnR5cGUgKTsKCQlhcnJheS5wdXNoKCB0ZXh0dXJlLmdlbmVyYXRlTWlwbWFwcyApOwoJCWFycmF5LnB1c2goIHRleHR1cmUucHJlbXVsdGlwbHlBbHBoYSApOwoJCWFycmF5LnB1c2goIHRleHR1cmUuZmxpcFkgKTsKCQlhcnJheS5wdXNoKCB0ZXh0dXJlLnVucGFja0FsaWdubWVudCApOwoJCWFycmF5LnB1c2goIHRleHR1cmUuY29sb3JTcGFjZSApOwoKCQlyZXR1cm4gYXJyYXkuam9pbigpOwoKCX0KCgkvLwoKCWZ1bmN0aW9uIHNldFRleHR1cmUyRCggdGV4dHVyZSwgc2xvdCApIHsKCgkJY29uc3QgdGV4dHVyZVByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggdGV4dHVyZSApOwoKCQlpZiAoIHRleHR1cmUuaXNWaWRlb1RleHR1cmUgKSB1cGRhdGVWaWRlb1RleHR1cmUoIHRleHR1cmUgKTsKCgkJaWYgKCB0ZXh0dXJlLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9PT0gZmFsc2UgJiYgdGV4dHVyZS52ZXJzaW9uID4gMCAmJiB0ZXh0dXJlUHJvcGVydGllcy5fX3ZlcnNpb24gIT09IHRleHR1cmUudmVyc2lvbiApIHsKCgkJCWNvbnN0IGltYWdlID0gdGV4dHVyZS5pbWFnZTsKCgkJCWlmICggaW1hZ2UgPT09IG51bGwgKSB7CgoJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogVGV4dHVyZSBtYXJrZWQgZm9yIHVwZGF0ZSBidXQgbm8gaW1hZ2UgZGF0YSBmb3VuZC4nICk7CgoJCQl9IGVsc2UgaWYgKCBpbWFnZS5jb21wbGV0ZSA9PT0gZmFsc2UgKSB7CgoJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogVGV4dHVyZSBtYXJrZWQgZm9yIHVwZGF0ZSBidXQgaW1hZ2UgaXMgaW5jb21wbGV0ZScgKTsKCgkJCX0gZWxzZSB7CgoJCQkJdXBsb2FkVGV4dHVyZSggdGV4dHVyZVByb3BlcnRpZXMsIHRleHR1cmUsIHNsb3QgKTsKCQkJCXJldHVybjsKCgkJCX0KCgkJfQoKCQlzdGF0ZS5iaW5kVGV4dHVyZSggX2dsLlRFWFRVUkVfMkQsIHRleHR1cmVQcm9wZXJ0aWVzLl9fd2ViZ2xUZXh0dXJlLCBfZ2wuVEVYVFVSRTAgKyBzbG90ICk7CgoJfQoKCWZ1bmN0aW9uIHNldFRleHR1cmUyREFycmF5KCB0ZXh0dXJlLCBzbG90ICkgewoKCQljb25zdCB0ZXh0dXJlUHJvcGVydGllcyA9IHByb3BlcnRpZXMuZ2V0KCB0ZXh0dXJlICk7CgoJCWlmICggdGV4dHVyZS52ZXJzaW9uID4gMCAmJiB0ZXh0dXJlUHJvcGVydGllcy5fX3ZlcnNpb24gIT09IHRleHR1cmUudmVyc2lvbiApIHsKCgkJCXVwbG9hZFRleHR1cmUoIHRleHR1cmVQcm9wZXJ0aWVzLCB0ZXh0dXJlLCBzbG90ICk7CgkJCXJldHVybjsKCgkJfQoKCQlzdGF0ZS5iaW5kVGV4dHVyZSggX2dsLlRFWFRVUkVfMkRfQVJSQVksIHRleHR1cmVQcm9wZXJ0aWVzLl9fd2ViZ2xUZXh0dXJlLCBfZ2wuVEVYVFVSRTAgKyBzbG90ICk7CgoJfQoKCWZ1bmN0aW9uIHNldFRleHR1cmUzRCggdGV4dHVyZSwgc2xvdCApIHsKCgkJY29uc3QgdGV4dHVyZVByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggdGV4dHVyZSApOwoKCQlpZiAoIHRleHR1cmUudmVyc2lvbiA+IDAgJiYgdGV4dHVyZVByb3BlcnRpZXMuX192ZXJzaW9uICE9PSB0ZXh0dXJlLnZlcnNpb24gKSB7CgoJCQl1cGxvYWRUZXh0dXJlKCB0ZXh0dXJlUHJvcGVydGllcywgdGV4dHVyZSwgc2xvdCApOwoJCQlyZXR1cm47CgoJCX0KCgkJc3RhdGUuYmluZFRleHR1cmUoIF9nbC5URVhUVVJFXzNELCB0ZXh0dXJlUHJvcGVydGllcy5fX3dlYmdsVGV4dHVyZSwgX2dsLlRFWFRVUkUwICsgc2xvdCApOwoKCX0KCglmdW5jdGlvbiBzZXRUZXh0dXJlQ3ViZSggdGV4dHVyZSwgc2xvdCApIHsKCgkJY29uc3QgdGV4dHVyZVByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggdGV4dHVyZSApOwoKCQlpZiAoIHRleHR1cmUudmVyc2lvbiA+IDAgJiYgdGV4dHVyZVByb3BlcnRpZXMuX192ZXJzaW9uICE9PSB0ZXh0dXJlLnZlcnNpb24gKSB7CgoJCQl1cGxvYWRDdWJlVGV4dHVyZSggdGV4dHVyZVByb3BlcnRpZXMsIHRleHR1cmUsIHNsb3QgKTsKCQkJcmV0dXJuOwoKCQl9CgoJCXN0YXRlLmJpbmRUZXh0dXJlKCBfZ2wuVEVYVFVSRV9DVUJFX01BUCwgdGV4dHVyZVByb3BlcnRpZXMuX193ZWJnbFRleHR1cmUsIF9nbC5URVhUVVJFMCArIHNsb3QgKTsKCgl9CgoJY29uc3Qgd3JhcHBpbmdUb0dMID0gewoJCVsgUmVwZWF0V3JhcHBpbmcgXTogX2dsLlJFUEVBVCwKCQlbIENsYW1wVG9FZGdlV3JhcHBpbmcgXTogX2dsLkNMQU1QX1RPX0VER0UsCgkJWyBNaXJyb3JlZFJlcGVhdFdyYXBwaW5nIF06IF9nbC5NSVJST1JFRF9SRVBFQVQKCX07CgoJY29uc3QgZmlsdGVyVG9HTCA9IHsKCQlbIE5lYXJlc3RGaWx0ZXIgXTogX2dsLk5FQVJFU1QsCgkJWyBOZWFyZXN0TWlwbWFwTmVhcmVzdEZpbHRlciBdOiBfZ2wuTkVBUkVTVF9NSVBNQVBfTkVBUkVTVCwKCQlbIE5lYXJlc3RNaXBtYXBMaW5lYXJGaWx0ZXIgXTogX2dsLk5FQVJFU1RfTUlQTUFQX0xJTkVBUiwKCgkJWyBMaW5lYXJGaWx0ZXIgXTogX2dsLkxJTkVBUiwKCQlbIExpbmVhck1pcG1hcE5lYXJlc3RGaWx0ZXIgXTogX2dsLkxJTkVBUl9NSVBNQVBfTkVBUkVTVCwKCQlbIExpbmVhck1pcG1hcExpbmVhckZpbHRlciBdOiBfZ2wuTElORUFSX01JUE1BUF9MSU5FQVIKCX07CgoJY29uc3QgY29tcGFyZVRvR0wgPSB7CgkJWyBOZXZlckNvbXBhcmUgXTogX2dsLk5FVkVSLAoJCVsgQWx3YXlzQ29tcGFyZSBdOiBfZ2wuQUxXQVlTLAoJCVsgTGVzc0NvbXBhcmUgXTogX2dsLkxFU1MsCgkJWyBMZXNzRXF1YWxDb21wYXJlIF06IF9nbC5MRVFVQUwsCgkJWyBFcXVhbENvbXBhcmUgXTogX2dsLkVRVUFMLAoJCVsgR3JlYXRlckVxdWFsQ29tcGFyZSBdOiBfZ2wuR0VRVUFMLAoJCVsgR3JlYXRlckNvbXBhcmUgXTogX2dsLkdSRUFURVIsCgkJWyBOb3RFcXVhbENvbXBhcmUgXTogX2dsLk5PVEVRVUFMCgl9OwoKCWZ1bmN0aW9uIHNldFRleHR1cmVQYXJhbWV0ZXJzKCB0ZXh0dXJlVHlwZSwgdGV4dHVyZSwgc3VwcG9ydHNNaXBzICkgewoKCQlpZiAoIHRleHR1cmUudHlwZSA9PT0gRmxvYXRUeXBlICYmIGV4dGVuc2lvbnMuaGFzKCAnT0VTX3RleHR1cmVfZmxvYXRfbGluZWFyJyApID09PSBmYWxzZSAmJgoJCQkoIHRleHR1cmUubWFnRmlsdGVyID09PSBMaW5lYXJGaWx0ZXIgfHwgdGV4dHVyZS5tYWdGaWx0ZXIgPT09IExpbmVhck1pcG1hcE5lYXJlc3RGaWx0ZXIgfHwgdGV4dHVyZS5tYWdGaWx0ZXIgPT09IE5lYXJlc3RNaXBtYXBMaW5lYXJGaWx0ZXIgfHwgdGV4dHVyZS5tYWdGaWx0ZXIgPT09IExpbmVhck1pcG1hcExpbmVhckZpbHRlciB8fAoJCQl0ZXh0dXJlLm1pbkZpbHRlciA9PT0gTGluZWFyRmlsdGVyIHx8IHRleHR1cmUubWluRmlsdGVyID09PSBMaW5lYXJNaXBtYXBOZWFyZXN0RmlsdGVyIHx8IHRleHR1cmUubWluRmlsdGVyID09PSBOZWFyZXN0TWlwbWFwTGluZWFyRmlsdGVyIHx8IHRleHR1cmUubWluRmlsdGVyID09PSBMaW5lYXJNaXBtYXBMaW5lYXJGaWx0ZXIgKSApIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IFVuYWJsZSB0byB1c2UgbGluZWFyIGZpbHRlcmluZyB3aXRoIGZsb2F0aW5nIHBvaW50IHRleHR1cmVzLiBPRVNfdGV4dHVyZV9mbG9hdF9saW5lYXIgbm90IHN1cHBvcnRlZCBvbiB0aGlzIGRldmljZS4nICk7CgoJCX0KCgkJaWYgKCBzdXBwb3J0c01pcHMgKSB7CgoJCQlfZ2wudGV4UGFyYW1ldGVyaSggdGV4dHVyZVR5cGUsIF9nbC5URVhUVVJFX1dSQVBfUywgd3JhcHBpbmdUb0dMWyB0ZXh0dXJlLndyYXBTIF0gKTsKCQkJX2dsLnRleFBhcmFtZXRlcmkoIHRleHR1cmVUeXBlLCBfZ2wuVEVYVFVSRV9XUkFQX1QsIHdyYXBwaW5nVG9HTFsgdGV4dHVyZS53cmFwVCBdICk7CgoJCQlpZiAoIHRleHR1cmVUeXBlID09PSBfZ2wuVEVYVFVSRV8zRCB8fCB0ZXh0dXJlVHlwZSA9PT0gX2dsLlRFWFRVUkVfMkRfQVJSQVkgKSB7CgoJCQkJX2dsLnRleFBhcmFtZXRlcmkoIHRleHR1cmVUeXBlLCBfZ2wuVEVYVFVSRV9XUkFQX1IsIHdyYXBwaW5nVG9HTFsgdGV4dHVyZS53cmFwUiBdICk7CgoJCQl9CgoJCQlfZ2wudGV4UGFyYW1ldGVyaSggdGV4dHVyZVR5cGUsIF9nbC5URVhUVVJFX01BR19GSUxURVIsIGZpbHRlclRvR0xbIHRleHR1cmUubWFnRmlsdGVyIF0gKTsKCQkJX2dsLnRleFBhcmFtZXRlcmkoIHRleHR1cmVUeXBlLCBfZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBmaWx0ZXJUb0dMWyB0ZXh0dXJlLm1pbkZpbHRlciBdICk7CgoJCX0gZWxzZSB7CgoJCQlfZ2wudGV4UGFyYW1ldGVyaSggdGV4dHVyZVR5cGUsIF9nbC5URVhUVVJFX1dSQVBfUywgX2dsLkNMQU1QX1RPX0VER0UgKTsKCQkJX2dsLnRleFBhcmFtZXRlcmkoIHRleHR1cmVUeXBlLCBfZ2wuVEVYVFVSRV9XUkFQX1QsIF9nbC5DTEFNUF9UT19FREdFICk7CgoJCQlpZiAoIHRleHR1cmVUeXBlID09PSBfZ2wuVEVYVFVSRV8zRCB8fCB0ZXh0dXJlVHlwZSA9PT0gX2dsLlRFWFRVUkVfMkRfQVJSQVkgKSB7CgoJCQkJX2dsLnRleFBhcmFtZXRlcmkoIHRleHR1cmVUeXBlLCBfZ2wuVEVYVFVSRV9XUkFQX1IsIF9nbC5DTEFNUF9UT19FREdFICk7CgoJCQl9CgoJCQlpZiAoIHRleHR1cmUud3JhcFMgIT09IENsYW1wVG9FZGdlV3JhcHBpbmcgfHwgdGV4dHVyZS53cmFwVCAhPT0gQ2xhbXBUb0VkZ2VXcmFwcGluZyApIHsKCgkJCQljb25zb2xlLndhcm4oICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBUZXh0dXJlIGlzIG5vdCBwb3dlciBvZiB0d28uIFRleHR1cmUud3JhcFMgYW5kIFRleHR1cmUud3JhcFQgc2hvdWxkIGJlIHNldCB0byBUSFJFRS5DbGFtcFRvRWRnZVdyYXBwaW5nLicgKTsKCgkJCX0KCgkJCV9nbC50ZXhQYXJhbWV0ZXJpKCB0ZXh0dXJlVHlwZSwgX2dsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZmlsdGVyRmFsbGJhY2soIHRleHR1cmUubWFnRmlsdGVyICkgKTsKCQkJX2dsLnRleFBhcmFtZXRlcmkoIHRleHR1cmVUeXBlLCBfZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBmaWx0ZXJGYWxsYmFjayggdGV4dHVyZS5taW5GaWx0ZXIgKSApOwoKCQkJaWYgKCB0ZXh0dXJlLm1pbkZpbHRlciAhPT0gTmVhcmVzdEZpbHRlciAmJiB0ZXh0dXJlLm1pbkZpbHRlciAhPT0gTGluZWFyRmlsdGVyICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IFRleHR1cmUgaXMgbm90IHBvd2VyIG9mIHR3by4gVGV4dHVyZS5taW5GaWx0ZXIgc2hvdWxkIGJlIHNldCB0byBUSFJFRS5OZWFyZXN0RmlsdGVyIG9yIFRIUkVFLkxpbmVhckZpbHRlci4nICk7CgoJCQl9CgoJCX0KCgkJaWYgKCB0ZXh0dXJlLmNvbXBhcmVGdW5jdGlvbiApIHsKCgkJCV9nbC50ZXhQYXJhbWV0ZXJpKCB0ZXh0dXJlVHlwZSwgX2dsLlRFWFRVUkVfQ09NUEFSRV9NT0RFLCBfZ2wuQ09NUEFSRV9SRUZfVE9fVEVYVFVSRSApOwoJCQlfZ2wudGV4UGFyYW1ldGVyaSggdGV4dHVyZVR5cGUsIF9nbC5URVhUVVJFX0NPTVBBUkVfRlVOQywgY29tcGFyZVRvR0xbIHRleHR1cmUuY29tcGFyZUZ1bmN0aW9uIF0gKTsKCgkJfQoKCQlpZiAoIGV4dGVuc2lvbnMuaGFzKCAnRVhUX3RleHR1cmVfZmlsdGVyX2FuaXNvdHJvcGljJyApID09PSB0cnVlICkgewoKCQkJY29uc3QgZXh0ZW5zaW9uID0gZXh0ZW5zaW9ucy5nZXQoICdFWFRfdGV4dHVyZV9maWx0ZXJfYW5pc290cm9waWMnICk7CgoJCQlpZiAoIHRleHR1cmUubWFnRmlsdGVyID09PSBOZWFyZXN0RmlsdGVyICkgcmV0dXJuOwoJCQlpZiAoIHRleHR1cmUubWluRmlsdGVyICE9PSBOZWFyZXN0TWlwbWFwTGluZWFyRmlsdGVyICYmIHRleHR1cmUubWluRmlsdGVyICE9PSBMaW5lYXJNaXBtYXBMaW5lYXJGaWx0ZXIgKSByZXR1cm47CgkJCWlmICggdGV4dHVyZS50eXBlID09PSBGbG9hdFR5cGUgJiYgZXh0ZW5zaW9ucy5oYXMoICdPRVNfdGV4dHVyZV9mbG9hdF9saW5lYXInICkgPT09IGZhbHNlICkgcmV0dXJuOyAvLyB2ZXJpZnkgZXh0ZW5zaW9uIGZvciBXZWJHTCAxIGFuZCBXZWJHTCAyCgkJCWlmICggaXNXZWJHTDIgPT09IGZhbHNlICYmICggdGV4dHVyZS50eXBlID09PSBIYWxmRmxvYXRUeXBlICYmIGV4dGVuc2lvbnMuaGFzKCAnT0VTX3RleHR1cmVfaGFsZl9mbG9hdF9saW5lYXInICkgPT09IGZhbHNlICkgKSByZXR1cm47IC8vIHZlcmlmeSBleHRlbnNpb24gZm9yIFdlYkdMIDEgb25seQoKCQkJaWYgKCB0ZXh0dXJlLmFuaXNvdHJvcHkgPiAxIHx8IHByb3BlcnRpZXMuZ2V0KCB0ZXh0dXJlICkuX19jdXJyZW50QW5pc290cm9weSApIHsKCgkJCQlfZ2wudGV4UGFyYW1ldGVyZiggdGV4dHVyZVR5cGUsIGV4dGVuc2lvbi5URVhUVVJFX01BWF9BTklTT1RST1BZX0VYVCwgTWF0aC5taW4oIHRleHR1cmUuYW5pc290cm9weSwgY2FwYWJpbGl0aWVzLmdldE1heEFuaXNvdHJvcHkoKSApICk7CgkJCQlwcm9wZXJ0aWVzLmdldCggdGV4dHVyZSApLl9fY3VycmVudEFuaXNvdHJvcHkgPSB0ZXh0dXJlLmFuaXNvdHJvcHk7CgoJCQl9CgoJCX0KCgl9CgoJZnVuY3Rpb24gaW5pdFRleHR1cmUoIHRleHR1cmVQcm9wZXJ0aWVzLCB0ZXh0dXJlICkgewoKCQlsZXQgZm9yY2VVcGxvYWQgPSBmYWxzZTsKCgkJaWYgKCB0ZXh0dXJlUHJvcGVydGllcy5fX3dlYmdsSW5pdCA9PT0gdW5kZWZpbmVkICkgewoKCQkJdGV4dHVyZVByb3BlcnRpZXMuX193ZWJnbEluaXQgPSB0cnVlOwoKCQkJdGV4dHVyZS5hZGRFdmVudExpc3RlbmVyKCAnZGlzcG9zZScsIG9uVGV4dHVyZURpc3Bvc2UgKTsKCgkJfQoKCQkvLyBjcmVhdGUgU291cmNlIDwtPiBXZWJHTFRleHR1cmVzIG1hcHBpbmcgaWYgbmVjZXNzYXJ5CgoJCWNvbnN0IHNvdXJjZSA9IHRleHR1cmUuc291cmNlOwoJCWxldCB3ZWJnbFRleHR1cmVzID0gX3NvdXJjZXMuZ2V0KCBzb3VyY2UgKTsKCgkJaWYgKCB3ZWJnbFRleHR1cmVzID09PSB1bmRlZmluZWQgKSB7CgoJCQl3ZWJnbFRleHR1cmVzID0ge307CgkJCV9zb3VyY2VzLnNldCggc291cmNlLCB3ZWJnbFRleHR1cmVzICk7CgoJCX0KCgkJLy8gY2hlY2sgaWYgdGhlcmUgaXMgYWxyZWFkeSBhIFdlYkdMVGV4dHVyZSBvYmplY3QgZm9yIHRoZSBnaXZlbiB0ZXh0dXJlIHBhcmFtZXRlcnMKCgkJY29uc3QgdGV4dHVyZUNhY2hlS2V5ID0gZ2V0VGV4dHVyZUNhY2hlS2V5KCB0ZXh0dXJlICk7CgoJCWlmICggdGV4dHVyZUNhY2hlS2V5ICE9PSB0ZXh0dXJlUHJvcGVydGllcy5fX2NhY2hlS2V5ICkgewoKCQkJLy8gaWYgbm90LCBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgV2ViR0xUZXh0dXJlCgoJCQlpZiAoIHdlYmdsVGV4dHVyZXNbIHRleHR1cmVDYWNoZUtleSBdID09PSB1bmRlZmluZWQgKSB7CgoJCQkJLy8gY3JlYXRlIG5ldyBlbnRyeQoKCQkJCXdlYmdsVGV4dHVyZXNbIHRleHR1cmVDYWNoZUtleSBdID0gewoJCQkJCXRleHR1cmU6IF9nbC5jcmVhdGVUZXh0dXJlKCksCgkJCQkJdXNlZFRpbWVzOiAwCgkJCQl9OwoKCQkJCWluZm8ubWVtb3J5LnRleHR1cmVzICsrOwoKCQkJCS8vIHdoZW4gYSBuZXcgaW5zdGFuY2Ugb2YgV2ViR0xUZXh0dXJlIHdhcyBjcmVhdGVkLCBhIHRleHR1cmUgdXBsb2FkIGlzIHJlcXVpcmVkCgkJCQkvLyBldmVuIGlmIHRoZSBpbWFnZSBjb250ZW50cyBhcmUgaWRlbnRpY2FsCgoJCQkJZm9yY2VVcGxvYWQgPSB0cnVlOwoKCQkJfQoKCQkJd2ViZ2xUZXh0dXJlc1sgdGV4dHVyZUNhY2hlS2V5IF0udXNlZFRpbWVzICsrOwoKCQkJLy8gZXZlcnkgdGltZSB0aGUgdGV4dHVyZSBjYWNoZSBrZXkgY2hhbmdlcywgaXQncyBuZWNlc3NhcnkgdG8gY2hlY2sgaWYgYW4gaW5zdGFuY2Ugb2YKCQkJLy8gV2ViR0xUZXh0dXJlIGNhbiBiZSBkZWxldGVkIGluIG9yZGVyIHRvIGF2b2lkIGEgbWVtb3J5IGxlYWsuCgoJCQljb25zdCB3ZWJnbFRleHR1cmUgPSB3ZWJnbFRleHR1cmVzWyB0ZXh0dXJlUHJvcGVydGllcy5fX2NhY2hlS2V5IF07CgoJCQlpZiAoIHdlYmdsVGV4dHVyZSAhPT0gdW5kZWZpbmVkICkgewoKCQkJCXdlYmdsVGV4dHVyZXNbIHRleHR1cmVQcm9wZXJ0aWVzLl9fY2FjaGVLZXkgXS51c2VkVGltZXMgLS07CgoJCQkJaWYgKCB3ZWJnbFRleHR1cmUudXNlZFRpbWVzID09PSAwICkgewoKCQkJCQlkZWxldGVUZXh0dXJlKCB0ZXh0dXJlICk7CgoJCQkJfQoKCQkJfQoKCQkJLy8gc3RvcmUgcmVmZXJlbmNlcyB0byBjYWNoZSBrZXkgYW5kIFdlYkdMVGV4dHVyZSBvYmplY3QKCgkJCXRleHR1cmVQcm9wZXJ0aWVzLl9fY2FjaGVLZXkgPSB0ZXh0dXJlQ2FjaGVLZXk7CgkJCXRleHR1cmVQcm9wZXJ0aWVzLl9fd2ViZ2xUZXh0dXJlID0gd2ViZ2xUZXh0dXJlc1sgdGV4dHVyZUNhY2hlS2V5IF0udGV4dHVyZTsKCgkJfQoKCQlyZXR1cm4gZm9yY2VVcGxvYWQ7CgoJfQoKCWZ1bmN0aW9uIHVwbG9hZFRleHR1cmUoIHRleHR1cmVQcm9wZXJ0aWVzLCB0ZXh0dXJlLCBzbG90ICkgewoKCQlsZXQgdGV4dHVyZVR5cGUgPSBfZ2wuVEVYVFVSRV8yRDsKCgkJaWYgKCB0ZXh0dXJlLmlzRGF0YUFycmF5VGV4dHVyZSB8fCB0ZXh0dXJlLmlzQ29tcHJlc3NlZEFycmF5VGV4dHVyZSApIHRleHR1cmVUeXBlID0gX2dsLlRFWFRVUkVfMkRfQVJSQVk7CgkJaWYgKCB0ZXh0dXJlLmlzRGF0YTNEVGV4dHVyZSApIHRleHR1cmVUeXBlID0gX2dsLlRFWFRVUkVfM0Q7CgoJCWNvbnN0IGZvcmNlVXBsb2FkID0gaW5pdFRleHR1cmUoIHRleHR1cmVQcm9wZXJ0aWVzLCB0ZXh0dXJlICk7CgkJY29uc3Qgc291cmNlID0gdGV4dHVyZS5zb3VyY2U7CgoJCXN0YXRlLmJpbmRUZXh0dXJlKCB0ZXh0dXJlVHlwZSwgdGV4dHVyZVByb3BlcnRpZXMuX193ZWJnbFRleHR1cmUsIF9nbC5URVhUVVJFMCArIHNsb3QgKTsKCgkJY29uc3Qgc291cmNlUHJvcGVydGllcyA9IHByb3BlcnRpZXMuZ2V0KCBzb3VyY2UgKTsKCgkJaWYgKCBzb3VyY2UudmVyc2lvbiAhPT0gc291cmNlUHJvcGVydGllcy5fX3ZlcnNpb24gfHwgZm9yY2VVcGxvYWQgPT09IHRydWUgKSB7CgoJCQlzdGF0ZS5hY3RpdmVUZXh0dXJlKCBfZ2wuVEVYVFVSRTAgKyBzbG90ICk7CgoJCQljb25zdCB3b3JraW5nUHJpbWFyaWVzID0gQ29sb3JNYW5hZ2VtZW50LmdldFByaW1hcmllcyggQ29sb3JNYW5hZ2VtZW50LndvcmtpbmdDb2xvclNwYWNlICk7CgkJCWNvbnN0IHRleHR1cmVQcmltYXJpZXMgPSB0ZXh0dXJlLmNvbG9yU3BhY2UgPT09IE5vQ29sb3JTcGFjZSA/IG51bGwgOiBDb2xvck1hbmFnZW1lbnQuZ2V0UHJpbWFyaWVzKCB0ZXh0dXJlLmNvbG9yU3BhY2UgKTsKCQkJY29uc3QgdW5wYWNrQ29udmVyc2lvbiA9IHRleHR1cmUuY29sb3JTcGFjZSA9PT0gTm9Db2xvclNwYWNlIHx8IHdvcmtpbmdQcmltYXJpZXMgPT09IHRleHR1cmVQcmltYXJpZXMgPyBfZ2wuTk9ORSA6IF9nbC5CUk9XU0VSX0RFRkFVTFRfV0VCR0w7CgoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfRkxJUF9ZX1dFQkdMLCB0ZXh0dXJlLmZsaXBZICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19QUkVNVUxUSVBMWV9BTFBIQV9XRUJHTCwgdGV4dHVyZS5wcmVtdWx0aXBseUFscGhhICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19BTElHTk1FTlQsIHRleHR1cmUudW5wYWNrQWxpZ25tZW50ICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19DT0xPUlNQQUNFX0NPTlZFUlNJT05fV0VCR0wsIHVucGFja0NvbnZlcnNpb24gKTsKCgkJCWNvbnN0IG5lZWRzUG93ZXJPZlR3byA9IHRleHR1cmVOZWVkc1Bvd2VyT2ZUd28oIHRleHR1cmUgKSAmJiBpc1Bvd2VyT2ZUd28kMSggdGV4dHVyZS5pbWFnZSApID09PSBmYWxzZTsKCQkJbGV0IGltYWdlID0gcmVzaXplSW1hZ2UoIHRleHR1cmUuaW1hZ2UsIG5lZWRzUG93ZXJPZlR3bywgZmFsc2UsIGNhcGFiaWxpdGllcy5tYXhUZXh0dXJlU2l6ZSApOwoJCQlpbWFnZSA9IHZlcmlmeUNvbG9yU3BhY2UoIHRleHR1cmUsIGltYWdlICk7CgoJCQljb25zdCBzdXBwb3J0c01pcHMgPSBpc1Bvd2VyT2ZUd28kMSggaW1hZ2UgKSB8fCBpc1dlYkdMMiwKCQkJCWdsRm9ybWF0ID0gdXRpbHMuY29udmVydCggdGV4dHVyZS5mb3JtYXQsIHRleHR1cmUuY29sb3JTcGFjZSApOwoKCQkJbGV0IGdsVHlwZSA9IHV0aWxzLmNvbnZlcnQoIHRleHR1cmUudHlwZSApLAoJCQkJZ2xJbnRlcm5hbEZvcm1hdCA9IGdldEludGVybmFsRm9ybWF0KCB0ZXh0dXJlLmludGVybmFsRm9ybWF0LCBnbEZvcm1hdCwgZ2xUeXBlLCB0ZXh0dXJlLmNvbG9yU3BhY2UsIHRleHR1cmUuaXNWaWRlb1RleHR1cmUgKTsKCgkJCXNldFRleHR1cmVQYXJhbWV0ZXJzKCB0ZXh0dXJlVHlwZSwgdGV4dHVyZSwgc3VwcG9ydHNNaXBzICk7CgoJCQlsZXQgbWlwbWFwOwoJCQljb25zdCBtaXBtYXBzID0gdGV4dHVyZS5taXBtYXBzOwoKCQkJY29uc3QgdXNlVGV4U3RvcmFnZSA9ICggaXNXZWJHTDIgJiYgdGV4dHVyZS5pc1ZpZGVvVGV4dHVyZSAhPT0gdHJ1ZSAmJiBnbEludGVybmFsRm9ybWF0ICE9PSBSR0JfRVRDMV9Gb3JtYXQgKTsKCQkJY29uc3QgYWxsb2NhdGVNZW1vcnkgPSAoIHNvdXJjZVByb3BlcnRpZXMuX192ZXJzaW9uID09PSB1bmRlZmluZWQgKSB8fCAoIGZvcmNlVXBsb2FkID09PSB0cnVlICk7CgkJCWNvbnN0IGRhdGFSZWFkeSA9IHNvdXJjZS5kYXRhUmVhZHk7CgkJCWNvbnN0IGxldmVscyA9IGdldE1pcExldmVscyggdGV4dHVyZSwgaW1hZ2UsIHN1cHBvcnRzTWlwcyApOwoKCQkJaWYgKCB0ZXh0dXJlLmlzRGVwdGhUZXh0dXJlICkgewoKCQkJCS8vIHBvcHVsYXRlIGRlcHRoIHRleHR1cmUgd2l0aCBkdW1teSBkYXRhCgoJCQkJZ2xJbnRlcm5hbEZvcm1hdCA9IF9nbC5ERVBUSF9DT01QT05FTlQ7CgoJCQkJaWYgKCBpc1dlYkdMMiApIHsKCgkJCQkJaWYgKCB0ZXh0dXJlLnR5cGUgPT09IEZsb2F0VHlwZSApIHsKCgkJCQkJCWdsSW50ZXJuYWxGb3JtYXQgPSBfZ2wuREVQVEhfQ09NUE9ORU5UMzJGOwoKCQkJCQl9IGVsc2UgaWYgKCB0ZXh0dXJlLnR5cGUgPT09IFVuc2lnbmVkSW50VHlwZSApIHsKCgkJCQkJCWdsSW50ZXJuYWxGb3JtYXQgPSBfZ2wuREVQVEhfQ09NUE9ORU5UMjQ7CgoJCQkJCX0gZWxzZSBpZiAoIHRleHR1cmUudHlwZSA9PT0gVW5zaWduZWRJbnQyNDhUeXBlICkgewoKCQkJCQkJZ2xJbnRlcm5hbEZvcm1hdCA9IF9nbC5ERVBUSDI0X1NURU5DSUw4OwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJZ2xJbnRlcm5hbEZvcm1hdCA9IF9nbC5ERVBUSF9DT01QT05FTlQxNjsgLy8gV2ViR0wyIHJlcXVpcmVzIHNpemVkIGludGVybmFsZm9ybWF0IGZvciBnbFRleEltYWdlMkQKCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggdGV4dHVyZS50eXBlID09PSBGbG9hdFR5cGUgKSB7CgoJCQkJCQljb25zb2xlLmVycm9yKCAnV2ViR0xSZW5kZXJlcjogRmxvYXRpbmcgcG9pbnQgZGVwdGggdGV4dHVyZSByZXF1aXJlcyBXZWJHTDIuJyApOwoKCQkJCQl9CgoJCQkJfQoKCQkJCS8vIHZhbGlkYXRpb24gY2hlY2tzIGZvciBXZWJHTCAxCgoJCQkJaWYgKCB0ZXh0dXJlLmZvcm1hdCA9PT0gRGVwdGhGb3JtYXQgJiYgZ2xJbnRlcm5hbEZvcm1hdCA9PT0gX2dsLkRFUFRIX0NPTVBPTkVOVCApIHsKCgkJCQkJLy8gVGhlIGVycm9yIElOVkFMSURfT1BFUkFUSU9OIGlzIGdlbmVyYXRlZCBieSB0ZXhJbWFnZTJEIGlmIGZvcm1hdCBhbmQgaW50ZXJuYWxmb3JtYXQgYXJlCgkJCQkJLy8gREVQVEhfQ09NUE9ORU5UIGFuZCB0eXBlIGlzIG5vdCBVTlNJR05FRF9TSE9SVCBvciBVTlNJR05FRF9JTlQKCQkJCQkvLyAoaHR0cHM6Ly93d3cua2hyb25vcy5vcmcvcmVnaXN0cnkvd2ViZ2wvZXh0ZW5zaW9ucy9XRUJHTF9kZXB0aF90ZXh0dXJlLykKCQkJCQlpZiAoIHRleHR1cmUudHlwZSAhPT0gVW5zaWduZWRTaG9ydFR5cGUgJiYgdGV4dHVyZS50eXBlICE9PSBVbnNpZ25lZEludFR5cGUgKSB7CgoJCQkJCQljb25zb2xlLndhcm4oICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBVc2UgVW5zaWduZWRTaG9ydFR5cGUgb3IgVW5zaWduZWRJbnRUeXBlIGZvciBEZXB0aEZvcm1hdCBEZXB0aFRleHR1cmUuJyApOwoKCQkJCQkJdGV4dHVyZS50eXBlID0gVW5zaWduZWRJbnRUeXBlOwoJCQkJCQlnbFR5cGUgPSB1dGlscy5jb252ZXJ0KCB0ZXh0dXJlLnR5cGUgKTsKCgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoIHRleHR1cmUuZm9ybWF0ID09PSBEZXB0aFN0ZW5jaWxGb3JtYXQgJiYgZ2xJbnRlcm5hbEZvcm1hdCA9PT0gX2dsLkRFUFRIX0NPTVBPTkVOVCApIHsKCgkJCQkJLy8gRGVwdGggc3RlbmNpbCB0ZXh0dXJlcyBuZWVkIHRoZSBERVBUSF9TVEVOQ0lMIGludGVybmFsIGZvcm1hdAoJCQkJCS8vIChodHRwczovL3d3dy5raHJvbm9zLm9yZy9yZWdpc3RyeS93ZWJnbC9leHRlbnNpb25zL1dFQkdMX2RlcHRoX3RleHR1cmUvKQoJCQkJCWdsSW50ZXJuYWxGb3JtYXQgPSBfZ2wuREVQVEhfU1RFTkNJTDsKCgkJCQkJLy8gVGhlIGVycm9yIElOVkFMSURfT1BFUkFUSU9OIGlzIGdlbmVyYXRlZCBieSB0ZXhJbWFnZTJEIGlmIGZvcm1hdCBhbmQgaW50ZXJuYWxmb3JtYXQgYXJlCgkJCQkJLy8gREVQVEhfU1RFTkNJTCBhbmQgdHlwZSBpcyBub3QgVU5TSUdORURfSU5UXzI0XzhfV0VCR0wuCgkJCQkJLy8gKGh0dHBzOi8vd3d3Lmtocm9ub3Mub3JnL3JlZ2lzdHJ5L3dlYmdsL2V4dGVuc2lvbnMvV0VCR0xfZGVwdGhfdGV4dHVyZS8pCgkJCQkJaWYgKCB0ZXh0dXJlLnR5cGUgIT09IFVuc2lnbmVkSW50MjQ4VHlwZSApIHsKCgkJCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IFVzZSBVbnNpZ25lZEludDI0OFR5cGUgZm9yIERlcHRoU3RlbmNpbEZvcm1hdCBEZXB0aFRleHR1cmUuJyApOwoKCQkJCQkJdGV4dHVyZS50eXBlID0gVW5zaWduZWRJbnQyNDhUeXBlOwoJCQkJCQlnbFR5cGUgPSB1dGlscy5jb252ZXJ0KCB0ZXh0dXJlLnR5cGUgKTsKCgkJCQkJfQoKCQkJCX0KCgkJCQkvLwoKCQkJCWlmICggYWxsb2NhdGVNZW1vcnkgKSB7CgoJCQkJCWlmICggdXNlVGV4U3RvcmFnZSApIHsKCgkJCQkJCXN0YXRlLnRleFN0b3JhZ2UyRCggX2dsLlRFWFRVUkVfMkQsIDEsIGdsSW50ZXJuYWxGb3JtYXQsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXN0YXRlLnRleEltYWdlMkQoIF9nbC5URVhUVVJFXzJELCAwLCBnbEludGVybmFsRm9ybWF0LCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0LCAwLCBnbEZvcm1hdCwgZ2xUeXBlLCBudWxsICk7CgoJCQkJCX0KCgkJCQl9CgoJCQl9IGVsc2UgaWYgKCB0ZXh0dXJlLmlzRGF0YVRleHR1cmUgKSB7CgoJCQkJLy8gdXNlIG1hbnVhbGx5IGNyZWF0ZWQgbWlwbWFwcyBpZiBhdmFpbGFibGUKCQkJCS8vIGlmIHRoZXJlIGFyZSBubyBtYW51YWwgbWlwbWFwcwoJCQkJLy8gc2V0IDAgbGV2ZWwgbWlwbWFwIGFuZCB0aGVuIHVzZSBHTCB0byBnZW5lcmF0ZSBvdGhlciBtaXBtYXAgbGV2ZWxzCgoJCQkJaWYgKCBtaXBtYXBzLmxlbmd0aCA+IDAgJiYgc3VwcG9ydHNNaXBzICkgewoKCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgJiYgYWxsb2NhdGVNZW1vcnkgKSB7CgoJCQkJCQlzdGF0ZS50ZXhTdG9yYWdlMkQoIF9nbC5URVhUVVJFXzJELCBsZXZlbHMsIGdsSW50ZXJuYWxGb3JtYXQsIG1pcG1hcHNbIDAgXS53aWR0aCwgbWlwbWFwc1sgMCBdLmhlaWdodCApOwoKCQkJCQl9CgoJCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBtaXBtYXBzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCQkJbWlwbWFwID0gbWlwbWFwc1sgaSBdOwoKCQkJCQkJaWYgKCB1c2VUZXhTdG9yYWdlICkgewoKCQkJCQkJCWlmICggZGF0YVJlYWR5ICkgewoKCQkJCQkJCQlzdGF0ZS50ZXhTdWJJbWFnZTJEKCBfZ2wuVEVYVFVSRV8yRCwgaSwgMCwgMCwgbWlwbWFwLndpZHRoLCBtaXBtYXAuaGVpZ2h0LCBnbEZvcm1hdCwgZ2xUeXBlLCBtaXBtYXAuZGF0YSApOwoKCQkJCQkJCX0KCgkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJc3RhdGUudGV4SW1hZ2UyRCggX2dsLlRFWFRVUkVfMkQsIGksIGdsSW50ZXJuYWxGb3JtYXQsIG1pcG1hcC53aWR0aCwgbWlwbWFwLmhlaWdodCwgMCwgZ2xGb3JtYXQsIGdsVHlwZSwgbWlwbWFwLmRhdGEgKTsKCgkJCQkJCX0KCgkJCQkJfQoKCQkJCQl0ZXh0dXJlLmdlbmVyYXRlTWlwbWFwcyA9IGZhbHNlOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggdXNlVGV4U3RvcmFnZSApIHsKCgkJCQkJCWlmICggYWxsb2NhdGVNZW1vcnkgKSB7CgoJCQkJCQkJc3RhdGUudGV4U3RvcmFnZTJEKCBfZ2wuVEVYVFVSRV8yRCwgbGV2ZWxzLCBnbEludGVybmFsRm9ybWF0LCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0ICk7CgoJCQkJCQl9CgoJCQkJCQlpZiAoIGRhdGFSZWFkeSApIHsKCgkJCQkJCQlzdGF0ZS50ZXhTdWJJbWFnZTJEKCBfZ2wuVEVYVFVSRV8yRCwgMCwgMCwgMCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCwgZ2xGb3JtYXQsIGdsVHlwZSwgaW1hZ2UuZGF0YSApOwoKCQkJCQkJfQoKCQkJCQl9IGVsc2UgewoKCQkJCQkJc3RhdGUudGV4SW1hZ2UyRCggX2dsLlRFWFRVUkVfMkQsIDAsIGdsSW50ZXJuYWxGb3JtYXQsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQsIDAsIGdsRm9ybWF0LCBnbFR5cGUsIGltYWdlLmRhdGEgKTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0gZWxzZSBpZiAoIHRleHR1cmUuaXNDb21wcmVzc2VkVGV4dHVyZSApIHsKCgkJCQlpZiAoIHRleHR1cmUuaXNDb21wcmVzc2VkQXJyYXlUZXh0dXJlICkgewoKCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgJiYgYWxsb2NhdGVNZW1vcnkgKSB7CgoJCQkJCQlzdGF0ZS50ZXhTdG9yYWdlM0QoIF9nbC5URVhUVVJFXzJEX0FSUkFZLCBsZXZlbHMsIGdsSW50ZXJuYWxGb3JtYXQsIG1pcG1hcHNbIDAgXS53aWR0aCwgbWlwbWFwc1sgMCBdLmhlaWdodCwgaW1hZ2UuZGVwdGggKTsKCgkJCQkJfQoKCQkJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gbWlwbWFwcy5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCQkJCW1pcG1hcCA9IG1pcG1hcHNbIGkgXTsKCgkJCQkJCWlmICggdGV4dHVyZS5mb3JtYXQgIT09IFJHQkFGb3JtYXQgKSB7CgoJCQkJCQkJaWYgKCBnbEZvcm1hdCAhPT0gbnVsbCApIHsKCgkJCQkJCQkJaWYgKCB1c2VUZXhTdG9yYWdlICkgewoKCQkJCQkJCQkJaWYgKCBkYXRhUmVhZHkgKSB7CgoJCQkJCQkJCQkJc3RhdGUuY29tcHJlc3NlZFRleFN1YkltYWdlM0QoIF9nbC5URVhUVVJFXzJEX0FSUkFZLCBpLCAwLCAwLCAwLCBtaXBtYXAud2lkdGgsIG1pcG1hcC5oZWlnaHQsIGltYWdlLmRlcHRoLCBnbEZvcm1hdCwgbWlwbWFwLmRhdGEsIDAsIDAgKTsKCgkJCQkJCQkJCX0KCgkJCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkJCXN0YXRlLmNvbXByZXNzZWRUZXhJbWFnZTNEKCBfZ2wuVEVYVFVSRV8yRF9BUlJBWSwgaSwgZ2xJbnRlcm5hbEZvcm1hdCwgbWlwbWFwLndpZHRoLCBtaXBtYXAuaGVpZ2h0LCBpbWFnZS5kZXB0aCwgMCwgbWlwbWFwLmRhdGEsIDAsIDAgKTsKCgkJCQkJCQkJfQoKCQkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IEF0dGVtcHQgdG8gbG9hZCB1bnN1cHBvcnRlZCBjb21wcmVzc2VkIHRleHR1cmUgZm9ybWF0IGluIC51cGxvYWRUZXh0dXJlKCknICk7CgoJCQkJCQkJfQoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgKSB7CgoJCQkJCQkJCWlmICggZGF0YVJlYWR5ICkgewoKCQkJCQkJCQkJc3RhdGUudGV4U3ViSW1hZ2UzRCggX2dsLlRFWFRVUkVfMkRfQVJSQVksIGksIDAsIDAsIDAsIG1pcG1hcC53aWR0aCwgbWlwbWFwLmhlaWdodCwgaW1hZ2UuZGVwdGgsIGdsRm9ybWF0LCBnbFR5cGUsIG1pcG1hcC5kYXRhICk7CgoJCQkJCQkJCX0KCgkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQlzdGF0ZS50ZXhJbWFnZTNEKCBfZ2wuVEVYVFVSRV8yRF9BUlJBWSwgaSwgZ2xJbnRlcm5hbEZvcm1hdCwgbWlwbWFwLndpZHRoLCBtaXBtYXAuaGVpZ2h0LCBpbWFnZS5kZXB0aCwgMCwgZ2xGb3JtYXQsIGdsVHlwZSwgbWlwbWFwLmRhdGEgKTsKCgkJCQkJCQl9CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgJiYgYWxsb2NhdGVNZW1vcnkgKSB7CgoJCQkJCQlzdGF0ZS50ZXhTdG9yYWdlMkQoIF9nbC5URVhUVVJFXzJELCBsZXZlbHMsIGdsSW50ZXJuYWxGb3JtYXQsIG1pcG1hcHNbIDAgXS53aWR0aCwgbWlwbWFwc1sgMCBdLmhlaWdodCApOwoKCQkJCQl9CgoJCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBtaXBtYXBzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCQkJbWlwbWFwID0gbWlwbWFwc1sgaSBdOwoKCQkJCQkJaWYgKCB0ZXh0dXJlLmZvcm1hdCAhPT0gUkdCQUZvcm1hdCApIHsKCgkJCQkJCQlpZiAoIGdsRm9ybWF0ICE9PSBudWxsICkgewoKCQkJCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgKSB7CgoJCQkJCQkJCQlpZiAoIGRhdGFSZWFkeSApIHsKCgkJCQkJCQkJCQlzdGF0ZS5jb21wcmVzc2VkVGV4U3ViSW1hZ2UyRCggX2dsLlRFWFRVUkVfMkQsIGksIDAsIDAsIG1pcG1hcC53aWR0aCwgbWlwbWFwLmhlaWdodCwgZ2xGb3JtYXQsIG1pcG1hcC5kYXRhICk7CgoJCQkJCQkJCQl9CgoJCQkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJCQlzdGF0ZS5jb21wcmVzc2VkVGV4SW1hZ2UyRCggX2dsLlRFWFRVUkVfMkQsIGksIGdsSW50ZXJuYWxGb3JtYXQsIG1pcG1hcC53aWR0aCwgbWlwbWFwLmhlaWdodCwgMCwgbWlwbWFwLmRhdGEgKTsKCgkJCQkJCQkJfQoKCQkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IEF0dGVtcHQgdG8gbG9hZCB1bnN1cHBvcnRlZCBjb21wcmVzc2VkIHRleHR1cmUgZm9ybWF0IGluIC51cGxvYWRUZXh0dXJlKCknICk7CgoJCQkJCQkJfQoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgKSB7CgoJCQkJCQkJCWlmICggZGF0YVJlYWR5ICkgewoKCQkJCQkJCQkJc3RhdGUudGV4U3ViSW1hZ2UyRCggX2dsLlRFWFRVUkVfMkQsIGksIDAsIDAsIG1pcG1hcC53aWR0aCwgbWlwbWFwLmhlaWdodCwgZ2xGb3JtYXQsIGdsVHlwZSwgbWlwbWFwLmRhdGEgKTsKCgkJCQkJCQkJfQoKCQkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJCXN0YXRlLnRleEltYWdlMkQoIF9nbC5URVhUVVJFXzJELCBpLCBnbEludGVybmFsRm9ybWF0LCBtaXBtYXAud2lkdGgsIG1pcG1hcC5oZWlnaHQsIDAsIGdsRm9ybWF0LCBnbFR5cGUsIG1pcG1hcC5kYXRhICk7CgoJCQkJCQkJfQoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJfQoKCQkJfSBlbHNlIGlmICggdGV4dHVyZS5pc0RhdGFBcnJheVRleHR1cmUgKSB7CgoJCQkJaWYgKCB1c2VUZXhTdG9yYWdlICkgewoKCQkJCQlpZiAoIGFsbG9jYXRlTWVtb3J5ICkgewoKCQkJCQkJc3RhdGUudGV4U3RvcmFnZTNEKCBfZ2wuVEVYVFVSRV8yRF9BUlJBWSwgbGV2ZWxzLCBnbEludGVybmFsRm9ybWF0LCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0LCBpbWFnZS5kZXB0aCApOwoKCQkJCQl9CgoJCQkJCWlmICggZGF0YVJlYWR5ICkgewoKCQkJCQkJc3RhdGUudGV4U3ViSW1hZ2UzRCggX2dsLlRFWFRVUkVfMkRfQVJSQVksIDAsIDAsIDAsIDAsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQsIGltYWdlLmRlcHRoLCBnbEZvcm1hdCwgZ2xUeXBlLCBpbWFnZS5kYXRhICk7CgoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQlzdGF0ZS50ZXhJbWFnZTNEKCBfZ2wuVEVYVFVSRV8yRF9BUlJBWSwgMCwgZ2xJbnRlcm5hbEZvcm1hdCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCwgaW1hZ2UuZGVwdGgsIDAsIGdsRm9ybWF0LCBnbFR5cGUsIGltYWdlLmRhdGEgKTsKCgkJCQl9CgoJCQl9IGVsc2UgaWYgKCB0ZXh0dXJlLmlzRGF0YTNEVGV4dHVyZSApIHsKCgkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgKSB7CgoJCQkJCWlmICggYWxsb2NhdGVNZW1vcnkgKSB7CgoJCQkJCQlzdGF0ZS50ZXhTdG9yYWdlM0QoIF9nbC5URVhUVVJFXzNELCBsZXZlbHMsIGdsSW50ZXJuYWxGb3JtYXQsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQsIGltYWdlLmRlcHRoICk7CgoJCQkJCX0KCgkJCQkJaWYgKCBkYXRhUmVhZHkgKSB7CgoJCQkJCQlzdGF0ZS50ZXhTdWJJbWFnZTNEKCBfZ2wuVEVYVFVSRV8zRCwgMCwgMCwgMCwgMCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCwgaW1hZ2UuZGVwdGgsIGdsRm9ybWF0LCBnbFR5cGUsIGltYWdlLmRhdGEgKTsKCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCXN0YXRlLnRleEltYWdlM0QoIF9nbC5URVhUVVJFXzNELCAwLCBnbEludGVybmFsRm9ybWF0LCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0LCBpbWFnZS5kZXB0aCwgMCwgZ2xGb3JtYXQsIGdsVHlwZSwgaW1hZ2UuZGF0YSApOwoKCQkJCX0KCgkJCX0gZWxzZSBpZiAoIHRleHR1cmUuaXNGcmFtZWJ1ZmZlclRleHR1cmUgKSB7CgoJCQkJaWYgKCBhbGxvY2F0ZU1lbW9yeSApIHsKCgkJCQkJaWYgKCB1c2VUZXhTdG9yYWdlICkgewoKCQkJCQkJc3RhdGUudGV4U3RvcmFnZTJEKCBfZ2wuVEVYVFVSRV8yRCwgbGV2ZWxzLCBnbEludGVybmFsRm9ybWF0LCBpbWFnZS53aWR0aCwgaW1hZ2UuaGVpZ2h0ICk7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlsZXQgd2lkdGggPSBpbWFnZS53aWR0aCwgaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0OwoKCQkJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgbGV2ZWxzOyBpICsrICkgewoKCQkJCQkJCXN0YXRlLnRleEltYWdlMkQoIF9nbC5URVhUVVJFXzJELCBpLCBnbEludGVybmFsRm9ybWF0LCB3aWR0aCwgaGVpZ2h0LCAwLCBnbEZvcm1hdCwgZ2xUeXBlLCBudWxsICk7CgoJCQkJCQkJd2lkdGggPj49IDE7CgkJCQkJCQloZWlnaHQgPj49IDE7CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCS8vIHJlZ3VsYXIgVGV4dHVyZSAoaW1hZ2UsIHZpZGVvLCBjYW52YXMpCgoJCQkJLy8gdXNlIG1hbnVhbGx5IGNyZWF0ZWQgbWlwbWFwcyBpZiBhdmFpbGFibGUKCQkJCS8vIGlmIHRoZXJlIGFyZSBubyBtYW51YWwgbWlwbWFwcwoJCQkJLy8gc2V0IDAgbGV2ZWwgbWlwbWFwIGFuZCB0aGVuIHVzZSBHTCB0byBnZW5lcmF0ZSBvdGhlciBtaXBtYXAgbGV2ZWxzCgoJCQkJaWYgKCBtaXBtYXBzLmxlbmd0aCA+IDAgJiYgc3VwcG9ydHNNaXBzICkgewoKCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgJiYgYWxsb2NhdGVNZW1vcnkgKSB7CgoJCQkJCQlzdGF0ZS50ZXhTdG9yYWdlMkQoIF9nbC5URVhUVVJFXzJELCBsZXZlbHMsIGdsSW50ZXJuYWxGb3JtYXQsIG1pcG1hcHNbIDAgXS53aWR0aCwgbWlwbWFwc1sgMCBdLmhlaWdodCApOwoKCQkJCQl9CgoJCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBtaXBtYXBzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCQkJbWlwbWFwID0gbWlwbWFwc1sgaSBdOwoKCQkJCQkJaWYgKCB1c2VUZXhTdG9yYWdlICkgewoKCQkJCQkJCWlmICggZGF0YVJlYWR5ICkgewoKCQkJCQkJCQlzdGF0ZS50ZXhTdWJJbWFnZTJEKCBfZ2wuVEVYVFVSRV8yRCwgaSwgMCwgMCwgZ2xGb3JtYXQsIGdsVHlwZSwgbWlwbWFwICk7CgoJCQkJCQkJfQoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQlzdGF0ZS50ZXhJbWFnZTJEKCBfZ2wuVEVYVFVSRV8yRCwgaSwgZ2xJbnRlcm5hbEZvcm1hdCwgZ2xGb3JtYXQsIGdsVHlwZSwgbWlwbWFwICk7CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJdGV4dHVyZS5nZW5lcmF0ZU1pcG1hcHMgPSBmYWxzZTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgKSB7CgoJCQkJCQlpZiAoIGFsbG9jYXRlTWVtb3J5ICkgewoKCQkJCQkJCXN0YXRlLnRleFN0b3JhZ2UyRCggX2dsLlRFWFRVUkVfMkQsIGxldmVscywgZ2xJbnRlcm5hbEZvcm1hdCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCApOwoKCQkJCQkJfQoKCQkJCQkJaWYgKCBkYXRhUmVhZHkgKSB7CgoJCQkJCQkJc3RhdGUudGV4U3ViSW1hZ2UyRCggX2dsLlRFWFRVUkVfMkQsIDAsIDAsIDAsIGdsRm9ybWF0LCBnbFR5cGUsIGltYWdlICk7CgoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlzdGF0ZS50ZXhJbWFnZTJEKCBfZ2wuVEVYVFVSRV8yRCwgMCwgZ2xJbnRlcm5hbEZvcm1hdCwgZ2xGb3JtYXQsIGdsVHlwZSwgaW1hZ2UgKTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJCWlmICggdGV4dHVyZU5lZWRzR2VuZXJhdGVNaXBtYXBzKCB0ZXh0dXJlLCBzdXBwb3J0c01pcHMgKSApIHsKCgkJCQlnZW5lcmF0ZU1pcG1hcCggdGV4dHVyZVR5cGUgKTsKCgkJCX0KCgkJCXNvdXJjZVByb3BlcnRpZXMuX192ZXJzaW9uID0gc291cmNlLnZlcnNpb247CgoJCQlpZiAoIHRleHR1cmUub25VcGRhdGUgKSB0ZXh0dXJlLm9uVXBkYXRlKCB0ZXh0dXJlICk7CgoJCX0KCgkJdGV4dHVyZVByb3BlcnRpZXMuX192ZXJzaW9uID0gdGV4dHVyZS52ZXJzaW9uOwoKCX0KCglmdW5jdGlvbiB1cGxvYWRDdWJlVGV4dHVyZSggdGV4dHVyZVByb3BlcnRpZXMsIHRleHR1cmUsIHNsb3QgKSB7CgoJCWlmICggdGV4dHVyZS5pbWFnZS5sZW5ndGggIT09IDYgKSByZXR1cm47CgoJCWNvbnN0IGZvcmNlVXBsb2FkID0gaW5pdFRleHR1cmUoIHRleHR1cmVQcm9wZXJ0aWVzLCB0ZXh0dXJlICk7CgkJY29uc3Qgc291cmNlID0gdGV4dHVyZS5zb3VyY2U7CgoJCXN0YXRlLmJpbmRUZXh0dXJlKCBfZ2wuVEVYVFVSRV9DVUJFX01BUCwgdGV4dHVyZVByb3BlcnRpZXMuX193ZWJnbFRleHR1cmUsIF9nbC5URVhUVVJFMCArIHNsb3QgKTsKCgkJY29uc3Qgc291cmNlUHJvcGVydGllcyA9IHByb3BlcnRpZXMuZ2V0KCBzb3VyY2UgKTsKCgkJaWYgKCBzb3VyY2UudmVyc2lvbiAhPT0gc291cmNlUHJvcGVydGllcy5fX3ZlcnNpb24gfHwgZm9yY2VVcGxvYWQgPT09IHRydWUgKSB7CgoJCQlzdGF0ZS5hY3RpdmVUZXh0dXJlKCBfZ2wuVEVYVFVSRTAgKyBzbG90ICk7CgoJCQljb25zdCB3b3JraW5nUHJpbWFyaWVzID0gQ29sb3JNYW5hZ2VtZW50LmdldFByaW1hcmllcyggQ29sb3JNYW5hZ2VtZW50LndvcmtpbmdDb2xvclNwYWNlICk7CgkJCWNvbnN0IHRleHR1cmVQcmltYXJpZXMgPSB0ZXh0dXJlLmNvbG9yU3BhY2UgPT09IE5vQ29sb3JTcGFjZSA/IG51bGwgOiBDb2xvck1hbmFnZW1lbnQuZ2V0UHJpbWFyaWVzKCB0ZXh0dXJlLmNvbG9yU3BhY2UgKTsKCQkJY29uc3QgdW5wYWNrQ29udmVyc2lvbiA9IHRleHR1cmUuY29sb3JTcGFjZSA9PT0gTm9Db2xvclNwYWNlIHx8IHdvcmtpbmdQcmltYXJpZXMgPT09IHRleHR1cmVQcmltYXJpZXMgPyBfZ2wuTk9ORSA6IF9nbC5CUk9XU0VSX0RFRkFVTFRfV0VCR0w7CgoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfRkxJUF9ZX1dFQkdMLCB0ZXh0dXJlLmZsaXBZICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19QUkVNVUxUSVBMWV9BTFBIQV9XRUJHTCwgdGV4dHVyZS5wcmVtdWx0aXBseUFscGhhICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19BTElHTk1FTlQsIHRleHR1cmUudW5wYWNrQWxpZ25tZW50ICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19DT0xPUlNQQUNFX0NPTlZFUlNJT05fV0VCR0wsIHVucGFja0NvbnZlcnNpb24gKTsKCgkJCWNvbnN0IGlzQ29tcHJlc3NlZCA9ICggdGV4dHVyZS5pc0NvbXByZXNzZWRUZXh0dXJlIHx8IHRleHR1cmUuaW1hZ2VbIDAgXS5pc0NvbXByZXNzZWRUZXh0dXJlICk7CgkJCWNvbnN0IGlzRGF0YVRleHR1cmUgPSAoIHRleHR1cmUuaW1hZ2VbIDAgXSAmJiB0ZXh0dXJlLmltYWdlWyAwIF0uaXNEYXRhVGV4dHVyZSApOwoKCQkJY29uc3QgY3ViZUltYWdlID0gW107CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA2OyBpICsrICkgewoKCQkJCWlmICggISBpc0NvbXByZXNzZWQgJiYgISBpc0RhdGFUZXh0dXJlICkgewoKCQkJCQljdWJlSW1hZ2VbIGkgXSA9IHJlc2l6ZUltYWdlKCB0ZXh0dXJlLmltYWdlWyBpIF0sIGZhbHNlLCB0cnVlLCBjYXBhYmlsaXRpZXMubWF4Q3ViZW1hcFNpemUgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQljdWJlSW1hZ2VbIGkgXSA9IGlzRGF0YVRleHR1cmUgPyB0ZXh0dXJlLmltYWdlWyBpIF0uaW1hZ2UgOiB0ZXh0dXJlLmltYWdlWyBpIF07CgoJCQkJfQoKCQkJCWN1YmVJbWFnZVsgaSBdID0gdmVyaWZ5Q29sb3JTcGFjZSggdGV4dHVyZSwgY3ViZUltYWdlWyBpIF0gKTsKCgkJCX0KCgkJCWNvbnN0IGltYWdlID0gY3ViZUltYWdlWyAwIF0sCgkJCQlzdXBwb3J0c01pcHMgPSBpc1Bvd2VyT2ZUd28kMSggaW1hZ2UgKSB8fCBpc1dlYkdMMiwKCQkJCWdsRm9ybWF0ID0gdXRpbHMuY29udmVydCggdGV4dHVyZS5mb3JtYXQsIHRleHR1cmUuY29sb3JTcGFjZSApLAoJCQkJZ2xUeXBlID0gdXRpbHMuY29udmVydCggdGV4dHVyZS50eXBlICksCgkJCQlnbEludGVybmFsRm9ybWF0ID0gZ2V0SW50ZXJuYWxGb3JtYXQoIHRleHR1cmUuaW50ZXJuYWxGb3JtYXQsIGdsRm9ybWF0LCBnbFR5cGUsIHRleHR1cmUuY29sb3JTcGFjZSApOwoKCQkJY29uc3QgdXNlVGV4U3RvcmFnZSA9ICggaXNXZWJHTDIgJiYgdGV4dHVyZS5pc1ZpZGVvVGV4dHVyZSAhPT0gdHJ1ZSApOwoJCQljb25zdCBhbGxvY2F0ZU1lbW9yeSA9ICggc291cmNlUHJvcGVydGllcy5fX3ZlcnNpb24gPT09IHVuZGVmaW5lZCApIHx8ICggZm9yY2VVcGxvYWQgPT09IHRydWUgKTsKCQkJY29uc3QgZGF0YVJlYWR5ID0gc291cmNlLmRhdGFSZWFkeTsKCQkJbGV0IGxldmVscyA9IGdldE1pcExldmVscyggdGV4dHVyZSwgaW1hZ2UsIHN1cHBvcnRzTWlwcyApOwoKCQkJc2V0VGV4dHVyZVBhcmFtZXRlcnMoIF9nbC5URVhUVVJFX0NVQkVfTUFQLCB0ZXh0dXJlLCBzdXBwb3J0c01pcHMgKTsKCgkJCWxldCBtaXBtYXBzOwoKCQkJaWYgKCBpc0NvbXByZXNzZWQgKSB7CgoJCQkJaWYgKCB1c2VUZXhTdG9yYWdlICYmIGFsbG9jYXRlTWVtb3J5ICkgewoKCQkJCQlzdGF0ZS50ZXhTdG9yYWdlMkQoIF9nbC5URVhUVVJFX0NVQkVfTUFQLCBsZXZlbHMsIGdsSW50ZXJuYWxGb3JtYXQsIGltYWdlLndpZHRoLCBpbWFnZS5oZWlnaHQgKTsKCgkJCQl9CgoJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgNjsgaSArKyApIHsKCgkJCQkJbWlwbWFwcyA9IGN1YmVJbWFnZVsgaSBdLm1pcG1hcHM7CgoJCQkJCWZvciAoIGxldCBqID0gMDsgaiA8IG1pcG1hcHMubGVuZ3RoOyBqICsrICkgewoKCQkJCQkJY29uc3QgbWlwbWFwID0gbWlwbWFwc1sgaiBdOwoKCQkJCQkJaWYgKCB0ZXh0dXJlLmZvcm1hdCAhPT0gUkdCQUZvcm1hdCApIHsKCgkJCQkJCQlpZiAoIGdsRm9ybWF0ICE9PSBudWxsICkgewoKCQkJCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgKSB7CgoJCQkJCQkJCQlpZiAoIGRhdGFSZWFkeSApIHsKCgkJCQkJCQkJCQlzdGF0ZS5jb21wcmVzc2VkVGV4U3ViSW1hZ2UyRCggX2dsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIGksIGosIDAsIDAsIG1pcG1hcC53aWR0aCwgbWlwbWFwLmhlaWdodCwgZ2xGb3JtYXQsIG1pcG1hcC5kYXRhICk7CgoJCQkJCQkJCQl9CgoJCQkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJCQlzdGF0ZS5jb21wcmVzc2VkVGV4SW1hZ2UyRCggX2dsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIGksIGosIGdsSW50ZXJuYWxGb3JtYXQsIG1pcG1hcC53aWR0aCwgbWlwbWFwLmhlaWdodCwgMCwgbWlwbWFwLmRhdGEgKTsKCgkJCQkJCQkJfQoKCQkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IEF0dGVtcHQgdG8gbG9hZCB1bnN1cHBvcnRlZCBjb21wcmVzc2VkIHRleHR1cmUgZm9ybWF0IGluIC5zZXRUZXh0dXJlQ3ViZSgpJyApOwoKCQkJCQkJCX0KCgkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJaWYgKCB1c2VUZXhTdG9yYWdlICkgewoKCQkJCQkJCQlpZiAoIGRhdGFSZWFkeSApIHsKCgkJCQkJCQkJCXN0YXRlLnRleFN1YkltYWdlMkQoIF9nbC5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBpLCBqLCAwLCAwLCBtaXBtYXAud2lkdGgsIG1pcG1hcC5oZWlnaHQsIGdsRm9ybWF0LCBnbFR5cGUsIG1pcG1hcC5kYXRhICk7CgoJCQkJCQkJCX0KCgkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQlzdGF0ZS50ZXhJbWFnZTJEKCBfZ2wuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgaSwgaiwgZ2xJbnRlcm5hbEZvcm1hdCwgbWlwbWFwLndpZHRoLCBtaXBtYXAuaGVpZ2h0LCAwLCBnbEZvcm1hdCwgZ2xUeXBlLCBtaXBtYXAuZGF0YSApOwoKCQkJCQkJCX0KCgkJCQkJCX0KCgkJCQkJfQoKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJbWlwbWFwcyA9IHRleHR1cmUubWlwbWFwczsKCgkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgJiYgYWxsb2NhdGVNZW1vcnkgKSB7CgoJCQkJCS8vIFRPRE86IFVuaWZvcm1seSBoYW5kbGUgbWlwbWFwIGRlZmluaXRpb25zCgkJCQkJLy8gTm9ybWFsIHRleHR1cmVzIGFuZCBjb21wcmVzc2VkIGN1YmUgdGV4dHVyZXMgZGVmaW5lIGJhc2UgbGV2ZWwgKyBtaXBzIHdpdGggdGhlaXIgbWlwbWFwIGFycmF5CgkJCQkJLy8gVW5jb21wcmVzc2VkIGN1YmUgdGV4dHVyZXMgdXNlIHRoZWlyIG1pcG1hcCBhcnJheSBvbmx5IGZvciBtaXBzIChubyBiYXNlIGxldmVsKQoKCQkJCQlpZiAoIG1pcG1hcHMubGVuZ3RoID4gMCApIGxldmVscyArKzsKCgkJCQkJc3RhdGUudGV4U3RvcmFnZTJEKCBfZ2wuVEVYVFVSRV9DVUJFX01BUCwgbGV2ZWxzLCBnbEludGVybmFsRm9ybWF0LCBjdWJlSW1hZ2VbIDAgXS53aWR0aCwgY3ViZUltYWdlWyAwIF0uaGVpZ2h0ICk7CgoJCQkJfQoKCQkJCWZvciAoIGxldCBpID0gMDsgaSA8IDY7IGkgKysgKSB7CgoJCQkJCWlmICggaXNEYXRhVGV4dHVyZSApIHsKCgkJCQkJCWlmICggdXNlVGV4U3RvcmFnZSApIHsKCgkJCQkJCQlpZiAoIGRhdGFSZWFkeSApIHsKCgkJCQkJCQkJc3RhdGUudGV4U3ViSW1hZ2UyRCggX2dsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIGksIDAsIDAsIDAsIGN1YmVJbWFnZVsgaSBdLndpZHRoLCBjdWJlSW1hZ2VbIGkgXS5oZWlnaHQsIGdsRm9ybWF0LCBnbFR5cGUsIGN1YmVJbWFnZVsgaSBdLmRhdGEgKTsKCgkJCQkJCQl9CgoJCQkJCQl9IGVsc2UgewoKCQkJCQkJCXN0YXRlLnRleEltYWdlMkQoIF9nbC5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBpLCAwLCBnbEludGVybmFsRm9ybWF0LCBjdWJlSW1hZ2VbIGkgXS53aWR0aCwgY3ViZUltYWdlWyBpIF0uaGVpZ2h0LCAwLCBnbEZvcm1hdCwgZ2xUeXBlLCBjdWJlSW1hZ2VbIGkgXS5kYXRhICk7CgoJCQkJCQl9CgoJCQkJCQlmb3IgKCBsZXQgaiA9IDA7IGogPCBtaXBtYXBzLmxlbmd0aDsgaiArKyApIHsKCgkJCQkJCQljb25zdCBtaXBtYXAgPSBtaXBtYXBzWyBqIF07CgkJCQkJCQljb25zdCBtaXBtYXBJbWFnZSA9IG1pcG1hcC5pbWFnZVsgaSBdLmltYWdlOwoKCQkJCQkJCWlmICggdXNlVGV4U3RvcmFnZSApIHsKCgkJCQkJCQkJaWYgKCBkYXRhUmVhZHkgKSB7CgoJCQkJCQkJCQlzdGF0ZS50ZXhTdWJJbWFnZTJEKCBfZ2wuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgaSwgaiArIDEsIDAsIDAsIG1pcG1hcEltYWdlLndpZHRoLCBtaXBtYXBJbWFnZS5oZWlnaHQsIGdsRm9ybWF0LCBnbFR5cGUsIG1pcG1hcEltYWdlLmRhdGEgKTsKCgkJCQkJCQkJfQoKCQkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJCXN0YXRlLnRleEltYWdlMkQoIF9nbC5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBpLCBqICsgMSwgZ2xJbnRlcm5hbEZvcm1hdCwgbWlwbWFwSW1hZ2Uud2lkdGgsIG1pcG1hcEltYWdlLmhlaWdodCwgMCwgZ2xGb3JtYXQsIGdsVHlwZSwgbWlwbWFwSW1hZ2UuZGF0YSApOwoKCQkJCQkJCX0KCgkJCQkJCX0KCgkJCQkJfSBlbHNlIHsKCgkJCQkJCWlmICggdXNlVGV4U3RvcmFnZSApIHsKCgkJCQkJCQlpZiAoIGRhdGFSZWFkeSApIHsKCgkJCQkJCQkJc3RhdGUudGV4U3ViSW1hZ2UyRCggX2dsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIGksIDAsIDAsIDAsIGdsRm9ybWF0LCBnbFR5cGUsIGN1YmVJbWFnZVsgaSBdICk7CgoJCQkJCQkJfQoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQlzdGF0ZS50ZXhJbWFnZTJEKCBfZ2wuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgaSwgMCwgZ2xJbnRlcm5hbEZvcm1hdCwgZ2xGb3JtYXQsIGdsVHlwZSwgY3ViZUltYWdlWyBpIF0gKTsKCgkJCQkJCX0KCgkJCQkJCWZvciAoIGxldCBqID0gMDsgaiA8IG1pcG1hcHMubGVuZ3RoOyBqICsrICkgewoKCQkJCQkJCWNvbnN0IG1pcG1hcCA9IG1pcG1hcHNbIGogXTsKCgkJCQkJCQlpZiAoIHVzZVRleFN0b3JhZ2UgKSB7CgoJCQkJCQkJCWlmICggZGF0YVJlYWR5ICkgewoKCQkJCQkJCQkJc3RhdGUudGV4U3ViSW1hZ2UyRCggX2dsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIGksIGogKyAxLCAwLCAwLCBnbEZvcm1hdCwgZ2xUeXBlLCBtaXBtYXAuaW1hZ2VbIGkgXSApOwoKCQkJCQkJCQl9CgoJCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkJc3RhdGUudGV4SW1hZ2UyRCggX2dsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIGksIGogKyAxLCBnbEludGVybmFsRm9ybWF0LCBnbEZvcm1hdCwgZ2xUeXBlLCBtaXBtYXAuaW1hZ2VbIGkgXSApOwoKCQkJCQkJCX0KCgkJCQkJCX0KCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJCWlmICggdGV4dHVyZU5lZWRzR2VuZXJhdGVNaXBtYXBzKCB0ZXh0dXJlLCBzdXBwb3J0c01pcHMgKSApIHsKCgkJCQkvLyBXZSBhc3N1bWUgaW1hZ2VzIGZvciBjdWJlIG1hcCBoYXZlIHRoZSBzYW1lIHNpemUuCgkJCQlnZW5lcmF0ZU1pcG1hcCggX2dsLlRFWFRVUkVfQ1VCRV9NQVAgKTsKCgkJCX0KCgkJCXNvdXJjZVByb3BlcnRpZXMuX192ZXJzaW9uID0gc291cmNlLnZlcnNpb247CgoJCQlpZiAoIHRleHR1cmUub25VcGRhdGUgKSB0ZXh0dXJlLm9uVXBkYXRlKCB0ZXh0dXJlICk7CgoJCX0KCgkJdGV4dHVyZVByb3BlcnRpZXMuX192ZXJzaW9uID0gdGV4dHVyZS52ZXJzaW9uOwoKCX0KCgkvLyBSZW5kZXIgdGFyZ2V0cwoKCS8vIFNldHVwIHN0b3JhZ2UgZm9yIHRhcmdldCB0ZXh0dXJlIGFuZCBiaW5kIGl0IHRvIGNvcnJlY3QgZnJhbWVidWZmZXIKCWZ1bmN0aW9uIHNldHVwRnJhbWVCdWZmZXJUZXh0dXJlKCBmcmFtZWJ1ZmZlciwgcmVuZGVyVGFyZ2V0LCB0ZXh0dXJlLCBhdHRhY2htZW50LCB0ZXh0dXJlVGFyZ2V0LCBsZXZlbCApIHsKCgkJY29uc3QgZ2xGb3JtYXQgPSB1dGlscy5jb252ZXJ0KCB0ZXh0dXJlLmZvcm1hdCwgdGV4dHVyZS5jb2xvclNwYWNlICk7CgkJY29uc3QgZ2xUeXBlID0gdXRpbHMuY29udmVydCggdGV4dHVyZS50eXBlICk7CgkJY29uc3QgZ2xJbnRlcm5hbEZvcm1hdCA9IGdldEludGVybmFsRm9ybWF0KCB0ZXh0dXJlLmludGVybmFsRm9ybWF0LCBnbEZvcm1hdCwgZ2xUeXBlLCB0ZXh0dXJlLmNvbG9yU3BhY2UgKTsKCQljb25zdCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIHJlbmRlclRhcmdldCApOwoKCQlpZiAoICEgcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX2hhc0V4dGVybmFsVGV4dHVyZXMgKSB7CgoJCQljb25zdCB3aWR0aCA9IE1hdGgubWF4KCAxLCByZW5kZXJUYXJnZXQud2lkdGggPj4gbGV2ZWwgKTsKCQkJY29uc3QgaGVpZ2h0ID0gTWF0aC5tYXgoIDEsIHJlbmRlclRhcmdldC5oZWlnaHQgPj4gbGV2ZWwgKTsKCgkJCWlmICggdGV4dHVyZVRhcmdldCA9PT0gX2dsLlRFWFRVUkVfM0QgfHwgdGV4dHVyZVRhcmdldCA9PT0gX2dsLlRFWFRVUkVfMkRfQVJSQVkgKSB7CgoJCQkJc3RhdGUudGV4SW1hZ2UzRCggdGV4dHVyZVRhcmdldCwgbGV2ZWwsIGdsSW50ZXJuYWxGb3JtYXQsIHdpZHRoLCBoZWlnaHQsIHJlbmRlclRhcmdldC5kZXB0aCwgMCwgZ2xGb3JtYXQsIGdsVHlwZSwgbnVsbCApOwoKCQkJfSBlbHNlIHsKCgkJCQlzdGF0ZS50ZXhJbWFnZTJEKCB0ZXh0dXJlVGFyZ2V0LCBsZXZlbCwgZ2xJbnRlcm5hbEZvcm1hdCwgd2lkdGgsIGhlaWdodCwgMCwgZ2xGb3JtYXQsIGdsVHlwZSwgbnVsbCApOwoKCQkJfQoKCQl9CgoJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkZSQU1FQlVGRkVSLCBmcmFtZWJ1ZmZlciApOwoKCQlpZiAoIHVzZU11bHRpc2FtcGxlZFJUVCggcmVuZGVyVGFyZ2V0ICkgKSB7CgoJCQltdWx0aXNhbXBsZWRSVFRFeHQuZnJhbWVidWZmZXJUZXh0dXJlMkRNdWx0aXNhbXBsZUVYVCggX2dsLkZSQU1FQlVGRkVSLCBhdHRhY2htZW50LCB0ZXh0dXJlVGFyZ2V0LCBwcm9wZXJ0aWVzLmdldCggdGV4dHVyZSApLl9fd2ViZ2xUZXh0dXJlLCAwLCBnZXRSZW5kZXJUYXJnZXRTYW1wbGVzKCByZW5kZXJUYXJnZXQgKSApOwoKCQl9IGVsc2UgaWYgKCB0ZXh0dXJlVGFyZ2V0ID09PSBfZ2wuVEVYVFVSRV8yRCB8fCAoIHRleHR1cmVUYXJnZXQgPj0gX2dsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCAmJiB0ZXh0dXJlVGFyZ2V0IDw9IF9nbC5URVhUVVJFX0NVQkVfTUFQX05FR0FUSVZFX1ogKSApIHsgLy8gc2VlICMyNDc1MwoKCQkJX2dsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKCBfZ2wuRlJBTUVCVUZGRVIsIGF0dGFjaG1lbnQsIHRleHR1cmVUYXJnZXQsIHByb3BlcnRpZXMuZ2V0KCB0ZXh0dXJlICkuX193ZWJnbFRleHR1cmUsIGxldmVsICk7CgoJCX0KCgkJc3RhdGUuYmluZEZyYW1lYnVmZmVyKCBfZ2wuRlJBTUVCVUZGRVIsIG51bGwgKTsKCgl9CgoKCS8vIFNldHVwIHN0b3JhZ2UgZm9yIGludGVybmFsIGRlcHRoL3N0ZW5jaWwgYnVmZmVycyBhbmQgYmluZCB0byBjb3JyZWN0IGZyYW1lYnVmZmVyCglmdW5jdGlvbiBzZXR1cFJlbmRlckJ1ZmZlclN0b3JhZ2UoIHJlbmRlcmJ1ZmZlciwgcmVuZGVyVGFyZ2V0LCBpc011bHRpc2FtcGxlICkgewoKCQlfZ2wuYmluZFJlbmRlcmJ1ZmZlciggX2dsLlJFTkRFUkJVRkZFUiwgcmVuZGVyYnVmZmVyICk7CgoJCWlmICggcmVuZGVyVGFyZ2V0LmRlcHRoQnVmZmVyICYmICEgcmVuZGVyVGFyZ2V0LnN0ZW5jaWxCdWZmZXIgKSB7CgoJCQlsZXQgZ2xJbnRlcm5hbEZvcm1hdCA9ICggaXNXZWJHTDIgPT09IHRydWUgKSA/IF9nbC5ERVBUSF9DT01QT05FTlQyNCA6IF9nbC5ERVBUSF9DT01QT05FTlQxNjsKCgkJCWlmICggaXNNdWx0aXNhbXBsZSB8fCB1c2VNdWx0aXNhbXBsZWRSVFQoIHJlbmRlclRhcmdldCApICkgewoKCQkJCWNvbnN0IGRlcHRoVGV4dHVyZSA9IHJlbmRlclRhcmdldC5kZXB0aFRleHR1cmU7CgoJCQkJaWYgKCBkZXB0aFRleHR1cmUgJiYgZGVwdGhUZXh0dXJlLmlzRGVwdGhUZXh0dXJlICkgewoKCQkJCQlpZiAoIGRlcHRoVGV4dHVyZS50eXBlID09PSBGbG9hdFR5cGUgKSB7CgoJCQkJCQlnbEludGVybmFsRm9ybWF0ID0gX2dsLkRFUFRIX0NPTVBPTkVOVDMyRjsKCgkJCQkJfSBlbHNlIGlmICggZGVwdGhUZXh0dXJlLnR5cGUgPT09IFVuc2lnbmVkSW50VHlwZSApIHsKCgkJCQkJCWdsSW50ZXJuYWxGb3JtYXQgPSBfZ2wuREVQVEhfQ09NUE9ORU5UMjQ7CgoJCQkJCX0KCgkJCQl9CgoJCQkJY29uc3Qgc2FtcGxlcyA9IGdldFJlbmRlclRhcmdldFNhbXBsZXMoIHJlbmRlclRhcmdldCApOwoKCQkJCWlmICggdXNlTXVsdGlzYW1wbGVkUlRUKCByZW5kZXJUYXJnZXQgKSApIHsKCgkJCQkJbXVsdGlzYW1wbGVkUlRURXh0LnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZUVYVCggX2dsLlJFTkRFUkJVRkZFUiwgc2FtcGxlcywgZ2xJbnRlcm5hbEZvcm1hdCwgcmVuZGVyVGFyZ2V0LndpZHRoLCByZW5kZXJUYXJnZXQuaGVpZ2h0ICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJX2dsLnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZSggX2dsLlJFTkRFUkJVRkZFUiwgc2FtcGxlcywgZ2xJbnRlcm5hbEZvcm1hdCwgcmVuZGVyVGFyZ2V0LndpZHRoLCByZW5kZXJUYXJnZXQuaGVpZ2h0ICk7CgoJCQkJfQoKCQkJfSBlbHNlIHsKCgkJCQlfZ2wucmVuZGVyYnVmZmVyU3RvcmFnZSggX2dsLlJFTkRFUkJVRkZFUiwgZ2xJbnRlcm5hbEZvcm1hdCwgcmVuZGVyVGFyZ2V0LndpZHRoLCByZW5kZXJUYXJnZXQuaGVpZ2h0ICk7CgoJCQl9CgoJCQlfZ2wuZnJhbWVidWZmZXJSZW5kZXJidWZmZXIoIF9nbC5GUkFNRUJVRkZFUiwgX2dsLkRFUFRIX0FUVEFDSE1FTlQsIF9nbC5SRU5ERVJCVUZGRVIsIHJlbmRlcmJ1ZmZlciApOwoKCQl9IGVsc2UgaWYgKCByZW5kZXJUYXJnZXQuZGVwdGhCdWZmZXIgJiYgcmVuZGVyVGFyZ2V0LnN0ZW5jaWxCdWZmZXIgKSB7CgoJCQljb25zdCBzYW1wbGVzID0gZ2V0UmVuZGVyVGFyZ2V0U2FtcGxlcyggcmVuZGVyVGFyZ2V0ICk7CgoJCQlpZiAoIGlzTXVsdGlzYW1wbGUgJiYgdXNlTXVsdGlzYW1wbGVkUlRUKCByZW5kZXJUYXJnZXQgKSA9PT0gZmFsc2UgKSB7CgoJCQkJX2dsLnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZSggX2dsLlJFTkRFUkJVRkZFUiwgc2FtcGxlcywgX2dsLkRFUFRIMjRfU1RFTkNJTDgsIHJlbmRlclRhcmdldC53aWR0aCwgcmVuZGVyVGFyZ2V0LmhlaWdodCApOwoKCQkJfSBlbHNlIGlmICggdXNlTXVsdGlzYW1wbGVkUlRUKCByZW5kZXJUYXJnZXQgKSApIHsKCgkJCQltdWx0aXNhbXBsZWRSVFRFeHQucmVuZGVyYnVmZmVyU3RvcmFnZU11bHRpc2FtcGxlRVhUKCBfZ2wuUkVOREVSQlVGRkVSLCBzYW1wbGVzLCBfZ2wuREVQVEgyNF9TVEVOQ0lMOCwgcmVuZGVyVGFyZ2V0LndpZHRoLCByZW5kZXJUYXJnZXQuaGVpZ2h0ICk7CgoJCQl9IGVsc2UgewoKCQkJCV9nbC5yZW5kZXJidWZmZXJTdG9yYWdlKCBfZ2wuUkVOREVSQlVGRkVSLCBfZ2wuREVQVEhfU1RFTkNJTCwgcmVuZGVyVGFyZ2V0LndpZHRoLCByZW5kZXJUYXJnZXQuaGVpZ2h0ICk7CgoJCQl9CgoKCQkJX2dsLmZyYW1lYnVmZmVyUmVuZGVyYnVmZmVyKCBfZ2wuRlJBTUVCVUZGRVIsIF9nbC5ERVBUSF9TVEVOQ0lMX0FUVEFDSE1FTlQsIF9nbC5SRU5ERVJCVUZGRVIsIHJlbmRlcmJ1ZmZlciApOwoKCQl9IGVsc2UgewoKCQkJY29uc3QgdGV4dHVyZXMgPSByZW5kZXJUYXJnZXQuaXNXZWJHTE11bHRpcGxlUmVuZGVyVGFyZ2V0cyA9PT0gdHJ1ZSA/IHJlbmRlclRhcmdldC50ZXh0dXJlIDogWyByZW5kZXJUYXJnZXQudGV4dHVyZSBdOwoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgdGV4dHVyZXMubGVuZ3RoOyBpICsrICkgewoKCQkJCWNvbnN0IHRleHR1cmUgPSB0ZXh0dXJlc1sgaSBdOwoKCQkJCWNvbnN0IGdsRm9ybWF0ID0gdXRpbHMuY29udmVydCggdGV4dHVyZS5mb3JtYXQsIHRleHR1cmUuY29sb3JTcGFjZSApOwoJCQkJY29uc3QgZ2xUeXBlID0gdXRpbHMuY29udmVydCggdGV4dHVyZS50eXBlICk7CgkJCQljb25zdCBnbEludGVybmFsRm9ybWF0ID0gZ2V0SW50ZXJuYWxGb3JtYXQoIHRleHR1cmUuaW50ZXJuYWxGb3JtYXQsIGdsRm9ybWF0LCBnbFR5cGUsIHRleHR1cmUuY29sb3JTcGFjZSApOwoJCQkJY29uc3Qgc2FtcGxlcyA9IGdldFJlbmRlclRhcmdldFNhbXBsZXMoIHJlbmRlclRhcmdldCApOwoKCQkJCWlmICggaXNNdWx0aXNhbXBsZSAmJiB1c2VNdWx0aXNhbXBsZWRSVFQoIHJlbmRlclRhcmdldCApID09PSBmYWxzZSApIHsKCgkJCQkJX2dsLnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZSggX2dsLlJFTkRFUkJVRkZFUiwgc2FtcGxlcywgZ2xJbnRlcm5hbEZvcm1hdCwgcmVuZGVyVGFyZ2V0LndpZHRoLCByZW5kZXJUYXJnZXQuaGVpZ2h0ICk7CgoJCQkJfSBlbHNlIGlmICggdXNlTXVsdGlzYW1wbGVkUlRUKCByZW5kZXJUYXJnZXQgKSApIHsKCgkJCQkJbXVsdGlzYW1wbGVkUlRURXh0LnJlbmRlcmJ1ZmZlclN0b3JhZ2VNdWx0aXNhbXBsZUVYVCggX2dsLlJFTkRFUkJVRkZFUiwgc2FtcGxlcywgZ2xJbnRlcm5hbEZvcm1hdCwgcmVuZGVyVGFyZ2V0LndpZHRoLCByZW5kZXJUYXJnZXQuaGVpZ2h0ICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJX2dsLnJlbmRlcmJ1ZmZlclN0b3JhZ2UoIF9nbC5SRU5ERVJCVUZGRVIsIGdsSW50ZXJuYWxGb3JtYXQsIHJlbmRlclRhcmdldC53aWR0aCwgcmVuZGVyVGFyZ2V0LmhlaWdodCApOwoKCQkJCX0KCgkJCX0KCgkJfQoKCQlfZ2wuYmluZFJlbmRlcmJ1ZmZlciggX2dsLlJFTkRFUkJVRkZFUiwgbnVsbCApOwoKCX0KCgkvLyBTZXR1cCByZXNvdXJjZXMgZm9yIGEgRGVwdGggVGV4dHVyZSBmb3IgYSBGQk8gKG5lZWRzIGFuIGV4dGVuc2lvbikKCWZ1bmN0aW9uIHNldHVwRGVwdGhUZXh0dXJlKCBmcmFtZWJ1ZmZlciwgcmVuZGVyVGFyZ2V0ICkgewoKCQljb25zdCBpc0N1YmUgPSAoIHJlbmRlclRhcmdldCAmJiByZW5kZXJUYXJnZXQuaXNXZWJHTEN1YmVSZW5kZXJUYXJnZXQgKTsKCQlpZiAoIGlzQ3ViZSApIHRocm93IG5ldyBFcnJvciggJ0RlcHRoIFRleHR1cmUgd2l0aCBjdWJlIHJlbmRlciB0YXJnZXRzIGlzIG5vdCBzdXBwb3J0ZWQnICk7CgoJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkZSQU1FQlVGRkVSLCBmcmFtZWJ1ZmZlciApOwoKCQlpZiAoICEgKCByZW5kZXJUYXJnZXQuZGVwdGhUZXh0dXJlICYmIHJlbmRlclRhcmdldC5kZXB0aFRleHR1cmUuaXNEZXB0aFRleHR1cmUgKSApIHsKCgkJCXRocm93IG5ldyBFcnJvciggJ3JlbmRlclRhcmdldC5kZXB0aFRleHR1cmUgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBUSFJFRS5EZXB0aFRleHR1cmUnICk7CgoJCX0KCgkJLy8gdXBsb2FkIGFuIGVtcHR5IGRlcHRoIHRleHR1cmUgd2l0aCBmcmFtZWJ1ZmZlciBzaXplCgkJaWYgKCAhIHByb3BlcnRpZXMuZ2V0KCByZW5kZXJUYXJnZXQuZGVwdGhUZXh0dXJlICkuX193ZWJnbFRleHR1cmUgfHwKCQkJCXJlbmRlclRhcmdldC5kZXB0aFRleHR1cmUuaW1hZ2Uud2lkdGggIT09IHJlbmRlclRhcmdldC53aWR0aCB8fAoJCQkJcmVuZGVyVGFyZ2V0LmRlcHRoVGV4dHVyZS5pbWFnZS5oZWlnaHQgIT09IHJlbmRlclRhcmdldC5oZWlnaHQgKSB7CgoJCQlyZW5kZXJUYXJnZXQuZGVwdGhUZXh0dXJlLmltYWdlLndpZHRoID0gcmVuZGVyVGFyZ2V0LndpZHRoOwoJCQlyZW5kZXJUYXJnZXQuZGVwdGhUZXh0dXJlLmltYWdlLmhlaWdodCA9IHJlbmRlclRhcmdldC5oZWlnaHQ7CgkJCXJlbmRlclRhcmdldC5kZXB0aFRleHR1cmUubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQl9CgoJCXNldFRleHR1cmUyRCggcmVuZGVyVGFyZ2V0LmRlcHRoVGV4dHVyZSwgMCApOwoKCQljb25zdCB3ZWJnbERlcHRoVGV4dHVyZSA9IHByb3BlcnRpZXMuZ2V0KCByZW5kZXJUYXJnZXQuZGVwdGhUZXh0dXJlICkuX193ZWJnbFRleHR1cmU7CgkJY29uc3Qgc2FtcGxlcyA9IGdldFJlbmRlclRhcmdldFNhbXBsZXMoIHJlbmRlclRhcmdldCApOwoKCQlpZiAoIHJlbmRlclRhcmdldC5kZXB0aFRleHR1cmUuZm9ybWF0ID09PSBEZXB0aEZvcm1hdCApIHsKCgkJCWlmICggdXNlTXVsdGlzYW1wbGVkUlRUKCByZW5kZXJUYXJnZXQgKSApIHsKCgkJCQltdWx0aXNhbXBsZWRSVFRFeHQuZnJhbWVidWZmZXJUZXh0dXJlMkRNdWx0aXNhbXBsZUVYVCggX2dsLkZSQU1FQlVGRkVSLCBfZ2wuREVQVEhfQVRUQUNITUVOVCwgX2dsLlRFWFRVUkVfMkQsIHdlYmdsRGVwdGhUZXh0dXJlLCAwLCBzYW1wbGVzICk7CgoJCQl9IGVsc2UgewoKCQkJCV9nbC5mcmFtZWJ1ZmZlclRleHR1cmUyRCggX2dsLkZSQU1FQlVGRkVSLCBfZ2wuREVQVEhfQVRUQUNITUVOVCwgX2dsLlRFWFRVUkVfMkQsIHdlYmdsRGVwdGhUZXh0dXJlLCAwICk7CgoJCQl9CgoJCX0gZWxzZSBpZiAoIHJlbmRlclRhcmdldC5kZXB0aFRleHR1cmUuZm9ybWF0ID09PSBEZXB0aFN0ZW5jaWxGb3JtYXQgKSB7CgoJCQlpZiAoIHVzZU11bHRpc2FtcGxlZFJUVCggcmVuZGVyVGFyZ2V0ICkgKSB7CgoJCQkJbXVsdGlzYW1wbGVkUlRURXh0LmZyYW1lYnVmZmVyVGV4dHVyZTJETXVsdGlzYW1wbGVFWFQoIF9nbC5GUkFNRUJVRkZFUiwgX2dsLkRFUFRIX1NURU5DSUxfQVRUQUNITUVOVCwgX2dsLlRFWFRVUkVfMkQsIHdlYmdsRGVwdGhUZXh0dXJlLCAwLCBzYW1wbGVzICk7CgoJCQl9IGVsc2UgewoKCQkJCV9nbC5mcmFtZWJ1ZmZlclRleHR1cmUyRCggX2dsLkZSQU1FQlVGRkVSLCBfZ2wuREVQVEhfU1RFTkNJTF9BVFRBQ0hNRU5ULCBfZ2wuVEVYVFVSRV8yRCwgd2ViZ2xEZXB0aFRleHR1cmUsIDAgKTsKCgkJCX0KCgkJfSBlbHNlIHsKCgkJCXRocm93IG5ldyBFcnJvciggJ1Vua25vd24gZGVwdGhUZXh0dXJlIGZvcm1hdCcgKTsKCgkJfQoKCX0KCgkvLyBTZXR1cCBHTCByZXNvdXJjZXMgZm9yIGEgbm9uLXRleHR1cmUgZGVwdGggYnVmZmVyCglmdW5jdGlvbiBzZXR1cERlcHRoUmVuZGVyYnVmZmVyKCByZW5kZXJUYXJnZXQgKSB7CgoJCWNvbnN0IHJlbmRlclRhcmdldFByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggcmVuZGVyVGFyZ2V0ICk7CgkJY29uc3QgaXNDdWJlID0gKCByZW5kZXJUYXJnZXQuaXNXZWJHTEN1YmVSZW5kZXJUYXJnZXQgPT09IHRydWUgKTsKCgkJaWYgKCByZW5kZXJUYXJnZXQuZGVwdGhUZXh0dXJlICYmICEgcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX2F1dG9BbGxvY2F0ZURlcHRoQnVmZmVyICkgewoKCQkJaWYgKCBpc0N1YmUgKSB0aHJvdyBuZXcgRXJyb3IoICd0YXJnZXQuZGVwdGhUZXh0dXJlIG5vdCBzdXBwb3J0ZWQgaW4gQ3ViZSByZW5kZXIgdGFyZ2V0cycgKTsKCgkJCXNldHVwRGVwdGhUZXh0dXJlKCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlciwgcmVuZGVyVGFyZ2V0ICk7CgoJCX0gZWxzZSB7CgoJCQlpZiAoIGlzQ3ViZSApIHsKCgkJCQlyZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xEZXB0aGJ1ZmZlciA9IFtdOwoKCQkJCWZvciAoIGxldCBpID0gMDsgaSA8IDY7IGkgKysgKSB7CgoJCQkJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkZSQU1FQlVGRkVSLCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlclsgaSBdICk7CgkJCQkJcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRGVwdGhidWZmZXJbIGkgXSA9IF9nbC5jcmVhdGVSZW5kZXJidWZmZXIoKTsKCQkJCQlzZXR1cFJlbmRlckJ1ZmZlclN0b3JhZ2UoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbERlcHRoYnVmZmVyWyBpIF0sIHJlbmRlclRhcmdldCwgZmFsc2UgKTsKCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkZSQU1FQlVGRkVSLCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlciApOwoJCQkJcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRGVwdGhidWZmZXIgPSBfZ2wuY3JlYXRlUmVuZGVyYnVmZmVyKCk7CgkJCQlzZXR1cFJlbmRlckJ1ZmZlclN0b3JhZ2UoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbERlcHRoYnVmZmVyLCByZW5kZXJUYXJnZXQsIGZhbHNlICk7CgoJCQl9CgoJCX0KCgkJc3RhdGUuYmluZEZyYW1lYnVmZmVyKCBfZ2wuRlJBTUVCVUZGRVIsIG51bGwgKTsKCgl9CgoJLy8gcmViaW5kIGZyYW1lYnVmZmVyIHdpdGggZXh0ZXJuYWwgdGV4dHVyZXMKCWZ1bmN0aW9uIHJlYmluZFRleHR1cmVzKCByZW5kZXJUYXJnZXQsIGNvbG9yVGV4dHVyZSwgZGVwdGhUZXh0dXJlICkgewoKCQljb25zdCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIHJlbmRlclRhcmdldCApOwoKCQlpZiAoIGNvbG9yVGV4dHVyZSAhPT0gdW5kZWZpbmVkICkgewoKCQkJc2V0dXBGcmFtZUJ1ZmZlclRleHR1cmUoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbEZyYW1lYnVmZmVyLCByZW5kZXJUYXJnZXQsIHJlbmRlclRhcmdldC50ZXh0dXJlLCBfZ2wuQ09MT1JfQVRUQUNITUVOVDAsIF9nbC5URVhUVVJFXzJELCAwICk7CgoJCX0KCgkJaWYgKCBkZXB0aFRleHR1cmUgIT09IHVuZGVmaW5lZCApIHsKCgkJCXNldHVwRGVwdGhSZW5kZXJidWZmZXIoIHJlbmRlclRhcmdldCApOwoKCQl9CgoJfQoKCS8vIFNldCB1cCBHTCByZXNvdXJjZXMgZm9yIHRoZSByZW5kZXIgdGFyZ2V0CglmdW5jdGlvbiBzZXR1cFJlbmRlclRhcmdldCggcmVuZGVyVGFyZ2V0ICkgewoKCQljb25zdCB0ZXh0dXJlID0gcmVuZGVyVGFyZ2V0LnRleHR1cmU7CgoJCWNvbnN0IHJlbmRlclRhcmdldFByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggcmVuZGVyVGFyZ2V0ICk7CgkJY29uc3QgdGV4dHVyZVByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggdGV4dHVyZSApOwoKCQlyZW5kZXJUYXJnZXQuYWRkRXZlbnRMaXN0ZW5lciggJ2Rpc3Bvc2UnLCBvblJlbmRlclRhcmdldERpc3Bvc2UgKTsKCgkJaWYgKCByZW5kZXJUYXJnZXQuaXNXZWJHTE11bHRpcGxlUmVuZGVyVGFyZ2V0cyAhPT0gdHJ1ZSApIHsKCgkJCWlmICggdGV4dHVyZVByb3BlcnRpZXMuX193ZWJnbFRleHR1cmUgPT09IHVuZGVmaW5lZCApIHsKCgkJCQl0ZXh0dXJlUHJvcGVydGllcy5fX3dlYmdsVGV4dHVyZSA9IF9nbC5jcmVhdGVUZXh0dXJlKCk7CgoJCQl9CgoJCQl0ZXh0dXJlUHJvcGVydGllcy5fX3ZlcnNpb24gPSB0ZXh0dXJlLnZlcnNpb247CgkJCWluZm8ubWVtb3J5LnRleHR1cmVzICsrOwoKCQl9CgoJCWNvbnN0IGlzQ3ViZSA9ICggcmVuZGVyVGFyZ2V0LmlzV2ViR0xDdWJlUmVuZGVyVGFyZ2V0ID09PSB0cnVlICk7CgkJY29uc3QgaXNNdWx0aXBsZVJlbmRlclRhcmdldHMgPSAoIHJlbmRlclRhcmdldC5pc1dlYkdMTXVsdGlwbGVSZW5kZXJUYXJnZXRzID09PSB0cnVlICk7CgkJY29uc3Qgc3VwcG9ydHNNaXBzID0gaXNQb3dlck9mVHdvJDEoIHJlbmRlclRhcmdldCApIHx8IGlzV2ViR0wyOwoKCQkvLyBTZXR1cCBmcmFtZWJ1ZmZlcgoKCQlpZiAoIGlzQ3ViZSApIHsKCgkJCXJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbEZyYW1lYnVmZmVyID0gW107CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA2OyBpICsrICkgewoKCQkJCWlmICggaXNXZWJHTDIgJiYgdGV4dHVyZS5taXBtYXBzICYmIHRleHR1cmUubWlwbWFwcy5sZW5ndGggPiAwICkgewoKCQkJCQlyZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlclsgaSBdID0gW107CgoJCQkJCWZvciAoIGxldCBsZXZlbCA9IDA7IGxldmVsIDwgdGV4dHVyZS5taXBtYXBzLmxlbmd0aDsgbGV2ZWwgKysgKSB7CgoJCQkJCQlyZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlclsgaSBdWyBsZXZlbCBdID0gX2dsLmNyZWF0ZUZyYW1lYnVmZmVyKCk7CgoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQlyZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlclsgaSBdID0gX2dsLmNyZWF0ZUZyYW1lYnVmZmVyKCk7CgoJCQkJfQoKCQkJfQoKCQl9IGVsc2UgewoKCQkJaWYgKCBpc1dlYkdMMiAmJiB0ZXh0dXJlLm1pcG1hcHMgJiYgdGV4dHVyZS5taXBtYXBzLmxlbmd0aCA+IDAgKSB7CgoJCQkJcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRnJhbWVidWZmZXIgPSBbXTsKCgkJCQlmb3IgKCBsZXQgbGV2ZWwgPSAwOyBsZXZlbCA8IHRleHR1cmUubWlwbWFwcy5sZW5ndGg7IGxldmVsICsrICkgewoKCQkJCQlyZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlclsgbGV2ZWwgXSA9IF9nbC5jcmVhdGVGcmFtZWJ1ZmZlcigpOwoKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRnJhbWVidWZmZXIgPSBfZ2wuY3JlYXRlRnJhbWVidWZmZXIoKTsKCgkJCX0KCgkJCWlmICggaXNNdWx0aXBsZVJlbmRlclRhcmdldHMgKSB7CgoJCQkJaWYgKCBjYXBhYmlsaXRpZXMuZHJhd0J1ZmZlcnMgKSB7CgoJCQkJCWNvbnN0IHRleHR1cmVzID0gcmVuZGVyVGFyZ2V0LnRleHR1cmU7CgoJCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSB0ZXh0dXJlcy5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCQkJCWNvbnN0IGF0dGFjaG1lbnRQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIHRleHR1cmVzWyBpIF0gKTsKCgkJCQkJCWlmICggYXR0YWNobWVudFByb3BlcnRpZXMuX193ZWJnbFRleHR1cmUgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkJCQlhdHRhY2htZW50UHJvcGVydGllcy5fX3dlYmdsVGV4dHVyZSA9IF9nbC5jcmVhdGVUZXh0dXJlKCk7CgoJCQkJCQkJaW5mby5tZW1vcnkudGV4dHVyZXMgKys7CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQljb25zb2xlLndhcm4oICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBXZWJHTE11bHRpcGxlUmVuZGVyVGFyZ2V0cyBjYW4gb25seSBiZSB1c2VkIHdpdGggV2ViR0wyIG9yIFdFQkdMX2RyYXdfYnVmZmVycyBleHRlbnNpb24uJyApOwoKCQkJCX0KCgkJCX0KCgkJCWlmICggKCBpc1dlYkdMMiAmJiByZW5kZXJUYXJnZXQuc2FtcGxlcyA+IDAgKSAmJiB1c2VNdWx0aXNhbXBsZWRSVFQoIHJlbmRlclRhcmdldCApID09PSBmYWxzZSApIHsKCgkJCQljb25zdCB0ZXh0dXJlcyA9IGlzTXVsdGlwbGVSZW5kZXJUYXJnZXRzID8gdGV4dHVyZSA6IFsgdGV4dHVyZSBdOwoKCQkJCXJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyID0gX2dsLmNyZWF0ZUZyYW1lYnVmZmVyKCk7CgkJCQlyZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xDb2xvclJlbmRlcmJ1ZmZlciA9IFtdOwoKCQkJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkZSQU1FQlVGRkVSLCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xNdWx0aXNhbXBsZWRGcmFtZWJ1ZmZlciApOwoKCQkJCWZvciAoIGxldCBpID0gMDsgaSA8IHRleHR1cmVzLmxlbmd0aDsgaSArKyApIHsKCgkJCQkJY29uc3QgdGV4dHVyZSA9IHRleHR1cmVzWyBpIF07CgkJCQkJcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsQ29sb3JSZW5kZXJidWZmZXJbIGkgXSA9IF9nbC5jcmVhdGVSZW5kZXJidWZmZXIoKTsKCgkJCQkJX2dsLmJpbmRSZW5kZXJidWZmZXIoIF9nbC5SRU5ERVJCVUZGRVIsIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbENvbG9yUmVuZGVyYnVmZmVyWyBpIF0gKTsKCgkJCQkJY29uc3QgZ2xGb3JtYXQgPSB1dGlscy5jb252ZXJ0KCB0ZXh0dXJlLmZvcm1hdCwgdGV4dHVyZS5jb2xvclNwYWNlICk7CgkJCQkJY29uc3QgZ2xUeXBlID0gdXRpbHMuY29udmVydCggdGV4dHVyZS50eXBlICk7CgkJCQkJY29uc3QgZ2xJbnRlcm5hbEZvcm1hdCA9IGdldEludGVybmFsRm9ybWF0KCB0ZXh0dXJlLmludGVybmFsRm9ybWF0LCBnbEZvcm1hdCwgZ2xUeXBlLCB0ZXh0dXJlLmNvbG9yU3BhY2UsIHJlbmRlclRhcmdldC5pc1hSUmVuZGVyVGFyZ2V0ID09PSB0cnVlICk7CgkJCQkJY29uc3Qgc2FtcGxlcyA9IGdldFJlbmRlclRhcmdldFNhbXBsZXMoIHJlbmRlclRhcmdldCApOwoJCQkJCV9nbC5yZW5kZXJidWZmZXJTdG9yYWdlTXVsdGlzYW1wbGUoIF9nbC5SRU5ERVJCVUZGRVIsIHNhbXBsZXMsIGdsSW50ZXJuYWxGb3JtYXQsIHJlbmRlclRhcmdldC53aWR0aCwgcmVuZGVyVGFyZ2V0LmhlaWdodCApOwoKCQkJCQlfZ2wuZnJhbWVidWZmZXJSZW5kZXJidWZmZXIoIF9nbC5GUkFNRUJVRkZFUiwgX2dsLkNPTE9SX0FUVEFDSE1FTlQwICsgaSwgX2dsLlJFTkRFUkJVRkZFUiwgcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsQ29sb3JSZW5kZXJidWZmZXJbIGkgXSApOwoKCQkJCX0KCgkJCQlfZ2wuYmluZFJlbmRlcmJ1ZmZlciggX2dsLlJFTkRFUkJVRkZFUiwgbnVsbCApOwoKCQkJCWlmICggcmVuZGVyVGFyZ2V0LmRlcHRoQnVmZmVyICkgewoKCQkJCQlyZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xEZXB0aFJlbmRlcmJ1ZmZlciA9IF9nbC5jcmVhdGVSZW5kZXJidWZmZXIoKTsKCQkJCQlzZXR1cFJlbmRlckJ1ZmZlclN0b3JhZ2UoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbERlcHRoUmVuZGVyYnVmZmVyLCByZW5kZXJUYXJnZXQsIHRydWUgKTsKCgkJCQl9CgoJCQkJc3RhdGUuYmluZEZyYW1lYnVmZmVyKCBfZ2wuRlJBTUVCVUZGRVIsIG51bGwgKTsKCgkJCX0KCgkJfQoKCQkvLyBTZXR1cCBjb2xvciBidWZmZXIKCgkJaWYgKCBpc0N1YmUgKSB7CgoJCQlzdGF0ZS5iaW5kVGV4dHVyZSggX2dsLlRFWFRVUkVfQ1VCRV9NQVAsIHRleHR1cmVQcm9wZXJ0aWVzLl9fd2ViZ2xUZXh0dXJlICk7CgkJCXNldFRleHR1cmVQYXJhbWV0ZXJzKCBfZ2wuVEVYVFVSRV9DVUJFX01BUCwgdGV4dHVyZSwgc3VwcG9ydHNNaXBzICk7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA2OyBpICsrICkgewoKCQkJCWlmICggaXNXZWJHTDIgJiYgdGV4dHVyZS5taXBtYXBzICYmIHRleHR1cmUubWlwbWFwcy5sZW5ndGggPiAwICkgewoKCQkJCQlmb3IgKCBsZXQgbGV2ZWwgPSAwOyBsZXZlbCA8IHRleHR1cmUubWlwbWFwcy5sZW5ndGg7IGxldmVsICsrICkgewoKCQkJCQkJc2V0dXBGcmFtZUJ1ZmZlclRleHR1cmUoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbEZyYW1lYnVmZmVyWyBpIF1bIGxldmVsIF0sIHJlbmRlclRhcmdldCwgdGV4dHVyZSwgX2dsLkNPTE9SX0FUVEFDSE1FTlQwLCBfZ2wuVEVYVFVSRV9DVUJFX01BUF9QT1NJVElWRV9YICsgaSwgbGV2ZWwgKTsKCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCXNldHVwRnJhbWVCdWZmZXJUZXh0dXJlKCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlclsgaSBdLCByZW5kZXJUYXJnZXQsIHRleHR1cmUsIF9nbC5DT0xPUl9BVFRBQ0hNRU5UMCwgX2dsLlRFWFRVUkVfQ1VCRV9NQVBfUE9TSVRJVkVfWCArIGksIDAgKTsKCgkJCQl9CgoJCQl9CgoJCQlpZiAoIHRleHR1cmVOZWVkc0dlbmVyYXRlTWlwbWFwcyggdGV4dHVyZSwgc3VwcG9ydHNNaXBzICkgKSB7CgoJCQkJZ2VuZXJhdGVNaXBtYXAoIF9nbC5URVhUVVJFX0NVQkVfTUFQICk7CgoJCQl9CgoJCQlzdGF0ZS51bmJpbmRUZXh0dXJlKCk7CgoJCX0gZWxzZSBpZiAoIGlzTXVsdGlwbGVSZW5kZXJUYXJnZXRzICkgewoKCQkJY29uc3QgdGV4dHVyZXMgPSByZW5kZXJUYXJnZXQudGV4dHVyZTsKCgkJCWZvciAoIGxldCBpID0gMCwgaWwgPSB0ZXh0dXJlcy5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCQljb25zdCBhdHRhY2htZW50ID0gdGV4dHVyZXNbIGkgXTsKCQkJCWNvbnN0IGF0dGFjaG1lbnRQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIGF0dGFjaG1lbnQgKTsKCgkJCQlzdGF0ZS5iaW5kVGV4dHVyZSggX2dsLlRFWFRVUkVfMkQsIGF0dGFjaG1lbnRQcm9wZXJ0aWVzLl9fd2ViZ2xUZXh0dXJlICk7CgkJCQlzZXRUZXh0dXJlUGFyYW1ldGVycyggX2dsLlRFWFRVUkVfMkQsIGF0dGFjaG1lbnQsIHN1cHBvcnRzTWlwcyApOwoJCQkJc2V0dXBGcmFtZUJ1ZmZlclRleHR1cmUoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbEZyYW1lYnVmZmVyLCByZW5kZXJUYXJnZXQsIGF0dGFjaG1lbnQsIF9nbC5DT0xPUl9BVFRBQ0hNRU5UMCArIGksIF9nbC5URVhUVVJFXzJELCAwICk7CgoJCQkJaWYgKCB0ZXh0dXJlTmVlZHNHZW5lcmF0ZU1pcG1hcHMoIGF0dGFjaG1lbnQsIHN1cHBvcnRzTWlwcyApICkgewoKCQkJCQlnZW5lcmF0ZU1pcG1hcCggX2dsLlRFWFRVUkVfMkQgKTsKCgkJCQl9CgoJCQl9CgoJCQlzdGF0ZS51bmJpbmRUZXh0dXJlKCk7CgoJCX0gZWxzZSB7CgoJCQlsZXQgZ2xUZXh0dXJlVHlwZSA9IF9nbC5URVhUVVJFXzJEOwoKCQkJaWYgKCByZW5kZXJUYXJnZXQuaXNXZWJHTDNEUmVuZGVyVGFyZ2V0IHx8IHJlbmRlclRhcmdldC5pc1dlYkdMQXJyYXlSZW5kZXJUYXJnZXQgKSB7CgoJCQkJaWYgKCBpc1dlYkdMMiApIHsKCgkJCQkJZ2xUZXh0dXJlVHlwZSA9IHJlbmRlclRhcmdldC5pc1dlYkdMM0RSZW5kZXJUYXJnZXQgPyBfZ2wuVEVYVFVSRV8zRCA6IF9nbC5URVhUVVJFXzJEX0FSUkFZOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFRleHR1cmVzOiBUSFJFRS5EYXRhM0RUZXh0dXJlIGFuZCBUSFJFRS5EYXRhQXJyYXlUZXh0dXJlIG9ubHkgc3VwcG9ydGVkIHdpdGggV2ViR0wyLicgKTsKCgkJCQl9CgoJCQl9CgoJCQlzdGF0ZS5iaW5kVGV4dHVyZSggZ2xUZXh0dXJlVHlwZSwgdGV4dHVyZVByb3BlcnRpZXMuX193ZWJnbFRleHR1cmUgKTsKCQkJc2V0VGV4dHVyZVBhcmFtZXRlcnMoIGdsVGV4dHVyZVR5cGUsIHRleHR1cmUsIHN1cHBvcnRzTWlwcyApOwoKCQkJaWYgKCBpc1dlYkdMMiAmJiB0ZXh0dXJlLm1pcG1hcHMgJiYgdGV4dHVyZS5taXBtYXBzLmxlbmd0aCA+IDAgKSB7CgoJCQkJZm9yICggbGV0IGxldmVsID0gMDsgbGV2ZWwgPCB0ZXh0dXJlLm1pcG1hcHMubGVuZ3RoOyBsZXZlbCArKyApIHsKCgkJCQkJc2V0dXBGcmFtZUJ1ZmZlclRleHR1cmUoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbEZyYW1lYnVmZmVyWyBsZXZlbCBdLCByZW5kZXJUYXJnZXQsIHRleHR1cmUsIF9nbC5DT0xPUl9BVFRBQ0hNRU5UMCwgZ2xUZXh0dXJlVHlwZSwgbGV2ZWwgKTsKCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCXNldHVwRnJhbWVCdWZmZXJUZXh0dXJlKCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlciwgcmVuZGVyVGFyZ2V0LCB0ZXh0dXJlLCBfZ2wuQ09MT1JfQVRUQUNITUVOVDAsIGdsVGV4dHVyZVR5cGUsIDAgKTsKCgkJCX0KCgkJCWlmICggdGV4dHVyZU5lZWRzR2VuZXJhdGVNaXBtYXBzKCB0ZXh0dXJlLCBzdXBwb3J0c01pcHMgKSApIHsKCgkJCQlnZW5lcmF0ZU1pcG1hcCggZ2xUZXh0dXJlVHlwZSApOwoKCQkJfQoKCQkJc3RhdGUudW5iaW5kVGV4dHVyZSgpOwoKCQl9CgoJCS8vIFNldHVwIGRlcHRoIGFuZCBzdGVuY2lsIGJ1ZmZlcnMKCgkJaWYgKCByZW5kZXJUYXJnZXQuZGVwdGhCdWZmZXIgKSB7CgoJCQlzZXR1cERlcHRoUmVuZGVyYnVmZmVyKCByZW5kZXJUYXJnZXQgKTsKCgkJfQoKCX0KCglmdW5jdGlvbiB1cGRhdGVSZW5kZXJUYXJnZXRNaXBtYXAoIHJlbmRlclRhcmdldCApIHsKCgkJY29uc3Qgc3VwcG9ydHNNaXBzID0gaXNQb3dlck9mVHdvJDEoIHJlbmRlclRhcmdldCApIHx8IGlzV2ViR0wyOwoKCQljb25zdCB0ZXh0dXJlcyA9IHJlbmRlclRhcmdldC5pc1dlYkdMTXVsdGlwbGVSZW5kZXJUYXJnZXRzID09PSB0cnVlID8gcmVuZGVyVGFyZ2V0LnRleHR1cmUgOiBbIHJlbmRlclRhcmdldC50ZXh0dXJlIF07CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSB0ZXh0dXJlcy5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCWNvbnN0IHRleHR1cmUgPSB0ZXh0dXJlc1sgaSBdOwoKCQkJaWYgKCB0ZXh0dXJlTmVlZHNHZW5lcmF0ZU1pcG1hcHMoIHRleHR1cmUsIHN1cHBvcnRzTWlwcyApICkgewoKCQkJCWNvbnN0IHRhcmdldCA9IHJlbmRlclRhcmdldC5pc1dlYkdMQ3ViZVJlbmRlclRhcmdldCA/IF9nbC5URVhUVVJFX0NVQkVfTUFQIDogX2dsLlRFWFRVUkVfMkQ7CgkJCQljb25zdCB3ZWJnbFRleHR1cmUgPSBwcm9wZXJ0aWVzLmdldCggdGV4dHVyZSApLl9fd2ViZ2xUZXh0dXJlOwoKCQkJCXN0YXRlLmJpbmRUZXh0dXJlKCB0YXJnZXQsIHdlYmdsVGV4dHVyZSApOwoJCQkJZ2VuZXJhdGVNaXBtYXAoIHRhcmdldCApOwoJCQkJc3RhdGUudW5iaW5kVGV4dHVyZSgpOwoKCQkJfQoKCQl9CgoJfQoKCWZ1bmN0aW9uIHVwZGF0ZU11bHRpc2FtcGxlUmVuZGVyVGFyZ2V0KCByZW5kZXJUYXJnZXQgKSB7CgoJCWlmICggKCBpc1dlYkdMMiAmJiByZW5kZXJUYXJnZXQuc2FtcGxlcyA+IDAgKSAmJiB1c2VNdWx0aXNhbXBsZWRSVFQoIHJlbmRlclRhcmdldCApID09PSBmYWxzZSApIHsKCgkJCWNvbnN0IHRleHR1cmVzID0gcmVuZGVyVGFyZ2V0LmlzV2ViR0xNdWx0aXBsZVJlbmRlclRhcmdldHMgPyByZW5kZXJUYXJnZXQudGV4dHVyZSA6IFsgcmVuZGVyVGFyZ2V0LnRleHR1cmUgXTsKCQkJY29uc3Qgd2lkdGggPSByZW5kZXJUYXJnZXQud2lkdGg7CgkJCWNvbnN0IGhlaWdodCA9IHJlbmRlclRhcmdldC5oZWlnaHQ7CgkJCWxldCBtYXNrID0gX2dsLkNPTE9SX0JVRkZFUl9CSVQ7CgkJCWNvbnN0IGludmFsaWRhdGlvbkFycmF5ID0gW107CgkJCWNvbnN0IGRlcHRoU3R5bGUgPSByZW5kZXJUYXJnZXQuc3RlbmNpbEJ1ZmZlciA/IF9nbC5ERVBUSF9TVEVOQ0lMX0FUVEFDSE1FTlQgOiBfZ2wuREVQVEhfQVRUQUNITUVOVDsKCQkJY29uc3QgcmVuZGVyVGFyZ2V0UHJvcGVydGllcyA9IHByb3BlcnRpZXMuZ2V0KCByZW5kZXJUYXJnZXQgKTsKCQkJY29uc3QgaXNNdWx0aXBsZVJlbmRlclRhcmdldHMgPSAoIHJlbmRlclRhcmdldC5pc1dlYkdMTXVsdGlwbGVSZW5kZXJUYXJnZXRzID09PSB0cnVlICk7CgoJCQkvLyBJZiBNUlQgd2UgbmVlZCB0byByZW1vdmUgRkJPIGF0dGFjaG1lbnRzCgkJCWlmICggaXNNdWx0aXBsZVJlbmRlclRhcmdldHMgKSB7CgoJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgdGV4dHVyZXMubGVuZ3RoOyBpICsrICkgewoKCQkJCQlzdGF0ZS5iaW5kRnJhbWVidWZmZXIoIF9nbC5GUkFNRUJVRkZFUiwgcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsTXVsdGlzYW1wbGVkRnJhbWVidWZmZXIgKTsKCQkJCQlfZ2wuZnJhbWVidWZmZXJSZW5kZXJidWZmZXIoIF9nbC5GUkFNRUJVRkZFUiwgX2dsLkNPTE9SX0FUVEFDSE1FTlQwICsgaSwgX2dsLlJFTkRFUkJVRkZFUiwgbnVsbCApOwoKCQkJCQlzdGF0ZS5iaW5kRnJhbWVidWZmZXIoIF9nbC5GUkFNRUJVRkZFUiwgcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRnJhbWVidWZmZXIgKTsKCQkJCQlfZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoIF9nbC5EUkFXX0ZSQU1FQlVGRkVSLCBfZ2wuQ09MT1JfQVRUQUNITUVOVDAgKyBpLCBfZ2wuVEVYVFVSRV8yRCwgbnVsbCwgMCApOwoKCQkJCX0KCgkJCX0KCgkJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLlJFQURfRlJBTUVCVUZGRVIsIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyICk7CgkJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkRSQVdfRlJBTUVCVUZGRVIsIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbEZyYW1lYnVmZmVyICk7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB0ZXh0dXJlcy5sZW5ndGg7IGkgKysgKSB7CgoJCQkJaW52YWxpZGF0aW9uQXJyYXkucHVzaCggX2dsLkNPTE9SX0FUVEFDSE1FTlQwICsgaSApOwoKCQkJCWlmICggcmVuZGVyVGFyZ2V0LmRlcHRoQnVmZmVyICkgewoKCQkJCQlpbnZhbGlkYXRpb25BcnJheS5wdXNoKCBkZXB0aFN0eWxlICk7CgoJCQkJfQoKCQkJCWNvbnN0IGlnbm9yZURlcHRoVmFsdWVzID0gKCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9faWdub3JlRGVwdGhWYWx1ZXMgIT09IHVuZGVmaW5lZCApID8gcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX2lnbm9yZURlcHRoVmFsdWVzIDogZmFsc2U7CgoJCQkJaWYgKCBpZ25vcmVEZXB0aFZhbHVlcyA9PT0gZmFsc2UgKSB7CgoJCQkJCWlmICggcmVuZGVyVGFyZ2V0LmRlcHRoQnVmZmVyICkgbWFzayB8PSBfZ2wuREVQVEhfQlVGRkVSX0JJVDsKCQkJCQlpZiAoIHJlbmRlclRhcmdldC5zdGVuY2lsQnVmZmVyICkgbWFzayB8PSBfZ2wuU1RFTkNJTF9CVUZGRVJfQklUOwoKCQkJCX0KCgkJCQlpZiAoIGlzTXVsdGlwbGVSZW5kZXJUYXJnZXRzICkgewoKCQkJCQlfZ2wuZnJhbWVidWZmZXJSZW5kZXJidWZmZXIoIF9nbC5SRUFEX0ZSQU1FQlVGRkVSLCBfZ2wuQ09MT1JfQVRUQUNITUVOVDAsIF9nbC5SRU5ERVJCVUZGRVIsIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbENvbG9yUmVuZGVyYnVmZmVyWyBpIF0gKTsKCgkJCQl9CgoJCQkJaWYgKCBpZ25vcmVEZXB0aFZhbHVlcyA9PT0gdHJ1ZSApIHsKCgkJCQkJX2dsLmludmFsaWRhdGVGcmFtZWJ1ZmZlciggX2dsLlJFQURfRlJBTUVCVUZGRVIsIFsgZGVwdGhTdHlsZSBdICk7CgkJCQkJX2dsLmludmFsaWRhdGVGcmFtZWJ1ZmZlciggX2dsLkRSQVdfRlJBTUVCVUZGRVIsIFsgZGVwdGhTdHlsZSBdICk7CgoJCQkJfQoKCQkJCWlmICggaXNNdWx0aXBsZVJlbmRlclRhcmdldHMgKSB7CgoJCQkJCWNvbnN0IHdlYmdsVGV4dHVyZSA9IHByb3BlcnRpZXMuZ2V0KCB0ZXh0dXJlc1sgaSBdICkuX193ZWJnbFRleHR1cmU7CgkJCQkJX2dsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKCBfZ2wuRFJBV19GUkFNRUJVRkZFUiwgX2dsLkNPTE9SX0FUVEFDSE1FTlQwLCBfZ2wuVEVYVFVSRV8yRCwgd2ViZ2xUZXh0dXJlLCAwICk7CgoJCQkJfQoKCQkJCV9nbC5ibGl0RnJhbWVidWZmZXIoIDAsIDAsIHdpZHRoLCBoZWlnaHQsIDAsIDAsIHdpZHRoLCBoZWlnaHQsIG1hc2ssIF9nbC5ORUFSRVNUICk7CgoJCQkJaWYgKCBzdXBwb3J0c0ludmFsaWRhdGVGcmFtZWJ1ZmZlciApIHsKCgkJCQkJX2dsLmludmFsaWRhdGVGcmFtZWJ1ZmZlciggX2dsLlJFQURfRlJBTUVCVUZGRVIsIGludmFsaWRhdGlvbkFycmF5ICk7CgoJCQkJfQoKCgkJCX0KCgkJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLlJFQURfRlJBTUVCVUZGRVIsIG51bGwgKTsKCQkJc3RhdGUuYmluZEZyYW1lYnVmZmVyKCBfZ2wuRFJBV19GUkFNRUJVRkZFUiwgbnVsbCApOwoKCQkJLy8gSWYgTVJUIHNpbmNlIHByZS1ibGl0IHdlIHJlbW92ZWQgdGhlIEZCTyB3ZSBuZWVkIHRvIHJlY29uc3RydWN0IHRoZSBhdHRhY2htZW50cwoJCQlpZiAoIGlzTXVsdGlwbGVSZW5kZXJUYXJnZXRzICkgewoKCQkJCWZvciAoIGxldCBpID0gMDsgaSA8IHRleHR1cmVzLmxlbmd0aDsgaSArKyApIHsKCgkJCQkJc3RhdGUuYmluZEZyYW1lYnVmZmVyKCBfZ2wuRlJBTUVCVUZGRVIsIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyICk7CgkJCQkJX2dsLmZyYW1lYnVmZmVyUmVuZGVyYnVmZmVyKCBfZ2wuRlJBTUVCVUZGRVIsIF9nbC5DT0xPUl9BVFRBQ0hNRU5UMCArIGksIF9nbC5SRU5ERVJCVUZGRVIsIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbENvbG9yUmVuZGVyYnVmZmVyWyBpIF0gKTsKCgkJCQkJY29uc3Qgd2ViZ2xUZXh0dXJlID0gcHJvcGVydGllcy5nZXQoIHRleHR1cmVzWyBpIF0gKS5fX3dlYmdsVGV4dHVyZTsKCgkJCQkJc3RhdGUuYmluZEZyYW1lYnVmZmVyKCBfZ2wuRlJBTUVCVUZGRVIsIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbEZyYW1lYnVmZmVyICk7CgkJCQkJX2dsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKCBfZ2wuRFJBV19GUkFNRUJVRkZFUiwgX2dsLkNPTE9SX0FUVEFDSE1FTlQwICsgaSwgX2dsLlRFWFRVUkVfMkQsIHdlYmdsVGV4dHVyZSwgMCApOwoKCQkJCX0KCgkJCX0KCgkJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkRSQVdfRlJBTUVCVUZGRVIsIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyICk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gZ2V0UmVuZGVyVGFyZ2V0U2FtcGxlcyggcmVuZGVyVGFyZ2V0ICkgewoKCQlyZXR1cm4gTWF0aC5taW4oIGNhcGFiaWxpdGllcy5tYXhTYW1wbGVzLCByZW5kZXJUYXJnZXQuc2FtcGxlcyApOwoKCX0KCglmdW5jdGlvbiB1c2VNdWx0aXNhbXBsZWRSVFQoIHJlbmRlclRhcmdldCApIHsKCgkJY29uc3QgcmVuZGVyVGFyZ2V0UHJvcGVydGllcyA9IHByb3BlcnRpZXMuZ2V0KCByZW5kZXJUYXJnZXQgKTsKCgkJcmV0dXJuIGlzV2ViR0wyICYmIHJlbmRlclRhcmdldC5zYW1wbGVzID4gMCAmJiBleHRlbnNpb25zLmhhcyggJ1dFQkdMX211bHRpc2FtcGxlZF9yZW5kZXJfdG9fdGV4dHVyZScgKSA9PT0gdHJ1ZSAmJiByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fdXNlUmVuZGVyVG9UZXh0dXJlICE9PSBmYWxzZTsKCgl9CgoJZnVuY3Rpb24gdXBkYXRlVmlkZW9UZXh0dXJlKCB0ZXh0dXJlICkgewoKCQljb25zdCBmcmFtZSA9IGluZm8ucmVuZGVyLmZyYW1lOwoKCQkvLyBDaGVjayB0aGUgbGFzdCBmcmFtZSB3ZSB1cGRhdGVkIHRoZSBWaWRlb1RleHR1cmUKCgkJaWYgKCBfdmlkZW9UZXh0dXJlcy5nZXQoIHRleHR1cmUgKSAhPT0gZnJhbWUgKSB7CgoJCQlfdmlkZW9UZXh0dXJlcy5zZXQoIHRleHR1cmUsIGZyYW1lICk7CgkJCXRleHR1cmUudXBkYXRlKCk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gdmVyaWZ5Q29sb3JTcGFjZSggdGV4dHVyZSwgaW1hZ2UgKSB7CgoJCWNvbnN0IGNvbG9yU3BhY2UgPSB0ZXh0dXJlLmNvbG9yU3BhY2U7CgkJY29uc3QgZm9ybWF0ID0gdGV4dHVyZS5mb3JtYXQ7CgkJY29uc3QgdHlwZSA9IHRleHR1cmUudHlwZTsKCgkJaWYgKCB0ZXh0dXJlLmlzQ29tcHJlc3NlZFRleHR1cmUgPT09IHRydWUgfHwgdGV4dHVyZS5pc1ZpZGVvVGV4dHVyZSA9PT0gdHJ1ZSB8fCB0ZXh0dXJlLmZvcm1hdCA9PT0gX1NSR0JBRm9ybWF0ICkgcmV0dXJuIGltYWdlOwoKCQlpZiAoIGNvbG9yU3BhY2UgIT09IExpbmVhclNSR0JDb2xvclNwYWNlICYmIGNvbG9yU3BhY2UgIT09IE5vQ29sb3JTcGFjZSApIHsKCgkJCS8vIHNSR0IKCgkJCWlmICggQ29sb3JNYW5hZ2VtZW50LmdldFRyYW5zZmVyKCBjb2xvclNwYWNlICkgPT09IFNSR0JUcmFuc2ZlciApIHsKCgkJCQlpZiAoIGlzV2ViR0wyID09PSBmYWxzZSApIHsKCgkJCQkJLy8gaW4gV2ViR0wgMSwgdHJ5IHRvIHVzZSBFWFRfc1JHQiBleHRlbnNpb24gYW5kIHVuc2l6ZWQgZm9ybWF0cwoKCQkJCQlpZiAoIGV4dGVuc2lvbnMuaGFzKCAnRVhUX3NSR0InICkgPT09IHRydWUgJiYgZm9ybWF0ID09PSBSR0JBRm9ybWF0ICkgewoKCQkJCQkJdGV4dHVyZS5mb3JtYXQgPSBfU1JHQkFGb3JtYXQ7CgoJCQkJCQkvLyBpdCdzIG5vdCBwb3NzaWJsZSB0byBnZW5lcmF0ZSBtaXBzIGluIFdlYkdMIDEgd2l0aCB0aGlzIGV4dGVuc2lvbgoKCQkJCQkJdGV4dHVyZS5taW5GaWx0ZXIgPSBMaW5lYXJGaWx0ZXI7CgkJCQkJCXRleHR1cmUuZ2VuZXJhdGVNaXBtYXBzID0gZmFsc2U7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBzbG93IGZhbGxiYWNrIChDUFUgZGVjb2RlKQoKCQkJCQkJaW1hZ2UgPSBJbWFnZVV0aWxzLnNSR0JUb0xpbmVhciggaW1hZ2UgKTsKCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vIGluIFdlYkdMIDIgdW5jb21wcmVzc2VkIHRleHR1cmVzIGNhbiBvbmx5IGJlIHNSR0IgZW5jb2RlZCBpZiB0aGV5IGhhdmUgdGhlIFJHQkE4IGZvcm1hdAoKCQkJCQlpZiAoIGZvcm1hdCAhPT0gUkdCQUZvcm1hdCB8fCB0eXBlICE9PSBVbnNpZ25lZEJ5dGVUeXBlICkgewoKCQkJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xUZXh0dXJlczogc1JHQiBlbmNvZGVkIHRleHR1cmVzIGhhdmUgdG8gdXNlIFJHQkFGb3JtYXQgYW5kIFVuc2lnbmVkQnl0ZVR5cGUuJyApOwoKCQkJCQl9CgoJCQkJfQoKCQkJfSBlbHNlIHsKCgkJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuV2ViR0xUZXh0dXJlczogVW5zdXBwb3J0ZWQgdGV4dHVyZSBjb2xvciBzcGFjZTonLCBjb2xvclNwYWNlICk7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIGltYWdlOwoKCX0KCgkvLwoKCXRoaXMuYWxsb2NhdGVUZXh0dXJlVW5pdCA9IGFsbG9jYXRlVGV4dHVyZVVuaXQ7Cgl0aGlzLnJlc2V0VGV4dHVyZVVuaXRzID0gcmVzZXRUZXh0dXJlVW5pdHM7CgoJdGhpcy5zZXRUZXh0dXJlMkQgPSBzZXRUZXh0dXJlMkQ7Cgl0aGlzLnNldFRleHR1cmUyREFycmF5ID0gc2V0VGV4dHVyZTJEQXJyYXk7Cgl0aGlzLnNldFRleHR1cmUzRCA9IHNldFRleHR1cmUzRDsKCXRoaXMuc2V0VGV4dHVyZUN1YmUgPSBzZXRUZXh0dXJlQ3ViZTsKCXRoaXMucmViaW5kVGV4dHVyZXMgPSByZWJpbmRUZXh0dXJlczsKCXRoaXMuc2V0dXBSZW5kZXJUYXJnZXQgPSBzZXR1cFJlbmRlclRhcmdldDsKCXRoaXMudXBkYXRlUmVuZGVyVGFyZ2V0TWlwbWFwID0gdXBkYXRlUmVuZGVyVGFyZ2V0TWlwbWFwOwoJdGhpcy51cGRhdGVNdWx0aXNhbXBsZVJlbmRlclRhcmdldCA9IHVwZGF0ZU11bHRpc2FtcGxlUmVuZGVyVGFyZ2V0OwoJdGhpcy5zZXR1cERlcHRoUmVuZGVyYnVmZmVyID0gc2V0dXBEZXB0aFJlbmRlcmJ1ZmZlcjsKCXRoaXMuc2V0dXBGcmFtZUJ1ZmZlclRleHR1cmUgPSBzZXR1cEZyYW1lQnVmZmVyVGV4dHVyZTsKCXRoaXMudXNlTXVsdGlzYW1wbGVkUlRUID0gdXNlTXVsdGlzYW1wbGVkUlRUOwoKfQoKZnVuY3Rpb24gV2ViR0xVdGlscyggZ2wsIGV4dGVuc2lvbnMsIGNhcGFiaWxpdGllcyApIHsKCgljb25zdCBpc1dlYkdMMiA9IGNhcGFiaWxpdGllcy5pc1dlYkdMMjsKCglmdW5jdGlvbiBjb252ZXJ0KCBwLCBjb2xvclNwYWNlID0gTm9Db2xvclNwYWNlICkgewoKCQlsZXQgZXh0ZW5zaW9uOwoKCQljb25zdCB0cmFuc2ZlciA9IENvbG9yTWFuYWdlbWVudC5nZXRUcmFuc2ZlciggY29sb3JTcGFjZSApOwoKCQlpZiAoIHAgPT09IFVuc2lnbmVkQnl0ZVR5cGUgKSByZXR1cm4gZ2wuVU5TSUdORURfQllURTsKCQlpZiAoIHAgPT09IFVuc2lnbmVkU2hvcnQ0NDQ0VHlwZSApIHJldHVybiBnbC5VTlNJR05FRF9TSE9SVF80XzRfNF80OwoJCWlmICggcCA9PT0gVW5zaWduZWRTaG9ydDU1NTFUeXBlICkgcmV0dXJuIGdsLlVOU0lHTkVEX1NIT1JUXzVfNV81XzE7CgoJCWlmICggcCA9PT0gQnl0ZVR5cGUgKSByZXR1cm4gZ2wuQllURTsKCQlpZiAoIHAgPT09IFNob3J0VHlwZSApIHJldHVybiBnbC5TSE9SVDsKCQlpZiAoIHAgPT09IFVuc2lnbmVkU2hvcnRUeXBlICkgcmV0dXJuIGdsLlVOU0lHTkVEX1NIT1JUOwoJCWlmICggcCA9PT0gSW50VHlwZSApIHJldHVybiBnbC5JTlQ7CgkJaWYgKCBwID09PSBVbnNpZ25lZEludFR5cGUgKSByZXR1cm4gZ2wuVU5TSUdORURfSU5UOwoJCWlmICggcCA9PT0gRmxvYXRUeXBlICkgcmV0dXJuIGdsLkZMT0FUOwoKCQlpZiAoIHAgPT09IEhhbGZGbG9hdFR5cGUgKSB7CgoJCQlpZiAoIGlzV2ViR0wyICkgcmV0dXJuIGdsLkhBTEZfRkxPQVQ7CgoJCQlleHRlbnNpb24gPSBleHRlbnNpb25zLmdldCggJ09FU190ZXh0dXJlX2hhbGZfZmxvYXQnICk7CgoJCQlpZiAoIGV4dGVuc2lvbiAhPT0gbnVsbCApIHsKCgkJCQlyZXR1cm4gZXh0ZW5zaW9uLkhBTEZfRkxPQVRfT0VTOwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gbnVsbDsKCgkJCX0KCgkJfQoKCQlpZiAoIHAgPT09IEFscGhhRm9ybWF0ICkgcmV0dXJuIGdsLkFMUEhBOwoJCWlmICggcCA9PT0gUkdCQUZvcm1hdCApIHJldHVybiBnbC5SR0JBOwoJCWlmICggcCA9PT0gTHVtaW5hbmNlRm9ybWF0ICkgcmV0dXJuIGdsLkxVTUlOQU5DRTsKCQlpZiAoIHAgPT09IEx1bWluYW5jZUFscGhhRm9ybWF0ICkgcmV0dXJuIGdsLkxVTUlOQU5DRV9BTFBIQTsKCQlpZiAoIHAgPT09IERlcHRoRm9ybWF0ICkgcmV0dXJuIGdsLkRFUFRIX0NPTVBPTkVOVDsKCQlpZiAoIHAgPT09IERlcHRoU3RlbmNpbEZvcm1hdCApIHJldHVybiBnbC5ERVBUSF9TVEVOQ0lMOwoKCQkvLyBXZWJHTCAxIHNSR0IgZmFsbGJhY2sKCgkJaWYgKCBwID09PSBfU1JHQkFGb3JtYXQgKSB7CgoJCQlleHRlbnNpb24gPSBleHRlbnNpb25zLmdldCggJ0VYVF9zUkdCJyApOwoKCQkJaWYgKCBleHRlbnNpb24gIT09IG51bGwgKSB7CgoJCQkJcmV0dXJuIGV4dGVuc2lvbi5TUkdCX0FMUEhBX0VYVDsKCgkJCX0gZWxzZSB7CgoJCQkJcmV0dXJuIG51bGw7CgoJCQl9CgoJCX0KCgkJLy8gV2ViR0wyIGZvcm1hdHMuCgoJCWlmICggcCA9PT0gUmVkRm9ybWF0ICkgcmV0dXJuIGdsLlJFRDsKCQlpZiAoIHAgPT09IFJlZEludGVnZXJGb3JtYXQgKSByZXR1cm4gZ2wuUkVEX0lOVEVHRVI7CgkJaWYgKCBwID09PSBSR0Zvcm1hdCApIHJldHVybiBnbC5SRzsKCQlpZiAoIHAgPT09IFJHSW50ZWdlckZvcm1hdCApIHJldHVybiBnbC5SR19JTlRFR0VSOwoJCWlmICggcCA9PT0gUkdCQUludGVnZXJGb3JtYXQgKSByZXR1cm4gZ2wuUkdCQV9JTlRFR0VSOwoKCQkvLyBTM1RDCgoJCWlmICggcCA9PT0gUkdCX1MzVENfRFhUMV9Gb3JtYXQgfHwgcCA9PT0gUkdCQV9TM1RDX0RYVDFfRm9ybWF0IHx8IHAgPT09IFJHQkFfUzNUQ19EWFQzX0Zvcm1hdCB8fCBwID09PSBSR0JBX1MzVENfRFhUNV9Gb3JtYXQgKSB7CgoJCQlpZiAoIHRyYW5zZmVyID09PSBTUkdCVHJhbnNmZXIgKSB7CgoJCQkJZXh0ZW5zaW9uID0gZXh0ZW5zaW9ucy5nZXQoICdXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfczN0Y19zcmdiJyApOwoKCQkJCWlmICggZXh0ZW5zaW9uICE9PSBudWxsICkgewoKCQkJCQlpZiAoIHAgPT09IFJHQl9TM1RDX0RYVDFfRm9ybWF0ICkgcmV0dXJuIGV4dGVuc2lvbi5DT01QUkVTU0VEX1NSR0JfUzNUQ19EWFQxX0VYVDsKCQkJCQlpZiAoIHAgPT09IFJHQkFfUzNUQ19EWFQxX0Zvcm1hdCApIHJldHVybiBleHRlbnNpb24uQ09NUFJFU1NFRF9TUkdCX0FMUEhBX1MzVENfRFhUMV9FWFQ7CgkJCQkJaWYgKCBwID09PSBSR0JBX1MzVENfRFhUM19Gb3JtYXQgKSByZXR1cm4gZXh0ZW5zaW9uLkNPTVBSRVNTRURfU1JHQl9BTFBIQV9TM1RDX0RYVDNfRVhUOwoJCQkJCWlmICggcCA9PT0gUkdCQV9TM1RDX0RYVDVfRm9ybWF0ICkgcmV0dXJuIGV4dGVuc2lvbi5DT01QUkVTU0VEX1NSR0JfQUxQSEFfUzNUQ19EWFQ1X0VYVDsKCgkJCQl9IGVsc2UgewoKCQkJCQlyZXR1cm4gbnVsbDsKCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCWV4dGVuc2lvbiA9IGV4dGVuc2lvbnMuZ2V0KCAnV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX3MzdGMnICk7CgoJCQkJaWYgKCBleHRlbnNpb24gIT09IG51bGwgKSB7CgoJCQkJCWlmICggcCA9PT0gUkdCX1MzVENfRFhUMV9Gb3JtYXQgKSByZXR1cm4gZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCX1MzVENfRFhUMV9FWFQ7CgkJCQkJaWYgKCBwID09PSBSR0JBX1MzVENfRFhUMV9Gb3JtYXQgKSByZXR1cm4gZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCQV9TM1RDX0RYVDFfRVhUOwoJCQkJCWlmICggcCA9PT0gUkdCQV9TM1RDX0RYVDNfRm9ybWF0ICkgcmV0dXJuIGV4dGVuc2lvbi5DT01QUkVTU0VEX1JHQkFfUzNUQ19EWFQzX0VYVDsKCQkJCQlpZiAoIHAgPT09IFJHQkFfUzNUQ19EWFQ1X0Zvcm1hdCApIHJldHVybiBleHRlbnNpb24uQ09NUFJFU1NFRF9SR0JBX1MzVENfRFhUNV9FWFQ7CgoJCQkJfSBlbHNlIHsKCgkJCQkJcmV0dXJuIG51bGw7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCS8vIFBWUlRDCgoJCWlmICggcCA9PT0gUkdCX1BWUlRDXzRCUFBWMV9Gb3JtYXQgfHwgcCA9PT0gUkdCX1BWUlRDXzJCUFBWMV9Gb3JtYXQgfHwgcCA9PT0gUkdCQV9QVlJUQ180QlBQVjFfRm9ybWF0IHx8IHAgPT09IFJHQkFfUFZSVENfMkJQUFYxX0Zvcm1hdCApIHsKCgkJCWV4dGVuc2lvbiA9IGV4dGVuc2lvbnMuZ2V0KCAnV0VCR0xfY29tcHJlc3NlZF90ZXh0dXJlX3B2cnRjJyApOwoKCQkJaWYgKCBleHRlbnNpb24gIT09IG51bGwgKSB7CgoJCQkJaWYgKCBwID09PSBSR0JfUFZSVENfNEJQUFYxX0Zvcm1hdCApIHJldHVybiBleHRlbnNpb24uQ09NUFJFU1NFRF9SR0JfUFZSVENfNEJQUFYxX0lNRzsKCQkJCWlmICggcCA9PT0gUkdCX1BWUlRDXzJCUFBWMV9Gb3JtYXQgKSByZXR1cm4gZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCX1BWUlRDXzJCUFBWMV9JTUc7CgkJCQlpZiAoIHAgPT09IFJHQkFfUFZSVENfNEJQUFYxX0Zvcm1hdCApIHJldHVybiBleHRlbnNpb24uQ09NUFJFU1NFRF9SR0JBX1BWUlRDXzRCUFBWMV9JTUc7CgkJCQlpZiAoIHAgPT09IFJHQkFfUFZSVENfMkJQUFYxX0Zvcm1hdCApIHJldHVybiBleHRlbnNpb24uQ09NUFJFU1NFRF9SR0JBX1BWUlRDXzJCUFBWMV9JTUc7CgoJCQl9IGVsc2UgewoKCQkJCXJldHVybiBudWxsOwoKCQkJfQoKCQl9CgoJCS8vIEVUQzEKCgkJaWYgKCBwID09PSBSR0JfRVRDMV9Gb3JtYXQgKSB7CgoJCQlleHRlbnNpb24gPSBleHRlbnNpb25zLmdldCggJ1dFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9ldGMxJyApOwoKCQkJaWYgKCBleHRlbnNpb24gIT09IG51bGwgKSB7CgoJCQkJcmV0dXJuIGV4dGVuc2lvbi5DT01QUkVTU0VEX1JHQl9FVEMxX1dFQkdMOwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gbnVsbDsKCgkJCX0KCgkJfQoKCQkvLyBFVEMyCgoJCWlmICggcCA9PT0gUkdCX0VUQzJfRm9ybWF0IHx8IHAgPT09IFJHQkFfRVRDMl9FQUNfRm9ybWF0ICkgewoKCQkJZXh0ZW5zaW9uID0gZXh0ZW5zaW9ucy5nZXQoICdXRUJHTF9jb21wcmVzc2VkX3RleHR1cmVfZXRjJyApOwoKCQkJaWYgKCBleHRlbnNpb24gIT09IG51bGwgKSB7CgoJCQkJaWYgKCBwID09PSBSR0JfRVRDMl9Gb3JtYXQgKSByZXR1cm4gKCB0cmFuc2ZlciA9PT0gU1JHQlRyYW5zZmVyICkgPyBleHRlbnNpb24uQ09NUFJFU1NFRF9TUkdCOF9FVEMyIDogZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCOF9FVEMyOwoJCQkJaWYgKCBwID09PSBSR0JBX0VUQzJfRUFDX0Zvcm1hdCApIHJldHVybiAoIHRyYW5zZmVyID09PSBTUkdCVHJhbnNmZXIgKSA/IGV4dGVuc2lvbi5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9FVEMyX0VBQyA6IGV4dGVuc2lvbi5DT01QUkVTU0VEX1JHQkE4X0VUQzJfRUFDOwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gbnVsbDsKCgkJCX0KCgkJfQoKCQkvLyBBU1RDCgoJCWlmICggcCA9PT0gUkdCQV9BU1RDXzR4NF9Gb3JtYXQgfHwgcCA9PT0gUkdCQV9BU1RDXzV4NF9Gb3JtYXQgfHwgcCA9PT0gUkdCQV9BU1RDXzV4NV9Gb3JtYXQgfHwKCQkJcCA9PT0gUkdCQV9BU1RDXzZ4NV9Gb3JtYXQgfHwgcCA9PT0gUkdCQV9BU1RDXzZ4Nl9Gb3JtYXQgfHwgcCA9PT0gUkdCQV9BU1RDXzh4NV9Gb3JtYXQgfHwKCQkJcCA9PT0gUkdCQV9BU1RDXzh4Nl9Gb3JtYXQgfHwgcCA9PT0gUkdCQV9BU1RDXzh4OF9Gb3JtYXQgfHwgcCA9PT0gUkdCQV9BU1RDXzEweDVfRm9ybWF0IHx8CgkJCXAgPT09IFJHQkFfQVNUQ18xMHg2X0Zvcm1hdCB8fCBwID09PSBSR0JBX0FTVENfMTB4OF9Gb3JtYXQgfHwgcCA9PT0gUkdCQV9BU1RDXzEweDEwX0Zvcm1hdCB8fAoJCQlwID09PSBSR0JBX0FTVENfMTJ4MTBfRm9ybWF0IHx8IHAgPT09IFJHQkFfQVNUQ18xMngxMl9Gb3JtYXQgKSB7CgoJCQlleHRlbnNpb24gPSBleHRlbnNpb25zLmdldCggJ1dFQkdMX2NvbXByZXNzZWRfdGV4dHVyZV9hc3RjJyApOwoKCQkJaWYgKCBleHRlbnNpb24gIT09IG51bGwgKSB7CgoJCQkJaWYgKCBwID09PSBSR0JBX0FTVENfNHg0X0Zvcm1hdCApIHJldHVybiAoIHRyYW5zZmVyID09PSBTUkdCVHJhbnNmZXIgKSA/IGV4dGVuc2lvbi5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9BU1RDXzR4NF9LSFIgOiBleHRlbnNpb24uQ09NUFJFU1NFRF9SR0JBX0FTVENfNHg0X0tIUjsKCQkJCWlmICggcCA9PT0gUkdCQV9BU1RDXzV4NF9Gb3JtYXQgKSByZXR1cm4gKCB0cmFuc2ZlciA9PT0gU1JHQlRyYW5zZmVyICkgPyBleHRlbnNpb24uQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ181eDRfS0hSIDogZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCQV9BU1RDXzV4NF9LSFI7CgkJCQlpZiAoIHAgPT09IFJHQkFfQVNUQ181eDVfRm9ybWF0ICkgcmV0dXJuICggdHJhbnNmZXIgPT09IFNSR0JUcmFuc2ZlciApID8gZXh0ZW5zaW9uLkNPTVBSRVNTRURfU1JHQjhfQUxQSEE4X0FTVENfNXg1X0tIUiA6IGV4dGVuc2lvbi5DT01QUkVTU0VEX1JHQkFfQVNUQ181eDVfS0hSOwoJCQkJaWYgKCBwID09PSBSR0JBX0FTVENfNng1X0Zvcm1hdCApIHJldHVybiAoIHRyYW5zZmVyID09PSBTUkdCVHJhbnNmZXIgKSA/IGV4dGVuc2lvbi5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9BU1RDXzZ4NV9LSFIgOiBleHRlbnNpb24uQ09NUFJFU1NFRF9SR0JBX0FTVENfNng1X0tIUjsKCQkJCWlmICggcCA9PT0gUkdCQV9BU1RDXzZ4Nl9Gb3JtYXQgKSByZXR1cm4gKCB0cmFuc2ZlciA9PT0gU1JHQlRyYW5zZmVyICkgPyBleHRlbnNpb24uQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ182eDZfS0hSIDogZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCQV9BU1RDXzZ4Nl9LSFI7CgkJCQlpZiAoIHAgPT09IFJHQkFfQVNUQ184eDVfRm9ybWF0ICkgcmV0dXJuICggdHJhbnNmZXIgPT09IFNSR0JUcmFuc2ZlciApID8gZXh0ZW5zaW9uLkNPTVBSRVNTRURfU1JHQjhfQUxQSEE4X0FTVENfOHg1X0tIUiA6IGV4dGVuc2lvbi5DT01QUkVTU0VEX1JHQkFfQVNUQ184eDVfS0hSOwoJCQkJaWYgKCBwID09PSBSR0JBX0FTVENfOHg2X0Zvcm1hdCApIHJldHVybiAoIHRyYW5zZmVyID09PSBTUkdCVHJhbnNmZXIgKSA/IGV4dGVuc2lvbi5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9BU1RDXzh4Nl9LSFIgOiBleHRlbnNpb24uQ09NUFJFU1NFRF9SR0JBX0FTVENfOHg2X0tIUjsKCQkJCWlmICggcCA9PT0gUkdCQV9BU1RDXzh4OF9Gb3JtYXQgKSByZXR1cm4gKCB0cmFuc2ZlciA9PT0gU1JHQlRyYW5zZmVyICkgPyBleHRlbnNpb24uQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ184eDhfS0hSIDogZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCQV9BU1RDXzh4OF9LSFI7CgkJCQlpZiAoIHAgPT09IFJHQkFfQVNUQ18xMHg1X0Zvcm1hdCApIHJldHVybiAoIHRyYW5zZmVyID09PSBTUkdCVHJhbnNmZXIgKSA/IGV4dGVuc2lvbi5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9BU1RDXzEweDVfS0hSIDogZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCQV9BU1RDXzEweDVfS0hSOwoJCQkJaWYgKCBwID09PSBSR0JBX0FTVENfMTB4Nl9Gb3JtYXQgKSByZXR1cm4gKCB0cmFuc2ZlciA9PT0gU1JHQlRyYW5zZmVyICkgPyBleHRlbnNpb24uQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ18xMHg2X0tIUiA6IGV4dGVuc2lvbi5DT01QUkVTU0VEX1JHQkFfQVNUQ18xMHg2X0tIUjsKCQkJCWlmICggcCA9PT0gUkdCQV9BU1RDXzEweDhfRm9ybWF0ICkgcmV0dXJuICggdHJhbnNmZXIgPT09IFNSR0JUcmFuc2ZlciApID8gZXh0ZW5zaW9uLkNPTVBSRVNTRURfU1JHQjhfQUxQSEE4X0FTVENfMTB4OF9LSFIgOiBleHRlbnNpb24uQ09NUFJFU1NFRF9SR0JBX0FTVENfMTB4OF9LSFI7CgkJCQlpZiAoIHAgPT09IFJHQkFfQVNUQ18xMHgxMF9Gb3JtYXQgKSByZXR1cm4gKCB0cmFuc2ZlciA9PT0gU1JHQlRyYW5zZmVyICkgPyBleHRlbnNpb24uQ09NUFJFU1NFRF9TUkdCOF9BTFBIQThfQVNUQ18xMHgxMF9LSFIgOiBleHRlbnNpb24uQ09NUFJFU1NFRF9SR0JBX0FTVENfMTB4MTBfS0hSOwoJCQkJaWYgKCBwID09PSBSR0JBX0FTVENfMTJ4MTBfRm9ybWF0ICkgcmV0dXJuICggdHJhbnNmZXIgPT09IFNSR0JUcmFuc2ZlciApID8gZXh0ZW5zaW9uLkNPTVBSRVNTRURfU1JHQjhfQUxQSEE4X0FTVENfMTJ4MTBfS0hSIDogZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCQV9BU1RDXzEyeDEwX0tIUjsKCQkJCWlmICggcCA9PT0gUkdCQV9BU1RDXzEyeDEyX0Zvcm1hdCApIHJldHVybiAoIHRyYW5zZmVyID09PSBTUkdCVHJhbnNmZXIgKSA/IGV4dGVuc2lvbi5DT01QUkVTU0VEX1NSR0I4X0FMUEhBOF9BU1RDXzEyeDEyX0tIUiA6IGV4dGVuc2lvbi5DT01QUkVTU0VEX1JHQkFfQVNUQ18xMngxMl9LSFI7CgoJCQl9IGVsc2UgewoKCQkJCXJldHVybiBudWxsOwoKCQkJfQoKCQl9CgoJCS8vIEJQVEMKCgkJaWYgKCBwID09PSBSR0JBX0JQVENfRm9ybWF0IHx8IHAgPT09IFJHQl9CUFRDX1NJR05FRF9Gb3JtYXQgfHwgcCA9PT0gUkdCX0JQVENfVU5TSUdORURfRm9ybWF0ICkgewoKCQkJZXh0ZW5zaW9uID0gZXh0ZW5zaW9ucy5nZXQoICdFWFRfdGV4dHVyZV9jb21wcmVzc2lvbl9icHRjJyApOwoKCQkJaWYgKCBleHRlbnNpb24gIT09IG51bGwgKSB7CgoJCQkJaWYgKCBwID09PSBSR0JBX0JQVENfRm9ybWF0ICkgcmV0dXJuICggdHJhbnNmZXIgPT09IFNSR0JUcmFuc2ZlciApID8gZXh0ZW5zaW9uLkNPTVBSRVNTRURfU1JHQl9BTFBIQV9CUFRDX1VOT1JNX0VYVCA6IGV4dGVuc2lvbi5DT01QUkVTU0VEX1JHQkFfQlBUQ19VTk9STV9FWFQ7CgkJCQlpZiAoIHAgPT09IFJHQl9CUFRDX1NJR05FRF9Gb3JtYXQgKSByZXR1cm4gZXh0ZW5zaW9uLkNPTVBSRVNTRURfUkdCX0JQVENfU0lHTkVEX0ZMT0FUX0VYVDsKCQkJCWlmICggcCA9PT0gUkdCX0JQVENfVU5TSUdORURfRm9ybWF0ICkgcmV0dXJuIGV4dGVuc2lvbi5DT01QUkVTU0VEX1JHQl9CUFRDX1VOU0lHTkVEX0ZMT0FUX0VYVDsKCgkJCX0gZWxzZSB7CgoJCQkJcmV0dXJuIG51bGw7CgoJCQl9CgoJCX0KCgkJLy8gUkdUQwoKCQlpZiAoIHAgPT09IFJFRF9SR1RDMV9Gb3JtYXQgfHwgcCA9PT0gU0lHTkVEX1JFRF9SR1RDMV9Gb3JtYXQgfHwgcCA9PT0gUkVEX0dSRUVOX1JHVEMyX0Zvcm1hdCB8fCBwID09PSBTSUdORURfUkVEX0dSRUVOX1JHVEMyX0Zvcm1hdCApIHsKCgkJCWV4dGVuc2lvbiA9IGV4dGVuc2lvbnMuZ2V0KCAnRVhUX3RleHR1cmVfY29tcHJlc3Npb25fcmd0YycgKTsKCgkJCWlmICggZXh0ZW5zaW9uICE9PSBudWxsICkgewoKCQkJCWlmICggcCA9PT0gUkdCQV9CUFRDX0Zvcm1hdCApIHJldHVybiBleHRlbnNpb24uQ09NUFJFU1NFRF9SRURfUkdUQzFfRVhUOwoJCQkJaWYgKCBwID09PSBTSUdORURfUkVEX1JHVEMxX0Zvcm1hdCApIHJldHVybiBleHRlbnNpb24uQ09NUFJFU1NFRF9TSUdORURfUkVEX1JHVEMxX0VYVDsKCQkJCWlmICggcCA9PT0gUkVEX0dSRUVOX1JHVEMyX0Zvcm1hdCApIHJldHVybiBleHRlbnNpb24uQ09NUFJFU1NFRF9SRURfR1JFRU5fUkdUQzJfRVhUOwoJCQkJaWYgKCBwID09PSBTSUdORURfUkVEX0dSRUVOX1JHVEMyX0Zvcm1hdCApIHJldHVybiBleHRlbnNpb24uQ09NUFJFU1NFRF9TSUdORURfUkVEX0dSRUVOX1JHVEMyX0VYVDsKCgkJCX0gZWxzZSB7CgoJCQkJcmV0dXJuIG51bGw7CgoJCQl9CgoJCX0KCgkJLy8KCgkJaWYgKCBwID09PSBVbnNpZ25lZEludDI0OFR5cGUgKSB7CgoJCQlpZiAoIGlzV2ViR0wyICkgcmV0dXJuIGdsLlVOU0lHTkVEX0lOVF8yNF84OwoKCQkJZXh0ZW5zaW9uID0gZXh0ZW5zaW9ucy5nZXQoICdXRUJHTF9kZXB0aF90ZXh0dXJlJyApOwoKCQkJaWYgKCBleHRlbnNpb24gIT09IG51bGwgKSB7CgoJCQkJcmV0dXJuIGV4dGVuc2lvbi5VTlNJR05FRF9JTlRfMjRfOF9XRUJHTDsKCgkJCX0gZWxzZSB7CgoJCQkJcmV0dXJuIG51bGw7CgoJCQl9CgoJCX0KCgkJLy8gaWYgInAiIGNhbid0IGJlIHJlc29sdmVkLCBhc3N1bWUgdGhlIHVzZXIgZGVmaW5lcyBhIFdlYkdMIGNvbnN0YW50IGFzIGEgc3RyaW5nIChmYWxsYmFjay93b3JrYXJvdW5kIGZvciBwYWNrZWQgUkdCIGZvcm1hdHMpCgoJCXJldHVybiAoIGdsWyBwIF0gIT09IHVuZGVmaW5lZCApID8gZ2xbIHAgXSA6IG51bGw7CgoJfQoKCXJldHVybiB7IGNvbnZlcnQ6IGNvbnZlcnQgfTsKCn0KCmNsYXNzIEFycmF5Q2FtZXJhIGV4dGVuZHMgUGVyc3BlY3RpdmVDYW1lcmEgewoKCWNvbnN0cnVjdG9yKCBhcnJheSA9IFtdICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzQXJyYXlDYW1lcmEgPSB0cnVlOwoKCQl0aGlzLmNhbWVyYXMgPSBhcnJheTsKCgl9Cgp9CgpjbGFzcyBHcm91cCBleHRlbmRzIE9iamVjdDNEIHsKCgljb25zdHJ1Y3RvcigpIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc0dyb3VwID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ0dyb3VwJzsKCgl9Cgp9Cgpjb25zdCBfbW92ZUV2ZW50ID0geyB0eXBlOiAnbW92ZScgfTsKCmNsYXNzIFdlYlhSQ29udHJvbGxlciB7CgoJY29uc3RydWN0b3IoKSB7CgoJCXRoaXMuX3RhcmdldFJheSA9IG51bGw7CgkJdGhpcy5fZ3JpcCA9IG51bGw7CgkJdGhpcy5faGFuZCA9IG51bGw7CgoJfQoKCWdldEhhbmRTcGFjZSgpIHsKCgkJaWYgKCB0aGlzLl9oYW5kID09PSBudWxsICkgewoKCQkJdGhpcy5faGFuZCA9IG5ldyBHcm91cCgpOwoJCQl0aGlzLl9oYW5kLm1hdHJpeEF1dG9VcGRhdGUgPSBmYWxzZTsKCQkJdGhpcy5faGFuZC52aXNpYmxlID0gZmFsc2U7CgoJCQl0aGlzLl9oYW5kLmpvaW50cyA9IHt9OwoJCQl0aGlzLl9oYW5kLmlucHV0U3RhdGUgPSB7IHBpbmNoaW5nOiBmYWxzZSB9OwoKCQl9CgoJCXJldHVybiB0aGlzLl9oYW5kOwoKCX0KCglnZXRUYXJnZXRSYXlTcGFjZSgpIHsKCgkJaWYgKCB0aGlzLl90YXJnZXRSYXkgPT09IG51bGwgKSB7CgoJCQl0aGlzLl90YXJnZXRSYXkgPSBuZXcgR3JvdXAoKTsKCQkJdGhpcy5fdGFyZ2V0UmF5Lm1hdHJpeEF1dG9VcGRhdGUgPSBmYWxzZTsKCQkJdGhpcy5fdGFyZ2V0UmF5LnZpc2libGUgPSBmYWxzZTsKCQkJdGhpcy5fdGFyZ2V0UmF5Lmhhc0xpbmVhclZlbG9jaXR5ID0gZmFsc2U7CgkJCXRoaXMuX3RhcmdldFJheS5saW5lYXJWZWxvY2l0eSA9IG5ldyBWZWN0b3IzKCk7CgkJCXRoaXMuX3RhcmdldFJheS5oYXNBbmd1bGFyVmVsb2NpdHkgPSBmYWxzZTsKCQkJdGhpcy5fdGFyZ2V0UmF5LmFuZ3VsYXJWZWxvY2l0eSA9IG5ldyBWZWN0b3IzKCk7CgoJCX0KCgkJcmV0dXJuIHRoaXMuX3RhcmdldFJheTsKCgl9CgoJZ2V0R3JpcFNwYWNlKCkgewoKCQlpZiAoIHRoaXMuX2dyaXAgPT09IG51bGwgKSB7CgoJCQl0aGlzLl9ncmlwID0gbmV3IEdyb3VwKCk7CgkJCXRoaXMuX2dyaXAubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwoJCQl0aGlzLl9ncmlwLnZpc2libGUgPSBmYWxzZTsKCQkJdGhpcy5fZ3JpcC5oYXNMaW5lYXJWZWxvY2l0eSA9IGZhbHNlOwoJCQl0aGlzLl9ncmlwLmxpbmVhclZlbG9jaXR5ID0gbmV3IFZlY3RvcjMoKTsKCQkJdGhpcy5fZ3JpcC5oYXNBbmd1bGFyVmVsb2NpdHkgPSBmYWxzZTsKCQkJdGhpcy5fZ3JpcC5hbmd1bGFyVmVsb2NpdHkgPSBuZXcgVmVjdG9yMygpOwoKCQl9CgoJCXJldHVybiB0aGlzLl9ncmlwOwoKCX0KCglkaXNwYXRjaEV2ZW50KCBldmVudCApIHsKCgkJaWYgKCB0aGlzLl90YXJnZXRSYXkgIT09IG51bGwgKSB7CgoJCQl0aGlzLl90YXJnZXRSYXkuZGlzcGF0Y2hFdmVudCggZXZlbnQgKTsKCgkJfQoKCQlpZiAoIHRoaXMuX2dyaXAgIT09IG51bGwgKSB7CgoJCQl0aGlzLl9ncmlwLmRpc3BhdGNoRXZlbnQoIGV2ZW50ICk7CgoJCX0KCgkJaWYgKCB0aGlzLl9oYW5kICE9PSBudWxsICkgewoKCQkJdGhpcy5faGFuZC5kaXNwYXRjaEV2ZW50KCBldmVudCApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb25uZWN0KCBpbnB1dFNvdXJjZSApIHsKCgkJaWYgKCBpbnB1dFNvdXJjZSAmJiBpbnB1dFNvdXJjZS5oYW5kICkgewoKCQkJY29uc3QgaGFuZCA9IHRoaXMuX2hhbmQ7CgoJCQlpZiAoIGhhbmQgKSB7CgoJCQkJZm9yICggY29uc3QgaW5wdXRqb2ludCBvZiBpbnB1dFNvdXJjZS5oYW5kLnZhbHVlcygpICkgewoKCQkJCQkvLyBJbml0aWFsaXplIGhhbmQgd2l0aCBqb2ludHMgd2hlbiBjb25uZWN0ZWQKCQkJCQl0aGlzLl9nZXRIYW5kSm9pbnQoIGhhbmQsIGlucHV0am9pbnQgKTsKCgkJCQl9CgoJCQl9CgoJCX0KCgkJdGhpcy5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICdjb25uZWN0ZWQnLCBkYXRhOiBpbnB1dFNvdXJjZSB9ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglkaXNjb25uZWN0KCBpbnB1dFNvdXJjZSApIHsKCgkJdGhpcy5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICdkaXNjb25uZWN0ZWQnLCBkYXRhOiBpbnB1dFNvdXJjZSB9ICk7CgoJCWlmICggdGhpcy5fdGFyZ2V0UmF5ICE9PSBudWxsICkgewoKCQkJdGhpcy5fdGFyZ2V0UmF5LnZpc2libGUgPSBmYWxzZTsKCgkJfQoKCQlpZiAoIHRoaXMuX2dyaXAgIT09IG51bGwgKSB7CgoJCQl0aGlzLl9ncmlwLnZpc2libGUgPSBmYWxzZTsKCgkJfQoKCQlpZiAoIHRoaXMuX2hhbmQgIT09IG51bGwgKSB7CgoJCQl0aGlzLl9oYW5kLnZpc2libGUgPSBmYWxzZTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdXBkYXRlKCBpbnB1dFNvdXJjZSwgZnJhbWUsIHJlZmVyZW5jZVNwYWNlICkgewoKCQlsZXQgaW5wdXRQb3NlID0gbnVsbDsKCQlsZXQgZ3JpcFBvc2UgPSBudWxsOwoJCWxldCBoYW5kUG9zZSA9IG51bGw7CgoJCWNvbnN0IHRhcmdldFJheSA9IHRoaXMuX3RhcmdldFJheTsKCQljb25zdCBncmlwID0gdGhpcy5fZ3JpcDsKCQljb25zdCBoYW5kID0gdGhpcy5faGFuZDsKCgkJaWYgKCBpbnB1dFNvdXJjZSAmJiBmcmFtZS5zZXNzaW9uLnZpc2liaWxpdHlTdGF0ZSAhPT0gJ3Zpc2libGUtYmx1cnJlZCcgKSB7CgoJCQlpZiAoIGhhbmQgJiYgaW5wdXRTb3VyY2UuaGFuZCApIHsKCgkJCQloYW5kUG9zZSA9IHRydWU7CgoJCQkJZm9yICggY29uc3QgaW5wdXRqb2ludCBvZiBpbnB1dFNvdXJjZS5oYW5kLnZhbHVlcygpICkgewoKCQkJCQkvLyBVcGRhdGUgdGhlIGpvaW50cyBncm91cHMgd2l0aCB0aGUgWFJKb2ludCBwb3NlcwoJCQkJCWNvbnN0IGpvaW50UG9zZSA9IGZyYW1lLmdldEpvaW50UG9zZSggaW5wdXRqb2ludCwgcmVmZXJlbmNlU3BhY2UgKTsKCgkJCQkJLy8gVGhlIHRyYW5zZm9ybSBvZiB0aGlzIGpvaW50IHdpbGwgYmUgdXBkYXRlZCB3aXRoIHRoZSBqb2ludCBwb3NlIG9uIGVhY2ggZnJhbWUKCQkJCQljb25zdCBqb2ludCA9IHRoaXMuX2dldEhhbmRKb2ludCggaGFuZCwgaW5wdXRqb2ludCApOwoKCQkJCQlpZiAoIGpvaW50UG9zZSAhPT0gbnVsbCApIHsKCgkJCQkJCWpvaW50Lm1hdHJpeC5mcm9tQXJyYXkoIGpvaW50UG9zZS50cmFuc2Zvcm0ubWF0cml4ICk7CgkJCQkJCWpvaW50Lm1hdHJpeC5kZWNvbXBvc2UoIGpvaW50LnBvc2l0aW9uLCBqb2ludC5yb3RhdGlvbiwgam9pbnQuc2NhbGUgKTsKCQkJCQkJam9pbnQubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9IHRydWU7CgkJCQkJCWpvaW50LmpvaW50UmFkaXVzID0gam9pbnRQb3NlLnJhZGl1czsKCgkJCQkJfQoKCQkJCQlqb2ludC52aXNpYmxlID0gam9pbnRQb3NlICE9PSBudWxsOwoKCQkJCX0KCgkJCQkvLyBDdXN0b20gZXZlbnRzCgoJCQkJLy8gQ2hlY2sgcGluY2h6CgkJCQljb25zdCBpbmRleFRpcCA9IGhhbmQuam9pbnRzWyAnaW5kZXgtZmluZ2VyLXRpcCcgXTsKCQkJCWNvbnN0IHRodW1iVGlwID0gaGFuZC5qb2ludHNbICd0aHVtYi10aXAnIF07CgkJCQljb25zdCBkaXN0YW5jZSA9IGluZGV4VGlwLnBvc2l0aW9uLmRpc3RhbmNlVG8oIHRodW1iVGlwLnBvc2l0aW9uICk7CgoJCQkJY29uc3QgZGlzdGFuY2VUb1BpbmNoID0gMC4wMjsKCQkJCWNvbnN0IHRocmVzaG9sZCA9IDAuMDA1OwoKCQkJCWlmICggaGFuZC5pbnB1dFN0YXRlLnBpbmNoaW5nICYmIGRpc3RhbmNlID4gZGlzdGFuY2VUb1BpbmNoICsgdGhyZXNob2xkICkgewoKCQkJCQloYW5kLmlucHV0U3RhdGUucGluY2hpbmcgPSBmYWxzZTsKCQkJCQl0aGlzLmRpc3BhdGNoRXZlbnQoIHsKCQkJCQkJdHlwZTogJ3BpbmNoZW5kJywKCQkJCQkJaGFuZGVkbmVzczogaW5wdXRTb3VyY2UuaGFuZGVkbmVzcywKCQkJCQkJdGFyZ2V0OiB0aGlzCgkJCQkJfSApOwoKCQkJCX0gZWxzZSBpZiAoICEgaGFuZC5pbnB1dFN0YXRlLnBpbmNoaW5nICYmIGRpc3RhbmNlIDw9IGRpc3RhbmNlVG9QaW5jaCAtIHRocmVzaG9sZCApIHsKCgkJCQkJaGFuZC5pbnB1dFN0YXRlLnBpbmNoaW5nID0gdHJ1ZTsKCQkJCQl0aGlzLmRpc3BhdGNoRXZlbnQoIHsKCQkJCQkJdHlwZTogJ3BpbmNoc3RhcnQnLAoJCQkJCQloYW5kZWRuZXNzOiBpbnB1dFNvdXJjZS5oYW5kZWRuZXNzLAoJCQkJCQl0YXJnZXQ6IHRoaXMKCQkJCQl9ICk7CgoJCQkJfQoKCQkJfSBlbHNlIHsKCgkJCQlpZiAoIGdyaXAgIT09IG51bGwgJiYgaW5wdXRTb3VyY2UuZ3JpcFNwYWNlICkgewoKCQkJCQlncmlwUG9zZSA9IGZyYW1lLmdldFBvc2UoIGlucHV0U291cmNlLmdyaXBTcGFjZSwgcmVmZXJlbmNlU3BhY2UgKTsKCgkJCQkJaWYgKCBncmlwUG9zZSAhPT0gbnVsbCApIHsKCgkJCQkJCWdyaXAubWF0cml4LmZyb21BcnJheSggZ3JpcFBvc2UudHJhbnNmb3JtLm1hdHJpeCApOwoJCQkJCQlncmlwLm1hdHJpeC5kZWNvbXBvc2UoIGdyaXAucG9zaXRpb24sIGdyaXAucm90YXRpb24sIGdyaXAuc2NhbGUgKTsKCQkJCQkJZ3JpcC5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJCQkJCWlmICggZ3JpcFBvc2UubGluZWFyVmVsb2NpdHkgKSB7CgoJCQkJCQkJZ3JpcC5oYXNMaW5lYXJWZWxvY2l0eSA9IHRydWU7CgkJCQkJCQlncmlwLmxpbmVhclZlbG9jaXR5LmNvcHkoIGdyaXBQb3NlLmxpbmVhclZlbG9jaXR5ICk7CgoJCQkJCQl9IGVsc2UgewoKCQkJCQkJCWdyaXAuaGFzTGluZWFyVmVsb2NpdHkgPSBmYWxzZTsKCgkJCQkJCX0KCgkJCQkJCWlmICggZ3JpcFBvc2UuYW5ndWxhclZlbG9jaXR5ICkgewoKCQkJCQkJCWdyaXAuaGFzQW5ndWxhclZlbG9jaXR5ID0gdHJ1ZTsKCQkJCQkJCWdyaXAuYW5ndWxhclZlbG9jaXR5LmNvcHkoIGdyaXBQb3NlLmFuZ3VsYXJWZWxvY2l0eSApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQlncmlwLmhhc0FuZ3VsYXJWZWxvY2l0eSA9IGZhbHNlOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQkJaWYgKCB0YXJnZXRSYXkgIT09IG51bGwgKSB7CgoJCQkJaW5wdXRQb3NlID0gZnJhbWUuZ2V0UG9zZSggaW5wdXRTb3VyY2UudGFyZ2V0UmF5U3BhY2UsIHJlZmVyZW5jZVNwYWNlICk7CgoJCQkJLy8gU29tZSBydW50aW1lcyAobmFtZWx5IFZpdmUgQ29zbW9zIHdpdGggVml2ZSBPcGVuWFIgUnVudGltZSkgaGF2ZSBvbmx5IGdyaXAgc3BhY2UgYW5kIHJheSBzcGFjZSBpcyBlcXVhbCB0byBpdAoJCQkJaWYgKCBpbnB1dFBvc2UgPT09IG51bGwgJiYgZ3JpcFBvc2UgIT09IG51bGwgKSB7CgoJCQkJCWlucHV0UG9zZSA9IGdyaXBQb3NlOwoKCQkJCX0KCgkJCQlpZiAoIGlucHV0UG9zZSAhPT0gbnVsbCApIHsKCgkJCQkJdGFyZ2V0UmF5Lm1hdHJpeC5mcm9tQXJyYXkoIGlucHV0UG9zZS50cmFuc2Zvcm0ubWF0cml4ICk7CgkJCQkJdGFyZ2V0UmF5Lm1hdHJpeC5kZWNvbXBvc2UoIHRhcmdldFJheS5wb3NpdGlvbiwgdGFyZ2V0UmF5LnJvdGF0aW9uLCB0YXJnZXRSYXkuc2NhbGUgKTsKCQkJCQl0YXJnZXRSYXkubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9IHRydWU7CgoJCQkJCWlmICggaW5wdXRQb3NlLmxpbmVhclZlbG9jaXR5ICkgewoKCQkJCQkJdGFyZ2V0UmF5Lmhhc0xpbmVhclZlbG9jaXR5ID0gdHJ1ZTsKCQkJCQkJdGFyZ2V0UmF5LmxpbmVhclZlbG9jaXR5LmNvcHkoIGlucHV0UG9zZS5saW5lYXJWZWxvY2l0eSApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJdGFyZ2V0UmF5Lmhhc0xpbmVhclZlbG9jaXR5ID0gZmFsc2U7CgoJCQkJCX0KCgkJCQkJaWYgKCBpbnB1dFBvc2UuYW5ndWxhclZlbG9jaXR5ICkgewoKCQkJCQkJdGFyZ2V0UmF5Lmhhc0FuZ3VsYXJWZWxvY2l0eSA9IHRydWU7CgkJCQkJCXRhcmdldFJheS5hbmd1bGFyVmVsb2NpdHkuY29weSggaW5wdXRQb3NlLmFuZ3VsYXJWZWxvY2l0eSApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJdGFyZ2V0UmF5Lmhhc0FuZ3VsYXJWZWxvY2l0eSA9IGZhbHNlOwoKCQkJCQl9CgoJCQkJCXRoaXMuZGlzcGF0Y2hFdmVudCggX21vdmVFdmVudCApOwoKCQkJCX0KCgkJCX0KCgoJCX0KCgkJaWYgKCB0YXJnZXRSYXkgIT09IG51bGwgKSB7CgoJCQl0YXJnZXRSYXkudmlzaWJsZSA9ICggaW5wdXRQb3NlICE9PSBudWxsICk7CgoJCX0KCgkJaWYgKCBncmlwICE9PSBudWxsICkgewoKCQkJZ3JpcC52aXNpYmxlID0gKCBncmlwUG9zZSAhPT0gbnVsbCApOwoKCQl9CgoJCWlmICggaGFuZCAhPT0gbnVsbCApIHsKCgkJCWhhbmQudmlzaWJsZSA9ICggaGFuZFBvc2UgIT09IG51bGwgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJLy8gcHJpdmF0ZSBtZXRob2QKCglfZ2V0SGFuZEpvaW50KCBoYW5kLCBpbnB1dGpvaW50ICkgewoKCQlpZiAoIGhhbmQuam9pbnRzWyBpbnB1dGpvaW50LmpvaW50TmFtZSBdID09PSB1bmRlZmluZWQgKSB7CgoJCQljb25zdCBqb2ludCA9IG5ldyBHcm91cCgpOwoJCQlqb2ludC5tYXRyaXhBdXRvVXBkYXRlID0gZmFsc2U7CgkJCWpvaW50LnZpc2libGUgPSBmYWxzZTsKCQkJaGFuZC5qb2ludHNbIGlucHV0am9pbnQuam9pbnROYW1lIF0gPSBqb2ludDsKCgkJCWhhbmQuYWRkKCBqb2ludCApOwoKCQl9CgoJCXJldHVybiBoYW5kLmpvaW50c1sgaW5wdXRqb2ludC5qb2ludE5hbWUgXTsKCgl9Cgp9Cgpjb25zdCBfb2NjbHVzaW9uX3ZlcnRleCA9IGAKdm9pZCBtYWluKCkgewoKCWdsX1Bvc2l0aW9uID0gdmVjNCggcG9zaXRpb24sIDEuMCApOwoKfWA7Cgpjb25zdCBfb2NjbHVzaW9uX2ZyYWdtZW50ID0gYAp1bmlmb3JtIHNhbXBsZXIyREFycmF5IGRlcHRoQ29sb3I7CnVuaWZvcm0gZmxvYXQgZGVwdGhXaWR0aDsKdW5pZm9ybSBmbG9hdCBkZXB0aEhlaWdodDsKCnZvaWQgbWFpbigpIHsKCgl2ZWMyIGNvb3JkID0gdmVjMiggZ2xfRnJhZ0Nvb3JkLnggLyBkZXB0aFdpZHRoLCBnbF9GcmFnQ29vcmQueSAvIGRlcHRoSGVpZ2h0ICk7CgoJaWYgKCBjb29yZC54ID49IDEuMCApIHsKCgkJZ2xfRnJhZ0RlcHRoRVhUID0gdGV4dHVyZSggZGVwdGhDb2xvciwgdmVjMyggY29vcmQueCAtIDEuMCwgY29vcmQueSwgMSApICkucjsKCgl9IGVsc2UgewoKCQlnbF9GcmFnRGVwdGhFWFQgPSB0ZXh0dXJlKCBkZXB0aENvbG9yLCB2ZWMzKCBjb29yZC54LCBjb29yZC55LCAwICkgKS5yOwoKCX0KCn1gOwoKY2xhc3MgV2ViWFJEZXB0aFNlbnNpbmcgewoKCWNvbnN0cnVjdG9yKCkgewoKCQl0aGlzLnRleHR1cmUgPSBudWxsOwoJCXRoaXMubWVzaCA9IG51bGw7CgoJCXRoaXMuZGVwdGhOZWFyID0gMDsKCQl0aGlzLmRlcHRoRmFyID0gMDsKCgl9CgoJaW5pdCggcmVuZGVyZXIsIGRlcHRoRGF0YSwgcmVuZGVyU3RhdGUgKSB7CgoJCWlmICggdGhpcy50ZXh0dXJlID09PSBudWxsICkgewoKCQkJY29uc3QgdGV4dHVyZSA9IG5ldyBUZXh0dXJlKCk7CgoJCQljb25zdCB0ZXhQcm9wcyA9IHJlbmRlcmVyLnByb3BlcnRpZXMuZ2V0KCB0ZXh0dXJlICk7CgkJCXRleFByb3BzLl9fd2ViZ2xUZXh0dXJlID0gZGVwdGhEYXRhLnRleHR1cmU7CgoJCQlpZiAoICggZGVwdGhEYXRhLmRlcHRoTmVhciAhPSByZW5kZXJTdGF0ZS5kZXB0aE5lYXIgKSB8fCAoIGRlcHRoRGF0YS5kZXB0aEZhciAhPSByZW5kZXJTdGF0ZS5kZXB0aEZhciApICkgewoKCQkJCXRoaXMuZGVwdGhOZWFyID0gZGVwdGhEYXRhLmRlcHRoTmVhcjsKCQkJCXRoaXMuZGVwdGhGYXIgPSBkZXB0aERhdGEuZGVwdGhGYXI7CgoJCQl9CgoJCQl0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwoKCQl9CgoJfQoKCXJlbmRlciggcmVuZGVyZXIsIGNhbWVyYVhSICkgewoKCQlpZiAoIHRoaXMudGV4dHVyZSAhPT0gbnVsbCApIHsKCgkJCWlmICggdGhpcy5tZXNoID09PSBudWxsICkgewoKCQkJCWNvbnN0IHZpZXdwb3J0ID0gY2FtZXJhWFIuY2FtZXJhc1sgMCBdLnZpZXdwb3J0OwoJCQkJY29uc3QgbWF0ZXJpYWwgPSBuZXcgU2hhZGVyTWF0ZXJpYWwoIHsKCQkJCQlleHRlbnNpb25zOiB7IGZyYWdEZXB0aDogdHJ1ZSB9LAoJCQkJCXZlcnRleFNoYWRlcjogX29jY2x1c2lvbl92ZXJ0ZXgsCgkJCQkJZnJhZ21lbnRTaGFkZXI6IF9vY2NsdXNpb25fZnJhZ21lbnQsCgkJCQkJdW5pZm9ybXM6IHsKCQkJCQkJZGVwdGhDb2xvcjogeyB2YWx1ZTogdGhpcy50ZXh0dXJlIH0sCgkJCQkJCWRlcHRoV2lkdGg6IHsgdmFsdWU6IHZpZXdwb3J0LnogfSwKCQkJCQkJZGVwdGhIZWlnaHQ6IHsgdmFsdWU6IHZpZXdwb3J0LncgfQoJCQkJCX0KCQkJCX0gKTsKCgkJCQl0aGlzLm1lc2ggPSBuZXcgTWVzaCggbmV3IFBsYW5lR2VvbWV0cnkoIDIwLCAyMCApLCBtYXRlcmlhbCApOwoKCQkJfQoKCQkJcmVuZGVyZXIucmVuZGVyKCB0aGlzLm1lc2gsIGNhbWVyYVhSICk7CgoJCX0KCgl9CgoJcmVzZXQoKSB7CgoJCXRoaXMudGV4dHVyZSA9IG51bGw7CgkJdGhpcy5tZXNoID0gbnVsbDsKCgl9Cgp9CgpjbGFzcyBXZWJYUk1hbmFnZXIgZXh0ZW5kcyBFdmVudERpc3BhdGNoZXIgewoKCWNvbnN0cnVjdG9yKCByZW5kZXJlciwgZ2wgKSB7CgoJCXN1cGVyKCk7CgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJbGV0IHNlc3Npb24gPSBudWxsOwoKCQlsZXQgZnJhbWVidWZmZXJTY2FsZUZhY3RvciA9IDEuMDsKCgkJbGV0IHJlZmVyZW5jZVNwYWNlID0gbnVsbDsKCQlsZXQgcmVmZXJlbmNlU3BhY2VUeXBlID0gJ2xvY2FsLWZsb29yJzsKCQkvLyBTZXQgZGVmYXVsdCBmb3ZlYXRpb24gdG8gbWF4aW11bS4KCQlsZXQgZm92ZWF0aW9uID0gMS4wOwoJCWxldCBjdXN0b21SZWZlcmVuY2VTcGFjZSA9IG51bGw7CgoJCWxldCBwb3NlID0gbnVsbDsKCQlsZXQgZ2xCaW5kaW5nID0gbnVsbDsKCQlsZXQgZ2xQcm9qTGF5ZXIgPSBudWxsOwoJCWxldCBnbEJhc2VMYXllciA9IG51bGw7CgkJbGV0IHhyRnJhbWUgPSBudWxsOwoKCQljb25zdCBkZXB0aFNlbnNpbmcgPSBuZXcgV2ViWFJEZXB0aFNlbnNpbmcoKTsKCQljb25zdCBhdHRyaWJ1dGVzID0gZ2wuZ2V0Q29udGV4dEF0dHJpYnV0ZXMoKTsKCgkJbGV0IGluaXRpYWxSZW5kZXJUYXJnZXQgPSBudWxsOwoJCWxldCBuZXdSZW5kZXJUYXJnZXQgPSBudWxsOwoKCQljb25zdCBjb250cm9sbGVycyA9IFtdOwoJCWNvbnN0IGNvbnRyb2xsZXJJbnB1dFNvdXJjZXMgPSBbXTsKCgkJY29uc3QgY3VycmVudFNpemUgPSBuZXcgVmVjdG9yMigpOwoJCWxldCBjdXJyZW50UGl4ZWxSYXRpbyA9IG51bGw7CgoJCS8vCgoJCWNvbnN0IGNhbWVyYUwgPSBuZXcgUGVyc3BlY3RpdmVDYW1lcmEoKTsKCQljYW1lcmFMLmxheWVycy5lbmFibGUoIDEgKTsKCQljYW1lcmFMLnZpZXdwb3J0ID0gbmV3IFZlY3RvcjQoKTsKCgkJY29uc3QgY2FtZXJhUiA9IG5ldyBQZXJzcGVjdGl2ZUNhbWVyYSgpOwoJCWNhbWVyYVIubGF5ZXJzLmVuYWJsZSggMiApOwoJCWNhbWVyYVIudmlld3BvcnQgPSBuZXcgVmVjdG9yNCgpOwoKCQljb25zdCBjYW1lcmFzID0gWyBjYW1lcmFMLCBjYW1lcmFSIF07CgoJCWNvbnN0IGNhbWVyYVhSID0gbmV3IEFycmF5Q2FtZXJhKCk7CgkJY2FtZXJhWFIubGF5ZXJzLmVuYWJsZSggMSApOwoJCWNhbWVyYVhSLmxheWVycy5lbmFibGUoIDIgKTsKCgkJbGV0IF9jdXJyZW50RGVwdGhOZWFyID0gbnVsbDsKCQlsZXQgX2N1cnJlbnREZXB0aEZhciA9IG51bGw7CgoJCS8vCgoJCXRoaXMuY2FtZXJhQXV0b1VwZGF0ZSA9IHRydWU7CgkJdGhpcy5lbmFibGVkID0gZmFsc2U7CgoJCXRoaXMuaXNQcmVzZW50aW5nID0gZmFsc2U7CgoJCXRoaXMuZ2V0Q29udHJvbGxlciA9IGZ1bmN0aW9uICggaW5kZXggKSB7CgoJCQlsZXQgY29udHJvbGxlciA9IGNvbnRyb2xsZXJzWyBpbmRleCBdOwoKCQkJaWYgKCBjb250cm9sbGVyID09PSB1bmRlZmluZWQgKSB7CgoJCQkJY29udHJvbGxlciA9IG5ldyBXZWJYUkNvbnRyb2xsZXIoKTsKCQkJCWNvbnRyb2xsZXJzWyBpbmRleCBdID0gY29udHJvbGxlcjsKCgkJCX0KCgkJCXJldHVybiBjb250cm9sbGVyLmdldFRhcmdldFJheVNwYWNlKCk7CgoJCX07CgoJCXRoaXMuZ2V0Q29udHJvbGxlckdyaXAgPSBmdW5jdGlvbiAoIGluZGV4ICkgewoKCQkJbGV0IGNvbnRyb2xsZXIgPSBjb250cm9sbGVyc1sgaW5kZXggXTsKCgkJCWlmICggY29udHJvbGxlciA9PT0gdW5kZWZpbmVkICkgewoKCQkJCWNvbnRyb2xsZXIgPSBuZXcgV2ViWFJDb250cm9sbGVyKCk7CgkJCQljb250cm9sbGVyc1sgaW5kZXggXSA9IGNvbnRyb2xsZXI7CgoJCQl9CgoJCQlyZXR1cm4gY29udHJvbGxlci5nZXRHcmlwU3BhY2UoKTsKCgkJfTsKCgkJdGhpcy5nZXRIYW5kID0gZnVuY3Rpb24gKCBpbmRleCApIHsKCgkJCWxldCBjb250cm9sbGVyID0gY29udHJvbGxlcnNbIGluZGV4IF07CgoJCQlpZiAoIGNvbnRyb2xsZXIgPT09IHVuZGVmaW5lZCApIHsKCgkJCQljb250cm9sbGVyID0gbmV3IFdlYlhSQ29udHJvbGxlcigpOwoJCQkJY29udHJvbGxlcnNbIGluZGV4IF0gPSBjb250cm9sbGVyOwoKCQkJfQoKCQkJcmV0dXJuIGNvbnRyb2xsZXIuZ2V0SGFuZFNwYWNlKCk7CgoJCX07CgoJCS8vCgoJCWZ1bmN0aW9uIG9uU2Vzc2lvbkV2ZW50KCBldmVudCApIHsKCgkJCWNvbnN0IGNvbnRyb2xsZXJJbmRleCA9IGNvbnRyb2xsZXJJbnB1dFNvdXJjZXMuaW5kZXhPZiggZXZlbnQuaW5wdXRTb3VyY2UgKTsKCgkJCWlmICggY29udHJvbGxlckluZGV4ID09PSAtIDEgKSB7CgoJCQkJcmV0dXJuOwoKCQkJfQoKCQkJY29uc3QgY29udHJvbGxlciA9IGNvbnRyb2xsZXJzWyBjb250cm9sbGVySW5kZXggXTsKCgkJCWlmICggY29udHJvbGxlciAhPT0gdW5kZWZpbmVkICkgewoKCQkJCWNvbnRyb2xsZXIudXBkYXRlKCBldmVudC5pbnB1dFNvdXJjZSwgZXZlbnQuZnJhbWUsIGN1c3RvbVJlZmVyZW5jZVNwYWNlIHx8IHJlZmVyZW5jZVNwYWNlICk7CgkJCQljb250cm9sbGVyLmRpc3BhdGNoRXZlbnQoIHsgdHlwZTogZXZlbnQudHlwZSwgZGF0YTogZXZlbnQuaW5wdXRTb3VyY2UgfSApOwoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIG9uU2Vzc2lvbkVuZCgpIHsKCgkJCXNlc3Npb24ucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3NlbGVjdCcsIG9uU2Vzc2lvbkV2ZW50ICk7CgkJCXNlc3Npb24ucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3NlbGVjdHN0YXJ0Jywgb25TZXNzaW9uRXZlbnQgKTsKCQkJc2Vzc2lvbi5yZW1vdmVFdmVudExpc3RlbmVyKCAnc2VsZWN0ZW5kJywgb25TZXNzaW9uRXZlbnQgKTsKCQkJc2Vzc2lvbi5yZW1vdmVFdmVudExpc3RlbmVyKCAnc3F1ZWV6ZScsIG9uU2Vzc2lvbkV2ZW50ICk7CgkJCXNlc3Npb24ucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3NxdWVlemVzdGFydCcsIG9uU2Vzc2lvbkV2ZW50ICk7CgkJCXNlc3Npb24ucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3NxdWVlemVlbmQnLCBvblNlc3Npb25FdmVudCApOwoJCQlzZXNzaW9uLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdlbmQnLCBvblNlc3Npb25FbmQgKTsKCQkJc2Vzc2lvbi5yZW1vdmVFdmVudExpc3RlbmVyKCAnaW5wdXRzb3VyY2VzY2hhbmdlJywgb25JbnB1dFNvdXJjZXNDaGFuZ2UgKTsKCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IGNvbnRyb2xsZXJzLmxlbmd0aDsgaSArKyApIHsKCgkJCQljb25zdCBpbnB1dFNvdXJjZSA9IGNvbnRyb2xsZXJJbnB1dFNvdXJjZXNbIGkgXTsKCgkJCQlpZiAoIGlucHV0U291cmNlID09PSBudWxsICkgY29udGludWU7CgoJCQkJY29udHJvbGxlcklucHV0U291cmNlc1sgaSBdID0gbnVsbDsKCgkJCQljb250cm9sbGVyc1sgaSBdLmRpc2Nvbm5lY3QoIGlucHV0U291cmNlICk7CgoJCQl9CgoJCQlfY3VycmVudERlcHRoTmVhciA9IG51bGw7CgkJCV9jdXJyZW50RGVwdGhGYXIgPSBudWxsOwoKCQkJZGVwdGhTZW5zaW5nLnJlc2V0KCk7CgoJCQkvLyByZXN0b3JlIGZyYW1lYnVmZmVyL3JlbmRlcmluZyBzdGF0ZQoKCQkJcmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KCBpbml0aWFsUmVuZGVyVGFyZ2V0ICk7CgoJCQlnbEJhc2VMYXllciA9IG51bGw7CgkJCWdsUHJvakxheWVyID0gbnVsbDsKCQkJZ2xCaW5kaW5nID0gbnVsbDsKCQkJc2Vzc2lvbiA9IG51bGw7CgkJCW5ld1JlbmRlclRhcmdldCA9IG51bGw7CgoJCQkvLwoKCQkJYW5pbWF0aW9uLnN0b3AoKTsKCgkJCXNjb3BlLmlzUHJlc2VudGluZyA9IGZhbHNlOwoKCQkJcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbyggY3VycmVudFBpeGVsUmF0aW8gKTsKCQkJcmVuZGVyZXIuc2V0U2l6ZSggY3VycmVudFNpemUud2lkdGgsIGN1cnJlbnRTaXplLmhlaWdodCwgZmFsc2UgKTsKCgkJCXNjb3BlLmRpc3BhdGNoRXZlbnQoIHsgdHlwZTogJ3Nlc3Npb25lbmQnIH0gKTsKCgkJfQoKCQl0aGlzLnNldEZyYW1lYnVmZmVyU2NhbGVGYWN0b3IgPSBmdW5jdGlvbiAoIHZhbHVlICkgewoKCQkJZnJhbWVidWZmZXJTY2FsZUZhY3RvciA9IHZhbHVlOwoKCQkJaWYgKCBzY29wZS5pc1ByZXNlbnRpbmcgPT09IHRydWUgKSB7CgoJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViWFJNYW5hZ2VyOiBDYW5ub3QgY2hhbmdlIGZyYW1lYnVmZmVyIHNjYWxlIHdoaWxlIHByZXNlbnRpbmcuJyApOwoKCQkJfQoKCQl9OwoKCQl0aGlzLnNldFJlZmVyZW5jZVNwYWNlVHlwZSA9IGZ1bmN0aW9uICggdmFsdWUgKSB7CgoJCQlyZWZlcmVuY2VTcGFjZVR5cGUgPSB2YWx1ZTsKCgkJCWlmICggc2NvcGUuaXNQcmVzZW50aW5nID09PSB0cnVlICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYlhSTWFuYWdlcjogQ2Fubm90IGNoYW5nZSByZWZlcmVuY2Ugc3BhY2UgdHlwZSB3aGlsZSBwcmVzZW50aW5nLicgKTsKCgkJCX0KCgkJfTsKCgkJdGhpcy5nZXRSZWZlcmVuY2VTcGFjZSA9IGZ1bmN0aW9uICgpIHsKCgkJCXJldHVybiBjdXN0b21SZWZlcmVuY2VTcGFjZSB8fCByZWZlcmVuY2VTcGFjZTsKCgkJfTsKCgkJdGhpcy5zZXRSZWZlcmVuY2VTcGFjZSA9IGZ1bmN0aW9uICggc3BhY2UgKSB7CgoJCQljdXN0b21SZWZlcmVuY2VTcGFjZSA9IHNwYWNlOwoKCQl9OwoKCQl0aGlzLmdldEJhc2VMYXllciA9IGZ1bmN0aW9uICgpIHsKCgkJCXJldHVybiBnbFByb2pMYXllciAhPT0gbnVsbCA/IGdsUHJvakxheWVyIDogZ2xCYXNlTGF5ZXI7CgoJCX07CgoJCXRoaXMuZ2V0QmluZGluZyA9IGZ1bmN0aW9uICgpIHsKCgkJCXJldHVybiBnbEJpbmRpbmc7CgoJCX07CgoJCXRoaXMuZ2V0RnJhbWUgPSBmdW5jdGlvbiAoKSB7CgoJCQlyZXR1cm4geHJGcmFtZTsKCgkJfTsKCgkJdGhpcy5nZXRTZXNzaW9uID0gZnVuY3Rpb24gKCkgewoKCQkJcmV0dXJuIHNlc3Npb247CgoJCX07CgoJCXRoaXMuc2V0U2Vzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uICggdmFsdWUgKSB7CgoJCQlzZXNzaW9uID0gdmFsdWU7CgoJCQlpZiAoIHNlc3Npb24gIT09IG51bGwgKSB7CgoJCQkJaW5pdGlhbFJlbmRlclRhcmdldCA9IHJlbmRlcmVyLmdldFJlbmRlclRhcmdldCgpOwoKCQkJCXNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lciggJ3NlbGVjdCcsIG9uU2Vzc2lvbkV2ZW50ICk7CgkJCQlzZXNzaW9uLmFkZEV2ZW50TGlzdGVuZXIoICdzZWxlY3RzdGFydCcsIG9uU2Vzc2lvbkV2ZW50ICk7CgkJCQlzZXNzaW9uLmFkZEV2ZW50TGlzdGVuZXIoICdzZWxlY3RlbmQnLCBvblNlc3Npb25FdmVudCApOwoJCQkJc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCAnc3F1ZWV6ZScsIG9uU2Vzc2lvbkV2ZW50ICk7CgkJCQlzZXNzaW9uLmFkZEV2ZW50TGlzdGVuZXIoICdzcXVlZXplc3RhcnQnLCBvblNlc3Npb25FdmVudCApOwoJCQkJc2Vzc2lvbi5hZGRFdmVudExpc3RlbmVyKCAnc3F1ZWV6ZWVuZCcsIG9uU2Vzc2lvbkV2ZW50ICk7CgkJCQlzZXNzaW9uLmFkZEV2ZW50TGlzdGVuZXIoICdlbmQnLCBvblNlc3Npb25FbmQgKTsKCQkJCXNlc3Npb24uYWRkRXZlbnRMaXN0ZW5lciggJ2lucHV0c291cmNlc2NoYW5nZScsIG9uSW5wdXRTb3VyY2VzQ2hhbmdlICk7CgoJCQkJaWYgKCBhdHRyaWJ1dGVzLnhyQ29tcGF0aWJsZSAhPT0gdHJ1ZSApIHsKCgkJCQkJYXdhaXQgZ2wubWFrZVhSQ29tcGF0aWJsZSgpOwoKCQkJCX0KCgkJCQljdXJyZW50UGl4ZWxSYXRpbyA9IHJlbmRlcmVyLmdldFBpeGVsUmF0aW8oKTsKCQkJCXJlbmRlcmVyLmdldFNpemUoIGN1cnJlbnRTaXplICk7CgoJCQkJaWYgKCAoIHNlc3Npb24ucmVuZGVyU3RhdGUubGF5ZXJzID09PSB1bmRlZmluZWQgKSB8fCAoIHJlbmRlcmVyLmNhcGFiaWxpdGllcy5pc1dlYkdMMiA9PT0gZmFsc2UgKSApIHsKCgkJCQkJY29uc3QgbGF5ZXJJbml0ID0gewoJCQkJCQlhbnRpYWxpYXM6ICggc2Vzc2lvbi5yZW5kZXJTdGF0ZS5sYXllcnMgPT09IHVuZGVmaW5lZCApID8gYXR0cmlidXRlcy5hbnRpYWxpYXMgOiB0cnVlLAoJCQkJCQlhbHBoYTogdHJ1ZSwKCQkJCQkJZGVwdGg6IGF0dHJpYnV0ZXMuZGVwdGgsCgkJCQkJCXN0ZW5jaWw6IGF0dHJpYnV0ZXMuc3RlbmNpbCwKCQkJCQkJZnJhbWVidWZmZXJTY2FsZUZhY3RvcjogZnJhbWVidWZmZXJTY2FsZUZhY3RvcgoJCQkJCX07CgoJCQkJCWdsQmFzZUxheWVyID0gbmV3IFhSV2ViR0xMYXllciggc2Vzc2lvbiwgZ2wsIGxheWVySW5pdCApOwoKCQkJCQlzZXNzaW9uLnVwZGF0ZVJlbmRlclN0YXRlKCB7IGJhc2VMYXllcjogZ2xCYXNlTGF5ZXIgfSApOwoKCQkJCQlyZW5kZXJlci5zZXRQaXhlbFJhdGlvKCAxICk7CgkJCQkJcmVuZGVyZXIuc2V0U2l6ZSggZ2xCYXNlTGF5ZXIuZnJhbWVidWZmZXJXaWR0aCwgZ2xCYXNlTGF5ZXIuZnJhbWVidWZmZXJIZWlnaHQsIGZhbHNlICk7CgoJCQkJCW5ld1JlbmRlclRhcmdldCA9IG5ldyBXZWJHTFJlbmRlclRhcmdldCgKCQkJCQkJZ2xCYXNlTGF5ZXIuZnJhbWVidWZmZXJXaWR0aCwKCQkJCQkJZ2xCYXNlTGF5ZXIuZnJhbWVidWZmZXJIZWlnaHQsCgkJCQkJCXsKCQkJCQkJCWZvcm1hdDogUkdCQUZvcm1hdCwKCQkJCQkJCXR5cGU6IFVuc2lnbmVkQnl0ZVR5cGUsCgkJCQkJCQljb2xvclNwYWNlOiByZW5kZXJlci5vdXRwdXRDb2xvclNwYWNlLAoJCQkJCQkJc3RlbmNpbEJ1ZmZlcjogYXR0cmlidXRlcy5zdGVuY2lsCgkJCQkJCX0KCQkJCQkpOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWxldCBkZXB0aEZvcm1hdCA9IG51bGw7CgkJCQkJbGV0IGRlcHRoVHlwZSA9IG51bGw7CgkJCQkJbGV0IGdsRGVwdGhGb3JtYXQgPSBudWxsOwoKCQkJCQlpZiAoIGF0dHJpYnV0ZXMuZGVwdGggKSB7CgoJCQkJCQlnbERlcHRoRm9ybWF0ID0gYXR0cmlidXRlcy5zdGVuY2lsID8gZ2wuREVQVEgyNF9TVEVOQ0lMOCA6IGdsLkRFUFRIX0NPTVBPTkVOVDI0OwoJCQkJCQlkZXB0aEZvcm1hdCA9IGF0dHJpYnV0ZXMuc3RlbmNpbCA/IERlcHRoU3RlbmNpbEZvcm1hdCA6IERlcHRoRm9ybWF0OwoJCQkJCQlkZXB0aFR5cGUgPSBhdHRyaWJ1dGVzLnN0ZW5jaWwgPyBVbnNpZ25lZEludDI0OFR5cGUgOiBVbnNpZ25lZEludFR5cGU7CgoJCQkJCX0KCgkJCQkJY29uc3QgcHJvamVjdGlvbmxheWVySW5pdCA9IHsKCQkJCQkJY29sb3JGb3JtYXQ6IGdsLlJHQkE4LAoJCQkJCQlkZXB0aEZvcm1hdDogZ2xEZXB0aEZvcm1hdCwKCQkJCQkJc2NhbGVGYWN0b3I6IGZyYW1lYnVmZmVyU2NhbGVGYWN0b3IKCQkJCQl9OwoKCQkJCQlnbEJpbmRpbmcgPSBuZXcgWFJXZWJHTEJpbmRpbmcoIHNlc3Npb24sIGdsICk7CgoJCQkJCWdsUHJvakxheWVyID0gZ2xCaW5kaW5nLmNyZWF0ZVByb2plY3Rpb25MYXllciggcHJvamVjdGlvbmxheWVySW5pdCApOwoKCQkJCQlzZXNzaW9uLnVwZGF0ZVJlbmRlclN0YXRlKCB7IGxheWVyczogWyBnbFByb2pMYXllciBdIH0gKTsKCgkJCQkJcmVuZGVyZXIuc2V0UGl4ZWxSYXRpbyggMSApOwoJCQkJCXJlbmRlcmVyLnNldFNpemUoIGdsUHJvakxheWVyLnRleHR1cmVXaWR0aCwgZ2xQcm9qTGF5ZXIudGV4dHVyZUhlaWdodCwgZmFsc2UgKTsKCgkJCQkJbmV3UmVuZGVyVGFyZ2V0ID0gbmV3IFdlYkdMUmVuZGVyVGFyZ2V0KAoJCQkJCQlnbFByb2pMYXllci50ZXh0dXJlV2lkdGgsCgkJCQkJCWdsUHJvakxheWVyLnRleHR1cmVIZWlnaHQsCgkJCQkJCXsKCQkJCQkJCWZvcm1hdDogUkdCQUZvcm1hdCwKCQkJCQkJCXR5cGU6IFVuc2lnbmVkQnl0ZVR5cGUsCgkJCQkJCQlkZXB0aFRleHR1cmU6IG5ldyBEZXB0aFRleHR1cmUoIGdsUHJvakxheWVyLnRleHR1cmVXaWR0aCwgZ2xQcm9qTGF5ZXIudGV4dHVyZUhlaWdodCwgZGVwdGhUeXBlLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBkZXB0aEZvcm1hdCApLAoJCQkJCQkJc3RlbmNpbEJ1ZmZlcjogYXR0cmlidXRlcy5zdGVuY2lsLAoJCQkJCQkJY29sb3JTcGFjZTogcmVuZGVyZXIub3V0cHV0Q29sb3JTcGFjZSwKCQkJCQkJCXNhbXBsZXM6IGF0dHJpYnV0ZXMuYW50aWFsaWFzID8gNCA6IDAKCQkJCQkJfSApOwoKCQkJCQljb25zdCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzID0gcmVuZGVyZXIucHJvcGVydGllcy5nZXQoIG5ld1JlbmRlclRhcmdldCApOwoJCQkJCXJlbmRlclRhcmdldFByb3BlcnRpZXMuX19pZ25vcmVEZXB0aFZhbHVlcyA9IGdsUHJvakxheWVyLmlnbm9yZURlcHRoVmFsdWVzOwoKCQkJCX0KCgkJCQluZXdSZW5kZXJUYXJnZXQuaXNYUlJlbmRlclRhcmdldCA9IHRydWU7IC8vIFRPRE8gUmVtb3ZlIHRoaXMgd2hlbiBwb3NzaWJsZSwgc2VlICMyMzI3OAoKCQkJCXRoaXMuc2V0Rm92ZWF0aW9uKCBmb3ZlYXRpb24gKTsKCgkJCQljdXN0b21SZWZlcmVuY2VTcGFjZSA9IG51bGw7CgkJCQlyZWZlcmVuY2VTcGFjZSA9IGF3YWl0IHNlc3Npb24ucmVxdWVzdFJlZmVyZW5jZVNwYWNlKCByZWZlcmVuY2VTcGFjZVR5cGUgKTsKCgkJCQlhbmltYXRpb24uc2V0Q29udGV4dCggc2Vzc2lvbiApOwoJCQkJYW5pbWF0aW9uLnN0YXJ0KCk7CgoJCQkJc2NvcGUuaXNQcmVzZW50aW5nID0gdHJ1ZTsKCgkJCQlzY29wZS5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICdzZXNzaW9uc3RhcnQnIH0gKTsKCgkJCX0KCgkJfTsKCgkJdGhpcy5nZXRFbnZpcm9ubWVudEJsZW5kTW9kZSA9IGZ1bmN0aW9uICgpIHsKCgkJCWlmICggc2Vzc2lvbiAhPT0gbnVsbCApIHsKCgkJCQlyZXR1cm4gc2Vzc2lvbi5lbnZpcm9ubWVudEJsZW5kTW9kZTsKCgkJCX0KCgkJfTsKCgkJZnVuY3Rpb24gb25JbnB1dFNvdXJjZXNDaGFuZ2UoIGV2ZW50ICkgewoKCQkJLy8gTm90aWZ5IGRpc2Nvbm5lY3RlZAoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgZXZlbnQucmVtb3ZlZC5sZW5ndGg7IGkgKysgKSB7CgoJCQkJY29uc3QgaW5wdXRTb3VyY2UgPSBldmVudC5yZW1vdmVkWyBpIF07CgkJCQljb25zdCBpbmRleCA9IGNvbnRyb2xsZXJJbnB1dFNvdXJjZXMuaW5kZXhPZiggaW5wdXRTb3VyY2UgKTsKCgkJCQlpZiAoIGluZGV4ID49IDAgKSB7CgoJCQkJCWNvbnRyb2xsZXJJbnB1dFNvdXJjZXNbIGluZGV4IF0gPSBudWxsOwoJCQkJCWNvbnRyb2xsZXJzWyBpbmRleCBdLmRpc2Nvbm5lY3QoIGlucHV0U291cmNlICk7CgoJCQkJfQoKCQkJfQoKCQkJLy8gTm90aWZ5IGNvbm5lY3RlZAoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgZXZlbnQuYWRkZWQubGVuZ3RoOyBpICsrICkgewoKCQkJCWNvbnN0IGlucHV0U291cmNlID0gZXZlbnQuYWRkZWRbIGkgXTsKCgkJCQlsZXQgY29udHJvbGxlckluZGV4ID0gY29udHJvbGxlcklucHV0U291cmNlcy5pbmRleE9mKCBpbnB1dFNvdXJjZSApOwoKCQkJCWlmICggY29udHJvbGxlckluZGV4ID09PSAtIDEgKSB7CgoJCQkJCS8vIEFzc2lnbiBpbnB1dCBzb3VyY2UgYSBjb250cm9sbGVyIHRoYXQgY3VycmVudGx5IGhhcyBubyBpbnB1dCBzb3VyY2UKCgkJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgY29udHJvbGxlcnMubGVuZ3RoOyBpICsrICkgewoKCQkJCQkJaWYgKCBpID49IGNvbnRyb2xsZXJJbnB1dFNvdXJjZXMubGVuZ3RoICkgewoKCQkJCQkJCWNvbnRyb2xsZXJJbnB1dFNvdXJjZXMucHVzaCggaW5wdXRTb3VyY2UgKTsKCQkJCQkJCWNvbnRyb2xsZXJJbmRleCA9IGk7CgkJCQkJCQlicmVhazsKCgkJCQkJCX0gZWxzZSBpZiAoIGNvbnRyb2xsZXJJbnB1dFNvdXJjZXNbIGkgXSA9PT0gbnVsbCApIHsKCgkJCQkJCQljb250cm9sbGVySW5wdXRTb3VyY2VzWyBpIF0gPSBpbnB1dFNvdXJjZTsKCQkJCQkJCWNvbnRyb2xsZXJJbmRleCA9IGk7CgkJCQkJCQlicmVhazsKCgkJCQkJCX0KCgkJCQkJfQoKCQkJCQkvLyBJZiBhbGwgY29udHJvbGxlcnMgZG8gY3VycmVudGx5IHJlY2VpdmUgaW5wdXQgd2UgaWdub3JlIG5ldyBvbmVzCgoJCQkJCWlmICggY29udHJvbGxlckluZGV4ID09PSAtIDEgKSBicmVhazsKCgkJCQl9CgoJCQkJY29uc3QgY29udHJvbGxlciA9IGNvbnRyb2xsZXJzWyBjb250cm9sbGVySW5kZXggXTsKCgkJCQlpZiAoIGNvbnRyb2xsZXIgKSB7CgoJCQkJCWNvbnRyb2xsZXIuY29ubmVjdCggaW5wdXRTb3VyY2UgKTsKCgkJCQl9CgoJCQl9CgoJCX0KCgkJLy8KCgkJY29uc3QgY2FtZXJhTFBvcyA9IG5ldyBWZWN0b3IzKCk7CgkJY29uc3QgY2FtZXJhUlBvcyA9IG5ldyBWZWN0b3IzKCk7CgoJCS8qKgoJCSAqIEFzc3VtZXMgMiBjYW1lcmFzIHRoYXQgYXJlIHBhcmFsbGVsIGFuZCBzaGFyZSBhbiBYLWF4aXMsIGFuZCB0aGF0CgkJICogdGhlIGNhbWVyYXMnIHByb2plY3Rpb24gYW5kIHdvcmxkIG1hdHJpY2VzIGhhdmUgYWxyZWFkeSBiZWVuIHNldC4KCQkgKiBBbmQgdGhhdCBuZWFyIGFuZCBmYXIgcGxhbmVzIGFyZSBpZGVudGljYWwgZm9yIGJvdGggY2FtZXJhcy4KCQkgKiBWaXN1YWxpemF0aW9uIG9mIHRoaXMgdGVjaG5pcXVlOiBodHRwczovL2NvbXB1dGVyZ3JhcGhpY3Muc3RhY2tleGNoYW5nZS5jb20vYS80NzY1CgkJICovCgkJZnVuY3Rpb24gc2V0UHJvamVjdGlvbkZyb21VbmlvbiggY2FtZXJhLCBjYW1lcmFMLCBjYW1lcmFSICkgewoKCQkJY2FtZXJhTFBvcy5zZXRGcm9tTWF0cml4UG9zaXRpb24oIGNhbWVyYUwubWF0cml4V29ybGQgKTsKCQkJY2FtZXJhUlBvcy5zZXRGcm9tTWF0cml4UG9zaXRpb24oIGNhbWVyYVIubWF0cml4V29ybGQgKTsKCgkJCWNvbnN0IGlwZCA9IGNhbWVyYUxQb3MuZGlzdGFuY2VUbyggY2FtZXJhUlBvcyApOwoKCQkJY29uc3QgcHJvakwgPSBjYW1lcmFMLnByb2plY3Rpb25NYXRyaXguZWxlbWVudHM7CgkJCWNvbnN0IHByb2pSID0gY2FtZXJhUi5wcm9qZWN0aW9uTWF0cml4LmVsZW1lbnRzOwoKCQkJLy8gVlIgc3lzdGVtcyB3aWxsIGhhdmUgaWRlbnRpY2FsIGZhciBhbmQgbmVhciBwbGFuZXMsIGFuZAoJCQkvLyBtb3N0IGxpa2VseSBpZGVudGljYWwgdG9wIGFuZCBib3R0b20gZnJ1c3R1bSBleHRlbnRzLgoJCQkvLyBVc2UgdGhlIGxlZnQgY2FtZXJhIGZvciB0aGVzZSB2YWx1ZXMuCgkJCWNvbnN0IG5lYXIgPSBwcm9qTFsgMTQgXSAvICggcHJvakxbIDEwIF0gLSAxICk7CgkJCWNvbnN0IGZhciA9IHByb2pMWyAxNCBdIC8gKCBwcm9qTFsgMTAgXSArIDEgKTsKCQkJY29uc3QgdG9wRm92ID0gKCBwcm9qTFsgOSBdICsgMSApIC8gcHJvakxbIDUgXTsKCQkJY29uc3QgYm90dG9tRm92ID0gKCBwcm9qTFsgOSBdIC0gMSApIC8gcHJvakxbIDUgXTsKCgkJCWNvbnN0IGxlZnRGb3YgPSAoIHByb2pMWyA4IF0gLSAxICkgLyBwcm9qTFsgMCBdOwoJCQljb25zdCByaWdodEZvdiA9ICggcHJvalJbIDggXSArIDEgKSAvIHByb2pSWyAwIF07CgkJCWNvbnN0IGxlZnQgPSBuZWFyICogbGVmdEZvdjsKCQkJY29uc3QgcmlnaHQgPSBuZWFyICogcmlnaHRGb3Y7CgoJCQkvLyBDYWxjdWxhdGUgdGhlIG5ldyBjYW1lcmEncyBwb3NpdGlvbiBvZmZzZXQgZnJvbSB0aGUKCQkJLy8gbGVmdCBjYW1lcmEuIHhPZmZzZXQgc2hvdWxkIGJlIHJvdWdobHkgaGFsZiBgaXBkYC4KCQkJY29uc3Qgek9mZnNldCA9IGlwZCAvICggLSBsZWZ0Rm92ICsgcmlnaHRGb3YgKTsKCQkJY29uc3QgeE9mZnNldCA9IHpPZmZzZXQgKiAtIGxlZnRGb3Y7CgoJCQkvLyBUT0RPOiBCZXR0ZXIgd2F5IHRvIGFwcGx5IHRoaXMgb2Zmc2V0PwoJCQljYW1lcmFMLm1hdHJpeFdvcmxkLmRlY29tcG9zZSggY2FtZXJhLnBvc2l0aW9uLCBjYW1lcmEucXVhdGVybmlvbiwgY2FtZXJhLnNjYWxlICk7CgkJCWNhbWVyYS50cmFuc2xhdGVYKCB4T2Zmc2V0ICk7CgkJCWNhbWVyYS50cmFuc2xhdGVaKCB6T2Zmc2V0ICk7CgkJCWNhbWVyYS5tYXRyaXhXb3JsZC5jb21wb3NlKCBjYW1lcmEucG9zaXRpb24sIGNhbWVyYS5xdWF0ZXJuaW9uLCBjYW1lcmEuc2NhbGUgKTsKCQkJY2FtZXJhLm1hdHJpeFdvcmxkSW52ZXJzZS5jb3B5KCBjYW1lcmEubWF0cml4V29ybGQgKS5pbnZlcnQoKTsKCgkJCS8vIEZpbmQgdGhlIHVuaW9uIG9mIHRoZSBmcnVzdHVtIHZhbHVlcyBvZiB0aGUgY2FtZXJhcyBhbmQgc2NhbGUKCQkJLy8gdGhlIHZhbHVlcyBzbyB0aGF0IHRoZSBuZWFyIHBsYW5lJ3MgcG9zaXRpb24gZG9lcyBub3QgY2hhbmdlIGluIHdvcmxkIHNwYWNlLAoJCQkvLyBhbHRob3VnaCBtdXN0IG5vdyBiZSByZWxhdGl2ZSB0byB0aGUgbmV3IHVuaW9uIGNhbWVyYS4KCQkJY29uc3QgbmVhcjIgPSBuZWFyICsgek9mZnNldDsKCQkJY29uc3QgZmFyMiA9IGZhciArIHpPZmZzZXQ7CgkJCWNvbnN0IGxlZnQyID0gbGVmdCAtIHhPZmZzZXQ7CgkJCWNvbnN0IHJpZ2h0MiA9IHJpZ2h0ICsgKCBpcGQgLSB4T2Zmc2V0ICk7CgkJCWNvbnN0IHRvcDIgPSB0b3BGb3YgKiBmYXIgLyBmYXIyICogbmVhcjI7CgkJCWNvbnN0IGJvdHRvbTIgPSBib3R0b21Gb3YgKiBmYXIgLyBmYXIyICogbmVhcjI7CgoJCQljYW1lcmEucHJvamVjdGlvbk1hdHJpeC5tYWtlUGVyc3BlY3RpdmUoIGxlZnQyLCByaWdodDIsIHRvcDIsIGJvdHRvbTIsIG5lYXIyLCBmYXIyICk7CgkJCWNhbWVyYS5wcm9qZWN0aW9uTWF0cml4SW52ZXJzZS5jb3B5KCBjYW1lcmEucHJvamVjdGlvbk1hdHJpeCApLmludmVydCgpOwoKCQl9CgoJCWZ1bmN0aW9uIHVwZGF0ZUNhbWVyYSggY2FtZXJhLCBwYXJlbnQgKSB7CgoJCQlpZiAoIHBhcmVudCA9PT0gbnVsbCApIHsKCgkJCQljYW1lcmEubWF0cml4V29ybGQuY29weSggY2FtZXJhLm1hdHJpeCApOwoKCQkJfSBlbHNlIHsKCgkJCQljYW1lcmEubWF0cml4V29ybGQubXVsdGlwbHlNYXRyaWNlcyggcGFyZW50Lm1hdHJpeFdvcmxkLCBjYW1lcmEubWF0cml4ICk7CgoJCQl9CgoJCQljYW1lcmEubWF0cml4V29ybGRJbnZlcnNlLmNvcHkoIGNhbWVyYS5tYXRyaXhXb3JsZCApLmludmVydCgpOwoKCQl9CgoJCXRoaXMudXBkYXRlQ2FtZXJhID0gZnVuY3Rpb24gKCBjYW1lcmEgKSB7CgoJCQlpZiAoIHNlc3Npb24gPT09IG51bGwgKSByZXR1cm47CgoJCQlpZiAoIGRlcHRoU2Vuc2luZy50ZXh0dXJlICE9PSBudWxsICkgewoKCQkJCWNhbWVyYS5uZWFyID0gZGVwdGhTZW5zaW5nLmRlcHRoTmVhcjsKCQkJCWNhbWVyYS5mYXIgPSBkZXB0aFNlbnNpbmcuZGVwdGhGYXI7CgoJCQl9CgoJCQljYW1lcmFYUi5uZWFyID0gY2FtZXJhUi5uZWFyID0gY2FtZXJhTC5uZWFyID0gY2FtZXJhLm5lYXI7CgkJCWNhbWVyYVhSLmZhciA9IGNhbWVyYVIuZmFyID0gY2FtZXJhTC5mYXIgPSBjYW1lcmEuZmFyOwoKCQkJaWYgKCBfY3VycmVudERlcHRoTmVhciAhPT0gY2FtZXJhWFIubmVhciB8fCBfY3VycmVudERlcHRoRmFyICE9PSBjYW1lcmFYUi5mYXIgKSB7CgoJCQkJLy8gTm90ZSB0aGF0IHRoZSBuZXcgcmVuZGVyU3RhdGUgd29uJ3QgYXBwbHkgdW50aWwgdGhlIG5leHQgZnJhbWUuIFNlZSAjMTgzMjAKCgkJCQlzZXNzaW9uLnVwZGF0ZVJlbmRlclN0YXRlKCB7CgkJCQkJZGVwdGhOZWFyOiBjYW1lcmFYUi5uZWFyLAoJCQkJCWRlcHRoRmFyOiBjYW1lcmFYUi5mYXIKCQkJCX0gKTsKCgkJCQlfY3VycmVudERlcHRoTmVhciA9IGNhbWVyYVhSLm5lYXI7CgkJCQlfY3VycmVudERlcHRoRmFyID0gY2FtZXJhWFIuZmFyOwoKCQkJCWNhbWVyYUwubmVhciA9IF9jdXJyZW50RGVwdGhOZWFyOwoJCQkJY2FtZXJhTC5mYXIgPSBfY3VycmVudERlcHRoRmFyOwoJCQkJY2FtZXJhUi5uZWFyID0gX2N1cnJlbnREZXB0aE5lYXI7CgkJCQljYW1lcmFSLmZhciA9IF9jdXJyZW50RGVwdGhGYXI7CgoJCQkJY2FtZXJhTC51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgkJCQljYW1lcmFSLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKCQkJCWNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgoJCQl9CgoJCQljb25zdCBwYXJlbnQgPSBjYW1lcmEucGFyZW50OwoJCQljb25zdCBjYW1lcmFzID0gY2FtZXJhWFIuY2FtZXJhczsKCgkJCXVwZGF0ZUNhbWVyYSggY2FtZXJhWFIsIHBhcmVudCApOwoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgY2FtZXJhcy5sZW5ndGg7IGkgKysgKSB7CgoJCQkJdXBkYXRlQ2FtZXJhKCBjYW1lcmFzWyBpIF0sIHBhcmVudCApOwoKCQkJfQoKCQkJLy8gdXBkYXRlIHByb2plY3Rpb24gbWF0cml4IGZvciBwcm9wZXIgdmlldyBmcnVzdHVtIGN1bGxpbmcKCgkJCWlmICggY2FtZXJhcy5sZW5ndGggPT09IDIgKSB7CgoJCQkJc2V0UHJvamVjdGlvbkZyb21VbmlvbiggY2FtZXJhWFIsIGNhbWVyYUwsIGNhbWVyYVIgKTsKCgkJCX0gZWxzZSB7CgoJCQkJLy8gYXNzdW1lIHNpbmdsZSBjYW1lcmEgc2V0dXAgKEFSKQoKCQkJCWNhbWVyYVhSLnByb2plY3Rpb25NYXRyaXguY29weSggY2FtZXJhTC5wcm9qZWN0aW9uTWF0cml4ICk7CgoJCQl9CgoJCQkvLyB1cGRhdGUgdXNlciBjYW1lcmEgYW5kIGl0cyBjaGlsZHJlbgoKCQkJdXBkYXRlVXNlckNhbWVyYSggY2FtZXJhLCBjYW1lcmFYUiwgcGFyZW50ICk7CgoJCX07CgoJCWZ1bmN0aW9uIHVwZGF0ZVVzZXJDYW1lcmEoIGNhbWVyYSwgY2FtZXJhWFIsIHBhcmVudCApIHsKCgkJCWlmICggcGFyZW50ID09PSBudWxsICkgewoKCQkJCWNhbWVyYS5tYXRyaXguY29weSggY2FtZXJhWFIubWF0cml4V29ybGQgKTsKCgkJCX0gZWxzZSB7CgoJCQkJY2FtZXJhLm1hdHJpeC5jb3B5KCBwYXJlbnQubWF0cml4V29ybGQgKTsKCQkJCWNhbWVyYS5tYXRyaXguaW52ZXJ0KCk7CgkJCQljYW1lcmEubWF0cml4Lm11bHRpcGx5KCBjYW1lcmFYUi5tYXRyaXhXb3JsZCApOwoKCQkJfQoKCQkJY2FtZXJhLm1hdHJpeC5kZWNvbXBvc2UoIGNhbWVyYS5wb3NpdGlvbiwgY2FtZXJhLnF1YXRlcm5pb24sIGNhbWVyYS5zY2FsZSApOwoJCQljYW1lcmEudXBkYXRlTWF0cml4V29ybGQoIHRydWUgKTsKCgkJCWNhbWVyYS5wcm9qZWN0aW9uTWF0cml4LmNvcHkoIGNhbWVyYVhSLnByb2plY3Rpb25NYXRyaXggKTsKCQkJY2FtZXJhLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlLmNvcHkoIGNhbWVyYVhSLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlICk7CgoJCQlpZiAoIGNhbWVyYS5pc1BlcnNwZWN0aXZlQ2FtZXJhICkgewoKCQkJCWNhbWVyYS5mb3YgPSBSQUQyREVHICogMiAqIE1hdGguYXRhbiggMSAvIGNhbWVyYS5wcm9qZWN0aW9uTWF0cml4LmVsZW1lbnRzWyA1IF0gKTsKCQkJCWNhbWVyYS56b29tID0gMTsKCgkJCX0KCgkJfQoKCQl0aGlzLmdldENhbWVyYSA9IGZ1bmN0aW9uICgpIHsKCgkJCXJldHVybiBjYW1lcmFYUjsKCgkJfTsKCgkJdGhpcy5nZXRGb3ZlYXRpb24gPSBmdW5jdGlvbiAoKSB7CgoJCQlpZiAoIGdsUHJvakxheWVyID09PSBudWxsICYmIGdsQmFzZUxheWVyID09PSBudWxsICkgewoKCQkJCXJldHVybiB1bmRlZmluZWQ7CgoJCQl9CgoJCQlyZXR1cm4gZm92ZWF0aW9uOwoKCQl9OwoKCQl0aGlzLnNldEZvdmVhdGlvbiA9IGZ1bmN0aW9uICggdmFsdWUgKSB7CgoJCQkvLyAwID0gbm8gZm92ZWF0aW9uID0gZnVsbCByZXNvbHV0aW9uCgkJCS8vIDEgPSBtYXhpbXVtIGZvdmVhdGlvbiA9IHRoZSBlZGdlcyByZW5kZXIgYXQgbG93ZXIgcmVzb2x1dGlvbgoKCQkJZm92ZWF0aW9uID0gdmFsdWU7CgoJCQlpZiAoIGdsUHJvakxheWVyICE9PSBudWxsICkgewoKCQkJCWdsUHJvakxheWVyLmZpeGVkRm92ZWF0aW9uID0gdmFsdWU7CgoJCQl9CgoJCQlpZiAoIGdsQmFzZUxheWVyICE9PSBudWxsICYmIGdsQmFzZUxheWVyLmZpeGVkRm92ZWF0aW9uICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJZ2xCYXNlTGF5ZXIuZml4ZWRGb3ZlYXRpb24gPSB2YWx1ZTsKCgkJCX0KCgkJfTsKCgkJdGhpcy5oYXNEZXB0aFNlbnNpbmcgPSBmdW5jdGlvbiAoKSB7CgoJCQlyZXR1cm4gZGVwdGhTZW5zaW5nLnRleHR1cmUgIT09IG51bGw7CgoJCX07CgoJCS8vIEFuaW1hdGlvbiBMb29wCgoJCWxldCBvbkFuaW1hdGlvbkZyYW1lQ2FsbGJhY2sgPSBudWxsOwoKCQlmdW5jdGlvbiBvbkFuaW1hdGlvbkZyYW1lKCB0aW1lLCBmcmFtZSApIHsKCgkJCXBvc2UgPSBmcmFtZS5nZXRWaWV3ZXJQb3NlKCBjdXN0b21SZWZlcmVuY2VTcGFjZSB8fCByZWZlcmVuY2VTcGFjZSApOwoJCQl4ckZyYW1lID0gZnJhbWU7CgoJCQlpZiAoIHBvc2UgIT09IG51bGwgKSB7CgoJCQkJY29uc3Qgdmlld3MgPSBwb3NlLnZpZXdzOwoKCQkJCWlmICggZ2xCYXNlTGF5ZXIgIT09IG51bGwgKSB7CgoJCQkJCXJlbmRlcmVyLnNldFJlbmRlclRhcmdldEZyYW1lYnVmZmVyKCBuZXdSZW5kZXJUYXJnZXQsIGdsQmFzZUxheWVyLmZyYW1lYnVmZmVyICk7CgkJCQkJcmVuZGVyZXIuc2V0UmVuZGVyVGFyZ2V0KCBuZXdSZW5kZXJUYXJnZXQgKTsKCgkJCQl9CgoJCQkJbGV0IGNhbWVyYVhSTmVlZHNVcGRhdGUgPSBmYWxzZTsKCgkJCQkvLyBjaGVjayBpZiBpdCdzIG5lY2Vzc2FyeSB0byByZWJ1aWxkIGNhbWVyYVhSJ3MgY2FtZXJhIGxpc3QKCgkJCQlpZiAoIHZpZXdzLmxlbmd0aCAhPT0gY2FtZXJhWFIuY2FtZXJhcy5sZW5ndGggKSB7CgoJCQkJCWNhbWVyYVhSLmNhbWVyYXMubGVuZ3RoID0gMDsKCQkJCQljYW1lcmFYUk5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJCQl9CgoJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgdmlld3MubGVuZ3RoOyBpICsrICkgewoKCQkJCQljb25zdCB2aWV3ID0gdmlld3NbIGkgXTsKCgkJCQkJbGV0IHZpZXdwb3J0ID0gbnVsbDsKCgkJCQkJaWYgKCBnbEJhc2VMYXllciAhPT0gbnVsbCApIHsKCgkJCQkJCXZpZXdwb3J0ID0gZ2xCYXNlTGF5ZXIuZ2V0Vmlld3BvcnQoIHZpZXcgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCWNvbnN0IGdsU3ViSW1hZ2UgPSBnbEJpbmRpbmcuZ2V0Vmlld1N1YkltYWdlKCBnbFByb2pMYXllciwgdmlldyApOwoJCQkJCQl2aWV3cG9ydCA9IGdsU3ViSW1hZ2Uudmlld3BvcnQ7CgoJCQkJCQkvLyBGb3Igc2lkZS1ieS1zaWRlIHByb2plY3Rpb24sIHdlIG9ubHkgcHJvZHVjZSBhIHNpbmdsZSB0ZXh0dXJlIGZvciBib3RoIGV5ZXMuCgkJCQkJCWlmICggaSA9PT0gMCApIHsKCgkJCQkJCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXRUZXh0dXJlcygKCQkJCQkJCQluZXdSZW5kZXJUYXJnZXQsCgkJCQkJCQkJZ2xTdWJJbWFnZS5jb2xvclRleHR1cmUsCgkJCQkJCQkJZ2xQcm9qTGF5ZXIuaWdub3JlRGVwdGhWYWx1ZXMgPyB1bmRlZmluZWQgOiBnbFN1YkltYWdlLmRlcHRoU3RlbmNpbFRleHR1cmUgKTsKCgkJCQkJCQlyZW5kZXJlci5zZXRSZW5kZXJUYXJnZXQoIG5ld1JlbmRlclRhcmdldCApOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWxldCBjYW1lcmEgPSBjYW1lcmFzWyBpIF07CgoJCQkJCWlmICggY2FtZXJhID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCQljYW1lcmEgPSBuZXcgUGVyc3BlY3RpdmVDYW1lcmEoKTsKCQkJCQkJY2FtZXJhLmxheWVycy5lbmFibGUoIGkgKTsKCQkJCQkJY2FtZXJhLnZpZXdwb3J0ID0gbmV3IFZlY3RvcjQoKTsKCQkJCQkJY2FtZXJhc1sgaSBdID0gY2FtZXJhOwoKCQkJCQl9CgoJCQkJCWNhbWVyYS5tYXRyaXguZnJvbUFycmF5KCB2aWV3LnRyYW5zZm9ybS5tYXRyaXggKTsKCQkJCQljYW1lcmEubWF0cml4LmRlY29tcG9zZSggY2FtZXJhLnBvc2l0aW9uLCBjYW1lcmEucXVhdGVybmlvbiwgY2FtZXJhLnNjYWxlICk7CgkJCQkJY2FtZXJhLnByb2plY3Rpb25NYXRyaXguZnJvbUFycmF5KCB2aWV3LnByb2plY3Rpb25NYXRyaXggKTsKCQkJCQljYW1lcmEucHJvamVjdGlvbk1hdHJpeEludmVyc2UuY29weSggY2FtZXJhLnByb2plY3Rpb25NYXRyaXggKS5pbnZlcnQoKTsKCQkJCQljYW1lcmEudmlld3BvcnQuc2V0KCB2aWV3cG9ydC54LCB2aWV3cG9ydC55LCB2aWV3cG9ydC53aWR0aCwgdmlld3BvcnQuaGVpZ2h0ICk7CgoJCQkJCWlmICggaSA9PT0gMCApIHsKCgkJCQkJCWNhbWVyYVhSLm1hdHJpeC5jb3B5KCBjYW1lcmEubWF0cml4ICk7CgkJCQkJCWNhbWVyYVhSLm1hdHJpeC5kZWNvbXBvc2UoIGNhbWVyYVhSLnBvc2l0aW9uLCBjYW1lcmFYUi5xdWF0ZXJuaW9uLCBjYW1lcmFYUi5zY2FsZSApOwoKCQkJCQl9CgoJCQkJCWlmICggY2FtZXJhWFJOZWVkc1VwZGF0ZSA9PT0gdHJ1ZSApIHsKCgkJCQkJCWNhbWVyYVhSLmNhbWVyYXMucHVzaCggY2FtZXJhICk7CgoJCQkJCX0KCgkJCQl9CgoJCQkJLy8KCgkJCQljb25zdCBlbmFibGVkRmVhdHVyZXMgPSBzZXNzaW9uLmVuYWJsZWRGZWF0dXJlczsKCgkJCQlpZiAoIGVuYWJsZWRGZWF0dXJlcyAmJiBlbmFibGVkRmVhdHVyZXMuaW5jbHVkZXMoICdkZXB0aC1zZW5zaW5nJyApICkgewoKCQkJCQljb25zdCBkZXB0aERhdGEgPSBnbEJpbmRpbmcuZ2V0RGVwdGhJbmZvcm1hdGlvbiggdmlld3NbIDAgXSApOwoKCQkJCQlpZiAoIGRlcHRoRGF0YSAmJiBkZXB0aERhdGEuaXNWYWxpZCAmJiBkZXB0aERhdGEudGV4dHVyZSApIHsKCgkJCQkJCWRlcHRoU2Vuc2luZy5pbml0KCByZW5kZXJlciwgZGVwdGhEYXRhLCBzZXNzaW9uLnJlbmRlclN0YXRlICk7CgoJCQkJCX0KCgkJCQl9CgoJCQl9CgoJCQkvLwoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgY29udHJvbGxlcnMubGVuZ3RoOyBpICsrICkgewoKCQkJCWNvbnN0IGlucHV0U291cmNlID0gY29udHJvbGxlcklucHV0U291cmNlc1sgaSBdOwoJCQkJY29uc3QgY29udHJvbGxlciA9IGNvbnRyb2xsZXJzWyBpIF07CgoJCQkJaWYgKCBpbnB1dFNvdXJjZSAhPT0gbnVsbCAmJiBjb250cm9sbGVyICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJCWNvbnRyb2xsZXIudXBkYXRlKCBpbnB1dFNvdXJjZSwgZnJhbWUsIGN1c3RvbVJlZmVyZW5jZVNwYWNlIHx8IHJlZmVyZW5jZVNwYWNlICk7CgoJCQkJfQoKCQkJfQoKCQkJZGVwdGhTZW5zaW5nLnJlbmRlciggcmVuZGVyZXIsIGNhbWVyYVhSICk7CgoJCQlpZiAoIG9uQW5pbWF0aW9uRnJhbWVDYWxsYmFjayApIG9uQW5pbWF0aW9uRnJhbWVDYWxsYmFjayggdGltZSwgZnJhbWUgKTsKCgkJCWlmICggZnJhbWUuZGV0ZWN0ZWRQbGFuZXMgKSB7CgoJCQkJc2NvcGUuZGlzcGF0Y2hFdmVudCggeyB0eXBlOiAncGxhbmVzZGV0ZWN0ZWQnLCBkYXRhOiBmcmFtZSB9ICk7CgoJCQl9CgoJCQl4ckZyYW1lID0gbnVsbDsKCgkJfQoKCQljb25zdCBhbmltYXRpb24gPSBuZXcgV2ViR0xBbmltYXRpb24oKTsKCgkJYW5pbWF0aW9uLnNldEFuaW1hdGlvbkxvb3AoIG9uQW5pbWF0aW9uRnJhbWUgKTsKCgkJdGhpcy5zZXRBbmltYXRpb25Mb29wID0gZnVuY3Rpb24gKCBjYWxsYmFjayApIHsKCgkJCW9uQW5pbWF0aW9uRnJhbWVDYWxsYmFjayA9IGNhbGxiYWNrOwoKCQl9OwoKCQl0aGlzLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7fTsKCgl9Cgp9CgpmdW5jdGlvbiBXZWJHTE1hdGVyaWFscyggcmVuZGVyZXIsIHByb3BlcnRpZXMgKSB7CgoJZnVuY3Rpb24gcmVmcmVzaFRyYW5zZm9ybVVuaWZvcm0oIG1hcCwgdW5pZm9ybSApIHsKCgkJaWYgKCBtYXAubWF0cml4QXV0b1VwZGF0ZSA9PT0gdHJ1ZSApIHsKCgkJCW1hcC51cGRhdGVNYXRyaXgoKTsKCgkJfQoKCQl1bmlmb3JtLnZhbHVlLmNvcHkoIG1hcC5tYXRyaXggKTsKCgl9CgoJZnVuY3Rpb24gcmVmcmVzaEZvZ1VuaWZvcm1zKCB1bmlmb3JtcywgZm9nICkgewoKCQlmb2cuY29sb3IuZ2V0UkdCKCB1bmlmb3Jtcy5mb2dDb2xvci52YWx1ZSwgZ2V0VW5saXRVbmlmb3JtQ29sb3JTcGFjZSggcmVuZGVyZXIgKSApOwoKCQlpZiAoIGZvZy5pc0ZvZyApIHsKCgkJCXVuaWZvcm1zLmZvZ05lYXIudmFsdWUgPSBmb2cubmVhcjsKCQkJdW5pZm9ybXMuZm9nRmFyLnZhbHVlID0gZm9nLmZhcjsKCgkJfSBlbHNlIGlmICggZm9nLmlzRm9nRXhwMiApIHsKCgkJCXVuaWZvcm1zLmZvZ0RlbnNpdHkudmFsdWUgPSBmb2cuZGVuc2l0eTsKCgkJfQoKCX0KCglmdW5jdGlvbiByZWZyZXNoTWF0ZXJpYWxVbmlmb3JtcyggdW5pZm9ybXMsIG1hdGVyaWFsLCBwaXhlbFJhdGlvLCBoZWlnaHQsIHRyYW5zbWlzc2lvblJlbmRlclRhcmdldCApIHsKCgkJaWYgKCBtYXRlcmlhbC5pc01lc2hCYXNpY01hdGVyaWFsICkgewoKCQkJcmVmcmVzaFVuaWZvcm1zQ29tbW9uKCB1bmlmb3JtcywgbWF0ZXJpYWwgKTsKCgkJfSBlbHNlIGlmICggbWF0ZXJpYWwuaXNNZXNoTGFtYmVydE1hdGVyaWFsICkgewoKCQkJcmVmcmVzaFVuaWZvcm1zQ29tbW9uKCB1bmlmb3JtcywgbWF0ZXJpYWwgKTsKCgkJfSBlbHNlIGlmICggbWF0ZXJpYWwuaXNNZXNoVG9vbk1hdGVyaWFsICkgewoKCQkJcmVmcmVzaFVuaWZvcm1zQ29tbW9uKCB1bmlmb3JtcywgbWF0ZXJpYWwgKTsKCQkJcmVmcmVzaFVuaWZvcm1zVG9vbiggdW5pZm9ybXMsIG1hdGVyaWFsICk7CgoJCX0gZWxzZSBpZiAoIG1hdGVyaWFsLmlzTWVzaFBob25nTWF0ZXJpYWwgKSB7CgoJCQlyZWZyZXNoVW5pZm9ybXNDb21tb24oIHVuaWZvcm1zLCBtYXRlcmlhbCApOwoJCQlyZWZyZXNoVW5pZm9ybXNQaG9uZyggdW5pZm9ybXMsIG1hdGVyaWFsICk7CgoJCX0gZWxzZSBpZiAoIG1hdGVyaWFsLmlzTWVzaFN0YW5kYXJkTWF0ZXJpYWwgKSB7CgoJCQlyZWZyZXNoVW5pZm9ybXNDb21tb24oIHVuaWZvcm1zLCBtYXRlcmlhbCApOwoJCQlyZWZyZXNoVW5pZm9ybXNTdGFuZGFyZCggdW5pZm9ybXMsIG1hdGVyaWFsICk7CgoJCQlpZiAoIG1hdGVyaWFsLmlzTWVzaFBoeXNpY2FsTWF0ZXJpYWwgKSB7CgoJCQkJcmVmcmVzaFVuaWZvcm1zUGh5c2ljYWwoIHVuaWZvcm1zLCBtYXRlcmlhbCwgdHJhbnNtaXNzaW9uUmVuZGVyVGFyZ2V0ICk7CgoJCQl9CgoJCX0gZWxzZSBpZiAoIG1hdGVyaWFsLmlzTWVzaE1hdGNhcE1hdGVyaWFsICkgewoKCQkJcmVmcmVzaFVuaWZvcm1zQ29tbW9uKCB1bmlmb3JtcywgbWF0ZXJpYWwgKTsKCQkJcmVmcmVzaFVuaWZvcm1zTWF0Y2FwKCB1bmlmb3JtcywgbWF0ZXJpYWwgKTsKCgkJfSBlbHNlIGlmICggbWF0ZXJpYWwuaXNNZXNoRGVwdGhNYXRlcmlhbCApIHsKCgkJCXJlZnJlc2hVbmlmb3Jtc0NvbW1vbiggdW5pZm9ybXMsIG1hdGVyaWFsICk7CgoJCX0gZWxzZSBpZiAoIG1hdGVyaWFsLmlzTWVzaERpc3RhbmNlTWF0ZXJpYWwgKSB7CgoJCQlyZWZyZXNoVW5pZm9ybXNDb21tb24oIHVuaWZvcm1zLCBtYXRlcmlhbCApOwoJCQlyZWZyZXNoVW5pZm9ybXNEaXN0YW5jZSggdW5pZm9ybXMsIG1hdGVyaWFsICk7CgoJCX0gZWxzZSBpZiAoIG1hdGVyaWFsLmlzTWVzaE5vcm1hbE1hdGVyaWFsICkgewoKCQkJcmVmcmVzaFVuaWZvcm1zQ29tbW9uKCB1bmlmb3JtcywgbWF0ZXJpYWwgKTsKCgkJfSBlbHNlIGlmICggbWF0ZXJpYWwuaXNMaW5lQmFzaWNNYXRlcmlhbCApIHsKCgkJCXJlZnJlc2hVbmlmb3Jtc0xpbmUoIHVuaWZvcm1zLCBtYXRlcmlhbCApOwoKCQkJaWYgKCBtYXRlcmlhbC5pc0xpbmVEYXNoZWRNYXRlcmlhbCApIHsKCgkJCQlyZWZyZXNoVW5pZm9ybXNEYXNoKCB1bmlmb3JtcywgbWF0ZXJpYWwgKTsKCgkJCX0KCgkJfSBlbHNlIGlmICggbWF0ZXJpYWwuaXNQb2ludHNNYXRlcmlhbCApIHsKCgkJCXJlZnJlc2hVbmlmb3Jtc1BvaW50cyggdW5pZm9ybXMsIG1hdGVyaWFsLCBwaXhlbFJhdGlvLCBoZWlnaHQgKTsKCgkJfSBlbHNlIGlmICggbWF0ZXJpYWwuaXNTcHJpdGVNYXRlcmlhbCApIHsKCgkJCXJlZnJlc2hVbmlmb3Jtc1Nwcml0ZXMoIHVuaWZvcm1zLCBtYXRlcmlhbCApOwoKCQl9IGVsc2UgaWYgKCBtYXRlcmlhbC5pc1NoYWRvd01hdGVyaWFsICkgewoKCQkJdW5pZm9ybXMuY29sb3IudmFsdWUuY29weSggbWF0ZXJpYWwuY29sb3IgKTsKCQkJdW5pZm9ybXMub3BhY2l0eS52YWx1ZSA9IG1hdGVyaWFsLm9wYWNpdHk7CgoJCX0gZWxzZSBpZiAoIG1hdGVyaWFsLmlzU2hhZGVyTWF0ZXJpYWwgKSB7CgoJCQltYXRlcmlhbC51bmlmb3Jtc05lZWRVcGRhdGUgPSBmYWxzZTsgLy8gIzE1NTgxCgoJCX0KCgl9CgoJZnVuY3Rpb24gcmVmcmVzaFVuaWZvcm1zQ29tbW9uKCB1bmlmb3JtcywgbWF0ZXJpYWwgKSB7CgoJCXVuaWZvcm1zLm9wYWNpdHkudmFsdWUgPSBtYXRlcmlhbC5vcGFjaXR5OwoKCQlpZiAoIG1hdGVyaWFsLmNvbG9yICkgewoKCQkJdW5pZm9ybXMuZGlmZnVzZS52YWx1ZS5jb3B5KCBtYXRlcmlhbC5jb2xvciApOwoKCQl9CgoJCWlmICggbWF0ZXJpYWwuZW1pc3NpdmUgKSB7CgoJCQl1bmlmb3Jtcy5lbWlzc2l2ZS52YWx1ZS5jb3B5KCBtYXRlcmlhbC5lbWlzc2l2ZSApLm11bHRpcGx5U2NhbGFyKCBtYXRlcmlhbC5lbWlzc2l2ZUludGVuc2l0eSApOwoKCQl9CgoJCWlmICggbWF0ZXJpYWwubWFwICkgewoKCQkJdW5pZm9ybXMubWFwLnZhbHVlID0gbWF0ZXJpYWwubWFwOwoKCQkJcmVmcmVzaFRyYW5zZm9ybVVuaWZvcm0oIG1hdGVyaWFsLm1hcCwgdW5pZm9ybXMubWFwVHJhbnNmb3JtICk7CgoJCX0KCgkJaWYgKCBtYXRlcmlhbC5hbHBoYU1hcCApIHsKCgkJCXVuaWZvcm1zLmFscGhhTWFwLnZhbHVlID0gbWF0ZXJpYWwuYWxwaGFNYXA7CgoJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuYWxwaGFNYXAsIHVuaWZvcm1zLmFscGhhTWFwVHJhbnNmb3JtICk7CgoJCX0KCgkJaWYgKCBtYXRlcmlhbC5idW1wTWFwICkgewoKCQkJdW5pZm9ybXMuYnVtcE1hcC52YWx1ZSA9IG1hdGVyaWFsLmJ1bXBNYXA7CgoJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuYnVtcE1hcCwgdW5pZm9ybXMuYnVtcE1hcFRyYW5zZm9ybSApOwoKCQkJdW5pZm9ybXMuYnVtcFNjYWxlLnZhbHVlID0gbWF0ZXJpYWwuYnVtcFNjYWxlOwoKCQkJaWYgKCBtYXRlcmlhbC5zaWRlID09PSBCYWNrU2lkZSApIHsKCgkJCQl1bmlmb3Jtcy5idW1wU2NhbGUudmFsdWUgKj0gLSAxOwoKCQkJfQoKCQl9CgoJCWlmICggbWF0ZXJpYWwubm9ybWFsTWFwICkgewoKCQkJdW5pZm9ybXMubm9ybWFsTWFwLnZhbHVlID0gbWF0ZXJpYWwubm9ybWFsTWFwOwoKCQkJcmVmcmVzaFRyYW5zZm9ybVVuaWZvcm0oIG1hdGVyaWFsLm5vcm1hbE1hcCwgdW5pZm9ybXMubm9ybWFsTWFwVHJhbnNmb3JtICk7CgoJCQl1bmlmb3Jtcy5ub3JtYWxTY2FsZS52YWx1ZS5jb3B5KCBtYXRlcmlhbC5ub3JtYWxTY2FsZSApOwoKCQkJaWYgKCBtYXRlcmlhbC5zaWRlID09PSBCYWNrU2lkZSApIHsKCgkJCQl1bmlmb3Jtcy5ub3JtYWxTY2FsZS52YWx1ZS5uZWdhdGUoKTsKCgkJCX0KCgkJfQoKCQlpZiAoIG1hdGVyaWFsLmRpc3BsYWNlbWVudE1hcCApIHsKCgkJCXVuaWZvcm1zLmRpc3BsYWNlbWVudE1hcC52YWx1ZSA9IG1hdGVyaWFsLmRpc3BsYWNlbWVudE1hcDsKCgkJCXJlZnJlc2hUcmFuc2Zvcm1Vbmlmb3JtKCBtYXRlcmlhbC5kaXNwbGFjZW1lbnRNYXAsIHVuaWZvcm1zLmRpc3BsYWNlbWVudE1hcFRyYW5zZm9ybSApOwoKCQkJdW5pZm9ybXMuZGlzcGxhY2VtZW50U2NhbGUudmFsdWUgPSBtYXRlcmlhbC5kaXNwbGFjZW1lbnRTY2FsZTsKCQkJdW5pZm9ybXMuZGlzcGxhY2VtZW50Qmlhcy52YWx1ZSA9IG1hdGVyaWFsLmRpc3BsYWNlbWVudEJpYXM7CgoJCX0KCgkJaWYgKCBtYXRlcmlhbC5lbWlzc2l2ZU1hcCApIHsKCgkJCXVuaWZvcm1zLmVtaXNzaXZlTWFwLnZhbHVlID0gbWF0ZXJpYWwuZW1pc3NpdmVNYXA7CgoJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuZW1pc3NpdmVNYXAsIHVuaWZvcm1zLmVtaXNzaXZlTWFwVHJhbnNmb3JtICk7CgoJCX0KCgkJaWYgKCBtYXRlcmlhbC5zcGVjdWxhck1hcCApIHsKCgkJCXVuaWZvcm1zLnNwZWN1bGFyTWFwLnZhbHVlID0gbWF0ZXJpYWwuc3BlY3VsYXJNYXA7CgoJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuc3BlY3VsYXJNYXAsIHVuaWZvcm1zLnNwZWN1bGFyTWFwVHJhbnNmb3JtICk7CgoJCX0KCgkJaWYgKCBtYXRlcmlhbC5hbHBoYVRlc3QgPiAwICkgewoKCQkJdW5pZm9ybXMuYWxwaGFUZXN0LnZhbHVlID0gbWF0ZXJpYWwuYWxwaGFUZXN0OwoKCQl9CgoJCWNvbnN0IGVudk1hcCA9IHByb3BlcnRpZXMuZ2V0KCBtYXRlcmlhbCApLmVudk1hcDsKCgkJaWYgKCBlbnZNYXAgKSB7CgoJCQl1bmlmb3Jtcy5lbnZNYXAudmFsdWUgPSBlbnZNYXA7CgoJCQl1bmlmb3Jtcy5mbGlwRW52TWFwLnZhbHVlID0gKCBlbnZNYXAuaXNDdWJlVGV4dHVyZSAmJiBlbnZNYXAuaXNSZW5kZXJUYXJnZXRUZXh0dXJlID09PSBmYWxzZSApID8gLSAxIDogMTsKCgkJCXVuaWZvcm1zLnJlZmxlY3Rpdml0eS52YWx1ZSA9IG1hdGVyaWFsLnJlZmxlY3Rpdml0eTsKCQkJdW5pZm9ybXMuaW9yLnZhbHVlID0gbWF0ZXJpYWwuaW9yOwoJCQl1bmlmb3Jtcy5yZWZyYWN0aW9uUmF0aW8udmFsdWUgPSBtYXRlcmlhbC5yZWZyYWN0aW9uUmF0aW87CgoJCX0KCgkJaWYgKCBtYXRlcmlhbC5saWdodE1hcCApIHsKCgkJCXVuaWZvcm1zLmxpZ2h0TWFwLnZhbHVlID0gbWF0ZXJpYWwubGlnaHRNYXA7CgoJCQkvLyBhcnRpc3QtZnJpZW5kbHkgbGlnaHQgaW50ZW5zaXR5IHNjYWxpbmcgZmFjdG9yCgkJCWNvbnN0IHNjYWxlRmFjdG9yID0gKCByZW5kZXJlci5fdXNlTGVnYWN5TGlnaHRzID09PSB0cnVlICkgPyBNYXRoLlBJIDogMTsKCgkJCXVuaWZvcm1zLmxpZ2h0TWFwSW50ZW5zaXR5LnZhbHVlID0gbWF0ZXJpYWwubGlnaHRNYXBJbnRlbnNpdHkgKiBzY2FsZUZhY3RvcjsKCgkJCXJlZnJlc2hUcmFuc2Zvcm1Vbmlmb3JtKCBtYXRlcmlhbC5saWdodE1hcCwgdW5pZm9ybXMubGlnaHRNYXBUcmFuc2Zvcm0gKTsKCgkJfQoKCQlpZiAoIG1hdGVyaWFsLmFvTWFwICkgewoKCQkJdW5pZm9ybXMuYW9NYXAudmFsdWUgPSBtYXRlcmlhbC5hb01hcDsKCQkJdW5pZm9ybXMuYW9NYXBJbnRlbnNpdHkudmFsdWUgPSBtYXRlcmlhbC5hb01hcEludGVuc2l0eTsKCgkJCXJlZnJlc2hUcmFuc2Zvcm1Vbmlmb3JtKCBtYXRlcmlhbC5hb01hcCwgdW5pZm9ybXMuYW9NYXBUcmFuc2Zvcm0gKTsKCgkJfQoKCX0KCglmdW5jdGlvbiByZWZyZXNoVW5pZm9ybXNMaW5lKCB1bmlmb3JtcywgbWF0ZXJpYWwgKSB7CgoJCXVuaWZvcm1zLmRpZmZ1c2UudmFsdWUuY29weSggbWF0ZXJpYWwuY29sb3IgKTsKCQl1bmlmb3Jtcy5vcGFjaXR5LnZhbHVlID0gbWF0ZXJpYWwub3BhY2l0eTsKCgkJaWYgKCBtYXRlcmlhbC5tYXAgKSB7CgoJCQl1bmlmb3Jtcy5tYXAudmFsdWUgPSBtYXRlcmlhbC5tYXA7CgoJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwubWFwLCB1bmlmb3Jtcy5tYXBUcmFuc2Zvcm0gKTsKCgkJfQoKCX0KCglmdW5jdGlvbiByZWZyZXNoVW5pZm9ybXNEYXNoKCB1bmlmb3JtcywgbWF0ZXJpYWwgKSB7CgoJCXVuaWZvcm1zLmRhc2hTaXplLnZhbHVlID0gbWF0ZXJpYWwuZGFzaFNpemU7CgkJdW5pZm9ybXMudG90YWxTaXplLnZhbHVlID0gbWF0ZXJpYWwuZGFzaFNpemUgKyBtYXRlcmlhbC5nYXBTaXplOwoJCXVuaWZvcm1zLnNjYWxlLnZhbHVlID0gbWF0ZXJpYWwuc2NhbGU7CgoJfQoKCWZ1bmN0aW9uIHJlZnJlc2hVbmlmb3Jtc1BvaW50cyggdW5pZm9ybXMsIG1hdGVyaWFsLCBwaXhlbFJhdGlvLCBoZWlnaHQgKSB7CgoJCXVuaWZvcm1zLmRpZmZ1c2UudmFsdWUuY29weSggbWF0ZXJpYWwuY29sb3IgKTsKCQl1bmlmb3Jtcy5vcGFjaXR5LnZhbHVlID0gbWF0ZXJpYWwub3BhY2l0eTsKCQl1bmlmb3Jtcy5zaXplLnZhbHVlID0gbWF0ZXJpYWwuc2l6ZSAqIHBpeGVsUmF0aW87CgkJdW5pZm9ybXMuc2NhbGUudmFsdWUgPSBoZWlnaHQgKiAwLjU7CgoJCWlmICggbWF0ZXJpYWwubWFwICkgewoKCQkJdW5pZm9ybXMubWFwLnZhbHVlID0gbWF0ZXJpYWwubWFwOwoKCQkJcmVmcmVzaFRyYW5zZm9ybVVuaWZvcm0oIG1hdGVyaWFsLm1hcCwgdW5pZm9ybXMudXZUcmFuc2Zvcm0gKTsKCgkJfQoKCQlpZiAoIG1hdGVyaWFsLmFscGhhTWFwICkgewoKCQkJdW5pZm9ybXMuYWxwaGFNYXAudmFsdWUgPSBtYXRlcmlhbC5hbHBoYU1hcDsKCgkJCXJlZnJlc2hUcmFuc2Zvcm1Vbmlmb3JtKCBtYXRlcmlhbC5hbHBoYU1hcCwgdW5pZm9ybXMuYWxwaGFNYXBUcmFuc2Zvcm0gKTsKCgkJfQoKCQlpZiAoIG1hdGVyaWFsLmFscGhhVGVzdCA+IDAgKSB7CgoJCQl1bmlmb3Jtcy5hbHBoYVRlc3QudmFsdWUgPSBtYXRlcmlhbC5hbHBoYVRlc3Q7CgoJCX0KCgl9CgoJZnVuY3Rpb24gcmVmcmVzaFVuaWZvcm1zU3ByaXRlcyggdW5pZm9ybXMsIG1hdGVyaWFsICkgewoKCQl1bmlmb3Jtcy5kaWZmdXNlLnZhbHVlLmNvcHkoIG1hdGVyaWFsLmNvbG9yICk7CgkJdW5pZm9ybXMub3BhY2l0eS52YWx1ZSA9IG1hdGVyaWFsLm9wYWNpdHk7CgkJdW5pZm9ybXMucm90YXRpb24udmFsdWUgPSBtYXRlcmlhbC5yb3RhdGlvbjsKCgkJaWYgKCBtYXRlcmlhbC5tYXAgKSB7CgoJCQl1bmlmb3Jtcy5tYXAudmFsdWUgPSBtYXRlcmlhbC5tYXA7CgoJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwubWFwLCB1bmlmb3Jtcy5tYXBUcmFuc2Zvcm0gKTsKCgkJfQoKCQlpZiAoIG1hdGVyaWFsLmFscGhhTWFwICkgewoKCQkJdW5pZm9ybXMuYWxwaGFNYXAudmFsdWUgPSBtYXRlcmlhbC5hbHBoYU1hcDsKCgkJCXJlZnJlc2hUcmFuc2Zvcm1Vbmlmb3JtKCBtYXRlcmlhbC5hbHBoYU1hcCwgdW5pZm9ybXMuYWxwaGFNYXBUcmFuc2Zvcm0gKTsKCgkJfQoKCQlpZiAoIG1hdGVyaWFsLmFscGhhVGVzdCA+IDAgKSB7CgoJCQl1bmlmb3Jtcy5hbHBoYVRlc3QudmFsdWUgPSBtYXRlcmlhbC5hbHBoYVRlc3Q7CgoJCX0KCgl9CgoJZnVuY3Rpb24gcmVmcmVzaFVuaWZvcm1zUGhvbmcoIHVuaWZvcm1zLCBtYXRlcmlhbCApIHsKCgkJdW5pZm9ybXMuc3BlY3VsYXIudmFsdWUuY29weSggbWF0ZXJpYWwuc3BlY3VsYXIgKTsKCQl1bmlmb3Jtcy5zaGluaW5lc3MudmFsdWUgPSBNYXRoLm1heCggbWF0ZXJpYWwuc2hpbmluZXNzLCAxZS00ICk7IC8vIHRvIHByZXZlbnQgcG93KCAwLjAsIDAuMCApCgoJfQoKCWZ1bmN0aW9uIHJlZnJlc2hVbmlmb3Jtc1Rvb24oIHVuaWZvcm1zLCBtYXRlcmlhbCApIHsKCgkJaWYgKCBtYXRlcmlhbC5ncmFkaWVudE1hcCApIHsKCgkJCXVuaWZvcm1zLmdyYWRpZW50TWFwLnZhbHVlID0gbWF0ZXJpYWwuZ3JhZGllbnRNYXA7CgoJCX0KCgl9CgoJZnVuY3Rpb24gcmVmcmVzaFVuaWZvcm1zU3RhbmRhcmQoIHVuaWZvcm1zLCBtYXRlcmlhbCApIHsKCgkJdW5pZm9ybXMubWV0YWxuZXNzLnZhbHVlID0gbWF0ZXJpYWwubWV0YWxuZXNzOwoKCQlpZiAoIG1hdGVyaWFsLm1ldGFsbmVzc01hcCApIHsKCgkJCXVuaWZvcm1zLm1ldGFsbmVzc01hcC52YWx1ZSA9IG1hdGVyaWFsLm1ldGFsbmVzc01hcDsKCgkJCXJlZnJlc2hUcmFuc2Zvcm1Vbmlmb3JtKCBtYXRlcmlhbC5tZXRhbG5lc3NNYXAsIHVuaWZvcm1zLm1ldGFsbmVzc01hcFRyYW5zZm9ybSApOwoKCQl9CgoJCXVuaWZvcm1zLnJvdWdobmVzcy52YWx1ZSA9IG1hdGVyaWFsLnJvdWdobmVzczsKCgkJaWYgKCBtYXRlcmlhbC5yb3VnaG5lc3NNYXAgKSB7CgoJCQl1bmlmb3Jtcy5yb3VnaG5lc3NNYXAudmFsdWUgPSBtYXRlcmlhbC5yb3VnaG5lc3NNYXA7CgoJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwucm91Z2huZXNzTWFwLCB1bmlmb3Jtcy5yb3VnaG5lc3NNYXBUcmFuc2Zvcm0gKTsKCgkJfQoKCQljb25zdCBlbnZNYXAgPSBwcm9wZXJ0aWVzLmdldCggbWF0ZXJpYWwgKS5lbnZNYXA7CgoJCWlmICggZW52TWFwICkgewoKCQkJLy91bmlmb3Jtcy5lbnZNYXAudmFsdWUgPSBtYXRlcmlhbC5lbnZNYXA7IC8vIHBhcnQgb2YgdW5pZm9ybXMgY29tbW9uCgkJCXVuaWZvcm1zLmVudk1hcEludGVuc2l0eS52YWx1ZSA9IG1hdGVyaWFsLmVudk1hcEludGVuc2l0eTsKCgkJfQoKCX0KCglmdW5jdGlvbiByZWZyZXNoVW5pZm9ybXNQaHlzaWNhbCggdW5pZm9ybXMsIG1hdGVyaWFsLCB0cmFuc21pc3Npb25SZW5kZXJUYXJnZXQgKSB7CgoJCXVuaWZvcm1zLmlvci52YWx1ZSA9IG1hdGVyaWFsLmlvcjsgLy8gYWxzbyBwYXJ0IG9mIHVuaWZvcm1zIGNvbW1vbgoKCQlpZiAoIG1hdGVyaWFsLnNoZWVuID4gMCApIHsKCgkJCXVuaWZvcm1zLnNoZWVuQ29sb3IudmFsdWUuY29weSggbWF0ZXJpYWwuc2hlZW5Db2xvciApLm11bHRpcGx5U2NhbGFyKCBtYXRlcmlhbC5zaGVlbiApOwoKCQkJdW5pZm9ybXMuc2hlZW5Sb3VnaG5lc3MudmFsdWUgPSBtYXRlcmlhbC5zaGVlblJvdWdobmVzczsKCgkJCWlmICggbWF0ZXJpYWwuc2hlZW5Db2xvck1hcCApIHsKCgkJCQl1bmlmb3Jtcy5zaGVlbkNvbG9yTWFwLnZhbHVlID0gbWF0ZXJpYWwuc2hlZW5Db2xvck1hcDsKCgkJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuc2hlZW5Db2xvck1hcCwgdW5pZm9ybXMuc2hlZW5Db2xvck1hcFRyYW5zZm9ybSApOwoKCQkJfQoKCQkJaWYgKCBtYXRlcmlhbC5zaGVlblJvdWdobmVzc01hcCApIHsKCgkJCQl1bmlmb3Jtcy5zaGVlblJvdWdobmVzc01hcC52YWx1ZSA9IG1hdGVyaWFsLnNoZWVuUm91Z2huZXNzTWFwOwoKCQkJCXJlZnJlc2hUcmFuc2Zvcm1Vbmlmb3JtKCBtYXRlcmlhbC5zaGVlblJvdWdobmVzc01hcCwgdW5pZm9ybXMuc2hlZW5Sb3VnaG5lc3NNYXBUcmFuc2Zvcm0gKTsKCgkJCX0KCgkJfQoKCQlpZiAoIG1hdGVyaWFsLmNsZWFyY29hdCA+IDAgKSB7CgoJCQl1bmlmb3Jtcy5jbGVhcmNvYXQudmFsdWUgPSBtYXRlcmlhbC5jbGVhcmNvYXQ7CgkJCXVuaWZvcm1zLmNsZWFyY29hdFJvdWdobmVzcy52YWx1ZSA9IG1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzczsKCgkJCWlmICggbWF0ZXJpYWwuY2xlYXJjb2F0TWFwICkgewoKCQkJCXVuaWZvcm1zLmNsZWFyY29hdE1hcC52YWx1ZSA9IG1hdGVyaWFsLmNsZWFyY29hdE1hcDsKCgkJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuY2xlYXJjb2F0TWFwLCB1bmlmb3Jtcy5jbGVhcmNvYXRNYXBUcmFuc2Zvcm0gKTsKCgkJCX0KCgkJCWlmICggbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzTWFwICkgewoKCQkJCXVuaWZvcm1zLmNsZWFyY29hdFJvdWdobmVzc01hcC52YWx1ZSA9IG1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzc01hcDsKCgkJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzTWFwLCB1bmlmb3Jtcy5jbGVhcmNvYXRSb3VnaG5lc3NNYXBUcmFuc2Zvcm0gKTsKCgkJCX0KCgkJCWlmICggbWF0ZXJpYWwuY2xlYXJjb2F0Tm9ybWFsTWFwICkgewoKCQkJCXVuaWZvcm1zLmNsZWFyY29hdE5vcm1hbE1hcC52YWx1ZSA9IG1hdGVyaWFsLmNsZWFyY29hdE5vcm1hbE1hcDsKCgkJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuY2xlYXJjb2F0Tm9ybWFsTWFwLCB1bmlmb3Jtcy5jbGVhcmNvYXROb3JtYWxNYXBUcmFuc2Zvcm0gKTsKCgkJCQl1bmlmb3Jtcy5jbGVhcmNvYXROb3JtYWxTY2FsZS52YWx1ZS5jb3B5KCBtYXRlcmlhbC5jbGVhcmNvYXROb3JtYWxTY2FsZSApOwoKCQkJCWlmICggbWF0ZXJpYWwuc2lkZSA9PT0gQmFja1NpZGUgKSB7CgoJCQkJCXVuaWZvcm1zLmNsZWFyY29hdE5vcm1hbFNjYWxlLnZhbHVlLm5lZ2F0ZSgpOwoKCQkJCX0KCgkJCX0KCgkJfQoKCQlpZiAoIG1hdGVyaWFsLmlyaWRlc2NlbmNlID4gMCApIHsKCgkJCXVuaWZvcm1zLmlyaWRlc2NlbmNlLnZhbHVlID0gbWF0ZXJpYWwuaXJpZGVzY2VuY2U7CgkJCXVuaWZvcm1zLmlyaWRlc2NlbmNlSU9SLnZhbHVlID0gbWF0ZXJpYWwuaXJpZGVzY2VuY2VJT1I7CgkJCXVuaWZvcm1zLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWluaW11bS52YWx1ZSA9IG1hdGVyaWFsLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2VbIDAgXTsKCQkJdW5pZm9ybXMuaXJpZGVzY2VuY2VUaGlja25lc3NNYXhpbXVtLnZhbHVlID0gbWF0ZXJpYWwuaXJpZGVzY2VuY2VUaGlja25lc3NSYW5nZVsgMSBdOwoKCQkJaWYgKCBtYXRlcmlhbC5pcmlkZXNjZW5jZU1hcCApIHsKCgkJCQl1bmlmb3Jtcy5pcmlkZXNjZW5jZU1hcC52YWx1ZSA9IG1hdGVyaWFsLmlyaWRlc2NlbmNlTWFwOwoKCQkJCXJlZnJlc2hUcmFuc2Zvcm1Vbmlmb3JtKCBtYXRlcmlhbC5pcmlkZXNjZW5jZU1hcCwgdW5pZm9ybXMuaXJpZGVzY2VuY2VNYXBUcmFuc2Zvcm0gKTsKCgkJCX0KCgkJCWlmICggbWF0ZXJpYWwuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAgKSB7CgoJCQkJdW5pZm9ybXMuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAudmFsdWUgPSBtYXRlcmlhbC5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcDsKCgkJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuaXJpZGVzY2VuY2VUaGlja25lc3NNYXAsIHVuaWZvcm1zLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwVHJhbnNmb3JtICk7CgoJCQl9CgoJCX0KCgkJaWYgKCBtYXRlcmlhbC50cmFuc21pc3Npb24gPiAwICkgewoKCQkJdW5pZm9ybXMudHJhbnNtaXNzaW9uLnZhbHVlID0gbWF0ZXJpYWwudHJhbnNtaXNzaW9uOwoJCQl1bmlmb3Jtcy50cmFuc21pc3Npb25TYW1wbGVyTWFwLnZhbHVlID0gdHJhbnNtaXNzaW9uUmVuZGVyVGFyZ2V0LnRleHR1cmU7CgkJCXVuaWZvcm1zLnRyYW5zbWlzc2lvblNhbXBsZXJTaXplLnZhbHVlLnNldCggdHJhbnNtaXNzaW9uUmVuZGVyVGFyZ2V0LndpZHRoLCB0cmFuc21pc3Npb25SZW5kZXJUYXJnZXQuaGVpZ2h0ICk7CgoJCQlpZiAoIG1hdGVyaWFsLnRyYW5zbWlzc2lvbk1hcCApIHsKCgkJCQl1bmlmb3Jtcy50cmFuc21pc3Npb25NYXAudmFsdWUgPSBtYXRlcmlhbC50cmFuc21pc3Npb25NYXA7CgoJCQkJcmVmcmVzaFRyYW5zZm9ybVVuaWZvcm0oIG1hdGVyaWFsLnRyYW5zbWlzc2lvbk1hcCwgdW5pZm9ybXMudHJhbnNtaXNzaW9uTWFwVHJhbnNmb3JtICk7CgoJCQl9CgoJCQl1bmlmb3Jtcy50aGlja25lc3MudmFsdWUgPSBtYXRlcmlhbC50aGlja25lc3M7CgoJCQlpZiAoIG1hdGVyaWFsLnRoaWNrbmVzc01hcCApIHsKCgkJCQl1bmlmb3Jtcy50aGlja25lc3NNYXAudmFsdWUgPSBtYXRlcmlhbC50aGlja25lc3NNYXA7CgoJCQkJcmVmcmVzaFRyYW5zZm9ybVVuaWZvcm0oIG1hdGVyaWFsLnRoaWNrbmVzc01hcCwgdW5pZm9ybXMudGhpY2tuZXNzTWFwVHJhbnNmb3JtICk7CgoJCQl9CgoJCQl1bmlmb3Jtcy5hdHRlbnVhdGlvbkRpc3RhbmNlLnZhbHVlID0gbWF0ZXJpYWwuYXR0ZW51YXRpb25EaXN0YW5jZTsKCQkJdW5pZm9ybXMuYXR0ZW51YXRpb25Db2xvci52YWx1ZS5jb3B5KCBtYXRlcmlhbC5hdHRlbnVhdGlvbkNvbG9yICk7CgoJCX0KCgkJaWYgKCBtYXRlcmlhbC5hbmlzb3Ryb3B5ID4gMCApIHsKCgkJCXVuaWZvcm1zLmFuaXNvdHJvcHlWZWN0b3IudmFsdWUuc2V0KCBtYXRlcmlhbC5hbmlzb3Ryb3B5ICogTWF0aC5jb3MoIG1hdGVyaWFsLmFuaXNvdHJvcHlSb3RhdGlvbiApLCBtYXRlcmlhbC5hbmlzb3Ryb3B5ICogTWF0aC5zaW4oIG1hdGVyaWFsLmFuaXNvdHJvcHlSb3RhdGlvbiApICk7CgoJCQlpZiAoIG1hdGVyaWFsLmFuaXNvdHJvcHlNYXAgKSB7CgoJCQkJdW5pZm9ybXMuYW5pc290cm9weU1hcC52YWx1ZSA9IG1hdGVyaWFsLmFuaXNvdHJvcHlNYXA7CgoJCQkJcmVmcmVzaFRyYW5zZm9ybVVuaWZvcm0oIG1hdGVyaWFsLmFuaXNvdHJvcHlNYXAsIHVuaWZvcm1zLmFuaXNvdHJvcHlNYXBUcmFuc2Zvcm0gKTsKCgkJCX0KCgkJfQoKCQl1bmlmb3Jtcy5zcGVjdWxhckludGVuc2l0eS52YWx1ZSA9IG1hdGVyaWFsLnNwZWN1bGFySW50ZW5zaXR5OwoJCXVuaWZvcm1zLnNwZWN1bGFyQ29sb3IudmFsdWUuY29weSggbWF0ZXJpYWwuc3BlY3VsYXJDb2xvciApOwoKCQlpZiAoIG1hdGVyaWFsLnNwZWN1bGFyQ29sb3JNYXAgKSB7CgoJCQl1bmlmb3Jtcy5zcGVjdWxhckNvbG9yTWFwLnZhbHVlID0gbWF0ZXJpYWwuc3BlY3VsYXJDb2xvck1hcDsKCgkJCXJlZnJlc2hUcmFuc2Zvcm1Vbmlmb3JtKCBtYXRlcmlhbC5zcGVjdWxhckNvbG9yTWFwLCB1bmlmb3Jtcy5zcGVjdWxhckNvbG9yTWFwVHJhbnNmb3JtICk7CgoJCX0KCgkJaWYgKCBtYXRlcmlhbC5zcGVjdWxhckludGVuc2l0eU1hcCApIHsKCgkJCXVuaWZvcm1zLnNwZWN1bGFySW50ZW5zaXR5TWFwLnZhbHVlID0gbWF0ZXJpYWwuc3BlY3VsYXJJbnRlbnNpdHlNYXA7CgoJCQlyZWZyZXNoVHJhbnNmb3JtVW5pZm9ybSggbWF0ZXJpYWwuc3BlY3VsYXJJbnRlbnNpdHlNYXAsIHVuaWZvcm1zLnNwZWN1bGFySW50ZW5zaXR5TWFwVHJhbnNmb3JtICk7CgoJCX0KCgl9CgoJZnVuY3Rpb24gcmVmcmVzaFVuaWZvcm1zTWF0Y2FwKCB1bmlmb3JtcywgbWF0ZXJpYWwgKSB7CgoJCWlmICggbWF0ZXJpYWwubWF0Y2FwICkgewoKCQkJdW5pZm9ybXMubWF0Y2FwLnZhbHVlID0gbWF0ZXJpYWwubWF0Y2FwOwoKCQl9CgoJfQoKCWZ1bmN0aW9uIHJlZnJlc2hVbmlmb3Jtc0Rpc3RhbmNlKCB1bmlmb3JtcywgbWF0ZXJpYWwgKSB7CgoJCWNvbnN0IGxpZ2h0ID0gcHJvcGVydGllcy5nZXQoIG1hdGVyaWFsICkubGlnaHQ7CgoJCXVuaWZvcm1zLnJlZmVyZW5jZVBvc2l0aW9uLnZhbHVlLnNldEZyb21NYXRyaXhQb3NpdGlvbiggbGlnaHQubWF0cml4V29ybGQgKTsKCQl1bmlmb3Jtcy5uZWFyRGlzdGFuY2UudmFsdWUgPSBsaWdodC5zaGFkb3cuY2FtZXJhLm5lYXI7CgkJdW5pZm9ybXMuZmFyRGlzdGFuY2UudmFsdWUgPSBsaWdodC5zaGFkb3cuY2FtZXJhLmZhcjsKCgl9CgoJcmV0dXJuIHsKCQlyZWZyZXNoRm9nVW5pZm9ybXM6IHJlZnJlc2hGb2dVbmlmb3JtcywKCQlyZWZyZXNoTWF0ZXJpYWxVbmlmb3JtczogcmVmcmVzaE1hdGVyaWFsVW5pZm9ybXMKCX07Cgp9CgpmdW5jdGlvbiBXZWJHTFVuaWZvcm1zR3JvdXBzKCBnbCwgaW5mbywgY2FwYWJpbGl0aWVzLCBzdGF0ZSApIHsKCglsZXQgYnVmZmVycyA9IHt9OwoJbGV0IHVwZGF0ZUxpc3QgPSB7fTsKCWxldCBhbGxvY2F0ZWRCaW5kaW5nUG9pbnRzID0gW107CgoJY29uc3QgbWF4QmluZGluZ1BvaW50cyA9ICggY2FwYWJpbGl0aWVzLmlzV2ViR0wyICkgPyBnbC5nZXRQYXJhbWV0ZXIoIGdsLk1BWF9VTklGT1JNX0JVRkZFUl9CSU5ESU5HUyApIDogMDsgLy8gYmluZGluZyBwb2ludHMgYXJlIGdsb2JhbCB3aGVyZWFzIGJsb2NrIGluZGljZXMgYXJlIHBlciBzaGFkZXIgcHJvZ3JhbQoKCWZ1bmN0aW9uIGJpbmQoIHVuaWZvcm1zR3JvdXAsIHByb2dyYW0gKSB7CgoJCWNvbnN0IHdlYmdsUHJvZ3JhbSA9IHByb2dyYW0ucHJvZ3JhbTsKCQlzdGF0ZS51bmlmb3JtQmxvY2tCaW5kaW5nKCB1bmlmb3Jtc0dyb3VwLCB3ZWJnbFByb2dyYW0gKTsKCgl9CgoJZnVuY3Rpb24gdXBkYXRlKCB1bmlmb3Jtc0dyb3VwLCBwcm9ncmFtICkgewoKCQlsZXQgYnVmZmVyID0gYnVmZmVyc1sgdW5pZm9ybXNHcm91cC5pZCBdOwoKCQlpZiAoIGJ1ZmZlciA9PT0gdW5kZWZpbmVkICkgewoKCQkJcHJlcGFyZVVuaWZvcm1zR3JvdXAoIHVuaWZvcm1zR3JvdXAgKTsKCgkJCWJ1ZmZlciA9IGNyZWF0ZUJ1ZmZlciggdW5pZm9ybXNHcm91cCApOwoJCQlidWZmZXJzWyB1bmlmb3Jtc0dyb3VwLmlkIF0gPSBidWZmZXI7CgoJCQl1bmlmb3Jtc0dyb3VwLmFkZEV2ZW50TGlzdGVuZXIoICdkaXNwb3NlJywgb25Vbmlmb3Jtc0dyb3Vwc0Rpc3Bvc2UgKTsKCgkJfQoKCQkvLyBlbnN1cmUgdG8gdXBkYXRlIHRoZSBiaW5kaW5nIHBvaW50cy9ibG9jayBpbmRpY2VzIG1hcHBpbmcgZm9yIHRoaXMgcHJvZ3JhbQoKCQljb25zdCB3ZWJnbFByb2dyYW0gPSBwcm9ncmFtLnByb2dyYW07CgkJc3RhdGUudXBkYXRlVUJPTWFwcGluZyggdW5pZm9ybXNHcm91cCwgd2ViZ2xQcm9ncmFtICk7CgoJCS8vIHVwZGF0ZSBVQk8gb25jZSBwZXIgZnJhbWUKCgkJY29uc3QgZnJhbWUgPSBpbmZvLnJlbmRlci5mcmFtZTsKCgkJaWYgKCB1cGRhdGVMaXN0WyB1bmlmb3Jtc0dyb3VwLmlkIF0gIT09IGZyYW1lICkgewoKCQkJdXBkYXRlQnVmZmVyRGF0YSggdW5pZm9ybXNHcm91cCApOwoKCQkJdXBkYXRlTGlzdFsgdW5pZm9ybXNHcm91cC5pZCBdID0gZnJhbWU7CgoJCX0KCgl9CgoJZnVuY3Rpb24gY3JlYXRlQnVmZmVyKCB1bmlmb3Jtc0dyb3VwICkgewoKCQkvLyB0aGUgc2V0dXAgb2YgYW4gVUJPIGlzIGluZGVwZW5kZW50IG9mIGEgcGFydGljdWxhciBzaGFkZXIgcHJvZ3JhbSBidXQgZ2xvYmFsCgoJCWNvbnN0IGJpbmRpbmdQb2ludEluZGV4ID0gYWxsb2NhdGVCaW5kaW5nUG9pbnRJbmRleCgpOwoJCXVuaWZvcm1zR3JvdXAuX19iaW5kaW5nUG9pbnRJbmRleCA9IGJpbmRpbmdQb2ludEluZGV4OwoKCQljb25zdCBidWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCQljb25zdCBzaXplID0gdW5pZm9ybXNHcm91cC5fX3NpemU7CgkJY29uc3QgdXNhZ2UgPSB1bmlmb3Jtc0dyb3VwLnVzYWdlOwoKCQlnbC5iaW5kQnVmZmVyKCBnbC5VTklGT1JNX0JVRkZFUiwgYnVmZmVyICk7CgkJZ2wuYnVmZmVyRGF0YSggZ2wuVU5JRk9STV9CVUZGRVIsIHNpemUsIHVzYWdlICk7CgkJZ2wuYmluZEJ1ZmZlciggZ2wuVU5JRk9STV9CVUZGRVIsIG51bGwgKTsKCQlnbC5iaW5kQnVmZmVyQmFzZSggZ2wuVU5JRk9STV9CVUZGRVIsIGJpbmRpbmdQb2ludEluZGV4LCBidWZmZXIgKTsKCgkJcmV0dXJuIGJ1ZmZlcjsKCgl9CgoJZnVuY3Rpb24gYWxsb2NhdGVCaW5kaW5nUG9pbnRJbmRleCgpIHsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgbWF4QmluZGluZ1BvaW50czsgaSArKyApIHsKCgkJCWlmICggYWxsb2NhdGVkQmluZGluZ1BvaW50cy5pbmRleE9mKCBpICkgPT09IC0gMSApIHsKCgkJCQlhbGxvY2F0ZWRCaW5kaW5nUG9pbnRzLnB1c2goIGkgKTsKCQkJCXJldHVybiBpOwoKCQkJfQoKCQl9CgoJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBNYXhpbXVtIG51bWJlciBvZiBzaW11bHRhbmVvdXNseSB1c2FibGUgdW5pZm9ybXMgZ3JvdXBzIHJlYWNoZWQuJyApOwoKCQlyZXR1cm4gMDsKCgl9CgoJZnVuY3Rpb24gdXBkYXRlQnVmZmVyRGF0YSggdW5pZm9ybXNHcm91cCApIHsKCgkJY29uc3QgYnVmZmVyID0gYnVmZmVyc1sgdW5pZm9ybXNHcm91cC5pZCBdOwoJCWNvbnN0IHVuaWZvcm1zID0gdW5pZm9ybXNHcm91cC51bmlmb3JtczsKCQljb25zdCBjYWNoZSA9IHVuaWZvcm1zR3JvdXAuX19jYWNoZTsKCgkJZ2wuYmluZEJ1ZmZlciggZ2wuVU5JRk9STV9CVUZGRVIsIGJ1ZmZlciApOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gdW5pZm9ybXMubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQljb25zdCB1bmlmb3JtQXJyYXkgPSBBcnJheS5pc0FycmF5KCB1bmlmb3Jtc1sgaSBdICkgPyB1bmlmb3Jtc1sgaSBdIDogWyB1bmlmb3Jtc1sgaSBdIF07CgoJCQlmb3IgKCBsZXQgaiA9IDAsIGpsID0gdW5pZm9ybUFycmF5Lmxlbmd0aDsgaiA8IGpsOyBqICsrICkgewoKCQkJCWNvbnN0IHVuaWZvcm0gPSB1bmlmb3JtQXJyYXlbIGogXTsKCgkJCQlpZiAoIGhhc1VuaWZvcm1DaGFuZ2VkKCB1bmlmb3JtLCBpLCBqLCBjYWNoZSApID09PSB0cnVlICkgewoKCQkJCQljb25zdCBvZmZzZXQgPSB1bmlmb3JtLl9fb2Zmc2V0OwoKCQkJCQljb25zdCB2YWx1ZXMgPSBBcnJheS5pc0FycmF5KCB1bmlmb3JtLnZhbHVlICkgPyB1bmlmb3JtLnZhbHVlIDogWyB1bmlmb3JtLnZhbHVlIF07CgoJCQkJCWxldCBhcnJheU9mZnNldCA9IDA7CgoJCQkJCWZvciAoIGxldCBrID0gMDsgayA8IHZhbHVlcy5sZW5ndGg7IGsgKysgKSB7CgoJCQkJCQljb25zdCB2YWx1ZSA9IHZhbHVlc1sgayBdOwoKCQkJCQkJY29uc3QgaW5mbyA9IGdldFVuaWZvcm1TaXplKCB2YWx1ZSApOwoKCQkJCQkJLy8gVE9ETyBhZGQgaW50ZWdlciBhbmQgc3RydWN0IHN1cHBvcnQKCQkJCQkJaWYgKCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nICkgewoKCQkJCQkJCXVuaWZvcm0uX19kYXRhWyAwIF0gPSB2YWx1ZTsKCQkJCQkJCWdsLmJ1ZmZlclN1YkRhdGEoIGdsLlVOSUZPUk1fQlVGRkVSLCBvZmZzZXQgKyBhcnJheU9mZnNldCwgdW5pZm9ybS5fX2RhdGEgKTsKCgkJCQkJCX0gZWxzZSBpZiAoIHZhbHVlLmlzTWF0cml4MyApIHsKCgkJCQkJCQkvLyBtYW51YWxseSBjb252ZXJ0aW5nIDN4MyB0byAzeDQKCgkJCQkJCQl1bmlmb3JtLl9fZGF0YVsgMCBdID0gdmFsdWUuZWxlbWVudHNbIDAgXTsKCQkJCQkJCXVuaWZvcm0uX19kYXRhWyAxIF0gPSB2YWx1ZS5lbGVtZW50c1sgMSBdOwoJCQkJCQkJdW5pZm9ybS5fX2RhdGFbIDIgXSA9IHZhbHVlLmVsZW1lbnRzWyAyIF07CgkJCQkJCQl1bmlmb3JtLl9fZGF0YVsgMyBdID0gMDsKCQkJCQkJCXVuaWZvcm0uX19kYXRhWyA0IF0gPSB2YWx1ZS5lbGVtZW50c1sgMyBdOwoJCQkJCQkJdW5pZm9ybS5fX2RhdGFbIDUgXSA9IHZhbHVlLmVsZW1lbnRzWyA0IF07CgkJCQkJCQl1bmlmb3JtLl9fZGF0YVsgNiBdID0gdmFsdWUuZWxlbWVudHNbIDUgXTsKCQkJCQkJCXVuaWZvcm0uX19kYXRhWyA3IF0gPSAwOwoJCQkJCQkJdW5pZm9ybS5fX2RhdGFbIDggXSA9IHZhbHVlLmVsZW1lbnRzWyA2IF07CgkJCQkJCQl1bmlmb3JtLl9fZGF0YVsgOSBdID0gdmFsdWUuZWxlbWVudHNbIDcgXTsKCQkJCQkJCXVuaWZvcm0uX19kYXRhWyAxMCBdID0gdmFsdWUuZWxlbWVudHNbIDggXTsKCQkJCQkJCXVuaWZvcm0uX19kYXRhWyAxMSBdID0gMDsKCgkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJdmFsdWUudG9BcnJheSggdW5pZm9ybS5fX2RhdGEsIGFycmF5T2Zmc2V0ICk7CgoJCQkJCQkJYXJyYXlPZmZzZXQgKz0gaW5mby5zdG9yYWdlIC8gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWdsLmJ1ZmZlclN1YkRhdGEoIGdsLlVOSUZPUk1fQlVGRkVSLCBvZmZzZXQsIHVuaWZvcm0uX19kYXRhICk7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCWdsLmJpbmRCdWZmZXIoIGdsLlVOSUZPUk1fQlVGRkVSLCBudWxsICk7CgoJfQoKCWZ1bmN0aW9uIGhhc1VuaWZvcm1DaGFuZ2VkKCB1bmlmb3JtLCBpbmRleCwgaW5kZXhBcnJheSwgY2FjaGUgKSB7CgoJCWNvbnN0IHZhbHVlID0gdW5pZm9ybS52YWx1ZTsKCQljb25zdCBpbmRleFN0cmluZyA9IGluZGV4ICsgJ18nICsgaW5kZXhBcnJheTsKCgkJaWYgKCBjYWNoZVsgaW5kZXhTdHJpbmcgXSA9PT0gdW5kZWZpbmVkICkgewoKCQkJLy8gY2FjaGUgZW50cnkgZG9lcyBub3QgZXhpc3Qgc28gZmFyCgoJCQlpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgfHwgdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicgKSB7CgoJCQkJY2FjaGVbIGluZGV4U3RyaW5nIF0gPSB2YWx1ZTsKCgkJCX0gZWxzZSB7CgoJCQkJY2FjaGVbIGluZGV4U3RyaW5nIF0gPSB2YWx1ZS5jbG9uZSgpOwoKCQkJfQoKCQkJcmV0dXJuIHRydWU7CgoJCX0gZWxzZSB7CgoJCQljb25zdCBjYWNoZWRPYmplY3QgPSBjYWNoZVsgaW5kZXhTdHJpbmcgXTsKCgkJCS8vIGNvbXBhcmUgY3VycmVudCB2YWx1ZSB3aXRoIGNhY2hlZCBlbnRyeQoKCQkJaWYgKCB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nICkgewoKCQkJCWlmICggY2FjaGVkT2JqZWN0ICE9PSB2YWx1ZSApIHsKCgkJCQkJY2FjaGVbIGluZGV4U3RyaW5nIF0gPSB2YWx1ZTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCgkJCQl9CgoJCQl9IGVsc2UgewoKCQkJCWlmICggY2FjaGVkT2JqZWN0LmVxdWFscyggdmFsdWUgKSA9PT0gZmFsc2UgKSB7CgoJCQkJCWNhY2hlZE9iamVjdC5jb3B5KCB2YWx1ZSApOwoJCQkJCXJldHVybiB0cnVlOwoKCQkJCX0KCgkJCX0KCgkJfQoKCQlyZXR1cm4gZmFsc2U7CgoJfQoKCWZ1bmN0aW9uIHByZXBhcmVVbmlmb3Jtc0dyb3VwKCB1bmlmb3Jtc0dyb3VwICkgewoKCQkvLyBkZXRlcm1pbmUgdG90YWwgYnVmZmVyIHNpemUgYWNjb3JkaW5nIHRvIHRoZSBTVEQxNDAgbGF5b3V0CgkJLy8gSGludDogU1REMTQwIGlzIHRoZSBvbmx5IHN1cHBvcnRlZCBsYXlvdXQgaW4gV2ViR0wgMgoKCQljb25zdCB1bmlmb3JtcyA9IHVuaWZvcm1zR3JvdXAudW5pZm9ybXM7CgoJCWxldCBvZmZzZXQgPSAwOyAvLyBnbG9iYWwgYnVmZmVyIG9mZnNldCBpbiBieXRlcwoJCWNvbnN0IGNodW5rU2l6ZSA9IDE2OyAvLyBzaXplIG9mIGEgY2h1bmsgaW4gYnl0ZXMKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gdW5pZm9ybXMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWNvbnN0IHVuaWZvcm1BcnJheSA9IEFycmF5LmlzQXJyYXkoIHVuaWZvcm1zWyBpIF0gKSA/IHVuaWZvcm1zWyBpIF0gOiBbIHVuaWZvcm1zWyBpIF0gXTsKCgkJCWZvciAoIGxldCBqID0gMCwgamwgPSB1bmlmb3JtQXJyYXkubGVuZ3RoOyBqIDwgamw7IGogKysgKSB7CgoJCQkJY29uc3QgdW5pZm9ybSA9IHVuaWZvcm1BcnJheVsgaiBdOwoKCQkJCWNvbnN0IHZhbHVlcyA9IEFycmF5LmlzQXJyYXkoIHVuaWZvcm0udmFsdWUgKSA/IHVuaWZvcm0udmFsdWUgOiBbIHVuaWZvcm0udmFsdWUgXTsKCgkJCQlmb3IgKCBsZXQgayA9IDAsIGtsID0gdmFsdWVzLmxlbmd0aDsgayA8IGtsOyBrICsrICkgewoKCQkJCQljb25zdCB2YWx1ZSA9IHZhbHVlc1sgayBdOwoKCQkJCQljb25zdCBpbmZvID0gZ2V0VW5pZm9ybVNpemUoIHZhbHVlICk7CgoJCQkJCS8vIENhbGN1bGF0ZSB0aGUgY2h1bmsgb2Zmc2V0CgkJCQkJY29uc3QgY2h1bmtPZmZzZXRVbmlmb3JtID0gb2Zmc2V0ICUgY2h1bmtTaXplOwoKCQkJCQkvLyBDaGVjayBmb3IgY2h1bmsgb3ZlcmZsb3cKCQkJCQlpZiAoIGNodW5rT2Zmc2V0VW5pZm9ybSAhPT0gMCAmJiAoIGNodW5rU2l6ZSAtIGNodW5rT2Zmc2V0VW5pZm9ybSApIDwgaW5mby5ib3VuZGFyeSApIHsKCgkJCQkJCS8vIEFkZCBwYWRkaW5nIGFuZCBhZGp1c3Qgb2Zmc2V0CgkJCQkJCW9mZnNldCArPSAoIGNodW5rU2l6ZSAtIGNodW5rT2Zmc2V0VW5pZm9ybSApOwoKCQkJCQl9CgoJCQkJCS8vIHRoZSBmb2xsb3dpbmcgdHdvIHByb3BlcnRpZXMgd2lsbCBiZSB1c2VkIGZvciBwYXJ0aWFsIGJ1ZmZlciB1cGRhdGVzCgoJCQkJCXVuaWZvcm0uX19kYXRhID0gbmV3IEZsb2F0MzJBcnJheSggaW5mby5zdG9yYWdlIC8gRmxvYXQzMkFycmF5LkJZVEVTX1BFUl9FTEVNRU5UICk7CgkJCQkJdW5pZm9ybS5fX29mZnNldCA9IG9mZnNldDsKCgoJCQkJCS8vIFVwZGF0ZSB0aGUgZ2xvYmFsIG9mZnNldAoJCQkJCW9mZnNldCArPSBpbmZvLnN0b3JhZ2U7CgoKCQkJCX0KCgkJCX0KCgkJfQoKCQkvLyBlbnN1cmUgY29ycmVjdCBmaW5hbCBwYWRkaW5nCgoJCWNvbnN0IGNodW5rT2Zmc2V0ID0gb2Zmc2V0ICUgY2h1bmtTaXplOwoKCQlpZiAoIGNodW5rT2Zmc2V0ID4gMCApIG9mZnNldCArPSAoIGNodW5rU2l6ZSAtIGNodW5rT2Zmc2V0ICk7CgoJCS8vCgoJCXVuaWZvcm1zR3JvdXAuX19zaXplID0gb2Zmc2V0OwoJCXVuaWZvcm1zR3JvdXAuX19jYWNoZSA9IHt9OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZnVuY3Rpb24gZ2V0VW5pZm9ybVNpemUoIHZhbHVlICkgewoKCQljb25zdCBpbmZvID0gewoJCQlib3VuZGFyeTogMCwgLy8gYnl0ZXMKCQkJc3RvcmFnZTogMCAvLyBieXRlcwoJCX07CgoJCS8vIGRldGVybWluZSBzaXplcyBhY2NvcmRpbmcgdG8gU1REMTQwCgoJCWlmICggdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyB8fCB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJyApIHsKCgkJCS8vIGZsb2F0L2ludC9ib29sCgoJCQlpbmZvLmJvdW5kYXJ5ID0gNDsKCQkJaW5mby5zdG9yYWdlID0gNDsKCgkJfSBlbHNlIGlmICggdmFsdWUuaXNWZWN0b3IyICkgewoKCQkJLy8gdmVjMgoKCQkJaW5mby5ib3VuZGFyeSA9IDg7CgkJCWluZm8uc3RvcmFnZSA9IDg7CgoJCX0gZWxzZSBpZiAoIHZhbHVlLmlzVmVjdG9yMyB8fCB2YWx1ZS5pc0NvbG9yICkgewoKCQkJLy8gdmVjMwoKCQkJaW5mby5ib3VuZGFyeSA9IDE2OwoJCQlpbmZvLnN0b3JhZ2UgPSAxMjsgLy8gZXZpbDogdmVjMyBtdXN0IHN0YXJ0IG9uIGEgMTYtYnl0ZSBib3VuZGFyeSBidXQgaXQgb25seSBjb25zdW1lcyAxMiBieXRlcwoKCQl9IGVsc2UgaWYgKCB2YWx1ZS5pc1ZlY3RvcjQgKSB7CgoJCQkvLyB2ZWM0CgoJCQlpbmZvLmJvdW5kYXJ5ID0gMTY7CgkJCWluZm8uc3RvcmFnZSA9IDE2OwoKCQl9IGVsc2UgaWYgKCB2YWx1ZS5pc01hdHJpeDMgKSB7CgoJCQkvLyBtYXQzIChpbiBTVEQxNDAgYSAzeDMgbWF0cml4IGlzIHJlcHJlc2VudGVkIGFzIDN4NCkKCgkJCWluZm8uYm91bmRhcnkgPSA0ODsKCQkJaW5mby5zdG9yYWdlID0gNDg7CgoJCX0gZWxzZSBpZiAoIHZhbHVlLmlzTWF0cml4NCApIHsKCgkJCS8vIG1hdDQKCgkJCWluZm8uYm91bmRhcnkgPSA2NDsKCQkJaW5mby5zdG9yYWdlID0gNjQ7CgoJCX0gZWxzZSBpZiAoIHZhbHVlLmlzVGV4dHVyZSApIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IFRleHR1cmUgc2FtcGxlcnMgY2FuIG5vdCBiZSBwYXJ0IG9mIGFuIHVuaWZvcm1zIGdyb3VwLicgKTsKCgkJfSBlbHNlIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IFVuc3VwcG9ydGVkIHVuaWZvcm0gdmFsdWUgdHlwZS4nLCB2YWx1ZSApOwoKCQl9CgoJCXJldHVybiBpbmZvOwoKCX0KCglmdW5jdGlvbiBvblVuaWZvcm1zR3JvdXBzRGlzcG9zZSggZXZlbnQgKSB7CgoJCWNvbnN0IHVuaWZvcm1zR3JvdXAgPSBldmVudC50YXJnZXQ7CgoJCXVuaWZvcm1zR3JvdXAucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ2Rpc3Bvc2UnLCBvblVuaWZvcm1zR3JvdXBzRGlzcG9zZSApOwoKCQljb25zdCBpbmRleCA9IGFsbG9jYXRlZEJpbmRpbmdQb2ludHMuaW5kZXhPZiggdW5pZm9ybXNHcm91cC5fX2JpbmRpbmdQb2ludEluZGV4ICk7CgkJYWxsb2NhdGVkQmluZGluZ1BvaW50cy5zcGxpY2UoIGluZGV4LCAxICk7CgoJCWdsLmRlbGV0ZUJ1ZmZlciggYnVmZmVyc1sgdW5pZm9ybXNHcm91cC5pZCBdICk7CgoJCWRlbGV0ZSBidWZmZXJzWyB1bmlmb3Jtc0dyb3VwLmlkIF07CgkJZGVsZXRlIHVwZGF0ZUxpc3RbIHVuaWZvcm1zR3JvdXAuaWQgXTsKCgl9CgoJZnVuY3Rpb24gZGlzcG9zZSgpIHsKCgkJZm9yICggY29uc3QgaWQgaW4gYnVmZmVycyApIHsKCgkJCWdsLmRlbGV0ZUJ1ZmZlciggYnVmZmVyc1sgaWQgXSApOwoKCQl9CgoJCWFsbG9jYXRlZEJpbmRpbmdQb2ludHMgPSBbXTsKCQlidWZmZXJzID0ge307CgkJdXBkYXRlTGlzdCA9IHt9OwoKCX0KCglyZXR1cm4gewoKCQliaW5kOiBiaW5kLAoJCXVwZGF0ZTogdXBkYXRlLAoKCQlkaXNwb3NlOiBkaXNwb3NlCgoJfTsKCn0KCmNsYXNzIFdlYkdMUmVuZGVyZXIgewoKCWNvbnN0cnVjdG9yKCBwYXJhbWV0ZXJzID0ge30gKSB7CgoJCWNvbnN0IHsKCQkJY2FudmFzID0gY3JlYXRlQ2FudmFzRWxlbWVudCgpLAoJCQljb250ZXh0ID0gbnVsbCwKCQkJZGVwdGggPSB0cnVlLAoJCQlzdGVuY2lsID0gdHJ1ZSwKCQkJYWxwaGEgPSBmYWxzZSwKCQkJYW50aWFsaWFzID0gZmFsc2UsCgkJCXByZW11bHRpcGxpZWRBbHBoYSA9IHRydWUsCgkJCXByZXNlcnZlRHJhd2luZ0J1ZmZlciA9IGZhbHNlLAoJCQlwb3dlclByZWZlcmVuY2UgPSAnZGVmYXVsdCcsCgkJCWZhaWxJZk1ham9yUGVyZm9ybWFuY2VDYXZlYXQgPSBmYWxzZSwKCQl9ID0gcGFyYW1ldGVyczsKCgkJdGhpcy5pc1dlYkdMUmVuZGVyZXIgPSB0cnVlOwoKCQlsZXQgX2FscGhhOwoKCQlpZiAoIGNvbnRleHQgIT09IG51bGwgKSB7CgoJCQlfYWxwaGEgPSBjb250ZXh0LmdldENvbnRleHRBdHRyaWJ1dGVzKCkuYWxwaGE7CgoJCX0gZWxzZSB7CgoJCQlfYWxwaGEgPSBhbHBoYTsKCgkJfQoKCQljb25zdCB1aW50Q2xlYXJDb2xvciA9IG5ldyBVaW50MzJBcnJheSggNCApOwoJCWNvbnN0IGludENsZWFyQ29sb3IgPSBuZXcgSW50MzJBcnJheSggNCApOwoKCQlsZXQgY3VycmVudFJlbmRlckxpc3QgPSBudWxsOwoJCWxldCBjdXJyZW50UmVuZGVyU3RhdGUgPSBudWxsOwoKCQkvLyByZW5kZXIoKSBjYW4gYmUgY2FsbGVkIGZyb20gd2l0aGluIGEgY2FsbGJhY2sgdHJpZ2dlcmVkIGJ5IGFub3RoZXIgcmVuZGVyLgoJCS8vIFdlIHRyYWNrIHRoaXMgc28gdGhhdCB0aGUgbmVzdGVkIHJlbmRlciBjYWxsIGdldHMgaXRzIGxpc3QgYW5kIHN0YXRlIGlzb2xhdGVkIGZyb20gdGhlIHBhcmVudCByZW5kZXIgY2FsbC4KCgkJY29uc3QgcmVuZGVyTGlzdFN0YWNrID0gW107CgkJY29uc3QgcmVuZGVyU3RhdGVTdGFjayA9IFtdOwoKCQkvLyBwdWJsaWMgcHJvcGVydGllcwoKCQl0aGlzLmRvbUVsZW1lbnQgPSBjYW52YXM7CgoJCS8vIERlYnVnIGNvbmZpZ3VyYXRpb24gY29udGFpbmVyCgkJdGhpcy5kZWJ1ZyA9IHsKCgkJCS8qKgoJCQkgKiBFbmFibGVzIGVycm9yIGNoZWNraW5nIGFuZCByZXBvcnRpbmcgd2hlbiBzaGFkZXIgcHJvZ3JhbXMgYXJlIGJlaW5nIGNvbXBpbGVkCgkJCSAqIEB0eXBlIHtib29sZWFufQoJCQkgKi8KCQkJY2hlY2tTaGFkZXJFcnJvcnM6IHRydWUsCgkJCS8qKgoJCQkgKiBDYWxsYmFjayBmb3IgY3VzdG9tIGVycm9yIHJlcG9ydGluZy4KCQkJICogQHR5cGUgez9GdW5jdGlvbn0KCQkJICovCgkJCW9uU2hhZGVyRXJyb3I6IG51bGwKCQl9OwoKCQkvLyBjbGVhcmluZwoKCQl0aGlzLmF1dG9DbGVhciA9IHRydWU7CgkJdGhpcy5hdXRvQ2xlYXJDb2xvciA9IHRydWU7CgkJdGhpcy5hdXRvQ2xlYXJEZXB0aCA9IHRydWU7CgkJdGhpcy5hdXRvQ2xlYXJTdGVuY2lsID0gdHJ1ZTsKCgkJLy8gc2NlbmUgZ3JhcGgKCgkJdGhpcy5zb3J0T2JqZWN0cyA9IHRydWU7CgoJCS8vIHVzZXItZGVmaW5lZCBjbGlwcGluZwoKCQl0aGlzLmNsaXBwaW5nUGxhbmVzID0gW107CgkJdGhpcy5sb2NhbENsaXBwaW5nRW5hYmxlZCA9IGZhbHNlOwoKCQkvLyBwaHlzaWNhbGx5IGJhc2VkIHNoYWRpbmcKCgkJdGhpcy5fb3V0cHV0Q29sb3JTcGFjZSA9IFNSR0JDb2xvclNwYWNlOwoKCQkvLyBwaHlzaWNhbCBsaWdodHMKCgkJdGhpcy5fdXNlTGVnYWN5TGlnaHRzID0gZmFsc2U7CgoJCS8vIHRvbmUgbWFwcGluZwoKCQl0aGlzLnRvbmVNYXBwaW5nID0gTm9Ub25lTWFwcGluZzsKCQl0aGlzLnRvbmVNYXBwaW5nRXhwb3N1cmUgPSAxLjA7CgoJCS8vIGludGVybmFsIHByb3BlcnRpZXMKCgkJY29uc3QgX3RoaXMgPSB0aGlzOwoKCQlsZXQgX2lzQ29udGV4dExvc3QgPSBmYWxzZTsKCgkJLy8gaW50ZXJuYWwgc3RhdGUgY2FjaGUKCgkJbGV0IF9jdXJyZW50QWN0aXZlQ3ViZUZhY2UgPSAwOwoJCWxldCBfY3VycmVudEFjdGl2ZU1pcG1hcExldmVsID0gMDsKCQlsZXQgX2N1cnJlbnRSZW5kZXJUYXJnZXQgPSBudWxsOwoJCWxldCBfY3VycmVudE1hdGVyaWFsSWQgPSAtIDE7CgoJCWxldCBfY3VycmVudENhbWVyYSA9IG51bGw7CgoJCWNvbnN0IF9jdXJyZW50Vmlld3BvcnQgPSBuZXcgVmVjdG9yNCgpOwoJCWNvbnN0IF9jdXJyZW50U2Npc3NvciA9IG5ldyBWZWN0b3I0KCk7CgkJbGV0IF9jdXJyZW50U2Npc3NvclRlc3QgPSBudWxsOwoKCQljb25zdCBfY3VycmVudENsZWFyQ29sb3IgPSBuZXcgQ29sb3IoIDB4MDAwMDAwICk7CgkJbGV0IF9jdXJyZW50Q2xlYXJBbHBoYSA9IDA7CgoJCS8vCgoJCWxldCBfd2lkdGggPSBjYW52YXMud2lkdGg7CgkJbGV0IF9oZWlnaHQgPSBjYW52YXMuaGVpZ2h0OwoKCQlsZXQgX3BpeGVsUmF0aW8gPSAxOwoJCWxldCBfb3BhcXVlU29ydCA9IG51bGw7CgkJbGV0IF90cmFuc3BhcmVudFNvcnQgPSBudWxsOwoKCQljb25zdCBfdmlld3BvcnQgPSBuZXcgVmVjdG9yNCggMCwgMCwgX3dpZHRoLCBfaGVpZ2h0ICk7CgkJY29uc3QgX3NjaXNzb3IgPSBuZXcgVmVjdG9yNCggMCwgMCwgX3dpZHRoLCBfaGVpZ2h0ICk7CgkJbGV0IF9zY2lzc29yVGVzdCA9IGZhbHNlOwoKCQkvLyBmcnVzdHVtCgoJCWNvbnN0IF9mcnVzdHVtID0gbmV3IEZydXN0dW0oKTsKCgkJLy8gY2xpcHBpbmcKCgkJbGV0IF9jbGlwcGluZ0VuYWJsZWQgPSBmYWxzZTsKCQlsZXQgX2xvY2FsQ2xpcHBpbmdFbmFibGVkID0gZmFsc2U7CgoJCS8vIHRyYW5zbWlzc2lvbgoKCQlsZXQgX3RyYW5zbWlzc2lvblJlbmRlclRhcmdldCA9IG51bGw7CgoJCS8vIGNhbWVyYSBtYXRyaWNlcyBjYWNoZQoKCQljb25zdCBfcHJvalNjcmVlbk1hdHJpeCA9IG5ldyBNYXRyaXg0KCk7CgoJCWNvbnN0IF92ZWN0b3IyID0gbmV3IFZlY3RvcjIoKTsKCQljb25zdCBfdmVjdG9yMyA9IG5ldyBWZWN0b3IzKCk7CgoJCWNvbnN0IF9lbXB0eVNjZW5lID0geyBiYWNrZ3JvdW5kOiBudWxsLCBmb2c6IG51bGwsIGVudmlyb25tZW50OiBudWxsLCBvdmVycmlkZU1hdGVyaWFsOiBudWxsLCBpc1NjZW5lOiB0cnVlIH07CgoJCWZ1bmN0aW9uIGdldFRhcmdldFBpeGVsUmF0aW8oKSB7CgoJCQlyZXR1cm4gX2N1cnJlbnRSZW5kZXJUYXJnZXQgPT09IG51bGwgPyBfcGl4ZWxSYXRpbyA6IDE7CgoJCX0KCgkJLy8gaW5pdGlhbGl6ZQoKCQlsZXQgX2dsID0gY29udGV4dDsKCgkJZnVuY3Rpb24gZ2V0Q29udGV4dCggY29udGV4dE5hbWVzLCBjb250ZXh0QXR0cmlidXRlcyApIHsKCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IGNvbnRleHROYW1lcy5sZW5ndGg7IGkgKysgKSB7CgoJCQkJY29uc3QgY29udGV4dE5hbWUgPSBjb250ZXh0TmFtZXNbIGkgXTsKCQkJCWNvbnN0IGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dCggY29udGV4dE5hbWUsIGNvbnRleHRBdHRyaWJ1dGVzICk7CgkJCQlpZiAoIGNvbnRleHQgIT09IG51bGwgKSByZXR1cm4gY29udGV4dDsKCgkJCX0KCgkJCXJldHVybiBudWxsOwoKCQl9CgoJCXRyeSB7CgoJCQljb25zdCBjb250ZXh0QXR0cmlidXRlcyA9IHsKCQkJCWFscGhhOiB0cnVlLAoJCQkJZGVwdGgsCgkJCQlzdGVuY2lsLAoJCQkJYW50aWFsaWFzLAoJCQkJcHJlbXVsdGlwbGllZEFscGhhLAoJCQkJcHJlc2VydmVEcmF3aW5nQnVmZmVyLAoJCQkJcG93ZXJQcmVmZXJlbmNlLAoJCQkJZmFpbElmTWFqb3JQZXJmb3JtYW5jZUNhdmVhdCwKCQkJfTsKCgkJCS8vIE9mZnNjcmVlbkNhbnZhcyBkb2VzIG5vdCBoYXZlIHNldEF0dHJpYnV0ZSwgc2VlICMyMjgxMQoJCQlpZiAoICdzZXRBdHRyaWJ1dGUnIGluIGNhbnZhcyApIGNhbnZhcy5zZXRBdHRyaWJ1dGUoICdkYXRhLWVuZ2luZScsIGB0aHJlZS5qcyByJHtSRVZJU0lPTn1gICk7CgoJCQkvLyBldmVudCBsaXN0ZW5lcnMgbXVzdCBiZSByZWdpc3RlcmVkIGJlZm9yZSBXZWJHTCBjb250ZXh0IGlzIGNyZWF0ZWQsIHNlZSAjMTI3NTMKCQkJY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoICd3ZWJnbGNvbnRleHRsb3N0Jywgb25Db250ZXh0TG9zdCwgZmFsc2UgKTsKCQkJY2FudmFzLmFkZEV2ZW50TGlzdGVuZXIoICd3ZWJnbGNvbnRleHRyZXN0b3JlZCcsIG9uQ29udGV4dFJlc3RvcmUsIGZhbHNlICk7CgkJCWNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCAnd2ViZ2xjb250ZXh0Y3JlYXRpb25lcnJvcicsIG9uQ29udGV4dENyZWF0aW9uRXJyb3IsIGZhbHNlICk7CgoJCQlpZiAoIF9nbCA9PT0gbnVsbCApIHsKCgkJCQljb25zdCBjb250ZXh0TmFtZXMgPSBbICd3ZWJnbDInLCAnd2ViZ2wnLCAnZXhwZXJpbWVudGFsLXdlYmdsJyBdOwoKCQkJCWlmICggX3RoaXMuaXNXZWJHTDFSZW5kZXJlciA9PT0gdHJ1ZSApIHsKCgkJCQkJY29udGV4dE5hbWVzLnNoaWZ0KCk7CgoJCQkJfQoKCQkJCV9nbCA9IGdldENvbnRleHQoIGNvbnRleHROYW1lcywgY29udGV4dEF0dHJpYnV0ZXMgKTsKCgkJCQlpZiAoIF9nbCA9PT0gbnVsbCApIHsKCgkJCQkJaWYgKCBnZXRDb250ZXh0KCBjb250ZXh0TmFtZXMgKSApIHsKCgkJCQkJCXRocm93IG5ldyBFcnJvciggJ0Vycm9yIGNyZWF0aW5nIFdlYkdMIGNvbnRleHQgd2l0aCB5b3VyIHNlbGVjdGVkIGF0dHJpYnV0ZXMuJyApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJdGhyb3cgbmV3IEVycm9yKCAnRXJyb3IgY3JlYXRpbmcgV2ViR0wgY29udGV4dC4nICk7CgoJCQkJCX0KCgkJCQl9CgoJCQl9CgoJCQlpZiAoIHR5cGVvZiBXZWJHTFJlbmRlcmluZ0NvbnRleHQgIT09ICd1bmRlZmluZWQnICYmIF9nbCBpbnN0YW5jZW9mIFdlYkdMUmVuZGVyaW5nQ29udGV4dCApIHsgLy8gQGRlcHJlY2F0ZWQsIHIxNTMKCgkJCQljb25zb2xlLndhcm4oICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBXZWJHTCAxIHN1cHBvcnQgd2FzIGRlcHJlY2F0ZWQgaW4gcjE1MyBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHIxNjMuJyApOwoKCQkJfQoKCQkJLy8gU29tZSBleHBlcmltZW50YWwtd2ViZ2wgaW1wbGVtZW50YXRpb25zIGRvIG5vdCBoYXZlIGdldFNoYWRlclByZWNpc2lvbkZvcm1hdAoKCQkJaWYgKCBfZ2wuZ2V0U2hhZGVyUHJlY2lzaW9uRm9ybWF0ID09PSB1bmRlZmluZWQgKSB7CgoJCQkJX2dsLmdldFNoYWRlclByZWNpc2lvbkZvcm1hdCA9IGZ1bmN0aW9uICgpIHsKCgkJCQkJcmV0dXJuIHsgJ3JhbmdlTWluJzogMSwgJ3JhbmdlTWF4JzogMSwgJ3ByZWNpc2lvbic6IDEgfTsKCgkJCQl9OwoKCQkJfQoKCQl9IGNhdGNoICggZXJyb3IgKSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogJyArIGVycm9yLm1lc3NhZ2UgKTsKCQkJdGhyb3cgZXJyb3I7CgoJCX0KCgkJbGV0IGV4dGVuc2lvbnMsIGNhcGFiaWxpdGllcywgc3RhdGUsIGluZm87CgkJbGV0IHByb3BlcnRpZXMsIHRleHR1cmVzLCBjdWJlbWFwcywgY3ViZXV2bWFwcywgYXR0cmlidXRlcywgZ2VvbWV0cmllcywgb2JqZWN0czsKCQlsZXQgcHJvZ3JhbUNhY2hlLCBtYXRlcmlhbHMsIHJlbmRlckxpc3RzLCByZW5kZXJTdGF0ZXMsIGNsaXBwaW5nLCBzaGFkb3dNYXA7CgoJCWxldCBiYWNrZ3JvdW5kLCBtb3JwaHRhcmdldHMsIGJ1ZmZlclJlbmRlcmVyLCBpbmRleGVkQnVmZmVyUmVuZGVyZXI7CgoJCWxldCB1dGlscywgYmluZGluZ1N0YXRlcywgdW5pZm9ybXNHcm91cHM7CgoJCWZ1bmN0aW9uIGluaXRHTENvbnRleHQoKSB7CgoJCQlleHRlbnNpb25zID0gbmV3IFdlYkdMRXh0ZW5zaW9ucyggX2dsICk7CgoJCQljYXBhYmlsaXRpZXMgPSBuZXcgV2ViR0xDYXBhYmlsaXRpZXMoIF9nbCwgZXh0ZW5zaW9ucywgcGFyYW1ldGVycyApOwoKCQkJZXh0ZW5zaW9ucy5pbml0KCBjYXBhYmlsaXRpZXMgKTsKCgkJCXV0aWxzID0gbmV3IFdlYkdMVXRpbHMoIF9nbCwgZXh0ZW5zaW9ucywgY2FwYWJpbGl0aWVzICk7CgoJCQlzdGF0ZSA9IG5ldyBXZWJHTFN0YXRlKCBfZ2wsIGV4dGVuc2lvbnMsIGNhcGFiaWxpdGllcyApOwoKCQkJaW5mbyA9IG5ldyBXZWJHTEluZm8oIF9nbCApOwoJCQlwcm9wZXJ0aWVzID0gbmV3IFdlYkdMUHJvcGVydGllcygpOwoJCQl0ZXh0dXJlcyA9IG5ldyBXZWJHTFRleHR1cmVzKCBfZ2wsIGV4dGVuc2lvbnMsIHN0YXRlLCBwcm9wZXJ0aWVzLCBjYXBhYmlsaXRpZXMsIHV0aWxzLCBpbmZvICk7CgkJCWN1YmVtYXBzID0gbmV3IFdlYkdMQ3ViZU1hcHMoIF90aGlzICk7CgkJCWN1YmV1dm1hcHMgPSBuZXcgV2ViR0xDdWJlVVZNYXBzKCBfdGhpcyApOwoJCQlhdHRyaWJ1dGVzID0gbmV3IFdlYkdMQXR0cmlidXRlcyggX2dsLCBjYXBhYmlsaXRpZXMgKTsKCQkJYmluZGluZ1N0YXRlcyA9IG5ldyBXZWJHTEJpbmRpbmdTdGF0ZXMoIF9nbCwgZXh0ZW5zaW9ucywgYXR0cmlidXRlcywgY2FwYWJpbGl0aWVzICk7CgkJCWdlb21ldHJpZXMgPSBuZXcgV2ViR0xHZW9tZXRyaWVzKCBfZ2wsIGF0dHJpYnV0ZXMsIGluZm8sIGJpbmRpbmdTdGF0ZXMgKTsKCQkJb2JqZWN0cyA9IG5ldyBXZWJHTE9iamVjdHMoIF9nbCwgZ2VvbWV0cmllcywgYXR0cmlidXRlcywgaW5mbyApOwoJCQltb3JwaHRhcmdldHMgPSBuZXcgV2ViR0xNb3JwaHRhcmdldHMoIF9nbCwgY2FwYWJpbGl0aWVzLCB0ZXh0dXJlcyApOwoJCQljbGlwcGluZyA9IG5ldyBXZWJHTENsaXBwaW5nKCBwcm9wZXJ0aWVzICk7CgkJCXByb2dyYW1DYWNoZSA9IG5ldyBXZWJHTFByb2dyYW1zKCBfdGhpcywgY3ViZW1hcHMsIGN1YmV1dm1hcHMsIGV4dGVuc2lvbnMsIGNhcGFiaWxpdGllcywgYmluZGluZ1N0YXRlcywgY2xpcHBpbmcgKTsKCQkJbWF0ZXJpYWxzID0gbmV3IFdlYkdMTWF0ZXJpYWxzKCBfdGhpcywgcHJvcGVydGllcyApOwoJCQlyZW5kZXJMaXN0cyA9IG5ldyBXZWJHTFJlbmRlckxpc3RzKCk7CgkJCXJlbmRlclN0YXRlcyA9IG5ldyBXZWJHTFJlbmRlclN0YXRlcyggZXh0ZW5zaW9ucywgY2FwYWJpbGl0aWVzICk7CgkJCWJhY2tncm91bmQgPSBuZXcgV2ViR0xCYWNrZ3JvdW5kKCBfdGhpcywgY3ViZW1hcHMsIGN1YmV1dm1hcHMsIHN0YXRlLCBvYmplY3RzLCBfYWxwaGEsIHByZW11bHRpcGxpZWRBbHBoYSApOwoJCQlzaGFkb3dNYXAgPSBuZXcgV2ViR0xTaGFkb3dNYXAoIF90aGlzLCBvYmplY3RzLCBjYXBhYmlsaXRpZXMgKTsKCQkJdW5pZm9ybXNHcm91cHMgPSBuZXcgV2ViR0xVbmlmb3Jtc0dyb3VwcyggX2dsLCBpbmZvLCBjYXBhYmlsaXRpZXMsIHN0YXRlICk7CgoJCQlidWZmZXJSZW5kZXJlciA9IG5ldyBXZWJHTEJ1ZmZlclJlbmRlcmVyKCBfZ2wsIGV4dGVuc2lvbnMsIGluZm8sIGNhcGFiaWxpdGllcyApOwoJCQlpbmRleGVkQnVmZmVyUmVuZGVyZXIgPSBuZXcgV2ViR0xJbmRleGVkQnVmZmVyUmVuZGVyZXIoIF9nbCwgZXh0ZW5zaW9ucywgaW5mbywgY2FwYWJpbGl0aWVzICk7CgoJCQlpbmZvLnByb2dyYW1zID0gcHJvZ3JhbUNhY2hlLnByb2dyYW1zOwoKCQkJX3RoaXMuY2FwYWJpbGl0aWVzID0gY2FwYWJpbGl0aWVzOwoJCQlfdGhpcy5leHRlbnNpb25zID0gZXh0ZW5zaW9uczsKCQkJX3RoaXMucHJvcGVydGllcyA9IHByb3BlcnRpZXM7CgkJCV90aGlzLnJlbmRlckxpc3RzID0gcmVuZGVyTGlzdHM7CgkJCV90aGlzLnNoYWRvd01hcCA9IHNoYWRvd01hcDsKCQkJX3RoaXMuc3RhdGUgPSBzdGF0ZTsKCQkJX3RoaXMuaW5mbyA9IGluZm87CgoJCX0KCgkJaW5pdEdMQ29udGV4dCgpOwoKCQkvLyB4cgoKCQljb25zdCB4ciA9IG5ldyBXZWJYUk1hbmFnZXIoIF90aGlzLCBfZ2wgKTsKCgkJdGhpcy54ciA9IHhyOwoKCQkvLyBBUEkKCgkJdGhpcy5nZXRDb250ZXh0ID0gZnVuY3Rpb24gKCkgewoKCQkJcmV0dXJuIF9nbDsKCgkJfTsKCgkJdGhpcy5nZXRDb250ZXh0QXR0cmlidXRlcyA9IGZ1bmN0aW9uICgpIHsKCgkJCXJldHVybiBfZ2wuZ2V0Q29udGV4dEF0dHJpYnV0ZXMoKTsKCgkJfTsKCgkJdGhpcy5mb3JjZUNvbnRleHRMb3NzID0gZnVuY3Rpb24gKCkgewoKCQkJY29uc3QgZXh0ZW5zaW9uID0gZXh0ZW5zaW9ucy5nZXQoICdXRUJHTF9sb3NlX2NvbnRleHQnICk7CgkJCWlmICggZXh0ZW5zaW9uICkgZXh0ZW5zaW9uLmxvc2VDb250ZXh0KCk7CgoJCX07CgoJCXRoaXMuZm9yY2VDb250ZXh0UmVzdG9yZSA9IGZ1bmN0aW9uICgpIHsKCgkJCWNvbnN0IGV4dGVuc2lvbiA9IGV4dGVuc2lvbnMuZ2V0KCAnV0VCR0xfbG9zZV9jb250ZXh0JyApOwoJCQlpZiAoIGV4dGVuc2lvbiApIGV4dGVuc2lvbi5yZXN0b3JlQ29udGV4dCgpOwoKCQl9OwoKCQl0aGlzLmdldFBpeGVsUmF0aW8gPSBmdW5jdGlvbiAoKSB7CgoJCQlyZXR1cm4gX3BpeGVsUmF0aW87CgoJCX07CgoJCXRoaXMuc2V0UGl4ZWxSYXRpbyA9IGZ1bmN0aW9uICggdmFsdWUgKSB7CgoJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSByZXR1cm47CgoJCQlfcGl4ZWxSYXRpbyA9IHZhbHVlOwoKCQkJdGhpcy5zZXRTaXplKCBfd2lkdGgsIF9oZWlnaHQsIGZhbHNlICk7CgoJCX07CgoJCXRoaXMuZ2V0U2l6ZSA9IGZ1bmN0aW9uICggdGFyZ2V0ICkgewoKCQkJcmV0dXJuIHRhcmdldC5zZXQoIF93aWR0aCwgX2hlaWdodCApOwoKCQl9OwoKCQl0aGlzLnNldFNpemUgPSBmdW5jdGlvbiAoIHdpZHRoLCBoZWlnaHQsIHVwZGF0ZVN0eWxlID0gdHJ1ZSApIHsKCgkJCWlmICggeHIuaXNQcmVzZW50aW5nICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IENhblwndCBjaGFuZ2Ugc2l6ZSB3aGlsZSBWUiBkZXZpY2UgaXMgcHJlc2VudGluZy4nICk7CgkJCQlyZXR1cm47CgoJCQl9CgoJCQlfd2lkdGggPSB3aWR0aDsKCQkJX2hlaWdodCA9IGhlaWdodDsKCgkJCWNhbnZhcy53aWR0aCA9IE1hdGguZmxvb3IoIHdpZHRoICogX3BpeGVsUmF0aW8gKTsKCQkJY2FudmFzLmhlaWdodCA9IE1hdGguZmxvb3IoIGhlaWdodCAqIF9waXhlbFJhdGlvICk7CgoJCQlpZiAoIHVwZGF0ZVN0eWxlID09PSB0cnVlICkgewoKCQkJCWNhbnZhcy5zdHlsZS53aWR0aCA9IHdpZHRoICsgJ3B4JzsKCQkJCWNhbnZhcy5zdHlsZS5oZWlnaHQgPSBoZWlnaHQgKyAncHgnOwoKCQkJfQoKCQkJdGhpcy5zZXRWaWV3cG9ydCggMCwgMCwgd2lkdGgsIGhlaWdodCApOwoKCQl9OwoKCQl0aGlzLmdldERyYXdpbmdCdWZmZXJTaXplID0gZnVuY3Rpb24gKCB0YXJnZXQgKSB7CgoJCQlyZXR1cm4gdGFyZ2V0LnNldCggX3dpZHRoICogX3BpeGVsUmF0aW8sIF9oZWlnaHQgKiBfcGl4ZWxSYXRpbyApLmZsb29yKCk7CgoJCX07CgoJCXRoaXMuc2V0RHJhd2luZ0J1ZmZlclNpemUgPSBmdW5jdGlvbiAoIHdpZHRoLCBoZWlnaHQsIHBpeGVsUmF0aW8gKSB7CgoJCQlfd2lkdGggPSB3aWR0aDsKCQkJX2hlaWdodCA9IGhlaWdodDsKCgkJCV9waXhlbFJhdGlvID0gcGl4ZWxSYXRpbzsKCgkJCWNhbnZhcy53aWR0aCA9IE1hdGguZmxvb3IoIHdpZHRoICogcGl4ZWxSYXRpbyApOwoJCQljYW52YXMuaGVpZ2h0ID0gTWF0aC5mbG9vciggaGVpZ2h0ICogcGl4ZWxSYXRpbyApOwoKCQkJdGhpcy5zZXRWaWV3cG9ydCggMCwgMCwgd2lkdGgsIGhlaWdodCApOwoKCQl9OwoKCQl0aGlzLmdldEN1cnJlbnRWaWV3cG9ydCA9IGZ1bmN0aW9uICggdGFyZ2V0ICkgewoKCQkJcmV0dXJuIHRhcmdldC5jb3B5KCBfY3VycmVudFZpZXdwb3J0ICk7CgoJCX07CgoJCXRoaXMuZ2V0Vmlld3BvcnQgPSBmdW5jdGlvbiAoIHRhcmdldCApIHsKCgkJCXJldHVybiB0YXJnZXQuY29weSggX3ZpZXdwb3J0ICk7CgoJCX07CgoJCXRoaXMuc2V0Vmlld3BvcnQgPSBmdW5jdGlvbiAoIHgsIHksIHdpZHRoLCBoZWlnaHQgKSB7CgoJCQlpZiAoIHguaXNWZWN0b3I0ICkgewoKCQkJCV92aWV3cG9ydC5zZXQoIHgueCwgeC55LCB4LnosIHgudyApOwoKCQkJfSBlbHNlIHsKCgkJCQlfdmlld3BvcnQuc2V0KCB4LCB5LCB3aWR0aCwgaGVpZ2h0ICk7CgoJCQl9CgoJCQlzdGF0ZS52aWV3cG9ydCggX2N1cnJlbnRWaWV3cG9ydC5jb3B5KCBfdmlld3BvcnQgKS5tdWx0aXBseVNjYWxhciggX3BpeGVsUmF0aW8gKS5mbG9vcigpICk7CgoJCX07CgoJCXRoaXMuZ2V0U2Npc3NvciA9IGZ1bmN0aW9uICggdGFyZ2V0ICkgewoKCQkJcmV0dXJuIHRhcmdldC5jb3B5KCBfc2Npc3NvciApOwoKCQl9OwoKCQl0aGlzLnNldFNjaXNzb3IgPSBmdW5jdGlvbiAoIHgsIHksIHdpZHRoLCBoZWlnaHQgKSB7CgoJCQlpZiAoIHguaXNWZWN0b3I0ICkgewoKCQkJCV9zY2lzc29yLnNldCggeC54LCB4LnksIHgueiwgeC53ICk7CgoJCQl9IGVsc2UgewoKCQkJCV9zY2lzc29yLnNldCggeCwgeSwgd2lkdGgsIGhlaWdodCApOwoKCQkJfQoKCQkJc3RhdGUuc2Npc3NvciggX2N1cnJlbnRTY2lzc29yLmNvcHkoIF9zY2lzc29yICkubXVsdGlwbHlTY2FsYXIoIF9waXhlbFJhdGlvICkuZmxvb3IoKSApOwoKCQl9OwoKCQl0aGlzLmdldFNjaXNzb3JUZXN0ID0gZnVuY3Rpb24gKCkgewoKCQkJcmV0dXJuIF9zY2lzc29yVGVzdDsKCgkJfTsKCgkJdGhpcy5zZXRTY2lzc29yVGVzdCA9IGZ1bmN0aW9uICggYm9vbGVhbiApIHsKCgkJCXN0YXRlLnNldFNjaXNzb3JUZXN0KCBfc2Npc3NvclRlc3QgPSBib29sZWFuICk7CgoJCX07CgoJCXRoaXMuc2V0T3BhcXVlU29ydCA9IGZ1bmN0aW9uICggbWV0aG9kICkgewoKCQkJX29wYXF1ZVNvcnQgPSBtZXRob2Q7CgoJCX07CgoJCXRoaXMuc2V0VHJhbnNwYXJlbnRTb3J0ID0gZnVuY3Rpb24gKCBtZXRob2QgKSB7CgoJCQlfdHJhbnNwYXJlbnRTb3J0ID0gbWV0aG9kOwoKCQl9OwoKCQkvLyBDbGVhcmluZwoKCQl0aGlzLmdldENsZWFyQ29sb3IgPSBmdW5jdGlvbiAoIHRhcmdldCApIHsKCgkJCXJldHVybiB0YXJnZXQuY29weSggYmFja2dyb3VuZC5nZXRDbGVhckNvbG9yKCkgKTsKCgkJfTsKCgkJdGhpcy5zZXRDbGVhckNvbG9yID0gZnVuY3Rpb24gKCkgewoKCQkJYmFja2dyb3VuZC5zZXRDbGVhckNvbG9yLmFwcGx5KCBiYWNrZ3JvdW5kLCBhcmd1bWVudHMgKTsKCgkJfTsKCgkJdGhpcy5nZXRDbGVhckFscGhhID0gZnVuY3Rpb24gKCkgewoKCQkJcmV0dXJuIGJhY2tncm91bmQuZ2V0Q2xlYXJBbHBoYSgpOwoKCQl9OwoKCQl0aGlzLnNldENsZWFyQWxwaGEgPSBmdW5jdGlvbiAoKSB7CgoJCQliYWNrZ3JvdW5kLnNldENsZWFyQWxwaGEuYXBwbHkoIGJhY2tncm91bmQsIGFyZ3VtZW50cyApOwoKCQl9OwoKCQl0aGlzLmNsZWFyID0gZnVuY3Rpb24gKCBjb2xvciA9IHRydWUsIGRlcHRoID0gdHJ1ZSwgc3RlbmNpbCA9IHRydWUgKSB7CgoJCQlsZXQgYml0cyA9IDA7CgoJCQlpZiAoIGNvbG9yICkgewoKCQkJCS8vIGNoZWNrIGlmIHdlJ3JlIHRyeWluZyB0byBjbGVhciBhbiBpbnRlZ2VyIHRhcmdldAoJCQkJbGV0IGlzSW50ZWdlckZvcm1hdCA9IGZhbHNlOwoJCQkJaWYgKCBfY3VycmVudFJlbmRlclRhcmdldCAhPT0gbnVsbCApIHsKCgkJCQkJY29uc3QgdGFyZ2V0Rm9ybWF0ID0gX2N1cnJlbnRSZW5kZXJUYXJnZXQudGV4dHVyZS5mb3JtYXQ7CgkJCQkJaXNJbnRlZ2VyRm9ybWF0ID0gdGFyZ2V0Rm9ybWF0ID09PSBSR0JBSW50ZWdlckZvcm1hdCB8fAoJCQkJCQl0YXJnZXRGb3JtYXQgPT09IFJHSW50ZWdlckZvcm1hdCB8fAoJCQkJCQl0YXJnZXRGb3JtYXQgPT09IFJlZEludGVnZXJGb3JtYXQ7CgoJCQkJfQoKCQkJCS8vIHVzZSB0aGUgYXBwcm9wcmlhdGUgY2xlYXIgZnVuY3Rpb25zIHRvIGNsZWFyIHRoZSB0YXJnZXQgaWYgaXQncyBhIHNpZ25lZAoJCQkJLy8gb3IgdW5zaWduZWQgaW50ZWdlciB0YXJnZXQKCQkJCWlmICggaXNJbnRlZ2VyRm9ybWF0ICkgewoKCQkJCQljb25zdCB0YXJnZXRUeXBlID0gX2N1cnJlbnRSZW5kZXJUYXJnZXQudGV4dHVyZS50eXBlOwoJCQkJCWNvbnN0IGlzVW5zaWduZWRUeXBlID0gdGFyZ2V0VHlwZSA9PT0gVW5zaWduZWRCeXRlVHlwZSB8fAoJCQkJCQl0YXJnZXRUeXBlID09PSBVbnNpZ25lZEludFR5cGUgfHwKCQkJCQkJdGFyZ2V0VHlwZSA9PT0gVW5zaWduZWRTaG9ydFR5cGUgfHwKCQkJCQkJdGFyZ2V0VHlwZSA9PT0gVW5zaWduZWRJbnQyNDhUeXBlIHx8CgkJCQkJCXRhcmdldFR5cGUgPT09IFVuc2lnbmVkU2hvcnQ0NDQ0VHlwZSB8fAoJCQkJCQl0YXJnZXRUeXBlID09PSBVbnNpZ25lZFNob3J0NTU1MVR5cGU7CgoJCQkJCWNvbnN0IGNsZWFyQ29sb3IgPSBiYWNrZ3JvdW5kLmdldENsZWFyQ29sb3IoKTsKCQkJCQljb25zdCBhID0gYmFja2dyb3VuZC5nZXRDbGVhckFscGhhKCk7CgkJCQkJY29uc3QgciA9IGNsZWFyQ29sb3IucjsKCQkJCQljb25zdCBnID0gY2xlYXJDb2xvci5nOwoJCQkJCWNvbnN0IGIgPSBjbGVhckNvbG9yLmI7CgoJCQkJCWlmICggaXNVbnNpZ25lZFR5cGUgKSB7CgoJCQkJCQl1aW50Q2xlYXJDb2xvclsgMCBdID0gcjsKCQkJCQkJdWludENsZWFyQ29sb3JbIDEgXSA9IGc7CgkJCQkJCXVpbnRDbGVhckNvbG9yWyAyIF0gPSBiOwoJCQkJCQl1aW50Q2xlYXJDb2xvclsgMyBdID0gYTsKCQkJCQkJX2dsLmNsZWFyQnVmZmVydWl2KCBfZ2wuQ09MT1IsIDAsIHVpbnRDbGVhckNvbG9yICk7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlpbnRDbGVhckNvbG9yWyAwIF0gPSByOwoJCQkJCQlpbnRDbGVhckNvbG9yWyAxIF0gPSBnOwoJCQkJCQlpbnRDbGVhckNvbG9yWyAyIF0gPSBiOwoJCQkJCQlpbnRDbGVhckNvbG9yWyAzIF0gPSBhOwoJCQkJCQlfZ2wuY2xlYXJCdWZmZXJpdiggX2dsLkNPTE9SLCAwLCBpbnRDbGVhckNvbG9yICk7CgoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQliaXRzIHw9IF9nbC5DT0xPUl9CVUZGRVJfQklUOwoKCQkJCX0KCgkJCX0KCgkJCWlmICggZGVwdGggKSBiaXRzIHw9IF9nbC5ERVBUSF9CVUZGRVJfQklUOwoJCQlpZiAoIHN0ZW5jaWwgKSB7CgoJCQkJYml0cyB8PSBfZ2wuU1RFTkNJTF9CVUZGRVJfQklUOwoJCQkJdGhpcy5zdGF0ZS5idWZmZXJzLnN0ZW5jaWwuc2V0TWFzayggMHhmZmZmZmZmZiApOwoKCQkJfQoKCQkJX2dsLmNsZWFyKCBiaXRzICk7CgoJCX07CgoJCXRoaXMuY2xlYXJDb2xvciA9IGZ1bmN0aW9uICgpIHsKCgkJCXRoaXMuY2xlYXIoIHRydWUsIGZhbHNlLCBmYWxzZSApOwoKCQl9OwoKCQl0aGlzLmNsZWFyRGVwdGggPSBmdW5jdGlvbiAoKSB7CgoJCQl0aGlzLmNsZWFyKCBmYWxzZSwgdHJ1ZSwgZmFsc2UgKTsKCgkJfTsKCgkJdGhpcy5jbGVhclN0ZW5jaWwgPSBmdW5jdGlvbiAoKSB7CgoJCQl0aGlzLmNsZWFyKCBmYWxzZSwgZmFsc2UsIHRydWUgKTsKCgkJfTsKCgkJLy8KCgkJdGhpcy5kaXNwb3NlID0gZnVuY3Rpb24gKCkgewoKCQkJY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoICd3ZWJnbGNvbnRleHRsb3N0Jywgb25Db250ZXh0TG9zdCwgZmFsc2UgKTsKCQkJY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoICd3ZWJnbGNvbnRleHRyZXN0b3JlZCcsIG9uQ29udGV4dFJlc3RvcmUsIGZhbHNlICk7CgkJCWNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCAnd2ViZ2xjb250ZXh0Y3JlYXRpb25lcnJvcicsIG9uQ29udGV4dENyZWF0aW9uRXJyb3IsIGZhbHNlICk7CgoJCQlyZW5kZXJMaXN0cy5kaXNwb3NlKCk7CgkJCXJlbmRlclN0YXRlcy5kaXNwb3NlKCk7CgkJCXByb3BlcnRpZXMuZGlzcG9zZSgpOwoJCQljdWJlbWFwcy5kaXNwb3NlKCk7CgkJCWN1YmV1dm1hcHMuZGlzcG9zZSgpOwoJCQlvYmplY3RzLmRpc3Bvc2UoKTsKCQkJYmluZGluZ1N0YXRlcy5kaXNwb3NlKCk7CgkJCXVuaWZvcm1zR3JvdXBzLmRpc3Bvc2UoKTsKCQkJcHJvZ3JhbUNhY2hlLmRpc3Bvc2UoKTsKCgkJCXhyLmRpc3Bvc2UoKTsKCgkJCXhyLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdzZXNzaW9uc3RhcnQnLCBvblhSU2Vzc2lvblN0YXJ0ICk7CgkJCXhyLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdzZXNzaW9uZW5kJywgb25YUlNlc3Npb25FbmQgKTsKCgkJCWlmICggX3RyYW5zbWlzc2lvblJlbmRlclRhcmdldCApIHsKCgkJCQlfdHJhbnNtaXNzaW9uUmVuZGVyVGFyZ2V0LmRpc3Bvc2UoKTsKCQkJCV90cmFuc21pc3Npb25SZW5kZXJUYXJnZXQgPSBudWxsOwoKCQkJfQoKCQkJYW5pbWF0aW9uLnN0b3AoKTsKCgkJfTsKCgkJLy8gRXZlbnRzCgoJCWZ1bmN0aW9uIG9uQ29udGV4dExvc3QoIGV2ZW50ICkgewoKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCWNvbnNvbGUubG9nKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogQ29udGV4dCBMb3N0LicgKTsKCgkJCV9pc0NvbnRleHRMb3N0ID0gdHJ1ZTsKCgkJfQoKCQlmdW5jdGlvbiBvbkNvbnRleHRSZXN0b3JlKCAvKiBldmVudCAqLyApIHsKCgkJCWNvbnNvbGUubG9nKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogQ29udGV4dCBSZXN0b3JlZC4nICk7CgoJCQlfaXNDb250ZXh0TG9zdCA9IGZhbHNlOwoKCQkJY29uc3QgaW5mb0F1dG9SZXNldCA9IGluZm8uYXV0b1Jlc2V0OwoJCQljb25zdCBzaGFkb3dNYXBFbmFibGVkID0gc2hhZG93TWFwLmVuYWJsZWQ7CgkJCWNvbnN0IHNoYWRvd01hcEF1dG9VcGRhdGUgPSBzaGFkb3dNYXAuYXV0b1VwZGF0ZTsKCQkJY29uc3Qgc2hhZG93TWFwTmVlZHNVcGRhdGUgPSBzaGFkb3dNYXAubmVlZHNVcGRhdGU7CgkJCWNvbnN0IHNoYWRvd01hcFR5cGUgPSBzaGFkb3dNYXAudHlwZTsKCgkJCWluaXRHTENvbnRleHQoKTsKCgkJCWluZm8uYXV0b1Jlc2V0ID0gaW5mb0F1dG9SZXNldDsKCQkJc2hhZG93TWFwLmVuYWJsZWQgPSBzaGFkb3dNYXBFbmFibGVkOwoJCQlzaGFkb3dNYXAuYXV0b1VwZGF0ZSA9IHNoYWRvd01hcEF1dG9VcGRhdGU7CgkJCXNoYWRvd01hcC5uZWVkc1VwZGF0ZSA9IHNoYWRvd01hcE5lZWRzVXBkYXRlOwoJCQlzaGFkb3dNYXAudHlwZSA9IHNoYWRvd01hcFR5cGU7CgoJCX0KCgkJZnVuY3Rpb24gb25Db250ZXh0Q3JlYXRpb25FcnJvciggZXZlbnQgKSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogQSBXZWJHTCBjb250ZXh0IGNvdWxkIG5vdCBiZSBjcmVhdGVkLiBSZWFzb246ICcsIGV2ZW50LnN0YXR1c01lc3NhZ2UgKTsKCgkJfQoKCQlmdW5jdGlvbiBvbk1hdGVyaWFsRGlzcG9zZSggZXZlbnQgKSB7CgoJCQljb25zdCBtYXRlcmlhbCA9IGV2ZW50LnRhcmdldDsKCgkJCW1hdGVyaWFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdkaXNwb3NlJywgb25NYXRlcmlhbERpc3Bvc2UgKTsKCgkJCWRlYWxsb2NhdGVNYXRlcmlhbCggbWF0ZXJpYWwgKTsKCgkJfQoKCQkvLyBCdWZmZXIgZGVhbGxvY2F0aW9uCgoJCWZ1bmN0aW9uIGRlYWxsb2NhdGVNYXRlcmlhbCggbWF0ZXJpYWwgKSB7CgoJCQlyZWxlYXNlTWF0ZXJpYWxQcm9ncmFtUmVmZXJlbmNlcyggbWF0ZXJpYWwgKTsKCgkJCXByb3BlcnRpZXMucmVtb3ZlKCBtYXRlcmlhbCApOwoKCQl9CgoKCQlmdW5jdGlvbiByZWxlYXNlTWF0ZXJpYWxQcm9ncmFtUmVmZXJlbmNlcyggbWF0ZXJpYWwgKSB7CgoJCQljb25zdCBwcm9ncmFtcyA9IHByb3BlcnRpZXMuZ2V0KCBtYXRlcmlhbCApLnByb2dyYW1zOwoKCQkJaWYgKCBwcm9ncmFtcyAhPT0gdW5kZWZpbmVkICkgewoKCQkJCXByb2dyYW1zLmZvckVhY2goIGZ1bmN0aW9uICggcHJvZ3JhbSApIHsKCgkJCQkJcHJvZ3JhbUNhY2hlLnJlbGVhc2VQcm9ncmFtKCBwcm9ncmFtICk7CgoJCQkJfSApOwoKCQkJCWlmICggbWF0ZXJpYWwuaXNTaGFkZXJNYXRlcmlhbCApIHsKCgkJCQkJcHJvZ3JhbUNhY2hlLnJlbGVhc2VTaGFkZXJDYWNoZSggbWF0ZXJpYWwgKTsKCgkJCQl9CgoJCQl9CgoJCX0KCgkJLy8gQnVmZmVyIHJlbmRlcmluZwoKCQl0aGlzLnJlbmRlckJ1ZmZlckRpcmVjdCA9IGZ1bmN0aW9uICggY2FtZXJhLCBzY2VuZSwgZ2VvbWV0cnksIG1hdGVyaWFsLCBvYmplY3QsIGdyb3VwICkgewoKCQkJaWYgKCBzY2VuZSA9PT0gbnVsbCApIHNjZW5lID0gX2VtcHR5U2NlbmU7IC8vIHJlbmRlckJ1ZmZlckRpcmVjdCBzZWNvbmQgcGFyYW1ldGVyIHVzZWQgdG8gYmUgZm9nIChjb3VsZCBiZSBudWxsKQoKCQkJY29uc3QgZnJvbnRGYWNlQ1cgPSAoIG9iamVjdC5pc01lc2ggJiYgb2JqZWN0Lm1hdHJpeFdvcmxkLmRldGVybWluYW50KCkgPCAwICk7CgoJCQljb25zdCBwcm9ncmFtID0gc2V0UHJvZ3JhbSggY2FtZXJhLCBzY2VuZSwgZ2VvbWV0cnksIG1hdGVyaWFsLCBvYmplY3QgKTsKCgkJCXN0YXRlLnNldE1hdGVyaWFsKCBtYXRlcmlhbCwgZnJvbnRGYWNlQ1cgKTsKCgkJCS8vCgoJCQlsZXQgaW5kZXggPSBnZW9tZXRyeS5pbmRleDsKCQkJbGV0IHJhbmdlRmFjdG9yID0gMTsKCgkJCWlmICggbWF0ZXJpYWwud2lyZWZyYW1lID09PSB0cnVlICkgewoKCQkJCWluZGV4ID0gZ2VvbWV0cmllcy5nZXRXaXJlZnJhbWVBdHRyaWJ1dGUoIGdlb21ldHJ5ICk7CgoJCQkJaWYgKCBpbmRleCA9PT0gdW5kZWZpbmVkICkgcmV0dXJuOwoKCQkJCXJhbmdlRmFjdG9yID0gMjsKCgkJCX0KCgkJCS8vCgoJCQljb25zdCBkcmF3UmFuZ2UgPSBnZW9tZXRyeS5kcmF3UmFuZ2U7CgkJCWNvbnN0IHBvc2l0aW9uID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKCgkJCWxldCBkcmF3U3RhcnQgPSBkcmF3UmFuZ2Uuc3RhcnQgKiByYW5nZUZhY3RvcjsKCQkJbGV0IGRyYXdFbmQgPSAoIGRyYXdSYW5nZS5zdGFydCArIGRyYXdSYW5nZS5jb3VudCApICogcmFuZ2VGYWN0b3I7CgoJCQlpZiAoIGdyb3VwICE9PSBudWxsICkgewoKCQkJCWRyYXdTdGFydCA9IE1hdGgubWF4KCBkcmF3U3RhcnQsIGdyb3VwLnN0YXJ0ICogcmFuZ2VGYWN0b3IgKTsKCQkJCWRyYXdFbmQgPSBNYXRoLm1pbiggZHJhd0VuZCwgKCBncm91cC5zdGFydCArIGdyb3VwLmNvdW50ICkgKiByYW5nZUZhY3RvciApOwoKCQkJfQoKCQkJaWYgKCBpbmRleCAhPT0gbnVsbCApIHsKCgkJCQlkcmF3U3RhcnQgPSBNYXRoLm1heCggZHJhd1N0YXJ0LCAwICk7CgkJCQlkcmF3RW5kID0gTWF0aC5taW4oIGRyYXdFbmQsIGluZGV4LmNvdW50ICk7CgoJCQl9IGVsc2UgaWYgKCBwb3NpdGlvbiAhPT0gdW5kZWZpbmVkICYmIHBvc2l0aW9uICE9PSBudWxsICkgewoKCQkJCWRyYXdTdGFydCA9IE1hdGgubWF4KCBkcmF3U3RhcnQsIDAgKTsKCQkJCWRyYXdFbmQgPSBNYXRoLm1pbiggZHJhd0VuZCwgcG9zaXRpb24uY291bnQgKTsKCgkJCX0KCgkJCWNvbnN0IGRyYXdDb3VudCA9IGRyYXdFbmQgLSBkcmF3U3RhcnQ7CgoJCQlpZiAoIGRyYXdDb3VudCA8IDAgfHwgZHJhd0NvdW50ID09PSBJbmZpbml0eSApIHJldHVybjsKCgkJCS8vCgoJCQliaW5kaW5nU3RhdGVzLnNldHVwKCBvYmplY3QsIG1hdGVyaWFsLCBwcm9ncmFtLCBnZW9tZXRyeSwgaW5kZXggKTsKCgkJCWxldCBhdHRyaWJ1dGU7CgkJCWxldCByZW5kZXJlciA9IGJ1ZmZlclJlbmRlcmVyOwoKCQkJaWYgKCBpbmRleCAhPT0gbnVsbCApIHsKCgkJCQlhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzLmdldCggaW5kZXggKTsKCgkJCQlyZW5kZXJlciA9IGluZGV4ZWRCdWZmZXJSZW5kZXJlcjsKCQkJCXJlbmRlcmVyLnNldEluZGV4KCBhdHRyaWJ1dGUgKTsKCgkJCX0KCgkJCS8vCgoJCQlpZiAoIG9iamVjdC5pc01lc2ggKSB7CgoJCQkJaWYgKCBtYXRlcmlhbC53aXJlZnJhbWUgPT09IHRydWUgKSB7CgoJCQkJCXN0YXRlLnNldExpbmVXaWR0aCggbWF0ZXJpYWwud2lyZWZyYW1lTGluZXdpZHRoICogZ2V0VGFyZ2V0UGl4ZWxSYXRpbygpICk7CgkJCQkJcmVuZGVyZXIuc2V0TW9kZSggX2dsLkxJTkVTICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJcmVuZGVyZXIuc2V0TW9kZSggX2dsLlRSSUFOR0xFUyApOwoKCQkJCX0KCgkJCX0gZWxzZSBpZiAoIG9iamVjdC5pc0xpbmUgKSB7CgoJCQkJbGV0IGxpbmVXaWR0aCA9IG1hdGVyaWFsLmxpbmV3aWR0aDsKCgkJCQlpZiAoIGxpbmVXaWR0aCA9PT0gdW5kZWZpbmVkICkgbGluZVdpZHRoID0gMTsgLy8gTm90IHVzaW5nIExpbmUqTWF0ZXJpYWwKCgkJCQlzdGF0ZS5zZXRMaW5lV2lkdGgoIGxpbmVXaWR0aCAqIGdldFRhcmdldFBpeGVsUmF0aW8oKSApOwoKCQkJCWlmICggb2JqZWN0LmlzTGluZVNlZ21lbnRzICkgewoKCQkJCQlyZW5kZXJlci5zZXRNb2RlKCBfZ2wuTElORVMgKTsKCgkJCQl9IGVsc2UgaWYgKCBvYmplY3QuaXNMaW5lTG9vcCApIHsKCgkJCQkJcmVuZGVyZXIuc2V0TW9kZSggX2dsLkxJTkVfTE9PUCApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXJlbmRlcmVyLnNldE1vZGUoIF9nbC5MSU5FX1NUUklQICk7CgoJCQkJfQoKCQkJfSBlbHNlIGlmICggb2JqZWN0LmlzUG9pbnRzICkgewoKCQkJCXJlbmRlcmVyLnNldE1vZGUoIF9nbC5QT0lOVFMgKTsKCgkJCX0gZWxzZSBpZiAoIG9iamVjdC5pc1Nwcml0ZSApIHsKCgkJCQlyZW5kZXJlci5zZXRNb2RlKCBfZ2wuVFJJQU5HTEVTICk7CgoJCQl9CgoJCQlpZiAoIG9iamVjdC5pc0JhdGNoZWRNZXNoICkgewoKCQkJCXJlbmRlcmVyLnJlbmRlck11bHRpRHJhdyggb2JqZWN0Ll9tdWx0aURyYXdTdGFydHMsIG9iamVjdC5fbXVsdGlEcmF3Q291bnRzLCBvYmplY3QuX211bHRpRHJhd0NvdW50ICk7CgoJCQl9IGVsc2UgaWYgKCBvYmplY3QuaXNJbnN0YW5jZWRNZXNoICkgewoKCQkJCXJlbmRlcmVyLnJlbmRlckluc3RhbmNlcyggZHJhd1N0YXJ0LCBkcmF3Q291bnQsIG9iamVjdC5jb3VudCApOwoKCQkJfSBlbHNlIGlmICggZ2VvbWV0cnkuaXNJbnN0YW5jZWRCdWZmZXJHZW9tZXRyeSApIHsKCgkJCQljb25zdCBtYXhJbnN0YW5jZUNvdW50ID0gZ2VvbWV0cnkuX21heEluc3RhbmNlQ291bnQgIT09IHVuZGVmaW5lZCA/IGdlb21ldHJ5Ll9tYXhJbnN0YW5jZUNvdW50IDogSW5maW5pdHk7CgkJCQljb25zdCBpbnN0YW5jZUNvdW50ID0gTWF0aC5taW4oIGdlb21ldHJ5Lmluc3RhbmNlQ291bnQsIG1heEluc3RhbmNlQ291bnQgKTsKCgkJCQlyZW5kZXJlci5yZW5kZXJJbnN0YW5jZXMoIGRyYXdTdGFydCwgZHJhd0NvdW50LCBpbnN0YW5jZUNvdW50ICk7CgoJCQl9IGVsc2UgewoKCQkJCXJlbmRlcmVyLnJlbmRlciggZHJhd1N0YXJ0LCBkcmF3Q291bnQgKTsKCgkJCX0KCgkJfTsKCgkJLy8gQ29tcGlsZQoKCQlmdW5jdGlvbiBwcmVwYXJlTWF0ZXJpYWwoIG1hdGVyaWFsLCBzY2VuZSwgb2JqZWN0ICkgewoKCQkJaWYgKCBtYXRlcmlhbC50cmFuc3BhcmVudCA9PT0gdHJ1ZSAmJiBtYXRlcmlhbC5zaWRlID09PSBEb3VibGVTaWRlICYmIG1hdGVyaWFsLmZvcmNlU2luZ2xlUGFzcyA9PT0gZmFsc2UgKSB7CgoJCQkJbWF0ZXJpYWwuc2lkZSA9IEJhY2tTaWRlOwoJCQkJbWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwoJCQkJZ2V0UHJvZ3JhbSggbWF0ZXJpYWwsIHNjZW5lLCBvYmplY3QgKTsKCgkJCQltYXRlcmlhbC5zaWRlID0gRnJvbnRTaWRlOwoJCQkJbWF0ZXJpYWwubmVlZHNVcGRhdGUgPSB0cnVlOwoJCQkJZ2V0UHJvZ3JhbSggbWF0ZXJpYWwsIHNjZW5lLCBvYmplY3QgKTsKCgkJCQltYXRlcmlhbC5zaWRlID0gRG91YmxlU2lkZTsKCgkJCX0gZWxzZSB7CgoJCQkJZ2V0UHJvZ3JhbSggbWF0ZXJpYWwsIHNjZW5lLCBvYmplY3QgKTsKCgkJCX0KCgkJfQoKCQl0aGlzLmNvbXBpbGUgPSBmdW5jdGlvbiAoIHNjZW5lLCBjYW1lcmEsIHRhcmdldFNjZW5lID0gbnVsbCApIHsKCgkJCWlmICggdGFyZ2V0U2NlbmUgPT09IG51bGwgKSB0YXJnZXRTY2VuZSA9IHNjZW5lOwoKCQkJY3VycmVudFJlbmRlclN0YXRlID0gcmVuZGVyU3RhdGVzLmdldCggdGFyZ2V0U2NlbmUgKTsKCQkJY3VycmVudFJlbmRlclN0YXRlLmluaXQoKTsKCgkJCXJlbmRlclN0YXRlU3RhY2sucHVzaCggY3VycmVudFJlbmRlclN0YXRlICk7CgoJCQkvLyBnYXRoZXIgbGlnaHRzIGZyb20gYm90aCB0aGUgdGFyZ2V0IHNjZW5lIGFuZCB0aGUgbmV3IG9iamVjdCB0aGF0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIHNjZW5lLgoKCQkJdGFyZ2V0U2NlbmUudHJhdmVyc2VWaXNpYmxlKCBmdW5jdGlvbiAoIG9iamVjdCApIHsKCgkJCQlpZiAoIG9iamVjdC5pc0xpZ2h0ICYmIG9iamVjdC5sYXllcnMudGVzdCggY2FtZXJhLmxheWVycyApICkgewoKCQkJCQljdXJyZW50UmVuZGVyU3RhdGUucHVzaExpZ2h0KCBvYmplY3QgKTsKCgkJCQkJaWYgKCBvYmplY3QuY2FzdFNoYWRvdyApIHsKCgkJCQkJCWN1cnJlbnRSZW5kZXJTdGF0ZS5wdXNoU2hhZG93KCBvYmplY3QgKTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0gKTsKCgkJCWlmICggc2NlbmUgIT09IHRhcmdldFNjZW5lICkgewoKCQkJCXNjZW5lLnRyYXZlcnNlVmlzaWJsZSggZnVuY3Rpb24gKCBvYmplY3QgKSB7CgoJCQkJCWlmICggb2JqZWN0LmlzTGlnaHQgJiYgb2JqZWN0LmxheWVycy50ZXN0KCBjYW1lcmEubGF5ZXJzICkgKSB7CgoJCQkJCQljdXJyZW50UmVuZGVyU3RhdGUucHVzaExpZ2h0KCBvYmplY3QgKTsKCgkJCQkJCWlmICggb2JqZWN0LmNhc3RTaGFkb3cgKSB7CgoJCQkJCQkJY3VycmVudFJlbmRlclN0YXRlLnB1c2hTaGFkb3coIG9iamVjdCApOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJfSApOwoKCQkJfQoKCQkJY3VycmVudFJlbmRlclN0YXRlLnNldHVwTGlnaHRzKCBfdGhpcy5fdXNlTGVnYWN5TGlnaHRzICk7CgoJCQkvLyBPbmx5IGluaXRpYWxpemUgbWF0ZXJpYWxzIGluIHRoZSBuZXcgc2NlbmUsIG5vdCB0aGUgdGFyZ2V0U2NlbmUuCgoJCQljb25zdCBtYXRlcmlhbHMgPSBuZXcgU2V0KCk7CgoJCQlzY2VuZS50cmF2ZXJzZSggZnVuY3Rpb24gKCBvYmplY3QgKSB7CgoJCQkJY29uc3QgbWF0ZXJpYWwgPSBvYmplY3QubWF0ZXJpYWw7CgoJCQkJaWYgKCBtYXRlcmlhbCApIHsKCgkJCQkJaWYgKCBBcnJheS5pc0FycmF5KCBtYXRlcmlhbCApICkgewoKCQkJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgbWF0ZXJpYWwubGVuZ3RoOyBpICsrICkgewoKCQkJCQkJCWNvbnN0IG1hdGVyaWFsMiA9IG1hdGVyaWFsWyBpIF07CgoJCQkJCQkJcHJlcGFyZU1hdGVyaWFsKCBtYXRlcmlhbDIsIHRhcmdldFNjZW5lLCBvYmplY3QgKTsKCQkJCQkJCW1hdGVyaWFscy5hZGQoIG1hdGVyaWFsMiApOwoKCQkJCQkJfQoKCQkJCQl9IGVsc2UgewoKCQkJCQkJcHJlcGFyZU1hdGVyaWFsKCBtYXRlcmlhbCwgdGFyZ2V0U2NlbmUsIG9iamVjdCApOwoJCQkJCQltYXRlcmlhbHMuYWRkKCBtYXRlcmlhbCApOwoKCQkJCQl9CgoJCQkJfQoKCQkJfSApOwoKCQkJcmVuZGVyU3RhdGVTdGFjay5wb3AoKTsKCQkJY3VycmVudFJlbmRlclN0YXRlID0gbnVsbDsKCgkJCXJldHVybiBtYXRlcmlhbHM7CgoJCX07CgoJCS8vIGNvbXBpbGVBc3luYwoKCQl0aGlzLmNvbXBpbGVBc3luYyA9IGZ1bmN0aW9uICggc2NlbmUsIGNhbWVyYSwgdGFyZ2V0U2NlbmUgPSBudWxsICkgewoKCQkJY29uc3QgbWF0ZXJpYWxzID0gdGhpcy5jb21waWxlKCBzY2VuZSwgY2FtZXJhLCB0YXJnZXRTY2VuZSApOwoKCQkJLy8gV2FpdCBmb3IgYWxsIHRoZSBtYXRlcmlhbHMgaW4gdGhlIG5ldyBvYmplY3QgdG8gaW5kaWNhdGUgdGhhdCB0aGV5J3JlCgkJCS8vIHJlYWR5IHRvIGJlIHVzZWQgYmVmb3JlIHJlc29sdmluZyB0aGUgcHJvbWlzZS4KCgkJCXJldHVybiBuZXcgUHJvbWlzZSggKCByZXNvbHZlICkgPT4gewoKCQkJCWZ1bmN0aW9uIGNoZWNrTWF0ZXJpYWxzUmVhZHkoKSB7CgoJCQkJCW1hdGVyaWFscy5mb3JFYWNoKCBmdW5jdGlvbiAoIG1hdGVyaWFsICkgewoKCQkJCQkJY29uc3QgbWF0ZXJpYWxQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIG1hdGVyaWFsICk7CgkJCQkJCWNvbnN0IHByb2dyYW0gPSBtYXRlcmlhbFByb3BlcnRpZXMuY3VycmVudFByb2dyYW07CgoJCQkJCQlpZiAoIHByb2dyYW0uaXNSZWFkeSgpICkgewoKCQkJCQkJCS8vIHJlbW92ZSBhbnkgcHJvZ3JhbXMgdGhhdCByZXBvcnQgdGhleSdyZSByZWFkeSB0byB1c2UgZnJvbSB0aGUgbGlzdAoJCQkJCQkJbWF0ZXJpYWxzLmRlbGV0ZSggbWF0ZXJpYWwgKTsKCgkJCQkJCX0KCgkJCQkJfSApOwoKCQkJCQkvLyBvbmNlIHRoZSBsaXN0IG9mIGNvbXBpbGluZyBtYXRlcmlhbHMgaXMgZW1wdHksIGNhbGwgdGhlIGNhbGxiYWNrCgoJCQkJCWlmICggbWF0ZXJpYWxzLnNpemUgPT09IDAgKSB7CgoJCQkJCQlyZXNvbHZlKCBzY2VuZSApOwoJCQkJCQlyZXR1cm47CgoJCQkJCX0KCgkJCQkJLy8gaWYgc29tZSBtYXRlcmlhbHMgYXJlIHN0aWxsIG5vdCByZWFkeSwgd2FpdCBhIGJpdCBhbmQgY2hlY2sgYWdhaW4KCgkJCQkJc2V0VGltZW91dCggY2hlY2tNYXRlcmlhbHNSZWFkeSwgMTAgKTsKCgkJCQl9CgoJCQkJaWYgKCBleHRlbnNpb25zLmdldCggJ0tIUl9wYXJhbGxlbF9zaGFkZXJfY29tcGlsZScgKSAhPT0gbnVsbCApIHsKCgkJCQkJLy8gSWYgd2UgY2FuIGNoZWNrIHRoZSBjb21waWxhdGlvbiBzdGF0dXMgb2YgdGhlIG1hdGVyaWFscyB3aXRob3V0CgkJCQkJLy8gYmxvY2tpbmcgdGhlbiBkbyBzbyByaWdodCBhd2F5LgoKCQkJCQljaGVja01hdGVyaWFsc1JlYWR5KCk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJLy8gT3RoZXJ3aXNlIHN0YXJ0IGJ5IHdhaXRpbmcgYSBiaXQgdG8gZ2l2ZSB0aGUgbWF0ZXJpYWxzIHdlIGp1c3QKCQkJCQkvLyBpbml0aWFsaXplZCBhIGNoYW5jZSB0byBmaW5pc2guCgoJCQkJCXNldFRpbWVvdXQoIGNoZWNrTWF0ZXJpYWxzUmVhZHksIDEwICk7CgoJCQkJfQoKCQkJfSApOwoKCQl9OwoKCQkvLyBBbmltYXRpb24gTG9vcAoKCQlsZXQgb25BbmltYXRpb25GcmFtZUNhbGxiYWNrID0gbnVsbDsKCgkJZnVuY3Rpb24gb25BbmltYXRpb25GcmFtZSggdGltZSApIHsKCgkJCWlmICggb25BbmltYXRpb25GcmFtZUNhbGxiYWNrICkgb25BbmltYXRpb25GcmFtZUNhbGxiYWNrKCB0aW1lICk7CgoJCX0KCgkJZnVuY3Rpb24gb25YUlNlc3Npb25TdGFydCgpIHsKCgkJCWFuaW1hdGlvbi5zdG9wKCk7CgoJCX0KCgkJZnVuY3Rpb24gb25YUlNlc3Npb25FbmQoKSB7CgoJCQlhbmltYXRpb24uc3RhcnQoKTsKCgkJfQoKCQljb25zdCBhbmltYXRpb24gPSBuZXcgV2ViR0xBbmltYXRpb24oKTsKCQlhbmltYXRpb24uc2V0QW5pbWF0aW9uTG9vcCggb25BbmltYXRpb25GcmFtZSApOwoKCQlpZiAoIHR5cGVvZiBzZWxmICE9PSAndW5kZWZpbmVkJyApIGFuaW1hdGlvbi5zZXRDb250ZXh0KCBzZWxmICk7CgoJCXRoaXMuc2V0QW5pbWF0aW9uTG9vcCA9IGZ1bmN0aW9uICggY2FsbGJhY2sgKSB7CgoJCQlvbkFuaW1hdGlvbkZyYW1lQ2FsbGJhY2sgPSBjYWxsYmFjazsKCQkJeHIuc2V0QW5pbWF0aW9uTG9vcCggY2FsbGJhY2sgKTsKCgkJCSggY2FsbGJhY2sgPT09IG51bGwgKSA/IGFuaW1hdGlvbi5zdG9wKCkgOiBhbmltYXRpb24uc3RhcnQoKTsKCgkJfTsKCgkJeHIuYWRkRXZlbnRMaXN0ZW5lciggJ3Nlc3Npb25zdGFydCcsIG9uWFJTZXNzaW9uU3RhcnQgKTsKCQl4ci5hZGRFdmVudExpc3RlbmVyKCAnc2Vzc2lvbmVuZCcsIG9uWFJTZXNzaW9uRW5kICk7CgoJCS8vIFJlbmRlcmluZwoKCQl0aGlzLnJlbmRlciA9IGZ1bmN0aW9uICggc2NlbmUsIGNhbWVyYSApIHsKCgkJCWlmICggY2FtZXJhICE9PSB1bmRlZmluZWQgJiYgY2FtZXJhLmlzQ2FtZXJhICE9PSB0cnVlICkgewoKCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFJlbmRlcmVyLnJlbmRlcjogY2FtZXJhIGlzIG5vdCBhbiBpbnN0YW5jZSBvZiBUSFJFRS5DYW1lcmEuJyApOwoJCQkJcmV0dXJuOwoKCQkJfQoKCQkJaWYgKCBfaXNDb250ZXh0TG9zdCA9PT0gdHJ1ZSApIHJldHVybjsKCgkJCS8vIHVwZGF0ZSBzY2VuZSBncmFwaAoKCQkJaWYgKCBzY2VuZS5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPT09IHRydWUgKSBzY2VuZS51cGRhdGVNYXRyaXhXb3JsZCgpOwoKCQkJLy8gdXBkYXRlIGNhbWVyYSBtYXRyaWNlcyBhbmQgZnJ1c3R1bQoKCQkJaWYgKCBjYW1lcmEucGFyZW50ID09PSBudWxsICYmIGNhbWVyYS5tYXRyaXhXb3JsZEF1dG9VcGRhdGUgPT09IHRydWUgKSBjYW1lcmEudXBkYXRlTWF0cml4V29ybGQoKTsKCgkJCWlmICggeHIuZW5hYmxlZCA9PT0gdHJ1ZSAmJiB4ci5pc1ByZXNlbnRpbmcgPT09IHRydWUgKSB7CgoJCQkJaWYgKCB4ci5jYW1lcmFBdXRvVXBkYXRlID09PSB0cnVlICkgeHIudXBkYXRlQ2FtZXJhKCBjYW1lcmEgKTsKCgkJCQljYW1lcmEgPSB4ci5nZXRDYW1lcmEoKTsgLy8gdXNlIFhSIGNhbWVyYSBmb3IgcmVuZGVyaW5nCgoJCQl9CgoJCQkvLwoJCQlpZiAoIHNjZW5lLmlzU2NlbmUgPT09IHRydWUgKSBzY2VuZS5vbkJlZm9yZVJlbmRlciggX3RoaXMsIHNjZW5lLCBjYW1lcmEsIF9jdXJyZW50UmVuZGVyVGFyZ2V0ICk7CgoJCQljdXJyZW50UmVuZGVyU3RhdGUgPSByZW5kZXJTdGF0ZXMuZ2V0KCBzY2VuZSwgcmVuZGVyU3RhdGVTdGFjay5sZW5ndGggKTsKCQkJY3VycmVudFJlbmRlclN0YXRlLmluaXQoKTsKCgkJCXJlbmRlclN0YXRlU3RhY2sucHVzaCggY3VycmVudFJlbmRlclN0YXRlICk7CgoJCQlfcHJvalNjcmVlbk1hdHJpeC5tdWx0aXBseU1hdHJpY2VzKCBjYW1lcmEucHJvamVjdGlvbk1hdHJpeCwgY2FtZXJhLm1hdHJpeFdvcmxkSW52ZXJzZSApOwoJCQlfZnJ1c3R1bS5zZXRGcm9tUHJvamVjdGlvbk1hdHJpeCggX3Byb2pTY3JlZW5NYXRyaXggKTsKCgkJCV9sb2NhbENsaXBwaW5nRW5hYmxlZCA9IHRoaXMubG9jYWxDbGlwcGluZ0VuYWJsZWQ7CgkJCV9jbGlwcGluZ0VuYWJsZWQgPSBjbGlwcGluZy5pbml0KCB0aGlzLmNsaXBwaW5nUGxhbmVzLCBfbG9jYWxDbGlwcGluZ0VuYWJsZWQgKTsKCgkJCWN1cnJlbnRSZW5kZXJMaXN0ID0gcmVuZGVyTGlzdHMuZ2V0KCBzY2VuZSwgcmVuZGVyTGlzdFN0YWNrLmxlbmd0aCApOwoJCQljdXJyZW50UmVuZGVyTGlzdC5pbml0KCk7CgoJCQlyZW5kZXJMaXN0U3RhY2sucHVzaCggY3VycmVudFJlbmRlckxpc3QgKTsKCgkJCXByb2plY3RPYmplY3QoIHNjZW5lLCBjYW1lcmEsIDAsIF90aGlzLnNvcnRPYmplY3RzICk7CgoJCQljdXJyZW50UmVuZGVyTGlzdC5maW5pc2goKTsKCgkJCWlmICggX3RoaXMuc29ydE9iamVjdHMgPT09IHRydWUgKSB7CgoJCQkJY3VycmVudFJlbmRlckxpc3Quc29ydCggX29wYXF1ZVNvcnQsIF90cmFuc3BhcmVudFNvcnQgKTsKCgkJCX0KCgkJCS8vCgoJCQl0aGlzLmluZm8ucmVuZGVyLmZyYW1lICsrOwoKCQkJaWYgKCBfY2xpcHBpbmdFbmFibGVkID09PSB0cnVlICkgY2xpcHBpbmcuYmVnaW5TaGFkb3dzKCk7CgoJCQljb25zdCBzaGFkb3dzQXJyYXkgPSBjdXJyZW50UmVuZGVyU3RhdGUuc3RhdGUuc2hhZG93c0FycmF5OwoKCQkJc2hhZG93TWFwLnJlbmRlciggc2hhZG93c0FycmF5LCBzY2VuZSwgY2FtZXJhICk7CgoJCQlpZiAoIF9jbGlwcGluZ0VuYWJsZWQgPT09IHRydWUgKSBjbGlwcGluZy5lbmRTaGFkb3dzKCk7CgoJCQkvLwoKCQkJaWYgKCB0aGlzLmluZm8uYXV0b1Jlc2V0ID09PSB0cnVlICkgdGhpcy5pbmZvLnJlc2V0KCk7CgoKCQkJLy8KCgkJCWlmICggeHIuZW5hYmxlZCA9PT0gZmFsc2UgfHwgeHIuaXNQcmVzZW50aW5nID09PSBmYWxzZSB8fCB4ci5oYXNEZXB0aFNlbnNpbmcoKSA9PT0gZmFsc2UgKSB7CgoJCQkJYmFja2dyb3VuZC5yZW5kZXIoIGN1cnJlbnRSZW5kZXJMaXN0LCBzY2VuZSApOwoKCQkJfQoKCQkJLy8gcmVuZGVyIHNjZW5lCgoJCQljdXJyZW50UmVuZGVyU3RhdGUuc2V0dXBMaWdodHMoIF90aGlzLl91c2VMZWdhY3lMaWdodHMgKTsKCgkJCWlmICggY2FtZXJhLmlzQXJyYXlDYW1lcmEgKSB7CgoJCQkJY29uc3QgY2FtZXJhcyA9IGNhbWVyYS5jYW1lcmFzOwoKCQkJCWZvciAoIGxldCBpID0gMCwgbCA9IGNhbWVyYXMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQkJY29uc3QgY2FtZXJhMiA9IGNhbWVyYXNbIGkgXTsKCgkJCQkJcmVuZGVyU2NlbmUoIGN1cnJlbnRSZW5kZXJMaXN0LCBzY2VuZSwgY2FtZXJhMiwgY2FtZXJhMi52aWV3cG9ydCApOwoKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJcmVuZGVyU2NlbmUoIGN1cnJlbnRSZW5kZXJMaXN0LCBzY2VuZSwgY2FtZXJhICk7CgoJCQl9CgoJCQkvLwoKCQkJaWYgKCBfY3VycmVudFJlbmRlclRhcmdldCAhPT0gbnVsbCApIHsKCgkJCQkvLyByZXNvbHZlIG11bHRpc2FtcGxlIHJlbmRlcmJ1ZmZlcnMgdG8gYSBzaW5nbGUtc2FtcGxlIHRleHR1cmUgaWYgbmVjZXNzYXJ5CgoJCQkJdGV4dHVyZXMudXBkYXRlTXVsdGlzYW1wbGVSZW5kZXJUYXJnZXQoIF9jdXJyZW50UmVuZGVyVGFyZ2V0ICk7CgoJCQkJLy8gR2VuZXJhdGUgbWlwbWFwIGlmIHdlJ3JlIHVzaW5nIGFueSBraW5kIG9mIG1pcG1hcCBmaWx0ZXJpbmcKCgkJCQl0ZXh0dXJlcy51cGRhdGVSZW5kZXJUYXJnZXRNaXBtYXAoIF9jdXJyZW50UmVuZGVyVGFyZ2V0ICk7CgoJCQl9CgoJCQkvLwoKCQkJaWYgKCBzY2VuZS5pc1NjZW5lID09PSB0cnVlICkgc2NlbmUub25BZnRlclJlbmRlciggX3RoaXMsIHNjZW5lLCBjYW1lcmEgKTsKCgkJCS8vIF9nbC5maW5pc2goKTsKCgkJCWJpbmRpbmdTdGF0ZXMucmVzZXREZWZhdWx0U3RhdGUoKTsKCQkJX2N1cnJlbnRNYXRlcmlhbElkID0gLSAxOwoJCQlfY3VycmVudENhbWVyYSA9IG51bGw7CgoJCQlyZW5kZXJTdGF0ZVN0YWNrLnBvcCgpOwoKCQkJaWYgKCByZW5kZXJTdGF0ZVN0YWNrLmxlbmd0aCA+IDAgKSB7CgoJCQkJY3VycmVudFJlbmRlclN0YXRlID0gcmVuZGVyU3RhdGVTdGFja1sgcmVuZGVyU3RhdGVTdGFjay5sZW5ndGggLSAxIF07CgoJCQl9IGVsc2UgewoKCQkJCWN1cnJlbnRSZW5kZXJTdGF0ZSA9IG51bGw7CgoJCQl9CgoJCQlyZW5kZXJMaXN0U3RhY2sucG9wKCk7CgoJCQlpZiAoIHJlbmRlckxpc3RTdGFjay5sZW5ndGggPiAwICkgewoKCQkJCWN1cnJlbnRSZW5kZXJMaXN0ID0gcmVuZGVyTGlzdFN0YWNrWyByZW5kZXJMaXN0U3RhY2subGVuZ3RoIC0gMSBdOwoKCQkJfSBlbHNlIHsKCgkJCQljdXJyZW50UmVuZGVyTGlzdCA9IG51bGw7CgoJCQl9CgoJCX07CgoJCWZ1bmN0aW9uIHByb2plY3RPYmplY3QoIG9iamVjdCwgY2FtZXJhLCBncm91cE9yZGVyLCBzb3J0T2JqZWN0cyApIHsKCgkJCWlmICggb2JqZWN0LnZpc2libGUgPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJY29uc3QgdmlzaWJsZSA9IG9iamVjdC5sYXllcnMudGVzdCggY2FtZXJhLmxheWVycyApOwoKCQkJaWYgKCB2aXNpYmxlICkgewoKCQkJCWlmICggb2JqZWN0LmlzR3JvdXAgKSB7CgoJCQkJCWdyb3VwT3JkZXIgPSBvYmplY3QucmVuZGVyT3JkZXI7CgoJCQkJfSBlbHNlIGlmICggb2JqZWN0LmlzTE9EICkgewoKCQkJCQlpZiAoIG9iamVjdC5hdXRvVXBkYXRlID09PSB0cnVlICkgb2JqZWN0LnVwZGF0ZSggY2FtZXJhICk7CgoJCQkJfSBlbHNlIGlmICggb2JqZWN0LmlzTGlnaHQgKSB7CgoJCQkJCWN1cnJlbnRSZW5kZXJTdGF0ZS5wdXNoTGlnaHQoIG9iamVjdCApOwoKCQkJCQlpZiAoIG9iamVjdC5jYXN0U2hhZG93ICkgewoKCQkJCQkJY3VycmVudFJlbmRlclN0YXRlLnB1c2hTaGFkb3coIG9iamVjdCApOwoKCQkJCQl9CgoJCQkJfSBlbHNlIGlmICggb2JqZWN0LmlzU3ByaXRlICkgewoKCQkJCQlpZiAoICEgb2JqZWN0LmZydXN0dW1DdWxsZWQgfHwgX2ZydXN0dW0uaW50ZXJzZWN0c1Nwcml0ZSggb2JqZWN0ICkgKSB7CgoJCQkJCQlpZiAoIHNvcnRPYmplY3RzICkgewoKCQkJCQkJCV92ZWN0b3IzLnNldEZyb21NYXRyaXhQb3NpdGlvbiggb2JqZWN0Lm1hdHJpeFdvcmxkICkKCQkJCQkJCQkuYXBwbHlNYXRyaXg0KCBfcHJvalNjcmVlbk1hdHJpeCApOwoKCQkJCQkJfQoKCQkJCQkJY29uc3QgZ2VvbWV0cnkgPSBvYmplY3RzLnVwZGF0ZSggb2JqZWN0ICk7CgkJCQkJCWNvbnN0IG1hdGVyaWFsID0gb2JqZWN0Lm1hdGVyaWFsOwoKCQkJCQkJaWYgKCBtYXRlcmlhbC52aXNpYmxlICkgewoKCQkJCQkJCWN1cnJlbnRSZW5kZXJMaXN0LnB1c2goIG9iamVjdCwgZ2VvbWV0cnksIG1hdGVyaWFsLCBncm91cE9yZGVyLCBfdmVjdG9yMy56LCBudWxsICk7CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQl9IGVsc2UgaWYgKCBvYmplY3QuaXNNZXNoIHx8IG9iamVjdC5pc0xpbmUgfHwgb2JqZWN0LmlzUG9pbnRzICkgewoKCQkJCQlpZiAoICEgb2JqZWN0LmZydXN0dW1DdWxsZWQgfHwgX2ZydXN0dW0uaW50ZXJzZWN0c09iamVjdCggb2JqZWN0ICkgKSB7CgoJCQkJCQljb25zdCBnZW9tZXRyeSA9IG9iamVjdHMudXBkYXRlKCBvYmplY3QgKTsKCQkJCQkJY29uc3QgbWF0ZXJpYWwgPSBvYmplY3QubWF0ZXJpYWw7CgoJCQkJCQlpZiAoIHNvcnRPYmplY3RzICkgewoKCQkJCQkJCWlmICggb2JqZWN0LmJvdW5kaW5nU3BoZXJlICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJCQkJCWlmICggb2JqZWN0LmJvdW5kaW5nU3BoZXJlID09PSBudWxsICkgb2JqZWN0LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwoJCQkJCQkJCV92ZWN0b3IzLmNvcHkoIG9iamVjdC5ib3VuZGluZ1NwaGVyZS5jZW50ZXIgKTsKCgkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQlpZiAoIGdlb21ldHJ5LmJvdW5kaW5nU3BoZXJlID09PSBudWxsICkgZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CgkJCQkJCQkJX3ZlY3RvcjMuY29weSggZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUuY2VudGVyICk7CgoJCQkJCQkJfQoKCQkJCQkJCV92ZWN0b3IzCgkJCQkJCQkJLmFwcGx5TWF0cml4NCggb2JqZWN0Lm1hdHJpeFdvcmxkICkKCQkJCQkJCQkuYXBwbHlNYXRyaXg0KCBfcHJvalNjcmVlbk1hdHJpeCApOwoKCQkJCQkJfQoKCQkJCQkJaWYgKCBBcnJheS5pc0FycmF5KCBtYXRlcmlhbCApICkgewoKCQkJCQkJCWNvbnN0IGdyb3VwcyA9IGdlb21ldHJ5Lmdyb3VwczsKCgkJCQkJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBncm91cHMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQkJCQkJY29uc3QgZ3JvdXAgPSBncm91cHNbIGkgXTsKCQkJCQkJCQljb25zdCBncm91cE1hdGVyaWFsID0gbWF0ZXJpYWxbIGdyb3VwLm1hdGVyaWFsSW5kZXggXTsKCgkJCQkJCQkJaWYgKCBncm91cE1hdGVyaWFsICYmIGdyb3VwTWF0ZXJpYWwudmlzaWJsZSApIHsKCgkJCQkJCQkJCWN1cnJlbnRSZW5kZXJMaXN0LnB1c2goIG9iamVjdCwgZ2VvbWV0cnksIGdyb3VwTWF0ZXJpYWwsIGdyb3VwT3JkZXIsIF92ZWN0b3IzLnosIGdyb3VwICk7CgoJCQkJCQkJCX0KCgkJCQkJCQl9CgoJCQkJCQl9IGVsc2UgaWYgKCBtYXRlcmlhbC52aXNpYmxlICkgewoKCQkJCQkJCWN1cnJlbnRSZW5kZXJMaXN0LnB1c2goIG9iamVjdCwgZ2VvbWV0cnksIG1hdGVyaWFsLCBncm91cE9yZGVyLCBfdmVjdG9yMy56LCBudWxsICk7CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQl9CgoJCQl9CgoJCQljb25zdCBjaGlsZHJlbiA9IG9iamVjdC5jaGlsZHJlbjsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJcHJvamVjdE9iamVjdCggY2hpbGRyZW5bIGkgXSwgY2FtZXJhLCBncm91cE9yZGVyLCBzb3J0T2JqZWN0cyApOwoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIHJlbmRlclNjZW5lKCBjdXJyZW50UmVuZGVyTGlzdCwgc2NlbmUsIGNhbWVyYSwgdmlld3BvcnQgKSB7CgoJCQljb25zdCBvcGFxdWVPYmplY3RzID0gY3VycmVudFJlbmRlckxpc3Qub3BhcXVlOwoJCQljb25zdCB0cmFuc21pc3NpdmVPYmplY3RzID0gY3VycmVudFJlbmRlckxpc3QudHJhbnNtaXNzaXZlOwoJCQljb25zdCB0cmFuc3BhcmVudE9iamVjdHMgPSBjdXJyZW50UmVuZGVyTGlzdC50cmFuc3BhcmVudDsKCgkJCWN1cnJlbnRSZW5kZXJTdGF0ZS5zZXR1cExpZ2h0c1ZpZXcoIGNhbWVyYSApOwoKCQkJaWYgKCBfY2xpcHBpbmdFbmFibGVkID09PSB0cnVlICkgY2xpcHBpbmcuc2V0R2xvYmFsU3RhdGUoIF90aGlzLmNsaXBwaW5nUGxhbmVzLCBjYW1lcmEgKTsKCgkJCWlmICggdHJhbnNtaXNzaXZlT2JqZWN0cy5sZW5ndGggPiAwICkgcmVuZGVyVHJhbnNtaXNzaW9uUGFzcyggb3BhcXVlT2JqZWN0cywgdHJhbnNtaXNzaXZlT2JqZWN0cywgc2NlbmUsIGNhbWVyYSApOwoKCQkJaWYgKCB2aWV3cG9ydCApIHN0YXRlLnZpZXdwb3J0KCBfY3VycmVudFZpZXdwb3J0LmNvcHkoIHZpZXdwb3J0ICkgKTsKCgkJCWlmICggb3BhcXVlT2JqZWN0cy5sZW5ndGggPiAwICkgcmVuZGVyT2JqZWN0cyggb3BhcXVlT2JqZWN0cywgc2NlbmUsIGNhbWVyYSApOwoJCQlpZiAoIHRyYW5zbWlzc2l2ZU9iamVjdHMubGVuZ3RoID4gMCApIHJlbmRlck9iamVjdHMoIHRyYW5zbWlzc2l2ZU9iamVjdHMsIHNjZW5lLCBjYW1lcmEgKTsKCQkJaWYgKCB0cmFuc3BhcmVudE9iamVjdHMubGVuZ3RoID4gMCApIHJlbmRlck9iamVjdHMoIHRyYW5zcGFyZW50T2JqZWN0cywgc2NlbmUsIGNhbWVyYSApOwoKCQkJLy8gRW5zdXJlIGRlcHRoIGJ1ZmZlciB3cml0aW5nIGlzIGVuYWJsZWQgc28gaXQgY2FuIGJlIGNsZWFyZWQgb24gbmV4dCByZW5kZXIKCgkJCXN0YXRlLmJ1ZmZlcnMuZGVwdGguc2V0VGVzdCggdHJ1ZSApOwoJCQlzdGF0ZS5idWZmZXJzLmRlcHRoLnNldE1hc2soIHRydWUgKTsKCQkJc3RhdGUuYnVmZmVycy5jb2xvci5zZXRNYXNrKCB0cnVlICk7CgoJCQlzdGF0ZS5zZXRQb2x5Z29uT2Zmc2V0KCBmYWxzZSApOwoKCQl9CgoJCWZ1bmN0aW9uIHJlbmRlclRyYW5zbWlzc2lvblBhc3MoIG9wYXF1ZU9iamVjdHMsIHRyYW5zbWlzc2l2ZU9iamVjdHMsIHNjZW5lLCBjYW1lcmEgKSB7CgoJCQljb25zdCBvdmVycmlkZU1hdGVyaWFsID0gc2NlbmUuaXNTY2VuZSA9PT0gdHJ1ZSA/IHNjZW5lLm92ZXJyaWRlTWF0ZXJpYWwgOiBudWxsOwoKCQkJaWYgKCBvdmVycmlkZU1hdGVyaWFsICE9PSBudWxsICkgewoKCQkJCXJldHVybjsKCgkJCX0KCgkJCWNvbnN0IGlzV2ViR0wyID0gY2FwYWJpbGl0aWVzLmlzV2ViR0wyOwoKCQkJaWYgKCBfdHJhbnNtaXNzaW9uUmVuZGVyVGFyZ2V0ID09PSBudWxsICkgewoKCQkJCV90cmFuc21pc3Npb25SZW5kZXJUYXJnZXQgPSBuZXcgV2ViR0xSZW5kZXJUYXJnZXQoIDEsIDEsIHsKCQkJCQlnZW5lcmF0ZU1pcG1hcHM6IHRydWUsCgkJCQkJdHlwZTogZXh0ZW5zaW9ucy5oYXMoICdFWFRfY29sb3JfYnVmZmVyX2hhbGZfZmxvYXQnICkgPyBIYWxmRmxvYXRUeXBlIDogVW5zaWduZWRCeXRlVHlwZSwKCQkJCQltaW5GaWx0ZXI6IExpbmVhck1pcG1hcExpbmVhckZpbHRlciwKCQkJCQlzYW1wbGVzOiAoIGlzV2ViR0wyICkgPyA0IDogMAoJCQkJfSApOwoKCQkJCS8vIGRlYnVnCgoJCQkJLyoKCQkJCWNvbnN0IGdlb21ldHJ5ID0gbmV3IFBsYW5lR2VvbWV0cnkoKTsKCQkJCWNvbnN0IG1hdGVyaWFsID0gbmV3IE1lc2hCYXNpY01hdGVyaWFsKCB7IG1hcDogX3RyYW5zbWlzc2lvblJlbmRlclRhcmdldC50ZXh0dXJlIH0gKTsKCgkJCQljb25zdCBtZXNoID0gbmV3IE1lc2goIGdlb21ldHJ5LCBtYXRlcmlhbCApOwoJCQkJc2NlbmUuYWRkKCBtZXNoICk7CgkJCQkqLwoKCQkJfQoKCQkJX3RoaXMuZ2V0RHJhd2luZ0J1ZmZlclNpemUoIF92ZWN0b3IyICk7CgoJCQlpZiAoIGlzV2ViR0wyICkgewoKCQkJCV90cmFuc21pc3Npb25SZW5kZXJUYXJnZXQuc2V0U2l6ZSggX3ZlY3RvcjIueCwgX3ZlY3RvcjIueSApOwoKCQkJfSBlbHNlIHsKCgkJCQlfdHJhbnNtaXNzaW9uUmVuZGVyVGFyZ2V0LnNldFNpemUoIGZsb29yUG93ZXJPZlR3byggX3ZlY3RvcjIueCApLCBmbG9vclBvd2VyT2ZUd28oIF92ZWN0b3IyLnkgKSApOwoKCQkJfQoKCQkJLy8KCgkJCWNvbnN0IGN1cnJlbnRSZW5kZXJUYXJnZXQgPSBfdGhpcy5nZXRSZW5kZXJUYXJnZXQoKTsKCQkJX3RoaXMuc2V0UmVuZGVyVGFyZ2V0KCBfdHJhbnNtaXNzaW9uUmVuZGVyVGFyZ2V0ICk7CgoJCQlfdGhpcy5nZXRDbGVhckNvbG9yKCBfY3VycmVudENsZWFyQ29sb3IgKTsKCQkJX2N1cnJlbnRDbGVhckFscGhhID0gX3RoaXMuZ2V0Q2xlYXJBbHBoYSgpOwoJCQlpZiAoIF9jdXJyZW50Q2xlYXJBbHBoYSA8IDEgKSBfdGhpcy5zZXRDbGVhckNvbG9yKCAweGZmZmZmZiwgMC41ICk7CgoJCQlfdGhpcy5jbGVhcigpOwoKCQkJLy8gVHVybiBvZmYgdGhlIGZlYXR1cmVzIHdoaWNoIGNhbiBhZmZlY3QgdGhlIGZyYWcgY29sb3IgZm9yIG9wYXF1ZSBvYmplY3RzIHBhc3MuCgkJCS8vIE90aGVyd2lzZSB0aGV5IGFyZSBhcHBsaWVkIHR3aWNlIGluIG9wYXF1ZSBvYmplY3RzIHBhc3MgYW5kIHRyYW5zbWlzc2lvbiBvYmplY3RzIHBhc3MuCgkJCWNvbnN0IGN1cnJlbnRUb25lTWFwcGluZyA9IF90aGlzLnRvbmVNYXBwaW5nOwoJCQlfdGhpcy50b25lTWFwcGluZyA9IE5vVG9uZU1hcHBpbmc7CgoJCQlyZW5kZXJPYmplY3RzKCBvcGFxdWVPYmplY3RzLCBzY2VuZSwgY2FtZXJhICk7CgoJCQl0ZXh0dXJlcy51cGRhdGVNdWx0aXNhbXBsZVJlbmRlclRhcmdldCggX3RyYW5zbWlzc2lvblJlbmRlclRhcmdldCApOwoJCQl0ZXh0dXJlcy51cGRhdGVSZW5kZXJUYXJnZXRNaXBtYXAoIF90cmFuc21pc3Npb25SZW5kZXJUYXJnZXQgKTsKCgkJCWxldCByZW5kZXJUYXJnZXROZWVkc1VwZGF0ZSA9IGZhbHNlOwoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gdHJhbnNtaXNzaXZlT2JqZWN0cy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWNvbnN0IHJlbmRlckl0ZW0gPSB0cmFuc21pc3NpdmVPYmplY3RzWyBpIF07CgoJCQkJY29uc3Qgb2JqZWN0ID0gcmVuZGVySXRlbS5vYmplY3Q7CgkJCQljb25zdCBnZW9tZXRyeSA9IHJlbmRlckl0ZW0uZ2VvbWV0cnk7CgkJCQljb25zdCBtYXRlcmlhbCA9IHJlbmRlckl0ZW0ubWF0ZXJpYWw7CgkJCQljb25zdCBncm91cCA9IHJlbmRlckl0ZW0uZ3JvdXA7CgoJCQkJaWYgKCBtYXRlcmlhbC5zaWRlID09PSBEb3VibGVTaWRlICYmIG9iamVjdC5sYXllcnMudGVzdCggY2FtZXJhLmxheWVycyApICkgewoKCQkJCQljb25zdCBjdXJyZW50U2lkZSA9IG1hdGVyaWFsLnNpZGU7CgoJCQkJCW1hdGVyaWFsLnNpZGUgPSBCYWNrU2lkZTsKCQkJCQltYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCQkJCXJlbmRlck9iamVjdCggb2JqZWN0LCBzY2VuZSwgY2FtZXJhLCBnZW9tZXRyeSwgbWF0ZXJpYWwsIGdyb3VwICk7CgoJCQkJCW1hdGVyaWFsLnNpZGUgPSBjdXJyZW50U2lkZTsKCQkJCQltYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCQkJCXJlbmRlclRhcmdldE5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJCQl9CgoJCQl9CgoJCQlpZiAoIHJlbmRlclRhcmdldE5lZWRzVXBkYXRlID09PSB0cnVlICkgewoKCQkJCXRleHR1cmVzLnVwZGF0ZU11bHRpc2FtcGxlUmVuZGVyVGFyZ2V0KCBfdHJhbnNtaXNzaW9uUmVuZGVyVGFyZ2V0ICk7CgkJCQl0ZXh0dXJlcy51cGRhdGVSZW5kZXJUYXJnZXRNaXBtYXAoIF90cmFuc21pc3Npb25SZW5kZXJUYXJnZXQgKTsKCgkJCX0KCgkJCV90aGlzLnNldFJlbmRlclRhcmdldCggY3VycmVudFJlbmRlclRhcmdldCApOwoKCQkJX3RoaXMuc2V0Q2xlYXJDb2xvciggX2N1cnJlbnRDbGVhckNvbG9yLCBfY3VycmVudENsZWFyQWxwaGEgKTsKCgkJCV90aGlzLnRvbmVNYXBwaW5nID0gY3VycmVudFRvbmVNYXBwaW5nOwoKCQl9CgoJCWZ1bmN0aW9uIHJlbmRlck9iamVjdHMoIHJlbmRlckxpc3QsIHNjZW5lLCBjYW1lcmEgKSB7CgoJCQljb25zdCBvdmVycmlkZU1hdGVyaWFsID0gc2NlbmUuaXNTY2VuZSA9PT0gdHJ1ZSA/IHNjZW5lLm92ZXJyaWRlTWF0ZXJpYWwgOiBudWxsOwoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gcmVuZGVyTGlzdC5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWNvbnN0IHJlbmRlckl0ZW0gPSByZW5kZXJMaXN0WyBpIF07CgoJCQkJY29uc3Qgb2JqZWN0ID0gcmVuZGVySXRlbS5vYmplY3Q7CgkJCQljb25zdCBnZW9tZXRyeSA9IHJlbmRlckl0ZW0uZ2VvbWV0cnk7CgkJCQljb25zdCBtYXRlcmlhbCA9IG92ZXJyaWRlTWF0ZXJpYWwgPT09IG51bGwgPyByZW5kZXJJdGVtLm1hdGVyaWFsIDogb3ZlcnJpZGVNYXRlcmlhbDsKCQkJCWNvbnN0IGdyb3VwID0gcmVuZGVySXRlbS5ncm91cDsKCgkJCQlpZiAoIG9iamVjdC5sYXllcnMudGVzdCggY2FtZXJhLmxheWVycyApICkgewoKCQkJCQlyZW5kZXJPYmplY3QoIG9iamVjdCwgc2NlbmUsIGNhbWVyYSwgZ2VvbWV0cnksIG1hdGVyaWFsLCBncm91cCApOwoKCQkJCX0KCgkJCX0KCgkJfQoKCQlmdW5jdGlvbiByZW5kZXJPYmplY3QoIG9iamVjdCwgc2NlbmUsIGNhbWVyYSwgZ2VvbWV0cnksIG1hdGVyaWFsLCBncm91cCApIHsKCgkJCW9iamVjdC5vbkJlZm9yZVJlbmRlciggX3RoaXMsIHNjZW5lLCBjYW1lcmEsIGdlb21ldHJ5LCBtYXRlcmlhbCwgZ3JvdXAgKTsKCgkJCW9iamVjdC5tb2RlbFZpZXdNYXRyaXgubXVsdGlwbHlNYXRyaWNlcyggY2FtZXJhLm1hdHJpeFdvcmxkSW52ZXJzZSwgb2JqZWN0Lm1hdHJpeFdvcmxkICk7CgkJCW9iamVjdC5ub3JtYWxNYXRyaXguZ2V0Tm9ybWFsTWF0cml4KCBvYmplY3QubW9kZWxWaWV3TWF0cml4ICk7CgoJCQltYXRlcmlhbC5vbkJlZm9yZVJlbmRlciggX3RoaXMsIHNjZW5lLCBjYW1lcmEsIGdlb21ldHJ5LCBvYmplY3QsIGdyb3VwICk7CgoJCQlpZiAoIG1hdGVyaWFsLnRyYW5zcGFyZW50ID09PSB0cnVlICYmIG1hdGVyaWFsLnNpZGUgPT09IERvdWJsZVNpZGUgJiYgbWF0ZXJpYWwuZm9yY2VTaW5nbGVQYXNzID09PSBmYWxzZSApIHsKCgkJCQltYXRlcmlhbC5zaWRlID0gQmFja1NpZGU7CgkJCQltYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CgkJCQlfdGhpcy5yZW5kZXJCdWZmZXJEaXJlY3QoIGNhbWVyYSwgc2NlbmUsIGdlb21ldHJ5LCBtYXRlcmlhbCwgb2JqZWN0LCBncm91cCApOwoKCQkJCW1hdGVyaWFsLnNpZGUgPSBGcm9udFNpZGU7CgkJCQltYXRlcmlhbC5uZWVkc1VwZGF0ZSA9IHRydWU7CgkJCQlfdGhpcy5yZW5kZXJCdWZmZXJEaXJlY3QoIGNhbWVyYSwgc2NlbmUsIGdlb21ldHJ5LCBtYXRlcmlhbCwgb2JqZWN0LCBncm91cCApOwoKCQkJCW1hdGVyaWFsLnNpZGUgPSBEb3VibGVTaWRlOwoKCQkJfSBlbHNlIHsKCgkJCQlfdGhpcy5yZW5kZXJCdWZmZXJEaXJlY3QoIGNhbWVyYSwgc2NlbmUsIGdlb21ldHJ5LCBtYXRlcmlhbCwgb2JqZWN0LCBncm91cCApOwoKCQkJfQoKCQkJb2JqZWN0Lm9uQWZ0ZXJSZW5kZXIoIF90aGlzLCBzY2VuZSwgY2FtZXJhLCBnZW9tZXRyeSwgbWF0ZXJpYWwsIGdyb3VwICk7CgoJCX0KCgkJZnVuY3Rpb24gZ2V0UHJvZ3JhbSggbWF0ZXJpYWwsIHNjZW5lLCBvYmplY3QgKSB7CgoJCQlpZiAoIHNjZW5lLmlzU2NlbmUgIT09IHRydWUgKSBzY2VuZSA9IF9lbXB0eVNjZW5lOyAvLyBzY2VuZSBjb3VsZCBiZSBhIE1lc2gsIExpbmUsIFBvaW50cywgLi4uCgoJCQljb25zdCBtYXRlcmlhbFByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggbWF0ZXJpYWwgKTsKCgkJCWNvbnN0IGxpZ2h0cyA9IGN1cnJlbnRSZW5kZXJTdGF0ZS5zdGF0ZS5saWdodHM7CgkJCWNvbnN0IHNoYWRvd3NBcnJheSA9IGN1cnJlbnRSZW5kZXJTdGF0ZS5zdGF0ZS5zaGFkb3dzQXJyYXk7CgoJCQljb25zdCBsaWdodHNTdGF0ZVZlcnNpb24gPSBsaWdodHMuc3RhdGUudmVyc2lvbjsKCgkJCWNvbnN0IHBhcmFtZXRlcnMgPSBwcm9ncmFtQ2FjaGUuZ2V0UGFyYW1ldGVycyggbWF0ZXJpYWwsIGxpZ2h0cy5zdGF0ZSwgc2hhZG93c0FycmF5LCBzY2VuZSwgb2JqZWN0ICk7CgkJCWNvbnN0IHByb2dyYW1DYWNoZUtleSA9IHByb2dyYW1DYWNoZS5nZXRQcm9ncmFtQ2FjaGVLZXkoIHBhcmFtZXRlcnMgKTsKCgkJCWxldCBwcm9ncmFtcyA9IG1hdGVyaWFsUHJvcGVydGllcy5wcm9ncmFtczsKCgkJCS8vIGFsd2F5cyB1cGRhdGUgZW52aXJvbm1lbnQgYW5kIGZvZyAtIGNoYW5naW5nIHRoZXNlIHRyaWdnZXIgYW4gZ2V0UHJvZ3JhbSBjYWxsLCBidXQgaXQncyBwb3NzaWJsZSB0aGF0IHRoZSBwcm9ncmFtIGRvZXNuJ3QgY2hhbmdlCgoJCQltYXRlcmlhbFByb3BlcnRpZXMuZW52aXJvbm1lbnQgPSBtYXRlcmlhbC5pc01lc2hTdGFuZGFyZE1hdGVyaWFsID8gc2NlbmUuZW52aXJvbm1lbnQgOiBudWxsOwoJCQltYXRlcmlhbFByb3BlcnRpZXMuZm9nID0gc2NlbmUuZm9nOwoJCQltYXRlcmlhbFByb3BlcnRpZXMuZW52TWFwID0gKCBtYXRlcmlhbC5pc01lc2hTdGFuZGFyZE1hdGVyaWFsID8gY3ViZXV2bWFwcyA6IGN1YmVtYXBzICkuZ2V0KCBtYXRlcmlhbC5lbnZNYXAgfHwgbWF0ZXJpYWxQcm9wZXJ0aWVzLmVudmlyb25tZW50ICk7CgoJCQlpZiAoIHByb2dyYW1zID09PSB1bmRlZmluZWQgKSB7CgoJCQkJLy8gbmV3IG1hdGVyaWFsCgoJCQkJbWF0ZXJpYWwuYWRkRXZlbnRMaXN0ZW5lciggJ2Rpc3Bvc2UnLCBvbk1hdGVyaWFsRGlzcG9zZSApOwoKCQkJCXByb2dyYW1zID0gbmV3IE1hcCgpOwoJCQkJbWF0ZXJpYWxQcm9wZXJ0aWVzLnByb2dyYW1zID0gcHJvZ3JhbXM7CgoJCQl9CgoJCQlsZXQgcHJvZ3JhbSA9IHByb2dyYW1zLmdldCggcHJvZ3JhbUNhY2hlS2V5ICk7CgoJCQlpZiAoIHByb2dyYW0gIT09IHVuZGVmaW5lZCApIHsKCgkJCQkvLyBlYXJseSBvdXQgaWYgcHJvZ3JhbSBhbmQgbGlnaHQgc3RhdGUgaXMgaWRlbnRpY2FsCgoJCQkJaWYgKCBtYXRlcmlhbFByb3BlcnRpZXMuY3VycmVudFByb2dyYW0gPT09IHByb2dyYW0gJiYgbWF0ZXJpYWxQcm9wZXJ0aWVzLmxpZ2h0c1N0YXRlVmVyc2lvbiA9PT0gbGlnaHRzU3RhdGVWZXJzaW9uICkgewoKCQkJCQl1cGRhdGVDb21tb25NYXRlcmlhbFByb3BlcnRpZXMoIG1hdGVyaWFsLCBwYXJhbWV0ZXJzICk7CgoJCQkJCXJldHVybiBwcm9ncmFtOwoKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJcGFyYW1ldGVycy51bmlmb3JtcyA9IHByb2dyYW1DYWNoZS5nZXRVbmlmb3JtcyggbWF0ZXJpYWwgKTsKCgkJCQltYXRlcmlhbC5vbkJ1aWxkKCBvYmplY3QsIHBhcmFtZXRlcnMsIF90aGlzICk7CgoJCQkJbWF0ZXJpYWwub25CZWZvcmVDb21waWxlKCBwYXJhbWV0ZXJzLCBfdGhpcyApOwoKCQkJCXByb2dyYW0gPSBwcm9ncmFtQ2FjaGUuYWNxdWlyZVByb2dyYW0oIHBhcmFtZXRlcnMsIHByb2dyYW1DYWNoZUtleSApOwoJCQkJcHJvZ3JhbXMuc2V0KCBwcm9ncmFtQ2FjaGVLZXksIHByb2dyYW0gKTsKCgkJCQltYXRlcmlhbFByb3BlcnRpZXMudW5pZm9ybXMgPSBwYXJhbWV0ZXJzLnVuaWZvcm1zOwoKCQkJfQoKCQkJY29uc3QgdW5pZm9ybXMgPSBtYXRlcmlhbFByb3BlcnRpZXMudW5pZm9ybXM7CgoJCQlpZiAoICggISBtYXRlcmlhbC5pc1NoYWRlck1hdGVyaWFsICYmICEgbWF0ZXJpYWwuaXNSYXdTaGFkZXJNYXRlcmlhbCApIHx8IG1hdGVyaWFsLmNsaXBwaW5nID09PSB0cnVlICkgewoKCQkJCXVuaWZvcm1zLmNsaXBwaW5nUGxhbmVzID0gY2xpcHBpbmcudW5pZm9ybTsKCgkJCX0KCgkJCXVwZGF0ZUNvbW1vbk1hdGVyaWFsUHJvcGVydGllcyggbWF0ZXJpYWwsIHBhcmFtZXRlcnMgKTsKCgkJCS8vIHN0b3JlIHRoZSBsaWdodCBzZXR1cCBpdCB3YXMgY3JlYXRlZCBmb3IKCgkJCW1hdGVyaWFsUHJvcGVydGllcy5uZWVkc0xpZ2h0cyA9IG1hdGVyaWFsTmVlZHNMaWdodHMoIG1hdGVyaWFsICk7CgkJCW1hdGVyaWFsUHJvcGVydGllcy5saWdodHNTdGF0ZVZlcnNpb24gPSBsaWdodHNTdGF0ZVZlcnNpb247CgoJCQlpZiAoIG1hdGVyaWFsUHJvcGVydGllcy5uZWVkc0xpZ2h0cyApIHsKCgkJCQkvLyB3aXJlIHVwIHRoZSBtYXRlcmlhbCB0byB0aGlzIHJlbmRlcmVyJ3MgbGlnaHRpbmcgc3RhdGUKCgkJCQl1bmlmb3Jtcy5hbWJpZW50TGlnaHRDb2xvci52YWx1ZSA9IGxpZ2h0cy5zdGF0ZS5hbWJpZW50OwoJCQkJdW5pZm9ybXMubGlnaHRQcm9iZS52YWx1ZSA9IGxpZ2h0cy5zdGF0ZS5wcm9iZTsKCQkJCXVuaWZvcm1zLmRpcmVjdGlvbmFsTGlnaHRzLnZhbHVlID0gbGlnaHRzLnN0YXRlLmRpcmVjdGlvbmFsOwoJCQkJdW5pZm9ybXMuZGlyZWN0aW9uYWxMaWdodFNoYWRvd3MudmFsdWUgPSBsaWdodHMuc3RhdGUuZGlyZWN0aW9uYWxTaGFkb3c7CgkJCQl1bmlmb3Jtcy5zcG90TGlnaHRzLnZhbHVlID0gbGlnaHRzLnN0YXRlLnNwb3Q7CgkJCQl1bmlmb3Jtcy5zcG90TGlnaHRTaGFkb3dzLnZhbHVlID0gbGlnaHRzLnN0YXRlLnNwb3RTaGFkb3c7CgkJCQl1bmlmb3Jtcy5yZWN0QXJlYUxpZ2h0cy52YWx1ZSA9IGxpZ2h0cy5zdGF0ZS5yZWN0QXJlYTsKCQkJCXVuaWZvcm1zLmx0Y18xLnZhbHVlID0gbGlnaHRzLnN0YXRlLnJlY3RBcmVhTFRDMTsKCQkJCXVuaWZvcm1zLmx0Y18yLnZhbHVlID0gbGlnaHRzLnN0YXRlLnJlY3RBcmVhTFRDMjsKCQkJCXVuaWZvcm1zLnBvaW50TGlnaHRzLnZhbHVlID0gbGlnaHRzLnN0YXRlLnBvaW50OwoJCQkJdW5pZm9ybXMucG9pbnRMaWdodFNoYWRvd3MudmFsdWUgPSBsaWdodHMuc3RhdGUucG9pbnRTaGFkb3c7CgkJCQl1bmlmb3Jtcy5oZW1pc3BoZXJlTGlnaHRzLnZhbHVlID0gbGlnaHRzLnN0YXRlLmhlbWk7CgoJCQkJdW5pZm9ybXMuZGlyZWN0aW9uYWxTaGFkb3dNYXAudmFsdWUgPSBsaWdodHMuc3RhdGUuZGlyZWN0aW9uYWxTaGFkb3dNYXA7CgkJCQl1bmlmb3Jtcy5kaXJlY3Rpb25hbFNoYWRvd01hdHJpeC52YWx1ZSA9IGxpZ2h0cy5zdGF0ZS5kaXJlY3Rpb25hbFNoYWRvd01hdHJpeDsKCQkJCXVuaWZvcm1zLnNwb3RTaGFkb3dNYXAudmFsdWUgPSBsaWdodHMuc3RhdGUuc3BvdFNoYWRvd01hcDsKCQkJCXVuaWZvcm1zLnNwb3RMaWdodE1hdHJpeC52YWx1ZSA9IGxpZ2h0cy5zdGF0ZS5zcG90TGlnaHRNYXRyaXg7CgkJCQl1bmlmb3Jtcy5zcG90TGlnaHRNYXAudmFsdWUgPSBsaWdodHMuc3RhdGUuc3BvdExpZ2h0TWFwOwoJCQkJdW5pZm9ybXMucG9pbnRTaGFkb3dNYXAudmFsdWUgPSBsaWdodHMuc3RhdGUucG9pbnRTaGFkb3dNYXA7CgkJCQl1bmlmb3Jtcy5wb2ludFNoYWRvd01hdHJpeC52YWx1ZSA9IGxpZ2h0cy5zdGF0ZS5wb2ludFNoYWRvd01hdHJpeDsKCQkJCS8vIFRPRE8gKGFiZWxuYXRpb24pOiBhZGQgYXJlYSBsaWdodHMgc2hhZG93IGluZm8gdG8gdW5pZm9ybXMKCgkJCX0KCgkJCW1hdGVyaWFsUHJvcGVydGllcy5jdXJyZW50UHJvZ3JhbSA9IHByb2dyYW07CgkJCW1hdGVyaWFsUHJvcGVydGllcy51bmlmb3Jtc0xpc3QgPSBudWxsOwoKCQkJcmV0dXJuIHByb2dyYW07CgoJCX0KCgkJZnVuY3Rpb24gZ2V0VW5pZm9ybUxpc3QoIG1hdGVyaWFsUHJvcGVydGllcyApIHsKCgkJCWlmICggbWF0ZXJpYWxQcm9wZXJ0aWVzLnVuaWZvcm1zTGlzdCA9PT0gbnVsbCApIHsKCgkJCQljb25zdCBwcm9nVW5pZm9ybXMgPSBtYXRlcmlhbFByb3BlcnRpZXMuY3VycmVudFByb2dyYW0uZ2V0VW5pZm9ybXMoKTsKCQkJCW1hdGVyaWFsUHJvcGVydGllcy51bmlmb3Jtc0xpc3QgPSBXZWJHTFVuaWZvcm1zLnNlcVdpdGhWYWx1ZSggcHJvZ1VuaWZvcm1zLnNlcSwgbWF0ZXJpYWxQcm9wZXJ0aWVzLnVuaWZvcm1zICk7CgoJCQl9CgoJCQlyZXR1cm4gbWF0ZXJpYWxQcm9wZXJ0aWVzLnVuaWZvcm1zTGlzdDsKCgkJfQoKCQlmdW5jdGlvbiB1cGRhdGVDb21tb25NYXRlcmlhbFByb3BlcnRpZXMoIG1hdGVyaWFsLCBwYXJhbWV0ZXJzICkgewoKCQkJY29uc3QgbWF0ZXJpYWxQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIG1hdGVyaWFsICk7CgoJCQltYXRlcmlhbFByb3BlcnRpZXMub3V0cHV0Q29sb3JTcGFjZSA9IHBhcmFtZXRlcnMub3V0cHV0Q29sb3JTcGFjZTsKCQkJbWF0ZXJpYWxQcm9wZXJ0aWVzLmJhdGNoaW5nID0gcGFyYW1ldGVycy5iYXRjaGluZzsKCQkJbWF0ZXJpYWxQcm9wZXJ0aWVzLmluc3RhbmNpbmcgPSBwYXJhbWV0ZXJzLmluc3RhbmNpbmc7CgkJCW1hdGVyaWFsUHJvcGVydGllcy5pbnN0YW5jaW5nQ29sb3IgPSBwYXJhbWV0ZXJzLmluc3RhbmNpbmdDb2xvcjsKCQkJbWF0ZXJpYWxQcm9wZXJ0aWVzLnNraW5uaW5nID0gcGFyYW1ldGVycy5za2lubmluZzsKCQkJbWF0ZXJpYWxQcm9wZXJ0aWVzLm1vcnBoVGFyZ2V0cyA9IHBhcmFtZXRlcnMubW9ycGhUYXJnZXRzOwoJCQltYXRlcmlhbFByb3BlcnRpZXMubW9ycGhOb3JtYWxzID0gcGFyYW1ldGVycy5tb3JwaE5vcm1hbHM7CgkJCW1hdGVyaWFsUHJvcGVydGllcy5tb3JwaENvbG9ycyA9IHBhcmFtZXRlcnMubW9ycGhDb2xvcnM7CgkJCW1hdGVyaWFsUHJvcGVydGllcy5tb3JwaFRhcmdldHNDb3VudCA9IHBhcmFtZXRlcnMubW9ycGhUYXJnZXRzQ291bnQ7CgkJCW1hdGVyaWFsUHJvcGVydGllcy5udW1DbGlwcGluZ1BsYW5lcyA9IHBhcmFtZXRlcnMubnVtQ2xpcHBpbmdQbGFuZXM7CgkJCW1hdGVyaWFsUHJvcGVydGllcy5udW1JbnRlcnNlY3Rpb24gPSBwYXJhbWV0ZXJzLm51bUNsaXBJbnRlcnNlY3Rpb247CgkJCW1hdGVyaWFsUHJvcGVydGllcy52ZXJ0ZXhBbHBoYXMgPSBwYXJhbWV0ZXJzLnZlcnRleEFscGhhczsKCQkJbWF0ZXJpYWxQcm9wZXJ0aWVzLnZlcnRleFRhbmdlbnRzID0gcGFyYW1ldGVycy52ZXJ0ZXhUYW5nZW50czsKCQkJbWF0ZXJpYWxQcm9wZXJ0aWVzLnRvbmVNYXBwaW5nID0gcGFyYW1ldGVycy50b25lTWFwcGluZzsKCgkJfQoKCQlmdW5jdGlvbiBzZXRQcm9ncmFtKCBjYW1lcmEsIHNjZW5lLCBnZW9tZXRyeSwgbWF0ZXJpYWwsIG9iamVjdCApIHsKCgkJCWlmICggc2NlbmUuaXNTY2VuZSAhPT0gdHJ1ZSApIHNjZW5lID0gX2VtcHR5U2NlbmU7IC8vIHNjZW5lIGNvdWxkIGJlIGEgTWVzaCwgTGluZSwgUG9pbnRzLCAuLi4KCgkJCXRleHR1cmVzLnJlc2V0VGV4dHVyZVVuaXRzKCk7CgoJCQljb25zdCBmb2cgPSBzY2VuZS5mb2c7CgkJCWNvbnN0IGVudmlyb25tZW50ID0gbWF0ZXJpYWwuaXNNZXNoU3RhbmRhcmRNYXRlcmlhbCA/IHNjZW5lLmVudmlyb25tZW50IDogbnVsbDsKCQkJY29uc3QgY29sb3JTcGFjZSA9ICggX2N1cnJlbnRSZW5kZXJUYXJnZXQgPT09IG51bGwgKSA/IF90aGlzLm91dHB1dENvbG9yU3BhY2UgOiAoIF9jdXJyZW50UmVuZGVyVGFyZ2V0LmlzWFJSZW5kZXJUYXJnZXQgPT09IHRydWUgPyBfY3VycmVudFJlbmRlclRhcmdldC50ZXh0dXJlLmNvbG9yU3BhY2UgOiBMaW5lYXJTUkdCQ29sb3JTcGFjZSApOwoJCQljb25zdCBlbnZNYXAgPSAoIG1hdGVyaWFsLmlzTWVzaFN0YW5kYXJkTWF0ZXJpYWwgPyBjdWJldXZtYXBzIDogY3ViZW1hcHMgKS5nZXQoIG1hdGVyaWFsLmVudk1hcCB8fCBlbnZpcm9ubWVudCApOwoJCQljb25zdCB2ZXJ0ZXhBbHBoYXMgPSBtYXRlcmlhbC52ZXJ0ZXhDb2xvcnMgPT09IHRydWUgJiYgISEgZ2VvbWV0cnkuYXR0cmlidXRlcy5jb2xvciAmJiBnZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbG9yLml0ZW1TaXplID09PSA0OwoJCQljb25zdCB2ZXJ0ZXhUYW5nZW50cyA9ICEhIGdlb21ldHJ5LmF0dHJpYnV0ZXMudGFuZ2VudCAmJiAoICEhIG1hdGVyaWFsLm5vcm1hbE1hcCB8fCBtYXRlcmlhbC5hbmlzb3Ryb3B5ID4gMCApOwoJCQljb25zdCBtb3JwaFRhcmdldHMgPSAhISBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb247CgkJCWNvbnN0IG1vcnBoTm9ybWFscyA9ICEhIGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy5ub3JtYWw7CgkJCWNvbnN0IG1vcnBoQ29sb3JzID0gISEgZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzLmNvbG9yOwoKCQkJbGV0IHRvbmVNYXBwaW5nID0gTm9Ub25lTWFwcGluZzsKCgkJCWlmICggbWF0ZXJpYWwudG9uZU1hcHBlZCApIHsKCgkJCQlpZiAoIF9jdXJyZW50UmVuZGVyVGFyZ2V0ID09PSBudWxsIHx8IF9jdXJyZW50UmVuZGVyVGFyZ2V0LmlzWFJSZW5kZXJUYXJnZXQgPT09IHRydWUgKSB7CgoJCQkJCXRvbmVNYXBwaW5nID0gX3RoaXMudG9uZU1hcHBpbmc7CgoJCQkJfQoKCQkJfQoKCQkJY29uc3QgbW9ycGhBdHRyaWJ1dGUgPSBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMucG9zaXRpb24gfHwgZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzLm5vcm1hbCB8fCBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXMuY29sb3I7CgkJCWNvbnN0IG1vcnBoVGFyZ2V0c0NvdW50ID0gKCBtb3JwaEF0dHJpYnV0ZSAhPT0gdW5kZWZpbmVkICkgPyBtb3JwaEF0dHJpYnV0ZS5sZW5ndGggOiAwOwoKCQkJY29uc3QgbWF0ZXJpYWxQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIG1hdGVyaWFsICk7CgkJCWNvbnN0IGxpZ2h0cyA9IGN1cnJlbnRSZW5kZXJTdGF0ZS5zdGF0ZS5saWdodHM7CgoJCQlpZiAoIF9jbGlwcGluZ0VuYWJsZWQgPT09IHRydWUgKSB7CgoJCQkJaWYgKCBfbG9jYWxDbGlwcGluZ0VuYWJsZWQgPT09IHRydWUgfHwgY2FtZXJhICE9PSBfY3VycmVudENhbWVyYSApIHsKCgkJCQkJY29uc3QgdXNlQ2FjaGUgPQoJCQkJCQljYW1lcmEgPT09IF9jdXJyZW50Q2FtZXJhICYmCgkJCQkJCW1hdGVyaWFsLmlkID09PSBfY3VycmVudE1hdGVyaWFsSWQ7CgoJCQkJCS8vIHdlIG1pZ2h0IHdhbnQgdG8gY2FsbCB0aGlzIGZ1bmN0aW9uIHdpdGggc29tZSBDbGlwcGluZ0dyb3VwCgkJCQkJLy8gb2JqZWN0IGluc3RlYWQgb2YgdGhlIG1hdGVyaWFsLCBvbmNlIGl0IGJlY29tZXMgZmVhc2libGUKCQkJCQkvLyAoIzg0NjUsICM4Mzc5KQoJCQkJCWNsaXBwaW5nLnNldFN0YXRlKCBtYXRlcmlhbCwgY2FtZXJhLCB1c2VDYWNoZSApOwoKCQkJCX0KCgkJCX0KCgkJCS8vCgoJCQlsZXQgbmVlZHNQcm9ncmFtQ2hhbmdlID0gZmFsc2U7CgoJCQlpZiAoIG1hdGVyaWFsLnZlcnNpb24gPT09IG1hdGVyaWFsUHJvcGVydGllcy5fX3ZlcnNpb24gKSB7CgoJCQkJaWYgKCBtYXRlcmlhbFByb3BlcnRpZXMubmVlZHNMaWdodHMgJiYgKCBtYXRlcmlhbFByb3BlcnRpZXMubGlnaHRzU3RhdGVWZXJzaW9uICE9PSBsaWdodHMuc3RhdGUudmVyc2lvbiApICkgewoKCQkJCQluZWVkc1Byb2dyYW1DaGFuZ2UgPSB0cnVlOwoKCQkJCX0gZWxzZSBpZiAoIG1hdGVyaWFsUHJvcGVydGllcy5vdXRwdXRDb2xvclNwYWNlICE9PSBjb2xvclNwYWNlICkgewoKCQkJCQluZWVkc1Byb2dyYW1DaGFuZ2UgPSB0cnVlOwoKCQkJCX0gZWxzZSBpZiAoIG9iamVjdC5pc0JhdGNoZWRNZXNoICYmIG1hdGVyaWFsUHJvcGVydGllcy5iYXRjaGluZyA9PT0gZmFsc2UgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggISBvYmplY3QuaXNCYXRjaGVkTWVzaCAmJiBtYXRlcmlhbFByb3BlcnRpZXMuYmF0Y2hpbmcgPT09IHRydWUgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggb2JqZWN0LmlzSW5zdGFuY2VkTWVzaCAmJiBtYXRlcmlhbFByb3BlcnRpZXMuaW5zdGFuY2luZyA9PT0gZmFsc2UgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggISBvYmplY3QuaXNJbnN0YW5jZWRNZXNoICYmIG1hdGVyaWFsUHJvcGVydGllcy5pbnN0YW5jaW5nID09PSB0cnVlICkgewoKCQkJCQluZWVkc1Byb2dyYW1DaGFuZ2UgPSB0cnVlOwoKCQkJCX0gZWxzZSBpZiAoIG9iamVjdC5pc1NraW5uZWRNZXNoICYmIG1hdGVyaWFsUHJvcGVydGllcy5za2lubmluZyA9PT0gZmFsc2UgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggISBvYmplY3QuaXNTa2lubmVkTWVzaCAmJiBtYXRlcmlhbFByb3BlcnRpZXMuc2tpbm5pbmcgPT09IHRydWUgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggb2JqZWN0LmlzSW5zdGFuY2VkTWVzaCAmJiBtYXRlcmlhbFByb3BlcnRpZXMuaW5zdGFuY2luZ0NvbG9yID09PSB0cnVlICYmIG9iamVjdC5pbnN0YW5jZUNvbG9yID09PSBudWxsICkgewoKCQkJCQluZWVkc1Byb2dyYW1DaGFuZ2UgPSB0cnVlOwoKCQkJCX0gZWxzZSBpZiAoIG9iamVjdC5pc0luc3RhbmNlZE1lc2ggJiYgbWF0ZXJpYWxQcm9wZXJ0aWVzLmluc3RhbmNpbmdDb2xvciA9PT0gZmFsc2UgJiYgb2JqZWN0Lmluc3RhbmNlQ29sb3IgIT09IG51bGwgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggbWF0ZXJpYWxQcm9wZXJ0aWVzLmVudk1hcCAhPT0gZW52TWFwICkgewoKCQkJCQluZWVkc1Byb2dyYW1DaGFuZ2UgPSB0cnVlOwoKCQkJCX0gZWxzZSBpZiAoIG1hdGVyaWFsLmZvZyA9PT0gdHJ1ZSAmJiBtYXRlcmlhbFByb3BlcnRpZXMuZm9nICE9PSBmb2cgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggbWF0ZXJpYWxQcm9wZXJ0aWVzLm51bUNsaXBwaW5nUGxhbmVzICE9PSB1bmRlZmluZWQgJiYKCQkJCQkoIG1hdGVyaWFsUHJvcGVydGllcy5udW1DbGlwcGluZ1BsYW5lcyAhPT0gY2xpcHBpbmcubnVtUGxhbmVzIHx8CgkJCQkJbWF0ZXJpYWxQcm9wZXJ0aWVzLm51bUludGVyc2VjdGlvbiAhPT0gY2xpcHBpbmcubnVtSW50ZXJzZWN0aW9uICkgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggbWF0ZXJpYWxQcm9wZXJ0aWVzLnZlcnRleEFscGhhcyAhPT0gdmVydGV4QWxwaGFzICkgewoKCQkJCQluZWVkc1Byb2dyYW1DaGFuZ2UgPSB0cnVlOwoKCQkJCX0gZWxzZSBpZiAoIG1hdGVyaWFsUHJvcGVydGllcy52ZXJ0ZXhUYW5nZW50cyAhPT0gdmVydGV4VGFuZ2VudHMgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggbWF0ZXJpYWxQcm9wZXJ0aWVzLm1vcnBoVGFyZ2V0cyAhPT0gbW9ycGhUYXJnZXRzICkgewoKCQkJCQluZWVkc1Byb2dyYW1DaGFuZ2UgPSB0cnVlOwoKCQkJCX0gZWxzZSBpZiAoIG1hdGVyaWFsUHJvcGVydGllcy5tb3JwaE5vcm1hbHMgIT09IG1vcnBoTm9ybWFscyApIHsKCgkJCQkJbmVlZHNQcm9ncmFtQ2hhbmdlID0gdHJ1ZTsKCgkJCQl9IGVsc2UgaWYgKCBtYXRlcmlhbFByb3BlcnRpZXMubW9ycGhDb2xvcnMgIT09IG1vcnBoQ29sb3JzICkgewoKCQkJCQluZWVkc1Byb2dyYW1DaGFuZ2UgPSB0cnVlOwoKCQkJCX0gZWxzZSBpZiAoIG1hdGVyaWFsUHJvcGVydGllcy50b25lTWFwcGluZyAhPT0gdG9uZU1hcHBpbmcgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfSBlbHNlIGlmICggY2FwYWJpbGl0aWVzLmlzV2ViR0wyID09PSB0cnVlICYmIG1hdGVyaWFsUHJvcGVydGllcy5tb3JwaFRhcmdldHNDb3VudCAhPT0gbW9ycGhUYXJnZXRzQ291bnQgKSB7CgoJCQkJCW5lZWRzUHJvZ3JhbUNoYW5nZSA9IHRydWU7CgoJCQkJfQoKCQkJfSBlbHNlIHsKCgkJCQluZWVkc1Byb2dyYW1DaGFuZ2UgPSB0cnVlOwoJCQkJbWF0ZXJpYWxQcm9wZXJ0aWVzLl9fdmVyc2lvbiA9IG1hdGVyaWFsLnZlcnNpb247CgoJCQl9CgoJCQkvLwoKCQkJbGV0IHByb2dyYW0gPSBtYXRlcmlhbFByb3BlcnRpZXMuY3VycmVudFByb2dyYW07CgoJCQlpZiAoIG5lZWRzUHJvZ3JhbUNoYW5nZSA9PT0gdHJ1ZSApIHsKCgkJCQlwcm9ncmFtID0gZ2V0UHJvZ3JhbSggbWF0ZXJpYWwsIHNjZW5lLCBvYmplY3QgKTsKCgkJCX0KCgkJCWxldCByZWZyZXNoUHJvZ3JhbSA9IGZhbHNlOwoJCQlsZXQgcmVmcmVzaE1hdGVyaWFsID0gZmFsc2U7CgkJCWxldCByZWZyZXNoTGlnaHRzID0gZmFsc2U7CgoJCQljb25zdCBwX3VuaWZvcm1zID0gcHJvZ3JhbS5nZXRVbmlmb3JtcygpLAoJCQkJbV91bmlmb3JtcyA9IG1hdGVyaWFsUHJvcGVydGllcy51bmlmb3JtczsKCgkJCWlmICggc3RhdGUudXNlUHJvZ3JhbSggcHJvZ3JhbS5wcm9ncmFtICkgKSB7CgoJCQkJcmVmcmVzaFByb2dyYW0gPSB0cnVlOwoJCQkJcmVmcmVzaE1hdGVyaWFsID0gdHJ1ZTsKCQkJCXJlZnJlc2hMaWdodHMgPSB0cnVlOwoKCQkJfQoKCQkJaWYgKCBtYXRlcmlhbC5pZCAhPT0gX2N1cnJlbnRNYXRlcmlhbElkICkgewoKCQkJCV9jdXJyZW50TWF0ZXJpYWxJZCA9IG1hdGVyaWFsLmlkOwoKCQkJCXJlZnJlc2hNYXRlcmlhbCA9IHRydWU7CgoJCQl9CgoJCQlpZiAoIHJlZnJlc2hQcm9ncmFtIHx8IF9jdXJyZW50Q2FtZXJhICE9PSBjYW1lcmEgKSB7CgoJCQkJLy8gY29tbW9uIGNhbWVyYSB1bmlmb3JtcwoKCQkJCXBfdW5pZm9ybXMuc2V0VmFsdWUoIF9nbCwgJ3Byb2plY3Rpb25NYXRyaXgnLCBjYW1lcmEucHJvamVjdGlvbk1hdHJpeCApOwoJCQkJcF91bmlmb3Jtcy5zZXRWYWx1ZSggX2dsLCAndmlld01hdHJpeCcsIGNhbWVyYS5tYXRyaXhXb3JsZEludmVyc2UgKTsKCgkJCQljb25zdCB1Q2FtUG9zID0gcF91bmlmb3Jtcy5tYXAuY2FtZXJhUG9zaXRpb247CgoJCQkJaWYgKCB1Q2FtUG9zICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJCXVDYW1Qb3Muc2V0VmFsdWUoIF9nbCwgX3ZlY3RvcjMuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCBjYW1lcmEubWF0cml4V29ybGQgKSApOwoKCQkJCX0KCgkJCQlpZiAoIGNhcGFiaWxpdGllcy5sb2dhcml0aG1pY0RlcHRoQnVmZmVyICkgewoKCQkJCQlwX3VuaWZvcm1zLnNldFZhbHVlKCBfZ2wsICdsb2dEZXB0aEJ1ZkZDJywKCQkJCQkJMi4wIC8gKCBNYXRoLmxvZyggY2FtZXJhLmZhciArIDEuMCApIC8gTWF0aC5MTjIgKSApOwoKCQkJCX0KCgkJCQkvLyBjb25zaWRlciBtb3ZpbmcgaXNPcnRob2dyYXBoaWMgdG8gVW5pZm9ybUxpYiBhbmQgV2ViR0xNYXRlcmlhbHMsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vbXJkb29iL3RocmVlLmpzL3B1bGwvMjY0NjcjaXNzdWVjb21tZW50LTE2NDUxODUwNjcKCgkJCQlpZiAoIG1hdGVyaWFsLmlzTWVzaFBob25nTWF0ZXJpYWwgfHwKCQkJCQltYXRlcmlhbC5pc01lc2hUb29uTWF0ZXJpYWwgfHwKCQkJCQltYXRlcmlhbC5pc01lc2hMYW1iZXJ0TWF0ZXJpYWwgfHwKCQkJCQltYXRlcmlhbC5pc01lc2hCYXNpY01hdGVyaWFsIHx8CgkJCQkJbWF0ZXJpYWwuaXNNZXNoU3RhbmRhcmRNYXRlcmlhbCB8fAoJCQkJCW1hdGVyaWFsLmlzU2hhZGVyTWF0ZXJpYWwgKSB7CgoJCQkJCXBfdW5pZm9ybXMuc2V0VmFsdWUoIF9nbCwgJ2lzT3J0aG9ncmFwaGljJywgY2FtZXJhLmlzT3J0aG9ncmFwaGljQ2FtZXJhID09PSB0cnVlICk7CgoJCQkJfQoKCQkJCWlmICggX2N1cnJlbnRDYW1lcmEgIT09IGNhbWVyYSApIHsKCgkJCQkJX2N1cnJlbnRDYW1lcmEgPSBjYW1lcmE7CgoJCQkJCS8vIGxpZ2h0aW5nIHVuaWZvcm1zIGRlcGVuZCBvbiB0aGUgY2FtZXJhIHNvIGVuZm9yY2UgYW4gdXBkYXRlCgkJCQkJLy8gbm93LCBpbiBjYXNlIHRoaXMgbWF0ZXJpYWwgc3VwcG9ydHMgbGlnaHRzIC0gb3IgbGF0ZXIsIHdoZW4KCQkJCQkvLyB0aGUgbmV4dCBtYXRlcmlhbCB0aGF0IGRvZXMgZ2V0cyBhY3RpdmF0ZWQ6CgoJCQkJCXJlZnJlc2hNYXRlcmlhbCA9IHRydWU7CQkvLyBzZXQgdG8gdHJ1ZSBvbiBtYXRlcmlhbCBjaGFuZ2UKCQkJCQlyZWZyZXNoTGlnaHRzID0gdHJ1ZTsJCS8vIHJlbWFpbnMgc2V0IHVudGlsIHVwZGF0ZSBkb25lCgoJCQkJfQoKCQkJfQoKCQkJLy8gc2tpbm5pbmcgYW5kIG1vcnBoIHRhcmdldCB1bmlmb3JtcyBtdXN0IGJlIHNldCBldmVuIGlmIG1hdGVyaWFsIGRpZG4ndCBjaGFuZ2UKCQkJLy8gYXV0by1zZXR0aW5nIG9mIHRleHR1cmUgdW5pdCBmb3IgYm9uZSBhbmQgbW9ycGggdGV4dHVyZSBtdXN0IGdvIGJlZm9yZSBvdGhlciB0ZXh0dXJlcwoJCQkvLyBvdGhlcndpc2UgdGV4dHVyZXMgdXNlZCBmb3Igc2tpbm5pbmcgYW5kIG1vcnBoaW5nIGNhbiB0YWtlIG92ZXIgdGV4dHVyZSB1bml0cyByZXNlcnZlZCBmb3Igb3RoZXIgbWF0ZXJpYWwgdGV4dHVyZXMKCgkJCWlmICggb2JqZWN0LmlzU2tpbm5lZE1lc2ggKSB7CgoJCQkJcF91bmlmb3Jtcy5zZXRPcHRpb25hbCggX2dsLCBvYmplY3QsICdiaW5kTWF0cml4JyApOwoJCQkJcF91bmlmb3Jtcy5zZXRPcHRpb25hbCggX2dsLCBvYmplY3QsICdiaW5kTWF0cml4SW52ZXJzZScgKTsKCgkJCQljb25zdCBza2VsZXRvbiA9IG9iamVjdC5za2VsZXRvbjsKCgkJCQlpZiAoIHNrZWxldG9uICkgewoKCQkJCQlpZiAoIGNhcGFiaWxpdGllcy5mbG9hdFZlcnRleFRleHR1cmVzICkgewoKCQkJCQkJaWYgKCBza2VsZXRvbi5ib25lVGV4dHVyZSA9PT0gbnVsbCApIHNrZWxldG9uLmNvbXB1dGVCb25lVGV4dHVyZSgpOwoKCQkJCQkJcF91bmlmb3Jtcy5zZXRWYWx1ZSggX2dsLCAnYm9uZVRleHR1cmUnLCBza2VsZXRvbi5ib25lVGV4dHVyZSwgdGV4dHVyZXMgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXI6IFNraW5uZWRNZXNoIGNhbiBvbmx5IGJlIHVzZWQgd2l0aCBXZWJHTCAyLiBXaXRoIFdlYkdMIDEgT0VTX3RleHR1cmVfZmxvYXQgYW5kIHZlcnRleCB0ZXh0dXJlcyBzdXBwb3J0IGlzIHJlcXVpcmVkLicgKTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJCWlmICggb2JqZWN0LmlzQmF0Y2hlZE1lc2ggKSB7CgoJCQkJcF91bmlmb3Jtcy5zZXRPcHRpb25hbCggX2dsLCBvYmplY3QsICdiYXRjaGluZ1RleHR1cmUnICk7CgkJCQlwX3VuaWZvcm1zLnNldFZhbHVlKCBfZ2wsICdiYXRjaGluZ1RleHR1cmUnLCBvYmplY3QuX21hdHJpY2VzVGV4dHVyZSwgdGV4dHVyZXMgKTsKCgkJCX0KCgkJCWNvbnN0IG1vcnBoQXR0cmlidXRlcyA9IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlczsKCgkJCWlmICggbW9ycGhBdHRyaWJ1dGVzLnBvc2l0aW9uICE9PSB1bmRlZmluZWQgfHwgbW9ycGhBdHRyaWJ1dGVzLm5vcm1hbCAhPT0gdW5kZWZpbmVkIHx8ICggbW9ycGhBdHRyaWJ1dGVzLmNvbG9yICE9PSB1bmRlZmluZWQgJiYgY2FwYWJpbGl0aWVzLmlzV2ViR0wyID09PSB0cnVlICkgKSB7CgoJCQkJbW9ycGh0YXJnZXRzLnVwZGF0ZSggb2JqZWN0LCBnZW9tZXRyeSwgcHJvZ3JhbSApOwoKCQkJfQoKCQkJaWYgKCByZWZyZXNoTWF0ZXJpYWwgfHwgbWF0ZXJpYWxQcm9wZXJ0aWVzLnJlY2VpdmVTaGFkb3cgIT09IG9iamVjdC5yZWNlaXZlU2hhZG93ICkgewoKCQkJCW1hdGVyaWFsUHJvcGVydGllcy5yZWNlaXZlU2hhZG93ID0gb2JqZWN0LnJlY2VpdmVTaGFkb3c7CgkJCQlwX3VuaWZvcm1zLnNldFZhbHVlKCBfZ2wsICdyZWNlaXZlU2hhZG93Jywgb2JqZWN0LnJlY2VpdmVTaGFkb3cgKTsKCgkJCX0KCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tcmRvb2IvdGhyZWUuanMvcHVsbC8yNDQ2NyNpc3N1ZWNvbW1lbnQtMTIwOTAzMTUxMgoKCQkJaWYgKCBtYXRlcmlhbC5pc01lc2hHb3VyYXVkTWF0ZXJpYWwgJiYgbWF0ZXJpYWwuZW52TWFwICE9PSBudWxsICkgewoKCQkJCW1fdW5pZm9ybXMuZW52TWFwLnZhbHVlID0gZW52TWFwOwoKCQkJCW1fdW5pZm9ybXMuZmxpcEVudk1hcC52YWx1ZSA9ICggZW52TWFwLmlzQ3ViZVRleHR1cmUgJiYgZW52TWFwLmlzUmVuZGVyVGFyZ2V0VGV4dHVyZSA9PT0gZmFsc2UgKSA/IC0gMSA6IDE7CgoJCQl9CgoJCQlpZiAoIHJlZnJlc2hNYXRlcmlhbCApIHsKCgkJCQlwX3VuaWZvcm1zLnNldFZhbHVlKCBfZ2wsICd0b25lTWFwcGluZ0V4cG9zdXJlJywgX3RoaXMudG9uZU1hcHBpbmdFeHBvc3VyZSApOwoKCQkJCWlmICggbWF0ZXJpYWxQcm9wZXJ0aWVzLm5lZWRzTGlnaHRzICkgewoKCQkJCQkvLyB0aGUgY3VycmVudCBtYXRlcmlhbCByZXF1aXJlcyBsaWdodGluZyBpbmZvCgoJCQkJCS8vIG5vdGU6IGFsbCBsaWdodGluZyB1bmlmb3JtcyBhcmUgYWx3YXlzIHNldCBjb3JyZWN0bHkKCQkJCQkvLyB0aGV5IHNpbXBseSByZWZlcmVuY2UgdGhlIHJlbmRlcmVyJ3Mgc3RhdGUgZm9yIHRoZWlyCgkJCQkJLy8gdmFsdWVzCgkJCQkJLy8KCQkJCQkvLyB1c2UgdGhlIGN1cnJlbnQgbWF0ZXJpYWwncyAubmVlZHNVcGRhdGUgZmxhZ3MgdG8gc2V0CgkJCQkJLy8gdGhlIEdMIHN0YXRlIHdoZW4gcmVxdWlyZWQKCgkJCQkJbWFya1VuaWZvcm1zTGlnaHRzTmVlZHNVcGRhdGUoIG1fdW5pZm9ybXMsIHJlZnJlc2hMaWdodHMgKTsKCgkJCQl9CgoJCQkJLy8gcmVmcmVzaCB1bmlmb3JtcyBjb21tb24gdG8gc2V2ZXJhbCBtYXRlcmlhbHMKCgkJCQlpZiAoIGZvZyAmJiBtYXRlcmlhbC5mb2cgPT09IHRydWUgKSB7CgoJCQkJCW1hdGVyaWFscy5yZWZyZXNoRm9nVW5pZm9ybXMoIG1fdW5pZm9ybXMsIGZvZyApOwoKCQkJCX0KCgkJCQltYXRlcmlhbHMucmVmcmVzaE1hdGVyaWFsVW5pZm9ybXMoIG1fdW5pZm9ybXMsIG1hdGVyaWFsLCBfcGl4ZWxSYXRpbywgX2hlaWdodCwgX3RyYW5zbWlzc2lvblJlbmRlclRhcmdldCApOwoKCQkJCVdlYkdMVW5pZm9ybXMudXBsb2FkKCBfZ2wsIGdldFVuaWZvcm1MaXN0KCBtYXRlcmlhbFByb3BlcnRpZXMgKSwgbV91bmlmb3JtcywgdGV4dHVyZXMgKTsKCgkJCX0KCgkJCWlmICggbWF0ZXJpYWwuaXNTaGFkZXJNYXRlcmlhbCAmJiBtYXRlcmlhbC51bmlmb3Jtc05lZWRVcGRhdGUgPT09IHRydWUgKSB7CgoJCQkJV2ViR0xVbmlmb3Jtcy51cGxvYWQoIF9nbCwgZ2V0VW5pZm9ybUxpc3QoIG1hdGVyaWFsUHJvcGVydGllcyApLCBtX3VuaWZvcm1zLCB0ZXh0dXJlcyApOwoJCQkJbWF0ZXJpYWwudW5pZm9ybXNOZWVkVXBkYXRlID0gZmFsc2U7CgoJCQl9CgoJCQlpZiAoIG1hdGVyaWFsLmlzU3ByaXRlTWF0ZXJpYWwgKSB7CgoJCQkJcF91bmlmb3Jtcy5zZXRWYWx1ZSggX2dsLCAnY2VudGVyJywgb2JqZWN0LmNlbnRlciApOwoKCQkJfQoKCQkJLy8gY29tbW9uIG1hdHJpY2VzCgoJCQlwX3VuaWZvcm1zLnNldFZhbHVlKCBfZ2wsICdtb2RlbFZpZXdNYXRyaXgnLCBvYmplY3QubW9kZWxWaWV3TWF0cml4ICk7CgkJCXBfdW5pZm9ybXMuc2V0VmFsdWUoIF9nbCwgJ25vcm1hbE1hdHJpeCcsIG9iamVjdC5ub3JtYWxNYXRyaXggKTsKCQkJcF91bmlmb3Jtcy5zZXRWYWx1ZSggX2dsLCAnbW9kZWxNYXRyaXgnLCBvYmplY3QubWF0cml4V29ybGQgKTsKCgkJCS8vIFVCT3MKCgkJCWlmICggbWF0ZXJpYWwuaXNTaGFkZXJNYXRlcmlhbCB8fCBtYXRlcmlhbC5pc1Jhd1NoYWRlck1hdGVyaWFsICkgewoKCQkJCWNvbnN0IGdyb3VwcyA9IG1hdGVyaWFsLnVuaWZvcm1zR3JvdXBzOwoKCQkJCWZvciAoIGxldCBpID0gMCwgbCA9IGdyb3Vwcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCQlpZiAoIGNhcGFiaWxpdGllcy5pc1dlYkdMMiApIHsKCgkJCQkJCWNvbnN0IGdyb3VwID0gZ3JvdXBzWyBpIF07CgoJCQkJCQl1bmlmb3Jtc0dyb3Vwcy51cGRhdGUoIGdyb3VwLCBwcm9ncmFtICk7CgkJCQkJCXVuaWZvcm1zR3JvdXBzLmJpbmQoIGdyb3VwLCBwcm9ncmFtICk7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQljb25zb2xlLndhcm4oICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBVbmlmb3JtIEJ1ZmZlciBPYmplY3RzIGNhbiBvbmx5IGJlIHVzZWQgd2l0aCBXZWJHTCAyLicgKTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJCXJldHVybiBwcm9ncmFtOwoKCQl9CgoJCS8vIElmIHVuaWZvcm1zIGFyZSBtYXJrZWQgYXMgY2xlYW4sIHRoZXkgZG9uJ3QgbmVlZCB0byBiZSBsb2FkZWQgdG8gdGhlIEdQVS4KCgkJZnVuY3Rpb24gbWFya1VuaWZvcm1zTGlnaHRzTmVlZHNVcGRhdGUoIHVuaWZvcm1zLCB2YWx1ZSApIHsKCgkJCXVuaWZvcm1zLmFtYmllbnRMaWdodENvbG9yLm5lZWRzVXBkYXRlID0gdmFsdWU7CgkJCXVuaWZvcm1zLmxpZ2h0UHJvYmUubmVlZHNVcGRhdGUgPSB2YWx1ZTsKCgkJCXVuaWZvcm1zLmRpcmVjdGlvbmFsTGlnaHRzLm5lZWRzVXBkYXRlID0gdmFsdWU7CgkJCXVuaWZvcm1zLmRpcmVjdGlvbmFsTGlnaHRTaGFkb3dzLm5lZWRzVXBkYXRlID0gdmFsdWU7CgkJCXVuaWZvcm1zLnBvaW50TGlnaHRzLm5lZWRzVXBkYXRlID0gdmFsdWU7CgkJCXVuaWZvcm1zLnBvaW50TGlnaHRTaGFkb3dzLm5lZWRzVXBkYXRlID0gdmFsdWU7CgkJCXVuaWZvcm1zLnNwb3RMaWdodHMubmVlZHNVcGRhdGUgPSB2YWx1ZTsKCQkJdW5pZm9ybXMuc3BvdExpZ2h0U2hhZG93cy5uZWVkc1VwZGF0ZSA9IHZhbHVlOwoJCQl1bmlmb3Jtcy5yZWN0QXJlYUxpZ2h0cy5uZWVkc1VwZGF0ZSA9IHZhbHVlOwoJCQl1bmlmb3Jtcy5oZW1pc3BoZXJlTGlnaHRzLm5lZWRzVXBkYXRlID0gdmFsdWU7CgoJCX0KCgkJZnVuY3Rpb24gbWF0ZXJpYWxOZWVkc0xpZ2h0cyggbWF0ZXJpYWwgKSB7CgoJCQlyZXR1cm4gbWF0ZXJpYWwuaXNNZXNoTGFtYmVydE1hdGVyaWFsIHx8IG1hdGVyaWFsLmlzTWVzaFRvb25NYXRlcmlhbCB8fCBtYXRlcmlhbC5pc01lc2hQaG9uZ01hdGVyaWFsIHx8CgkJCQltYXRlcmlhbC5pc01lc2hTdGFuZGFyZE1hdGVyaWFsIHx8IG1hdGVyaWFsLmlzU2hhZG93TWF0ZXJpYWwgfHwKCQkJCSggbWF0ZXJpYWwuaXNTaGFkZXJNYXRlcmlhbCAmJiBtYXRlcmlhbC5saWdodHMgPT09IHRydWUgKTsKCgkJfQoKCQl0aGlzLmdldEFjdGl2ZUN1YmVGYWNlID0gZnVuY3Rpb24gKCkgewoKCQkJcmV0dXJuIF9jdXJyZW50QWN0aXZlQ3ViZUZhY2U7CgoJCX07CgoJCXRoaXMuZ2V0QWN0aXZlTWlwbWFwTGV2ZWwgPSBmdW5jdGlvbiAoKSB7CgoJCQlyZXR1cm4gX2N1cnJlbnRBY3RpdmVNaXBtYXBMZXZlbDsKCgkJfTsKCgkJdGhpcy5nZXRSZW5kZXJUYXJnZXQgPSBmdW5jdGlvbiAoKSB7CgoJCQlyZXR1cm4gX2N1cnJlbnRSZW5kZXJUYXJnZXQ7CgoJCX07CgoJCXRoaXMuc2V0UmVuZGVyVGFyZ2V0VGV4dHVyZXMgPSBmdW5jdGlvbiAoIHJlbmRlclRhcmdldCwgY29sb3JUZXh0dXJlLCBkZXB0aFRleHR1cmUgKSB7CgoJCQlwcm9wZXJ0aWVzLmdldCggcmVuZGVyVGFyZ2V0LnRleHR1cmUgKS5fX3dlYmdsVGV4dHVyZSA9IGNvbG9yVGV4dHVyZTsKCQkJcHJvcGVydGllcy5nZXQoIHJlbmRlclRhcmdldC5kZXB0aFRleHR1cmUgKS5fX3dlYmdsVGV4dHVyZSA9IGRlcHRoVGV4dHVyZTsKCgkJCWNvbnN0IHJlbmRlclRhcmdldFByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggcmVuZGVyVGFyZ2V0ICk7CgkJCXJlbmRlclRhcmdldFByb3BlcnRpZXMuX19oYXNFeHRlcm5hbFRleHR1cmVzID0gdHJ1ZTsKCgkJCWlmICggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX2hhc0V4dGVybmFsVGV4dHVyZXMgKSB7CgoJCQkJcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX2F1dG9BbGxvY2F0ZURlcHRoQnVmZmVyID0gZGVwdGhUZXh0dXJlID09PSB1bmRlZmluZWQ7CgoJCQkJaWYgKCAhIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX19hdXRvQWxsb2NhdGVEZXB0aEJ1ZmZlciApIHsKCgkJCQkJLy8gVGhlIG11bHRpc2FtcGxlX3JlbmRlcl90b190ZXh0dXJlIGV4dGVuc2lvbiBkb2Vzbid0IHdvcmsgcHJvcGVybHkgaWYgdGhlcmUKCQkJCQkvLyBhcmUgbWlkZnJhbWUgZmx1c2hlcyBhbmQgYW4gZXh0ZXJuYWwgZGVwdGggYnVmZmVyLiBEaXNhYmxlIHVzZSBvZiB0aGUgZXh0ZW5zaW9uLgoJCQkJCWlmICggZXh0ZW5zaW9ucy5oYXMoICdXRUJHTF9tdWx0aXNhbXBsZWRfcmVuZGVyX3RvX3RleHR1cmUnICkgPT09IHRydWUgKSB7CgoJCQkJCQljb25zb2xlLndhcm4oICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBSZW5kZXItdG8tdGV4dHVyZSBleHRlbnNpb24gd2FzIGRpc2FibGVkIGJlY2F1c2UgYW4gZXh0ZXJuYWwgdGV4dHVyZSB3YXMgcHJvdmlkZWQnICk7CgkJCQkJCXJlbmRlclRhcmdldFByb3BlcnRpZXMuX191c2VSZW5kZXJUb1RleHR1cmUgPSBmYWxzZTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJfTsKCgkJdGhpcy5zZXRSZW5kZXJUYXJnZXRGcmFtZWJ1ZmZlciA9IGZ1bmN0aW9uICggcmVuZGVyVGFyZ2V0LCBkZWZhdWx0RnJhbWVidWZmZXIgKSB7CgoJCQljb25zdCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIHJlbmRlclRhcmdldCApOwoJCQlyZW5kZXJUYXJnZXRQcm9wZXJ0aWVzLl9fd2ViZ2xGcmFtZWJ1ZmZlciA9IGRlZmF1bHRGcmFtZWJ1ZmZlcjsKCQkJcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3VzZURlZmF1bHRGcmFtZWJ1ZmZlciA9IGRlZmF1bHRGcmFtZWJ1ZmZlciA9PT0gdW5kZWZpbmVkOwoKCQl9OwoKCQl0aGlzLnNldFJlbmRlclRhcmdldCA9IGZ1bmN0aW9uICggcmVuZGVyVGFyZ2V0LCBhY3RpdmVDdWJlRmFjZSA9IDAsIGFjdGl2ZU1pcG1hcExldmVsID0gMCApIHsKCgkJCV9jdXJyZW50UmVuZGVyVGFyZ2V0ID0gcmVuZGVyVGFyZ2V0OwoJCQlfY3VycmVudEFjdGl2ZUN1YmVGYWNlID0gYWN0aXZlQ3ViZUZhY2U7CgkJCV9jdXJyZW50QWN0aXZlTWlwbWFwTGV2ZWwgPSBhY3RpdmVNaXBtYXBMZXZlbDsKCgkJCWxldCB1c2VEZWZhdWx0RnJhbWVidWZmZXIgPSB0cnVlOwoJCQlsZXQgZnJhbWVidWZmZXIgPSBudWxsOwoJCQlsZXQgaXNDdWJlID0gZmFsc2U7CgkJCWxldCBpc1JlbmRlclRhcmdldDNEID0gZmFsc2U7CgoJCQlpZiAoIHJlbmRlclRhcmdldCApIHsKCgkJCQljb25zdCByZW5kZXJUYXJnZXRQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIHJlbmRlclRhcmdldCApOwoKCQkJCWlmICggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3VzZURlZmF1bHRGcmFtZWJ1ZmZlciAhPT0gdW5kZWZpbmVkICkgewoKCQkJCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0byByZWJpbmQgdGhlIGZyYW1lYnVmZmVyLgoJCQkJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkZSQU1FQlVGRkVSLCBudWxsICk7CgkJCQkJdXNlRGVmYXVsdEZyYW1lYnVmZmVyID0gZmFsc2U7CgoJCQkJfSBlbHNlIGlmICggcmVuZGVyVGFyZ2V0UHJvcGVydGllcy5fX3dlYmdsRnJhbWVidWZmZXIgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkJdGV4dHVyZXMuc2V0dXBSZW5kZXJUYXJnZXQoIHJlbmRlclRhcmdldCApOwoKCQkJCX0gZWxzZSBpZiAoIHJlbmRlclRhcmdldFByb3BlcnRpZXMuX19oYXNFeHRlcm5hbFRleHR1cmVzICkgewoKCQkJCQkvLyBDb2xvciBhbmQgZGVwdGggdGV4dHVyZSBtdXN0IGJlIHJlYm91bmQgaW4gb3JkZXIgZm9yIHRoZSBzd2FwY2hhaW4gdG8gdXBkYXRlLgoJCQkJCXRleHR1cmVzLnJlYmluZFRleHR1cmVzKCByZW5kZXJUYXJnZXQsIHByb3BlcnRpZXMuZ2V0KCByZW5kZXJUYXJnZXQudGV4dHVyZSApLl9fd2ViZ2xUZXh0dXJlLCBwcm9wZXJ0aWVzLmdldCggcmVuZGVyVGFyZ2V0LmRlcHRoVGV4dHVyZSApLl9fd2ViZ2xUZXh0dXJlICk7CgoJCQkJfQoKCQkJCWNvbnN0IHRleHR1cmUgPSByZW5kZXJUYXJnZXQudGV4dHVyZTsKCgkJCQlpZiAoIHRleHR1cmUuaXNEYXRhM0RUZXh0dXJlIHx8IHRleHR1cmUuaXNEYXRhQXJyYXlUZXh0dXJlIHx8IHRleHR1cmUuaXNDb21wcmVzc2VkQXJyYXlUZXh0dXJlICkgewoKCQkJCQlpc1JlbmRlclRhcmdldDNEID0gdHJ1ZTsKCgkJCQl9CgoJCQkJY29uc3QgX193ZWJnbEZyYW1lYnVmZmVyID0gcHJvcGVydGllcy5nZXQoIHJlbmRlclRhcmdldCApLl9fd2ViZ2xGcmFtZWJ1ZmZlcjsKCgkJCQlpZiAoIHJlbmRlclRhcmdldC5pc1dlYkdMQ3ViZVJlbmRlclRhcmdldCApIHsKCgkJCQkJaWYgKCBBcnJheS5pc0FycmF5KCBfX3dlYmdsRnJhbWVidWZmZXJbIGFjdGl2ZUN1YmVGYWNlIF0gKSApIHsKCgkJCQkJCWZyYW1lYnVmZmVyID0gX193ZWJnbEZyYW1lYnVmZmVyWyBhY3RpdmVDdWJlRmFjZSBdWyBhY3RpdmVNaXBtYXBMZXZlbCBdOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJZnJhbWVidWZmZXIgPSBfX3dlYmdsRnJhbWVidWZmZXJbIGFjdGl2ZUN1YmVGYWNlIF07CgoJCQkJCX0KCgkJCQkJaXNDdWJlID0gdHJ1ZTsKCgkJCQl9IGVsc2UgaWYgKCAoIGNhcGFiaWxpdGllcy5pc1dlYkdMMiAmJiByZW5kZXJUYXJnZXQuc2FtcGxlcyA+IDAgKSAmJiB0ZXh0dXJlcy51c2VNdWx0aXNhbXBsZWRSVFQoIHJlbmRlclRhcmdldCApID09PSBmYWxzZSApIHsKCgkJCQkJZnJhbWVidWZmZXIgPSBwcm9wZXJ0aWVzLmdldCggcmVuZGVyVGFyZ2V0ICkuX193ZWJnbE11bHRpc2FtcGxlZEZyYW1lYnVmZmVyOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggQXJyYXkuaXNBcnJheSggX193ZWJnbEZyYW1lYnVmZmVyICkgKSB7CgoJCQkJCQlmcmFtZWJ1ZmZlciA9IF9fd2ViZ2xGcmFtZWJ1ZmZlclsgYWN0aXZlTWlwbWFwTGV2ZWwgXTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCWZyYW1lYnVmZmVyID0gX193ZWJnbEZyYW1lYnVmZmVyOwoKCQkJCQl9CgoJCQkJfQoKCQkJCV9jdXJyZW50Vmlld3BvcnQuY29weSggcmVuZGVyVGFyZ2V0LnZpZXdwb3J0ICk7CgkJCQlfY3VycmVudFNjaXNzb3IuY29weSggcmVuZGVyVGFyZ2V0LnNjaXNzb3IgKTsKCQkJCV9jdXJyZW50U2Npc3NvclRlc3QgPSByZW5kZXJUYXJnZXQuc2Npc3NvclRlc3Q7CgoJCQl9IGVsc2UgewoKCQkJCV9jdXJyZW50Vmlld3BvcnQuY29weSggX3ZpZXdwb3J0ICkubXVsdGlwbHlTY2FsYXIoIF9waXhlbFJhdGlvICkuZmxvb3IoKTsKCQkJCV9jdXJyZW50U2Npc3Nvci5jb3B5KCBfc2Npc3NvciApLm11bHRpcGx5U2NhbGFyKCBfcGl4ZWxSYXRpbyApLmZsb29yKCk7CgkJCQlfY3VycmVudFNjaXNzb3JUZXN0ID0gX3NjaXNzb3JUZXN0OwoKCQkJfQoKCQkJY29uc3QgZnJhbWVidWZmZXJCb3VuZCA9IHN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkZSQU1FQlVGRkVSLCBmcmFtZWJ1ZmZlciApOwoKCQkJaWYgKCBmcmFtZWJ1ZmZlckJvdW5kICYmIGNhcGFiaWxpdGllcy5kcmF3QnVmZmVycyAmJiB1c2VEZWZhdWx0RnJhbWVidWZmZXIgKSB7CgoJCQkJc3RhdGUuZHJhd0J1ZmZlcnMoIHJlbmRlclRhcmdldCwgZnJhbWVidWZmZXIgKTsKCgkJCX0KCgkJCXN0YXRlLnZpZXdwb3J0KCBfY3VycmVudFZpZXdwb3J0ICk7CgkJCXN0YXRlLnNjaXNzb3IoIF9jdXJyZW50U2Npc3NvciApOwoJCQlzdGF0ZS5zZXRTY2lzc29yVGVzdCggX2N1cnJlbnRTY2lzc29yVGVzdCApOwoKCQkJaWYgKCBpc0N1YmUgKSB7CgoJCQkJY29uc3QgdGV4dHVyZVByb3BlcnRpZXMgPSBwcm9wZXJ0aWVzLmdldCggcmVuZGVyVGFyZ2V0LnRleHR1cmUgKTsKCQkJCV9nbC5mcmFtZWJ1ZmZlclRleHR1cmUyRCggX2dsLkZSQU1FQlVGRkVSLCBfZ2wuQ09MT1JfQVRUQUNITUVOVDAsIF9nbC5URVhUVVJFX0NVQkVfTUFQX1BPU0lUSVZFX1ggKyBhY3RpdmVDdWJlRmFjZSwgdGV4dHVyZVByb3BlcnRpZXMuX193ZWJnbFRleHR1cmUsIGFjdGl2ZU1pcG1hcExldmVsICk7CgoJCQl9IGVsc2UgaWYgKCBpc1JlbmRlclRhcmdldDNEICkgewoKCQkJCWNvbnN0IHRleHR1cmVQcm9wZXJ0aWVzID0gcHJvcGVydGllcy5nZXQoIHJlbmRlclRhcmdldC50ZXh0dXJlICk7CgkJCQljb25zdCBsYXllciA9IGFjdGl2ZUN1YmVGYWNlIHx8IDA7CgkJCQlfZ2wuZnJhbWVidWZmZXJUZXh0dXJlTGF5ZXIoIF9nbC5GUkFNRUJVRkZFUiwgX2dsLkNPTE9SX0FUVEFDSE1FTlQwLCB0ZXh0dXJlUHJvcGVydGllcy5fX3dlYmdsVGV4dHVyZSwgYWN0aXZlTWlwbWFwTGV2ZWwgfHwgMCwgbGF5ZXIgKTsKCgkJCX0KCgkJCV9jdXJyZW50TWF0ZXJpYWxJZCA9IC0gMTsgLy8gcmVzZXQgY3VycmVudCBtYXRlcmlhbCB0byBlbnN1cmUgY29ycmVjdCB1bmlmb3JtIGJpbmRpbmdzCgoJCX07CgoJCXRoaXMucmVhZFJlbmRlclRhcmdldFBpeGVscyA9IGZ1bmN0aW9uICggcmVuZGVyVGFyZ2V0LCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBidWZmZXIsIGFjdGl2ZUN1YmVGYWNlSW5kZXggKSB7CgoJCQlpZiAoICEgKCByZW5kZXJUYXJnZXQgJiYgcmVuZGVyVGFyZ2V0LmlzV2ViR0xSZW5kZXJUYXJnZXQgKSApIHsKCgkJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuV2ViR0xSZW5kZXJlci5yZWFkUmVuZGVyVGFyZ2V0UGl4ZWxzOiByZW5kZXJUYXJnZXQgaXMgbm90IFRIUkVFLldlYkdMUmVuZGVyVGFyZ2V0LicgKTsKCQkJCXJldHVybjsKCgkJCX0KCgkJCWxldCBmcmFtZWJ1ZmZlciA9IHByb3BlcnRpZXMuZ2V0KCByZW5kZXJUYXJnZXQgKS5fX3dlYmdsRnJhbWVidWZmZXI7CgoJCQlpZiAoIHJlbmRlclRhcmdldC5pc1dlYkdMQ3ViZVJlbmRlclRhcmdldCAmJiBhY3RpdmVDdWJlRmFjZUluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJZnJhbWVidWZmZXIgPSBmcmFtZWJ1ZmZlclsgYWN0aXZlQ3ViZUZhY2VJbmRleCBdOwoKCQkJfQoKCQkJaWYgKCBmcmFtZWJ1ZmZlciApIHsKCgkJCQlzdGF0ZS5iaW5kRnJhbWVidWZmZXIoIF9nbC5GUkFNRUJVRkZFUiwgZnJhbWVidWZmZXIgKTsKCgkJCQl0cnkgewoKCQkJCQljb25zdCB0ZXh0dXJlID0gcmVuZGVyVGFyZ2V0LnRleHR1cmU7CgkJCQkJY29uc3QgdGV4dHVyZUZvcm1hdCA9IHRleHR1cmUuZm9ybWF0OwoJCQkJCWNvbnN0IHRleHR1cmVUeXBlID0gdGV4dHVyZS50eXBlOwoKCQkJCQlpZiAoIHRleHR1cmVGb3JtYXQgIT09IFJHQkFGb3JtYXQgJiYgdXRpbHMuY29udmVydCggdGV4dHVyZUZvcm1hdCApICE9PSBfZ2wuZ2V0UGFyYW1ldGVyKCBfZ2wuSU1QTEVNRU5UQVRJT05fQ09MT1JfUkVBRF9GT1JNQVQgKSApIHsKCgkJCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFJlbmRlcmVyLnJlYWRSZW5kZXJUYXJnZXRQaXhlbHM6IHJlbmRlclRhcmdldCBpcyBub3QgaW4gUkdCQSBvciBpbXBsZW1lbnRhdGlvbiBkZWZpbmVkIGZvcm1hdC4nICk7CgkJCQkJCXJldHVybjsKCgkJCQkJfQoKCQkJCQljb25zdCBoYWxmRmxvYXRTdXBwb3J0ZWRCeUV4dCA9ICggdGV4dHVyZVR5cGUgPT09IEhhbGZGbG9hdFR5cGUgKSAmJiAoIGV4dGVuc2lvbnMuaGFzKCAnRVhUX2NvbG9yX2J1ZmZlcl9oYWxmX2Zsb2F0JyApIHx8ICggY2FwYWJpbGl0aWVzLmlzV2ViR0wyICYmIGV4dGVuc2lvbnMuaGFzKCAnRVhUX2NvbG9yX2J1ZmZlcl9mbG9hdCcgKSApICk7CgoJCQkJCWlmICggdGV4dHVyZVR5cGUgIT09IFVuc2lnbmVkQnl0ZVR5cGUgJiYgdXRpbHMuY29udmVydCggdGV4dHVyZVR5cGUgKSAhPT0gX2dsLmdldFBhcmFtZXRlciggX2dsLklNUExFTUVOVEFUSU9OX0NPTE9SX1JFQURfVFlQRSApICYmIC8vIEVkZ2UgYW5kIENocm9tZSBNYWMgPCA1MiAoIzk1MTMpCgkJCQkJCSEgKCB0ZXh0dXJlVHlwZSA9PT0gRmxvYXRUeXBlICYmICggY2FwYWJpbGl0aWVzLmlzV2ViR0wyIHx8IGV4dGVuc2lvbnMuaGFzKCAnT0VTX3RleHR1cmVfZmxvYXQnICkgfHwgZXh0ZW5zaW9ucy5oYXMoICdXRUJHTF9jb2xvcl9idWZmZXJfZmxvYXQnICkgKSApICYmIC8vIENocm9tZSBNYWMgPj0gNTIgYW5kIEZpcmVmb3gKCQkJCQkJISBoYWxmRmxvYXRTdXBwb3J0ZWRCeUV4dCApIHsKCgkJCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5XZWJHTFJlbmRlcmVyLnJlYWRSZW5kZXJUYXJnZXRQaXhlbHM6IHJlbmRlclRhcmdldCBpcyBub3QgaW4gVW5zaWduZWRCeXRlVHlwZSBvciBpbXBsZW1lbnRhdGlvbiBkZWZpbmVkIHR5cGUuJyApOwoJCQkJCQlyZXR1cm47CgoJCQkJCX0KCgkJCQkJLy8gdGhlIGZvbGxvd2luZyBpZiBzdGF0ZW1lbnQgZW5zdXJlcyB2YWxpZCByZWFkIHJlcXVlc3RzIChubyBvdXQtb2YtYm91bmRzIHBpeGVscywgc2VlICM4NjA0KQoKCQkJCQlpZiAoICggeCA+PSAwICYmIHggPD0gKCByZW5kZXJUYXJnZXQud2lkdGggLSB3aWR0aCApICkgJiYgKCB5ID49IDAgJiYgeSA8PSAoIHJlbmRlclRhcmdldC5oZWlnaHQgLSBoZWlnaHQgKSApICkgewoKCQkJCQkJX2dsLnJlYWRQaXhlbHMoIHgsIHksIHdpZHRoLCBoZWlnaHQsIHV0aWxzLmNvbnZlcnQoIHRleHR1cmVGb3JtYXQgKSwgdXRpbHMuY29udmVydCggdGV4dHVyZVR5cGUgKSwgYnVmZmVyICk7CgoJCQkJCX0KCgkJCQl9IGZpbmFsbHkgewoKCQkJCQkvLyByZXN0b3JlIGZyYW1lYnVmZmVyIG9mIGN1cnJlbnQgcmVuZGVyIHRhcmdldCBpZiBuZWNlc3NhcnkKCgkJCQkJY29uc3QgZnJhbWVidWZmZXIgPSAoIF9jdXJyZW50UmVuZGVyVGFyZ2V0ICE9PSBudWxsICkgPyBwcm9wZXJ0aWVzLmdldCggX2N1cnJlbnRSZW5kZXJUYXJnZXQgKS5fX3dlYmdsRnJhbWVidWZmZXIgOiBudWxsOwoJCQkJCXN0YXRlLmJpbmRGcmFtZWJ1ZmZlciggX2dsLkZSQU1FQlVGRkVSLCBmcmFtZWJ1ZmZlciApOwoKCQkJCX0KCgkJCX0KCgkJfTsKCgkJdGhpcy5jb3B5RnJhbWVidWZmZXJUb1RleHR1cmUgPSBmdW5jdGlvbiAoIHBvc2l0aW9uLCB0ZXh0dXJlLCBsZXZlbCA9IDAgKSB7CgoJCQljb25zdCBsZXZlbFNjYWxlID0gTWF0aC5wb3coIDIsIC0gbGV2ZWwgKTsKCQkJY29uc3Qgd2lkdGggPSBNYXRoLmZsb29yKCB0ZXh0dXJlLmltYWdlLndpZHRoICogbGV2ZWxTY2FsZSApOwoJCQljb25zdCBoZWlnaHQgPSBNYXRoLmZsb29yKCB0ZXh0dXJlLmltYWdlLmhlaWdodCAqIGxldmVsU2NhbGUgKTsKCgkJCXRleHR1cmVzLnNldFRleHR1cmUyRCggdGV4dHVyZSwgMCApOwoKCQkJX2dsLmNvcHlUZXhTdWJJbWFnZTJEKCBfZ2wuVEVYVFVSRV8yRCwgbGV2ZWwsIDAsIDAsIHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIHdpZHRoLCBoZWlnaHQgKTsKCgkJCXN0YXRlLnVuYmluZFRleHR1cmUoKTsKCgkJfTsKCgkJdGhpcy5jb3B5VGV4dHVyZVRvVGV4dHVyZSA9IGZ1bmN0aW9uICggcG9zaXRpb24sIHNyY1RleHR1cmUsIGRzdFRleHR1cmUsIGxldmVsID0gMCApIHsKCgkJCWNvbnN0IHdpZHRoID0gc3JjVGV4dHVyZS5pbWFnZS53aWR0aDsKCQkJY29uc3QgaGVpZ2h0ID0gc3JjVGV4dHVyZS5pbWFnZS5oZWlnaHQ7CgkJCWNvbnN0IGdsRm9ybWF0ID0gdXRpbHMuY29udmVydCggZHN0VGV4dHVyZS5mb3JtYXQgKTsKCQkJY29uc3QgZ2xUeXBlID0gdXRpbHMuY29udmVydCggZHN0VGV4dHVyZS50eXBlICk7CgoJCQl0ZXh0dXJlcy5zZXRUZXh0dXJlMkQoIGRzdFRleHR1cmUsIDAgKTsKCgkJCS8vIEFzIGFub3RoZXIgdGV4dHVyZSB1cGxvYWQgbWF5IGhhdmUgY2hhbmdlZCBwaXhlbFN0b3JlaQoJCQkvLyBwYXJhbWV0ZXJzLCBtYWtlIHN1cmUgdGhleSBhcmUgY29ycmVjdCBmb3IgdGhlIGRzdFRleHR1cmUKCQkJX2dsLnBpeGVsU3RvcmVpKCBfZ2wuVU5QQUNLX0ZMSVBfWV9XRUJHTCwgZHN0VGV4dHVyZS5mbGlwWSApOwoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfUFJFTVVMVElQTFlfQUxQSEFfV0VCR0wsIGRzdFRleHR1cmUucHJlbXVsdGlwbHlBbHBoYSApOwoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfQUxJR05NRU5ULCBkc3RUZXh0dXJlLnVucGFja0FsaWdubWVudCApOwoKCQkJaWYgKCBzcmNUZXh0dXJlLmlzRGF0YVRleHR1cmUgKSB7CgoJCQkJX2dsLnRleFN1YkltYWdlMkQoIF9nbC5URVhUVVJFXzJELCBsZXZlbCwgcG9zaXRpb24ueCwgcG9zaXRpb24ueSwgd2lkdGgsIGhlaWdodCwgZ2xGb3JtYXQsIGdsVHlwZSwgc3JjVGV4dHVyZS5pbWFnZS5kYXRhICk7CgoJCQl9IGVsc2UgewoKCQkJCWlmICggc3JjVGV4dHVyZS5pc0NvbXByZXNzZWRUZXh0dXJlICkgewoKCQkJCQlfZ2wuY29tcHJlc3NlZFRleFN1YkltYWdlMkQoIF9nbC5URVhUVVJFXzJELCBsZXZlbCwgcG9zaXRpb24ueCwgcG9zaXRpb24ueSwgc3JjVGV4dHVyZS5taXBtYXBzWyAwIF0ud2lkdGgsIHNyY1RleHR1cmUubWlwbWFwc1sgMCBdLmhlaWdodCwgZ2xGb3JtYXQsIHNyY1RleHR1cmUubWlwbWFwc1sgMCBdLmRhdGEgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlfZ2wudGV4U3ViSW1hZ2UyRCggX2dsLlRFWFRVUkVfMkQsIGxldmVsLCBwb3NpdGlvbi54LCBwb3NpdGlvbi55LCBnbEZvcm1hdCwgZ2xUeXBlLCBzcmNUZXh0dXJlLmltYWdlICk7CgoJCQkJfQoKCQkJfQoKCQkJLy8gR2VuZXJhdGUgbWlwbWFwcyBvbmx5IHdoZW4gY29weWluZyBsZXZlbCAwCgkJCWlmICggbGV2ZWwgPT09IDAgJiYgZHN0VGV4dHVyZS5nZW5lcmF0ZU1pcG1hcHMgKSBfZ2wuZ2VuZXJhdGVNaXBtYXAoIF9nbC5URVhUVVJFXzJEICk7CgoJCQlzdGF0ZS51bmJpbmRUZXh0dXJlKCk7CgoJCX07CgoJCXRoaXMuY29weVRleHR1cmVUb1RleHR1cmUzRCA9IGZ1bmN0aW9uICggc291cmNlQm94LCBwb3NpdGlvbiwgc3JjVGV4dHVyZSwgZHN0VGV4dHVyZSwgbGV2ZWwgPSAwICkgewoKCQkJaWYgKCBfdGhpcy5pc1dlYkdMMVJlbmRlcmVyICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLldlYkdMUmVuZGVyZXIuY29weVRleHR1cmVUb1RleHR1cmUzRDogY2FuIG9ubHkgYmUgdXNlZCB3aXRoIFdlYkdMMi4nICk7CgkJCQlyZXR1cm47CgoJCQl9CgoJCQljb25zdCB3aWR0aCA9IHNvdXJjZUJveC5tYXgueCAtIHNvdXJjZUJveC5taW4ueCArIDE7CgkJCWNvbnN0IGhlaWdodCA9IHNvdXJjZUJveC5tYXgueSAtIHNvdXJjZUJveC5taW4ueSArIDE7CgkJCWNvbnN0IGRlcHRoID0gc291cmNlQm94Lm1heC56IC0gc291cmNlQm94Lm1pbi56ICsgMTsKCQkJY29uc3QgZ2xGb3JtYXQgPSB1dGlscy5jb252ZXJ0KCBkc3RUZXh0dXJlLmZvcm1hdCApOwoJCQljb25zdCBnbFR5cGUgPSB1dGlscy5jb252ZXJ0KCBkc3RUZXh0dXJlLnR5cGUgKTsKCQkJbGV0IGdsVGFyZ2V0OwoKCQkJaWYgKCBkc3RUZXh0dXJlLmlzRGF0YTNEVGV4dHVyZSApIHsKCgkJCQl0ZXh0dXJlcy5zZXRUZXh0dXJlM0QoIGRzdFRleHR1cmUsIDAgKTsKCQkJCWdsVGFyZ2V0ID0gX2dsLlRFWFRVUkVfM0Q7CgoJCQl9IGVsc2UgaWYgKCBkc3RUZXh0dXJlLmlzRGF0YUFycmF5VGV4dHVyZSB8fCBkc3RUZXh0dXJlLmlzQ29tcHJlc3NlZEFycmF5VGV4dHVyZSApIHsKCgkJCQl0ZXh0dXJlcy5zZXRUZXh0dXJlMkRBcnJheSggZHN0VGV4dHVyZSwgMCApOwoJCQkJZ2xUYXJnZXQgPSBfZ2wuVEVYVFVSRV8yRF9BUlJBWTsKCgkJCX0gZWxzZSB7CgoJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xSZW5kZXJlci5jb3B5VGV4dHVyZVRvVGV4dHVyZTNEOiBvbmx5IHN1cHBvcnRzIFRIUkVFLkRhdGFUZXh0dXJlM0QgYW5kIFRIUkVFLkRhdGFUZXh0dXJlMkRBcnJheS4nICk7CgkJCQlyZXR1cm47CgoJCQl9CgoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfRkxJUF9ZX1dFQkdMLCBkc3RUZXh0dXJlLmZsaXBZICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19QUkVNVUxUSVBMWV9BTFBIQV9XRUJHTCwgZHN0VGV4dHVyZS5wcmVtdWx0aXBseUFscGhhICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19BTElHTk1FTlQsIGRzdFRleHR1cmUudW5wYWNrQWxpZ25tZW50ICk7CgoJCQljb25zdCB1bnBhY2tSb3dMZW4gPSBfZ2wuZ2V0UGFyYW1ldGVyKCBfZ2wuVU5QQUNLX1JPV19MRU5HVEggKTsKCQkJY29uc3QgdW5wYWNrSW1hZ2VIZWlnaHQgPSBfZ2wuZ2V0UGFyYW1ldGVyKCBfZ2wuVU5QQUNLX0lNQUdFX0hFSUdIVCApOwoJCQljb25zdCB1bnBhY2tTa2lwUGl4ZWxzID0gX2dsLmdldFBhcmFtZXRlciggX2dsLlVOUEFDS19TS0lQX1BJWEVMUyApOwoJCQljb25zdCB1bnBhY2tTa2lwUm93cyA9IF9nbC5nZXRQYXJhbWV0ZXIoIF9nbC5VTlBBQ0tfU0tJUF9ST1dTICk7CgkJCWNvbnN0IHVucGFja1NraXBJbWFnZXMgPSBfZ2wuZ2V0UGFyYW1ldGVyKCBfZ2wuVU5QQUNLX1NLSVBfSU1BR0VTICk7CgoJCQljb25zdCBpbWFnZSA9IHNyY1RleHR1cmUuaXNDb21wcmVzc2VkVGV4dHVyZSA/IHNyY1RleHR1cmUubWlwbWFwc1sgbGV2ZWwgXSA6IHNyY1RleHR1cmUuaW1hZ2U7CgoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfUk9XX0xFTkdUSCwgaW1hZ2Uud2lkdGggKTsKCQkJX2dsLnBpeGVsU3RvcmVpKCBfZ2wuVU5QQUNLX0lNQUdFX0hFSUdIVCwgaW1hZ2UuaGVpZ2h0ICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19TS0lQX1BJWEVMUywgc291cmNlQm94Lm1pbi54ICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19TS0lQX1JPV1MsIHNvdXJjZUJveC5taW4ueSApOwoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfU0tJUF9JTUFHRVMsIHNvdXJjZUJveC5taW4ueiApOwoKCQkJaWYgKCBzcmNUZXh0dXJlLmlzRGF0YVRleHR1cmUgfHwgc3JjVGV4dHVyZS5pc0RhdGEzRFRleHR1cmUgKSB7CgoJCQkJX2dsLnRleFN1YkltYWdlM0QoIGdsVGFyZ2V0LCBsZXZlbCwgcG9zaXRpb24ueCwgcG9zaXRpb24ueSwgcG9zaXRpb24ueiwgd2lkdGgsIGhlaWdodCwgZGVwdGgsIGdsRm9ybWF0LCBnbFR5cGUsIGltYWdlLmRhdGEgKTsKCgkJCX0gZWxzZSB7CgoJCQkJaWYgKCBzcmNUZXh0dXJlLmlzQ29tcHJlc3NlZEFycmF5VGV4dHVyZSApIHsKCgkJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xSZW5kZXJlci5jb3B5VGV4dHVyZVRvVGV4dHVyZTNEOiB1bnRlc3RlZCBzdXBwb3J0IGZvciBjb21wcmVzc2VkIHNyY1RleHR1cmUuJyApOwoJCQkJCV9nbC5jb21wcmVzc2VkVGV4U3ViSW1hZ2UzRCggZ2xUYXJnZXQsIGxldmVsLCBwb3NpdGlvbi54LCBwb3NpdGlvbi55LCBwb3NpdGlvbi56LCB3aWR0aCwgaGVpZ2h0LCBkZXB0aCwgZ2xGb3JtYXQsIGltYWdlLmRhdGEgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlfZ2wudGV4U3ViSW1hZ2UzRCggZ2xUYXJnZXQsIGxldmVsLCBwb3NpdGlvbi54LCBwb3NpdGlvbi55LCBwb3NpdGlvbi56LCB3aWR0aCwgaGVpZ2h0LCBkZXB0aCwgZ2xGb3JtYXQsIGdsVHlwZSwgaW1hZ2UgKTsKCgkJCQl9CgoJCQl9CgoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfUk9XX0xFTkdUSCwgdW5wYWNrUm93TGVuICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19JTUFHRV9IRUlHSFQsIHVucGFja0ltYWdlSGVpZ2h0ICk7CgkJCV9nbC5waXhlbFN0b3JlaSggX2dsLlVOUEFDS19TS0lQX1BJWEVMUywgdW5wYWNrU2tpcFBpeGVscyApOwoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfU0tJUF9ST1dTLCB1bnBhY2tTa2lwUm93cyApOwoJCQlfZ2wucGl4ZWxTdG9yZWkoIF9nbC5VTlBBQ0tfU0tJUF9JTUFHRVMsIHVucGFja1NraXBJbWFnZXMgKTsKCgkJCS8vIEdlbmVyYXRlIG1pcG1hcHMgb25seSB3aGVuIGNvcHlpbmcgbGV2ZWwgMAoJCQlpZiAoIGxldmVsID09PSAwICYmIGRzdFRleHR1cmUuZ2VuZXJhdGVNaXBtYXBzICkgX2dsLmdlbmVyYXRlTWlwbWFwKCBnbFRhcmdldCApOwoKCQkJc3RhdGUudW5iaW5kVGV4dHVyZSgpOwoKCQl9OwoKCQl0aGlzLmluaXRUZXh0dXJlID0gZnVuY3Rpb24gKCB0ZXh0dXJlICkgewoKCQkJaWYgKCB0ZXh0dXJlLmlzQ3ViZVRleHR1cmUgKSB7CgoJCQkJdGV4dHVyZXMuc2V0VGV4dHVyZUN1YmUoIHRleHR1cmUsIDAgKTsKCgkJCX0gZWxzZSBpZiAoIHRleHR1cmUuaXNEYXRhM0RUZXh0dXJlICkgewoKCQkJCXRleHR1cmVzLnNldFRleHR1cmUzRCggdGV4dHVyZSwgMCApOwoKCQkJfSBlbHNlIGlmICggdGV4dHVyZS5pc0RhdGFBcnJheVRleHR1cmUgfHwgdGV4dHVyZS5pc0NvbXByZXNzZWRBcnJheVRleHR1cmUgKSB7CgoJCQkJdGV4dHVyZXMuc2V0VGV4dHVyZTJEQXJyYXkoIHRleHR1cmUsIDAgKTsKCgkJCX0gZWxzZSB7CgoJCQkJdGV4dHVyZXMuc2V0VGV4dHVyZTJEKCB0ZXh0dXJlLCAwICk7CgoJCQl9CgoJCQlzdGF0ZS51bmJpbmRUZXh0dXJlKCk7CgoJCX07CgoJCXRoaXMucmVzZXRTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKCgkJCV9jdXJyZW50QWN0aXZlQ3ViZUZhY2UgPSAwOwoJCQlfY3VycmVudEFjdGl2ZU1pcG1hcExldmVsID0gMDsKCQkJX2N1cnJlbnRSZW5kZXJUYXJnZXQgPSBudWxsOwoKCQkJc3RhdGUucmVzZXQoKTsKCQkJYmluZGluZ1N0YXRlcy5yZXNldCgpOwoKCQl9OwoKCQlpZiAoIHR5cGVvZiBfX1RIUkVFX0RFVlRPT0xTX18gIT09ICd1bmRlZmluZWQnICkgewoKCQkJX19USFJFRV9ERVZUT09MU19fLmRpc3BhdGNoRXZlbnQoIG5ldyBDdXN0b21FdmVudCggJ29ic2VydmUnLCB7IGRldGFpbDogdGhpcyB9ICkgKTsKCgkJfQoKCX0KCglnZXQgY29vcmRpbmF0ZVN5c3RlbSgpIHsKCgkJcmV0dXJuIFdlYkdMQ29vcmRpbmF0ZVN5c3RlbTsKCgl9CgoJZ2V0IG91dHB1dENvbG9yU3BhY2UoKSB7CgoJCXJldHVybiB0aGlzLl9vdXRwdXRDb2xvclNwYWNlOwoKCX0KCglzZXQgb3V0cHV0Q29sb3JTcGFjZSggY29sb3JTcGFjZSApIHsKCgkJdGhpcy5fb3V0cHV0Q29sb3JTcGFjZSA9IGNvbG9yU3BhY2U7CgoJCWNvbnN0IGdsID0gdGhpcy5nZXRDb250ZXh0KCk7CgkJZ2wuZHJhd2luZ0J1ZmZlckNvbG9yU3BhY2UgPSBjb2xvclNwYWNlID09PSBEaXNwbGF5UDNDb2xvclNwYWNlID8gJ2Rpc3BsYXktcDMnIDogJ3NyZ2InOwoJCWdsLnVucGFja0NvbG9yU3BhY2UgPSBDb2xvck1hbmFnZW1lbnQud29ya2luZ0NvbG9yU3BhY2UgPT09IExpbmVhckRpc3BsYXlQM0NvbG9yU3BhY2UgPyAnZGlzcGxheS1wMycgOiAnc3JnYic7CgoJfQoKCWdldCBvdXRwdXRFbmNvZGluZygpIHsgLy8gQGRlcHJlY2F0ZWQsIHIxNTIKCgkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogUHJvcGVydHkgLm91dHB1dEVuY29kaW5nIGhhcyBiZWVuIHJlbW92ZWQuIFVzZSAub3V0cHV0Q29sb3JTcGFjZSBpbnN0ZWFkLicgKTsKCQlyZXR1cm4gdGhpcy5vdXRwdXRDb2xvclNwYWNlID09PSBTUkdCQ29sb3JTcGFjZSA/IHNSR0JFbmNvZGluZyA6IExpbmVhckVuY29kaW5nOwoKCX0KCglzZXQgb3V0cHV0RW5jb2RpbmcoIGVuY29kaW5nICkgeyAvLyBAZGVwcmVjYXRlZCwgcjE1MgoKCQljb25zb2xlLndhcm4oICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBQcm9wZXJ0eSAub3V0cHV0RW5jb2RpbmcgaGFzIGJlZW4gcmVtb3ZlZC4gVXNlIC5vdXRwdXRDb2xvclNwYWNlIGluc3RlYWQuJyApOwoJCXRoaXMub3V0cHV0Q29sb3JTcGFjZSA9IGVuY29kaW5nID09PSBzUkdCRW5jb2RpbmcgPyBTUkdCQ29sb3JTcGFjZSA6IExpbmVhclNSR0JDb2xvclNwYWNlOwoKCX0KCglnZXQgdXNlTGVnYWN5TGlnaHRzKCkgeyAvLyBAZGVwcmVjYXRlZCwgcjE1NQoKCQljb25zb2xlLndhcm4oICdUSFJFRS5XZWJHTFJlbmRlcmVyOiBUaGUgcHJvcGVydHkgLnVzZUxlZ2FjeUxpZ2h0cyBoYXMgYmVlbiBkZXByZWNhdGVkLiBNaWdyYXRlIHlvdXIgbGlnaHRpbmcgYWNjb3JkaW5nIHRvIHRoZSBmb2xsb3dpbmcgZ3VpZGU6IGh0dHBzOi8vZGlzY291cnNlLnRocmVlanMub3JnL3QvdXBkYXRlcy10by1saWdodGluZy1pbi10aHJlZS1qcy1yMTU1LzUzNzMzLicgKTsKCQlyZXR1cm4gdGhpcy5fdXNlTGVnYWN5TGlnaHRzOwoKCX0KCglzZXQgdXNlTGVnYWN5TGlnaHRzKCB2YWx1ZSApIHsgLy8gQGRlcHJlY2F0ZWQsIHIxNTUKCgkJY29uc29sZS53YXJuKCAnVEhSRUUuV2ViR0xSZW5kZXJlcjogVGhlIHByb3BlcnR5IC51c2VMZWdhY3lMaWdodHMgaGFzIGJlZW4gZGVwcmVjYXRlZC4gTWlncmF0ZSB5b3VyIGxpZ2h0aW5nIGFjY29yZGluZyB0byB0aGUgZm9sbG93aW5nIGd1aWRlOiBodHRwczovL2Rpc2NvdXJzZS50aHJlZWpzLm9yZy90L3VwZGF0ZXMtdG8tbGlnaHRpbmctaW4tdGhyZWUtanMtcjE1NS81MzczMy4nICk7CgkJdGhpcy5fdXNlTGVnYWN5TGlnaHRzID0gdmFsdWU7CgoJfQoKfQoKY2xhc3MgV2ViR0wxUmVuZGVyZXIgZXh0ZW5kcyBXZWJHTFJlbmRlcmVyIHt9CgpXZWJHTDFSZW5kZXJlci5wcm90b3R5cGUuaXNXZWJHTDFSZW5kZXJlciA9IHRydWU7CgpjbGFzcyBGb2dFeHAyIHsKCgljb25zdHJ1Y3RvciggY29sb3IsIGRlbnNpdHkgPSAwLjAwMDI1ICkgewoKCQl0aGlzLmlzRm9nRXhwMiA9IHRydWU7CgoJCXRoaXMubmFtZSA9ICcnOwoKCQl0aGlzLmNvbG9yID0gbmV3IENvbG9yKCBjb2xvciApOwoJCXRoaXMuZGVuc2l0eSA9IGRlbnNpdHk7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IEZvZ0V4cDIoIHRoaXMuY29sb3IsIHRoaXMuZGVuc2l0eSApOwoKCX0KCgl0b0pTT04oIC8qIG1ldGEgKi8gKSB7CgoJCXJldHVybiB7CgkJCXR5cGU6ICdGb2dFeHAyJywKCQkJbmFtZTogdGhpcy5uYW1lLAoJCQljb2xvcjogdGhpcy5jb2xvci5nZXRIZXgoKSwKCQkJZGVuc2l0eTogdGhpcy5kZW5zaXR5CgkJfTsKCgl9Cgp9CgpjbGFzcyBGb2cgewoKCWNvbnN0cnVjdG9yKCBjb2xvciwgbmVhciA9IDEsIGZhciA9IDEwMDAgKSB7CgoJCXRoaXMuaXNGb2cgPSB0cnVlOwoKCQl0aGlzLm5hbWUgPSAnJzsKCgkJdGhpcy5jb2xvciA9IG5ldyBDb2xvciggY29sb3IgKTsKCgkJdGhpcy5uZWFyID0gbmVhcjsKCQl0aGlzLmZhciA9IGZhcjsKCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgRm9nKCB0aGlzLmNvbG9yLCB0aGlzLm5lYXIsIHRoaXMuZmFyICk7CgoJfQoKCXRvSlNPTiggLyogbWV0YSAqLyApIHsKCgkJcmV0dXJuIHsKCQkJdHlwZTogJ0ZvZycsCgkJCW5hbWU6IHRoaXMubmFtZSwKCQkJY29sb3I6IHRoaXMuY29sb3IuZ2V0SGV4KCksCgkJCW5lYXI6IHRoaXMubmVhciwKCQkJZmFyOiB0aGlzLmZhcgoJCX07CgoJfQoKfQoKY2xhc3MgU2NlbmUgZXh0ZW5kcyBPYmplY3QzRCB7CgoJY29uc3RydWN0b3IoKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNTY2VuZSA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdTY2VuZSc7CgoJCXRoaXMuYmFja2dyb3VuZCA9IG51bGw7CgkJdGhpcy5lbnZpcm9ubWVudCA9IG51bGw7CgkJdGhpcy5mb2cgPSBudWxsOwoKCQl0aGlzLmJhY2tncm91bmRCbHVycmluZXNzID0gMDsKCQl0aGlzLmJhY2tncm91bmRJbnRlbnNpdHkgPSAxOwoKCQl0aGlzLm92ZXJyaWRlTWF0ZXJpYWwgPSBudWxsOwoKCQlpZiAoIHR5cGVvZiBfX1RIUkVFX0RFVlRPT0xTX18gIT09ICd1bmRlZmluZWQnICkgewoKCQkJX19USFJFRV9ERVZUT09MU19fLmRpc3BhdGNoRXZlbnQoIG5ldyBDdXN0b21FdmVudCggJ29ic2VydmUnLCB7IGRldGFpbDogdGhpcyB9ICkgKTsKCgkJfQoKCX0KCgljb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlLCByZWN1cnNpdmUgKTsKCgkJaWYgKCBzb3VyY2UuYmFja2dyb3VuZCAhPT0gbnVsbCApIHRoaXMuYmFja2dyb3VuZCA9IHNvdXJjZS5iYWNrZ3JvdW5kLmNsb25lKCk7CgkJaWYgKCBzb3VyY2UuZW52aXJvbm1lbnQgIT09IG51bGwgKSB0aGlzLmVudmlyb25tZW50ID0gc291cmNlLmVudmlyb25tZW50LmNsb25lKCk7CgkJaWYgKCBzb3VyY2UuZm9nICE9PSBudWxsICkgdGhpcy5mb2cgPSBzb3VyY2UuZm9nLmNsb25lKCk7CgoJCXRoaXMuYmFja2dyb3VuZEJsdXJyaW5lc3MgPSBzb3VyY2UuYmFja2dyb3VuZEJsdXJyaW5lc3M7CgkJdGhpcy5iYWNrZ3JvdW5kSW50ZW5zaXR5ID0gc291cmNlLmJhY2tncm91bmRJbnRlbnNpdHk7CgoJCWlmICggc291cmNlLm92ZXJyaWRlTWF0ZXJpYWwgIT09IG51bGwgKSB0aGlzLm92ZXJyaWRlTWF0ZXJpYWwgPSBzb3VyY2Uub3ZlcnJpZGVNYXRlcmlhbC5jbG9uZSgpOwoKCQl0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSBzb3VyY2UubWF0cml4QXV0b1VwZGF0ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTiggbWV0YSApIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTiggbWV0YSApOwoKCQlpZiAoIHRoaXMuZm9nICE9PSBudWxsICkgZGF0YS5vYmplY3QuZm9nID0gdGhpcy5mb2cudG9KU09OKCk7CgkJaWYgKCB0aGlzLmJhY2tncm91bmRCbHVycmluZXNzID4gMCApIGRhdGEub2JqZWN0LmJhY2tncm91bmRCbHVycmluZXNzID0gdGhpcy5iYWNrZ3JvdW5kQmx1cnJpbmVzczsKCQlpZiAoIHRoaXMuYmFja2dyb3VuZEludGVuc2l0eSAhPT0gMSApIGRhdGEub2JqZWN0LmJhY2tncm91bmRJbnRlbnNpdHkgPSB0aGlzLmJhY2tncm91bmRJbnRlbnNpdHk7CgoJCXJldHVybiBkYXRhOwoKCX0KCn0KCmNsYXNzIEludGVybGVhdmVkQnVmZmVyIHsKCgljb25zdHJ1Y3RvciggYXJyYXksIHN0cmlkZSApIHsKCgkJdGhpcy5pc0ludGVybGVhdmVkQnVmZmVyID0gdHJ1ZTsKCgkJdGhpcy5hcnJheSA9IGFycmF5OwoJCXRoaXMuc3RyaWRlID0gc3RyaWRlOwoJCXRoaXMuY291bnQgPSBhcnJheSAhPT0gdW5kZWZpbmVkID8gYXJyYXkubGVuZ3RoIC8gc3RyaWRlIDogMDsKCgkJdGhpcy51c2FnZSA9IFN0YXRpY0RyYXdVc2FnZTsKCQl0aGlzLl91cGRhdGVSYW5nZSA9IHsgb2Zmc2V0OiAwLCBjb3VudDogLSAxIH07CgkJdGhpcy51cGRhdGVSYW5nZXMgPSBbXTsKCgkJdGhpcy52ZXJzaW9uID0gMDsKCgkJdGhpcy51dWlkID0gZ2VuZXJhdGVVVUlEKCk7CgoJfQoKCW9uVXBsb2FkQ2FsbGJhY2soKSB7fQoKCXNldCBuZWVkc1VwZGF0ZSggdmFsdWUgKSB7CgoJCWlmICggdmFsdWUgPT09IHRydWUgKSB0aGlzLnZlcnNpb24gKys7CgoJfQoKCWdldCB1cGRhdGVSYW5nZSgpIHsKCgkJd2Fybk9uY2UoICdUSFJFRS5JbnRlcmxlYXZlZEJ1ZmZlcjogdXBkYXRlUmFuZ2UoKSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gcjE2OS4gVXNlIGFkZFVwZGF0ZVJhbmdlKCkgaW5zdGVhZC4nICk7IC8vIEBkZXByZWNhdGVkLCByMTU5CgkJcmV0dXJuIHRoaXMuX3VwZGF0ZVJhbmdlOwoKCX0KCglzZXRVc2FnZSggdmFsdWUgKSB7CgoJCXRoaXMudXNhZ2UgPSB2YWx1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFkZFVwZGF0ZVJhbmdlKCBzdGFydCwgY291bnQgKSB7CgoJCXRoaXMudXBkYXRlUmFuZ2VzLnB1c2goIHsgc3RhcnQsIGNvdW50IH0gKTsKCgl9CgoJY2xlYXJVcGRhdGVSYW5nZXMoKSB7CgoJCXRoaXMudXBkYXRlUmFuZ2VzLmxlbmd0aCA9IDA7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJdGhpcy5hcnJheSA9IG5ldyBzb3VyY2UuYXJyYXkuY29uc3RydWN0b3IoIHNvdXJjZS5hcnJheSApOwoJCXRoaXMuY291bnQgPSBzb3VyY2UuY291bnQ7CgkJdGhpcy5zdHJpZGUgPSBzb3VyY2Uuc3RyaWRlOwoJCXRoaXMudXNhZ2UgPSBzb3VyY2UudXNhZ2U7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb3B5QXQoIGluZGV4MSwgYXR0cmlidXRlLCBpbmRleDIgKSB7CgoJCWluZGV4MSAqPSB0aGlzLnN0cmlkZTsKCQlpbmRleDIgKj0gYXR0cmlidXRlLnN0cmlkZTsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gdGhpcy5zdHJpZGU7IGkgPCBsOyBpICsrICkgewoKCQkJdGhpcy5hcnJheVsgaW5kZXgxICsgaSBdID0gYXR0cmlidXRlLmFycmF5WyBpbmRleDIgKyBpIF07CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldCggdmFsdWUsIG9mZnNldCA9IDAgKSB7CgoJCXRoaXMuYXJyYXkuc2V0KCB2YWx1ZSwgb2Zmc2V0ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljbG9uZSggZGF0YSApIHsKCgkJaWYgKCBkYXRhLmFycmF5QnVmZmVycyA9PT0gdW5kZWZpbmVkICkgewoKCQkJZGF0YS5hcnJheUJ1ZmZlcnMgPSB7fTsKCgkJfQoKCQlpZiAoIHRoaXMuYXJyYXkuYnVmZmVyLl91dWlkID09PSB1bmRlZmluZWQgKSB7CgoJCQl0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZCA9IGdlbmVyYXRlVVVJRCgpOwoKCQl9CgoJCWlmICggZGF0YS5hcnJheUJ1ZmZlcnNbIHRoaXMuYXJyYXkuYnVmZmVyLl91dWlkIF0gPT09IHVuZGVmaW5lZCApIHsKCgkJCWRhdGEuYXJyYXlCdWZmZXJzWyB0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZCBdID0gdGhpcy5hcnJheS5zbGljZSggMCApLmJ1ZmZlcjsKCgkJfQoKCQljb25zdCBhcnJheSA9IG5ldyB0aGlzLmFycmF5LmNvbnN0cnVjdG9yKCBkYXRhLmFycmF5QnVmZmVyc1sgdGhpcy5hcnJheS5idWZmZXIuX3V1aWQgXSApOwoKCQljb25zdCBpYiA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKCBhcnJheSwgdGhpcy5zdHJpZGUgKTsKCQlpYi5zZXRVc2FnZSggdGhpcy51c2FnZSApOwoKCQlyZXR1cm4gaWI7CgoJfQoKCW9uVXBsb2FkKCBjYWxsYmFjayApIHsKCgkJdGhpcy5vblVwbG9hZENhbGxiYWNrID0gY2FsbGJhY2s7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0pTT04oIGRhdGEgKSB7CgoJCWlmICggZGF0YS5hcnJheUJ1ZmZlcnMgPT09IHVuZGVmaW5lZCApIHsKCgkJCWRhdGEuYXJyYXlCdWZmZXJzID0ge307CgoJCX0KCgkJLy8gZ2VuZXJhdGUgVVVJRCBmb3IgYXJyYXkgYnVmZmVyIGlmIG5lY2Vzc2FyeQoKCQlpZiAoIHRoaXMuYXJyYXkuYnVmZmVyLl91dWlkID09PSB1bmRlZmluZWQgKSB7CgoJCQl0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZCA9IGdlbmVyYXRlVVVJRCgpOwoKCQl9CgoJCWlmICggZGF0YS5hcnJheUJ1ZmZlcnNbIHRoaXMuYXJyYXkuYnVmZmVyLl91dWlkIF0gPT09IHVuZGVmaW5lZCApIHsKCgkJCWRhdGEuYXJyYXlCdWZmZXJzWyB0aGlzLmFycmF5LmJ1ZmZlci5fdXVpZCBdID0gQXJyYXkuZnJvbSggbmV3IFVpbnQzMkFycmF5KCB0aGlzLmFycmF5LmJ1ZmZlciApICk7CgoJCX0KCgkJLy8KCgkJcmV0dXJuIHsKCQkJdXVpZDogdGhpcy51dWlkLAoJCQlidWZmZXI6IHRoaXMuYXJyYXkuYnVmZmVyLl91dWlkLAoJCQl0eXBlOiB0aGlzLmFycmF5LmNvbnN0cnVjdG9yLm5hbWUsCgkJCXN0cmlkZTogdGhpcy5zdHJpZGUKCQl9OwoKCX0KCn0KCmNvbnN0IF92ZWN0b3IkNiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNsYXNzIEludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlIHsKCgljb25zdHJ1Y3RvciggaW50ZXJsZWF2ZWRCdWZmZXIsIGl0ZW1TaXplLCBvZmZzZXQsIG5vcm1hbGl6ZWQgPSBmYWxzZSApIHsKCgkJdGhpcy5pc0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlID0gdHJ1ZTsKCgkJdGhpcy5uYW1lID0gJyc7CgoJCXRoaXMuZGF0YSA9IGludGVybGVhdmVkQnVmZmVyOwoJCXRoaXMuaXRlbVNpemUgPSBpdGVtU2l6ZTsKCQl0aGlzLm9mZnNldCA9IG9mZnNldDsKCgkJdGhpcy5ub3JtYWxpemVkID0gbm9ybWFsaXplZDsKCgl9CgoJZ2V0IGNvdW50KCkgewoKCQlyZXR1cm4gdGhpcy5kYXRhLmNvdW50OwoKCX0KCglnZXQgYXJyYXkoKSB7CgoJCXJldHVybiB0aGlzLmRhdGEuYXJyYXk7CgoJfQoKCXNldCBuZWVkc1VwZGF0ZSggdmFsdWUgKSB7CgoJCXRoaXMuZGF0YS5uZWVkc1VwZGF0ZSA9IHZhbHVlOwoKCX0KCglhcHBseU1hdHJpeDQoIG0gKSB7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IHRoaXMuZGF0YS5jb3VudDsgaSA8IGw7IGkgKysgKSB7CgoJCQlfdmVjdG9yJDYuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggdGhpcywgaSApOwoKCQkJX3ZlY3RvciQ2LmFwcGx5TWF0cml4NCggbSApOwoKCQkJdGhpcy5zZXRYWVooIGksIF92ZWN0b3IkNi54LCBfdmVjdG9yJDYueSwgX3ZlY3RvciQ2LnogKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJYXBwbHlOb3JtYWxNYXRyaXgoIG0gKSB7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IHRoaXMuY291bnQ7IGkgPCBsOyBpICsrICkgewoKCQkJX3ZlY3RvciQ2LmZyb21CdWZmZXJBdHRyaWJ1dGUoIHRoaXMsIGkgKTsKCgkJCV92ZWN0b3IkNi5hcHBseU5vcm1hbE1hdHJpeCggbSApOwoKCQkJdGhpcy5zZXRYWVooIGksIF92ZWN0b3IkNi54LCBfdmVjdG9yJDYueSwgX3ZlY3RvciQ2LnogKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdHJhbnNmb3JtRGlyZWN0aW9uKCBtICkgewoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSB0aGlzLmNvdW50OyBpIDwgbDsgaSArKyApIHsKCgkJCV92ZWN0b3IkNi5mcm9tQnVmZmVyQXR0cmlidXRlKCB0aGlzLCBpICk7CgoJCQlfdmVjdG9yJDYudHJhbnNmb3JtRGlyZWN0aW9uKCBtICk7CgoJCQl0aGlzLnNldFhZWiggaSwgX3ZlY3RvciQ2LngsIF92ZWN0b3IkNi55LCBfdmVjdG9yJDYueiApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRDb21wb25lbnQoIGluZGV4LCBjb21wb25lbnQgKSB7CgoJCWxldCB2YWx1ZSA9IHRoaXMuYXJyYXlbIGluZGV4ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgY29tcG9uZW50IF07CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgdmFsdWUgPSBkZW5vcm1hbGl6ZSggdmFsdWUsIHRoaXMuYXJyYXkgKTsKCgkJcmV0dXJuIHZhbHVlOwoKCX0KCglzZXRDb21wb25lbnQoIGluZGV4LCBjb21wb25lbnQsIHZhbHVlICkgewoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHZhbHVlID0gbm9ybWFsaXplKCB2YWx1ZSwgdGhpcy5hcnJheSApOwoKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgY29tcG9uZW50IF0gPSB2YWx1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFgoIGluZGV4LCB4ICkgewoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHggPSBub3JtYWxpemUoIHgsIHRoaXMuYXJyYXkgKTsKCgkJdGhpcy5kYXRhLmFycmF5WyBpbmRleCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCBdID0geDsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFkoIGluZGV4LCB5ICkgewoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHkgPSBub3JtYWxpemUoIHksIHRoaXMuYXJyYXkgKTsKCgkJdGhpcy5kYXRhLmFycmF5WyBpbmRleCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCArIDEgXSA9IHk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRaKCBpbmRleCwgeiApIHsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB6ID0gbm9ybWFsaXplKCB6LCB0aGlzLmFycmF5ICk7CgoJCXRoaXMuZGF0YS5hcnJheVsgaW5kZXggKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQgKyAyIF0gPSB6OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0VyggaW5kZXgsIHcgKSB7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgdyA9IG5vcm1hbGl6ZSggdywgdGhpcy5hcnJheSApOwoKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgMyBdID0gdzsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldFgoIGluZGV4ICkgewoKCQlsZXQgeCA9IHRoaXMuZGF0YS5hcnJheVsgaW5kZXggKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQgXTsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB4ID0gZGVub3JtYWxpemUoIHgsIHRoaXMuYXJyYXkgKTsKCgkJcmV0dXJuIHg7CgoJfQoKCWdldFkoIGluZGV4ICkgewoKCQlsZXQgeSA9IHRoaXMuZGF0YS5hcnJheVsgaW5kZXggKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQgKyAxIF07CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgeSA9IGRlbm9ybWFsaXplKCB5LCB0aGlzLmFycmF5ICk7CgoJCXJldHVybiB5OwoKCX0KCglnZXRaKCBpbmRleCApIHsKCgkJbGV0IHogPSB0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0ICsgMiBdOwoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHogPSBkZW5vcm1hbGl6ZSggeiwgdGhpcy5hcnJheSApOwoKCQlyZXR1cm4gejsKCgl9CgoJZ2V0VyggaW5kZXggKSB7CgoJCWxldCB3ID0gdGhpcy5kYXRhLmFycmF5WyBpbmRleCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldCArIDMgXTsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB3ID0gZGVub3JtYWxpemUoIHcsIHRoaXMuYXJyYXkgKTsKCgkJcmV0dXJuIHc7CgoJfQoKCXNldFhZKCBpbmRleCwgeCwgeSApIHsKCgkJaW5kZXggPSBpbmRleCAqIHRoaXMuZGF0YS5zdHJpZGUgKyB0aGlzLm9mZnNldDsKCgkJaWYgKCB0aGlzLm5vcm1hbGl6ZWQgKSB7CgoJCQl4ID0gbm9ybWFsaXplKCB4LCB0aGlzLmFycmF5ICk7CgkJCXkgPSBub3JtYWxpemUoIHksIHRoaXMuYXJyYXkgKTsKCgkJfQoKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICsgMCBdID0geDsKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICsgMSBdID0geTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFhZWiggaW5kZXgsIHgsIHksIHogKSB7CgoJCWluZGV4ID0gaW5kZXggKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQ7CgoJCWlmICggdGhpcy5ub3JtYWxpemVkICkgewoKCQkJeCA9IG5vcm1hbGl6ZSggeCwgdGhpcy5hcnJheSApOwoJCQl5ID0gbm9ybWFsaXplKCB5LCB0aGlzLmFycmF5ICk7CgkJCXogPSBub3JtYWxpemUoIHosIHRoaXMuYXJyYXkgKTsKCgkJfQoKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICsgMCBdID0geDsKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICsgMSBdID0geTsKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICsgMiBdID0gejsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFhZWlcoIGluZGV4LCB4LCB5LCB6LCB3ICkgewoKCQlpbmRleCA9IGluZGV4ICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0OwoKCQlpZiAoIHRoaXMubm9ybWFsaXplZCApIHsKCgkJCXggPSBub3JtYWxpemUoIHgsIHRoaXMuYXJyYXkgKTsKCQkJeSA9IG5vcm1hbGl6ZSggeSwgdGhpcy5hcnJheSApOwoJCQl6ID0gbm9ybWFsaXplKCB6LCB0aGlzLmFycmF5ICk7CgkJCXcgPSBub3JtYWxpemUoIHcsIHRoaXMuYXJyYXkgKTsKCgkJfQoKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICsgMCBdID0geDsKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICsgMSBdID0geTsKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICsgMiBdID0gejsKCQl0aGlzLmRhdGEuYXJyYXlbIGluZGV4ICsgMyBdID0gdzsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsb25lKCBkYXRhICkgewoKCQlpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCApIHsKCgkJCWNvbnNvbGUubG9nKCAnVEhSRUUuSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUuY2xvbmUoKTogQ2xvbmluZyBhbiBpbnRlcmxlYXZlZCBidWZmZXIgYXR0cmlidXRlIHdpbGwgZGUtaW50ZXJsZWF2ZSBidWZmZXIgZGF0YS4nICk7CgoJCQljb25zdCBhcnJheSA9IFtdOwoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgdGhpcy5jb3VudDsgaSArKyApIHsKCgkJCQljb25zdCBpbmRleCA9IGkgKiB0aGlzLmRhdGEuc3RyaWRlICsgdGhpcy5vZmZzZXQ7CgoJCQkJZm9yICggbGV0IGogPSAwOyBqIDwgdGhpcy5pdGVtU2l6ZTsgaiArKyApIHsKCgkJCQkJYXJyYXkucHVzaCggdGhpcy5kYXRhLmFycmF5WyBpbmRleCArIGogXSApOwoKCQkJCX0KCgkJCX0KCgkJCXJldHVybiBuZXcgQnVmZmVyQXR0cmlidXRlKCBuZXcgdGhpcy5hcnJheS5jb25zdHJ1Y3RvciggYXJyYXkgKSwgdGhpcy5pdGVtU2l6ZSwgdGhpcy5ub3JtYWxpemVkICk7CgoJCX0gZWxzZSB7CgoJCQlpZiAoIGRhdGEuaW50ZXJsZWF2ZWRCdWZmZXJzID09PSB1bmRlZmluZWQgKSB7CgoJCQkJZGF0YS5pbnRlcmxlYXZlZEJ1ZmZlcnMgPSB7fTsKCgkJCX0KCgkJCWlmICggZGF0YS5pbnRlcmxlYXZlZEJ1ZmZlcnNbIHRoaXMuZGF0YS51dWlkIF0gPT09IHVuZGVmaW5lZCApIHsKCgkJCQlkYXRhLmludGVybGVhdmVkQnVmZmVyc1sgdGhpcy5kYXRhLnV1aWQgXSA9IHRoaXMuZGF0YS5jbG9uZSggZGF0YSApOwoKCQkJfQoKCQkJcmV0dXJuIG5ldyBJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZSggZGF0YS5pbnRlcmxlYXZlZEJ1ZmZlcnNbIHRoaXMuZGF0YS51dWlkIF0sIHRoaXMuaXRlbVNpemUsIHRoaXMub2Zmc2V0LCB0aGlzLm5vcm1hbGl6ZWQgKTsKCgkJfQoKCX0KCgl0b0pTT04oIGRhdGEgKSB7CgoJCWlmICggZGF0YSA9PT0gdW5kZWZpbmVkICkgewoKCQkJY29uc29sZS5sb2coICdUSFJFRS5JbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZS50b0pTT04oKTogU2VyaWFsaXppbmcgYW4gaW50ZXJsZWF2ZWQgYnVmZmVyIGF0dHJpYnV0ZSB3aWxsIGRlLWludGVybGVhdmUgYnVmZmVyIGRhdGEuJyApOwoKCQkJY29uc3QgYXJyYXkgPSBbXTsKCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMuY291bnQ7IGkgKysgKSB7CgoJCQkJY29uc3QgaW5kZXggPSBpICogdGhpcy5kYXRhLnN0cmlkZSArIHRoaXMub2Zmc2V0OwoKCQkJCWZvciAoIGxldCBqID0gMDsgaiA8IHRoaXMuaXRlbVNpemU7IGogKysgKSB7CgoJCQkJCWFycmF5LnB1c2goIHRoaXMuZGF0YS5hcnJheVsgaW5kZXggKyBqIF0gKTsKCgkJCQl9CgoJCQl9CgoJCQkvLyBkZS1pbnRlcmxlYXZlIGRhdGEgYW5kIHNhdmUgaXQgYXMgYW4gb3JkaW5hcnkgYnVmZmVyIGF0dHJpYnV0ZSBmb3Igbm93CgoJCQlyZXR1cm4gewoJCQkJaXRlbVNpemU6IHRoaXMuaXRlbVNpemUsCgkJCQl0eXBlOiB0aGlzLmFycmF5LmNvbnN0cnVjdG9yLm5hbWUsCgkJCQlhcnJheTogYXJyYXksCgkJCQlub3JtYWxpemVkOiB0aGlzLm5vcm1hbGl6ZWQKCQkJfTsKCgkJfSBlbHNlIHsKCgkJCS8vIHNhdmUgYXMgdHJ1ZSBpbnRlcmxlYXZlZCBhdHRyaWJ1dGUKCgkJCWlmICggZGF0YS5pbnRlcmxlYXZlZEJ1ZmZlcnMgPT09IHVuZGVmaW5lZCApIHsKCgkJCQlkYXRhLmludGVybGVhdmVkQnVmZmVycyA9IHt9OwoKCQkJfQoKCQkJaWYgKCBkYXRhLmludGVybGVhdmVkQnVmZmVyc1sgdGhpcy5kYXRhLnV1aWQgXSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCWRhdGEuaW50ZXJsZWF2ZWRCdWZmZXJzWyB0aGlzLmRhdGEudXVpZCBdID0gdGhpcy5kYXRhLnRvSlNPTiggZGF0YSApOwoKCQkJfQoKCQkJcmV0dXJuIHsKCQkJCWlzSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGU6IHRydWUsCgkJCQlpdGVtU2l6ZTogdGhpcy5pdGVtU2l6ZSwKCQkJCWRhdGE6IHRoaXMuZGF0YS51dWlkLAoJCQkJb2Zmc2V0OiB0aGlzLm9mZnNldCwKCQkJCW5vcm1hbGl6ZWQ6IHRoaXMubm9ybWFsaXplZAoJCQl9OwoKCQl9CgoJfQoKfQoKY2xhc3MgU3ByaXRlTWF0ZXJpYWwgZXh0ZW5kcyBNYXRlcmlhbCB7CgoJY29uc3RydWN0b3IoIHBhcmFtZXRlcnMgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNTcHJpdGVNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdTcHJpdGVNYXRlcmlhbCc7CgoJCXRoaXMuY29sb3IgPSBuZXcgQ29sb3IoIDB4ZmZmZmZmICk7CgoJCXRoaXMubWFwID0gbnVsbDsKCgkJdGhpcy5hbHBoYU1hcCA9IG51bGw7CgoJCXRoaXMucm90YXRpb24gPSAwOwoKCQl0aGlzLnNpemVBdHRlbnVhdGlvbiA9IHRydWU7CgoJCXRoaXMudHJhbnNwYXJlbnQgPSB0cnVlOwoKCQl0aGlzLmZvZyA9IHRydWU7CgoJCXRoaXMuc2V0VmFsdWVzKCBwYXJhbWV0ZXJzICk7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuY29sb3IuY29weSggc291cmNlLmNvbG9yICk7CgoJCXRoaXMubWFwID0gc291cmNlLm1hcDsKCgkJdGhpcy5hbHBoYU1hcCA9IHNvdXJjZS5hbHBoYU1hcDsKCgkJdGhpcy5yb3RhdGlvbiA9IHNvdXJjZS5yb3RhdGlvbjsKCgkJdGhpcy5zaXplQXR0ZW51YXRpb24gPSBzb3VyY2Uuc2l6ZUF0dGVudWF0aW9uOwoKCQl0aGlzLmZvZyA9IHNvdXJjZS5mb2c7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmxldCBfZ2VvbWV0cnk7Cgpjb25zdCBfaW50ZXJzZWN0UG9pbnQgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF93b3JsZFNjYWxlID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfbXZQb3NpdGlvbiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNvbnN0IF9hbGlnbmVkUG9zaXRpb24gPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCk7CmNvbnN0IF9yb3RhdGVkUG9zaXRpb24gPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCk7CmNvbnN0IF92aWV3V29ybGRNYXRyaXggPSAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXg0KCk7Cgpjb25zdCBfdkEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92QiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3ZDID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwoKY29uc3QgX3V2QSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjIoKTsKY29uc3QgX3V2QiA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjIoKTsKY29uc3QgX3V2QyA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjIoKTsKCmNsYXNzIFNwcml0ZSBleHRlbmRzIE9iamVjdDNEIHsKCgljb25zdHJ1Y3RvciggbWF0ZXJpYWwgPSBuZXcgU3ByaXRlTWF0ZXJpYWwoKSApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc1Nwcml0ZSA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdTcHJpdGUnOwoKCQlpZiAoIF9nZW9tZXRyeSA9PT0gdW5kZWZpbmVkICkgewoKCQkJX2dlb21ldHJ5ID0gbmV3IEJ1ZmZlckdlb21ldHJ5KCk7CgoJCQljb25zdCBmbG9hdDMyQXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KCBbCgkJCQktIDAuNSwgLSAwLjUsIDAsIDAsIDAsCgkJCQkwLjUsIC0gMC41LCAwLCAxLCAwLAoJCQkJMC41LCAwLjUsIDAsIDEsIDEsCgkJCQktIDAuNSwgMC41LCAwLCAwLCAxCgkJCV0gKTsKCgkJCWNvbnN0IGludGVybGVhdmVkQnVmZmVyID0gbmV3IEludGVybGVhdmVkQnVmZmVyKCBmbG9hdDMyQXJyYXksIDUgKTsKCgkJCV9nZW9tZXRyeS5zZXRJbmRleCggWyAwLCAxLCAyLAkwLCAyLCAzIF0gKTsKCQkJX2dlb21ldHJ5LnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlKCBpbnRlcmxlYXZlZEJ1ZmZlciwgMywgMCwgZmFsc2UgKSApOwoJCQlfZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAndXYnLCBuZXcgSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUoIGludGVybGVhdmVkQnVmZmVyLCAyLCAzLCBmYWxzZSApICk7CgoJCX0KCgkJdGhpcy5nZW9tZXRyeSA9IF9nZW9tZXRyeTsKCQl0aGlzLm1hdGVyaWFsID0gbWF0ZXJpYWw7CgoJCXRoaXMuY2VudGVyID0gbmV3IFZlY3RvcjIoIDAuNSwgMC41ICk7CgoJfQoKCXJheWNhc3QoIHJheWNhc3RlciwgaW50ZXJzZWN0cyApIHsKCgkJaWYgKCByYXljYXN0ZXIuY2FtZXJhID09PSBudWxsICkgewoKCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLlNwcml0ZTogIlJheWNhc3Rlci5jYW1lcmEiIG5lZWRzIHRvIGJlIHNldCBpbiBvcmRlciB0byByYXljYXN0IGFnYWluc3Qgc3ByaXRlcy4nICk7CgoJCX0KCgkJX3dvcmxkU2NhbGUuc2V0RnJvbU1hdHJpeFNjYWxlKCB0aGlzLm1hdHJpeFdvcmxkICk7CgoJCV92aWV3V29ybGRNYXRyaXguY29weSggcmF5Y2FzdGVyLmNhbWVyYS5tYXRyaXhXb3JsZCApOwoJCXRoaXMubW9kZWxWaWV3TWF0cml4Lm11bHRpcGx5TWF0cmljZXMoIHJheWNhc3Rlci5jYW1lcmEubWF0cml4V29ybGRJbnZlcnNlLCB0aGlzLm1hdHJpeFdvcmxkICk7CgoJCV9tdlBvc2l0aW9uLnNldEZyb21NYXRyaXhQb3NpdGlvbiggdGhpcy5tb2RlbFZpZXdNYXRyaXggKTsKCgkJaWYgKCByYXljYXN0ZXIuY2FtZXJhLmlzUGVyc3BlY3RpdmVDYW1lcmEgJiYgdGhpcy5tYXRlcmlhbC5zaXplQXR0ZW51YXRpb24gPT09IGZhbHNlICkgewoKCQkJX3dvcmxkU2NhbGUubXVsdGlwbHlTY2FsYXIoIC0gX212UG9zaXRpb24ueiApOwoKCQl9CgoJCWNvbnN0IHJvdGF0aW9uID0gdGhpcy5tYXRlcmlhbC5yb3RhdGlvbjsKCQlsZXQgc2luLCBjb3M7CgoJCWlmICggcm90YXRpb24gIT09IDAgKSB7CgoJCQljb3MgPSBNYXRoLmNvcyggcm90YXRpb24gKTsKCQkJc2luID0gTWF0aC5zaW4oIHJvdGF0aW9uICk7CgoJCX0KCgkJY29uc3QgY2VudGVyID0gdGhpcy5jZW50ZXI7CgoJCXRyYW5zZm9ybVZlcnRleCggX3ZBLnNldCggLSAwLjUsIC0gMC41LCAwICksIF9tdlBvc2l0aW9uLCBjZW50ZXIsIF93b3JsZFNjYWxlLCBzaW4sIGNvcyApOwoJCXRyYW5zZm9ybVZlcnRleCggX3ZCLnNldCggMC41LCAtIDAuNSwgMCApLCBfbXZQb3NpdGlvbiwgY2VudGVyLCBfd29ybGRTY2FsZSwgc2luLCBjb3MgKTsKCQl0cmFuc2Zvcm1WZXJ0ZXgoIF92Qy5zZXQoIDAuNSwgMC41LCAwICksIF9tdlBvc2l0aW9uLCBjZW50ZXIsIF93b3JsZFNjYWxlLCBzaW4sIGNvcyApOwoKCQlfdXZBLnNldCggMCwgMCApOwoJCV91dkIuc2V0KCAxLCAwICk7CgkJX3V2Qy5zZXQoIDEsIDEgKTsKCgkJLy8gY2hlY2sgZmlyc3QgdHJpYW5nbGUKCQlsZXQgaW50ZXJzZWN0ID0gcmF5Y2FzdGVyLnJheS5pbnRlcnNlY3RUcmlhbmdsZSggX3ZBLCBfdkIsIF92QywgZmFsc2UsIF9pbnRlcnNlY3RQb2ludCApOwoKCQlpZiAoIGludGVyc2VjdCA9PT0gbnVsbCApIHsKCgkJCS8vIGNoZWNrIHNlY29uZCB0cmlhbmdsZQoJCQl0cmFuc2Zvcm1WZXJ0ZXgoIF92Qi5zZXQoIC0gMC41LCAwLjUsIDAgKSwgX212UG9zaXRpb24sIGNlbnRlciwgX3dvcmxkU2NhbGUsIHNpbiwgY29zICk7CgkJCV91dkIuc2V0KCAwLCAxICk7CgoJCQlpbnRlcnNlY3QgPSByYXljYXN0ZXIucmF5LmludGVyc2VjdFRyaWFuZ2xlKCBfdkEsIF92QywgX3ZCLCBmYWxzZSwgX2ludGVyc2VjdFBvaW50ICk7CgkJCWlmICggaW50ZXJzZWN0ID09PSBudWxsICkgewoKCQkJCXJldHVybjsKCgkJCX0KCgkJfQoKCQljb25zdCBkaXN0YW5jZSA9IHJheWNhc3Rlci5yYXkub3JpZ2luLmRpc3RhbmNlVG8oIF9pbnRlcnNlY3RQb2ludCApOwoKCQlpZiAoIGRpc3RhbmNlIDwgcmF5Y2FzdGVyLm5lYXIgfHwgZGlzdGFuY2UgPiByYXljYXN0ZXIuZmFyICkgcmV0dXJuOwoKCQlpbnRlcnNlY3RzLnB1c2goIHsKCgkJCWRpc3RhbmNlOiBkaXN0YW5jZSwKCQkJcG9pbnQ6IF9pbnRlcnNlY3RQb2ludC5jbG9uZSgpLAoJCQl1djogVHJpYW5nbGUuZ2V0SW50ZXJwb2xhdGlvbiggX2ludGVyc2VjdFBvaW50LCBfdkEsIF92QiwgX3ZDLCBfdXZBLCBfdXZCLCBfdXZDLCBuZXcgVmVjdG9yMigpICksCgkJCWZhY2U6IG51bGwsCgkJCW9iamVjdDogdGhpcwoKCQl9ICk7CgoJfQoKCWNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApOwoKCQlpZiAoIHNvdXJjZS5jZW50ZXIgIT09IHVuZGVmaW5lZCApIHRoaXMuY2VudGVyLmNvcHkoIHNvdXJjZS5jZW50ZXIgKTsKCgkJdGhpcy5tYXRlcmlhbCA9IHNvdXJjZS5tYXRlcmlhbDsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKZnVuY3Rpb24gdHJhbnNmb3JtVmVydGV4KCB2ZXJ0ZXhQb3NpdGlvbiwgbXZQb3NpdGlvbiwgY2VudGVyLCBzY2FsZSwgc2luLCBjb3MgKSB7CgoJLy8gY29tcHV0ZSBwb3NpdGlvbiBpbiBjYW1lcmEgc3BhY2UKCV9hbGlnbmVkUG9zaXRpb24uc3ViVmVjdG9ycyggdmVydGV4UG9zaXRpb24sIGNlbnRlciApLmFkZFNjYWxhciggMC41ICkubXVsdGlwbHkoIHNjYWxlICk7CgoJLy8gdG8gY2hlY2sgaWYgcm90YXRpb24gaXMgbm90IHplcm8KCWlmICggc2luICE9PSB1bmRlZmluZWQgKSB7CgoJCV9yb3RhdGVkUG9zaXRpb24ueCA9ICggY29zICogX2FsaWduZWRQb3NpdGlvbi54ICkgLSAoIHNpbiAqIF9hbGlnbmVkUG9zaXRpb24ueSApOwoJCV9yb3RhdGVkUG9zaXRpb24ueSA9ICggc2luICogX2FsaWduZWRQb3NpdGlvbi54ICkgKyAoIGNvcyAqIF9hbGlnbmVkUG9zaXRpb24ueSApOwoKCX0gZWxzZSB7CgoJCV9yb3RhdGVkUG9zaXRpb24uY29weSggX2FsaWduZWRQb3NpdGlvbiApOwoKCX0KCgoJdmVydGV4UG9zaXRpb24uY29weSggbXZQb3NpdGlvbiApOwoJdmVydGV4UG9zaXRpb24ueCArPSBfcm90YXRlZFBvc2l0aW9uLng7Cgl2ZXJ0ZXhQb3NpdGlvbi55ICs9IF9yb3RhdGVkUG9zaXRpb24ueTsKCgkvLyB0cmFuc2Zvcm0gdG8gd29ybGQgc3BhY2UKCXZlcnRleFBvc2l0aW9uLmFwcGx5TWF0cml4NCggX3ZpZXdXb3JsZE1hdHJpeCApOwoKfQoKY29uc3QgX3YxJDIgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92MiQxID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwoKY2xhc3MgTE9EIGV4dGVuZHMgT2JqZWN0M0QgewoKCWNvbnN0cnVjdG9yKCkgewoKCQlzdXBlcigpOwoKCQl0aGlzLl9jdXJyZW50TGV2ZWwgPSAwOwoKCQl0aGlzLnR5cGUgPSAnTE9EJzsKCgkJT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoIHRoaXMsIHsKCQkJbGV2ZWxzOiB7CgkJCQllbnVtZXJhYmxlOiB0cnVlLAoJCQkJdmFsdWU6IFtdCgkJCX0sCgkJCWlzTE9EOiB7CgkJCQl2YWx1ZTogdHJ1ZSwKCQkJfQoJCX0gKTsKCgkJdGhpcy5hdXRvVXBkYXRlID0gdHJ1ZTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UsIGZhbHNlICk7CgoJCWNvbnN0IGxldmVscyA9IHNvdXJjZS5sZXZlbHM7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IGxldmVscy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgbGV2ZWwgPSBsZXZlbHNbIGkgXTsKCgkJCXRoaXMuYWRkTGV2ZWwoIGxldmVsLm9iamVjdC5jbG9uZSgpLCBsZXZlbC5kaXN0YW5jZSwgbGV2ZWwuaHlzdGVyZXNpcyApOwoKCQl9CgoJCXRoaXMuYXV0b1VwZGF0ZSA9IHNvdXJjZS5hdXRvVXBkYXRlOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJYWRkTGV2ZWwoIG9iamVjdCwgZGlzdGFuY2UgPSAwLCBoeXN0ZXJlc2lzID0gMCApIHsKCgkJZGlzdGFuY2UgPSBNYXRoLmFicyggZGlzdGFuY2UgKTsKCgkJY29uc3QgbGV2ZWxzID0gdGhpcy5sZXZlbHM7CgoJCWxldCBsOwoKCQlmb3IgKCBsID0gMDsgbCA8IGxldmVscy5sZW5ndGg7IGwgKysgKSB7CgoJCQlpZiAoIGRpc3RhbmNlIDwgbGV2ZWxzWyBsIF0uZGlzdGFuY2UgKSB7CgoJCQkJYnJlYWs7CgoJCQl9CgoJCX0KCgkJbGV2ZWxzLnNwbGljZSggbCwgMCwgeyBkaXN0YW5jZTogZGlzdGFuY2UsIGh5c3RlcmVzaXM6IGh5c3RlcmVzaXMsIG9iamVjdDogb2JqZWN0IH0gKTsKCgkJdGhpcy5hZGQoIG9iamVjdCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0Q3VycmVudExldmVsKCkgewoKCQlyZXR1cm4gdGhpcy5fY3VycmVudExldmVsOwoKCX0KCgoKCWdldE9iamVjdEZvckRpc3RhbmNlKCBkaXN0YW5jZSApIHsKCgkJY29uc3QgbGV2ZWxzID0gdGhpcy5sZXZlbHM7CgoJCWlmICggbGV2ZWxzLmxlbmd0aCA+IDAgKSB7CgoJCQlsZXQgaSwgbDsKCgkJCWZvciAoIGkgPSAxLCBsID0gbGV2ZWxzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJbGV0IGxldmVsRGlzdGFuY2UgPSBsZXZlbHNbIGkgXS5kaXN0YW5jZTsKCgkJCQlpZiAoIGxldmVsc1sgaSBdLm9iamVjdC52aXNpYmxlICkgewoKCQkJCQlsZXZlbERpc3RhbmNlIC09IGxldmVsRGlzdGFuY2UgKiBsZXZlbHNbIGkgXS5oeXN0ZXJlc2lzOwoKCQkJCX0KCgkJCQlpZiAoIGRpc3RhbmNlIDwgbGV2ZWxEaXN0YW5jZSApIHsKCgkJCQkJYnJlYWs7CgoJCQkJfQoKCQkJfQoKCQkJcmV0dXJuIGxldmVsc1sgaSAtIDEgXS5vYmplY3Q7CgoJCX0KCgkJcmV0dXJuIG51bGw7CgoJfQoKCXJheWNhc3QoIHJheWNhc3RlciwgaW50ZXJzZWN0cyApIHsKCgkJY29uc3QgbGV2ZWxzID0gdGhpcy5sZXZlbHM7CgoJCWlmICggbGV2ZWxzLmxlbmd0aCA+IDAgKSB7CgoJCQlfdjEkMi5zZXRGcm9tTWF0cml4UG9zaXRpb24oIHRoaXMubWF0cml4V29ybGQgKTsKCgkJCWNvbnN0IGRpc3RhbmNlID0gcmF5Y2FzdGVyLnJheS5vcmlnaW4uZGlzdGFuY2VUbyggX3YxJDIgKTsKCgkJCXRoaXMuZ2V0T2JqZWN0Rm9yRGlzdGFuY2UoIGRpc3RhbmNlICkucmF5Y2FzdCggcmF5Y2FzdGVyLCBpbnRlcnNlY3RzICk7CgoJCX0KCgl9CgoJdXBkYXRlKCBjYW1lcmEgKSB7CgoJCWNvbnN0IGxldmVscyA9IHRoaXMubGV2ZWxzOwoKCQlpZiAoIGxldmVscy5sZW5ndGggPiAxICkgewoKCQkJX3YxJDIuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCBjYW1lcmEubWF0cml4V29ybGQgKTsKCQkJX3YyJDEuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCB0aGlzLm1hdHJpeFdvcmxkICk7CgoJCQljb25zdCBkaXN0YW5jZSA9IF92MSQyLmRpc3RhbmNlVG8oIF92MiQxICkgLyBjYW1lcmEuem9vbTsKCgkJCWxldmVsc1sgMCBdLm9iamVjdC52aXNpYmxlID0gdHJ1ZTsKCgkJCWxldCBpLCBsOwoKCQkJZm9yICggaSA9IDEsIGwgPSBsZXZlbHMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQlsZXQgbGV2ZWxEaXN0YW5jZSA9IGxldmVsc1sgaSBdLmRpc3RhbmNlOwoKCQkJCWlmICggbGV2ZWxzWyBpIF0ub2JqZWN0LnZpc2libGUgKSB7CgoJCQkJCWxldmVsRGlzdGFuY2UgLT0gbGV2ZWxEaXN0YW5jZSAqIGxldmVsc1sgaSBdLmh5c3RlcmVzaXM7CgoJCQkJfQoKCQkJCWlmICggZGlzdGFuY2UgPj0gbGV2ZWxEaXN0YW5jZSApIHsKCgkJCQkJbGV2ZWxzWyBpIC0gMSBdLm9iamVjdC52aXNpYmxlID0gZmFsc2U7CgkJCQkJbGV2ZWxzWyBpIF0ub2JqZWN0LnZpc2libGUgPSB0cnVlOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWJyZWFrOwoKCQkJCX0KCgkJCX0KCgkJCXRoaXMuX2N1cnJlbnRMZXZlbCA9IGkgLSAxOwoKCQkJZm9yICggOyBpIDwgbDsgaSArKyApIHsKCgkJCQlsZXZlbHNbIGkgXS5vYmplY3QudmlzaWJsZSA9IGZhbHNlOwoKCQkJfQoKCQl9CgoJfQoKCXRvSlNPTiggbWV0YSApIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTiggbWV0YSApOwoKCQlpZiAoIHRoaXMuYXV0b1VwZGF0ZSA9PT0gZmFsc2UgKSBkYXRhLm9iamVjdC5hdXRvVXBkYXRlID0gZmFsc2U7CgoJCWRhdGEub2JqZWN0LmxldmVscyA9IFtdOwoKCQljb25zdCBsZXZlbHMgPSB0aGlzLmxldmVsczsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gbGV2ZWxzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljb25zdCBsZXZlbCA9IGxldmVsc1sgaSBdOwoKCQkJZGF0YS5vYmplY3QubGV2ZWxzLnB1c2goIHsKCQkJCW9iamVjdDogbGV2ZWwub2JqZWN0LnV1aWQsCgkJCQlkaXN0YW5jZTogbGV2ZWwuZGlzdGFuY2UsCgkJCQloeXN0ZXJlc2lzOiBsZXZlbC5oeXN0ZXJlc2lzCgkJCX0gKTsKCgkJfQoKCQlyZXR1cm4gZGF0YTsKCgl9Cgp9Cgpjb25zdCBfYmFzZVBvc2l0aW9uID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwoKY29uc3QgX3NraW5JbmRleCA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjQoKTsKY29uc3QgX3NraW5XZWlnaHQgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3I0KCk7Cgpjb25zdCBfdmVjdG9yMyA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX21hdHJpeDQgPSAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXg0KCk7CmNvbnN0IF92ZXJ0ZXggPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7Cgpjb25zdCBfc3BoZXJlJDQgPSAvKkBfX1BVUkVfXyovIG5ldyBTcGhlcmUoKTsKY29uc3QgX2ludmVyc2VNYXRyaXgkMiA9IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDQoKTsKY29uc3QgX3JheSQyID0gLypAX19QVVJFX18qLyBuZXcgUmF5KCk7CgpjbGFzcyBTa2lubmVkTWVzaCBleHRlbmRzIE1lc2ggewoKCWNvbnN0cnVjdG9yKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKSB7CgoJCXN1cGVyKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTsKCgkJdGhpcy5pc1NraW5uZWRNZXNoID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ1NraW5uZWRNZXNoJzsKCgkJdGhpcy5iaW5kTW9kZSA9IEF0dGFjaGVkQmluZE1vZGU7CgkJdGhpcy5iaW5kTWF0cml4ID0gbmV3IE1hdHJpeDQoKTsKCQl0aGlzLmJpbmRNYXRyaXhJbnZlcnNlID0gbmV3IE1hdHJpeDQoKTsKCgkJdGhpcy5ib3VuZGluZ0JveCA9IG51bGw7CgkJdGhpcy5ib3VuZGluZ1NwaGVyZSA9IG51bGw7CgoJfQoKCWNvbXB1dGVCb3VuZGluZ0JveCgpIHsKCgkJY29uc3QgZ2VvbWV0cnkgPSB0aGlzLmdlb21ldHJ5OwoKCQlpZiAoIHRoaXMuYm91bmRpbmdCb3ggPT09IG51bGwgKSB7CgoJCQl0aGlzLmJvdW5kaW5nQm94ID0gbmV3IEJveDMoKTsKCgkJfQoKCQl0aGlzLmJvdW5kaW5nQm94Lm1ha2VFbXB0eSgpOwoKCQljb25zdCBwb3NpdGlvbkF0dHJpYnV0ZSA9IGdlb21ldHJ5LmdldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJyApOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBwb3NpdGlvbkF0dHJpYnV0ZS5jb3VudDsgaSArKyApIHsKCgkJCXRoaXMuZ2V0VmVydGV4UG9zaXRpb24oIGksIF92ZXJ0ZXggKTsKCQkJdGhpcy5ib3VuZGluZ0JveC5leHBhbmRCeVBvaW50KCBfdmVydGV4ICk7CgoJCX0KCgl9CgoJY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCkgewoKCQljb25zdCBnZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnk7CgoJCWlmICggdGhpcy5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCApIHsKCgkJCXRoaXMuYm91bmRpbmdTcGhlcmUgPSBuZXcgU3BoZXJlKCk7CgoJCX0KCgkJdGhpcy5ib3VuZGluZ1NwaGVyZS5tYWtlRW1wdHkoKTsKCgkJY29uc3QgcG9zaXRpb25BdHRyaWJ1dGUgPSBnZW9tZXRyeS5nZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicgKTsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgcG9zaXRpb25BdHRyaWJ1dGUuY291bnQ7IGkgKysgKSB7CgoJCQl0aGlzLmdldFZlcnRleFBvc2l0aW9uKCBpLCBfdmVydGV4ICk7CgkJCXRoaXMuYm91bmRpbmdTcGhlcmUuZXhwYW5kQnlQb2ludCggX3ZlcnRleCApOwoKCQl9CgoJfQoKCWNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApOwoKCQl0aGlzLmJpbmRNb2RlID0gc291cmNlLmJpbmRNb2RlOwoJCXRoaXMuYmluZE1hdHJpeC5jb3B5KCBzb3VyY2UuYmluZE1hdHJpeCApOwoJCXRoaXMuYmluZE1hdHJpeEludmVyc2UuY29weSggc291cmNlLmJpbmRNYXRyaXhJbnZlcnNlICk7CgoJCXRoaXMuc2tlbGV0b24gPSBzb3VyY2Uuc2tlbGV0b247CgoJCWlmICggc291cmNlLmJvdW5kaW5nQm94ICE9PSBudWxsICkgdGhpcy5ib3VuZGluZ0JveCA9IHNvdXJjZS5ib3VuZGluZ0JveC5jbG9uZSgpOwoJCWlmICggc291cmNlLmJvdW5kaW5nU3BoZXJlICE9PSBudWxsICkgdGhpcy5ib3VuZGluZ1NwaGVyZSA9IHNvdXJjZS5ib3VuZGluZ1NwaGVyZS5jbG9uZSgpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcmF5Y2FzdCggcmF5Y2FzdGVyLCBpbnRlcnNlY3RzICkgewoKCQljb25zdCBtYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWw7CgkJY29uc3QgbWF0cml4V29ybGQgPSB0aGlzLm1hdHJpeFdvcmxkOwoKCQlpZiAoIG1hdGVyaWFsID09PSB1bmRlZmluZWQgKSByZXR1cm47CgoJCS8vIHRlc3Qgd2l0aCBib3VuZGluZyBzcGhlcmUgaW4gd29ybGQgc3BhY2UKCgkJaWYgKCB0aGlzLmJvdW5kaW5nU3BoZXJlID09PSBudWxsICkgdGhpcy5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTsKCgkJX3NwaGVyZSQ0LmNvcHkoIHRoaXMuYm91bmRpbmdTcGhlcmUgKTsKCQlfc3BoZXJlJDQuYXBwbHlNYXRyaXg0KCBtYXRyaXhXb3JsZCApOwoKCQlpZiAoIHJheWNhc3Rlci5yYXkuaW50ZXJzZWN0c1NwaGVyZSggX3NwaGVyZSQ0ICkgPT09IGZhbHNlICkgcmV0dXJuOwoKCQkvLyBjb252ZXJ0IHJheSB0byBsb2NhbCBzcGFjZSBvZiBza2lubmVkIG1lc2gKCgkJX2ludmVyc2VNYXRyaXgkMi5jb3B5KCBtYXRyaXhXb3JsZCApLmludmVydCgpOwoJCV9yYXkkMi5jb3B5KCByYXljYXN0ZXIucmF5ICkuYXBwbHlNYXRyaXg0KCBfaW52ZXJzZU1hdHJpeCQyICk7CgoJCS8vIHRlc3Qgd2l0aCBib3VuZGluZyBib3ggaW4gbG9jYWwgc3BhY2UKCgkJaWYgKCB0aGlzLmJvdW5kaW5nQm94ICE9PSBudWxsICkgewoKCQkJaWYgKCBfcmF5JDIuaW50ZXJzZWN0c0JveCggdGhpcy5ib3VuZGluZ0JveCApID09PSBmYWxzZSApIHJldHVybjsKCgkJfQoKCQkvLyB0ZXN0IGZvciBpbnRlcnNlY3Rpb25zIHdpdGggZ2VvbWV0cnkKCgkJdGhpcy5fY29tcHV0ZUludGVyc2VjdGlvbnMoIHJheWNhc3RlciwgaW50ZXJzZWN0cywgX3JheSQyICk7CgoJfQoKCWdldFZlcnRleFBvc2l0aW9uKCBpbmRleCwgdGFyZ2V0ICkgewoKCQlzdXBlci5nZXRWZXJ0ZXhQb3NpdGlvbiggaW5kZXgsIHRhcmdldCApOwoKCQl0aGlzLmFwcGx5Qm9uZVRyYW5zZm9ybSggaW5kZXgsIHRhcmdldCApOwoKCQlyZXR1cm4gdGFyZ2V0OwoKCX0KCgliaW5kKCBza2VsZXRvbiwgYmluZE1hdHJpeCApIHsKCgkJdGhpcy5za2VsZXRvbiA9IHNrZWxldG9uOwoKCQlpZiAoIGJpbmRNYXRyaXggPT09IHVuZGVmaW5lZCApIHsKCgkJCXRoaXMudXBkYXRlTWF0cml4V29ybGQoIHRydWUgKTsKCgkJCXRoaXMuc2tlbGV0b24uY2FsY3VsYXRlSW52ZXJzZXMoKTsKCgkJCWJpbmRNYXRyaXggPSB0aGlzLm1hdHJpeFdvcmxkOwoKCQl9CgoJCXRoaXMuYmluZE1hdHJpeC5jb3B5KCBiaW5kTWF0cml4ICk7CgkJdGhpcy5iaW5kTWF0cml4SW52ZXJzZS5jb3B5KCBiaW5kTWF0cml4ICkuaW52ZXJ0KCk7CgoJfQoKCXBvc2UoKSB7CgoJCXRoaXMuc2tlbGV0b24ucG9zZSgpOwoKCX0KCglub3JtYWxpemVTa2luV2VpZ2h0cygpIHsKCgkJY29uc3QgdmVjdG9yID0gbmV3IFZlY3RvcjQoKTsKCgkJY29uc3Qgc2tpbldlaWdodCA9IHRoaXMuZ2VvbWV0cnkuYXR0cmlidXRlcy5za2luV2VpZ2h0OwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBza2luV2VpZ2h0LmNvdW50OyBpIDwgbDsgaSArKyApIHsKCgkJCXZlY3Rvci5mcm9tQnVmZmVyQXR0cmlidXRlKCBza2luV2VpZ2h0LCBpICk7CgoJCQljb25zdCBzY2FsZSA9IDEuMCAvIHZlY3Rvci5tYW5oYXR0YW5MZW5ndGgoKTsKCgkJCWlmICggc2NhbGUgIT09IEluZmluaXR5ICkgewoKCQkJCXZlY3Rvci5tdWx0aXBseVNjYWxhciggc2NhbGUgKTsKCgkJCX0gZWxzZSB7CgoJCQkJdmVjdG9yLnNldCggMSwgMCwgMCwgMCApOyAvLyBkbyBzb21ldGhpbmcgcmVhc29uYWJsZQoKCQkJfQoKCQkJc2tpbldlaWdodC5zZXRYWVpXKCBpLCB2ZWN0b3IueCwgdmVjdG9yLnksIHZlY3Rvci56LCB2ZWN0b3IudyApOwoKCQl9CgoJfQoKCXVwZGF0ZU1hdHJpeFdvcmxkKCBmb3JjZSApIHsKCgkJc3VwZXIudXBkYXRlTWF0cml4V29ybGQoIGZvcmNlICk7CgoJCWlmICggdGhpcy5iaW5kTW9kZSA9PT0gQXR0YWNoZWRCaW5kTW9kZSApIHsKCgkJCXRoaXMuYmluZE1hdHJpeEludmVyc2UuY29weSggdGhpcy5tYXRyaXhXb3JsZCApLmludmVydCgpOwoKCQl9IGVsc2UgaWYgKCB0aGlzLmJpbmRNb2RlID09PSBEZXRhY2hlZEJpbmRNb2RlICkgewoKCQkJdGhpcy5iaW5kTWF0cml4SW52ZXJzZS5jb3B5KCB0aGlzLmJpbmRNYXRyaXggKS5pbnZlcnQoKTsKCgkJfSBlbHNlIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLlNraW5uZWRNZXNoOiBVbnJlY29nbml6ZWQgYmluZE1vZGU6ICcgKyB0aGlzLmJpbmRNb2RlICk7CgoJCX0KCgl9CgoJYXBwbHlCb25lVHJhbnNmb3JtKCBpbmRleCwgdmVjdG9yICkgewoKCQljb25zdCBza2VsZXRvbiA9IHRoaXMuc2tlbGV0b247CgkJY29uc3QgZ2VvbWV0cnkgPSB0aGlzLmdlb21ldHJ5OwoKCQlfc2tpbkluZGV4LmZyb21CdWZmZXJBdHRyaWJ1dGUoIGdlb21ldHJ5LmF0dHJpYnV0ZXMuc2tpbkluZGV4LCBpbmRleCApOwoJCV9za2luV2VpZ2h0LmZyb21CdWZmZXJBdHRyaWJ1dGUoIGdlb21ldHJ5LmF0dHJpYnV0ZXMuc2tpbldlaWdodCwgaW5kZXggKTsKCgkJX2Jhc2VQb3NpdGlvbi5jb3B5KCB2ZWN0b3IgKS5hcHBseU1hdHJpeDQoIHRoaXMuYmluZE1hdHJpeCApOwoKCQl2ZWN0b3Iuc2V0KCAwLCAwLCAwICk7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IDQ7IGkgKysgKSB7CgoJCQljb25zdCB3ZWlnaHQgPSBfc2tpbldlaWdodC5nZXRDb21wb25lbnQoIGkgKTsKCgkJCWlmICggd2VpZ2h0ICE9PSAwICkgewoKCQkJCWNvbnN0IGJvbmVJbmRleCA9IF9za2luSW5kZXguZ2V0Q29tcG9uZW50KCBpICk7CgoJCQkJX21hdHJpeDQubXVsdGlwbHlNYXRyaWNlcyggc2tlbGV0b24uYm9uZXNbIGJvbmVJbmRleCBdLm1hdHJpeFdvcmxkLCBza2VsZXRvbi5ib25lSW52ZXJzZXNbIGJvbmVJbmRleCBdICk7CgoJCQkJdmVjdG9yLmFkZFNjYWxlZFZlY3RvciggX3ZlY3RvcjMuY29weSggX2Jhc2VQb3NpdGlvbiApLmFwcGx5TWF0cml4NCggX21hdHJpeDQgKSwgd2VpZ2h0ICk7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIHZlY3Rvci5hcHBseU1hdHJpeDQoIHRoaXMuYmluZE1hdHJpeEludmVyc2UgKTsKCgl9Cgp9CgpjbGFzcyBCb25lIGV4dGVuZHMgT2JqZWN0M0QgewoKCWNvbnN0cnVjdG9yKCkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzQm9uZSA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdCb25lJzsKCgl9Cgp9CgpjbGFzcyBEYXRhVGV4dHVyZSBleHRlbmRzIFRleHR1cmUgewoKCWNvbnN0cnVjdG9yKCBkYXRhID0gbnVsbCwgd2lkdGggPSAxLCBoZWlnaHQgPSAxLCBmb3JtYXQsIHR5cGUsIG1hcHBpbmcsIHdyYXBTLCB3cmFwVCwgbWFnRmlsdGVyID0gTmVhcmVzdEZpbHRlciwgbWluRmlsdGVyID0gTmVhcmVzdEZpbHRlciwgYW5pc290cm9weSwgY29sb3JTcGFjZSApIHsKCgkJc3VwZXIoIG51bGwsIG1hcHBpbmcsIHdyYXBTLCB3cmFwVCwgbWFnRmlsdGVyLCBtaW5GaWx0ZXIsIGZvcm1hdCwgdHlwZSwgYW5pc290cm9weSwgY29sb3JTcGFjZSApOwoKCQl0aGlzLmlzRGF0YVRleHR1cmUgPSB0cnVlOwoKCQl0aGlzLmltYWdlID0geyBkYXRhOiBkYXRhLCB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0IH07CgoJCXRoaXMuZ2VuZXJhdGVNaXBtYXBzID0gZmFsc2U7CgkJdGhpcy5mbGlwWSA9IGZhbHNlOwoJCXRoaXMudW5wYWNrQWxpZ25tZW50ID0gMTsKCgl9Cgp9Cgpjb25zdCBfb2Zmc2V0TWF0cml4ID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwpjb25zdCBfaWRlbnRpdHlNYXRyaXgkMSA9IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDQoKTsKCmNsYXNzIFNrZWxldG9uIHsKCgljb25zdHJ1Y3RvciggYm9uZXMgPSBbXSwgYm9uZUludmVyc2VzID0gW10gKSB7CgoJCXRoaXMudXVpZCA9IGdlbmVyYXRlVVVJRCgpOwoKCQl0aGlzLmJvbmVzID0gYm9uZXMuc2xpY2UoIDAgKTsKCQl0aGlzLmJvbmVJbnZlcnNlcyA9IGJvbmVJbnZlcnNlczsKCQl0aGlzLmJvbmVNYXRyaWNlcyA9IG51bGw7CgoJCXRoaXMuYm9uZVRleHR1cmUgPSBudWxsOwoKCQl0aGlzLmluaXQoKTsKCgl9CgoJaW5pdCgpIHsKCgkJY29uc3QgYm9uZXMgPSB0aGlzLmJvbmVzOwoJCWNvbnN0IGJvbmVJbnZlcnNlcyA9IHRoaXMuYm9uZUludmVyc2VzOwoKCQl0aGlzLmJvbmVNYXRyaWNlcyA9IG5ldyBGbG9hdDMyQXJyYXkoIGJvbmVzLmxlbmd0aCAqIDE2ICk7CgoJCS8vIGNhbGN1bGF0ZSBpbnZlcnNlIGJvbmUgbWF0cmljZXMgaWYgbmVjZXNzYXJ5CgoJCWlmICggYm9uZUludmVyc2VzLmxlbmd0aCA9PT0gMCApIHsKCgkJCXRoaXMuY2FsY3VsYXRlSW52ZXJzZXMoKTsKCgkJfSBlbHNlIHsKCgkJCS8vIGhhbmRsZSBzcGVjaWFsIGNhc2UKCgkJCWlmICggYm9uZXMubGVuZ3RoICE9PSBib25lSW52ZXJzZXMubGVuZ3RoICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLlNrZWxldG9uOiBOdW1iZXIgb2YgaW52ZXJzZSBib25lIG1hdHJpY2VzIGRvZXMgbm90IG1hdGNoIGFtb3VudCBvZiBib25lcy4nICk7CgoJCQkJdGhpcy5ib25lSW52ZXJzZXMgPSBbXTsKCgkJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gdGhpcy5ib25lcy5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCQkJdGhpcy5ib25lSW52ZXJzZXMucHVzaCggbmV3IE1hdHJpeDQoKSApOwoKCQkJCX0KCgkJCX0KCgkJfQoKCX0KCgljYWxjdWxhdGVJbnZlcnNlcygpIHsKCgkJdGhpcy5ib25lSW52ZXJzZXMubGVuZ3RoID0gMDsKCgkJZm9yICggbGV0IGkgPSAwLCBpbCA9IHRoaXMuYm9uZXMubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQljb25zdCBpbnZlcnNlID0gbmV3IE1hdHJpeDQoKTsKCgkJCWlmICggdGhpcy5ib25lc1sgaSBdICkgewoKCQkJCWludmVyc2UuY29weSggdGhpcy5ib25lc1sgaSBdLm1hdHJpeFdvcmxkICkuaW52ZXJ0KCk7CgoJCQl9CgoJCQl0aGlzLmJvbmVJbnZlcnNlcy5wdXNoKCBpbnZlcnNlICk7CgoJCX0KCgl9CgoJcG9zZSgpIHsKCgkJLy8gcmVjb3ZlciB0aGUgYmluZC10aW1lIHdvcmxkIG1hdHJpY2VzCgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSB0aGlzLmJvbmVzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJY29uc3QgYm9uZSA9IHRoaXMuYm9uZXNbIGkgXTsKCgkJCWlmICggYm9uZSApIHsKCgkJCQlib25lLm1hdHJpeFdvcmxkLmNvcHkoIHRoaXMuYm9uZUludmVyc2VzWyBpIF0gKS5pbnZlcnQoKTsKCgkJCX0KCgkJfQoKCQkvLyBjb21wdXRlIHRoZSBsb2NhbCBtYXRyaWNlcywgcG9zaXRpb25zLCByb3RhdGlvbnMgYW5kIHNjYWxlcwoKCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gdGhpcy5ib25lcy5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCWNvbnN0IGJvbmUgPSB0aGlzLmJvbmVzWyBpIF07CgoJCQlpZiAoIGJvbmUgKSB7CgoJCQkJaWYgKCBib25lLnBhcmVudCAmJiBib25lLnBhcmVudC5pc0JvbmUgKSB7CgoJCQkJCWJvbmUubWF0cml4LmNvcHkoIGJvbmUucGFyZW50Lm1hdHJpeFdvcmxkICkuaW52ZXJ0KCk7CgkJCQkJYm9uZS5tYXRyaXgubXVsdGlwbHkoIGJvbmUubWF0cml4V29ybGQgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlib25lLm1hdHJpeC5jb3B5KCBib25lLm1hdHJpeFdvcmxkICk7CgoJCQkJfQoKCQkJCWJvbmUubWF0cml4LmRlY29tcG9zZSggYm9uZS5wb3NpdGlvbiwgYm9uZS5xdWF0ZXJuaW9uLCBib25lLnNjYWxlICk7CgoJCQl9CgoJCX0KCgl9CgoJdXBkYXRlKCkgewoKCQljb25zdCBib25lcyA9IHRoaXMuYm9uZXM7CgkJY29uc3QgYm9uZUludmVyc2VzID0gdGhpcy5ib25lSW52ZXJzZXM7CgkJY29uc3QgYm9uZU1hdHJpY2VzID0gdGhpcy5ib25lTWF0cmljZXM7CgkJY29uc3QgYm9uZVRleHR1cmUgPSB0aGlzLmJvbmVUZXh0dXJlOwoKCQkvLyBmbGF0dGVuIGJvbmUgbWF0cmljZXMgdG8gYXJyYXkKCgkJZm9yICggbGV0IGkgPSAwLCBpbCA9IGJvbmVzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJLy8gY29tcHV0ZSB0aGUgb2Zmc2V0IGJldHdlZW4gdGhlIGN1cnJlbnQgYW5kIHRoZSBvcmlnaW5hbCB0cmFuc2Zvcm0KCgkJCWNvbnN0IG1hdHJpeCA9IGJvbmVzWyBpIF0gPyBib25lc1sgaSBdLm1hdHJpeFdvcmxkIDogX2lkZW50aXR5TWF0cml4JDE7CgoJCQlfb2Zmc2V0TWF0cml4Lm11bHRpcGx5TWF0cmljZXMoIG1hdHJpeCwgYm9uZUludmVyc2VzWyBpIF0gKTsKCQkJX29mZnNldE1hdHJpeC50b0FycmF5KCBib25lTWF0cmljZXMsIGkgKiAxNiApOwoKCQl9CgoJCWlmICggYm9uZVRleHR1cmUgIT09IG51bGwgKSB7CgoJCQlib25lVGV4dHVyZS5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCX0KCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgU2tlbGV0b24oIHRoaXMuYm9uZXMsIHRoaXMuYm9uZUludmVyc2VzICk7CgoJfQoKCWNvbXB1dGVCb25lVGV4dHVyZSgpIHsKCgkJLy8gbGF5b3V0ICgxIG1hdHJpeCA9IDQgcGl4ZWxzKQoJCS8vICAgICAgUkdCQSBSR0JBIFJHQkEgUkdCQSAoPT4gY29sdW1uMSwgY29sdW1uMiwgY29sdW1uMywgY29sdW1uNCkKCQkvLyAgd2l0aCAgOHg4ICBwaXhlbCB0ZXh0dXJlIG1heCAgIDE2IGJvbmVzICogNCBwaXhlbHMgPSAgKDggKiA4KQoJCS8vICAgICAgIDE2eDE2IHBpeGVsIHRleHR1cmUgbWF4ICAgNjQgYm9uZXMgKiA0IHBpeGVscyA9ICgxNiAqIDE2KQoJCS8vICAgICAgIDMyeDMyIHBpeGVsIHRleHR1cmUgbWF4ICAyNTYgYm9uZXMgKiA0IHBpeGVscyA9ICgzMiAqIDMyKQoJCS8vICAgICAgIDY0eDY0IHBpeGVsIHRleHR1cmUgbWF4IDEwMjQgYm9uZXMgKiA0IHBpeGVscyA9ICg2NCAqIDY0KQoKCQlsZXQgc2l6ZSA9IE1hdGguc3FydCggdGhpcy5ib25lcy5sZW5ndGggKiA0ICk7IC8vIDQgcGl4ZWxzIG5lZWRlZCBmb3IgMSBtYXRyaXgKCQlzaXplID0gTWF0aC5jZWlsKCBzaXplIC8gNCApICogNDsKCQlzaXplID0gTWF0aC5tYXgoIHNpemUsIDQgKTsKCgkJY29uc3QgYm9uZU1hdHJpY2VzID0gbmV3IEZsb2F0MzJBcnJheSggc2l6ZSAqIHNpemUgKiA0ICk7IC8vIDQgZmxvYXRzIHBlciBSR0JBIHBpeGVsCgkJYm9uZU1hdHJpY2VzLnNldCggdGhpcy5ib25lTWF0cmljZXMgKTsgLy8gY29weSBjdXJyZW50IHZhbHVlcwoKCQljb25zdCBib25lVGV4dHVyZSA9IG5ldyBEYXRhVGV4dHVyZSggYm9uZU1hdHJpY2VzLCBzaXplLCBzaXplLCBSR0JBRm9ybWF0LCBGbG9hdFR5cGUgKTsKCQlib25lVGV4dHVyZS5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCXRoaXMuYm9uZU1hdHJpY2VzID0gYm9uZU1hdHJpY2VzOwoJCXRoaXMuYm9uZVRleHR1cmUgPSBib25lVGV4dHVyZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldEJvbmVCeU5hbWUoIG5hbWUgKSB7CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSB0aGlzLmJvbmVzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJY29uc3QgYm9uZSA9IHRoaXMuYm9uZXNbIGkgXTsKCgkJCWlmICggYm9uZS5uYW1lID09PSBuYW1lICkgewoKCQkJCXJldHVybiBib25lOwoKCQkJfQoKCQl9CgoJCXJldHVybiB1bmRlZmluZWQ7CgoJfQoKCWRpc3Bvc2UoICkgewoKCQlpZiAoIHRoaXMuYm9uZVRleHR1cmUgIT09IG51bGwgKSB7CgoJCQl0aGlzLmJvbmVUZXh0dXJlLmRpc3Bvc2UoKTsKCgkJCXRoaXMuYm9uZVRleHR1cmUgPSBudWxsOwoKCQl9CgoJfQoKCWZyb21KU09OKCBqc29uLCBib25lcyApIHsKCgkJdGhpcy51dWlkID0ganNvbi51dWlkOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBqc29uLmJvbmVzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljb25zdCB1dWlkID0ganNvbi5ib25lc1sgaSBdOwoJCQlsZXQgYm9uZSA9IGJvbmVzWyB1dWlkIF07CgoJCQlpZiAoIGJvbmUgPT09IHVuZGVmaW5lZCApIHsKCgkJCQljb25zb2xlLndhcm4oICdUSFJFRS5Ta2VsZXRvbjogTm8gYm9uZSBmb3VuZCB3aXRoIFVVSUQ6JywgdXVpZCApOwoJCQkJYm9uZSA9IG5ldyBCb25lKCk7CgoJCQl9CgoJCQl0aGlzLmJvbmVzLnB1c2goIGJvbmUgKTsKCQkJdGhpcy5ib25lSW52ZXJzZXMucHVzaCggbmV3IE1hdHJpeDQoKS5mcm9tQXJyYXkoIGpzb24uYm9uZUludmVyc2VzWyBpIF0gKSApOwoKCQl9CgoJCXRoaXMuaW5pdCgpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCkgewoKCQljb25zdCBkYXRhID0gewoJCQltZXRhZGF0YTogewoJCQkJdmVyc2lvbjogNC42LAoJCQkJdHlwZTogJ1NrZWxldG9uJywKCQkJCWdlbmVyYXRvcjogJ1NrZWxldG9uLnRvSlNPTicKCQkJfSwKCQkJYm9uZXM6IFtdLAoJCQlib25lSW52ZXJzZXM6IFtdCgkJfTsKCgkJZGF0YS51dWlkID0gdGhpcy51dWlkOwoKCQljb25zdCBib25lcyA9IHRoaXMuYm9uZXM7CgkJY29uc3QgYm9uZUludmVyc2VzID0gdGhpcy5ib25lSW52ZXJzZXM7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IGJvbmVzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljb25zdCBib25lID0gYm9uZXNbIGkgXTsKCQkJZGF0YS5ib25lcy5wdXNoKCBib25lLnV1aWQgKTsKCgkJCWNvbnN0IGJvbmVJbnZlcnNlID0gYm9uZUludmVyc2VzWyBpIF07CgkJCWRhdGEuYm9uZUludmVyc2VzLnB1c2goIGJvbmVJbnZlcnNlLnRvQXJyYXkoKSApOwoKCQl9CgoJCXJldHVybiBkYXRhOwoKCX0KCn0KCmNsYXNzIEluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZSBleHRlbmRzIEJ1ZmZlckF0dHJpYnV0ZSB7CgoJY29uc3RydWN0b3IoIGFycmF5LCBpdGVtU2l6ZSwgbm9ybWFsaXplZCwgbWVzaFBlckF0dHJpYnV0ZSA9IDEgKSB7CgoJCXN1cGVyKCBhcnJheSwgaXRlbVNpemUsIG5vcm1hbGl6ZWQgKTsKCgkJdGhpcy5pc0luc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZSA9IHRydWU7CgoJCXRoaXMubWVzaFBlckF0dHJpYnV0ZSA9IG1lc2hQZXJBdHRyaWJ1dGU7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMubWVzaFBlckF0dHJpYnV0ZSA9IHNvdXJjZS5tZXNoUGVyQXR0cmlidXRlOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCkgewoKCQljb25zdCBkYXRhID0gc3VwZXIudG9KU09OKCk7CgoJCWRhdGEubWVzaFBlckF0dHJpYnV0ZSA9IHRoaXMubWVzaFBlckF0dHJpYnV0ZTsKCgkJZGF0YS5pc0luc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZSA9IHRydWU7CgoJCXJldHVybiBkYXRhOwoKCX0KCn0KCmNvbnN0IF9pbnN0YW5jZUxvY2FsTWF0cml4ID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwpjb25zdCBfaW5zdGFuY2VXb3JsZE1hdHJpeCA9IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDQoKTsKCmNvbnN0IF9pbnN0YW5jZUludGVyc2VjdHMgPSBbXTsKCmNvbnN0IF9ib3gzID0gLypAX19QVVJFX18qLyBuZXcgQm94MygpOwpjb25zdCBfaWRlbnRpdHkgPSAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXg0KCk7CmNvbnN0IF9tZXNoJDEgPSAvKkBfX1BVUkVfXyovIG5ldyBNZXNoKCk7CmNvbnN0IF9zcGhlcmUkMyA9IC8qQF9fUFVSRV9fKi8gbmV3IFNwaGVyZSgpOwoKY2xhc3MgSW5zdGFuY2VkTWVzaCBleHRlbmRzIE1lc2ggewoKCWNvbnN0cnVjdG9yKCBnZW9tZXRyeSwgbWF0ZXJpYWwsIGNvdW50ICkgewoKCQlzdXBlciggZ2VvbWV0cnksIG1hdGVyaWFsICk7CgoJCXRoaXMuaXNJbnN0YW5jZWRNZXNoID0gdHJ1ZTsKCgkJdGhpcy5pbnN0YW5jZU1hdHJpeCA9IG5ldyBJbnN0YW5jZWRCdWZmZXJBdHRyaWJ1dGUoIG5ldyBGbG9hdDMyQXJyYXkoIGNvdW50ICogMTYgKSwgMTYgKTsKCQl0aGlzLmluc3RhbmNlQ29sb3IgPSBudWxsOwoKCQl0aGlzLmNvdW50ID0gY291bnQ7CgoJCXRoaXMuYm91bmRpbmdCb3ggPSBudWxsOwoJCXRoaXMuYm91bmRpbmdTcGhlcmUgPSBudWxsOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSArKyApIHsKCgkJCXRoaXMuc2V0TWF0cml4QXQoIGksIF9pZGVudGl0eSApOwoKCQl9CgoJfQoKCWNvbXB1dGVCb3VuZGluZ0JveCgpIHsKCgkJY29uc3QgZ2VvbWV0cnkgPSB0aGlzLmdlb21ldHJ5OwoJCWNvbnN0IGNvdW50ID0gdGhpcy5jb3VudDsKCgkJaWYgKCB0aGlzLmJvdW5kaW5nQm94ID09PSBudWxsICkgewoKCQkJdGhpcy5ib3VuZGluZ0JveCA9IG5ldyBCb3gzKCk7CgoJCX0KCgkJaWYgKCBnZW9tZXRyeS5ib3VuZGluZ0JveCA9PT0gbnVsbCApIHsKCgkJCWdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ0JveCgpOwoKCQl9CgoJCXRoaXMuYm91bmRpbmdCb3gubWFrZUVtcHR5KCk7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IGNvdW50OyBpICsrICkgewoKCQkJdGhpcy5nZXRNYXRyaXhBdCggaSwgX2luc3RhbmNlTG9jYWxNYXRyaXggKTsKCgkJCV9ib3gzLmNvcHkoIGdlb21ldHJ5LmJvdW5kaW5nQm94ICkuYXBwbHlNYXRyaXg0KCBfaW5zdGFuY2VMb2NhbE1hdHJpeCApOwoKCQkJdGhpcy5ib3VuZGluZ0JveC51bmlvbiggX2JveDMgKTsKCgkJfQoKCX0KCgljb21wdXRlQm91bmRpbmdTcGhlcmUoKSB7CgoJCWNvbnN0IGdlb21ldHJ5ID0gdGhpcy5nZW9tZXRyeTsKCQljb25zdCBjb3VudCA9IHRoaXMuY291bnQ7CgoJCWlmICggdGhpcy5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCApIHsKCgkJCXRoaXMuYm91bmRpbmdTcGhlcmUgPSBuZXcgU3BoZXJlKCk7CgoJCX0KCgkJaWYgKCBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCApIHsKCgkJCWdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwoKCQl9CgoJCXRoaXMuYm91bmRpbmdTcGhlcmUubWFrZUVtcHR5KCk7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IGNvdW50OyBpICsrICkgewoKCQkJdGhpcy5nZXRNYXRyaXhBdCggaSwgX2luc3RhbmNlTG9jYWxNYXRyaXggKTsKCgkJCV9zcGhlcmUkMy5jb3B5KCBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSApLmFwcGx5TWF0cml4NCggX2luc3RhbmNlTG9jYWxNYXRyaXggKTsKCgkJCXRoaXMuYm91bmRpbmdTcGhlcmUudW5pb24oIF9zcGhlcmUkMyApOwoKCQl9CgoJfQoKCWNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApOwoKCQl0aGlzLmluc3RhbmNlTWF0cml4LmNvcHkoIHNvdXJjZS5pbnN0YW5jZU1hdHJpeCApOwoKCQlpZiAoIHNvdXJjZS5pbnN0YW5jZUNvbG9yICE9PSBudWxsICkgdGhpcy5pbnN0YW5jZUNvbG9yID0gc291cmNlLmluc3RhbmNlQ29sb3IuY2xvbmUoKTsKCgkJdGhpcy5jb3VudCA9IHNvdXJjZS5jb3VudDsKCgkJaWYgKCBzb3VyY2UuYm91bmRpbmdCb3ggIT09IG51bGwgKSB0aGlzLmJvdW5kaW5nQm94ID0gc291cmNlLmJvdW5kaW5nQm94LmNsb25lKCk7CgkJaWYgKCBzb3VyY2UuYm91bmRpbmdTcGhlcmUgIT09IG51bGwgKSB0aGlzLmJvdW5kaW5nU3BoZXJlID0gc291cmNlLmJvdW5kaW5nU3BoZXJlLmNsb25lKCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRDb2xvckF0KCBpbmRleCwgY29sb3IgKSB7CgoJCWNvbG9yLmZyb21BcnJheSggdGhpcy5pbnN0YW5jZUNvbG9yLmFycmF5LCBpbmRleCAqIDMgKTsKCgl9CgoJZ2V0TWF0cml4QXQoIGluZGV4LCBtYXRyaXggKSB7CgoJCW1hdHJpeC5mcm9tQXJyYXkoIHRoaXMuaW5zdGFuY2VNYXRyaXguYXJyYXksIGluZGV4ICogMTYgKTsKCgl9CgoJcmF5Y2FzdCggcmF5Y2FzdGVyLCBpbnRlcnNlY3RzICkgewoKCQljb25zdCBtYXRyaXhXb3JsZCA9IHRoaXMubWF0cml4V29ybGQ7CgkJY29uc3QgcmF5Y2FzdFRpbWVzID0gdGhpcy5jb3VudDsKCgkJX21lc2gkMS5nZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnk7CgkJX21lc2gkMS5tYXRlcmlhbCA9IHRoaXMubWF0ZXJpYWw7CgoJCWlmICggX21lc2gkMS5tYXRlcmlhbCA9PT0gdW5kZWZpbmVkICkgcmV0dXJuOwoKCQkvLyB0ZXN0IHdpdGggYm91bmRpbmcgc3BoZXJlIGZpcnN0CgoJCWlmICggdGhpcy5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCApIHRoaXMuY29tcHV0ZUJvdW5kaW5nU3BoZXJlKCk7CgoJCV9zcGhlcmUkMy5jb3B5KCB0aGlzLmJvdW5kaW5nU3BoZXJlICk7CgkJX3NwaGVyZSQzLmFwcGx5TWF0cml4NCggbWF0cml4V29ybGQgKTsKCgkJaWYgKCByYXljYXN0ZXIucmF5LmludGVyc2VjdHNTcGhlcmUoIF9zcGhlcmUkMyApID09PSBmYWxzZSApIHJldHVybjsKCgkJLy8gbm93IHRlc3QgZWFjaCBpbnN0YW5jZQoKCQlmb3IgKCBsZXQgaW5zdGFuY2VJZCA9IDA7IGluc3RhbmNlSWQgPCByYXljYXN0VGltZXM7IGluc3RhbmNlSWQgKysgKSB7CgoJCQkvLyBjYWxjdWxhdGUgdGhlIHdvcmxkIG1hdHJpeCBmb3IgZWFjaCBpbnN0YW5jZQoKCQkJdGhpcy5nZXRNYXRyaXhBdCggaW5zdGFuY2VJZCwgX2luc3RhbmNlTG9jYWxNYXRyaXggKTsKCgkJCV9pbnN0YW5jZVdvcmxkTWF0cml4Lm11bHRpcGx5TWF0cmljZXMoIG1hdHJpeFdvcmxkLCBfaW5zdGFuY2VMb2NhbE1hdHJpeCApOwoKCQkJLy8gdGhlIG1lc2ggcmVwcmVzZW50cyB0aGlzIHNpbmdsZSBpbnN0YW5jZQoKCQkJX21lc2gkMS5tYXRyaXhXb3JsZCA9IF9pbnN0YW5jZVdvcmxkTWF0cml4OwoKCQkJX21lc2gkMS5yYXljYXN0KCByYXljYXN0ZXIsIF9pbnN0YW5jZUludGVyc2VjdHMgKTsKCgkJCS8vIHByb2Nlc3MgdGhlIHJlc3VsdCBvZiByYXljYXN0CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBfaW5zdGFuY2VJbnRlcnNlY3RzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJY29uc3QgaW50ZXJzZWN0ID0gX2luc3RhbmNlSW50ZXJzZWN0c1sgaSBdOwoJCQkJaW50ZXJzZWN0Lmluc3RhbmNlSWQgPSBpbnN0YW5jZUlkOwoJCQkJaW50ZXJzZWN0Lm9iamVjdCA9IHRoaXM7CgkJCQlpbnRlcnNlY3RzLnB1c2goIGludGVyc2VjdCApOwoKCQkJfQoKCQkJX2luc3RhbmNlSW50ZXJzZWN0cy5sZW5ndGggPSAwOwoKCQl9CgoJfQoKCXNldENvbG9yQXQoIGluZGV4LCBjb2xvciApIHsKCgkJaWYgKCB0aGlzLmluc3RhbmNlQ29sb3IgPT09IG51bGwgKSB7CgoJCQl0aGlzLmluc3RhbmNlQ29sb3IgPSBuZXcgSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlKCBuZXcgRmxvYXQzMkFycmF5KCB0aGlzLmluc3RhbmNlTWF0cml4LmNvdW50ICogMyApLCAzICk7CgoJCX0KCgkJY29sb3IudG9BcnJheSggdGhpcy5pbnN0YW5jZUNvbG9yLmFycmF5LCBpbmRleCAqIDMgKTsKCgl9CgoJc2V0TWF0cml4QXQoIGluZGV4LCBtYXRyaXggKSB7CgoJCW1hdHJpeC50b0FycmF5KCB0aGlzLmluc3RhbmNlTWF0cml4LmFycmF5LCBpbmRleCAqIDE2ICk7CgoJfQoKCXVwZGF0ZU1vcnBoVGFyZ2V0cygpIHsKCgl9CgoJZGlzcG9zZSgpIHsKCgkJdGhpcy5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICdkaXNwb3NlJyB9ICk7CgoJfQoKfQoKZnVuY3Rpb24gc29ydE9wYXF1ZSggYSwgYiApIHsKCglyZXR1cm4gYS56IC0gYi56OwoKfQoKZnVuY3Rpb24gc29ydFRyYW5zcGFyZW50KCBhLCBiICkgewoKCXJldHVybiBiLnogLSBhLno7Cgp9CgpjbGFzcyBNdWx0aURyYXdSZW5kZXJMaXN0IHsKCgljb25zdHJ1Y3RvcigpIHsKCgkJdGhpcy5pbmRleCA9IDA7CgkJdGhpcy5wb29sID0gW107CgkJdGhpcy5saXN0ID0gW107CgoJfQoKCXB1c2goIGRyYXdSYW5nZSwgeiApIHsKCgkJY29uc3QgcG9vbCA9IHRoaXMucG9vbDsKCQljb25zdCBsaXN0ID0gdGhpcy5saXN0OwoJCWlmICggdGhpcy5pbmRleCA+PSBwb29sLmxlbmd0aCApIHsKCgkJCXBvb2wucHVzaCggewoKCQkJCXN0YXJ0OiAtIDEsCgkJCQljb3VudDogLSAxLAoJCQkJejogLSAxLAoKCQkJfSApOwoKCQl9CgoJCWNvbnN0IGl0ZW0gPSBwb29sWyB0aGlzLmluZGV4IF07CgkJbGlzdC5wdXNoKCBpdGVtICk7CgkJdGhpcy5pbmRleCArKzsKCgkJaXRlbS5zdGFydCA9IGRyYXdSYW5nZS5zdGFydDsKCQlpdGVtLmNvdW50ID0gZHJhd1JhbmdlLmNvdW50OwoJCWl0ZW0ueiA9IHo7CgoJfQoKCXJlc2V0KCkgewoKCQl0aGlzLmxpc3QubGVuZ3RoID0gMDsKCQl0aGlzLmluZGV4ID0gMDsKCgl9Cgp9Cgpjb25zdCBJRF9BVFRSX05BTUUgPSAnYmF0Y2hJZCc7CmNvbnN0IF9tYXRyaXggPSAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXg0KCk7CmNvbnN0IF9pbnZNYXRyaXhXb3JsZCA9IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDQoKTsKY29uc3QgX2lkZW50aXR5TWF0cml4ID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwpjb25zdCBfcHJvalNjcmVlbk1hdHJpeCQyID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwpjb25zdCBfZnJ1c3R1bSA9IC8qQF9fUFVSRV9fKi8gbmV3IEZydXN0dW0oKTsKY29uc3QgX2JveCQxID0gLypAX19QVVJFX18qLyBuZXcgQm94MygpOwpjb25zdCBfc3BoZXJlJDIgPSAvKkBfX1BVUkVfXyovIG5ldyBTcGhlcmUoKTsKY29uc3QgX3ZlY3RvciQ1ID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfcmVuZGVyTGlzdCA9IC8qQF9fUFVSRV9fKi8gbmV3IE11bHRpRHJhd1JlbmRlckxpc3QoKTsKY29uc3QgX21lc2ggPSAvKkBfX1BVUkVfXyovIG5ldyBNZXNoKCk7CmNvbnN0IF9iYXRjaEludGVyc2VjdHMgPSBbXTsKCi8vIEBUT0RPOiBTa2lubmVkTWVzaCBzdXBwb3J0PwovLyBAVE9ETzogZ2VvbWV0cnkuZ3JvdXBzIHN1cHBvcnQ/Ci8vIEBUT0RPOiBnZW9tZXRyeS5kcmF3UmFuZ2Ugc3VwcG9ydD8KLy8gQFRPRE86IGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcyBzdXBwb3J0PwovLyBAVE9ETzogU3VwcG9ydCB1bmlmb3JtIHBhcmFtZXRlciBwZXIgZ2VvbWV0cnkKLy8gQFRPRE86IEFkZCBhbiAib3B0aW1pemUiIGZ1bmN0aW9uIHRvIHBhY2sgZ2VvbWV0cnkgYW5kIHJlbW92ZSBkYXRhIGdhcHMKCi8vIGNvcGllcyBkYXRhIGZyb20gYXR0cmlidXRlICJzcmMiIGludG8gInRhcmdldCIgc3RhcnRpbmcgYXQgInRhcmdldE9mZnNldCIKZnVuY3Rpb24gY29weUF0dHJpYnV0ZURhdGEoIHNyYywgdGFyZ2V0LCB0YXJnZXRPZmZzZXQgPSAwICkgewoKCWNvbnN0IGl0ZW1TaXplID0gdGFyZ2V0Lml0ZW1TaXplOwoJaWYgKCBzcmMuaXNJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZSB8fCBzcmMuYXJyYXkuY29uc3RydWN0b3IgIT09IHRhcmdldC5hcnJheS5jb25zdHJ1Y3RvciApIHsKCgkJLy8gdXNlIHRoZSBjb21wb25lbnQgZ2V0dGVycyBhbmQgc2V0dGVycyBpZiB0aGUgYXJyYXkgZGF0YSBjYW5ub3QKCQkvLyBiZSBjb3BpZWQgZGlyZWN0bHkKCQljb25zdCB2ZXJ0ZXhDb3VudCA9IHNyYy5jb3VudDsKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB2ZXJ0ZXhDb3VudDsgaSArKyApIHsKCgkJCWZvciAoIGxldCBjID0gMDsgYyA8IGl0ZW1TaXplOyBjICsrICkgewoKCQkJCXRhcmdldC5zZXRDb21wb25lbnQoIGkgKyB0YXJnZXRPZmZzZXQsIGMsIHNyYy5nZXRDb21wb25lbnQoIGksIGMgKSApOwoKCQkJfQoKCQl9CgoJfSBlbHNlIHsKCgkJLy8gZmFzdGVyIGNvcHkgYXBwcm9hY2ggdXNpbmcgdHlwZWQgYXJyYXkgc2V0IGZ1bmN0aW9uCgkJdGFyZ2V0LmFycmF5LnNldCggc3JjLmFycmF5LCB0YXJnZXRPZmZzZXQgKiBpdGVtU2l6ZSApOwoKCX0KCgl0YXJnZXQubmVlZHNVcGRhdGUgPSB0cnVlOwoKfQoKY2xhc3MgQmF0Y2hlZE1lc2ggZXh0ZW5kcyBNZXNoIHsKCglnZXQgbWF4R2VvbWV0cnlDb3VudCgpIHsKCgkJcmV0dXJuIHRoaXMuX21heEdlb21ldHJ5Q291bnQ7CgoJfQoKCWNvbnN0cnVjdG9yKCBtYXhHZW9tZXRyeUNvdW50LCBtYXhWZXJ0ZXhDb3VudCwgbWF4SW5kZXhDb3VudCA9IG1heFZlcnRleENvdW50ICogMiwgbWF0ZXJpYWwgKSB7CgoJCXN1cGVyKCBuZXcgQnVmZmVyR2VvbWV0cnkoKSwgbWF0ZXJpYWwgKTsKCgkJdGhpcy5pc0JhdGNoZWRNZXNoID0gdHJ1ZTsKCQl0aGlzLnBlck9iamVjdEZydXN0dW1DdWxsZWQgPSB0cnVlOwoJCXRoaXMuc29ydE9iamVjdHMgPSB0cnVlOwoJCXRoaXMuYm91bmRpbmdCb3ggPSBudWxsOwoJCXRoaXMuYm91bmRpbmdTcGhlcmUgPSBudWxsOwoJCXRoaXMuY3VzdG9tU29ydCA9IG51bGw7CgoJCXRoaXMuX2RyYXdSYW5nZXMgPSBbXTsKCQl0aGlzLl9yZXNlcnZlZFJhbmdlcyA9IFtdOwoKCQl0aGlzLl92aXNpYmlsaXR5ID0gW107CgkJdGhpcy5fYWN0aXZlID0gW107CgkJdGhpcy5fYm91bmRzID0gW107CgoJCXRoaXMuX21heEdlb21ldHJ5Q291bnQgPSBtYXhHZW9tZXRyeUNvdW50OwoJCXRoaXMuX21heFZlcnRleENvdW50ID0gbWF4VmVydGV4Q291bnQ7CgkJdGhpcy5fbWF4SW5kZXhDb3VudCA9IG1heEluZGV4Q291bnQ7CgoJCXRoaXMuX2dlb21ldHJ5SW5pdGlhbGl6ZWQgPSBmYWxzZTsKCQl0aGlzLl9nZW9tZXRyeUNvdW50ID0gMDsKCQl0aGlzLl9tdWx0aURyYXdDb3VudHMgPSBuZXcgSW50MzJBcnJheSggbWF4R2VvbWV0cnlDb3VudCApOwoJCXRoaXMuX211bHRpRHJhd1N0YXJ0cyA9IG5ldyBJbnQzMkFycmF5KCBtYXhHZW9tZXRyeUNvdW50ICk7CgkJdGhpcy5fbXVsdGlEcmF3Q291bnQgPSAwOwoJCXRoaXMuX3Zpc2liaWxpdHlDaGFuZ2VkID0gdHJ1ZTsKCgkJLy8gTG9jYWwgbWF0cml4IHBlciBnZW9tZXRyeSBieSB1c2luZyBkYXRhIHRleHR1cmUKCQl0aGlzLl9tYXRyaWNlc1RleHR1cmUgPSBudWxsOwoKCQl0aGlzLl9pbml0TWF0cmljZXNUZXh0dXJlKCk7CgoJfQoKCV9pbml0TWF0cmljZXNUZXh0dXJlKCkgewoKCQkvLyBsYXlvdXQgKDEgbWF0cml4ID0gNCBwaXhlbHMpCgkJLy8gICAgICBSR0JBIFJHQkEgUkdCQSBSR0JBICg9PiBjb2x1bW4xLCBjb2x1bW4yLCBjb2x1bW4zLCBjb2x1bW40KQoJCS8vICB3aXRoICA4eDggIHBpeGVsIHRleHR1cmUgbWF4ICAgMTYgbWF0cmljZXMgKiA0IHBpeGVscyA9ICAoOCAqIDgpCgkJLy8gICAgICAgMTZ4MTYgcGl4ZWwgdGV4dHVyZSBtYXggICA2NCBtYXRyaWNlcyAqIDQgcGl4ZWxzID0gKDE2ICogMTYpCgkJLy8gICAgICAgMzJ4MzIgcGl4ZWwgdGV4dHVyZSBtYXggIDI1NiBtYXRyaWNlcyAqIDQgcGl4ZWxzID0gKDMyICogMzIpCgkJLy8gICAgICAgNjR4NjQgcGl4ZWwgdGV4dHVyZSBtYXggMTAyNCBtYXRyaWNlcyAqIDQgcGl4ZWxzID0gKDY0ICogNjQpCgoJCWxldCBzaXplID0gTWF0aC5zcXJ0KCB0aGlzLl9tYXhHZW9tZXRyeUNvdW50ICogNCApOyAvLyA0IHBpeGVscyBuZWVkZWQgZm9yIDEgbWF0cml4CgkJc2l6ZSA9IE1hdGguY2VpbCggc2l6ZSAvIDQgKSAqIDQ7CgkJc2l6ZSA9IE1hdGgubWF4KCBzaXplLCA0ICk7CgoJCWNvbnN0IG1hdHJpY2VzQXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KCBzaXplICogc2l6ZSAqIDQgKTsgLy8gNCBmbG9hdHMgcGVyIFJHQkEgcGl4ZWwKCQljb25zdCBtYXRyaWNlc1RleHR1cmUgPSBuZXcgRGF0YVRleHR1cmUoIG1hdHJpY2VzQXJyYXksIHNpemUsIHNpemUsIFJHQkFGb3JtYXQsIEZsb2F0VHlwZSApOwoKCQl0aGlzLl9tYXRyaWNlc1RleHR1cmUgPSBtYXRyaWNlc1RleHR1cmU7CgoJfQoKCV9pbml0aWFsaXplR2VvbWV0cnkoIHJlZmVyZW5jZSApIHsKCgkJY29uc3QgZ2VvbWV0cnkgPSB0aGlzLmdlb21ldHJ5OwoJCWNvbnN0IG1heFZlcnRleENvdW50ID0gdGhpcy5fbWF4VmVydGV4Q291bnQ7CgkJY29uc3QgbWF4R2VvbWV0cnlDb3VudCA9IHRoaXMuX21heEdlb21ldHJ5Q291bnQ7CgkJY29uc3QgbWF4SW5kZXhDb3VudCA9IHRoaXMuX21heEluZGV4Q291bnQ7CgkJaWYgKCB0aGlzLl9nZW9tZXRyeUluaXRpYWxpemVkID09PSBmYWxzZSApIHsKCgkJCWZvciAoIGNvbnN0IGF0dHJpYnV0ZU5hbWUgaW4gcmVmZXJlbmNlLmF0dHJpYnV0ZXMgKSB7CgoJCQkJY29uc3Qgc3JjQXR0cmlidXRlID0gcmVmZXJlbmNlLmdldEF0dHJpYnV0ZSggYXR0cmlidXRlTmFtZSApOwoJCQkJY29uc3QgeyBhcnJheSwgaXRlbVNpemUsIG5vcm1hbGl6ZWQgfSA9IHNyY0F0dHJpYnV0ZTsKCgkJCQljb25zdCBkc3RBcnJheSA9IG5ldyBhcnJheS5jb25zdHJ1Y3RvciggbWF4VmVydGV4Q291bnQgKiBpdGVtU2l6ZSApOwoJCQkJY29uc3QgZHN0QXR0cmlidXRlID0gbmV3IHNyY0F0dHJpYnV0ZS5jb25zdHJ1Y3RvciggZHN0QXJyYXksIGl0ZW1TaXplLCBub3JtYWxpemVkICk7CgkJCQlkc3RBdHRyaWJ1dGUuc2V0VXNhZ2UoIHNyY0F0dHJpYnV0ZS51c2FnZSApOwoKCQkJCWdlb21ldHJ5LnNldEF0dHJpYnV0ZSggYXR0cmlidXRlTmFtZSwgZHN0QXR0cmlidXRlICk7CgoJCQl9CgoJCQlpZiAoIHJlZmVyZW5jZS5nZXRJbmRleCgpICE9PSBudWxsICkgewoKCQkJCWNvbnN0IGluZGV4QXJyYXkgPSBtYXhWZXJ0ZXhDb3VudCA+IDY1NTM2CgkJCQkJPyBuZXcgVWludDMyQXJyYXkoIG1heEluZGV4Q291bnQgKQoJCQkJCTogbmV3IFVpbnQxNkFycmF5KCBtYXhJbmRleENvdW50ICk7CgoJCQkJZ2VvbWV0cnkuc2V0SW5kZXgoIG5ldyBCdWZmZXJBdHRyaWJ1dGUoIGluZGV4QXJyYXksIDEgKSApOwoKCQkJfQoKCQkJY29uc3QgaWRBcnJheSA9IG1heEdlb21ldHJ5Q291bnQgPiA2NTUzNgoJCQkJPyBuZXcgVWludDMyQXJyYXkoIG1heFZlcnRleENvdW50ICkKCQkJCTogbmV3IFVpbnQxNkFycmF5KCBtYXhWZXJ0ZXhDb3VudCApOwoJCQlnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoIElEX0FUVFJfTkFNRSwgbmV3IEJ1ZmZlckF0dHJpYnV0ZSggaWRBcnJheSwgMSApICk7CgoJCQl0aGlzLl9nZW9tZXRyeUluaXRpYWxpemVkID0gdHJ1ZTsKCgkJfQoKCX0KCgkvLyBNYWtlIHN1cmUgdGhlIGdlb21ldHJ5IGlzIGNvbXBhdGlibGUgd2l0aCB0aGUgZXhpc3RpbmcgY29tYmluZWQgZ2VvbWV0cnkgYXRyaWJ1dGVzCglfdmFsaWRhdGVHZW9tZXRyeSggZ2VvbWV0cnkgKSB7CgoJCS8vIGNoZWNrIHRoYXQgdGhlIGdlb21ldHJ5IGRvZXNuJ3QgaGF2ZSBhIHZlcnNpb24gb2Ygb3VyIHJlc2VydmVkIGlkIGF0dHJpYnV0ZQoJCWlmICggZ2VvbWV0cnkuZ2V0QXR0cmlidXRlKCBJRF9BVFRSX05BTUUgKSApIHsKCgkJCXRocm93IG5ldyBFcnJvciggYEJhdGNoZWRNZXNoOiBHZW9tZXRyeSBjYW5ub3QgdXNlIGF0dHJpYnV0ZSAiJHsgSURfQVRUUl9OQU1FIH0iYCApOwoKCQl9CgoJCS8vIGNoZWNrIHRvIGVuc3VyZSB0aGUgZ2VvbWV0cmllcyBhcmUgdXNpbmcgY29uc2lzdGVudCBhdHRyaWJ1dGVzIGFuZCBpbmRpY2VzCgkJY29uc3QgYmF0Y2hHZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnk7CgkJaWYgKCBCb29sZWFuKCBnZW9tZXRyeS5nZXRJbmRleCgpICkgIT09IEJvb2xlYW4oIGJhdGNoR2VvbWV0cnkuZ2V0SW5kZXgoKSApICkgewoKCQkJdGhyb3cgbmV3IEVycm9yKCAnQmF0Y2hlZE1lc2g6IEFsbCBnZW9tZXRyaWVzIG11c3QgY29uc2lzdGVudGx5IGhhdmUgImluZGV4Ii4nICk7CgoJCX0KCgkJZm9yICggY29uc3QgYXR0cmlidXRlTmFtZSBpbiBiYXRjaEdlb21ldHJ5LmF0dHJpYnV0ZXMgKSB7CgoJCQlpZiAoIGF0dHJpYnV0ZU5hbWUgPT09IElEX0FUVFJfTkFNRSApIHsKCgkJCQljb250aW51ZTsKCgkJCX0KCgkJCWlmICggISBnZW9tZXRyeS5oYXNBdHRyaWJ1dGUoIGF0dHJpYnV0ZU5hbWUgKSApIHsKCgkJCQl0aHJvdyBuZXcgRXJyb3IoIGBCYXRjaGVkTWVzaDogQWRkZWQgZ2VvbWV0cnkgbWlzc2luZyAiJHsgYXR0cmlidXRlTmFtZSB9Ii4gQWxsIGdlb21ldHJpZXMgbXVzdCBoYXZlIGNvbnNpc3RlbnQgYXR0cmlidXRlcy5gICk7CgoJCQl9CgoJCQljb25zdCBzcmNBdHRyaWJ1dGUgPSBnZW9tZXRyeS5nZXRBdHRyaWJ1dGUoIGF0dHJpYnV0ZU5hbWUgKTsKCQkJY29uc3QgZHN0QXR0cmlidXRlID0gYmF0Y2hHZW9tZXRyeS5nZXRBdHRyaWJ1dGUoIGF0dHJpYnV0ZU5hbWUgKTsKCQkJaWYgKCBzcmNBdHRyaWJ1dGUuaXRlbVNpemUgIT09IGRzdEF0dHJpYnV0ZS5pdGVtU2l6ZSB8fCBzcmNBdHRyaWJ1dGUubm9ybWFsaXplZCAhPT0gZHN0QXR0cmlidXRlLm5vcm1hbGl6ZWQgKSB7CgoJCQkJdGhyb3cgbmV3IEVycm9yKCAnQmF0Y2hlZE1lc2g6IEFsbCBhdHRyaWJ1dGVzIG11c3QgaGF2ZSBhIGNvbnNpc3RlbnQgaXRlbVNpemUgYW5kIG5vcm1hbGl6ZWQgdmFsdWUuJyApOwoKCQkJfQoKCQl9CgoJfQoKCXNldEN1c3RvbVNvcnQoIGZ1bmMgKSB7CgoJCXRoaXMuY3VzdG9tU29ydCA9IGZ1bmM7CgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvbXB1dGVCb3VuZGluZ0JveCgpIHsKCgkJaWYgKCB0aGlzLmJvdW5kaW5nQm94ID09PSBudWxsICkgewoKCQkJdGhpcy5ib3VuZGluZ0JveCA9IG5ldyBCb3gzKCk7CgoJCX0KCgkJY29uc3QgZ2VvbWV0cnlDb3VudCA9IHRoaXMuX2dlb21ldHJ5Q291bnQ7CgkJY29uc3QgYm91bmRpbmdCb3ggPSB0aGlzLmJvdW5kaW5nQm94OwoJCWNvbnN0IGFjdGl2ZSA9IHRoaXMuX2FjdGl2ZTsKCgkJYm91bmRpbmdCb3gubWFrZUVtcHR5KCk7CgkJZm9yICggbGV0IGkgPSAwOyBpIDwgZ2VvbWV0cnlDb3VudDsgaSArKyApIHsKCgkJCWlmICggYWN0aXZlWyBpIF0gPT09IGZhbHNlICkgY29udGludWU7CgoJCQl0aGlzLmdldE1hdHJpeEF0KCBpLCBfbWF0cml4ICk7CgkJCXRoaXMuZ2V0Qm91bmRpbmdCb3hBdCggaSwgX2JveCQxICkuYXBwbHlNYXRyaXg0KCBfbWF0cml4ICk7CgkJCWJvdW5kaW5nQm94LnVuaW9uKCBfYm94JDEgKTsKCgkJfQoKCX0KCgljb21wdXRlQm91bmRpbmdTcGhlcmUoKSB7CgoJCWlmICggdGhpcy5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCApIHsKCgkJCXRoaXMuYm91bmRpbmdTcGhlcmUgPSBuZXcgU3BoZXJlKCk7CgoJCX0KCgkJY29uc3QgZ2VvbWV0cnlDb3VudCA9IHRoaXMuX2dlb21ldHJ5Q291bnQ7CgkJY29uc3QgYm91bmRpbmdTcGhlcmUgPSB0aGlzLmJvdW5kaW5nU3BoZXJlOwoJCWNvbnN0IGFjdGl2ZSA9IHRoaXMuX2FjdGl2ZTsKCgkJYm91bmRpbmdTcGhlcmUubWFrZUVtcHR5KCk7CgkJZm9yICggbGV0IGkgPSAwOyBpIDwgZ2VvbWV0cnlDb3VudDsgaSArKyApIHsKCgkJCWlmICggYWN0aXZlWyBpIF0gPT09IGZhbHNlICkgY29udGludWU7CgoJCQl0aGlzLmdldE1hdHJpeEF0KCBpLCBfbWF0cml4ICk7CgkJCXRoaXMuZ2V0Qm91bmRpbmdTcGhlcmVBdCggaSwgX3NwaGVyZSQyICkuYXBwbHlNYXRyaXg0KCBfbWF0cml4ICk7CgkJCWJvdW5kaW5nU3BoZXJlLnVuaW9uKCBfc3BoZXJlJDIgKTsKCgkJfQoKCX0KCglhZGRHZW9tZXRyeSggZ2VvbWV0cnksIHZlcnRleENvdW50ID0gLSAxLCBpbmRleENvdW50ID0gLSAxICkgewoKCQl0aGlzLl9pbml0aWFsaXplR2VvbWV0cnkoIGdlb21ldHJ5ICk7CgoJCXRoaXMuX3ZhbGlkYXRlR2VvbWV0cnkoIGdlb21ldHJ5ICk7CgoJCS8vIGVuc3VyZSB3ZSdyZSBub3Qgb3ZlciBnZW9tZXRyeQoJCWlmICggdGhpcy5fZ2VvbWV0cnlDb3VudCA+PSB0aGlzLl9tYXhHZW9tZXRyeUNvdW50ICkgewoKCQkJdGhyb3cgbmV3IEVycm9yKCAnQmF0Y2hlZE1lc2g6IE1heGltdW0gZ2VvbWV0cnkgY291bnQgcmVhY2hlZC4nICk7CgoJCX0KCgkJLy8gZ2V0IHRoZSBuZWNlc3NhcnkgcmFuZ2UgZm8gdGhlIGdlb21ldHJ5CgkJY29uc3QgcmVzZXJ2ZWRSYW5nZSA9IHsKCQkJdmVydGV4U3RhcnQ6IC0gMSwKCQkJdmVydGV4Q291bnQ6IC0gMSwKCQkJaW5kZXhTdGFydDogLSAxLAoJCQlpbmRleENvdW50OiAtIDEsCgkJfTsKCgkJbGV0IGxhc3RSYW5nZSA9IG51bGw7CgkJY29uc3QgcmVzZXJ2ZWRSYW5nZXMgPSB0aGlzLl9yZXNlcnZlZFJhbmdlczsKCQljb25zdCBkcmF3UmFuZ2VzID0gdGhpcy5fZHJhd1JhbmdlczsKCQljb25zdCBib3VuZHMgPSB0aGlzLl9ib3VuZHM7CgkJaWYgKCB0aGlzLl9nZW9tZXRyeUNvdW50ICE9PSAwICkgewoKCQkJbGFzdFJhbmdlID0gcmVzZXJ2ZWRSYW5nZXNbIHJlc2VydmVkUmFuZ2VzLmxlbmd0aCAtIDEgXTsKCgkJfQoKCQlpZiAoIHZlcnRleENvdW50ID09PSAtIDEgKSB7CgoJCQlyZXNlcnZlZFJhbmdlLnZlcnRleENvdW50ID0gZ2VvbWV0cnkuZ2V0QXR0cmlidXRlKCAncG9zaXRpb24nICkuY291bnQ7CgoJCX0gZWxzZSB7CgoJCQlyZXNlcnZlZFJhbmdlLnZlcnRleENvdW50ID0gdmVydGV4Q291bnQ7CgoJCX0KCgkJaWYgKCBsYXN0UmFuZ2UgPT09IG51bGwgKSB7CgoJCQlyZXNlcnZlZFJhbmdlLnZlcnRleFN0YXJ0ID0gMDsKCgkJfSBlbHNlIHsKCgkJCXJlc2VydmVkUmFuZ2UudmVydGV4U3RhcnQgPSBsYXN0UmFuZ2UudmVydGV4U3RhcnQgKyBsYXN0UmFuZ2UudmVydGV4Q291bnQ7CgoJCX0KCgkJY29uc3QgaW5kZXggPSBnZW9tZXRyeS5nZXRJbmRleCgpOwoJCWNvbnN0IGhhc0luZGV4ID0gaW5kZXggIT09IG51bGw7CgkJaWYgKCBoYXNJbmRleCApIHsKCgkJCWlmICggaW5kZXhDb3VudAk9PT0gLSAxICkgewoKCQkJCXJlc2VydmVkUmFuZ2UuaW5kZXhDb3VudCA9IGluZGV4LmNvdW50OwoKCQkJfSBlbHNlIHsKCgkJCQlyZXNlcnZlZFJhbmdlLmluZGV4Q291bnQgPSBpbmRleENvdW50OwoKCQkJfQoKCQkJaWYgKCBsYXN0UmFuZ2UgPT09IG51bGwgKSB7CgoJCQkJcmVzZXJ2ZWRSYW5nZS5pbmRleFN0YXJ0ID0gMDsKCgkJCX0gZWxzZSB7CgoJCQkJcmVzZXJ2ZWRSYW5nZS5pbmRleFN0YXJ0ID0gbGFzdFJhbmdlLmluZGV4U3RhcnQgKyBsYXN0UmFuZ2UuaW5kZXhDb3VudDsKCgkJCX0KCgkJfQoKCQlpZiAoCgkJCXJlc2VydmVkUmFuZ2UuaW5kZXhTdGFydCAhPT0gLSAxICYmCgkJCXJlc2VydmVkUmFuZ2UuaW5kZXhTdGFydCArIHJlc2VydmVkUmFuZ2UuaW5kZXhDb3VudCA+IHRoaXMuX21heEluZGV4Q291bnQgfHwKCQkJcmVzZXJ2ZWRSYW5nZS52ZXJ0ZXhTdGFydCArIHJlc2VydmVkUmFuZ2UudmVydGV4Q291bnQgPiB0aGlzLl9tYXhWZXJ0ZXhDb3VudAoJCSkgewoKCQkJdGhyb3cgbmV3IEVycm9yKCAnQmF0Y2hlZE1lc2g6IFJlc2VydmVkIHNwYWNlIHJlcXVlc3QgZXhjZWVkcyB0aGUgbWF4aW11bSBidWZmZXIgc2l6ZS4nICk7CgoJCX0KCgkJY29uc3QgdmlzaWJpbGl0eSA9IHRoaXMuX3Zpc2liaWxpdHk7CgkJY29uc3QgYWN0aXZlID0gdGhpcy5fYWN0aXZlOwoJCWNvbnN0IG1hdHJpY2VzVGV4dHVyZSA9IHRoaXMuX21hdHJpY2VzVGV4dHVyZTsKCQljb25zdCBtYXRyaWNlc0FycmF5ID0gdGhpcy5fbWF0cmljZXNUZXh0dXJlLmltYWdlLmRhdGE7CgoJCS8vIHB1c2ggbmV3IHZpc2liaWxpdHkgc3RhdGVzCgkJdmlzaWJpbGl0eS5wdXNoKCB0cnVlICk7CgkJYWN0aXZlLnB1c2goIHRydWUgKTsKCgkJLy8gdXBkYXRlIGlkCgkJY29uc3QgZ2VvbWV0cnlJZCA9IHRoaXMuX2dlb21ldHJ5Q291bnQ7CgkJdGhpcy5fZ2VvbWV0cnlDb3VudCArKzsKCgkJLy8gaW5pdGlhbGl6ZSBtYXRyaXggaW5mb3JtYXRpb24KCQlfaWRlbnRpdHlNYXRyaXgudG9BcnJheSggbWF0cmljZXNBcnJheSwgZ2VvbWV0cnlJZCAqIDE2ICk7CgkJbWF0cmljZXNUZXh0dXJlLm5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJLy8gYWRkIHRoZSByZXNlcnZlZCByYW5nZSBhbmQgZHJhdyByYW5nZSBvYmplY3RzCgkJcmVzZXJ2ZWRSYW5nZXMucHVzaCggcmVzZXJ2ZWRSYW5nZSApOwoJCWRyYXdSYW5nZXMucHVzaCggewoJCQlzdGFydDogaGFzSW5kZXggPyByZXNlcnZlZFJhbmdlLmluZGV4U3RhcnQgOiByZXNlcnZlZFJhbmdlLnZlcnRleFN0YXJ0LAoJCQljb3VudDogLSAxCgkJfSApOwoJCWJvdW5kcy5wdXNoKCB7CgkJCWJveEluaXRpYWxpemVkOiBmYWxzZSwKCQkJYm94OiBuZXcgQm94MygpLAoKCQkJc3BoZXJlSW5pdGlhbGl6ZWQ6IGZhbHNlLAoJCQlzcGhlcmU6IG5ldyBTcGhlcmUoKQoJCX0gKTsKCgkJLy8gc2V0IHRoZSBpZCBmb3IgdGhlIGdlb21ldHJ5CgkJY29uc3QgaWRBdHRyaWJ1dGUgPSB0aGlzLmdlb21ldHJ5LmdldEF0dHJpYnV0ZSggSURfQVRUUl9OQU1FICk7CgkJZm9yICggbGV0IGkgPSAwOyBpIDwgcmVzZXJ2ZWRSYW5nZS52ZXJ0ZXhDb3VudDsgaSArKyApIHsKCgkJCWlkQXR0cmlidXRlLnNldFgoIHJlc2VydmVkUmFuZ2UudmVydGV4U3RhcnQgKyBpLCBnZW9tZXRyeUlkICk7CgoJCX0KCgkJaWRBdHRyaWJ1dGUubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQkvLyB1cGRhdGUgdGhlIGdlb21ldHJ5CgkJdGhpcy5zZXRHZW9tZXRyeUF0KCBnZW9tZXRyeUlkLCBnZW9tZXRyeSApOwoKCQlyZXR1cm4gZ2VvbWV0cnlJZDsKCgl9CgoJc2V0R2VvbWV0cnlBdCggaWQsIGdlb21ldHJ5ICkgewoKCQlpZiAoIGlkID49IHRoaXMuX2dlb21ldHJ5Q291bnQgKSB7CgoJCQl0aHJvdyBuZXcgRXJyb3IoICdCYXRjaGVkTWVzaDogTWF4aW11bSBnZW9tZXRyeSBjb3VudCByZWFjaGVkLicgKTsKCgkJfQoKCQl0aGlzLl92YWxpZGF0ZUdlb21ldHJ5KCBnZW9tZXRyeSApOwoKCQljb25zdCBiYXRjaEdlb21ldHJ5ID0gdGhpcy5nZW9tZXRyeTsKCQljb25zdCBoYXNJbmRleCA9IGJhdGNoR2VvbWV0cnkuZ2V0SW5kZXgoKSAhPT0gbnVsbDsKCQljb25zdCBkc3RJbmRleCA9IGJhdGNoR2VvbWV0cnkuZ2V0SW5kZXgoKTsKCQljb25zdCBzcmNJbmRleCA9IGdlb21ldHJ5LmdldEluZGV4KCk7CgkJY29uc3QgcmVzZXJ2ZWRSYW5nZSA9IHRoaXMuX3Jlc2VydmVkUmFuZ2VzWyBpZCBdOwoJCWlmICgKCQkJaGFzSW5kZXggJiYKCQkJc3JjSW5kZXguY291bnQgPiByZXNlcnZlZFJhbmdlLmluZGV4Q291bnQgfHwKCQkJZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbi5jb3VudCA+IHJlc2VydmVkUmFuZ2UudmVydGV4Q291bnQKCQkpIHsKCgkJCXRocm93IG5ldyBFcnJvciggJ0JhdGNoZWRNZXNoOiBSZXNlcnZlZCBzcGFjZSBub3QgbGFyZ2UgZW5vdWdoIGZvciBwcm92aWRlZCBnZW9tZXRyeS4nICk7CgoJCX0KCgkJLy8gY29weSBnZW9tZXRyeSBvdmVyCgkJY29uc3QgdmVydGV4U3RhcnQgPSByZXNlcnZlZFJhbmdlLnZlcnRleFN0YXJ0OwoJCWNvbnN0IHZlcnRleENvdW50ID0gcmVzZXJ2ZWRSYW5nZS52ZXJ0ZXhDb3VudDsKCQlmb3IgKCBjb25zdCBhdHRyaWJ1dGVOYW1lIGluIGJhdGNoR2VvbWV0cnkuYXR0cmlidXRlcyApIHsKCgkJCWlmICggYXR0cmlidXRlTmFtZSA9PT0gSURfQVRUUl9OQU1FICkgewoKCQkJCWNvbnRpbnVlOwoKCQkJfQoKCQkJLy8gY29weSBhdHRyaWJ1dGUgZGF0YQoJCQljb25zdCBzcmNBdHRyaWJ1dGUgPSBnZW9tZXRyeS5nZXRBdHRyaWJ1dGUoIGF0dHJpYnV0ZU5hbWUgKTsKCQkJY29uc3QgZHN0QXR0cmlidXRlID0gYmF0Y2hHZW9tZXRyeS5nZXRBdHRyaWJ1dGUoIGF0dHJpYnV0ZU5hbWUgKTsKCQkJY29weUF0dHJpYnV0ZURhdGEoIHNyY0F0dHJpYnV0ZSwgZHN0QXR0cmlidXRlLCB2ZXJ0ZXhTdGFydCApOwoKCQkJLy8gZmlsbCB0aGUgcmVzdCBpbiB3aXRoIHplcm9lcwoJCQljb25zdCBpdGVtU2l6ZSA9IHNyY0F0dHJpYnV0ZS5pdGVtU2l6ZTsKCQkJZm9yICggbGV0IGkgPSBzcmNBdHRyaWJ1dGUuY291bnQsIGwgPSB2ZXJ0ZXhDb3VudDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJY29uc3QgaW5kZXggPSB2ZXJ0ZXhTdGFydCArIGk7CgkJCQlmb3IgKCBsZXQgYyA9IDA7IGMgPCBpdGVtU2l6ZTsgYyArKyApIHsKCgkJCQkJZHN0QXR0cmlidXRlLnNldENvbXBvbmVudCggaW5kZXgsIGMsIDAgKTsKCgkJCQl9CgoJCQl9CgoJCQlkc3RBdHRyaWJ1dGUubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQl9CgoJCS8vIGNvcHkgaW5kZXgKCQlpZiAoIGhhc0luZGV4ICkgewoKCQkJY29uc3QgaW5kZXhTdGFydCA9IHJlc2VydmVkUmFuZ2UuaW5kZXhTdGFydDsKCgkJCS8vIGNvcHkgaW5kZXggZGF0YSBvdmVyCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IHNyY0luZGV4LmNvdW50OyBpICsrICkgewoKCQkJCWRzdEluZGV4LnNldFgoIGluZGV4U3RhcnQgKyBpLCB2ZXJ0ZXhTdGFydCArIHNyY0luZGV4LmdldFgoIGkgKSApOwoKCQkJfQoKCQkJLy8gZmlsbCB0aGUgcmVzdCBpbiB3aXRoIHplcm9lcwoJCQlmb3IgKCBsZXQgaSA9IHNyY0luZGV4LmNvdW50LCBsID0gcmVzZXJ2ZWRSYW5nZS5pbmRleENvdW50OyBpIDwgbDsgaSArKyApIHsKCgkJCQlkc3RJbmRleC5zZXRYKCBpbmRleFN0YXJ0ICsgaSwgdmVydGV4U3RhcnQgKTsKCgkJCX0KCgkJCWRzdEluZGV4Lm5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJfQoKCQkvLyBzdG9yZSB0aGUgYm91bmRpbmcgYm94ZXMKCQljb25zdCBib3VuZCA9IHRoaXMuX2JvdW5kc1sgaWQgXTsKCQlpZiAoIGdlb21ldHJ5LmJvdW5kaW5nQm94ICE9PSBudWxsICkgewoKCQkJYm91bmQuYm94LmNvcHkoIGdlb21ldHJ5LmJvdW5kaW5nQm94ICk7CgkJCWJvdW5kLmJveEluaXRpYWxpemVkID0gdHJ1ZTsKCgkJfSBlbHNlIHsKCgkJCWJvdW5kLmJveEluaXRpYWxpemVkID0gZmFsc2U7CgoJCX0KCgkJaWYgKCBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSAhPT0gbnVsbCApIHsKCgkJCWJvdW5kLnNwaGVyZS5jb3B5KCBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSApOwoJCQlib3VuZC5zcGhlcmVJbml0aWFsaXplZCA9IHRydWU7CgoJCX0gZWxzZSB7CgoJCQlib3VuZC5zcGhlcmVJbml0aWFsaXplZCA9IGZhbHNlOwoKCQl9CgoJCS8vIHNldCBkcmF3UmFuZ2UgY291bnQKCQljb25zdCBkcmF3UmFuZ2UgPSB0aGlzLl9kcmF3UmFuZ2VzWyBpZCBdOwoJCWNvbnN0IHBvc0F0dHIgPSBnZW9tZXRyeS5nZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicgKTsKCQlkcmF3UmFuZ2UuY291bnQgPSBoYXNJbmRleCA/IHNyY0luZGV4LmNvdW50IDogcG9zQXR0ci5jb3VudDsKCQl0aGlzLl92aXNpYmlsaXR5Q2hhbmdlZCA9IHRydWU7CgoJCXJldHVybiBpZDsKCgl9CgoJZGVsZXRlR2VvbWV0cnkoIGdlb21ldHJ5SWQgKSB7CgoJCS8vIE5vdGU6IFVzZXIgbmVlZHMgdG8gY2FsbCBvcHRpbWl6ZSgpIGFmdGVyd2FyZCB0byBwYWNrIHRoZSBkYXRhLgoKCQljb25zdCBhY3RpdmUgPSB0aGlzLl9hY3RpdmU7CgkJaWYgKCBnZW9tZXRyeUlkID49IGFjdGl2ZS5sZW5ndGggfHwgYWN0aXZlWyBnZW9tZXRyeUlkIF0gPT09IGZhbHNlICkgewoKCQkJcmV0dXJuIHRoaXM7CgoJCX0KCgkJYWN0aXZlWyBnZW9tZXRyeUlkIF0gPSBmYWxzZTsKCQl0aGlzLl92aXNpYmlsaXR5Q2hhbmdlZCA9IHRydWU7CgoJCXJldHVybiB0aGlzOwoKCX0KCgkvLyBnZXQgYm91bmRpbmcgYm94IGFuZCBjb21wdXRlIGl0IGlmIGl0IGRvZXNuJ3QgZXhpc3QKCWdldEJvdW5kaW5nQm94QXQoIGlkLCB0YXJnZXQgKSB7CgoJCWNvbnN0IGFjdGl2ZSA9IHRoaXMuX2FjdGl2ZTsKCQlpZiAoIGFjdGl2ZVsgaWQgXSA9PT0gZmFsc2UgKSB7CgoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQkvLyBjb21wdXRlIGJvdW5kaW5nIGJveAoJCWNvbnN0IGJvdW5kID0gdGhpcy5fYm91bmRzWyBpZCBdOwoJCWNvbnN0IGJveCA9IGJvdW5kLmJveDsKCQljb25zdCBnZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnk7CgkJaWYgKCBib3VuZC5ib3hJbml0aWFsaXplZCA9PT0gZmFsc2UgKSB7CgoJCQlib3gubWFrZUVtcHR5KCk7CgoJCQljb25zdCBpbmRleCA9IGdlb21ldHJ5LmluZGV4OwoJCQljb25zdCBwb3NpdGlvbiA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb247CgkJCWNvbnN0IGRyYXdSYW5nZSA9IHRoaXMuX2RyYXdSYW5nZXNbIGlkIF07CgkJCWZvciAoIGxldCBpID0gZHJhd1JhbmdlLnN0YXJ0LCBsID0gZHJhd1JhbmdlLnN0YXJ0ICsgZHJhd1JhbmdlLmNvdW50OyBpIDwgbDsgaSArKyApIHsKCgkJCQlsZXQgaXYgPSBpOwoJCQkJaWYgKCBpbmRleCApIHsKCgkJCQkJaXYgPSBpbmRleC5nZXRYKCBpdiApOwoKCQkJCX0KCgkJCQlib3guZXhwYW5kQnlQb2ludCggX3ZlY3RvciQ1LmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uLCBpdiApICk7CgoJCQl9CgoJCQlib3VuZC5ib3hJbml0aWFsaXplZCA9IHRydWU7CgoJCX0KCgkJdGFyZ2V0LmNvcHkoIGJveCApOwoJCXJldHVybiB0YXJnZXQ7CgoJfQoKCS8vIGdldCBib3VuZGluZyBzcGhlcmUgYW5kIGNvbXB1dGUgaXQgaWYgaXQgZG9lc24ndCBleGlzdAoJZ2V0Qm91bmRpbmdTcGhlcmVBdCggaWQsIHRhcmdldCApIHsKCgkJY29uc3QgYWN0aXZlID0gdGhpcy5fYWN0aXZlOwoJCWlmICggYWN0aXZlWyBpZCBdID09PSBmYWxzZSApIHsKCgkJCXJldHVybiBudWxsOwoKCQl9CgoJCS8vIGNvbXB1dGUgYm91bmRpbmcgc3BoZXJlCgkJY29uc3QgYm91bmQgPSB0aGlzLl9ib3VuZHNbIGlkIF07CgkJY29uc3Qgc3BoZXJlID0gYm91bmQuc3BoZXJlOwoJCWNvbnN0IGdlb21ldHJ5ID0gdGhpcy5nZW9tZXRyeTsKCQlpZiAoIGJvdW5kLnNwaGVyZUluaXRpYWxpemVkID09PSBmYWxzZSApIHsKCgkJCXNwaGVyZS5tYWtlRW1wdHkoKTsKCgkJCXRoaXMuZ2V0Qm91bmRpbmdCb3hBdCggaWQsIF9ib3gkMSApOwoJCQlfYm94JDEuZ2V0Q2VudGVyKCBzcGhlcmUuY2VudGVyICk7CgoJCQljb25zdCBpbmRleCA9IGdlb21ldHJ5LmluZGV4OwoJCQljb25zdCBwb3NpdGlvbiA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb247CgkJCWNvbnN0IGRyYXdSYW5nZSA9IHRoaXMuX2RyYXdSYW5nZXNbIGlkIF07CgoJCQlsZXQgbWF4UmFkaXVzU3EgPSAwOwoJCQlmb3IgKCBsZXQgaSA9IGRyYXdSYW5nZS5zdGFydCwgbCA9IGRyYXdSYW5nZS5zdGFydCArIGRyYXdSYW5nZS5jb3VudDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJbGV0IGl2ID0gaTsKCQkJCWlmICggaW5kZXggKSB7CgoJCQkJCWl2ID0gaW5kZXguZ2V0WCggaXYgKTsKCgkJCQl9CgoJCQkJX3ZlY3RvciQ1LmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uLCBpdiApOwoJCQkJbWF4UmFkaXVzU3EgPSBNYXRoLm1heCggbWF4UmFkaXVzU3EsIHNwaGVyZS5jZW50ZXIuZGlzdGFuY2VUb1NxdWFyZWQoIF92ZWN0b3IkNSApICk7CgoJCQl9CgoJCQlzcGhlcmUucmFkaXVzID0gTWF0aC5zcXJ0KCBtYXhSYWRpdXNTcSApOwoJCQlib3VuZC5zcGhlcmVJbml0aWFsaXplZCA9IHRydWU7CgoJCX0KCgkJdGFyZ2V0LmNvcHkoIHNwaGVyZSApOwoJCXJldHVybiB0YXJnZXQ7CgoJfQoKCXNldE1hdHJpeEF0KCBnZW9tZXRyeUlkLCBtYXRyaXggKSB7CgoJCS8vIEBUT0RPOiBNYXAgZ2VvbWV0cnlJZCB0byBpbmRleCBvZiB0aGUgYXJyYXlzIGJlY2F1c2UKCQkvLyAgICAgICAgb3B0aW1pemUoKSBjYW4gbWFrZSBnZW9tZXRyeUlkIG1pc21hdGNoIHRoZSBpbmRleAoKCQljb25zdCBhY3RpdmUgPSB0aGlzLl9hY3RpdmU7CgkJY29uc3QgbWF0cmljZXNUZXh0dXJlID0gdGhpcy5fbWF0cmljZXNUZXh0dXJlOwoJCWNvbnN0IG1hdHJpY2VzQXJyYXkgPSB0aGlzLl9tYXRyaWNlc1RleHR1cmUuaW1hZ2UuZGF0YTsKCQljb25zdCBnZW9tZXRyeUNvdW50ID0gdGhpcy5fZ2VvbWV0cnlDb3VudDsKCQlpZiAoIGdlb21ldHJ5SWQgPj0gZ2VvbWV0cnlDb3VudCB8fCBhY3RpdmVbIGdlb21ldHJ5SWQgXSA9PT0gZmFsc2UgKSB7CgoJCQlyZXR1cm4gdGhpczsKCgkJfQoKCQltYXRyaXgudG9BcnJheSggbWF0cmljZXNBcnJheSwgZ2VvbWV0cnlJZCAqIDE2ICk7CgkJbWF0cmljZXNUZXh0dXJlLm5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldE1hdHJpeEF0KCBnZW9tZXRyeUlkLCBtYXRyaXggKSB7CgoJCWNvbnN0IGFjdGl2ZSA9IHRoaXMuX2FjdGl2ZTsKCQljb25zdCBtYXRyaWNlc0FycmF5ID0gdGhpcy5fbWF0cmljZXNUZXh0dXJlLmltYWdlLmRhdGE7CgkJY29uc3QgZ2VvbWV0cnlDb3VudCA9IHRoaXMuX2dlb21ldHJ5Q291bnQ7CgkJaWYgKCBnZW9tZXRyeUlkID49IGdlb21ldHJ5Q291bnQgfHwgYWN0aXZlWyBnZW9tZXRyeUlkIF0gPT09IGZhbHNlICkgewoKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJcmV0dXJuIG1hdHJpeC5mcm9tQXJyYXkoIG1hdHJpY2VzQXJyYXksIGdlb21ldHJ5SWQgKiAxNiApOwoKCX0KCglzZXRWaXNpYmxlQXQoIGdlb21ldHJ5SWQsIHZhbHVlICkgewoKCQljb25zdCB2aXNpYmlsaXR5ID0gdGhpcy5fdmlzaWJpbGl0eTsKCQljb25zdCBhY3RpdmUgPSB0aGlzLl9hY3RpdmU7CgkJY29uc3QgZ2VvbWV0cnlDb3VudCA9IHRoaXMuX2dlb21ldHJ5Q291bnQ7CgoJCS8vIGlmIHRoZSBnZW9tZXRyeSBpcyBvdXQgb2YgcmFuZ2UsIG5vdCBhY3RpdmUsIG9yIHZpc2liaWxpdHkgc3RhdGUKCQkvLyBkb2VzIG5vdCBjaGFuZ2UgdGhlbiByZXR1cm4gZWFybHkKCQlpZiAoCgkJCWdlb21ldHJ5SWQgPj0gZ2VvbWV0cnlDb3VudCB8fAoJCQlhY3RpdmVbIGdlb21ldHJ5SWQgXSA9PT0gZmFsc2UgfHwKCQkJdmlzaWJpbGl0eVsgZ2VvbWV0cnlJZCBdID09PSB2YWx1ZQoJCSkgewoKCQkJcmV0dXJuIHRoaXM7CgoJCX0KCgkJdmlzaWJpbGl0eVsgZ2VvbWV0cnlJZCBdID0gdmFsdWU7CgkJdGhpcy5fdmlzaWJpbGl0eUNoYW5nZWQgPSB0cnVlOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0VmlzaWJsZUF0KCBnZW9tZXRyeUlkICkgewoKCQljb25zdCB2aXNpYmlsaXR5ID0gdGhpcy5fdmlzaWJpbGl0eTsKCQljb25zdCBhY3RpdmUgPSB0aGlzLl9hY3RpdmU7CgkJY29uc3QgZ2VvbWV0cnlDb3VudCA9IHRoaXMuX2dlb21ldHJ5Q291bnQ7CgoJCS8vIHJldHVybiBlYXJseSBpZiB0aGUgZ2VvbWV0cnkgaXMgb3V0IG9mIHJhbmdlIG9yIG5vdCBhY3RpdmUKCQlpZiAoIGdlb21ldHJ5SWQgPj0gZ2VvbWV0cnlDb3VudCB8fCBhY3RpdmVbIGdlb21ldHJ5SWQgXSA9PT0gZmFsc2UgKSB7CgoJCQlyZXR1cm4gZmFsc2U7CgoJCX0KCgkJcmV0dXJuIHZpc2liaWxpdHlbIGdlb21ldHJ5SWQgXTsKCgl9CgoJcmF5Y2FzdCggcmF5Y2FzdGVyLCBpbnRlcnNlY3RzICkgewoKCQljb25zdCB2aXNpYmlsaXR5ID0gdGhpcy5fdmlzaWJpbGl0eTsKCQljb25zdCBhY3RpdmUgPSB0aGlzLl9hY3RpdmU7CgkJY29uc3QgZHJhd1JhbmdlcyA9IHRoaXMuX2RyYXdSYW5nZXM7CgkJY29uc3QgZ2VvbWV0cnlDb3VudCA9IHRoaXMuX2dlb21ldHJ5Q291bnQ7CgkJY29uc3QgbWF0cml4V29ybGQgPSB0aGlzLm1hdHJpeFdvcmxkOwoJCWNvbnN0IGJhdGNoR2VvbWV0cnkgPSB0aGlzLmdlb21ldHJ5OwoKCQkvLyBpdGVyYXRlIG92ZXIgZWFjaCBnZW9tZXRyeQoJCV9tZXNoLm1hdGVyaWFsID0gdGhpcy5tYXRlcmlhbDsKCQlfbWVzaC5nZW9tZXRyeS5pbmRleCA9IGJhdGNoR2VvbWV0cnkuaW5kZXg7CgkJX21lc2guZ2VvbWV0cnkuYXR0cmlidXRlcyA9IGJhdGNoR2VvbWV0cnkuYXR0cmlidXRlczsKCQlpZiAoIF9tZXNoLmdlb21ldHJ5LmJvdW5kaW5nQm94ID09PSBudWxsICkgewoKCQkJX21lc2guZ2VvbWV0cnkuYm91bmRpbmdCb3ggPSBuZXcgQm94MygpOwoKCQl9CgoJCWlmICggX21lc2guZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgKSB7CgoJCQlfbWVzaC5nZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9IG5ldyBTcGhlcmUoKTsKCgkJfQoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBnZW9tZXRyeUNvdW50OyBpICsrICkgewoKCQkJaWYgKCAhIHZpc2liaWxpdHlbIGkgXSB8fCAhIGFjdGl2ZVsgaSBdICkgewoKCQkJCWNvbnRpbnVlOwoKCQkJfQoKCQkJY29uc3QgZHJhd1JhbmdlID0gZHJhd1Jhbmdlc1sgaSBdOwoJCQlfbWVzaC5nZW9tZXRyeS5zZXREcmF3UmFuZ2UoIGRyYXdSYW5nZS5zdGFydCwgZHJhd1JhbmdlLmNvdW50ICk7CgoJCQkvLyBnZSB0aGUgaW50ZXJzZWN0cwoJCQl0aGlzLmdldE1hdHJpeEF0KCBpLCBfbWVzaC5tYXRyaXhXb3JsZCApLnByZW11bHRpcGx5KCBtYXRyaXhXb3JsZCApOwoJCQl0aGlzLmdldEJvdW5kaW5nQm94QXQoIGksIF9tZXNoLmdlb21ldHJ5LmJvdW5kaW5nQm94ICk7CgkJCXRoaXMuZ2V0Qm91bmRpbmdTcGhlcmVBdCggaSwgX21lc2guZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgKTsKCQkJX21lc2gucmF5Y2FzdCggcmF5Y2FzdGVyLCBfYmF0Y2hJbnRlcnNlY3RzICk7CgoJCQkvLyBhZGQgYmF0Y2ggaWQgdG8gdGhlIGludGVyc2VjdHMKCQkJZm9yICggbGV0IGogPSAwLCBsID0gX2JhdGNoSW50ZXJzZWN0cy5sZW5ndGg7IGogPCBsOyBqICsrICkgewoKCQkJCWNvbnN0IGludGVyc2VjdCA9IF9iYXRjaEludGVyc2VjdHNbIGogXTsKCQkJCWludGVyc2VjdC5vYmplY3QgPSB0aGlzOwoJCQkJaW50ZXJzZWN0LmJhdGNoSWQgPSBpOwoJCQkJaW50ZXJzZWN0cy5wdXNoKCBpbnRlcnNlY3QgKTsKCgkJCX0KCgkJCV9iYXRjaEludGVyc2VjdHMubGVuZ3RoID0gMDsKCgkJfQoKCQlfbWVzaC5tYXRlcmlhbCA9IG51bGw7CgkJX21lc2guZ2VvbWV0cnkuaW5kZXggPSBudWxsOwoJCV9tZXNoLmdlb21ldHJ5LmF0dHJpYnV0ZXMgPSB7fTsKCQlfbWVzaC5nZW9tZXRyeS5zZXREcmF3UmFuZ2UoIDAsIEluZmluaXR5ICk7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuZ2VvbWV0cnkgPSBzb3VyY2UuZ2VvbWV0cnkuY2xvbmUoKTsKCQl0aGlzLnBlck9iamVjdEZydXN0dW1DdWxsZWQgPSBzb3VyY2UucGVyT2JqZWN0RnJ1c3R1bUN1bGxlZDsKCQl0aGlzLnNvcnRPYmplY3RzID0gc291cmNlLnNvcnRPYmplY3RzOwoJCXRoaXMuYm91bmRpbmdCb3ggPSBzb3VyY2UuYm91bmRpbmdCb3ggIT09IG51bGwgPyBzb3VyY2UuYm91bmRpbmdCb3guY2xvbmUoKSA6IG51bGw7CgkJdGhpcy5ib3VuZGluZ1NwaGVyZSA9IHNvdXJjZS5ib3VuZGluZ1NwaGVyZSAhPT0gbnVsbCA/IHNvdXJjZS5ib3VuZGluZ1NwaGVyZS5jbG9uZSgpIDogbnVsbDsKCgkJdGhpcy5fZHJhd1JhbmdlcyA9IHNvdXJjZS5fZHJhd1Jhbmdlcy5tYXAoIHJhbmdlID0+ICggeyAuLi5yYW5nZSB9ICkgKTsKCQl0aGlzLl9yZXNlcnZlZFJhbmdlcyA9IHNvdXJjZS5fcmVzZXJ2ZWRSYW5nZXMubWFwKCByYW5nZSA9PiAoIHsgLi4ucmFuZ2UgfSApICk7CgoJCXRoaXMuX3Zpc2liaWxpdHkgPSBzb3VyY2UuX3Zpc2liaWxpdHkuc2xpY2UoKTsKCQl0aGlzLl9hY3RpdmUgPSBzb3VyY2UuX2FjdGl2ZS5zbGljZSgpOwoJCXRoaXMuX2JvdW5kcyA9IHNvdXJjZS5fYm91bmRzLm1hcCggYm91bmQgPT4gKCB7CgkJCWJveEluaXRpYWxpemVkOiBib3VuZC5ib3hJbml0aWFsaXplZCwKCQkJYm94OiBib3VuZC5ib3guY2xvbmUoKSwKCgkJCXNwaGVyZUluaXRpYWxpemVkOiBib3VuZC5zcGhlcmVJbml0aWFsaXplZCwKCQkJc3BoZXJlOiBib3VuZC5zcGhlcmUuY2xvbmUoKQoJCX0gKSApOwoKCQl0aGlzLl9tYXhHZW9tZXRyeUNvdW50ID0gc291cmNlLl9tYXhHZW9tZXRyeUNvdW50OwoJCXRoaXMuX21heFZlcnRleENvdW50ID0gc291cmNlLl9tYXhWZXJ0ZXhDb3VudDsKCQl0aGlzLl9tYXhJbmRleENvdW50ID0gc291cmNlLl9tYXhJbmRleENvdW50OwoKCQl0aGlzLl9nZW9tZXRyeUluaXRpYWxpemVkID0gc291cmNlLl9nZW9tZXRyeUluaXRpYWxpemVkOwoJCXRoaXMuX2dlb21ldHJ5Q291bnQgPSBzb3VyY2UuX2dlb21ldHJ5Q291bnQ7CgkJdGhpcy5fbXVsdGlEcmF3Q291bnRzID0gc291cmNlLl9tdWx0aURyYXdDb3VudHMuc2xpY2UoKTsKCQl0aGlzLl9tdWx0aURyYXdTdGFydHMgPSBzb3VyY2UuX211bHRpRHJhd1N0YXJ0cy5zbGljZSgpOwoKCQl0aGlzLl9tYXRyaWNlc1RleHR1cmUgPSBzb3VyY2UuX21hdHJpY2VzVGV4dHVyZS5jbG9uZSgpOwoJCXRoaXMuX21hdHJpY2VzVGV4dHVyZS5pbWFnZS5kYXRhID0gdGhpcy5fbWF0cmljZXNUZXh0dXJlLmltYWdlLnNsaWNlKCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglkaXNwb3NlKCkgewoKCQkvLyBBc3N1bWluZyB0aGUgZ2VvbWV0cnkgaXMgbm90IHNoYXJlZCB3aXRoIG90aGVyIG1lc2hlcwoJCXRoaXMuZ2VvbWV0cnkuZGlzcG9zZSgpOwoKCQl0aGlzLl9tYXRyaWNlc1RleHR1cmUuZGlzcG9zZSgpOwoJCXRoaXMuX21hdHJpY2VzVGV4dHVyZSA9IG51bGw7CgkJcmV0dXJuIHRoaXM7CgoJfQoKCW9uQmVmb3JlUmVuZGVyKCByZW5kZXJlciwgc2NlbmUsIGNhbWVyYSwgZ2VvbWV0cnksIG1hdGVyaWFsLyosIF9ncm91cCovICkgewoKCQkvLyBpZiB2aXNpYmlsaXR5IGhhcyBub3QgY2hhbmdlZCBhbmQgZnJ1c3R1bSBjdWxsaW5nIGFuZCBvYmplY3Qgc29ydGluZyBpcyBub3QgcmVxdWlyZWQKCQkvLyB0aGVuIHNraXAgaXRlcmF0aW5nIG92ZXIgYWxsIGl0ZW1zCgkJaWYgKCAhIHRoaXMuX3Zpc2liaWxpdHlDaGFuZ2VkICYmICEgdGhpcy5wZXJPYmplY3RGcnVzdHVtQ3VsbGVkICYmICEgdGhpcy5zb3J0T2JqZWN0cyApIHsKCgkJCXJldHVybjsKCgkJfQoKCQkvLyB0aGUgaW5kZXhlZCB2ZXJzaW9uIG9mIHRoZSBtdWx0aSBkcmF3IGZ1bmN0aW9uIHJlcXVpcmVzIHNwZWNpZnlpbmcgdGhlIHN0YXJ0CgkJLy8gb2Zmc2V0IGluIGJ5dGVzLgoJCWNvbnN0IGluZGV4ID0gZ2VvbWV0cnkuZ2V0SW5kZXgoKTsKCQljb25zdCBieXRlc1BlckVsZW1lbnQgPSBpbmRleCA9PT0gbnVsbCA/IDEgOiBpbmRleC5hcnJheS5CWVRFU19QRVJfRUxFTUVOVDsKCgkJY29uc3QgYWN0aXZlID0gdGhpcy5fYWN0aXZlOwoJCWNvbnN0IHZpc2liaWxpdHkgPSB0aGlzLl92aXNpYmlsaXR5OwoJCWNvbnN0IG11bHRpRHJhd1N0YXJ0cyA9IHRoaXMuX211bHRpRHJhd1N0YXJ0czsKCQljb25zdCBtdWx0aURyYXdDb3VudHMgPSB0aGlzLl9tdWx0aURyYXdDb3VudHM7CgkJY29uc3QgZHJhd1JhbmdlcyA9IHRoaXMuX2RyYXdSYW5nZXM7CgkJY29uc3QgcGVyT2JqZWN0RnJ1c3R1bUN1bGxlZCA9IHRoaXMucGVyT2JqZWN0RnJ1c3R1bUN1bGxlZDsKCgkJLy8gcHJlcGFyZSB0aGUgZnJ1c3R1bSBpbiB0aGUgbG9jYWwgZnJhbWUKCQlpZiAoIHBlck9iamVjdEZydXN0dW1DdWxsZWQgKSB7CgoJCQlfcHJvalNjcmVlbk1hdHJpeCQyCgkJCQkubXVsdGlwbHlNYXRyaWNlcyggY2FtZXJhLnByb2plY3Rpb25NYXRyaXgsIGNhbWVyYS5tYXRyaXhXb3JsZEludmVyc2UgKQoJCQkJLm11bHRpcGx5KCB0aGlzLm1hdHJpeFdvcmxkICk7CgkJCV9mcnVzdHVtLnNldEZyb21Qcm9qZWN0aW9uTWF0cml4KAoJCQkJX3Byb2pTY3JlZW5NYXRyaXgkMiwKCQkJCXJlbmRlcmVyLmNvb3JkaW5hdGVTeXN0ZW0KCQkJKTsKCgkJfQoKCQlsZXQgY291bnQgPSAwOwoJCWlmICggdGhpcy5zb3J0T2JqZWN0cyApIHsKCgkJCS8vIGdldCB0aGUgY2FtZXJhIHBvc2l0aW9uIGluIHRoZSBsb2NhbCBmcmFtZQoJCQlfaW52TWF0cml4V29ybGQuY29weSggdGhpcy5tYXRyaXhXb3JsZCApLmludmVydCgpOwoJCQlfdmVjdG9yJDUuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCBjYW1lcmEubWF0cml4V29ybGQgKS5hcHBseU1hdHJpeDQoIF9pbnZNYXRyaXhXb3JsZCApOwoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gdmlzaWJpbGl0eS5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWlmICggdmlzaWJpbGl0eVsgaSBdICYmIGFjdGl2ZVsgaSBdICkgewoKCQkJCQkvLyBnZXQgdGhlIGJvdW5kcyBpbiB3b3JsZCBzcGFjZQoJCQkJCXRoaXMuZ2V0TWF0cml4QXQoIGksIF9tYXRyaXggKTsKCQkJCQl0aGlzLmdldEJvdW5kaW5nU3BoZXJlQXQoIGksIF9zcGhlcmUkMiApLmFwcGx5TWF0cml4NCggX21hdHJpeCApOwoKCQkJCQkvLyBkZXRlcm1pbmUgd2hldGhlciB0aGUgYmF0Y2hlZCBnZW9tZXRyeSBpcyB3aXRoaW4gdGhlIGZydXN0dW0KCQkJCQlsZXQgY3VsbGVkID0gZmFsc2U7CgkJCQkJaWYgKCBwZXJPYmplY3RGcnVzdHVtQ3VsbGVkICkgewoKCQkJCQkJY3VsbGVkID0gISBfZnJ1c3R1bS5pbnRlcnNlY3RzU3BoZXJlKCBfc3BoZXJlJDIgKTsKCgkJCQkJfQoKCQkJCQlpZiAoICEgY3VsbGVkICkgewoKCQkJCQkJLy8gZ2V0IHRoZSBkaXN0YW5jZSBmcm9tIGNhbWVyYSB1c2VkIGZvciBzb3J0aW5nCgkJCQkJCWNvbnN0IHogPSBfdmVjdG9yJDUuZGlzdGFuY2VUbyggX3NwaGVyZSQyLmNlbnRlciApOwoJCQkJCQlfcmVuZGVyTGlzdC5wdXNoKCBkcmF3UmFuZ2VzWyBpIF0sIHogKTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJCS8vIFNvcnQgdGhlIGRyYXcgcmFuZ2VzIGFuZCBwcmVwIGZvciByZW5kZXJpbmcKCQkJY29uc3QgbGlzdCA9IF9yZW5kZXJMaXN0Lmxpc3Q7CgkJCWNvbnN0IGN1c3RvbVNvcnQgPSB0aGlzLmN1c3RvbVNvcnQ7CgkJCWlmICggY3VzdG9tU29ydCA9PT0gbnVsbCApIHsKCgkJCQlsaXN0LnNvcnQoIG1hdGVyaWFsLnRyYW5zcGFyZW50ID8gc29ydFRyYW5zcGFyZW50IDogc29ydE9wYXF1ZSApOwoKCQkJfSBlbHNlIHsKCgkJCQljdXN0b21Tb3J0LmNhbGwoIHRoaXMsIGxpc3QsIGNhbWVyYSApOwoKCQkJfQoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWNvbnN0IGl0ZW0gPSBsaXN0WyBpIF07CgkJCQltdWx0aURyYXdTdGFydHNbIGNvdW50IF0gPSBpdGVtLnN0YXJ0ICogYnl0ZXNQZXJFbGVtZW50OwoJCQkJbXVsdGlEcmF3Q291bnRzWyBjb3VudCBdID0gaXRlbS5jb3VudDsKCQkJCWNvdW50ICsrOwoKCQkJfQoKCQkJX3JlbmRlckxpc3QucmVzZXQoKTsKCgkJfSBlbHNlIHsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IHZpc2liaWxpdHkubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQlpZiAoIHZpc2liaWxpdHlbIGkgXSAmJiBhY3RpdmVbIGkgXSApIHsKCgkJCQkJLy8gZGV0ZXJtaW5lIHdoZXRoZXIgdGhlIGJhdGNoZWQgZ2VvbWV0cnkgaXMgd2l0aGluIHRoZSBmcnVzdHVtCgkJCQkJbGV0IGN1bGxlZCA9IGZhbHNlOwoJCQkJCWlmICggcGVyT2JqZWN0RnJ1c3R1bUN1bGxlZCApIHsKCgkJCQkJCS8vIGdldCB0aGUgYm91bmRzIGluIHdvcmxkIHNwYWNlCgkJCQkJCXRoaXMuZ2V0TWF0cml4QXQoIGksIF9tYXRyaXggKTsKCQkJCQkJdGhpcy5nZXRCb3VuZGluZ1NwaGVyZUF0KCBpLCBfc3BoZXJlJDIgKS5hcHBseU1hdHJpeDQoIF9tYXRyaXggKTsKCQkJCQkJY3VsbGVkID0gISBfZnJ1c3R1bS5pbnRlcnNlY3RzU3BoZXJlKCBfc3BoZXJlJDIgKTsKCgkJCQkJfQoKCQkJCQlpZiAoICEgY3VsbGVkICkgewoKCQkJCQkJY29uc3QgcmFuZ2UgPSBkcmF3UmFuZ2VzWyBpIF07CgkJCQkJCW11bHRpRHJhd1N0YXJ0c1sgY291bnQgXSA9IHJhbmdlLnN0YXJ0ICogYnl0ZXNQZXJFbGVtZW50OwoJCQkJCQltdWx0aURyYXdDb3VudHNbIGNvdW50IF0gPSByYW5nZS5jb3VudDsKCQkJCQkJY291bnQgKys7CgoJCQkJCX0KCgkJCQl9CgoJCQl9CgoJCX0KCgkJdGhpcy5fbXVsdGlEcmF3Q291bnQgPSBjb3VudDsKCQl0aGlzLl92aXNpYmlsaXR5Q2hhbmdlZCA9IGZhbHNlOwoKCX0KCglvbkJlZm9yZVNoYWRvdyggcmVuZGVyZXIsIG9iamVjdCwgY2FtZXJhLCBzaGFkb3dDYW1lcmEsIGdlb21ldHJ5LCBkZXB0aE1hdGVyaWFsLyogLCBncm91cCAqLyApIHsKCgkJdGhpcy5vbkJlZm9yZVJlbmRlciggcmVuZGVyZXIsIG51bGwsIHNoYWRvd0NhbWVyYSwgZ2VvbWV0cnksIGRlcHRoTWF0ZXJpYWwgKTsKCgl9Cgp9CgpjbGFzcyBMaW5lQmFzaWNNYXRlcmlhbCBleHRlbmRzIE1hdGVyaWFsIHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVycyApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc0xpbmVCYXNpY01hdGVyaWFsID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ0xpbmVCYXNpY01hdGVyaWFsJzsKCgkJdGhpcy5jb2xvciA9IG5ldyBDb2xvciggMHhmZmZmZmYgKTsKCgkJdGhpcy5tYXAgPSBudWxsOwoKCQl0aGlzLmxpbmV3aWR0aCA9IDE7CgkJdGhpcy5saW5lY2FwID0gJ3JvdW5kJzsKCQl0aGlzLmxpbmVqb2luID0gJ3JvdW5kJzsKCgkJdGhpcy5mb2cgPSB0cnVlOwoKCQl0aGlzLnNldFZhbHVlcyggcGFyYW1ldGVycyApOwoKCX0KCgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5jb2xvci5jb3B5KCBzb3VyY2UuY29sb3IgKTsKCgkJdGhpcy5tYXAgPSBzb3VyY2UubWFwOwoKCQl0aGlzLmxpbmV3aWR0aCA9IHNvdXJjZS5saW5ld2lkdGg7CgkJdGhpcy5saW5lY2FwID0gc291cmNlLmxpbmVjYXA7CgkJdGhpcy5saW5lam9pbiA9IHNvdXJjZS5saW5lam9pbjsKCgkJdGhpcy5mb2cgPSBzb3VyY2UuZm9nOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9Cgpjb25zdCBfc3RhcnQkMSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX2VuZCQxID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfaW52ZXJzZU1hdHJpeCQxID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwpjb25zdCBfcmF5JDEgPSAvKkBfX1BVUkVfXyovIG5ldyBSYXkoKTsKY29uc3QgX3NwaGVyZSQxID0gLypAX19QVVJFX18qLyBuZXcgU3BoZXJlKCk7CgpjbGFzcyBMaW5lIGV4dGVuZHMgT2JqZWN0M0QgewoKCWNvbnN0cnVjdG9yKCBnZW9tZXRyeSA9IG5ldyBCdWZmZXJHZW9tZXRyeSgpLCBtYXRlcmlhbCA9IG5ldyBMaW5lQmFzaWNNYXRlcmlhbCgpICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzTGluZSA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdMaW5lJzsKCgkJdGhpcy5nZW9tZXRyeSA9IGdlb21ldHJ5OwoJCXRoaXMubWF0ZXJpYWwgPSBtYXRlcmlhbDsKCgkJdGhpcy51cGRhdGVNb3JwaFRhcmdldHMoKTsKCgl9CgoJY29weSggc291cmNlLCByZWN1cnNpdmUgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICk7CgoJCXRoaXMubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KCBzb3VyY2UubWF0ZXJpYWwgKSA/IHNvdXJjZS5tYXRlcmlhbC5zbGljZSgpIDogc291cmNlLm1hdGVyaWFsOwoJCXRoaXMuZ2VvbWV0cnkgPSBzb3VyY2UuZ2VvbWV0cnk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb21wdXRlTGluZURpc3RhbmNlcygpIHsKCgkJY29uc3QgZ2VvbWV0cnkgPSB0aGlzLmdlb21ldHJ5OwoKCQkvLyB3ZSBhc3N1bWUgbm9uLWluZGV4ZWQgZ2VvbWV0cnkKCgkJaWYgKCBnZW9tZXRyeS5pbmRleCA9PT0gbnVsbCApIHsKCgkJCWNvbnN0IHBvc2l0aW9uQXR0cmlidXRlID0gZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKCQkJY29uc3QgbGluZURpc3RhbmNlcyA9IFsgMCBdOwoKCQkJZm9yICggbGV0IGkgPSAxLCBsID0gcG9zaXRpb25BdHRyaWJ1dGUuY291bnQ7IGkgPCBsOyBpICsrICkgewoKCQkJCV9zdGFydCQxLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCBpIC0gMSApOwoJCQkJX2VuZCQxLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCBpICk7CgoJCQkJbGluZURpc3RhbmNlc1sgaSBdID0gbGluZURpc3RhbmNlc1sgaSAtIDEgXTsKCQkJCWxpbmVEaXN0YW5jZXNbIGkgXSArPSBfc3RhcnQkMS5kaXN0YW5jZVRvKCBfZW5kJDEgKTsKCgkJCX0KCgkJCWdlb21ldHJ5LnNldEF0dHJpYnV0ZSggJ2xpbmVEaXN0YW5jZScsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCBsaW5lRGlzdGFuY2VzLCAxICkgKTsKCgkJfSBlbHNlIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLkxpbmUuY29tcHV0ZUxpbmVEaXN0YW5jZXMoKTogQ29tcHV0YXRpb24gb25seSBwb3NzaWJsZSB3aXRoIG5vbi1pbmRleGVkIEJ1ZmZlckdlb21ldHJ5LicgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcmF5Y2FzdCggcmF5Y2FzdGVyLCBpbnRlcnNlY3RzICkgewoKCQljb25zdCBnZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnk7CgkJY29uc3QgbWF0cml4V29ybGQgPSB0aGlzLm1hdHJpeFdvcmxkOwoJCWNvbnN0IHRocmVzaG9sZCA9IHJheWNhc3Rlci5wYXJhbXMuTGluZS50aHJlc2hvbGQ7CgkJY29uc3QgZHJhd1JhbmdlID0gZ2VvbWV0cnkuZHJhd1JhbmdlOwoKCQkvLyBDaGVja2luZyBib3VuZGluZ1NwaGVyZSBkaXN0YW5jZSB0byByYXkKCgkJaWYgKCBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSA9PT0gbnVsbCApIGdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwoKCQlfc3BoZXJlJDEuY29weSggZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgKTsKCQlfc3BoZXJlJDEuYXBwbHlNYXRyaXg0KCBtYXRyaXhXb3JsZCApOwoJCV9zcGhlcmUkMS5yYWRpdXMgKz0gdGhyZXNob2xkOwoKCQlpZiAoIHJheWNhc3Rlci5yYXkuaW50ZXJzZWN0c1NwaGVyZSggX3NwaGVyZSQxICkgPT09IGZhbHNlICkgcmV0dXJuOwoKCQkvLwoKCQlfaW52ZXJzZU1hdHJpeCQxLmNvcHkoIG1hdHJpeFdvcmxkICkuaW52ZXJ0KCk7CgkJX3JheSQxLmNvcHkoIHJheWNhc3Rlci5yYXkgKS5hcHBseU1hdHJpeDQoIF9pbnZlcnNlTWF0cml4JDEgKTsKCgkJY29uc3QgbG9jYWxUaHJlc2hvbGQgPSB0aHJlc2hvbGQgLyAoICggdGhpcy5zY2FsZS54ICsgdGhpcy5zY2FsZS55ICsgdGhpcy5zY2FsZS56ICkgLyAzICk7CgkJY29uc3QgbG9jYWxUaHJlc2hvbGRTcSA9IGxvY2FsVGhyZXNob2xkICogbG9jYWxUaHJlc2hvbGQ7CgoJCWNvbnN0IHZTdGFydCA9IG5ldyBWZWN0b3IzKCk7CgkJY29uc3QgdkVuZCA9IG5ldyBWZWN0b3IzKCk7CgkJY29uc3QgaW50ZXJTZWdtZW50ID0gbmV3IFZlY3RvcjMoKTsKCQljb25zdCBpbnRlclJheSA9IG5ldyBWZWN0b3IzKCk7CgkJY29uc3Qgc3RlcCA9IHRoaXMuaXNMaW5lU2VnbWVudHMgPyAyIDogMTsKCgkJY29uc3QgaW5kZXggPSBnZW9tZXRyeS5pbmRleDsKCQljb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKCQljb25zdCBwb3NpdGlvbkF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXMucG9zaXRpb247CgoJCWlmICggaW5kZXggIT09IG51bGwgKSB7CgoJCQljb25zdCBzdGFydCA9IE1hdGgubWF4KCAwLCBkcmF3UmFuZ2Uuc3RhcnQgKTsKCQkJY29uc3QgZW5kID0gTWF0aC5taW4oIGluZGV4LmNvdW50LCAoIGRyYXdSYW5nZS5zdGFydCArIGRyYXdSYW5nZS5jb3VudCApICk7CgoJCQlmb3IgKCBsZXQgaSA9IHN0YXJ0LCBsID0gZW5kIC0gMTsgaSA8IGw7IGkgKz0gc3RlcCApIHsKCgkJCQljb25zdCBhID0gaW5kZXguZ2V0WCggaSApOwoJCQkJY29uc3QgYiA9IGluZGV4LmdldFgoIGkgKyAxICk7CgoJCQkJdlN0YXJ0LmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCBhICk7CgkJCQl2RW5kLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0cmlidXRlLCBiICk7CgoJCQkJY29uc3QgZGlzdFNxID0gX3JheSQxLmRpc3RhbmNlU3FUb1NlZ21lbnQoIHZTdGFydCwgdkVuZCwgaW50ZXJSYXksIGludGVyU2VnbWVudCApOwoKCQkJCWlmICggZGlzdFNxID4gbG9jYWxUaHJlc2hvbGRTcSApIGNvbnRpbnVlOwoKCQkJCWludGVyUmF5LmFwcGx5TWF0cml4NCggdGhpcy5tYXRyaXhXb3JsZCApOyAvL01vdmUgYmFjayB0byB3b3JsZCBzcGFjZSBmb3IgZGlzdGFuY2UgY2FsY3VsYXRpb24KCgkJCQljb25zdCBkaXN0YW5jZSA9IHJheWNhc3Rlci5yYXkub3JpZ2luLmRpc3RhbmNlVG8oIGludGVyUmF5ICk7CgoJCQkJaWYgKCBkaXN0YW5jZSA8IHJheWNhc3Rlci5uZWFyIHx8IGRpc3RhbmNlID4gcmF5Y2FzdGVyLmZhciApIGNvbnRpbnVlOwoKCQkJCWludGVyc2VjdHMucHVzaCggewoKCQkJCQlkaXN0YW5jZTogZGlzdGFuY2UsCgkJCQkJLy8gV2hhdCBkbyB3ZSB3YW50PyBpbnRlcnNlY3Rpb24gcG9pbnQgb24gdGhlIHJheSBvciBvbiB0aGUgc2VnbWVudD8/CgkJCQkJLy8gcG9pbnQ6IHJheWNhc3Rlci5yYXkuYXQoIGRpc3RhbmNlICksCgkJCQkJcG9pbnQ6IGludGVyU2VnbWVudC5jbG9uZSgpLmFwcGx5TWF0cml4NCggdGhpcy5tYXRyaXhXb3JsZCApLAoJCQkJCWluZGV4OiBpLAoJCQkJCWZhY2U6IG51bGwsCgkJCQkJZmFjZUluZGV4OiBudWxsLAoJCQkJCW9iamVjdDogdGhpcwoKCQkJCX0gKTsKCgkJCX0KCgkJfSBlbHNlIHsKCgkJCWNvbnN0IHN0YXJ0ID0gTWF0aC5tYXgoIDAsIGRyYXdSYW5nZS5zdGFydCApOwoJCQljb25zdCBlbmQgPSBNYXRoLm1pbiggcG9zaXRpb25BdHRyaWJ1dGUuY291bnQsICggZHJhd1JhbmdlLnN0YXJ0ICsgZHJhd1JhbmdlLmNvdW50ICkgKTsKCgkJCWZvciAoIGxldCBpID0gc3RhcnQsIGwgPSBlbmQgLSAxOyBpIDwgbDsgaSArPSBzdGVwICkgewoKCQkJCXZTdGFydC5mcm9tQnVmZmVyQXR0cmlidXRlKCBwb3NpdGlvbkF0dHJpYnV0ZSwgaSApOwoJCQkJdkVuZC5mcm9tQnVmZmVyQXR0cmlidXRlKCBwb3NpdGlvbkF0dHJpYnV0ZSwgaSArIDEgKTsKCgkJCQljb25zdCBkaXN0U3EgPSBfcmF5JDEuZGlzdGFuY2VTcVRvU2VnbWVudCggdlN0YXJ0LCB2RW5kLCBpbnRlclJheSwgaW50ZXJTZWdtZW50ICk7CgoJCQkJaWYgKCBkaXN0U3EgPiBsb2NhbFRocmVzaG9sZFNxICkgY29udGludWU7CgoJCQkJaW50ZXJSYXkuYXBwbHlNYXRyaXg0KCB0aGlzLm1hdHJpeFdvcmxkICk7IC8vTW92ZSBiYWNrIHRvIHdvcmxkIHNwYWNlIGZvciBkaXN0YW5jZSBjYWxjdWxhdGlvbgoKCQkJCWNvbnN0IGRpc3RhbmNlID0gcmF5Y2FzdGVyLnJheS5vcmlnaW4uZGlzdGFuY2VUbyggaW50ZXJSYXkgKTsKCgkJCQlpZiAoIGRpc3RhbmNlIDwgcmF5Y2FzdGVyLm5lYXIgfHwgZGlzdGFuY2UgPiByYXljYXN0ZXIuZmFyICkgY29udGludWU7CgoJCQkJaW50ZXJzZWN0cy5wdXNoKCB7CgoJCQkJCWRpc3RhbmNlOiBkaXN0YW5jZSwKCQkJCQkvLyBXaGF0IGRvIHdlIHdhbnQ/IGludGVyc2VjdGlvbiBwb2ludCBvbiB0aGUgcmF5IG9yIG9uIHRoZSBzZWdtZW50Pz8KCQkJCQkvLyBwb2ludDogcmF5Y2FzdGVyLnJheS5hdCggZGlzdGFuY2UgKSwKCQkJCQlwb2ludDogaW50ZXJTZWdtZW50LmNsb25lKCkuYXBwbHlNYXRyaXg0KCB0aGlzLm1hdHJpeFdvcmxkICksCgkJCQkJaW5kZXg6IGksCgkJCQkJZmFjZTogbnVsbCwKCQkJCQlmYWNlSW5kZXg6IG51bGwsCgkJCQkJb2JqZWN0OiB0aGlzCgoJCQkJfSApOwoKCQkJfQoKCQl9CgoJfQoKCXVwZGF0ZU1vcnBoVGFyZ2V0cygpIHsKCgkJY29uc3QgZ2VvbWV0cnkgPSB0aGlzLmdlb21ldHJ5OwoKCQljb25zdCBtb3JwaEF0dHJpYnV0ZXMgPSBnZW9tZXRyeS5tb3JwaEF0dHJpYnV0ZXM7CgkJY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKCBtb3JwaEF0dHJpYnV0ZXMgKTsKCgkJaWYgKCBrZXlzLmxlbmd0aCA+IDAgKSB7CgoJCQljb25zdCBtb3JwaEF0dHJpYnV0ZSA9IG1vcnBoQXR0cmlidXRlc1sga2V5c1sgMCBdIF07CgoJCQlpZiAoIG1vcnBoQXR0cmlidXRlICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJdGhpcy5tb3JwaFRhcmdldEluZmx1ZW5jZXMgPSBbXTsKCQkJCXRoaXMubW9ycGhUYXJnZXREaWN0aW9uYXJ5ID0ge307CgoJCQkJZm9yICggbGV0IG0gPSAwLCBtbCA9IG1vcnBoQXR0cmlidXRlLmxlbmd0aDsgbSA8IG1sOyBtICsrICkgewoKCQkJCQljb25zdCBuYW1lID0gbW9ycGhBdHRyaWJ1dGVbIG0gXS5uYW1lIHx8IFN0cmluZyggbSApOwoKCQkJCQl0aGlzLm1vcnBoVGFyZ2V0SW5mbHVlbmNlcy5wdXNoKCAwICk7CgkJCQkJdGhpcy5tb3JwaFRhcmdldERpY3Rpb25hcnlbIG5hbWUgXSA9IG07CgoJCQkJfQoKCQkJfQoKCQl9CgoJfQoKfQoKY29uc3QgX3N0YXJ0ID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfZW5kID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwoKY2xhc3MgTGluZVNlZ21lbnRzIGV4dGVuZHMgTGluZSB7CgoJY29uc3RydWN0b3IoIGdlb21ldHJ5LCBtYXRlcmlhbCApIHsKCgkJc3VwZXIoIGdlb21ldHJ5LCBtYXRlcmlhbCApOwoKCQl0aGlzLmlzTGluZVNlZ21lbnRzID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ0xpbmVTZWdtZW50cyc7CgoJfQoKCWNvbXB1dGVMaW5lRGlzdGFuY2VzKCkgewoKCQljb25zdCBnZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnk7CgoJCS8vIHdlIGFzc3VtZSBub24taW5kZXhlZCBnZW9tZXRyeQoKCQlpZiAoIGdlb21ldHJ5LmluZGV4ID09PSBudWxsICkgewoKCQkJY29uc3QgcG9zaXRpb25BdHRyaWJ1dGUgPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uOwoJCQljb25zdCBsaW5lRGlzdGFuY2VzID0gW107CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBwb3NpdGlvbkF0dHJpYnV0ZS5jb3VudDsgaSA8IGw7IGkgKz0gMiApIHsKCgkJCQlfc3RhcnQuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb25BdHRyaWJ1dGUsIGkgKTsKCQkJCV9lbmQuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb25BdHRyaWJ1dGUsIGkgKyAxICk7CgoJCQkJbGluZURpc3RhbmNlc1sgaSBdID0gKCBpID09PSAwICkgPyAwIDogbGluZURpc3RhbmNlc1sgaSAtIDEgXTsKCQkJCWxpbmVEaXN0YW5jZXNbIGkgKyAxIF0gPSBsaW5lRGlzdGFuY2VzWyBpIF0gKyBfc3RhcnQuZGlzdGFuY2VUbyggX2VuZCApOwoKCQkJfQoKCQkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAnbGluZURpc3RhbmNlJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIGxpbmVEaXN0YW5jZXMsIDEgKSApOwoKCQl9IGVsc2UgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuTGluZVNlZ21lbnRzLmNvbXB1dGVMaW5lRGlzdGFuY2VzKCk6IENvbXB1dGF0aW9uIG9ubHkgcG9zc2libGUgd2l0aCBub24taW5kZXhlZCBCdWZmZXJHZW9tZXRyeS4nICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKY2xhc3MgTGluZUxvb3AgZXh0ZW5kcyBMaW5lIHsKCgljb25zdHJ1Y3RvciggZ2VvbWV0cnksIG1hdGVyaWFsICkgewoKCQlzdXBlciggZ2VvbWV0cnksIG1hdGVyaWFsICk7CgoJCXRoaXMuaXNMaW5lTG9vcCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdMaW5lTG9vcCc7CgoJfQoKfQoKY2xhc3MgUG9pbnRzTWF0ZXJpYWwgZXh0ZW5kcyBNYXRlcmlhbCB7CgoJY29uc3RydWN0b3IoIHBhcmFtZXRlcnMgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNQb2ludHNNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdQb2ludHNNYXRlcmlhbCc7CgoJCXRoaXMuY29sb3IgPSBuZXcgQ29sb3IoIDB4ZmZmZmZmICk7CgoJCXRoaXMubWFwID0gbnVsbDsKCgkJdGhpcy5hbHBoYU1hcCA9IG51bGw7CgoJCXRoaXMuc2l6ZSA9IDE7CgkJdGhpcy5zaXplQXR0ZW51YXRpb24gPSB0cnVlOwoKCQl0aGlzLmZvZyA9IHRydWU7CgoJCXRoaXMuc2V0VmFsdWVzKCBwYXJhbWV0ZXJzICk7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuY29sb3IuY29weSggc291cmNlLmNvbG9yICk7CgoJCXRoaXMubWFwID0gc291cmNlLm1hcDsKCgkJdGhpcy5hbHBoYU1hcCA9IHNvdXJjZS5hbHBoYU1hcDsKCgkJdGhpcy5zaXplID0gc291cmNlLnNpemU7CgkJdGhpcy5zaXplQXR0ZW51YXRpb24gPSBzb3VyY2Uuc2l6ZUF0dGVudWF0aW9uOwoKCQl0aGlzLmZvZyA9IHNvdXJjZS5mb2c7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNvbnN0IF9pbnZlcnNlTWF0cml4ID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwpjb25zdCBfcmF5ID0gLypAX19QVVJFX18qLyBuZXcgUmF5KCk7CmNvbnN0IF9zcGhlcmUgPSAvKkBfX1BVUkVfXyovIG5ldyBTcGhlcmUoKTsKY29uc3QgX3Bvc2l0aW9uJDIgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CgpjbGFzcyBQb2ludHMgZXh0ZW5kcyBPYmplY3QzRCB7CgoJY29uc3RydWN0b3IoIGdlb21ldHJ5ID0gbmV3IEJ1ZmZlckdlb21ldHJ5KCksIG1hdGVyaWFsID0gbmV3IFBvaW50c01hdGVyaWFsKCkgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNQb2ludHMgPSB0cnVlOwoKCQl0aGlzLnR5cGUgPSAnUG9pbnRzJzsKCgkJdGhpcy5nZW9tZXRyeSA9IGdlb21ldHJ5OwoJCXRoaXMubWF0ZXJpYWwgPSBtYXRlcmlhbDsKCgkJdGhpcy51cGRhdGVNb3JwaFRhcmdldHMoKTsKCgl9CgoJY29weSggc291cmNlLCByZWN1cnNpdmUgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICk7CgoJCXRoaXMubWF0ZXJpYWwgPSBBcnJheS5pc0FycmF5KCBzb3VyY2UubWF0ZXJpYWwgKSA/IHNvdXJjZS5tYXRlcmlhbC5zbGljZSgpIDogc291cmNlLm1hdGVyaWFsOwoJCXRoaXMuZ2VvbWV0cnkgPSBzb3VyY2UuZ2VvbWV0cnk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglyYXljYXN0KCByYXljYXN0ZXIsIGludGVyc2VjdHMgKSB7CgoJCWNvbnN0IGdlb21ldHJ5ID0gdGhpcy5nZW9tZXRyeTsKCQljb25zdCBtYXRyaXhXb3JsZCA9IHRoaXMubWF0cml4V29ybGQ7CgkJY29uc3QgdGhyZXNob2xkID0gcmF5Y2FzdGVyLnBhcmFtcy5Qb2ludHMudGhyZXNob2xkOwoJCWNvbnN0IGRyYXdSYW5nZSA9IGdlb21ldHJ5LmRyYXdSYW5nZTsKCgkJLy8gQ2hlY2tpbmcgYm91bmRpbmdTcGhlcmUgZGlzdGFuY2UgdG8gcmF5CgoJCWlmICggZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgPT09IG51bGwgKSBnZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTsKCgkJX3NwaGVyZS5jb3B5KCBnZW9tZXRyeS5ib3VuZGluZ1NwaGVyZSApOwoJCV9zcGhlcmUuYXBwbHlNYXRyaXg0KCBtYXRyaXhXb3JsZCApOwoJCV9zcGhlcmUucmFkaXVzICs9IHRocmVzaG9sZDsKCgkJaWYgKCByYXljYXN0ZXIucmF5LmludGVyc2VjdHNTcGhlcmUoIF9zcGhlcmUgKSA9PT0gZmFsc2UgKSByZXR1cm47CgoJCS8vCgoJCV9pbnZlcnNlTWF0cml4LmNvcHkoIG1hdHJpeFdvcmxkICkuaW52ZXJ0KCk7CgkJX3JheS5jb3B5KCByYXljYXN0ZXIucmF5ICkuYXBwbHlNYXRyaXg0KCBfaW52ZXJzZU1hdHJpeCApOwoKCQljb25zdCBsb2NhbFRocmVzaG9sZCA9IHRocmVzaG9sZCAvICggKCB0aGlzLnNjYWxlLnggKyB0aGlzLnNjYWxlLnkgKyB0aGlzLnNjYWxlLnogKSAvIDMgKTsKCQljb25zdCBsb2NhbFRocmVzaG9sZFNxID0gbG9jYWxUaHJlc2hvbGQgKiBsb2NhbFRocmVzaG9sZDsKCgkJY29uc3QgaW5kZXggPSBnZW9tZXRyeS5pbmRleDsKCQljb25zdCBhdHRyaWJ1dGVzID0gZ2VvbWV0cnkuYXR0cmlidXRlczsKCQljb25zdCBwb3NpdGlvbkF0dHJpYnV0ZSA9IGF0dHJpYnV0ZXMucG9zaXRpb247CgoJCWlmICggaW5kZXggIT09IG51bGwgKSB7CgoJCQljb25zdCBzdGFydCA9IE1hdGgubWF4KCAwLCBkcmF3UmFuZ2Uuc3RhcnQgKTsKCQkJY29uc3QgZW5kID0gTWF0aC5taW4oIGluZGV4LmNvdW50LCAoIGRyYXdSYW5nZS5zdGFydCArIGRyYXdSYW5nZS5jb3VudCApICk7CgoJCQlmb3IgKCBsZXQgaSA9IHN0YXJ0LCBpbCA9IGVuZDsgaSA8IGlsOyBpICsrICkgewoKCQkJCWNvbnN0IGEgPSBpbmRleC5nZXRYKCBpICk7CgoJCQkJX3Bvc2l0aW9uJDIuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb25BdHRyaWJ1dGUsIGEgKTsKCgkJCQl0ZXN0UG9pbnQoIF9wb3NpdGlvbiQyLCBhLCBsb2NhbFRocmVzaG9sZFNxLCBtYXRyaXhXb3JsZCwgcmF5Y2FzdGVyLCBpbnRlcnNlY3RzLCB0aGlzICk7CgoJCQl9CgoJCX0gZWxzZSB7CgoJCQljb25zdCBzdGFydCA9IE1hdGgubWF4KCAwLCBkcmF3UmFuZ2Uuc3RhcnQgKTsKCQkJY29uc3QgZW5kID0gTWF0aC5taW4oIHBvc2l0aW9uQXR0cmlidXRlLmNvdW50LCAoIGRyYXdSYW5nZS5zdGFydCArIGRyYXdSYW5nZS5jb3VudCApICk7CgoJCQlmb3IgKCBsZXQgaSA9IHN0YXJ0LCBsID0gZW5kOyBpIDwgbDsgaSArKyApIHsKCgkJCQlfcG9zaXRpb24kMi5mcm9tQnVmZmVyQXR0cmlidXRlKCBwb3NpdGlvbkF0dHJpYnV0ZSwgaSApOwoKCQkJCXRlc3RQb2ludCggX3Bvc2l0aW9uJDIsIGksIGxvY2FsVGhyZXNob2xkU3EsIG1hdHJpeFdvcmxkLCByYXljYXN0ZXIsIGludGVyc2VjdHMsIHRoaXMgKTsKCgkJCX0KCgkJfQoKCX0KCgl1cGRhdGVNb3JwaFRhcmdldHMoKSB7CgoJCWNvbnN0IGdlb21ldHJ5ID0gdGhpcy5nZW9tZXRyeTsKCgkJY29uc3QgbW9ycGhBdHRyaWJ1dGVzID0gZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzOwoJCWNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyggbW9ycGhBdHRyaWJ1dGVzICk7CgoJCWlmICgga2V5cy5sZW5ndGggPiAwICkgewoKCQkJY29uc3QgbW9ycGhBdHRyaWJ1dGUgPSBtb3JwaEF0dHJpYnV0ZXNbIGtleXNbIDAgXSBdOwoKCQkJaWYgKCBtb3JwaEF0dHJpYnV0ZSAhPT0gdW5kZWZpbmVkICkgewoKCQkJCXRoaXMubW9ycGhUYXJnZXRJbmZsdWVuY2VzID0gW107CgkJCQl0aGlzLm1vcnBoVGFyZ2V0RGljdGlvbmFyeSA9IHt9OwoKCQkJCWZvciAoIGxldCBtID0gMCwgbWwgPSBtb3JwaEF0dHJpYnV0ZS5sZW5ndGg7IG0gPCBtbDsgbSArKyApIHsKCgkJCQkJY29uc3QgbmFtZSA9IG1vcnBoQXR0cmlidXRlWyBtIF0ubmFtZSB8fCBTdHJpbmcoIG0gKTsKCgkJCQkJdGhpcy5tb3JwaFRhcmdldEluZmx1ZW5jZXMucHVzaCggMCApOwoJCQkJCXRoaXMubW9ycGhUYXJnZXREaWN0aW9uYXJ5WyBuYW1lIF0gPSBtOwoKCQkJCX0KCgkJCX0KCgkJfQoKCX0KCn0KCmZ1bmN0aW9uIHRlc3RQb2ludCggcG9pbnQsIGluZGV4LCBsb2NhbFRocmVzaG9sZFNxLCBtYXRyaXhXb3JsZCwgcmF5Y2FzdGVyLCBpbnRlcnNlY3RzLCBvYmplY3QgKSB7CgoJY29uc3QgcmF5UG9pbnREaXN0YW5jZVNxID0gX3JheS5kaXN0YW5jZVNxVG9Qb2ludCggcG9pbnQgKTsKCglpZiAoIHJheVBvaW50RGlzdGFuY2VTcSA8IGxvY2FsVGhyZXNob2xkU3EgKSB7CgoJCWNvbnN0IGludGVyc2VjdFBvaW50ID0gbmV3IFZlY3RvcjMoKTsKCgkJX3JheS5jbG9zZXN0UG9pbnRUb1BvaW50KCBwb2ludCwgaW50ZXJzZWN0UG9pbnQgKTsKCQlpbnRlcnNlY3RQb2ludC5hcHBseU1hdHJpeDQoIG1hdHJpeFdvcmxkICk7CgoJCWNvbnN0IGRpc3RhbmNlID0gcmF5Y2FzdGVyLnJheS5vcmlnaW4uZGlzdGFuY2VUbyggaW50ZXJzZWN0UG9pbnQgKTsKCgkJaWYgKCBkaXN0YW5jZSA8IHJheWNhc3Rlci5uZWFyIHx8IGRpc3RhbmNlID4gcmF5Y2FzdGVyLmZhciApIHJldHVybjsKCgkJaW50ZXJzZWN0cy5wdXNoKCB7CgoJCQlkaXN0YW5jZTogZGlzdGFuY2UsCgkJCWRpc3RhbmNlVG9SYXk6IE1hdGguc3FydCggcmF5UG9pbnREaXN0YW5jZVNxICksCgkJCXBvaW50OiBpbnRlcnNlY3RQb2ludCwKCQkJaW5kZXg6IGluZGV4LAoJCQlmYWNlOiBudWxsLAoJCQlvYmplY3Q6IG9iamVjdAoKCQl9ICk7CgoJfQoKfQoKY2xhc3MgVmlkZW9UZXh0dXJlIGV4dGVuZHMgVGV4dHVyZSB7CgoJY29uc3RydWN0b3IoIHZpZGVvLCBtYXBwaW5nLCB3cmFwUywgd3JhcFQsIG1hZ0ZpbHRlciwgbWluRmlsdGVyLCBmb3JtYXQsIHR5cGUsIGFuaXNvdHJvcHkgKSB7CgoJCXN1cGVyKCB2aWRlbywgbWFwcGluZywgd3JhcFMsIHdyYXBULCBtYWdGaWx0ZXIsIG1pbkZpbHRlciwgZm9ybWF0LCB0eXBlLCBhbmlzb3Ryb3B5ICk7CgoJCXRoaXMuaXNWaWRlb1RleHR1cmUgPSB0cnVlOwoKCQl0aGlzLm1pbkZpbHRlciA9IG1pbkZpbHRlciAhPT0gdW5kZWZpbmVkID8gbWluRmlsdGVyIDogTGluZWFyRmlsdGVyOwoJCXRoaXMubWFnRmlsdGVyID0gbWFnRmlsdGVyICE9PSB1bmRlZmluZWQgPyBtYWdGaWx0ZXIgOiBMaW5lYXJGaWx0ZXI7CgoJCXRoaXMuZ2VuZXJhdGVNaXBtYXBzID0gZmFsc2U7CgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJZnVuY3Rpb24gdXBkYXRlVmlkZW8oKSB7CgoJCQlzY29wZS5uZWVkc1VwZGF0ZSA9IHRydWU7CgkJCXZpZGVvLnJlcXVlc3RWaWRlb0ZyYW1lQ2FsbGJhY2soIHVwZGF0ZVZpZGVvICk7CgoJCX0KCgkJaWYgKCAncmVxdWVzdFZpZGVvRnJhbWVDYWxsYmFjaycgaW4gdmlkZW8gKSB7CgoJCQl2aWRlby5yZXF1ZXN0VmlkZW9GcmFtZUNhbGxiYWNrKCB1cGRhdGVWaWRlbyApOwoKCQl9CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoIHRoaXMuaW1hZ2UgKS5jb3B5KCB0aGlzICk7CgoJfQoKCXVwZGF0ZSgpIHsKCgkJY29uc3QgdmlkZW8gPSB0aGlzLmltYWdlOwoJCWNvbnN0IGhhc1ZpZGVvRnJhbWVDYWxsYmFjayA9ICdyZXF1ZXN0VmlkZW9GcmFtZUNhbGxiYWNrJyBpbiB2aWRlbzsKCgkJaWYgKCBoYXNWaWRlb0ZyYW1lQ2FsbGJhY2sgPT09IGZhbHNlICYmIHZpZGVvLnJlYWR5U3RhdGUgPj0gdmlkZW8uSEFWRV9DVVJSRU5UX0RBVEEgKSB7CgoJCQl0aGlzLm5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJfQoKCX0KCn0KCmNsYXNzIEZyYW1lYnVmZmVyVGV4dHVyZSBleHRlbmRzIFRleHR1cmUgewoKCWNvbnN0cnVjdG9yKCB3aWR0aCwgaGVpZ2h0ICkgewoKCQlzdXBlciggeyB3aWR0aCwgaGVpZ2h0IH0gKTsKCgkJdGhpcy5pc0ZyYW1lYnVmZmVyVGV4dHVyZSA9IHRydWU7CgoJCXRoaXMubWFnRmlsdGVyID0gTmVhcmVzdEZpbHRlcjsKCQl0aGlzLm1pbkZpbHRlciA9IE5lYXJlc3RGaWx0ZXI7CgoJCXRoaXMuZ2VuZXJhdGVNaXBtYXBzID0gZmFsc2U7CgoJCXRoaXMubmVlZHNVcGRhdGUgPSB0cnVlOwoKCX0KCn0KCmNsYXNzIENvbXByZXNzZWRUZXh0dXJlIGV4dGVuZHMgVGV4dHVyZSB7CgoJY29uc3RydWN0b3IoIG1pcG1hcHMsIHdpZHRoLCBoZWlnaHQsIGZvcm1hdCwgdHlwZSwgbWFwcGluZywgd3JhcFMsIHdyYXBULCBtYWdGaWx0ZXIsIG1pbkZpbHRlciwgYW5pc290cm9weSwgY29sb3JTcGFjZSApIHsKCgkJc3VwZXIoIG51bGwsIG1hcHBpbmcsIHdyYXBTLCB3cmFwVCwgbWFnRmlsdGVyLCBtaW5GaWx0ZXIsIGZvcm1hdCwgdHlwZSwgYW5pc290cm9weSwgY29sb3JTcGFjZSApOwoKCQl0aGlzLmlzQ29tcHJlc3NlZFRleHR1cmUgPSB0cnVlOwoKCQl0aGlzLmltYWdlID0geyB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0IH07CgkJdGhpcy5taXBtYXBzID0gbWlwbWFwczsKCgkJLy8gbm8gZmxpcHBpbmcgZm9yIGN1YmUgdGV4dHVyZXMKCQkvLyAoYWxzbyBmbGlwcGluZyBkb2Vzbid0IHdvcmsgZm9yIGNvbXByZXNzZWQgdGV4dHVyZXMgKQoKCQl0aGlzLmZsaXBZID0gZmFsc2U7CgoJCS8vIGNhbid0IGdlbmVyYXRlIG1pcG1hcHMgZm9yIGNvbXByZXNzZWQgdGV4dHVyZXMKCQkvLyBtaXBzIG11c3QgYmUgZW1iZWRkZWQgaW4gRERTIGZpbGVzCgoJCXRoaXMuZ2VuZXJhdGVNaXBtYXBzID0gZmFsc2U7CgoJfQoKfQoKY2xhc3MgQ29tcHJlc3NlZEFycmF5VGV4dHVyZSBleHRlbmRzIENvbXByZXNzZWRUZXh0dXJlIHsKCgljb25zdHJ1Y3RvciggbWlwbWFwcywgd2lkdGgsIGhlaWdodCwgZGVwdGgsIGZvcm1hdCwgdHlwZSApIHsKCgkJc3VwZXIoIG1pcG1hcHMsIHdpZHRoLCBoZWlnaHQsIGZvcm1hdCwgdHlwZSApOwoKCQl0aGlzLmlzQ29tcHJlc3NlZEFycmF5VGV4dHVyZSA9IHRydWU7CgkJdGhpcy5pbWFnZS5kZXB0aCA9IGRlcHRoOwoJCXRoaXMud3JhcFIgPSBDbGFtcFRvRWRnZVdyYXBwaW5nOwoKCX0KCn0KCmNsYXNzIENvbXByZXNzZWRDdWJlVGV4dHVyZSBleHRlbmRzIENvbXByZXNzZWRUZXh0dXJlIHsKCgljb25zdHJ1Y3RvciggaW1hZ2VzLCBmb3JtYXQsIHR5cGUgKSB7CgoJCXN1cGVyKCB1bmRlZmluZWQsIGltYWdlc1sgMCBdLndpZHRoLCBpbWFnZXNbIDAgXS5oZWlnaHQsIGZvcm1hdCwgdHlwZSwgQ3ViZVJlZmxlY3Rpb25NYXBwaW5nICk7CgoJCXRoaXMuaXNDb21wcmVzc2VkQ3ViZVRleHR1cmUgPSB0cnVlOwoJCXRoaXMuaXNDdWJlVGV4dHVyZSA9IHRydWU7CgoJCXRoaXMuaW1hZ2UgPSBpbWFnZXM7CgoJfQoKfQoKY2xhc3MgQ2FudmFzVGV4dHVyZSBleHRlbmRzIFRleHR1cmUgewoKCWNvbnN0cnVjdG9yKCBjYW52YXMsIG1hcHBpbmcsIHdyYXBTLCB3cmFwVCwgbWFnRmlsdGVyLCBtaW5GaWx0ZXIsIGZvcm1hdCwgdHlwZSwgYW5pc290cm9weSApIHsKCgkJc3VwZXIoIGNhbnZhcywgbWFwcGluZywgd3JhcFMsIHdyYXBULCBtYWdGaWx0ZXIsIG1pbkZpbHRlciwgZm9ybWF0LCB0eXBlLCBhbmlzb3Ryb3B5ICk7CgoJCXRoaXMuaXNDYW52YXNUZXh0dXJlID0gdHJ1ZTsKCgkJdGhpcy5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJfQoKfQoKLyoqCiAqIEV4dGVuc2libGUgY3VydmUgb2JqZWN0LgogKgogKiBTb21lIGNvbW1vbiBvZiBjdXJ2ZSBtZXRob2RzOgogKiAuZ2V0UG9pbnQoIHQsIG9wdGlvbmFsVGFyZ2V0ICksIC5nZXRUYW5nZW50KCB0LCBvcHRpb25hbFRhcmdldCApCiAqIC5nZXRQb2ludEF0KCB1LCBvcHRpb25hbFRhcmdldCApLCAuZ2V0VGFuZ2VudEF0KCB1LCBvcHRpb25hbFRhcmdldCApCiAqIC5nZXRQb2ludHMoKSwgLmdldFNwYWNlZFBvaW50cygpCiAqIC5nZXRMZW5ndGgoKQogKiAudXBkYXRlQXJjTGVuZ3RocygpCiAqCiAqIFRoaXMgZm9sbG93aW5nIGN1cnZlcyBpbmhlcml0IGZyb20gVEhSRUUuQ3VydmU6CiAqCiAqIC0tIDJEIGN1cnZlcyAtLQogKiBUSFJFRS5BcmNDdXJ2ZQogKiBUSFJFRS5DdWJpY0JlemllckN1cnZlCiAqIFRIUkVFLkVsbGlwc2VDdXJ2ZQogKiBUSFJFRS5MaW5lQ3VydmUKICogVEhSRUUuUXVhZHJhdGljQmV6aWVyQ3VydmUKICogVEhSRUUuU3BsaW5lQ3VydmUKICoKICogLS0gM0QgY3VydmVzIC0tCiAqIFRIUkVFLkNhdG11bGxSb21DdXJ2ZTMKICogVEhSRUUuQ3ViaWNCZXppZXJDdXJ2ZTMKICogVEhSRUUuTGluZUN1cnZlMwogKiBUSFJFRS5RdWFkcmF0aWNCZXppZXJDdXJ2ZTMKICoKICogQSBzZXJpZXMgb2YgY3VydmVzIGNhbiBiZSByZXByZXNlbnRlZCBhcyBhIFRIUkVFLkN1cnZlUGF0aC4KICoKICoqLwoKY2xhc3MgQ3VydmUgewoKCWNvbnN0cnVjdG9yKCkgewoKCQl0aGlzLnR5cGUgPSAnQ3VydmUnOwoKCQl0aGlzLmFyY0xlbmd0aERpdmlzaW9ucyA9IDIwMDsKCgl9CgoJLy8gVmlydHVhbCBiYXNlIGNsYXNzIG1ldGhvZCB0byBvdmVyd3JpdGUgYW5kIGltcGxlbWVudCBpbiBzdWJjbGFzc2VzCgkvLwktIHQgWzAgLi4gMV0KCglnZXRQb2ludCggLyogdCwgb3B0aW9uYWxUYXJnZXQgKi8gKSB7CgoJCWNvbnNvbGUud2FybiggJ1RIUkVFLkN1cnZlOiAuZ2V0UG9pbnQoKSBub3QgaW1wbGVtZW50ZWQuJyApOwoJCXJldHVybiBudWxsOwoKCX0KCgkvLyBHZXQgcG9pbnQgYXQgcmVsYXRpdmUgcG9zaXRpb24gaW4gY3VydmUgYWNjb3JkaW5nIHRvIGFyYyBsZW5ndGgKCS8vIC0gdSBbMCAuLiAxXQoKCWdldFBvaW50QXQoIHUsIG9wdGlvbmFsVGFyZ2V0ICkgewoKCQljb25zdCB0ID0gdGhpcy5nZXRVdG9UbWFwcGluZyggdSApOwoJCXJldHVybiB0aGlzLmdldFBvaW50KCB0LCBvcHRpb25hbFRhcmdldCApOwoKCX0KCgkvLyBHZXQgc2VxdWVuY2Ugb2YgcG9pbnRzIHVzaW5nIGdldFBvaW50KCB0ICkKCglnZXRQb2ludHMoIGRpdmlzaW9ucyA9IDUgKSB7CgoJCWNvbnN0IHBvaW50cyA9IFtdOwoKCQlmb3IgKCBsZXQgZCA9IDA7IGQgPD0gZGl2aXNpb25zOyBkICsrICkgewoKCQkJcG9pbnRzLnB1c2goIHRoaXMuZ2V0UG9pbnQoIGQgLyBkaXZpc2lvbnMgKSApOwoKCQl9CgoJCXJldHVybiBwb2ludHM7CgoJfQoKCS8vIEdldCBzZXF1ZW5jZSBvZiBwb2ludHMgdXNpbmcgZ2V0UG9pbnRBdCggdSApCgoJZ2V0U3BhY2VkUG9pbnRzKCBkaXZpc2lvbnMgPSA1ICkgewoKCQljb25zdCBwb2ludHMgPSBbXTsKCgkJZm9yICggbGV0IGQgPSAwOyBkIDw9IGRpdmlzaW9uczsgZCArKyApIHsKCgkJCXBvaW50cy5wdXNoKCB0aGlzLmdldFBvaW50QXQoIGQgLyBkaXZpc2lvbnMgKSApOwoKCQl9CgoJCXJldHVybiBwb2ludHM7CgoJfQoKCS8vIEdldCB0b3RhbCBjdXJ2ZSBhcmMgbGVuZ3RoCgoJZ2V0TGVuZ3RoKCkgewoKCQljb25zdCBsZW5ndGhzID0gdGhpcy5nZXRMZW5ndGhzKCk7CgkJcmV0dXJuIGxlbmd0aHNbIGxlbmd0aHMubGVuZ3RoIC0gMSBdOwoKCX0KCgkvLyBHZXQgbGlzdCBvZiBjdW11bGF0aXZlIHNlZ21lbnQgbGVuZ3RocwoKCWdldExlbmd0aHMoIGRpdmlzaW9ucyA9IHRoaXMuYXJjTGVuZ3RoRGl2aXNpb25zICkgewoKCQlpZiAoIHRoaXMuY2FjaGVBcmNMZW5ndGhzICYmCgkJCSggdGhpcy5jYWNoZUFyY0xlbmd0aHMubGVuZ3RoID09PSBkaXZpc2lvbnMgKyAxICkgJiYKCQkJISB0aGlzLm5lZWRzVXBkYXRlICkgewoKCQkJcmV0dXJuIHRoaXMuY2FjaGVBcmNMZW5ndGhzOwoKCQl9CgoJCXRoaXMubmVlZHNVcGRhdGUgPSBmYWxzZTsKCgkJY29uc3QgY2FjaGUgPSBbXTsKCQlsZXQgY3VycmVudCwgbGFzdCA9IHRoaXMuZ2V0UG9pbnQoIDAgKTsKCQlsZXQgc3VtID0gMDsKCgkJY2FjaGUucHVzaCggMCApOwoKCQlmb3IgKCBsZXQgcCA9IDE7IHAgPD0gZGl2aXNpb25zOyBwICsrICkgewoKCQkJY3VycmVudCA9IHRoaXMuZ2V0UG9pbnQoIHAgLyBkaXZpc2lvbnMgKTsKCQkJc3VtICs9IGN1cnJlbnQuZGlzdGFuY2VUbyggbGFzdCApOwoJCQljYWNoZS5wdXNoKCBzdW0gKTsKCQkJbGFzdCA9IGN1cnJlbnQ7CgoJCX0KCgkJdGhpcy5jYWNoZUFyY0xlbmd0aHMgPSBjYWNoZTsKCgkJcmV0dXJuIGNhY2hlOyAvLyB7IHN1bXM6IGNhY2hlLCBzdW06IHN1bSB9OyBTdW0gaXMgaW4gdGhlIGxhc3QgZWxlbWVudC4KCgl9CgoJdXBkYXRlQXJjTGVuZ3RocygpIHsKCgkJdGhpcy5uZWVkc1VwZGF0ZSA9IHRydWU7CgkJdGhpcy5nZXRMZW5ndGhzKCk7CgoJfQoKCS8vIEdpdmVuIHUgKCAwIC4uIDEgKSwgZ2V0IGEgdCB0byBmaW5kIHAuIFRoaXMgZ2l2ZXMgeW91IHBvaW50cyB3aGljaCBhcmUgZXF1aWRpc3RhbnQKCglnZXRVdG9UbWFwcGluZyggdSwgZGlzdGFuY2UgKSB7CgoJCWNvbnN0IGFyY0xlbmd0aHMgPSB0aGlzLmdldExlbmd0aHMoKTsKCgkJbGV0IGkgPSAwOwoJCWNvbnN0IGlsID0gYXJjTGVuZ3Rocy5sZW5ndGg7CgoJCWxldCB0YXJnZXRBcmNMZW5ndGg7IC8vIFRoZSB0YXJnZXRlZCB1IGRpc3RhbmNlIHZhbHVlIHRvIGdldAoKCQlpZiAoIGRpc3RhbmNlICkgewoKCQkJdGFyZ2V0QXJjTGVuZ3RoID0gZGlzdGFuY2U7CgoJCX0gZWxzZSB7CgoJCQl0YXJnZXRBcmNMZW5ndGggPSB1ICogYXJjTGVuZ3Roc1sgaWwgLSAxIF07CgoJCX0KCgkJLy8gYmluYXJ5IHNlYXJjaCBmb3IgdGhlIGluZGV4IHdpdGggbGFyZ2VzdCB2YWx1ZSBzbWFsbGVyIHRoYW4gdGFyZ2V0IHUgZGlzdGFuY2UKCgkJbGV0IGxvdyA9IDAsIGhpZ2ggPSBpbCAtIDEsIGNvbXBhcmlzb247CgoJCXdoaWxlICggbG93IDw9IGhpZ2ggKSB7CgoJCQlpID0gTWF0aC5mbG9vciggbG93ICsgKCBoaWdoIC0gbG93ICkgLyAyICk7IC8vIGxlc3MgbGlrZWx5IHRvIG92ZXJmbG93LCB0aG91Z2ggcHJvYmFibHkgbm90IGlzc3VlIGhlcmUsIEpTIGRvZXNuJ3QgcmVhbGx5IGhhdmUgaW50ZWdlcnMsIGFsbCBudW1iZXJzIGFyZSBmbG9hdHMKCgkJCWNvbXBhcmlzb24gPSBhcmNMZW5ndGhzWyBpIF0gLSB0YXJnZXRBcmNMZW5ndGg7CgoJCQlpZiAoIGNvbXBhcmlzb24gPCAwICkgewoKCQkJCWxvdyA9IGkgKyAxOwoKCQkJfSBlbHNlIGlmICggY29tcGFyaXNvbiA+IDAgKSB7CgoJCQkJaGlnaCA9IGkgLSAxOwoKCQkJfSBlbHNlIHsKCgkJCQloaWdoID0gaTsKCQkJCWJyZWFrOwoKCQkJCS8vIERPTkUKCgkJCX0KCgkJfQoKCQlpID0gaGlnaDsKCgkJaWYgKCBhcmNMZW5ndGhzWyBpIF0gPT09IHRhcmdldEFyY0xlbmd0aCApIHsKCgkJCXJldHVybiBpIC8gKCBpbCAtIDEgKTsKCgkJfQoKCQkvLyB3ZSBjb3VsZCBnZXQgZmluZXIgZ3JhaW4gYXQgbGVuZ3Rocywgb3IgdXNlIHNpbXBsZSBpbnRlcnBvbGF0aW9uIGJldHdlZW4gdHdvIHBvaW50cwoKCQljb25zdCBsZW5ndGhCZWZvcmUgPSBhcmNMZW5ndGhzWyBpIF07CgkJY29uc3QgbGVuZ3RoQWZ0ZXIgPSBhcmNMZW5ndGhzWyBpICsgMSBdOwoKCQljb25zdCBzZWdtZW50TGVuZ3RoID0gbGVuZ3RoQWZ0ZXIgLSBsZW5ndGhCZWZvcmU7CgoJCS8vIGRldGVybWluZSB3aGVyZSB3ZSBhcmUgYmV0d2VlbiB0aGUgJ2JlZm9yZScgYW5kICdhZnRlcicgcG9pbnRzCgoJCWNvbnN0IHNlZ21lbnRGcmFjdGlvbiA9ICggdGFyZ2V0QXJjTGVuZ3RoIC0gbGVuZ3RoQmVmb3JlICkgLyBzZWdtZW50TGVuZ3RoOwoKCQkvLyBhZGQgdGhhdCBmcmFjdGlvbmFsIGFtb3VudCB0byB0CgoJCWNvbnN0IHQgPSAoIGkgKyBzZWdtZW50RnJhY3Rpb24gKSAvICggaWwgLSAxICk7CgoJCXJldHVybiB0OwoKCX0KCgkvLyBSZXR1cm5zIGEgdW5pdCB2ZWN0b3IgdGFuZ2VudCBhdCB0CgkvLyBJbiBjYXNlIGFueSBzdWIgY3VydmUgZG9lcyBub3QgaW1wbGVtZW50IGl0cyB0YW5nZW50IGRlcml2YXRpb24sCgkvLyAyIHBvaW50cyBhIHNtYWxsIGRlbHRhIGFwYXJ0IHdpbGwgYmUgdXNlZCB0byBmaW5kIGl0cyBncmFkaWVudAoJLy8gd2hpY2ggc2VlbXMgdG8gZ2l2ZSBhIHJlYXNvbmFibGUgYXBwcm94aW1hdGlvbgoKCWdldFRhbmdlbnQoIHQsIG9wdGlvbmFsVGFyZ2V0ICkgewoKCQljb25zdCBkZWx0YSA9IDAuMDAwMTsKCQlsZXQgdDEgPSB0IC0gZGVsdGE7CgkJbGV0IHQyID0gdCArIGRlbHRhOwoKCQkvLyBDYXBwaW5nIGluIGNhc2Ugb2YgZGFuZ2VyCgoJCWlmICggdDEgPCAwICkgdDEgPSAwOwoJCWlmICggdDIgPiAxICkgdDIgPSAxOwoKCQljb25zdCBwdDEgPSB0aGlzLmdldFBvaW50KCB0MSApOwoJCWNvbnN0IHB0MiA9IHRoaXMuZ2V0UG9pbnQoIHQyICk7CgoJCWNvbnN0IHRhbmdlbnQgPSBvcHRpb25hbFRhcmdldCB8fCAoICggcHQxLmlzVmVjdG9yMiApID8gbmV3IFZlY3RvcjIoKSA6IG5ldyBWZWN0b3IzKCkgKTsKCgkJdGFuZ2VudC5jb3B5KCBwdDIgKS5zdWIoIHB0MSApLm5vcm1hbGl6ZSgpOwoKCQlyZXR1cm4gdGFuZ2VudDsKCgl9CgoJZ2V0VGFuZ2VudEF0KCB1LCBvcHRpb25hbFRhcmdldCApIHsKCgkJY29uc3QgdCA9IHRoaXMuZ2V0VXRvVG1hcHBpbmcoIHUgKTsKCQlyZXR1cm4gdGhpcy5nZXRUYW5nZW50KCB0LCBvcHRpb25hbFRhcmdldCApOwoKCX0KCgljb21wdXRlRnJlbmV0RnJhbWVzKCBzZWdtZW50cywgY2xvc2VkICkgewoKCQkvLyBzZWUgaHR0cDovL3d3dy5jcy5pbmRpYW5hLmVkdS9wdWIvdGVjaHJlcG9ydHMvVFI0MjUucGRmCgoJCWNvbnN0IG5vcm1hbCA9IG5ldyBWZWN0b3IzKCk7CgoJCWNvbnN0IHRhbmdlbnRzID0gW107CgkJY29uc3Qgbm9ybWFscyA9IFtdOwoJCWNvbnN0IGJpbm9ybWFscyA9IFtdOwoKCQljb25zdCB2ZWMgPSBuZXcgVmVjdG9yMygpOwoJCWNvbnN0IG1hdCA9IG5ldyBNYXRyaXg0KCk7CgoJCS8vIGNvbXB1dGUgdGhlIHRhbmdlbnQgdmVjdG9ycyBmb3IgZWFjaCBzZWdtZW50IG9uIHRoZSBjdXJ2ZQoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPD0gc2VnbWVudHM7IGkgKysgKSB7CgoJCQljb25zdCB1ID0gaSAvIHNlZ21lbnRzOwoKCQkJdGFuZ2VudHNbIGkgXSA9IHRoaXMuZ2V0VGFuZ2VudEF0KCB1LCBuZXcgVmVjdG9yMygpICk7CgoJCX0KCgkJLy8gc2VsZWN0IGFuIGluaXRpYWwgbm9ybWFsIHZlY3RvciBwZXJwZW5kaWN1bGFyIHRvIHRoZSBmaXJzdCB0YW5nZW50IHZlY3RvciwKCQkvLyBhbmQgaW4gdGhlIGRpcmVjdGlvbiBvZiB0aGUgbWluaW11bSB0YW5nZW50IHh5eiBjb21wb25lbnQKCgkJbm9ybWFsc1sgMCBdID0gbmV3IFZlY3RvcjMoKTsKCQliaW5vcm1hbHNbIDAgXSA9IG5ldyBWZWN0b3IzKCk7CgkJbGV0IG1pbiA9IE51bWJlci5NQVhfVkFMVUU7CgkJY29uc3QgdHggPSBNYXRoLmFicyggdGFuZ2VudHNbIDAgXS54ICk7CgkJY29uc3QgdHkgPSBNYXRoLmFicyggdGFuZ2VudHNbIDAgXS55ICk7CgkJY29uc3QgdHogPSBNYXRoLmFicyggdGFuZ2VudHNbIDAgXS56ICk7CgoJCWlmICggdHggPD0gbWluICkgewoKCQkJbWluID0gdHg7CgkJCW5vcm1hbC5zZXQoIDEsIDAsIDAgKTsKCgkJfQoKCQlpZiAoIHR5IDw9IG1pbiApIHsKCgkJCW1pbiA9IHR5OwoJCQlub3JtYWwuc2V0KCAwLCAxLCAwICk7CgoJCX0KCgkJaWYgKCB0eiA8PSBtaW4gKSB7CgoJCQlub3JtYWwuc2V0KCAwLCAwLCAxICk7CgoJCX0KCgkJdmVjLmNyb3NzVmVjdG9ycyggdGFuZ2VudHNbIDAgXSwgbm9ybWFsICkubm9ybWFsaXplKCk7CgoJCW5vcm1hbHNbIDAgXS5jcm9zc1ZlY3RvcnMoIHRhbmdlbnRzWyAwIF0sIHZlYyApOwoJCWJpbm9ybWFsc1sgMCBdLmNyb3NzVmVjdG9ycyggdGFuZ2VudHNbIDAgXSwgbm9ybWFsc1sgMCBdICk7CgoKCQkvLyBjb21wdXRlIHRoZSBzbG93bHktdmFyeWluZyBub3JtYWwgYW5kIGJpbm9ybWFsIHZlY3RvcnMgZm9yIGVhY2ggc2VnbWVudCBvbiB0aGUgY3VydmUKCgkJZm9yICggbGV0IGkgPSAxOyBpIDw9IHNlZ21lbnRzOyBpICsrICkgewoKCQkJbm9ybWFsc1sgaSBdID0gbm9ybWFsc1sgaSAtIDEgXS5jbG9uZSgpOwoKCQkJYmlub3JtYWxzWyBpIF0gPSBiaW5vcm1hbHNbIGkgLSAxIF0uY2xvbmUoKTsKCgkJCXZlYy5jcm9zc1ZlY3RvcnMoIHRhbmdlbnRzWyBpIC0gMSBdLCB0YW5nZW50c1sgaSBdICk7CgoJCQlpZiAoIHZlYy5sZW5ndGgoKSA+IE51bWJlci5FUFNJTE9OICkgewoKCQkJCXZlYy5ub3JtYWxpemUoKTsKCgkJCQljb25zdCB0aGV0YSA9IE1hdGguYWNvcyggY2xhbXAoIHRhbmdlbnRzWyBpIC0gMSBdLmRvdCggdGFuZ2VudHNbIGkgXSApLCAtIDEsIDEgKSApOyAvLyBjbGFtcCBmb3IgZmxvYXRpbmcgcHQgZXJyb3JzCgoJCQkJbm9ybWFsc1sgaSBdLmFwcGx5TWF0cml4NCggbWF0Lm1ha2VSb3RhdGlvbkF4aXMoIHZlYywgdGhldGEgKSApOwoKCQkJfQoKCQkJYmlub3JtYWxzWyBpIF0uY3Jvc3NWZWN0b3JzKCB0YW5nZW50c1sgaSBdLCBub3JtYWxzWyBpIF0gKTsKCgkJfQoKCQkvLyBpZiB0aGUgY3VydmUgaXMgY2xvc2VkLCBwb3N0cHJvY2VzcyB0aGUgdmVjdG9ycyBzbyB0aGUgZmlyc3QgYW5kIGxhc3Qgbm9ybWFsIHZlY3RvcnMgYXJlIHRoZSBzYW1lCgoJCWlmICggY2xvc2VkID09PSB0cnVlICkgewoKCQkJbGV0IHRoZXRhID0gTWF0aC5hY29zKCBjbGFtcCggbm9ybWFsc1sgMCBdLmRvdCggbm9ybWFsc1sgc2VnbWVudHMgXSApLCAtIDEsIDEgKSApOwoJCQl0aGV0YSAvPSBzZWdtZW50czsKCgkJCWlmICggdGFuZ2VudHNbIDAgXS5kb3QoIHZlYy5jcm9zc1ZlY3RvcnMoIG5vcm1hbHNbIDAgXSwgbm9ybWFsc1sgc2VnbWVudHMgXSApICkgPiAwICkgewoKCQkJCXRoZXRhID0gLSB0aGV0YTsKCgkJCX0KCgkJCWZvciAoIGxldCBpID0gMTsgaSA8PSBzZWdtZW50czsgaSArKyApIHsKCgkJCQkvLyB0d2lzdCBhIGxpdHRsZS4uLgoJCQkJbm9ybWFsc1sgaSBdLmFwcGx5TWF0cml4NCggbWF0Lm1ha2VSb3RhdGlvbkF4aXMoIHRhbmdlbnRzWyBpIF0sIHRoZXRhICogaSApICk7CgkJCQliaW5vcm1hbHNbIGkgXS5jcm9zc1ZlY3RvcnMoIHRhbmdlbnRzWyBpIF0sIG5vcm1hbHNbIGkgXSApOwoKCQkJfQoKCQl9CgoJCXJldHVybiB7CgkJCXRhbmdlbnRzOiB0YW5nZW50cywKCQkJbm9ybWFsczogbm9ybWFscywKCQkJYmlub3JtYWxzOiBiaW5vcm1hbHMKCQl9OwoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSggdGhpcyApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXRoaXMuYXJjTGVuZ3RoRGl2aXNpb25zID0gc291cmNlLmFyY0xlbmd0aERpdmlzaW9uczsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTigpIHsKCgkJY29uc3QgZGF0YSA9IHsKCQkJbWV0YWRhdGE6IHsKCQkJCXZlcnNpb246IDQuNiwKCQkJCXR5cGU6ICdDdXJ2ZScsCgkJCQlnZW5lcmF0b3I6ICdDdXJ2ZS50b0pTT04nCgkJCX0KCQl9OwoKCQlkYXRhLmFyY0xlbmd0aERpdmlzaW9ucyA9IHRoaXMuYXJjTGVuZ3RoRGl2aXNpb25zOwoJCWRhdGEudHlwZSA9IHRoaXMudHlwZTsKCgkJcmV0dXJuIGRhdGE7CgoJfQoKCWZyb21KU09OKCBqc29uICkgewoKCQl0aGlzLmFyY0xlbmd0aERpdmlzaW9ucyA9IGpzb24uYXJjTGVuZ3RoRGl2aXNpb25zOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBFbGxpcHNlQ3VydmUgZXh0ZW5kcyBDdXJ2ZSB7CgoJY29uc3RydWN0b3IoIGFYID0gMCwgYVkgPSAwLCB4UmFkaXVzID0gMSwgeVJhZGl1cyA9IDEsIGFTdGFydEFuZ2xlID0gMCwgYUVuZEFuZ2xlID0gTWF0aC5QSSAqIDIsIGFDbG9ja3dpc2UgPSBmYWxzZSwgYVJvdGF0aW9uID0gMCApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc0VsbGlwc2VDdXJ2ZSA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdFbGxpcHNlQ3VydmUnOwoKCQl0aGlzLmFYID0gYVg7CgkJdGhpcy5hWSA9IGFZOwoKCQl0aGlzLnhSYWRpdXMgPSB4UmFkaXVzOwoJCXRoaXMueVJhZGl1cyA9IHlSYWRpdXM7CgoJCXRoaXMuYVN0YXJ0QW5nbGUgPSBhU3RhcnRBbmdsZTsKCQl0aGlzLmFFbmRBbmdsZSA9IGFFbmRBbmdsZTsKCgkJdGhpcy5hQ2xvY2t3aXNlID0gYUNsb2Nrd2lzZTsKCgkJdGhpcy5hUm90YXRpb24gPSBhUm90YXRpb247CgoJfQoKCWdldFBvaW50KCB0LCBvcHRpb25hbFRhcmdldCApIHsKCgkJY29uc3QgcG9pbnQgPSBvcHRpb25hbFRhcmdldCB8fCBuZXcgVmVjdG9yMigpOwoKCQljb25zdCB0d29QaSA9IE1hdGguUEkgKiAyOwoJCWxldCBkZWx0YUFuZ2xlID0gdGhpcy5hRW5kQW5nbGUgLSB0aGlzLmFTdGFydEFuZ2xlOwoJCWNvbnN0IHNhbWVQb2ludHMgPSBNYXRoLmFicyggZGVsdGFBbmdsZSApIDwgTnVtYmVyLkVQU0lMT047CgoJCS8vIGVuc3VyZXMgdGhhdCBkZWx0YUFuZ2xlIGlzIDAgLi4gMiBQSQoJCXdoaWxlICggZGVsdGFBbmdsZSA8IDAgKSBkZWx0YUFuZ2xlICs9IHR3b1BpOwoJCXdoaWxlICggZGVsdGFBbmdsZSA+IHR3b1BpICkgZGVsdGFBbmdsZSAtPSB0d29QaTsKCgkJaWYgKCBkZWx0YUFuZ2xlIDwgTnVtYmVyLkVQU0lMT04gKSB7CgoJCQlpZiAoIHNhbWVQb2ludHMgKSB7CgoJCQkJZGVsdGFBbmdsZSA9IDA7CgoJCQl9IGVsc2UgewoKCQkJCWRlbHRhQW5nbGUgPSB0d29QaTsKCgkJCX0KCgkJfQoKCQlpZiAoIHRoaXMuYUNsb2Nrd2lzZSA9PT0gdHJ1ZSAmJiAhIHNhbWVQb2ludHMgKSB7CgoJCQlpZiAoIGRlbHRhQW5nbGUgPT09IHR3b1BpICkgewoKCQkJCWRlbHRhQW5nbGUgPSAtIHR3b1BpOwoKCQkJfSBlbHNlIHsKCgkJCQlkZWx0YUFuZ2xlID0gZGVsdGFBbmdsZSAtIHR3b1BpOwoKCQkJfQoKCQl9CgoJCWNvbnN0IGFuZ2xlID0gdGhpcy5hU3RhcnRBbmdsZSArIHQgKiBkZWx0YUFuZ2xlOwoJCWxldCB4ID0gdGhpcy5hWCArIHRoaXMueFJhZGl1cyAqIE1hdGguY29zKCBhbmdsZSApOwoJCWxldCB5ID0gdGhpcy5hWSArIHRoaXMueVJhZGl1cyAqIE1hdGguc2luKCBhbmdsZSApOwoKCQlpZiAoIHRoaXMuYVJvdGF0aW9uICE9PSAwICkgewoKCQkJY29uc3QgY29zID0gTWF0aC5jb3MoIHRoaXMuYVJvdGF0aW9uICk7CgkJCWNvbnN0IHNpbiA9IE1hdGguc2luKCB0aGlzLmFSb3RhdGlvbiApOwoKCQkJY29uc3QgdHggPSB4IC0gdGhpcy5hWDsKCQkJY29uc3QgdHkgPSB5IC0gdGhpcy5hWTsKCgkJCS8vIFJvdGF0ZSB0aGUgcG9pbnQgYWJvdXQgdGhlIGNlbnRlciBvZiB0aGUgZWxsaXBzZS4KCQkJeCA9IHR4ICogY29zIC0gdHkgKiBzaW4gKyB0aGlzLmFYOwoJCQl5ID0gdHggKiBzaW4gKyB0eSAqIGNvcyArIHRoaXMuYVk7CgoJCX0KCgkJcmV0dXJuIHBvaW50LnNldCggeCwgeSApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLmFYID0gc291cmNlLmFYOwoJCXRoaXMuYVkgPSBzb3VyY2UuYVk7CgoJCXRoaXMueFJhZGl1cyA9IHNvdXJjZS54UmFkaXVzOwoJCXRoaXMueVJhZGl1cyA9IHNvdXJjZS55UmFkaXVzOwoKCQl0aGlzLmFTdGFydEFuZ2xlID0gc291cmNlLmFTdGFydEFuZ2xlOwoJCXRoaXMuYUVuZEFuZ2xlID0gc291cmNlLmFFbmRBbmdsZTsKCgkJdGhpcy5hQ2xvY2t3aXNlID0gc291cmNlLmFDbG9ja3dpc2U7CgoJCXRoaXMuYVJvdGF0aW9uID0gc291cmNlLmFSb3RhdGlvbjsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTigpIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTigpOwoKCQlkYXRhLmFYID0gdGhpcy5hWDsKCQlkYXRhLmFZID0gdGhpcy5hWTsKCgkJZGF0YS54UmFkaXVzID0gdGhpcy54UmFkaXVzOwoJCWRhdGEueVJhZGl1cyA9IHRoaXMueVJhZGl1czsKCgkJZGF0YS5hU3RhcnRBbmdsZSA9IHRoaXMuYVN0YXJ0QW5nbGU7CgkJZGF0YS5hRW5kQW5nbGUgPSB0aGlzLmFFbmRBbmdsZTsKCgkJZGF0YS5hQ2xvY2t3aXNlID0gdGhpcy5hQ2xvY2t3aXNlOwoKCQlkYXRhLmFSb3RhdGlvbiA9IHRoaXMuYVJvdGF0aW9uOwoKCQlyZXR1cm4gZGF0YTsKCgl9CgoJZnJvbUpTT04oIGpzb24gKSB7CgoJCXN1cGVyLmZyb21KU09OKCBqc29uICk7CgoJCXRoaXMuYVggPSBqc29uLmFYOwoJCXRoaXMuYVkgPSBqc29uLmFZOwoKCQl0aGlzLnhSYWRpdXMgPSBqc29uLnhSYWRpdXM7CgkJdGhpcy55UmFkaXVzID0ganNvbi55UmFkaXVzOwoKCQl0aGlzLmFTdGFydEFuZ2xlID0ganNvbi5hU3RhcnRBbmdsZTsKCQl0aGlzLmFFbmRBbmdsZSA9IGpzb24uYUVuZEFuZ2xlOwoKCQl0aGlzLmFDbG9ja3dpc2UgPSBqc29uLmFDbG9ja3dpc2U7CgoJCXRoaXMuYVJvdGF0aW9uID0ganNvbi5hUm90YXRpb247CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIEFyY0N1cnZlIGV4dGVuZHMgRWxsaXBzZUN1cnZlIHsKCgljb25zdHJ1Y3RvciggYVgsIGFZLCBhUmFkaXVzLCBhU3RhcnRBbmdsZSwgYUVuZEFuZ2xlLCBhQ2xvY2t3aXNlICkgewoKCQlzdXBlciggYVgsIGFZLCBhUmFkaXVzLCBhUmFkaXVzLCBhU3RhcnRBbmdsZSwgYUVuZEFuZ2xlLCBhQ2xvY2t3aXNlICk7CgoJCXRoaXMuaXNBcmNDdXJ2ZSA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdBcmNDdXJ2ZSc7CgoJfQoKfQoKLyoqCiAqIENlbnRyaXBldGFsIENhdG11bGxSb20gQ3VydmUgLSB3aGljaCBpcyB1c2VmdWwgZm9yIGF2b2lkaW5nCiAqIGN1c3BzIGFuZCBzZWxmLWludGVyc2VjdGlvbnMgaW4gbm9uLXVuaWZvcm0gY2F0bXVsbCByb20gY3VydmVzLgogKiBodHRwOi8vd3d3LmNlbXl1a3NlbC5jb20vcmVzZWFyY2gvY2F0bXVsbHJvbV9wYXJhbS9jYXRtdWxscm9tLnBkZgogKgogKiBjdXJ2ZS50eXBlIGFjY2VwdHMgY2VudHJpcGV0YWwoZGVmYXVsdCksIGNob3JkYWwgYW5kIGNhdG11bGxyb20KICogY3VydmUudGVuc2lvbiBpcyB1c2VkIGZvciBjYXRtdWxscm9tIHdoaWNoIGRlZmF1bHRzIHRvIDAuNQogKi8KCgovKgpCYXNlZCBvbiBhbiBvcHRpbWl6ZWQgYysrIHNvbHV0aW9uIGluCiAtIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvOTQ4OTczNi9jYXRtdWxsLXJvbS1jdXJ2ZS13aXRoLW5vLWN1c3BzLWFuZC1uby1zZWxmLWludGVyc2VjdGlvbnMvCiAtIGh0dHA6Ly9pZGVvbmUuY29tL05vRWJWTQoKVGhpcyBDdWJpY1BvbHkgY2xhc3MgY291bGQgYmUgdXNlZCBmb3IgcmV1c2luZyBzb21lIHZhcmlhYmxlcyBhbmQgY2FsY3VsYXRpb25zLApidXQgZm9yIHRocmVlLmpzIGN1cnZlIHVzZSwgaXQgY291bGQgYmUgcG9zc2libGUgaW5saW5lZCBhbmQgZmxhdHRlbiBpbnRvIGEgc2luZ2xlIGZ1bmN0aW9uIGNhbGwKd2hpY2ggY2FuIGJlIHBsYWNlZCBpbiBDdXJ2ZVV0aWxzLgoqLwoKZnVuY3Rpb24gQ3ViaWNQb2x5KCkgewoKCWxldCBjMCA9IDAsIGMxID0gMCwgYzIgPSAwLCBjMyA9IDA7CgoJLyoKCSAqIENvbXB1dGUgY29lZmZpY2llbnRzIGZvciBhIGN1YmljIHBvbHlub21pYWwKCSAqICAgcChzKSA9IGMwICsgYzEqcyArIGMyKnNeMiArIGMzKnNeMwoJICogc3VjaCB0aGF0CgkgKiAgIHAoMCkgPSB4MCwgcCgxKSA9IHgxCgkgKiAgYW5kCgkgKiAgIHAnKDApID0gdDAsIHAnKDEpID0gdDEuCgkgKi8KCWZ1bmN0aW9uIGluaXQoIHgwLCB4MSwgdDAsIHQxICkgewoKCQljMCA9IHgwOwoJCWMxID0gdDA7CgkJYzIgPSAtIDMgKiB4MCArIDMgKiB4MSAtIDIgKiB0MCAtIHQxOwoJCWMzID0gMiAqIHgwIC0gMiAqIHgxICsgdDAgKyB0MTsKCgl9CgoJcmV0dXJuIHsKCgkJaW5pdENhdG11bGxSb206IGZ1bmN0aW9uICggeDAsIHgxLCB4MiwgeDMsIHRlbnNpb24gKSB7CgoJCQlpbml0KCB4MSwgeDIsIHRlbnNpb24gKiAoIHgyIC0geDAgKSwgdGVuc2lvbiAqICggeDMgLSB4MSApICk7CgoJCX0sCgoJCWluaXROb251bmlmb3JtQ2F0bXVsbFJvbTogZnVuY3Rpb24gKCB4MCwgeDEsIHgyLCB4MywgZHQwLCBkdDEsIGR0MiApIHsKCgkJCS8vIGNvbXB1dGUgdGFuZ2VudHMgd2hlbiBwYXJhbWV0ZXJpemVkIGluIFt0MSx0Ml0KCQkJbGV0IHQxID0gKCB4MSAtIHgwICkgLyBkdDAgLSAoIHgyIC0geDAgKSAvICggZHQwICsgZHQxICkgKyAoIHgyIC0geDEgKSAvIGR0MTsKCQkJbGV0IHQyID0gKCB4MiAtIHgxICkgLyBkdDEgLSAoIHgzIC0geDEgKSAvICggZHQxICsgZHQyICkgKyAoIHgzIC0geDIgKSAvIGR0MjsKCgkJCS8vIHJlc2NhbGUgdGFuZ2VudHMgZm9yIHBhcmFtZXRyaXphdGlvbiBpbiBbMCwxXQoJCQl0MSAqPSBkdDE7CgkJCXQyICo9IGR0MTsKCgkJCWluaXQoIHgxLCB4MiwgdDEsIHQyICk7CgoJCX0sCgoJCWNhbGM6IGZ1bmN0aW9uICggdCApIHsKCgkJCWNvbnN0IHQyID0gdCAqIHQ7CgkJCWNvbnN0IHQzID0gdDIgKiB0OwoJCQlyZXR1cm4gYzAgKyBjMSAqIHQgKyBjMiAqIHQyICsgYzMgKiB0MzsKCgkJfQoKCX07Cgp9CgovLwoKY29uc3QgdG1wID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBweCA9IC8qQF9fUFVSRV9fKi8gbmV3IEN1YmljUG9seSgpOwpjb25zdCBweSA9IC8qQF9fUFVSRV9fKi8gbmV3IEN1YmljUG9seSgpOwpjb25zdCBweiA9IC8qQF9fUFVSRV9fKi8gbmV3IEN1YmljUG9seSgpOwoKY2xhc3MgQ2F0bXVsbFJvbUN1cnZlMyBleHRlbmRzIEN1cnZlIHsKCgljb25zdHJ1Y3RvciggcG9pbnRzID0gW10sIGNsb3NlZCA9IGZhbHNlLCBjdXJ2ZVR5cGUgPSAnY2VudHJpcGV0YWwnLCB0ZW5zaW9uID0gMC41ICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzQ2F0bXVsbFJvbUN1cnZlMyA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdDYXRtdWxsUm9tQ3VydmUzJzsKCgkJdGhpcy5wb2ludHMgPSBwb2ludHM7CgkJdGhpcy5jbG9zZWQgPSBjbG9zZWQ7CgkJdGhpcy5jdXJ2ZVR5cGUgPSBjdXJ2ZVR5cGU7CgkJdGhpcy50ZW5zaW9uID0gdGVuc2lvbjsKCgl9CgoJZ2V0UG9pbnQoIHQsIG9wdGlvbmFsVGFyZ2V0ID0gbmV3IFZlY3RvcjMoKSApIHsKCgkJY29uc3QgcG9pbnQgPSBvcHRpb25hbFRhcmdldDsKCgkJY29uc3QgcG9pbnRzID0gdGhpcy5wb2ludHM7CgkJY29uc3QgbCA9IHBvaW50cy5sZW5ndGg7CgoJCWNvbnN0IHAgPSAoIGwgLSAoIHRoaXMuY2xvc2VkID8gMCA6IDEgKSApICogdDsKCQlsZXQgaW50UG9pbnQgPSBNYXRoLmZsb29yKCBwICk7CgkJbGV0IHdlaWdodCA9IHAgLSBpbnRQb2ludDsKCgkJaWYgKCB0aGlzLmNsb3NlZCApIHsKCgkJCWludFBvaW50ICs9IGludFBvaW50ID4gMCA/IDAgOiAoIE1hdGguZmxvb3IoIE1hdGguYWJzKCBpbnRQb2ludCApIC8gbCApICsgMSApICogbDsKCgkJfSBlbHNlIGlmICggd2VpZ2h0ID09PSAwICYmIGludFBvaW50ID09PSBsIC0gMSApIHsKCgkJCWludFBvaW50ID0gbCAtIDI7CgkJCXdlaWdodCA9IDE7CgoJCX0KCgkJbGV0IHAwLCBwMzsgLy8gNCBwb2ludHMgKHAxICYgcDIgZGVmaW5lZCBiZWxvdykKCgkJaWYgKCB0aGlzLmNsb3NlZCB8fCBpbnRQb2ludCA+IDAgKSB7CgoJCQlwMCA9IHBvaW50c1sgKCBpbnRQb2ludCAtIDEgKSAlIGwgXTsKCgkJfSBlbHNlIHsKCgkJCS8vIGV4dHJhcG9sYXRlIGZpcnN0IHBvaW50CgkJCXRtcC5zdWJWZWN0b3JzKCBwb2ludHNbIDAgXSwgcG9pbnRzWyAxIF0gKS5hZGQoIHBvaW50c1sgMCBdICk7CgkJCXAwID0gdG1wOwoKCQl9CgoJCWNvbnN0IHAxID0gcG9pbnRzWyBpbnRQb2ludCAlIGwgXTsKCQljb25zdCBwMiA9IHBvaW50c1sgKCBpbnRQb2ludCArIDEgKSAlIGwgXTsKCgkJaWYgKCB0aGlzLmNsb3NlZCB8fCBpbnRQb2ludCArIDIgPCBsICkgewoKCQkJcDMgPSBwb2ludHNbICggaW50UG9pbnQgKyAyICkgJSBsIF07CgoJCX0gZWxzZSB7CgoJCQkvLyBleHRyYXBvbGF0ZSBsYXN0IHBvaW50CgkJCXRtcC5zdWJWZWN0b3JzKCBwb2ludHNbIGwgLSAxIF0sIHBvaW50c1sgbCAtIDIgXSApLmFkZCggcG9pbnRzWyBsIC0gMSBdICk7CgkJCXAzID0gdG1wOwoKCQl9CgoJCWlmICggdGhpcy5jdXJ2ZVR5cGUgPT09ICdjZW50cmlwZXRhbCcgfHwgdGhpcy5jdXJ2ZVR5cGUgPT09ICdjaG9yZGFsJyApIHsKCgkJCS8vIGluaXQgQ2VudHJpcGV0YWwgLyBDaG9yZGFsIENhdG11bGwtUm9tCgkJCWNvbnN0IHBvdyA9IHRoaXMuY3VydmVUeXBlID09PSAnY2hvcmRhbCcgPyAwLjUgOiAwLjI1OwoJCQlsZXQgZHQwID0gTWF0aC5wb3coIHAwLmRpc3RhbmNlVG9TcXVhcmVkKCBwMSApLCBwb3cgKTsKCQkJbGV0IGR0MSA9IE1hdGgucG93KCBwMS5kaXN0YW5jZVRvU3F1YXJlZCggcDIgKSwgcG93ICk7CgkJCWxldCBkdDIgPSBNYXRoLnBvdyggcDIuZGlzdGFuY2VUb1NxdWFyZWQoIHAzICksIHBvdyApOwoKCQkJLy8gc2FmZXR5IGNoZWNrIGZvciByZXBlYXRlZCBwb2ludHMKCQkJaWYgKCBkdDEgPCAxZS00ICkgZHQxID0gMS4wOwoJCQlpZiAoIGR0MCA8IDFlLTQgKSBkdDAgPSBkdDE7CgkJCWlmICggZHQyIDwgMWUtNCApIGR0MiA9IGR0MTsKCgkJCXB4LmluaXROb251bmlmb3JtQ2F0bXVsbFJvbSggcDAueCwgcDEueCwgcDIueCwgcDMueCwgZHQwLCBkdDEsIGR0MiApOwoJCQlweS5pbml0Tm9udW5pZm9ybUNhdG11bGxSb20oIHAwLnksIHAxLnksIHAyLnksIHAzLnksIGR0MCwgZHQxLCBkdDIgKTsKCQkJcHouaW5pdE5vbnVuaWZvcm1DYXRtdWxsUm9tKCBwMC56LCBwMS56LCBwMi56LCBwMy56LCBkdDAsIGR0MSwgZHQyICk7CgoJCX0gZWxzZSBpZiAoIHRoaXMuY3VydmVUeXBlID09PSAnY2F0bXVsbHJvbScgKSB7CgoJCQlweC5pbml0Q2F0bXVsbFJvbSggcDAueCwgcDEueCwgcDIueCwgcDMueCwgdGhpcy50ZW5zaW9uICk7CgkJCXB5LmluaXRDYXRtdWxsUm9tKCBwMC55LCBwMS55LCBwMi55LCBwMy55LCB0aGlzLnRlbnNpb24gKTsKCQkJcHouaW5pdENhdG11bGxSb20oIHAwLnosIHAxLnosIHAyLnosIHAzLnosIHRoaXMudGVuc2lvbiApOwoKCQl9CgoJCXBvaW50LnNldCgKCQkJcHguY2FsYyggd2VpZ2h0ICksCgkJCXB5LmNhbGMoIHdlaWdodCApLAoJCQlwei5jYWxjKCB3ZWlnaHQgKQoJCSk7CgoJCXJldHVybiBwb2ludDsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5wb2ludHMgPSBbXTsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gc291cmNlLnBvaW50cy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgcG9pbnQgPSBzb3VyY2UucG9pbnRzWyBpIF07CgoJCQl0aGlzLnBvaW50cy5wdXNoKCBwb2ludC5jbG9uZSgpICk7CgoJCX0KCgkJdGhpcy5jbG9zZWQgPSBzb3VyY2UuY2xvc2VkOwoJCXRoaXMuY3VydmVUeXBlID0gc291cmNlLmN1cnZlVHlwZTsKCQl0aGlzLnRlbnNpb24gPSBzb3VyY2UudGVuc2lvbjsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTigpIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTigpOwoKCQlkYXRhLnBvaW50cyA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSB0aGlzLnBvaW50cy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgcG9pbnQgPSB0aGlzLnBvaW50c1sgaSBdOwoJCQlkYXRhLnBvaW50cy5wdXNoKCBwb2ludC50b0FycmF5KCkgKTsKCgkJfQoKCQlkYXRhLmNsb3NlZCA9IHRoaXMuY2xvc2VkOwoJCWRhdGEuY3VydmVUeXBlID0gdGhpcy5jdXJ2ZVR5cGU7CgkJZGF0YS50ZW5zaW9uID0gdGhpcy50ZW5zaW9uOwoKCQlyZXR1cm4gZGF0YTsKCgl9CgoJZnJvbUpTT04oIGpzb24gKSB7CgoJCXN1cGVyLmZyb21KU09OKCBqc29uICk7CgoJCXRoaXMucG9pbnRzID0gW107CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IGpzb24ucG9pbnRzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljb25zdCBwb2ludCA9IGpzb24ucG9pbnRzWyBpIF07CgkJCXRoaXMucG9pbnRzLnB1c2goIG5ldyBWZWN0b3IzKCkuZnJvbUFycmF5KCBwb2ludCApICk7CgoJCX0KCgkJdGhpcy5jbG9zZWQgPSBqc29uLmNsb3NlZDsKCQl0aGlzLmN1cnZlVHlwZSA9IGpzb24uY3VydmVUeXBlOwoJCXRoaXMudGVuc2lvbiA9IGpzb24udGVuc2lvbjsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKLyoqCiAqIEJlemllciBDdXJ2ZXMgZm9ybXVsYXMgb2J0YWluZWQgZnJvbQogKiBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9CJUMzJUE5emllcl9jdXJ2ZQogKi8KCmZ1bmN0aW9uIENhdG11bGxSb20oIHQsIHAwLCBwMSwgcDIsIHAzICkgewoKCWNvbnN0IHYwID0gKCBwMiAtIHAwICkgKiAwLjU7Cgljb25zdCB2MSA9ICggcDMgLSBwMSApICogMC41OwoJY29uc3QgdDIgPSB0ICogdDsKCWNvbnN0IHQzID0gdCAqIHQyOwoJcmV0dXJuICggMiAqIHAxIC0gMiAqIHAyICsgdjAgKyB2MSApICogdDMgKyAoIC0gMyAqIHAxICsgMyAqIHAyIC0gMiAqIHYwIC0gdjEgKSAqIHQyICsgdjAgKiB0ICsgcDE7Cgp9CgovLwoKZnVuY3Rpb24gUXVhZHJhdGljQmV6aWVyUDAoIHQsIHAgKSB7CgoJY29uc3QgayA9IDEgLSB0OwoJcmV0dXJuIGsgKiBrICogcDsKCn0KCmZ1bmN0aW9uIFF1YWRyYXRpY0JlemllclAxKCB0LCBwICkgewoKCXJldHVybiAyICogKCAxIC0gdCApICogdCAqIHA7Cgp9CgpmdW5jdGlvbiBRdWFkcmF0aWNCZXppZXJQMiggdCwgcCApIHsKCglyZXR1cm4gdCAqIHQgKiBwOwoKfQoKZnVuY3Rpb24gUXVhZHJhdGljQmV6aWVyKCB0LCBwMCwgcDEsIHAyICkgewoKCXJldHVybiBRdWFkcmF0aWNCZXppZXJQMCggdCwgcDAgKSArIFF1YWRyYXRpY0JlemllclAxKCB0LCBwMSApICsKCQlRdWFkcmF0aWNCZXppZXJQMiggdCwgcDIgKTsKCn0KCi8vCgpmdW5jdGlvbiBDdWJpY0JlemllclAwKCB0LCBwICkgewoKCWNvbnN0IGsgPSAxIC0gdDsKCXJldHVybiBrICogayAqIGsgKiBwOwoKfQoKZnVuY3Rpb24gQ3ViaWNCZXppZXJQMSggdCwgcCApIHsKCgljb25zdCBrID0gMSAtIHQ7CglyZXR1cm4gMyAqIGsgKiBrICogdCAqIHA7Cgp9CgpmdW5jdGlvbiBDdWJpY0JlemllclAyKCB0LCBwICkgewoKCXJldHVybiAzICogKCAxIC0gdCApICogdCAqIHQgKiBwOwoKfQoKZnVuY3Rpb24gQ3ViaWNCZXppZXJQMyggdCwgcCApIHsKCglyZXR1cm4gdCAqIHQgKiB0ICogcDsKCn0KCmZ1bmN0aW9uIEN1YmljQmV6aWVyKCB0LCBwMCwgcDEsIHAyLCBwMyApIHsKCglyZXR1cm4gQ3ViaWNCZXppZXJQMCggdCwgcDAgKSArIEN1YmljQmV6aWVyUDEoIHQsIHAxICkgKyBDdWJpY0JlemllclAyKCB0LCBwMiApICsKCQlDdWJpY0JlemllclAzKCB0LCBwMyApOwoKfQoKY2xhc3MgQ3ViaWNCZXppZXJDdXJ2ZSBleHRlbmRzIEN1cnZlIHsKCgljb25zdHJ1Y3RvciggdjAgPSBuZXcgVmVjdG9yMigpLCB2MSA9IG5ldyBWZWN0b3IyKCksIHYyID0gbmV3IFZlY3RvcjIoKSwgdjMgPSBuZXcgVmVjdG9yMigpICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzQ3ViaWNCZXppZXJDdXJ2ZSA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdDdWJpY0JlemllckN1cnZlJzsKCgkJdGhpcy52MCA9IHYwOwoJCXRoaXMudjEgPSB2MTsKCQl0aGlzLnYyID0gdjI7CgkJdGhpcy52MyA9IHYzOwoKCX0KCglnZXRQb2ludCggdCwgb3B0aW9uYWxUYXJnZXQgPSBuZXcgVmVjdG9yMigpICkgewoKCQljb25zdCBwb2ludCA9IG9wdGlvbmFsVGFyZ2V0OwoKCQljb25zdCB2MCA9IHRoaXMudjAsIHYxID0gdGhpcy52MSwgdjIgPSB0aGlzLnYyLCB2MyA9IHRoaXMudjM7CgoJCXBvaW50LnNldCgKCQkJQ3ViaWNCZXppZXIoIHQsIHYwLngsIHYxLngsIHYyLngsIHYzLnggKSwKCQkJQ3ViaWNCZXppZXIoIHQsIHYwLnksIHYxLnksIHYyLnksIHYzLnkgKQoJCSk7CgoJCXJldHVybiBwb2ludDsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy52MC5jb3B5KCBzb3VyY2UudjAgKTsKCQl0aGlzLnYxLmNvcHkoIHNvdXJjZS52MSApOwoJCXRoaXMudjIuY29weSggc291cmNlLnYyICk7CgkJdGhpcy52My5jb3B5KCBzb3VyY2UudjMgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTigpIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTigpOwoKCQlkYXRhLnYwID0gdGhpcy52MC50b0FycmF5KCk7CgkJZGF0YS52MSA9IHRoaXMudjEudG9BcnJheSgpOwoJCWRhdGEudjIgPSB0aGlzLnYyLnRvQXJyYXkoKTsKCQlkYXRhLnYzID0gdGhpcy52My50b0FycmF5KCk7CgoJCXJldHVybiBkYXRhOwoKCX0KCglmcm9tSlNPTigganNvbiApIHsKCgkJc3VwZXIuZnJvbUpTT04oIGpzb24gKTsKCgkJdGhpcy52MC5mcm9tQXJyYXkoIGpzb24udjAgKTsKCQl0aGlzLnYxLmZyb21BcnJheSgganNvbi52MSApOwoJCXRoaXMudjIuZnJvbUFycmF5KCBqc29uLnYyICk7CgkJdGhpcy52My5mcm9tQXJyYXkoIGpzb24udjMgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKY2xhc3MgQ3ViaWNCZXppZXJDdXJ2ZTMgZXh0ZW5kcyBDdXJ2ZSB7CgoJY29uc3RydWN0b3IoIHYwID0gbmV3IFZlY3RvcjMoKSwgdjEgPSBuZXcgVmVjdG9yMygpLCB2MiA9IG5ldyBWZWN0b3IzKCksIHYzID0gbmV3IFZlY3RvcjMoKSApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc0N1YmljQmV6aWVyQ3VydmUzID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ0N1YmljQmV6aWVyQ3VydmUzJzsKCgkJdGhpcy52MCA9IHYwOwoJCXRoaXMudjEgPSB2MTsKCQl0aGlzLnYyID0gdjI7CgkJdGhpcy52MyA9IHYzOwoKCX0KCglnZXRQb2ludCggdCwgb3B0aW9uYWxUYXJnZXQgPSBuZXcgVmVjdG9yMygpICkgewoKCQljb25zdCBwb2ludCA9IG9wdGlvbmFsVGFyZ2V0OwoKCQljb25zdCB2MCA9IHRoaXMudjAsIHYxID0gdGhpcy52MSwgdjIgPSB0aGlzLnYyLCB2MyA9IHRoaXMudjM7CgoJCXBvaW50LnNldCgKCQkJQ3ViaWNCZXppZXIoIHQsIHYwLngsIHYxLngsIHYyLngsIHYzLnggKSwKCQkJQ3ViaWNCZXppZXIoIHQsIHYwLnksIHYxLnksIHYyLnksIHYzLnkgKSwKCQkJQ3ViaWNCZXppZXIoIHQsIHYwLnosIHYxLnosIHYyLnosIHYzLnogKQoJCSk7CgoJCXJldHVybiBwb2ludDsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy52MC5jb3B5KCBzb3VyY2UudjAgKTsKCQl0aGlzLnYxLmNvcHkoIHNvdXJjZS52MSApOwoJCXRoaXMudjIuY29weSggc291cmNlLnYyICk7CgkJdGhpcy52My5jb3B5KCBzb3VyY2UudjMgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTigpIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTigpOwoKCQlkYXRhLnYwID0gdGhpcy52MC50b0FycmF5KCk7CgkJZGF0YS52MSA9IHRoaXMudjEudG9BcnJheSgpOwoJCWRhdGEudjIgPSB0aGlzLnYyLnRvQXJyYXkoKTsKCQlkYXRhLnYzID0gdGhpcy52My50b0FycmF5KCk7CgoJCXJldHVybiBkYXRhOwoKCX0KCglmcm9tSlNPTigganNvbiApIHsKCgkJc3VwZXIuZnJvbUpTT04oIGpzb24gKTsKCgkJdGhpcy52MC5mcm9tQXJyYXkoIGpzb24udjAgKTsKCQl0aGlzLnYxLmZyb21BcnJheSgganNvbi52MSApOwoJCXRoaXMudjIuZnJvbUFycmF5KCBqc29uLnYyICk7CgkJdGhpcy52My5mcm9tQXJyYXkoIGpzb24udjMgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKY2xhc3MgTGluZUN1cnZlIGV4dGVuZHMgQ3VydmUgewoKCWNvbnN0cnVjdG9yKCB2MSA9IG5ldyBWZWN0b3IyKCksIHYyID0gbmV3IFZlY3RvcjIoKSApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc0xpbmVDdXJ2ZSA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdMaW5lQ3VydmUnOwoKCQl0aGlzLnYxID0gdjE7CgkJdGhpcy52MiA9IHYyOwoKCX0KCglnZXRQb2ludCggdCwgb3B0aW9uYWxUYXJnZXQgPSBuZXcgVmVjdG9yMigpICkgewoKCQljb25zdCBwb2ludCA9IG9wdGlvbmFsVGFyZ2V0OwoKCQlpZiAoIHQgPT09IDEgKSB7CgoJCQlwb2ludC5jb3B5KCB0aGlzLnYyICk7CgoJCX0gZWxzZSB7CgoJCQlwb2ludC5jb3B5KCB0aGlzLnYyICkuc3ViKCB0aGlzLnYxICk7CgkJCXBvaW50Lm11bHRpcGx5U2NhbGFyKCB0ICkuYWRkKCB0aGlzLnYxICk7CgoJCX0KCgkJcmV0dXJuIHBvaW50OwoKCX0KCgkvLyBMaW5lIGN1cnZlIGlzIGxpbmVhciwgc28gd2UgY2FuIG92ZXJ3cml0ZSBkZWZhdWx0IGdldFBvaW50QXQKCWdldFBvaW50QXQoIHUsIG9wdGlvbmFsVGFyZ2V0ICkgewoKCQlyZXR1cm4gdGhpcy5nZXRQb2ludCggdSwgb3B0aW9uYWxUYXJnZXQgKTsKCgl9CgoJZ2V0VGFuZ2VudCggdCwgb3B0aW9uYWxUYXJnZXQgPSBuZXcgVmVjdG9yMigpICkgewoKCQlyZXR1cm4gb3B0aW9uYWxUYXJnZXQuc3ViVmVjdG9ycyggdGhpcy52MiwgdGhpcy52MSApLm5vcm1hbGl6ZSgpOwoKCX0KCglnZXRUYW5nZW50QXQoIHUsIG9wdGlvbmFsVGFyZ2V0ICkgewoKCQlyZXR1cm4gdGhpcy5nZXRUYW5nZW50KCB1LCBvcHRpb25hbFRhcmdldCApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLnYxLmNvcHkoIHNvdXJjZS52MSApOwoJCXRoaXMudjIuY29weSggc291cmNlLnYyICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0pTT04oKSB7CgoJCWNvbnN0IGRhdGEgPSBzdXBlci50b0pTT04oKTsKCgkJZGF0YS52MSA9IHRoaXMudjEudG9BcnJheSgpOwoJCWRhdGEudjIgPSB0aGlzLnYyLnRvQXJyYXkoKTsKCgkJcmV0dXJuIGRhdGE7CgoJfQoKCWZyb21KU09OKCBqc29uICkgewoKCQlzdXBlci5mcm9tSlNPTigganNvbiApOwoKCQl0aGlzLnYxLmZyb21BcnJheSgganNvbi52MSApOwoJCXRoaXMudjIuZnJvbUFycmF5KCBqc29uLnYyICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIExpbmVDdXJ2ZTMgZXh0ZW5kcyBDdXJ2ZSB7CgoJY29uc3RydWN0b3IoIHYxID0gbmV3IFZlY3RvcjMoKSwgdjIgPSBuZXcgVmVjdG9yMygpICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzTGluZUN1cnZlMyA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdMaW5lQ3VydmUzJzsKCgkJdGhpcy52MSA9IHYxOwoJCXRoaXMudjIgPSB2MjsKCgl9CgoJZ2V0UG9pbnQoIHQsIG9wdGlvbmFsVGFyZ2V0ID0gbmV3IFZlY3RvcjMoKSApIHsKCgkJY29uc3QgcG9pbnQgPSBvcHRpb25hbFRhcmdldDsKCgkJaWYgKCB0ID09PSAxICkgewoKCQkJcG9pbnQuY29weSggdGhpcy52MiApOwoKCQl9IGVsc2UgewoKCQkJcG9pbnQuY29weSggdGhpcy52MiApLnN1YiggdGhpcy52MSApOwoJCQlwb2ludC5tdWx0aXBseVNjYWxhciggdCApLmFkZCggdGhpcy52MSApOwoKCQl9CgoJCXJldHVybiBwb2ludDsKCgl9CgoJLy8gTGluZSBjdXJ2ZSBpcyBsaW5lYXIsIHNvIHdlIGNhbiBvdmVyd3JpdGUgZGVmYXVsdCBnZXRQb2ludEF0CglnZXRQb2ludEF0KCB1LCBvcHRpb25hbFRhcmdldCApIHsKCgkJcmV0dXJuIHRoaXMuZ2V0UG9pbnQoIHUsIG9wdGlvbmFsVGFyZ2V0ICk7CgoJfQoKCWdldFRhbmdlbnQoIHQsIG9wdGlvbmFsVGFyZ2V0ID0gbmV3IFZlY3RvcjMoKSApIHsKCgkJcmV0dXJuIG9wdGlvbmFsVGFyZ2V0LnN1YlZlY3RvcnMoIHRoaXMudjIsIHRoaXMudjEgKS5ub3JtYWxpemUoKTsKCgl9CgoJZ2V0VGFuZ2VudEF0KCB1LCBvcHRpb25hbFRhcmdldCApIHsKCgkJcmV0dXJuIHRoaXMuZ2V0VGFuZ2VudCggdSwgb3B0aW9uYWxUYXJnZXQgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy52MS5jb3B5KCBzb3VyY2UudjEgKTsKCQl0aGlzLnYyLmNvcHkoIHNvdXJjZS52MiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCkgewoKCQljb25zdCBkYXRhID0gc3VwZXIudG9KU09OKCk7CgoJCWRhdGEudjEgPSB0aGlzLnYxLnRvQXJyYXkoKTsKCQlkYXRhLnYyID0gdGhpcy52Mi50b0FycmF5KCk7CgoJCXJldHVybiBkYXRhOwoKCX0KCglmcm9tSlNPTigganNvbiApIHsKCgkJc3VwZXIuZnJvbUpTT04oIGpzb24gKTsKCgkJdGhpcy52MS5mcm9tQXJyYXkoIGpzb24udjEgKTsKCQl0aGlzLnYyLmZyb21BcnJheSgganNvbi52MiApOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBRdWFkcmF0aWNCZXppZXJDdXJ2ZSBleHRlbmRzIEN1cnZlIHsKCgljb25zdHJ1Y3RvciggdjAgPSBuZXcgVmVjdG9yMigpLCB2MSA9IG5ldyBWZWN0b3IyKCksIHYyID0gbmV3IFZlY3RvcjIoKSApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc1F1YWRyYXRpY0JlemllckN1cnZlID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ1F1YWRyYXRpY0JlemllckN1cnZlJzsKCgkJdGhpcy52MCA9IHYwOwoJCXRoaXMudjEgPSB2MTsKCQl0aGlzLnYyID0gdjI7CgoJfQoKCWdldFBvaW50KCB0LCBvcHRpb25hbFRhcmdldCA9IG5ldyBWZWN0b3IyKCkgKSB7CgoJCWNvbnN0IHBvaW50ID0gb3B0aW9uYWxUYXJnZXQ7CgoJCWNvbnN0IHYwID0gdGhpcy52MCwgdjEgPSB0aGlzLnYxLCB2MiA9IHRoaXMudjI7CgoJCXBvaW50LnNldCgKCQkJUXVhZHJhdGljQmV6aWVyKCB0LCB2MC54LCB2MS54LCB2Mi54ICksCgkJCVF1YWRyYXRpY0JlemllciggdCwgdjAueSwgdjEueSwgdjIueSApCgkJKTsKCgkJcmV0dXJuIHBvaW50OwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLnYwLmNvcHkoIHNvdXJjZS52MCApOwoJCXRoaXMudjEuY29weSggc291cmNlLnYxICk7CgkJdGhpcy52Mi5jb3B5KCBzb3VyY2UudjIgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTigpIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTigpOwoKCQlkYXRhLnYwID0gdGhpcy52MC50b0FycmF5KCk7CgkJZGF0YS52MSA9IHRoaXMudjEudG9BcnJheSgpOwoJCWRhdGEudjIgPSB0aGlzLnYyLnRvQXJyYXkoKTsKCgkJcmV0dXJuIGRhdGE7CgoJfQoKCWZyb21KU09OKCBqc29uICkgewoKCQlzdXBlci5mcm9tSlNPTigganNvbiApOwoKCQl0aGlzLnYwLmZyb21BcnJheSgganNvbi52MCApOwoJCXRoaXMudjEuZnJvbUFycmF5KCBqc29uLnYxICk7CgkJdGhpcy52Mi5mcm9tQXJyYXkoIGpzb24udjIgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKY2xhc3MgUXVhZHJhdGljQmV6aWVyQ3VydmUzIGV4dGVuZHMgQ3VydmUgewoKCWNvbnN0cnVjdG9yKCB2MCA9IG5ldyBWZWN0b3IzKCksIHYxID0gbmV3IFZlY3RvcjMoKSwgdjIgPSBuZXcgVmVjdG9yMygpICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzUXVhZHJhdGljQmV6aWVyQ3VydmUzID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ1F1YWRyYXRpY0JlemllckN1cnZlMyc7CgoJCXRoaXMudjAgPSB2MDsKCQl0aGlzLnYxID0gdjE7CgkJdGhpcy52MiA9IHYyOwoKCX0KCglnZXRQb2ludCggdCwgb3B0aW9uYWxUYXJnZXQgPSBuZXcgVmVjdG9yMygpICkgewoKCQljb25zdCBwb2ludCA9IG9wdGlvbmFsVGFyZ2V0OwoKCQljb25zdCB2MCA9IHRoaXMudjAsIHYxID0gdGhpcy52MSwgdjIgPSB0aGlzLnYyOwoKCQlwb2ludC5zZXQoCgkJCVF1YWRyYXRpY0JlemllciggdCwgdjAueCwgdjEueCwgdjIueCApLAoJCQlRdWFkcmF0aWNCZXppZXIoIHQsIHYwLnksIHYxLnksIHYyLnkgKSwKCQkJUXVhZHJhdGljQmV6aWVyKCB0LCB2MC56LCB2MS56LCB2Mi56ICkKCQkpOwoKCQlyZXR1cm4gcG9pbnQ7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMudjAuY29weSggc291cmNlLnYwICk7CgkJdGhpcy52MS5jb3B5KCBzb3VyY2UudjEgKTsKCQl0aGlzLnYyLmNvcHkoIHNvdXJjZS52MiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCkgewoKCQljb25zdCBkYXRhID0gc3VwZXIudG9KU09OKCk7CgoJCWRhdGEudjAgPSB0aGlzLnYwLnRvQXJyYXkoKTsKCQlkYXRhLnYxID0gdGhpcy52MS50b0FycmF5KCk7CgkJZGF0YS52MiA9IHRoaXMudjIudG9BcnJheSgpOwoKCQlyZXR1cm4gZGF0YTsKCgl9CgoJZnJvbUpTT04oIGpzb24gKSB7CgoJCXN1cGVyLmZyb21KU09OKCBqc29uICk7CgoJCXRoaXMudjAuZnJvbUFycmF5KCBqc29uLnYwICk7CgkJdGhpcy52MS5mcm9tQXJyYXkoIGpzb24udjEgKTsKCQl0aGlzLnYyLmZyb21BcnJheSgganNvbi52MiApOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBTcGxpbmVDdXJ2ZSBleHRlbmRzIEN1cnZlIHsKCgljb25zdHJ1Y3RvciggcG9pbnRzID0gW10gKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNTcGxpbmVDdXJ2ZSA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdTcGxpbmVDdXJ2ZSc7CgoJCXRoaXMucG9pbnRzID0gcG9pbnRzOwoKCX0KCglnZXRQb2ludCggdCwgb3B0aW9uYWxUYXJnZXQgPSBuZXcgVmVjdG9yMigpICkgewoKCQljb25zdCBwb2ludCA9IG9wdGlvbmFsVGFyZ2V0OwoKCQljb25zdCBwb2ludHMgPSB0aGlzLnBvaW50czsKCQljb25zdCBwID0gKCBwb2ludHMubGVuZ3RoIC0gMSApICogdDsKCgkJY29uc3QgaW50UG9pbnQgPSBNYXRoLmZsb29yKCBwICk7CgkJY29uc3Qgd2VpZ2h0ID0gcCAtIGludFBvaW50OwoKCQljb25zdCBwMCA9IHBvaW50c1sgaW50UG9pbnQgPT09IDAgPyBpbnRQb2ludCA6IGludFBvaW50IC0gMSBdOwoJCWNvbnN0IHAxID0gcG9pbnRzWyBpbnRQb2ludCBdOwoJCWNvbnN0IHAyID0gcG9pbnRzWyBpbnRQb2ludCA+IHBvaW50cy5sZW5ndGggLSAyID8gcG9pbnRzLmxlbmd0aCAtIDEgOiBpbnRQb2ludCArIDEgXTsKCQljb25zdCBwMyA9IHBvaW50c1sgaW50UG9pbnQgPiBwb2ludHMubGVuZ3RoIC0gMyA/IHBvaW50cy5sZW5ndGggLSAxIDogaW50UG9pbnQgKyAyIF07CgoJCXBvaW50LnNldCgKCQkJQ2F0bXVsbFJvbSggd2VpZ2h0LCBwMC54LCBwMS54LCBwMi54LCBwMy54ICksCgkJCUNhdG11bGxSb20oIHdlaWdodCwgcDAueSwgcDEueSwgcDIueSwgcDMueSApCgkJKTsKCgkJcmV0dXJuIHBvaW50OwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLnBvaW50cyA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBzb3VyY2UucG9pbnRzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljb25zdCBwb2ludCA9IHNvdXJjZS5wb2ludHNbIGkgXTsKCgkJCXRoaXMucG9pbnRzLnB1c2goIHBvaW50LmNsb25lKCkgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCkgewoKCQljb25zdCBkYXRhID0gc3VwZXIudG9KU09OKCk7CgoJCWRhdGEucG9pbnRzID0gW107CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IHRoaXMucG9pbnRzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljb25zdCBwb2ludCA9IHRoaXMucG9pbnRzWyBpIF07CgkJCWRhdGEucG9pbnRzLnB1c2goIHBvaW50LnRvQXJyYXkoKSApOwoKCQl9CgoJCXJldHVybiBkYXRhOwoKCX0KCglmcm9tSlNPTigganNvbiApIHsKCgkJc3VwZXIuZnJvbUpTT04oIGpzb24gKTsKCgkJdGhpcy5wb2ludHMgPSBbXTsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0ganNvbi5wb2ludHMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWNvbnN0IHBvaW50ID0ganNvbi5wb2ludHNbIGkgXTsKCQkJdGhpcy5wb2ludHMucHVzaCggbmV3IFZlY3RvcjIoKS5mcm9tQXJyYXkoIHBvaW50ICkgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9Cgp2YXIgQ3VydmVzID0gLyojX19QVVJFX18qL09iamVjdC5mcmVlemUoewoJX19wcm90b19fOiBudWxsLAoJQXJjQ3VydmU6IEFyY0N1cnZlLAoJQ2F0bXVsbFJvbUN1cnZlMzogQ2F0bXVsbFJvbUN1cnZlMywKCUN1YmljQmV6aWVyQ3VydmU6IEN1YmljQmV6aWVyQ3VydmUsCglDdWJpY0JlemllckN1cnZlMzogQ3ViaWNCZXppZXJDdXJ2ZTMsCglFbGxpcHNlQ3VydmU6IEVsbGlwc2VDdXJ2ZSwKCUxpbmVDdXJ2ZTogTGluZUN1cnZlLAoJTGluZUN1cnZlMzogTGluZUN1cnZlMywKCVF1YWRyYXRpY0JlemllckN1cnZlOiBRdWFkcmF0aWNCZXppZXJDdXJ2ZSwKCVF1YWRyYXRpY0JlemllckN1cnZlMzogUXVhZHJhdGljQmV6aWVyQ3VydmUzLAoJU3BsaW5lQ3VydmU6IFNwbGluZUN1cnZlCn0pOwoKLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAqCUN1cnZlZCBQYXRoIC0gYSBjdXJ2ZSBwYXRoIGlzIHNpbXBseSBhIGFycmF5IG9mIGNvbm5lY3RlZAogKiAgY3VydmVzLCBidXQgcmV0YWlucyB0aGUgYXBpIG9mIGEgY3VydmUKICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqLwoKY2xhc3MgQ3VydmVQYXRoIGV4dGVuZHMgQ3VydmUgewoKCWNvbnN0cnVjdG9yKCkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnQ3VydmVQYXRoJzsKCgkJdGhpcy5jdXJ2ZXMgPSBbXTsKCQl0aGlzLmF1dG9DbG9zZSA9IGZhbHNlOyAvLyBBdXRvbWF0aWNhbGx5IGNsb3NlcyB0aGUgcGF0aAoKCX0KCglhZGQoIGN1cnZlICkgewoKCQl0aGlzLmN1cnZlcy5wdXNoKCBjdXJ2ZSApOwoKCX0KCgljbG9zZVBhdGgoKSB7CgoJCS8vIEFkZCBhIGxpbmUgY3VydmUgaWYgc3RhcnQgYW5kIGVuZCBvZiBsaW5lcyBhcmUgbm90IGNvbm5lY3RlZAoJCWNvbnN0IHN0YXJ0UG9pbnQgPSB0aGlzLmN1cnZlc1sgMCBdLmdldFBvaW50KCAwICk7CgkJY29uc3QgZW5kUG9pbnQgPSB0aGlzLmN1cnZlc1sgdGhpcy5jdXJ2ZXMubGVuZ3RoIC0gMSBdLmdldFBvaW50KCAxICk7CgoJCWlmICggISBzdGFydFBvaW50LmVxdWFscyggZW5kUG9pbnQgKSApIHsKCgkJCWNvbnN0IGxpbmVUeXBlID0gKCBzdGFydFBvaW50LmlzVmVjdG9yMiA9PT0gdHJ1ZSApID8gJ0xpbmVDdXJ2ZScgOiAnTGluZUN1cnZlMyc7CgkJCXRoaXMuY3VydmVzLnB1c2goIG5ldyBDdXJ2ZXNbIGxpbmVUeXBlIF0oIGVuZFBvaW50LCBzdGFydFBvaW50ICkgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJLy8gVG8gZ2V0IGFjY3VyYXRlIHBvaW50IHdpdGggcmVmZXJlbmNlIHRvCgkvLyBlbnRpcmUgcGF0aCBkaXN0YW5jZSBhdCB0aW1lIHQsCgkvLyBmb2xsb3dpbmcgaGFzIHRvIGJlIGRvbmU6CgoJLy8gMS4gTGVuZ3RoIG9mIGVhY2ggc3ViIHBhdGggaGF2ZSB0byBiZSBrbm93bgoJLy8gMi4gTG9jYXRlIGFuZCBpZGVudGlmeSB0eXBlIG9mIGN1cnZlCgkvLyAzLiBHZXQgdCBmb3IgdGhlIGN1cnZlCgkvLyA0LiBSZXR1cm4gY3VydmUuZ2V0UG9pbnRBdCh0JykKCglnZXRQb2ludCggdCwgb3B0aW9uYWxUYXJnZXQgKSB7CgoJCWNvbnN0IGQgPSB0ICogdGhpcy5nZXRMZW5ndGgoKTsKCQljb25zdCBjdXJ2ZUxlbmd0aHMgPSB0aGlzLmdldEN1cnZlTGVuZ3RocygpOwoJCWxldCBpID0gMDsKCgkJLy8gVG8gdGhpbmsgYWJvdXQgYm91bmRhcmllcyBwb2ludHMuCgoJCXdoaWxlICggaSA8IGN1cnZlTGVuZ3Rocy5sZW5ndGggKSB7CgoJCQlpZiAoIGN1cnZlTGVuZ3Roc1sgaSBdID49IGQgKSB7CgoJCQkJY29uc3QgZGlmZiA9IGN1cnZlTGVuZ3Roc1sgaSBdIC0gZDsKCQkJCWNvbnN0IGN1cnZlID0gdGhpcy5jdXJ2ZXNbIGkgXTsKCgkJCQljb25zdCBzZWdtZW50TGVuZ3RoID0gY3VydmUuZ2V0TGVuZ3RoKCk7CgkJCQljb25zdCB1ID0gc2VnbWVudExlbmd0aCA9PT0gMCA/IDAgOiAxIC0gZGlmZiAvIHNlZ21lbnRMZW5ndGg7CgoJCQkJcmV0dXJuIGN1cnZlLmdldFBvaW50QXQoIHUsIG9wdGlvbmFsVGFyZ2V0ICk7CgoJCQl9CgoJCQlpICsrOwoKCQl9CgoJCXJldHVybiBudWxsOwoKCQkvLyBsb29wIHdoZXJlIHN1bSAhPSAwLCBzdW0gPiBkICwgc3VtKzEgPGQKCgl9CgoJLy8gV2UgY2Fubm90IHVzZSB0aGUgZGVmYXVsdCBUSFJFRS5DdXJ2ZSBnZXRQb2ludCgpIHdpdGggZ2V0TGVuZ3RoKCkgYmVjYXVzZSBpbgoJLy8gVEhSRUUuQ3VydmUsIGdldExlbmd0aCgpIGRlcGVuZHMgb24gZ2V0UG9pbnQoKSBidXQgaW4gVEhSRUUuQ3VydmVQYXRoCgkvLyBnZXRQb2ludCgpIGRlcGVuZHMgb24gZ2V0TGVuZ3RoCgoJZ2V0TGVuZ3RoKCkgewoKCQljb25zdCBsZW5zID0gdGhpcy5nZXRDdXJ2ZUxlbmd0aHMoKTsKCQlyZXR1cm4gbGVuc1sgbGVucy5sZW5ndGggLSAxIF07CgoJfQoKCS8vIGNhY2hlTGVuZ3RocyBtdXN0IGJlIHJlY2FsY3VsYXRlZC4KCXVwZGF0ZUFyY0xlbmd0aHMoKSB7CgoJCXRoaXMubmVlZHNVcGRhdGUgPSB0cnVlOwoJCXRoaXMuY2FjaGVMZW5ndGhzID0gbnVsbDsKCQl0aGlzLmdldEN1cnZlTGVuZ3RocygpOwoKCX0KCgkvLyBDb21wdXRlIGxlbmd0aHMgYW5kIGNhY2hlIHRoZW0KCS8vIFdlIGNhbm5vdCBvdmVyd3JpdGUgZ2V0TGVuZ3RocygpIGJlY2F1c2UgVXRvVCBtYXBwaW5nIHVzZXMgaXQuCgoJZ2V0Q3VydmVMZW5ndGhzKCkgewoKCQkvLyBXZSB1c2UgY2FjaGUgdmFsdWVzIGlmIGN1cnZlcyBhbmQgY2FjaGUgYXJyYXkgYXJlIHNhbWUgbGVuZ3RoCgoJCWlmICggdGhpcy5jYWNoZUxlbmd0aHMgJiYgdGhpcy5jYWNoZUxlbmd0aHMubGVuZ3RoID09PSB0aGlzLmN1cnZlcy5sZW5ndGggKSB7CgoJCQlyZXR1cm4gdGhpcy5jYWNoZUxlbmd0aHM7CgoJCX0KCgkJLy8gR2V0IGxlbmd0aCBvZiBzdWItY3VydmUKCQkvLyBQdXNoIHN1bXMgaW50byBjYWNoZWQgYXJyYXkKCgkJY29uc3QgbGVuZ3RocyA9IFtdOwoJCWxldCBzdW1zID0gMDsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gdGhpcy5jdXJ2ZXMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCXN1bXMgKz0gdGhpcy5jdXJ2ZXNbIGkgXS5nZXRMZW5ndGgoKTsKCQkJbGVuZ3Rocy5wdXNoKCBzdW1zICk7CgoJCX0KCgkJdGhpcy5jYWNoZUxlbmd0aHMgPSBsZW5ndGhzOwoKCQlyZXR1cm4gbGVuZ3RoczsKCgl9CgoJZ2V0U3BhY2VkUG9pbnRzKCBkaXZpc2lvbnMgPSA0MCApIHsKCgkJY29uc3QgcG9pbnRzID0gW107CgoJCWZvciAoIGxldCBpID0gMDsgaSA8PSBkaXZpc2lvbnM7IGkgKysgKSB7CgoJCQlwb2ludHMucHVzaCggdGhpcy5nZXRQb2ludCggaSAvIGRpdmlzaW9ucyApICk7CgoJCX0KCgkJaWYgKCB0aGlzLmF1dG9DbG9zZSApIHsKCgkJCXBvaW50cy5wdXNoKCBwb2ludHNbIDAgXSApOwoKCQl9CgoJCXJldHVybiBwb2ludHM7CgoJfQoKCWdldFBvaW50cyggZGl2aXNpb25zID0gMTIgKSB7CgoJCWNvbnN0IHBvaW50cyA9IFtdOwoJCWxldCBsYXN0OwoKCQlmb3IgKCBsZXQgaSA9IDAsIGN1cnZlcyA9IHRoaXMuY3VydmVzOyBpIDwgY3VydmVzLmxlbmd0aDsgaSArKyApIHsKCgkJCWNvbnN0IGN1cnZlID0gY3VydmVzWyBpIF07CgkJCWNvbnN0IHJlc29sdXRpb24gPSBjdXJ2ZS5pc0VsbGlwc2VDdXJ2ZSA/IGRpdmlzaW9ucyAqIDIKCQkJCTogKCBjdXJ2ZS5pc0xpbmVDdXJ2ZSB8fCBjdXJ2ZS5pc0xpbmVDdXJ2ZTMgKSA/IDEKCQkJCQk6IGN1cnZlLmlzU3BsaW5lQ3VydmUgPyBkaXZpc2lvbnMgKiBjdXJ2ZS5wb2ludHMubGVuZ3RoCgkJCQkJCTogZGl2aXNpb25zOwoKCQkJY29uc3QgcHRzID0gY3VydmUuZ2V0UG9pbnRzKCByZXNvbHV0aW9uICk7CgoJCQlmb3IgKCBsZXQgaiA9IDA7IGogPCBwdHMubGVuZ3RoOyBqICsrICkgewoKCQkJCWNvbnN0IHBvaW50ID0gcHRzWyBqIF07CgoJCQkJaWYgKCBsYXN0ICYmIGxhc3QuZXF1YWxzKCBwb2ludCApICkgY29udGludWU7IC8vIGVuc3VyZXMgbm8gY29uc2VjdXRpdmUgcG9pbnRzIGFyZSBkdXBsaWNhdGVzCgoJCQkJcG9pbnRzLnB1c2goIHBvaW50ICk7CgkJCQlsYXN0ID0gcG9pbnQ7CgoJCQl9CgoJCX0KCgkJaWYgKCB0aGlzLmF1dG9DbG9zZSAmJiBwb2ludHMubGVuZ3RoID4gMSAmJiAhIHBvaW50c1sgcG9pbnRzLmxlbmd0aCAtIDEgXS5lcXVhbHMoIHBvaW50c1sgMCBdICkgKSB7CgoJCQlwb2ludHMucHVzaCggcG9pbnRzWyAwIF0gKTsKCgkJfQoKCQlyZXR1cm4gcG9pbnRzOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLmN1cnZlcyA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBzb3VyY2UuY3VydmVzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljb25zdCBjdXJ2ZSA9IHNvdXJjZS5jdXJ2ZXNbIGkgXTsKCgkJCXRoaXMuY3VydmVzLnB1c2goIGN1cnZlLmNsb25lKCkgKTsKCgkJfQoKCQl0aGlzLmF1dG9DbG9zZSA9IHNvdXJjZS5hdXRvQ2xvc2U7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0pTT04oKSB7CgoJCWNvbnN0IGRhdGEgPSBzdXBlci50b0pTT04oKTsKCgkJZGF0YS5hdXRvQ2xvc2UgPSB0aGlzLmF1dG9DbG9zZTsKCQlkYXRhLmN1cnZlcyA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSB0aGlzLmN1cnZlcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgY3VydmUgPSB0aGlzLmN1cnZlc1sgaSBdOwoJCQlkYXRhLmN1cnZlcy5wdXNoKCBjdXJ2ZS50b0pTT04oKSApOwoKCQl9CgoJCXJldHVybiBkYXRhOwoKCX0KCglmcm9tSlNPTigganNvbiApIHsKCgkJc3VwZXIuZnJvbUpTT04oIGpzb24gKTsKCgkJdGhpcy5hdXRvQ2xvc2UgPSBqc29uLmF1dG9DbG9zZTsKCQl0aGlzLmN1cnZlcyA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBqc29uLmN1cnZlcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgY3VydmUgPSBqc29uLmN1cnZlc1sgaSBdOwoJCQl0aGlzLmN1cnZlcy5wdXNoKCBuZXcgQ3VydmVzWyBjdXJ2ZS50eXBlIF0oKS5mcm9tSlNPTiggY3VydmUgKSApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIFBhdGggZXh0ZW5kcyBDdXJ2ZVBhdGggewoKCWNvbnN0cnVjdG9yKCBwb2ludHMgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMudHlwZSA9ICdQYXRoJzsKCgkJdGhpcy5jdXJyZW50UG9pbnQgPSBuZXcgVmVjdG9yMigpOwoKCQlpZiAoIHBvaW50cyApIHsKCgkJCXRoaXMuc2V0RnJvbVBvaW50cyggcG9pbnRzICk7CgoJCX0KCgl9CgoJc2V0RnJvbVBvaW50cyggcG9pbnRzICkgewoKCQl0aGlzLm1vdmVUbyggcG9pbnRzWyAwIF0ueCwgcG9pbnRzWyAwIF0ueSApOwoKCQlmb3IgKCBsZXQgaSA9IDEsIGwgPSBwb2ludHMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCXRoaXMubGluZVRvKCBwb2ludHNbIGkgXS54LCBwb2ludHNbIGkgXS55ICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW1vdmVUbyggeCwgeSApIHsKCgkJdGhpcy5jdXJyZW50UG9pbnQuc2V0KCB4LCB5ICk7IC8vIFRPRE8gY29uc2lkZXIgcmVmZXJlbmNpbmcgdmVjdG9ycyBpbnN0ZWFkIG9mIGNvcHlpbmc/CgoJCXJldHVybiB0aGlzOwoKCX0KCglsaW5lVG8oIHgsIHkgKSB7CgoJCWNvbnN0IGN1cnZlID0gbmV3IExpbmVDdXJ2ZSggdGhpcy5jdXJyZW50UG9pbnQuY2xvbmUoKSwgbmV3IFZlY3RvcjIoIHgsIHkgKSApOwoJCXRoaXMuY3VydmVzLnB1c2goIGN1cnZlICk7CgoJCXRoaXMuY3VycmVudFBvaW50LnNldCggeCwgeSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcXVhZHJhdGljQ3VydmVUbyggYUNQeCwgYUNQeSwgYVgsIGFZICkgewoKCQljb25zdCBjdXJ2ZSA9IG5ldyBRdWFkcmF0aWNCZXppZXJDdXJ2ZSgKCQkJdGhpcy5jdXJyZW50UG9pbnQuY2xvbmUoKSwKCQkJbmV3IFZlY3RvcjIoIGFDUHgsIGFDUHkgKSwKCQkJbmV3IFZlY3RvcjIoIGFYLCBhWSApCgkJKTsKCgkJdGhpcy5jdXJ2ZXMucHVzaCggY3VydmUgKTsKCgkJdGhpcy5jdXJyZW50UG9pbnQuc2V0KCBhWCwgYVkgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWJlemllckN1cnZlVG8oIGFDUDF4LCBhQ1AxeSwgYUNQMngsIGFDUDJ5LCBhWCwgYVkgKSB7CgoJCWNvbnN0IGN1cnZlID0gbmV3IEN1YmljQmV6aWVyQ3VydmUoCgkJCXRoaXMuY3VycmVudFBvaW50LmNsb25lKCksCgkJCW5ldyBWZWN0b3IyKCBhQ1AxeCwgYUNQMXkgKSwKCQkJbmV3IFZlY3RvcjIoIGFDUDJ4LCBhQ1AyeSApLAoJCQluZXcgVmVjdG9yMiggYVgsIGFZICkKCQkpOwoKCQl0aGlzLmN1cnZlcy5wdXNoKCBjdXJ2ZSApOwoKCQl0aGlzLmN1cnJlbnRQb2ludC5zZXQoIGFYLCBhWSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3BsaW5lVGhydSggcHRzIC8qQXJyYXkgb2YgVmVjdG9yKi8gKSB7CgoJCWNvbnN0IG5wdHMgPSBbIHRoaXMuY3VycmVudFBvaW50LmNsb25lKCkgXS5jb25jYXQoIHB0cyApOwoKCQljb25zdCBjdXJ2ZSA9IG5ldyBTcGxpbmVDdXJ2ZSggbnB0cyApOwoJCXRoaXMuY3VydmVzLnB1c2goIGN1cnZlICk7CgoJCXRoaXMuY3VycmVudFBvaW50LmNvcHkoIHB0c1sgcHRzLmxlbmd0aCAtIDEgXSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJYXJjKCBhWCwgYVksIGFSYWRpdXMsIGFTdGFydEFuZ2xlLCBhRW5kQW5nbGUsIGFDbG9ja3dpc2UgKSB7CgoJCWNvbnN0IHgwID0gdGhpcy5jdXJyZW50UG9pbnQueDsKCQljb25zdCB5MCA9IHRoaXMuY3VycmVudFBvaW50Lnk7CgoJCXRoaXMuYWJzYXJjKCBhWCArIHgwLCBhWSArIHkwLCBhUmFkaXVzLAoJCQlhU3RhcnRBbmdsZSwgYUVuZEFuZ2xlLCBhQ2xvY2t3aXNlICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglhYnNhcmMoIGFYLCBhWSwgYVJhZGl1cywgYVN0YXJ0QW5nbGUsIGFFbmRBbmdsZSwgYUNsb2Nrd2lzZSApIHsKCgkJdGhpcy5hYnNlbGxpcHNlKCBhWCwgYVksIGFSYWRpdXMsIGFSYWRpdXMsIGFTdGFydEFuZ2xlLCBhRW5kQW5nbGUsIGFDbG9ja3dpc2UgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWVsbGlwc2UoIGFYLCBhWSwgeFJhZGl1cywgeVJhZGl1cywgYVN0YXJ0QW5nbGUsIGFFbmRBbmdsZSwgYUNsb2Nrd2lzZSwgYVJvdGF0aW9uICkgewoKCQljb25zdCB4MCA9IHRoaXMuY3VycmVudFBvaW50Lng7CgkJY29uc3QgeTAgPSB0aGlzLmN1cnJlbnRQb2ludC55OwoKCQl0aGlzLmFic2VsbGlwc2UoIGFYICsgeDAsIGFZICsgeTAsIHhSYWRpdXMsIHlSYWRpdXMsIGFTdGFydEFuZ2xlLCBhRW5kQW5nbGUsIGFDbG9ja3dpc2UsIGFSb3RhdGlvbiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJYWJzZWxsaXBzZSggYVgsIGFZLCB4UmFkaXVzLCB5UmFkaXVzLCBhU3RhcnRBbmdsZSwgYUVuZEFuZ2xlLCBhQ2xvY2t3aXNlLCBhUm90YXRpb24gKSB7CgoJCWNvbnN0IGN1cnZlID0gbmV3IEVsbGlwc2VDdXJ2ZSggYVgsIGFZLCB4UmFkaXVzLCB5UmFkaXVzLCBhU3RhcnRBbmdsZSwgYUVuZEFuZ2xlLCBhQ2xvY2t3aXNlLCBhUm90YXRpb24gKTsKCgkJaWYgKCB0aGlzLmN1cnZlcy5sZW5ndGggPiAwICkgewoKCQkJLy8gaWYgYSBwcmV2aW91cyBjdXJ2ZSBpcyBwcmVzZW50LCBhdHRlbXB0IHRvIGpvaW4KCQkJY29uc3QgZmlyc3RQb2ludCA9IGN1cnZlLmdldFBvaW50KCAwICk7CgoJCQlpZiAoICEgZmlyc3RQb2ludC5lcXVhbHMoIHRoaXMuY3VycmVudFBvaW50ICkgKSB7CgoJCQkJdGhpcy5saW5lVG8oIGZpcnN0UG9pbnQueCwgZmlyc3RQb2ludC55ICk7CgoJCQl9CgoJCX0KCgkJdGhpcy5jdXJ2ZXMucHVzaCggY3VydmUgKTsKCgkJY29uc3QgbGFzdFBvaW50ID0gY3VydmUuZ2V0UG9pbnQoIDEgKTsKCQl0aGlzLmN1cnJlbnRQb2ludC5jb3B5KCBsYXN0UG9pbnQgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuY3VycmVudFBvaW50LmNvcHkoIHNvdXJjZS5jdXJyZW50UG9pbnQgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTigpIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTigpOwoKCQlkYXRhLmN1cnJlbnRQb2ludCA9IHRoaXMuY3VycmVudFBvaW50LnRvQXJyYXkoKTsKCgkJcmV0dXJuIGRhdGE7CgoJfQoKCWZyb21KU09OKCBqc29uICkgewoKCQlzdXBlci5mcm9tSlNPTigganNvbiApOwoKCQl0aGlzLmN1cnJlbnRQb2ludC5mcm9tQXJyYXkoIGpzb24uY3VycmVudFBvaW50ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIExhdGhlR2VvbWV0cnkgZXh0ZW5kcyBCdWZmZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIHBvaW50cyA9IFsgbmV3IFZlY3RvcjIoIDAsIC0gMC41ICksIG5ldyBWZWN0b3IyKCAwLjUsIDAgKSwgbmV3IFZlY3RvcjIoIDAsIDAuNSApIF0sIHNlZ21lbnRzID0gMTIsIHBoaVN0YXJ0ID0gMCwgcGhpTGVuZ3RoID0gTWF0aC5QSSAqIDIgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMudHlwZSA9ICdMYXRoZUdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlwb2ludHM6IHBvaW50cywKCQkJc2VnbWVudHM6IHNlZ21lbnRzLAoJCQlwaGlTdGFydDogcGhpU3RhcnQsCgkJCXBoaUxlbmd0aDogcGhpTGVuZ3RoCgkJfTsKCgkJc2VnbWVudHMgPSBNYXRoLmZsb29yKCBzZWdtZW50cyApOwoKCQkvLyBjbGFtcCBwaGlMZW5ndGggc28gaXQncyBpbiByYW5nZSBvZiBbIDAsIDJQSSBdCgoJCXBoaUxlbmd0aCA9IGNsYW1wKCBwaGlMZW5ndGgsIDAsIE1hdGguUEkgKiAyICk7CgoJCS8vIGJ1ZmZlcnMKCgkJY29uc3QgaW5kaWNlcyA9IFtdOwoJCWNvbnN0IHZlcnRpY2VzID0gW107CgkJY29uc3QgdXZzID0gW107CgkJY29uc3QgaW5pdE5vcm1hbHMgPSBbXTsKCQljb25zdCBub3JtYWxzID0gW107CgoJCS8vIGhlbHBlciB2YXJpYWJsZXMKCgkJY29uc3QgaW52ZXJzZVNlZ21lbnRzID0gMS4wIC8gc2VnbWVudHM7CgkJY29uc3QgdmVydGV4ID0gbmV3IFZlY3RvcjMoKTsKCQljb25zdCB1diA9IG5ldyBWZWN0b3IyKCk7CgkJY29uc3Qgbm9ybWFsID0gbmV3IFZlY3RvcjMoKTsKCQljb25zdCBjdXJOb3JtYWwgPSBuZXcgVmVjdG9yMygpOwoJCWNvbnN0IHByZXZOb3JtYWwgPSBuZXcgVmVjdG9yMygpOwoJCWxldCBkeCA9IDA7CgkJbGV0IGR5ID0gMDsKCgkJLy8gcHJlLWNvbXB1dGUgbm9ybWFscyBmb3IgaW5pdGlhbCAibWVyaWRpYW4iCgoJCWZvciAoIGxldCBqID0gMDsgaiA8PSAoIHBvaW50cy5sZW5ndGggLSAxICk7IGogKysgKSB7CgoJCQlzd2l0Y2ggKCBqICkgewoKCQkJCWNhc2UgMDoJCQkJLy8gc3BlY2lhbCBoYW5kbGluZyBmb3IgMXN0IHZlcnRleCBvbiBwYXRoCgoJCQkJCWR4ID0gcG9pbnRzWyBqICsgMSBdLnggLSBwb2ludHNbIGogXS54OwoJCQkJCWR5ID0gcG9pbnRzWyBqICsgMSBdLnkgLSBwb2ludHNbIGogXS55OwoKCQkJCQlub3JtYWwueCA9IGR5ICogMS4wOwoJCQkJCW5vcm1hbC55ID0gLSBkeDsKCQkJCQlub3JtYWwueiA9IGR5ICogMC4wOwoKCQkJCQlwcmV2Tm9ybWFsLmNvcHkoIG5vcm1hbCApOwoKCQkJCQlub3JtYWwubm9ybWFsaXplKCk7CgoJCQkJCWluaXROb3JtYWxzLnB1c2goIG5vcm1hbC54LCBub3JtYWwueSwgbm9ybWFsLnogKTsKCgkJCQkJYnJlYWs7CgoJCQkJY2FzZSAoIHBvaW50cy5sZW5ndGggLSAxICk6CS8vIHNwZWNpYWwgaGFuZGxpbmcgZm9yIGxhc3QgVmVydGV4IG9uIHBhdGgKCgkJCQkJaW5pdE5vcm1hbHMucHVzaCggcHJldk5vcm1hbC54LCBwcmV2Tm9ybWFsLnksIHByZXZOb3JtYWwueiApOwoKCQkJCQlicmVhazsKCgkJCQlkZWZhdWx0OgkJCS8vIGRlZmF1bHQgaGFuZGxpbmcgZm9yIGFsbCB2ZXJ0aWNlcyBpbiBiZXR3ZWVuCgoJCQkJCWR4ID0gcG9pbnRzWyBqICsgMSBdLnggLSBwb2ludHNbIGogXS54OwoJCQkJCWR5ID0gcG9pbnRzWyBqICsgMSBdLnkgLSBwb2ludHNbIGogXS55OwoKCQkJCQlub3JtYWwueCA9IGR5ICogMS4wOwoJCQkJCW5vcm1hbC55ID0gLSBkeDsKCQkJCQlub3JtYWwueiA9IGR5ICogMC4wOwoKCQkJCQljdXJOb3JtYWwuY29weSggbm9ybWFsICk7CgoJCQkJCW5vcm1hbC54ICs9IHByZXZOb3JtYWwueDsKCQkJCQlub3JtYWwueSArPSBwcmV2Tm9ybWFsLnk7CgkJCQkJbm9ybWFsLnogKz0gcHJldk5vcm1hbC56OwoKCQkJCQlub3JtYWwubm9ybWFsaXplKCk7CgoJCQkJCWluaXROb3JtYWxzLnB1c2goIG5vcm1hbC54LCBub3JtYWwueSwgbm9ybWFsLnogKTsKCgkJCQkJcHJldk5vcm1hbC5jb3B5KCBjdXJOb3JtYWwgKTsKCgkJCX0KCgkJfQoKCQkvLyBnZW5lcmF0ZSB2ZXJ0aWNlcywgdXZzIGFuZCBub3JtYWxzCgoJCWZvciAoIGxldCBpID0gMDsgaSA8PSBzZWdtZW50czsgaSArKyApIHsKCgkJCWNvbnN0IHBoaSA9IHBoaVN0YXJ0ICsgaSAqIGludmVyc2VTZWdtZW50cyAqIHBoaUxlbmd0aDsKCgkJCWNvbnN0IHNpbiA9IE1hdGguc2luKCBwaGkgKTsKCQkJY29uc3QgY29zID0gTWF0aC5jb3MoIHBoaSApOwoKCQkJZm9yICggbGV0IGogPSAwOyBqIDw9ICggcG9pbnRzLmxlbmd0aCAtIDEgKTsgaiArKyApIHsKCgkJCQkvLyB2ZXJ0ZXgKCgkJCQl2ZXJ0ZXgueCA9IHBvaW50c1sgaiBdLnggKiBzaW47CgkJCQl2ZXJ0ZXgueSA9IHBvaW50c1sgaiBdLnk7CgkJCQl2ZXJ0ZXgueiA9IHBvaW50c1sgaiBdLnggKiBjb3M7CgoJCQkJdmVydGljZXMucHVzaCggdmVydGV4LngsIHZlcnRleC55LCB2ZXJ0ZXgueiApOwoKCQkJCS8vIHV2CgoJCQkJdXYueCA9IGkgLyBzZWdtZW50czsKCQkJCXV2LnkgPSBqIC8gKCBwb2ludHMubGVuZ3RoIC0gMSApOwoKCQkJCXV2cy5wdXNoKCB1di54LCB1di55ICk7CgoJCQkJLy8gbm9ybWFsCgoJCQkJY29uc3QgeCA9IGluaXROb3JtYWxzWyAzICogaiArIDAgXSAqIHNpbjsKCQkJCWNvbnN0IHkgPSBpbml0Tm9ybWFsc1sgMyAqIGogKyAxIF07CgkJCQljb25zdCB6ID0gaW5pdE5vcm1hbHNbIDMgKiBqICsgMCBdICogY29zOwoKCQkJCW5vcm1hbHMucHVzaCggeCwgeSwgeiApOwoKCQkJfQoKCQl9CgoJCS8vIGluZGljZXMKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgc2VnbWVudHM7IGkgKysgKSB7CgoJCQlmb3IgKCBsZXQgaiA9IDA7IGogPCAoIHBvaW50cy5sZW5ndGggLSAxICk7IGogKysgKSB7CgoJCQkJY29uc3QgYmFzZSA9IGogKyBpICogcG9pbnRzLmxlbmd0aDsKCgkJCQljb25zdCBhID0gYmFzZTsKCQkJCWNvbnN0IGIgPSBiYXNlICsgcG9pbnRzLmxlbmd0aDsKCQkJCWNvbnN0IGMgPSBiYXNlICsgcG9pbnRzLmxlbmd0aCArIDE7CgkJCQljb25zdCBkID0gYmFzZSArIDE7CgoJCQkJLy8gZmFjZXMKCgkJCQlpbmRpY2VzLnB1c2goIGEsIGIsIGQgKTsKCQkJCWluZGljZXMucHVzaCggYywgZCwgYiApOwoKCQkJfQoKCQl9CgoJCS8vIGJ1aWxkIGdlb21ldHJ5CgoJCXRoaXMuc2V0SW5kZXgoIGluZGljZXMgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHZlcnRpY2VzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3V2JywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHV2cywgMiApICk7CgkJdGhpcy5zZXRBdHRyaWJ1dGUoICdub3JtYWwnLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggbm9ybWFscywgMyApICk7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oIHt9LCBzb3VyY2UucGFyYW1ldGVycyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQlyZXR1cm4gbmV3IExhdGhlR2VvbWV0cnkoIGRhdGEucG9pbnRzLCBkYXRhLnNlZ21lbnRzLCBkYXRhLnBoaVN0YXJ0LCBkYXRhLnBoaUxlbmd0aCApOwoKCX0KCn0KCmNsYXNzIENhcHN1bGVHZW9tZXRyeSBleHRlbmRzIExhdGhlR2VvbWV0cnkgewoKCWNvbnN0cnVjdG9yKCByYWRpdXMgPSAxLCBsZW5ndGggPSAxLCBjYXBTZWdtZW50cyA9IDQsIHJhZGlhbFNlZ21lbnRzID0gOCApIHsKCgkJY29uc3QgcGF0aCA9IG5ldyBQYXRoKCk7CgkJcGF0aC5hYnNhcmMoIDAsIC0gbGVuZ3RoIC8gMiwgcmFkaXVzLCBNYXRoLlBJICogMS41LCAwICk7CgkJcGF0aC5hYnNhcmMoIDAsIGxlbmd0aCAvIDIsIHJhZGl1cywgMCwgTWF0aC5QSSAqIDAuNSApOwoKCQlzdXBlciggcGF0aC5nZXRQb2ludHMoIGNhcFNlZ21lbnRzICksIHJhZGlhbFNlZ21lbnRzICk7CgoJCXRoaXMudHlwZSA9ICdDYXBzdWxlR2VvbWV0cnknOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSB7CgkJCXJhZGl1czogcmFkaXVzLAoJCQlsZW5ndGg6IGxlbmd0aCwKCQkJY2FwU2VnbWVudHM6IGNhcFNlZ21lbnRzLAoJCQlyYWRpYWxTZWdtZW50czogcmFkaWFsU2VnbWVudHMsCgkJfTsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQlyZXR1cm4gbmV3IENhcHN1bGVHZW9tZXRyeSggZGF0YS5yYWRpdXMsIGRhdGEubGVuZ3RoLCBkYXRhLmNhcFNlZ21lbnRzLCBkYXRhLnJhZGlhbFNlZ21lbnRzICk7CgoJfQoKfQoKY2xhc3MgQ2lyY2xlR2VvbWV0cnkgZXh0ZW5kcyBCdWZmZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIHJhZGl1cyA9IDEsIHNlZ21lbnRzID0gMzIsIHRoZXRhU3RhcnQgPSAwLCB0aGV0YUxlbmd0aCA9IE1hdGguUEkgKiAyICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnQ2lyY2xlR2VvbWV0cnknOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSB7CgkJCXJhZGl1czogcmFkaXVzLAoJCQlzZWdtZW50czogc2VnbWVudHMsCgkJCXRoZXRhU3RhcnQ6IHRoZXRhU3RhcnQsCgkJCXRoZXRhTGVuZ3RoOiB0aGV0YUxlbmd0aAoJCX07CgoJCXNlZ21lbnRzID0gTWF0aC5tYXgoIDMsIHNlZ21lbnRzICk7CgoJCS8vIGJ1ZmZlcnMKCgkJY29uc3QgaW5kaWNlcyA9IFtdOwoJCWNvbnN0IHZlcnRpY2VzID0gW107CgkJY29uc3Qgbm9ybWFscyA9IFtdOwoJCWNvbnN0IHV2cyA9IFtdOwoKCQkvLyBoZWxwZXIgdmFyaWFibGVzCgoJCWNvbnN0IHZlcnRleCA9IG5ldyBWZWN0b3IzKCk7CgkJY29uc3QgdXYgPSBuZXcgVmVjdG9yMigpOwoKCQkvLyBjZW50ZXIgcG9pbnQKCgkJdmVydGljZXMucHVzaCggMCwgMCwgMCApOwoJCW5vcm1hbHMucHVzaCggMCwgMCwgMSApOwoJCXV2cy5wdXNoKCAwLjUsIDAuNSApOwoKCQlmb3IgKCBsZXQgcyA9IDAsIGkgPSAzOyBzIDw9IHNlZ21lbnRzOyBzICsrLCBpICs9IDMgKSB7CgoJCQljb25zdCBzZWdtZW50ID0gdGhldGFTdGFydCArIHMgLyBzZWdtZW50cyAqIHRoZXRhTGVuZ3RoOwoKCQkJLy8gdmVydGV4CgoJCQl2ZXJ0ZXgueCA9IHJhZGl1cyAqIE1hdGguY29zKCBzZWdtZW50ICk7CgkJCXZlcnRleC55ID0gcmFkaXVzICogTWF0aC5zaW4oIHNlZ21lbnQgKTsKCgkJCXZlcnRpY2VzLnB1c2goIHZlcnRleC54LCB2ZXJ0ZXgueSwgdmVydGV4LnogKTsKCgkJCS8vIG5vcm1hbAoKCQkJbm9ybWFscy5wdXNoKCAwLCAwLCAxICk7CgoJCQkvLyB1dnMKCgkJCXV2LnggPSAoIHZlcnRpY2VzWyBpIF0gLyByYWRpdXMgKyAxICkgLyAyOwoJCQl1di55ID0gKCB2ZXJ0aWNlc1sgaSArIDEgXSAvIHJhZGl1cyArIDEgKSAvIDI7CgoJCQl1dnMucHVzaCggdXYueCwgdXYueSApOwoKCQl9CgoJCS8vIGluZGljZXMKCgkJZm9yICggbGV0IGkgPSAxOyBpIDw9IHNlZ21lbnRzOyBpICsrICkgewoKCQkJaW5kaWNlcy5wdXNoKCBpLCBpICsgMSwgMCApOwoKCQl9CgoJCS8vIGJ1aWxkIGdlb21ldHJ5CgoJCXRoaXMuc2V0SW5kZXgoIGluZGljZXMgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHZlcnRpY2VzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ25vcm1hbCcsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCBub3JtYWxzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3V2JywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHV2cywgMiApICk7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oIHt9LCBzb3VyY2UucGFyYW1ldGVycyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQlyZXR1cm4gbmV3IENpcmNsZUdlb21ldHJ5KCBkYXRhLnJhZGl1cywgZGF0YS5zZWdtZW50cywgZGF0YS50aGV0YVN0YXJ0LCBkYXRhLnRoZXRhTGVuZ3RoICk7CgoJfQoKfQoKY2xhc3MgQ3lsaW5kZXJHZW9tZXRyeSBleHRlbmRzIEJ1ZmZlckdlb21ldHJ5IHsKCgljb25zdHJ1Y3RvciggcmFkaXVzVG9wID0gMSwgcmFkaXVzQm90dG9tID0gMSwgaGVpZ2h0ID0gMSwgcmFkaWFsU2VnbWVudHMgPSAzMiwgaGVpZ2h0U2VnbWVudHMgPSAxLCBvcGVuRW5kZWQgPSBmYWxzZSwgdGhldGFTdGFydCA9IDAsIHRoZXRhTGVuZ3RoID0gTWF0aC5QSSAqIDIgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMudHlwZSA9ICdDeWxpbmRlckdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlyYWRpdXNUb3A6IHJhZGl1c1RvcCwKCQkJcmFkaXVzQm90dG9tOiByYWRpdXNCb3R0b20sCgkJCWhlaWdodDogaGVpZ2h0LAoJCQlyYWRpYWxTZWdtZW50czogcmFkaWFsU2VnbWVudHMsCgkJCWhlaWdodFNlZ21lbnRzOiBoZWlnaHRTZWdtZW50cywKCQkJb3BlbkVuZGVkOiBvcGVuRW5kZWQsCgkJCXRoZXRhU3RhcnQ6IHRoZXRhU3RhcnQsCgkJCXRoZXRhTGVuZ3RoOiB0aGV0YUxlbmd0aAoJCX07CgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJcmFkaWFsU2VnbWVudHMgPSBNYXRoLmZsb29yKCByYWRpYWxTZWdtZW50cyApOwoJCWhlaWdodFNlZ21lbnRzID0gTWF0aC5mbG9vciggaGVpZ2h0U2VnbWVudHMgKTsKCgkJLy8gYnVmZmVycwoKCQljb25zdCBpbmRpY2VzID0gW107CgkJY29uc3QgdmVydGljZXMgPSBbXTsKCQljb25zdCBub3JtYWxzID0gW107CgkJY29uc3QgdXZzID0gW107CgoJCS8vIGhlbHBlciB2YXJpYWJsZXMKCgkJbGV0IGluZGV4ID0gMDsKCQljb25zdCBpbmRleEFycmF5ID0gW107CgkJY29uc3QgaGFsZkhlaWdodCA9IGhlaWdodCAvIDI7CgkJbGV0IGdyb3VwU3RhcnQgPSAwOwoKCQkvLyBnZW5lcmF0ZSBnZW9tZXRyeQoKCQlnZW5lcmF0ZVRvcnNvKCk7CgoJCWlmICggb3BlbkVuZGVkID09PSBmYWxzZSApIHsKCgkJCWlmICggcmFkaXVzVG9wID4gMCApIGdlbmVyYXRlQ2FwKCB0cnVlICk7CgkJCWlmICggcmFkaXVzQm90dG9tID4gMCApIGdlbmVyYXRlQ2FwKCBmYWxzZSApOwoKCQl9CgoJCS8vIGJ1aWxkIGdlb21ldHJ5CgoJCXRoaXMuc2V0SW5kZXgoIGluZGljZXMgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHZlcnRpY2VzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ25vcm1hbCcsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCBub3JtYWxzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3V2JywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHV2cywgMiApICk7CgoJCWZ1bmN0aW9uIGdlbmVyYXRlVG9yc28oKSB7CgoJCQljb25zdCBub3JtYWwgPSBuZXcgVmVjdG9yMygpOwoJCQljb25zdCB2ZXJ0ZXggPSBuZXcgVmVjdG9yMygpOwoKCQkJbGV0IGdyb3VwQ291bnQgPSAwOwoKCQkJLy8gdGhpcyB3aWxsIGJlIHVzZWQgdG8gY2FsY3VsYXRlIHRoZSBub3JtYWwKCQkJY29uc3Qgc2xvcGUgPSAoIHJhZGl1c0JvdHRvbSAtIHJhZGl1c1RvcCApIC8gaGVpZ2h0OwoKCQkJLy8gZ2VuZXJhdGUgdmVydGljZXMsIG5vcm1hbHMgYW5kIHV2cwoKCQkJZm9yICggbGV0IHkgPSAwOyB5IDw9IGhlaWdodFNlZ21lbnRzOyB5ICsrICkgewoKCQkJCWNvbnN0IGluZGV4Um93ID0gW107CgoJCQkJY29uc3QgdiA9IHkgLyBoZWlnaHRTZWdtZW50czsKCgkJCQkvLyBjYWxjdWxhdGUgdGhlIHJhZGl1cyBvZiB0aGUgY3VycmVudCByb3cKCgkJCQljb25zdCByYWRpdXMgPSB2ICogKCByYWRpdXNCb3R0b20gLSByYWRpdXNUb3AgKSArIHJhZGl1c1RvcDsKCgkJCQlmb3IgKCBsZXQgeCA9IDA7IHggPD0gcmFkaWFsU2VnbWVudHM7IHggKysgKSB7CgoJCQkJCWNvbnN0IHUgPSB4IC8gcmFkaWFsU2VnbWVudHM7CgoJCQkJCWNvbnN0IHRoZXRhID0gdSAqIHRoZXRhTGVuZ3RoICsgdGhldGFTdGFydDsKCgkJCQkJY29uc3Qgc2luVGhldGEgPSBNYXRoLnNpbiggdGhldGEgKTsKCQkJCQljb25zdCBjb3NUaGV0YSA9IE1hdGguY29zKCB0aGV0YSApOwoKCQkJCQkvLyB2ZXJ0ZXgKCgkJCQkJdmVydGV4LnggPSByYWRpdXMgKiBzaW5UaGV0YTsKCQkJCQl2ZXJ0ZXgueSA9IC0gdiAqIGhlaWdodCArIGhhbGZIZWlnaHQ7CgkJCQkJdmVydGV4LnogPSByYWRpdXMgKiBjb3NUaGV0YTsKCQkJCQl2ZXJ0aWNlcy5wdXNoKCB2ZXJ0ZXgueCwgdmVydGV4LnksIHZlcnRleC56ICk7CgoJCQkJCS8vIG5vcm1hbAoKCQkJCQlub3JtYWwuc2V0KCBzaW5UaGV0YSwgc2xvcGUsIGNvc1RoZXRhICkubm9ybWFsaXplKCk7CgkJCQkJbm9ybWFscy5wdXNoKCBub3JtYWwueCwgbm9ybWFsLnksIG5vcm1hbC56ICk7CgoJCQkJCS8vIHV2CgoJCQkJCXV2cy5wdXNoKCB1LCAxIC0gdiApOwoKCQkJCQkvLyBzYXZlIGluZGV4IG9mIHZlcnRleCBpbiByZXNwZWN0aXZlIHJvdwoKCQkJCQlpbmRleFJvdy5wdXNoKCBpbmRleCArKyApOwoKCQkJCX0KCgkJCQkvLyBub3cgc2F2ZSB2ZXJ0aWNlcyBvZiB0aGUgcm93IGluIG91ciBpbmRleCBhcnJheQoKCQkJCWluZGV4QXJyYXkucHVzaCggaW5kZXhSb3cgKTsKCgkJCX0KCgkJCS8vIGdlbmVyYXRlIGluZGljZXMKCgkJCWZvciAoIGxldCB4ID0gMDsgeCA8IHJhZGlhbFNlZ21lbnRzOyB4ICsrICkgewoKCQkJCWZvciAoIGxldCB5ID0gMDsgeSA8IGhlaWdodFNlZ21lbnRzOyB5ICsrICkgewoKCQkJCQkvLyB3ZSB1c2UgdGhlIGluZGV4IGFycmF5IHRvIGFjY2VzcyB0aGUgY29ycmVjdCBpbmRpY2VzCgoJCQkJCWNvbnN0IGEgPSBpbmRleEFycmF5WyB5IF1bIHggXTsKCQkJCQljb25zdCBiID0gaW5kZXhBcnJheVsgeSArIDEgXVsgeCBdOwoJCQkJCWNvbnN0IGMgPSBpbmRleEFycmF5WyB5ICsgMSBdWyB4ICsgMSBdOwoJCQkJCWNvbnN0IGQgPSBpbmRleEFycmF5WyB5IF1bIHggKyAxIF07CgoJCQkJCS8vIGZhY2VzCgoJCQkJCWluZGljZXMucHVzaCggYSwgYiwgZCApOwoJCQkJCWluZGljZXMucHVzaCggYiwgYywgZCApOwoKCQkJCQkvLyB1cGRhdGUgZ3JvdXAgY291bnRlcgoKCQkJCQlncm91cENvdW50ICs9IDY7CgoJCQkJfQoKCQkJfQoKCQkJLy8gYWRkIGEgZ3JvdXAgdG8gdGhlIGdlb21ldHJ5LiB0aGlzIHdpbGwgZW5zdXJlIG11bHRpIG1hdGVyaWFsIHN1cHBvcnQKCgkJCXNjb3BlLmFkZEdyb3VwKCBncm91cFN0YXJ0LCBncm91cENvdW50LCAwICk7CgoJCQkvLyBjYWxjdWxhdGUgbmV3IHN0YXJ0IHZhbHVlIGZvciBncm91cHMKCgkJCWdyb3VwU3RhcnQgKz0gZ3JvdXBDb3VudDsKCgkJfQoKCQlmdW5jdGlvbiBnZW5lcmF0ZUNhcCggdG9wICkgewoKCQkJLy8gc2F2ZSB0aGUgaW5kZXggb2YgdGhlIGZpcnN0IGNlbnRlciB2ZXJ0ZXgKCQkJY29uc3QgY2VudGVySW5kZXhTdGFydCA9IGluZGV4OwoKCQkJY29uc3QgdXYgPSBuZXcgVmVjdG9yMigpOwoJCQljb25zdCB2ZXJ0ZXggPSBuZXcgVmVjdG9yMygpOwoKCQkJbGV0IGdyb3VwQ291bnQgPSAwOwoKCQkJY29uc3QgcmFkaXVzID0gKCB0b3AgPT09IHRydWUgKSA/IHJhZGl1c1RvcCA6IHJhZGl1c0JvdHRvbTsKCQkJY29uc3Qgc2lnbiA9ICggdG9wID09PSB0cnVlICkgPyAxIDogLSAxOwoKCQkJLy8gZmlyc3Qgd2UgZ2VuZXJhdGUgdGhlIGNlbnRlciB2ZXJ0ZXggZGF0YSBvZiB0aGUgY2FwLgoJCQkvLyBiZWNhdXNlIHRoZSBnZW9tZXRyeSBuZWVkcyBvbmUgc2V0IG9mIHV2cyBwZXIgZmFjZSwKCQkJLy8gd2UgbXVzdCBnZW5lcmF0ZSBhIGNlbnRlciB2ZXJ0ZXggcGVyIGZhY2Uvc2VnbWVudAoKCQkJZm9yICggbGV0IHggPSAxOyB4IDw9IHJhZGlhbFNlZ21lbnRzOyB4ICsrICkgewoKCQkJCS8vIHZlcnRleAoKCQkJCXZlcnRpY2VzLnB1c2goIDAsIGhhbGZIZWlnaHQgKiBzaWduLCAwICk7CgoJCQkJLy8gbm9ybWFsCgoJCQkJbm9ybWFscy5wdXNoKCAwLCBzaWduLCAwICk7CgoJCQkJLy8gdXYKCgkJCQl1dnMucHVzaCggMC41LCAwLjUgKTsKCgkJCQkvLyBpbmNyZWFzZSBpbmRleAoKCQkJCWluZGV4ICsrOwoKCQkJfQoKCQkJLy8gc2F2ZSB0aGUgaW5kZXggb2YgdGhlIGxhc3QgY2VudGVyIHZlcnRleAoJCQljb25zdCBjZW50ZXJJbmRleEVuZCA9IGluZGV4OwoKCQkJLy8gbm93IHdlIGdlbmVyYXRlIHRoZSBzdXJyb3VuZGluZyB2ZXJ0aWNlcywgbm9ybWFscyBhbmQgdXZzCgoJCQlmb3IgKCBsZXQgeCA9IDA7IHggPD0gcmFkaWFsU2VnbWVudHM7IHggKysgKSB7CgoJCQkJY29uc3QgdSA9IHggLyByYWRpYWxTZWdtZW50czsKCQkJCWNvbnN0IHRoZXRhID0gdSAqIHRoZXRhTGVuZ3RoICsgdGhldGFTdGFydDsKCgkJCQljb25zdCBjb3NUaGV0YSA9IE1hdGguY29zKCB0aGV0YSApOwoJCQkJY29uc3Qgc2luVGhldGEgPSBNYXRoLnNpbiggdGhldGEgKTsKCgkJCQkvLyB2ZXJ0ZXgKCgkJCQl2ZXJ0ZXgueCA9IHJhZGl1cyAqIHNpblRoZXRhOwoJCQkJdmVydGV4LnkgPSBoYWxmSGVpZ2h0ICogc2lnbjsKCQkJCXZlcnRleC56ID0gcmFkaXVzICogY29zVGhldGE7CgkJCQl2ZXJ0aWNlcy5wdXNoKCB2ZXJ0ZXgueCwgdmVydGV4LnksIHZlcnRleC56ICk7CgoJCQkJLy8gbm9ybWFsCgoJCQkJbm9ybWFscy5wdXNoKCAwLCBzaWduLCAwICk7CgoJCQkJLy8gdXYKCgkJCQl1di54ID0gKCBjb3NUaGV0YSAqIDAuNSApICsgMC41OwoJCQkJdXYueSA9ICggc2luVGhldGEgKiAwLjUgKiBzaWduICkgKyAwLjU7CgkJCQl1dnMucHVzaCggdXYueCwgdXYueSApOwoKCQkJCS8vIGluY3JlYXNlIGluZGV4CgoJCQkJaW5kZXggKys7CgoJCQl9CgoJCQkvLyBnZW5lcmF0ZSBpbmRpY2VzCgoJCQlmb3IgKCBsZXQgeCA9IDA7IHggPCByYWRpYWxTZWdtZW50czsgeCArKyApIHsKCgkJCQljb25zdCBjID0gY2VudGVySW5kZXhTdGFydCArIHg7CgkJCQljb25zdCBpID0gY2VudGVySW5kZXhFbmQgKyB4OwoKCQkJCWlmICggdG9wID09PSB0cnVlICkgewoKCQkJCQkvLyBmYWNlIHRvcAoKCQkJCQlpbmRpY2VzLnB1c2goIGksIGkgKyAxLCBjICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJLy8gZmFjZSBib3R0b20KCgkJCQkJaW5kaWNlcy5wdXNoKCBpICsgMSwgaSwgYyApOwoKCQkJCX0KCgkJCQlncm91cENvdW50ICs9IDM7CgoJCQl9CgoJCQkvLyBhZGQgYSBncm91cCB0byB0aGUgZ2VvbWV0cnkuIHRoaXMgd2lsbCBlbnN1cmUgbXVsdGkgbWF0ZXJpYWwgc3VwcG9ydAoKCQkJc2NvcGUuYWRkR3JvdXAoIGdyb3VwU3RhcnQsIGdyb3VwQ291bnQsIHRvcCA9PT0gdHJ1ZSA/IDEgOiAyICk7CgoJCQkvLyBjYWxjdWxhdGUgbmV3IHN0YXJ0IHZhbHVlIGZvciBncm91cHMKCgkJCWdyb3VwU3RhcnQgKz0gZ3JvdXBDb3VudDsKCgkJfQoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKCB7fSwgc291cmNlLnBhcmFtZXRlcnMgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXN0YXRpYyBmcm9tSlNPTiggZGF0YSApIHsKCgkJcmV0dXJuIG5ldyBDeWxpbmRlckdlb21ldHJ5KCBkYXRhLnJhZGl1c1RvcCwgZGF0YS5yYWRpdXNCb3R0b20sIGRhdGEuaGVpZ2h0LCBkYXRhLnJhZGlhbFNlZ21lbnRzLCBkYXRhLmhlaWdodFNlZ21lbnRzLCBkYXRhLm9wZW5FbmRlZCwgZGF0YS50aGV0YVN0YXJ0LCBkYXRhLnRoZXRhTGVuZ3RoICk7CgoJfQoKfQoKY2xhc3MgQ29uZUdlb21ldHJ5IGV4dGVuZHMgQ3lsaW5kZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIHJhZGl1cyA9IDEsIGhlaWdodCA9IDEsIHJhZGlhbFNlZ21lbnRzID0gMzIsIGhlaWdodFNlZ21lbnRzID0gMSwgb3BlbkVuZGVkID0gZmFsc2UsIHRoZXRhU3RhcnQgPSAwLCB0aGV0YUxlbmd0aCA9IE1hdGguUEkgKiAyICkgewoKCQlzdXBlciggMCwgcmFkaXVzLCBoZWlnaHQsIHJhZGlhbFNlZ21lbnRzLCBoZWlnaHRTZWdtZW50cywgb3BlbkVuZGVkLCB0aGV0YVN0YXJ0LCB0aGV0YUxlbmd0aCApOwoKCQl0aGlzLnR5cGUgPSAnQ29uZUdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlyYWRpdXM6IHJhZGl1cywKCQkJaGVpZ2h0OiBoZWlnaHQsCgkJCXJhZGlhbFNlZ21lbnRzOiByYWRpYWxTZWdtZW50cywKCQkJaGVpZ2h0U2VnbWVudHM6IGhlaWdodFNlZ21lbnRzLAoJCQlvcGVuRW5kZWQ6IG9wZW5FbmRlZCwKCQkJdGhldGFTdGFydDogdGhldGFTdGFydCwKCQkJdGhldGFMZW5ndGg6IHRoZXRhTGVuZ3RoCgkJfTsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQlyZXR1cm4gbmV3IENvbmVHZW9tZXRyeSggZGF0YS5yYWRpdXMsIGRhdGEuaGVpZ2h0LCBkYXRhLnJhZGlhbFNlZ21lbnRzLCBkYXRhLmhlaWdodFNlZ21lbnRzLCBkYXRhLm9wZW5FbmRlZCwgZGF0YS50aGV0YVN0YXJ0LCBkYXRhLnRoZXRhTGVuZ3RoICk7CgoJfQoKfQoKY2xhc3MgUG9seWhlZHJvbkdlb21ldHJ5IGV4dGVuZHMgQnVmZmVyR2VvbWV0cnkgewoKCWNvbnN0cnVjdG9yKCB2ZXJ0aWNlcyA9IFtdLCBpbmRpY2VzID0gW10sIHJhZGl1cyA9IDEsIGRldGFpbCA9IDAgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMudHlwZSA9ICdQb2x5aGVkcm9uR2VvbWV0cnknOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSB7CgkJCXZlcnRpY2VzOiB2ZXJ0aWNlcywKCQkJaW5kaWNlczogaW5kaWNlcywKCQkJcmFkaXVzOiByYWRpdXMsCgkJCWRldGFpbDogZGV0YWlsCgkJfTsKCgkJLy8gZGVmYXVsdCBidWZmZXIgZGF0YQoKCQljb25zdCB2ZXJ0ZXhCdWZmZXIgPSBbXTsKCQljb25zdCB1dkJ1ZmZlciA9IFtdOwoKCQkvLyB0aGUgc3ViZGl2aXNpb24gY3JlYXRlcyB0aGUgdmVydGV4IGJ1ZmZlciBkYXRhCgoJCXN1YmRpdmlkZSggZGV0YWlsICk7CgoJCS8vIGFsbCB2ZXJ0aWNlcyBzaG91bGQgbGllIG9uIGEgY29uY2VwdHVhbCBzcGhlcmUgd2l0aCBhIGdpdmVuIHJhZGl1cwoKCQlhcHBseVJhZGl1cyggcmFkaXVzICk7CgoJCS8vIGZpbmFsbHksIGNyZWF0ZSB0aGUgdXYgZGF0YQoKCQlnZW5lcmF0ZVVWcygpOwoKCQkvLyBidWlsZCBub24taW5kZXhlZCBnZW9tZXRyeQoKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHZlcnRleEJ1ZmZlciwgMyApICk7CgkJdGhpcy5zZXRBdHRyaWJ1dGUoICdub3JtYWwnLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdmVydGV4QnVmZmVyLnNsaWNlKCksIDMgKSApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAndXYnLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdXZCdWZmZXIsIDIgKSApOwoKCQlpZiAoIGRldGFpbCA9PT0gMCApIHsKCgkJCXRoaXMuY29tcHV0ZVZlcnRleE5vcm1hbHMoKTsgLy8gZmxhdCBub3JtYWxzCgoJCX0gZWxzZSB7CgoJCQl0aGlzLm5vcm1hbGl6ZU5vcm1hbHMoKTsgLy8gc21vb3RoIG5vcm1hbHMKCgkJfQoKCQkvLyBoZWxwZXIgZnVuY3Rpb25zCgoJCWZ1bmN0aW9uIHN1YmRpdmlkZSggZGV0YWlsICkgewoKCQkJY29uc3QgYSA9IG5ldyBWZWN0b3IzKCk7CgkJCWNvbnN0IGIgPSBuZXcgVmVjdG9yMygpOwoJCQljb25zdCBjID0gbmV3IFZlY3RvcjMoKTsKCgkJCS8vIGl0ZXJhdGUgb3ZlciBhbGwgZmFjZXMgYW5kIGFwcGx5IGEgc3ViZGl2aXNpb24gd2l0aCB0aGUgZ2l2ZW4gZGV0YWlsIHZhbHVlCgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBpbmRpY2VzLmxlbmd0aDsgaSArPSAzICkgewoKCQkJCS8vIGdldCB0aGUgdmVydGljZXMgb2YgdGhlIGZhY2UKCgkJCQlnZXRWZXJ0ZXhCeUluZGV4KCBpbmRpY2VzWyBpICsgMCBdLCBhICk7CgkJCQlnZXRWZXJ0ZXhCeUluZGV4KCBpbmRpY2VzWyBpICsgMSBdLCBiICk7CgkJCQlnZXRWZXJ0ZXhCeUluZGV4KCBpbmRpY2VzWyBpICsgMiBdLCBjICk7CgoJCQkJLy8gcGVyZm9ybSBzdWJkaXZpc2lvbgoKCQkJCXN1YmRpdmlkZUZhY2UoIGEsIGIsIGMsIGRldGFpbCApOwoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIHN1YmRpdmlkZUZhY2UoIGEsIGIsIGMsIGRldGFpbCApIHsKCgkJCWNvbnN0IGNvbHMgPSBkZXRhaWwgKyAxOwoKCQkJLy8gd2UgdXNlIHRoaXMgbXVsdGlkaW1lbnNpb25hbCBhcnJheSBhcyBhIGRhdGEgc3RydWN0dXJlIGZvciBjcmVhdGluZyB0aGUgc3ViZGl2aXNpb24KCgkJCWNvbnN0IHYgPSBbXTsKCgkJCS8vIGNvbnN0cnVjdCBhbGwgb2YgdGhlIHZlcnRpY2VzIGZvciB0aGlzIHN1YmRpdmlzaW9uCgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPD0gY29sczsgaSArKyApIHsKCgkJCQl2WyBpIF0gPSBbXTsKCgkJCQljb25zdCBhaiA9IGEuY2xvbmUoKS5sZXJwKCBjLCBpIC8gY29scyApOwoJCQkJY29uc3QgYmogPSBiLmNsb25lKCkubGVycCggYywgaSAvIGNvbHMgKTsKCgkJCQljb25zdCByb3dzID0gY29scyAtIGk7CgoJCQkJZm9yICggbGV0IGogPSAwOyBqIDw9IHJvd3M7IGogKysgKSB7CgoJCQkJCWlmICggaiA9PT0gMCAmJiBpID09PSBjb2xzICkgewoKCQkJCQkJdlsgaSBdWyBqIF0gPSBhajsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXZbIGkgXVsgaiBdID0gYWouY2xvbmUoKS5sZXJwKCBiaiwgaiAvIHJvd3MgKTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJCS8vIGNvbnN0cnVjdCBhbGwgb2YgdGhlIGZhY2VzCgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBjb2xzOyBpICsrICkgewoKCQkJCWZvciAoIGxldCBqID0gMDsgaiA8IDIgKiAoIGNvbHMgLSBpICkgLSAxOyBqICsrICkgewoKCQkJCQljb25zdCBrID0gTWF0aC5mbG9vciggaiAvIDIgKTsKCgkJCQkJaWYgKCBqICUgMiA9PT0gMCApIHsKCgkJCQkJCXB1c2hWZXJ0ZXgoIHZbIGkgXVsgayArIDEgXSApOwoJCQkJCQlwdXNoVmVydGV4KCB2WyBpICsgMSBdWyBrIF0gKTsKCQkJCQkJcHVzaFZlcnRleCggdlsgaSBdWyBrIF0gKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXB1c2hWZXJ0ZXgoIHZbIGkgXVsgayArIDEgXSApOwoJCQkJCQlwdXNoVmVydGV4KCB2WyBpICsgMSBdWyBrICsgMSBdICk7CgkJCQkJCXB1c2hWZXJ0ZXgoIHZbIGkgKyAxIF1bIGsgXSApOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIGFwcGx5UmFkaXVzKCByYWRpdXMgKSB7CgoJCQljb25zdCB2ZXJ0ZXggPSBuZXcgVmVjdG9yMygpOwoKCQkJLy8gaXRlcmF0ZSBvdmVyIHRoZSBlbnRpcmUgYnVmZmVyIGFuZCBhcHBseSB0aGUgcmFkaXVzIHRvIGVhY2ggdmVydGV4CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB2ZXJ0ZXhCdWZmZXIubGVuZ3RoOyBpICs9IDMgKSB7CgoJCQkJdmVydGV4LnggPSB2ZXJ0ZXhCdWZmZXJbIGkgKyAwIF07CgkJCQl2ZXJ0ZXgueSA9IHZlcnRleEJ1ZmZlclsgaSArIDEgXTsKCQkJCXZlcnRleC56ID0gdmVydGV4QnVmZmVyWyBpICsgMiBdOwoKCQkJCXZlcnRleC5ub3JtYWxpemUoKS5tdWx0aXBseVNjYWxhciggcmFkaXVzICk7CgoJCQkJdmVydGV4QnVmZmVyWyBpICsgMCBdID0gdmVydGV4Lng7CgkJCQl2ZXJ0ZXhCdWZmZXJbIGkgKyAxIF0gPSB2ZXJ0ZXgueTsKCQkJCXZlcnRleEJ1ZmZlclsgaSArIDIgXSA9IHZlcnRleC56OwoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIGdlbmVyYXRlVVZzKCkgewoKCQkJY29uc3QgdmVydGV4ID0gbmV3IFZlY3RvcjMoKTsKCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IHZlcnRleEJ1ZmZlci5sZW5ndGg7IGkgKz0gMyApIHsKCgkJCQl2ZXJ0ZXgueCA9IHZlcnRleEJ1ZmZlclsgaSArIDAgXTsKCQkJCXZlcnRleC55ID0gdmVydGV4QnVmZmVyWyBpICsgMSBdOwoJCQkJdmVydGV4LnogPSB2ZXJ0ZXhCdWZmZXJbIGkgKyAyIF07CgoJCQkJY29uc3QgdSA9IGF6aW11dGgoIHZlcnRleCApIC8gMiAvIE1hdGguUEkgKyAwLjU7CgkJCQljb25zdCB2ID0gaW5jbGluYXRpb24oIHZlcnRleCApIC8gTWF0aC5QSSArIDAuNTsKCQkJCXV2QnVmZmVyLnB1c2goIHUsIDEgLSB2ICk7CgoJCQl9CgoJCQljb3JyZWN0VVZzKCk7CgoJCQljb3JyZWN0U2VhbSgpOwoKCQl9CgoJCWZ1bmN0aW9uIGNvcnJlY3RTZWFtKCkgewoKCQkJLy8gaGFuZGxlIGNhc2Ugd2hlbiBmYWNlIHN0cmFkZGxlcyB0aGUgc2VhbSwgc2VlICMzMjY5CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB1dkJ1ZmZlci5sZW5ndGg7IGkgKz0gNiApIHsKCgkJCQkvLyB1diBkYXRhIG9mIGEgc2luZ2xlIGZhY2UKCgkJCQljb25zdCB4MCA9IHV2QnVmZmVyWyBpICsgMCBdOwoJCQkJY29uc3QgeDEgPSB1dkJ1ZmZlclsgaSArIDIgXTsKCQkJCWNvbnN0IHgyID0gdXZCdWZmZXJbIGkgKyA0IF07CgoJCQkJY29uc3QgbWF4ID0gTWF0aC5tYXgoIHgwLCB4MSwgeDIgKTsKCQkJCWNvbnN0IG1pbiA9IE1hdGgubWluKCB4MCwgeDEsIHgyICk7CgoJCQkJLy8gMC45IGlzIHNvbWV3aGF0IGFyYml0cmFyeQoKCQkJCWlmICggbWF4ID4gMC45ICYmIG1pbiA8IDAuMSApIHsKCgkJCQkJaWYgKCB4MCA8IDAuMiApIHV2QnVmZmVyWyBpICsgMCBdICs9IDE7CgkJCQkJaWYgKCB4MSA8IDAuMiApIHV2QnVmZmVyWyBpICsgMiBdICs9IDE7CgkJCQkJaWYgKCB4MiA8IDAuMiApIHV2QnVmZmVyWyBpICsgNCBdICs9IDE7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIHB1c2hWZXJ0ZXgoIHZlcnRleCApIHsKCgkJCXZlcnRleEJ1ZmZlci5wdXNoKCB2ZXJ0ZXgueCwgdmVydGV4LnksIHZlcnRleC56ICk7CgoJCX0KCgkJZnVuY3Rpb24gZ2V0VmVydGV4QnlJbmRleCggaW5kZXgsIHZlcnRleCApIHsKCgkJCWNvbnN0IHN0cmlkZSA9IGluZGV4ICogMzsKCgkJCXZlcnRleC54ID0gdmVydGljZXNbIHN0cmlkZSArIDAgXTsKCQkJdmVydGV4LnkgPSB2ZXJ0aWNlc1sgc3RyaWRlICsgMSBdOwoJCQl2ZXJ0ZXgueiA9IHZlcnRpY2VzWyBzdHJpZGUgKyAyIF07CgoJCX0KCgkJZnVuY3Rpb24gY29ycmVjdFVWcygpIHsKCgkJCWNvbnN0IGEgPSBuZXcgVmVjdG9yMygpOwoJCQljb25zdCBiID0gbmV3IFZlY3RvcjMoKTsKCQkJY29uc3QgYyA9IG5ldyBWZWN0b3IzKCk7CgoJCQljb25zdCBjZW50cm9pZCA9IG5ldyBWZWN0b3IzKCk7CgoJCQljb25zdCB1dkEgPSBuZXcgVmVjdG9yMigpOwoJCQljb25zdCB1dkIgPSBuZXcgVmVjdG9yMigpOwoJCQljb25zdCB1dkMgPSBuZXcgVmVjdG9yMigpOwoKCQkJZm9yICggbGV0IGkgPSAwLCBqID0gMDsgaSA8IHZlcnRleEJ1ZmZlci5sZW5ndGg7IGkgKz0gOSwgaiArPSA2ICkgewoKCQkJCWEuc2V0KCB2ZXJ0ZXhCdWZmZXJbIGkgKyAwIF0sIHZlcnRleEJ1ZmZlclsgaSArIDEgXSwgdmVydGV4QnVmZmVyWyBpICsgMiBdICk7CgkJCQliLnNldCggdmVydGV4QnVmZmVyWyBpICsgMyBdLCB2ZXJ0ZXhCdWZmZXJbIGkgKyA0IF0sIHZlcnRleEJ1ZmZlclsgaSArIDUgXSApOwoJCQkJYy5zZXQoIHZlcnRleEJ1ZmZlclsgaSArIDYgXSwgdmVydGV4QnVmZmVyWyBpICsgNyBdLCB2ZXJ0ZXhCdWZmZXJbIGkgKyA4IF0gKTsKCgkJCQl1dkEuc2V0KCB1dkJ1ZmZlclsgaiArIDAgXSwgdXZCdWZmZXJbIGogKyAxIF0gKTsKCQkJCXV2Qi5zZXQoIHV2QnVmZmVyWyBqICsgMiBdLCB1dkJ1ZmZlclsgaiArIDMgXSApOwoJCQkJdXZDLnNldCggdXZCdWZmZXJbIGogKyA0IF0sIHV2QnVmZmVyWyBqICsgNSBdICk7CgoJCQkJY2VudHJvaWQuY29weSggYSApLmFkZCggYiApLmFkZCggYyApLmRpdmlkZVNjYWxhciggMyApOwoKCQkJCWNvbnN0IGF6aSA9IGF6aW11dGgoIGNlbnRyb2lkICk7CgoJCQkJY29ycmVjdFVWKCB1dkEsIGogKyAwLCBhLCBhemkgKTsKCQkJCWNvcnJlY3RVViggdXZCLCBqICsgMiwgYiwgYXppICk7CgkJCQljb3JyZWN0VVYoIHV2QywgaiArIDQsIGMsIGF6aSApOwoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIGNvcnJlY3RVViggdXYsIHN0cmlkZSwgdmVjdG9yLCBhemltdXRoICkgewoKCQkJaWYgKCAoIGF6aW11dGggPCAwICkgJiYgKCB1di54ID09PSAxICkgKSB7CgoJCQkJdXZCdWZmZXJbIHN0cmlkZSBdID0gdXYueCAtIDE7CgoJCQl9CgoJCQlpZiAoICggdmVjdG9yLnggPT09IDAgKSAmJiAoIHZlY3Rvci56ID09PSAwICkgKSB7CgoJCQkJdXZCdWZmZXJbIHN0cmlkZSBdID0gYXppbXV0aCAvIDIgLyBNYXRoLlBJICsgMC41OwoKCQkJfQoKCQl9CgoJCS8vIEFuZ2xlIGFyb3VuZCB0aGUgWSBheGlzLCBjb3VudGVyLWNsb2Nrd2lzZSB3aGVuIGxvb2tpbmcgZnJvbSBhYm92ZS4KCgkJZnVuY3Rpb24gYXppbXV0aCggdmVjdG9yICkgewoKCQkJcmV0dXJuIE1hdGguYXRhbjIoIHZlY3Rvci56LCAtIHZlY3Rvci54ICk7CgoJCX0KCgoJCS8vIEFuZ2xlIGFib3ZlIHRoZSBYWiBwbGFuZS4KCgkJZnVuY3Rpb24gaW5jbGluYXRpb24oIHZlY3RvciApIHsKCgkJCXJldHVybiBNYXRoLmF0YW4yKCAtIHZlY3Rvci55LCBNYXRoLnNxcnQoICggdmVjdG9yLnggKiB2ZWN0b3IueCApICsgKCB2ZWN0b3IueiAqIHZlY3Rvci56ICkgKSApOwoKCQl9CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oIHt9LCBzb3VyY2UucGFyYW1ldGVycyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQlyZXR1cm4gbmV3IFBvbHloZWRyb25HZW9tZXRyeSggZGF0YS52ZXJ0aWNlcywgZGF0YS5pbmRpY2VzLCBkYXRhLnJhZGl1cywgZGF0YS5kZXRhaWxzICk7CgoJfQoKfQoKY2xhc3MgRG9kZWNhaGVkcm9uR2VvbWV0cnkgZXh0ZW5kcyBQb2x5aGVkcm9uR2VvbWV0cnkgewoKCWNvbnN0cnVjdG9yKCByYWRpdXMgPSAxLCBkZXRhaWwgPSAwICkgewoKCQljb25zdCB0ID0gKCAxICsgTWF0aC5zcXJ0KCA1ICkgKSAvIDI7CgkJY29uc3QgciA9IDEgLyB0OwoKCQljb25zdCB2ZXJ0aWNlcyA9IFsKCgkJCS8vICjCsTEsIMKxMSwgwrExKQoJCQktIDEsIC0gMSwgLSAxLAktIDEsIC0gMSwgMSwKCQkJLSAxLCAxLCAtIDEsIC0gMSwgMSwgMSwKCQkJMSwgLSAxLCAtIDEsIDEsIC0gMSwgMSwKCQkJMSwgMSwgLSAxLCAxLCAxLCAxLAoKCQkJLy8gKDAsIMKxMS/PhiwgwrHPhikKCQkJMCwgLSByLCAtIHQsIDAsIC0gciwgdCwKCQkJMCwgciwgLSB0LCAwLCByLCB0LAoKCQkJLy8gKMKxMS/PhiwgwrHPhiwgMCkKCQkJLSByLCAtIHQsIDAsIC0gciwgdCwgMCwKCQkJciwgLSB0LCAwLCByLCB0LCAwLAoKCQkJLy8gKMKxz4YsIDAsIMKxMS/PhikKCQkJLSB0LCAwLCAtIHIsIHQsIDAsIC0gciwKCQkJLSB0LCAwLCByLCB0LCAwLCByCgkJXTsKCgkJY29uc3QgaW5kaWNlcyA9IFsKCQkJMywgMTEsIDcsIAkzLCA3LCAxNSwgCTMsIDE1LCAxMywKCQkJNywgMTksIDE3LCAJNywgMTcsIDYsIAk3LCA2LCAxNSwKCQkJMTcsIDQsIDgsIAkxNywgOCwgMTAsIAkxNywgMTAsIDYsCgkJCTgsIDAsIDE2LCAJOCwgMTYsIDIsIAk4LCAyLCAxMCwKCQkJMCwgMTIsIDEsIAkwLCAxLCAxOCwgCTAsIDE4LCAxNiwKCQkJNiwgMTAsIDIsIAk2LCAyLCAxMywgCTYsIDEzLCAxNSwKCQkJMiwgMTYsIDE4LCAJMiwgMTgsIDMsIAkyLCAzLCAxMywKCQkJMTgsIDEsIDksIAkxOCwgOSwgMTEsIAkxOCwgMTEsIDMsCgkJCTQsIDE0LCAxMiwgCTQsIDEyLCAwLCAJNCwgMCwgOCwKCQkJMTEsIDksIDUsIAkxMSwgNSwgMTksIAkxMSwgMTksIDcsCgkJCTE5LCA1LCAxNCwgCTE5LCAxNCwgNCwgCTE5LCA0LCAxNywKCQkJMSwgMTIsIDE0LCAJMSwgMTQsIDUsIAkxLCA1LCA5CgkJXTsKCgkJc3VwZXIoIHZlcnRpY2VzLCBpbmRpY2VzLCByYWRpdXMsIGRldGFpbCApOwoKCQl0aGlzLnR5cGUgPSAnRG9kZWNhaGVkcm9uR2VvbWV0cnknOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSB7CgkJCXJhZGl1czogcmFkaXVzLAoJCQlkZXRhaWw6IGRldGFpbAoJCX07CgoJfQoKCXN0YXRpYyBmcm9tSlNPTiggZGF0YSApIHsKCgkJcmV0dXJuIG5ldyBEb2RlY2FoZWRyb25HZW9tZXRyeSggZGF0YS5yYWRpdXMsIGRhdGEuZGV0YWlsICk7CgoJfQoKfQoKY29uc3QgX3YwID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfdjEkMSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX25vcm1hbCA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3RyaWFuZ2xlID0gLypAX19QVVJFX18qLyBuZXcgVHJpYW5nbGUoKTsKCmNsYXNzIEVkZ2VzR2VvbWV0cnkgZXh0ZW5kcyBCdWZmZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIGdlb21ldHJ5ID0gbnVsbCwgdGhyZXNob2xkQW5nbGUgPSAxICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnRWRnZXNHZW9tZXRyeSc7CgoJCXRoaXMucGFyYW1ldGVycyA9IHsKCQkJZ2VvbWV0cnk6IGdlb21ldHJ5LAoJCQl0aHJlc2hvbGRBbmdsZTogdGhyZXNob2xkQW5nbGUKCQl9OwoKCQlpZiAoIGdlb21ldHJ5ICE9PSBudWxsICkgewoKCQkJY29uc3QgcHJlY2lzaW9uUG9pbnRzID0gNDsKCQkJY29uc3QgcHJlY2lzaW9uID0gTWF0aC5wb3coIDEwLCBwcmVjaXNpb25Qb2ludHMgKTsKCQkJY29uc3QgdGhyZXNob2xkRG90ID0gTWF0aC5jb3MoIERFRzJSQUQgKiB0aHJlc2hvbGRBbmdsZSApOwoKCQkJY29uc3QgaW5kZXhBdHRyID0gZ2VvbWV0cnkuZ2V0SW5kZXgoKTsKCQkJY29uc3QgcG9zaXRpb25BdHRyID0gZ2VvbWV0cnkuZ2V0QXR0cmlidXRlKCAncG9zaXRpb24nICk7CgkJCWNvbnN0IGluZGV4Q291bnQgPSBpbmRleEF0dHIgPyBpbmRleEF0dHIuY291bnQgOiBwb3NpdGlvbkF0dHIuY291bnQ7CgoJCQljb25zdCBpbmRleEFyciA9IFsgMCwgMCwgMCBdOwoJCQljb25zdCB2ZXJ0S2V5cyA9IFsgJ2EnLCAnYicsICdjJyBdOwoJCQljb25zdCBoYXNoZXMgPSBuZXcgQXJyYXkoIDMgKTsKCgkJCWNvbnN0IGVkZ2VEYXRhID0ge307CgkJCWNvbnN0IHZlcnRpY2VzID0gW107CgkJCWZvciAoIGxldCBpID0gMDsgaSA8IGluZGV4Q291bnQ7IGkgKz0gMyApIHsKCgkJCQlpZiAoIGluZGV4QXR0ciApIHsKCgkJCQkJaW5kZXhBcnJbIDAgXSA9IGluZGV4QXR0ci5nZXRYKCBpICk7CgkJCQkJaW5kZXhBcnJbIDEgXSA9IGluZGV4QXR0ci5nZXRYKCBpICsgMSApOwoJCQkJCWluZGV4QXJyWyAyIF0gPSBpbmRleEF0dHIuZ2V0WCggaSArIDIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpbmRleEFyclsgMCBdID0gaTsKCQkJCQlpbmRleEFyclsgMSBdID0gaSArIDE7CgkJCQkJaW5kZXhBcnJbIDIgXSA9IGkgKyAyOwoKCQkJCX0KCgkJCQljb25zdCB7IGEsIGIsIGMgfSA9IF90cmlhbmdsZTsKCQkJCWEuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb25BdHRyLCBpbmRleEFyclsgMCBdICk7CgkJCQliLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uQXR0ciwgaW5kZXhBcnJbIDEgXSApOwoJCQkJYy5mcm9tQnVmZmVyQXR0cmlidXRlKCBwb3NpdGlvbkF0dHIsIGluZGV4QXJyWyAyIF0gKTsKCQkJCV90cmlhbmdsZS5nZXROb3JtYWwoIF9ub3JtYWwgKTsKCgkJCQkvLyBjcmVhdGUgaGFzaGVzIGZvciB0aGUgZWRnZSBmcm9tIHRoZSB2ZXJ0aWNlcwoJCQkJaGFzaGVzWyAwIF0gPSBgJHsgTWF0aC5yb3VuZCggYS54ICogcHJlY2lzaW9uICkgfSwkeyBNYXRoLnJvdW5kKCBhLnkgKiBwcmVjaXNpb24gKSB9LCR7IE1hdGgucm91bmQoIGEueiAqIHByZWNpc2lvbiApIH1gOwoJCQkJaGFzaGVzWyAxIF0gPSBgJHsgTWF0aC5yb3VuZCggYi54ICogcHJlY2lzaW9uICkgfSwkeyBNYXRoLnJvdW5kKCBiLnkgKiBwcmVjaXNpb24gKSB9LCR7IE1hdGgucm91bmQoIGIueiAqIHByZWNpc2lvbiApIH1gOwoJCQkJaGFzaGVzWyAyIF0gPSBgJHsgTWF0aC5yb3VuZCggYy54ICogcHJlY2lzaW9uICkgfSwkeyBNYXRoLnJvdW5kKCBjLnkgKiBwcmVjaXNpb24gKSB9LCR7IE1hdGgucm91bmQoIGMueiAqIHByZWNpc2lvbiApIH1gOwoKCQkJCS8vIHNraXAgZGVnZW5lcmF0ZSB0cmlhbmdsZXMKCQkJCWlmICggaGFzaGVzWyAwIF0gPT09IGhhc2hlc1sgMSBdIHx8IGhhc2hlc1sgMSBdID09PSBoYXNoZXNbIDIgXSB8fCBoYXNoZXNbIDIgXSA9PT0gaGFzaGVzWyAwIF0gKSB7CgoJCQkJCWNvbnRpbnVlOwoKCQkJCX0KCgkJCQkvLyBpdGVyYXRlIG92ZXIgZXZlcnkgZWRnZQoJCQkJZm9yICggbGV0IGogPSAwOyBqIDwgMzsgaiArKyApIHsKCgkJCQkJLy8gZ2V0IHRoZSBmaXJzdCBhbmQgbmV4dCB2ZXJ0ZXggbWFraW5nIHVwIHRoZSBlZGdlCgkJCQkJY29uc3Qgak5leHQgPSAoIGogKyAxICkgJSAzOwoJCQkJCWNvbnN0IHZlY0hhc2gwID0gaGFzaGVzWyBqIF07CgkJCQkJY29uc3QgdmVjSGFzaDEgPSBoYXNoZXNbIGpOZXh0IF07CgkJCQkJY29uc3QgdjAgPSBfdHJpYW5nbGVbIHZlcnRLZXlzWyBqIF0gXTsKCQkJCQljb25zdCB2MSA9IF90cmlhbmdsZVsgdmVydEtleXNbIGpOZXh0IF0gXTsKCgkJCQkJY29uc3QgaGFzaCA9IGAkeyB2ZWNIYXNoMCB9XyR7IHZlY0hhc2gxIH1gOwoJCQkJCWNvbnN0IHJldmVyc2VIYXNoID0gYCR7IHZlY0hhc2gxIH1fJHsgdmVjSGFzaDAgfWA7CgoJCQkJCWlmICggcmV2ZXJzZUhhc2ggaW4gZWRnZURhdGEgJiYgZWRnZURhdGFbIHJldmVyc2VIYXNoIF0gKSB7CgoJCQkJCQkvLyBpZiB3ZSBmb3VuZCBhIHNpYmxpbmcgZWRnZSBhZGQgaXQgaW50byB0aGUgdmVydGV4IGFycmF5IGlmCgkJCQkJCS8vIGl0IG1lZXRzIHRoZSBhbmdsZSB0aHJlc2hvbGQgYW5kIGRlbGV0ZSB0aGUgZWRnZSBmcm9tIHRoZSBtYXAuCgkJCQkJCWlmICggX25vcm1hbC5kb3QoIGVkZ2VEYXRhWyByZXZlcnNlSGFzaCBdLm5vcm1hbCApIDw9IHRocmVzaG9sZERvdCApIHsKCgkJCQkJCQl2ZXJ0aWNlcy5wdXNoKCB2MC54LCB2MC55LCB2MC56ICk7CgkJCQkJCQl2ZXJ0aWNlcy5wdXNoKCB2MS54LCB2MS55LCB2MS56ICk7CgoJCQkJCQl9CgoJCQkJCQllZGdlRGF0YVsgcmV2ZXJzZUhhc2ggXSA9IG51bGw7CgoJCQkJCX0gZWxzZSBpZiAoICEgKCBoYXNoIGluIGVkZ2VEYXRhICkgKSB7CgoJCQkJCQkvLyBpZiB3ZSd2ZSBhbHJlYWR5IGdvdCBhbiBlZGdlIGhlcmUgdGhlbiBza2lwIGFkZGluZyBhIG5ldyBvbmUKCQkJCQkJZWRnZURhdGFbIGhhc2ggXSA9IHsKCgkJCQkJCQlpbmRleDA6IGluZGV4QXJyWyBqIF0sCgkJCQkJCQlpbmRleDE6IGluZGV4QXJyWyBqTmV4dCBdLAoJCQkJCQkJbm9ybWFsOiBfbm9ybWFsLmNsb25lKCksCgoJCQkJCQl9OwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQkJLy8gaXRlcmF0ZSBvdmVyIGFsbCByZW1haW5pbmcsIHVubWF0Y2hlZCBlZGdlcyBhbmQgYWRkIHRoZW0gdG8gdGhlIHZlcnRleCBhcnJheQoJCQlmb3IgKCBjb25zdCBrZXkgaW4gZWRnZURhdGEgKSB7CgoJCQkJaWYgKCBlZGdlRGF0YVsga2V5IF0gKSB7CgoJCQkJCWNvbnN0IHsgaW5kZXgwLCBpbmRleDEgfSA9IGVkZ2VEYXRhWyBrZXkgXTsKCQkJCQlfdjAuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb25BdHRyLCBpbmRleDAgKTsKCQkJCQlfdjEkMS5mcm9tQnVmZmVyQXR0cmlidXRlKCBwb3NpdGlvbkF0dHIsIGluZGV4MSApOwoKCQkJCQl2ZXJ0aWNlcy5wdXNoKCBfdjAueCwgX3YwLnksIF92MC56ICk7CgkJCQkJdmVydGljZXMucHVzaCggX3YxJDEueCwgX3YxJDEueSwgX3YxJDEueiApOwoKCQkJCX0KCgkJCX0KCgkJCXRoaXMuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdmVydGljZXMsIDMgKSApOwoKCQl9CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oIHt9LCBzb3VyY2UucGFyYW1ldGVycyApOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBTaGFwZSBleHRlbmRzIFBhdGggewoKCWNvbnN0cnVjdG9yKCBwb2ludHMgKSB7CgoJCXN1cGVyKCBwb2ludHMgKTsKCgkJdGhpcy51dWlkID0gZ2VuZXJhdGVVVUlEKCk7CgoJCXRoaXMudHlwZSA9ICdTaGFwZSc7CgoJCXRoaXMuaG9sZXMgPSBbXTsKCgl9CgoJZ2V0UG9pbnRzSG9sZXMoIGRpdmlzaW9ucyApIHsKCgkJY29uc3QgaG9sZXNQdHMgPSBbXTsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gdGhpcy5ob2xlcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJaG9sZXNQdHNbIGkgXSA9IHRoaXMuaG9sZXNbIGkgXS5nZXRQb2ludHMoIGRpdmlzaW9ucyApOwoKCQl9CgoJCXJldHVybiBob2xlc1B0czsKCgl9CgoJLy8gZ2V0IHBvaW50cyBvZiBzaGFwZSBhbmQgaG9sZXMgKGtleXBvaW50cyBiYXNlZCBvbiBzZWdtZW50cyBwYXJhbWV0ZXIpCgoJZXh0cmFjdFBvaW50cyggZGl2aXNpb25zICkgewoKCQlyZXR1cm4gewoKCQkJc2hhcGU6IHRoaXMuZ2V0UG9pbnRzKCBkaXZpc2lvbnMgKSwKCQkJaG9sZXM6IHRoaXMuZ2V0UG9pbnRzSG9sZXMoIGRpdmlzaW9ucyApCgoJCX07CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuaG9sZXMgPSBbXTsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gc291cmNlLmhvbGVzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljb25zdCBob2xlID0gc291cmNlLmhvbGVzWyBpIF07CgoJCQl0aGlzLmhvbGVzLnB1c2goIGhvbGUuY2xvbmUoKSApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0pTT04oKSB7CgoJCWNvbnN0IGRhdGEgPSBzdXBlci50b0pTT04oKTsKCgkJZGF0YS51dWlkID0gdGhpcy51dWlkOwoJCWRhdGEuaG9sZXMgPSBbXTsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gdGhpcy5ob2xlcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3QgaG9sZSA9IHRoaXMuaG9sZXNbIGkgXTsKCQkJZGF0YS5ob2xlcy5wdXNoKCBob2xlLnRvSlNPTigpICk7CgoJCX0KCgkJcmV0dXJuIGRhdGE7CgoJfQoKCWZyb21KU09OKCBqc29uICkgewoKCQlzdXBlci5mcm9tSlNPTigganNvbiApOwoKCQl0aGlzLnV1aWQgPSBqc29uLnV1aWQ7CgkJdGhpcy5ob2xlcyA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBqc29uLmhvbGVzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQljb25zdCBob2xlID0ganNvbi5ob2xlc1sgaSBdOwoJCQl0aGlzLmhvbGVzLnB1c2goIG5ldyBQYXRoKCkuZnJvbUpTT04oIGhvbGUgKSApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCi8qKgogKiBQb3J0IGZyb20gaHR0cHM6Ly9naXRodWIuY29tL21hcGJveC9lYXJjdXQgKHYyLjIuNCkKICovCgpjb25zdCBFYXJjdXQgPSB7CgoJdHJpYW5ndWxhdGU6IGZ1bmN0aW9uICggZGF0YSwgaG9sZUluZGljZXMsIGRpbSA9IDIgKSB7CgoJCWNvbnN0IGhhc0hvbGVzID0gaG9sZUluZGljZXMgJiYgaG9sZUluZGljZXMubGVuZ3RoOwoJCWNvbnN0IG91dGVyTGVuID0gaGFzSG9sZXMgPyBob2xlSW5kaWNlc1sgMCBdICogZGltIDogZGF0YS5sZW5ndGg7CgkJbGV0IG91dGVyTm9kZSA9IGxpbmtlZExpc3QoIGRhdGEsIDAsIG91dGVyTGVuLCBkaW0sIHRydWUgKTsKCQljb25zdCB0cmlhbmdsZXMgPSBbXTsKCgkJaWYgKCAhIG91dGVyTm9kZSB8fCBvdXRlck5vZGUubmV4dCA9PT0gb3V0ZXJOb2RlLnByZXYgKSByZXR1cm4gdHJpYW5nbGVzOwoKCQlsZXQgbWluWCwgbWluWSwgbWF4WCwgbWF4WSwgeCwgeSwgaW52U2l6ZTsKCgkJaWYgKCBoYXNIb2xlcyApIG91dGVyTm9kZSA9IGVsaW1pbmF0ZUhvbGVzKCBkYXRhLCBob2xlSW5kaWNlcywgb3V0ZXJOb2RlLCBkaW0gKTsKCgkJLy8gaWYgdGhlIHNoYXBlIGlzIG5vdCB0b28gc2ltcGxlLCB3ZSdsbCB1c2Ugei1vcmRlciBjdXJ2ZSBoYXNoIGxhdGVyOyBjYWxjdWxhdGUgcG9seWdvbiBiYm94CgkJaWYgKCBkYXRhLmxlbmd0aCA+IDgwICogZGltICkgewoKCQkJbWluWCA9IG1heFggPSBkYXRhWyAwIF07CgkJCW1pblkgPSBtYXhZID0gZGF0YVsgMSBdOwoKCQkJZm9yICggbGV0IGkgPSBkaW07IGkgPCBvdXRlckxlbjsgaSArPSBkaW0gKSB7CgoJCQkJeCA9IGRhdGFbIGkgXTsKCQkJCXkgPSBkYXRhWyBpICsgMSBdOwoJCQkJaWYgKCB4IDwgbWluWCApIG1pblggPSB4OwoJCQkJaWYgKCB5IDwgbWluWSApIG1pblkgPSB5OwoJCQkJaWYgKCB4ID4gbWF4WCApIG1heFggPSB4OwoJCQkJaWYgKCB5ID4gbWF4WSApIG1heFkgPSB5OwoKCQkJfQoKCQkJLy8gbWluWCwgbWluWSBhbmQgaW52U2l6ZSBhcmUgbGF0ZXIgdXNlZCB0byB0cmFuc2Zvcm0gY29vcmRzIGludG8gaW50ZWdlcnMgZm9yIHotb3JkZXIgY2FsY3VsYXRpb24KCQkJaW52U2l6ZSA9IE1hdGgubWF4KCBtYXhYIC0gbWluWCwgbWF4WSAtIG1pblkgKTsKCQkJaW52U2l6ZSA9IGludlNpemUgIT09IDAgPyAzMjc2NyAvIGludlNpemUgOiAwOwoKCQl9CgoJCWVhcmN1dExpbmtlZCggb3V0ZXJOb2RlLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgMCApOwoKCQlyZXR1cm4gdHJpYW5nbGVzOwoKCX0KCn07CgovLyBjcmVhdGUgYSBjaXJjdWxhciBkb3VibHkgbGlua2VkIGxpc3QgZnJvbSBwb2x5Z29uIHBvaW50cyBpbiB0aGUgc3BlY2lmaWVkIHdpbmRpbmcgb3JkZXIKZnVuY3Rpb24gbGlua2VkTGlzdCggZGF0YSwgc3RhcnQsIGVuZCwgZGltLCBjbG9ja3dpc2UgKSB7CgoJbGV0IGksIGxhc3Q7CgoJaWYgKCBjbG9ja3dpc2UgPT09ICggc2lnbmVkQXJlYSggZGF0YSwgc3RhcnQsIGVuZCwgZGltICkgPiAwICkgKSB7CgoJCWZvciAoIGkgPSBzdGFydDsgaSA8IGVuZDsgaSArPSBkaW0gKSBsYXN0ID0gaW5zZXJ0Tm9kZSggaSwgZGF0YVsgaSBdLCBkYXRhWyBpICsgMSBdLCBsYXN0ICk7CgoJfSBlbHNlIHsKCgkJZm9yICggaSA9IGVuZCAtIGRpbTsgaSA+PSBzdGFydDsgaSAtPSBkaW0gKSBsYXN0ID0gaW5zZXJ0Tm9kZSggaSwgZGF0YVsgaSBdLCBkYXRhWyBpICsgMSBdLCBsYXN0ICk7CgoJfQoKCWlmICggbGFzdCAmJiBlcXVhbHMoIGxhc3QsIGxhc3QubmV4dCApICkgewoKCQlyZW1vdmVOb2RlKCBsYXN0ICk7CgkJbGFzdCA9IGxhc3QubmV4dDsKCgl9CgoJcmV0dXJuIGxhc3Q7Cgp9CgovLyBlbGltaW5hdGUgY29saW5lYXIgb3IgZHVwbGljYXRlIHBvaW50cwpmdW5jdGlvbiBmaWx0ZXJQb2ludHMoIHN0YXJ0LCBlbmQgKSB7CgoJaWYgKCAhIHN0YXJ0ICkgcmV0dXJuIHN0YXJ0OwoJaWYgKCAhIGVuZCApIGVuZCA9IHN0YXJ0OwoKCWxldCBwID0gc3RhcnQsCgkJYWdhaW47CglkbyB7CgoJCWFnYWluID0gZmFsc2U7CgoJCWlmICggISBwLnN0ZWluZXIgJiYgKCBlcXVhbHMoIHAsIHAubmV4dCApIHx8IGFyZWEoIHAucHJldiwgcCwgcC5uZXh0ICkgPT09IDAgKSApIHsKCgkJCXJlbW92ZU5vZGUoIHAgKTsKCQkJcCA9IGVuZCA9IHAucHJldjsKCQkJaWYgKCBwID09PSBwLm5leHQgKSBicmVhazsKCQkJYWdhaW4gPSB0cnVlOwoKCQl9IGVsc2UgewoKCQkJcCA9IHAubmV4dDsKCgkJfQoKCX0gd2hpbGUgKCBhZ2FpbiB8fCBwICE9PSBlbmQgKTsKCglyZXR1cm4gZW5kOwoKfQoKLy8gbWFpbiBlYXIgc2xpY2luZyBsb29wIHdoaWNoIHRyaWFuZ3VsYXRlcyBhIHBvbHlnb24gKGdpdmVuIGFzIGEgbGlua2VkIGxpc3QpCmZ1bmN0aW9uIGVhcmN1dExpbmtlZCggZWFyLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgcGFzcyApIHsKCglpZiAoICEgZWFyICkgcmV0dXJuOwoKCS8vIGludGVybGluayBwb2x5Z29uIG5vZGVzIGluIHotb3JkZXIKCWlmICggISBwYXNzICYmIGludlNpemUgKSBpbmRleEN1cnZlKCBlYXIsIG1pblgsIG1pblksIGludlNpemUgKTsKCglsZXQgc3RvcCA9IGVhciwKCQlwcmV2LCBuZXh0OwoKCS8vIGl0ZXJhdGUgdGhyb3VnaCBlYXJzLCBzbGljaW5nIHRoZW0gb25lIGJ5IG9uZQoJd2hpbGUgKCBlYXIucHJldiAhPT0gZWFyLm5leHQgKSB7CgoJCXByZXYgPSBlYXIucHJldjsKCQluZXh0ID0gZWFyLm5leHQ7CgoJCWlmICggaW52U2l6ZSA/IGlzRWFySGFzaGVkKCBlYXIsIG1pblgsIG1pblksIGludlNpemUgKSA6IGlzRWFyKCBlYXIgKSApIHsKCgkJCS8vIGN1dCBvZmYgdGhlIHRyaWFuZ2xlCgkJCXRyaWFuZ2xlcy5wdXNoKCBwcmV2LmkgLyBkaW0gfCAwICk7CgkJCXRyaWFuZ2xlcy5wdXNoKCBlYXIuaSAvIGRpbSB8IDAgKTsKCQkJdHJpYW5nbGVzLnB1c2goIG5leHQuaSAvIGRpbSB8IDAgKTsKCgkJCXJlbW92ZU5vZGUoIGVhciApOwoKCQkJLy8gc2tpcHBpbmcgdGhlIG5leHQgdmVydGV4IGxlYWRzIHRvIGxlc3Mgc2xpdmVyIHRyaWFuZ2xlcwoJCQllYXIgPSBuZXh0Lm5leHQ7CgkJCXN0b3AgPSBuZXh0Lm5leHQ7CgoJCQljb250aW51ZTsKCgkJfQoKCQllYXIgPSBuZXh0OwoKCQkvLyBpZiB3ZSBsb29wZWQgdGhyb3VnaCB0aGUgd2hvbGUgcmVtYWluaW5nIHBvbHlnb24gYW5kIGNhbid0IGZpbmQgYW55IG1vcmUgZWFycwoJCWlmICggZWFyID09PSBzdG9wICkgewoKCQkJLy8gdHJ5IGZpbHRlcmluZyBwb2ludHMgYW5kIHNsaWNpbmcgYWdhaW4KCQkJaWYgKCAhIHBhc3MgKSB7CgoJCQkJZWFyY3V0TGlua2VkKCBmaWx0ZXJQb2ludHMoIGVhciApLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSwgMSApOwoKCQkJCS8vIGlmIHRoaXMgZGlkbid0IHdvcmssIHRyeSBjdXJpbmcgYWxsIHNtYWxsIHNlbGYtaW50ZXJzZWN0aW9ucyBsb2NhbGx5CgoJCQl9IGVsc2UgaWYgKCBwYXNzID09PSAxICkgewoKCQkJCWVhciA9IGN1cmVMb2NhbEludGVyc2VjdGlvbnMoIGZpbHRlclBvaW50cyggZWFyICksIHRyaWFuZ2xlcywgZGltICk7CgkJCQllYXJjdXRMaW5rZWQoIGVhciwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDIgKTsKCgkJCQkvLyBhcyBhIGxhc3QgcmVzb3J0LCB0cnkgc3BsaXR0aW5nIHRoZSByZW1haW5pbmcgcG9seWdvbiBpbnRvIHR3bwoKCQkJfSBlbHNlIGlmICggcGFzcyA9PT0gMiApIHsKCgkJCQlzcGxpdEVhcmN1dCggZWFyLCB0cmlhbmdsZXMsIGRpbSwgbWluWCwgbWluWSwgaW52U2l6ZSApOwoKCQkJfQoKCQkJYnJlYWs7CgoJCX0KCgl9Cgp9CgovLyBjaGVjayB3aGV0aGVyIGEgcG9seWdvbiBub2RlIGZvcm1zIGEgdmFsaWQgZWFyIHdpdGggYWRqYWNlbnQgbm9kZXMKZnVuY3Rpb24gaXNFYXIoIGVhciApIHsKCgljb25zdCBhID0gZWFyLnByZXYsCgkJYiA9IGVhciwKCQljID0gZWFyLm5leHQ7CgoJaWYgKCBhcmVhKCBhLCBiLCBjICkgPj0gMCApIHJldHVybiBmYWxzZTsgLy8gcmVmbGV4LCBjYW4ndCBiZSBhbiBlYXIKCgkvLyBub3cgbWFrZSBzdXJlIHdlIGRvbid0IGhhdmUgb3RoZXIgcG9pbnRzIGluc2lkZSB0aGUgcG90ZW50aWFsIGVhcgoJY29uc3QgYXggPSBhLngsIGJ4ID0gYi54LCBjeCA9IGMueCwgYXkgPSBhLnksIGJ5ID0gYi55LCBjeSA9IGMueTsKCgkvLyB0cmlhbmdsZSBiYm94OyBtaW4gJiBtYXggYXJlIGNhbGN1bGF0ZWQgbGlrZSB0aGlzIGZvciBzcGVlZAoJY29uc3QgeDAgPSBheCA8IGJ4ID8gKCBheCA8IGN4ID8gYXggOiBjeCApIDogKCBieCA8IGN4ID8gYnggOiBjeCApLAoJCXkwID0gYXkgPCBieSA/ICggYXkgPCBjeSA/IGF5IDogY3kgKSA6ICggYnkgPCBjeSA/IGJ5IDogY3kgKSwKCQl4MSA9IGF4ID4gYnggPyAoIGF4ID4gY3ggPyBheCA6IGN4ICkgOiAoIGJ4ID4gY3ggPyBieCA6IGN4ICksCgkJeTEgPSBheSA+IGJ5ID8gKCBheSA+IGN5ID8gYXkgOiBjeSApIDogKCBieSA+IGN5ID8gYnkgOiBjeSApOwoKCWxldCBwID0gYy5uZXh0OwoJd2hpbGUgKCBwICE9PSBhICkgewoKCQlpZiAoIHAueCA+PSB4MCAmJiBwLnggPD0geDEgJiYgcC55ID49IHkwICYmIHAueSA8PSB5MSAmJgoJCQlwb2ludEluVHJpYW5nbGUoIGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHAueCwgcC55ICkgJiYKCQkJYXJlYSggcC5wcmV2LCBwLCBwLm5leHQgKSA+PSAwICkgcmV0dXJuIGZhbHNlOwoJCXAgPSBwLm5leHQ7CgoJfQoKCXJldHVybiB0cnVlOwoKfQoKZnVuY3Rpb24gaXNFYXJIYXNoZWQoIGVhciwgbWluWCwgbWluWSwgaW52U2l6ZSApIHsKCgljb25zdCBhID0gZWFyLnByZXYsCgkJYiA9IGVhciwKCQljID0gZWFyLm5leHQ7CgoJaWYgKCBhcmVhKCBhLCBiLCBjICkgPj0gMCApIHJldHVybiBmYWxzZTsgLy8gcmVmbGV4LCBjYW4ndCBiZSBhbiBlYXIKCgljb25zdCBheCA9IGEueCwgYnggPSBiLngsIGN4ID0gYy54LCBheSA9IGEueSwgYnkgPSBiLnksIGN5ID0gYy55OwoKCS8vIHRyaWFuZ2xlIGJib3g7IG1pbiAmIG1heCBhcmUgY2FsY3VsYXRlZCBsaWtlIHRoaXMgZm9yIHNwZWVkCgljb25zdCB4MCA9IGF4IDwgYnggPyAoIGF4IDwgY3ggPyBheCA6IGN4ICkgOiAoIGJ4IDwgY3ggPyBieCA6IGN4ICksCgkJeTAgPSBheSA8IGJ5ID8gKCBheSA8IGN5ID8gYXkgOiBjeSApIDogKCBieSA8IGN5ID8gYnkgOiBjeSApLAoJCXgxID0gYXggPiBieCA/ICggYXggPiBjeCA/IGF4IDogY3ggKSA6ICggYnggPiBjeCA/IGJ4IDogY3ggKSwKCQl5MSA9IGF5ID4gYnkgPyAoIGF5ID4gY3kgPyBheSA6IGN5ICkgOiAoIGJ5ID4gY3kgPyBieSA6IGN5ICk7CgoJLy8gei1vcmRlciByYW5nZSBmb3IgdGhlIGN1cnJlbnQgdHJpYW5nbGUgYmJveDsKCWNvbnN0IG1pblogPSB6T3JkZXIoIHgwLCB5MCwgbWluWCwgbWluWSwgaW52U2l6ZSApLAoJCW1heFogPSB6T3JkZXIoIHgxLCB5MSwgbWluWCwgbWluWSwgaW52U2l6ZSApOwoKCWxldCBwID0gZWFyLnByZXZaLAoJCW4gPSBlYXIubmV4dFo7CgoJLy8gbG9vayBmb3IgcG9pbnRzIGluc2lkZSB0aGUgdHJpYW5nbGUgaW4gYm90aCBkaXJlY3Rpb25zCgl3aGlsZSAoIHAgJiYgcC56ID49IG1pblogJiYgbiAmJiBuLnogPD0gbWF4WiApIHsKCgkJaWYgKCBwLnggPj0geDAgJiYgcC54IDw9IHgxICYmIHAueSA+PSB5MCAmJiBwLnkgPD0geTEgJiYgcCAhPT0gYSAmJiBwICE9PSBjICYmCgkJCXBvaW50SW5UcmlhbmdsZSggYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgcC54LCBwLnkgKSAmJiBhcmVhKCBwLnByZXYsIHAsIHAubmV4dCApID49IDAgKSByZXR1cm4gZmFsc2U7CgkJcCA9IHAucHJldlo7CgoJCWlmICggbi54ID49IHgwICYmIG4ueCA8PSB4MSAmJiBuLnkgPj0geTAgJiYgbi55IDw9IHkxICYmIG4gIT09IGEgJiYgbiAhPT0gYyAmJgoJCQlwb2ludEluVHJpYW5nbGUoIGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIG4ueCwgbi55ICkgJiYgYXJlYSggbi5wcmV2LCBuLCBuLm5leHQgKSA+PSAwICkgcmV0dXJuIGZhbHNlOwoJCW4gPSBuLm5leHRaOwoKCX0KCgkvLyBsb29rIGZvciByZW1haW5pbmcgcG9pbnRzIGluIGRlY3JlYXNpbmcgei1vcmRlcgoJd2hpbGUgKCBwICYmIHAueiA+PSBtaW5aICkgewoKCQlpZiAoIHAueCA+PSB4MCAmJiBwLnggPD0geDEgJiYgcC55ID49IHkwICYmIHAueSA8PSB5MSAmJiBwICE9PSBhICYmIHAgIT09IGMgJiYKCQkJcG9pbnRJblRyaWFuZ2xlKCBheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBwLngsIHAueSApICYmIGFyZWEoIHAucHJldiwgcCwgcC5uZXh0ICkgPj0gMCApIHJldHVybiBmYWxzZTsKCQlwID0gcC5wcmV2WjsKCgl9CgoJLy8gbG9vayBmb3IgcmVtYWluaW5nIHBvaW50cyBpbiBpbmNyZWFzaW5nIHotb3JkZXIKCXdoaWxlICggbiAmJiBuLnogPD0gbWF4WiApIHsKCgkJaWYgKCBuLnggPj0geDAgJiYgbi54IDw9IHgxICYmIG4ueSA+PSB5MCAmJiBuLnkgPD0geTEgJiYgbiAhPT0gYSAmJiBuICE9PSBjICYmCgkJCXBvaW50SW5UcmlhbmdsZSggYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgbi54LCBuLnkgKSAmJiBhcmVhKCBuLnByZXYsIG4sIG4ubmV4dCApID49IDAgKSByZXR1cm4gZmFsc2U7CgkJbiA9IG4ubmV4dFo7CgoJfQoKCXJldHVybiB0cnVlOwoKfQoKLy8gZ28gdGhyb3VnaCBhbGwgcG9seWdvbiBub2RlcyBhbmQgY3VyZSBzbWFsbCBsb2NhbCBzZWxmLWludGVyc2VjdGlvbnMKZnVuY3Rpb24gY3VyZUxvY2FsSW50ZXJzZWN0aW9ucyggc3RhcnQsIHRyaWFuZ2xlcywgZGltICkgewoKCWxldCBwID0gc3RhcnQ7CglkbyB7CgoJCWNvbnN0IGEgPSBwLnByZXYsCgkJCWIgPSBwLm5leHQubmV4dDsKCgkJaWYgKCAhIGVxdWFscyggYSwgYiApICYmIGludGVyc2VjdHMoIGEsIHAsIHAubmV4dCwgYiApICYmIGxvY2FsbHlJbnNpZGUoIGEsIGIgKSAmJiBsb2NhbGx5SW5zaWRlKCBiLCBhICkgKSB7CgoJCQl0cmlhbmdsZXMucHVzaCggYS5pIC8gZGltIHwgMCApOwoJCQl0cmlhbmdsZXMucHVzaCggcC5pIC8gZGltIHwgMCApOwoJCQl0cmlhbmdsZXMucHVzaCggYi5pIC8gZGltIHwgMCApOwoKCQkJLy8gcmVtb3ZlIHR3byBub2RlcyBpbnZvbHZlZAoJCQlyZW1vdmVOb2RlKCBwICk7CgkJCXJlbW92ZU5vZGUoIHAubmV4dCApOwoKCQkJcCA9IHN0YXJ0ID0gYjsKCgkJfQoKCQlwID0gcC5uZXh0OwoKCX0gd2hpbGUgKCBwICE9PSBzdGFydCApOwoKCXJldHVybiBmaWx0ZXJQb2ludHMoIHAgKTsKCn0KCi8vIHRyeSBzcGxpdHRpbmcgcG9seWdvbiBpbnRvIHR3byBhbmQgdHJpYW5ndWxhdGUgdGhlbSBpbmRlcGVuZGVudGx5CmZ1bmN0aW9uIHNwbGl0RWFyY3V0KCBzdGFydCwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUgKSB7CgoJLy8gbG9vayBmb3IgYSB2YWxpZCBkaWFnb25hbCB0aGF0IGRpdmlkZXMgdGhlIHBvbHlnb24gaW50byB0d28KCWxldCBhID0gc3RhcnQ7CglkbyB7CgoJCWxldCBiID0gYS5uZXh0Lm5leHQ7CgkJd2hpbGUgKCBiICE9PSBhLnByZXYgKSB7CgoJCQlpZiAoIGEuaSAhPT0gYi5pICYmIGlzVmFsaWREaWFnb25hbCggYSwgYiApICkgewoKCQkJCS8vIHNwbGl0IHRoZSBwb2x5Z29uIGluIHR3byBieSB0aGUgZGlhZ29uYWwKCQkJCWxldCBjID0gc3BsaXRQb2x5Z29uKCBhLCBiICk7CgoJCQkJLy8gZmlsdGVyIGNvbGluZWFyIHBvaW50cyBhcm91bmQgdGhlIGN1dHMKCQkJCWEgPSBmaWx0ZXJQb2ludHMoIGEsIGEubmV4dCApOwoJCQkJYyA9IGZpbHRlclBvaW50cyggYywgYy5uZXh0ICk7CgoJCQkJLy8gcnVuIGVhcmN1dCBvbiBlYWNoIGhhbGYKCQkJCWVhcmN1dExpbmtlZCggYSwgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDAgKTsKCQkJCWVhcmN1dExpbmtlZCggYywgdHJpYW5nbGVzLCBkaW0sIG1pblgsIG1pblksIGludlNpemUsIDAgKTsKCQkJCXJldHVybjsKCgkJCX0KCgkJCWIgPSBiLm5leHQ7CgoJCX0KCgkJYSA9IGEubmV4dDsKCgl9IHdoaWxlICggYSAhPT0gc3RhcnQgKTsKCn0KCi8vIGxpbmsgZXZlcnkgaG9sZSBpbnRvIHRoZSBvdXRlciBsb29wLCBwcm9kdWNpbmcgYSBzaW5nbGUtcmluZyBwb2x5Z29uIHdpdGhvdXQgaG9sZXMKZnVuY3Rpb24gZWxpbWluYXRlSG9sZXMoIGRhdGEsIGhvbGVJbmRpY2VzLCBvdXRlck5vZGUsIGRpbSApIHsKCgljb25zdCBxdWV1ZSA9IFtdOwoJbGV0IGksIGxlbiwgc3RhcnQsIGVuZCwgbGlzdDsKCglmb3IgKCBpID0gMCwgbGVuID0gaG9sZUluZGljZXMubGVuZ3RoOyBpIDwgbGVuOyBpICsrICkgewoKCQlzdGFydCA9IGhvbGVJbmRpY2VzWyBpIF0gKiBkaW07CgkJZW5kID0gaSA8IGxlbiAtIDEgPyBob2xlSW5kaWNlc1sgaSArIDEgXSAqIGRpbSA6IGRhdGEubGVuZ3RoOwoJCWxpc3QgPSBsaW5rZWRMaXN0KCBkYXRhLCBzdGFydCwgZW5kLCBkaW0sIGZhbHNlICk7CgkJaWYgKCBsaXN0ID09PSBsaXN0Lm5leHQgKSBsaXN0LnN0ZWluZXIgPSB0cnVlOwoJCXF1ZXVlLnB1c2goIGdldExlZnRtb3N0KCBsaXN0ICkgKTsKCgl9CgoJcXVldWUuc29ydCggY29tcGFyZVggKTsKCgkvLyBwcm9jZXNzIGhvbGVzIGZyb20gbGVmdCB0byByaWdodAoJZm9yICggaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7IGkgKysgKSB7CgoJCW91dGVyTm9kZSA9IGVsaW1pbmF0ZUhvbGUoIHF1ZXVlWyBpIF0sIG91dGVyTm9kZSApOwoKCX0KCglyZXR1cm4gb3V0ZXJOb2RlOwoKfQoKZnVuY3Rpb24gY29tcGFyZVgoIGEsIGIgKSB7CgoJcmV0dXJuIGEueCAtIGIueDsKCn0KCi8vIGZpbmQgYSBicmlkZ2UgYmV0d2VlbiB2ZXJ0aWNlcyB0aGF0IGNvbm5lY3RzIGhvbGUgd2l0aCBhbiBvdXRlciByaW5nIGFuZCBsaW5rIGl0CmZ1bmN0aW9uIGVsaW1pbmF0ZUhvbGUoIGhvbGUsIG91dGVyTm9kZSApIHsKCgljb25zdCBicmlkZ2UgPSBmaW5kSG9sZUJyaWRnZSggaG9sZSwgb3V0ZXJOb2RlICk7CglpZiAoICEgYnJpZGdlICkgewoKCQlyZXR1cm4gb3V0ZXJOb2RlOwoKCX0KCgljb25zdCBicmlkZ2VSZXZlcnNlID0gc3BsaXRQb2x5Z29uKCBicmlkZ2UsIGhvbGUgKTsKCgkvLyBmaWx0ZXIgY29sbGluZWFyIHBvaW50cyBhcm91bmQgdGhlIGN1dHMKCWZpbHRlclBvaW50cyggYnJpZGdlUmV2ZXJzZSwgYnJpZGdlUmV2ZXJzZS5uZXh0ICk7CglyZXR1cm4gZmlsdGVyUG9pbnRzKCBicmlkZ2UsIGJyaWRnZS5uZXh0ICk7Cgp9CgovLyBEYXZpZCBFYmVybHkncyBhbGdvcml0aG0gZm9yIGZpbmRpbmcgYSBicmlkZ2UgYmV0d2VlbiBob2xlIGFuZCBvdXRlciBwb2x5Z29uCmZ1bmN0aW9uIGZpbmRIb2xlQnJpZGdlKCBob2xlLCBvdXRlck5vZGUgKSB7CgoJbGV0IHAgPSBvdXRlck5vZGUsCgkJcXggPSAtIEluZmluaXR5LAoJCW07CgoJY29uc3QgaHggPSBob2xlLngsIGh5ID0gaG9sZS55OwoKCS8vIGZpbmQgYSBzZWdtZW50IGludGVyc2VjdGVkIGJ5IGEgcmF5IGZyb20gdGhlIGhvbGUncyBsZWZ0bW9zdCBwb2ludCB0byB0aGUgbGVmdDsKCS8vIHNlZ21lbnQncyBlbmRwb2ludCB3aXRoIGxlc3NlciB4IHdpbGwgYmUgcG90ZW50aWFsIGNvbm5lY3Rpb24gcG9pbnQKCWRvIHsKCgkJaWYgKCBoeSA8PSBwLnkgJiYgaHkgPj0gcC5uZXh0LnkgJiYgcC5uZXh0LnkgIT09IHAueSApIHsKCgkJCWNvbnN0IHggPSBwLnggKyAoIGh5IC0gcC55ICkgKiAoIHAubmV4dC54IC0gcC54ICkgLyAoIHAubmV4dC55IC0gcC55ICk7CgkJCWlmICggeCA8PSBoeCAmJiB4ID4gcXggKSB7CgoJCQkJcXggPSB4OwoJCQkJbSA9IHAueCA8IHAubmV4dC54ID8gcCA6IHAubmV4dDsKCQkJCWlmICggeCA9PT0gaHggKSByZXR1cm4gbTsgLy8gaG9sZSB0b3VjaGVzIG91dGVyIHNlZ21lbnQ7IHBpY2sgbGVmdG1vc3QgZW5kcG9pbnQKCgkJCX0KCgkJfQoKCQlwID0gcC5uZXh0OwoKCX0gd2hpbGUgKCBwICE9PSBvdXRlck5vZGUgKTsKCglpZiAoICEgbSApIHJldHVybiBudWxsOwoKCS8vIGxvb2sgZm9yIHBvaW50cyBpbnNpZGUgdGhlIHRyaWFuZ2xlIG9mIGhvbGUgcG9pbnQsIHNlZ21lbnQgaW50ZXJzZWN0aW9uIGFuZCBlbmRwb2ludDsKCS8vIGlmIHRoZXJlIGFyZSBubyBwb2ludHMgZm91bmQsIHdlIGhhdmUgYSB2YWxpZCBjb25uZWN0aW9uOwoJLy8gb3RoZXJ3aXNlIGNob29zZSB0aGUgcG9pbnQgb2YgdGhlIG1pbmltdW0gYW5nbGUgd2l0aCB0aGUgcmF5IGFzIGNvbm5lY3Rpb24gcG9pbnQKCgljb25zdCBzdG9wID0gbSwKCQlteCA9IG0ueCwKCQlteSA9IG0ueTsKCWxldCB0YW5NaW4gPSBJbmZpbml0eSwgdGFuOwoKCXAgPSBtOwoKCWRvIHsKCgkJaWYgKCBoeCA+PSBwLnggJiYgcC54ID49IG14ICYmIGh4ICE9PSBwLnggJiYKCQkJCXBvaW50SW5UcmlhbmdsZSggaHkgPCBteSA/IGh4IDogcXgsIGh5LCBteCwgbXksIGh5IDwgbXkgPyBxeCA6IGh4LCBoeSwgcC54LCBwLnkgKSApIHsKCgkJCXRhbiA9IE1hdGguYWJzKCBoeSAtIHAueSApIC8gKCBoeCAtIHAueCApOyAvLyB0YW5nZW50aWFsCgoJCQlpZiAoIGxvY2FsbHlJbnNpZGUoIHAsIGhvbGUgKSAmJiAoIHRhbiA8IHRhbk1pbiB8fCAoIHRhbiA9PT0gdGFuTWluICYmICggcC54ID4gbS54IHx8ICggcC54ID09PSBtLnggJiYgc2VjdG9yQ29udGFpbnNTZWN0b3IoIG0sIHAgKSApICkgKSApICkgewoKCQkJCW0gPSBwOwoJCQkJdGFuTWluID0gdGFuOwoKCQkJfQoKCQl9CgoJCXAgPSBwLm5leHQ7CgoJfSB3aGlsZSAoIHAgIT09IHN0b3AgKTsKCglyZXR1cm4gbTsKCn0KCi8vIHdoZXRoZXIgc2VjdG9yIGluIHZlcnRleCBtIGNvbnRhaW5zIHNlY3RvciBpbiB2ZXJ0ZXggcCBpbiB0aGUgc2FtZSBjb29yZGluYXRlcwpmdW5jdGlvbiBzZWN0b3JDb250YWluc1NlY3RvciggbSwgcCApIHsKCglyZXR1cm4gYXJlYSggbS5wcmV2LCBtLCBwLnByZXYgKSA8IDAgJiYgYXJlYSggcC5uZXh0LCBtLCBtLm5leHQgKSA8IDA7Cgp9CgovLyBpbnRlcmxpbmsgcG9seWdvbiBub2RlcyBpbiB6LW9yZGVyCmZ1bmN0aW9uIGluZGV4Q3VydmUoIHN0YXJ0LCBtaW5YLCBtaW5ZLCBpbnZTaXplICkgewoKCWxldCBwID0gc3RhcnQ7CglkbyB7CgoJCWlmICggcC56ID09PSAwICkgcC56ID0gek9yZGVyKCBwLngsIHAueSwgbWluWCwgbWluWSwgaW52U2l6ZSApOwoJCXAucHJldlogPSBwLnByZXY7CgkJcC5uZXh0WiA9IHAubmV4dDsKCQlwID0gcC5uZXh0OwoKCX0gd2hpbGUgKCBwICE9PSBzdGFydCApOwoKCXAucHJldloubmV4dFogPSBudWxsOwoJcC5wcmV2WiA9IG51bGw7CgoJc29ydExpbmtlZCggcCApOwoKfQoKLy8gU2ltb24gVGF0aGFtJ3MgbGlua2VkIGxpc3QgbWVyZ2Ugc29ydCBhbGdvcml0aG0KLy8gaHR0cDovL3d3dy5jaGlhcmsuZ3JlZW5lbmQub3JnLnVrL35zZ3RhdGhhbS9hbGdvcml0aG1zL2xpc3Rzb3J0Lmh0bWwKZnVuY3Rpb24gc29ydExpbmtlZCggbGlzdCApIHsKCglsZXQgaSwgcCwgcSwgZSwgdGFpbCwgbnVtTWVyZ2VzLCBwU2l6ZSwgcVNpemUsCgkJaW5TaXplID0gMTsKCglkbyB7CgoJCXAgPSBsaXN0OwoJCWxpc3QgPSBudWxsOwoJCXRhaWwgPSBudWxsOwoJCW51bU1lcmdlcyA9IDA7CgoJCXdoaWxlICggcCApIHsKCgkJCW51bU1lcmdlcyArKzsKCQkJcSA9IHA7CgkJCXBTaXplID0gMDsKCQkJZm9yICggaSA9IDA7IGkgPCBpblNpemU7IGkgKysgKSB7CgoJCQkJcFNpemUgKys7CgkJCQlxID0gcS5uZXh0WjsKCQkJCWlmICggISBxICkgYnJlYWs7CgoJCQl9CgoJCQlxU2l6ZSA9IGluU2l6ZTsKCgkJCXdoaWxlICggcFNpemUgPiAwIHx8ICggcVNpemUgPiAwICYmIHEgKSApIHsKCgkJCQlpZiAoIHBTaXplICE9PSAwICYmICggcVNpemUgPT09IDAgfHwgISBxIHx8IHAueiA8PSBxLnogKSApIHsKCgkJCQkJZSA9IHA7CgkJCQkJcCA9IHAubmV4dFo7CgkJCQkJcFNpemUgLS07CgoJCQkJfSBlbHNlIHsKCgkJCQkJZSA9IHE7CgkJCQkJcSA9IHEubmV4dFo7CgkJCQkJcVNpemUgLS07CgoJCQkJfQoKCQkJCWlmICggdGFpbCApIHRhaWwubmV4dFogPSBlOwoJCQkJZWxzZSBsaXN0ID0gZTsKCgkJCQllLnByZXZaID0gdGFpbDsKCQkJCXRhaWwgPSBlOwoKCQkJfQoKCQkJcCA9IHE7CgoJCX0KCgkJdGFpbC5uZXh0WiA9IG51bGw7CgkJaW5TaXplICo9IDI7CgoJfSB3aGlsZSAoIG51bU1lcmdlcyA+IDEgKTsKCglyZXR1cm4gbGlzdDsKCn0KCi8vIHotb3JkZXIgb2YgYSBwb2ludCBnaXZlbiBjb29yZHMgYW5kIGludmVyc2Ugb2YgdGhlIGxvbmdlciBzaWRlIG9mIGRhdGEgYmJveApmdW5jdGlvbiB6T3JkZXIoIHgsIHksIG1pblgsIG1pblksIGludlNpemUgKSB7CgoJLy8gY29vcmRzIGFyZSB0cmFuc2Zvcm1lZCBpbnRvIG5vbi1uZWdhdGl2ZSAxNS1iaXQgaW50ZWdlciByYW5nZQoJeCA9ICggeCAtIG1pblggKSAqIGludlNpemUgfCAwOwoJeSA9ICggeSAtIG1pblkgKSAqIGludlNpemUgfCAwOwoKCXggPSAoIHggfCAoIHggPDwgOCApICkgJiAweDAwRkYwMEZGOwoJeCA9ICggeCB8ICggeCA8PCA0ICkgKSAmIDB4MEYwRjBGMEY7Cgl4ID0gKCB4IHwgKCB4IDw8IDIgKSApICYgMHgzMzMzMzMzMzsKCXggPSAoIHggfCAoIHggPDwgMSApICkgJiAweDU1NTU1NTU1OwoKCXkgPSAoIHkgfCAoIHkgPDwgOCApICkgJiAweDAwRkYwMEZGOwoJeSA9ICggeSB8ICggeSA8PCA0ICkgKSAmIDB4MEYwRjBGMEY7Cgl5ID0gKCB5IHwgKCB5IDw8IDIgKSApICYgMHgzMzMzMzMzMzsKCXkgPSAoIHkgfCAoIHkgPDwgMSApICkgJiAweDU1NTU1NTU1OwoKCXJldHVybiB4IHwgKCB5IDw8IDEgKTsKCn0KCi8vIGZpbmQgdGhlIGxlZnRtb3N0IG5vZGUgb2YgYSBwb2x5Z29uIHJpbmcKZnVuY3Rpb24gZ2V0TGVmdG1vc3QoIHN0YXJ0ICkgewoKCWxldCBwID0gc3RhcnQsCgkJbGVmdG1vc3QgPSBzdGFydDsKCWRvIHsKCgkJaWYgKCBwLnggPCBsZWZ0bW9zdC54IHx8ICggcC54ID09PSBsZWZ0bW9zdC54ICYmIHAueSA8IGxlZnRtb3N0LnkgKSApIGxlZnRtb3N0ID0gcDsKCQlwID0gcC5uZXh0OwoKCX0gd2hpbGUgKCBwICE9PSBzdGFydCApOwoKCXJldHVybiBsZWZ0bW9zdDsKCn0KCi8vIGNoZWNrIGlmIGEgcG9pbnQgbGllcyB3aXRoaW4gYSBjb252ZXggdHJpYW5nbGUKZnVuY3Rpb24gcG9pbnRJblRyaWFuZ2xlKCBheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBweCwgcHkgKSB7CgoJcmV0dXJuICggY3ggLSBweCApICogKCBheSAtIHB5ICkgPj0gKCBheCAtIHB4ICkgKiAoIGN5IC0gcHkgKSAmJgogICAgICAgICAgICggYXggLSBweCApICogKCBieSAtIHB5ICkgPj0gKCBieCAtIHB4ICkgKiAoIGF5IC0gcHkgKSAmJgogICAgICAgICAgICggYnggLSBweCApICogKCBjeSAtIHB5ICkgPj0gKCBjeCAtIHB4ICkgKiAoIGJ5IC0gcHkgKTsKCn0KCi8vIGNoZWNrIGlmIGEgZGlhZ29uYWwgYmV0d2VlbiB0d28gcG9seWdvbiBub2RlcyBpcyB2YWxpZCAobGllcyBpbiBwb2x5Z29uIGludGVyaW9yKQpmdW5jdGlvbiBpc1ZhbGlkRGlhZ29uYWwoIGEsIGIgKSB7CgoJcmV0dXJuIGEubmV4dC5pICE9PSBiLmkgJiYgYS5wcmV2LmkgIT09IGIuaSAmJiAhIGludGVyc2VjdHNQb2x5Z29uKCBhLCBiICkgJiYgLy8gZG9uZXMndCBpbnRlcnNlY3Qgb3RoZXIgZWRnZXMKICAgICAgICAgICAoIGxvY2FsbHlJbnNpZGUoIGEsIGIgKSAmJiBsb2NhbGx5SW5zaWRlKCBiLCBhICkgJiYgbWlkZGxlSW5zaWRlKCBhLCBiICkgJiYgLy8gbG9jYWxseSB2aXNpYmxlCiAgICAgICAgICAgICggYXJlYSggYS5wcmV2LCBhLCBiLnByZXYgKSB8fCBhcmVhKCBhLCBiLnByZXYsIGIgKSApIHx8IC8vIGRvZXMgbm90IGNyZWF0ZSBvcHBvc2l0ZS1mYWNpbmcgc2VjdG9ycwogICAgICAgICAgICBlcXVhbHMoIGEsIGIgKSAmJiBhcmVhKCBhLnByZXYsIGEsIGEubmV4dCApID4gMCAmJiBhcmVhKCBiLnByZXYsIGIsIGIubmV4dCApID4gMCApOyAvLyBzcGVjaWFsIHplcm8tbGVuZ3RoIGNhc2UKCn0KCi8vIHNpZ25lZCBhcmVhIG9mIGEgdHJpYW5nbGUKZnVuY3Rpb24gYXJlYSggcCwgcSwgciApIHsKCglyZXR1cm4gKCBxLnkgLSBwLnkgKSAqICggci54IC0gcS54ICkgLSAoIHEueCAtIHAueCApICogKCByLnkgLSBxLnkgKTsKCn0KCi8vIGNoZWNrIGlmIHR3byBwb2ludHMgYXJlIGVxdWFsCmZ1bmN0aW9uIGVxdWFscyggcDEsIHAyICkgewoKCXJldHVybiBwMS54ID09PSBwMi54ICYmIHAxLnkgPT09IHAyLnk7Cgp9CgovLyBjaGVjayBpZiB0d28gc2VnbWVudHMgaW50ZXJzZWN0CmZ1bmN0aW9uIGludGVyc2VjdHMoIHAxLCBxMSwgcDIsIHEyICkgewoKCWNvbnN0IG8xID0gc2lnbiggYXJlYSggcDEsIHExLCBwMiApICk7Cgljb25zdCBvMiA9IHNpZ24oIGFyZWEoIHAxLCBxMSwgcTIgKSApOwoJY29uc3QgbzMgPSBzaWduKCBhcmVhKCBwMiwgcTIsIHAxICkgKTsKCWNvbnN0IG80ID0gc2lnbiggYXJlYSggcDIsIHEyLCBxMSApICk7CgoJaWYgKCBvMSAhPT0gbzIgJiYgbzMgIT09IG80ICkgcmV0dXJuIHRydWU7IC8vIGdlbmVyYWwgY2FzZQoKCWlmICggbzEgPT09IDAgJiYgb25TZWdtZW50KCBwMSwgcDIsIHExICkgKSByZXR1cm4gdHJ1ZTsgLy8gcDEsIHExIGFuZCBwMiBhcmUgY29sbGluZWFyIGFuZCBwMiBsaWVzIG9uIHAxcTEKCWlmICggbzIgPT09IDAgJiYgb25TZWdtZW50KCBwMSwgcTIsIHExICkgKSByZXR1cm4gdHJ1ZTsgLy8gcDEsIHExIGFuZCBxMiBhcmUgY29sbGluZWFyIGFuZCBxMiBsaWVzIG9uIHAxcTEKCWlmICggbzMgPT09IDAgJiYgb25TZWdtZW50KCBwMiwgcDEsIHEyICkgKSByZXR1cm4gdHJ1ZTsgLy8gcDIsIHEyIGFuZCBwMSBhcmUgY29sbGluZWFyIGFuZCBwMSBsaWVzIG9uIHAycTIKCWlmICggbzQgPT09IDAgJiYgb25TZWdtZW50KCBwMiwgcTEsIHEyICkgKSByZXR1cm4gdHJ1ZTsgLy8gcDIsIHEyIGFuZCBxMSBhcmUgY29sbGluZWFyIGFuZCBxMSBsaWVzIG9uIHAycTIKCglyZXR1cm4gZmFsc2U7Cgp9CgovLyBmb3IgY29sbGluZWFyIHBvaW50cyBwLCBxLCByLCBjaGVjayBpZiBwb2ludCBxIGxpZXMgb24gc2VnbWVudCBwcgpmdW5jdGlvbiBvblNlZ21lbnQoIHAsIHEsIHIgKSB7CgoJcmV0dXJuIHEueCA8PSBNYXRoLm1heCggcC54LCByLnggKSAmJiBxLnggPj0gTWF0aC5taW4oIHAueCwgci54ICkgJiYgcS55IDw9IE1hdGgubWF4KCBwLnksIHIueSApICYmIHEueSA+PSBNYXRoLm1pbiggcC55LCByLnkgKTsKCn0KCmZ1bmN0aW9uIHNpZ24oIG51bSApIHsKCglyZXR1cm4gbnVtID4gMCA/IDEgOiBudW0gPCAwID8gLSAxIDogMDsKCn0KCi8vIGNoZWNrIGlmIGEgcG9seWdvbiBkaWFnb25hbCBpbnRlcnNlY3RzIGFueSBwb2x5Z29uIHNlZ21lbnRzCmZ1bmN0aW9uIGludGVyc2VjdHNQb2x5Z29uKCBhLCBiICkgewoKCWxldCBwID0gYTsKCWRvIHsKCgkJaWYgKCBwLmkgIT09IGEuaSAmJiBwLm5leHQuaSAhPT0gYS5pICYmIHAuaSAhPT0gYi5pICYmIHAubmV4dC5pICE9PSBiLmkgJiYKCQkJaW50ZXJzZWN0cyggcCwgcC5uZXh0LCBhLCBiICkgKSByZXR1cm4gdHJ1ZTsKCQlwID0gcC5uZXh0OwoKCX0gd2hpbGUgKCBwICE9PSBhICk7CgoJcmV0dXJuIGZhbHNlOwoKfQoKLy8gY2hlY2sgaWYgYSBwb2x5Z29uIGRpYWdvbmFsIGlzIGxvY2FsbHkgaW5zaWRlIHRoZSBwb2x5Z29uCmZ1bmN0aW9uIGxvY2FsbHlJbnNpZGUoIGEsIGIgKSB7CgoJcmV0dXJuIGFyZWEoIGEucHJldiwgYSwgYS5uZXh0ICkgPCAwID8KCQlhcmVhKCBhLCBiLCBhLm5leHQgKSA+PSAwICYmIGFyZWEoIGEsIGEucHJldiwgYiApID49IDAgOgoJCWFyZWEoIGEsIGIsIGEucHJldiApIDwgMCB8fCBhcmVhKCBhLCBhLm5leHQsIGIgKSA8IDA7Cgp9CgovLyBjaGVjayBpZiB0aGUgbWlkZGxlIHBvaW50IG9mIGEgcG9seWdvbiBkaWFnb25hbCBpcyBpbnNpZGUgdGhlIHBvbHlnb24KZnVuY3Rpb24gbWlkZGxlSW5zaWRlKCBhLCBiICkgewoKCWxldCBwID0gYSwKCQlpbnNpZGUgPSBmYWxzZTsKCWNvbnN0IHB4ID0gKCBhLnggKyBiLnggKSAvIDIsCgkJcHkgPSAoIGEueSArIGIueSApIC8gMjsKCWRvIHsKCgkJaWYgKCAoICggcC55ID4gcHkgKSAhPT0gKCBwLm5leHQueSA+IHB5ICkgKSAmJiBwLm5leHQueSAhPT0gcC55ICYmCgkJCSggcHggPCAoIHAubmV4dC54IC0gcC54ICkgKiAoIHB5IC0gcC55ICkgLyAoIHAubmV4dC55IC0gcC55ICkgKyBwLnggKSApCgkJCWluc2lkZSA9ICEgaW5zaWRlOwoJCXAgPSBwLm5leHQ7CgoJfSB3aGlsZSAoIHAgIT09IGEgKTsKCglyZXR1cm4gaW5zaWRlOwoKfQoKLy8gbGluayB0d28gcG9seWdvbiB2ZXJ0aWNlcyB3aXRoIGEgYnJpZGdlOyBpZiB0aGUgdmVydGljZXMgYmVsb25nIHRvIHRoZSBzYW1lIHJpbmcsIGl0IHNwbGl0cyBwb2x5Z29uIGludG8gdHdvOwovLyBpZiBvbmUgYmVsb25ncyB0byB0aGUgb3V0ZXIgcmluZyBhbmQgYW5vdGhlciB0byBhIGhvbGUsIGl0IG1lcmdlcyBpdCBpbnRvIGEgc2luZ2xlIHJpbmcKZnVuY3Rpb24gc3BsaXRQb2x5Z29uKCBhLCBiICkgewoKCWNvbnN0IGEyID0gbmV3IE5vZGUoIGEuaSwgYS54LCBhLnkgKSwKCQliMiA9IG5ldyBOb2RlKCBiLmksIGIueCwgYi55ICksCgkJYW4gPSBhLm5leHQsCgkJYnAgPSBiLnByZXY7CgoJYS5uZXh0ID0gYjsKCWIucHJldiA9IGE7CgoJYTIubmV4dCA9IGFuOwoJYW4ucHJldiA9IGEyOwoKCWIyLm5leHQgPSBhMjsKCWEyLnByZXYgPSBiMjsKCglicC5uZXh0ID0gYjI7CgliMi5wcmV2ID0gYnA7CgoJcmV0dXJuIGIyOwoKfQoKLy8gY3JlYXRlIGEgbm9kZSBhbmQgb3B0aW9uYWxseSBsaW5rIGl0IHdpdGggcHJldmlvdXMgb25lIChpbiBhIGNpcmN1bGFyIGRvdWJseSBsaW5rZWQgbGlzdCkKZnVuY3Rpb24gaW5zZXJ0Tm9kZSggaSwgeCwgeSwgbGFzdCApIHsKCgljb25zdCBwID0gbmV3IE5vZGUoIGksIHgsIHkgKTsKCglpZiAoICEgbGFzdCApIHsKCgkJcC5wcmV2ID0gcDsKCQlwLm5leHQgPSBwOwoKCX0gZWxzZSB7CgoJCXAubmV4dCA9IGxhc3QubmV4dDsKCQlwLnByZXYgPSBsYXN0OwoJCWxhc3QubmV4dC5wcmV2ID0gcDsKCQlsYXN0Lm5leHQgPSBwOwoKCX0KCglyZXR1cm4gcDsKCn0KCmZ1bmN0aW9uIHJlbW92ZU5vZGUoIHAgKSB7CgoJcC5uZXh0LnByZXYgPSBwLnByZXY7CglwLnByZXYubmV4dCA9IHAubmV4dDsKCglpZiAoIHAucHJldlogKSBwLnByZXZaLm5leHRaID0gcC5uZXh0WjsKCWlmICggcC5uZXh0WiApIHAubmV4dFoucHJldlogPSBwLnByZXZaOwoKfQoKZnVuY3Rpb24gTm9kZSggaSwgeCwgeSApIHsKCgkvLyB2ZXJ0ZXggaW5kZXggaW4gY29vcmRpbmF0ZXMgYXJyYXkKCXRoaXMuaSA9IGk7CgoJLy8gdmVydGV4IGNvb3JkaW5hdGVzCgl0aGlzLnggPSB4OwoJdGhpcy55ID0geTsKCgkvLyBwcmV2aW91cyBhbmQgbmV4dCB2ZXJ0ZXggbm9kZXMgaW4gYSBwb2x5Z29uIHJpbmcKCXRoaXMucHJldiA9IG51bGw7Cgl0aGlzLm5leHQgPSBudWxsOwoKCS8vIHotb3JkZXIgY3VydmUgdmFsdWUKCXRoaXMueiA9IDA7CgoJLy8gcHJldmlvdXMgYW5kIG5leHQgbm9kZXMgaW4gei1vcmRlcgoJdGhpcy5wcmV2WiA9IG51bGw7Cgl0aGlzLm5leHRaID0gbnVsbDsKCgkvLyBpbmRpY2F0ZXMgd2hldGhlciB0aGlzIGlzIGEgc3RlaW5lciBwb2ludAoJdGhpcy5zdGVpbmVyID0gZmFsc2U7Cgp9CgpmdW5jdGlvbiBzaWduZWRBcmVhKCBkYXRhLCBzdGFydCwgZW5kLCBkaW0gKSB7CgoJbGV0IHN1bSA9IDA7Cglmb3IgKCBsZXQgaSA9IHN0YXJ0LCBqID0gZW5kIC0gZGltOyBpIDwgZW5kOyBpICs9IGRpbSApIHsKCgkJc3VtICs9ICggZGF0YVsgaiBdIC0gZGF0YVsgaSBdICkgKiAoIGRhdGFbIGkgKyAxIF0gKyBkYXRhWyBqICsgMSBdICk7CgkJaiA9IGk7CgoJfQoKCXJldHVybiBzdW07Cgp9CgpjbGFzcyBTaGFwZVV0aWxzIHsKCgkvLyBjYWxjdWxhdGUgYXJlYSBvZiB0aGUgY29udG91ciBwb2x5Z29uCgoJc3RhdGljIGFyZWEoIGNvbnRvdXIgKSB7CgoJCWNvbnN0IG4gPSBjb250b3VyLmxlbmd0aDsKCQlsZXQgYSA9IDAuMDsKCgkJZm9yICggbGV0IHAgPSBuIC0gMSwgcSA9IDA7IHEgPCBuOyBwID0gcSArKyApIHsKCgkJCWEgKz0gY29udG91clsgcCBdLnggKiBjb250b3VyWyBxIF0ueSAtIGNvbnRvdXJbIHEgXS54ICogY29udG91clsgcCBdLnk7CgoJCX0KCgkJcmV0dXJuIGEgKiAwLjU7CgoJfQoKCXN0YXRpYyBpc0Nsb2NrV2lzZSggcHRzICkgewoKCQlyZXR1cm4gU2hhcGVVdGlscy5hcmVhKCBwdHMgKSA8IDA7CgoJfQoKCXN0YXRpYyB0cmlhbmd1bGF0ZVNoYXBlKCBjb250b3VyLCBob2xlcyApIHsKCgkJY29uc3QgdmVydGljZXMgPSBbXTsgLy8gZmxhdCBhcnJheSBvZiB2ZXJ0aWNlcyBsaWtlIFsgeDAseTAsIHgxLHkxLCB4Mix5MiwgLi4uIF0KCQljb25zdCBob2xlSW5kaWNlcyA9IFtdOyAvLyBhcnJheSBvZiBob2xlIGluZGljZXMKCQljb25zdCBmYWNlcyA9IFtdOyAvLyBmaW5hbCBhcnJheSBvZiB2ZXJ0ZXggaW5kaWNlcyBsaWtlIFsgWyBhLGIsZCBdLCBbIGIsYyxkIF0gXQoKCQlyZW1vdmVEdXBFbmRQdHMoIGNvbnRvdXIgKTsKCQlhZGRDb250b3VyKCB2ZXJ0aWNlcywgY29udG91ciApOwoKCQkvLwoKCQlsZXQgaG9sZUluZGV4ID0gY29udG91ci5sZW5ndGg7CgoJCWhvbGVzLmZvckVhY2goIHJlbW92ZUR1cEVuZFB0cyApOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBob2xlcy5sZW5ndGg7IGkgKysgKSB7CgoJCQlob2xlSW5kaWNlcy5wdXNoKCBob2xlSW5kZXggKTsKCQkJaG9sZUluZGV4ICs9IGhvbGVzWyBpIF0ubGVuZ3RoOwoJCQlhZGRDb250b3VyKCB2ZXJ0aWNlcywgaG9sZXNbIGkgXSApOwoKCQl9CgoJCS8vCgoJCWNvbnN0IHRyaWFuZ2xlcyA9IEVhcmN1dC50cmlhbmd1bGF0ZSggdmVydGljZXMsIGhvbGVJbmRpY2VzICk7CgoJCS8vCgoJCWZvciAoIGxldCBpID0gMDsgaSA8IHRyaWFuZ2xlcy5sZW5ndGg7IGkgKz0gMyApIHsKCgkJCWZhY2VzLnB1c2goIHRyaWFuZ2xlcy5zbGljZSggaSwgaSArIDMgKSApOwoKCQl9CgoJCXJldHVybiBmYWNlczsKCgl9Cgp9CgpmdW5jdGlvbiByZW1vdmVEdXBFbmRQdHMoIHBvaW50cyApIHsKCgljb25zdCBsID0gcG9pbnRzLmxlbmd0aDsKCglpZiAoIGwgPiAyICYmIHBvaW50c1sgbCAtIDEgXS5lcXVhbHMoIHBvaW50c1sgMCBdICkgKSB7CgoJCXBvaW50cy5wb3AoKTsKCgl9Cgp9CgpmdW5jdGlvbiBhZGRDb250b3VyKCB2ZXJ0aWNlcywgY29udG91ciApIHsKCglmb3IgKCBsZXQgaSA9IDA7IGkgPCBjb250b3VyLmxlbmd0aDsgaSArKyApIHsKCgkJdmVydGljZXMucHVzaCggY29udG91clsgaSBdLnggKTsKCQl2ZXJ0aWNlcy5wdXNoKCBjb250b3VyWyBpIF0ueSApOwoKCX0KCn0KCi8qKgogKiBDcmVhdGVzIGV4dHJ1ZGVkIGdlb21ldHJ5IGZyb20gYSBwYXRoIHNoYXBlLgogKgogKiBwYXJhbWV0ZXJzID0gewogKgogKiAgY3VydmVTZWdtZW50czogPGludD4sIC8vIG51bWJlciBvZiBwb2ludHMgb24gdGhlIGN1cnZlcwogKiAgc3RlcHM6IDxpbnQ+LCAvLyBudW1iZXIgb2YgcG9pbnRzIGZvciB6LXNpZGUgZXh0cnVzaW9ucyAvIHVzZWQgZm9yIHN1YmRpdmlkaW5nIHNlZ21lbnRzIG9mIGV4dHJ1ZGUgc3BsaW5lIHRvbwogKiAgZGVwdGg6IDxmbG9hdD4sIC8vIERlcHRoIHRvIGV4dHJ1ZGUgdGhlIHNoYXBlCiAqCiAqICBiZXZlbEVuYWJsZWQ6IDxib29sPiwgLy8gdHVybiBvbiBiZXZlbAogKiAgYmV2ZWxUaGlja25lc3M6IDxmbG9hdD4sIC8vIGhvdyBkZWVwIGludG8gdGhlIG9yaWdpbmFsIHNoYXBlIGJldmVsIGdvZXMKICogIGJldmVsU2l6ZTogPGZsb2F0PiwgLy8gaG93IGZhciBmcm9tIHNoYXBlIG91dGxpbmUgKGluY2x1ZGluZyBiZXZlbE9mZnNldCkgaXMgYmV2ZWwKICogIGJldmVsT2Zmc2V0OiA8ZmxvYXQ+LCAvLyBob3cgZmFyIGZyb20gc2hhcGUgb3V0bGluZSBkb2VzIGJldmVsIHN0YXJ0CiAqICBiZXZlbFNlZ21lbnRzOiA8aW50PiwgLy8gbnVtYmVyIG9mIGJldmVsIGxheWVycwogKgogKiAgZXh0cnVkZVBhdGg6IDxUSFJFRS5DdXJ2ZT4gLy8gY3VydmUgdG8gZXh0cnVkZSBzaGFwZSBhbG9uZwogKgogKiAgVVZHZW5lcmF0b3I6IDxPYmplY3Q+IC8vIG9iamVjdCB0aGF0IHByb3ZpZGVzIFVWIGdlbmVyYXRvciBmdW5jdGlvbnMKICoKICogfQogKi8KCgpjbGFzcyBFeHRydWRlR2VvbWV0cnkgZXh0ZW5kcyBCdWZmZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIHNoYXBlcyA9IG5ldyBTaGFwZSggWyBuZXcgVmVjdG9yMiggMC41LCAwLjUgKSwgbmV3IFZlY3RvcjIoIC0gMC41LCAwLjUgKSwgbmV3IFZlY3RvcjIoIC0gMC41LCAtIDAuNSApLCBuZXcgVmVjdG9yMiggMC41LCAtIDAuNSApIF0gKSwgb3B0aW9ucyA9IHt9ICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnRXh0cnVkZUdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlzaGFwZXM6IHNoYXBlcywKCQkJb3B0aW9uczogb3B0aW9ucwoJCX07CgoJCXNoYXBlcyA9IEFycmF5LmlzQXJyYXkoIHNoYXBlcyApID8gc2hhcGVzIDogWyBzaGFwZXMgXTsKCgkJY29uc3Qgc2NvcGUgPSB0aGlzOwoKCQljb25zdCB2ZXJ0aWNlc0FycmF5ID0gW107CgkJY29uc3QgdXZBcnJheSA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBzaGFwZXMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWNvbnN0IHNoYXBlID0gc2hhcGVzWyBpIF07CgkJCWFkZFNoYXBlKCBzaGFwZSApOwoKCQl9CgoJCS8vIGJ1aWxkIGdlb21ldHJ5CgoJCXRoaXMuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdmVydGljZXNBcnJheSwgMyApICk7CgkJdGhpcy5zZXRBdHRyaWJ1dGUoICd1dicsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCB1dkFycmF5LCAyICkgKTsKCgkJdGhpcy5jb21wdXRlVmVydGV4Tm9ybWFscygpOwoKCQkvLyBmdW5jdGlvbnMKCgkJZnVuY3Rpb24gYWRkU2hhcGUoIHNoYXBlICkgewoKCQkJY29uc3QgcGxhY2Vob2xkZXIgPSBbXTsKCgkJCS8vIG9wdGlvbnMKCgkJCWNvbnN0IGN1cnZlU2VnbWVudHMgPSBvcHRpb25zLmN1cnZlU2VnbWVudHMgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY3VydmVTZWdtZW50cyA6IDEyOwoJCQljb25zdCBzdGVwcyA9IG9wdGlvbnMuc3RlcHMgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc3RlcHMgOiAxOwoJCQljb25zdCBkZXB0aCA9IG9wdGlvbnMuZGVwdGggIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuZGVwdGggOiAxOwoKCQkJbGV0IGJldmVsRW5hYmxlZCA9IG9wdGlvbnMuYmV2ZWxFbmFibGVkICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmJldmVsRW5hYmxlZCA6IHRydWU7CgkJCWxldCBiZXZlbFRoaWNrbmVzcyA9IG9wdGlvbnMuYmV2ZWxUaGlja25lc3MgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuYmV2ZWxUaGlja25lc3MgOiAwLjI7CgkJCWxldCBiZXZlbFNpemUgPSBvcHRpb25zLmJldmVsU2l6ZSAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5iZXZlbFNpemUgOiBiZXZlbFRoaWNrbmVzcyAtIDAuMTsKCQkJbGV0IGJldmVsT2Zmc2V0ID0gb3B0aW9ucy5iZXZlbE9mZnNldCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5iZXZlbE9mZnNldCA6IDA7CgkJCWxldCBiZXZlbFNlZ21lbnRzID0gb3B0aW9ucy5iZXZlbFNlZ21lbnRzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmJldmVsU2VnbWVudHMgOiAzOwoKCQkJY29uc3QgZXh0cnVkZVBhdGggPSBvcHRpb25zLmV4dHJ1ZGVQYXRoOwoKCQkJY29uc3QgdXZnZW4gPSBvcHRpb25zLlVWR2VuZXJhdG9yICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLlVWR2VuZXJhdG9yIDogV29ybGRVVkdlbmVyYXRvcjsKCgkJCS8vCgoJCQlsZXQgZXh0cnVkZVB0cywgZXh0cnVkZUJ5UGF0aCA9IGZhbHNlOwoJCQlsZXQgc3BsaW5lVHViZSwgYmlub3JtYWwsIG5vcm1hbCwgcG9zaXRpb24yOwoKCQkJaWYgKCBleHRydWRlUGF0aCApIHsKCgkJCQlleHRydWRlUHRzID0gZXh0cnVkZVBhdGguZ2V0U3BhY2VkUG9pbnRzKCBzdGVwcyApOwoKCQkJCWV4dHJ1ZGVCeVBhdGggPSB0cnVlOwoJCQkJYmV2ZWxFbmFibGVkID0gZmFsc2U7IC8vIGJldmVscyBub3Qgc3VwcG9ydGVkIGZvciBwYXRoIGV4dHJ1c2lvbgoKCQkJCS8vIFNFVFVQIFROQiB2YXJpYWJsZXMKCgkJCQkvLyBUT0RPMSAtIGhhdmUgYSAuaXNDbG9zZWQgaW4gc3BsaW5lPwoKCQkJCXNwbGluZVR1YmUgPSBleHRydWRlUGF0aC5jb21wdXRlRnJlbmV0RnJhbWVzKCBzdGVwcywgZmFsc2UgKTsKCgkJCQkvLyBjb25zb2xlLmxvZyhzcGxpbmVUdWJlLCAnc3BsaW5lVHViZScsIHNwbGluZVR1YmUubm9ybWFscy5sZW5ndGgsICdzdGVwcycsIHN0ZXBzLCAnZXh0cnVkZVB0cycsIGV4dHJ1ZGVQdHMubGVuZ3RoKTsKCgkJCQliaW5vcm1hbCA9IG5ldyBWZWN0b3IzKCk7CgkJCQlub3JtYWwgPSBuZXcgVmVjdG9yMygpOwoJCQkJcG9zaXRpb24yID0gbmV3IFZlY3RvcjMoKTsKCgkJCX0KCgkJCS8vIFNhZmVndWFyZHMgaWYgYmV2ZWxzIGFyZSBub3QgZW5hYmxlZAoKCQkJaWYgKCAhIGJldmVsRW5hYmxlZCApIHsKCgkJCQliZXZlbFNlZ21lbnRzID0gMDsKCQkJCWJldmVsVGhpY2tuZXNzID0gMDsKCQkJCWJldmVsU2l6ZSA9IDA7CgkJCQliZXZlbE9mZnNldCA9IDA7CgoJCQl9CgoJCQkvLyBWYXJpYWJsZXMgaW5pdGlhbGl6YXRpb24KCgkJCWNvbnN0IHNoYXBlUG9pbnRzID0gc2hhcGUuZXh0cmFjdFBvaW50cyggY3VydmVTZWdtZW50cyApOwoKCQkJbGV0IHZlcnRpY2VzID0gc2hhcGVQb2ludHMuc2hhcGU7CgkJCWNvbnN0IGhvbGVzID0gc2hhcGVQb2ludHMuaG9sZXM7CgoJCQljb25zdCByZXZlcnNlID0gISBTaGFwZVV0aWxzLmlzQ2xvY2tXaXNlKCB2ZXJ0aWNlcyApOwoKCQkJaWYgKCByZXZlcnNlICkgewoKCQkJCXZlcnRpY2VzID0gdmVydGljZXMucmV2ZXJzZSgpOwoKCQkJCS8vIE1heWJlIHdlIHNob3VsZCBhbHNvIGNoZWNrIGlmIGhvbGVzIGFyZSBpbiB0aGUgb3Bwb3NpdGUgZGlyZWN0aW9uLCBqdXN0IHRvIGJlIHNhZmUgLi4uCgoJCQkJZm9yICggbGV0IGggPSAwLCBobCA9IGhvbGVzLmxlbmd0aDsgaCA8IGhsOyBoICsrICkgewoKCQkJCQljb25zdCBhaG9sZSA9IGhvbGVzWyBoIF07CgoJCQkJCWlmICggU2hhcGVVdGlscy5pc0Nsb2NrV2lzZSggYWhvbGUgKSApIHsKCgkJCQkJCWhvbGVzWyBoIF0gPSBhaG9sZS5yZXZlcnNlKCk7CgoJCQkJCX0KCgkJCQl9CgoJCQl9CgoKCQkJY29uc3QgZmFjZXMgPSBTaGFwZVV0aWxzLnRyaWFuZ3VsYXRlU2hhcGUoIHZlcnRpY2VzLCBob2xlcyApOwoKCQkJLyogVmVydGljZXMgKi8KCgkJCWNvbnN0IGNvbnRvdXIgPSB2ZXJ0aWNlczsgLy8gdmVydGljZXMgaGFzIGFsbCBwb2ludHMgYnV0IGNvbnRvdXIgaGFzIG9ubHkgcG9pbnRzIG9mIGNpcmN1bWZlcmVuY2UKCgkJCWZvciAoIGxldCBoID0gMCwgaGwgPSBob2xlcy5sZW5ndGg7IGggPCBobDsgaCArKyApIHsKCgkJCQljb25zdCBhaG9sZSA9IGhvbGVzWyBoIF07CgoJCQkJdmVydGljZXMgPSB2ZXJ0aWNlcy5jb25jYXQoIGFob2xlICk7CgoJCQl9CgoKCQkJZnVuY3Rpb24gc2NhbGVQdDIoIHB0LCB2ZWMsIHNpemUgKSB7CgoJCQkJaWYgKCAhIHZlYyApIGNvbnNvbGUuZXJyb3IoICdUSFJFRS5FeHRydWRlR2VvbWV0cnk6IHZlYyBkb2VzIG5vdCBleGlzdCcgKTsKCgkJCQlyZXR1cm4gcHQuY2xvbmUoKS5hZGRTY2FsZWRWZWN0b3IoIHZlYywgc2l6ZSApOwoKCQkJfQoKCQkJY29uc3QgdmxlbiA9IHZlcnRpY2VzLmxlbmd0aCwgZmxlbiA9IGZhY2VzLmxlbmd0aDsKCgoJCQkvLyBGaW5kIGRpcmVjdGlvbnMgZm9yIHBvaW50IG1vdmVtZW50CgoKCQkJZnVuY3Rpb24gZ2V0QmV2ZWxWZWMoIGluUHQsIGluUHJldiwgaW5OZXh0ICkgewoKCQkJCS8vIGNvbXB1dGVzIGZvciBpblB0IHRoZSBjb3JyZXNwb25kaW5nIHBvaW50IGluUHQnIG9uIGEgbmV3IGNvbnRvdXIKCQkJCS8vICAgc2hpZnRlZCBieSAxIHVuaXQgKGxlbmd0aCBvZiBub3JtYWxpemVkIHZlY3RvcikgdG8gdGhlIGxlZnQKCQkJCS8vIGlmIHdlIHdhbGsgYWxvbmcgY29udG91ciBjbG9ja3dpc2UsIHRoaXMgbmV3IGNvbnRvdXIgaXMgb3V0c2lkZSB0aGUgb2xkIG9uZQoJCQkJLy8KCQkJCS8vIGluUHQnIGlzIHRoZSBpbnRlcnNlY3Rpb24gb2YgdGhlIHR3byBsaW5lcyBwYXJhbGxlbCB0byB0aGUgdHdvCgkJCQkvLyAgYWRqYWNlbnQgZWRnZXMgb2YgaW5QdCBhdCBhIGRpc3RhbmNlIG9mIDEgdW5pdCBvbiB0aGUgbGVmdCBzaWRlLgoKCQkJCWxldCB2X3RyYW5zX3gsIHZfdHJhbnNfeSwgc2hyaW5rX2J5OyAvLyByZXN1bHRpbmcgdHJhbnNsYXRpb24gdmVjdG9yIGZvciBpblB0CgoJCQkJLy8gZ29vZCByZWFkaW5nIGZvciBnZW9tZXRyeSBhbGdvcml0aG1zIChoZXJlOiBsaW5lLWxpbmUgaW50ZXJzZWN0aW9uKQoJCQkJLy8gaHR0cDovL2dlb21hbGdvcml0aG1zLmNvbS9hMDUtX2ludGVyc2VjdC0xLmh0bWwKCgkJCQljb25zdCB2X3ByZXZfeCA9IGluUHQueCAtIGluUHJldi54LAoJCQkJCXZfcHJldl95ID0gaW5QdC55IC0gaW5QcmV2Lnk7CgkJCQljb25zdCB2X25leHRfeCA9IGluTmV4dC54IC0gaW5QdC54LAoJCQkJCXZfbmV4dF95ID0gaW5OZXh0LnkgLSBpblB0Lnk7CgoJCQkJY29uc3Qgdl9wcmV2X2xlbnNxID0gKCB2X3ByZXZfeCAqIHZfcHJldl94ICsgdl9wcmV2X3kgKiB2X3ByZXZfeSApOwoKCQkJCS8vIGNoZWNrIGZvciBjb2xsaW5lYXIgZWRnZXMKCQkJCWNvbnN0IGNvbGxpbmVhcjAgPSAoIHZfcHJldl94ICogdl9uZXh0X3kgLSB2X3ByZXZfeSAqIHZfbmV4dF94ICk7CgoJCQkJaWYgKCBNYXRoLmFicyggY29sbGluZWFyMCApID4gTnVtYmVyLkVQU0lMT04gKSB7CgoJCQkJCS8vIG5vdCBjb2xsaW5lYXIKCgkJCQkJLy8gbGVuZ3RoIG9mIHZlY3RvcnMgZm9yIG5vcm1hbGl6aW5nCgoJCQkJCWNvbnN0IHZfcHJldl9sZW4gPSBNYXRoLnNxcnQoIHZfcHJldl9sZW5zcSApOwoJCQkJCWNvbnN0IHZfbmV4dF9sZW4gPSBNYXRoLnNxcnQoIHZfbmV4dF94ICogdl9uZXh0X3ggKyB2X25leHRfeSAqIHZfbmV4dF95ICk7CgoJCQkJCS8vIHNoaWZ0IGFkamFjZW50IHBvaW50cyBieSB1bml0IHZlY3RvcnMgdG8gdGhlIGxlZnQKCgkJCQkJY29uc3QgcHRQcmV2U2hpZnRfeCA9ICggaW5QcmV2LnggLSB2X3ByZXZfeSAvIHZfcHJldl9sZW4gKTsKCQkJCQljb25zdCBwdFByZXZTaGlmdF95ID0gKCBpblByZXYueSArIHZfcHJldl94IC8gdl9wcmV2X2xlbiApOwoKCQkJCQljb25zdCBwdE5leHRTaGlmdF94ID0gKCBpbk5leHQueCAtIHZfbmV4dF95IC8gdl9uZXh0X2xlbiApOwoJCQkJCWNvbnN0IHB0TmV4dFNoaWZ0X3kgPSAoIGluTmV4dC55ICsgdl9uZXh0X3ggLyB2X25leHRfbGVuICk7CgoJCQkJCS8vIHNjYWxpbmcgZmFjdG9yIGZvciB2X3ByZXYgdG8gaW50ZXJzZWN0aW9uIHBvaW50CgoJCQkJCWNvbnN0IHNmID0gKCAoIHB0TmV4dFNoaWZ0X3ggLSBwdFByZXZTaGlmdF94ICkgKiB2X25leHRfeSAtCgkJCQkJCQkoIHB0TmV4dFNoaWZ0X3kgLSBwdFByZXZTaGlmdF95ICkgKiB2X25leHRfeCApIC8KCQkJCQkJKCB2X3ByZXZfeCAqIHZfbmV4dF95IC0gdl9wcmV2X3kgKiB2X25leHRfeCApOwoKCQkJCQkvLyB2ZWN0b3IgZnJvbSBpblB0IHRvIGludGVyc2VjdGlvbiBwb2ludAoKCQkJCQl2X3RyYW5zX3ggPSAoIHB0UHJldlNoaWZ0X3ggKyB2X3ByZXZfeCAqIHNmIC0gaW5QdC54ICk7CgkJCQkJdl90cmFuc195ID0gKCBwdFByZXZTaGlmdF95ICsgdl9wcmV2X3kgKiBzZiAtIGluUHQueSApOwoKCQkJCQkvLyBEb24ndCBub3JtYWxpemUhLCBvdGhlcndpc2Ugc2hhcnAgY29ybmVycyBiZWNvbWUgdWdseQoJCQkJCS8vICBidXQgcHJldmVudCBjcmF6eSBzcGlrZXMKCQkJCQljb25zdCB2X3RyYW5zX2xlbnNxID0gKCB2X3RyYW5zX3ggKiB2X3RyYW5zX3ggKyB2X3RyYW5zX3kgKiB2X3RyYW5zX3kgKTsKCQkJCQlpZiAoIHZfdHJhbnNfbGVuc3EgPD0gMiApIHsKCgkJCQkJCXJldHVybiBuZXcgVmVjdG9yMiggdl90cmFuc194LCB2X3RyYW5zX3kgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXNocmlua19ieSA9IE1hdGguc3FydCggdl90cmFuc19sZW5zcSAvIDIgKTsKCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vIGhhbmRsZSBzcGVjaWFsIGNhc2Ugb2YgY29sbGluZWFyIGVkZ2VzCgoJCQkJCWxldCBkaXJlY3Rpb25fZXEgPSBmYWxzZTsgLy8gYXNzdW1lczogb3Bwb3NpdGUKCgkJCQkJaWYgKCB2X3ByZXZfeCA+IE51bWJlci5FUFNJTE9OICkgewoKCQkJCQkJaWYgKCB2X25leHRfeCA+IE51bWJlci5FUFNJTE9OICkgewoKCQkJCQkJCWRpcmVjdGlvbl9lcSA9IHRydWU7CgoJCQkJCQl9CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlpZiAoIHZfcHJldl94IDwgLSBOdW1iZXIuRVBTSUxPTiApIHsKCgkJCQkJCQlpZiAoIHZfbmV4dF94IDwgLSBOdW1iZXIuRVBTSUxPTiApIHsKCgkJCQkJCQkJZGlyZWN0aW9uX2VxID0gdHJ1ZTsKCgkJCQkJCQl9CgoJCQkJCQl9IGVsc2UgewoKCQkJCQkJCWlmICggTWF0aC5zaWduKCB2X3ByZXZfeSApID09PSBNYXRoLnNpZ24oIHZfbmV4dF95ICkgKSB7CgoJCQkJCQkJCWRpcmVjdGlvbl9lcSA9IHRydWU7CgoJCQkJCQkJfQoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICggZGlyZWN0aW9uX2VxICkgewoKCQkJCQkJLy8gY29uc29sZS5sb2coIldhcm5pbmc6IGxpbmVzIGFyZSBhIHN0cmFpZ2h0IHNlcXVlbmNlIik7CgkJCQkJCXZfdHJhbnNfeCA9IC0gdl9wcmV2X3k7CgkJCQkJCXZfdHJhbnNfeSA9IHZfcHJldl94OwoJCQkJCQlzaHJpbmtfYnkgPSBNYXRoLnNxcnQoIHZfcHJldl9sZW5zcSApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gY29uc29sZS5sb2coIldhcm5pbmc6IGxpbmVzIGFyZSBhIHN0cmFpZ2h0IHNwaWtlIik7CgkJCQkJCXZfdHJhbnNfeCA9IHZfcHJldl94OwoJCQkJCQl2X3RyYW5zX3kgPSB2X3ByZXZfeTsKCQkJCQkJc2hyaW5rX2J5ID0gTWF0aC5zcXJ0KCB2X3ByZXZfbGVuc3EgLyAyICk7CgoJCQkJCX0KCgkJCQl9CgoJCQkJcmV0dXJuIG5ldyBWZWN0b3IyKCB2X3RyYW5zX3ggLyBzaHJpbmtfYnksIHZfdHJhbnNfeSAvIHNocmlua19ieSApOwoKCQkJfQoKCgkJCWNvbnN0IGNvbnRvdXJNb3ZlbWVudHMgPSBbXTsKCgkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBjb250b3VyLmxlbmd0aCwgaiA9IGlsIC0gMSwgayA9IGkgKyAxOyBpIDwgaWw7IGkgKyssIGogKyssIGsgKysgKSB7CgoJCQkJaWYgKCBqID09PSBpbCApIGogPSAwOwoJCQkJaWYgKCBrID09PSBpbCApIGsgPSAwOwoKCQkJCS8vICAoaiktLS0oaSktLS0oaykKCQkJCS8vIGNvbnNvbGUubG9nKCdpLGosaycsIGksIGogLCBrKQoKCQkJCWNvbnRvdXJNb3ZlbWVudHNbIGkgXSA9IGdldEJldmVsVmVjKCBjb250b3VyWyBpIF0sIGNvbnRvdXJbIGogXSwgY29udG91clsgayBdICk7CgoJCQl9CgoJCQljb25zdCBob2xlc01vdmVtZW50cyA9IFtdOwoJCQlsZXQgb25lSG9sZU1vdmVtZW50cywgdmVydGljZXNNb3ZlbWVudHMgPSBjb250b3VyTW92ZW1lbnRzLmNvbmNhdCgpOwoKCQkJZm9yICggbGV0IGggPSAwLCBobCA9IGhvbGVzLmxlbmd0aDsgaCA8IGhsOyBoICsrICkgewoKCQkJCWNvbnN0IGFob2xlID0gaG9sZXNbIGggXTsKCgkJCQlvbmVIb2xlTW92ZW1lbnRzID0gW107CgoJCQkJZm9yICggbGV0IGkgPSAwLCBpbCA9IGFob2xlLmxlbmd0aCwgaiA9IGlsIC0gMSwgayA9IGkgKyAxOyBpIDwgaWw7IGkgKyssIGogKyssIGsgKysgKSB7CgoJCQkJCWlmICggaiA9PT0gaWwgKSBqID0gMDsKCQkJCQlpZiAoIGsgPT09IGlsICkgayA9IDA7CgoJCQkJCS8vICAoaiktLS0oaSktLS0oaykKCQkJCQlvbmVIb2xlTW92ZW1lbnRzWyBpIF0gPSBnZXRCZXZlbFZlYyggYWhvbGVbIGkgXSwgYWhvbGVbIGogXSwgYWhvbGVbIGsgXSApOwoKCQkJCX0KCgkJCQlob2xlc01vdmVtZW50cy5wdXNoKCBvbmVIb2xlTW92ZW1lbnRzICk7CgkJCQl2ZXJ0aWNlc01vdmVtZW50cyA9IHZlcnRpY2VzTW92ZW1lbnRzLmNvbmNhdCggb25lSG9sZU1vdmVtZW50cyApOwoKCQkJfQoKCgkJCS8vIExvb3AgYmV2ZWxTZWdtZW50cywgMSBmb3IgdGhlIGZyb250LCAxIGZvciB0aGUgYmFjawoKCQkJZm9yICggbGV0IGIgPSAwOyBiIDwgYmV2ZWxTZWdtZW50czsgYiArKyApIHsKCgkJCQkvL2ZvciAoIGIgPSBiZXZlbFNlZ21lbnRzOyBiID4gMDsgYiAtLSApIHsKCgkJCQljb25zdCB0ID0gYiAvIGJldmVsU2VnbWVudHM7CgkJCQljb25zdCB6ID0gYmV2ZWxUaGlja25lc3MgKiBNYXRoLmNvcyggdCAqIE1hdGguUEkgLyAyICk7CgkJCQljb25zdCBicyA9IGJldmVsU2l6ZSAqIE1hdGguc2luKCB0ICogTWF0aC5QSSAvIDIgKSArIGJldmVsT2Zmc2V0OwoKCQkJCS8vIGNvbnRyYWN0IHNoYXBlCgoJCQkJZm9yICggbGV0IGkgPSAwLCBpbCA9IGNvbnRvdXIubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQkJCWNvbnN0IHZlcnQgPSBzY2FsZVB0MiggY29udG91clsgaSBdLCBjb250b3VyTW92ZW1lbnRzWyBpIF0sIGJzICk7CgoJCQkJCXYoIHZlcnQueCwgdmVydC55LCAtIHogKTsKCgkJCQl9CgoJCQkJLy8gZXhwYW5kIGhvbGVzCgoJCQkJZm9yICggbGV0IGggPSAwLCBobCA9IGhvbGVzLmxlbmd0aDsgaCA8IGhsOyBoICsrICkgewoKCQkJCQljb25zdCBhaG9sZSA9IGhvbGVzWyBoIF07CgkJCQkJb25lSG9sZU1vdmVtZW50cyA9IGhvbGVzTW92ZW1lbnRzWyBoIF07CgoJCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBhaG9sZS5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCQkJCWNvbnN0IHZlcnQgPSBzY2FsZVB0MiggYWhvbGVbIGkgXSwgb25lSG9sZU1vdmVtZW50c1sgaSBdLCBicyApOwoKCQkJCQkJdiggdmVydC54LCB2ZXJ0LnksIC0geiApOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQkJY29uc3QgYnMgPSBiZXZlbFNpemUgKyBiZXZlbE9mZnNldDsKCgkJCS8vIEJhY2sgZmFjaW5nIHZlcnRpY2VzCgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB2bGVuOyBpICsrICkgewoKCQkJCWNvbnN0IHZlcnQgPSBiZXZlbEVuYWJsZWQgPyBzY2FsZVB0MiggdmVydGljZXNbIGkgXSwgdmVydGljZXNNb3ZlbWVudHNbIGkgXSwgYnMgKSA6IHZlcnRpY2VzWyBpIF07CgoJCQkJaWYgKCAhIGV4dHJ1ZGVCeVBhdGggKSB7CgoJCQkJCXYoIHZlcnQueCwgdmVydC55LCAwICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJLy8gdiggdmVydC54LCB2ZXJ0LnkgKyBleHRydWRlUHRzWyAwIF0ueSwgZXh0cnVkZVB0c1sgMCBdLnggKTsKCgkJCQkJbm9ybWFsLmNvcHkoIHNwbGluZVR1YmUubm9ybWFsc1sgMCBdICkubXVsdGlwbHlTY2FsYXIoIHZlcnQueCApOwoJCQkJCWJpbm9ybWFsLmNvcHkoIHNwbGluZVR1YmUuYmlub3JtYWxzWyAwIF0gKS5tdWx0aXBseVNjYWxhciggdmVydC55ICk7CgoJCQkJCXBvc2l0aW9uMi5jb3B5KCBleHRydWRlUHRzWyAwIF0gKS5hZGQoIG5vcm1hbCApLmFkZCggYmlub3JtYWwgKTsKCgkJCQkJdiggcG9zaXRpb24yLngsIHBvc2l0aW9uMi55LCBwb3NpdGlvbjIueiApOwoKCQkJCX0KCgkJCX0KCgkJCS8vIEFkZCBzdGVwcGVkIHZlcnRpY2VzLi4uCgkJCS8vIEluY2x1ZGluZyBmcm9udCBmYWNpbmcgdmVydGljZXMKCgkJCWZvciAoIGxldCBzID0gMTsgcyA8PSBzdGVwczsgcyArKyApIHsKCgkJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB2bGVuOyBpICsrICkgewoKCQkJCQljb25zdCB2ZXJ0ID0gYmV2ZWxFbmFibGVkID8gc2NhbGVQdDIoIHZlcnRpY2VzWyBpIF0sIHZlcnRpY2VzTW92ZW1lbnRzWyBpIF0sIGJzICkgOiB2ZXJ0aWNlc1sgaSBdOwoKCQkJCQlpZiAoICEgZXh0cnVkZUJ5UGF0aCApIHsKCgkJCQkJCXYoIHZlcnQueCwgdmVydC55LCBkZXB0aCAvIHN0ZXBzICogcyApOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJLy8gdiggdmVydC54LCB2ZXJ0LnkgKyBleHRydWRlUHRzWyBzIC0gMSBdLnksIGV4dHJ1ZGVQdHNbIHMgLSAxIF0ueCApOwoKCQkJCQkJbm9ybWFsLmNvcHkoIHNwbGluZVR1YmUubm9ybWFsc1sgcyBdICkubXVsdGlwbHlTY2FsYXIoIHZlcnQueCApOwoJCQkJCQliaW5vcm1hbC5jb3B5KCBzcGxpbmVUdWJlLmJpbm9ybWFsc1sgcyBdICkubXVsdGlwbHlTY2FsYXIoIHZlcnQueSApOwoKCQkJCQkJcG9zaXRpb24yLmNvcHkoIGV4dHJ1ZGVQdHNbIHMgXSApLmFkZCggbm9ybWFsICkuYWRkKCBiaW5vcm1hbCApOwoKCQkJCQkJdiggcG9zaXRpb24yLngsIHBvc2l0aW9uMi55LCBwb3NpdGlvbjIueiApOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCgkJCS8vIEFkZCBiZXZlbCBzZWdtZW50cyBwbGFuZXMKCgkJCS8vZm9yICggYiA9IDE7IGIgPD0gYmV2ZWxTZWdtZW50czsgYiArKyApIHsKCQkJZm9yICggbGV0IGIgPSBiZXZlbFNlZ21lbnRzIC0gMTsgYiA+PSAwOyBiIC0tICkgewoKCQkJCWNvbnN0IHQgPSBiIC8gYmV2ZWxTZWdtZW50czsKCQkJCWNvbnN0IHogPSBiZXZlbFRoaWNrbmVzcyAqIE1hdGguY29zKCB0ICogTWF0aC5QSSAvIDIgKTsKCQkJCWNvbnN0IGJzID0gYmV2ZWxTaXplICogTWF0aC5zaW4oIHQgKiBNYXRoLlBJIC8gMiApICsgYmV2ZWxPZmZzZXQ7CgoJCQkJLy8gY29udHJhY3Qgc2hhcGUKCgkJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gY29udG91ci5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCQkJY29uc3QgdmVydCA9IHNjYWxlUHQyKCBjb250b3VyWyBpIF0sIGNvbnRvdXJNb3ZlbWVudHNbIGkgXSwgYnMgKTsKCQkJCQl2KCB2ZXJ0LngsIHZlcnQueSwgZGVwdGggKyB6ICk7CgoJCQkJfQoKCQkJCS8vIGV4cGFuZCBob2xlcwoKCQkJCWZvciAoIGxldCBoID0gMCwgaGwgPSBob2xlcy5sZW5ndGg7IGggPCBobDsgaCArKyApIHsKCgkJCQkJY29uc3QgYWhvbGUgPSBob2xlc1sgaCBdOwoJCQkJCW9uZUhvbGVNb3ZlbWVudHMgPSBob2xlc01vdmVtZW50c1sgaCBdOwoKCQkJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gYWhvbGUubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQkJCQljb25zdCB2ZXJ0ID0gc2NhbGVQdDIoIGFob2xlWyBpIF0sIG9uZUhvbGVNb3ZlbWVudHNbIGkgXSwgYnMgKTsKCgkJCQkJCWlmICggISBleHRydWRlQnlQYXRoICkgewoKCQkJCQkJCXYoIHZlcnQueCwgdmVydC55LCBkZXB0aCArIHogKTsKCgkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJdiggdmVydC54LCB2ZXJ0LnkgKyBleHRydWRlUHRzWyBzdGVwcyAtIDEgXS55LCBleHRydWRlUHRzWyBzdGVwcyAtIDEgXS54ICsgeiApOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQkJLyogRmFjZXMgKi8KCgkJCS8vIFRvcCBhbmQgYm90dG9tIGZhY2VzCgoJCQlidWlsZExpZEZhY2VzKCk7CgoJCQkvLyBTaWRlcyBmYWNlcwoKCQkJYnVpbGRTaWRlRmFjZXMoKTsKCgoJCQkvLy8vLyAgSW50ZXJuYWwgZnVuY3Rpb25zCgoJCQlmdW5jdGlvbiBidWlsZExpZEZhY2VzKCkgewoKCQkJCWNvbnN0IHN0YXJ0ID0gdmVydGljZXNBcnJheS5sZW5ndGggLyAzOwoKCQkJCWlmICggYmV2ZWxFbmFibGVkICkgewoKCQkJCQlsZXQgbGF5ZXIgPSAwOyAvLyBzdGVwcyArIDEKCQkJCQlsZXQgb2Zmc2V0ID0gdmxlbiAqIGxheWVyOwoKCQkJCQkvLyBCb3R0b20gZmFjZXMKCgkJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgZmxlbjsgaSArKyApIHsKCgkJCQkJCWNvbnN0IGZhY2UgPSBmYWNlc1sgaSBdOwoJCQkJCQlmMyggZmFjZVsgMiBdICsgb2Zmc2V0LCBmYWNlWyAxIF0gKyBvZmZzZXQsIGZhY2VbIDAgXSArIG9mZnNldCApOwoKCQkJCQl9CgoJCQkJCWxheWVyID0gc3RlcHMgKyBiZXZlbFNlZ21lbnRzICogMjsKCQkJCQlvZmZzZXQgPSB2bGVuICogbGF5ZXI7CgoJCQkJCS8vIFRvcCBmYWNlcwoKCQkJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBmbGVuOyBpICsrICkgewoKCQkJCQkJY29uc3QgZmFjZSA9IGZhY2VzWyBpIF07CgkJCQkJCWYzKCBmYWNlWyAwIF0gKyBvZmZzZXQsIGZhY2VbIDEgXSArIG9mZnNldCwgZmFjZVsgMiBdICsgb2Zmc2V0ICk7CgoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQkvLyBCb3R0b20gZmFjZXMKCgkJCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgZmxlbjsgaSArKyApIHsKCgkJCQkJCWNvbnN0IGZhY2UgPSBmYWNlc1sgaSBdOwoJCQkJCQlmMyggZmFjZVsgMiBdLCBmYWNlWyAxIF0sIGZhY2VbIDAgXSApOwoKCQkJCQl9CgoJCQkJCS8vIFRvcCBmYWNlcwoKCQkJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBmbGVuOyBpICsrICkgewoKCQkJCQkJY29uc3QgZmFjZSA9IGZhY2VzWyBpIF07CgkJCQkJCWYzKCBmYWNlWyAwIF0gKyB2bGVuICogc3RlcHMsIGZhY2VbIDEgXSArIHZsZW4gKiBzdGVwcywgZmFjZVsgMiBdICsgdmxlbiAqIHN0ZXBzICk7CgoJCQkJCX0KCgkJCQl9CgoJCQkJc2NvcGUuYWRkR3JvdXAoIHN0YXJ0LCB2ZXJ0aWNlc0FycmF5Lmxlbmd0aCAvIDMgLSBzdGFydCwgMCApOwoKCQkJfQoKCQkJLy8gQ3JlYXRlIGZhY2VzIGZvciB0aGUgei1zaWRlcyBvZiB0aGUgc2hhcGUKCgkJCWZ1bmN0aW9uIGJ1aWxkU2lkZUZhY2VzKCkgewoKCQkJCWNvbnN0IHN0YXJ0ID0gdmVydGljZXNBcnJheS5sZW5ndGggLyAzOwoJCQkJbGV0IGxheWVyb2Zmc2V0ID0gMDsKCQkJCXNpZGV3YWxscyggY29udG91ciwgbGF5ZXJvZmZzZXQgKTsKCQkJCWxheWVyb2Zmc2V0ICs9IGNvbnRvdXIubGVuZ3RoOwoKCQkJCWZvciAoIGxldCBoID0gMCwgaGwgPSBob2xlcy5sZW5ndGg7IGggPCBobDsgaCArKyApIHsKCgkJCQkJY29uc3QgYWhvbGUgPSBob2xlc1sgaCBdOwoJCQkJCXNpZGV3YWxscyggYWhvbGUsIGxheWVyb2Zmc2V0ICk7CgoJCQkJCS8vLCB0cnVlCgkJCQkJbGF5ZXJvZmZzZXQgKz0gYWhvbGUubGVuZ3RoOwoKCQkJCX0KCgoJCQkJc2NvcGUuYWRkR3JvdXAoIHN0YXJ0LCB2ZXJ0aWNlc0FycmF5Lmxlbmd0aCAvIDMgLSBzdGFydCwgMSApOwoKCgkJCX0KCgkJCWZ1bmN0aW9uIHNpZGV3YWxscyggY29udG91ciwgbGF5ZXJvZmZzZXQgKSB7CgoJCQkJbGV0IGkgPSBjb250b3VyLmxlbmd0aDsKCgkJCQl3aGlsZSAoIC0tIGkgPj0gMCApIHsKCgkJCQkJY29uc3QgaiA9IGk7CgkJCQkJbGV0IGsgPSBpIC0gMTsKCQkJCQlpZiAoIGsgPCAwICkgayA9IGNvbnRvdXIubGVuZ3RoIC0gMTsKCgkJCQkJLy9jb25zb2xlLmxvZygnYicsIGksaiwgaS0xLCBrLHZlcnRpY2VzLmxlbmd0aCk7CgoJCQkJCWZvciAoIGxldCBzID0gMCwgc2wgPSAoIHN0ZXBzICsgYmV2ZWxTZWdtZW50cyAqIDIgKTsgcyA8IHNsOyBzICsrICkgewoKCQkJCQkJY29uc3Qgc2xlbjEgPSB2bGVuICogczsKCQkJCQkJY29uc3Qgc2xlbjIgPSB2bGVuICogKCBzICsgMSApOwoKCQkJCQkJY29uc3QgYSA9IGxheWVyb2Zmc2V0ICsgaiArIHNsZW4xLAoJCQkJCQkJYiA9IGxheWVyb2Zmc2V0ICsgayArIHNsZW4xLAoJCQkJCQkJYyA9IGxheWVyb2Zmc2V0ICsgayArIHNsZW4yLAoJCQkJCQkJZCA9IGxheWVyb2Zmc2V0ICsgaiArIHNsZW4yOwoKCQkJCQkJZjQoIGEsIGIsIGMsIGQgKTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJCWZ1bmN0aW9uIHYoIHgsIHksIHogKSB7CgoJCQkJcGxhY2Vob2xkZXIucHVzaCggeCApOwoJCQkJcGxhY2Vob2xkZXIucHVzaCggeSApOwoJCQkJcGxhY2Vob2xkZXIucHVzaCggeiApOwoKCQkJfQoKCgkJCWZ1bmN0aW9uIGYzKCBhLCBiLCBjICkgewoKCQkJCWFkZFZlcnRleCggYSApOwoJCQkJYWRkVmVydGV4KCBiICk7CgkJCQlhZGRWZXJ0ZXgoIGMgKTsKCgkJCQljb25zdCBuZXh0SW5kZXggPSB2ZXJ0aWNlc0FycmF5Lmxlbmd0aCAvIDM7CgkJCQljb25zdCB1dnMgPSB1dmdlbi5nZW5lcmF0ZVRvcFVWKCBzY29wZSwgdmVydGljZXNBcnJheSwgbmV4dEluZGV4IC0gMywgbmV4dEluZGV4IC0gMiwgbmV4dEluZGV4IC0gMSApOwoKCQkJCWFkZFVWKCB1dnNbIDAgXSApOwoJCQkJYWRkVVYoIHV2c1sgMSBdICk7CgkJCQlhZGRVViggdXZzWyAyIF0gKTsKCgkJCX0KCgkJCWZ1bmN0aW9uIGY0KCBhLCBiLCBjLCBkICkgewoKCQkJCWFkZFZlcnRleCggYSApOwoJCQkJYWRkVmVydGV4KCBiICk7CgkJCQlhZGRWZXJ0ZXgoIGQgKTsKCgkJCQlhZGRWZXJ0ZXgoIGIgKTsKCQkJCWFkZFZlcnRleCggYyApOwoJCQkJYWRkVmVydGV4KCBkICk7CgoKCQkJCWNvbnN0IG5leHRJbmRleCA9IHZlcnRpY2VzQXJyYXkubGVuZ3RoIC8gMzsKCQkJCWNvbnN0IHV2cyA9IHV2Z2VuLmdlbmVyYXRlU2lkZVdhbGxVViggc2NvcGUsIHZlcnRpY2VzQXJyYXksIG5leHRJbmRleCAtIDYsIG5leHRJbmRleCAtIDMsIG5leHRJbmRleCAtIDIsIG5leHRJbmRleCAtIDEgKTsKCgkJCQlhZGRVViggdXZzWyAwIF0gKTsKCQkJCWFkZFVWKCB1dnNbIDEgXSApOwoJCQkJYWRkVVYoIHV2c1sgMyBdICk7CgoJCQkJYWRkVVYoIHV2c1sgMSBdICk7CgkJCQlhZGRVViggdXZzWyAyIF0gKTsKCQkJCWFkZFVWKCB1dnNbIDMgXSApOwoKCQkJfQoKCQkJZnVuY3Rpb24gYWRkVmVydGV4KCBpbmRleCApIHsKCgkJCQl2ZXJ0aWNlc0FycmF5LnB1c2goIHBsYWNlaG9sZGVyWyBpbmRleCAqIDMgKyAwIF0gKTsKCQkJCXZlcnRpY2VzQXJyYXkucHVzaCggcGxhY2Vob2xkZXJbIGluZGV4ICogMyArIDEgXSApOwoJCQkJdmVydGljZXNBcnJheS5wdXNoKCBwbGFjZWhvbGRlclsgaW5kZXggKiAzICsgMiBdICk7CgoJCQl9CgoKCQkJZnVuY3Rpb24gYWRkVVYoIHZlY3RvcjIgKSB7CgoJCQkJdXZBcnJheS5wdXNoKCB2ZWN0b3IyLnggKTsKCQkJCXV2QXJyYXkucHVzaCggdmVjdG9yMi55ICk7CgoJCQl9CgoJCX0KCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gT2JqZWN0LmFzc2lnbigge30sIHNvdXJjZS5wYXJhbWV0ZXJzICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0pTT04oKSB7CgoJCWNvbnN0IGRhdGEgPSBzdXBlci50b0pTT04oKTsKCgkJY29uc3Qgc2hhcGVzID0gdGhpcy5wYXJhbWV0ZXJzLnNoYXBlczsKCQljb25zdCBvcHRpb25zID0gdGhpcy5wYXJhbWV0ZXJzLm9wdGlvbnM7CgoJCXJldHVybiB0b0pTT04kMSggc2hhcGVzLCBvcHRpb25zLCBkYXRhICk7CgoJfQoKCXN0YXRpYyBmcm9tSlNPTiggZGF0YSwgc2hhcGVzICkgewoKCQljb25zdCBnZW9tZXRyeVNoYXBlcyA9IFtdOwoKCQlmb3IgKCBsZXQgaiA9IDAsIGpsID0gZGF0YS5zaGFwZXMubGVuZ3RoOyBqIDwgamw7IGogKysgKSB7CgoJCQljb25zdCBzaGFwZSA9IHNoYXBlc1sgZGF0YS5zaGFwZXNbIGogXSBdOwoKCQkJZ2VvbWV0cnlTaGFwZXMucHVzaCggc2hhcGUgKTsKCgkJfQoKCQljb25zdCBleHRydWRlUGF0aCA9IGRhdGEub3B0aW9ucy5leHRydWRlUGF0aDsKCgkJaWYgKCBleHRydWRlUGF0aCAhPT0gdW5kZWZpbmVkICkgewoKCQkJZGF0YS5vcHRpb25zLmV4dHJ1ZGVQYXRoID0gbmV3IEN1cnZlc1sgZXh0cnVkZVBhdGgudHlwZSBdKCkuZnJvbUpTT04oIGV4dHJ1ZGVQYXRoICk7CgoJCX0KCgkJcmV0dXJuIG5ldyBFeHRydWRlR2VvbWV0cnkoIGdlb21ldHJ5U2hhcGVzLCBkYXRhLm9wdGlvbnMgKTsKCgl9Cgp9Cgpjb25zdCBXb3JsZFVWR2VuZXJhdG9yID0gewoKCWdlbmVyYXRlVG9wVVY6IGZ1bmN0aW9uICggZ2VvbWV0cnksIHZlcnRpY2VzLCBpbmRleEEsIGluZGV4QiwgaW5kZXhDICkgewoKCQljb25zdCBhX3ggPSB2ZXJ0aWNlc1sgaW5kZXhBICogMyBdOwoJCWNvbnN0IGFfeSA9IHZlcnRpY2VzWyBpbmRleEEgKiAzICsgMSBdOwoJCWNvbnN0IGJfeCA9IHZlcnRpY2VzWyBpbmRleEIgKiAzIF07CgkJY29uc3QgYl95ID0gdmVydGljZXNbIGluZGV4QiAqIDMgKyAxIF07CgkJY29uc3QgY194ID0gdmVydGljZXNbIGluZGV4QyAqIDMgXTsKCQljb25zdCBjX3kgPSB2ZXJ0aWNlc1sgaW5kZXhDICogMyArIDEgXTsKCgkJcmV0dXJuIFsKCQkJbmV3IFZlY3RvcjIoIGFfeCwgYV95ICksCgkJCW5ldyBWZWN0b3IyKCBiX3gsIGJfeSApLAoJCQluZXcgVmVjdG9yMiggY194LCBjX3kgKQoJCV07CgoJfSwKCglnZW5lcmF0ZVNpZGVXYWxsVVY6IGZ1bmN0aW9uICggZ2VvbWV0cnksIHZlcnRpY2VzLCBpbmRleEEsIGluZGV4QiwgaW5kZXhDLCBpbmRleEQgKSB7CgoJCWNvbnN0IGFfeCA9IHZlcnRpY2VzWyBpbmRleEEgKiAzIF07CgkJY29uc3QgYV95ID0gdmVydGljZXNbIGluZGV4QSAqIDMgKyAxIF07CgkJY29uc3QgYV96ID0gdmVydGljZXNbIGluZGV4QSAqIDMgKyAyIF07CgkJY29uc3QgYl94ID0gdmVydGljZXNbIGluZGV4QiAqIDMgXTsKCQljb25zdCBiX3kgPSB2ZXJ0aWNlc1sgaW5kZXhCICogMyArIDEgXTsKCQljb25zdCBiX3ogPSB2ZXJ0aWNlc1sgaW5kZXhCICogMyArIDIgXTsKCQljb25zdCBjX3ggPSB2ZXJ0aWNlc1sgaW5kZXhDICogMyBdOwoJCWNvbnN0IGNfeSA9IHZlcnRpY2VzWyBpbmRleEMgKiAzICsgMSBdOwoJCWNvbnN0IGNfeiA9IHZlcnRpY2VzWyBpbmRleEMgKiAzICsgMiBdOwoJCWNvbnN0IGRfeCA9IHZlcnRpY2VzWyBpbmRleEQgKiAzIF07CgkJY29uc3QgZF95ID0gdmVydGljZXNbIGluZGV4RCAqIDMgKyAxIF07CgkJY29uc3QgZF96ID0gdmVydGljZXNbIGluZGV4RCAqIDMgKyAyIF07CgoJCWlmICggTWF0aC5hYnMoIGFfeSAtIGJfeSApIDwgTWF0aC5hYnMoIGFfeCAtIGJfeCApICkgewoKCQkJcmV0dXJuIFsKCQkJCW5ldyBWZWN0b3IyKCBhX3gsIDEgLSBhX3ogKSwKCQkJCW5ldyBWZWN0b3IyKCBiX3gsIDEgLSBiX3ogKSwKCQkJCW5ldyBWZWN0b3IyKCBjX3gsIDEgLSBjX3ogKSwKCQkJCW5ldyBWZWN0b3IyKCBkX3gsIDEgLSBkX3ogKQoJCQldOwoKCQl9IGVsc2UgewoKCQkJcmV0dXJuIFsKCQkJCW5ldyBWZWN0b3IyKCBhX3ksIDEgLSBhX3ogKSwKCQkJCW5ldyBWZWN0b3IyKCBiX3ksIDEgLSBiX3ogKSwKCQkJCW5ldyBWZWN0b3IyKCBjX3ksIDEgLSBjX3ogKSwKCQkJCW5ldyBWZWN0b3IyKCBkX3ksIDEgLSBkX3ogKQoJCQldOwoKCQl9CgoJfQoKfTsKCmZ1bmN0aW9uIHRvSlNPTiQxKCBzaGFwZXMsIG9wdGlvbnMsIGRhdGEgKSB7CgoJZGF0YS5zaGFwZXMgPSBbXTsKCglpZiAoIEFycmF5LmlzQXJyYXkoIHNoYXBlcyApICkgewoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBzaGFwZXMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWNvbnN0IHNoYXBlID0gc2hhcGVzWyBpIF07CgoJCQlkYXRhLnNoYXBlcy5wdXNoKCBzaGFwZS51dWlkICk7CgoJCX0KCgl9IGVsc2UgewoKCQlkYXRhLnNoYXBlcy5wdXNoKCBzaGFwZXMudXVpZCApOwoKCX0KCglkYXRhLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKCB7fSwgb3B0aW9ucyApOwoKCWlmICggb3B0aW9ucy5leHRydWRlUGF0aCAhPT0gdW5kZWZpbmVkICkgZGF0YS5vcHRpb25zLmV4dHJ1ZGVQYXRoID0gb3B0aW9ucy5leHRydWRlUGF0aC50b0pTT04oKTsKCglyZXR1cm4gZGF0YTsKCn0KCmNsYXNzIEljb3NhaGVkcm9uR2VvbWV0cnkgZXh0ZW5kcyBQb2x5aGVkcm9uR2VvbWV0cnkgewoKCWNvbnN0cnVjdG9yKCByYWRpdXMgPSAxLCBkZXRhaWwgPSAwICkgewoKCQljb25zdCB0ID0gKCAxICsgTWF0aC5zcXJ0KCA1ICkgKSAvIDI7CgoJCWNvbnN0IHZlcnRpY2VzID0gWwoJCQktIDEsIHQsIDAsIAkxLCB0LCAwLCAJLSAxLCAtIHQsIDAsIAkxLCAtIHQsIDAsCgkJCTAsIC0gMSwgdCwgCTAsIDEsIHQsCTAsIC0gMSwgLSB0LCAJMCwgMSwgLSB0LAoJCQl0LCAwLCAtIDEsIAl0LCAwLCAxLCAJLSB0LCAwLCAtIDEsIAktIHQsIDAsIDEKCQldOwoKCQljb25zdCBpbmRpY2VzID0gWwoJCQkwLCAxMSwgNSwgCTAsIDUsIDEsIAkwLCAxLCA3LCAJMCwgNywgMTAsIAkwLCAxMCwgMTEsCgkJCTEsIDUsIDksIAk1LCAxMSwgNCwJMTEsIDEwLCAyLAkxMCwgNywgNiwJNywgMSwgOCwKCQkJMywgOSwgNCwgCTMsIDQsIDIsCTMsIDIsIDYsCTMsIDYsIDgsCTMsIDgsIDksCgkJCTQsIDksIDUsIAkyLCA0LCAxMSwJNiwgMiwgMTAsCTgsIDYsIDcsCTksIDgsIDEKCQldOwoKCQlzdXBlciggdmVydGljZXMsIGluZGljZXMsIHJhZGl1cywgZGV0YWlsICk7CgoJCXRoaXMudHlwZSA9ICdJY29zYWhlZHJvbkdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlyYWRpdXM6IHJhZGl1cywKCQkJZGV0YWlsOiBkZXRhaWwKCQl9OwoKCX0KCglzdGF0aWMgZnJvbUpTT04oIGRhdGEgKSB7CgoJCXJldHVybiBuZXcgSWNvc2FoZWRyb25HZW9tZXRyeSggZGF0YS5yYWRpdXMsIGRhdGEuZGV0YWlsICk7CgoJfQoKfQoKY2xhc3MgT2N0YWhlZHJvbkdlb21ldHJ5IGV4dGVuZHMgUG9seWhlZHJvbkdlb21ldHJ5IHsKCgljb25zdHJ1Y3RvciggcmFkaXVzID0gMSwgZGV0YWlsID0gMCApIHsKCgkJY29uc3QgdmVydGljZXMgPSBbCgkJCTEsIDAsIDAsIAktIDEsIDAsIDAsCTAsIDEsIDAsCgkJCTAsIC0gMSwgMCwgCTAsIDAsIDEsCTAsIDAsIC0gMQoJCV07CgoJCWNvbnN0IGluZGljZXMgPSBbCgkJCTAsIDIsIDQsCTAsIDQsIDMsCTAsIDMsIDUsCgkJCTAsIDUsIDIsCTEsIDIsIDUsCTEsIDUsIDMsCgkJCTEsIDMsIDQsCTEsIDQsIDIKCQldOwoKCQlzdXBlciggdmVydGljZXMsIGluZGljZXMsIHJhZGl1cywgZGV0YWlsICk7CgoJCXRoaXMudHlwZSA9ICdPY3RhaGVkcm9uR2VvbWV0cnknOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSB7CgkJCXJhZGl1czogcmFkaXVzLAoJCQlkZXRhaWw6IGRldGFpbAoJCX07CgoJfQoKCXN0YXRpYyBmcm9tSlNPTiggZGF0YSApIHsKCgkJcmV0dXJuIG5ldyBPY3RhaGVkcm9uR2VvbWV0cnkoIGRhdGEucmFkaXVzLCBkYXRhLmRldGFpbCApOwoKCX0KCn0KCmNsYXNzIFJpbmdHZW9tZXRyeSBleHRlbmRzIEJ1ZmZlckdlb21ldHJ5IHsKCgljb25zdHJ1Y3RvciggaW5uZXJSYWRpdXMgPSAwLjUsIG91dGVyUmFkaXVzID0gMSwgdGhldGFTZWdtZW50cyA9IDMyLCBwaGlTZWdtZW50cyA9IDEsIHRoZXRhU3RhcnQgPSAwLCB0aGV0YUxlbmd0aCA9IE1hdGguUEkgKiAyICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnUmluZ0dlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlpbm5lclJhZGl1czogaW5uZXJSYWRpdXMsCgkJCW91dGVyUmFkaXVzOiBvdXRlclJhZGl1cywKCQkJdGhldGFTZWdtZW50czogdGhldGFTZWdtZW50cywKCQkJcGhpU2VnbWVudHM6IHBoaVNlZ21lbnRzLAoJCQl0aGV0YVN0YXJ0OiB0aGV0YVN0YXJ0LAoJCQl0aGV0YUxlbmd0aDogdGhldGFMZW5ndGgKCQl9OwoKCQl0aGV0YVNlZ21lbnRzID0gTWF0aC5tYXgoIDMsIHRoZXRhU2VnbWVudHMgKTsKCQlwaGlTZWdtZW50cyA9IE1hdGgubWF4KCAxLCBwaGlTZWdtZW50cyApOwoKCQkvLyBidWZmZXJzCgoJCWNvbnN0IGluZGljZXMgPSBbXTsKCQljb25zdCB2ZXJ0aWNlcyA9IFtdOwoJCWNvbnN0IG5vcm1hbHMgPSBbXTsKCQljb25zdCB1dnMgPSBbXTsKCgkJLy8gc29tZSBoZWxwZXIgdmFyaWFibGVzCgoJCWxldCByYWRpdXMgPSBpbm5lclJhZGl1czsKCQljb25zdCByYWRpdXNTdGVwID0gKCAoIG91dGVyUmFkaXVzIC0gaW5uZXJSYWRpdXMgKSAvIHBoaVNlZ21lbnRzICk7CgkJY29uc3QgdmVydGV4ID0gbmV3IFZlY3RvcjMoKTsKCQljb25zdCB1diA9IG5ldyBWZWN0b3IyKCk7CgoJCS8vIGdlbmVyYXRlIHZlcnRpY2VzLCBub3JtYWxzIGFuZCB1dnMKCgkJZm9yICggbGV0IGogPSAwOyBqIDw9IHBoaVNlZ21lbnRzOyBqICsrICkgewoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDw9IHRoZXRhU2VnbWVudHM7IGkgKysgKSB7CgoJCQkJLy8gdmFsdWVzIGFyZSBnZW5lcmF0ZSBmcm9tIHRoZSBpbnNpZGUgb2YgdGhlIHJpbmcgdG8gdGhlIG91dHNpZGUKCgkJCQljb25zdCBzZWdtZW50ID0gdGhldGFTdGFydCArIGkgLyB0aGV0YVNlZ21lbnRzICogdGhldGFMZW5ndGg7CgoJCQkJLy8gdmVydGV4CgoJCQkJdmVydGV4LnggPSByYWRpdXMgKiBNYXRoLmNvcyggc2VnbWVudCApOwoJCQkJdmVydGV4LnkgPSByYWRpdXMgKiBNYXRoLnNpbiggc2VnbWVudCApOwoKCQkJCXZlcnRpY2VzLnB1c2goIHZlcnRleC54LCB2ZXJ0ZXgueSwgdmVydGV4LnogKTsKCgkJCQkvLyBub3JtYWwKCgkJCQlub3JtYWxzLnB1c2goIDAsIDAsIDEgKTsKCgkJCQkvLyB1dgoKCQkJCXV2LnggPSAoIHZlcnRleC54IC8gb3V0ZXJSYWRpdXMgKyAxICkgLyAyOwoJCQkJdXYueSA9ICggdmVydGV4LnkgLyBvdXRlclJhZGl1cyArIDEgKSAvIDI7CgoJCQkJdXZzLnB1c2goIHV2LngsIHV2LnkgKTsKCgkJCX0KCgkJCS8vIGluY3JlYXNlIHRoZSByYWRpdXMgZm9yIG5leHQgcm93IG9mIHZlcnRpY2VzCgoJCQlyYWRpdXMgKz0gcmFkaXVzU3RlcDsKCgkJfQoKCQkvLyBpbmRpY2VzCgoJCWZvciAoIGxldCBqID0gMDsgaiA8IHBoaVNlZ21lbnRzOyBqICsrICkgewoKCQkJY29uc3QgdGhldGFTZWdtZW50TGV2ZWwgPSBqICogKCB0aGV0YVNlZ21lbnRzICsgMSApOwoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDwgdGhldGFTZWdtZW50czsgaSArKyApIHsKCgkJCQljb25zdCBzZWdtZW50ID0gaSArIHRoZXRhU2VnbWVudExldmVsOwoKCQkJCWNvbnN0IGEgPSBzZWdtZW50OwoJCQkJY29uc3QgYiA9IHNlZ21lbnQgKyB0aGV0YVNlZ21lbnRzICsgMTsKCQkJCWNvbnN0IGMgPSBzZWdtZW50ICsgdGhldGFTZWdtZW50cyArIDI7CgkJCQljb25zdCBkID0gc2VnbWVudCArIDE7CgoJCQkJLy8gZmFjZXMKCgkJCQlpbmRpY2VzLnB1c2goIGEsIGIsIGQgKTsKCQkJCWluZGljZXMucHVzaCggYiwgYywgZCApOwoKCQkJfQoKCQl9CgoJCS8vIGJ1aWxkIGdlb21ldHJ5CgoJCXRoaXMuc2V0SW5kZXgoIGluZGljZXMgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHZlcnRpY2VzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ25vcm1hbCcsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCBub3JtYWxzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3V2JywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHV2cywgMiApICk7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oIHt9LCBzb3VyY2UucGFyYW1ldGVycyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQlyZXR1cm4gbmV3IFJpbmdHZW9tZXRyeSggZGF0YS5pbm5lclJhZGl1cywgZGF0YS5vdXRlclJhZGl1cywgZGF0YS50aGV0YVNlZ21lbnRzLCBkYXRhLnBoaVNlZ21lbnRzLCBkYXRhLnRoZXRhU3RhcnQsIGRhdGEudGhldGFMZW5ndGggKTsKCgl9Cgp9CgpjbGFzcyBTaGFwZUdlb21ldHJ5IGV4dGVuZHMgQnVmZmVyR2VvbWV0cnkgewoKCWNvbnN0cnVjdG9yKCBzaGFwZXMgPSBuZXcgU2hhcGUoIFsgbmV3IFZlY3RvcjIoIDAsIDAuNSApLCBuZXcgVmVjdG9yMiggLSAwLjUsIC0gMC41ICksIG5ldyBWZWN0b3IyKCAwLjUsIC0gMC41ICkgXSApLCBjdXJ2ZVNlZ21lbnRzID0gMTIgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMudHlwZSA9ICdTaGFwZUdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlzaGFwZXM6IHNoYXBlcywKCQkJY3VydmVTZWdtZW50czogY3VydmVTZWdtZW50cwoJCX07CgoJCS8vIGJ1ZmZlcnMKCgkJY29uc3QgaW5kaWNlcyA9IFtdOwoJCWNvbnN0IHZlcnRpY2VzID0gW107CgkJY29uc3Qgbm9ybWFscyA9IFtdOwoJCWNvbnN0IHV2cyA9IFtdOwoKCQkvLyBoZWxwZXIgdmFyaWFibGVzCgoJCWxldCBncm91cFN0YXJ0ID0gMDsKCQlsZXQgZ3JvdXBDb3VudCA9IDA7CgoJCS8vIGFsbG93IHNpbmdsZSBhbmQgYXJyYXkgdmFsdWVzIGZvciAic2hhcGVzIiBwYXJhbWV0ZXIKCgkJaWYgKCBBcnJheS5pc0FycmF5KCBzaGFwZXMgKSA9PT0gZmFsc2UgKSB7CgoJCQlhZGRTaGFwZSggc2hhcGVzICk7CgoJCX0gZWxzZSB7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBzaGFwZXMubGVuZ3RoOyBpICsrICkgewoKCQkJCWFkZFNoYXBlKCBzaGFwZXNbIGkgXSApOwoKCQkJCXRoaXMuYWRkR3JvdXAoIGdyb3VwU3RhcnQsIGdyb3VwQ291bnQsIGkgKTsgLy8gZW5hYmxlcyBNdWx0aU1hdGVyaWFsIHN1cHBvcnQKCgkJCQlncm91cFN0YXJ0ICs9IGdyb3VwQ291bnQ7CgkJCQlncm91cENvdW50ID0gMDsKCgkJCX0KCgkJfQoKCQkvLyBidWlsZCBnZW9tZXRyeQoKCQl0aGlzLnNldEluZGV4KCBpbmRpY2VzICk7CgkJdGhpcy5zZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCB2ZXJ0aWNlcywgMyApICk7CgkJdGhpcy5zZXRBdHRyaWJ1dGUoICdub3JtYWwnLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggbm9ybWFscywgMyApICk7CgkJdGhpcy5zZXRBdHRyaWJ1dGUoICd1dicsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCB1dnMsIDIgKSApOwoKCgkJLy8gaGVscGVyIGZ1bmN0aW9ucwoKCQlmdW5jdGlvbiBhZGRTaGFwZSggc2hhcGUgKSB7CgoJCQljb25zdCBpbmRleE9mZnNldCA9IHZlcnRpY2VzLmxlbmd0aCAvIDM7CgkJCWNvbnN0IHBvaW50cyA9IHNoYXBlLmV4dHJhY3RQb2ludHMoIGN1cnZlU2VnbWVudHMgKTsKCgkJCWxldCBzaGFwZVZlcnRpY2VzID0gcG9pbnRzLnNoYXBlOwoJCQljb25zdCBzaGFwZUhvbGVzID0gcG9pbnRzLmhvbGVzOwoKCQkJLy8gY2hlY2sgZGlyZWN0aW9uIG9mIHZlcnRpY2VzCgoJCQlpZiAoIFNoYXBlVXRpbHMuaXNDbG9ja1dpc2UoIHNoYXBlVmVydGljZXMgKSA9PT0gZmFsc2UgKSB7CgoJCQkJc2hhcGVWZXJ0aWNlcyA9IHNoYXBlVmVydGljZXMucmV2ZXJzZSgpOwoKCQkJfQoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gc2hhcGVIb2xlcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWNvbnN0IHNoYXBlSG9sZSA9IHNoYXBlSG9sZXNbIGkgXTsKCgkJCQlpZiAoIFNoYXBlVXRpbHMuaXNDbG9ja1dpc2UoIHNoYXBlSG9sZSApID09PSB0cnVlICkgewoKCQkJCQlzaGFwZUhvbGVzWyBpIF0gPSBzaGFwZUhvbGUucmV2ZXJzZSgpOwoKCQkJCX0KCgkJCX0KCgkJCWNvbnN0IGZhY2VzID0gU2hhcGVVdGlscy50cmlhbmd1bGF0ZVNoYXBlKCBzaGFwZVZlcnRpY2VzLCBzaGFwZUhvbGVzICk7CgoJCQkvLyBqb2luIHZlcnRpY2VzIG9mIGlubmVyIGFuZCBvdXRlciBwYXRocyB0byBhIHNpbmdsZSBhcnJheQoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gc2hhcGVIb2xlcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWNvbnN0IHNoYXBlSG9sZSA9IHNoYXBlSG9sZXNbIGkgXTsKCQkJCXNoYXBlVmVydGljZXMgPSBzaGFwZVZlcnRpY2VzLmNvbmNhdCggc2hhcGVIb2xlICk7CgoJCQl9CgoJCQkvLyB2ZXJ0aWNlcywgbm9ybWFscywgdXZzCgoJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBzaGFwZVZlcnRpY2VzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJY29uc3QgdmVydGV4ID0gc2hhcGVWZXJ0aWNlc1sgaSBdOwoKCQkJCXZlcnRpY2VzLnB1c2goIHZlcnRleC54LCB2ZXJ0ZXgueSwgMCApOwoJCQkJbm9ybWFscy5wdXNoKCAwLCAwLCAxICk7CgkJCQl1dnMucHVzaCggdmVydGV4LngsIHZlcnRleC55ICk7IC8vIHdvcmxkIHV2cwoKCQkJfQoKCQkJLy8gaW5kaWNlcwoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gZmFjZXMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQljb25zdCBmYWNlID0gZmFjZXNbIGkgXTsKCgkJCQljb25zdCBhID0gZmFjZVsgMCBdICsgaW5kZXhPZmZzZXQ7CgkJCQljb25zdCBiID0gZmFjZVsgMSBdICsgaW5kZXhPZmZzZXQ7CgkJCQljb25zdCBjID0gZmFjZVsgMiBdICsgaW5kZXhPZmZzZXQ7CgoJCQkJaW5kaWNlcy5wdXNoKCBhLCBiLCBjICk7CgkJCQlncm91cENvdW50ICs9IDM7CgoJCQl9CgoJCX0KCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gT2JqZWN0LmFzc2lnbigge30sIHNvdXJjZS5wYXJhbWV0ZXJzICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0pTT04oKSB7CgoJCWNvbnN0IGRhdGEgPSBzdXBlci50b0pTT04oKTsKCgkJY29uc3Qgc2hhcGVzID0gdGhpcy5wYXJhbWV0ZXJzLnNoYXBlczsKCgkJcmV0dXJuIHRvSlNPTiggc2hhcGVzLCBkYXRhICk7CgoJfQoKCXN0YXRpYyBmcm9tSlNPTiggZGF0YSwgc2hhcGVzICkgewoKCQljb25zdCBnZW9tZXRyeVNoYXBlcyA9IFtdOwoKCQlmb3IgKCBsZXQgaiA9IDAsIGpsID0gZGF0YS5zaGFwZXMubGVuZ3RoOyBqIDwgamw7IGogKysgKSB7CgoJCQljb25zdCBzaGFwZSA9IHNoYXBlc1sgZGF0YS5zaGFwZXNbIGogXSBdOwoKCQkJZ2VvbWV0cnlTaGFwZXMucHVzaCggc2hhcGUgKTsKCgkJfQoKCQlyZXR1cm4gbmV3IFNoYXBlR2VvbWV0cnkoIGdlb21ldHJ5U2hhcGVzLCBkYXRhLmN1cnZlU2VnbWVudHMgKTsKCgl9Cgp9CgpmdW5jdGlvbiB0b0pTT04oIHNoYXBlcywgZGF0YSApIHsKCglkYXRhLnNoYXBlcyA9IFtdOwoKCWlmICggQXJyYXkuaXNBcnJheSggc2hhcGVzICkgKSB7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IHNoYXBlcy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJY29uc3Qgc2hhcGUgPSBzaGFwZXNbIGkgXTsKCgkJCWRhdGEuc2hhcGVzLnB1c2goIHNoYXBlLnV1aWQgKTsKCgkJfQoKCX0gZWxzZSB7CgoJCWRhdGEuc2hhcGVzLnB1c2goIHNoYXBlcy51dWlkICk7CgoJfQoKCXJldHVybiBkYXRhOwoKfQoKY2xhc3MgU3BoZXJlR2VvbWV0cnkgZXh0ZW5kcyBCdWZmZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIHJhZGl1cyA9IDEsIHdpZHRoU2VnbWVudHMgPSAzMiwgaGVpZ2h0U2VnbWVudHMgPSAxNiwgcGhpU3RhcnQgPSAwLCBwaGlMZW5ndGggPSBNYXRoLlBJICogMiwgdGhldGFTdGFydCA9IDAsIHRoZXRhTGVuZ3RoID0gTWF0aC5QSSApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy50eXBlID0gJ1NwaGVyZUdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlyYWRpdXM6IHJhZGl1cywKCQkJd2lkdGhTZWdtZW50czogd2lkdGhTZWdtZW50cywKCQkJaGVpZ2h0U2VnbWVudHM6IGhlaWdodFNlZ21lbnRzLAoJCQlwaGlTdGFydDogcGhpU3RhcnQsCgkJCXBoaUxlbmd0aDogcGhpTGVuZ3RoLAoJCQl0aGV0YVN0YXJ0OiB0aGV0YVN0YXJ0LAoJCQl0aGV0YUxlbmd0aDogdGhldGFMZW5ndGgKCQl9OwoKCQl3aWR0aFNlZ21lbnRzID0gTWF0aC5tYXgoIDMsIE1hdGguZmxvb3IoIHdpZHRoU2VnbWVudHMgKSApOwoJCWhlaWdodFNlZ21lbnRzID0gTWF0aC5tYXgoIDIsIE1hdGguZmxvb3IoIGhlaWdodFNlZ21lbnRzICkgKTsKCgkJY29uc3QgdGhldGFFbmQgPSBNYXRoLm1pbiggdGhldGFTdGFydCArIHRoZXRhTGVuZ3RoLCBNYXRoLlBJICk7CgoJCWxldCBpbmRleCA9IDA7CgkJY29uc3QgZ3JpZCA9IFtdOwoKCQljb25zdCB2ZXJ0ZXggPSBuZXcgVmVjdG9yMygpOwoJCWNvbnN0IG5vcm1hbCA9IG5ldyBWZWN0b3IzKCk7CgoJCS8vIGJ1ZmZlcnMKCgkJY29uc3QgaW5kaWNlcyA9IFtdOwoJCWNvbnN0IHZlcnRpY2VzID0gW107CgkJY29uc3Qgbm9ybWFscyA9IFtdOwoJCWNvbnN0IHV2cyA9IFtdOwoKCQkvLyBnZW5lcmF0ZSB2ZXJ0aWNlcywgbm9ybWFscyBhbmQgdXZzCgoJCWZvciAoIGxldCBpeSA9IDA7IGl5IDw9IGhlaWdodFNlZ21lbnRzOyBpeSArKyApIHsKCgkJCWNvbnN0IHZlcnRpY2VzUm93ID0gW107CgoJCQljb25zdCB2ID0gaXkgLyBoZWlnaHRTZWdtZW50czsKCgkJCS8vIHNwZWNpYWwgY2FzZSBmb3IgdGhlIHBvbGVzCgoJCQlsZXQgdU9mZnNldCA9IDA7CgoJCQlpZiAoIGl5ID09PSAwICYmIHRoZXRhU3RhcnQgPT09IDAgKSB7CgoJCQkJdU9mZnNldCA9IDAuNSAvIHdpZHRoU2VnbWVudHM7CgoJCQl9IGVsc2UgaWYgKCBpeSA9PT0gaGVpZ2h0U2VnbWVudHMgJiYgdGhldGFFbmQgPT09IE1hdGguUEkgKSB7CgoJCQkJdU9mZnNldCA9IC0gMC41IC8gd2lkdGhTZWdtZW50czsKCgkJCX0KCgkJCWZvciAoIGxldCBpeCA9IDA7IGl4IDw9IHdpZHRoU2VnbWVudHM7IGl4ICsrICkgewoKCQkJCWNvbnN0IHUgPSBpeCAvIHdpZHRoU2VnbWVudHM7CgoJCQkJLy8gdmVydGV4CgoJCQkJdmVydGV4LnggPSAtIHJhZGl1cyAqIE1hdGguY29zKCBwaGlTdGFydCArIHUgKiBwaGlMZW5ndGggKSAqIE1hdGguc2luKCB0aGV0YVN0YXJ0ICsgdiAqIHRoZXRhTGVuZ3RoICk7CgkJCQl2ZXJ0ZXgueSA9IHJhZGl1cyAqIE1hdGguY29zKCB0aGV0YVN0YXJ0ICsgdiAqIHRoZXRhTGVuZ3RoICk7CgkJCQl2ZXJ0ZXgueiA9IHJhZGl1cyAqIE1hdGguc2luKCBwaGlTdGFydCArIHUgKiBwaGlMZW5ndGggKSAqIE1hdGguc2luKCB0aGV0YVN0YXJ0ICsgdiAqIHRoZXRhTGVuZ3RoICk7CgoJCQkJdmVydGljZXMucHVzaCggdmVydGV4LngsIHZlcnRleC55LCB2ZXJ0ZXgueiApOwoKCQkJCS8vIG5vcm1hbAoKCQkJCW5vcm1hbC5jb3B5KCB2ZXJ0ZXggKS5ub3JtYWxpemUoKTsKCQkJCW5vcm1hbHMucHVzaCggbm9ybWFsLngsIG5vcm1hbC55LCBub3JtYWwueiApOwoKCQkJCS8vIHV2CgoJCQkJdXZzLnB1c2goIHUgKyB1T2Zmc2V0LCAxIC0gdiApOwoKCQkJCXZlcnRpY2VzUm93LnB1c2goIGluZGV4ICsrICk7CgoJCQl9CgoJCQlncmlkLnB1c2goIHZlcnRpY2VzUm93ICk7CgoJCX0KCgkJLy8gaW5kaWNlcwoKCQlmb3IgKCBsZXQgaXkgPSAwOyBpeSA8IGhlaWdodFNlZ21lbnRzOyBpeSArKyApIHsKCgkJCWZvciAoIGxldCBpeCA9IDA7IGl4IDwgd2lkdGhTZWdtZW50czsgaXggKysgKSB7CgoJCQkJY29uc3QgYSA9IGdyaWRbIGl5IF1bIGl4ICsgMSBdOwoJCQkJY29uc3QgYiA9IGdyaWRbIGl5IF1bIGl4IF07CgkJCQljb25zdCBjID0gZ3JpZFsgaXkgKyAxIF1bIGl4IF07CgkJCQljb25zdCBkID0gZ3JpZFsgaXkgKyAxIF1bIGl4ICsgMSBdOwoKCQkJCWlmICggaXkgIT09IDAgfHwgdGhldGFTdGFydCA+IDAgKSBpbmRpY2VzLnB1c2goIGEsIGIsIGQgKTsKCQkJCWlmICggaXkgIT09IGhlaWdodFNlZ21lbnRzIC0gMSB8fCB0aGV0YUVuZCA8IE1hdGguUEkgKSBpbmRpY2VzLnB1c2goIGIsIGMsIGQgKTsKCgkJCX0KCgkJfQoKCQkvLyBidWlsZCBnZW9tZXRyeQoKCQl0aGlzLnNldEluZGV4KCBpbmRpY2VzICk7CgkJdGhpcy5zZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCB2ZXJ0aWNlcywgMyApICk7CgkJdGhpcy5zZXRBdHRyaWJ1dGUoICdub3JtYWwnLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggbm9ybWFscywgMyApICk7CgkJdGhpcy5zZXRBdHRyaWJ1dGUoICd1dicsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCB1dnMsIDIgKSApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKCB7fSwgc291cmNlLnBhcmFtZXRlcnMgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXN0YXRpYyBmcm9tSlNPTiggZGF0YSApIHsKCgkJcmV0dXJuIG5ldyBTcGhlcmVHZW9tZXRyeSggZGF0YS5yYWRpdXMsIGRhdGEud2lkdGhTZWdtZW50cywgZGF0YS5oZWlnaHRTZWdtZW50cywgZGF0YS5waGlTdGFydCwgZGF0YS5waGlMZW5ndGgsIGRhdGEudGhldGFTdGFydCwgZGF0YS50aGV0YUxlbmd0aCApOwoKCX0KCn0KCmNsYXNzIFRldHJhaGVkcm9uR2VvbWV0cnkgZXh0ZW5kcyBQb2x5aGVkcm9uR2VvbWV0cnkgewoKCWNvbnN0cnVjdG9yKCByYWRpdXMgPSAxLCBkZXRhaWwgPSAwICkgewoKCQljb25zdCB2ZXJ0aWNlcyA9IFsKCQkJMSwgMSwgMSwgCS0gMSwgLSAxLCAxLCAJLSAxLCAxLCAtIDEsIAkxLCAtIDEsIC0gMQoJCV07CgoJCWNvbnN0IGluZGljZXMgPSBbCgkJCTIsIDEsIDAsIAkwLCAzLCAyLAkxLCAzLCAwLAkyLCAzLCAxCgkJXTsKCgkJc3VwZXIoIHZlcnRpY2VzLCBpbmRpY2VzLCByYWRpdXMsIGRldGFpbCApOwoKCQl0aGlzLnR5cGUgPSAnVGV0cmFoZWRyb25HZW9tZXRyeSc7CgoJCXRoaXMucGFyYW1ldGVycyA9IHsKCQkJcmFkaXVzOiByYWRpdXMsCgkJCWRldGFpbDogZGV0YWlsCgkJfTsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQlyZXR1cm4gbmV3IFRldHJhaGVkcm9uR2VvbWV0cnkoIGRhdGEucmFkaXVzLCBkYXRhLmRldGFpbCApOwoKCX0KCn0KCmNsYXNzIFRvcnVzR2VvbWV0cnkgZXh0ZW5kcyBCdWZmZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIHJhZGl1cyA9IDEsIHR1YmUgPSAwLjQsIHJhZGlhbFNlZ21lbnRzID0gMTIsIHR1YnVsYXJTZWdtZW50cyA9IDQ4LCBhcmMgPSBNYXRoLlBJICogMiApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy50eXBlID0gJ1RvcnVzR2VvbWV0cnknOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSB7CgkJCXJhZGl1czogcmFkaXVzLAoJCQl0dWJlOiB0dWJlLAoJCQlyYWRpYWxTZWdtZW50czogcmFkaWFsU2VnbWVudHMsCgkJCXR1YnVsYXJTZWdtZW50czogdHVidWxhclNlZ21lbnRzLAoJCQlhcmM6IGFyYwoJCX07CgoJCXJhZGlhbFNlZ21lbnRzID0gTWF0aC5mbG9vciggcmFkaWFsU2VnbWVudHMgKTsKCQl0dWJ1bGFyU2VnbWVudHMgPSBNYXRoLmZsb29yKCB0dWJ1bGFyU2VnbWVudHMgKTsKCgkJLy8gYnVmZmVycwoKCQljb25zdCBpbmRpY2VzID0gW107CgkJY29uc3QgdmVydGljZXMgPSBbXTsKCQljb25zdCBub3JtYWxzID0gW107CgkJY29uc3QgdXZzID0gW107CgoJCS8vIGhlbHBlciB2YXJpYWJsZXMKCgkJY29uc3QgY2VudGVyID0gbmV3IFZlY3RvcjMoKTsKCQljb25zdCB2ZXJ0ZXggPSBuZXcgVmVjdG9yMygpOwoJCWNvbnN0IG5vcm1hbCA9IG5ldyBWZWN0b3IzKCk7CgoJCS8vIGdlbmVyYXRlIHZlcnRpY2VzLCBub3JtYWxzIGFuZCB1dnMKCgkJZm9yICggbGV0IGogPSAwOyBqIDw9IHJhZGlhbFNlZ21lbnRzOyBqICsrICkgewoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDw9IHR1YnVsYXJTZWdtZW50czsgaSArKyApIHsKCgkJCQljb25zdCB1ID0gaSAvIHR1YnVsYXJTZWdtZW50cyAqIGFyYzsKCQkJCWNvbnN0IHYgPSBqIC8gcmFkaWFsU2VnbWVudHMgKiBNYXRoLlBJICogMjsKCgkJCQkvLyB2ZXJ0ZXgKCgkJCQl2ZXJ0ZXgueCA9ICggcmFkaXVzICsgdHViZSAqIE1hdGguY29zKCB2ICkgKSAqIE1hdGguY29zKCB1ICk7CgkJCQl2ZXJ0ZXgueSA9ICggcmFkaXVzICsgdHViZSAqIE1hdGguY29zKCB2ICkgKSAqIE1hdGguc2luKCB1ICk7CgkJCQl2ZXJ0ZXgueiA9IHR1YmUgKiBNYXRoLnNpbiggdiApOwoKCQkJCXZlcnRpY2VzLnB1c2goIHZlcnRleC54LCB2ZXJ0ZXgueSwgdmVydGV4LnogKTsKCgkJCQkvLyBub3JtYWwKCgkJCQljZW50ZXIueCA9IHJhZGl1cyAqIE1hdGguY29zKCB1ICk7CgkJCQljZW50ZXIueSA9IHJhZGl1cyAqIE1hdGguc2luKCB1ICk7CgkJCQlub3JtYWwuc3ViVmVjdG9ycyggdmVydGV4LCBjZW50ZXIgKS5ub3JtYWxpemUoKTsKCgkJCQlub3JtYWxzLnB1c2goIG5vcm1hbC54LCBub3JtYWwueSwgbm9ybWFsLnogKTsKCgkJCQkvLyB1dgoKCQkJCXV2cy5wdXNoKCBpIC8gdHVidWxhclNlZ21lbnRzICk7CgkJCQl1dnMucHVzaCggaiAvIHJhZGlhbFNlZ21lbnRzICk7CgoJCQl9CgoJCX0KCgkJLy8gZ2VuZXJhdGUgaW5kaWNlcwoKCQlmb3IgKCBsZXQgaiA9IDE7IGogPD0gcmFkaWFsU2VnbWVudHM7IGogKysgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDE7IGkgPD0gdHVidWxhclNlZ21lbnRzOyBpICsrICkgewoKCQkJCS8vIGluZGljZXMKCgkJCQljb25zdCBhID0gKCB0dWJ1bGFyU2VnbWVudHMgKyAxICkgKiBqICsgaSAtIDE7CgkJCQljb25zdCBiID0gKCB0dWJ1bGFyU2VnbWVudHMgKyAxICkgKiAoIGogLSAxICkgKyBpIC0gMTsKCQkJCWNvbnN0IGMgPSAoIHR1YnVsYXJTZWdtZW50cyArIDEgKSAqICggaiAtIDEgKSArIGk7CgkJCQljb25zdCBkID0gKCB0dWJ1bGFyU2VnbWVudHMgKyAxICkgKiBqICsgaTsKCgkJCQkvLyBmYWNlcwoKCQkJCWluZGljZXMucHVzaCggYSwgYiwgZCApOwoJCQkJaW5kaWNlcy5wdXNoKCBiLCBjLCBkICk7CgoJCQl9CgoJCX0KCgkJLy8gYnVpbGQgZ2VvbWV0cnkKCgkJdGhpcy5zZXRJbmRleCggaW5kaWNlcyApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdmVydGljZXMsIDMgKSApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAnbm9ybWFsJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIG5vcm1hbHMsIDMgKSApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAndXYnLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdXZzLCAyICkgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gT2JqZWN0LmFzc2lnbigge30sIHNvdXJjZS5wYXJhbWV0ZXJzICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzdGF0aWMgZnJvbUpTT04oIGRhdGEgKSB7CgoJCXJldHVybiBuZXcgVG9ydXNHZW9tZXRyeSggZGF0YS5yYWRpdXMsIGRhdGEudHViZSwgZGF0YS5yYWRpYWxTZWdtZW50cywgZGF0YS50dWJ1bGFyU2VnbWVudHMsIGRhdGEuYXJjICk7CgoJfQoKfQoKY2xhc3MgVG9ydXNLbm90R2VvbWV0cnkgZXh0ZW5kcyBCdWZmZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIHJhZGl1cyA9IDEsIHR1YmUgPSAwLjQsIHR1YnVsYXJTZWdtZW50cyA9IDY0LCByYWRpYWxTZWdtZW50cyA9IDgsIHAgPSAyLCBxID0gMyApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy50eXBlID0gJ1RvcnVzS25vdEdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlyYWRpdXM6IHJhZGl1cywKCQkJdHViZTogdHViZSwKCQkJdHVidWxhclNlZ21lbnRzOiB0dWJ1bGFyU2VnbWVudHMsCgkJCXJhZGlhbFNlZ21lbnRzOiByYWRpYWxTZWdtZW50cywKCQkJcDogcCwKCQkJcTogcQoJCX07CgoJCXR1YnVsYXJTZWdtZW50cyA9IE1hdGguZmxvb3IoIHR1YnVsYXJTZWdtZW50cyApOwoJCXJhZGlhbFNlZ21lbnRzID0gTWF0aC5mbG9vciggcmFkaWFsU2VnbWVudHMgKTsKCgkJLy8gYnVmZmVycwoKCQljb25zdCBpbmRpY2VzID0gW107CgkJY29uc3QgdmVydGljZXMgPSBbXTsKCQljb25zdCBub3JtYWxzID0gW107CgkJY29uc3QgdXZzID0gW107CgoJCS8vIGhlbHBlciB2YXJpYWJsZXMKCgkJY29uc3QgdmVydGV4ID0gbmV3IFZlY3RvcjMoKTsKCQljb25zdCBub3JtYWwgPSBuZXcgVmVjdG9yMygpOwoKCQljb25zdCBQMSA9IG5ldyBWZWN0b3IzKCk7CgkJY29uc3QgUDIgPSBuZXcgVmVjdG9yMygpOwoKCQljb25zdCBCID0gbmV3IFZlY3RvcjMoKTsKCQljb25zdCBUID0gbmV3IFZlY3RvcjMoKTsKCQljb25zdCBOID0gbmV3IFZlY3RvcjMoKTsKCgkJLy8gZ2VuZXJhdGUgdmVydGljZXMsIG5vcm1hbHMgYW5kIHV2cwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPD0gdHVidWxhclNlZ21lbnRzOyArKyBpICkgewoKCQkJLy8gdGhlIHJhZGlhbiAidSIgaXMgdXNlZCB0byBjYWxjdWxhdGUgdGhlIHBvc2l0aW9uIG9uIHRoZSB0b3J1cyBjdXJ2ZSBvZiB0aGUgY3VycmVudCB0dWJ1bGFyIHNlZ21lbnQKCgkJCWNvbnN0IHUgPSBpIC8gdHVidWxhclNlZ21lbnRzICogcCAqIE1hdGguUEkgKiAyOwoKCQkJLy8gbm93IHdlIGNhbGN1bGF0ZSB0d28gcG9pbnRzLiBQMSBpcyBvdXIgY3VycmVudCBwb3NpdGlvbiBvbiB0aGUgY3VydmUsIFAyIGlzIGEgbGl0dGxlIGZhcnRoZXIgYWhlYWQuCgkJCS8vIHRoZXNlIHBvaW50cyBhcmUgdXNlZCB0byBjcmVhdGUgYSBzcGVjaWFsICJjb29yZGluYXRlIHNwYWNlIiwgd2hpY2ggaXMgbmVjZXNzYXJ5IHRvIGNhbGN1bGF0ZSB0aGUgY29ycmVjdCB2ZXJ0ZXggcG9zaXRpb25zCgoJCQljYWxjdWxhdGVQb3NpdGlvbk9uQ3VydmUoIHUsIHAsIHEsIHJhZGl1cywgUDEgKTsKCQkJY2FsY3VsYXRlUG9zaXRpb25PbkN1cnZlKCB1ICsgMC4wMSwgcCwgcSwgcmFkaXVzLCBQMiApOwoKCQkJLy8gY2FsY3VsYXRlIG9ydGhvbm9ybWFsIGJhc2lzCgoJCQlULnN1YlZlY3RvcnMoIFAyLCBQMSApOwoJCQlOLmFkZFZlY3RvcnMoIFAyLCBQMSApOwoJCQlCLmNyb3NzVmVjdG9ycyggVCwgTiApOwoJCQlOLmNyb3NzVmVjdG9ycyggQiwgVCApOwoKCQkJLy8gbm9ybWFsaXplIEIsIE4uIFQgY2FuIGJlIGlnbm9yZWQsIHdlIGRvbid0IHVzZSBpdAoKCQkJQi5ub3JtYWxpemUoKTsKCQkJTi5ub3JtYWxpemUoKTsKCgkJCWZvciAoIGxldCBqID0gMDsgaiA8PSByYWRpYWxTZWdtZW50czsgKysgaiApIHsKCgkJCQkvLyBub3cgY2FsY3VsYXRlIHRoZSB2ZXJ0aWNlcy4gdGhleSBhcmUgbm90aGluZyBtb3JlIHRoYW4gYW4gZXh0cnVzaW9uIG9mIHRoZSB0b3J1cyBjdXJ2ZS4KCQkJCS8vIGJlY2F1c2Ugd2UgZXh0cnVkZSBhIHNoYXBlIGluIHRoZSB4eS1wbGFuZSwgdGhlcmUgaXMgbm8gbmVlZCB0byBjYWxjdWxhdGUgYSB6LXZhbHVlLgoKCQkJCWNvbnN0IHYgPSBqIC8gcmFkaWFsU2VnbWVudHMgKiBNYXRoLlBJICogMjsKCQkJCWNvbnN0IGN4ID0gLSB0dWJlICogTWF0aC5jb3MoIHYgKTsKCQkJCWNvbnN0IGN5ID0gdHViZSAqIE1hdGguc2luKCB2ICk7CgoJCQkJLy8gbm93IGNhbGN1bGF0ZSB0aGUgZmluYWwgdmVydGV4IHBvc2l0aW9uLgoJCQkJLy8gZmlyc3Qgd2Ugb3JpZW50IHRoZSBleHRydXNpb24gd2l0aCBvdXIgYmFzaXMgdmVjdG9ycywgdGhlbiB3ZSBhZGQgaXQgdG8gdGhlIGN1cnJlbnQgcG9zaXRpb24gb24gdGhlIGN1cnZlCgoJCQkJdmVydGV4LnggPSBQMS54ICsgKCBjeCAqIE4ueCArIGN5ICogQi54ICk7CgkJCQl2ZXJ0ZXgueSA9IFAxLnkgKyAoIGN4ICogTi55ICsgY3kgKiBCLnkgKTsKCQkJCXZlcnRleC56ID0gUDEueiArICggY3ggKiBOLnogKyBjeSAqIEIueiApOwoKCQkJCXZlcnRpY2VzLnB1c2goIHZlcnRleC54LCB2ZXJ0ZXgueSwgdmVydGV4LnogKTsKCgkJCQkvLyBub3JtYWwgKFAxIGlzIGFsd2F5cyB0aGUgY2VudGVyL29yaWdpbiBvZiB0aGUgZXh0cnVzaW9uLCB0aHVzIHdlIGNhbiB1c2UgaXQgdG8gY2FsY3VsYXRlIHRoZSBub3JtYWwpCgoJCQkJbm9ybWFsLnN1YlZlY3RvcnMoIHZlcnRleCwgUDEgKS5ub3JtYWxpemUoKTsKCgkJCQlub3JtYWxzLnB1c2goIG5vcm1hbC54LCBub3JtYWwueSwgbm9ybWFsLnogKTsKCgkJCQkvLyB1dgoKCQkJCXV2cy5wdXNoKCBpIC8gdHVidWxhclNlZ21lbnRzICk7CgkJCQl1dnMucHVzaCggaiAvIHJhZGlhbFNlZ21lbnRzICk7CgoJCQl9CgoJCX0KCgkJLy8gZ2VuZXJhdGUgaW5kaWNlcwoKCQlmb3IgKCBsZXQgaiA9IDE7IGogPD0gdHVidWxhclNlZ21lbnRzOyBqICsrICkgewoKCQkJZm9yICggbGV0IGkgPSAxOyBpIDw9IHJhZGlhbFNlZ21lbnRzOyBpICsrICkgewoKCQkJCS8vIGluZGljZXMKCgkJCQljb25zdCBhID0gKCByYWRpYWxTZWdtZW50cyArIDEgKSAqICggaiAtIDEgKSArICggaSAtIDEgKTsKCQkJCWNvbnN0IGIgPSAoIHJhZGlhbFNlZ21lbnRzICsgMSApICogaiArICggaSAtIDEgKTsKCQkJCWNvbnN0IGMgPSAoIHJhZGlhbFNlZ21lbnRzICsgMSApICogaiArIGk7CgkJCQljb25zdCBkID0gKCByYWRpYWxTZWdtZW50cyArIDEgKSAqICggaiAtIDEgKSArIGk7CgoJCQkJLy8gZmFjZXMKCgkJCQlpbmRpY2VzLnB1c2goIGEsIGIsIGQgKTsKCQkJCWluZGljZXMucHVzaCggYiwgYywgZCApOwoKCQkJfQoKCQl9CgoJCS8vIGJ1aWxkIGdlb21ldHJ5CgoJCXRoaXMuc2V0SW5kZXgoIGluZGljZXMgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHZlcnRpY2VzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ25vcm1hbCcsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCBub3JtYWxzLCAzICkgKTsKCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3V2JywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHV2cywgMiApICk7CgoJCS8vIHRoaXMgZnVuY3Rpb24gY2FsY3VsYXRlcyB0aGUgY3VycmVudCBwb3NpdGlvbiBvbiB0aGUgdG9ydXMgY3VydmUKCgkJZnVuY3Rpb24gY2FsY3VsYXRlUG9zaXRpb25PbkN1cnZlKCB1LCBwLCBxLCByYWRpdXMsIHBvc2l0aW9uICkgewoKCQkJY29uc3QgY3UgPSBNYXRoLmNvcyggdSApOwoJCQljb25zdCBzdSA9IE1hdGguc2luKCB1ICk7CgkJCWNvbnN0IHF1T3ZlclAgPSBxIC8gcCAqIHU7CgkJCWNvbnN0IGNzID0gTWF0aC5jb3MoIHF1T3ZlclAgKTsKCgkJCXBvc2l0aW9uLnggPSByYWRpdXMgKiAoIDIgKyBjcyApICogMC41ICogY3U7CgkJCXBvc2l0aW9uLnkgPSByYWRpdXMgKiAoIDIgKyBjcyApICogc3UgKiAwLjU7CgkJCXBvc2l0aW9uLnogPSByYWRpdXMgKiBNYXRoLnNpbiggcXVPdmVyUCApICogMC41OwoKCQl9CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oIHt9LCBzb3VyY2UucGFyYW1ldGVycyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQlyZXR1cm4gbmV3IFRvcnVzS25vdEdlb21ldHJ5KCBkYXRhLnJhZGl1cywgZGF0YS50dWJlLCBkYXRhLnR1YnVsYXJTZWdtZW50cywgZGF0YS5yYWRpYWxTZWdtZW50cywgZGF0YS5wLCBkYXRhLnEgKTsKCgl9Cgp9CgpjbGFzcyBUdWJlR2VvbWV0cnkgZXh0ZW5kcyBCdWZmZXJHZW9tZXRyeSB7CgoJY29uc3RydWN0b3IoIHBhdGggPSBuZXcgUXVhZHJhdGljQmV6aWVyQ3VydmUzKCBuZXcgVmVjdG9yMyggLSAxLCAtIDEsIDAgKSwgbmV3IFZlY3RvcjMoIC0gMSwgMSwgMCApLCBuZXcgVmVjdG9yMyggMSwgMSwgMCApICksIHR1YnVsYXJTZWdtZW50cyA9IDY0LCByYWRpdXMgPSAxLCByYWRpYWxTZWdtZW50cyA9IDgsIGNsb3NlZCA9IGZhbHNlICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnVHViZUdlb21ldHJ5JzsKCgkJdGhpcy5wYXJhbWV0ZXJzID0gewoJCQlwYXRoOiBwYXRoLAoJCQl0dWJ1bGFyU2VnbWVudHM6IHR1YnVsYXJTZWdtZW50cywKCQkJcmFkaXVzOiByYWRpdXMsCgkJCXJhZGlhbFNlZ21lbnRzOiByYWRpYWxTZWdtZW50cywKCQkJY2xvc2VkOiBjbG9zZWQKCQl9OwoKCQljb25zdCBmcmFtZXMgPSBwYXRoLmNvbXB1dGVGcmVuZXRGcmFtZXMoIHR1YnVsYXJTZWdtZW50cywgY2xvc2VkICk7CgoJCS8vIGV4cG9zZSBpbnRlcm5hbHMKCgkJdGhpcy50YW5nZW50cyA9IGZyYW1lcy50YW5nZW50czsKCQl0aGlzLm5vcm1hbHMgPSBmcmFtZXMubm9ybWFsczsKCQl0aGlzLmJpbm9ybWFscyA9IGZyYW1lcy5iaW5vcm1hbHM7CgoJCS8vIGhlbHBlciB2YXJpYWJsZXMKCgkJY29uc3QgdmVydGV4ID0gbmV3IFZlY3RvcjMoKTsKCQljb25zdCBub3JtYWwgPSBuZXcgVmVjdG9yMygpOwoJCWNvbnN0IHV2ID0gbmV3IFZlY3RvcjIoKTsKCQlsZXQgUCA9IG5ldyBWZWN0b3IzKCk7CgoJCS8vIGJ1ZmZlcgoKCQljb25zdCB2ZXJ0aWNlcyA9IFtdOwoJCWNvbnN0IG5vcm1hbHMgPSBbXTsKCQljb25zdCB1dnMgPSBbXTsKCQljb25zdCBpbmRpY2VzID0gW107CgoJCS8vIGNyZWF0ZSBidWZmZXIgZGF0YQoKCQlnZW5lcmF0ZUJ1ZmZlckRhdGEoKTsKCgkJLy8gYnVpbGQgZ2VvbWV0cnkKCgkJdGhpcy5zZXRJbmRleCggaW5kaWNlcyApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdmVydGljZXMsIDMgKSApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAnbm9ybWFsJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIG5vcm1hbHMsIDMgKSApOwoJCXRoaXMuc2V0QXR0cmlidXRlKCAndXYnLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdXZzLCAyICkgKTsKCgkJLy8gZnVuY3Rpb25zCgoJCWZ1bmN0aW9uIGdlbmVyYXRlQnVmZmVyRGF0YSgpIHsKCgkJCWZvciAoIGxldCBpID0gMDsgaSA8IHR1YnVsYXJTZWdtZW50czsgaSArKyApIHsKCgkJCQlnZW5lcmF0ZVNlZ21lbnQoIGkgKTsKCgkJCX0KCgkJCS8vIGlmIHRoZSBnZW9tZXRyeSBpcyBub3QgY2xvc2VkLCBnZW5lcmF0ZSB0aGUgbGFzdCByb3cgb2YgdmVydGljZXMgYW5kIG5vcm1hbHMKCQkJLy8gYXQgdGhlIHJlZ3VsYXIgcG9zaXRpb24gb24gdGhlIGdpdmVuIHBhdGgKCQkJLy8KCQkJLy8gaWYgdGhlIGdlb21ldHJ5IGlzIGNsb3NlZCwgZHVwbGljYXRlIHRoZSBmaXJzdCByb3cgb2YgdmVydGljZXMgYW5kIG5vcm1hbHMgKHV2cyB3aWxsIGRpZmZlcikKCgkJCWdlbmVyYXRlU2VnbWVudCggKCBjbG9zZWQgPT09IGZhbHNlICkgPyB0dWJ1bGFyU2VnbWVudHMgOiAwICk7CgoJCQkvLyB1dnMgYXJlIGdlbmVyYXRlZCBpbiBhIHNlcGFyYXRlIGZ1bmN0aW9uLgoJCQkvLyB0aGlzIG1ha2VzIGl0IGVhc3kgY29tcHV0ZSBjb3JyZWN0IHZhbHVlcyBmb3IgY2xvc2VkIGdlb21ldHJpZXMKCgkJCWdlbmVyYXRlVVZzKCk7CgoJCQkvLyBmaW5hbGx5IGNyZWF0ZSBmYWNlcwoKCQkJZ2VuZXJhdGVJbmRpY2VzKCk7CgoJCX0KCgkJZnVuY3Rpb24gZ2VuZXJhdGVTZWdtZW50KCBpICkgewoKCQkJLy8gd2UgdXNlIGdldFBvaW50QXQgdG8gc2FtcGxlIGV2ZW5seSBkaXN0cmlidXRlZCBwb2ludHMgZnJvbSB0aGUgZ2l2ZW4gcGF0aAoKCQkJUCA9IHBhdGguZ2V0UG9pbnRBdCggaSAvIHR1YnVsYXJTZWdtZW50cywgUCApOwoKCQkJLy8gcmV0cmlldmUgY29ycmVzcG9uZGluZyBub3JtYWwgYW5kIGJpbm9ybWFsCgoJCQljb25zdCBOID0gZnJhbWVzLm5vcm1hbHNbIGkgXTsKCQkJY29uc3QgQiA9IGZyYW1lcy5iaW5vcm1hbHNbIGkgXTsKCgkJCS8vIGdlbmVyYXRlIG5vcm1hbHMgYW5kIHZlcnRpY2VzIGZvciB0aGUgY3VycmVudCBzZWdtZW50CgoJCQlmb3IgKCBsZXQgaiA9IDA7IGogPD0gcmFkaWFsU2VnbWVudHM7IGogKysgKSB7CgoJCQkJY29uc3QgdiA9IGogLyByYWRpYWxTZWdtZW50cyAqIE1hdGguUEkgKiAyOwoKCQkJCWNvbnN0IHNpbiA9IE1hdGguc2luKCB2ICk7CgkJCQljb25zdCBjb3MgPSAtIE1hdGguY29zKCB2ICk7CgoJCQkJLy8gbm9ybWFsCgoJCQkJbm9ybWFsLnggPSAoIGNvcyAqIE4ueCArIHNpbiAqIEIueCApOwoJCQkJbm9ybWFsLnkgPSAoIGNvcyAqIE4ueSArIHNpbiAqIEIueSApOwoJCQkJbm9ybWFsLnogPSAoIGNvcyAqIE4ueiArIHNpbiAqIEIueiApOwoJCQkJbm9ybWFsLm5vcm1hbGl6ZSgpOwoKCQkJCW5vcm1hbHMucHVzaCggbm9ybWFsLngsIG5vcm1hbC55LCBub3JtYWwueiApOwoKCQkJCS8vIHZlcnRleAoKCQkJCXZlcnRleC54ID0gUC54ICsgcmFkaXVzICogbm9ybWFsLng7CgkJCQl2ZXJ0ZXgueSA9IFAueSArIHJhZGl1cyAqIG5vcm1hbC55OwoJCQkJdmVydGV4LnogPSBQLnogKyByYWRpdXMgKiBub3JtYWwuejsKCgkJCQl2ZXJ0aWNlcy5wdXNoKCB2ZXJ0ZXgueCwgdmVydGV4LnksIHZlcnRleC56ICk7CgoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gZ2VuZXJhdGVJbmRpY2VzKCkgewoKCQkJZm9yICggbGV0IGogPSAxOyBqIDw9IHR1YnVsYXJTZWdtZW50czsgaiArKyApIHsKCgkJCQlmb3IgKCBsZXQgaSA9IDE7IGkgPD0gcmFkaWFsU2VnbWVudHM7IGkgKysgKSB7CgoJCQkJCWNvbnN0IGEgPSAoIHJhZGlhbFNlZ21lbnRzICsgMSApICogKCBqIC0gMSApICsgKCBpIC0gMSApOwoJCQkJCWNvbnN0IGIgPSAoIHJhZGlhbFNlZ21lbnRzICsgMSApICogaiArICggaSAtIDEgKTsKCQkJCQljb25zdCBjID0gKCByYWRpYWxTZWdtZW50cyArIDEgKSAqIGogKyBpOwoJCQkJCWNvbnN0IGQgPSAoIHJhZGlhbFNlZ21lbnRzICsgMSApICogKCBqIC0gMSApICsgaTsKCgkJCQkJLy8gZmFjZXMKCgkJCQkJaW5kaWNlcy5wdXNoKCBhLCBiLCBkICk7CgkJCQkJaW5kaWNlcy5wdXNoKCBiLCBjLCBkICk7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIGdlbmVyYXRlVVZzKCkgewoKCQkJZm9yICggbGV0IGkgPSAwOyBpIDw9IHR1YnVsYXJTZWdtZW50czsgaSArKyApIHsKCgkJCQlmb3IgKCBsZXQgaiA9IDA7IGogPD0gcmFkaWFsU2VnbWVudHM7IGogKysgKSB7CgoJCQkJCXV2LnggPSBpIC8gdHVidWxhclNlZ21lbnRzOwoJCQkJCXV2LnkgPSBqIC8gcmFkaWFsU2VnbWVudHM7CgoJCQkJCXV2cy5wdXNoKCB1di54LCB1di55ICk7CgoJCQkJfQoKCQkJfQoKCQl9CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5hc3NpZ24oIHt9LCBzb3VyY2UucGFyYW1ldGVycyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCkgewoKCQljb25zdCBkYXRhID0gc3VwZXIudG9KU09OKCk7CgoJCWRhdGEucGF0aCA9IHRoaXMucGFyYW1ldGVycy5wYXRoLnRvSlNPTigpOwoKCQlyZXR1cm4gZGF0YTsKCgl9CgoJc3RhdGljIGZyb21KU09OKCBkYXRhICkgewoKCQkvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGJ1aWx0LWluIGN1cnZlcyAoZS5nLiBDYXRtdWxsUm9tQ3VydmUzKS4KCQkvLyBVc2VyIGRlZmluZWQgY3VydmVzIG9yIGluc3RhbmNlcyBvZiBDdXJ2ZVBhdGggd2lsbCBub3QgYmUgZGVzZXJpYWxpemVkLgoJCXJldHVybiBuZXcgVHViZUdlb21ldHJ5KAoJCQluZXcgQ3VydmVzWyBkYXRhLnBhdGgudHlwZSBdKCkuZnJvbUpTT04oIGRhdGEucGF0aCApLAoJCQlkYXRhLnR1YnVsYXJTZWdtZW50cywKCQkJZGF0YS5yYWRpdXMsCgkJCWRhdGEucmFkaWFsU2VnbWVudHMsCgkJCWRhdGEuY2xvc2VkCgkJKTsKCgl9Cgp9CgpjbGFzcyBXaXJlZnJhbWVHZW9tZXRyeSBleHRlbmRzIEJ1ZmZlckdlb21ldHJ5IHsKCgljb25zdHJ1Y3RvciggZ2VvbWV0cnkgPSBudWxsICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnV2lyZWZyYW1lR2VvbWV0cnknOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSB7CgkJCWdlb21ldHJ5OiBnZW9tZXRyeQoJCX07CgoJCWlmICggZ2VvbWV0cnkgIT09IG51bGwgKSB7CgoJCQkvLyBidWZmZXIKCgkJCWNvbnN0IHZlcnRpY2VzID0gW107CgkJCWNvbnN0IGVkZ2VzID0gbmV3IFNldCgpOwoKCQkJLy8gaGVscGVyIHZhcmlhYmxlcwoKCQkJY29uc3Qgc3RhcnQgPSBuZXcgVmVjdG9yMygpOwoJCQljb25zdCBlbmQgPSBuZXcgVmVjdG9yMygpOwoKCQkJaWYgKCBnZW9tZXRyeS5pbmRleCAhPT0gbnVsbCApIHsKCgkJCQkvLyBpbmRleGVkIEJ1ZmZlckdlb21ldHJ5CgoJCQkJY29uc3QgcG9zaXRpb24gPSBnZW9tZXRyeS5hdHRyaWJ1dGVzLnBvc2l0aW9uOwoJCQkJY29uc3QgaW5kaWNlcyA9IGdlb21ldHJ5LmluZGV4OwoJCQkJbGV0IGdyb3VwcyA9IGdlb21ldHJ5Lmdyb3VwczsKCgkJCQlpZiAoIGdyb3Vwcy5sZW5ndGggPT09IDAgKSB7CgoJCQkJCWdyb3VwcyA9IFsgeyBzdGFydDogMCwgY291bnQ6IGluZGljZXMuY291bnQsIG1hdGVyaWFsSW5kZXg6IDAgfSBdOwoKCQkJCX0KCgkJCQkvLyBjcmVhdGUgYSBkYXRhIHN0cnVjdHVyZSB0aGF0IGNvbnRhaW5zIGFsbCBlZGdlcyB3aXRob3V0IGR1cGxpY2F0ZXMKCgkJCQlmb3IgKCBsZXQgbyA9IDAsIG9sID0gZ3JvdXBzLmxlbmd0aDsgbyA8IG9sOyArKyBvICkgewoKCQkJCQljb25zdCBncm91cCA9IGdyb3Vwc1sgbyBdOwoKCQkJCQljb25zdCBncm91cFN0YXJ0ID0gZ3JvdXAuc3RhcnQ7CgkJCQkJY29uc3QgZ3JvdXBDb3VudCA9IGdyb3VwLmNvdW50OwoKCQkJCQlmb3IgKCBsZXQgaSA9IGdyb3VwU3RhcnQsIGwgPSAoIGdyb3VwU3RhcnQgKyBncm91cENvdW50ICk7IGkgPCBsOyBpICs9IDMgKSB7CgoJCQkJCQlmb3IgKCBsZXQgaiA9IDA7IGogPCAzOyBqICsrICkgewoKCQkJCQkJCWNvbnN0IGluZGV4MSA9IGluZGljZXMuZ2V0WCggaSArIGogKTsKCQkJCQkJCWNvbnN0IGluZGV4MiA9IGluZGljZXMuZ2V0WCggaSArICggaiArIDEgKSAlIDMgKTsKCgkJCQkJCQlzdGFydC5mcm9tQnVmZmVyQXR0cmlidXRlKCBwb3NpdGlvbiwgaW5kZXgxICk7CgkJCQkJCQllbmQuZnJvbUJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb24sIGluZGV4MiApOwoKCQkJCQkJCWlmICggaXNVbmlxdWVFZGdlKCBzdGFydCwgZW5kLCBlZGdlcyApID09PSB0cnVlICkgewoKCQkJCQkJCQl2ZXJ0aWNlcy5wdXNoKCBzdGFydC54LCBzdGFydC55LCBzdGFydC56ICk7CgkJCQkJCQkJdmVydGljZXMucHVzaCggZW5kLngsIGVuZC55LCBlbmQueiApOwoKCQkJCQkJCX0KCgkJCQkJCX0KCgkJCQkJfQoKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJLy8gbm9uLWluZGV4ZWQgQnVmZmVyR2VvbWV0cnkKCgkJCQljb25zdCBwb3NpdGlvbiA9IGdlb21ldHJ5LmF0dHJpYnV0ZXMucG9zaXRpb247CgoJCQkJZm9yICggbGV0IGkgPSAwLCBsID0gKCBwb3NpdGlvbi5jb3VudCAvIDMgKTsgaSA8IGw7IGkgKysgKSB7CgoJCQkJCWZvciAoIGxldCBqID0gMDsgaiA8IDM7IGogKysgKSB7CgoJCQkJCQkvLyB0aHJlZSBlZGdlcyBwZXIgdHJpYW5nbGUsIGFuIGVkZ2UgaXMgcmVwcmVzZW50ZWQgYXMgKGluZGV4MSwgaW5kZXgyKQoJCQkJCQkvLyBlLmcuIHRoZSBmaXJzdCB0cmlhbmdsZSBoYXMgdGhlIGZvbGxvd2luZyBlZGdlczogKDAsMSksKDEsMiksKDIsMCkKCgkJCQkJCWNvbnN0IGluZGV4MSA9IDMgKiBpICsgajsKCQkJCQkJY29uc3QgaW5kZXgyID0gMyAqIGkgKyAoICggaiArIDEgKSAlIDMgKTsKCgkJCQkJCXN0YXJ0LmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uLCBpbmRleDEgKTsKCQkJCQkJZW5kLmZyb21CdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uLCBpbmRleDIgKTsKCgkJCQkJCWlmICggaXNVbmlxdWVFZGdlKCBzdGFydCwgZW5kLCBlZGdlcyApID09PSB0cnVlICkgewoKCQkJCQkJCXZlcnRpY2VzLnB1c2goIHN0YXJ0LngsIHN0YXJ0LnksIHN0YXJ0LnogKTsKCQkJCQkJCXZlcnRpY2VzLnB1c2goIGVuZC54LCBlbmQueSwgZW5kLnogKTsKCgkJCQkJCX0KCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJCS8vIGJ1aWxkIGdlb21ldHJ5CgoJCQl0aGlzLnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHZlcnRpY2VzLCAzICkgKTsKCgkJfQoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLnBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKCB7fSwgc291cmNlLnBhcmFtZXRlcnMgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKZnVuY3Rpb24gaXNVbmlxdWVFZGdlKCBzdGFydCwgZW5kLCBlZGdlcyApIHsKCgljb25zdCBoYXNoMSA9IGAke3N0YXJ0Lnh9LCR7c3RhcnQueX0sJHtzdGFydC56fS0ke2VuZC54fSwke2VuZC55fSwke2VuZC56fWA7Cgljb25zdCBoYXNoMiA9IGAke2VuZC54fSwke2VuZC55fSwke2VuZC56fS0ke3N0YXJ0Lnh9LCR7c3RhcnQueX0sJHtzdGFydC56fWA7IC8vIGNvaW5jaWRlbnQgZWRnZQoKCWlmICggZWRnZXMuaGFzKCBoYXNoMSApID09PSB0cnVlIHx8IGVkZ2VzLmhhcyggaGFzaDIgKSA9PT0gdHJ1ZSApIHsKCgkJcmV0dXJuIGZhbHNlOwoKCX0gZWxzZSB7CgoJCWVkZ2VzLmFkZCggaGFzaDEgKTsKCQllZGdlcy5hZGQoIGhhc2gyICk7CgkJcmV0dXJuIHRydWU7CgoJfQoKfQoKdmFyIEdlb21ldHJpZXMgPSAvKiNfX1BVUkVfXyovT2JqZWN0LmZyZWV6ZSh7CglfX3Byb3RvX186IG51bGwsCglCb3hHZW9tZXRyeTogQm94R2VvbWV0cnksCglDYXBzdWxlR2VvbWV0cnk6IENhcHN1bGVHZW9tZXRyeSwKCUNpcmNsZUdlb21ldHJ5OiBDaXJjbGVHZW9tZXRyeSwKCUNvbmVHZW9tZXRyeTogQ29uZUdlb21ldHJ5LAoJQ3lsaW5kZXJHZW9tZXRyeTogQ3lsaW5kZXJHZW9tZXRyeSwKCURvZGVjYWhlZHJvbkdlb21ldHJ5OiBEb2RlY2FoZWRyb25HZW9tZXRyeSwKCUVkZ2VzR2VvbWV0cnk6IEVkZ2VzR2VvbWV0cnksCglFeHRydWRlR2VvbWV0cnk6IEV4dHJ1ZGVHZW9tZXRyeSwKCUljb3NhaGVkcm9uR2VvbWV0cnk6IEljb3NhaGVkcm9uR2VvbWV0cnksCglMYXRoZUdlb21ldHJ5OiBMYXRoZUdlb21ldHJ5LAoJT2N0YWhlZHJvbkdlb21ldHJ5OiBPY3RhaGVkcm9uR2VvbWV0cnksCglQbGFuZUdlb21ldHJ5OiBQbGFuZUdlb21ldHJ5LAoJUG9seWhlZHJvbkdlb21ldHJ5OiBQb2x5aGVkcm9uR2VvbWV0cnksCglSaW5nR2VvbWV0cnk6IFJpbmdHZW9tZXRyeSwKCVNoYXBlR2VvbWV0cnk6IFNoYXBlR2VvbWV0cnksCglTcGhlcmVHZW9tZXRyeTogU3BoZXJlR2VvbWV0cnksCglUZXRyYWhlZHJvbkdlb21ldHJ5OiBUZXRyYWhlZHJvbkdlb21ldHJ5LAoJVG9ydXNHZW9tZXRyeTogVG9ydXNHZW9tZXRyeSwKCVRvcnVzS25vdEdlb21ldHJ5OiBUb3J1c0tub3RHZW9tZXRyeSwKCVR1YmVHZW9tZXRyeTogVHViZUdlb21ldHJ5LAoJV2lyZWZyYW1lR2VvbWV0cnk6IFdpcmVmcmFtZUdlb21ldHJ5Cn0pOwoKY2xhc3MgU2hhZG93TWF0ZXJpYWwgZXh0ZW5kcyBNYXRlcmlhbCB7CgoJY29uc3RydWN0b3IoIHBhcmFtZXRlcnMgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNTaGFkb3dNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdTaGFkb3dNYXRlcmlhbCc7CgoJCXRoaXMuY29sb3IgPSBuZXcgQ29sb3IoIDB4MDAwMDAwICk7CgkJdGhpcy50cmFuc3BhcmVudCA9IHRydWU7CgoJCXRoaXMuZm9nID0gdHJ1ZTsKCgkJdGhpcy5zZXRWYWx1ZXMoIHBhcmFtZXRlcnMgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5jb2xvci5jb3B5KCBzb3VyY2UuY29sb3IgKTsKCgkJdGhpcy5mb2cgPSBzb3VyY2UuZm9nOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBSYXdTaGFkZXJNYXRlcmlhbCBleHRlbmRzIFNoYWRlck1hdGVyaWFsIHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVycyApIHsKCgkJc3VwZXIoIHBhcmFtZXRlcnMgKTsKCgkJdGhpcy5pc1Jhd1NoYWRlck1hdGVyaWFsID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ1Jhd1NoYWRlck1hdGVyaWFsJzsKCgl9Cgp9CgpjbGFzcyBNZXNoU3RhbmRhcmRNYXRlcmlhbCBleHRlbmRzIE1hdGVyaWFsIHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVycyApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc01lc2hTdGFuZGFyZE1hdGVyaWFsID0gdHJ1ZTsKCgkJdGhpcy5kZWZpbmVzID0geyAnU1RBTkRBUkQnOiAnJyB9OwoKCQl0aGlzLnR5cGUgPSAnTWVzaFN0YW5kYXJkTWF0ZXJpYWwnOwoKCQl0aGlzLmNvbG9yID0gbmV3IENvbG9yKCAweGZmZmZmZiApOyAvLyBkaWZmdXNlCgkJdGhpcy5yb3VnaG5lc3MgPSAxLjA7CgkJdGhpcy5tZXRhbG5lc3MgPSAwLjA7CgoJCXRoaXMubWFwID0gbnVsbDsKCgkJdGhpcy5saWdodE1hcCA9IG51bGw7CgkJdGhpcy5saWdodE1hcEludGVuc2l0eSA9IDEuMDsKCgkJdGhpcy5hb01hcCA9IG51bGw7CgkJdGhpcy5hb01hcEludGVuc2l0eSA9IDEuMDsKCgkJdGhpcy5lbWlzc2l2ZSA9IG5ldyBDb2xvciggMHgwMDAwMDAgKTsKCQl0aGlzLmVtaXNzaXZlSW50ZW5zaXR5ID0gMS4wOwoJCXRoaXMuZW1pc3NpdmVNYXAgPSBudWxsOwoKCQl0aGlzLmJ1bXBNYXAgPSBudWxsOwoJCXRoaXMuYnVtcFNjYWxlID0gMTsKCgkJdGhpcy5ub3JtYWxNYXAgPSBudWxsOwoJCXRoaXMubm9ybWFsTWFwVHlwZSA9IFRhbmdlbnRTcGFjZU5vcm1hbE1hcDsKCQl0aGlzLm5vcm1hbFNjYWxlID0gbmV3IFZlY3RvcjIoIDEsIDEgKTsKCgkJdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBudWxsOwoJCXRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSAxOwoJCXRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IDA7CgoJCXRoaXMucm91Z2huZXNzTWFwID0gbnVsbDsKCgkJdGhpcy5tZXRhbG5lc3NNYXAgPSBudWxsOwoKCQl0aGlzLmFscGhhTWFwID0gbnVsbDsKCgkJdGhpcy5lbnZNYXAgPSBudWxsOwoJCXRoaXMuZW52TWFwSW50ZW5zaXR5ID0gMS4wOwoKCQl0aGlzLndpcmVmcmFtZSA9IGZhbHNlOwoJCXRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gMTsKCQl0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSAncm91bmQnOwoJCXRoaXMud2lyZWZyYW1lTGluZWpvaW4gPSAncm91bmQnOwoKCQl0aGlzLmZsYXRTaGFkaW5nID0gZmFsc2U7CgoJCXRoaXMuZm9nID0gdHJ1ZTsKCgkJdGhpcy5zZXRWYWx1ZXMoIHBhcmFtZXRlcnMgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5kZWZpbmVzID0geyAnU1RBTkRBUkQnOiAnJyB9OwoKCQl0aGlzLmNvbG9yLmNvcHkoIHNvdXJjZS5jb2xvciApOwoJCXRoaXMucm91Z2huZXNzID0gc291cmNlLnJvdWdobmVzczsKCQl0aGlzLm1ldGFsbmVzcyA9IHNvdXJjZS5tZXRhbG5lc3M7CgoJCXRoaXMubWFwID0gc291cmNlLm1hcDsKCgkJdGhpcy5saWdodE1hcCA9IHNvdXJjZS5saWdodE1hcDsKCQl0aGlzLmxpZ2h0TWFwSW50ZW5zaXR5ID0gc291cmNlLmxpZ2h0TWFwSW50ZW5zaXR5OwoKCQl0aGlzLmFvTWFwID0gc291cmNlLmFvTWFwOwoJCXRoaXMuYW9NYXBJbnRlbnNpdHkgPSBzb3VyY2UuYW9NYXBJbnRlbnNpdHk7CgoJCXRoaXMuZW1pc3NpdmUuY29weSggc291cmNlLmVtaXNzaXZlICk7CgkJdGhpcy5lbWlzc2l2ZU1hcCA9IHNvdXJjZS5lbWlzc2l2ZU1hcDsKCQl0aGlzLmVtaXNzaXZlSW50ZW5zaXR5ID0gc291cmNlLmVtaXNzaXZlSW50ZW5zaXR5OwoKCQl0aGlzLmJ1bXBNYXAgPSBzb3VyY2UuYnVtcE1hcDsKCQl0aGlzLmJ1bXBTY2FsZSA9IHNvdXJjZS5idW1wU2NhbGU7CgoJCXRoaXMubm9ybWFsTWFwID0gc291cmNlLm5vcm1hbE1hcDsKCQl0aGlzLm5vcm1hbE1hcFR5cGUgPSBzb3VyY2Uubm9ybWFsTWFwVHlwZTsKCQl0aGlzLm5vcm1hbFNjYWxlLmNvcHkoIHNvdXJjZS5ub3JtYWxTY2FsZSApOwoKCQl0aGlzLmRpc3BsYWNlbWVudE1hcCA9IHNvdXJjZS5kaXNwbGFjZW1lbnRNYXA7CgkJdGhpcy5kaXNwbGFjZW1lbnRTY2FsZSA9IHNvdXJjZS5kaXNwbGFjZW1lbnRTY2FsZTsKCQl0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSBzb3VyY2UuZGlzcGxhY2VtZW50QmlhczsKCgkJdGhpcy5yb3VnaG5lc3NNYXAgPSBzb3VyY2Uucm91Z2huZXNzTWFwOwoKCQl0aGlzLm1ldGFsbmVzc01hcCA9IHNvdXJjZS5tZXRhbG5lc3NNYXA7CgoJCXRoaXMuYWxwaGFNYXAgPSBzb3VyY2UuYWxwaGFNYXA7CgoJCXRoaXMuZW52TWFwID0gc291cmNlLmVudk1hcDsKCQl0aGlzLmVudk1hcEludGVuc2l0eSA9IHNvdXJjZS5lbnZNYXBJbnRlbnNpdHk7CgoJCXRoaXMud2lyZWZyYW1lID0gc291cmNlLndpcmVmcmFtZTsKCQl0aGlzLndpcmVmcmFtZUxpbmV3aWR0aCA9IHNvdXJjZS53aXJlZnJhbWVMaW5ld2lkdGg7CgkJdGhpcy53aXJlZnJhbWVMaW5lY2FwID0gc291cmNlLndpcmVmcmFtZUxpbmVjYXA7CgkJdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9IHNvdXJjZS53aXJlZnJhbWVMaW5lam9pbjsKCgkJdGhpcy5mbGF0U2hhZGluZyA9IHNvdXJjZS5mbGF0U2hhZGluZzsKCgkJdGhpcy5mb2cgPSBzb3VyY2UuZm9nOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBNZXNoUGh5c2ljYWxNYXRlcmlhbCBleHRlbmRzIE1lc2hTdGFuZGFyZE1hdGVyaWFsIHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVycyApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc01lc2hQaHlzaWNhbE1hdGVyaWFsID0gdHJ1ZTsKCgkJdGhpcy5kZWZpbmVzID0gewoKCQkJJ1NUQU5EQVJEJzogJycsCgkJCSdQSFlTSUNBTCc6ICcnCgoJCX07CgoJCXRoaXMudHlwZSA9ICdNZXNoUGh5c2ljYWxNYXRlcmlhbCc7CgoJCXRoaXMuYW5pc290cm9weVJvdGF0aW9uID0gMDsKCQl0aGlzLmFuaXNvdHJvcHlNYXAgPSBudWxsOwoKCQl0aGlzLmNsZWFyY29hdE1hcCA9IG51bGw7CgkJdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3MgPSAwLjA7CgkJdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3NNYXAgPSBudWxsOwoJCXRoaXMuY2xlYXJjb2F0Tm9ybWFsU2NhbGUgPSBuZXcgVmVjdG9yMiggMSwgMSApOwoJCXRoaXMuY2xlYXJjb2F0Tm9ybWFsTWFwID0gbnVsbDsKCgkJdGhpcy5pb3IgPSAxLjU7CgoJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcywgJ3JlZmxlY3Rpdml0eScsIHsKCQkJZ2V0OiBmdW5jdGlvbiAoKSB7CgoJCQkJcmV0dXJuICggY2xhbXAoIDIuNSAqICggdGhpcy5pb3IgLSAxICkgLyAoIHRoaXMuaW9yICsgMSApLCAwLCAxICkgKTsKCgkJCX0sCgkJCXNldDogZnVuY3Rpb24gKCByZWZsZWN0aXZpdHkgKSB7CgoJCQkJdGhpcy5pb3IgPSAoIDEgKyAwLjQgKiByZWZsZWN0aXZpdHkgKSAvICggMSAtIDAuNCAqIHJlZmxlY3Rpdml0eSApOwoKCQkJfQoJCX0gKTsKCgkJdGhpcy5pcmlkZXNjZW5jZU1hcCA9IG51bGw7CgkJdGhpcy5pcmlkZXNjZW5jZUlPUiA9IDEuMzsKCQl0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2UgPSBbIDEwMCwgNDAwIF07CgkJdGhpcy5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCA9IG51bGw7CgoJCXRoaXMuc2hlZW5Db2xvciA9IG5ldyBDb2xvciggMHgwMDAwMDAgKTsKCQl0aGlzLnNoZWVuQ29sb3JNYXAgPSBudWxsOwoJCXRoaXMuc2hlZW5Sb3VnaG5lc3MgPSAxLjA7CgkJdGhpcy5zaGVlblJvdWdobmVzc01hcCA9IG51bGw7CgoJCXRoaXMudHJhbnNtaXNzaW9uTWFwID0gbnVsbDsKCgkJdGhpcy50aGlja25lc3MgPSAwOwoJCXRoaXMudGhpY2tuZXNzTWFwID0gbnVsbDsKCQl0aGlzLmF0dGVudWF0aW9uRGlzdGFuY2UgPSBJbmZpbml0eTsKCQl0aGlzLmF0dGVudWF0aW9uQ29sb3IgPSBuZXcgQ29sb3IoIDEsIDEsIDEgKTsKCgkJdGhpcy5zcGVjdWxhckludGVuc2l0eSA9IDEuMDsKCQl0aGlzLnNwZWN1bGFySW50ZW5zaXR5TWFwID0gbnVsbDsKCQl0aGlzLnNwZWN1bGFyQ29sb3IgPSBuZXcgQ29sb3IoIDEsIDEsIDEgKTsKCQl0aGlzLnNwZWN1bGFyQ29sb3JNYXAgPSBudWxsOwoKCQl0aGlzLl9hbmlzb3Ryb3B5ID0gMDsKCQl0aGlzLl9jbGVhcmNvYXQgPSAwOwoJCXRoaXMuX2lyaWRlc2NlbmNlID0gMDsKCQl0aGlzLl9zaGVlbiA9IDAuMDsKCQl0aGlzLl90cmFuc21pc3Npb24gPSAwOwoKCQl0aGlzLnNldFZhbHVlcyggcGFyYW1ldGVycyApOwoKCX0KCglnZXQgYW5pc290cm9weSgpIHsKCgkJcmV0dXJuIHRoaXMuX2FuaXNvdHJvcHk7CgoJfQoKCXNldCBhbmlzb3Ryb3B5KCB2YWx1ZSApIHsKCgkJaWYgKCB0aGlzLl9hbmlzb3Ryb3B5ID4gMCAhPT0gdmFsdWUgPiAwICkgewoKCQkJdGhpcy52ZXJzaW9uICsrOwoKCQl9CgoJCXRoaXMuX2FuaXNvdHJvcHkgPSB2YWx1ZTsKCgl9CgoJZ2V0IGNsZWFyY29hdCgpIHsKCgkJcmV0dXJuIHRoaXMuX2NsZWFyY29hdDsKCgl9CgoJc2V0IGNsZWFyY29hdCggdmFsdWUgKSB7CgoJCWlmICggdGhpcy5fY2xlYXJjb2F0ID4gMCAhPT0gdmFsdWUgPiAwICkgewoKCQkJdGhpcy52ZXJzaW9uICsrOwoKCQl9CgoJCXRoaXMuX2NsZWFyY29hdCA9IHZhbHVlOwoKCX0KCglnZXQgaXJpZGVzY2VuY2UoKSB7CgoJCXJldHVybiB0aGlzLl9pcmlkZXNjZW5jZTsKCgl9CgoJc2V0IGlyaWRlc2NlbmNlKCB2YWx1ZSApIHsKCgkJaWYgKCB0aGlzLl9pcmlkZXNjZW5jZSA+IDAgIT09IHZhbHVlID4gMCApIHsKCgkJCXRoaXMudmVyc2lvbiArKzsKCgkJfQoKCQl0aGlzLl9pcmlkZXNjZW5jZSA9IHZhbHVlOwoKCX0KCglnZXQgc2hlZW4oKSB7CgoJCXJldHVybiB0aGlzLl9zaGVlbjsKCgl9CgoJc2V0IHNoZWVuKCB2YWx1ZSApIHsKCgkJaWYgKCB0aGlzLl9zaGVlbiA+IDAgIT09IHZhbHVlID4gMCApIHsKCgkJCXRoaXMudmVyc2lvbiArKzsKCgkJfQoKCQl0aGlzLl9zaGVlbiA9IHZhbHVlOwoKCX0KCglnZXQgdHJhbnNtaXNzaW9uKCkgewoKCQlyZXR1cm4gdGhpcy5fdHJhbnNtaXNzaW9uOwoKCX0KCglzZXQgdHJhbnNtaXNzaW9uKCB2YWx1ZSApIHsKCgkJaWYgKCB0aGlzLl90cmFuc21pc3Npb24gPiAwICE9PSB2YWx1ZSA+IDAgKSB7CgoJCQl0aGlzLnZlcnNpb24gKys7CgoJCX0KCgkJdGhpcy5fdHJhbnNtaXNzaW9uID0gdmFsdWU7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuZGVmaW5lcyA9IHsKCgkJCSdTVEFOREFSRCc6ICcnLAoJCQknUEhZU0lDQUwnOiAnJwoKCQl9OwoKCQl0aGlzLmFuaXNvdHJvcHkgPSBzb3VyY2UuYW5pc290cm9weTsKCQl0aGlzLmFuaXNvdHJvcHlSb3RhdGlvbiA9IHNvdXJjZS5hbmlzb3Ryb3B5Um90YXRpb247CgkJdGhpcy5hbmlzb3Ryb3B5TWFwID0gc291cmNlLmFuaXNvdHJvcHlNYXA7CgoJCXRoaXMuY2xlYXJjb2F0ID0gc291cmNlLmNsZWFyY29hdDsKCQl0aGlzLmNsZWFyY29hdE1hcCA9IHNvdXJjZS5jbGVhcmNvYXRNYXA7CgkJdGhpcy5jbGVhcmNvYXRSb3VnaG5lc3MgPSBzb3VyY2UuY2xlYXJjb2F0Um91Z2huZXNzOwoJCXRoaXMuY2xlYXJjb2F0Um91Z2huZXNzTWFwID0gc291cmNlLmNsZWFyY29hdFJvdWdobmVzc01hcDsKCQl0aGlzLmNsZWFyY29hdE5vcm1hbE1hcCA9IHNvdXJjZS5jbGVhcmNvYXROb3JtYWxNYXA7CgkJdGhpcy5jbGVhcmNvYXROb3JtYWxTY2FsZS5jb3B5KCBzb3VyY2UuY2xlYXJjb2F0Tm9ybWFsU2NhbGUgKTsKCgkJdGhpcy5pb3IgPSBzb3VyY2UuaW9yOwoKCQl0aGlzLmlyaWRlc2NlbmNlID0gc291cmNlLmlyaWRlc2NlbmNlOwoJCXRoaXMuaXJpZGVzY2VuY2VNYXAgPSBzb3VyY2UuaXJpZGVzY2VuY2VNYXA7CgkJdGhpcy5pcmlkZXNjZW5jZUlPUiA9IHNvdXJjZS5pcmlkZXNjZW5jZUlPUjsKCQl0aGlzLmlyaWRlc2NlbmNlVGhpY2tuZXNzUmFuZ2UgPSBbIC4uLnNvdXJjZS5pcmlkZXNjZW5jZVRoaWNrbmVzc1JhbmdlIF07CgkJdGhpcy5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCA9IHNvdXJjZS5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcDsKCgkJdGhpcy5zaGVlbiA9IHNvdXJjZS5zaGVlbjsKCQl0aGlzLnNoZWVuQ29sb3IuY29weSggc291cmNlLnNoZWVuQ29sb3IgKTsKCQl0aGlzLnNoZWVuQ29sb3JNYXAgPSBzb3VyY2Uuc2hlZW5Db2xvck1hcDsKCQl0aGlzLnNoZWVuUm91Z2huZXNzID0gc291cmNlLnNoZWVuUm91Z2huZXNzOwoJCXRoaXMuc2hlZW5Sb3VnaG5lc3NNYXAgPSBzb3VyY2Uuc2hlZW5Sb3VnaG5lc3NNYXA7CgoJCXRoaXMudHJhbnNtaXNzaW9uID0gc291cmNlLnRyYW5zbWlzc2lvbjsKCQl0aGlzLnRyYW5zbWlzc2lvbk1hcCA9IHNvdXJjZS50cmFuc21pc3Npb25NYXA7CgoJCXRoaXMudGhpY2tuZXNzID0gc291cmNlLnRoaWNrbmVzczsKCQl0aGlzLnRoaWNrbmVzc01hcCA9IHNvdXJjZS50aGlja25lc3NNYXA7CgkJdGhpcy5hdHRlbnVhdGlvbkRpc3RhbmNlID0gc291cmNlLmF0dGVudWF0aW9uRGlzdGFuY2U7CgkJdGhpcy5hdHRlbnVhdGlvbkNvbG9yLmNvcHkoIHNvdXJjZS5hdHRlbnVhdGlvbkNvbG9yICk7CgoJCXRoaXMuc3BlY3VsYXJJbnRlbnNpdHkgPSBzb3VyY2Uuc3BlY3VsYXJJbnRlbnNpdHk7CgkJdGhpcy5zcGVjdWxhckludGVuc2l0eU1hcCA9IHNvdXJjZS5zcGVjdWxhckludGVuc2l0eU1hcDsKCQl0aGlzLnNwZWN1bGFyQ29sb3IuY29weSggc291cmNlLnNwZWN1bGFyQ29sb3IgKTsKCQl0aGlzLnNwZWN1bGFyQ29sb3JNYXAgPSBzb3VyY2Uuc3BlY3VsYXJDb2xvck1hcDsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKY2xhc3MgTWVzaFBob25nTWF0ZXJpYWwgZXh0ZW5kcyBNYXRlcmlhbCB7CgoJY29uc3RydWN0b3IoIHBhcmFtZXRlcnMgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNNZXNoUGhvbmdNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdNZXNoUGhvbmdNYXRlcmlhbCc7CgoJCXRoaXMuY29sb3IgPSBuZXcgQ29sb3IoIDB4ZmZmZmZmICk7IC8vIGRpZmZ1c2UKCQl0aGlzLnNwZWN1bGFyID0gbmV3IENvbG9yKCAweDExMTExMSApOwoJCXRoaXMuc2hpbmluZXNzID0gMzA7CgoJCXRoaXMubWFwID0gbnVsbDsKCgkJdGhpcy5saWdodE1hcCA9IG51bGw7CgkJdGhpcy5saWdodE1hcEludGVuc2l0eSA9IDEuMDsKCgkJdGhpcy5hb01hcCA9IG51bGw7CgkJdGhpcy5hb01hcEludGVuc2l0eSA9IDEuMDsKCgkJdGhpcy5lbWlzc2l2ZSA9IG5ldyBDb2xvciggMHgwMDAwMDAgKTsKCQl0aGlzLmVtaXNzaXZlSW50ZW5zaXR5ID0gMS4wOwoJCXRoaXMuZW1pc3NpdmVNYXAgPSBudWxsOwoKCQl0aGlzLmJ1bXBNYXAgPSBudWxsOwoJCXRoaXMuYnVtcFNjYWxlID0gMTsKCgkJdGhpcy5ub3JtYWxNYXAgPSBudWxsOwoJCXRoaXMubm9ybWFsTWFwVHlwZSA9IFRhbmdlbnRTcGFjZU5vcm1hbE1hcDsKCQl0aGlzLm5vcm1hbFNjYWxlID0gbmV3IFZlY3RvcjIoIDEsIDEgKTsKCgkJdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBudWxsOwoJCXRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSAxOwoJCXRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IDA7CgoJCXRoaXMuc3BlY3VsYXJNYXAgPSBudWxsOwoKCQl0aGlzLmFscGhhTWFwID0gbnVsbDsKCgkJdGhpcy5lbnZNYXAgPSBudWxsOwoJCXRoaXMuY29tYmluZSA9IE11bHRpcGx5T3BlcmF0aW9uOwoJCXRoaXMucmVmbGVjdGl2aXR5ID0gMTsKCQl0aGlzLnJlZnJhY3Rpb25SYXRpbyA9IDAuOTg7CgoJCXRoaXMud2lyZWZyYW1lID0gZmFsc2U7CgkJdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSAxOwoJCXRoaXMud2lyZWZyYW1lTGluZWNhcCA9ICdyb3VuZCc7CgkJdGhpcy53aXJlZnJhbWVMaW5lam9pbiA9ICdyb3VuZCc7CgoJCXRoaXMuZmxhdFNoYWRpbmcgPSBmYWxzZTsKCgkJdGhpcy5mb2cgPSB0cnVlOwoKCQl0aGlzLnNldFZhbHVlcyggcGFyYW1ldGVycyApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLmNvbG9yLmNvcHkoIHNvdXJjZS5jb2xvciApOwoJCXRoaXMuc3BlY3VsYXIuY29weSggc291cmNlLnNwZWN1bGFyICk7CgkJdGhpcy5zaGluaW5lc3MgPSBzb3VyY2Uuc2hpbmluZXNzOwoKCQl0aGlzLm1hcCA9IHNvdXJjZS5tYXA7CgoJCXRoaXMubGlnaHRNYXAgPSBzb3VyY2UubGlnaHRNYXA7CgkJdGhpcy5saWdodE1hcEludGVuc2l0eSA9IHNvdXJjZS5saWdodE1hcEludGVuc2l0eTsKCgkJdGhpcy5hb01hcCA9IHNvdXJjZS5hb01hcDsKCQl0aGlzLmFvTWFwSW50ZW5zaXR5ID0gc291cmNlLmFvTWFwSW50ZW5zaXR5OwoKCQl0aGlzLmVtaXNzaXZlLmNvcHkoIHNvdXJjZS5lbWlzc2l2ZSApOwoJCXRoaXMuZW1pc3NpdmVNYXAgPSBzb3VyY2UuZW1pc3NpdmVNYXA7CgkJdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IHNvdXJjZS5lbWlzc2l2ZUludGVuc2l0eTsKCgkJdGhpcy5idW1wTWFwID0gc291cmNlLmJ1bXBNYXA7CgkJdGhpcy5idW1wU2NhbGUgPSBzb3VyY2UuYnVtcFNjYWxlOwoKCQl0aGlzLm5vcm1hbE1hcCA9IHNvdXJjZS5ub3JtYWxNYXA7CgkJdGhpcy5ub3JtYWxNYXBUeXBlID0gc291cmNlLm5vcm1hbE1hcFR5cGU7CgkJdGhpcy5ub3JtYWxTY2FsZS5jb3B5KCBzb3VyY2Uubm9ybWFsU2NhbGUgKTsKCgkJdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBzb3VyY2UuZGlzcGxhY2VtZW50TWFwOwoJCXRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSBzb3VyY2UuZGlzcGxhY2VtZW50U2NhbGU7CgkJdGhpcy5kaXNwbGFjZW1lbnRCaWFzID0gc291cmNlLmRpc3BsYWNlbWVudEJpYXM7CgoJCXRoaXMuc3BlY3VsYXJNYXAgPSBzb3VyY2Uuc3BlY3VsYXJNYXA7CgoJCXRoaXMuYWxwaGFNYXAgPSBzb3VyY2UuYWxwaGFNYXA7CgoJCXRoaXMuZW52TWFwID0gc291cmNlLmVudk1hcDsKCQl0aGlzLmNvbWJpbmUgPSBzb3VyY2UuY29tYmluZTsKCQl0aGlzLnJlZmxlY3Rpdml0eSA9IHNvdXJjZS5yZWZsZWN0aXZpdHk7CgkJdGhpcy5yZWZyYWN0aW9uUmF0aW8gPSBzb3VyY2UucmVmcmFjdGlvblJhdGlvOwoKCQl0aGlzLndpcmVmcmFtZSA9IHNvdXJjZS53aXJlZnJhbWU7CgkJdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSBzb3VyY2Uud2lyZWZyYW1lTGluZXdpZHRoOwoJCXRoaXMud2lyZWZyYW1lTGluZWNhcCA9IHNvdXJjZS53aXJlZnJhbWVMaW5lY2FwOwoJCXRoaXMud2lyZWZyYW1lTGluZWpvaW4gPSBzb3VyY2Uud2lyZWZyYW1lTGluZWpvaW47CgoJCXRoaXMuZmxhdFNoYWRpbmcgPSBzb3VyY2UuZmxhdFNoYWRpbmc7CgoJCXRoaXMuZm9nID0gc291cmNlLmZvZzsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKY2xhc3MgTWVzaFRvb25NYXRlcmlhbCBleHRlbmRzIE1hdGVyaWFsIHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVycyApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc01lc2hUb29uTWF0ZXJpYWwgPSB0cnVlOwoKCQl0aGlzLmRlZmluZXMgPSB7ICdUT09OJzogJycgfTsKCgkJdGhpcy50eXBlID0gJ01lc2hUb29uTWF0ZXJpYWwnOwoKCQl0aGlzLmNvbG9yID0gbmV3IENvbG9yKCAweGZmZmZmZiApOwoKCQl0aGlzLm1hcCA9IG51bGw7CgkJdGhpcy5ncmFkaWVudE1hcCA9IG51bGw7CgoJCXRoaXMubGlnaHRNYXAgPSBudWxsOwoJCXRoaXMubGlnaHRNYXBJbnRlbnNpdHkgPSAxLjA7CgoJCXRoaXMuYW9NYXAgPSBudWxsOwoJCXRoaXMuYW9NYXBJbnRlbnNpdHkgPSAxLjA7CgoJCXRoaXMuZW1pc3NpdmUgPSBuZXcgQ29sb3IoIDB4MDAwMDAwICk7CgkJdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IDEuMDsKCQl0aGlzLmVtaXNzaXZlTWFwID0gbnVsbDsKCgkJdGhpcy5idW1wTWFwID0gbnVsbDsKCQl0aGlzLmJ1bXBTY2FsZSA9IDE7CgoJCXRoaXMubm9ybWFsTWFwID0gbnVsbDsKCQl0aGlzLm5vcm1hbE1hcFR5cGUgPSBUYW5nZW50U3BhY2VOb3JtYWxNYXA7CgkJdGhpcy5ub3JtYWxTY2FsZSA9IG5ldyBWZWN0b3IyKCAxLCAxICk7CgoJCXRoaXMuZGlzcGxhY2VtZW50TWFwID0gbnVsbDsKCQl0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gMTsKCQl0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSAwOwoKCQl0aGlzLmFscGhhTWFwID0gbnVsbDsKCgkJdGhpcy53aXJlZnJhbWUgPSBmYWxzZTsKCQl0aGlzLndpcmVmcmFtZUxpbmV3aWR0aCA9IDE7CgkJdGhpcy53aXJlZnJhbWVMaW5lY2FwID0gJ3JvdW5kJzsKCQl0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gJ3JvdW5kJzsKCgkJdGhpcy5mb2cgPSB0cnVlOwoKCQl0aGlzLnNldFZhbHVlcyggcGFyYW1ldGVycyApOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLmNvbG9yLmNvcHkoIHNvdXJjZS5jb2xvciApOwoKCQl0aGlzLm1hcCA9IHNvdXJjZS5tYXA7CgkJdGhpcy5ncmFkaWVudE1hcCA9IHNvdXJjZS5ncmFkaWVudE1hcDsKCgkJdGhpcy5saWdodE1hcCA9IHNvdXJjZS5saWdodE1hcDsKCQl0aGlzLmxpZ2h0TWFwSW50ZW5zaXR5ID0gc291cmNlLmxpZ2h0TWFwSW50ZW5zaXR5OwoKCQl0aGlzLmFvTWFwID0gc291cmNlLmFvTWFwOwoJCXRoaXMuYW9NYXBJbnRlbnNpdHkgPSBzb3VyY2UuYW9NYXBJbnRlbnNpdHk7CgoJCXRoaXMuZW1pc3NpdmUuY29weSggc291cmNlLmVtaXNzaXZlICk7CgkJdGhpcy5lbWlzc2l2ZU1hcCA9IHNvdXJjZS5lbWlzc2l2ZU1hcDsKCQl0aGlzLmVtaXNzaXZlSW50ZW5zaXR5ID0gc291cmNlLmVtaXNzaXZlSW50ZW5zaXR5OwoKCQl0aGlzLmJ1bXBNYXAgPSBzb3VyY2UuYnVtcE1hcDsKCQl0aGlzLmJ1bXBTY2FsZSA9IHNvdXJjZS5idW1wU2NhbGU7CgoJCXRoaXMubm9ybWFsTWFwID0gc291cmNlLm5vcm1hbE1hcDsKCQl0aGlzLm5vcm1hbE1hcFR5cGUgPSBzb3VyY2Uubm9ybWFsTWFwVHlwZTsKCQl0aGlzLm5vcm1hbFNjYWxlLmNvcHkoIHNvdXJjZS5ub3JtYWxTY2FsZSApOwoKCQl0aGlzLmRpc3BsYWNlbWVudE1hcCA9IHNvdXJjZS5kaXNwbGFjZW1lbnRNYXA7CgkJdGhpcy5kaXNwbGFjZW1lbnRTY2FsZSA9IHNvdXJjZS5kaXNwbGFjZW1lbnRTY2FsZTsKCQl0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSBzb3VyY2UuZGlzcGxhY2VtZW50QmlhczsKCgkJdGhpcy5hbHBoYU1hcCA9IHNvdXJjZS5hbHBoYU1hcDsKCgkJdGhpcy53aXJlZnJhbWUgPSBzb3VyY2Uud2lyZWZyYW1lOwoJCXRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gc291cmNlLndpcmVmcmFtZUxpbmV3aWR0aDsKCQl0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSBzb3VyY2Uud2lyZWZyYW1lTGluZWNhcDsKCQl0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gc291cmNlLndpcmVmcmFtZUxpbmVqb2luOwoKCQl0aGlzLmZvZyA9IHNvdXJjZS5mb2c7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIE1lc2hOb3JtYWxNYXRlcmlhbCBleHRlbmRzIE1hdGVyaWFsIHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVycyApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc01lc2hOb3JtYWxNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdNZXNoTm9ybWFsTWF0ZXJpYWwnOwoKCQl0aGlzLmJ1bXBNYXAgPSBudWxsOwoJCXRoaXMuYnVtcFNjYWxlID0gMTsKCgkJdGhpcy5ub3JtYWxNYXAgPSBudWxsOwoJCXRoaXMubm9ybWFsTWFwVHlwZSA9IFRhbmdlbnRTcGFjZU5vcm1hbE1hcDsKCQl0aGlzLm5vcm1hbFNjYWxlID0gbmV3IFZlY3RvcjIoIDEsIDEgKTsKCgkJdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBudWxsOwoJCXRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSAxOwoJCXRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IDA7CgoJCXRoaXMud2lyZWZyYW1lID0gZmFsc2U7CgkJdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSAxOwoKCQl0aGlzLmZsYXRTaGFkaW5nID0gZmFsc2U7CgoJCXRoaXMuc2V0VmFsdWVzKCBwYXJhbWV0ZXJzICk7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuYnVtcE1hcCA9IHNvdXJjZS5idW1wTWFwOwoJCXRoaXMuYnVtcFNjYWxlID0gc291cmNlLmJ1bXBTY2FsZTsKCgkJdGhpcy5ub3JtYWxNYXAgPSBzb3VyY2Uubm9ybWFsTWFwOwoJCXRoaXMubm9ybWFsTWFwVHlwZSA9IHNvdXJjZS5ub3JtYWxNYXBUeXBlOwoJCXRoaXMubm9ybWFsU2NhbGUuY29weSggc291cmNlLm5vcm1hbFNjYWxlICk7CgoJCXRoaXMuZGlzcGxhY2VtZW50TWFwID0gc291cmNlLmRpc3BsYWNlbWVudE1hcDsKCQl0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gc291cmNlLmRpc3BsYWNlbWVudFNjYWxlOwoJCXRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IHNvdXJjZS5kaXNwbGFjZW1lbnRCaWFzOwoKCQl0aGlzLndpcmVmcmFtZSA9IHNvdXJjZS53aXJlZnJhbWU7CgkJdGhpcy53aXJlZnJhbWVMaW5ld2lkdGggPSBzb3VyY2Uud2lyZWZyYW1lTGluZXdpZHRoOwoKCQl0aGlzLmZsYXRTaGFkaW5nID0gc291cmNlLmZsYXRTaGFkaW5nOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBNZXNoTGFtYmVydE1hdGVyaWFsIGV4dGVuZHMgTWF0ZXJpYWwgewoKCWNvbnN0cnVjdG9yKCBwYXJhbWV0ZXJzICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzTWVzaExhbWJlcnRNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdNZXNoTGFtYmVydE1hdGVyaWFsJzsKCgkJdGhpcy5jb2xvciA9IG5ldyBDb2xvciggMHhmZmZmZmYgKTsgLy8gZGlmZnVzZQoKCQl0aGlzLm1hcCA9IG51bGw7CgoJCXRoaXMubGlnaHRNYXAgPSBudWxsOwoJCXRoaXMubGlnaHRNYXBJbnRlbnNpdHkgPSAxLjA7CgoJCXRoaXMuYW9NYXAgPSBudWxsOwoJCXRoaXMuYW9NYXBJbnRlbnNpdHkgPSAxLjA7CgoJCXRoaXMuZW1pc3NpdmUgPSBuZXcgQ29sb3IoIDB4MDAwMDAwICk7CgkJdGhpcy5lbWlzc2l2ZUludGVuc2l0eSA9IDEuMDsKCQl0aGlzLmVtaXNzaXZlTWFwID0gbnVsbDsKCgkJdGhpcy5idW1wTWFwID0gbnVsbDsKCQl0aGlzLmJ1bXBTY2FsZSA9IDE7CgoJCXRoaXMubm9ybWFsTWFwID0gbnVsbDsKCQl0aGlzLm5vcm1hbE1hcFR5cGUgPSBUYW5nZW50U3BhY2VOb3JtYWxNYXA7CgkJdGhpcy5ub3JtYWxTY2FsZSA9IG5ldyBWZWN0b3IyKCAxLCAxICk7CgoJCXRoaXMuZGlzcGxhY2VtZW50TWFwID0gbnVsbDsKCQl0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gMTsKCQl0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSAwOwoKCQl0aGlzLnNwZWN1bGFyTWFwID0gbnVsbDsKCgkJdGhpcy5hbHBoYU1hcCA9IG51bGw7CgoJCXRoaXMuZW52TWFwID0gbnVsbDsKCQl0aGlzLmNvbWJpbmUgPSBNdWx0aXBseU9wZXJhdGlvbjsKCQl0aGlzLnJlZmxlY3Rpdml0eSA9IDE7CgkJdGhpcy5yZWZyYWN0aW9uUmF0aW8gPSAwLjk4OwoKCQl0aGlzLndpcmVmcmFtZSA9IGZhbHNlOwoJCXRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gMTsKCQl0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSAncm91bmQnOwoJCXRoaXMud2lyZWZyYW1lTGluZWpvaW4gPSAncm91bmQnOwoKCQl0aGlzLmZsYXRTaGFkaW5nID0gZmFsc2U7CgoJCXRoaXMuZm9nID0gdHJ1ZTsKCgkJdGhpcy5zZXRWYWx1ZXMoIHBhcmFtZXRlcnMgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5jb2xvci5jb3B5KCBzb3VyY2UuY29sb3IgKTsKCgkJdGhpcy5tYXAgPSBzb3VyY2UubWFwOwoKCQl0aGlzLmxpZ2h0TWFwID0gc291cmNlLmxpZ2h0TWFwOwoJCXRoaXMubGlnaHRNYXBJbnRlbnNpdHkgPSBzb3VyY2UubGlnaHRNYXBJbnRlbnNpdHk7CgoJCXRoaXMuYW9NYXAgPSBzb3VyY2UuYW9NYXA7CgkJdGhpcy5hb01hcEludGVuc2l0eSA9IHNvdXJjZS5hb01hcEludGVuc2l0eTsKCgkJdGhpcy5lbWlzc2l2ZS5jb3B5KCBzb3VyY2UuZW1pc3NpdmUgKTsKCQl0aGlzLmVtaXNzaXZlTWFwID0gc291cmNlLmVtaXNzaXZlTWFwOwoJCXRoaXMuZW1pc3NpdmVJbnRlbnNpdHkgPSBzb3VyY2UuZW1pc3NpdmVJbnRlbnNpdHk7CgoJCXRoaXMuYnVtcE1hcCA9IHNvdXJjZS5idW1wTWFwOwoJCXRoaXMuYnVtcFNjYWxlID0gc291cmNlLmJ1bXBTY2FsZTsKCgkJdGhpcy5ub3JtYWxNYXAgPSBzb3VyY2Uubm9ybWFsTWFwOwoJCXRoaXMubm9ybWFsTWFwVHlwZSA9IHNvdXJjZS5ub3JtYWxNYXBUeXBlOwoJCXRoaXMubm9ybWFsU2NhbGUuY29weSggc291cmNlLm5vcm1hbFNjYWxlICk7CgoJCXRoaXMuZGlzcGxhY2VtZW50TWFwID0gc291cmNlLmRpc3BsYWNlbWVudE1hcDsKCQl0aGlzLmRpc3BsYWNlbWVudFNjYWxlID0gc291cmNlLmRpc3BsYWNlbWVudFNjYWxlOwoJCXRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IHNvdXJjZS5kaXNwbGFjZW1lbnRCaWFzOwoKCQl0aGlzLnNwZWN1bGFyTWFwID0gc291cmNlLnNwZWN1bGFyTWFwOwoKCQl0aGlzLmFscGhhTWFwID0gc291cmNlLmFscGhhTWFwOwoKCQl0aGlzLmVudk1hcCA9IHNvdXJjZS5lbnZNYXA7CgkJdGhpcy5jb21iaW5lID0gc291cmNlLmNvbWJpbmU7CgkJdGhpcy5yZWZsZWN0aXZpdHkgPSBzb3VyY2UucmVmbGVjdGl2aXR5OwoJCXRoaXMucmVmcmFjdGlvblJhdGlvID0gc291cmNlLnJlZnJhY3Rpb25SYXRpbzsKCgkJdGhpcy53aXJlZnJhbWUgPSBzb3VyY2Uud2lyZWZyYW1lOwoJCXRoaXMud2lyZWZyYW1lTGluZXdpZHRoID0gc291cmNlLndpcmVmcmFtZUxpbmV3aWR0aDsKCQl0aGlzLndpcmVmcmFtZUxpbmVjYXAgPSBzb3VyY2Uud2lyZWZyYW1lTGluZWNhcDsKCQl0aGlzLndpcmVmcmFtZUxpbmVqb2luID0gc291cmNlLndpcmVmcmFtZUxpbmVqb2luOwoKCQl0aGlzLmZsYXRTaGFkaW5nID0gc291cmNlLmZsYXRTaGFkaW5nOwoKCQl0aGlzLmZvZyA9IHNvdXJjZS5mb2c7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIE1lc2hNYXRjYXBNYXRlcmlhbCBleHRlbmRzIE1hdGVyaWFsIHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVycyApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc01lc2hNYXRjYXBNYXRlcmlhbCA9IHRydWU7CgoJCXRoaXMuZGVmaW5lcyA9IHsgJ01BVENBUCc6ICcnIH07CgoJCXRoaXMudHlwZSA9ICdNZXNoTWF0Y2FwTWF0ZXJpYWwnOwoKCQl0aGlzLmNvbG9yID0gbmV3IENvbG9yKCAweGZmZmZmZiApOyAvLyBkaWZmdXNlCgoJCXRoaXMubWF0Y2FwID0gbnVsbDsKCgkJdGhpcy5tYXAgPSBudWxsOwoKCQl0aGlzLmJ1bXBNYXAgPSBudWxsOwoJCXRoaXMuYnVtcFNjYWxlID0gMTsKCgkJdGhpcy5ub3JtYWxNYXAgPSBudWxsOwoJCXRoaXMubm9ybWFsTWFwVHlwZSA9IFRhbmdlbnRTcGFjZU5vcm1hbE1hcDsKCQl0aGlzLm5vcm1hbFNjYWxlID0gbmV3IFZlY3RvcjIoIDEsIDEgKTsKCgkJdGhpcy5kaXNwbGFjZW1lbnRNYXAgPSBudWxsOwoJCXRoaXMuZGlzcGxhY2VtZW50U2NhbGUgPSAxOwoJCXRoaXMuZGlzcGxhY2VtZW50QmlhcyA9IDA7CgoJCXRoaXMuYWxwaGFNYXAgPSBudWxsOwoKCQl0aGlzLmZsYXRTaGFkaW5nID0gZmFsc2U7CgoJCXRoaXMuZm9nID0gdHJ1ZTsKCgkJdGhpcy5zZXRWYWx1ZXMoIHBhcmFtZXRlcnMgKTsKCgl9CgoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuZGVmaW5lcyA9IHsgJ01BVENBUCc6ICcnIH07CgoJCXRoaXMuY29sb3IuY29weSggc291cmNlLmNvbG9yICk7CgoJCXRoaXMubWF0Y2FwID0gc291cmNlLm1hdGNhcDsKCgkJdGhpcy5tYXAgPSBzb3VyY2UubWFwOwoKCQl0aGlzLmJ1bXBNYXAgPSBzb3VyY2UuYnVtcE1hcDsKCQl0aGlzLmJ1bXBTY2FsZSA9IHNvdXJjZS5idW1wU2NhbGU7CgoJCXRoaXMubm9ybWFsTWFwID0gc291cmNlLm5vcm1hbE1hcDsKCQl0aGlzLm5vcm1hbE1hcFR5cGUgPSBzb3VyY2Uubm9ybWFsTWFwVHlwZTsKCQl0aGlzLm5vcm1hbFNjYWxlLmNvcHkoIHNvdXJjZS5ub3JtYWxTY2FsZSApOwoKCQl0aGlzLmRpc3BsYWNlbWVudE1hcCA9IHNvdXJjZS5kaXNwbGFjZW1lbnRNYXA7CgkJdGhpcy5kaXNwbGFjZW1lbnRTY2FsZSA9IHNvdXJjZS5kaXNwbGFjZW1lbnRTY2FsZTsKCQl0aGlzLmRpc3BsYWNlbWVudEJpYXMgPSBzb3VyY2UuZGlzcGxhY2VtZW50QmlhczsKCgkJdGhpcy5hbHBoYU1hcCA9IHNvdXJjZS5hbHBoYU1hcDsKCgkJdGhpcy5mbGF0U2hhZGluZyA9IHNvdXJjZS5mbGF0U2hhZGluZzsKCgkJdGhpcy5mb2cgPSBzb3VyY2UuZm9nOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBMaW5lRGFzaGVkTWF0ZXJpYWwgZXh0ZW5kcyBMaW5lQmFzaWNNYXRlcmlhbCB7CgoJY29uc3RydWN0b3IoIHBhcmFtZXRlcnMgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNMaW5lRGFzaGVkTWF0ZXJpYWwgPSB0cnVlOwoKCQl0aGlzLnR5cGUgPSAnTGluZURhc2hlZE1hdGVyaWFsJzsKCgkJdGhpcy5zY2FsZSA9IDE7CgkJdGhpcy5kYXNoU2l6ZSA9IDM7CgkJdGhpcy5nYXBTaXplID0gMTsKCgkJdGhpcy5zZXRWYWx1ZXMoIHBhcmFtZXRlcnMgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5zY2FsZSA9IHNvdXJjZS5zY2FsZTsKCQl0aGlzLmRhc2hTaXplID0gc291cmNlLmRhc2hTaXplOwoJCXRoaXMuZ2FwU2l6ZSA9IHNvdXJjZS5nYXBTaXplOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgovLyBjb252ZXJ0cyBhbiBhcnJheSB0byBhIHNwZWNpZmljIHR5cGUKZnVuY3Rpb24gY29udmVydEFycmF5KCBhcnJheSwgdHlwZSwgZm9yY2VDbG9uZSApIHsKCglpZiAoICEgYXJyYXkgfHwgLy8gbGV0ICd1bmRlZmluZWQnIGFuZCAnbnVsbCcgcGFzcwoJCSEgZm9yY2VDbG9uZSAmJiBhcnJheS5jb25zdHJ1Y3RvciA9PT0gdHlwZSApIHJldHVybiBhcnJheTsKCglpZiAoIHR5cGVvZiB0eXBlLkJZVEVTX1BFUl9FTEVNRU5UID09PSAnbnVtYmVyJyApIHsKCgkJcmV0dXJuIG5ldyB0eXBlKCBhcnJheSApOyAvLyBjcmVhdGUgdHlwZWQgYXJyYXkKCgl9CgoJcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcnJheSApOyAvLyBjcmVhdGUgQXJyYXkKCn0KCmZ1bmN0aW9uIGlzVHlwZWRBcnJheSggb2JqZWN0ICkgewoKCXJldHVybiBBcnJheUJ1ZmZlci5pc1ZpZXcoIG9iamVjdCApICYmCgkJISAoIG9iamVjdCBpbnN0YW5jZW9mIERhdGFWaWV3ICk7Cgp9CgovLyByZXR1cm5zIGFuIGFycmF5IGJ5IHdoaWNoIHRpbWVzIGFuZCB2YWx1ZXMgY2FuIGJlIHNvcnRlZApmdW5jdGlvbiBnZXRLZXlmcmFtZU9yZGVyKCB0aW1lcyApIHsKCglmdW5jdGlvbiBjb21wYXJlVGltZSggaSwgaiApIHsKCgkJcmV0dXJuIHRpbWVzWyBpIF0gLSB0aW1lc1sgaiBdOwoKCX0KCgljb25zdCBuID0gdGltZXMubGVuZ3RoOwoJY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KCBuICk7Cglmb3IgKCBsZXQgaSA9IDA7IGkgIT09IG47ICsrIGkgKSByZXN1bHRbIGkgXSA9IGk7CgoJcmVzdWx0LnNvcnQoIGNvbXBhcmVUaW1lICk7CgoJcmV0dXJuIHJlc3VsdDsKCn0KCi8vIHVzZXMgdGhlIGFycmF5IHByZXZpb3VzbHkgcmV0dXJuZWQgYnkgJ2dldEtleWZyYW1lT3JkZXInIHRvIHNvcnQgZGF0YQpmdW5jdGlvbiBzb3J0ZWRBcnJheSggdmFsdWVzLCBzdHJpZGUsIG9yZGVyICkgewoKCWNvbnN0IG5WYWx1ZXMgPSB2YWx1ZXMubGVuZ3RoOwoJY29uc3QgcmVzdWx0ID0gbmV3IHZhbHVlcy5jb25zdHJ1Y3RvciggblZhbHVlcyApOwoKCWZvciAoIGxldCBpID0gMCwgZHN0T2Zmc2V0ID0gMDsgZHN0T2Zmc2V0ICE9PSBuVmFsdWVzOyArKyBpICkgewoKCQljb25zdCBzcmNPZmZzZXQgPSBvcmRlclsgaSBdICogc3RyaWRlOwoKCQlmb3IgKCBsZXQgaiA9IDA7IGogIT09IHN0cmlkZTsgKysgaiApIHsKCgkJCXJlc3VsdFsgZHN0T2Zmc2V0ICsrIF0gPSB2YWx1ZXNbIHNyY09mZnNldCArIGogXTsKCgkJfQoKCX0KCglyZXR1cm4gcmVzdWx0OwoKfQoKLy8gZnVuY3Rpb24gZm9yIHBhcnNpbmcgQU9TIGtleWZyYW1lIGZvcm1hdHMKZnVuY3Rpb24gZmxhdHRlbkpTT04oIGpzb25LZXlzLCB0aW1lcywgdmFsdWVzLCB2YWx1ZVByb3BlcnR5TmFtZSApIHsKCglsZXQgaSA9IDEsIGtleSA9IGpzb25LZXlzWyAwIF07CgoJd2hpbGUgKCBrZXkgIT09IHVuZGVmaW5lZCAmJiBrZXlbIHZhbHVlUHJvcGVydHlOYW1lIF0gPT09IHVuZGVmaW5lZCApIHsKCgkJa2V5ID0ganNvbktleXNbIGkgKysgXTsKCgl9CgoJaWYgKCBrZXkgPT09IHVuZGVmaW5lZCApIHJldHVybjsgLy8gbm8gZGF0YQoKCWxldCB2YWx1ZSA9IGtleVsgdmFsdWVQcm9wZXJ0eU5hbWUgXTsKCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHJldHVybjsgLy8gbm8gZGF0YQoKCWlmICggQXJyYXkuaXNBcnJheSggdmFsdWUgKSApIHsKCgkJZG8gewoKCQkJdmFsdWUgPSBrZXlbIHZhbHVlUHJvcGVydHlOYW1lIF07CgoJCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJdGltZXMucHVzaCgga2V5LnRpbWUgKTsKCQkJCXZhbHVlcy5wdXNoLmFwcGx5KCB2YWx1ZXMsIHZhbHVlICk7IC8vIHB1c2ggYWxsIGVsZW1lbnRzCgoJCQl9CgoJCQlrZXkgPSBqc29uS2V5c1sgaSArKyBdOwoKCQl9IHdoaWxlICgga2V5ICE9PSB1bmRlZmluZWQgKTsKCgl9IGVsc2UgaWYgKCB2YWx1ZS50b0FycmF5ICE9PSB1bmRlZmluZWQgKSB7CgoJCS8vIC4uLmFzc3VtZSBUSFJFRS5NYXRoLWlzaAoKCQlkbyB7CgoJCQl2YWx1ZSA9IGtleVsgdmFsdWVQcm9wZXJ0eU5hbWUgXTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCgkJCQl0aW1lcy5wdXNoKCBrZXkudGltZSApOwoJCQkJdmFsdWUudG9BcnJheSggdmFsdWVzLCB2YWx1ZXMubGVuZ3RoICk7CgoJCQl9CgoJCQlrZXkgPSBqc29uS2V5c1sgaSArKyBdOwoKCQl9IHdoaWxlICgga2V5ICE9PSB1bmRlZmluZWQgKTsKCgl9IGVsc2UgewoKCQkvLyBvdGhlcndpc2UgcHVzaCBhcy1pcwoKCQlkbyB7CgoJCQl2YWx1ZSA9IGtleVsgdmFsdWVQcm9wZXJ0eU5hbWUgXTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCgkJCQl0aW1lcy5wdXNoKCBrZXkudGltZSApOwoJCQkJdmFsdWVzLnB1c2goIHZhbHVlICk7CgoJCQl9CgoJCQlrZXkgPSBqc29uS2V5c1sgaSArKyBdOwoKCQl9IHdoaWxlICgga2V5ICE9PSB1bmRlZmluZWQgKTsKCgl9Cgp9CgpmdW5jdGlvbiBzdWJjbGlwKCBzb3VyY2VDbGlwLCBuYW1lLCBzdGFydEZyYW1lLCBlbmRGcmFtZSwgZnBzID0gMzAgKSB7CgoJY29uc3QgY2xpcCA9IHNvdXJjZUNsaXAuY2xvbmUoKTsKCgljbGlwLm5hbWUgPSBuYW1lOwoKCWNvbnN0IHRyYWNrcyA9IFtdOwoKCWZvciAoIGxldCBpID0gMDsgaSA8IGNsaXAudHJhY2tzLmxlbmd0aDsgKysgaSApIHsKCgkJY29uc3QgdHJhY2sgPSBjbGlwLnRyYWNrc1sgaSBdOwoJCWNvbnN0IHZhbHVlU2l6ZSA9IHRyYWNrLmdldFZhbHVlU2l6ZSgpOwoKCQljb25zdCB0aW1lcyA9IFtdOwoJCWNvbnN0IHZhbHVlcyA9IFtdOwoKCQlmb3IgKCBsZXQgaiA9IDA7IGogPCB0cmFjay50aW1lcy5sZW5ndGg7ICsrIGogKSB7CgoJCQljb25zdCBmcmFtZSA9IHRyYWNrLnRpbWVzWyBqIF0gKiBmcHM7CgoJCQlpZiAoIGZyYW1lIDwgc3RhcnRGcmFtZSB8fCBmcmFtZSA+PSBlbmRGcmFtZSApIGNvbnRpbnVlOwoKCQkJdGltZXMucHVzaCggdHJhY2sudGltZXNbIGogXSApOwoKCQkJZm9yICggbGV0IGsgPSAwOyBrIDwgdmFsdWVTaXplOyArKyBrICkgewoKCQkJCXZhbHVlcy5wdXNoKCB0cmFjay52YWx1ZXNbIGogKiB2YWx1ZVNpemUgKyBrIF0gKTsKCgkJCX0KCgkJfQoKCQlpZiAoIHRpbWVzLmxlbmd0aCA9PT0gMCApIGNvbnRpbnVlOwoKCQl0cmFjay50aW1lcyA9IGNvbnZlcnRBcnJheSggdGltZXMsIHRyYWNrLnRpbWVzLmNvbnN0cnVjdG9yICk7CgkJdHJhY2sudmFsdWVzID0gY29udmVydEFycmF5KCB2YWx1ZXMsIHRyYWNrLnZhbHVlcy5jb25zdHJ1Y3RvciApOwoKCQl0cmFja3MucHVzaCggdHJhY2sgKTsKCgl9CgoJY2xpcC50cmFja3MgPSB0cmFja3M7CgoJLy8gZmluZCBtaW5pbXVtIC50aW1lcyB2YWx1ZSBhY3Jvc3MgYWxsIHRyYWNrcyBpbiB0aGUgdHJpbW1lZCBjbGlwCgoJbGV0IG1pblN0YXJ0VGltZSA9IEluZmluaXR5OwoKCWZvciAoIGxldCBpID0gMDsgaSA8IGNsaXAudHJhY2tzLmxlbmd0aDsgKysgaSApIHsKCgkJaWYgKCBtaW5TdGFydFRpbWUgPiBjbGlwLnRyYWNrc1sgaSBdLnRpbWVzWyAwIF0gKSB7CgoJCQltaW5TdGFydFRpbWUgPSBjbGlwLnRyYWNrc1sgaSBdLnRpbWVzWyAwIF07CgoJCX0KCgl9CgoJLy8gc2hpZnQgYWxsIHRyYWNrcyBzdWNoIHRoYXQgY2xpcCBiZWdpbnMgYXQgdD0wCgoJZm9yICggbGV0IGkgPSAwOyBpIDwgY2xpcC50cmFja3MubGVuZ3RoOyArKyBpICkgewoKCQljbGlwLnRyYWNrc1sgaSBdLnNoaWZ0KCAtIDEgKiBtaW5TdGFydFRpbWUgKTsKCgl9CgoJY2xpcC5yZXNldER1cmF0aW9uKCk7CgoJcmV0dXJuIGNsaXA7Cgp9CgpmdW5jdGlvbiBtYWtlQ2xpcEFkZGl0aXZlKCB0YXJnZXRDbGlwLCByZWZlcmVuY2VGcmFtZSA9IDAsIHJlZmVyZW5jZUNsaXAgPSB0YXJnZXRDbGlwLCBmcHMgPSAzMCApIHsKCglpZiAoIGZwcyA8PSAwICkgZnBzID0gMzA7CgoJY29uc3QgbnVtVHJhY2tzID0gcmVmZXJlbmNlQ2xpcC50cmFja3MubGVuZ3RoOwoJY29uc3QgcmVmZXJlbmNlVGltZSA9IHJlZmVyZW5jZUZyYW1lIC8gZnBzOwoKCS8vIE1ha2UgZWFjaCB0cmFjaydzIHZhbHVlcyByZWxhdGl2ZSB0byB0aGUgdmFsdWVzIGF0IHRoZSByZWZlcmVuY2UgZnJhbWUKCWZvciAoIGxldCBpID0gMDsgaSA8IG51bVRyYWNrczsgKysgaSApIHsKCgkJY29uc3QgcmVmZXJlbmNlVHJhY2sgPSByZWZlcmVuY2VDbGlwLnRyYWNrc1sgaSBdOwoJCWNvbnN0IHJlZmVyZW5jZVRyYWNrVHlwZSA9IHJlZmVyZW5jZVRyYWNrLlZhbHVlVHlwZU5hbWU7CgoJCS8vIFNraXAgdGhpcyB0cmFjayBpZiBpdCdzIG5vbi1udW1lcmljCgkJaWYgKCByZWZlcmVuY2VUcmFja1R5cGUgPT09ICdib29sJyB8fCByZWZlcmVuY2VUcmFja1R5cGUgPT09ICdzdHJpbmcnICkgY29udGludWU7CgoJCS8vIEZpbmQgdGhlIHRyYWNrIGluIHRoZSB0YXJnZXQgY2xpcCB3aG9zZSBuYW1lIGFuZCB0eXBlIG1hdGNoZXMgdGhlIHJlZmVyZW5jZSB0cmFjawoJCWNvbnN0IHRhcmdldFRyYWNrID0gdGFyZ2V0Q2xpcC50cmFja3MuZmluZCggZnVuY3Rpb24gKCB0cmFjayApIHsKCgkJCXJldHVybiB0cmFjay5uYW1lID09PSByZWZlcmVuY2VUcmFjay5uYW1lCgkJCQkmJiB0cmFjay5WYWx1ZVR5cGVOYW1lID09PSByZWZlcmVuY2VUcmFja1R5cGU7CgoJCX0gKTsKCgkJaWYgKCB0YXJnZXRUcmFjayA9PT0gdW5kZWZpbmVkICkgY29udGludWU7CgoJCWxldCByZWZlcmVuY2VPZmZzZXQgPSAwOwoJCWNvbnN0IHJlZmVyZW5jZVZhbHVlU2l6ZSA9IHJlZmVyZW5jZVRyYWNrLmdldFZhbHVlU2l6ZSgpOwoKCQlpZiAoIHJlZmVyZW5jZVRyYWNrLmNyZWF0ZUludGVycG9sYW50LmlzSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kR0xURkN1YmljU3BsaW5lICkgewoKCQkJcmVmZXJlbmNlT2Zmc2V0ID0gcmVmZXJlbmNlVmFsdWVTaXplIC8gMzsKCgkJfQoKCQlsZXQgdGFyZ2V0T2Zmc2V0ID0gMDsKCQljb25zdCB0YXJnZXRWYWx1ZVNpemUgPSB0YXJnZXRUcmFjay5nZXRWYWx1ZVNpemUoKTsKCgkJaWYgKCB0YXJnZXRUcmFjay5jcmVhdGVJbnRlcnBvbGFudC5pc0ludGVycG9sYW50RmFjdG9yeU1ldGhvZEdMVEZDdWJpY1NwbGluZSApIHsKCgkJCXRhcmdldE9mZnNldCA9IHRhcmdldFZhbHVlU2l6ZSAvIDM7CgoJCX0KCgkJY29uc3QgbGFzdEluZGV4ID0gcmVmZXJlbmNlVHJhY2sudGltZXMubGVuZ3RoIC0gMTsKCQlsZXQgcmVmZXJlbmNlVmFsdWU7CgoJCS8vIEZpbmQgdGhlIHZhbHVlIHRvIHN1YnRyYWN0IG91dCBvZiB0aGUgdHJhY2sKCQlpZiAoIHJlZmVyZW5jZVRpbWUgPD0gcmVmZXJlbmNlVHJhY2sudGltZXNbIDAgXSApIHsKCgkJCS8vIFJlZmVyZW5jZSBmcmFtZSBpcyBlYXJsaWVyIHRoYW4gdGhlIGZpcnN0IGtleWZyYW1lLCBzbyBqdXN0IHVzZSB0aGUgZmlyc3Qga2V5ZnJhbWUKCQkJY29uc3Qgc3RhcnRJbmRleCA9IHJlZmVyZW5jZU9mZnNldDsKCQkJY29uc3QgZW5kSW5kZXggPSByZWZlcmVuY2VWYWx1ZVNpemUgLSByZWZlcmVuY2VPZmZzZXQ7CgkJCXJlZmVyZW5jZVZhbHVlID0gcmVmZXJlbmNlVHJhY2sudmFsdWVzLnNsaWNlKCBzdGFydEluZGV4LCBlbmRJbmRleCApOwoKCQl9IGVsc2UgaWYgKCByZWZlcmVuY2VUaW1lID49IHJlZmVyZW5jZVRyYWNrLnRpbWVzWyBsYXN0SW5kZXggXSApIHsKCgkJCS8vIFJlZmVyZW5jZSBmcmFtZSBpcyBhZnRlciB0aGUgbGFzdCBrZXlmcmFtZSwgc28ganVzdCB1c2UgdGhlIGxhc3Qga2V5ZnJhbWUKCQkJY29uc3Qgc3RhcnRJbmRleCA9IGxhc3RJbmRleCAqIHJlZmVyZW5jZVZhbHVlU2l6ZSArIHJlZmVyZW5jZU9mZnNldDsKCQkJY29uc3QgZW5kSW5kZXggPSBzdGFydEluZGV4ICsgcmVmZXJlbmNlVmFsdWVTaXplIC0gcmVmZXJlbmNlT2Zmc2V0OwoJCQlyZWZlcmVuY2VWYWx1ZSA9IHJlZmVyZW5jZVRyYWNrLnZhbHVlcy5zbGljZSggc3RhcnRJbmRleCwgZW5kSW5kZXggKTsKCgkJfSBlbHNlIHsKCgkJCS8vIEludGVycG9sYXRlIHRvIHRoZSByZWZlcmVuY2UgdmFsdWUKCQkJY29uc3QgaW50ZXJwb2xhbnQgPSByZWZlcmVuY2VUcmFjay5jcmVhdGVJbnRlcnBvbGFudCgpOwoJCQljb25zdCBzdGFydEluZGV4ID0gcmVmZXJlbmNlT2Zmc2V0OwoJCQljb25zdCBlbmRJbmRleCA9IHJlZmVyZW5jZVZhbHVlU2l6ZSAtIHJlZmVyZW5jZU9mZnNldDsKCQkJaW50ZXJwb2xhbnQuZXZhbHVhdGUoIHJlZmVyZW5jZVRpbWUgKTsKCQkJcmVmZXJlbmNlVmFsdWUgPSBpbnRlcnBvbGFudC5yZXN1bHRCdWZmZXIuc2xpY2UoIHN0YXJ0SW5kZXgsIGVuZEluZGV4ICk7CgoJCX0KCgkJLy8gQ29uanVnYXRlIHRoZSBxdWF0ZXJuaW9uCgkJaWYgKCByZWZlcmVuY2VUcmFja1R5cGUgPT09ICdxdWF0ZXJuaW9uJyApIHsKCgkJCWNvbnN0IHJlZmVyZW5jZVF1YXQgPSBuZXcgUXVhdGVybmlvbigpLmZyb21BcnJheSggcmVmZXJlbmNlVmFsdWUgKS5ub3JtYWxpemUoKS5jb25qdWdhdGUoKTsKCQkJcmVmZXJlbmNlUXVhdC50b0FycmF5KCByZWZlcmVuY2VWYWx1ZSApOwoKCQl9CgoJCS8vIFN1YnRyYWN0IHRoZSByZWZlcmVuY2UgdmFsdWUgZnJvbSBhbGwgb2YgdGhlIHRyYWNrIHZhbHVlcwoKCQljb25zdCBudW1UaW1lcyA9IHRhcmdldFRyYWNrLnRpbWVzLmxlbmd0aDsKCQlmb3IgKCBsZXQgaiA9IDA7IGogPCBudW1UaW1lczsgKysgaiApIHsKCgkJCWNvbnN0IHZhbHVlU3RhcnQgPSBqICogdGFyZ2V0VmFsdWVTaXplICsgdGFyZ2V0T2Zmc2V0OwoKCQkJaWYgKCByZWZlcmVuY2VUcmFja1R5cGUgPT09ICdxdWF0ZXJuaW9uJyApIHsKCgkJCQkvLyBNdWx0aXBseSB0aGUgY29uanVnYXRlIGZvciBxdWF0ZXJuaW9uIHRyYWNrIHR5cGVzCgkJCQlRdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnNGbGF0KAoJCQkJCXRhcmdldFRyYWNrLnZhbHVlcywKCQkJCQl2YWx1ZVN0YXJ0LAoJCQkJCXJlZmVyZW5jZVZhbHVlLAoJCQkJCTAsCgkJCQkJdGFyZ2V0VHJhY2sudmFsdWVzLAoJCQkJCXZhbHVlU3RhcnQKCQkJCSk7CgoJCQl9IGVsc2UgewoKCQkJCWNvbnN0IHZhbHVlRW5kID0gdGFyZ2V0VmFsdWVTaXplIC0gdGFyZ2V0T2Zmc2V0ICogMjsKCgkJCQkvLyBTdWJ0cmFjdCBlYWNoIHZhbHVlIGZvciBhbGwgb3RoZXIgbnVtZXJpYyB0cmFjayB0eXBlcwoJCQkJZm9yICggbGV0IGsgPSAwOyBrIDwgdmFsdWVFbmQ7ICsrIGsgKSB7CgoJCQkJCXRhcmdldFRyYWNrLnZhbHVlc1sgdmFsdWVTdGFydCArIGsgXSAtPSByZWZlcmVuY2VWYWx1ZVsgayBdOwoKCQkJCX0KCgkJCX0KCgkJfQoKCX0KCgl0YXJnZXRDbGlwLmJsZW5kTW9kZSA9IEFkZGl0aXZlQW5pbWF0aW9uQmxlbmRNb2RlOwoKCXJldHVybiB0YXJnZXRDbGlwOwoKfQoKY29uc3QgQW5pbWF0aW9uVXRpbHMgPSB7Cgljb252ZXJ0QXJyYXk6IGNvbnZlcnRBcnJheSwKCWlzVHlwZWRBcnJheTogaXNUeXBlZEFycmF5LAoJZ2V0S2V5ZnJhbWVPcmRlcjogZ2V0S2V5ZnJhbWVPcmRlciwKCXNvcnRlZEFycmF5OiBzb3J0ZWRBcnJheSwKCWZsYXR0ZW5KU09OOiBmbGF0dGVuSlNPTiwKCXN1YmNsaXA6IHN1YmNsaXAsCgltYWtlQ2xpcEFkZGl0aXZlOiBtYWtlQ2xpcEFkZGl0aXZlCn07CgovKioKICogQWJzdHJhY3QgYmFzZSBjbGFzcyBvZiBpbnRlcnBvbGFudHMgb3ZlciBwYXJhbWV0cmljIHNhbXBsZXMuCiAqCiAqIFRoZSBwYXJhbWV0ZXIgZG9tYWluIGlzIG9uZSBkaW1lbnNpb25hbCwgdHlwaWNhbGx5IHRoZSB0aW1lIG9yIGEgcGF0aAogKiBhbG9uZyBhIGN1cnZlIGRlZmluZWQgYnkgdGhlIGRhdGEuCiAqCiAqIFRoZSBzYW1wbGUgdmFsdWVzIGNhbiBoYXZlIGFueSBkaW1lbnNpb25hbGl0eSBhbmQgZGVyaXZlZCBjbGFzc2VzIG1heQogKiBhcHBseSBzcGVjaWFsIGludGVycHJldGF0aW9ucyB0byB0aGUgZGF0YS4KICoKICogVGhpcyBjbGFzcyBwcm92aWRlcyB0aGUgaW50ZXJ2YWwgc2VlayBpbiBhIFRlbXBsYXRlIE1ldGhvZCwgZGVmZXJyaW5nCiAqIHRoZSBhY3R1YWwgaW50ZXJwb2xhdGlvbiB0byBkZXJpdmVkIGNsYXNzZXMuCiAqCiAqIFRpbWUgY29tcGxleGl0eSBpcyBPKDEpIGZvciBsaW5lYXIgYWNjZXNzIGNyb3NzaW5nIGF0IG1vc3QgdHdvIHBvaW50cwogKiBhbmQgTyhsb2cgTikgZm9yIHJhbmRvbSBhY2Nlc3MsIHdoZXJlIE4gaXMgdGhlIG51bWJlciBvZiBwb3NpdGlvbnMuCiAqCiAqIFJlZmVyZW5jZXM6CiAqCiAqIAkJaHR0cDovL3d3dy5vb2Rlc2lnbi5jb20vdGVtcGxhdGUtbWV0aG9kLXBhdHRlcm4uaHRtbAogKgogKi8KCmNsYXNzIEludGVycG9sYW50IHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVyUG9zaXRpb25zLCBzYW1wbGVWYWx1ZXMsIHNhbXBsZVNpemUsIHJlc3VsdEJ1ZmZlciApIHsKCgkJdGhpcy5wYXJhbWV0ZXJQb3NpdGlvbnMgPSBwYXJhbWV0ZXJQb3NpdGlvbnM7CgkJdGhpcy5fY2FjaGVkSW5kZXggPSAwOwoKCQl0aGlzLnJlc3VsdEJ1ZmZlciA9IHJlc3VsdEJ1ZmZlciAhPT0gdW5kZWZpbmVkID8KCQkJcmVzdWx0QnVmZmVyIDogbmV3IHNhbXBsZVZhbHVlcy5jb25zdHJ1Y3Rvciggc2FtcGxlU2l6ZSApOwoJCXRoaXMuc2FtcGxlVmFsdWVzID0gc2FtcGxlVmFsdWVzOwoJCXRoaXMudmFsdWVTaXplID0gc2FtcGxlU2l6ZTsKCgkJdGhpcy5zZXR0aW5ncyA9IG51bGw7CgkJdGhpcy5EZWZhdWx0U2V0dGluZ3NfID0ge307CgoJfQoKCWV2YWx1YXRlKCB0ICkgewoKCQljb25zdCBwcCA9IHRoaXMucGFyYW1ldGVyUG9zaXRpb25zOwoJCWxldCBpMSA9IHRoaXMuX2NhY2hlZEluZGV4LAoJCQl0MSA9IHBwWyBpMSBdLAoJCQl0MCA9IHBwWyBpMSAtIDEgXTsKCgkJdmFsaWRhdGVfaW50ZXJ2YWw6IHsKCgkJCXNlZWs6IHsKCgkJCQlsZXQgcmlnaHQ7CgoJCQkJbGluZWFyX3NjYW46IHsKCgkJCQkJLy8tIFNlZSBodHRwOi8vanNwZXJmLmNvbS9jb21wYXJpc29uLXRvLXVuZGVmaW5lZC8zCgkJCQkJLy8tIHNsb3dlciBjb2RlOgoJCQkJCS8vLQoJCQkJCS8vLSAJCQkJaWYgKCB0ID49IHQxIHx8IHQxID09PSB1bmRlZmluZWQgKSB7CgkJCQkJZm9yd2FyZF9zY2FuOiBpZiAoICEgKCB0IDwgdDEgKSApIHsKCgkJCQkJCWZvciAoIGxldCBnaXZlVXBBdCA9IGkxICsgMjsgOyApIHsKCgkJCQkJCQlpZiAoIHQxID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCQkJCWlmICggdCA8IHQwICkgYnJlYWsgZm9yd2FyZF9zY2FuOwoKCQkJCQkJCQkvLyBhZnRlciBlbmQKCgkJCQkJCQkJaTEgPSBwcC5sZW5ndGg7CgkJCQkJCQkJdGhpcy5fY2FjaGVkSW5kZXggPSBpMTsKCQkJCQkJCQlyZXR1cm4gdGhpcy5jb3B5U2FtcGxlVmFsdWVfKCBpMSAtIDEgKTsKCgkJCQkJCQl9CgoJCQkJCQkJaWYgKCBpMSA9PT0gZ2l2ZVVwQXQgKSBicmVhazsgLy8gdGhpcyBsb29wCgoJCQkJCQkJdDAgPSB0MTsKCQkJCQkJCXQxID0gcHBbICsrIGkxIF07CgoJCQkJCQkJaWYgKCB0IDwgdDEgKSB7CgoJCQkJCQkJCS8vIHdlIGhhdmUgYXJyaXZlZCBhdCB0aGUgc291Z2h0IGludGVydmFsCgkJCQkJCQkJYnJlYWsgc2VlazsKCgkJCQkJCQl9CgoJCQkJCQl9CgoJCQkJCQkvLyBwcmVwYXJlIGJpbmFyeSBzZWFyY2ggb24gdGhlIHJpZ2h0IHNpZGUgb2YgdGhlIGluZGV4CgkJCQkJCXJpZ2h0ID0gcHAubGVuZ3RoOwoJCQkJCQlicmVhayBsaW5lYXJfc2NhbjsKCgkJCQkJfQoKCQkJCQkvLy0gc2xvd2VyIGNvZGU6CgkJCQkJLy8tCQkJCQlpZiAoIHQgPCB0MCB8fCB0MCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggISAoIHQgPj0gdDAgKSApIHsKCgkJCQkJCS8vIGxvb3Bpbmc/CgoJCQkJCQljb25zdCB0MWdsb2JhbCA9IHBwWyAxIF07CgoJCQkJCQlpZiAoIHQgPCB0MWdsb2JhbCApIHsKCgkJCQkJCQlpMSA9IDI7IC8vICsgMSwgdXNpbmcgdGhlIHNjYW4gZm9yIHRoZSBkZXRhaWxzCgkJCQkJCQl0MCA9IHQxZ2xvYmFsOwoKCQkJCQkJfQoKCQkJCQkJLy8gbGluZWFyIHJldmVyc2Ugc2NhbgoKCQkJCQkJZm9yICggbGV0IGdpdmVVcEF0ID0gaTEgLSAyOyA7ICkgewoKCQkJCQkJCWlmICggdDAgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkJCQkJLy8gYmVmb3JlIHN0YXJ0CgoJCQkJCQkJCXRoaXMuX2NhY2hlZEluZGV4ID0gMDsKCQkJCQkJCQlyZXR1cm4gdGhpcy5jb3B5U2FtcGxlVmFsdWVfKCAwICk7CgoJCQkJCQkJfQoKCQkJCQkJCWlmICggaTEgPT09IGdpdmVVcEF0ICkgYnJlYWs7IC8vIHRoaXMgbG9vcAoKCQkJCQkJCXQxID0gdDA7CgkJCQkJCQl0MCA9IHBwWyAtLSBpMSAtIDEgXTsKCgkJCQkJCQlpZiAoIHQgPj0gdDAgKSB7CgoJCQkJCQkJCS8vIHdlIGhhdmUgYXJyaXZlZCBhdCB0aGUgc291Z2h0IGludGVydmFsCgkJCQkJCQkJYnJlYWsgc2VlazsKCgkJCQkJCQl9CgoJCQkJCQl9CgoJCQkJCQkvLyBwcmVwYXJlIGJpbmFyeSBzZWFyY2ggb24gdGhlIGxlZnQgc2lkZSBvZiB0aGUgaW5kZXgKCQkJCQkJcmlnaHQgPSBpMTsKCQkJCQkJaTEgPSAwOwoJCQkJCQlicmVhayBsaW5lYXJfc2NhbjsKCgkJCQkJfQoKCQkJCQkvLyB0aGUgaW50ZXJ2YWwgaXMgdmFsaWQKCgkJCQkJYnJlYWsgdmFsaWRhdGVfaW50ZXJ2YWw7CgoJCQkJfSAvLyBsaW5lYXIgc2NhbgoKCQkJCS8vIGJpbmFyeSBzZWFyY2gKCgkJCQl3aGlsZSAoIGkxIDwgcmlnaHQgKSB7CgoJCQkJCWNvbnN0IG1pZCA9ICggaTEgKyByaWdodCApID4+PiAxOwoKCQkJCQlpZiAoIHQgPCBwcFsgbWlkIF0gKSB7CgoJCQkJCQlyaWdodCA9IG1pZDsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCWkxID0gbWlkICsgMTsKCgkJCQkJfQoKCQkJCX0KCgkJCQl0MSA9IHBwWyBpMSBdOwoJCQkJdDAgPSBwcFsgaTEgLSAxIF07CgoJCQkJLy8gY2hlY2sgYm91bmRhcnkgY2FzZXMsIGFnYWluCgoJCQkJaWYgKCB0MCA9PT0gdW5kZWZpbmVkICkgewoKCQkJCQl0aGlzLl9jYWNoZWRJbmRleCA9IDA7CgkJCQkJcmV0dXJuIHRoaXMuY29weVNhbXBsZVZhbHVlXyggMCApOwoKCQkJCX0KCgkJCQlpZiAoIHQxID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCWkxID0gcHAubGVuZ3RoOwoJCQkJCXRoaXMuX2NhY2hlZEluZGV4ID0gaTE7CgkJCQkJcmV0dXJuIHRoaXMuY29weVNhbXBsZVZhbHVlXyggaTEgLSAxICk7CgoJCQkJfQoKCQkJfSAvLyBzZWVrCgoJCQl0aGlzLl9jYWNoZWRJbmRleCA9IGkxOwoKCQkJdGhpcy5pbnRlcnZhbENoYW5nZWRfKCBpMSwgdDAsIHQxICk7CgoJCX0gLy8gdmFsaWRhdGVfaW50ZXJ2YWwKCgkJcmV0dXJuIHRoaXMuaW50ZXJwb2xhdGVfKCBpMSwgdDAsIHQsIHQxICk7CgoJfQoKCWdldFNldHRpbmdzXygpIHsKCgkJcmV0dXJuIHRoaXMuc2V0dGluZ3MgfHwgdGhpcy5EZWZhdWx0U2V0dGluZ3NfOwoKCX0KCgljb3B5U2FtcGxlVmFsdWVfKCBpbmRleCApIHsKCgkJLy8gY29waWVzIGEgc2FtcGxlIHZhbHVlIHRvIHRoZSByZXN1bHQgYnVmZmVyCgoJCWNvbnN0IHJlc3VsdCA9IHRoaXMucmVzdWx0QnVmZmVyLAoJCQl2YWx1ZXMgPSB0aGlzLnNhbXBsZVZhbHVlcywKCQkJc3RyaWRlID0gdGhpcy52YWx1ZVNpemUsCgkJCW9mZnNldCA9IGluZGV4ICogc3RyaWRlOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgIT09IHN0cmlkZTsgKysgaSApIHsKCgkJCXJlc3VsdFsgaSBdID0gdmFsdWVzWyBvZmZzZXQgKyBpIF07CgoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCgl9CgoJLy8gVGVtcGxhdGUgbWV0aG9kcyBmb3IgZGVyaXZlZCBjbGFzc2VzOgoKCWludGVycG9sYXRlXyggLyogaTEsIHQwLCB0LCB0MSAqLyApIHsKCgkJdGhyb3cgbmV3IEVycm9yKCAnY2FsbCB0byBhYnN0cmFjdCBtZXRob2QnICk7CgkJLy8gaW1wbGVtZW50YXRpb25zIHNoYWxsIHJldHVybiB0aGlzLnJlc3VsdEJ1ZmZlcgoKCX0KCglpbnRlcnZhbENoYW5nZWRfKCAvKiBpMSwgdDAsIHQxICovICkgewoKCQkvLyBlbXB0eQoKCX0KCn0KCi8qKgogKiBGYXN0IGFuZCBzaW1wbGUgY3ViaWMgc3BsaW5lIGludGVycG9sYW50LgogKgogKiBJdCB3YXMgZGVyaXZlZCBmcm9tIGEgSGVybWl0aWFuIGNvbnN0cnVjdGlvbiBzZXR0aW5nIHRoZSBmaXJzdCBkZXJpdmF0aXZlCiAqIGF0IGVhY2ggc2FtcGxlIHBvc2l0aW9uIHRvIHRoZSBsaW5lYXIgc2xvcGUgYmV0d2VlbiBuZWlnaGJvcmluZyBwb3NpdGlvbnMKICogb3ZlciB0aGVpciBwYXJhbWV0ZXIgaW50ZXJ2YWwuCiAqLwoKY2xhc3MgQ3ViaWNJbnRlcnBvbGFudCBleHRlbmRzIEludGVycG9sYW50IHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVyUG9zaXRpb25zLCBzYW1wbGVWYWx1ZXMsIHNhbXBsZVNpemUsIHJlc3VsdEJ1ZmZlciApIHsKCgkJc3VwZXIoIHBhcmFtZXRlclBvc2l0aW9ucywgc2FtcGxlVmFsdWVzLCBzYW1wbGVTaXplLCByZXN1bHRCdWZmZXIgKTsKCgkJdGhpcy5fd2VpZ2h0UHJldiA9IC0gMDsKCQl0aGlzLl9vZmZzZXRQcmV2ID0gLSAwOwoJCXRoaXMuX3dlaWdodE5leHQgPSAtIDA7CgkJdGhpcy5fb2Zmc2V0TmV4dCA9IC0gMDsKCgkJdGhpcy5EZWZhdWx0U2V0dGluZ3NfID0gewoKCQkJZW5kaW5nU3RhcnQ6IFplcm9DdXJ2YXR1cmVFbmRpbmcsCgkJCWVuZGluZ0VuZDogWmVyb0N1cnZhdHVyZUVuZGluZwoKCQl9OwoKCX0KCglpbnRlcnZhbENoYW5nZWRfKCBpMSwgdDAsIHQxICkgewoKCQljb25zdCBwcCA9IHRoaXMucGFyYW1ldGVyUG9zaXRpb25zOwoJCWxldCBpUHJldiA9IGkxIC0gMiwKCQkJaU5leHQgPSBpMSArIDEsCgoJCQl0UHJldiA9IHBwWyBpUHJldiBdLAoJCQl0TmV4dCA9IHBwWyBpTmV4dCBdOwoKCQlpZiAoIHRQcmV2ID09PSB1bmRlZmluZWQgKSB7CgoJCQlzd2l0Y2ggKCB0aGlzLmdldFNldHRpbmdzXygpLmVuZGluZ1N0YXJ0ICkgewoKCQkJCWNhc2UgWmVyb1Nsb3BlRW5kaW5nOgoKCQkJCQkvLyBmJyh0MCkgPSAwCgkJCQkJaVByZXYgPSBpMTsKCQkJCQl0UHJldiA9IDIgKiB0MCAtIHQxOwoKCQkJCQlicmVhazsKCgkJCQljYXNlIFdyYXBBcm91bmRFbmRpbmc6CgoJCQkJCS8vIHVzZSB0aGUgb3RoZXIgZW5kIG9mIHRoZSBjdXJ2ZQoJCQkJCWlQcmV2ID0gcHAubGVuZ3RoIC0gMjsKCQkJCQl0UHJldiA9IHQwICsgcHBbIGlQcmV2IF0gLSBwcFsgaVByZXYgKyAxIF07CgoJCQkJCWJyZWFrOwoKCQkJCWRlZmF1bHQ6IC8vIFplcm9DdXJ2YXR1cmVFbmRpbmcKCgkJCQkJLy8gZicnKHQwKSA9IDAgYS5rLmEuIE5hdHVyYWwgU3BsaW5lCgkJCQkJaVByZXYgPSBpMTsKCQkJCQl0UHJldiA9IHQxOwoKCQkJfQoKCQl9CgoJCWlmICggdE5leHQgPT09IHVuZGVmaW5lZCApIHsKCgkJCXN3aXRjaCAoIHRoaXMuZ2V0U2V0dGluZ3NfKCkuZW5kaW5nRW5kICkgewoKCQkJCWNhc2UgWmVyb1Nsb3BlRW5kaW5nOgoKCQkJCQkvLyBmJyh0TikgPSAwCgkJCQkJaU5leHQgPSBpMTsKCQkJCQl0TmV4dCA9IDIgKiB0MSAtIHQwOwoKCQkJCQlicmVhazsKCgkJCQljYXNlIFdyYXBBcm91bmRFbmRpbmc6CgoJCQkJCS8vIHVzZSB0aGUgb3RoZXIgZW5kIG9mIHRoZSBjdXJ2ZQoJCQkJCWlOZXh0ID0gMTsKCQkJCQl0TmV4dCA9IHQxICsgcHBbIDEgXSAtIHBwWyAwIF07CgoJCQkJCWJyZWFrOwoKCQkJCWRlZmF1bHQ6IC8vIFplcm9DdXJ2YXR1cmVFbmRpbmcKCgkJCQkJLy8gZicnKHROKSA9IDAsIGEuay5hLiBOYXR1cmFsIFNwbGluZQoJCQkJCWlOZXh0ID0gaTEgLSAxOwoJCQkJCXROZXh0ID0gdDA7CgoJCQl9CgoJCX0KCgkJY29uc3QgaGFsZkR0ID0gKCB0MSAtIHQwICkgKiAwLjUsCgkJCXN0cmlkZSA9IHRoaXMudmFsdWVTaXplOwoKCQl0aGlzLl93ZWlnaHRQcmV2ID0gaGFsZkR0IC8gKCB0MCAtIHRQcmV2ICk7CgkJdGhpcy5fd2VpZ2h0TmV4dCA9IGhhbGZEdCAvICggdE5leHQgLSB0MSApOwoJCXRoaXMuX29mZnNldFByZXYgPSBpUHJldiAqIHN0cmlkZTsKCQl0aGlzLl9vZmZzZXROZXh0ID0gaU5leHQgKiBzdHJpZGU7CgoJfQoKCWludGVycG9sYXRlXyggaTEsIHQwLCB0LCB0MSApIHsKCgkJY29uc3QgcmVzdWx0ID0gdGhpcy5yZXN1bHRCdWZmZXIsCgkJCXZhbHVlcyA9IHRoaXMuc2FtcGxlVmFsdWVzLAoJCQlzdHJpZGUgPSB0aGlzLnZhbHVlU2l6ZSwKCgkJCW8xID0gaTEgKiBzdHJpZGUsCQlvMCA9IG8xIC0gc3RyaWRlLAoJCQlvUCA9IHRoaXMuX29mZnNldFByZXYsIAlvTiA9IHRoaXMuX29mZnNldE5leHQsCgkJCXdQID0gdGhpcy5fd2VpZ2h0UHJldiwJd04gPSB0aGlzLl93ZWlnaHROZXh0LAoKCQkJcCA9ICggdCAtIHQwICkgLyAoIHQxIC0gdDAgKSwKCQkJcHAgPSBwICogcCwKCQkJcHBwID0gcHAgKiBwOwoKCQkvLyBldmFsdWF0ZSBwb2x5bm9taWFscwoKCQljb25zdCBzUCA9IC0gd1AgKiBwcHAgKyAyICogd1AgKiBwcCAtIHdQICogcDsKCQljb25zdCBzMCA9ICggMSArIHdQICkgKiBwcHAgKyAoIC0gMS41IC0gMiAqIHdQICkgKiBwcCArICggLSAwLjUgKyB3UCApICogcCArIDE7CgkJY29uc3QgczEgPSAoIC0gMSAtIHdOICkgKiBwcHAgKyAoIDEuNSArIHdOICkgKiBwcCArIDAuNSAqIHA7CgkJY29uc3Qgc04gPSB3TiAqIHBwcCAtIHdOICogcHA7CgoJCS8vIGNvbWJpbmUgZGF0YSBsaW5lYXJseQoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgIT09IHN0cmlkZTsgKysgaSApIHsKCgkJCXJlc3VsdFsgaSBdID0KCQkJCQlzUCAqIHZhbHVlc1sgb1AgKyBpIF0gKwoJCQkJCXMwICogdmFsdWVzWyBvMCArIGkgXSArCgkJCQkJczEgKiB2YWx1ZXNbIG8xICsgaSBdICsKCQkJCQlzTiAqIHZhbHVlc1sgb04gKyBpIF07CgoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCgl9Cgp9CgpjbGFzcyBMaW5lYXJJbnRlcnBvbGFudCBleHRlbmRzIEludGVycG9sYW50IHsKCgljb25zdHJ1Y3RvciggcGFyYW1ldGVyUG9zaXRpb25zLCBzYW1wbGVWYWx1ZXMsIHNhbXBsZVNpemUsIHJlc3VsdEJ1ZmZlciApIHsKCgkJc3VwZXIoIHBhcmFtZXRlclBvc2l0aW9ucywgc2FtcGxlVmFsdWVzLCBzYW1wbGVTaXplLCByZXN1bHRCdWZmZXIgKTsKCgl9CgoJaW50ZXJwb2xhdGVfKCBpMSwgdDAsIHQsIHQxICkgewoKCQljb25zdCByZXN1bHQgPSB0aGlzLnJlc3VsdEJ1ZmZlciwKCQkJdmFsdWVzID0gdGhpcy5zYW1wbGVWYWx1ZXMsCgkJCXN0cmlkZSA9IHRoaXMudmFsdWVTaXplLAoKCQkJb2Zmc2V0MSA9IGkxICogc3RyaWRlLAoJCQlvZmZzZXQwID0gb2Zmc2V0MSAtIHN0cmlkZSwKCgkJCXdlaWdodDEgPSAoIHQgLSB0MCApIC8gKCB0MSAtIHQwICksCgkJCXdlaWdodDAgPSAxIC0gd2VpZ2h0MTsKCgkJZm9yICggbGV0IGkgPSAwOyBpICE9PSBzdHJpZGU7ICsrIGkgKSB7CgoJCQlyZXN1bHRbIGkgXSA9CgkJCQkJdmFsdWVzWyBvZmZzZXQwICsgaSBdICogd2VpZ2h0MCArCgkJCQkJdmFsdWVzWyBvZmZzZXQxICsgaSBdICogd2VpZ2h0MTsKCgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoKCX0KCn0KCi8qKgogKgogKiBJbnRlcnBvbGFudCB0aGF0IGV2YWx1YXRlcyB0byB0aGUgc2FtcGxlIHZhbHVlIGF0IHRoZSBwb3NpdGlvbiBwcmVjZWRpbmcKICogdGhlIHBhcmFtZXRlci4KICovCgpjbGFzcyBEaXNjcmV0ZUludGVycG9sYW50IGV4dGVuZHMgSW50ZXJwb2xhbnQgewoKCWNvbnN0cnVjdG9yKCBwYXJhbWV0ZXJQb3NpdGlvbnMsIHNhbXBsZVZhbHVlcywgc2FtcGxlU2l6ZSwgcmVzdWx0QnVmZmVyICkgewoKCQlzdXBlciggcGFyYW1ldGVyUG9zaXRpb25zLCBzYW1wbGVWYWx1ZXMsIHNhbXBsZVNpemUsIHJlc3VsdEJ1ZmZlciApOwoKCX0KCglpbnRlcnBvbGF0ZV8oIGkxIC8qLCB0MCwgdCwgdDEgKi8gKSB7CgoJCXJldHVybiB0aGlzLmNvcHlTYW1wbGVWYWx1ZV8oIGkxIC0gMSApOwoKCX0KCn0KCmNsYXNzIEtleWZyYW1lVHJhY2sgewoKCWNvbnN0cnVjdG9yKCBuYW1lLCB0aW1lcywgdmFsdWVzLCBpbnRlcnBvbGF0aW9uICkgewoKCQlpZiAoIG5hbWUgPT09IHVuZGVmaW5lZCApIHRocm93IG5ldyBFcnJvciggJ1RIUkVFLktleWZyYW1lVHJhY2s6IHRyYWNrIG5hbWUgaXMgdW5kZWZpbmVkJyApOwoJCWlmICggdGltZXMgPT09IHVuZGVmaW5lZCB8fCB0aW1lcy5sZW5ndGggPT09IDAgKSB0aHJvdyBuZXcgRXJyb3IoICdUSFJFRS5LZXlmcmFtZVRyYWNrOiBubyBrZXlmcmFtZXMgaW4gdHJhY2sgbmFtZWQgJyArIG5hbWUgKTsKCgkJdGhpcy5uYW1lID0gbmFtZTsKCgkJdGhpcy50aW1lcyA9IGNvbnZlcnRBcnJheSggdGltZXMsIHRoaXMuVGltZUJ1ZmZlclR5cGUgKTsKCQl0aGlzLnZhbHVlcyA9IGNvbnZlcnRBcnJheSggdmFsdWVzLCB0aGlzLlZhbHVlQnVmZmVyVHlwZSApOwoKCQl0aGlzLnNldEludGVycG9sYXRpb24oIGludGVycG9sYXRpb24gfHwgdGhpcy5EZWZhdWx0SW50ZXJwb2xhdGlvbiApOwoKCX0KCgkvLyBTZXJpYWxpemF0aW9uIChpbiBzdGF0aWMgY29udGV4dCwgYmVjYXVzZSBvZiBjb25zdHJ1Y3RvciBpbnZvY2F0aW9uCgkvLyBhbmQgYXV0b21hdGljIGludm9jYXRpb24gb2YgLnRvSlNPTik6CgoJc3RhdGljIHRvSlNPTiggdHJhY2sgKSB7CgoJCWNvbnN0IHRyYWNrVHlwZSA9IHRyYWNrLmNvbnN0cnVjdG9yOwoKCQlsZXQganNvbjsKCgkJLy8gZGVyaXZlZCBjbGFzc2VzIGNhbiBkZWZpbmUgYSBzdGF0aWMgdG9KU09OIG1ldGhvZAoJCWlmICggdHJhY2tUeXBlLnRvSlNPTiAhPT0gdGhpcy50b0pTT04gKSB7CgoJCQlqc29uID0gdHJhY2tUeXBlLnRvSlNPTiggdHJhY2sgKTsKCgkJfSBlbHNlIHsKCgkJCS8vIGJ5IGRlZmF1bHQsIHdlIGFzc3VtZSB0aGUgZGF0YSBjYW4gYmUgc2VyaWFsaXplZCBhcy1pcwoJCQlqc29uID0gewoKCQkJCSduYW1lJzogdHJhY2submFtZSwKCQkJCSd0aW1lcyc6IGNvbnZlcnRBcnJheSggdHJhY2sudGltZXMsIEFycmF5ICksCgkJCQkndmFsdWVzJzogY29udmVydEFycmF5KCB0cmFjay52YWx1ZXMsIEFycmF5ICkKCgkJCX07CgoJCQljb25zdCBpbnRlcnBvbGF0aW9uID0gdHJhY2suZ2V0SW50ZXJwb2xhdGlvbigpOwoKCQkJaWYgKCBpbnRlcnBvbGF0aW9uICE9PSB0cmFjay5EZWZhdWx0SW50ZXJwb2xhdGlvbiApIHsKCgkJCQlqc29uLmludGVycG9sYXRpb24gPSBpbnRlcnBvbGF0aW9uOwoKCQkJfQoKCQl9CgoJCWpzb24udHlwZSA9IHRyYWNrLlZhbHVlVHlwZU5hbWU7IC8vIG1hbmRhdG9yeQoKCQlyZXR1cm4ganNvbjsKCgl9CgoJSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kRGlzY3JldGUoIHJlc3VsdCApIHsKCgkJcmV0dXJuIG5ldyBEaXNjcmV0ZUludGVycG9sYW50KCB0aGlzLnRpbWVzLCB0aGlzLnZhbHVlcywgdGhpcy5nZXRWYWx1ZVNpemUoKSwgcmVzdWx0ICk7CgoJfQoKCUludGVycG9sYW50RmFjdG9yeU1ldGhvZExpbmVhciggcmVzdWx0ICkgewoKCQlyZXR1cm4gbmV3IExpbmVhckludGVycG9sYW50KCB0aGlzLnRpbWVzLCB0aGlzLnZhbHVlcywgdGhpcy5nZXRWYWx1ZVNpemUoKSwgcmVzdWx0ICk7CgoJfQoKCUludGVycG9sYW50RmFjdG9yeU1ldGhvZFNtb290aCggcmVzdWx0ICkgewoKCQlyZXR1cm4gbmV3IEN1YmljSW50ZXJwb2xhbnQoIHRoaXMudGltZXMsIHRoaXMudmFsdWVzLCB0aGlzLmdldFZhbHVlU2l6ZSgpLCByZXN1bHQgKTsKCgl9CgoJc2V0SW50ZXJwb2xhdGlvbiggaW50ZXJwb2xhdGlvbiApIHsKCgkJbGV0IGZhY3RvcnlNZXRob2Q7CgoJCXN3aXRjaCAoIGludGVycG9sYXRpb24gKSB7CgoJCQljYXNlIEludGVycG9sYXRlRGlzY3JldGU6CgoJCQkJZmFjdG9yeU1ldGhvZCA9IHRoaXMuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kRGlzY3JldGU7CgoJCQkJYnJlYWs7CgoJCQljYXNlIEludGVycG9sYXRlTGluZWFyOgoKCQkJCWZhY3RvcnlNZXRob2QgPSB0aGlzLkludGVycG9sYW50RmFjdG9yeU1ldGhvZExpbmVhcjsKCgkJCQlicmVhazsKCgkJCWNhc2UgSW50ZXJwb2xhdGVTbW9vdGg6CgoJCQkJZmFjdG9yeU1ldGhvZCA9IHRoaXMuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kU21vb3RoOwoKCQkJCWJyZWFrOwoKCQl9CgoJCWlmICggZmFjdG9yeU1ldGhvZCA9PT0gdW5kZWZpbmVkICkgewoKCQkJY29uc3QgbWVzc2FnZSA9ICd1bnN1cHBvcnRlZCBpbnRlcnBvbGF0aW9uIGZvciAnICsKCQkJCXRoaXMuVmFsdWVUeXBlTmFtZSArICcga2V5ZnJhbWUgdHJhY2sgbmFtZWQgJyArIHRoaXMubmFtZTsKCgkJCWlmICggdGhpcy5jcmVhdGVJbnRlcnBvbGFudCA9PT0gdW5kZWZpbmVkICkgewoKCQkJCS8vIGZhbGwgYmFjayB0byBkZWZhdWx0LCB1bmxlc3MgdGhlIGRlZmF1bHQgaXRzZWxmIGlzIG1lc3NlZCB1cAoJCQkJaWYgKCBpbnRlcnBvbGF0aW9uICE9PSB0aGlzLkRlZmF1bHRJbnRlcnBvbGF0aW9uICkgewoKCQkJCQl0aGlzLnNldEludGVycG9sYXRpb24oIHRoaXMuRGVmYXVsdEludGVycG9sYXRpb24gKTsKCgkJCQl9IGVsc2UgewoKCQkJCQl0aHJvdyBuZXcgRXJyb3IoIG1lc3NhZ2UgKTsgLy8gZmF0YWwsIGluIHRoaXMgY2FzZQoKCQkJCX0KCgkJCX0KCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLktleWZyYW1lVHJhY2s6JywgbWVzc2FnZSApOwoJCQlyZXR1cm4gdGhpczsKCgkJfQoKCQl0aGlzLmNyZWF0ZUludGVycG9sYW50ID0gZmFjdG9yeU1ldGhvZDsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldEludGVycG9sYXRpb24oKSB7CgoJCXN3aXRjaCAoIHRoaXMuY3JlYXRlSW50ZXJwb2xhbnQgKSB7CgoJCQljYXNlIHRoaXMuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kRGlzY3JldGU6CgoJCQkJcmV0dXJuIEludGVycG9sYXRlRGlzY3JldGU7CgoJCQljYXNlIHRoaXMuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kTGluZWFyOgoKCQkJCXJldHVybiBJbnRlcnBvbGF0ZUxpbmVhcjsKCgkJCWNhc2UgdGhpcy5JbnRlcnBvbGFudEZhY3RvcnlNZXRob2RTbW9vdGg6CgoJCQkJcmV0dXJuIEludGVycG9sYXRlU21vb3RoOwoKCQl9CgoJfQoKCWdldFZhbHVlU2l6ZSgpIHsKCgkJcmV0dXJuIHRoaXMudmFsdWVzLmxlbmd0aCAvIHRoaXMudGltZXMubGVuZ3RoOwoKCX0KCgkvLyBtb3ZlIGFsbCBrZXlmcmFtZXMgZWl0aGVyIGZvcndhcmRzIG9yIGJhY2t3YXJkcyBpbiB0aW1lCglzaGlmdCggdGltZU9mZnNldCApIHsKCgkJaWYgKCB0aW1lT2Zmc2V0ICE9PSAwLjAgKSB7CgoJCQljb25zdCB0aW1lcyA9IHRoaXMudGltZXM7CgoJCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSB0aW1lcy5sZW5ndGg7IGkgIT09IG47ICsrIGkgKSB7CgoJCQkJdGltZXNbIGkgXSArPSB0aW1lT2Zmc2V0OwoKCQkJfQoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCgkvLyBzY2FsZSBhbGwga2V5ZnJhbWUgdGltZXMgYnkgYSBmYWN0b3IgKHVzZWZ1bCBmb3IgZnJhbWUgPC0+IHNlY29uZHMgY29udmVyc2lvbnMpCglzY2FsZSggdGltZVNjYWxlICkgewoKCQlpZiAoIHRpbWVTY2FsZSAhPT0gMS4wICkgewoKCQkJY29uc3QgdGltZXMgPSB0aGlzLnRpbWVzOwoKCQkJZm9yICggbGV0IGkgPSAwLCBuID0gdGltZXMubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJCXRpbWVzWyBpIF0gKj0gdGltZVNjYWxlOwoKCQkJfQoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCgkvLyByZW1vdmVzIGtleWZyYW1lcyBiZWZvcmUgYW5kIGFmdGVyIGFuaW1hdGlvbiB3aXRob3V0IGNoYW5naW5nIGFueSB2YWx1ZXMgd2l0aGluIHRoZSByYW5nZSBbc3RhcnRUaW1lLCBlbmRUaW1lXS4KCS8vIElNUE9SVEFOVDogV2UgZG8gbm90IHNoaWZ0IGFyb3VuZCBrZXlzIHRvIHRoZSBzdGFydCBvZiB0aGUgdHJhY2sgdGltZSwgYmVjYXVzZSBmb3IgaW50ZXJwb2xhdGVkIGtleXMgdGhpcyB3aWxsIGNoYW5nZSB0aGVpciB2YWx1ZXMKCXRyaW0oIHN0YXJ0VGltZSwgZW5kVGltZSApIHsKCgkJY29uc3QgdGltZXMgPSB0aGlzLnRpbWVzLAoJCQluS2V5cyA9IHRpbWVzLmxlbmd0aDsKCgkJbGV0IGZyb20gPSAwLAoJCQl0byA9IG5LZXlzIC0gMTsKCgkJd2hpbGUgKCBmcm9tICE9PSBuS2V5cyAmJiB0aW1lc1sgZnJvbSBdIDwgc3RhcnRUaW1lICkgewoKCQkJKysgZnJvbTsKCgkJfQoKCQl3aGlsZSAoIHRvICE9PSAtIDEgJiYgdGltZXNbIHRvIF0gPiBlbmRUaW1lICkgewoKCQkJLS0gdG87CgoJCX0KCgkJKysgdG87IC8vIGluY2x1c2l2ZSAtPiBleGNsdXNpdmUgYm91bmQKCgkJaWYgKCBmcm9tICE9PSAwIHx8IHRvICE9PSBuS2V5cyApIHsKCgkJCS8vIGVtcHR5IHRyYWNrcyBhcmUgZm9yYmlkZGVuLCBzbyBrZWVwIGF0IGxlYXN0IG9uZSBrZXlmcmFtZQoJCQlpZiAoIGZyb20gPj0gdG8gKSB7CgoJCQkJdG8gPSBNYXRoLm1heCggdG8sIDEgKTsKCQkJCWZyb20gPSB0byAtIDE7CgoJCQl9CgoJCQljb25zdCBzdHJpZGUgPSB0aGlzLmdldFZhbHVlU2l6ZSgpOwoJCQl0aGlzLnRpbWVzID0gdGltZXMuc2xpY2UoIGZyb20sIHRvICk7CgkJCXRoaXMudmFsdWVzID0gdGhpcy52YWx1ZXMuc2xpY2UoIGZyb20gKiBzdHJpZGUsIHRvICogc3RyaWRlICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCS8vIGVuc3VyZSB3ZSBkbyBub3QgZ2V0IGEgR2FyYmFnZUluR2FyYmFnZU91dCBzaXR1YXRpb24sIG1ha2Ugc3VyZSB0cmFja3MgYXJlIGF0IGxlYXN0IG1pbmltYWxseSB2aWFibGUKCXZhbGlkYXRlKCkgewoKCQlsZXQgdmFsaWQgPSB0cnVlOwoKCQljb25zdCB2YWx1ZVNpemUgPSB0aGlzLmdldFZhbHVlU2l6ZSgpOwoJCWlmICggdmFsdWVTaXplIC0gTWF0aC5mbG9vciggdmFsdWVTaXplICkgIT09IDAgKSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuS2V5ZnJhbWVUcmFjazogSW52YWxpZCB2YWx1ZSBzaXplIGluIHRyYWNrLicsIHRoaXMgKTsKCQkJdmFsaWQgPSBmYWxzZTsKCgkJfQoKCQljb25zdCB0aW1lcyA9IHRoaXMudGltZXMsCgkJCXZhbHVlcyA9IHRoaXMudmFsdWVzLAoKCQkJbktleXMgPSB0aW1lcy5sZW5ndGg7CgoJCWlmICggbktleXMgPT09IDAgKSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuS2V5ZnJhbWVUcmFjazogVHJhY2sgaXMgZW1wdHkuJywgdGhpcyApOwoJCQl2YWxpZCA9IGZhbHNlOwoKCQl9CgoJCWxldCBwcmV2VGltZSA9IG51bGw7CgoJCWZvciAoIGxldCBpID0gMDsgaSAhPT0gbktleXM7IGkgKysgKSB7CgoJCQljb25zdCBjdXJyVGltZSA9IHRpbWVzWyBpIF07CgoJCQlpZiAoIHR5cGVvZiBjdXJyVGltZSA9PT0gJ251bWJlcicgJiYgaXNOYU4oIGN1cnJUaW1lICkgKSB7CgoJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLktleWZyYW1lVHJhY2s6IFRpbWUgaXMgbm90IGEgdmFsaWQgbnVtYmVyLicsIHRoaXMsIGksIGN1cnJUaW1lICk7CgkJCQl2YWxpZCA9IGZhbHNlOwoJCQkJYnJlYWs7CgoJCQl9CgoJCQlpZiAoIHByZXZUaW1lICE9PSBudWxsICYmIHByZXZUaW1lID4gY3VyclRpbWUgKSB7CgoJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLktleWZyYW1lVHJhY2s6IE91dCBvZiBvcmRlciBrZXlzLicsIHRoaXMsIGksIGN1cnJUaW1lLCBwcmV2VGltZSApOwoJCQkJdmFsaWQgPSBmYWxzZTsKCQkJCWJyZWFrOwoKCQkJfQoKCQkJcHJldlRpbWUgPSBjdXJyVGltZTsKCgkJfQoKCQlpZiAoIHZhbHVlcyAhPT0gdW5kZWZpbmVkICkgewoKCQkJaWYgKCBpc1R5cGVkQXJyYXkoIHZhbHVlcyApICkgewoKCQkJCWZvciAoIGxldCBpID0gMCwgbiA9IHZhbHVlcy5sZW5ndGg7IGkgIT09IG47ICsrIGkgKSB7CgoJCQkJCWNvbnN0IHZhbHVlID0gdmFsdWVzWyBpIF07CgoJCQkJCWlmICggaXNOYU4oIHZhbHVlICkgKSB7CgoJCQkJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuS2V5ZnJhbWVUcmFjazogVmFsdWUgaXMgbm90IGEgdmFsaWQgbnVtYmVyLicsIHRoaXMsIGksIHZhbHVlICk7CgkJCQkJCXZhbGlkID0gZmFsc2U7CgkJCQkJCWJyZWFrOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQl9CgoJCXJldHVybiB2YWxpZDsKCgl9CgoJLy8gcmVtb3ZlcyBlcXVpdmFsZW50IHNlcXVlbnRpYWwga2V5cyBhcyBjb21tb24gaW4gbW9ycGggdGFyZ2V0IHNlcXVlbmNlcwoJLy8gKDAsMCwwLDAsMSwxLDEsMCwwLDAsMCwwLDAsMCkgLS0+ICgwLDAsMSwxLDAsMCkKCW9wdGltaXplKCkgewoKCQkvLyB0aW1lcyBvciB2YWx1ZXMgbWF5IGJlIHNoYXJlZCB3aXRoIG90aGVyIHRyYWNrcywgc28gb3ZlcndyaXRpbmcgaXMgdW5zYWZlCgkJY29uc3QgdGltZXMgPSB0aGlzLnRpbWVzLnNsaWNlKCksCgkJCXZhbHVlcyA9IHRoaXMudmFsdWVzLnNsaWNlKCksCgkJCXN0cmlkZSA9IHRoaXMuZ2V0VmFsdWVTaXplKCksCgoJCQlzbW9vdGhJbnRlcnBvbGF0aW9uID0gdGhpcy5nZXRJbnRlcnBvbGF0aW9uKCkgPT09IEludGVycG9sYXRlU21vb3RoLAoKCQkJbGFzdEluZGV4ID0gdGltZXMubGVuZ3RoIC0gMTsKCgkJbGV0IHdyaXRlSW5kZXggPSAxOwoKCQlmb3IgKCBsZXQgaSA9IDE7IGkgPCBsYXN0SW5kZXg7ICsrIGkgKSB7CgoJCQlsZXQga2VlcCA9IGZhbHNlOwoKCQkJY29uc3QgdGltZSA9IHRpbWVzWyBpIF07CgkJCWNvbnN0IHRpbWVOZXh0ID0gdGltZXNbIGkgKyAxIF07CgoJCQkvLyByZW1vdmUgYWRqYWNlbnQga2V5ZnJhbWVzIHNjaGVkdWxlZCBhdCB0aGUgc2FtZSB0aW1lCgoJCQlpZiAoIHRpbWUgIT09IHRpbWVOZXh0ICYmICggaSAhPT0gMSB8fCB0aW1lICE9PSB0aW1lc1sgMCBdICkgKSB7CgoJCQkJaWYgKCAhIHNtb290aEludGVycG9sYXRpb24gKSB7CgoJCQkJCS8vIHJlbW92ZSB1bm5lY2Vzc2FyeSBrZXlmcmFtZXMgc2FtZSBhcyB0aGVpciBuZWlnaGJvcnMKCgkJCQkJY29uc3Qgb2Zmc2V0ID0gaSAqIHN0cmlkZSwKCQkJCQkJb2Zmc2V0UCA9IG9mZnNldCAtIHN0cmlkZSwKCQkJCQkJb2Zmc2V0TiA9IG9mZnNldCArIHN0cmlkZTsKCgkJCQkJZm9yICggbGV0IGogPSAwOyBqICE9PSBzdHJpZGU7ICsrIGogKSB7CgoJCQkJCQljb25zdCB2YWx1ZSA9IHZhbHVlc1sgb2Zmc2V0ICsgaiBdOwoKCQkJCQkJaWYgKCB2YWx1ZSAhPT0gdmFsdWVzWyBvZmZzZXRQICsgaiBdIHx8CgkJCQkJCQl2YWx1ZSAhPT0gdmFsdWVzWyBvZmZzZXROICsgaiBdICkgewoKCQkJCQkJCWtlZXAgPSB0cnVlOwoJCQkJCQkJYnJlYWs7CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQl9IGVsc2UgewoKCQkJCQlrZWVwID0gdHJ1ZTsKCgkJCQl9CgoJCQl9CgoJCQkvLyBpbi1wbGFjZSBjb21wYWN0aW9uCgoJCQlpZiAoIGtlZXAgKSB7CgoJCQkJaWYgKCBpICE9PSB3cml0ZUluZGV4ICkgewoKCQkJCQl0aW1lc1sgd3JpdGVJbmRleCBdID0gdGltZXNbIGkgXTsKCgkJCQkJY29uc3QgcmVhZE9mZnNldCA9IGkgKiBzdHJpZGUsCgkJCQkJCXdyaXRlT2Zmc2V0ID0gd3JpdGVJbmRleCAqIHN0cmlkZTsKCgkJCQkJZm9yICggbGV0IGogPSAwOyBqICE9PSBzdHJpZGU7ICsrIGogKSB7CgoJCQkJCQl2YWx1ZXNbIHdyaXRlT2Zmc2V0ICsgaiBdID0gdmFsdWVzWyByZWFkT2Zmc2V0ICsgaiBdOwoKCQkJCQl9CgoJCQkJfQoKCQkJCSsrIHdyaXRlSW5kZXg7CgoJCQl9CgoJCX0KCgkJLy8gZmx1c2ggbGFzdCBrZXlmcmFtZSAoY29tcGFjdGlvbiBsb29rcyBhaGVhZCkKCgkJaWYgKCBsYXN0SW5kZXggPiAwICkgewoKCQkJdGltZXNbIHdyaXRlSW5kZXggXSA9IHRpbWVzWyBsYXN0SW5kZXggXTsKCgkJCWZvciAoIGxldCByZWFkT2Zmc2V0ID0gbGFzdEluZGV4ICogc3RyaWRlLCB3cml0ZU9mZnNldCA9IHdyaXRlSW5kZXggKiBzdHJpZGUsIGogPSAwOyBqICE9PSBzdHJpZGU7ICsrIGogKSB7CgoJCQkJdmFsdWVzWyB3cml0ZU9mZnNldCArIGogXSA9IHZhbHVlc1sgcmVhZE9mZnNldCArIGogXTsKCgkJCX0KCgkJCSsrIHdyaXRlSW5kZXg7CgoJCX0KCgkJaWYgKCB3cml0ZUluZGV4ICE9PSB0aW1lcy5sZW5ndGggKSB7CgoJCQl0aGlzLnRpbWVzID0gdGltZXMuc2xpY2UoIDAsIHdyaXRlSW5kZXggKTsKCQkJdGhpcy52YWx1ZXMgPSB2YWx1ZXMuc2xpY2UoIDAsIHdyaXRlSW5kZXggKiBzdHJpZGUgKTsKCgkJfSBlbHNlIHsKCgkJCXRoaXMudGltZXMgPSB0aW1lczsKCQkJdGhpcy52YWx1ZXMgPSB2YWx1ZXM7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsb25lKCkgewoKCQljb25zdCB0aW1lcyA9IHRoaXMudGltZXMuc2xpY2UoKTsKCQljb25zdCB2YWx1ZXMgPSB0aGlzLnZhbHVlcy5zbGljZSgpOwoKCQljb25zdCBUeXBlZEtleWZyYW1lVHJhY2sgPSB0aGlzLmNvbnN0cnVjdG9yOwoJCWNvbnN0IHRyYWNrID0gbmV3IFR5cGVkS2V5ZnJhbWVUcmFjayggdGhpcy5uYW1lLCB0aW1lcywgdmFsdWVzICk7CgoJCS8vIEludGVycG9sYW50IGFyZ3VtZW50IHRvIGNvbnN0cnVjdG9yIGlzIG5vdCBzYXZlZCwgc28gY29weSB0aGUgZmFjdG9yeSBtZXRob2QgZGlyZWN0bHkuCgkJdHJhY2suY3JlYXRlSW50ZXJwb2xhbnQgPSB0aGlzLmNyZWF0ZUludGVycG9sYW50OwoKCQlyZXR1cm4gdHJhY2s7CgoJfQoKfQoKS2V5ZnJhbWVUcmFjay5wcm90b3R5cGUuVGltZUJ1ZmZlclR5cGUgPSBGbG9hdDMyQXJyYXk7CktleWZyYW1lVHJhY2sucHJvdG90eXBlLlZhbHVlQnVmZmVyVHlwZSA9IEZsb2F0MzJBcnJheTsKS2V5ZnJhbWVUcmFjay5wcm90b3R5cGUuRGVmYXVsdEludGVycG9sYXRpb24gPSBJbnRlcnBvbGF0ZUxpbmVhcjsKCi8qKgogKiBBIFRyYWNrIG9mIEJvb2xlYW4ga2V5ZnJhbWUgdmFsdWVzLgogKi8KY2xhc3MgQm9vbGVhbktleWZyYW1lVHJhY2sgZXh0ZW5kcyBLZXlmcmFtZVRyYWNrIHt9CgpCb29sZWFuS2V5ZnJhbWVUcmFjay5wcm90b3R5cGUuVmFsdWVUeXBlTmFtZSA9ICdib29sJzsKQm9vbGVhbktleWZyYW1lVHJhY2sucHJvdG90eXBlLlZhbHVlQnVmZmVyVHlwZSA9IEFycmF5OwpCb29sZWFuS2V5ZnJhbWVUcmFjay5wcm90b3R5cGUuRGVmYXVsdEludGVycG9sYXRpb24gPSBJbnRlcnBvbGF0ZURpc2NyZXRlOwpCb29sZWFuS2V5ZnJhbWVUcmFjay5wcm90b3R5cGUuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kTGluZWFyID0gdW5kZWZpbmVkOwpCb29sZWFuS2V5ZnJhbWVUcmFjay5wcm90b3R5cGUuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kU21vb3RoID0gdW5kZWZpbmVkOwoKLyoqCiAqIEEgVHJhY2sgb2Yga2V5ZnJhbWUgdmFsdWVzIHRoYXQgcmVwcmVzZW50IGNvbG9yLgogKi8KY2xhc3MgQ29sb3JLZXlmcmFtZVRyYWNrIGV4dGVuZHMgS2V5ZnJhbWVUcmFjayB7fQoKQ29sb3JLZXlmcmFtZVRyYWNrLnByb3RvdHlwZS5WYWx1ZVR5cGVOYW1lID0gJ2NvbG9yJzsKCi8qKgogKiBBIFRyYWNrIG9mIG51bWVyaWMga2V5ZnJhbWUgdmFsdWVzLgogKi8KY2xhc3MgTnVtYmVyS2V5ZnJhbWVUcmFjayBleHRlbmRzIEtleWZyYW1lVHJhY2sge30KCk51bWJlcktleWZyYW1lVHJhY2sucHJvdG90eXBlLlZhbHVlVHlwZU5hbWUgPSAnbnVtYmVyJzsKCi8qKgogKiBTcGhlcmljYWwgbGluZWFyIHVuaXQgcXVhdGVybmlvbiBpbnRlcnBvbGFudC4KICovCgpjbGFzcyBRdWF0ZXJuaW9uTGluZWFySW50ZXJwb2xhbnQgZXh0ZW5kcyBJbnRlcnBvbGFudCB7CgoJY29uc3RydWN0b3IoIHBhcmFtZXRlclBvc2l0aW9ucywgc2FtcGxlVmFsdWVzLCBzYW1wbGVTaXplLCByZXN1bHRCdWZmZXIgKSB7CgoJCXN1cGVyKCBwYXJhbWV0ZXJQb3NpdGlvbnMsIHNhbXBsZVZhbHVlcywgc2FtcGxlU2l6ZSwgcmVzdWx0QnVmZmVyICk7CgoJfQoKCWludGVycG9sYXRlXyggaTEsIHQwLCB0LCB0MSApIHsKCgkJY29uc3QgcmVzdWx0ID0gdGhpcy5yZXN1bHRCdWZmZXIsCgkJCXZhbHVlcyA9IHRoaXMuc2FtcGxlVmFsdWVzLAoJCQlzdHJpZGUgPSB0aGlzLnZhbHVlU2l6ZSwKCgkJCWFscGhhID0gKCB0IC0gdDAgKSAvICggdDEgLSB0MCApOwoKCQlsZXQgb2Zmc2V0ID0gaTEgKiBzdHJpZGU7CgoJCWZvciAoIGxldCBlbmQgPSBvZmZzZXQgKyBzdHJpZGU7IG9mZnNldCAhPT0gZW5kOyBvZmZzZXQgKz0gNCApIHsKCgkJCVF1YXRlcm5pb24uc2xlcnBGbGF0KCByZXN1bHQsIDAsIHZhbHVlcywgb2Zmc2V0IC0gc3RyaWRlLCB2YWx1ZXMsIG9mZnNldCwgYWxwaGEgKTsKCgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoKCX0KCn0KCi8qKgogKiBBIFRyYWNrIG9mIHF1YXRlcm5pb24ga2V5ZnJhbWUgdmFsdWVzLgogKi8KY2xhc3MgUXVhdGVybmlvbktleWZyYW1lVHJhY2sgZXh0ZW5kcyBLZXlmcmFtZVRyYWNrIHsKCglJbnRlcnBvbGFudEZhY3RvcnlNZXRob2RMaW5lYXIoIHJlc3VsdCApIHsKCgkJcmV0dXJuIG5ldyBRdWF0ZXJuaW9uTGluZWFySW50ZXJwb2xhbnQoIHRoaXMudGltZXMsIHRoaXMudmFsdWVzLCB0aGlzLmdldFZhbHVlU2l6ZSgpLCByZXN1bHQgKTsKCgl9Cgp9CgpRdWF0ZXJuaW9uS2V5ZnJhbWVUcmFjay5wcm90b3R5cGUuVmFsdWVUeXBlTmFtZSA9ICdxdWF0ZXJuaW9uJzsKLy8gVmFsdWVCdWZmZXJUeXBlIGlzIGluaGVyaXRlZApRdWF0ZXJuaW9uS2V5ZnJhbWVUcmFjay5wcm90b3R5cGUuRGVmYXVsdEludGVycG9sYXRpb24gPSBJbnRlcnBvbGF0ZUxpbmVhcjsKUXVhdGVybmlvbktleWZyYW1lVHJhY2sucHJvdG90eXBlLkludGVycG9sYW50RmFjdG9yeU1ldGhvZFNtb290aCA9IHVuZGVmaW5lZDsKCi8qKgogKiBBIFRyYWNrIHRoYXQgaW50ZXJwb2xhdGVzIFN0cmluZ3MKICovCmNsYXNzIFN0cmluZ0tleWZyYW1lVHJhY2sgZXh0ZW5kcyBLZXlmcmFtZVRyYWNrIHt9CgpTdHJpbmdLZXlmcmFtZVRyYWNrLnByb3RvdHlwZS5WYWx1ZVR5cGVOYW1lID0gJ3N0cmluZyc7ClN0cmluZ0tleWZyYW1lVHJhY2sucHJvdG90eXBlLlZhbHVlQnVmZmVyVHlwZSA9IEFycmF5OwpTdHJpbmdLZXlmcmFtZVRyYWNrLnByb3RvdHlwZS5EZWZhdWx0SW50ZXJwb2xhdGlvbiA9IEludGVycG9sYXRlRGlzY3JldGU7ClN0cmluZ0tleWZyYW1lVHJhY2sucHJvdG90eXBlLkludGVycG9sYW50RmFjdG9yeU1ldGhvZExpbmVhciA9IHVuZGVmaW5lZDsKU3RyaW5nS2V5ZnJhbWVUcmFjay5wcm90b3R5cGUuSW50ZXJwb2xhbnRGYWN0b3J5TWV0aG9kU21vb3RoID0gdW5kZWZpbmVkOwoKLyoqCiAqIEEgVHJhY2sgb2YgdmVjdG9yZWQga2V5ZnJhbWUgdmFsdWVzLgogKi8KY2xhc3MgVmVjdG9yS2V5ZnJhbWVUcmFjayBleHRlbmRzIEtleWZyYW1lVHJhY2sge30KClZlY3RvcktleWZyYW1lVHJhY2sucHJvdG90eXBlLlZhbHVlVHlwZU5hbWUgPSAndmVjdG9yJzsKCmNsYXNzIEFuaW1hdGlvbkNsaXAgewoKCWNvbnN0cnVjdG9yKCBuYW1lLCBkdXJhdGlvbiA9IC0gMSwgdHJhY2tzLCBibGVuZE1vZGUgPSBOb3JtYWxBbmltYXRpb25CbGVuZE1vZGUgKSB7CgoJCXRoaXMubmFtZSA9IG5hbWU7CgkJdGhpcy50cmFja3MgPSB0cmFja3M7CgkJdGhpcy5kdXJhdGlvbiA9IGR1cmF0aW9uOwoJCXRoaXMuYmxlbmRNb2RlID0gYmxlbmRNb2RlOwoKCQl0aGlzLnV1aWQgPSBnZW5lcmF0ZVVVSUQoKTsKCgkJLy8gdGhpcyBtZWFucyBpdCBzaG91bGQgZmlndXJlIG91dCBpdHMgZHVyYXRpb24gYnkgc2Nhbm5pbmcgdGhlIHRyYWNrcwoJCWlmICggdGhpcy5kdXJhdGlvbiA8IDAgKSB7CgoJCQl0aGlzLnJlc2V0RHVyYXRpb24oKTsKCgkJfQoKCX0KCgoJc3RhdGljIHBhcnNlKCBqc29uICkgewoKCQljb25zdCB0cmFja3MgPSBbXSwKCQkJanNvblRyYWNrcyA9IGpzb24udHJhY2tzLAoJCQlmcmFtZVRpbWUgPSAxLjAgLyAoIGpzb24uZnBzIHx8IDEuMCApOwoKCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSBqc29uVHJhY2tzLmxlbmd0aDsgaSAhPT0gbjsgKysgaSApIHsKCgkJCXRyYWNrcy5wdXNoKCBwYXJzZUtleWZyYW1lVHJhY2soIGpzb25UcmFja3NbIGkgXSApLnNjYWxlKCBmcmFtZVRpbWUgKSApOwoKCQl9CgoJCWNvbnN0IGNsaXAgPSBuZXcgdGhpcygganNvbi5uYW1lLCBqc29uLmR1cmF0aW9uLCB0cmFja3MsIGpzb24uYmxlbmRNb2RlICk7CgkJY2xpcC51dWlkID0ganNvbi51dWlkOwoKCQlyZXR1cm4gY2xpcDsKCgl9CgoJc3RhdGljIHRvSlNPTiggY2xpcCApIHsKCgkJY29uc3QgdHJhY2tzID0gW10sCgkJCWNsaXBUcmFja3MgPSBjbGlwLnRyYWNrczsKCgkJY29uc3QganNvbiA9IHsKCgkJCSduYW1lJzogY2xpcC5uYW1lLAoJCQknZHVyYXRpb24nOiBjbGlwLmR1cmF0aW9uLAoJCQkndHJhY2tzJzogdHJhY2tzLAoJCQkndXVpZCc6IGNsaXAudXVpZCwKCQkJJ2JsZW5kTW9kZSc6IGNsaXAuYmxlbmRNb2RlCgoJCX07CgoJCWZvciAoIGxldCBpID0gMCwgbiA9IGNsaXBUcmFja3MubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJdHJhY2tzLnB1c2goIEtleWZyYW1lVHJhY2sudG9KU09OKCBjbGlwVHJhY2tzWyBpIF0gKSApOwoKCQl9CgoJCXJldHVybiBqc29uOwoKCX0KCglzdGF0aWMgQ3JlYXRlRnJvbU1vcnBoVGFyZ2V0U2VxdWVuY2UoIG5hbWUsIG1vcnBoVGFyZ2V0U2VxdWVuY2UsIGZwcywgbm9Mb29wICkgewoKCQljb25zdCBudW1Nb3JwaFRhcmdldHMgPSBtb3JwaFRhcmdldFNlcXVlbmNlLmxlbmd0aDsKCQljb25zdCB0cmFja3MgPSBbXTsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgbnVtTW9ycGhUYXJnZXRzOyBpICsrICkgewoKCQkJbGV0IHRpbWVzID0gW107CgkJCWxldCB2YWx1ZXMgPSBbXTsKCgkJCXRpbWVzLnB1c2goCgkJCQkoIGkgKyBudW1Nb3JwaFRhcmdldHMgLSAxICkgJSBudW1Nb3JwaFRhcmdldHMsCgkJCQlpLAoJCQkJKCBpICsgMSApICUgbnVtTW9ycGhUYXJnZXRzICk7CgoJCQl2YWx1ZXMucHVzaCggMCwgMSwgMCApOwoKCQkJY29uc3Qgb3JkZXIgPSBnZXRLZXlmcmFtZU9yZGVyKCB0aW1lcyApOwoJCQl0aW1lcyA9IHNvcnRlZEFycmF5KCB0aW1lcywgMSwgb3JkZXIgKTsKCQkJdmFsdWVzID0gc29ydGVkQXJyYXkoIHZhbHVlcywgMSwgb3JkZXIgKTsKCgkJCS8vIGlmIHRoZXJlIGlzIGEga2V5IGF0IHRoZSBmaXJzdCBmcmFtZSwgZHVwbGljYXRlIGl0IGFzIHRoZQoJCQkvLyBsYXN0IGZyYW1lIGFzIHdlbGwgZm9yIHBlcmZlY3QgbG9vcC4KCQkJaWYgKCAhIG5vTG9vcCAmJiB0aW1lc1sgMCBdID09PSAwICkgewoKCQkJCXRpbWVzLnB1c2goIG51bU1vcnBoVGFyZ2V0cyApOwoJCQkJdmFsdWVzLnB1c2goIHZhbHVlc1sgMCBdICk7CgoJCQl9CgoJCQl0cmFja3MucHVzaCgKCQkJCW5ldyBOdW1iZXJLZXlmcmFtZVRyYWNrKAoJCQkJCScubW9ycGhUYXJnZXRJbmZsdWVuY2VzWycgKyBtb3JwaFRhcmdldFNlcXVlbmNlWyBpIF0ubmFtZSArICddJywKCQkJCQl0aW1lcywgdmFsdWVzCgkJCQkpLnNjYWxlKCAxLjAgLyBmcHMgKSApOwoKCQl9CgoJCXJldHVybiBuZXcgdGhpcyggbmFtZSwgLSAxLCB0cmFja3MgKTsKCgl9CgoJc3RhdGljIGZpbmRCeU5hbWUoIG9iamVjdE9yQ2xpcEFycmF5LCBuYW1lICkgewoKCQlsZXQgY2xpcEFycmF5ID0gb2JqZWN0T3JDbGlwQXJyYXk7CgoJCWlmICggISBBcnJheS5pc0FycmF5KCBvYmplY3RPckNsaXBBcnJheSApICkgewoKCQkJY29uc3QgbyA9IG9iamVjdE9yQ2xpcEFycmF5OwoJCQljbGlwQXJyYXkgPSBvLmdlb21ldHJ5ICYmIG8uZ2VvbWV0cnkuYW5pbWF0aW9ucyB8fCBvLmFuaW1hdGlvbnM7CgoJCX0KCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgY2xpcEFycmF5Lmxlbmd0aDsgaSArKyApIHsKCgkJCWlmICggY2xpcEFycmF5WyBpIF0ubmFtZSA9PT0gbmFtZSApIHsKCgkJCQlyZXR1cm4gY2xpcEFycmF5WyBpIF07CgoJCQl9CgoJCX0KCgkJcmV0dXJuIG51bGw7CgoJfQoKCXN0YXRpYyBDcmVhdGVDbGlwc0Zyb21Nb3JwaFRhcmdldFNlcXVlbmNlcyggbW9ycGhUYXJnZXRzLCBmcHMsIG5vTG9vcCApIHsKCgkJY29uc3QgYW5pbWF0aW9uVG9Nb3JwaFRhcmdldHMgPSB7fTsKCgkJLy8gdGVzdGVkIHdpdGggaHR0cHM6Ly9yZWdleDEwMS5jb20vIG9uIHRyaWNrIHNlcXVlbmNlcwoJCS8vIHN1Y2ggZmxhbWluZ29fZmx5QV8wMDMsIGZsYW1pbmdvX3J1bjFfMDAzLCBjcmRlYXRoMDA1OQoJCWNvbnN0IHBhdHRlcm4gPSAvXihbXHctXSo/KShbXGRdKykkLzsKCgkJLy8gc29ydCBtb3JwaCB0YXJnZXQgbmFtZXMgaW50byBhbmltYXRpb24gZ3JvdXBzIGJhc2VkCgkJLy8gcGF0dGVybnMgbGlrZSBXYWxrXzAwMSwgV2Fsa18wMDIsIFJ1bl8wMDEsIFJ1bl8wMDIKCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gbW9ycGhUYXJnZXRzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJY29uc3QgbW9ycGhUYXJnZXQgPSBtb3JwaFRhcmdldHNbIGkgXTsKCQkJY29uc3QgcGFydHMgPSBtb3JwaFRhcmdldC5uYW1lLm1hdGNoKCBwYXR0ZXJuICk7CgoJCQlpZiAoIHBhcnRzICYmIHBhcnRzLmxlbmd0aCA+IDEgKSB7CgoJCQkJY29uc3QgbmFtZSA9IHBhcnRzWyAxIF07CgoJCQkJbGV0IGFuaW1hdGlvbk1vcnBoVGFyZ2V0cyA9IGFuaW1hdGlvblRvTW9ycGhUYXJnZXRzWyBuYW1lIF07CgoJCQkJaWYgKCAhIGFuaW1hdGlvbk1vcnBoVGFyZ2V0cyApIHsKCgkJCQkJYW5pbWF0aW9uVG9Nb3JwaFRhcmdldHNbIG5hbWUgXSA9IGFuaW1hdGlvbk1vcnBoVGFyZ2V0cyA9IFtdOwoKCQkJCX0KCgkJCQlhbmltYXRpb25Nb3JwaFRhcmdldHMucHVzaCggbW9ycGhUYXJnZXQgKTsKCgkJCX0KCgkJfQoKCQljb25zdCBjbGlwcyA9IFtdOwoKCQlmb3IgKCBjb25zdCBuYW1lIGluIGFuaW1hdGlvblRvTW9ycGhUYXJnZXRzICkgewoKCQkJY2xpcHMucHVzaCggdGhpcy5DcmVhdGVGcm9tTW9ycGhUYXJnZXRTZXF1ZW5jZSggbmFtZSwgYW5pbWF0aW9uVG9Nb3JwaFRhcmdldHNbIG5hbWUgXSwgZnBzLCBub0xvb3AgKSApOwoKCQl9CgoJCXJldHVybiBjbGlwczsKCgl9CgoJLy8gcGFyc2UgdGhlIGFuaW1hdGlvbi5oaWVyYXJjaHkgZm9ybWF0CglzdGF0aWMgcGFyc2VBbmltYXRpb24oIGFuaW1hdGlvbiwgYm9uZXMgKSB7CgoJCWlmICggISBhbmltYXRpb24gKSB7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuQW5pbWF0aW9uQ2xpcDogTm8gYW5pbWF0aW9uIGluIEpTT05Mb2FkZXIgZGF0YS4nICk7CgkJCXJldHVybiBudWxsOwoKCQl9CgoJCWNvbnN0IGFkZE5vbmVtcHR5VHJhY2sgPSBmdW5jdGlvbiAoIHRyYWNrVHlwZSwgdHJhY2tOYW1lLCBhbmltYXRpb25LZXlzLCBwcm9wZXJ0eU5hbWUsIGRlc3RUcmFja3MgKSB7CgoJCQkvLyBvbmx5IHJldHVybiB0cmFjayBpZiB0aGVyZSBhcmUgYWN0dWFsbHkga2V5cy4KCQkJaWYgKCBhbmltYXRpb25LZXlzLmxlbmd0aCAhPT0gMCApIHsKCgkJCQljb25zdCB0aW1lcyA9IFtdOwoJCQkJY29uc3QgdmFsdWVzID0gW107CgoJCQkJZmxhdHRlbkpTT04oIGFuaW1hdGlvbktleXMsIHRpbWVzLCB2YWx1ZXMsIHByb3BlcnR5TmFtZSApOwoKCQkJCS8vIGVtcHR5IGtleXMgYXJlIGZpbHRlcmVkIG91dCwgc28gY2hlY2sgYWdhaW4KCQkJCWlmICggdGltZXMubGVuZ3RoICE9PSAwICkgewoKCQkJCQlkZXN0VHJhY2tzLnB1c2goIG5ldyB0cmFja1R5cGUoIHRyYWNrTmFtZSwgdGltZXMsIHZhbHVlcyApICk7CgoJCQkJfQoKCQkJfQoKCQl9OwoKCQljb25zdCB0cmFja3MgPSBbXTsKCgkJY29uc3QgY2xpcE5hbWUgPSBhbmltYXRpb24ubmFtZSB8fCAnZGVmYXVsdCc7CgkJY29uc3QgZnBzID0gYW5pbWF0aW9uLmZwcyB8fCAzMDsKCQljb25zdCBibGVuZE1vZGUgPSBhbmltYXRpb24uYmxlbmRNb2RlOwoKCQkvLyBhdXRvbWF0aWMgbGVuZ3RoIGRldGVybWluYXRpb24gaW4gQW5pbWF0aW9uQ2xpcC4KCQlsZXQgZHVyYXRpb24gPSBhbmltYXRpb24ubGVuZ3RoIHx8IC0gMTsKCgkJY29uc3QgaGllcmFyY2h5VHJhY2tzID0gYW5pbWF0aW9uLmhpZXJhcmNoeSB8fCBbXTsKCgkJZm9yICggbGV0IGggPSAwOyBoIDwgaGllcmFyY2h5VHJhY2tzLmxlbmd0aDsgaCArKyApIHsKCgkJCWNvbnN0IGFuaW1hdGlvbktleXMgPSBoaWVyYXJjaHlUcmFja3NbIGggXS5rZXlzOwoKCQkJLy8gc2tpcCBlbXB0eSB0cmFja3MKCQkJaWYgKCAhIGFuaW1hdGlvbktleXMgfHwgYW5pbWF0aW9uS2V5cy5sZW5ndGggPT09IDAgKSBjb250aW51ZTsKCgkJCS8vIHByb2Nlc3MgbW9ycGggdGFyZ2V0cwoJCQlpZiAoIGFuaW1hdGlvbktleXNbIDAgXS5tb3JwaFRhcmdldHMgKSB7CgoJCQkJLy8gZmlndXJlIG91dCBhbGwgbW9ycGggdGFyZ2V0cyB1c2VkIGluIHRoaXMgdHJhY2sKCQkJCWNvbnN0IG1vcnBoVGFyZ2V0TmFtZXMgPSB7fTsKCgkJCQlsZXQgazsKCgkJCQlmb3IgKCBrID0gMDsgayA8IGFuaW1hdGlvbktleXMubGVuZ3RoOyBrICsrICkgewoKCQkJCQlpZiAoIGFuaW1hdGlvbktleXNbIGsgXS5tb3JwaFRhcmdldHMgKSB7CgoJCQkJCQlmb3IgKCBsZXQgbSA9IDA7IG0gPCBhbmltYXRpb25LZXlzWyBrIF0ubW9ycGhUYXJnZXRzLmxlbmd0aDsgbSArKyApIHsKCgkJCQkJCQltb3JwaFRhcmdldE5hbWVzWyBhbmltYXRpb25LZXlzWyBrIF0ubW9ycGhUYXJnZXRzWyBtIF0gXSA9IC0gMTsKCgkJCQkJCX0KCgkJCQkJfQoKCQkJCX0KCgkJCQkvLyBjcmVhdGUgYSB0cmFjayBmb3IgZWFjaCBtb3JwaCB0YXJnZXQgd2l0aCBhbGwgemVybwoJCQkJLy8gbW9ycGhUYXJnZXRJbmZsdWVuY2VzIGV4Y2VwdCBmb3IgdGhlIGtleXMgaW4gd2hpY2gKCQkJCS8vIHRoZSBtb3JwaFRhcmdldCBpcyBuYW1lZC4KCQkJCWZvciAoIGNvbnN0IG1vcnBoVGFyZ2V0TmFtZSBpbiBtb3JwaFRhcmdldE5hbWVzICkgewoKCQkJCQljb25zdCB0aW1lcyA9IFtdOwoJCQkJCWNvbnN0IHZhbHVlcyA9IFtdOwoKCQkJCQlmb3IgKCBsZXQgbSA9IDA7IG0gIT09IGFuaW1hdGlvbktleXNbIGsgXS5tb3JwaFRhcmdldHMubGVuZ3RoOyArKyBtICkgewoKCQkJCQkJY29uc3QgYW5pbWF0aW9uS2V5ID0gYW5pbWF0aW9uS2V5c1sgayBdOwoKCQkJCQkJdGltZXMucHVzaCggYW5pbWF0aW9uS2V5LnRpbWUgKTsKCQkJCQkJdmFsdWVzLnB1c2goICggYW5pbWF0aW9uS2V5Lm1vcnBoVGFyZ2V0ID09PSBtb3JwaFRhcmdldE5hbWUgKSA/IDEgOiAwICk7CgoJCQkJCX0KCgkJCQkJdHJhY2tzLnB1c2goIG5ldyBOdW1iZXJLZXlmcmFtZVRyYWNrKCAnLm1vcnBoVGFyZ2V0SW5mbHVlbmNlWycgKyBtb3JwaFRhcmdldE5hbWUgKyAnXScsIHRpbWVzLCB2YWx1ZXMgKSApOwoKCQkJCX0KCgkJCQlkdXJhdGlvbiA9IG1vcnBoVGFyZ2V0TmFtZXMubGVuZ3RoICogZnBzOwoKCQkJfSBlbHNlIHsKCgkJCQkvLyAuLi5hc3N1bWUgc2tlbGV0YWwgYW5pbWF0aW9uCgoJCQkJY29uc3QgYm9uZU5hbWUgPSAnLmJvbmVzWycgKyBib25lc1sgaCBdLm5hbWUgKyAnXSc7CgoJCQkJYWRkTm9uZW1wdHlUcmFjaygKCQkJCQlWZWN0b3JLZXlmcmFtZVRyYWNrLCBib25lTmFtZSArICcucG9zaXRpb24nLAoJCQkJCWFuaW1hdGlvbktleXMsICdwb3MnLCB0cmFja3MgKTsKCgkJCQlhZGROb25lbXB0eVRyYWNrKAoJCQkJCVF1YXRlcm5pb25LZXlmcmFtZVRyYWNrLCBib25lTmFtZSArICcucXVhdGVybmlvbicsCgkJCQkJYW5pbWF0aW9uS2V5cywgJ3JvdCcsIHRyYWNrcyApOwoKCQkJCWFkZE5vbmVtcHR5VHJhY2soCgkJCQkJVmVjdG9yS2V5ZnJhbWVUcmFjaywgYm9uZU5hbWUgKyAnLnNjYWxlJywKCQkJCQlhbmltYXRpb25LZXlzLCAnc2NsJywgdHJhY2tzICk7CgoJCQl9CgoJCX0KCgkJaWYgKCB0cmFja3MubGVuZ3RoID09PSAwICkgewoKCQkJcmV0dXJuIG51bGw7CgoJCX0KCgkJY29uc3QgY2xpcCA9IG5ldyB0aGlzKCBjbGlwTmFtZSwgZHVyYXRpb24sIHRyYWNrcywgYmxlbmRNb2RlICk7CgoJCXJldHVybiBjbGlwOwoKCX0KCglyZXNldER1cmF0aW9uKCkgewoKCQljb25zdCB0cmFja3MgPSB0aGlzLnRyYWNrczsKCQlsZXQgZHVyYXRpb24gPSAwOwoKCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSB0cmFja3MubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJY29uc3QgdHJhY2sgPSB0aGlzLnRyYWNrc1sgaSBdOwoKCQkJZHVyYXRpb24gPSBNYXRoLm1heCggZHVyYXRpb24sIHRyYWNrLnRpbWVzWyB0cmFjay50aW1lcy5sZW5ndGggLSAxIF0gKTsKCgkJfQoKCQl0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0cmltKCkgewoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnRyYWNrcy5sZW5ndGg7IGkgKysgKSB7CgoJCQl0aGlzLnRyYWNrc1sgaSBdLnRyaW0oIDAsIHRoaXMuZHVyYXRpb24gKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdmFsaWRhdGUoKSB7CgoJCWxldCB2YWxpZCA9IHRydWU7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMudHJhY2tzLmxlbmd0aDsgaSArKyApIHsKCgkJCXZhbGlkID0gdmFsaWQgJiYgdGhpcy50cmFja3NbIGkgXS52YWxpZGF0ZSgpOwoKCQl9CgoJCXJldHVybiB2YWxpZDsKCgl9CgoJb3B0aW1pemUoKSB7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMudHJhY2tzLmxlbmd0aDsgaSArKyApIHsKCgkJCXRoaXMudHJhY2tzWyBpIF0ub3B0aW1pemUoKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xvbmUoKSB7CgoJCWNvbnN0IHRyYWNrcyA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnRyYWNrcy5sZW5ndGg7IGkgKysgKSB7CgoJCQl0cmFja3MucHVzaCggdGhpcy50cmFja3NbIGkgXS5jbG9uZSgpICk7CgoJCX0KCgkJcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCB0aGlzLm5hbWUsIHRoaXMuZHVyYXRpb24sIHRyYWNrcywgdGhpcy5ibGVuZE1vZGUgKTsKCgl9CgoJdG9KU09OKCkgewoKCQlyZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b0pTT04oIHRoaXMgKTsKCgl9Cgp9CgpmdW5jdGlvbiBnZXRUcmFja1R5cGVGb3JWYWx1ZVR5cGVOYW1lKCB0eXBlTmFtZSApIHsKCglzd2l0Y2ggKCB0eXBlTmFtZS50b0xvd2VyQ2FzZSgpICkgewoKCQljYXNlICdzY2FsYXInOgoJCWNhc2UgJ2RvdWJsZSc6CgkJY2FzZSAnZmxvYXQnOgoJCWNhc2UgJ251bWJlcic6CgkJY2FzZSAnaW50ZWdlcic6CgoJCQlyZXR1cm4gTnVtYmVyS2V5ZnJhbWVUcmFjazsKCgkJY2FzZSAndmVjdG9yJzoKCQljYXNlICd2ZWN0b3IyJzoKCQljYXNlICd2ZWN0b3IzJzoKCQljYXNlICd2ZWN0b3I0JzoKCgkJCXJldHVybiBWZWN0b3JLZXlmcmFtZVRyYWNrOwoKCQljYXNlICdjb2xvcic6CgoJCQlyZXR1cm4gQ29sb3JLZXlmcmFtZVRyYWNrOwoKCQljYXNlICdxdWF0ZXJuaW9uJzoKCgkJCXJldHVybiBRdWF0ZXJuaW9uS2V5ZnJhbWVUcmFjazsKCgkJY2FzZSAnYm9vbCc6CgkJY2FzZSAnYm9vbGVhbic6CgoJCQlyZXR1cm4gQm9vbGVhbktleWZyYW1lVHJhY2s7CgoJCWNhc2UgJ3N0cmluZyc6CgoJCQlyZXR1cm4gU3RyaW5nS2V5ZnJhbWVUcmFjazsKCgl9CgoJdGhyb3cgbmV3IEVycm9yKCAnVEhSRUUuS2V5ZnJhbWVUcmFjazogVW5zdXBwb3J0ZWQgdHlwZU5hbWU6ICcgKyB0eXBlTmFtZSApOwoKfQoKZnVuY3Rpb24gcGFyc2VLZXlmcmFtZVRyYWNrKCBqc29uICkgewoKCWlmICgganNvbi50eXBlID09PSB1bmRlZmluZWQgKSB7CgoJCXRocm93IG5ldyBFcnJvciggJ1RIUkVFLktleWZyYW1lVHJhY2s6IHRyYWNrIHR5cGUgdW5kZWZpbmVkLCBjYW4gbm90IHBhcnNlJyApOwoKCX0KCgljb25zdCB0cmFja1R5cGUgPSBnZXRUcmFja1R5cGVGb3JWYWx1ZVR5cGVOYW1lKCBqc29uLnR5cGUgKTsKCglpZiAoIGpzb24udGltZXMgPT09IHVuZGVmaW5lZCApIHsKCgkJY29uc3QgdGltZXMgPSBbXSwgdmFsdWVzID0gW107CgoJCWZsYXR0ZW5KU09OKCBqc29uLmtleXMsIHRpbWVzLCB2YWx1ZXMsICd2YWx1ZScgKTsKCgkJanNvbi50aW1lcyA9IHRpbWVzOwoJCWpzb24udmFsdWVzID0gdmFsdWVzOwoKCX0KCgkvLyBkZXJpdmVkIGNsYXNzZXMgY2FuIGRlZmluZSBhIHN0YXRpYyBwYXJzZSBtZXRob2QKCWlmICggdHJhY2tUeXBlLnBhcnNlICE9PSB1bmRlZmluZWQgKSB7CgoJCXJldHVybiB0cmFja1R5cGUucGFyc2UoIGpzb24gKTsKCgl9IGVsc2UgewoKCQkvLyBieSBkZWZhdWx0LCB3ZSBhc3N1bWUgYSBjb25zdHJ1Y3RvciBjb21wYXRpYmxlIHdpdGggdGhlIGJhc2UKCQlyZXR1cm4gbmV3IHRyYWNrVHlwZSgganNvbi5uYW1lLCBqc29uLnRpbWVzLCBqc29uLnZhbHVlcywganNvbi5pbnRlcnBvbGF0aW9uICk7CgoJfQoKfQoKY29uc3QgQ2FjaGUgPSB7CgoJZW5hYmxlZDogZmFsc2UsCgoJZmlsZXM6IHt9LAoKCWFkZDogZnVuY3Rpb24gKCBrZXksIGZpbGUgKSB7CgoJCWlmICggdGhpcy5lbmFibGVkID09PSBmYWxzZSApIHJldHVybjsKCgkJLy8gY29uc29sZS5sb2coICdUSFJFRS5DYWNoZScsICdBZGRpbmcga2V5OicsIGtleSApOwoKCQl0aGlzLmZpbGVzWyBrZXkgXSA9IGZpbGU7CgoJfSwKCglnZXQ6IGZ1bmN0aW9uICgga2V5ICkgewoKCQlpZiAoIHRoaXMuZW5hYmxlZCA9PT0gZmFsc2UgKSByZXR1cm47CgoJCS8vIGNvbnNvbGUubG9nKCAnVEhSRUUuQ2FjaGUnLCAnQ2hlY2tpbmcga2V5OicsIGtleSApOwoKCQlyZXR1cm4gdGhpcy5maWxlc1sga2V5IF07CgoJfSwKCglyZW1vdmU6IGZ1bmN0aW9uICgga2V5ICkgewoKCQlkZWxldGUgdGhpcy5maWxlc1sga2V5IF07CgoJfSwKCgljbGVhcjogZnVuY3Rpb24gKCkgewoKCQl0aGlzLmZpbGVzID0ge307CgoJfQoKfTsKCmNsYXNzIExvYWRpbmdNYW5hZ2VyIHsKCgljb25zdHJ1Y3Rvciggb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yICkgewoKCQljb25zdCBzY29wZSA9IHRoaXM7CgoJCWxldCBpc0xvYWRpbmcgPSBmYWxzZTsKCQlsZXQgaXRlbXNMb2FkZWQgPSAwOwoJCWxldCBpdGVtc1RvdGFsID0gMDsKCQlsZXQgdXJsTW9kaWZpZXIgPSB1bmRlZmluZWQ7CgkJY29uc3QgaGFuZGxlcnMgPSBbXTsKCgkJLy8gUmVmZXIgdG8gIzU2ODkgZm9yIHRoZSByZWFzb24gd2h5IHdlIGRvbid0IHNldCAub25TdGFydAoJCS8vIGluIHRoZSBjb25zdHJ1Y3RvcgoKCQl0aGlzLm9uU3RhcnQgPSB1bmRlZmluZWQ7CgkJdGhpcy5vbkxvYWQgPSBvbkxvYWQ7CgkJdGhpcy5vblByb2dyZXNzID0gb25Qcm9ncmVzczsKCQl0aGlzLm9uRXJyb3IgPSBvbkVycm9yOwoKCQl0aGlzLml0ZW1TdGFydCA9IGZ1bmN0aW9uICggdXJsICkgewoKCQkJaXRlbXNUb3RhbCArKzsKCgkJCWlmICggaXNMb2FkaW5nID09PSBmYWxzZSApIHsKCgkJCQlpZiAoIHNjb3BlLm9uU3RhcnQgIT09IHVuZGVmaW5lZCApIHsKCgkJCQkJc2NvcGUub25TdGFydCggdXJsLCBpdGVtc0xvYWRlZCwgaXRlbXNUb3RhbCApOwoKCQkJCX0KCgkJCX0KCgkJCWlzTG9hZGluZyA9IHRydWU7CgoJCX07CgoJCXRoaXMuaXRlbUVuZCA9IGZ1bmN0aW9uICggdXJsICkgewoKCQkJaXRlbXNMb2FkZWQgKys7CgoJCQlpZiAoIHNjb3BlLm9uUHJvZ3Jlc3MgIT09IHVuZGVmaW5lZCApIHsKCgkJCQlzY29wZS5vblByb2dyZXNzKCB1cmwsIGl0ZW1zTG9hZGVkLCBpdGVtc1RvdGFsICk7CgoJCQl9CgoJCQlpZiAoIGl0ZW1zTG9hZGVkID09PSBpdGVtc1RvdGFsICkgewoKCQkJCWlzTG9hZGluZyA9IGZhbHNlOwoKCQkJCWlmICggc2NvcGUub25Mb2FkICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJCXNjb3BlLm9uTG9hZCgpOwoKCQkJCX0KCgkJCX0KCgkJfTsKCgkJdGhpcy5pdGVtRXJyb3IgPSBmdW5jdGlvbiAoIHVybCApIHsKCgkJCWlmICggc2NvcGUub25FcnJvciAhPT0gdW5kZWZpbmVkICkgewoKCQkJCXNjb3BlLm9uRXJyb3IoIHVybCApOwoKCQkJfQoKCQl9OwoKCQl0aGlzLnJlc29sdmVVUkwgPSBmdW5jdGlvbiAoIHVybCApIHsKCgkJCWlmICggdXJsTW9kaWZpZXIgKSB7CgoJCQkJcmV0dXJuIHVybE1vZGlmaWVyKCB1cmwgKTsKCgkJCX0KCgkJCXJldHVybiB1cmw7CgoJCX07CgoJCXRoaXMuc2V0VVJMTW9kaWZpZXIgPSBmdW5jdGlvbiAoIHRyYW5zZm9ybSApIHsKCgkJCXVybE1vZGlmaWVyID0gdHJhbnNmb3JtOwoKCQkJcmV0dXJuIHRoaXM7CgoJCX07CgoJCXRoaXMuYWRkSGFuZGxlciA9IGZ1bmN0aW9uICggcmVnZXgsIGxvYWRlciApIHsKCgkJCWhhbmRsZXJzLnB1c2goIHJlZ2V4LCBsb2FkZXIgKTsKCgkJCXJldHVybiB0aGlzOwoKCQl9OwoKCQl0aGlzLnJlbW92ZUhhbmRsZXIgPSBmdW5jdGlvbiAoIHJlZ2V4ICkgewoKCQkJY29uc3QgaW5kZXggPSBoYW5kbGVycy5pbmRleE9mKCByZWdleCApOwoKCQkJaWYgKCBpbmRleCAhPT0gLSAxICkgewoKCQkJCWhhbmRsZXJzLnNwbGljZSggaW5kZXgsIDIgKTsKCgkJCX0KCgkJCXJldHVybiB0aGlzOwoKCQl9OwoKCQl0aGlzLmdldEhhbmRsZXIgPSBmdW5jdGlvbiAoIGZpbGUgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBoYW5kbGVycy5sZW5ndGg7IGkgPCBsOyBpICs9IDIgKSB7CgoJCQkJY29uc3QgcmVnZXggPSBoYW5kbGVyc1sgaSBdOwoJCQkJY29uc3QgbG9hZGVyID0gaGFuZGxlcnNbIGkgKyAxIF07CgoJCQkJaWYgKCByZWdleC5nbG9iYWwgKSByZWdleC5sYXN0SW5kZXggPSAwOyAvLyBzZWUgIzE3OTIwCgoJCQkJaWYgKCByZWdleC50ZXN0KCBmaWxlICkgKSB7CgoJCQkJCXJldHVybiBsb2FkZXI7CgoJCQkJfQoKCQkJfQoKCQkJcmV0dXJuIG51bGw7CgoJCX07CgoJfQoKfQoKY29uc3QgRGVmYXVsdExvYWRpbmdNYW5hZ2VyID0gLypAX19QVVJFX18qLyBuZXcgTG9hZGluZ01hbmFnZXIoKTsKCmNsYXNzIExvYWRlciB7CgoJY29uc3RydWN0b3IoIG1hbmFnZXIgKSB7CgoJCXRoaXMubWFuYWdlciA9ICggbWFuYWdlciAhPT0gdW5kZWZpbmVkICkgPyBtYW5hZ2VyIDogRGVmYXVsdExvYWRpbmdNYW5hZ2VyOwoKCQl0aGlzLmNyb3NzT3JpZ2luID0gJ2Fub255bW91cyc7CgkJdGhpcy53aXRoQ3JlZGVudGlhbHMgPSBmYWxzZTsKCQl0aGlzLnBhdGggPSAnJzsKCQl0aGlzLnJlc291cmNlUGF0aCA9ICcnOwoJCXRoaXMucmVxdWVzdEhlYWRlciA9IHt9OwoKCX0KCglsb2FkKCAvKiB1cmwsIG9uTG9hZCwgb25Qcm9ncmVzcywgb25FcnJvciAqLyApIHt9CgoJbG9hZEFzeW5jKCB1cmwsIG9uUHJvZ3Jlc3MgKSB7CgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJcmV0dXJuIG5ldyBQcm9taXNlKCBmdW5jdGlvbiAoIHJlc29sdmUsIHJlamVjdCApIHsKCgkJCXNjb3BlLmxvYWQoIHVybCwgcmVzb2x2ZSwgb25Qcm9ncmVzcywgcmVqZWN0ICk7CgoJCX0gKTsKCgl9CgoJcGFyc2UoIC8qIGRhdGEgKi8gKSB7fQoKCXNldENyb3NzT3JpZ2luKCBjcm9zc09yaWdpbiApIHsKCgkJdGhpcy5jcm9zc09yaWdpbiA9IGNyb3NzT3JpZ2luOwoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRXaXRoQ3JlZGVudGlhbHMoIHZhbHVlICkgewoKCQl0aGlzLndpdGhDcmVkZW50aWFscyA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRQYXRoKCBwYXRoICkgewoKCQl0aGlzLnBhdGggPSBwYXRoOwoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRSZXNvdXJjZVBhdGgoIHJlc291cmNlUGF0aCApIHsKCgkJdGhpcy5yZXNvdXJjZVBhdGggPSByZXNvdXJjZVBhdGg7CgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFJlcXVlc3RIZWFkZXIoIHJlcXVlc3RIZWFkZXIgKSB7CgoJCXRoaXMucmVxdWVzdEhlYWRlciA9IHJlcXVlc3RIZWFkZXI7CgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKTG9hZGVyLkRFRkFVTFRfTUFURVJJQUxfTkFNRSA9ICdfX0RFRkFVTFQnOwoKY29uc3QgbG9hZGluZyA9IHt9OwoKY2xhc3MgSHR0cEVycm9yIGV4dGVuZHMgRXJyb3IgewoKCWNvbnN0cnVjdG9yKCBtZXNzYWdlLCByZXNwb25zZSApIHsKCgkJc3VwZXIoIG1lc3NhZ2UgKTsKCQl0aGlzLnJlc3BvbnNlID0gcmVzcG9uc2U7CgoJfQoKfQoKY2xhc3MgRmlsZUxvYWRlciBleHRlbmRzIExvYWRlciB7CgoJY29uc3RydWN0b3IoIG1hbmFnZXIgKSB7CgoJCXN1cGVyKCBtYW5hZ2VyICk7CgoJfQoKCWxvYWQoIHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yICkgewoKCQlpZiAoIHVybCA9PT0gdW5kZWZpbmVkICkgdXJsID0gJyc7CgoJCWlmICggdGhpcy5wYXRoICE9PSB1bmRlZmluZWQgKSB1cmwgPSB0aGlzLnBhdGggKyB1cmw7CgoJCXVybCA9IHRoaXMubWFuYWdlci5yZXNvbHZlVVJMKCB1cmwgKTsKCgkJY29uc3QgY2FjaGVkID0gQ2FjaGUuZ2V0KCB1cmwgKTsKCgkJaWYgKCBjYWNoZWQgIT09IHVuZGVmaW5lZCApIHsKCgkJCXRoaXMubWFuYWdlci5pdGVtU3RhcnQoIHVybCApOwoKCQkJc2V0VGltZW91dCggKCkgPT4gewoKCQkJCWlmICggb25Mb2FkICkgb25Mb2FkKCBjYWNoZWQgKTsKCgkJCQl0aGlzLm1hbmFnZXIuaXRlbUVuZCggdXJsICk7CgoJCQl9LCAwICk7CgoJCQlyZXR1cm4gY2FjaGVkOwoKCQl9CgoJCS8vIENoZWNrIGlmIHJlcXVlc3QgaXMgZHVwbGljYXRlCgoJCWlmICggbG9hZGluZ1sgdXJsIF0gIT09IHVuZGVmaW5lZCApIHsKCgkJCWxvYWRpbmdbIHVybCBdLnB1c2goIHsKCgkJCQlvbkxvYWQ6IG9uTG9hZCwKCQkJCW9uUHJvZ3Jlc3M6IG9uUHJvZ3Jlc3MsCgkJCQlvbkVycm9yOiBvbkVycm9yCgoJCQl9ICk7CgoJCQlyZXR1cm47CgoJCX0KCgkJLy8gSW5pdGlhbGlzZSBhcnJheSBmb3IgZHVwbGljYXRlIHJlcXVlc3RzCgkJbG9hZGluZ1sgdXJsIF0gPSBbXTsKCgkJbG9hZGluZ1sgdXJsIF0ucHVzaCggewoJCQlvbkxvYWQ6IG9uTG9hZCwKCQkJb25Qcm9ncmVzczogb25Qcm9ncmVzcywKCQkJb25FcnJvcjogb25FcnJvciwKCQl9ICk7CgoJCS8vIGNyZWF0ZSByZXF1ZXN0CgkJY29uc3QgcmVxID0gbmV3IFJlcXVlc3QoIHVybCwgewoJCQloZWFkZXJzOiBuZXcgSGVhZGVycyggdGhpcy5yZXF1ZXN0SGVhZGVyICksCgkJCWNyZWRlbnRpYWxzOiB0aGlzLndpdGhDcmVkZW50aWFscyA/ICdpbmNsdWRlJyA6ICdzYW1lLW9yaWdpbicsCgkJCS8vIEFuIGFib3J0IGNvbnRyb2xsZXIgY291bGQgYmUgYWRkZWQgd2l0aGluIGEgZnV0dXJlIFBSCgkJfSApOwoKCQkvLyByZWNvcmQgc3RhdGVzICggYXZvaWQgZGF0YSByYWNlICkKCQljb25zdCBtaW1lVHlwZSA9IHRoaXMubWltZVR5cGU7CgkJY29uc3QgcmVzcG9uc2VUeXBlID0gdGhpcy5yZXNwb25zZVR5cGU7CgoJCS8vIHN0YXJ0IHRoZSBmZXRjaAoJCWZldGNoKCByZXEgKQoJCQkudGhlbiggcmVzcG9uc2UgPT4gewoKCQkJCWlmICggcmVzcG9uc2Uuc3RhdHVzID09PSAyMDAgfHwgcmVzcG9uc2Uuc3RhdHVzID09PSAwICkgewoKCQkJCQkvLyBTb21lIGJyb3dzZXJzIHJldHVybiBIVFRQIFN0YXR1cyAwIHdoZW4gdXNpbmcgbm9uLWh0dHAgcHJvdG9jb2wKCQkJCQkvLyBlLmcuICdmaWxlOi8vJyBvciAnZGF0YTovLycuIEhhbmRsZSBhcyBzdWNjZXNzLgoKCQkJCQlpZiAoIHJlc3BvbnNlLnN0YXR1cyA9PT0gMCApIHsKCgkJCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLkZpbGVMb2FkZXI6IEhUVFAgU3RhdHVzIDAgcmVjZWl2ZWQuJyApOwoKCQkJCQl9CgoJCQkJCS8vIFdvcmthcm91bmQ6IENoZWNraW5nIGlmIHJlc3BvbnNlLmJvZHkgPT09IHVuZGVmaW5lZCBmb3IgQWxpcGF5IGJyb3dzZXIgIzIzNTQ4CgoJCQkJCWlmICggdHlwZW9mIFJlYWRhYmxlU3RyZWFtID09PSAndW5kZWZpbmVkJyB8fCByZXNwb25zZS5ib2R5ID09PSB1bmRlZmluZWQgfHwgcmVzcG9uc2UuYm9keS5nZXRSZWFkZXIgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkJCXJldHVybiByZXNwb25zZTsKCgkJCQkJfQoKCQkJCQljb25zdCBjYWxsYmFja3MgPSBsb2FkaW5nWyB1cmwgXTsKCQkJCQljb25zdCByZWFkZXIgPSByZXNwb25zZS5ib2R5LmdldFJlYWRlcigpOwoKCQkJCQkvLyBOZ2lueCBuZWVkcyBYLUZpbGUtU2l6ZSBjaGVjawoJCQkJCS8vIGh0dHBzOi8vc2VydmVyZmF1bHQuY29tL3F1ZXN0aW9ucy80ODI4NzUvd2h5LWRvZXMtbmdpbngtcmVtb3ZlLWNvbnRlbnQtbGVuZ3RoLWhlYWRlci1mb3ItY2h1bmtlZC1jb250ZW50CgkJCQkJY29uc3QgY29udGVudExlbmd0aCA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCAnQ29udGVudC1MZW5ndGgnICkgfHwgcmVzcG9uc2UuaGVhZGVycy5nZXQoICdYLUZpbGUtU2l6ZScgKTsKCQkJCQljb25zdCB0b3RhbCA9IGNvbnRlbnRMZW5ndGggPyBwYXJzZUludCggY29udGVudExlbmd0aCApIDogMDsKCQkJCQljb25zdCBsZW5ndGhDb21wdXRhYmxlID0gdG90YWwgIT09IDA7CgkJCQkJbGV0IGxvYWRlZCA9IDA7CgoJCQkJCS8vIHBlcmlvZGljYWxseSByZWFkIGRhdGEgaW50byB0aGUgbmV3IHN0cmVhbSB0cmFja2luZyB3aGlsZSBkb3dubG9hZCBwcm9ncmVzcwoJCQkJCWNvbnN0IHN0cmVhbSA9IG5ldyBSZWFkYWJsZVN0cmVhbSggewoJCQkJCQlzdGFydCggY29udHJvbGxlciApIHsKCgkJCQkJCQlyZWFkRGF0YSgpOwoKCQkJCQkJCWZ1bmN0aW9uIHJlYWREYXRhKCkgewoKCQkJCQkJCQlyZWFkZXIucmVhZCgpLnRoZW4oICggeyBkb25lLCB2YWx1ZSB9ICkgPT4gewoKCQkJCQkJCQkJaWYgKCBkb25lICkgewoKCQkJCQkJCQkJCWNvbnRyb2xsZXIuY2xvc2UoKTsKCgkJCQkJCQkJCX0gZWxzZSB7CgoJCQkJCQkJCQkJbG9hZGVkICs9IHZhbHVlLmJ5dGVMZW5ndGg7CgoJCQkJCQkJCQkJY29uc3QgZXZlbnQgPSBuZXcgUHJvZ3Jlc3NFdmVudCggJ3Byb2dyZXNzJywgeyBsZW5ndGhDb21wdXRhYmxlLCBsb2FkZWQsIHRvdGFsIH0gKTsKCQkJCQkJCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQkJCQkJCQkJCWNvbnN0IGNhbGxiYWNrID0gY2FsbGJhY2tzWyBpIF07CgkJCQkJCQkJCQkJaWYgKCBjYWxsYmFjay5vblByb2dyZXNzICkgY2FsbGJhY2sub25Qcm9ncmVzcyggZXZlbnQgKTsKCgkJCQkJCQkJCQl9CgoJCQkJCQkJCQkJY29udHJvbGxlci5lbnF1ZXVlKCB2YWx1ZSApOwoJCQkJCQkJCQkJcmVhZERhdGEoKTsKCgkJCQkJCQkJCX0KCgkJCQkJCQkJfSApOwoKCQkJCQkJCX0KCgkJCQkJCX0KCgkJCQkJfSApOwoKCQkJCQlyZXR1cm4gbmV3IFJlc3BvbnNlKCBzdHJlYW0gKTsKCgkJCQl9IGVsc2UgewoKCQkJCQl0aHJvdyBuZXcgSHR0cEVycm9yKCBgZmV0Y2ggZm9yICIke3Jlc3BvbnNlLnVybH0iIHJlc3BvbmRlZCB3aXRoICR7cmVzcG9uc2Uuc3RhdHVzfTogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWAsIHJlc3BvbnNlICk7CgoJCQkJfQoKCQkJfSApCgkJCS50aGVuKCByZXNwb25zZSA9PiB7CgoJCQkJc3dpdGNoICggcmVzcG9uc2VUeXBlICkgewoKCQkJCQljYXNlICdhcnJheWJ1ZmZlcic6CgoJCQkJCQlyZXR1cm4gcmVzcG9uc2UuYXJyYXlCdWZmZXIoKTsKCgkJCQkJY2FzZSAnYmxvYic6CgoJCQkJCQlyZXR1cm4gcmVzcG9uc2UuYmxvYigpOwoKCQkJCQljYXNlICdkb2N1bWVudCc6CgoJCQkJCQlyZXR1cm4gcmVzcG9uc2UudGV4dCgpCgkJCQkJCQkudGhlbiggdGV4dCA9PiB7CgoJCQkJCQkJCWNvbnN0IHBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKCQkJCQkJCQlyZXR1cm4gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyggdGV4dCwgbWltZVR5cGUgKTsKCgkJCQkJCQl9ICk7CgoJCQkJCWNhc2UgJ2pzb24nOgoKCQkJCQkJcmV0dXJuIHJlc3BvbnNlLmpzb24oKTsKCgkJCQkJZGVmYXVsdDoKCgkJCQkJCWlmICggbWltZVR5cGUgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkJCQlyZXR1cm4gcmVzcG9uc2UudGV4dCgpOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQkvLyBzbmlmZiBlbmNvZGluZwoJCQkJCQkJY29uc3QgcmUgPSAvY2hhcnNldD0iPyhbXjsiXHNdKikiPy9pOwoJCQkJCQkJY29uc3QgZXhlYyA9IHJlLmV4ZWMoIG1pbWVUeXBlICk7CgkJCQkJCQljb25zdCBsYWJlbCA9IGV4ZWMgJiYgZXhlY1sgMSBdID8gZXhlY1sgMSBdLnRvTG93ZXJDYXNlKCkgOiB1bmRlZmluZWQ7CgkJCQkJCQljb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCBsYWJlbCApOwoJCQkJCQkJcmV0dXJuIHJlc3BvbnNlLmFycmF5QnVmZmVyKCkudGhlbiggYWIgPT4gZGVjb2Rlci5kZWNvZGUoIGFiICkgKTsKCgkJCQkJCX0KCgkJCQl9CgoJCQl9ICkKCQkJLnRoZW4oIGRhdGEgPT4gewoKCQkJCS8vIEFkZCB0byBjYWNoZSBvbmx5IG9uIEhUVFAgc3VjY2Vzcywgc28gdGhhdCB3ZSBkbyBub3QgY2FjaGUKCQkJCS8vIGVycm9yIHJlc3BvbnNlIGJvZGllcyBhcyBwcm9wZXIgcmVzcG9uc2VzIHRvIHJlcXVlc3RzLgoJCQkJQ2FjaGUuYWRkKCB1cmwsIGRhdGEgKTsKCgkJCQljb25zdCBjYWxsYmFja3MgPSBsb2FkaW5nWyB1cmwgXTsKCQkJCWRlbGV0ZSBsb2FkaW5nWyB1cmwgXTsKCgkJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gY2FsbGJhY2tzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCQljb25zdCBjYWxsYmFjayA9IGNhbGxiYWNrc1sgaSBdOwoJCQkJCWlmICggY2FsbGJhY2sub25Mb2FkICkgY2FsbGJhY2sub25Mb2FkKCBkYXRhICk7CgoJCQkJfQoKCQkJfSApCgkJCS5jYXRjaCggZXJyID0+IHsKCgkJCQkvLyBBYm9ydCBlcnJvcnMgYW5kIG90aGVyIGVycm9ycyBhcmUgaGFuZGxlZCB0aGUgc2FtZQoKCQkJCWNvbnN0IGNhbGxiYWNrcyA9IGxvYWRpbmdbIHVybCBdOwoKCQkJCWlmICggY2FsbGJhY2tzID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCS8vIFdoZW4gb25Mb2FkIHdhcyBjYWxsZWQgYW5kIHVybCB3YXMgZGVsZXRlZCBpbiBgbG9hZGluZ2AKCQkJCQl0aGlzLm1hbmFnZXIuaXRlbUVycm9yKCB1cmwgKTsKCQkJCQl0aHJvdyBlcnI7CgoJCQkJfQoKCQkJCWRlbGV0ZSBsb2FkaW5nWyB1cmwgXTsKCgkJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gY2FsbGJhY2tzLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCQljb25zdCBjYWxsYmFjayA9IGNhbGxiYWNrc1sgaSBdOwoJCQkJCWlmICggY2FsbGJhY2sub25FcnJvciApIGNhbGxiYWNrLm9uRXJyb3IoIGVyciApOwoKCQkJCX0KCgkJCQl0aGlzLm1hbmFnZXIuaXRlbUVycm9yKCB1cmwgKTsKCgkJCX0gKQoJCQkuZmluYWxseSggKCkgPT4gewoKCQkJCXRoaXMubWFuYWdlci5pdGVtRW5kKCB1cmwgKTsKCgkJCX0gKTsKCgkJdGhpcy5tYW5hZ2VyLml0ZW1TdGFydCggdXJsICk7CgoJfQoKCXNldFJlc3BvbnNlVHlwZSggdmFsdWUgKSB7CgoJCXRoaXMucmVzcG9uc2VUeXBlID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldE1pbWVUeXBlKCB2YWx1ZSApIHsKCgkJdGhpcy5taW1lVHlwZSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIEFuaW1hdGlvbkxvYWRlciBleHRlbmRzIExvYWRlciB7CgoJY29uc3RydWN0b3IoIG1hbmFnZXIgKSB7CgoJCXN1cGVyKCBtYW5hZ2VyICk7CgoJfQoKCWxvYWQoIHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yICkgewoKCQljb25zdCBzY29wZSA9IHRoaXM7CgoJCWNvbnN0IGxvYWRlciA9IG5ldyBGaWxlTG9hZGVyKCB0aGlzLm1hbmFnZXIgKTsKCQlsb2FkZXIuc2V0UGF0aCggdGhpcy5wYXRoICk7CgkJbG9hZGVyLnNldFJlcXVlc3RIZWFkZXIoIHRoaXMucmVxdWVzdEhlYWRlciApOwoJCWxvYWRlci5zZXRXaXRoQ3JlZGVudGlhbHMoIHRoaXMud2l0aENyZWRlbnRpYWxzICk7CgkJbG9hZGVyLmxvYWQoIHVybCwgZnVuY3Rpb24gKCB0ZXh0ICkgewoKCQkJdHJ5IHsKCgkJCQlvbkxvYWQoIHNjb3BlLnBhcnNlKCBKU09OLnBhcnNlKCB0ZXh0ICkgKSApOwoKCQkJfSBjYXRjaCAoIGUgKSB7CgoJCQkJaWYgKCBvbkVycm9yICkgewoKCQkJCQlvbkVycm9yKCBlICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJY29uc29sZS5lcnJvciggZSApOwoKCQkJCX0KCgkJCQlzY29wZS5tYW5hZ2VyLml0ZW1FcnJvciggdXJsICk7CgoJCQl9CgoJCX0sIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKTsKCgl9CgoJcGFyc2UoIGpzb24gKSB7CgoJCWNvbnN0IGFuaW1hdGlvbnMgPSBbXTsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwganNvbi5sZW5ndGg7IGkgKysgKSB7CgoJCQljb25zdCBjbGlwID0gQW5pbWF0aW9uQ2xpcC5wYXJzZSgganNvblsgaSBdICk7CgoJCQlhbmltYXRpb25zLnB1c2goIGNsaXAgKTsKCgkJfQoKCQlyZXR1cm4gYW5pbWF0aW9uczsKCgl9Cgp9CgovKioKICogQWJzdHJhY3QgQmFzZSBjbGFzcyB0byBibG9jayBiYXNlZCB0ZXh0dXJlcyBsb2FkZXIgKGRkcywgcHZyLCAuLi4pCiAqCiAqIFN1YiBjbGFzc2VzIGhhdmUgdG8gaW1wbGVtZW50IHRoZSBwYXJzZSgpIG1ldGhvZCB3aGljaCB3aWxsIGJlIHVzZWQgaW4gbG9hZCgpLgogKi8KCmNsYXNzIENvbXByZXNzZWRUZXh0dXJlTG9hZGVyIGV4dGVuZHMgTG9hZGVyIHsKCgljb25zdHJ1Y3RvciggbWFuYWdlciApIHsKCgkJc3VwZXIoIG1hbmFnZXIgKTsKCgl9CgoJbG9hZCggdXJsLCBvbkxvYWQsIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKSB7CgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJY29uc3QgaW1hZ2VzID0gW107CgoJCWNvbnN0IHRleHR1cmUgPSBuZXcgQ29tcHJlc3NlZFRleHR1cmUoKTsKCgkJY29uc3QgbG9hZGVyID0gbmV3IEZpbGVMb2FkZXIoIHRoaXMubWFuYWdlciApOwoJCWxvYWRlci5zZXRQYXRoKCB0aGlzLnBhdGggKTsKCQlsb2FkZXIuc2V0UmVzcG9uc2VUeXBlKCAnYXJyYXlidWZmZXInICk7CgkJbG9hZGVyLnNldFJlcXVlc3RIZWFkZXIoIHRoaXMucmVxdWVzdEhlYWRlciApOwoJCWxvYWRlci5zZXRXaXRoQ3JlZGVudGlhbHMoIHNjb3BlLndpdGhDcmVkZW50aWFscyApOwoKCQlsZXQgbG9hZGVkID0gMDsKCgkJZnVuY3Rpb24gbG9hZFRleHR1cmUoIGkgKSB7CgoJCQlsb2FkZXIubG9hZCggdXJsWyBpIF0sIGZ1bmN0aW9uICggYnVmZmVyICkgewoKCQkJCWNvbnN0IHRleERhdGFzID0gc2NvcGUucGFyc2UoIGJ1ZmZlciwgdHJ1ZSApOwoKCQkJCWltYWdlc1sgaSBdID0gewoJCQkJCXdpZHRoOiB0ZXhEYXRhcy53aWR0aCwKCQkJCQloZWlnaHQ6IHRleERhdGFzLmhlaWdodCwKCQkJCQlmb3JtYXQ6IHRleERhdGFzLmZvcm1hdCwKCQkJCQltaXBtYXBzOiB0ZXhEYXRhcy5taXBtYXBzCgkJCQl9OwoKCQkJCWxvYWRlZCArPSAxOwoKCQkJCWlmICggbG9hZGVkID09PSA2ICkgewoKCQkJCQlpZiAoIHRleERhdGFzLm1pcG1hcENvdW50ID09PSAxICkgdGV4dHVyZS5taW5GaWx0ZXIgPSBMaW5lYXJGaWx0ZXI7CgoJCQkJCXRleHR1cmUuaW1hZ2UgPSBpbWFnZXM7CgkJCQkJdGV4dHVyZS5mb3JtYXQgPSB0ZXhEYXRhcy5mb3JtYXQ7CgkJCQkJdGV4dHVyZS5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCQkJCWlmICggb25Mb2FkICkgb25Mb2FkKCB0ZXh0dXJlICk7CgoJCQkJfQoKCQkJfSwgb25Qcm9ncmVzcywgb25FcnJvciApOwoKCQl9CgoJCWlmICggQXJyYXkuaXNBcnJheSggdXJsICkgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGlsID0gdXJsLmxlbmd0aDsgaSA8IGlsOyArKyBpICkgewoKCQkJCWxvYWRUZXh0dXJlKCBpICk7CgoJCQl9CgoJCX0gZWxzZSB7CgoJCQkvLyBjb21wcmVzc2VkIGN1YmVtYXAgdGV4dHVyZSBzdG9yZWQgaW4gYSBzaW5nbGUgRERTIGZpbGUKCgkJCWxvYWRlci5sb2FkKCB1cmwsIGZ1bmN0aW9uICggYnVmZmVyICkgewoKCQkJCWNvbnN0IHRleERhdGFzID0gc2NvcGUucGFyc2UoIGJ1ZmZlciwgdHJ1ZSApOwoKCQkJCWlmICggdGV4RGF0YXMuaXNDdWJlbWFwICkgewoKCQkJCQljb25zdCBmYWNlcyA9IHRleERhdGFzLm1pcG1hcHMubGVuZ3RoIC8gdGV4RGF0YXMubWlwbWFwQ291bnQ7CgoJCQkJCWZvciAoIGxldCBmID0gMDsgZiA8IGZhY2VzOyBmICsrICkgewoKCQkJCQkJaW1hZ2VzWyBmIF0gPSB7IG1pcG1hcHM6IFtdIH07CgoJCQkJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB0ZXhEYXRhcy5taXBtYXBDb3VudDsgaSArKyApIHsKCgkJCQkJCQlpbWFnZXNbIGYgXS5taXBtYXBzLnB1c2goIHRleERhdGFzLm1pcG1hcHNbIGYgKiB0ZXhEYXRhcy5taXBtYXBDb3VudCArIGkgXSApOwoJCQkJCQkJaW1hZ2VzWyBmIF0uZm9ybWF0ID0gdGV4RGF0YXMuZm9ybWF0OwoJCQkJCQkJaW1hZ2VzWyBmIF0ud2lkdGggPSB0ZXhEYXRhcy53aWR0aDsKCQkJCQkJCWltYWdlc1sgZiBdLmhlaWdodCA9IHRleERhdGFzLmhlaWdodDsKCgkJCQkJCX0KCgkJCQkJfQoKCQkJCQl0ZXh0dXJlLmltYWdlID0gaW1hZ2VzOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRleHR1cmUuaW1hZ2Uud2lkdGggPSB0ZXhEYXRhcy53aWR0aDsKCQkJCQl0ZXh0dXJlLmltYWdlLmhlaWdodCA9IHRleERhdGFzLmhlaWdodDsKCQkJCQl0ZXh0dXJlLm1pcG1hcHMgPSB0ZXhEYXRhcy5taXBtYXBzOwoKCQkJCX0KCgkJCQlpZiAoIHRleERhdGFzLm1pcG1hcENvdW50ID09PSAxICkgewoKCQkJCQl0ZXh0dXJlLm1pbkZpbHRlciA9IExpbmVhckZpbHRlcjsKCgkJCQl9CgoJCQkJdGV4dHVyZS5mb3JtYXQgPSB0ZXhEYXRhcy5mb3JtYXQ7CgkJCQl0ZXh0dXJlLm5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJCQlpZiAoIG9uTG9hZCApIG9uTG9hZCggdGV4dHVyZSApOwoKCQkJfSwgb25Qcm9ncmVzcywgb25FcnJvciApOwoKCQl9CgoJCXJldHVybiB0ZXh0dXJlOwoKCX0KCn0KCmNsYXNzIEltYWdlTG9hZGVyIGV4dGVuZHMgTG9hZGVyIHsKCgljb25zdHJ1Y3RvciggbWFuYWdlciApIHsKCgkJc3VwZXIoIG1hbmFnZXIgKTsKCgl9CgoJbG9hZCggdXJsLCBvbkxvYWQsIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKSB7CgoJCWlmICggdGhpcy5wYXRoICE9PSB1bmRlZmluZWQgKSB1cmwgPSB0aGlzLnBhdGggKyB1cmw7CgoJCXVybCA9IHRoaXMubWFuYWdlci5yZXNvbHZlVVJMKCB1cmwgKTsKCgkJY29uc3Qgc2NvcGUgPSB0aGlzOwoKCQljb25zdCBjYWNoZWQgPSBDYWNoZS5nZXQoIHVybCApOwoKCQlpZiAoIGNhY2hlZCAhPT0gdW5kZWZpbmVkICkgewoKCQkJc2NvcGUubWFuYWdlci5pdGVtU3RhcnQoIHVybCApOwoKCQkJc2V0VGltZW91dCggZnVuY3Rpb24gKCkgewoKCQkJCWlmICggb25Mb2FkICkgb25Mb2FkKCBjYWNoZWQgKTsKCgkJCQlzY29wZS5tYW5hZ2VyLml0ZW1FbmQoIHVybCApOwoKCQkJfSwgMCApOwoKCQkJcmV0dXJuIGNhY2hlZDsKCgkJfQoKCQljb25zdCBpbWFnZSA9IGNyZWF0ZUVsZW1lbnROUyggJ2ltZycgKTsKCgkJZnVuY3Rpb24gb25JbWFnZUxvYWQoKSB7CgoJCQlyZW1vdmVFdmVudExpc3RlbmVycygpOwoKCQkJQ2FjaGUuYWRkKCB1cmwsIHRoaXMgKTsKCgkJCWlmICggb25Mb2FkICkgb25Mb2FkKCB0aGlzICk7CgoJCQlzY29wZS5tYW5hZ2VyLml0ZW1FbmQoIHVybCApOwoKCQl9CgoJCWZ1bmN0aW9uIG9uSW1hZ2VFcnJvciggZXZlbnQgKSB7CgoJCQlyZW1vdmVFdmVudExpc3RlbmVycygpOwoKCQkJaWYgKCBvbkVycm9yICkgb25FcnJvciggZXZlbnQgKTsKCgkJCXNjb3BlLm1hbmFnZXIuaXRlbUVycm9yKCB1cmwgKTsKCQkJc2NvcGUubWFuYWdlci5pdGVtRW5kKCB1cmwgKTsKCgkJfQoKCQlmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVycygpIHsKCgkJCWltYWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdsb2FkJywgb25JbWFnZUxvYWQsIGZhbHNlICk7CgkJCWltYWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdlcnJvcicsIG9uSW1hZ2VFcnJvciwgZmFsc2UgKTsKCgkJfQoKCQlpbWFnZS5hZGRFdmVudExpc3RlbmVyKCAnbG9hZCcsIG9uSW1hZ2VMb2FkLCBmYWxzZSApOwoJCWltYWdlLmFkZEV2ZW50TGlzdGVuZXIoICdlcnJvcicsIG9uSW1hZ2VFcnJvciwgZmFsc2UgKTsKCgkJaWYgKCB1cmwuc2xpY2UoIDAsIDUgKSAhPT0gJ2RhdGE6JyApIHsKCgkJCWlmICggdGhpcy5jcm9zc09yaWdpbiAhPT0gdW5kZWZpbmVkICkgaW1hZ2UuY3Jvc3NPcmlnaW4gPSB0aGlzLmNyb3NzT3JpZ2luOwoKCQl9CgoJCXNjb3BlLm1hbmFnZXIuaXRlbVN0YXJ0KCB1cmwgKTsKCgkJaW1hZ2Uuc3JjID0gdXJsOwoKCQlyZXR1cm4gaW1hZ2U7CgoJfQoKfQoKY2xhc3MgQ3ViZVRleHR1cmVMb2FkZXIgZXh0ZW5kcyBMb2FkZXIgewoKCWNvbnN0cnVjdG9yKCBtYW5hZ2VyICkgewoKCQlzdXBlciggbWFuYWdlciApOwoKCX0KCglsb2FkKCB1cmxzLCBvbkxvYWQsIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKSB7CgoJCWNvbnN0IHRleHR1cmUgPSBuZXcgQ3ViZVRleHR1cmUoKTsKCQl0ZXh0dXJlLmNvbG9yU3BhY2UgPSBTUkdCQ29sb3JTcGFjZTsKCgkJY29uc3QgbG9hZGVyID0gbmV3IEltYWdlTG9hZGVyKCB0aGlzLm1hbmFnZXIgKTsKCQlsb2FkZXIuc2V0Q3Jvc3NPcmlnaW4oIHRoaXMuY3Jvc3NPcmlnaW4gKTsKCQlsb2FkZXIuc2V0UGF0aCggdGhpcy5wYXRoICk7CgoJCWxldCBsb2FkZWQgPSAwOwoKCQlmdW5jdGlvbiBsb2FkVGV4dHVyZSggaSApIHsKCgkJCWxvYWRlci5sb2FkKCB1cmxzWyBpIF0sIGZ1bmN0aW9uICggaW1hZ2UgKSB7CgoJCQkJdGV4dHVyZS5pbWFnZXNbIGkgXSA9IGltYWdlOwoKCQkJCWxvYWRlZCArKzsKCgkJCQlpZiAoIGxvYWRlZCA9PT0gNiApIHsKCgkJCQkJdGV4dHVyZS5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCQkJCWlmICggb25Mb2FkICkgb25Mb2FkKCB0ZXh0dXJlICk7CgoJCQkJfQoKCQkJfSwgdW5kZWZpbmVkLCBvbkVycm9yICk7CgoJCX0KCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgdXJscy5sZW5ndGg7ICsrIGkgKSB7CgoJCQlsb2FkVGV4dHVyZSggaSApOwoKCQl9CgoJCXJldHVybiB0ZXh0dXJlOwoKCX0KCn0KCi8qKgogKiBBYnN0cmFjdCBCYXNlIGNsYXNzIHRvIGxvYWQgZ2VuZXJpYyBiaW5hcnkgdGV4dHVyZXMgZm9ybWF0cyAocmdiZSwgaGRyLCAuLi4pCiAqCiAqIFN1YiBjbGFzc2VzIGhhdmUgdG8gaW1wbGVtZW50IHRoZSBwYXJzZSgpIG1ldGhvZCB3aGljaCB3aWxsIGJlIHVzZWQgaW4gbG9hZCgpLgogKi8KCmNsYXNzIERhdGFUZXh0dXJlTG9hZGVyIGV4dGVuZHMgTG9hZGVyIHsKCgljb25zdHJ1Y3RvciggbWFuYWdlciApIHsKCgkJc3VwZXIoIG1hbmFnZXIgKTsKCgl9CgoJbG9hZCggdXJsLCBvbkxvYWQsIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKSB7CgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJY29uc3QgdGV4dHVyZSA9IG5ldyBEYXRhVGV4dHVyZSgpOwoKCQljb25zdCBsb2FkZXIgPSBuZXcgRmlsZUxvYWRlciggdGhpcy5tYW5hZ2VyICk7CgkJbG9hZGVyLnNldFJlc3BvbnNlVHlwZSggJ2FycmF5YnVmZmVyJyApOwoJCWxvYWRlci5zZXRSZXF1ZXN0SGVhZGVyKCB0aGlzLnJlcXVlc3RIZWFkZXIgKTsKCQlsb2FkZXIuc2V0UGF0aCggdGhpcy5wYXRoICk7CgkJbG9hZGVyLnNldFdpdGhDcmVkZW50aWFscyggc2NvcGUud2l0aENyZWRlbnRpYWxzICk7CgkJbG9hZGVyLmxvYWQoIHVybCwgZnVuY3Rpb24gKCBidWZmZXIgKSB7CgoJCQlsZXQgdGV4RGF0YTsKCgkJCXRyeSB7CgoJCQkJdGV4RGF0YSA9IHNjb3BlLnBhcnNlKCBidWZmZXIgKTsKCgkJCX0gY2F0Y2ggKCBlcnJvciApIHsKCgkJCQlpZiAoIG9uRXJyb3IgIT09IHVuZGVmaW5lZCApIHsKCgkJCQkJb25FcnJvciggZXJyb3IgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQljb25zb2xlLmVycm9yKCBlcnJvciApOwoJCQkJCXJldHVybjsKCgkJCQl9CgoJCQl9CgoJCQlpZiAoIHRleERhdGEuaW1hZ2UgIT09IHVuZGVmaW5lZCApIHsKCgkJCQl0ZXh0dXJlLmltYWdlID0gdGV4RGF0YS5pbWFnZTsKCgkJCX0gZWxzZSBpZiAoIHRleERhdGEuZGF0YSAhPT0gdW5kZWZpbmVkICkgewoKCQkJCXRleHR1cmUuaW1hZ2Uud2lkdGggPSB0ZXhEYXRhLndpZHRoOwoJCQkJdGV4dHVyZS5pbWFnZS5oZWlnaHQgPSB0ZXhEYXRhLmhlaWdodDsKCQkJCXRleHR1cmUuaW1hZ2UuZGF0YSA9IHRleERhdGEuZGF0YTsKCgkJCX0KCgkJCXRleHR1cmUud3JhcFMgPSB0ZXhEYXRhLndyYXBTICE9PSB1bmRlZmluZWQgPyB0ZXhEYXRhLndyYXBTIDogQ2xhbXBUb0VkZ2VXcmFwcGluZzsKCQkJdGV4dHVyZS53cmFwVCA9IHRleERhdGEud3JhcFQgIT09IHVuZGVmaW5lZCA/IHRleERhdGEud3JhcFQgOiBDbGFtcFRvRWRnZVdyYXBwaW5nOwoKCQkJdGV4dHVyZS5tYWdGaWx0ZXIgPSB0ZXhEYXRhLm1hZ0ZpbHRlciAhPT0gdW5kZWZpbmVkID8gdGV4RGF0YS5tYWdGaWx0ZXIgOiBMaW5lYXJGaWx0ZXI7CgkJCXRleHR1cmUubWluRmlsdGVyID0gdGV4RGF0YS5taW5GaWx0ZXIgIT09IHVuZGVmaW5lZCA/IHRleERhdGEubWluRmlsdGVyIDogTGluZWFyRmlsdGVyOwoKCQkJdGV4dHVyZS5hbmlzb3Ryb3B5ID0gdGV4RGF0YS5hbmlzb3Ryb3B5ICE9PSB1bmRlZmluZWQgPyB0ZXhEYXRhLmFuaXNvdHJvcHkgOiAxOwoKCQkJaWYgKCB0ZXhEYXRhLmNvbG9yU3BhY2UgIT09IHVuZGVmaW5lZCApIHsKCgkJCQl0ZXh0dXJlLmNvbG9yU3BhY2UgPSB0ZXhEYXRhLmNvbG9yU3BhY2U7CgoJCQl9IGVsc2UgaWYgKCB0ZXhEYXRhLmVuY29kaW5nICE9PSB1bmRlZmluZWQgKSB7IC8vIEBkZXByZWNhdGVkLCByMTUyCgoJCQkJdGV4dHVyZS5lbmNvZGluZyA9IHRleERhdGEuZW5jb2Rpbmc7CgoJCQl9CgoJCQlpZiAoIHRleERhdGEuZmxpcFkgIT09IHVuZGVmaW5lZCApIHsKCgkJCQl0ZXh0dXJlLmZsaXBZID0gdGV4RGF0YS5mbGlwWTsKCgkJCX0KCgkJCWlmICggdGV4RGF0YS5mb3JtYXQgIT09IHVuZGVmaW5lZCApIHsKCgkJCQl0ZXh0dXJlLmZvcm1hdCA9IHRleERhdGEuZm9ybWF0OwoKCQkJfQoKCQkJaWYgKCB0ZXhEYXRhLnR5cGUgIT09IHVuZGVmaW5lZCApIHsKCgkJCQl0ZXh0dXJlLnR5cGUgPSB0ZXhEYXRhLnR5cGU7CgoJCQl9CgoJCQlpZiAoIHRleERhdGEubWlwbWFwcyAhPT0gdW5kZWZpbmVkICkgewoKCQkJCXRleHR1cmUubWlwbWFwcyA9IHRleERhdGEubWlwbWFwczsKCQkJCXRleHR1cmUubWluRmlsdGVyID0gTGluZWFyTWlwbWFwTGluZWFyRmlsdGVyOyAvLyBwcmVzdW1hYmx5Li4uCgoJCQl9CgoJCQlpZiAoIHRleERhdGEubWlwbWFwQ291bnQgPT09IDEgKSB7CgoJCQkJdGV4dHVyZS5taW5GaWx0ZXIgPSBMaW5lYXJGaWx0ZXI7CgoJCQl9CgoJCQlpZiAoIHRleERhdGEuZ2VuZXJhdGVNaXBtYXBzICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJdGV4dHVyZS5nZW5lcmF0ZU1pcG1hcHMgPSB0ZXhEYXRhLmdlbmVyYXRlTWlwbWFwczsKCgkJCX0KCgkJCXRleHR1cmUubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQkJaWYgKCBvbkxvYWQgKSBvbkxvYWQoIHRleHR1cmUsIHRleERhdGEgKTsKCgkJfSwgb25Qcm9ncmVzcywgb25FcnJvciApOwoKCgkJcmV0dXJuIHRleHR1cmU7CgoJfQoKfQoKY2xhc3MgVGV4dHVyZUxvYWRlciBleHRlbmRzIExvYWRlciB7CgoJY29uc3RydWN0b3IoIG1hbmFnZXIgKSB7CgoJCXN1cGVyKCBtYW5hZ2VyICk7CgoJfQoKCWxvYWQoIHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yICkgewoKCQljb25zdCB0ZXh0dXJlID0gbmV3IFRleHR1cmUoKTsKCgkJY29uc3QgbG9hZGVyID0gbmV3IEltYWdlTG9hZGVyKCB0aGlzLm1hbmFnZXIgKTsKCQlsb2FkZXIuc2V0Q3Jvc3NPcmlnaW4oIHRoaXMuY3Jvc3NPcmlnaW4gKTsKCQlsb2FkZXIuc2V0UGF0aCggdGhpcy5wYXRoICk7CgoJCWxvYWRlci5sb2FkKCB1cmwsIGZ1bmN0aW9uICggaW1hZ2UgKSB7CgoJCQl0ZXh0dXJlLmltYWdlID0gaW1hZ2U7CgkJCXRleHR1cmUubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQkJaWYgKCBvbkxvYWQgIT09IHVuZGVmaW5lZCApIHsKCgkJCQlvbkxvYWQoIHRleHR1cmUgKTsKCgkJCX0KCgkJfSwgb25Qcm9ncmVzcywgb25FcnJvciApOwoKCQlyZXR1cm4gdGV4dHVyZTsKCgl9Cgp9CgpjbGFzcyBMaWdodCBleHRlbmRzIE9iamVjdDNEIHsKCgljb25zdHJ1Y3RvciggY29sb3IsIGludGVuc2l0eSA9IDEgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMuaXNMaWdodCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdMaWdodCc7CgoJCXRoaXMuY29sb3IgPSBuZXcgQ29sb3IoIGNvbG9yICk7CgkJdGhpcy5pbnRlbnNpdHkgPSBpbnRlbnNpdHk7CgoJfQoKCWRpc3Bvc2UoKSB7CgoJCS8vIEVtcHR5IGhlcmUgaW4gYmFzZSBjbGFzczsgc29tZSBzdWJjbGFzc2VzIG92ZXJyaWRlLgoKCX0KCgljb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlLCByZWN1cnNpdmUgKTsKCgkJdGhpcy5jb2xvci5jb3B5KCBzb3VyY2UuY29sb3IgKTsKCQl0aGlzLmludGVuc2l0eSA9IHNvdXJjZS5pbnRlbnNpdHk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0pTT04oIG1ldGEgKSB7CgoJCWNvbnN0IGRhdGEgPSBzdXBlci50b0pTT04oIG1ldGEgKTsKCgkJZGF0YS5vYmplY3QuY29sb3IgPSB0aGlzLmNvbG9yLmdldEhleCgpOwoJCWRhdGEub2JqZWN0LmludGVuc2l0eSA9IHRoaXMuaW50ZW5zaXR5OwoKCQlpZiAoIHRoaXMuZ3JvdW5kQ29sb3IgIT09IHVuZGVmaW5lZCApIGRhdGEub2JqZWN0Lmdyb3VuZENvbG9yID0gdGhpcy5ncm91bmRDb2xvci5nZXRIZXgoKTsKCgkJaWYgKCB0aGlzLmRpc3RhbmNlICE9PSB1bmRlZmluZWQgKSBkYXRhLm9iamVjdC5kaXN0YW5jZSA9IHRoaXMuZGlzdGFuY2U7CgkJaWYgKCB0aGlzLmFuZ2xlICE9PSB1bmRlZmluZWQgKSBkYXRhLm9iamVjdC5hbmdsZSA9IHRoaXMuYW5nbGU7CgkJaWYgKCB0aGlzLmRlY2F5ICE9PSB1bmRlZmluZWQgKSBkYXRhLm9iamVjdC5kZWNheSA9IHRoaXMuZGVjYXk7CgkJaWYgKCB0aGlzLnBlbnVtYnJhICE9PSB1bmRlZmluZWQgKSBkYXRhLm9iamVjdC5wZW51bWJyYSA9IHRoaXMucGVudW1icmE7CgoJCWlmICggdGhpcy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIGRhdGEub2JqZWN0LnNoYWRvdyA9IHRoaXMuc2hhZG93LnRvSlNPTigpOwoKCQlyZXR1cm4gZGF0YTsKCgl9Cgp9CgpjbGFzcyBIZW1pc3BoZXJlTGlnaHQgZXh0ZW5kcyBMaWdodCB7CgoJY29uc3RydWN0b3IoIHNreUNvbG9yLCBncm91bmRDb2xvciwgaW50ZW5zaXR5ICkgewoKCQlzdXBlciggc2t5Q29sb3IsIGludGVuc2l0eSApOwoKCQl0aGlzLmlzSGVtaXNwaGVyZUxpZ2h0ID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ0hlbWlzcGhlcmVMaWdodCc7CgoJCXRoaXMucG9zaXRpb24uY29weSggT2JqZWN0M0QuREVGQVVMVF9VUCApOwoJCXRoaXMudXBkYXRlTWF0cml4KCk7CgoJCXRoaXMuZ3JvdW5kQ29sb3IgPSBuZXcgQ29sb3IoIGdyb3VuZENvbG9yICk7CgoJfQoKCWNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApOwoKCQl0aGlzLmdyb3VuZENvbG9yLmNvcHkoIHNvdXJjZS5ncm91bmRDb2xvciApOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9Cgpjb25zdCBfcHJvalNjcmVlbk1hdHJpeCQxID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwpjb25zdCBfbGlnaHRQb3NpdGlvbldvcmxkJDEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9sb29rVGFyZ2V0JDEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CgpjbGFzcyBMaWdodFNoYWRvdyB7CgoJY29uc3RydWN0b3IoIGNhbWVyYSApIHsKCgkJdGhpcy5jYW1lcmEgPSBjYW1lcmE7CgoJCXRoaXMuYmlhcyA9IDA7CgkJdGhpcy5ub3JtYWxCaWFzID0gMDsKCQl0aGlzLnJhZGl1cyA9IDE7CgkJdGhpcy5ibHVyU2FtcGxlcyA9IDg7CgoJCXRoaXMubWFwU2l6ZSA9IG5ldyBWZWN0b3IyKCA1MTIsIDUxMiApOwoKCQl0aGlzLm1hcCA9IG51bGw7CgkJdGhpcy5tYXBQYXNzID0gbnVsbDsKCQl0aGlzLm1hdHJpeCA9IG5ldyBNYXRyaXg0KCk7CgoJCXRoaXMuYXV0b1VwZGF0ZSA9IHRydWU7CgkJdGhpcy5uZWVkc1VwZGF0ZSA9IGZhbHNlOwoKCQl0aGlzLl9mcnVzdHVtID0gbmV3IEZydXN0dW0oKTsKCQl0aGlzLl9mcmFtZUV4dGVudHMgPSBuZXcgVmVjdG9yMiggMSwgMSApOwoKCQl0aGlzLl92aWV3cG9ydENvdW50ID0gMTsKCgkJdGhpcy5fdmlld3BvcnRzID0gWwoKCQkJbmV3IFZlY3RvcjQoIDAsIDAsIDEsIDEgKQoKCQldOwoKCX0KCglnZXRWaWV3cG9ydENvdW50KCkgewoKCQlyZXR1cm4gdGhpcy5fdmlld3BvcnRDb3VudDsKCgl9CgoJZ2V0RnJ1c3R1bSgpIHsKCgkJcmV0dXJuIHRoaXMuX2ZydXN0dW07CgoJfQoKCXVwZGF0ZU1hdHJpY2VzKCBsaWdodCApIHsKCgkJY29uc3Qgc2hhZG93Q2FtZXJhID0gdGhpcy5jYW1lcmE7CgkJY29uc3Qgc2hhZG93TWF0cml4ID0gdGhpcy5tYXRyaXg7CgoJCV9saWdodFBvc2l0aW9uV29ybGQkMS5zZXRGcm9tTWF0cml4UG9zaXRpb24oIGxpZ2h0Lm1hdHJpeFdvcmxkICk7CgkJc2hhZG93Q2FtZXJhLnBvc2l0aW9uLmNvcHkoIF9saWdodFBvc2l0aW9uV29ybGQkMSApOwoKCQlfbG9va1RhcmdldCQxLnNldEZyb21NYXRyaXhQb3NpdGlvbiggbGlnaHQudGFyZ2V0Lm1hdHJpeFdvcmxkICk7CgkJc2hhZG93Q2FtZXJhLmxvb2tBdCggX2xvb2tUYXJnZXQkMSApOwoJCXNoYWRvd0NhbWVyYS51cGRhdGVNYXRyaXhXb3JsZCgpOwoKCQlfcHJvalNjcmVlbk1hdHJpeCQxLm11bHRpcGx5TWF0cmljZXMoIHNoYWRvd0NhbWVyYS5wcm9qZWN0aW9uTWF0cml4LCBzaGFkb3dDYW1lcmEubWF0cml4V29ybGRJbnZlcnNlICk7CgkJdGhpcy5fZnJ1c3R1bS5zZXRGcm9tUHJvamVjdGlvbk1hdHJpeCggX3Byb2pTY3JlZW5NYXRyaXgkMSApOwoKCQlzaGFkb3dNYXRyaXguc2V0KAoJCQkwLjUsIDAuMCwgMC4wLCAwLjUsCgkJCTAuMCwgMC41LCAwLjAsIDAuNSwKCQkJMC4wLCAwLjAsIDAuNSwgMC41LAoJCQkwLjAsIDAuMCwgMC4wLCAxLjAKCQkpOwoKCQlzaGFkb3dNYXRyaXgubXVsdGlwbHkoIF9wcm9qU2NyZWVuTWF0cml4JDEgKTsKCgl9CgoJZ2V0Vmlld3BvcnQoIHZpZXdwb3J0SW5kZXggKSB7CgoJCXJldHVybiB0aGlzLl92aWV3cG9ydHNbIHZpZXdwb3J0SW5kZXggXTsKCgl9CgoJZ2V0RnJhbWVFeHRlbnRzKCkgewoKCQlyZXR1cm4gdGhpcy5fZnJhbWVFeHRlbnRzOwoKCX0KCglkaXNwb3NlKCkgewoKCQlpZiAoIHRoaXMubWFwICkgewoKCQkJdGhpcy5tYXAuZGlzcG9zZSgpOwoKCQl9CgoJCWlmICggdGhpcy5tYXBQYXNzICkgewoKCQkJdGhpcy5tYXBQYXNzLmRpc3Bvc2UoKTsKCgkJfQoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXRoaXMuY2FtZXJhID0gc291cmNlLmNhbWVyYS5jbG9uZSgpOwoKCQl0aGlzLmJpYXMgPSBzb3VyY2UuYmlhczsKCQl0aGlzLnJhZGl1cyA9IHNvdXJjZS5yYWRpdXM7CgoJCXRoaXMubWFwU2l6ZS5jb3B5KCBzb3VyY2UubWFwU2l6ZSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkoIHRoaXMgKTsKCgl9CgoJdG9KU09OKCkgewoKCQljb25zdCBvYmplY3QgPSB7fTsKCgkJaWYgKCB0aGlzLmJpYXMgIT09IDAgKSBvYmplY3QuYmlhcyA9IHRoaXMuYmlhczsKCQlpZiAoIHRoaXMubm9ybWFsQmlhcyAhPT0gMCApIG9iamVjdC5ub3JtYWxCaWFzID0gdGhpcy5ub3JtYWxCaWFzOwoJCWlmICggdGhpcy5yYWRpdXMgIT09IDEgKSBvYmplY3QucmFkaXVzID0gdGhpcy5yYWRpdXM7CgkJaWYgKCB0aGlzLm1hcFNpemUueCAhPT0gNTEyIHx8IHRoaXMubWFwU2l6ZS55ICE9PSA1MTIgKSBvYmplY3QubWFwU2l6ZSA9IHRoaXMubWFwU2l6ZS50b0FycmF5KCk7CgoJCW9iamVjdC5jYW1lcmEgPSB0aGlzLmNhbWVyYS50b0pTT04oIGZhbHNlICkub2JqZWN0OwoJCWRlbGV0ZSBvYmplY3QuY2FtZXJhLm1hdHJpeDsKCgkJcmV0dXJuIG9iamVjdDsKCgl9Cgp9CgpjbGFzcyBTcG90TGlnaHRTaGFkb3cgZXh0ZW5kcyBMaWdodFNoYWRvdyB7CgoJY29uc3RydWN0b3IoKSB7CgoJCXN1cGVyKCBuZXcgUGVyc3BlY3RpdmVDYW1lcmEoIDUwLCAxLCAwLjUsIDUwMCApICk7CgoJCXRoaXMuaXNTcG90TGlnaHRTaGFkb3cgPSB0cnVlOwoKCQl0aGlzLmZvY3VzID0gMTsKCgl9CgoJdXBkYXRlTWF0cmljZXMoIGxpZ2h0ICkgewoKCQljb25zdCBjYW1lcmEgPSB0aGlzLmNhbWVyYTsKCgkJY29uc3QgZm92ID0gUkFEMkRFRyAqIDIgKiBsaWdodC5hbmdsZSAqIHRoaXMuZm9jdXM7CgkJY29uc3QgYXNwZWN0ID0gdGhpcy5tYXBTaXplLndpZHRoIC8gdGhpcy5tYXBTaXplLmhlaWdodDsKCQljb25zdCBmYXIgPSBsaWdodC5kaXN0YW5jZSB8fCBjYW1lcmEuZmFyOwoKCQlpZiAoIGZvdiAhPT0gY2FtZXJhLmZvdiB8fCBhc3BlY3QgIT09IGNhbWVyYS5hc3BlY3QgfHwgZmFyICE9PSBjYW1lcmEuZmFyICkgewoKCQkJY2FtZXJhLmZvdiA9IGZvdjsKCQkJY2FtZXJhLmFzcGVjdCA9IGFzcGVjdDsKCQkJY2FtZXJhLmZhciA9IGZhcjsKCQkJY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKCgkJfQoKCQlzdXBlci51cGRhdGVNYXRyaWNlcyggbGlnaHQgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy5mb2N1cyA9IHNvdXJjZS5mb2N1czsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKY2xhc3MgU3BvdExpZ2h0IGV4dGVuZHMgTGlnaHQgewoKCWNvbnN0cnVjdG9yKCBjb2xvciwgaW50ZW5zaXR5LCBkaXN0YW5jZSA9IDAsIGFuZ2xlID0gTWF0aC5QSSAvIDMsIHBlbnVtYnJhID0gMCwgZGVjYXkgPSAyICkgewoKCQlzdXBlciggY29sb3IsIGludGVuc2l0eSApOwoKCQl0aGlzLmlzU3BvdExpZ2h0ID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ1Nwb3RMaWdodCc7CgoJCXRoaXMucG9zaXRpb24uY29weSggT2JqZWN0M0QuREVGQVVMVF9VUCApOwoJCXRoaXMudXBkYXRlTWF0cml4KCk7CgoJCXRoaXMudGFyZ2V0ID0gbmV3IE9iamVjdDNEKCk7CgoJCXRoaXMuZGlzdGFuY2UgPSBkaXN0YW5jZTsKCQl0aGlzLmFuZ2xlID0gYW5nbGU7CgkJdGhpcy5wZW51bWJyYSA9IHBlbnVtYnJhOwoJCXRoaXMuZGVjYXkgPSBkZWNheTsKCgkJdGhpcy5tYXAgPSBudWxsOwoKCQl0aGlzLnNoYWRvdyA9IG5ldyBTcG90TGlnaHRTaGFkb3coKTsKCgl9CgoJZ2V0IHBvd2VyKCkgewoKCQkvLyBjb21wdXRlIHRoZSBsaWdodCdzIGx1bWlub3VzIHBvd2VyIChpbiBsdW1lbnMpIGZyb20gaXRzIGludGVuc2l0eSAoaW4gY2FuZGVsYSkKCQkvLyBieSBjb252ZW50aW9uIGZvciBhIHNwb3RsaWdodCwgbHVtaW5vdXMgcG93ZXIgKGxtKSA9IM+AICogbHVtaW5vdXMgaW50ZW5zaXR5IChjZCkKCQlyZXR1cm4gdGhpcy5pbnRlbnNpdHkgKiBNYXRoLlBJOwoKCX0KCglzZXQgcG93ZXIoIHBvd2VyICkgewoKCQkvLyBzZXQgdGhlIGxpZ2h0J3MgaW50ZW5zaXR5IChpbiBjYW5kZWxhKSBmcm9tIHRoZSBkZXNpcmVkIGx1bWlub3VzIHBvd2VyIChpbiBsdW1lbnMpCgkJdGhpcy5pbnRlbnNpdHkgPSBwb3dlciAvIE1hdGguUEk7CgoJfQoKCWRpc3Bvc2UoKSB7CgoJCXRoaXMuc2hhZG93LmRpc3Bvc2UoKTsKCgl9CgoJY29weSggc291cmNlLCByZWN1cnNpdmUgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICk7CgoJCXRoaXMuZGlzdGFuY2UgPSBzb3VyY2UuZGlzdGFuY2U7CgkJdGhpcy5hbmdsZSA9IHNvdXJjZS5hbmdsZTsKCQl0aGlzLnBlbnVtYnJhID0gc291cmNlLnBlbnVtYnJhOwoJCXRoaXMuZGVjYXkgPSBzb3VyY2UuZGVjYXk7CgoJCXRoaXMudGFyZ2V0ID0gc291cmNlLnRhcmdldC5jbG9uZSgpOwoKCQl0aGlzLnNoYWRvdyA9IHNvdXJjZS5zaGFkb3cuY2xvbmUoKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKY29uc3QgX3Byb2pTY3JlZW5NYXRyaXggPSAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXg0KCk7CmNvbnN0IF9saWdodFBvc2l0aW9uV29ybGQgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9sb29rVGFyZ2V0ID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwoKY2xhc3MgUG9pbnRMaWdodFNoYWRvdyBleHRlbmRzIExpZ2h0U2hhZG93IHsKCgljb25zdHJ1Y3RvcigpIHsKCgkJc3VwZXIoIG5ldyBQZXJzcGVjdGl2ZUNhbWVyYSggOTAsIDEsIDAuNSwgNTAwICkgKTsKCgkJdGhpcy5pc1BvaW50TGlnaHRTaGFkb3cgPSB0cnVlOwoKCQl0aGlzLl9mcmFtZUV4dGVudHMgPSBuZXcgVmVjdG9yMiggNCwgMiApOwoKCQl0aGlzLl92aWV3cG9ydENvdW50ID0gNjsKCgkJdGhpcy5fdmlld3BvcnRzID0gWwoJCQkvLyBUaGVzZSB2aWV3cG9ydHMgbWFwIGEgY3ViZS1tYXAgb250byBhIDJEIHRleHR1cmUgd2l0aCB0aGUKCQkJLy8gZm9sbG93aW5nIG9yaWVudGF0aW9uOgoJCQkvLwoJCQkvLyAgeHpYWgoJCQkvLyAgIHkgWQoJCQkvLwoJCQkvLyBYIC0gUG9zaXRpdmUgeCBkaXJlY3Rpb24KCQkJLy8geCAtIE5lZ2F0aXZlIHggZGlyZWN0aW9uCgkJCS8vIFkgLSBQb3NpdGl2ZSB5IGRpcmVjdGlvbgoJCQkvLyB5IC0gTmVnYXRpdmUgeSBkaXJlY3Rpb24KCQkJLy8gWiAtIFBvc2l0aXZlIHogZGlyZWN0aW9uCgkJCS8vIHogLSBOZWdhdGl2ZSB6IGRpcmVjdGlvbgoKCQkJLy8gcG9zaXRpdmUgWAoJCQluZXcgVmVjdG9yNCggMiwgMSwgMSwgMSApLAoJCQkvLyBuZWdhdGl2ZSBYCgkJCW5ldyBWZWN0b3I0KCAwLCAxLCAxLCAxICksCgkJCS8vIHBvc2l0aXZlIFoKCQkJbmV3IFZlY3RvcjQoIDMsIDEsIDEsIDEgKSwKCQkJLy8gbmVnYXRpdmUgWgoJCQluZXcgVmVjdG9yNCggMSwgMSwgMSwgMSApLAoJCQkvLyBwb3NpdGl2ZSBZCgkJCW5ldyBWZWN0b3I0KCAzLCAwLCAxLCAxICksCgkJCS8vIG5lZ2F0aXZlIFkKCQkJbmV3IFZlY3RvcjQoIDEsIDAsIDEsIDEgKQoJCV07CgoJCXRoaXMuX2N1YmVEaXJlY3Rpb25zID0gWwoJCQluZXcgVmVjdG9yMyggMSwgMCwgMCApLCBuZXcgVmVjdG9yMyggLSAxLCAwLCAwICksIG5ldyBWZWN0b3IzKCAwLCAwLCAxICksCgkJCW5ldyBWZWN0b3IzKCAwLCAwLCAtIDEgKSwgbmV3IFZlY3RvcjMoIDAsIDEsIDAgKSwgbmV3IFZlY3RvcjMoIDAsIC0gMSwgMCApCgkJXTsKCgkJdGhpcy5fY3ViZVVwcyA9IFsKCQkJbmV3IFZlY3RvcjMoIDAsIDEsIDAgKSwgbmV3IFZlY3RvcjMoIDAsIDEsIDAgKSwgbmV3IFZlY3RvcjMoIDAsIDEsIDAgKSwKCQkJbmV3IFZlY3RvcjMoIDAsIDEsIDAgKSwgbmV3IFZlY3RvcjMoIDAsIDAsIDEgKSwJbmV3IFZlY3RvcjMoIDAsIDAsIC0gMSApCgkJXTsKCgl9CgoJdXBkYXRlTWF0cmljZXMoIGxpZ2h0LCB2aWV3cG9ydEluZGV4ID0gMCApIHsKCgkJY29uc3QgY2FtZXJhID0gdGhpcy5jYW1lcmE7CgkJY29uc3Qgc2hhZG93TWF0cml4ID0gdGhpcy5tYXRyaXg7CgoJCWNvbnN0IGZhciA9IGxpZ2h0LmRpc3RhbmNlIHx8IGNhbWVyYS5mYXI7CgoJCWlmICggZmFyICE9PSBjYW1lcmEuZmFyICkgewoKCQkJY2FtZXJhLmZhciA9IGZhcjsKCQkJY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKCgkJfQoKCQlfbGlnaHRQb3NpdGlvbldvcmxkLnNldEZyb21NYXRyaXhQb3NpdGlvbiggbGlnaHQubWF0cml4V29ybGQgKTsKCQljYW1lcmEucG9zaXRpb24uY29weSggX2xpZ2h0UG9zaXRpb25Xb3JsZCApOwoKCQlfbG9va1RhcmdldC5jb3B5KCBjYW1lcmEucG9zaXRpb24gKTsKCQlfbG9va1RhcmdldC5hZGQoIHRoaXMuX2N1YmVEaXJlY3Rpb25zWyB2aWV3cG9ydEluZGV4IF0gKTsKCQljYW1lcmEudXAuY29weSggdGhpcy5fY3ViZVVwc1sgdmlld3BvcnRJbmRleCBdICk7CgkJY2FtZXJhLmxvb2tBdCggX2xvb2tUYXJnZXQgKTsKCQljYW1lcmEudXBkYXRlTWF0cml4V29ybGQoKTsKCgkJc2hhZG93TWF0cml4Lm1ha2VUcmFuc2xhdGlvbiggLSBfbGlnaHRQb3NpdGlvbldvcmxkLngsIC0gX2xpZ2h0UG9zaXRpb25Xb3JsZC55LCAtIF9saWdodFBvc2l0aW9uV29ybGQueiApOwoKCQlfcHJvalNjcmVlbk1hdHJpeC5tdWx0aXBseU1hdHJpY2VzKCBjYW1lcmEucHJvamVjdGlvbk1hdHJpeCwgY2FtZXJhLm1hdHJpeFdvcmxkSW52ZXJzZSApOwoJCXRoaXMuX2ZydXN0dW0uc2V0RnJvbVByb2plY3Rpb25NYXRyaXgoIF9wcm9qU2NyZWVuTWF0cml4ICk7CgoJfQoKfQoKY2xhc3MgUG9pbnRMaWdodCBleHRlbmRzIExpZ2h0IHsKCgljb25zdHJ1Y3RvciggY29sb3IsIGludGVuc2l0eSwgZGlzdGFuY2UgPSAwLCBkZWNheSA9IDIgKSB7CgoJCXN1cGVyKCBjb2xvciwgaW50ZW5zaXR5ICk7CgoJCXRoaXMuaXNQb2ludExpZ2h0ID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ1BvaW50TGlnaHQnOwoKCQl0aGlzLmRpc3RhbmNlID0gZGlzdGFuY2U7CgkJdGhpcy5kZWNheSA9IGRlY2F5OwoKCQl0aGlzLnNoYWRvdyA9IG5ldyBQb2ludExpZ2h0U2hhZG93KCk7CgoJfQoKCWdldCBwb3dlcigpIHsKCgkJLy8gY29tcHV0ZSB0aGUgbGlnaHQncyBsdW1pbm91cyBwb3dlciAoaW4gbHVtZW5zKSBmcm9tIGl0cyBpbnRlbnNpdHkgKGluIGNhbmRlbGEpCgkJLy8gZm9yIGFuIGlzb3Ryb3BpYyBsaWdodCBzb3VyY2UsIGx1bWlub3VzIHBvd2VyIChsbSkgPSA0IM+AIGx1bWlub3VzIGludGVuc2l0eSAoY2QpCgkJcmV0dXJuIHRoaXMuaW50ZW5zaXR5ICogNCAqIE1hdGguUEk7CgoJfQoKCXNldCBwb3dlciggcG93ZXIgKSB7CgoJCS8vIHNldCB0aGUgbGlnaHQncyBpbnRlbnNpdHkgKGluIGNhbmRlbGEpIGZyb20gdGhlIGRlc2lyZWQgbHVtaW5vdXMgcG93ZXIgKGluIGx1bWVucykKCQl0aGlzLmludGVuc2l0eSA9IHBvd2VyIC8gKCA0ICogTWF0aC5QSSApOwoKCX0KCglkaXNwb3NlKCkgewoKCQl0aGlzLnNoYWRvdy5kaXNwb3NlKCk7CgoJfQoKCWNvcHkoIHNvdXJjZSwgcmVjdXJzaXZlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApOwoKCQl0aGlzLmRpc3RhbmNlID0gc291cmNlLmRpc3RhbmNlOwoJCXRoaXMuZGVjYXkgPSBzb3VyY2UuZGVjYXk7CgoJCXRoaXMuc2hhZG93ID0gc291cmNlLnNoYWRvdy5jbG9uZSgpOwoKCQlyZXR1cm4gdGhpczsKCgl9Cgp9CgpjbGFzcyBEaXJlY3Rpb25hbExpZ2h0U2hhZG93IGV4dGVuZHMgTGlnaHRTaGFkb3cgewoKCWNvbnN0cnVjdG9yKCkgewoKCQlzdXBlciggbmV3IE9ydGhvZ3JhcGhpY0NhbWVyYSggLSA1LCA1LCA1LCAtIDUsIDAuNSwgNTAwICkgKTsKCgkJdGhpcy5pc0RpcmVjdGlvbmFsTGlnaHRTaGFkb3cgPSB0cnVlOwoKCX0KCn0KCmNsYXNzIERpcmVjdGlvbmFsTGlnaHQgZXh0ZW5kcyBMaWdodCB7CgoJY29uc3RydWN0b3IoIGNvbG9yLCBpbnRlbnNpdHkgKSB7CgoJCXN1cGVyKCBjb2xvciwgaW50ZW5zaXR5ICk7CgoJCXRoaXMuaXNEaXJlY3Rpb25hbExpZ2h0ID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ0RpcmVjdGlvbmFsTGlnaHQnOwoKCQl0aGlzLnBvc2l0aW9uLmNvcHkoIE9iamVjdDNELkRFRkFVTFRfVVAgKTsKCQl0aGlzLnVwZGF0ZU1hdHJpeCgpOwoKCQl0aGlzLnRhcmdldCA9IG5ldyBPYmplY3QzRCgpOwoKCQl0aGlzLnNoYWRvdyA9IG5ldyBEaXJlY3Rpb25hbExpZ2h0U2hhZG93KCk7CgoJfQoKCWRpc3Bvc2UoKSB7CgoJCXRoaXMuc2hhZG93LmRpc3Bvc2UoKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UgKTsKCgkJdGhpcy50YXJnZXQgPSBzb3VyY2UudGFyZ2V0LmNsb25lKCk7CgkJdGhpcy5zaGFkb3cgPSBzb3VyY2Uuc2hhZG93LmNsb25lKCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIEFtYmllbnRMaWdodCBleHRlbmRzIExpZ2h0IHsKCgljb25zdHJ1Y3RvciggY29sb3IsIGludGVuc2l0eSApIHsKCgkJc3VwZXIoIGNvbG9yLCBpbnRlbnNpdHkgKTsKCgkJdGhpcy5pc0FtYmllbnRMaWdodCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdBbWJpZW50TGlnaHQnOwoKCX0KCn0KCmNsYXNzIFJlY3RBcmVhTGlnaHQgZXh0ZW5kcyBMaWdodCB7CgoJY29uc3RydWN0b3IoIGNvbG9yLCBpbnRlbnNpdHksIHdpZHRoID0gMTAsIGhlaWdodCA9IDEwICkgewoKCQlzdXBlciggY29sb3IsIGludGVuc2l0eSApOwoKCQl0aGlzLmlzUmVjdEFyZWFMaWdodCA9IHRydWU7CgoJCXRoaXMudHlwZSA9ICdSZWN0QXJlYUxpZ2h0JzsKCgkJdGhpcy53aWR0aCA9IHdpZHRoOwoJCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKCX0KCglnZXQgcG93ZXIoKSB7CgoJCS8vIGNvbXB1dGUgdGhlIGxpZ2h0J3MgbHVtaW5vdXMgcG93ZXIgKGluIGx1bWVucykgZnJvbSBpdHMgaW50ZW5zaXR5IChpbiBuaXRzKQoJCXJldHVybiB0aGlzLmludGVuc2l0eSAqIHRoaXMud2lkdGggKiB0aGlzLmhlaWdodCAqIE1hdGguUEk7CgoJfQoKCXNldCBwb3dlciggcG93ZXIgKSB7CgoJCS8vIHNldCB0aGUgbGlnaHQncyBpbnRlbnNpdHkgKGluIG5pdHMpIGZyb20gdGhlIGRlc2lyZWQgbHVtaW5vdXMgcG93ZXIgKGluIGx1bWVucykKCQl0aGlzLmludGVuc2l0eSA9IHBvd2VyIC8gKCB0aGlzLndpZHRoICogdGhpcy5oZWlnaHQgKiBNYXRoLlBJICk7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMud2lkdGggPSBzb3VyY2Uud2lkdGg7CgkJdGhpcy5oZWlnaHQgPSBzb3VyY2UuaGVpZ2h0OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdG9KU09OKCBtZXRhICkgewoKCQljb25zdCBkYXRhID0gc3VwZXIudG9KU09OKCBtZXRhICk7CgoJCWRhdGEub2JqZWN0LndpZHRoID0gdGhpcy53aWR0aDsKCQlkYXRhLm9iamVjdC5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCgkJcmV0dXJuIGRhdGE7CgoJfQoKfQoKLyoqCiAqIFByaW1hcnkgcmVmZXJlbmNlOgogKiAgIGh0dHBzOi8vZ3JhcGhpY3Muc3RhbmZvcmQuZWR1L3BhcGVycy9lbnZtYXAvZW52bWFwLnBkZgogKgogKiBTZWNvbmRhcnkgcmVmZXJlbmNlOgogKiAgIGh0dHBzOi8vd3d3LnBwc2xvYW4ub3JnL3B1YmxpY2F0aW9ucy9TdHVwaWRTSDM2LnBkZgogKi8KCi8vIDMtYmFuZCBTSCBkZWZpbmVkIGJ5IDkgY29lZmZpY2llbnRzCgpjbGFzcyBTcGhlcmljYWxIYXJtb25pY3MzIHsKCgljb25zdHJ1Y3RvcigpIHsKCgkJdGhpcy5pc1NwaGVyaWNhbEhhcm1vbmljczMgPSB0cnVlOwoKCQl0aGlzLmNvZWZmaWNpZW50cyA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA5OyBpICsrICkgewoKCQkJdGhpcy5jb2VmZmljaWVudHMucHVzaCggbmV3IFZlY3RvcjMoKSApOwoKCQl9CgoJfQoKCXNldCggY29lZmZpY2llbnRzICkgewoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA5OyBpICsrICkgewoKCQkJdGhpcy5jb2VmZmljaWVudHNbIGkgXS5jb3B5KCBjb2VmZmljaWVudHNbIGkgXSApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCgl6ZXJvKCkgewoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA5OyBpICsrICkgewoKCQkJdGhpcy5jb2VmZmljaWVudHNbIGkgXS5zZXQoIDAsIDAsIDAgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJLy8gZ2V0IHRoZSByYWRpYW5jZSBpbiB0aGUgZGlyZWN0aW9uIG9mIHRoZSBub3JtYWwKCS8vIHRhcmdldCBpcyBhIFZlY3RvcjMKCWdldEF0KCBub3JtYWwsIHRhcmdldCApIHsKCgkJLy8gbm9ybWFsIGlzIGFzc3VtZWQgdG8gYmUgdW5pdCBsZW5ndGgKCgkJY29uc3QgeCA9IG5vcm1hbC54LCB5ID0gbm9ybWFsLnksIHogPSBub3JtYWwuejsKCgkJY29uc3QgY29lZmYgPSB0aGlzLmNvZWZmaWNpZW50czsKCgkJLy8gYmFuZCAwCgkJdGFyZ2V0LmNvcHkoIGNvZWZmWyAwIF0gKS5tdWx0aXBseVNjYWxhciggMC4yODIwOTUgKTsKCgkJLy8gYmFuZCAxCgkJdGFyZ2V0LmFkZFNjYWxlZFZlY3RvciggY29lZmZbIDEgXSwgMC40ODg2MDMgKiB5ICk7CgkJdGFyZ2V0LmFkZFNjYWxlZFZlY3RvciggY29lZmZbIDIgXSwgMC40ODg2MDMgKiB6ICk7CgkJdGFyZ2V0LmFkZFNjYWxlZFZlY3RvciggY29lZmZbIDMgXSwgMC40ODg2MDMgKiB4ICk7CgoJCS8vIGJhbmQgMgoJCXRhcmdldC5hZGRTY2FsZWRWZWN0b3IoIGNvZWZmWyA0IF0sIDEuMDkyNTQ4ICogKCB4ICogeSApICk7CgkJdGFyZ2V0LmFkZFNjYWxlZFZlY3RvciggY29lZmZbIDUgXSwgMS4wOTI1NDggKiAoIHkgKiB6ICkgKTsKCQl0YXJnZXQuYWRkU2NhbGVkVmVjdG9yKCBjb2VmZlsgNiBdLCAwLjMxNTM5MiAqICggMy4wICogeiAqIHogLSAxLjAgKSApOwoJCXRhcmdldC5hZGRTY2FsZWRWZWN0b3IoIGNvZWZmWyA3IF0sIDEuMDkyNTQ4ICogKCB4ICogeiApICk7CgkJdGFyZ2V0LmFkZFNjYWxlZFZlY3RvciggY29lZmZbIDggXSwgMC41NDYyNzQgKiAoIHggKiB4IC0geSAqIHkgKSApOwoKCQlyZXR1cm4gdGFyZ2V0OwoKCX0KCgkvLyBnZXQgdGhlIGlycmFkaWFuY2UgKHJhZGlhbmNlIGNvbnZvbHZlZCB3aXRoIGNvc2luZSBsb2JlKSBpbiB0aGUgZGlyZWN0aW9uIG9mIHRoZSBub3JtYWwKCS8vIHRhcmdldCBpcyBhIFZlY3RvcjMKCS8vIGh0dHBzOi8vZ3JhcGhpY3Muc3RhbmZvcmQuZWR1L3BhcGVycy9lbnZtYXAvZW52bWFwLnBkZgoJZ2V0SXJyYWRpYW5jZUF0KCBub3JtYWwsIHRhcmdldCApIHsKCgkJLy8gbm9ybWFsIGlzIGFzc3VtZWQgdG8gYmUgdW5pdCBsZW5ndGgKCgkJY29uc3QgeCA9IG5vcm1hbC54LCB5ID0gbm9ybWFsLnksIHogPSBub3JtYWwuejsKCgkJY29uc3QgY29lZmYgPSB0aGlzLmNvZWZmaWNpZW50czsKCgkJLy8gYmFuZCAwCgkJdGFyZ2V0LmNvcHkoIGNvZWZmWyAwIF0gKS5tdWx0aXBseVNjYWxhciggMC44ODYyMjcgKTsgLy8gz4AgKiAwLjI4MjA5NQoKCQkvLyBiYW5kIDEKCQl0YXJnZXQuYWRkU2NhbGVkVmVjdG9yKCBjb2VmZlsgMSBdLCAyLjAgKiAwLjUxMTY2NCAqIHkgKTsgLy8gKCAyICogz4AgLyAzICkgKiAwLjQ4ODYwMwoJCXRhcmdldC5hZGRTY2FsZWRWZWN0b3IoIGNvZWZmWyAyIF0sIDIuMCAqIDAuNTExNjY0ICogeiApOwoJCXRhcmdldC5hZGRTY2FsZWRWZWN0b3IoIGNvZWZmWyAzIF0sIDIuMCAqIDAuNTExNjY0ICogeCApOwoKCQkvLyBiYW5kIDIKCQl0YXJnZXQuYWRkU2NhbGVkVmVjdG9yKCBjb2VmZlsgNCBdLCAyLjAgKiAwLjQyOTA0MyAqIHggKiB5ICk7IC8vICggz4AgLyA0ICkgKiAxLjA5MjU0OAoJCXRhcmdldC5hZGRTY2FsZWRWZWN0b3IoIGNvZWZmWyA1IF0sIDIuMCAqIDAuNDI5MDQzICogeSAqIHogKTsKCQl0YXJnZXQuYWRkU2NhbGVkVmVjdG9yKCBjb2VmZlsgNiBdLCAwLjc0MzEyNSAqIHogKiB6IC0gMC4yNDc3MDggKTsgLy8gKCDPgCAvIDQgKSAqIDAuMzE1MzkyICogMwoJCXRhcmdldC5hZGRTY2FsZWRWZWN0b3IoIGNvZWZmWyA3IF0sIDIuMCAqIDAuNDI5MDQzICogeCAqIHogKTsKCQl0YXJnZXQuYWRkU2NhbGVkVmVjdG9yKCBjb2VmZlsgOCBdLCAwLjQyOTA0MyAqICggeCAqIHggLSB5ICogeSApICk7IC8vICggz4AgLyA0ICkgKiAwLjU0NjI3NAoKCQlyZXR1cm4gdGFyZ2V0OwoKCX0KCglhZGQoIHNoICkgewoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA5OyBpICsrICkgewoKCQkJdGhpcy5jb2VmZmljaWVudHNbIGkgXS5hZGQoIHNoLmNvZWZmaWNpZW50c1sgaSBdICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWFkZFNjYWxlZFNIKCBzaCwgcyApIHsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgOTsgaSArKyApIHsKCgkJCXRoaXMuY29lZmZpY2llbnRzWyBpIF0uYWRkU2NhbGVkVmVjdG9yKCBzaC5jb2VmZmljaWVudHNbIGkgXSwgcyApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglzY2FsZSggcyApIHsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgOTsgaSArKyApIHsKCgkJCXRoaXMuY29lZmZpY2llbnRzWyBpIF0ubXVsdGlwbHlTY2FsYXIoIHMgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbGVycCggc2gsIGFscGhhICkgewoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCA5OyBpICsrICkgewoKCQkJdGhpcy5jb2VmZmljaWVudHNbIGkgXS5sZXJwKCBzaC5jb2VmZmljaWVudHNbIGkgXSwgYWxwaGEgKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXF1YWxzKCBzaCApIHsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgOTsgaSArKyApIHsKCgkJCWlmICggISB0aGlzLmNvZWZmaWNpZW50c1sgaSBdLmVxdWFscyggc2guY29lZmZpY2llbnRzWyBpIF0gKSApIHsKCgkJCQlyZXR1cm4gZmFsc2U7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIHRydWU7CgoJfQoKCWNvcHkoIHNoICkgewoKCQlyZXR1cm4gdGhpcy5zZXQoIHNoLmNvZWZmaWNpZW50cyApOwoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKCkuY29weSggdGhpcyApOwoKCX0KCglmcm9tQXJyYXkoIGFycmF5LCBvZmZzZXQgPSAwICkgewoKCQljb25zdCBjb2VmZmljaWVudHMgPSB0aGlzLmNvZWZmaWNpZW50czsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgOTsgaSArKyApIHsKCgkJCWNvZWZmaWNpZW50c1sgaSBdLmZyb21BcnJheSggYXJyYXksIG9mZnNldCArICggaSAqIDMgKSApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0FycmF5KCBhcnJheSA9IFtdLCBvZmZzZXQgPSAwICkgewoKCQljb25zdCBjb2VmZmljaWVudHMgPSB0aGlzLmNvZWZmaWNpZW50czsKCgkJZm9yICggbGV0IGkgPSAwOyBpIDwgOTsgaSArKyApIHsKCgkJCWNvZWZmaWNpZW50c1sgaSBdLnRvQXJyYXkoIGFycmF5LCBvZmZzZXQgKyAoIGkgKiAzICkgKTsKCgkJfQoKCQlyZXR1cm4gYXJyYXk7CgoJfQoKCS8vIGV2YWx1YXRlIHRoZSBiYXNpcyBmdW5jdGlvbnMKCS8vIHNoQmFzaXMgaXMgYW4gQXJyYXlbIDkgXQoJc3RhdGljIGdldEJhc2lzQXQoIG5vcm1hbCwgc2hCYXNpcyApIHsKCgkJLy8gbm9ybWFsIGlzIGFzc3VtZWQgdG8gYmUgdW5pdCBsZW5ndGgKCgkJY29uc3QgeCA9IG5vcm1hbC54LCB5ID0gbm9ybWFsLnksIHogPSBub3JtYWwuejsKCgkJLy8gYmFuZCAwCgkJc2hCYXNpc1sgMCBdID0gMC4yODIwOTU7CgoJCS8vIGJhbmQgMQoJCXNoQmFzaXNbIDEgXSA9IDAuNDg4NjAzICogeTsKCQlzaEJhc2lzWyAyIF0gPSAwLjQ4ODYwMyAqIHo7CgkJc2hCYXNpc1sgMyBdID0gMC40ODg2MDMgKiB4OwoKCQkvLyBiYW5kIDIKCQlzaEJhc2lzWyA0IF0gPSAxLjA5MjU0OCAqIHggKiB5OwoJCXNoQmFzaXNbIDUgXSA9IDEuMDkyNTQ4ICogeSAqIHo7CgkJc2hCYXNpc1sgNiBdID0gMC4zMTUzOTIgKiAoIDMgKiB6ICogeiAtIDEgKTsKCQlzaEJhc2lzWyA3IF0gPSAxLjA5MjU0OCAqIHggKiB6OwoJCXNoQmFzaXNbIDggXSA9IDAuNTQ2Mjc0ICogKCB4ICogeCAtIHkgKiB5ICk7CgoJfQoKfQoKY2xhc3MgTGlnaHRQcm9iZSBleHRlbmRzIExpZ2h0IHsKCgljb25zdHJ1Y3Rvciggc2ggPSBuZXcgU3BoZXJpY2FsSGFybW9uaWNzMygpLCBpbnRlbnNpdHkgPSAxICkgewoKCQlzdXBlciggdW5kZWZpbmVkLCBpbnRlbnNpdHkgKTsKCgkJdGhpcy5pc0xpZ2h0UHJvYmUgPSB0cnVlOwoKCQl0aGlzLnNoID0gc2g7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlICk7CgoJCXRoaXMuc2guY29weSggc291cmNlLnNoICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglmcm9tSlNPTigganNvbiApIHsKCgkJdGhpcy5pbnRlbnNpdHkgPSBqc29uLmludGVuc2l0eTsgLy8gVE9ETzogTW92ZSB0aGlzIGJpdCB0byBMaWdodC5mcm9tSlNPTigpOwoJCXRoaXMuc2guZnJvbUFycmF5KCBqc29uLnNoICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b0pTT04oIG1ldGEgKSB7CgoJCWNvbnN0IGRhdGEgPSBzdXBlci50b0pTT04oIG1ldGEgKTsKCgkJZGF0YS5vYmplY3Quc2ggPSB0aGlzLnNoLnRvQXJyYXkoKTsKCgkJcmV0dXJuIGRhdGE7CgoJfQoKfQoKY2xhc3MgTWF0ZXJpYWxMb2FkZXIgZXh0ZW5kcyBMb2FkZXIgewoKCWNvbnN0cnVjdG9yKCBtYW5hZ2VyICkgewoKCQlzdXBlciggbWFuYWdlciApOwoJCXRoaXMudGV4dHVyZXMgPSB7fTsKCgl9CgoJbG9hZCggdXJsLCBvbkxvYWQsIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKSB7CgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJY29uc3QgbG9hZGVyID0gbmV3IEZpbGVMb2FkZXIoIHNjb3BlLm1hbmFnZXIgKTsKCQlsb2FkZXIuc2V0UGF0aCggc2NvcGUucGF0aCApOwoJCWxvYWRlci5zZXRSZXF1ZXN0SGVhZGVyKCBzY29wZS5yZXF1ZXN0SGVhZGVyICk7CgkJbG9hZGVyLnNldFdpdGhDcmVkZW50aWFscyggc2NvcGUud2l0aENyZWRlbnRpYWxzICk7CgkJbG9hZGVyLmxvYWQoIHVybCwgZnVuY3Rpb24gKCB0ZXh0ICkgewoKCQkJdHJ5IHsKCgkJCQlvbkxvYWQoIHNjb3BlLnBhcnNlKCBKU09OLnBhcnNlKCB0ZXh0ICkgKSApOwoKCQkJfSBjYXRjaCAoIGUgKSB7CgoJCQkJaWYgKCBvbkVycm9yICkgewoKCQkJCQlvbkVycm9yKCBlICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJY29uc29sZS5lcnJvciggZSApOwoKCQkJCX0KCgkJCQlzY29wZS5tYW5hZ2VyLml0ZW1FcnJvciggdXJsICk7CgoJCQl9CgoJCX0sIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKTsKCgl9CgoJcGFyc2UoIGpzb24gKSB7CgoJCWNvbnN0IHRleHR1cmVzID0gdGhpcy50ZXh0dXJlczsKCgkJZnVuY3Rpb24gZ2V0VGV4dHVyZSggbmFtZSApIHsKCgkJCWlmICggdGV4dHVyZXNbIG5hbWUgXSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLk1hdGVyaWFsTG9hZGVyOiBVbmRlZmluZWQgdGV4dHVyZScsIG5hbWUgKTsKCgkJCX0KCgkJCXJldHVybiB0ZXh0dXJlc1sgbmFtZSBdOwoKCQl9CgoJCWNvbnN0IG1hdGVyaWFsID0gTWF0ZXJpYWxMb2FkZXIuY3JlYXRlTWF0ZXJpYWxGcm9tVHlwZSgganNvbi50eXBlICk7CgoJCWlmICgganNvbi51dWlkICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC51dWlkID0ganNvbi51dWlkOwoJCWlmICgganNvbi5uYW1lICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5uYW1lID0ganNvbi5uYW1lOwoJCWlmICgganNvbi5jb2xvciAhPT0gdW5kZWZpbmVkICYmIG1hdGVyaWFsLmNvbG9yICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5jb2xvci5zZXRIZXgoIGpzb24uY29sb3IgKTsKCQlpZiAoIGpzb24ucm91Z2huZXNzICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5yb3VnaG5lc3MgPSBqc29uLnJvdWdobmVzczsKCQlpZiAoIGpzb24ubWV0YWxuZXNzICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5tZXRhbG5lc3MgPSBqc29uLm1ldGFsbmVzczsKCQlpZiAoIGpzb24uc2hlZW4gIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnNoZWVuID0ganNvbi5zaGVlbjsKCQlpZiAoIGpzb24uc2hlZW5Db2xvciAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuc2hlZW5Db2xvciA9IG5ldyBDb2xvcigpLnNldEhleCgganNvbi5zaGVlbkNvbG9yICk7CgkJaWYgKCBqc29uLnNoZWVuUm91Z2huZXNzICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zaGVlblJvdWdobmVzcyA9IGpzb24uc2hlZW5Sb3VnaG5lc3M7CgkJaWYgKCBqc29uLmVtaXNzaXZlICE9PSB1bmRlZmluZWQgJiYgbWF0ZXJpYWwuZW1pc3NpdmUgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmVtaXNzaXZlLnNldEhleCgganNvbi5lbWlzc2l2ZSApOwoJCWlmICgganNvbi5zcGVjdWxhciAhPT0gdW5kZWZpbmVkICYmIG1hdGVyaWFsLnNwZWN1bGFyICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zcGVjdWxhci5zZXRIZXgoIGpzb24uc3BlY3VsYXIgKTsKCQlpZiAoIGpzb24uc3BlY3VsYXJJbnRlbnNpdHkgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnNwZWN1bGFySW50ZW5zaXR5ID0ganNvbi5zcGVjdWxhckludGVuc2l0eTsKCQlpZiAoIGpzb24uc3BlY3VsYXJDb2xvciAhPT0gdW5kZWZpbmVkICYmIG1hdGVyaWFsLnNwZWN1bGFyQ29sb3IgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnNwZWN1bGFyQ29sb3Iuc2V0SGV4KCBqc29uLnNwZWN1bGFyQ29sb3IgKTsKCQlpZiAoIGpzb24uc2hpbmluZXNzICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zaGluaW5lc3MgPSBqc29uLnNoaW5pbmVzczsKCQlpZiAoIGpzb24uY2xlYXJjb2F0ICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5jbGVhcmNvYXQgPSBqc29uLmNsZWFyY29hdDsKCQlpZiAoIGpzb24uY2xlYXJjb2F0Um91Z2huZXNzICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5jbGVhcmNvYXRSb3VnaG5lc3MgPSBqc29uLmNsZWFyY29hdFJvdWdobmVzczsKCQlpZiAoIGpzb24uaXJpZGVzY2VuY2UgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmlyaWRlc2NlbmNlID0ganNvbi5pcmlkZXNjZW5jZTsKCQlpZiAoIGpzb24uaXJpZGVzY2VuY2VJT1IgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmlyaWRlc2NlbmNlSU9SID0ganNvbi5pcmlkZXNjZW5jZUlPUjsKCQlpZiAoIGpzb24uaXJpZGVzY2VuY2VUaGlja25lc3NSYW5nZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuaXJpZGVzY2VuY2VUaGlja25lc3NSYW5nZSA9IGpzb24uaXJpZGVzY2VuY2VUaGlja25lc3NSYW5nZTsKCQlpZiAoIGpzb24udHJhbnNtaXNzaW9uICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC50cmFuc21pc3Npb24gPSBqc29uLnRyYW5zbWlzc2lvbjsKCQlpZiAoIGpzb24udGhpY2tuZXNzICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC50aGlja25lc3MgPSBqc29uLnRoaWNrbmVzczsKCQlpZiAoIGpzb24uYXR0ZW51YXRpb25EaXN0YW5jZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuYXR0ZW51YXRpb25EaXN0YW5jZSA9IGpzb24uYXR0ZW51YXRpb25EaXN0YW5jZTsKCQlpZiAoIGpzb24uYXR0ZW51YXRpb25Db2xvciAhPT0gdW5kZWZpbmVkICYmIG1hdGVyaWFsLmF0dGVudWF0aW9uQ29sb3IgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmF0dGVudWF0aW9uQ29sb3Iuc2V0SGV4KCBqc29uLmF0dGVudWF0aW9uQ29sb3IgKTsKCQlpZiAoIGpzb24uYW5pc290cm9weSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuYW5pc290cm9weSA9IGpzb24uYW5pc290cm9weTsKCQlpZiAoIGpzb24uYW5pc290cm9weVJvdGF0aW9uICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5hbmlzb3Ryb3B5Um90YXRpb24gPSBqc29uLmFuaXNvdHJvcHlSb3RhdGlvbjsKCQlpZiAoIGpzb24uZm9nICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5mb2cgPSBqc29uLmZvZzsKCQlpZiAoIGpzb24uZmxhdFNoYWRpbmcgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmZsYXRTaGFkaW5nID0ganNvbi5mbGF0U2hhZGluZzsKCQlpZiAoIGpzb24uYmxlbmRpbmcgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmJsZW5kaW5nID0ganNvbi5ibGVuZGluZzsKCQlpZiAoIGpzb24uY29tYmluZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuY29tYmluZSA9IGpzb24uY29tYmluZTsKCQlpZiAoIGpzb24uc2lkZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuc2lkZSA9IGpzb24uc2lkZTsKCQlpZiAoIGpzb24uc2hhZG93U2lkZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuc2hhZG93U2lkZSA9IGpzb24uc2hhZG93U2lkZTsKCQlpZiAoIGpzb24ub3BhY2l0eSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwub3BhY2l0eSA9IGpzb24ub3BhY2l0eTsKCQlpZiAoIGpzb24udHJhbnNwYXJlbnQgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnRyYW5zcGFyZW50ID0ganNvbi50cmFuc3BhcmVudDsKCQlpZiAoIGpzb24uYWxwaGFUZXN0ICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5hbHBoYVRlc3QgPSBqc29uLmFscGhhVGVzdDsKCQlpZiAoIGpzb24uYWxwaGFIYXNoICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5hbHBoYUhhc2ggPSBqc29uLmFscGhhSGFzaDsKCQlpZiAoIGpzb24uZGVwdGhGdW5jICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5kZXB0aEZ1bmMgPSBqc29uLmRlcHRoRnVuYzsKCQlpZiAoIGpzb24uZGVwdGhUZXN0ICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5kZXB0aFRlc3QgPSBqc29uLmRlcHRoVGVzdDsKCQlpZiAoIGpzb24uZGVwdGhXcml0ZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuZGVwdGhXcml0ZSA9IGpzb24uZGVwdGhXcml0ZTsKCQlpZiAoIGpzb24uY29sb3JXcml0ZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuY29sb3JXcml0ZSA9IGpzb24uY29sb3JXcml0ZTsKCQlpZiAoIGpzb24uYmxlbmRTcmMgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmJsZW5kU3JjID0ganNvbi5ibGVuZFNyYzsKCQlpZiAoIGpzb24uYmxlbmREc3QgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmJsZW5kRHN0ID0ganNvbi5ibGVuZERzdDsKCQlpZiAoIGpzb24uYmxlbmRFcXVhdGlvbiAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuYmxlbmRFcXVhdGlvbiA9IGpzb24uYmxlbmRFcXVhdGlvbjsKCQlpZiAoIGpzb24uYmxlbmRTcmNBbHBoYSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuYmxlbmRTcmNBbHBoYSA9IGpzb24uYmxlbmRTcmNBbHBoYTsKCQlpZiAoIGpzb24uYmxlbmREc3RBbHBoYSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuYmxlbmREc3RBbHBoYSA9IGpzb24uYmxlbmREc3RBbHBoYTsKCQlpZiAoIGpzb24uYmxlbmRFcXVhdGlvbkFscGhhICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5ibGVuZEVxdWF0aW9uQWxwaGEgPSBqc29uLmJsZW5kRXF1YXRpb25BbHBoYTsKCQlpZiAoIGpzb24uYmxlbmRDb2xvciAhPT0gdW5kZWZpbmVkICYmIG1hdGVyaWFsLmJsZW5kQ29sb3IgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmJsZW5kQ29sb3Iuc2V0SGV4KCBqc29uLmJsZW5kQ29sb3IgKTsKCQlpZiAoIGpzb24uYmxlbmRBbHBoYSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuYmxlbmRBbHBoYSA9IGpzb24uYmxlbmRBbHBoYTsKCQlpZiAoIGpzb24uc3RlbmNpbFdyaXRlTWFzayAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuc3RlbmNpbFdyaXRlTWFzayA9IGpzb24uc3RlbmNpbFdyaXRlTWFzazsKCQlpZiAoIGpzb24uc3RlbmNpbEZ1bmMgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnN0ZW5jaWxGdW5jID0ganNvbi5zdGVuY2lsRnVuYzsKCQlpZiAoIGpzb24uc3RlbmNpbFJlZiAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuc3RlbmNpbFJlZiA9IGpzb24uc3RlbmNpbFJlZjsKCQlpZiAoIGpzb24uc3RlbmNpbEZ1bmNNYXNrICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zdGVuY2lsRnVuY01hc2sgPSBqc29uLnN0ZW5jaWxGdW5jTWFzazsKCQlpZiAoIGpzb24uc3RlbmNpbEZhaWwgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnN0ZW5jaWxGYWlsID0ganNvbi5zdGVuY2lsRmFpbDsKCQlpZiAoIGpzb24uc3RlbmNpbFpGYWlsICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zdGVuY2lsWkZhaWwgPSBqc29uLnN0ZW5jaWxaRmFpbDsKCQlpZiAoIGpzb24uc3RlbmNpbFpQYXNzICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zdGVuY2lsWlBhc3MgPSBqc29uLnN0ZW5jaWxaUGFzczsKCQlpZiAoIGpzb24uc3RlbmNpbFdyaXRlICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zdGVuY2lsV3JpdGUgPSBqc29uLnN0ZW5jaWxXcml0ZTsKCgkJaWYgKCBqc29uLndpcmVmcmFtZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwud2lyZWZyYW1lID0ganNvbi53aXJlZnJhbWU7CgkJaWYgKCBqc29uLndpcmVmcmFtZUxpbmV3aWR0aCAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwud2lyZWZyYW1lTGluZXdpZHRoID0ganNvbi53aXJlZnJhbWVMaW5ld2lkdGg7CgkJaWYgKCBqc29uLndpcmVmcmFtZUxpbmVjYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLndpcmVmcmFtZUxpbmVjYXAgPSBqc29uLndpcmVmcmFtZUxpbmVjYXA7CgkJaWYgKCBqc29uLndpcmVmcmFtZUxpbmVqb2luICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC53aXJlZnJhbWVMaW5lam9pbiA9IGpzb24ud2lyZWZyYW1lTGluZWpvaW47CgoJCWlmICgganNvbi5yb3RhdGlvbiAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwucm90YXRpb24gPSBqc29uLnJvdGF0aW9uOwoKCQlpZiAoIGpzb24ubGluZXdpZHRoICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5saW5ld2lkdGggPSBqc29uLmxpbmV3aWR0aDsKCQlpZiAoIGpzb24uZGFzaFNpemUgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmRhc2hTaXplID0ganNvbi5kYXNoU2l6ZTsKCQlpZiAoIGpzb24uZ2FwU2l6ZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuZ2FwU2l6ZSA9IGpzb24uZ2FwU2l6ZTsKCQlpZiAoIGpzb24uc2NhbGUgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnNjYWxlID0ganNvbi5zY2FsZTsKCgkJaWYgKCBqc29uLnBvbHlnb25PZmZzZXQgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnBvbHlnb25PZmZzZXQgPSBqc29uLnBvbHlnb25PZmZzZXQ7CgkJaWYgKCBqc29uLnBvbHlnb25PZmZzZXRGYWN0b3IgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnBvbHlnb25PZmZzZXRGYWN0b3IgPSBqc29uLnBvbHlnb25PZmZzZXRGYWN0b3I7CgkJaWYgKCBqc29uLnBvbHlnb25PZmZzZXRVbml0cyAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwucG9seWdvbk9mZnNldFVuaXRzID0ganNvbi5wb2x5Z29uT2Zmc2V0VW5pdHM7CgoJCWlmICgganNvbi5kaXRoZXJpbmcgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmRpdGhlcmluZyA9IGpzb24uZGl0aGVyaW5nOwoKCQlpZiAoIGpzb24uYWxwaGFUb0NvdmVyYWdlICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5hbHBoYVRvQ292ZXJhZ2UgPSBqc29uLmFscGhhVG9Db3ZlcmFnZTsKCQlpZiAoIGpzb24ucHJlbXVsdGlwbGllZEFscGhhICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5wcmVtdWx0aXBsaWVkQWxwaGEgPSBqc29uLnByZW11bHRpcGxpZWRBbHBoYTsKCQlpZiAoIGpzb24uZm9yY2VTaW5nbGVQYXNzICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5mb3JjZVNpbmdsZVBhc3MgPSBqc29uLmZvcmNlU2luZ2xlUGFzczsKCgkJaWYgKCBqc29uLnZpc2libGUgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnZpc2libGUgPSBqc29uLnZpc2libGU7CgoJCWlmICgganNvbi50b25lTWFwcGVkICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC50b25lTWFwcGVkID0ganNvbi50b25lTWFwcGVkOwoKCQlpZiAoIGpzb24udXNlckRhdGEgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnVzZXJEYXRhID0ganNvbi51c2VyRGF0YTsKCgkJaWYgKCBqc29uLnZlcnRleENvbG9ycyAhPT0gdW5kZWZpbmVkICkgewoKCQkJaWYgKCB0eXBlb2YganNvbi52ZXJ0ZXhDb2xvcnMgPT09ICdudW1iZXInICkgewoKCQkJCW1hdGVyaWFsLnZlcnRleENvbG9ycyA9ICgganNvbi52ZXJ0ZXhDb2xvcnMgPiAwICkgPyB0cnVlIDogZmFsc2U7CgoJCQl9IGVsc2UgewoKCQkJCW1hdGVyaWFsLnZlcnRleENvbG9ycyA9IGpzb24udmVydGV4Q29sb3JzOwoKCQkJfQoKCQl9CgoJCS8vIFNoYWRlciBNYXRlcmlhbAoKCQlpZiAoIGpzb24udW5pZm9ybXMgIT09IHVuZGVmaW5lZCApIHsKCgkJCWZvciAoIGNvbnN0IG5hbWUgaW4ganNvbi51bmlmb3JtcyApIHsKCgkJCQljb25zdCB1bmlmb3JtID0ganNvbi51bmlmb3Jtc1sgbmFtZSBdOwoKCQkJCW1hdGVyaWFsLnVuaWZvcm1zWyBuYW1lIF0gPSB7fTsKCgkJCQlzd2l0Y2ggKCB1bmlmb3JtLnR5cGUgKSB7CgoJCQkJCWNhc2UgJ3QnOgoJCQkJCQltYXRlcmlhbC51bmlmb3Jtc1sgbmFtZSBdLnZhbHVlID0gZ2V0VGV4dHVyZSggdW5pZm9ybS52YWx1ZSApOwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAnYyc6CgkJCQkJCW1hdGVyaWFsLnVuaWZvcm1zWyBuYW1lIF0udmFsdWUgPSBuZXcgQ29sb3IoKS5zZXRIZXgoIHVuaWZvcm0udmFsdWUgKTsKCQkJCQkJYnJlYWs7CgoJCQkJCWNhc2UgJ3YyJzoKCQkJCQkJbWF0ZXJpYWwudW5pZm9ybXNbIG5hbWUgXS52YWx1ZSA9IG5ldyBWZWN0b3IyKCkuZnJvbUFycmF5KCB1bmlmb3JtLnZhbHVlICk7CgkJCQkJCWJyZWFrOwoKCQkJCQljYXNlICd2Myc6CgkJCQkJCW1hdGVyaWFsLnVuaWZvcm1zWyBuYW1lIF0udmFsdWUgPSBuZXcgVmVjdG9yMygpLmZyb21BcnJheSggdW5pZm9ybS52YWx1ZSApOwoJCQkJCQlicmVhazsKCgkJCQkJY2FzZSAndjQnOgoJCQkJCQltYXRlcmlhbC51bmlmb3Jtc1sgbmFtZSBdLnZhbHVlID0gbmV3IFZlY3RvcjQoKS5mcm9tQXJyYXkoIHVuaWZvcm0udmFsdWUgKTsKCQkJCQkJYnJlYWs7CgoJCQkJCWNhc2UgJ20zJzoKCQkJCQkJbWF0ZXJpYWwudW5pZm9ybXNbIG5hbWUgXS52YWx1ZSA9IG5ldyBNYXRyaXgzKCkuZnJvbUFycmF5KCB1bmlmb3JtLnZhbHVlICk7CgkJCQkJCWJyZWFrOwoKCQkJCQljYXNlICdtNCc6CgkJCQkJCW1hdGVyaWFsLnVuaWZvcm1zWyBuYW1lIF0udmFsdWUgPSBuZXcgTWF0cml4NCgpLmZyb21BcnJheSggdW5pZm9ybS52YWx1ZSApOwoJCQkJCQlicmVhazsKCgkJCQkJZGVmYXVsdDoKCQkJCQkJbWF0ZXJpYWwudW5pZm9ybXNbIG5hbWUgXS52YWx1ZSA9IHVuaWZvcm0udmFsdWU7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCWlmICgganNvbi5kZWZpbmVzICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5kZWZpbmVzID0ganNvbi5kZWZpbmVzOwoJCWlmICgganNvbi52ZXJ0ZXhTaGFkZXIgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnZlcnRleFNoYWRlciA9IGpzb24udmVydGV4U2hhZGVyOwoJCWlmICgganNvbi5mcmFnbWVudFNoYWRlciAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuZnJhZ21lbnRTaGFkZXIgPSBqc29uLmZyYWdtZW50U2hhZGVyOwoJCWlmICgganNvbi5nbHNsVmVyc2lvbiAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuZ2xzbFZlcnNpb24gPSBqc29uLmdsc2xWZXJzaW9uOwoKCQlpZiAoIGpzb24uZXh0ZW5zaW9ucyAhPT0gdW5kZWZpbmVkICkgewoKCQkJZm9yICggY29uc3Qga2V5IGluIGpzb24uZXh0ZW5zaW9ucyApIHsKCgkJCQltYXRlcmlhbC5leHRlbnNpb25zWyBrZXkgXSA9IGpzb24uZXh0ZW5zaW9uc1sga2V5IF07CgoJCQl9CgoJCX0KCgkJaWYgKCBqc29uLmxpZ2h0cyAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwubGlnaHRzID0ganNvbi5saWdodHM7CgkJaWYgKCBqc29uLmNsaXBwaW5nICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5jbGlwcGluZyA9IGpzb24uY2xpcHBpbmc7CgoJCS8vIGZvciBQb2ludHNNYXRlcmlhbAoKCQlpZiAoIGpzb24uc2l6ZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuc2l6ZSA9IGpzb24uc2l6ZTsKCQlpZiAoIGpzb24uc2l6ZUF0dGVudWF0aW9uICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zaXplQXR0ZW51YXRpb24gPSBqc29uLnNpemVBdHRlbnVhdGlvbjsKCgkJLy8gbWFwcwoKCQlpZiAoIGpzb24ubWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5tYXAgPSBnZXRUZXh0dXJlKCBqc29uLm1hcCApOwoJCWlmICgganNvbi5tYXRjYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLm1hdGNhcCA9IGdldFRleHR1cmUoIGpzb24ubWF0Y2FwICk7CgoJCWlmICgganNvbi5hbHBoYU1hcCAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuYWxwaGFNYXAgPSBnZXRUZXh0dXJlKCBqc29uLmFscGhhTWFwICk7CgoJCWlmICgganNvbi5idW1wTWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5idW1wTWFwID0gZ2V0VGV4dHVyZSgganNvbi5idW1wTWFwICk7CgkJaWYgKCBqc29uLmJ1bXBTY2FsZSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuYnVtcFNjYWxlID0ganNvbi5idW1wU2NhbGU7CgoJCWlmICgganNvbi5ub3JtYWxNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLm5vcm1hbE1hcCA9IGdldFRleHR1cmUoIGpzb24ubm9ybWFsTWFwICk7CgkJaWYgKCBqc29uLm5vcm1hbE1hcFR5cGUgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLm5vcm1hbE1hcFR5cGUgPSBqc29uLm5vcm1hbE1hcFR5cGU7CgkJaWYgKCBqc29uLm5vcm1hbFNjYWxlICE9PSB1bmRlZmluZWQgKSB7CgoJCQlsZXQgbm9ybWFsU2NhbGUgPSBqc29uLm5vcm1hbFNjYWxlOwoKCQkJaWYgKCBBcnJheS5pc0FycmF5KCBub3JtYWxTY2FsZSApID09PSBmYWxzZSApIHsKCgkJCQkvLyBCbGVuZGVyIGV4cG9ydGVyIHVzZWQgdG8gZXhwb3J0IGEgc2NhbGFyLiBTZWUgIzc0NTkKCgkJCQlub3JtYWxTY2FsZSA9IFsgbm9ybWFsU2NhbGUsIG5vcm1hbFNjYWxlIF07CgoJCQl9CgoJCQltYXRlcmlhbC5ub3JtYWxTY2FsZSA9IG5ldyBWZWN0b3IyKCkuZnJvbUFycmF5KCBub3JtYWxTY2FsZSApOwoKCQl9CgoJCWlmICgganNvbi5kaXNwbGFjZW1lbnRNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmRpc3BsYWNlbWVudE1hcCA9IGdldFRleHR1cmUoIGpzb24uZGlzcGxhY2VtZW50TWFwICk7CgkJaWYgKCBqc29uLmRpc3BsYWNlbWVudFNjYWxlICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5kaXNwbGFjZW1lbnRTY2FsZSA9IGpzb24uZGlzcGxhY2VtZW50U2NhbGU7CgkJaWYgKCBqc29uLmRpc3BsYWNlbWVudEJpYXMgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmRpc3BsYWNlbWVudEJpYXMgPSBqc29uLmRpc3BsYWNlbWVudEJpYXM7CgoJCWlmICgganNvbi5yb3VnaG5lc3NNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnJvdWdobmVzc01hcCA9IGdldFRleHR1cmUoIGpzb24ucm91Z2huZXNzTWFwICk7CgkJaWYgKCBqc29uLm1ldGFsbmVzc01hcCAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwubWV0YWxuZXNzTWFwID0gZ2V0VGV4dHVyZSgganNvbi5tZXRhbG5lc3NNYXAgKTsKCgkJaWYgKCBqc29uLmVtaXNzaXZlTWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5lbWlzc2l2ZU1hcCA9IGdldFRleHR1cmUoIGpzb24uZW1pc3NpdmVNYXAgKTsKCQlpZiAoIGpzb24uZW1pc3NpdmVJbnRlbnNpdHkgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmVtaXNzaXZlSW50ZW5zaXR5ID0ganNvbi5lbWlzc2l2ZUludGVuc2l0eTsKCgkJaWYgKCBqc29uLnNwZWN1bGFyTWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zcGVjdWxhck1hcCA9IGdldFRleHR1cmUoIGpzb24uc3BlY3VsYXJNYXAgKTsKCQlpZiAoIGpzb24uc3BlY3VsYXJJbnRlbnNpdHlNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnNwZWN1bGFySW50ZW5zaXR5TWFwID0gZ2V0VGV4dHVyZSgganNvbi5zcGVjdWxhckludGVuc2l0eU1hcCApOwoJCWlmICgganNvbi5zcGVjdWxhckNvbG9yTWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zcGVjdWxhckNvbG9yTWFwID0gZ2V0VGV4dHVyZSgganNvbi5zcGVjdWxhckNvbG9yTWFwICk7CgoJCWlmICgganNvbi5lbnZNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmVudk1hcCA9IGdldFRleHR1cmUoIGpzb24uZW52TWFwICk7CgkJaWYgKCBqc29uLmVudk1hcEludGVuc2l0eSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuZW52TWFwSW50ZW5zaXR5ID0ganNvbi5lbnZNYXBJbnRlbnNpdHk7CgoJCWlmICgganNvbi5yZWZsZWN0aXZpdHkgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnJlZmxlY3Rpdml0eSA9IGpzb24ucmVmbGVjdGl2aXR5OwoJCWlmICgganNvbi5yZWZyYWN0aW9uUmF0aW8gIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnJlZnJhY3Rpb25SYXRpbyA9IGpzb24ucmVmcmFjdGlvblJhdGlvOwoKCQlpZiAoIGpzb24ubGlnaHRNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmxpZ2h0TWFwID0gZ2V0VGV4dHVyZSgganNvbi5saWdodE1hcCApOwoJCWlmICgganNvbi5saWdodE1hcEludGVuc2l0eSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwubGlnaHRNYXBJbnRlbnNpdHkgPSBqc29uLmxpZ2h0TWFwSW50ZW5zaXR5OwoKCQlpZiAoIGpzb24uYW9NYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmFvTWFwID0gZ2V0VGV4dHVyZSgganNvbi5hb01hcCApOwoJCWlmICgganNvbi5hb01hcEludGVuc2l0eSAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuYW9NYXBJbnRlbnNpdHkgPSBqc29uLmFvTWFwSW50ZW5zaXR5OwoKCQlpZiAoIGpzb24uZ3JhZGllbnRNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmdyYWRpZW50TWFwID0gZ2V0VGV4dHVyZSgganNvbi5ncmFkaWVudE1hcCApOwoKCQlpZiAoIGpzb24uY2xlYXJjb2F0TWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5jbGVhcmNvYXRNYXAgPSBnZXRUZXh0dXJlKCBqc29uLmNsZWFyY29hdE1hcCApOwoJCWlmICgganNvbi5jbGVhcmNvYXRSb3VnaG5lc3NNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzc01hcCA9IGdldFRleHR1cmUoIGpzb24uY2xlYXJjb2F0Um91Z2huZXNzTWFwICk7CgkJaWYgKCBqc29uLmNsZWFyY29hdE5vcm1hbE1hcCAhPT0gdW5kZWZpbmVkICkgbWF0ZXJpYWwuY2xlYXJjb2F0Tm9ybWFsTWFwID0gZ2V0VGV4dHVyZSgganNvbi5jbGVhcmNvYXROb3JtYWxNYXAgKTsKCQlpZiAoIGpzb24uY2xlYXJjb2F0Tm9ybWFsU2NhbGUgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmNsZWFyY29hdE5vcm1hbFNjYWxlID0gbmV3IFZlY3RvcjIoKS5mcm9tQXJyYXkoIGpzb24uY2xlYXJjb2F0Tm9ybWFsU2NhbGUgKTsKCgkJaWYgKCBqc29uLmlyaWRlc2NlbmNlTWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5pcmlkZXNjZW5jZU1hcCA9IGdldFRleHR1cmUoIGpzb24uaXJpZGVzY2VuY2VNYXAgKTsKCQlpZiAoIGpzb24uaXJpZGVzY2VuY2VUaGlja25lc3NNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLmlyaWRlc2NlbmNlVGhpY2tuZXNzTWFwID0gZ2V0VGV4dHVyZSgganNvbi5pcmlkZXNjZW5jZVRoaWNrbmVzc01hcCApOwoKCQlpZiAoIGpzb24udHJhbnNtaXNzaW9uTWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC50cmFuc21pc3Npb25NYXAgPSBnZXRUZXh0dXJlKCBqc29uLnRyYW5zbWlzc2lvbk1hcCApOwoJCWlmICgganNvbi50aGlja25lc3NNYXAgIT09IHVuZGVmaW5lZCApIG1hdGVyaWFsLnRoaWNrbmVzc01hcCA9IGdldFRleHR1cmUoIGpzb24udGhpY2tuZXNzTWFwICk7CgoJCWlmICgganNvbi5hbmlzb3Ryb3B5TWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5hbmlzb3Ryb3B5TWFwID0gZ2V0VGV4dHVyZSgganNvbi5hbmlzb3Ryb3B5TWFwICk7CgoJCWlmICgganNvbi5zaGVlbkNvbG9yTWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zaGVlbkNvbG9yTWFwID0gZ2V0VGV4dHVyZSgganNvbi5zaGVlbkNvbG9yTWFwICk7CgkJaWYgKCBqc29uLnNoZWVuUm91Z2huZXNzTWFwICE9PSB1bmRlZmluZWQgKSBtYXRlcmlhbC5zaGVlblJvdWdobmVzc01hcCA9IGdldFRleHR1cmUoIGpzb24uc2hlZW5Sb3VnaG5lc3NNYXAgKTsKCgkJcmV0dXJuIG1hdGVyaWFsOwoKCX0KCglzZXRUZXh0dXJlcyggdmFsdWUgKSB7CgoJCXRoaXMudGV4dHVyZXMgPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3RhdGljIGNyZWF0ZU1hdGVyaWFsRnJvbVR5cGUoIHR5cGUgKSB7CgoJCWNvbnN0IG1hdGVyaWFsTGliID0gewoJCQlTaGFkb3dNYXRlcmlhbCwKCQkJU3ByaXRlTWF0ZXJpYWwsCgkJCVJhd1NoYWRlck1hdGVyaWFsLAoJCQlTaGFkZXJNYXRlcmlhbCwKCQkJUG9pbnRzTWF0ZXJpYWwsCgkJCU1lc2hQaHlzaWNhbE1hdGVyaWFsLAoJCQlNZXNoU3RhbmRhcmRNYXRlcmlhbCwKCQkJTWVzaFBob25nTWF0ZXJpYWwsCgkJCU1lc2hUb29uTWF0ZXJpYWwsCgkJCU1lc2hOb3JtYWxNYXRlcmlhbCwKCQkJTWVzaExhbWJlcnRNYXRlcmlhbCwKCQkJTWVzaERlcHRoTWF0ZXJpYWwsCgkJCU1lc2hEaXN0YW5jZU1hdGVyaWFsLAoJCQlNZXNoQmFzaWNNYXRlcmlhbCwKCQkJTWVzaE1hdGNhcE1hdGVyaWFsLAoJCQlMaW5lRGFzaGVkTWF0ZXJpYWwsCgkJCUxpbmVCYXNpY01hdGVyaWFsLAoJCQlNYXRlcmlhbAoJCX07CgoJCXJldHVybiBuZXcgbWF0ZXJpYWxMaWJbIHR5cGUgXSgpOwoKCX0KCn0KCmNsYXNzIExvYWRlclV0aWxzIHsKCglzdGF0aWMgZGVjb2RlVGV4dCggYXJyYXkgKSB7CgoJCWlmICggdHlwZW9mIFRleHREZWNvZGVyICE9PSAndW5kZWZpbmVkJyApIHsKCgkJCXJldHVybiBuZXcgVGV4dERlY29kZXIoKS5kZWNvZGUoIGFycmF5ICk7CgoJCX0KCgkJLy8gQXZvaWQgdGhlIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgYXJyYXkpIHNob3J0Y3V0LCB3aGljaAoJCS8vIHRocm93cyBhICJtYXhpbXVtIGNhbGwgc3RhY2sgc2l6ZSBleGNlZWRlZCIgZXJyb3IgZm9yIGxhcmdlIGFycmF5cy4KCgkJbGV0IHMgPSAnJzsKCgkJZm9yICggbGV0IGkgPSAwLCBpbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJLy8gSW1wbGljaXRseSBhc3N1bWVzIGxpdHRsZS1lbmRpYW4uCgkJCXMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZSggYXJyYXlbIGkgXSApOwoKCQl9CgoJCXRyeSB7CgoJCQkvLyBtZXJnZXMgbXVsdGktYnl0ZSB1dGYtOCBjaGFyYWN0ZXJzLgoKCQkJcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudCggZXNjYXBlKCBzICkgKTsKCgkJfSBjYXRjaCAoIGUgKSB7IC8vIHNlZSAjMTYzNTgKCgkJCXJldHVybiBzOwoKCQl9CgoJfQoKCXN0YXRpYyBleHRyYWN0VXJsQmFzZSggdXJsICkgewoKCQljb25zdCBpbmRleCA9IHVybC5sYXN0SW5kZXhPZiggJy8nICk7CgoJCWlmICggaW5kZXggPT09IC0gMSApIHJldHVybiAnLi8nOwoKCQlyZXR1cm4gdXJsLnNsaWNlKCAwLCBpbmRleCArIDEgKTsKCgl9CgoJc3RhdGljIHJlc29sdmVVUkwoIHVybCwgcGF0aCApIHsKCgkJLy8gSW52YWxpZCBVUkwKCQlpZiAoIHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnIHx8IHVybCA9PT0gJycgKSByZXR1cm4gJyc7CgoJCS8vIEhvc3QgUmVsYXRpdmUgVVJMCgkJaWYgKCAvXmh0dHBzPzpcL1wvL2kudGVzdCggcGF0aCApICYmIC9eXC8vLnRlc3QoIHVybCApICkgewoKCQkJcGF0aCA9IHBhdGgucmVwbGFjZSggLyheaHR0cHM/OlwvXC9bXlwvXSspLiovaSwgJyQxJyApOwoKCQl9CgoJCS8vIEFic29sdXRlIFVSTCBodHRwOi8vLGh0dHBzOi8vLC8vCgkJaWYgKCAvXihodHRwcz86KT9cL1wvL2kudGVzdCggdXJsICkgKSByZXR1cm4gdXJsOwoKCQkvLyBEYXRhIFVSSQoJCWlmICggL15kYXRhOi4qLC4qJC9pLnRlc3QoIHVybCApICkgcmV0dXJuIHVybDsKCgkJLy8gQmxvYiBVUkwKCQlpZiAoIC9eYmxvYjouKiQvaS50ZXN0KCB1cmwgKSApIHJldHVybiB1cmw7CgoJCS8vIFJlbGF0aXZlIFVSTAoJCXJldHVybiBwYXRoICsgdXJsOwoKCX0KCn0KCmNsYXNzIEluc3RhbmNlZEJ1ZmZlckdlb21ldHJ5IGV4dGVuZHMgQnVmZmVyR2VvbWV0cnkgewoKCWNvbnN0cnVjdG9yKCkgewoKCQlzdXBlcigpOwoKCQl0aGlzLmlzSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnkgPSB0cnVlOwoKCQl0aGlzLnR5cGUgPSAnSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnknOwoJCXRoaXMuaW5zdGFuY2VDb3VudCA9IEluZmluaXR5OwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLmluc3RhbmNlQ291bnQgPSBzb3VyY2UuaW5zdGFuY2VDb3VudDsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXRvSlNPTigpIHsKCgkJY29uc3QgZGF0YSA9IHN1cGVyLnRvSlNPTigpOwoKCQlkYXRhLmluc3RhbmNlQ291bnQgPSB0aGlzLmluc3RhbmNlQ291bnQ7CgoJCWRhdGEuaXNJbnN0YW5jZWRCdWZmZXJHZW9tZXRyeSA9IHRydWU7CgoJCXJldHVybiBkYXRhOwoKCX0KCn0KCmNsYXNzIEJ1ZmZlckdlb21ldHJ5TG9hZGVyIGV4dGVuZHMgTG9hZGVyIHsKCgljb25zdHJ1Y3RvciggbWFuYWdlciApIHsKCgkJc3VwZXIoIG1hbmFnZXIgKTsKCgl9CgoJbG9hZCggdXJsLCBvbkxvYWQsIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKSB7CgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJY29uc3QgbG9hZGVyID0gbmV3IEZpbGVMb2FkZXIoIHNjb3BlLm1hbmFnZXIgKTsKCQlsb2FkZXIuc2V0UGF0aCggc2NvcGUucGF0aCApOwoJCWxvYWRlci5zZXRSZXF1ZXN0SGVhZGVyKCBzY29wZS5yZXF1ZXN0SGVhZGVyICk7CgkJbG9hZGVyLnNldFdpdGhDcmVkZW50aWFscyggc2NvcGUud2l0aENyZWRlbnRpYWxzICk7CgkJbG9hZGVyLmxvYWQoIHVybCwgZnVuY3Rpb24gKCB0ZXh0ICkgewoKCQkJdHJ5IHsKCgkJCQlvbkxvYWQoIHNjb3BlLnBhcnNlKCBKU09OLnBhcnNlKCB0ZXh0ICkgKSApOwoKCQkJfSBjYXRjaCAoIGUgKSB7CgoJCQkJaWYgKCBvbkVycm9yICkgewoKCQkJCQlvbkVycm9yKCBlICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJY29uc29sZS5lcnJvciggZSApOwoKCQkJCX0KCgkJCQlzY29wZS5tYW5hZ2VyLml0ZW1FcnJvciggdXJsICk7CgoJCQl9CgoJCX0sIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKTsKCgl9CgoJcGFyc2UoIGpzb24gKSB7CgoJCWNvbnN0IGludGVybGVhdmVkQnVmZmVyTWFwID0ge307CgkJY29uc3QgYXJyYXlCdWZmZXJNYXAgPSB7fTsKCgkJZnVuY3Rpb24gZ2V0SW50ZXJsZWF2ZWRCdWZmZXIoIGpzb24sIHV1aWQgKSB7CgoJCQlpZiAoIGludGVybGVhdmVkQnVmZmVyTWFwWyB1dWlkIF0gIT09IHVuZGVmaW5lZCApIHJldHVybiBpbnRlcmxlYXZlZEJ1ZmZlck1hcFsgdXVpZCBdOwoKCQkJY29uc3QgaW50ZXJsZWF2ZWRCdWZmZXJzID0ganNvbi5pbnRlcmxlYXZlZEJ1ZmZlcnM7CgkJCWNvbnN0IGludGVybGVhdmVkQnVmZmVyID0gaW50ZXJsZWF2ZWRCdWZmZXJzWyB1dWlkIF07CgoJCQljb25zdCBidWZmZXIgPSBnZXRBcnJheUJ1ZmZlcigganNvbiwgaW50ZXJsZWF2ZWRCdWZmZXIuYnVmZmVyICk7CgoJCQljb25zdCBhcnJheSA9IGdldFR5cGVkQXJyYXkoIGludGVybGVhdmVkQnVmZmVyLnR5cGUsIGJ1ZmZlciApOwoJCQljb25zdCBpYiA9IG5ldyBJbnRlcmxlYXZlZEJ1ZmZlciggYXJyYXksIGludGVybGVhdmVkQnVmZmVyLnN0cmlkZSApOwoJCQlpYi51dWlkID0gaW50ZXJsZWF2ZWRCdWZmZXIudXVpZDsKCgkJCWludGVybGVhdmVkQnVmZmVyTWFwWyB1dWlkIF0gPSBpYjsKCgkJCXJldHVybiBpYjsKCgkJfQoKCQlmdW5jdGlvbiBnZXRBcnJheUJ1ZmZlcigganNvbiwgdXVpZCApIHsKCgkJCWlmICggYXJyYXlCdWZmZXJNYXBbIHV1aWQgXSAhPT0gdW5kZWZpbmVkICkgcmV0dXJuIGFycmF5QnVmZmVyTWFwWyB1dWlkIF07CgoJCQljb25zdCBhcnJheUJ1ZmZlcnMgPSBqc29uLmFycmF5QnVmZmVyczsKCQkJY29uc3QgYXJyYXlCdWZmZXIgPSBhcnJheUJ1ZmZlcnNbIHV1aWQgXTsKCgkJCWNvbnN0IGFiID0gbmV3IFVpbnQzMkFycmF5KCBhcnJheUJ1ZmZlciApLmJ1ZmZlcjsKCgkJCWFycmF5QnVmZmVyTWFwWyB1dWlkIF0gPSBhYjsKCgkJCXJldHVybiBhYjsKCgkJfQoKCQljb25zdCBnZW9tZXRyeSA9IGpzb24uaXNJbnN0YW5jZWRCdWZmZXJHZW9tZXRyeSA/IG5ldyBJbnN0YW5jZWRCdWZmZXJHZW9tZXRyeSgpIDogbmV3IEJ1ZmZlckdlb21ldHJ5KCk7CgoJCWNvbnN0IGluZGV4ID0ganNvbi5kYXRhLmluZGV4OwoKCQlpZiAoIGluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgoJCQljb25zdCB0eXBlZEFycmF5ID0gZ2V0VHlwZWRBcnJheSggaW5kZXgudHlwZSwgaW5kZXguYXJyYXkgKTsKCQkJZ2VvbWV0cnkuc2V0SW5kZXgoIG5ldyBCdWZmZXJBdHRyaWJ1dGUoIHR5cGVkQXJyYXksIDEgKSApOwoKCQl9CgoJCWNvbnN0IGF0dHJpYnV0ZXMgPSBqc29uLmRhdGEuYXR0cmlidXRlczsKCgkJZm9yICggY29uc3Qga2V5IGluIGF0dHJpYnV0ZXMgKSB7CgoJCQljb25zdCBhdHRyaWJ1dGUgPSBhdHRyaWJ1dGVzWyBrZXkgXTsKCQkJbGV0IGJ1ZmZlckF0dHJpYnV0ZTsKCgkJCWlmICggYXR0cmlidXRlLmlzSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUgKSB7CgoJCQkJY29uc3QgaW50ZXJsZWF2ZWRCdWZmZXIgPSBnZXRJbnRlcmxlYXZlZEJ1ZmZlcigganNvbi5kYXRhLCBhdHRyaWJ1dGUuZGF0YSApOwoJCQkJYnVmZmVyQXR0cmlidXRlID0gbmV3IEludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlKCBpbnRlcmxlYXZlZEJ1ZmZlciwgYXR0cmlidXRlLml0ZW1TaXplLCBhdHRyaWJ1dGUub2Zmc2V0LCBhdHRyaWJ1dGUubm9ybWFsaXplZCApOwoKCQkJfSBlbHNlIHsKCgkJCQljb25zdCB0eXBlZEFycmF5ID0gZ2V0VHlwZWRBcnJheSggYXR0cmlidXRlLnR5cGUsIGF0dHJpYnV0ZS5hcnJheSApOwoJCQkJY29uc3QgYnVmZmVyQXR0cmlidXRlQ29uc3RyID0gYXR0cmlidXRlLmlzSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlID8gSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlIDogQnVmZmVyQXR0cmlidXRlOwoJCQkJYnVmZmVyQXR0cmlidXRlID0gbmV3IGJ1ZmZlckF0dHJpYnV0ZUNvbnN0ciggdHlwZWRBcnJheSwgYXR0cmlidXRlLml0ZW1TaXplLCBhdHRyaWJ1dGUubm9ybWFsaXplZCApOwoKCQkJfQoKCQkJaWYgKCBhdHRyaWJ1dGUubmFtZSAhPT0gdW5kZWZpbmVkICkgYnVmZmVyQXR0cmlidXRlLm5hbWUgPSBhdHRyaWJ1dGUubmFtZTsKCQkJaWYgKCBhdHRyaWJ1dGUudXNhZ2UgIT09IHVuZGVmaW5lZCApIGJ1ZmZlckF0dHJpYnV0ZS5zZXRVc2FnZSggYXR0cmlidXRlLnVzYWdlICk7CgoJCQlnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoIGtleSwgYnVmZmVyQXR0cmlidXRlICk7CgoJCX0KCgkJY29uc3QgbW9ycGhBdHRyaWJ1dGVzID0ganNvbi5kYXRhLm1vcnBoQXR0cmlidXRlczsKCgkJaWYgKCBtb3JwaEF0dHJpYnV0ZXMgKSB7CgoJCQlmb3IgKCBjb25zdCBrZXkgaW4gbW9ycGhBdHRyaWJ1dGVzICkgewoKCQkJCWNvbnN0IGF0dHJpYnV0ZUFycmF5ID0gbW9ycGhBdHRyaWJ1dGVzWyBrZXkgXTsKCgkJCQljb25zdCBhcnJheSA9IFtdOwoKCQkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBhdHRyaWJ1dGVBcnJheS5sZW5ndGg7IGkgPCBpbDsgaSArKyApIHsKCgkJCQkJY29uc3QgYXR0cmlidXRlID0gYXR0cmlidXRlQXJyYXlbIGkgXTsKCQkJCQlsZXQgYnVmZmVyQXR0cmlidXRlOwoKCQkJCQlpZiAoIGF0dHJpYnV0ZS5pc0ludGVybGVhdmVkQnVmZmVyQXR0cmlidXRlICkgewoKCQkJCQkJY29uc3QgaW50ZXJsZWF2ZWRCdWZmZXIgPSBnZXRJbnRlcmxlYXZlZEJ1ZmZlcigganNvbi5kYXRhLCBhdHRyaWJ1dGUuZGF0YSApOwoJCQkJCQlidWZmZXJBdHRyaWJ1dGUgPSBuZXcgSW50ZXJsZWF2ZWRCdWZmZXJBdHRyaWJ1dGUoIGludGVybGVhdmVkQnVmZmVyLCBhdHRyaWJ1dGUuaXRlbVNpemUsIGF0dHJpYnV0ZS5vZmZzZXQsIGF0dHJpYnV0ZS5ub3JtYWxpemVkICk7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQljb25zdCB0eXBlZEFycmF5ID0gZ2V0VHlwZWRBcnJheSggYXR0cmlidXRlLnR5cGUsIGF0dHJpYnV0ZS5hcnJheSApOwoJCQkJCQlidWZmZXJBdHRyaWJ1dGUgPSBuZXcgQnVmZmVyQXR0cmlidXRlKCB0eXBlZEFycmF5LCBhdHRyaWJ1dGUuaXRlbVNpemUsIGF0dHJpYnV0ZS5ub3JtYWxpemVkICk7CgoJCQkJCX0KCgkJCQkJaWYgKCBhdHRyaWJ1dGUubmFtZSAhPT0gdW5kZWZpbmVkICkgYnVmZmVyQXR0cmlidXRlLm5hbWUgPSBhdHRyaWJ1dGUubmFtZTsKCQkJCQlhcnJheS5wdXNoKCBidWZmZXJBdHRyaWJ1dGUgKTsKCgkJCQl9CgoJCQkJZ2VvbWV0cnkubW9ycGhBdHRyaWJ1dGVzWyBrZXkgXSA9IGFycmF5OwoKCQkJfQoKCQl9CgoJCWNvbnN0IG1vcnBoVGFyZ2V0c1JlbGF0aXZlID0ganNvbi5kYXRhLm1vcnBoVGFyZ2V0c1JlbGF0aXZlOwoKCQlpZiAoIG1vcnBoVGFyZ2V0c1JlbGF0aXZlICkgewoKCQkJZ2VvbWV0cnkubW9ycGhUYXJnZXRzUmVsYXRpdmUgPSB0cnVlOwoKCQl9CgoJCWNvbnN0IGdyb3VwcyA9IGpzb24uZGF0YS5ncm91cHMgfHwganNvbi5kYXRhLmRyYXdjYWxscyB8fCBqc29uLmRhdGEub2Zmc2V0czsKCgkJaWYgKCBncm91cHMgIT09IHVuZGVmaW5lZCApIHsKCgkJCWZvciAoIGxldCBpID0gMCwgbiA9IGdyb3Vwcy5sZW5ndGg7IGkgIT09IG47ICsrIGkgKSB7CgoJCQkJY29uc3QgZ3JvdXAgPSBncm91cHNbIGkgXTsKCgkJCQlnZW9tZXRyeS5hZGRHcm91cCggZ3JvdXAuc3RhcnQsIGdyb3VwLmNvdW50LCBncm91cC5tYXRlcmlhbEluZGV4ICk7CgoJCQl9CgoJCX0KCgkJY29uc3QgYm91bmRpbmdTcGhlcmUgPSBqc29uLmRhdGEuYm91bmRpbmdTcGhlcmU7CgoJCWlmICggYm91bmRpbmdTcGhlcmUgIT09IHVuZGVmaW5lZCApIHsKCgkJCWNvbnN0IGNlbnRlciA9IG5ldyBWZWN0b3IzKCk7CgoJCQlpZiAoIGJvdW5kaW5nU3BoZXJlLmNlbnRlciAhPT0gdW5kZWZpbmVkICkgewoKCQkJCWNlbnRlci5mcm9tQXJyYXkoIGJvdW5kaW5nU3BoZXJlLmNlbnRlciApOwoKCQkJfQoKCQkJZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmUgPSBuZXcgU3BoZXJlKCBjZW50ZXIsIGJvdW5kaW5nU3BoZXJlLnJhZGl1cyApOwoKCQl9CgoJCWlmICgganNvbi5uYW1lICkgZ2VvbWV0cnkubmFtZSA9IGpzb24ubmFtZTsKCQlpZiAoIGpzb24udXNlckRhdGEgKSBnZW9tZXRyeS51c2VyRGF0YSA9IGpzb24udXNlckRhdGE7CgoJCXJldHVybiBnZW9tZXRyeTsKCgl9Cgp9CgpjbGFzcyBPYmplY3RMb2FkZXIgZXh0ZW5kcyBMb2FkZXIgewoKCWNvbnN0cnVjdG9yKCBtYW5hZ2VyICkgewoKCQlzdXBlciggbWFuYWdlciApOwoKCX0KCglsb2FkKCB1cmwsIG9uTG9hZCwgb25Qcm9ncmVzcywgb25FcnJvciApIHsKCgkJY29uc3Qgc2NvcGUgPSB0aGlzOwoKCQljb25zdCBwYXRoID0gKCB0aGlzLnBhdGggPT09ICcnICkgPyBMb2FkZXJVdGlscy5leHRyYWN0VXJsQmFzZSggdXJsICkgOiB0aGlzLnBhdGg7CgkJdGhpcy5yZXNvdXJjZVBhdGggPSB0aGlzLnJlc291cmNlUGF0aCB8fCBwYXRoOwoKCQljb25zdCBsb2FkZXIgPSBuZXcgRmlsZUxvYWRlciggdGhpcy5tYW5hZ2VyICk7CgkJbG9hZGVyLnNldFBhdGgoIHRoaXMucGF0aCApOwoJCWxvYWRlci5zZXRSZXF1ZXN0SGVhZGVyKCB0aGlzLnJlcXVlc3RIZWFkZXIgKTsKCQlsb2FkZXIuc2V0V2l0aENyZWRlbnRpYWxzKCB0aGlzLndpdGhDcmVkZW50aWFscyApOwoJCWxvYWRlci5sb2FkKCB1cmwsIGZ1bmN0aW9uICggdGV4dCApIHsKCgkJCWxldCBqc29uID0gbnVsbDsKCgkJCXRyeSB7CgoJCQkJanNvbiA9IEpTT04ucGFyc2UoIHRleHQgKTsKCgkJCX0gY2F0Y2ggKCBlcnJvciApIHsKCgkJCQlpZiAoIG9uRXJyb3IgIT09IHVuZGVmaW5lZCApIG9uRXJyb3IoIGVycm9yICk7CgoJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFOk9iamVjdExvYWRlcjogQ2FuXCd0IHBhcnNlICcgKyB1cmwgKyAnLicsIGVycm9yLm1lc3NhZ2UgKTsKCgkJCQlyZXR1cm47CgoJCQl9CgoJCQljb25zdCBtZXRhZGF0YSA9IGpzb24ubWV0YWRhdGE7CgoJCQlpZiAoIG1ldGFkYXRhID09PSB1bmRlZmluZWQgfHwgbWV0YWRhdGEudHlwZSA9PT0gdW5kZWZpbmVkIHx8IG1ldGFkYXRhLnR5cGUudG9Mb3dlckNhc2UoKSA9PT0gJ2dlb21ldHJ5JyApIHsKCgkJCQlpZiAoIG9uRXJyb3IgIT09IHVuZGVmaW5lZCApIG9uRXJyb3IoIG5ldyBFcnJvciggJ1RIUkVFLk9iamVjdExvYWRlcjogQ2FuXCd0IGxvYWQgJyArIHVybCApICk7CgoJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLk9iamVjdExvYWRlcjogQ2FuXCd0IGxvYWQgJyArIHVybCApOwoJCQkJcmV0dXJuOwoKCQkJfQoKCQkJc2NvcGUucGFyc2UoIGpzb24sIG9uTG9hZCApOwoKCQl9LCBvblByb2dyZXNzLCBvbkVycm9yICk7CgoJfQoKCWFzeW5jIGxvYWRBc3luYyggdXJsLCBvblByb2dyZXNzICkgewoKCQljb25zdCBzY29wZSA9IHRoaXM7CgoJCWNvbnN0IHBhdGggPSAoIHRoaXMucGF0aCA9PT0gJycgKSA/IExvYWRlclV0aWxzLmV4dHJhY3RVcmxCYXNlKCB1cmwgKSA6IHRoaXMucGF0aDsKCQl0aGlzLnJlc291cmNlUGF0aCA9IHRoaXMucmVzb3VyY2VQYXRoIHx8IHBhdGg7CgoJCWNvbnN0IGxvYWRlciA9IG5ldyBGaWxlTG9hZGVyKCB0aGlzLm1hbmFnZXIgKTsKCQlsb2FkZXIuc2V0UGF0aCggdGhpcy5wYXRoICk7CgkJbG9hZGVyLnNldFJlcXVlc3RIZWFkZXIoIHRoaXMucmVxdWVzdEhlYWRlciApOwoJCWxvYWRlci5zZXRXaXRoQ3JlZGVudGlhbHMoIHRoaXMud2l0aENyZWRlbnRpYWxzICk7CgoJCWNvbnN0IHRleHQgPSBhd2FpdCBsb2FkZXIubG9hZEFzeW5jKCB1cmwsIG9uUHJvZ3Jlc3MgKTsKCgkJY29uc3QganNvbiA9IEpTT04ucGFyc2UoIHRleHQgKTsKCgkJY29uc3QgbWV0YWRhdGEgPSBqc29uLm1ldGFkYXRhOwoKCQlpZiAoIG1ldGFkYXRhID09PSB1bmRlZmluZWQgfHwgbWV0YWRhdGEudHlwZSA9PT0gdW5kZWZpbmVkIHx8IG1ldGFkYXRhLnR5cGUudG9Mb3dlckNhc2UoKSA9PT0gJ2dlb21ldHJ5JyApIHsKCgkJCXRocm93IG5ldyBFcnJvciggJ1RIUkVFLk9iamVjdExvYWRlcjogQ2FuXCd0IGxvYWQgJyArIHVybCApOwoKCQl9CgoJCXJldHVybiBhd2FpdCBzY29wZS5wYXJzZUFzeW5jKCBqc29uICk7CgoJfQoKCXBhcnNlKCBqc29uLCBvbkxvYWQgKSB7CgoJCWNvbnN0IGFuaW1hdGlvbnMgPSB0aGlzLnBhcnNlQW5pbWF0aW9ucygganNvbi5hbmltYXRpb25zICk7CgkJY29uc3Qgc2hhcGVzID0gdGhpcy5wYXJzZVNoYXBlcygganNvbi5zaGFwZXMgKTsKCQljb25zdCBnZW9tZXRyaWVzID0gdGhpcy5wYXJzZUdlb21ldHJpZXMoIGpzb24uZ2VvbWV0cmllcywgc2hhcGVzICk7CgoJCWNvbnN0IGltYWdlcyA9IHRoaXMucGFyc2VJbWFnZXMoIGpzb24uaW1hZ2VzLCBmdW5jdGlvbiAoKSB7CgoJCQlpZiAoIG9uTG9hZCAhPT0gdW5kZWZpbmVkICkgb25Mb2FkKCBvYmplY3QgKTsKCgkJfSApOwoKCQljb25zdCB0ZXh0dXJlcyA9IHRoaXMucGFyc2VUZXh0dXJlcygganNvbi50ZXh0dXJlcywgaW1hZ2VzICk7CgkJY29uc3QgbWF0ZXJpYWxzID0gdGhpcy5wYXJzZU1hdGVyaWFscygganNvbi5tYXRlcmlhbHMsIHRleHR1cmVzICk7CgoJCWNvbnN0IG9iamVjdCA9IHRoaXMucGFyc2VPYmplY3QoIGpzb24ub2JqZWN0LCBnZW9tZXRyaWVzLCBtYXRlcmlhbHMsIHRleHR1cmVzLCBhbmltYXRpb25zICk7CgkJY29uc3Qgc2tlbGV0b25zID0gdGhpcy5wYXJzZVNrZWxldG9ucygganNvbi5za2VsZXRvbnMsIG9iamVjdCApOwoKCQl0aGlzLmJpbmRTa2VsZXRvbnMoIG9iamVjdCwgc2tlbGV0b25zICk7CgoJCS8vCgoJCWlmICggb25Mb2FkICE9PSB1bmRlZmluZWQgKSB7CgoJCQlsZXQgaGFzSW1hZ2VzID0gZmFsc2U7CgoJCQlmb3IgKCBjb25zdCB1dWlkIGluIGltYWdlcyApIHsKCgkJCQlpZiAoIGltYWdlc1sgdXVpZCBdLmRhdGEgaW5zdGFuY2VvZiBIVE1MSW1hZ2VFbGVtZW50ICkgewoKCQkJCQloYXNJbWFnZXMgPSB0cnVlOwoJCQkJCWJyZWFrOwoKCQkJCX0KCgkJCX0KCgkJCWlmICggaGFzSW1hZ2VzID09PSBmYWxzZSApIG9uTG9hZCggb2JqZWN0ICk7CgoJCX0KCgkJcmV0dXJuIG9iamVjdDsKCgl9CgoJYXN5bmMgcGFyc2VBc3luYygganNvbiApIHsKCgkJY29uc3QgYW5pbWF0aW9ucyA9IHRoaXMucGFyc2VBbmltYXRpb25zKCBqc29uLmFuaW1hdGlvbnMgKTsKCQljb25zdCBzaGFwZXMgPSB0aGlzLnBhcnNlU2hhcGVzKCBqc29uLnNoYXBlcyApOwoJCWNvbnN0IGdlb21ldHJpZXMgPSB0aGlzLnBhcnNlR2VvbWV0cmllcygganNvbi5nZW9tZXRyaWVzLCBzaGFwZXMgKTsKCgkJY29uc3QgaW1hZ2VzID0gYXdhaXQgdGhpcy5wYXJzZUltYWdlc0FzeW5jKCBqc29uLmltYWdlcyApOwoKCQljb25zdCB0ZXh0dXJlcyA9IHRoaXMucGFyc2VUZXh0dXJlcygganNvbi50ZXh0dXJlcywgaW1hZ2VzICk7CgkJY29uc3QgbWF0ZXJpYWxzID0gdGhpcy5wYXJzZU1hdGVyaWFscygganNvbi5tYXRlcmlhbHMsIHRleHR1cmVzICk7CgoJCWNvbnN0IG9iamVjdCA9IHRoaXMucGFyc2VPYmplY3QoIGpzb24ub2JqZWN0LCBnZW9tZXRyaWVzLCBtYXRlcmlhbHMsIHRleHR1cmVzLCBhbmltYXRpb25zICk7CgkJY29uc3Qgc2tlbGV0b25zID0gdGhpcy5wYXJzZVNrZWxldG9ucygganNvbi5za2VsZXRvbnMsIG9iamVjdCApOwoKCQl0aGlzLmJpbmRTa2VsZXRvbnMoIG9iamVjdCwgc2tlbGV0b25zICk7CgoJCXJldHVybiBvYmplY3Q7CgoJfQoKCXBhcnNlU2hhcGVzKCBqc29uICkgewoKCQljb25zdCBzaGFwZXMgPSB7fTsKCgkJaWYgKCBqc29uICE9PSB1bmRlZmluZWQgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBqc29uLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJY29uc3Qgc2hhcGUgPSBuZXcgU2hhcGUoKS5mcm9tSlNPTigganNvblsgaSBdICk7CgoJCQkJc2hhcGVzWyBzaGFwZS51dWlkIF0gPSBzaGFwZTsKCgkJCX0KCgkJfQoKCQlyZXR1cm4gc2hhcGVzOwoKCX0KCglwYXJzZVNrZWxldG9ucygganNvbiwgb2JqZWN0ICkgewoKCQljb25zdCBza2VsZXRvbnMgPSB7fTsKCQljb25zdCBib25lcyA9IHt9OwoKCQkvLyBnZW5lcmF0ZSBib25lIGxvb2t1cCB0YWJsZQoKCQlvYmplY3QudHJhdmVyc2UoIGZ1bmN0aW9uICggY2hpbGQgKSB7CgoJCQlpZiAoIGNoaWxkLmlzQm9uZSApIGJvbmVzWyBjaGlsZC51dWlkIF0gPSBjaGlsZDsKCgkJfSApOwoKCQkvLyBjcmVhdGUgc2tlbGV0b25zCgoJCWlmICgganNvbiAhPT0gdW5kZWZpbmVkICkgewoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0ganNvbi5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWNvbnN0IHNrZWxldG9uID0gbmV3IFNrZWxldG9uKCkuZnJvbUpTT04oIGpzb25bIGkgXSwgYm9uZXMgKTsKCgkJCQlza2VsZXRvbnNbIHNrZWxldG9uLnV1aWQgXSA9IHNrZWxldG9uOwoKCQkJfQoKCQl9CgoJCXJldHVybiBza2VsZXRvbnM7CgoJfQoKCXBhcnNlR2VvbWV0cmllcygganNvbiwgc2hhcGVzICkgewoKCQljb25zdCBnZW9tZXRyaWVzID0ge307CgoJCWlmICgganNvbiAhPT0gdW5kZWZpbmVkICkgewoKCQkJY29uc3QgYnVmZmVyR2VvbWV0cnlMb2FkZXIgPSBuZXcgQnVmZmVyR2VvbWV0cnlMb2FkZXIoKTsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IGpzb24ubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQlsZXQgZ2VvbWV0cnk7CgkJCQljb25zdCBkYXRhID0ganNvblsgaSBdOwoKCQkJCXN3aXRjaCAoIGRhdGEudHlwZSApIHsKCgkJCQkJY2FzZSAnQnVmZmVyR2VvbWV0cnknOgoJCQkJCWNhc2UgJ0luc3RhbmNlZEJ1ZmZlckdlb21ldHJ5JzoKCgkJCQkJCWdlb21ldHJ5ID0gYnVmZmVyR2VvbWV0cnlMb2FkZXIucGFyc2UoIGRhdGEgKTsKCQkJCQkJYnJlYWs7CgoJCQkJCWRlZmF1bHQ6CgoJCQkJCQlpZiAoIGRhdGEudHlwZSBpbiBHZW9tZXRyaWVzICkgewoKCQkJCQkJCWdlb21ldHJ5ID0gR2VvbWV0cmllc1sgZGF0YS50eXBlIF0uZnJvbUpTT04oIGRhdGEsIHNoYXBlcyApOwoKCQkJCQkJfSBlbHNlIHsKCgkJCQkJCQljb25zb2xlLndhcm4oIGBUSFJFRS5PYmplY3RMb2FkZXI6IFVuc3VwcG9ydGVkIGdlb21ldHJ5IHR5cGUgIiR7IGRhdGEudHlwZSB9ImAgKTsKCgkJCQkJCX0KCgkJCQl9CgoJCQkJZ2VvbWV0cnkudXVpZCA9IGRhdGEudXVpZDsKCgkJCQlpZiAoIGRhdGEubmFtZSAhPT0gdW5kZWZpbmVkICkgZ2VvbWV0cnkubmFtZSA9IGRhdGEubmFtZTsKCQkJCWlmICggZGF0YS51c2VyRGF0YSAhPT0gdW5kZWZpbmVkICkgZ2VvbWV0cnkudXNlckRhdGEgPSBkYXRhLnVzZXJEYXRhOwoKCQkJCWdlb21ldHJpZXNbIGRhdGEudXVpZCBdID0gZ2VvbWV0cnk7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIGdlb21ldHJpZXM7CgoJfQoKCXBhcnNlTWF0ZXJpYWxzKCBqc29uLCB0ZXh0dXJlcyApIHsKCgkJY29uc3QgY2FjaGUgPSB7fTsgLy8gTXVsdGlNYXRlcmlhbAoJCWNvbnN0IG1hdGVyaWFscyA9IHt9OwoKCQlpZiAoIGpzb24gIT09IHVuZGVmaW5lZCApIHsKCgkJCWNvbnN0IGxvYWRlciA9IG5ldyBNYXRlcmlhbExvYWRlcigpOwoJCQlsb2FkZXIuc2V0VGV4dHVyZXMoIHRleHR1cmVzICk7CgoJCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBqc29uLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJY29uc3QgZGF0YSA9IGpzb25bIGkgXTsKCgkJCQlpZiAoIGNhY2hlWyBkYXRhLnV1aWQgXSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCQljYWNoZVsgZGF0YS51dWlkIF0gPSBsb2FkZXIucGFyc2UoIGRhdGEgKTsKCgkJCQl9CgoJCQkJbWF0ZXJpYWxzWyBkYXRhLnV1aWQgXSA9IGNhY2hlWyBkYXRhLnV1aWQgXTsKCgkJCX0KCgkJfQoKCQlyZXR1cm4gbWF0ZXJpYWxzOwoKCX0KCglwYXJzZUFuaW1hdGlvbnMoIGpzb24gKSB7CgoJCWNvbnN0IGFuaW1hdGlvbnMgPSB7fTsKCgkJaWYgKCBqc29uICE9PSB1bmRlZmluZWQgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBqc29uLmxlbmd0aDsgaSArKyApIHsKCgkJCQljb25zdCBkYXRhID0ganNvblsgaSBdOwoKCQkJCWNvbnN0IGNsaXAgPSBBbmltYXRpb25DbGlwLnBhcnNlKCBkYXRhICk7CgoJCQkJYW5pbWF0aW9uc1sgY2xpcC51dWlkIF0gPSBjbGlwOwoKCQkJfQoKCQl9CgoJCXJldHVybiBhbmltYXRpb25zOwoKCX0KCglwYXJzZUltYWdlcygganNvbiwgb25Mb2FkICkgewoKCQljb25zdCBzY29wZSA9IHRoaXM7CgkJY29uc3QgaW1hZ2VzID0ge307CgoJCWxldCBsb2FkZXI7CgoJCWZ1bmN0aW9uIGxvYWRJbWFnZSggdXJsICkgewoKCQkJc2NvcGUubWFuYWdlci5pdGVtU3RhcnQoIHVybCApOwoKCQkJcmV0dXJuIGxvYWRlci5sb2FkKCB1cmwsIGZ1bmN0aW9uICgpIHsKCgkJCQlzY29wZS5tYW5hZ2VyLml0ZW1FbmQoIHVybCApOwoKCQkJfSwgdW5kZWZpbmVkLCBmdW5jdGlvbiAoKSB7CgoJCQkJc2NvcGUubWFuYWdlci5pdGVtRXJyb3IoIHVybCApOwoJCQkJc2NvcGUubWFuYWdlci5pdGVtRW5kKCB1cmwgKTsKCgkJCX0gKTsKCgkJfQoKCQlmdW5jdGlvbiBkZXNlcmlhbGl6ZUltYWdlKCBpbWFnZSApIHsKCgkJCWlmICggdHlwZW9mIGltYWdlID09PSAnc3RyaW5nJyApIHsKCgkJCQljb25zdCB1cmwgPSBpbWFnZTsKCgkJCQljb25zdCBwYXRoID0gL14oXC9cLyl8KFthLXpdKzooXC9cLyk/KS9pLnRlc3QoIHVybCApID8gdXJsIDogc2NvcGUucmVzb3VyY2VQYXRoICsgdXJsOwoKCQkJCXJldHVybiBsb2FkSW1hZ2UoIHBhdGggKTsKCgkJCX0gZWxzZSB7CgoJCQkJaWYgKCBpbWFnZS5kYXRhICkgewoKCQkJCQlyZXR1cm4gewoJCQkJCQlkYXRhOiBnZXRUeXBlZEFycmF5KCBpbWFnZS50eXBlLCBpbWFnZS5kYXRhICksCgkJCQkJCXdpZHRoOiBpbWFnZS53aWR0aCwKCQkJCQkJaGVpZ2h0OiBpbWFnZS5oZWlnaHQKCQkJCQl9OwoKCQkJCX0gZWxzZSB7CgoJCQkJCXJldHVybiBudWxsOwoKCQkJCX0KCgkJCX0KCgkJfQoKCQlpZiAoIGpzb24gIT09IHVuZGVmaW5lZCAmJiBqc29uLmxlbmd0aCA+IDAgKSB7CgoJCQljb25zdCBtYW5hZ2VyID0gbmV3IExvYWRpbmdNYW5hZ2VyKCBvbkxvYWQgKTsKCgkJCWxvYWRlciA9IG5ldyBJbWFnZUxvYWRlciggbWFuYWdlciApOwoJCQlsb2FkZXIuc2V0Q3Jvc3NPcmlnaW4oIHRoaXMuY3Jvc3NPcmlnaW4gKTsKCgkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBqc29uLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCWNvbnN0IGltYWdlID0ganNvblsgaSBdOwoJCQkJY29uc3QgdXJsID0gaW1hZ2UudXJsOwoKCQkJCWlmICggQXJyYXkuaXNBcnJheSggdXJsICkgKSB7CgoJCQkJCS8vIGxvYWQgYXJyYXkgb2YgaW1hZ2VzIGUuZyBDdWJlVGV4dHVyZQoKCQkJCQljb25zdCBpbWFnZUFycmF5ID0gW107CgoJCQkJCWZvciAoIGxldCBqID0gMCwgamwgPSB1cmwubGVuZ3RoOyBqIDwgamw7IGogKysgKSB7CgoJCQkJCQljb25zdCBjdXJyZW50VXJsID0gdXJsWyBqIF07CgoJCQkJCQljb25zdCBkZXNlcmlhbGl6ZWRJbWFnZSA9IGRlc2VyaWFsaXplSW1hZ2UoIGN1cnJlbnRVcmwgKTsKCgkJCQkJCWlmICggZGVzZXJpYWxpemVkSW1hZ2UgIT09IG51bGwgKSB7CgoJCQkJCQkJaWYgKCBkZXNlcmlhbGl6ZWRJbWFnZSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQgKSB7CgoJCQkJCQkJCWltYWdlQXJyYXkucHVzaCggZGVzZXJpYWxpemVkSW1hZ2UgKTsKCgkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQkvLyBzcGVjaWFsIGNhc2U6IGhhbmRsZSBhcnJheSBvZiBkYXRhIHRleHR1cmVzIGZvciBjdWJlIHRleHR1cmVzCgoJCQkJCQkJCWltYWdlQXJyYXkucHVzaCggbmV3IERhdGFUZXh0dXJlKCBkZXNlcmlhbGl6ZWRJbWFnZS5kYXRhLCBkZXNlcmlhbGl6ZWRJbWFnZS53aWR0aCwgZGVzZXJpYWxpemVkSW1hZ2UuaGVpZ2h0ICkgKTsKCgkJCQkJCQl9CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaW1hZ2VzWyBpbWFnZS51dWlkIF0gPSBuZXcgU291cmNlKCBpbWFnZUFycmF5ICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJLy8gbG9hZCBzaW5nbGUgaW1hZ2UKCgkJCQkJY29uc3QgZGVzZXJpYWxpemVkSW1hZ2UgPSBkZXNlcmlhbGl6ZUltYWdlKCBpbWFnZS51cmwgKTsKCQkJCQlpbWFnZXNbIGltYWdlLnV1aWQgXSA9IG5ldyBTb3VyY2UoIGRlc2VyaWFsaXplZEltYWdlICk7CgoKCQkJCX0KCgkJCX0KCgkJfQoKCQlyZXR1cm4gaW1hZ2VzOwoKCX0KCglhc3luYyBwYXJzZUltYWdlc0FzeW5jKCBqc29uICkgewoKCQljb25zdCBzY29wZSA9IHRoaXM7CgkJY29uc3QgaW1hZ2VzID0ge307CgoJCWxldCBsb2FkZXI7CgoJCWFzeW5jIGZ1bmN0aW9uIGRlc2VyaWFsaXplSW1hZ2UoIGltYWdlICkgewoKCQkJaWYgKCB0eXBlb2YgaW1hZ2UgPT09ICdzdHJpbmcnICkgewoKCQkJCWNvbnN0IHVybCA9IGltYWdlOwoKCQkJCWNvbnN0IHBhdGggPSAvXihcL1wvKXwoW2Etel0rOihcL1wvKT8pL2kudGVzdCggdXJsICkgPyB1cmwgOiBzY29wZS5yZXNvdXJjZVBhdGggKyB1cmw7CgoJCQkJcmV0dXJuIGF3YWl0IGxvYWRlci5sb2FkQXN5bmMoIHBhdGggKTsKCgkJCX0gZWxzZSB7CgoJCQkJaWYgKCBpbWFnZS5kYXRhICkgewoKCQkJCQlyZXR1cm4gewoJCQkJCQlkYXRhOiBnZXRUeXBlZEFycmF5KCBpbWFnZS50eXBlLCBpbWFnZS5kYXRhICksCgkJCQkJCXdpZHRoOiBpbWFnZS53aWR0aCwKCQkJCQkJaGVpZ2h0OiBpbWFnZS5oZWlnaHQKCQkJCQl9OwoKCQkJCX0gZWxzZSB7CgoJCQkJCXJldHVybiBudWxsOwoKCQkJCX0KCgkJCX0KCgkJfQoKCQlpZiAoIGpzb24gIT09IHVuZGVmaW5lZCAmJiBqc29uLmxlbmd0aCA+IDAgKSB7CgoJCQlsb2FkZXIgPSBuZXcgSW1hZ2VMb2FkZXIoIHRoaXMubWFuYWdlciApOwoJCQlsb2FkZXIuc2V0Q3Jvc3NPcmlnaW4oIHRoaXMuY3Jvc3NPcmlnaW4gKTsKCgkJCWZvciAoIGxldCBpID0gMCwgaWwgPSBqc29uLmxlbmd0aDsgaSA8IGlsOyBpICsrICkgewoKCQkJCWNvbnN0IGltYWdlID0ganNvblsgaSBdOwoJCQkJY29uc3QgdXJsID0gaW1hZ2UudXJsOwoKCQkJCWlmICggQXJyYXkuaXNBcnJheSggdXJsICkgKSB7CgoJCQkJCS8vIGxvYWQgYXJyYXkgb2YgaW1hZ2VzIGUuZyBDdWJlVGV4dHVyZQoKCQkJCQljb25zdCBpbWFnZUFycmF5ID0gW107CgoJCQkJCWZvciAoIGxldCBqID0gMCwgamwgPSB1cmwubGVuZ3RoOyBqIDwgamw7IGogKysgKSB7CgoJCQkJCQljb25zdCBjdXJyZW50VXJsID0gdXJsWyBqIF07CgoJCQkJCQljb25zdCBkZXNlcmlhbGl6ZWRJbWFnZSA9IGF3YWl0IGRlc2VyaWFsaXplSW1hZ2UoIGN1cnJlbnRVcmwgKTsKCgkJCQkJCWlmICggZGVzZXJpYWxpemVkSW1hZ2UgIT09IG51bGwgKSB7CgoJCQkJCQkJaWYgKCBkZXNlcmlhbGl6ZWRJbWFnZSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQgKSB7CgoJCQkJCQkJCWltYWdlQXJyYXkucHVzaCggZGVzZXJpYWxpemVkSW1hZ2UgKTsKCgkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQkvLyBzcGVjaWFsIGNhc2U6IGhhbmRsZSBhcnJheSBvZiBkYXRhIHRleHR1cmVzIGZvciBjdWJlIHRleHR1cmVzCgoJCQkJCQkJCWltYWdlQXJyYXkucHVzaCggbmV3IERhdGFUZXh0dXJlKCBkZXNlcmlhbGl6ZWRJbWFnZS5kYXRhLCBkZXNlcmlhbGl6ZWRJbWFnZS53aWR0aCwgZGVzZXJpYWxpemVkSW1hZ2UuaGVpZ2h0ICkgKTsKCgkJCQkJCQl9CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaW1hZ2VzWyBpbWFnZS51dWlkIF0gPSBuZXcgU291cmNlKCBpbWFnZUFycmF5ICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJLy8gbG9hZCBzaW5nbGUgaW1hZ2UKCgkJCQkJY29uc3QgZGVzZXJpYWxpemVkSW1hZ2UgPSBhd2FpdCBkZXNlcmlhbGl6ZUltYWdlKCBpbWFnZS51cmwgKTsKCQkJCQlpbWFnZXNbIGltYWdlLnV1aWQgXSA9IG5ldyBTb3VyY2UoIGRlc2VyaWFsaXplZEltYWdlICk7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCXJldHVybiBpbWFnZXM7CgoJfQoKCXBhcnNlVGV4dHVyZXMoIGpzb24sIGltYWdlcyApIHsKCgkJZnVuY3Rpb24gcGFyc2VDb25zdGFudCggdmFsdWUsIHR5cGUgKSB7CgoJCQlpZiAoIHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgKSByZXR1cm4gdmFsdWU7CgoJCQljb25zb2xlLndhcm4oICdUSFJFRS5PYmplY3RMb2FkZXIucGFyc2VUZXh0dXJlOiBDb25zdGFudCBzaG91bGQgYmUgaW4gbnVtZXJpYyBmb3JtLicsIHZhbHVlICk7CgoJCQlyZXR1cm4gdHlwZVsgdmFsdWUgXTsKCgkJfQoKCQljb25zdCB0ZXh0dXJlcyA9IHt9OwoKCQlpZiAoIGpzb24gIT09IHVuZGVmaW5lZCApIHsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IGpzb24ubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQljb25zdCBkYXRhID0ganNvblsgaSBdOwoKCQkJCWlmICggZGF0YS5pbWFnZSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCQljb25zb2xlLndhcm4oICdUSFJFRS5PYmplY3RMb2FkZXI6IE5vICJpbWFnZSIgc3BlY2lmaWVkIGZvcicsIGRhdGEudXVpZCApOwoKCQkJCX0KCgkJCQlpZiAoIGltYWdlc1sgZGF0YS5pbWFnZSBdID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLk9iamVjdExvYWRlcjogVW5kZWZpbmVkIGltYWdlJywgZGF0YS5pbWFnZSApOwoKCQkJCX0KCgkJCQljb25zdCBzb3VyY2UgPSBpbWFnZXNbIGRhdGEuaW1hZ2UgXTsKCQkJCWNvbnN0IGltYWdlID0gc291cmNlLmRhdGE7CgoJCQkJbGV0IHRleHR1cmU7CgoJCQkJaWYgKCBBcnJheS5pc0FycmF5KCBpbWFnZSApICkgewoKCQkJCQl0ZXh0dXJlID0gbmV3IEN1YmVUZXh0dXJlKCk7CgoJCQkJCWlmICggaW1hZ2UubGVuZ3RoID09PSA2ICkgdGV4dHVyZS5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBpbWFnZSAmJiBpbWFnZS5kYXRhICkgewoKCQkJCQkJdGV4dHVyZSA9IG5ldyBEYXRhVGV4dHVyZSgpOwoKCQkJCQl9IGVsc2UgewoKCQkJCQkJdGV4dHVyZSA9IG5ldyBUZXh0dXJlKCk7CgoJCQkJCX0KCgkJCQkJaWYgKCBpbWFnZSApIHRleHR1cmUubmVlZHNVcGRhdGUgPSB0cnVlOyAvLyB0ZXh0dXJlcyBjYW4gaGF2ZSB1bmRlZmluZWQgaW1hZ2UgZGF0YQoKCQkJCX0KCgkJCQl0ZXh0dXJlLnNvdXJjZSA9IHNvdXJjZTsKCgkJCQl0ZXh0dXJlLnV1aWQgPSBkYXRhLnV1aWQ7CgoJCQkJaWYgKCBkYXRhLm5hbWUgIT09IHVuZGVmaW5lZCApIHRleHR1cmUubmFtZSA9IGRhdGEubmFtZTsKCgkJCQlpZiAoIGRhdGEubWFwcGluZyAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5tYXBwaW5nID0gcGFyc2VDb25zdGFudCggZGF0YS5tYXBwaW5nLCBURVhUVVJFX01BUFBJTkcgKTsKCQkJCWlmICggZGF0YS5jaGFubmVsICE9PSB1bmRlZmluZWQgKSB0ZXh0dXJlLmNoYW5uZWwgPSBkYXRhLmNoYW5uZWw7CgoJCQkJaWYgKCBkYXRhLm9mZnNldCAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5vZmZzZXQuZnJvbUFycmF5KCBkYXRhLm9mZnNldCApOwoJCQkJaWYgKCBkYXRhLnJlcGVhdCAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5yZXBlYXQuZnJvbUFycmF5KCBkYXRhLnJlcGVhdCApOwoJCQkJaWYgKCBkYXRhLmNlbnRlciAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5jZW50ZXIuZnJvbUFycmF5KCBkYXRhLmNlbnRlciApOwoJCQkJaWYgKCBkYXRhLnJvdGF0aW9uICE9PSB1bmRlZmluZWQgKSB0ZXh0dXJlLnJvdGF0aW9uID0gZGF0YS5yb3RhdGlvbjsKCgkJCQlpZiAoIGRhdGEud3JhcCAhPT0gdW5kZWZpbmVkICkgewoKCQkJCQl0ZXh0dXJlLndyYXBTID0gcGFyc2VDb25zdGFudCggZGF0YS53cmFwWyAwIF0sIFRFWFRVUkVfV1JBUFBJTkcgKTsKCQkJCQl0ZXh0dXJlLndyYXBUID0gcGFyc2VDb25zdGFudCggZGF0YS53cmFwWyAxIF0sIFRFWFRVUkVfV1JBUFBJTkcgKTsKCgkJCQl9CgoJCQkJaWYgKCBkYXRhLmZvcm1hdCAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5mb3JtYXQgPSBkYXRhLmZvcm1hdDsKCQkJCWlmICggZGF0YS5pbnRlcm5hbEZvcm1hdCAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5pbnRlcm5hbEZvcm1hdCA9IGRhdGEuaW50ZXJuYWxGb3JtYXQ7CgkJCQlpZiAoIGRhdGEudHlwZSAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS50eXBlID0gZGF0YS50eXBlOwoJCQkJaWYgKCBkYXRhLmNvbG9yU3BhY2UgIT09IHVuZGVmaW5lZCApIHRleHR1cmUuY29sb3JTcGFjZSA9IGRhdGEuY29sb3JTcGFjZTsKCQkJCWlmICggZGF0YS5lbmNvZGluZyAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5lbmNvZGluZyA9IGRhdGEuZW5jb2Rpbmc7IC8vIEBkZXByZWNhdGVkLCByMTUyCgoJCQkJaWYgKCBkYXRhLm1pbkZpbHRlciAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5taW5GaWx0ZXIgPSBwYXJzZUNvbnN0YW50KCBkYXRhLm1pbkZpbHRlciwgVEVYVFVSRV9GSUxURVIgKTsKCQkJCWlmICggZGF0YS5tYWdGaWx0ZXIgIT09IHVuZGVmaW5lZCApIHRleHR1cmUubWFnRmlsdGVyID0gcGFyc2VDb25zdGFudCggZGF0YS5tYWdGaWx0ZXIsIFRFWFRVUkVfRklMVEVSICk7CgkJCQlpZiAoIGRhdGEuYW5pc290cm9weSAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5hbmlzb3Ryb3B5ID0gZGF0YS5hbmlzb3Ryb3B5OwoKCQkJCWlmICggZGF0YS5mbGlwWSAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5mbGlwWSA9IGRhdGEuZmxpcFk7CgoJCQkJaWYgKCBkYXRhLmdlbmVyYXRlTWlwbWFwcyAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5nZW5lcmF0ZU1pcG1hcHMgPSBkYXRhLmdlbmVyYXRlTWlwbWFwczsKCQkJCWlmICggZGF0YS5wcmVtdWx0aXBseUFscGhhICE9PSB1bmRlZmluZWQgKSB0ZXh0dXJlLnByZW11bHRpcGx5QWxwaGEgPSBkYXRhLnByZW11bHRpcGx5QWxwaGE7CgkJCQlpZiAoIGRhdGEudW5wYWNrQWxpZ25tZW50ICE9PSB1bmRlZmluZWQgKSB0ZXh0dXJlLnVucGFja0FsaWdubWVudCA9IGRhdGEudW5wYWNrQWxpZ25tZW50OwoJCQkJaWYgKCBkYXRhLmNvbXBhcmVGdW5jdGlvbiAhPT0gdW5kZWZpbmVkICkgdGV4dHVyZS5jb21wYXJlRnVuY3Rpb24gPSBkYXRhLmNvbXBhcmVGdW5jdGlvbjsKCgkJCQlpZiAoIGRhdGEudXNlckRhdGEgIT09IHVuZGVmaW5lZCApIHRleHR1cmUudXNlckRhdGEgPSBkYXRhLnVzZXJEYXRhOwoKCQkJCXRleHR1cmVzWyBkYXRhLnV1aWQgXSA9IHRleHR1cmU7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIHRleHR1cmVzOwoKCX0KCglwYXJzZU9iamVjdCggZGF0YSwgZ2VvbWV0cmllcywgbWF0ZXJpYWxzLCB0ZXh0dXJlcywgYW5pbWF0aW9ucyApIHsKCgkJbGV0IG9iamVjdDsKCgkJZnVuY3Rpb24gZ2V0R2VvbWV0cnkoIG5hbWUgKSB7CgoJCQlpZiAoIGdlb21ldHJpZXNbIG5hbWUgXSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLk9iamVjdExvYWRlcjogVW5kZWZpbmVkIGdlb21ldHJ5JywgbmFtZSApOwoKCQkJfQoKCQkJcmV0dXJuIGdlb21ldHJpZXNbIG5hbWUgXTsKCgkJfQoKCQlmdW5jdGlvbiBnZXRNYXRlcmlhbCggbmFtZSApIHsKCgkJCWlmICggbmFtZSA9PT0gdW5kZWZpbmVkICkgcmV0dXJuIHVuZGVmaW5lZDsKCgkJCWlmICggQXJyYXkuaXNBcnJheSggbmFtZSApICkgewoKCQkJCWNvbnN0IGFycmF5ID0gW107CgoJCQkJZm9yICggbGV0IGkgPSAwLCBsID0gbmFtZS5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCQljb25zdCB1dWlkID0gbmFtZVsgaSBdOwoKCQkJCQlpZiAoIG1hdGVyaWFsc1sgdXVpZCBdID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCQljb25zb2xlLndhcm4oICdUSFJFRS5PYmplY3RMb2FkZXI6IFVuZGVmaW5lZCBtYXRlcmlhbCcsIHV1aWQgKTsKCgkJCQkJfQoKCQkJCQlhcnJheS5wdXNoKCBtYXRlcmlhbHNbIHV1aWQgXSApOwoKCQkJCX0KCgkJCQlyZXR1cm4gYXJyYXk7CgoJCQl9CgoJCQlpZiAoIG1hdGVyaWFsc1sgbmFtZSBdID09PSB1bmRlZmluZWQgKSB7CgoJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuT2JqZWN0TG9hZGVyOiBVbmRlZmluZWQgbWF0ZXJpYWwnLCBuYW1lICk7CgoJCQl9CgoJCQlyZXR1cm4gbWF0ZXJpYWxzWyBuYW1lIF07CgoJCX0KCgkJZnVuY3Rpb24gZ2V0VGV4dHVyZSggdXVpZCApIHsKCgkJCWlmICggdGV4dHVyZXNbIHV1aWQgXSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLk9iamVjdExvYWRlcjogVW5kZWZpbmVkIHRleHR1cmUnLCB1dWlkICk7CgoJCQl9CgoJCQlyZXR1cm4gdGV4dHVyZXNbIHV1aWQgXTsKCgkJfQoKCQlsZXQgZ2VvbWV0cnksIG1hdGVyaWFsOwoKCQlzd2l0Y2ggKCBkYXRhLnR5cGUgKSB7CgoJCQljYXNlICdTY2VuZSc6CgoJCQkJb2JqZWN0ID0gbmV3IFNjZW5lKCk7CgoJCQkJaWYgKCBkYXRhLmJhY2tncm91bmQgIT09IHVuZGVmaW5lZCApIHsKCgkJCQkJaWYgKCBOdW1iZXIuaXNJbnRlZ2VyKCBkYXRhLmJhY2tncm91bmQgKSApIHsKCgkJCQkJCW9iamVjdC5iYWNrZ3JvdW5kID0gbmV3IENvbG9yKCBkYXRhLmJhY2tncm91bmQgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCW9iamVjdC5iYWNrZ3JvdW5kID0gZ2V0VGV4dHVyZSggZGF0YS5iYWNrZ3JvdW5kICk7CgoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKCBkYXRhLmVudmlyb25tZW50ICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJCW9iamVjdC5lbnZpcm9ubWVudCA9IGdldFRleHR1cmUoIGRhdGEuZW52aXJvbm1lbnQgKTsKCgkJCQl9CgoJCQkJaWYgKCBkYXRhLmZvZyAhPT0gdW5kZWZpbmVkICkgewoKCQkJCQlpZiAoIGRhdGEuZm9nLnR5cGUgPT09ICdGb2cnICkgewoKCQkJCQkJb2JqZWN0LmZvZyA9IG5ldyBGb2coIGRhdGEuZm9nLmNvbG9yLCBkYXRhLmZvZy5uZWFyLCBkYXRhLmZvZy5mYXIgKTsKCgkJCQkJfSBlbHNlIGlmICggZGF0YS5mb2cudHlwZSA9PT0gJ0ZvZ0V4cDInICkgewoKCQkJCQkJb2JqZWN0LmZvZyA9IG5ldyBGb2dFeHAyKCBkYXRhLmZvZy5jb2xvciwgZGF0YS5mb2cuZGVuc2l0eSApOwoKCQkJCQl9CgoJCQkJCWlmICggZGF0YS5mb2cubmFtZSAhPT0gJycgKSB7CgoJCQkJCQlvYmplY3QuZm9nLm5hbWUgPSBkYXRhLmZvZy5uYW1lOwoKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICggZGF0YS5iYWNrZ3JvdW5kQmx1cnJpbmVzcyAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LmJhY2tncm91bmRCbHVycmluZXNzID0gZGF0YS5iYWNrZ3JvdW5kQmx1cnJpbmVzczsKCQkJCWlmICggZGF0YS5iYWNrZ3JvdW5kSW50ZW5zaXR5ICE9PSB1bmRlZmluZWQgKSBvYmplY3QuYmFja2dyb3VuZEludGVuc2l0eSA9IGRhdGEuYmFja2dyb3VuZEludGVuc2l0eTsKCgkJCQlicmVhazsKCgkJCWNhc2UgJ1BlcnNwZWN0aXZlQ2FtZXJhJzoKCgkJCQlvYmplY3QgPSBuZXcgUGVyc3BlY3RpdmVDYW1lcmEoIGRhdGEuZm92LCBkYXRhLmFzcGVjdCwgZGF0YS5uZWFyLCBkYXRhLmZhciApOwoKCQkJCWlmICggZGF0YS5mb2N1cyAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LmZvY3VzID0gZGF0YS5mb2N1czsKCQkJCWlmICggZGF0YS56b29tICE9PSB1bmRlZmluZWQgKSBvYmplY3Quem9vbSA9IGRhdGEuem9vbTsKCQkJCWlmICggZGF0YS5maWxtR2F1Z2UgIT09IHVuZGVmaW5lZCApIG9iamVjdC5maWxtR2F1Z2UgPSBkYXRhLmZpbG1HYXVnZTsKCQkJCWlmICggZGF0YS5maWxtT2Zmc2V0ICE9PSB1bmRlZmluZWQgKSBvYmplY3QuZmlsbU9mZnNldCA9IGRhdGEuZmlsbU9mZnNldDsKCQkJCWlmICggZGF0YS52aWV3ICE9PSB1bmRlZmluZWQgKSBvYmplY3QudmlldyA9IE9iamVjdC5hc3NpZ24oIHt9LCBkYXRhLnZpZXcgKTsKCgkJCQlicmVhazsKCgkJCWNhc2UgJ09ydGhvZ3JhcGhpY0NhbWVyYSc6CgoJCQkJb2JqZWN0ID0gbmV3IE9ydGhvZ3JhcGhpY0NhbWVyYSggZGF0YS5sZWZ0LCBkYXRhLnJpZ2h0LCBkYXRhLnRvcCwgZGF0YS5ib3R0b20sIGRhdGEubmVhciwgZGF0YS5mYXIgKTsKCgkJCQlpZiAoIGRhdGEuem9vbSAhPT0gdW5kZWZpbmVkICkgb2JqZWN0Lnpvb20gPSBkYXRhLnpvb207CgkJCQlpZiAoIGRhdGEudmlldyAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LnZpZXcgPSBPYmplY3QuYXNzaWduKCB7fSwgZGF0YS52aWV3ICk7CgoJCQkJYnJlYWs7CgoJCQljYXNlICdBbWJpZW50TGlnaHQnOgoKCQkJCW9iamVjdCA9IG5ldyBBbWJpZW50TGlnaHQoIGRhdGEuY29sb3IsIGRhdGEuaW50ZW5zaXR5ICk7CgoJCQkJYnJlYWs7CgoJCQljYXNlICdEaXJlY3Rpb25hbExpZ2h0JzoKCgkJCQlvYmplY3QgPSBuZXcgRGlyZWN0aW9uYWxMaWdodCggZGF0YS5jb2xvciwgZGF0YS5pbnRlbnNpdHkgKTsKCgkJCQlicmVhazsKCgkJCWNhc2UgJ1BvaW50TGlnaHQnOgoKCQkJCW9iamVjdCA9IG5ldyBQb2ludExpZ2h0KCBkYXRhLmNvbG9yLCBkYXRhLmludGVuc2l0eSwgZGF0YS5kaXN0YW5jZSwgZGF0YS5kZWNheSApOwoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnUmVjdEFyZWFMaWdodCc6CgoJCQkJb2JqZWN0ID0gbmV3IFJlY3RBcmVhTGlnaHQoIGRhdGEuY29sb3IsIGRhdGEuaW50ZW5zaXR5LCBkYXRhLndpZHRoLCBkYXRhLmhlaWdodCApOwoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnU3BvdExpZ2h0JzoKCgkJCQlvYmplY3QgPSBuZXcgU3BvdExpZ2h0KCBkYXRhLmNvbG9yLCBkYXRhLmludGVuc2l0eSwgZGF0YS5kaXN0YW5jZSwgZGF0YS5hbmdsZSwgZGF0YS5wZW51bWJyYSwgZGF0YS5kZWNheSApOwoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnSGVtaXNwaGVyZUxpZ2h0JzoKCgkJCQlvYmplY3QgPSBuZXcgSGVtaXNwaGVyZUxpZ2h0KCBkYXRhLmNvbG9yLCBkYXRhLmdyb3VuZENvbG9yLCBkYXRhLmludGVuc2l0eSApOwoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnTGlnaHRQcm9iZSc6CgoJCQkJb2JqZWN0ID0gbmV3IExpZ2h0UHJvYmUoKS5mcm9tSlNPTiggZGF0YSApOwoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnU2tpbm5lZE1lc2gnOgoKCQkJCWdlb21ldHJ5ID0gZ2V0R2VvbWV0cnkoIGRhdGEuZ2VvbWV0cnkgKTsKCQkJIAltYXRlcmlhbCA9IGdldE1hdGVyaWFsKCBkYXRhLm1hdGVyaWFsICk7CgoJCQkJb2JqZWN0ID0gbmV3IFNraW5uZWRNZXNoKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTsKCgkJCQlpZiAoIGRhdGEuYmluZE1vZGUgIT09IHVuZGVmaW5lZCApIG9iamVjdC5iaW5kTW9kZSA9IGRhdGEuYmluZE1vZGU7CgkJCQlpZiAoIGRhdGEuYmluZE1hdHJpeCAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LmJpbmRNYXRyaXguZnJvbUFycmF5KCBkYXRhLmJpbmRNYXRyaXggKTsKCQkJCWlmICggZGF0YS5za2VsZXRvbiAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LnNrZWxldG9uID0gZGF0YS5za2VsZXRvbjsKCgkJCQlicmVhazsKCgkJCWNhc2UgJ01lc2gnOgoKCQkJCWdlb21ldHJ5ID0gZ2V0R2VvbWV0cnkoIGRhdGEuZ2VvbWV0cnkgKTsKCQkJCW1hdGVyaWFsID0gZ2V0TWF0ZXJpYWwoIGRhdGEubWF0ZXJpYWwgKTsKCgkJCQlvYmplY3QgPSBuZXcgTWVzaCggZ2VvbWV0cnksIG1hdGVyaWFsICk7CgoJCQkJYnJlYWs7CgoJCQljYXNlICdJbnN0YW5jZWRNZXNoJzoKCgkJCQlnZW9tZXRyeSA9IGdldEdlb21ldHJ5KCBkYXRhLmdlb21ldHJ5ICk7CgkJCQltYXRlcmlhbCA9IGdldE1hdGVyaWFsKCBkYXRhLm1hdGVyaWFsICk7CgkJCQljb25zdCBjb3VudCA9IGRhdGEuY291bnQ7CgkJCQljb25zdCBpbnN0YW5jZU1hdHJpeCA9IGRhdGEuaW5zdGFuY2VNYXRyaXg7CgkJCQljb25zdCBpbnN0YW5jZUNvbG9yID0gZGF0YS5pbnN0YW5jZUNvbG9yOwoKCQkJCW9iamVjdCA9IG5ldyBJbnN0YW5jZWRNZXNoKCBnZW9tZXRyeSwgbWF0ZXJpYWwsIGNvdW50ICk7CgkJCQlvYmplY3QuaW5zdGFuY2VNYXRyaXggPSBuZXcgSW5zdGFuY2VkQnVmZmVyQXR0cmlidXRlKCBuZXcgRmxvYXQzMkFycmF5KCBpbnN0YW5jZU1hdHJpeC5hcnJheSApLCAxNiApOwoJCQkJaWYgKCBpbnN0YW5jZUNvbG9yICE9PSB1bmRlZmluZWQgKSBvYmplY3QuaW5zdGFuY2VDb2xvciA9IG5ldyBJbnN0YW5jZWRCdWZmZXJBdHRyaWJ1dGUoIG5ldyBGbG9hdDMyQXJyYXkoIGluc3RhbmNlQ29sb3IuYXJyYXkgKSwgaW5zdGFuY2VDb2xvci5pdGVtU2l6ZSApOwoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnQmF0Y2hlZE1lc2gnOgoKCQkJCWdlb21ldHJ5ID0gZ2V0R2VvbWV0cnkoIGRhdGEuZ2VvbWV0cnkgKTsKCQkJCW1hdGVyaWFsID0gZ2V0TWF0ZXJpYWwoIGRhdGEubWF0ZXJpYWwgKTsKCgkJCQlvYmplY3QgPSBuZXcgQmF0Y2hlZE1lc2goIGRhdGEubWF4R2VvbWV0cnlDb3VudCwgZGF0YS5tYXhWZXJ0ZXhDb3VudCwgZGF0YS5tYXhJbmRleENvdW50LCBtYXRlcmlhbCApOwoJCQkJb2JqZWN0Lmdlb21ldHJ5ID0gZ2VvbWV0cnk7CgkJCQlvYmplY3QucGVyT2JqZWN0RnJ1c3R1bUN1bGxlZCA9IGRhdGEucGVyT2JqZWN0RnJ1c3R1bUN1bGxlZDsKCQkJCW9iamVjdC5zb3J0T2JqZWN0cyA9IGRhdGEuc29ydE9iamVjdHM7CgoJCQkJb2JqZWN0Ll9kcmF3UmFuZ2VzID0gZGF0YS5kcmF3UmFuZ2VzOwoJCQkJb2JqZWN0Ll9yZXNlcnZlZFJhbmdlcyA9IGRhdGEucmVzZXJ2ZWRSYW5nZXM7CgoJCQkJb2JqZWN0Ll92aXNpYmlsaXR5ID0gZGF0YS52aXNpYmlsaXR5OwoJCQkJb2JqZWN0Ll9hY3RpdmUgPSBkYXRhLmFjdGl2ZTsKCQkJCW9iamVjdC5fYm91bmRzID0gZGF0YS5ib3VuZHMubWFwKCBib3VuZCA9PiB7CgoJCQkJCWNvbnN0IGJveCA9IG5ldyBCb3gzKCk7CgkJCQkJYm94Lm1pbi5mcm9tQXJyYXkoIGJvdW5kLmJveE1pbiApOwoJCQkJCWJveC5tYXguZnJvbUFycmF5KCBib3VuZC5ib3hNYXggKTsKCgkJCQkJY29uc3Qgc3BoZXJlID0gbmV3IFNwaGVyZSgpOwoJCQkJCXNwaGVyZS5yYWRpdXMgPSBib3VuZC5zcGhlcmVSYWRpdXM7CgkJCQkJc3BoZXJlLmNlbnRlci5mcm9tQXJyYXkoIGJvdW5kLnNwaGVyZUNlbnRlciApOwoKCQkJCQlyZXR1cm4gewoJCQkJCQlib3hJbml0aWFsaXplZDogYm91bmQuYm94SW5pdGlhbGl6ZWQsCgkJCQkJCWJveDogYm94LAoKCQkJCQkJc3BoZXJlSW5pdGlhbGl6ZWQ6IGJvdW5kLnNwaGVyZUluaXRpYWxpemVkLAoJCQkJCQlzcGhlcmU6IHNwaGVyZQoJCQkJCX07CgoJCQkJfSApOwoKCQkJCW9iamVjdC5fbWF4R2VvbWV0cnlDb3VudCA9IGRhdGEubWF4R2VvbWV0cnlDb3VudDsKCQkJCW9iamVjdC5fbWF4VmVydGV4Q291bnQgPSBkYXRhLm1heFZlcnRleENvdW50OwoJCQkJb2JqZWN0Ll9tYXhJbmRleENvdW50ID0gZGF0YS5tYXhJbmRleENvdW50OwoKCQkJCW9iamVjdC5fZ2VvbWV0cnlJbml0aWFsaXplZCA9IGRhdGEuZ2VvbWV0cnlJbml0aWFsaXplZDsKCQkJCW9iamVjdC5fZ2VvbWV0cnlDb3VudCA9IGRhdGEuZ2VvbWV0cnlDb3VudDsKCgkJCQlvYmplY3QuX21hdHJpY2VzVGV4dHVyZSA9IGdldFRleHR1cmUoIGRhdGEubWF0cmljZXNUZXh0dXJlLnV1aWQgKTsKCgkJCQlicmVhazsKCgkJCWNhc2UgJ0xPRCc6CgoJCQkJb2JqZWN0ID0gbmV3IExPRCgpOwoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnTGluZSc6CgoJCQkJb2JqZWN0ID0gbmV3IExpbmUoIGdldEdlb21ldHJ5KCBkYXRhLmdlb21ldHJ5ICksIGdldE1hdGVyaWFsKCBkYXRhLm1hdGVyaWFsICkgKTsKCgkJCQlicmVhazsKCgkJCWNhc2UgJ0xpbmVMb29wJzoKCgkJCQlvYmplY3QgPSBuZXcgTGluZUxvb3AoIGdldEdlb21ldHJ5KCBkYXRhLmdlb21ldHJ5ICksIGdldE1hdGVyaWFsKCBkYXRhLm1hdGVyaWFsICkgKTsKCgkJCQlicmVhazsKCgkJCWNhc2UgJ0xpbmVTZWdtZW50cyc6CgoJCQkJb2JqZWN0ID0gbmV3IExpbmVTZWdtZW50cyggZ2V0R2VvbWV0cnkoIGRhdGEuZ2VvbWV0cnkgKSwgZ2V0TWF0ZXJpYWwoIGRhdGEubWF0ZXJpYWwgKSApOwoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnUG9pbnRDbG91ZCc6CgkJCWNhc2UgJ1BvaW50cyc6CgoJCQkJb2JqZWN0ID0gbmV3IFBvaW50cyggZ2V0R2VvbWV0cnkoIGRhdGEuZ2VvbWV0cnkgKSwgZ2V0TWF0ZXJpYWwoIGRhdGEubWF0ZXJpYWwgKSApOwoKCQkJCWJyZWFrOwoKCQkJY2FzZSAnU3ByaXRlJzoKCgkJCQlvYmplY3QgPSBuZXcgU3ByaXRlKCBnZXRNYXRlcmlhbCggZGF0YS5tYXRlcmlhbCApICk7CgoJCQkJYnJlYWs7CgoJCQljYXNlICdHcm91cCc6CgoJCQkJb2JqZWN0ID0gbmV3IEdyb3VwKCk7CgoJCQkJYnJlYWs7CgoJCQljYXNlICdCb25lJzoKCgkJCQlvYmplY3QgPSBuZXcgQm9uZSgpOwoKCQkJCWJyZWFrOwoKCQkJZGVmYXVsdDoKCgkJCQlvYmplY3QgPSBuZXcgT2JqZWN0M0QoKTsKCgkJfQoKCQlvYmplY3QudXVpZCA9IGRhdGEudXVpZDsKCgkJaWYgKCBkYXRhLm5hbWUgIT09IHVuZGVmaW5lZCApIG9iamVjdC5uYW1lID0gZGF0YS5uYW1lOwoKCQlpZiAoIGRhdGEubWF0cml4ICE9PSB1bmRlZmluZWQgKSB7CgoJCQlvYmplY3QubWF0cml4LmZyb21BcnJheSggZGF0YS5tYXRyaXggKTsKCgkJCWlmICggZGF0YS5tYXRyaXhBdXRvVXBkYXRlICE9PSB1bmRlZmluZWQgKSBvYmplY3QubWF0cml4QXV0b1VwZGF0ZSA9IGRhdGEubWF0cml4QXV0b1VwZGF0ZTsKCQkJaWYgKCBvYmplY3QubWF0cml4QXV0b1VwZGF0ZSApIG9iamVjdC5tYXRyaXguZGVjb21wb3NlKCBvYmplY3QucG9zaXRpb24sIG9iamVjdC5xdWF0ZXJuaW9uLCBvYmplY3Quc2NhbGUgKTsKCgkJfSBlbHNlIHsKCgkJCWlmICggZGF0YS5wb3NpdGlvbiAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LnBvc2l0aW9uLmZyb21BcnJheSggZGF0YS5wb3NpdGlvbiApOwoJCQlpZiAoIGRhdGEucm90YXRpb24gIT09IHVuZGVmaW5lZCApIG9iamVjdC5yb3RhdGlvbi5mcm9tQXJyYXkoIGRhdGEucm90YXRpb24gKTsKCQkJaWYgKCBkYXRhLnF1YXRlcm5pb24gIT09IHVuZGVmaW5lZCApIG9iamVjdC5xdWF0ZXJuaW9uLmZyb21BcnJheSggZGF0YS5xdWF0ZXJuaW9uICk7CgkJCWlmICggZGF0YS5zY2FsZSAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LnNjYWxlLmZyb21BcnJheSggZGF0YS5zY2FsZSApOwoKCQl9CgoJCWlmICggZGF0YS51cCAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LnVwLmZyb21BcnJheSggZGF0YS51cCApOwoKCQlpZiAoIGRhdGEuY2FzdFNoYWRvdyAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LmNhc3RTaGFkb3cgPSBkYXRhLmNhc3RTaGFkb3c7CgkJaWYgKCBkYXRhLnJlY2VpdmVTaGFkb3cgIT09IHVuZGVmaW5lZCApIG9iamVjdC5yZWNlaXZlU2hhZG93ID0gZGF0YS5yZWNlaXZlU2hhZG93OwoKCQlpZiAoIGRhdGEuc2hhZG93ICkgewoKCQkJaWYgKCBkYXRhLnNoYWRvdy5iaWFzICE9PSB1bmRlZmluZWQgKSBvYmplY3Quc2hhZG93LmJpYXMgPSBkYXRhLnNoYWRvdy5iaWFzOwoJCQlpZiAoIGRhdGEuc2hhZG93Lm5vcm1hbEJpYXMgIT09IHVuZGVmaW5lZCApIG9iamVjdC5zaGFkb3cubm9ybWFsQmlhcyA9IGRhdGEuc2hhZG93Lm5vcm1hbEJpYXM7CgkJCWlmICggZGF0YS5zaGFkb3cucmFkaXVzICE9PSB1bmRlZmluZWQgKSBvYmplY3Quc2hhZG93LnJhZGl1cyA9IGRhdGEuc2hhZG93LnJhZGl1czsKCQkJaWYgKCBkYXRhLnNoYWRvdy5tYXBTaXplICE9PSB1bmRlZmluZWQgKSBvYmplY3Quc2hhZG93Lm1hcFNpemUuZnJvbUFycmF5KCBkYXRhLnNoYWRvdy5tYXBTaXplICk7CgkJCWlmICggZGF0YS5zaGFkb3cuY2FtZXJhICE9PSB1bmRlZmluZWQgKSBvYmplY3Quc2hhZG93LmNhbWVyYSA9IHRoaXMucGFyc2VPYmplY3QoIGRhdGEuc2hhZG93LmNhbWVyYSApOwoKCQl9CgoJCWlmICggZGF0YS52aXNpYmxlICE9PSB1bmRlZmluZWQgKSBvYmplY3QudmlzaWJsZSA9IGRhdGEudmlzaWJsZTsKCQlpZiAoIGRhdGEuZnJ1c3R1bUN1bGxlZCAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LmZydXN0dW1DdWxsZWQgPSBkYXRhLmZydXN0dW1DdWxsZWQ7CgkJaWYgKCBkYXRhLnJlbmRlck9yZGVyICE9PSB1bmRlZmluZWQgKSBvYmplY3QucmVuZGVyT3JkZXIgPSBkYXRhLnJlbmRlck9yZGVyOwoJCWlmICggZGF0YS51c2VyRGF0YSAhPT0gdW5kZWZpbmVkICkgb2JqZWN0LnVzZXJEYXRhID0gZGF0YS51c2VyRGF0YTsKCQlpZiAoIGRhdGEubGF5ZXJzICE9PSB1bmRlZmluZWQgKSBvYmplY3QubGF5ZXJzLm1hc2sgPSBkYXRhLmxheWVyczsKCgkJaWYgKCBkYXRhLmNoaWxkcmVuICE9PSB1bmRlZmluZWQgKSB7CgoJCQljb25zdCBjaGlsZHJlbiA9IGRhdGEuY2hpbGRyZW47CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkgKysgKSB7CgoJCQkJb2JqZWN0LmFkZCggdGhpcy5wYXJzZU9iamVjdCggY2hpbGRyZW5bIGkgXSwgZ2VvbWV0cmllcywgbWF0ZXJpYWxzLCB0ZXh0dXJlcywgYW5pbWF0aW9ucyApICk7CgoJCQl9CgoJCX0KCgkJaWYgKCBkYXRhLmFuaW1hdGlvbnMgIT09IHVuZGVmaW5lZCApIHsKCgkJCWNvbnN0IG9iamVjdEFuaW1hdGlvbnMgPSBkYXRhLmFuaW1hdGlvbnM7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBvYmplY3RBbmltYXRpb25zLmxlbmd0aDsgaSArKyApIHsKCgkJCQljb25zdCB1dWlkID0gb2JqZWN0QW5pbWF0aW9uc1sgaSBdOwoKCQkJCW9iamVjdC5hbmltYXRpb25zLnB1c2goIGFuaW1hdGlvbnNbIHV1aWQgXSApOwoKCQkJfQoKCQl9CgoJCWlmICggZGF0YS50eXBlID09PSAnTE9EJyApIHsKCgkJCWlmICggZGF0YS5hdXRvVXBkYXRlICE9PSB1bmRlZmluZWQgKSBvYmplY3QuYXV0b1VwZGF0ZSA9IGRhdGEuYXV0b1VwZGF0ZTsKCgkJCWNvbnN0IGxldmVscyA9IGRhdGEubGV2ZWxzOwoKCQkJZm9yICggbGV0IGwgPSAwOyBsIDwgbGV2ZWxzLmxlbmd0aDsgbCArKyApIHsKCgkJCQljb25zdCBsZXZlbCA9IGxldmVsc1sgbCBdOwoJCQkJY29uc3QgY2hpbGQgPSBvYmplY3QuZ2V0T2JqZWN0QnlQcm9wZXJ0eSggJ3V1aWQnLCBsZXZlbC5vYmplY3QgKTsKCgkJCQlpZiAoIGNoaWxkICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJCW9iamVjdC5hZGRMZXZlbCggY2hpbGQsIGxldmVsLmRpc3RhbmNlLCBsZXZlbC5oeXN0ZXJlc2lzICk7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCXJldHVybiBvYmplY3Q7CgoJfQoKCWJpbmRTa2VsZXRvbnMoIG9iamVjdCwgc2tlbGV0b25zICkgewoKCQlpZiAoIE9iamVjdC5rZXlzKCBza2VsZXRvbnMgKS5sZW5ndGggPT09IDAgKSByZXR1cm47CgoJCW9iamVjdC50cmF2ZXJzZSggZnVuY3Rpb24gKCBjaGlsZCApIHsKCgkJCWlmICggY2hpbGQuaXNTa2lubmVkTWVzaCA9PT0gdHJ1ZSAmJiBjaGlsZC5za2VsZXRvbiAhPT0gdW5kZWZpbmVkICkgewoKCQkJCWNvbnN0IHNrZWxldG9uID0gc2tlbGV0b25zWyBjaGlsZC5za2VsZXRvbiBdOwoKCQkJCWlmICggc2tlbGV0b24gPT09IHVuZGVmaW5lZCApIHsKCgkJCQkJY29uc29sZS53YXJuKCAnVEhSRUUuT2JqZWN0TG9hZGVyOiBObyBza2VsZXRvbiBmb3VuZCB3aXRoIFVVSUQ6JywgY2hpbGQuc2tlbGV0b24gKTsKCgkJCQl9IGVsc2UgewoKCQkJCQljaGlsZC5iaW5kKCBza2VsZXRvbiwgY2hpbGQuYmluZE1hdHJpeCApOwoKCQkJCX0KCgkJCX0KCgkJfSApOwoKCX0KCn0KCmNvbnN0IFRFWFRVUkVfTUFQUElORyA9IHsKCVVWTWFwcGluZzogVVZNYXBwaW5nLAoJQ3ViZVJlZmxlY3Rpb25NYXBwaW5nOiBDdWJlUmVmbGVjdGlvbk1hcHBpbmcsCglDdWJlUmVmcmFjdGlvbk1hcHBpbmc6IEN1YmVSZWZyYWN0aW9uTWFwcGluZywKCUVxdWlyZWN0YW5ndWxhclJlZmxlY3Rpb25NYXBwaW5nOiBFcXVpcmVjdGFuZ3VsYXJSZWZsZWN0aW9uTWFwcGluZywKCUVxdWlyZWN0YW5ndWxhclJlZnJhY3Rpb25NYXBwaW5nOiBFcXVpcmVjdGFuZ3VsYXJSZWZyYWN0aW9uTWFwcGluZywKCUN1YmVVVlJlZmxlY3Rpb25NYXBwaW5nOiBDdWJlVVZSZWZsZWN0aW9uTWFwcGluZwp9OwoKY29uc3QgVEVYVFVSRV9XUkFQUElORyA9IHsKCVJlcGVhdFdyYXBwaW5nOiBSZXBlYXRXcmFwcGluZywKCUNsYW1wVG9FZGdlV3JhcHBpbmc6IENsYW1wVG9FZGdlV3JhcHBpbmcsCglNaXJyb3JlZFJlcGVhdFdyYXBwaW5nOiBNaXJyb3JlZFJlcGVhdFdyYXBwaW5nCn07Cgpjb25zdCBURVhUVVJFX0ZJTFRFUiA9IHsKCU5lYXJlc3RGaWx0ZXI6IE5lYXJlc3RGaWx0ZXIsCglOZWFyZXN0TWlwbWFwTmVhcmVzdEZpbHRlcjogTmVhcmVzdE1pcG1hcE5lYXJlc3RGaWx0ZXIsCglOZWFyZXN0TWlwbWFwTGluZWFyRmlsdGVyOiBOZWFyZXN0TWlwbWFwTGluZWFyRmlsdGVyLAoJTGluZWFyRmlsdGVyOiBMaW5lYXJGaWx0ZXIsCglMaW5lYXJNaXBtYXBOZWFyZXN0RmlsdGVyOiBMaW5lYXJNaXBtYXBOZWFyZXN0RmlsdGVyLAoJTGluZWFyTWlwbWFwTGluZWFyRmlsdGVyOiBMaW5lYXJNaXBtYXBMaW5lYXJGaWx0ZXIKfTsKCmNsYXNzIEltYWdlQml0bWFwTG9hZGVyIGV4dGVuZHMgTG9hZGVyIHsKCgljb25zdHJ1Y3RvciggbWFuYWdlciApIHsKCgkJc3VwZXIoIG1hbmFnZXIgKTsKCgkJdGhpcy5pc0ltYWdlQml0bWFwTG9hZGVyID0gdHJ1ZTsKCgkJaWYgKCB0eXBlb2YgY3JlYXRlSW1hZ2VCaXRtYXAgPT09ICd1bmRlZmluZWQnICkgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuSW1hZ2VCaXRtYXBMb2FkZXI6IGNyZWF0ZUltYWdlQml0bWFwKCkgbm90IHN1cHBvcnRlZC4nICk7CgoJCX0KCgkJaWYgKCB0eXBlb2YgZmV0Y2ggPT09ICd1bmRlZmluZWQnICkgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuSW1hZ2VCaXRtYXBMb2FkZXI6IGZldGNoKCkgbm90IHN1cHBvcnRlZC4nICk7CgoJCX0KCgkJdGhpcy5vcHRpb25zID0geyBwcmVtdWx0aXBseUFscGhhOiAnbm9uZScgfTsKCgl9CgoJc2V0T3B0aW9ucyggb3B0aW9ucyApIHsKCgkJdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWxvYWQoIHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yICkgewoKCQlpZiAoIHVybCA9PT0gdW5kZWZpbmVkICkgdXJsID0gJyc7CgoJCWlmICggdGhpcy5wYXRoICE9PSB1bmRlZmluZWQgKSB1cmwgPSB0aGlzLnBhdGggKyB1cmw7CgoJCXVybCA9IHRoaXMubWFuYWdlci5yZXNvbHZlVVJMKCB1cmwgKTsKCgkJY29uc3Qgc2NvcGUgPSB0aGlzOwoKCQljb25zdCBjYWNoZWQgPSBDYWNoZS5nZXQoIHVybCApOwoKCQlpZiAoIGNhY2hlZCAhPT0gdW5kZWZpbmVkICkgewoKCQkJc2NvcGUubWFuYWdlci5pdGVtU3RhcnQoIHVybCApOwoKCQkJLy8gSWYgY2FjaGVkIGlzIGEgcHJvbWlzZSwgd2FpdCBmb3IgaXQgdG8gcmVzb2x2ZQoJCQlpZiAoIGNhY2hlZC50aGVuICkgewoKCQkJCWNhY2hlZC50aGVuKCBpbWFnZUJpdG1hcCA9PiB7CgoJCQkJCWlmICggb25Mb2FkICkgb25Mb2FkKCBpbWFnZUJpdG1hcCApOwoKCQkJCQlzY29wZS5tYW5hZ2VyLml0ZW1FbmQoIHVybCApOwoKCQkJCX0gKS5jYXRjaCggZSA9PiB7CgoJCQkJCWlmICggb25FcnJvciApIG9uRXJyb3IoIGUgKTsKCgkJCQl9ICk7CgkJCQlyZXR1cm47CgoJCQl9CgoJCQkvLyBJZiBjYWNoZWQgaXMgbm90IGEgcHJvbWlzZSAoaS5lLiwgaXQncyBhbHJlYWR5IGFuIGltYWdlQml0bWFwKQoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbiAoKSB7CgoJCQkJaWYgKCBvbkxvYWQgKSBvbkxvYWQoIGNhY2hlZCApOwoKCQkJCXNjb3BlLm1hbmFnZXIuaXRlbUVuZCggdXJsICk7CgoJCQl9LCAwICk7CgoJCQlyZXR1cm4gY2FjaGVkOwoKCQl9CgoJCWNvbnN0IGZldGNoT3B0aW9ucyA9IHt9OwoJCWZldGNoT3B0aW9ucy5jcmVkZW50aWFscyA9ICggdGhpcy5jcm9zc09yaWdpbiA9PT0gJ2Fub255bW91cycgKSA/ICdzYW1lLW9yaWdpbicgOiAnaW5jbHVkZSc7CgkJZmV0Y2hPcHRpb25zLmhlYWRlcnMgPSB0aGlzLnJlcXVlc3RIZWFkZXI7CgoJCWNvbnN0IHByb21pc2UgPSBmZXRjaCggdXJsLCBmZXRjaE9wdGlvbnMgKS50aGVuKCBmdW5jdGlvbiAoIHJlcyApIHsKCgkJCXJldHVybiByZXMuYmxvYigpOwoKCQl9ICkudGhlbiggZnVuY3Rpb24gKCBibG9iICkgewoKCQkJcmV0dXJuIGNyZWF0ZUltYWdlQml0bWFwKCBibG9iLCBPYmplY3QuYXNzaWduKCBzY29wZS5vcHRpb25zLCB7IGNvbG9yU3BhY2VDb252ZXJzaW9uOiAnbm9uZScgfSApICk7CgoJCX0gKS50aGVuKCBmdW5jdGlvbiAoIGltYWdlQml0bWFwICkgewoKCQkJQ2FjaGUuYWRkKCB1cmwsIGltYWdlQml0bWFwICk7CgoJCQlpZiAoIG9uTG9hZCApIG9uTG9hZCggaW1hZ2VCaXRtYXAgKTsKCgkJCXNjb3BlLm1hbmFnZXIuaXRlbUVuZCggdXJsICk7CgoJCQlyZXR1cm4gaW1hZ2VCaXRtYXA7CgoJCX0gKS5jYXRjaCggZnVuY3Rpb24gKCBlICkgewoKCQkJaWYgKCBvbkVycm9yICkgb25FcnJvciggZSApOwoKCQkJQ2FjaGUucmVtb3ZlKCB1cmwgKTsKCgkJCXNjb3BlLm1hbmFnZXIuaXRlbUVycm9yKCB1cmwgKTsKCQkJc2NvcGUubWFuYWdlci5pdGVtRW5kKCB1cmwgKTsKCgkJfSApOwoKCQlDYWNoZS5hZGQoIHVybCwgcHJvbWlzZSApOwoJCXNjb3BlLm1hbmFnZXIuaXRlbVN0YXJ0KCB1cmwgKTsKCgl9Cgp9CgpsZXQgX2NvbnRleHQ7CgpjbGFzcyBBdWRpb0NvbnRleHQgewoKCXN0YXRpYyBnZXRDb250ZXh0KCkgewoKCQlpZiAoIF9jb250ZXh0ID09PSB1bmRlZmluZWQgKSB7CgoJCQlfY29udGV4dCA9IG5ldyAoIHdpbmRvdy5BdWRpb0NvbnRleHQgfHwgd2luZG93LndlYmtpdEF1ZGlvQ29udGV4dCApKCk7CgoJCX0KCgkJcmV0dXJuIF9jb250ZXh0OwoKCX0KCglzdGF0aWMgc2V0Q29udGV4dCggdmFsdWUgKSB7CgoJCV9jb250ZXh0ID0gdmFsdWU7CgoJfQoKfQoKY2xhc3MgQXVkaW9Mb2FkZXIgZXh0ZW5kcyBMb2FkZXIgewoKCWNvbnN0cnVjdG9yKCBtYW5hZ2VyICkgewoKCQlzdXBlciggbWFuYWdlciApOwoKCX0KCglsb2FkKCB1cmwsIG9uTG9hZCwgb25Qcm9ncmVzcywgb25FcnJvciApIHsKCgkJY29uc3Qgc2NvcGUgPSB0aGlzOwoKCQljb25zdCBsb2FkZXIgPSBuZXcgRmlsZUxvYWRlciggdGhpcy5tYW5hZ2VyICk7CgkJbG9hZGVyLnNldFJlc3BvbnNlVHlwZSggJ2FycmF5YnVmZmVyJyApOwoJCWxvYWRlci5zZXRQYXRoKCB0aGlzLnBhdGggKTsKCQlsb2FkZXIuc2V0UmVxdWVzdEhlYWRlciggdGhpcy5yZXF1ZXN0SGVhZGVyICk7CgkJbG9hZGVyLnNldFdpdGhDcmVkZW50aWFscyggdGhpcy53aXRoQ3JlZGVudGlhbHMgKTsKCQlsb2FkZXIubG9hZCggdXJsLCBmdW5jdGlvbiAoIGJ1ZmZlciApIHsKCgkJCXRyeSB7CgoJCQkJLy8gQ3JlYXRlIGEgY29weSBvZiB0aGUgYnVmZmVyLiBUaGUgYGRlY29kZUF1ZGlvRGF0YWAgbWV0aG9kCgkJCQkvLyBkZXRhY2hlcyB0aGUgYnVmZmVyIHdoZW4gY29tcGxldGUsIHByZXZlbnRpbmcgcmV1c2UuCgkJCQljb25zdCBidWZmZXJDb3B5ID0gYnVmZmVyLnNsaWNlKCAwICk7CgoJCQkJY29uc3QgY29udGV4dCA9IEF1ZGlvQ29udGV4dC5nZXRDb250ZXh0KCk7CgkJCQljb250ZXh0LmRlY29kZUF1ZGlvRGF0YSggYnVmZmVyQ29weSwgZnVuY3Rpb24gKCBhdWRpb0J1ZmZlciApIHsKCgkJCQkJb25Mb2FkKCBhdWRpb0J1ZmZlciApOwoKCQkJCX0gKS5jYXRjaCggaGFuZGxlRXJyb3IgKTsKCgkJCX0gY2F0Y2ggKCBlICkgewoKCQkJCWhhbmRsZUVycm9yKCBlICk7CgoJCQl9CgoJCX0sIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKTsKCgkJZnVuY3Rpb24gaGFuZGxlRXJyb3IoIGUgKSB7CgoJCQlpZiAoIG9uRXJyb3IgKSB7CgoJCQkJb25FcnJvciggZSApOwoKCQkJfSBlbHNlIHsKCgkJCQljb25zb2xlLmVycm9yKCBlICk7CgoJCQl9CgoJCQlzY29wZS5tYW5hZ2VyLml0ZW1FcnJvciggdXJsICk7CgoJCX0KCgl9Cgp9Cgpjb25zdCBfZXllUmlnaHQgPSAvKkBfX1BVUkVfXyovIG5ldyBNYXRyaXg0KCk7CmNvbnN0IF9leWVMZWZ0ID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwpjb25zdCBfcHJvamVjdGlvbk1hdHJpeCA9IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDQoKTsKCmNsYXNzIFN0ZXJlb0NhbWVyYSB7CgoJY29uc3RydWN0b3IoKSB7CgoJCXRoaXMudHlwZSA9ICdTdGVyZW9DYW1lcmEnOwoKCQl0aGlzLmFzcGVjdCA9IDE7CgoJCXRoaXMuZXllU2VwID0gMC4wNjQ7CgoJCXRoaXMuY2FtZXJhTCA9IG5ldyBQZXJzcGVjdGl2ZUNhbWVyYSgpOwoJCXRoaXMuY2FtZXJhTC5sYXllcnMuZW5hYmxlKCAxICk7CgkJdGhpcy5jYW1lcmFMLm1hdHJpeEF1dG9VcGRhdGUgPSBmYWxzZTsKCgkJdGhpcy5jYW1lcmFSID0gbmV3IFBlcnNwZWN0aXZlQ2FtZXJhKCk7CgkJdGhpcy5jYW1lcmFSLmxheWVycy5lbmFibGUoIDIgKTsKCQl0aGlzLmNhbWVyYVIubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwoKCQl0aGlzLl9jYWNoZSA9IHsKCQkJZm9jdXM6IG51bGwsCgkJCWZvdjogbnVsbCwKCQkJYXNwZWN0OiBudWxsLAoJCQluZWFyOiBudWxsLAoJCQlmYXI6IG51bGwsCgkJCXpvb206IG51bGwsCgkJCWV5ZVNlcDogbnVsbAoJCX07CgoJfQoKCXVwZGF0ZSggY2FtZXJhICkgewoKCQljb25zdCBjYWNoZSA9IHRoaXMuX2NhY2hlOwoKCQljb25zdCBuZWVkc1VwZGF0ZSA9IGNhY2hlLmZvY3VzICE9PSBjYW1lcmEuZm9jdXMgfHwgY2FjaGUuZm92ICE9PSBjYW1lcmEuZm92IHx8CgkJCWNhY2hlLmFzcGVjdCAhPT0gY2FtZXJhLmFzcGVjdCAqIHRoaXMuYXNwZWN0IHx8IGNhY2hlLm5lYXIgIT09IGNhbWVyYS5uZWFyIHx8CgkJCWNhY2hlLmZhciAhPT0gY2FtZXJhLmZhciB8fCBjYWNoZS56b29tICE9PSBjYW1lcmEuem9vbSB8fCBjYWNoZS5leWVTZXAgIT09IHRoaXMuZXllU2VwOwoKCQlpZiAoIG5lZWRzVXBkYXRlICkgewoKCQkJY2FjaGUuZm9jdXMgPSBjYW1lcmEuZm9jdXM7CgkJCWNhY2hlLmZvdiA9IGNhbWVyYS5mb3Y7CgkJCWNhY2hlLmFzcGVjdCA9IGNhbWVyYS5hc3BlY3QgKiB0aGlzLmFzcGVjdDsKCQkJY2FjaGUubmVhciA9IGNhbWVyYS5uZWFyOwoJCQljYWNoZS5mYXIgPSBjYW1lcmEuZmFyOwoJCQljYWNoZS56b29tID0gY2FtZXJhLnpvb207CgkJCWNhY2hlLmV5ZVNlcCA9IHRoaXMuZXllU2VwOwoKCQkJLy8gT2ZmLWF4aXMgc3RlcmVvc2NvcGljIGVmZmVjdCBiYXNlZCBvbgoJCQkvLyBodHRwOi8vcGF1bGJvdXJrZS5uZXQvc3RlcmVvZ3JhcGhpY3Mvc3RlcmVvcmVuZGVyLwoKCQkJX3Byb2plY3Rpb25NYXRyaXguY29weSggY2FtZXJhLnByb2plY3Rpb25NYXRyaXggKTsKCQkJY29uc3QgZXllU2VwSGFsZiA9IGNhY2hlLmV5ZVNlcCAvIDI7CgkJCWNvbnN0IGV5ZVNlcE9uUHJvamVjdGlvbiA9IGV5ZVNlcEhhbGYgKiBjYWNoZS5uZWFyIC8gY2FjaGUuZm9jdXM7CgkJCWNvbnN0IHltYXggPSAoIGNhY2hlLm5lYXIgKiBNYXRoLnRhbiggREVHMlJBRCAqIGNhY2hlLmZvdiAqIDAuNSApICkgLyBjYWNoZS56b29tOwoJCQlsZXQgeG1pbiwgeG1heDsKCgkJCS8vIHRyYW5zbGF0ZSB4T2Zmc2V0CgoJCQlfZXllTGVmdC5lbGVtZW50c1sgMTIgXSA9IC0gZXllU2VwSGFsZjsKCQkJX2V5ZVJpZ2h0LmVsZW1lbnRzWyAxMiBdID0gZXllU2VwSGFsZjsKCgkJCS8vIGZvciBsZWZ0IGV5ZQoKCQkJeG1pbiA9IC0geW1heCAqIGNhY2hlLmFzcGVjdCArIGV5ZVNlcE9uUHJvamVjdGlvbjsKCQkJeG1heCA9IHltYXggKiBjYWNoZS5hc3BlY3QgKyBleWVTZXBPblByb2plY3Rpb247CgoJCQlfcHJvamVjdGlvbk1hdHJpeC5lbGVtZW50c1sgMCBdID0gMiAqIGNhY2hlLm5lYXIgLyAoIHhtYXggLSB4bWluICk7CgkJCV9wcm9qZWN0aW9uTWF0cml4LmVsZW1lbnRzWyA4IF0gPSAoIHhtYXggKyB4bWluICkgLyAoIHhtYXggLSB4bWluICk7CgoJCQl0aGlzLmNhbWVyYUwucHJvamVjdGlvbk1hdHJpeC5jb3B5KCBfcHJvamVjdGlvbk1hdHJpeCApOwoKCQkJLy8gZm9yIHJpZ2h0IGV5ZQoKCQkJeG1pbiA9IC0geW1heCAqIGNhY2hlLmFzcGVjdCAtIGV5ZVNlcE9uUHJvamVjdGlvbjsKCQkJeG1heCA9IHltYXggKiBjYWNoZS5hc3BlY3QgLSBleWVTZXBPblByb2plY3Rpb247CgoJCQlfcHJvamVjdGlvbk1hdHJpeC5lbGVtZW50c1sgMCBdID0gMiAqIGNhY2hlLm5lYXIgLyAoIHhtYXggLSB4bWluICk7CgkJCV9wcm9qZWN0aW9uTWF0cml4LmVsZW1lbnRzWyA4IF0gPSAoIHhtYXggKyB4bWluICkgLyAoIHhtYXggLSB4bWluICk7CgoJCQl0aGlzLmNhbWVyYVIucHJvamVjdGlvbk1hdHJpeC5jb3B5KCBfcHJvamVjdGlvbk1hdHJpeCApOwoKCQl9CgoJCXRoaXMuY2FtZXJhTC5tYXRyaXhXb3JsZC5jb3B5KCBjYW1lcmEubWF0cml4V29ybGQgKS5tdWx0aXBseSggX2V5ZUxlZnQgKTsKCQl0aGlzLmNhbWVyYVIubWF0cml4V29ybGQuY29weSggY2FtZXJhLm1hdHJpeFdvcmxkICkubXVsdGlwbHkoIF9leWVSaWdodCApOwoKCX0KCn0KCmNsYXNzIENsb2NrIHsKCgljb25zdHJ1Y3RvciggYXV0b1N0YXJ0ID0gdHJ1ZSApIHsKCgkJdGhpcy5hdXRvU3RhcnQgPSBhdXRvU3RhcnQ7CgoJCXRoaXMuc3RhcnRUaW1lID0gMDsKCQl0aGlzLm9sZFRpbWUgPSAwOwoJCXRoaXMuZWxhcHNlZFRpbWUgPSAwOwoKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCgl9CgoJc3RhcnQoKSB7CgoJCXRoaXMuc3RhcnRUaW1lID0gbm93KCk7CgoJCXRoaXMub2xkVGltZSA9IHRoaXMuc3RhcnRUaW1lOwoJCXRoaXMuZWxhcHNlZFRpbWUgPSAwOwoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJfQoKCXN0b3AoKSB7CgoJCXRoaXMuZ2V0RWxhcHNlZFRpbWUoKTsKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCQl0aGlzLmF1dG9TdGFydCA9IGZhbHNlOwoKCX0KCglnZXRFbGFwc2VkVGltZSgpIHsKCgkJdGhpcy5nZXREZWx0YSgpOwoJCXJldHVybiB0aGlzLmVsYXBzZWRUaW1lOwoKCX0KCglnZXREZWx0YSgpIHsKCgkJbGV0IGRpZmYgPSAwOwoKCQlpZiAoIHRoaXMuYXV0b1N0YXJ0ICYmICEgdGhpcy5ydW5uaW5nICkgewoKCQkJdGhpcy5zdGFydCgpOwoJCQlyZXR1cm4gMDsKCgkJfQoKCQlpZiAoIHRoaXMucnVubmluZyApIHsKCgkJCWNvbnN0IG5ld1RpbWUgPSBub3coKTsKCgkJCWRpZmYgPSAoIG5ld1RpbWUgLSB0aGlzLm9sZFRpbWUgKSAvIDEwMDA7CgkJCXRoaXMub2xkVGltZSA9IG5ld1RpbWU7CgoJCQl0aGlzLmVsYXBzZWRUaW1lICs9IGRpZmY7CgoJCX0KCgkJcmV0dXJuIGRpZmY7CgoJfQoKfQoKZnVuY3Rpb24gbm93KCkgewoKCXJldHVybiAoIHR5cGVvZiBwZXJmb3JtYW5jZSA9PT0gJ3VuZGVmaW5lZCcgPyBEYXRlIDogcGVyZm9ybWFuY2UgKS5ub3coKTsgLy8gc2VlICMxMDczMgoKfQoKY29uc3QgX3Bvc2l0aW9uJDEgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF9xdWF0ZXJuaW9uJDEgPSAvKkBfX1BVUkVfXyovIG5ldyBRdWF0ZXJuaW9uKCk7CmNvbnN0IF9zY2FsZSQxID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfb3JpZW50YXRpb24kMSA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNsYXNzIEF1ZGlvTGlzdGVuZXIgZXh0ZW5kcyBPYmplY3QzRCB7CgoJY29uc3RydWN0b3IoKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMudHlwZSA9ICdBdWRpb0xpc3RlbmVyJzsKCgkJdGhpcy5jb250ZXh0ID0gQXVkaW9Db250ZXh0LmdldENvbnRleHQoKTsKCgkJdGhpcy5nYWluID0gdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW4oKTsKCQl0aGlzLmdhaW4uY29ubmVjdCggdGhpcy5jb250ZXh0LmRlc3RpbmF0aW9uICk7CgoJCXRoaXMuZmlsdGVyID0gbnVsbDsKCgkJdGhpcy50aW1lRGVsdGEgPSAwOwoKCQkvLyBwcml2YXRlCgoJCXRoaXMuX2Nsb2NrID0gbmV3IENsb2NrKCk7CgoJfQoKCWdldElucHV0KCkgewoKCQlyZXR1cm4gdGhpcy5nYWluOwoKCX0KCglyZW1vdmVGaWx0ZXIoKSB7CgoJCWlmICggdGhpcy5maWx0ZXIgIT09IG51bGwgKSB7CgoJCQl0aGlzLmdhaW4uZGlzY29ubmVjdCggdGhpcy5maWx0ZXIgKTsKCQkJdGhpcy5maWx0ZXIuZGlzY29ubmVjdCggdGhpcy5jb250ZXh0LmRlc3RpbmF0aW9uICk7CgkJCXRoaXMuZ2Fpbi5jb25uZWN0KCB0aGlzLmNvbnRleHQuZGVzdGluYXRpb24gKTsKCQkJdGhpcy5maWx0ZXIgPSBudWxsOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRGaWx0ZXIoKSB7CgoJCXJldHVybiB0aGlzLmZpbHRlcjsKCgl9CgoJc2V0RmlsdGVyKCB2YWx1ZSApIHsKCgkJaWYgKCB0aGlzLmZpbHRlciAhPT0gbnVsbCApIHsKCgkJCXRoaXMuZ2Fpbi5kaXNjb25uZWN0KCB0aGlzLmZpbHRlciApOwoJCQl0aGlzLmZpbHRlci5kaXNjb25uZWN0KCB0aGlzLmNvbnRleHQuZGVzdGluYXRpb24gKTsKCgkJfSBlbHNlIHsKCgkJCXRoaXMuZ2Fpbi5kaXNjb25uZWN0KCB0aGlzLmNvbnRleHQuZGVzdGluYXRpb24gKTsKCgkJfQoKCQl0aGlzLmZpbHRlciA9IHZhbHVlOwoJCXRoaXMuZ2Fpbi5jb25uZWN0KCB0aGlzLmZpbHRlciApOwoJCXRoaXMuZmlsdGVyLmNvbm5lY3QoIHRoaXMuY29udGV4dC5kZXN0aW5hdGlvbiApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0TWFzdGVyVm9sdW1lKCkgewoKCQlyZXR1cm4gdGhpcy5nYWluLmdhaW4udmFsdWU7CgoJfQoKCXNldE1hc3RlclZvbHVtZSggdmFsdWUgKSB7CgoJCXRoaXMuZ2Fpbi5nYWluLnNldFRhcmdldEF0VGltZSggdmFsdWUsIHRoaXMuY29udGV4dC5jdXJyZW50VGltZSwgMC4wMSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdXBkYXRlTWF0cml4V29ybGQoIGZvcmNlICkgewoKCQlzdXBlci51cGRhdGVNYXRyaXhXb3JsZCggZm9yY2UgKTsKCgkJY29uc3QgbGlzdGVuZXIgPSB0aGlzLmNvbnRleHQubGlzdGVuZXI7CgkJY29uc3QgdXAgPSB0aGlzLnVwOwoKCQl0aGlzLnRpbWVEZWx0YSA9IHRoaXMuX2Nsb2NrLmdldERlbHRhKCk7CgoJCXRoaXMubWF0cml4V29ybGQuZGVjb21wb3NlKCBfcG9zaXRpb24kMSwgX3F1YXRlcm5pb24kMSwgX3NjYWxlJDEgKTsKCgkJX29yaWVudGF0aW9uJDEuc2V0KCAwLCAwLCAtIDEgKS5hcHBseVF1YXRlcm5pb24oIF9xdWF0ZXJuaW9uJDEgKTsKCgkJaWYgKCBsaXN0ZW5lci5wb3NpdGlvblggKSB7CgoJCQkvLyBjb2RlIHBhdGggZm9yIENocm9tZSAoc2VlICMxNDM5MykKCgkJCWNvbnN0IGVuZFRpbWUgPSB0aGlzLmNvbnRleHQuY3VycmVudFRpbWUgKyB0aGlzLnRpbWVEZWx0YTsKCgkJCWxpc3RlbmVyLnBvc2l0aW9uWC5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSggX3Bvc2l0aW9uJDEueCwgZW5kVGltZSApOwoJCQlsaXN0ZW5lci5wb3NpdGlvblkubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoIF9wb3NpdGlvbiQxLnksIGVuZFRpbWUgKTsKCQkJbGlzdGVuZXIucG9zaXRpb25aLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfcG9zaXRpb24kMS56LCBlbmRUaW1lICk7CgkJCWxpc3RlbmVyLmZvcndhcmRYLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfb3JpZW50YXRpb24kMS54LCBlbmRUaW1lICk7CgkJCWxpc3RlbmVyLmZvcndhcmRZLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfb3JpZW50YXRpb24kMS55LCBlbmRUaW1lICk7CgkJCWxpc3RlbmVyLmZvcndhcmRaLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfb3JpZW50YXRpb24kMS56LCBlbmRUaW1lICk7CgkJCWxpc3RlbmVyLnVwWC5saW5lYXJSYW1wVG9WYWx1ZUF0VGltZSggdXAueCwgZW5kVGltZSApOwoJCQlsaXN0ZW5lci51cFkubGluZWFyUmFtcFRvVmFsdWVBdFRpbWUoIHVwLnksIGVuZFRpbWUgKTsKCQkJbGlzdGVuZXIudXBaLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCB1cC56LCBlbmRUaW1lICk7CgoJCX0gZWxzZSB7CgoJCQlsaXN0ZW5lci5zZXRQb3NpdGlvbiggX3Bvc2l0aW9uJDEueCwgX3Bvc2l0aW9uJDEueSwgX3Bvc2l0aW9uJDEueiApOwoJCQlsaXN0ZW5lci5zZXRPcmllbnRhdGlvbiggX29yaWVudGF0aW9uJDEueCwgX29yaWVudGF0aW9uJDEueSwgX29yaWVudGF0aW9uJDEueiwgdXAueCwgdXAueSwgdXAueiApOwoKCQl9CgoJfQoKfQoKY2xhc3MgQXVkaW8gZXh0ZW5kcyBPYmplY3QzRCB7CgoJY29uc3RydWN0b3IoIGxpc3RlbmVyICkgewoKCQlzdXBlcigpOwoKCQl0aGlzLnR5cGUgPSAnQXVkaW8nOwoKCQl0aGlzLmxpc3RlbmVyID0gbGlzdGVuZXI7CgkJdGhpcy5jb250ZXh0ID0gbGlzdGVuZXIuY29udGV4dDsKCgkJdGhpcy5nYWluID0gdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW4oKTsKCQl0aGlzLmdhaW4uY29ubmVjdCggbGlzdGVuZXIuZ2V0SW5wdXQoKSApOwoKCQl0aGlzLmF1dG9wbGF5ID0gZmFsc2U7CgoJCXRoaXMuYnVmZmVyID0gbnVsbDsKCQl0aGlzLmRldHVuZSA9IDA7CgkJdGhpcy5sb29wID0gZmFsc2U7CgkJdGhpcy5sb29wU3RhcnQgPSAwOwoJCXRoaXMubG9vcEVuZCA9IDA7CgkJdGhpcy5vZmZzZXQgPSAwOwoJCXRoaXMuZHVyYXRpb24gPSB1bmRlZmluZWQ7CgkJdGhpcy5wbGF5YmFja1JhdGUgPSAxOwoJCXRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CgkJdGhpcy5oYXNQbGF5YmFja0NvbnRyb2wgPSB0cnVlOwoJCXRoaXMuc291cmNlID0gbnVsbDsKCQl0aGlzLnNvdXJjZVR5cGUgPSAnZW1wdHknOwoKCQl0aGlzLl9zdGFydGVkQXQgPSAwOwoJCXRoaXMuX3Byb2dyZXNzID0gMDsKCQl0aGlzLl9jb25uZWN0ZWQgPSBmYWxzZTsKCgkJdGhpcy5maWx0ZXJzID0gW107CgoJfQoKCWdldE91dHB1dCgpIHsKCgkJcmV0dXJuIHRoaXMuZ2FpbjsKCgl9CgoJc2V0Tm9kZVNvdXJjZSggYXVkaW9Ob2RlICkgewoKCQl0aGlzLmhhc1BsYXliYWNrQ29udHJvbCA9IGZhbHNlOwoJCXRoaXMuc291cmNlVHlwZSA9ICdhdWRpb05vZGUnOwoJCXRoaXMuc291cmNlID0gYXVkaW9Ob2RlOwoJCXRoaXMuY29ubmVjdCgpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0TWVkaWFFbGVtZW50U291cmNlKCBtZWRpYUVsZW1lbnQgKSB7CgoJCXRoaXMuaGFzUGxheWJhY2tDb250cm9sID0gZmFsc2U7CgkJdGhpcy5zb3VyY2VUeXBlID0gJ21lZGlhTm9kZSc7CgkJdGhpcy5zb3VyY2UgPSB0aGlzLmNvbnRleHQuY3JlYXRlTWVkaWFFbGVtZW50U291cmNlKCBtZWRpYUVsZW1lbnQgKTsKCQl0aGlzLmNvbm5lY3QoKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldE1lZGlhU3RyZWFtU291cmNlKCBtZWRpYVN0cmVhbSApIHsKCgkJdGhpcy5oYXNQbGF5YmFja0NvbnRyb2wgPSBmYWxzZTsKCQl0aGlzLnNvdXJjZVR5cGUgPSAnbWVkaWFTdHJlYW1Ob2RlJzsKCQl0aGlzLnNvdXJjZSA9IHRoaXMuY29udGV4dC5jcmVhdGVNZWRpYVN0cmVhbVNvdXJjZSggbWVkaWFTdHJlYW0gKTsKCQl0aGlzLmNvbm5lY3QoKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEJ1ZmZlciggYXVkaW9CdWZmZXIgKSB7CgoJCXRoaXMuYnVmZmVyID0gYXVkaW9CdWZmZXI7CgkJdGhpcy5zb3VyY2VUeXBlID0gJ2J1ZmZlcic7CgoJCWlmICggdGhpcy5hdXRvcGxheSApIHRoaXMucGxheSgpOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcGxheSggZGVsYXkgPSAwICkgewoKCQlpZiAoIHRoaXMuaXNQbGF5aW5nID09PSB0cnVlICkgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuQXVkaW86IEF1ZGlvIGlzIGFscmVhZHkgcGxheWluZy4nICk7CgkJCXJldHVybjsKCgkJfQoKCQlpZiAoIHRoaXMuaGFzUGxheWJhY2tDb250cm9sID09PSBmYWxzZSApIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLkF1ZGlvOiB0aGlzIEF1ZGlvIGhhcyBubyBwbGF5YmFjayBjb250cm9sLicgKTsKCQkJcmV0dXJuOwoKCQl9CgoJCXRoaXMuX3N0YXJ0ZWRBdCA9IHRoaXMuY29udGV4dC5jdXJyZW50VGltZSArIGRlbGF5OwoKCQljb25zdCBzb3VyY2UgPSB0aGlzLmNvbnRleHQuY3JlYXRlQnVmZmVyU291cmNlKCk7CgkJc291cmNlLmJ1ZmZlciA9IHRoaXMuYnVmZmVyOwoJCXNvdXJjZS5sb29wID0gdGhpcy5sb29wOwoJCXNvdXJjZS5sb29wU3RhcnQgPSB0aGlzLmxvb3BTdGFydDsKCQlzb3VyY2UubG9vcEVuZCA9IHRoaXMubG9vcEVuZDsKCQlzb3VyY2Uub25lbmRlZCA9IHRoaXMub25FbmRlZC5iaW5kKCB0aGlzICk7CgkJc291cmNlLnN0YXJ0KCB0aGlzLl9zdGFydGVkQXQsIHRoaXMuX3Byb2dyZXNzICsgdGhpcy5vZmZzZXQsIHRoaXMuZHVyYXRpb24gKTsKCgkJdGhpcy5pc1BsYXlpbmcgPSB0cnVlOwoKCQl0aGlzLnNvdXJjZSA9IHNvdXJjZTsKCgkJdGhpcy5zZXREZXR1bmUoIHRoaXMuZGV0dW5lICk7CgkJdGhpcy5zZXRQbGF5YmFja1JhdGUoIHRoaXMucGxheWJhY2tSYXRlICk7CgoJCXJldHVybiB0aGlzLmNvbm5lY3QoKTsKCgl9CgoJcGF1c2UoKSB7CgoJCWlmICggdGhpcy5oYXNQbGF5YmFja0NvbnRyb2wgPT09IGZhbHNlICkgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuQXVkaW86IHRoaXMgQXVkaW8gaGFzIG5vIHBsYXliYWNrIGNvbnRyb2wuJyApOwoJCQlyZXR1cm47CgoJCX0KCgkJaWYgKCB0aGlzLmlzUGxheWluZyA9PT0gdHJ1ZSApIHsKCgkJCS8vIHVwZGF0ZSBjdXJyZW50IHByb2dyZXNzCgoJCQl0aGlzLl9wcm9ncmVzcyArPSBNYXRoLm1heCggdGhpcy5jb250ZXh0LmN1cnJlbnRUaW1lIC0gdGhpcy5fc3RhcnRlZEF0LCAwICkgKiB0aGlzLnBsYXliYWNrUmF0ZTsKCgkJCWlmICggdGhpcy5sb29wID09PSB0cnVlICkgewoKCQkJCS8vIGVuc3VyZSBfcHJvZ3Jlc3MgZG9lcyBub3QgZXhjZWVkIGR1cmF0aW9uIHdpdGggbG9vcGVkIGF1ZGlvcwoKCQkJCXRoaXMuX3Byb2dyZXNzID0gdGhpcy5fcHJvZ3Jlc3MgJSAoIHRoaXMuZHVyYXRpb24gfHwgdGhpcy5idWZmZXIuZHVyYXRpb24gKTsKCgkJCX0KCgkJCXRoaXMuc291cmNlLnN0b3AoKTsKCQkJdGhpcy5zb3VyY2Uub25lbmRlZCA9IG51bGw7CgoJCQl0aGlzLmlzUGxheWluZyA9IGZhbHNlOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglzdG9wKCkgewoKCQlpZiAoIHRoaXMuaGFzUGxheWJhY2tDb250cm9sID09PSBmYWxzZSApIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLkF1ZGlvOiB0aGlzIEF1ZGlvIGhhcyBubyBwbGF5YmFjayBjb250cm9sLicgKTsKCQkJcmV0dXJuOwoKCQl9CgoJCXRoaXMuX3Byb2dyZXNzID0gMDsKCgkJaWYgKCB0aGlzLnNvdXJjZSAhPT0gbnVsbCApIHsKCgkJCXRoaXMuc291cmNlLnN0b3AoKTsKCQkJdGhpcy5zb3VyY2Uub25lbmRlZCA9IG51bGw7CgoJCX0KCgkJdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvbm5lY3QoKSB7CgoJCWlmICggdGhpcy5maWx0ZXJzLmxlbmd0aCA+IDAgKSB7CgoJCQl0aGlzLnNvdXJjZS5jb25uZWN0KCB0aGlzLmZpbHRlcnNbIDAgXSApOwoKCQkJZm9yICggbGV0IGkgPSAxLCBsID0gdGhpcy5maWx0ZXJzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQkJdGhpcy5maWx0ZXJzWyBpIC0gMSBdLmNvbm5lY3QoIHRoaXMuZmlsdGVyc1sgaSBdICk7CgoJCQl9CgoJCQl0aGlzLmZpbHRlcnNbIHRoaXMuZmlsdGVycy5sZW5ndGggLSAxIF0uY29ubmVjdCggdGhpcy5nZXRPdXRwdXQoKSApOwoKCQl9IGVsc2UgewoKCQkJdGhpcy5zb3VyY2UuY29ubmVjdCggdGhpcy5nZXRPdXRwdXQoKSApOwoKCQl9CgoJCXRoaXMuX2Nvbm5lY3RlZCA9IHRydWU7CgoJCXJldHVybiB0aGlzOwoKCX0KCglkaXNjb25uZWN0KCkgewoKCQlpZiAoIHRoaXMuX2Nvbm5lY3RlZCA9PT0gZmFsc2UgKSB7CgoJCQlyZXR1cm47CgoJCX0KCgkJaWYgKCB0aGlzLmZpbHRlcnMubGVuZ3RoID4gMCApIHsKCgkJCXRoaXMuc291cmNlLmRpc2Nvbm5lY3QoIHRoaXMuZmlsdGVyc1sgMCBdICk7CgoJCQlmb3IgKCBsZXQgaSA9IDEsIGwgPSB0aGlzLmZpbHRlcnMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQl0aGlzLmZpbHRlcnNbIGkgLSAxIF0uZGlzY29ubmVjdCggdGhpcy5maWx0ZXJzWyBpIF0gKTsKCgkJCX0KCgkJCXRoaXMuZmlsdGVyc1sgdGhpcy5maWx0ZXJzLmxlbmd0aCAtIDEgXS5kaXNjb25uZWN0KCB0aGlzLmdldE91dHB1dCgpICk7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLnNvdXJjZS5kaXNjb25uZWN0KCB0aGlzLmdldE91dHB1dCgpICk7CgoJCX0KCgkJdGhpcy5fY29ubmVjdGVkID0gZmFsc2U7CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXRGaWx0ZXJzKCkgewoKCQlyZXR1cm4gdGhpcy5maWx0ZXJzOwoKCX0KCglzZXRGaWx0ZXJzKCB2YWx1ZSApIHsKCgkJaWYgKCAhIHZhbHVlICkgdmFsdWUgPSBbXTsKCgkJaWYgKCB0aGlzLl9jb25uZWN0ZWQgPT09IHRydWUgKSB7CgoJCQl0aGlzLmRpc2Nvbm5lY3QoKTsKCQkJdGhpcy5maWx0ZXJzID0gdmFsdWUuc2xpY2UoKTsKCQkJdGhpcy5jb25uZWN0KCk7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLmZpbHRlcnMgPSB2YWx1ZS5zbGljZSgpOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXREZXR1bmUoIHZhbHVlICkgewoKCQl0aGlzLmRldHVuZSA9IHZhbHVlOwoKCQlpZiAoIHRoaXMuaXNQbGF5aW5nID09PSB0cnVlICYmIHRoaXMuc291cmNlLmRldHVuZSAhPT0gdW5kZWZpbmVkICkgewoKCQkJdGhpcy5zb3VyY2UuZGV0dW5lLnNldFRhcmdldEF0VGltZSggdGhpcy5kZXR1bmUsIHRoaXMuY29udGV4dC5jdXJyZW50VGltZSwgMC4wMSApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXREZXR1bmUoKSB7CgoJCXJldHVybiB0aGlzLmRldHVuZTsKCgl9CgoJZ2V0RmlsdGVyKCkgewoKCQlyZXR1cm4gdGhpcy5nZXRGaWx0ZXJzKClbIDAgXTsKCgl9CgoJc2V0RmlsdGVyKCBmaWx0ZXIgKSB7CgoJCXJldHVybiB0aGlzLnNldEZpbHRlcnMoIGZpbHRlciA/IFsgZmlsdGVyIF0gOiBbXSApOwoKCX0KCglzZXRQbGF5YmFja1JhdGUoIHZhbHVlICkgewoKCQlpZiAoIHRoaXMuaGFzUGxheWJhY2tDb250cm9sID09PSBmYWxzZSApIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLkF1ZGlvOiB0aGlzIEF1ZGlvIGhhcyBubyBwbGF5YmFjayBjb250cm9sLicgKTsKCQkJcmV0dXJuOwoKCQl9CgoJCXRoaXMucGxheWJhY2tSYXRlID0gdmFsdWU7CgoJCWlmICggdGhpcy5pc1BsYXlpbmcgPT09IHRydWUgKSB7CgoJCQl0aGlzLnNvdXJjZS5wbGF5YmFja1JhdGUuc2V0VGFyZ2V0QXRUaW1lKCB0aGlzLnBsYXliYWNrUmF0ZSwgdGhpcy5jb250ZXh0LmN1cnJlbnRUaW1lLCAwLjAxICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldFBsYXliYWNrUmF0ZSgpIHsKCgkJcmV0dXJuIHRoaXMucGxheWJhY2tSYXRlOwoKCX0KCglvbkVuZGVkKCkgewoKCQl0aGlzLmlzUGxheWluZyA9IGZhbHNlOwoKCX0KCglnZXRMb29wKCkgewoKCQlpZiAoIHRoaXMuaGFzUGxheWJhY2tDb250cm9sID09PSBmYWxzZSApIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLkF1ZGlvOiB0aGlzIEF1ZGlvIGhhcyBubyBwbGF5YmFjayBjb250cm9sLicgKTsKCQkJcmV0dXJuIGZhbHNlOwoKCQl9CgoJCXJldHVybiB0aGlzLmxvb3A7CgoJfQoKCXNldExvb3AoIHZhbHVlICkgewoKCQlpZiAoIHRoaXMuaGFzUGxheWJhY2tDb250cm9sID09PSBmYWxzZSApIHsKCgkJCWNvbnNvbGUud2FybiggJ1RIUkVFLkF1ZGlvOiB0aGlzIEF1ZGlvIGhhcyBubyBwbGF5YmFjayBjb250cm9sLicgKTsKCQkJcmV0dXJuOwoKCQl9CgoJCXRoaXMubG9vcCA9IHZhbHVlOwoKCQlpZiAoIHRoaXMuaXNQbGF5aW5nID09PSB0cnVlICkgewoKCQkJdGhpcy5zb3VyY2UubG9vcCA9IHRoaXMubG9vcDsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0TG9vcFN0YXJ0KCB2YWx1ZSApIHsKCgkJdGhpcy5sb29wU3RhcnQgPSB2YWx1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldExvb3BFbmQoIHZhbHVlICkgewoKCQl0aGlzLmxvb3BFbmQgPSB2YWx1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldFZvbHVtZSgpIHsKCgkJcmV0dXJuIHRoaXMuZ2Fpbi5nYWluLnZhbHVlOwoKCX0KCglzZXRWb2x1bWUoIHZhbHVlICkgewoKCQl0aGlzLmdhaW4uZ2Fpbi5zZXRUYXJnZXRBdFRpbWUoIHZhbHVlLCB0aGlzLmNvbnRleHQuY3VycmVudFRpbWUsIDAuMDEgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKfQoKY29uc3QgX3Bvc2l0aW9uID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfcXVhdGVybmlvbiA9IC8qQF9fUFVSRV9fKi8gbmV3IFF1YXRlcm5pb24oKTsKY29uc3QgX3NjYWxlID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfb3JpZW50YXRpb24gPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CgpjbGFzcyBQb3NpdGlvbmFsQXVkaW8gZXh0ZW5kcyBBdWRpbyB7CgoJY29uc3RydWN0b3IoIGxpc3RlbmVyICkgewoKCQlzdXBlciggbGlzdGVuZXIgKTsKCgkJdGhpcy5wYW5uZXIgPSB0aGlzLmNvbnRleHQuY3JlYXRlUGFubmVyKCk7CgkJdGhpcy5wYW5uZXIucGFubmluZ01vZGVsID0gJ0hSVEYnOwoJCXRoaXMucGFubmVyLmNvbm5lY3QoIHRoaXMuZ2FpbiApOwoKCX0KCgljb25uZWN0KCkgewoKCQlzdXBlci5jb25uZWN0KCk7CgoJCXRoaXMucGFubmVyLmNvbm5lY3QoIHRoaXMuZ2FpbiApOwoKCX0KCglkaXNjb25uZWN0KCkgewoKCQlzdXBlci5kaXNjb25uZWN0KCk7CgoJCXRoaXMucGFubmVyLmRpc2Nvbm5lY3QoIHRoaXMuZ2FpbiApOwoKCX0KCglnZXRPdXRwdXQoKSB7CgoJCXJldHVybiB0aGlzLnBhbm5lcjsKCgl9CgoJZ2V0UmVmRGlzdGFuY2UoKSB7CgoJCXJldHVybiB0aGlzLnBhbm5lci5yZWZEaXN0YW5jZTsKCgl9CgoJc2V0UmVmRGlzdGFuY2UoIHZhbHVlICkgewoKCQl0aGlzLnBhbm5lci5yZWZEaXN0YW5jZSA9IHZhbHVlOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0Um9sbG9mZkZhY3RvcigpIHsKCgkJcmV0dXJuIHRoaXMucGFubmVyLnJvbGxvZmZGYWN0b3I7CgoJfQoKCXNldFJvbGxvZmZGYWN0b3IoIHZhbHVlICkgewoKCQl0aGlzLnBhbm5lci5yb2xsb2ZmRmFjdG9yID0gdmFsdWU7CgoJCXJldHVybiB0aGlzOwoKCX0KCglnZXREaXN0YW5jZU1vZGVsKCkgewoKCQlyZXR1cm4gdGhpcy5wYW5uZXIuZGlzdGFuY2VNb2RlbDsKCgl9CgoJc2V0RGlzdGFuY2VNb2RlbCggdmFsdWUgKSB7CgoJCXRoaXMucGFubmVyLmRpc3RhbmNlTW9kZWwgPSB2YWx1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWdldE1heERpc3RhbmNlKCkgewoKCQlyZXR1cm4gdGhpcy5wYW5uZXIubWF4RGlzdGFuY2U7CgoJfQoKCXNldE1heERpc3RhbmNlKCB2YWx1ZSApIHsKCgkJdGhpcy5wYW5uZXIubWF4RGlzdGFuY2UgPSB2YWx1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldERpcmVjdGlvbmFsQ29uZSggY29uZUlubmVyQW5nbGUsIGNvbmVPdXRlckFuZ2xlLCBjb25lT3V0ZXJHYWluICkgewoKCQl0aGlzLnBhbm5lci5jb25lSW5uZXJBbmdsZSA9IGNvbmVJbm5lckFuZ2xlOwoJCXRoaXMucGFubmVyLmNvbmVPdXRlckFuZ2xlID0gY29uZU91dGVyQW5nbGU7CgkJdGhpcy5wYW5uZXIuY29uZU91dGVyR2FpbiA9IGNvbmVPdXRlckdhaW47CgoJCXJldHVybiB0aGlzOwoKCX0KCgl1cGRhdGVNYXRyaXhXb3JsZCggZm9yY2UgKSB7CgoJCXN1cGVyLnVwZGF0ZU1hdHJpeFdvcmxkKCBmb3JjZSApOwoKCQlpZiAoIHRoaXMuaGFzUGxheWJhY2tDb250cm9sID09PSB0cnVlICYmIHRoaXMuaXNQbGF5aW5nID09PSBmYWxzZSApIHJldHVybjsKCgkJdGhpcy5tYXRyaXhXb3JsZC5kZWNvbXBvc2UoIF9wb3NpdGlvbiwgX3F1YXRlcm5pb24sIF9zY2FsZSApOwoKCQlfb3JpZW50YXRpb24uc2V0KCAwLCAwLCAxICkuYXBwbHlRdWF0ZXJuaW9uKCBfcXVhdGVybmlvbiApOwoKCQljb25zdCBwYW5uZXIgPSB0aGlzLnBhbm5lcjsKCgkJaWYgKCBwYW5uZXIucG9zaXRpb25YICkgewoKCQkJLy8gY29kZSBwYXRoIGZvciBDaHJvbWUgYW5kIEZpcmVmb3ggKHNlZSAjMTQzOTMpCgoJCQljb25zdCBlbmRUaW1lID0gdGhpcy5jb250ZXh0LmN1cnJlbnRUaW1lICsgdGhpcy5saXN0ZW5lci50aW1lRGVsdGE7CgoJCQlwYW5uZXIucG9zaXRpb25YLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfcG9zaXRpb24ueCwgZW5kVGltZSApOwoJCQlwYW5uZXIucG9zaXRpb25ZLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfcG9zaXRpb24ueSwgZW5kVGltZSApOwoJCQlwYW5uZXIucG9zaXRpb25aLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfcG9zaXRpb24ueiwgZW5kVGltZSApOwoJCQlwYW5uZXIub3JpZW50YXRpb25YLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfb3JpZW50YXRpb24ueCwgZW5kVGltZSApOwoJCQlwYW5uZXIub3JpZW50YXRpb25ZLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfb3JpZW50YXRpb24ueSwgZW5kVGltZSApOwoJCQlwYW5uZXIub3JpZW50YXRpb25aLmxpbmVhclJhbXBUb1ZhbHVlQXRUaW1lKCBfb3JpZW50YXRpb24ueiwgZW5kVGltZSApOwoKCQl9IGVsc2UgewoKCQkJcGFubmVyLnNldFBvc2l0aW9uKCBfcG9zaXRpb24ueCwgX3Bvc2l0aW9uLnksIF9wb3NpdGlvbi56ICk7CgkJCXBhbm5lci5zZXRPcmllbnRhdGlvbiggX29yaWVudGF0aW9uLngsIF9vcmllbnRhdGlvbi55LCBfb3JpZW50YXRpb24ueiApOwoKCQl9CgoJfQoKfQoKY2xhc3MgQXVkaW9BbmFseXNlciB7CgoJY29uc3RydWN0b3IoIGF1ZGlvLCBmZnRTaXplID0gMjA0OCApIHsKCgkJdGhpcy5hbmFseXNlciA9IGF1ZGlvLmNvbnRleHQuY3JlYXRlQW5hbHlzZXIoKTsKCQl0aGlzLmFuYWx5c2VyLmZmdFNpemUgPSBmZnRTaXplOwoKCQl0aGlzLmRhdGEgPSBuZXcgVWludDhBcnJheSggdGhpcy5hbmFseXNlci5mcmVxdWVuY3lCaW5Db3VudCApOwoKCQlhdWRpby5nZXRPdXRwdXQoKS5jb25uZWN0KCB0aGlzLmFuYWx5c2VyICk7CgoJfQoKCglnZXRGcmVxdWVuY3lEYXRhKCkgewoKCQl0aGlzLmFuYWx5c2VyLmdldEJ5dGVGcmVxdWVuY3lEYXRhKCB0aGlzLmRhdGEgKTsKCgkJcmV0dXJuIHRoaXMuZGF0YTsKCgl9CgoJZ2V0QXZlcmFnZUZyZXF1ZW5jeSgpIHsKCgkJbGV0IHZhbHVlID0gMDsKCQljb25zdCBkYXRhID0gdGhpcy5nZXRGcmVxdWVuY3lEYXRhKCk7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpICsrICkgewoKCQkJdmFsdWUgKz0gZGF0YVsgaSBdOwoKCQl9CgoJCXJldHVybiB2YWx1ZSAvIGRhdGEubGVuZ3RoOwoKCX0KCn0KCmNsYXNzIFByb3BlcnR5TWl4ZXIgewoKCWNvbnN0cnVjdG9yKCBiaW5kaW5nLCB0eXBlTmFtZSwgdmFsdWVTaXplICkgewoKCQl0aGlzLmJpbmRpbmcgPSBiaW5kaW5nOwoJCXRoaXMudmFsdWVTaXplID0gdmFsdWVTaXplOwoKCQlsZXQgbWl4RnVuY3Rpb24sCgkJCW1peEZ1bmN0aW9uQWRkaXRpdmUsCgkJCXNldElkZW50aXR5OwoKCQkvLyBidWZmZXIgbGF5b3V0OiBbIGluY29taW5nIHwgYWNjdTAgfCBhY2N1MSB8IG9yaWcgfCBhZGRBY2N1IHwgKG9wdGlvbmFsIHdvcmspIF0KCQkvLwoJCS8vIGludGVycG9sYXRvcnMgY2FuIHVzZSAuYnVmZmVyIGFzIHRoZWlyIC5yZXN1bHQKCQkvLyB0aGUgZGF0YSB0aGVuIGdvZXMgdG8gJ2luY29taW5nJwoJCS8vCgkJLy8gJ2FjY3UwJyBhbmQgJ2FjY3UxJyBhcmUgdXNlZCBmcmFtZS1pbnRlcmxlYXZlZCBmb3IKCQkvLyB0aGUgY3VtdWxhdGl2ZSByZXN1bHQgYW5kIGFyZSBjb21wYXJlZCB0byBkZXRlY3QKCQkvLyBjaGFuZ2VzCgkJLy8KCQkvLyAnb3JpZycgc3RvcmVzIHRoZSBvcmlnaW5hbCBzdGF0ZSBvZiB0aGUgcHJvcGVydHkKCQkvLwoJCS8vICdhZGQnIGlzIHVzZWQgZm9yIGFkZGl0aXZlIGN1bXVsYXRpdmUgcmVzdWx0cwoJCS8vCgkJLy8gJ3dvcmsnIGlzIG9wdGlvbmFsIGFuZCBpcyBvbmx5IHByZXNlbnQgZm9yIHF1YXRlcm5pb24gdHlwZXMuIEl0IGlzIHVzZWQKCQkvLyB0byBzdG9yZSBpbnRlcm1lZGlhdGUgcXVhdGVybmlvbiBtdWx0aXBsaWNhdGlvbiByZXN1bHRzCgoJCXN3aXRjaCAoIHR5cGVOYW1lICkgewoKCQkJY2FzZSAncXVhdGVybmlvbic6CgkJCQltaXhGdW5jdGlvbiA9IHRoaXMuX3NsZXJwOwoJCQkJbWl4RnVuY3Rpb25BZGRpdGl2ZSA9IHRoaXMuX3NsZXJwQWRkaXRpdmU7CgkJCQlzZXRJZGVudGl0eSA9IHRoaXMuX3NldEFkZGl0aXZlSWRlbnRpdHlRdWF0ZXJuaW9uOwoKCQkJCXRoaXMuYnVmZmVyID0gbmV3IEZsb2F0NjRBcnJheSggdmFsdWVTaXplICogNiApOwoJCQkJdGhpcy5fd29ya0luZGV4ID0gNTsKCQkJCWJyZWFrOwoKCQkJY2FzZSAnc3RyaW5nJzoKCQkJY2FzZSAnYm9vbCc6CgkJCQltaXhGdW5jdGlvbiA9IHRoaXMuX3NlbGVjdDsKCgkJCQkvLyBVc2UgdGhlIHJlZ3VsYXIgbWl4IGZ1bmN0aW9uIGFuZCBmb3IgYWRkaXRpdmUgb24gdGhlc2UgdHlwZXMsCgkJCQkvLyBhZGRpdGl2ZSBpcyBub3QgcmVsZXZhbnQgZm9yIG5vbi1udW1lcmljIHR5cGVzCgkJCQltaXhGdW5jdGlvbkFkZGl0aXZlID0gdGhpcy5fc2VsZWN0OwoKCQkJCXNldElkZW50aXR5ID0gdGhpcy5fc2V0QWRkaXRpdmVJZGVudGl0eU90aGVyOwoKCQkJCXRoaXMuYnVmZmVyID0gbmV3IEFycmF5KCB2YWx1ZVNpemUgKiA1ICk7CgkJCQlicmVhazsKCgkJCWRlZmF1bHQ6CgkJCQltaXhGdW5jdGlvbiA9IHRoaXMuX2xlcnA7CgkJCQltaXhGdW5jdGlvbkFkZGl0aXZlID0gdGhpcy5fbGVycEFkZGl0aXZlOwoJCQkJc2V0SWRlbnRpdHkgPSB0aGlzLl9zZXRBZGRpdGl2ZUlkZW50aXR5TnVtZXJpYzsKCgkJCQl0aGlzLmJ1ZmZlciA9IG5ldyBGbG9hdDY0QXJyYXkoIHZhbHVlU2l6ZSAqIDUgKTsKCgkJfQoKCQl0aGlzLl9taXhCdWZmZXJSZWdpb24gPSBtaXhGdW5jdGlvbjsKCQl0aGlzLl9taXhCdWZmZXJSZWdpb25BZGRpdGl2ZSA9IG1peEZ1bmN0aW9uQWRkaXRpdmU7CgkJdGhpcy5fc2V0SWRlbnRpdHkgPSBzZXRJZGVudGl0eTsKCQl0aGlzLl9vcmlnSW5kZXggPSAzOwoJCXRoaXMuX2FkZEluZGV4ID0gNDsKCgkJdGhpcy5jdW11bGF0aXZlV2VpZ2h0ID0gMDsKCQl0aGlzLmN1bXVsYXRpdmVXZWlnaHRBZGRpdGl2ZSA9IDA7CgoJCXRoaXMudXNlQ291bnQgPSAwOwoJCXRoaXMucmVmZXJlbmNlQ291bnQgPSAwOwoKCX0KCgkvLyBhY2N1bXVsYXRlIGRhdGEgaW4gdGhlICdpbmNvbWluZycgcmVnaW9uIGludG8gJ2FjY3U8aT4nCglhY2N1bXVsYXRlKCBhY2N1SW5kZXgsIHdlaWdodCApIHsKCgkJLy8gbm90ZTogaGFwcGlseSBhY2N1bXVsYXRpbmcgbm90aGluZyB3aGVuIHdlaWdodCA9IDAsIHRoZSBjYWxsZXIga25vd3MKCQkvLyB0aGUgd2VpZ2h0IGFuZCBzaG91bGRuJ3QgaGF2ZSBtYWRlIHRoZSBjYWxsIGluIHRoZSBmaXJzdCBwbGFjZQoKCQljb25zdCBidWZmZXIgPSB0aGlzLmJ1ZmZlciwKCQkJc3RyaWRlID0gdGhpcy52YWx1ZVNpemUsCgkJCW9mZnNldCA9IGFjY3VJbmRleCAqIHN0cmlkZSArIHN0cmlkZTsKCgkJbGV0IGN1cnJlbnRXZWlnaHQgPSB0aGlzLmN1bXVsYXRpdmVXZWlnaHQ7CgoJCWlmICggY3VycmVudFdlaWdodCA9PT0gMCApIHsKCgkJCS8vIGFjY3VOIDo9IGluY29taW5nICogd2VpZ2h0CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgIT09IHN0cmlkZTsgKysgaSApIHsKCgkJCQlidWZmZXJbIG9mZnNldCArIGkgXSA9IGJ1ZmZlclsgaSBdOwoKCQkJfQoKCQkJY3VycmVudFdlaWdodCA9IHdlaWdodDsKCgkJfSBlbHNlIHsKCgkJCS8vIGFjY3VOIDo9IGFjY3VOICsgaW5jb21pbmcgKiB3ZWlnaHQKCgkJCWN1cnJlbnRXZWlnaHQgKz0gd2VpZ2h0OwoJCQljb25zdCBtaXggPSB3ZWlnaHQgLyBjdXJyZW50V2VpZ2h0OwoJCQl0aGlzLl9taXhCdWZmZXJSZWdpb24oIGJ1ZmZlciwgb2Zmc2V0LCAwLCBtaXgsIHN0cmlkZSApOwoKCQl9CgoJCXRoaXMuY3VtdWxhdGl2ZVdlaWdodCA9IGN1cnJlbnRXZWlnaHQ7CgoJfQoKCS8vIGFjY3VtdWxhdGUgZGF0YSBpbiB0aGUgJ2luY29taW5nJyByZWdpb24gaW50byAnYWRkJwoJYWNjdW11bGF0ZUFkZGl0aXZlKCB3ZWlnaHQgKSB7CgoJCWNvbnN0IGJ1ZmZlciA9IHRoaXMuYnVmZmVyLAoJCQlzdHJpZGUgPSB0aGlzLnZhbHVlU2l6ZSwKCQkJb2Zmc2V0ID0gc3RyaWRlICogdGhpcy5fYWRkSW5kZXg7CgoJCWlmICggdGhpcy5jdW11bGF0aXZlV2VpZ2h0QWRkaXRpdmUgPT09IDAgKSB7CgoJCQkvLyBhZGQgPSBpZGVudGl0eQoKCQkJdGhpcy5fc2V0SWRlbnRpdHkoKTsKCgkJfQoKCQkvLyBhZGQgOj0gYWRkICsgaW5jb21pbmcgKiB3ZWlnaHQKCgkJdGhpcy5fbWl4QnVmZmVyUmVnaW9uQWRkaXRpdmUoIGJ1ZmZlciwgb2Zmc2V0LCAwLCB3ZWlnaHQsIHN0cmlkZSApOwoJCXRoaXMuY3VtdWxhdGl2ZVdlaWdodEFkZGl0aXZlICs9IHdlaWdodDsKCgl9CgoJLy8gYXBwbHkgdGhlIHN0YXRlIG9mICdhY2N1PGk+JyB0byB0aGUgYmluZGluZyB3aGVuIGFjY3VzIGRpZmZlcgoJYXBwbHkoIGFjY3VJbmRleCApIHsKCgkJY29uc3Qgc3RyaWRlID0gdGhpcy52YWx1ZVNpemUsCgkJCWJ1ZmZlciA9IHRoaXMuYnVmZmVyLAoJCQlvZmZzZXQgPSBhY2N1SW5kZXggKiBzdHJpZGUgKyBzdHJpZGUsCgoJCQl3ZWlnaHQgPSB0aGlzLmN1bXVsYXRpdmVXZWlnaHQsCgkJCXdlaWdodEFkZGl0aXZlID0gdGhpcy5jdW11bGF0aXZlV2VpZ2h0QWRkaXRpdmUsCgoJCQliaW5kaW5nID0gdGhpcy5iaW5kaW5nOwoKCQl0aGlzLmN1bXVsYXRpdmVXZWlnaHQgPSAwOwoJCXRoaXMuY3VtdWxhdGl2ZVdlaWdodEFkZGl0aXZlID0gMDsKCgkJaWYgKCB3ZWlnaHQgPCAxICkgewoKCQkJLy8gYWNjdU4gOj0gYWNjdU4gKyBvcmlnaW5hbCAqICggMSAtIGN1bXVsYXRpdmVXZWlnaHQgKQoKCQkJY29uc3Qgb3JpZ2luYWxWYWx1ZU9mZnNldCA9IHN0cmlkZSAqIHRoaXMuX29yaWdJbmRleDsKCgkJCXRoaXMuX21peEJ1ZmZlclJlZ2lvbigKCQkJCWJ1ZmZlciwgb2Zmc2V0LCBvcmlnaW5hbFZhbHVlT2Zmc2V0LCAxIC0gd2VpZ2h0LCBzdHJpZGUgKTsKCgkJfQoKCQlpZiAoIHdlaWdodEFkZGl0aXZlID4gMCApIHsKCgkJCS8vIGFjY3VOIDo9IGFjY3VOICsgYWRkaXRpdmUgYWNjdU4KCgkJCXRoaXMuX21peEJ1ZmZlclJlZ2lvbkFkZGl0aXZlKCBidWZmZXIsIG9mZnNldCwgdGhpcy5fYWRkSW5kZXggKiBzdHJpZGUsIDEsIHN0cmlkZSApOwoKCQl9CgoJCWZvciAoIGxldCBpID0gc3RyaWRlLCBlID0gc3RyaWRlICsgc3RyaWRlOyBpICE9PSBlOyArKyBpICkgewoKCQkJaWYgKCBidWZmZXJbIGkgXSAhPT0gYnVmZmVyWyBpICsgc3RyaWRlIF0gKSB7CgoJCQkJLy8gdmFsdWUgaGFzIGNoYW5nZWQgLT4gdXBkYXRlIHNjZW5lIGdyYXBoCgoJCQkJYmluZGluZy5zZXRWYWx1ZSggYnVmZmVyLCBvZmZzZXQgKTsKCQkJCWJyZWFrOwoKCQkJfQoKCQl9CgoJfQoKCS8vIHJlbWVtYmVyIHRoZSBzdGF0ZSBvZiB0aGUgYm91bmQgcHJvcGVydHkgYW5kIGNvcHkgaXQgdG8gYm90aCBhY2N1cwoJc2F2ZU9yaWdpbmFsU3RhdGUoKSB7CgoJCWNvbnN0IGJpbmRpbmcgPSB0aGlzLmJpbmRpbmc7CgoJCWNvbnN0IGJ1ZmZlciA9IHRoaXMuYnVmZmVyLAoJCQlzdHJpZGUgPSB0aGlzLnZhbHVlU2l6ZSwKCgkJCW9yaWdpbmFsVmFsdWVPZmZzZXQgPSBzdHJpZGUgKiB0aGlzLl9vcmlnSW5kZXg7CgoJCWJpbmRpbmcuZ2V0VmFsdWUoIGJ1ZmZlciwgb3JpZ2luYWxWYWx1ZU9mZnNldCApOwoKCQkvLyBhY2N1WzAuLjFdIDo9IG9yaWcgLS0gaW5pdGlhbGx5IGRldGVjdCBjaGFuZ2VzIGFnYWluc3QgdGhlIG9yaWdpbmFsCgkJZm9yICggbGV0IGkgPSBzdHJpZGUsIGUgPSBvcmlnaW5hbFZhbHVlT2Zmc2V0OyBpICE9PSBlOyArKyBpICkgewoKCQkJYnVmZmVyWyBpIF0gPSBidWZmZXJbIG9yaWdpbmFsVmFsdWVPZmZzZXQgKyAoIGkgJSBzdHJpZGUgKSBdOwoKCQl9CgoJCS8vIEFkZCB0byBpZGVudGl0eSBmb3IgYWRkaXRpdmUKCQl0aGlzLl9zZXRJZGVudGl0eSgpOwoKCQl0aGlzLmN1bXVsYXRpdmVXZWlnaHQgPSAwOwoJCXRoaXMuY3VtdWxhdGl2ZVdlaWdodEFkZGl0aXZlID0gMDsKCgl9CgoJLy8gYXBwbHkgdGhlIHN0YXRlIHByZXZpb3VzbHkgdGFrZW4gdmlhICdzYXZlT3JpZ2luYWxTdGF0ZScgdG8gdGhlIGJpbmRpbmcKCXJlc3RvcmVPcmlnaW5hbFN0YXRlKCkgewoKCQljb25zdCBvcmlnaW5hbFZhbHVlT2Zmc2V0ID0gdGhpcy52YWx1ZVNpemUgKiAzOwoJCXRoaXMuYmluZGluZy5zZXRWYWx1ZSggdGhpcy5idWZmZXIsIG9yaWdpbmFsVmFsdWVPZmZzZXQgKTsKCgl9CgoJX3NldEFkZGl0aXZlSWRlbnRpdHlOdW1lcmljKCkgewoKCQljb25zdCBzdGFydEluZGV4ID0gdGhpcy5fYWRkSW5kZXggKiB0aGlzLnZhbHVlU2l6ZTsKCQljb25zdCBlbmRJbmRleCA9IHN0YXJ0SW5kZXggKyB0aGlzLnZhbHVlU2l6ZTsKCgkJZm9yICggbGV0IGkgPSBzdGFydEluZGV4OyBpIDwgZW5kSW5kZXg7IGkgKysgKSB7CgoJCQl0aGlzLmJ1ZmZlclsgaSBdID0gMDsKCgkJfQoKCX0KCglfc2V0QWRkaXRpdmVJZGVudGl0eVF1YXRlcm5pb24oKSB7CgoJCXRoaXMuX3NldEFkZGl0aXZlSWRlbnRpdHlOdW1lcmljKCk7CgkJdGhpcy5idWZmZXJbIHRoaXMuX2FkZEluZGV4ICogdGhpcy52YWx1ZVNpemUgKyAzIF0gPSAxOwoKCX0KCglfc2V0QWRkaXRpdmVJZGVudGl0eU90aGVyKCkgewoKCQljb25zdCBzdGFydEluZGV4ID0gdGhpcy5fb3JpZ0luZGV4ICogdGhpcy52YWx1ZVNpemU7CgkJY29uc3QgdGFyZ2V0SW5kZXggPSB0aGlzLl9hZGRJbmRleCAqIHRoaXMudmFsdWVTaXplOwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCB0aGlzLnZhbHVlU2l6ZTsgaSArKyApIHsKCgkJCXRoaXMuYnVmZmVyWyB0YXJnZXRJbmRleCArIGkgXSA9IHRoaXMuYnVmZmVyWyBzdGFydEluZGV4ICsgaSBdOwoKCQl9CgoJfQoKCgkvLyBtaXggZnVuY3Rpb25zCgoJX3NlbGVjdCggYnVmZmVyLCBkc3RPZmZzZXQsIHNyY09mZnNldCwgdCwgc3RyaWRlICkgewoKCQlpZiAoIHQgPj0gMC41ICkgewoKCQkJZm9yICggbGV0IGkgPSAwOyBpICE9PSBzdHJpZGU7ICsrIGkgKSB7CgoJCQkJYnVmZmVyWyBkc3RPZmZzZXQgKyBpIF0gPSBidWZmZXJbIHNyY09mZnNldCArIGkgXTsKCgkJCX0KCgkJfQoKCX0KCglfc2xlcnAoIGJ1ZmZlciwgZHN0T2Zmc2V0LCBzcmNPZmZzZXQsIHQgKSB7CgoJCVF1YXRlcm5pb24uc2xlcnBGbGF0KCBidWZmZXIsIGRzdE9mZnNldCwgYnVmZmVyLCBkc3RPZmZzZXQsIGJ1ZmZlciwgc3JjT2Zmc2V0LCB0ICk7CgoJfQoKCV9zbGVycEFkZGl0aXZlKCBidWZmZXIsIGRzdE9mZnNldCwgc3JjT2Zmc2V0LCB0LCBzdHJpZGUgKSB7CgoJCWNvbnN0IHdvcmtPZmZzZXQgPSB0aGlzLl93b3JrSW5kZXggKiBzdHJpZGU7CgoJCS8vIFN0b3JlIHJlc3VsdCBpbiBpbnRlcm1lZGlhdGUgYnVmZmVyIG9mZnNldAoJCVF1YXRlcm5pb24ubXVsdGlwbHlRdWF0ZXJuaW9uc0ZsYXQoIGJ1ZmZlciwgd29ya09mZnNldCwgYnVmZmVyLCBkc3RPZmZzZXQsIGJ1ZmZlciwgc3JjT2Zmc2V0ICk7CgoJCS8vIFNsZXJwIHRvIHRoZSBpbnRlcm1lZGlhdGUgcmVzdWx0CgkJUXVhdGVybmlvbi5zbGVycEZsYXQoIGJ1ZmZlciwgZHN0T2Zmc2V0LCBidWZmZXIsIGRzdE9mZnNldCwgYnVmZmVyLCB3b3JrT2Zmc2V0LCB0ICk7CgoJfQoKCV9sZXJwKCBidWZmZXIsIGRzdE9mZnNldCwgc3JjT2Zmc2V0LCB0LCBzdHJpZGUgKSB7CgoJCWNvbnN0IHMgPSAxIC0gdDsKCgkJZm9yICggbGV0IGkgPSAwOyBpICE9PSBzdHJpZGU7ICsrIGkgKSB7CgoJCQljb25zdCBqID0gZHN0T2Zmc2V0ICsgaTsKCgkJCWJ1ZmZlclsgaiBdID0gYnVmZmVyWyBqIF0gKiBzICsgYnVmZmVyWyBzcmNPZmZzZXQgKyBpIF0gKiB0OwoKCQl9CgoJfQoKCV9sZXJwQWRkaXRpdmUoIGJ1ZmZlciwgZHN0T2Zmc2V0LCBzcmNPZmZzZXQsIHQsIHN0cmlkZSApIHsKCgkJZm9yICggbGV0IGkgPSAwOyBpICE9PSBzdHJpZGU7ICsrIGkgKSB7CgoJCQljb25zdCBqID0gZHN0T2Zmc2V0ICsgaTsKCgkJCWJ1ZmZlclsgaiBdID0gYnVmZmVyWyBqIF0gKyBidWZmZXJbIHNyY09mZnNldCArIGkgXSAqIHQ7CgoJCX0KCgl9Cgp9CgovLyBDaGFyYWN0ZXJzIFtdLjovIGFyZSByZXNlcnZlZCBmb3IgdHJhY2sgYmluZGluZyBzeW50YXguCmNvbnN0IF9SRVNFUlZFRF9DSEFSU19SRSA9ICdcXFtcXF1cXC46XFwvJzsKY29uc3QgX3Jlc2VydmVkUmUgPSBuZXcgUmVnRXhwKCAnWycgKyBfUkVTRVJWRURfQ0hBUlNfUkUgKyAnXScsICdnJyApOwoKLy8gQXR0ZW1wdHMgdG8gYWxsb3cgbm9kZSBuYW1lcyBmcm9tIGFueSBsYW5ndWFnZS4gRVM1J3MgYFx3YCByZWdleHAgbWF0Y2hlcwovLyBvbmx5IGxhdGluIGNoYXJhY3RlcnMsIGFuZCB0aGUgdW5pY29kZSBccHtMfSBpcyBub3QgeWV0IHN1cHBvcnRlZC4gU28KLy8gaW5zdGVhZCwgd2UgZXhjbHVkZSByZXNlcnZlZCBjaGFyYWN0ZXJzIGFuZCBtYXRjaCBldmVyeXRoaW5nIGVsc2UuCmNvbnN0IF93b3JkQ2hhciA9ICdbXicgKyBfUkVTRVJWRURfQ0hBUlNfUkUgKyAnXSc7CmNvbnN0IF93b3JkQ2hhck9yRG90ID0gJ1teJyArIF9SRVNFUlZFRF9DSEFSU19SRS5yZXBsYWNlKCAnXFwuJywgJycgKSArICddJzsKCi8vIFBhcmVudCBkaXJlY3RvcmllcywgZGVsaW1pdGVkIGJ5ICcvJyBvciAnOicuIEN1cnJlbnRseSB1bnVzZWQsIGJ1dCBtdXN0Ci8vIGJlIG1hdGNoZWQgdG8gcGFyc2UgdGhlIHJlc3Qgb2YgdGhlIHRyYWNrIG5hbWUuCmNvbnN0IF9kaXJlY3RvcnlSZSA9IC8qQF9fUFVSRV9fKi8gLygoPzpXQytbXC86XSkqKS8uc291cmNlLnJlcGxhY2UoICdXQycsIF93b3JkQ2hhciApOwoKLy8gVGFyZ2V0IG5vZGUuIE1heSBjb250YWluIHdvcmQgY2hhcmFjdGVycyAoYS16QS1aMC05XykgYW5kICcuJyBvciAnLScuCmNvbnN0IF9ub2RlUmUgPSAvKkBfX1BVUkVfXyovIC8oV0NPRCspPy8uc291cmNlLnJlcGxhY2UoICdXQ09EJywgX3dvcmRDaGFyT3JEb3QgKTsKCi8vIE9iamVjdCBvbiB0YXJnZXQgbm9kZSwgYW5kIGFjY2Vzc29yLiBNYXkgbm90IGNvbnRhaW4gcmVzZXJ2ZWQKLy8gY2hhcmFjdGVycy4gQWNjZXNzb3IgbWF5IGNvbnRhaW4gYW55IGNoYXJhY3RlciBleGNlcHQgY2xvc2luZyBicmFja2V0Lgpjb25zdCBfb2JqZWN0UmUgPSAvKkBfX1BVUkVfXyovIC8oPzpcLihXQyspKD86XFsoLispXF0pPyk/Ly5zb3VyY2UucmVwbGFjZSggJ1dDJywgX3dvcmRDaGFyICk7CgovLyBQcm9wZXJ0eSBhbmQgYWNjZXNzb3IuIE1heSBub3QgY29udGFpbiByZXNlcnZlZCBjaGFyYWN0ZXJzLiBBY2Nlc3NvciBtYXkKLy8gY29udGFpbiBhbnkgbm9uLWJyYWNrZXQgY2hhcmFjdGVycy4KY29uc3QgX3Byb3BlcnR5UmUgPSAvKkBfX1BVUkVfXyovIC9cLihXQyspKD86XFsoLispXF0pPy8uc291cmNlLnJlcGxhY2UoICdXQycsIF93b3JkQ2hhciApOwoKY29uc3QgX3RyYWNrUmUgPSBuZXcgUmVnRXhwKCAnJwoJKyAnXicKCSsgX2RpcmVjdG9yeVJlCgkrIF9ub2RlUmUKCSsgX29iamVjdFJlCgkrIF9wcm9wZXJ0eVJlCgkrICckJwopOwoKY29uc3QgX3N1cHBvcnRlZE9iamVjdE5hbWVzID0gWyAnbWF0ZXJpYWwnLCAnbWF0ZXJpYWxzJywgJ2JvbmVzJywgJ21hcCcgXTsKCmNsYXNzIENvbXBvc2l0ZSB7CgoJY29uc3RydWN0b3IoIHRhcmdldEdyb3VwLCBwYXRoLCBvcHRpb25hbFBhcnNlZFBhdGggKSB7CgoJCWNvbnN0IHBhcnNlZFBhdGggPSBvcHRpb25hbFBhcnNlZFBhdGggfHwgUHJvcGVydHlCaW5kaW5nLnBhcnNlVHJhY2tOYW1lKCBwYXRoICk7CgoJCXRoaXMuX3RhcmdldEdyb3VwID0gdGFyZ2V0R3JvdXA7CgkJdGhpcy5fYmluZGluZ3MgPSB0YXJnZXRHcm91cC5zdWJzY3JpYmVfKCBwYXRoLCBwYXJzZWRQYXRoICk7CgoJfQoKCWdldFZhbHVlKCBhcnJheSwgb2Zmc2V0ICkgewoKCQl0aGlzLmJpbmQoKTsgLy8gYmluZCBhbGwgYmluZGluZwoKCQljb25zdCBmaXJzdFZhbGlkSW5kZXggPSB0aGlzLl90YXJnZXRHcm91cC5uQ2FjaGVkT2JqZWN0c18sCgkJCWJpbmRpbmcgPSB0aGlzLl9iaW5kaW5nc1sgZmlyc3RWYWxpZEluZGV4IF07CgoJCS8vIGFuZCBvbmx5IGNhbGwgLmdldFZhbHVlIG9uIHRoZSBmaXJzdAoJCWlmICggYmluZGluZyAhPT0gdW5kZWZpbmVkICkgYmluZGluZy5nZXRWYWx1ZSggYXJyYXksIG9mZnNldCApOwoKCX0KCglzZXRWYWx1ZSggYXJyYXksIG9mZnNldCApIHsKCgkJY29uc3QgYmluZGluZ3MgPSB0aGlzLl9iaW5kaW5nczsKCgkJZm9yICggbGV0IGkgPSB0aGlzLl90YXJnZXRHcm91cC5uQ2FjaGVkT2JqZWN0c18sIG4gPSBiaW5kaW5ncy5sZW5ndGg7IGkgIT09IG47ICsrIGkgKSB7CgoJCQliaW5kaW5nc1sgaSBdLnNldFZhbHVlKCBhcnJheSwgb2Zmc2V0ICk7CgoJCX0KCgl9CgoJYmluZCgpIHsKCgkJY29uc3QgYmluZGluZ3MgPSB0aGlzLl9iaW5kaW5nczsKCgkJZm9yICggbGV0IGkgPSB0aGlzLl90YXJnZXRHcm91cC5uQ2FjaGVkT2JqZWN0c18sIG4gPSBiaW5kaW5ncy5sZW5ndGg7IGkgIT09IG47ICsrIGkgKSB7CgoJCQliaW5kaW5nc1sgaSBdLmJpbmQoKTsKCgkJfQoKCX0KCgl1bmJpbmQoKSB7CgoJCWNvbnN0IGJpbmRpbmdzID0gdGhpcy5fYmluZGluZ3M7CgoJCWZvciAoIGxldCBpID0gdGhpcy5fdGFyZ2V0R3JvdXAubkNhY2hlZE9iamVjdHNfLCBuID0gYmluZGluZ3MubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJYmluZGluZ3NbIGkgXS51bmJpbmQoKTsKCgkJfQoKCX0KCn0KCi8vIE5vdGU6IFRoaXMgY2xhc3MgdXNlcyBhIFN0YXRlIHBhdHRlcm4gb24gYSBwZXItbWV0aG9kIGJhc2lzOgovLyAnYmluZCcgc2V0cyAndGhpcy5nZXRWYWx1ZScgLyAnc2V0VmFsdWUnIGFuZCBzaGFkb3dzIHRoZQovLyBwcm90b3R5cGUgdmVyc2lvbiBvZiB0aGVzZSBtZXRob2RzIHdpdGggb25lIHRoYXQgcmVwcmVzZW50cwovLyB0aGUgYm91bmQgc3RhdGUuIFdoZW4gdGhlIHByb3BlcnR5IGlzIG5vdCBmb3VuZCwgdGhlIG1ldGhvZHMKLy8gYmVjb21lIG5vLW9wcy4KY2xhc3MgUHJvcGVydHlCaW5kaW5nIHsKCgljb25zdHJ1Y3Rvciggcm9vdE5vZGUsIHBhdGgsIHBhcnNlZFBhdGggKSB7CgoJCXRoaXMucGF0aCA9IHBhdGg7CgkJdGhpcy5wYXJzZWRQYXRoID0gcGFyc2VkUGF0aCB8fCBQcm9wZXJ0eUJpbmRpbmcucGFyc2VUcmFja05hbWUoIHBhdGggKTsKCgkJdGhpcy5ub2RlID0gUHJvcGVydHlCaW5kaW5nLmZpbmROb2RlKCByb290Tm9kZSwgdGhpcy5wYXJzZWRQYXRoLm5vZGVOYW1lICk7CgoJCXRoaXMucm9vdE5vZGUgPSByb290Tm9kZTsKCgkJLy8gaW5pdGlhbCBzdGF0ZSBvZiB0aGVzZSBtZXRob2RzIHRoYXQgY2FsbHMgJ2JpbmQnCgkJdGhpcy5nZXRWYWx1ZSA9IHRoaXMuX2dldFZhbHVlX3VuYm91bmQ7CgkJdGhpcy5zZXRWYWx1ZSA9IHRoaXMuX3NldFZhbHVlX3VuYm91bmQ7CgoJfQoKCglzdGF0aWMgY3JlYXRlKCByb290LCBwYXRoLCBwYXJzZWRQYXRoICkgewoKCQlpZiAoICEgKCByb290ICYmIHJvb3QuaXNBbmltYXRpb25PYmplY3RHcm91cCApICkgewoKCQkJcmV0dXJuIG5ldyBQcm9wZXJ0eUJpbmRpbmcoIHJvb3QsIHBhdGgsIHBhcnNlZFBhdGggKTsKCgkJfSBlbHNlIHsKCgkJCXJldHVybiBuZXcgUHJvcGVydHlCaW5kaW5nLkNvbXBvc2l0ZSggcm9vdCwgcGF0aCwgcGFyc2VkUGF0aCApOwoKCQl9CgoJfQoKCS8qKgoJICogUmVwbGFjZXMgc3BhY2VzIHdpdGggdW5kZXJzY29yZXMgYW5kIHJlbW92ZXMgdW5zdXBwb3J0ZWQgY2hhcmFjdGVycyBmcm9tCgkgKiBub2RlIG5hbWVzLCB0byBlbnN1cmUgY29tcGF0aWJpbGl0eSB3aXRoIHBhcnNlVHJhY2tOYW1lKCkuCgkgKgoJICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTm9kZSBuYW1lIHRvIGJlIHNhbml0aXplZC4KCSAqIEByZXR1cm4ge3N0cmluZ30KCSAqLwoJc3RhdGljIHNhbml0aXplTm9kZU5hbWUoIG5hbWUgKSB7CgoJCXJldHVybiBuYW1lLnJlcGxhY2UoIC9ccy9nLCAnXycgKS5yZXBsYWNlKCBfcmVzZXJ2ZWRSZSwgJycgKTsKCgl9CgoJc3RhdGljIHBhcnNlVHJhY2tOYW1lKCB0cmFja05hbWUgKSB7CgoJCWNvbnN0IG1hdGNoZXMgPSBfdHJhY2tSZS5leGVjKCB0cmFja05hbWUgKTsKCgkJaWYgKCBtYXRjaGVzID09PSBudWxsICkgewoKCQkJdGhyb3cgbmV3IEVycm9yKCAnUHJvcGVydHlCaW5kaW5nOiBDYW5ub3QgcGFyc2UgdHJhY2tOYW1lOiAnICsgdHJhY2tOYW1lICk7CgoJCX0KCgkJY29uc3QgcmVzdWx0cyA9IHsKCQkJLy8gZGlyZWN0b3J5TmFtZTogbWF0Y2hlc1sgMSBdLCAvLyAodHNjaHcpIGN1cnJlbnRseSB1bnVzZWQKCQkJbm9kZU5hbWU6IG1hdGNoZXNbIDIgXSwKCQkJb2JqZWN0TmFtZTogbWF0Y2hlc1sgMyBdLAoJCQlvYmplY3RJbmRleDogbWF0Y2hlc1sgNCBdLAoJCQlwcm9wZXJ0eU5hbWU6IG1hdGNoZXNbIDUgXSwgLy8gcmVxdWlyZWQKCQkJcHJvcGVydHlJbmRleDogbWF0Y2hlc1sgNiBdCgkJfTsKCgkJY29uc3QgbGFzdERvdCA9IHJlc3VsdHMubm9kZU5hbWUgJiYgcmVzdWx0cy5ub2RlTmFtZS5sYXN0SW5kZXhPZiggJy4nICk7CgoJCWlmICggbGFzdERvdCAhPT0gdW5kZWZpbmVkICYmIGxhc3REb3QgIT09IC0gMSApIHsKCgkJCWNvbnN0IG9iamVjdE5hbWUgPSByZXN1bHRzLm5vZGVOYW1lLnN1YnN0cmluZyggbGFzdERvdCArIDEgKTsKCgkJCS8vIE9iamVjdCBuYW1lcyBtdXN0IGJlIGNoZWNrZWQgYWdhaW5zdCBhbiBhbGxvd2xpc3QuIE90aGVyd2lzZSwgdGhlcmUKCQkJLy8gaXMgbm8gd2F5IHRvIHBhcnNlICdmb28uYmFyLmJheic6ICdiYXonIG11c3QgYmUgYSBwcm9wZXJ0eSwgYnV0CgkJCS8vICdiYXInIGNvdWxkIGJlIHRoZSBvYmplY3ROYW1lLCBvciBwYXJ0IG9mIGEgbm9kZU5hbWUgKHdoaWNoIGNhbgoJCQkvLyBpbmNsdWRlICcuJyBjaGFyYWN0ZXJzKS4KCQkJaWYgKCBfc3VwcG9ydGVkT2JqZWN0TmFtZXMuaW5kZXhPZiggb2JqZWN0TmFtZSApICE9PSAtIDEgKSB7CgoJCQkJcmVzdWx0cy5ub2RlTmFtZSA9IHJlc3VsdHMubm9kZU5hbWUuc3Vic3RyaW5nKCAwLCBsYXN0RG90ICk7CgkJCQlyZXN1bHRzLm9iamVjdE5hbWUgPSBvYmplY3ROYW1lOwoKCQkJfQoKCQl9CgoJCWlmICggcmVzdWx0cy5wcm9wZXJ0eU5hbWUgPT09IG51bGwgfHwgcmVzdWx0cy5wcm9wZXJ0eU5hbWUubGVuZ3RoID09PSAwICkgewoKCQkJdGhyb3cgbmV3IEVycm9yKCAnUHJvcGVydHlCaW5kaW5nOiBjYW4gbm90IHBhcnNlIHByb3BlcnR5TmFtZSBmcm9tIHRyYWNrTmFtZTogJyArIHRyYWNrTmFtZSApOwoKCQl9CgoJCXJldHVybiByZXN1bHRzOwoKCX0KCglzdGF0aWMgZmluZE5vZGUoIHJvb3QsIG5vZGVOYW1lICkgewoKCQlpZiAoIG5vZGVOYW1lID09PSB1bmRlZmluZWQgfHwgbm9kZU5hbWUgPT09ICcnIHx8IG5vZGVOYW1lID09PSAnLicgfHwgbm9kZU5hbWUgPT09IC0gMSB8fCBub2RlTmFtZSA9PT0gcm9vdC5uYW1lIHx8IG5vZGVOYW1lID09PSByb290LnV1aWQgKSB7CgoJCQlyZXR1cm4gcm9vdDsKCgkJfQoKCQkvLyBzZWFyY2ggaW50byBza2VsZXRvbiBib25lcy4KCQlpZiAoIHJvb3Quc2tlbGV0b24gKSB7CgoJCQljb25zdCBib25lID0gcm9vdC5za2VsZXRvbi5nZXRCb25lQnlOYW1lKCBub2RlTmFtZSApOwoKCQkJaWYgKCBib25lICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJcmV0dXJuIGJvbmU7CgoJCQl9CgoJCX0KCgkJLy8gc2VhcmNoIGludG8gbm9kZSBzdWJ0cmVlLgoJCWlmICggcm9vdC5jaGlsZHJlbiApIHsKCgkJCWNvbnN0IHNlYXJjaE5vZGVTdWJ0cmVlID0gZnVuY3Rpb24gKCBjaGlsZHJlbiApIHsKCgkJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkgKysgKSB7CgoJCQkJCWNvbnN0IGNoaWxkTm9kZSA9IGNoaWxkcmVuWyBpIF07CgoJCQkJCWlmICggY2hpbGROb2RlLm5hbWUgPT09IG5vZGVOYW1lIHx8IGNoaWxkTm9kZS51dWlkID09PSBub2RlTmFtZSApIHsKCgkJCQkJCXJldHVybiBjaGlsZE5vZGU7CgoJCQkJCX0KCgkJCQkJY29uc3QgcmVzdWx0ID0gc2VhcmNoTm9kZVN1YnRyZWUoIGNoaWxkTm9kZS5jaGlsZHJlbiApOwoKCQkJCQlpZiAoIHJlc3VsdCApIHJldHVybiByZXN1bHQ7CgoJCQkJfQoKCQkJCXJldHVybiBudWxsOwoKCQkJfTsKCgkJCWNvbnN0IHN1YlRyZWVOb2RlID0gc2VhcmNoTm9kZVN1YnRyZWUoIHJvb3QuY2hpbGRyZW4gKTsKCgkJCWlmICggc3ViVHJlZU5vZGUgKSB7CgoJCQkJcmV0dXJuIHN1YlRyZWVOb2RlOwoKCQkJfQoKCQl9CgoJCXJldHVybiBudWxsOwoKCX0KCgkvLyB0aGVzZSBhcmUgdXNlZCB0byAiYmluZCIgYSBub25leGlzdGVudCBwcm9wZXJ0eQoJX2dldFZhbHVlX3VuYXZhaWxhYmxlKCkge30KCV9zZXRWYWx1ZV91bmF2YWlsYWJsZSgpIHt9CgoJLy8gR2V0dGVycwoKCV9nZXRWYWx1ZV9kaXJlY3QoIGJ1ZmZlciwgb2Zmc2V0ICkgewoKCQlidWZmZXJbIG9mZnNldCBdID0gdGhpcy50YXJnZXRPYmplY3RbIHRoaXMucHJvcGVydHlOYW1lIF07CgoJfQoKCV9nZXRWYWx1ZV9hcnJheSggYnVmZmVyLCBvZmZzZXQgKSB7CgoJCWNvbnN0IHNvdXJjZSA9IHRoaXMucmVzb2x2ZWRQcm9wZXJ0eTsKCgkJZm9yICggbGV0IGkgPSAwLCBuID0gc291cmNlLmxlbmd0aDsgaSAhPT0gbjsgKysgaSApIHsKCgkJCWJ1ZmZlclsgb2Zmc2V0ICsrIF0gPSBzb3VyY2VbIGkgXTsKCgkJfQoKCX0KCglfZ2V0VmFsdWVfYXJyYXlFbGVtZW50KCBidWZmZXIsIG9mZnNldCApIHsKCgkJYnVmZmVyWyBvZmZzZXQgXSA9IHRoaXMucmVzb2x2ZWRQcm9wZXJ0eVsgdGhpcy5wcm9wZXJ0eUluZGV4IF07CgoJfQoKCV9nZXRWYWx1ZV90b0FycmF5KCBidWZmZXIsIG9mZnNldCApIHsKCgkJdGhpcy5yZXNvbHZlZFByb3BlcnR5LnRvQXJyYXkoIGJ1ZmZlciwgb2Zmc2V0ICk7CgoJfQoKCS8vIERpcmVjdAoKCV9zZXRWYWx1ZV9kaXJlY3QoIGJ1ZmZlciwgb2Zmc2V0ICkgewoKCQl0aGlzLnRhcmdldE9iamVjdFsgdGhpcy5wcm9wZXJ0eU5hbWUgXSA9IGJ1ZmZlclsgb2Zmc2V0IF07CgoJfQoKCV9zZXRWYWx1ZV9kaXJlY3Rfc2V0TmVlZHNVcGRhdGUoIGJ1ZmZlciwgb2Zmc2V0ICkgewoKCQl0aGlzLnRhcmdldE9iamVjdFsgdGhpcy5wcm9wZXJ0eU5hbWUgXSA9IGJ1ZmZlclsgb2Zmc2V0IF07CgkJdGhpcy50YXJnZXRPYmplY3QubmVlZHNVcGRhdGUgPSB0cnVlOwoKCX0KCglfc2V0VmFsdWVfZGlyZWN0X3NldE1hdHJpeFdvcmxkTmVlZHNVcGRhdGUoIGJ1ZmZlciwgb2Zmc2V0ICkgewoKCQl0aGlzLnRhcmdldE9iamVjdFsgdGhpcy5wcm9wZXJ0eU5hbWUgXSA9IGJ1ZmZlclsgb2Zmc2V0IF07CgkJdGhpcy50YXJnZXRPYmplY3QubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9IHRydWU7CgoJfQoKCS8vIEVudGlyZUFycmF5CgoJX3NldFZhbHVlX2FycmF5KCBidWZmZXIsIG9mZnNldCApIHsKCgkJY29uc3QgZGVzdCA9IHRoaXMucmVzb2x2ZWRQcm9wZXJ0eTsKCgkJZm9yICggbGV0IGkgPSAwLCBuID0gZGVzdC5sZW5ndGg7IGkgIT09IG47ICsrIGkgKSB7CgoJCQlkZXN0WyBpIF0gPSBidWZmZXJbIG9mZnNldCArKyBdOwoKCQl9CgoJfQoKCV9zZXRWYWx1ZV9hcnJheV9zZXROZWVkc1VwZGF0ZSggYnVmZmVyLCBvZmZzZXQgKSB7CgoJCWNvbnN0IGRlc3QgPSB0aGlzLnJlc29sdmVkUHJvcGVydHk7CgoJCWZvciAoIGxldCBpID0gMCwgbiA9IGRlc3QubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJZGVzdFsgaSBdID0gYnVmZmVyWyBvZmZzZXQgKysgXTsKCgkJfQoKCQl0aGlzLnRhcmdldE9iamVjdC5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJfQoKCV9zZXRWYWx1ZV9hcnJheV9zZXRNYXRyaXhXb3JsZE5lZWRzVXBkYXRlKCBidWZmZXIsIG9mZnNldCApIHsKCgkJY29uc3QgZGVzdCA9IHRoaXMucmVzb2x2ZWRQcm9wZXJ0eTsKCgkJZm9yICggbGV0IGkgPSAwLCBuID0gZGVzdC5sZW5ndGg7IGkgIT09IG47ICsrIGkgKSB7CgoJCQlkZXN0WyBpIF0gPSBidWZmZXJbIG9mZnNldCArKyBdOwoKCQl9CgoJCXRoaXMudGFyZ2V0T2JqZWN0Lm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSB0cnVlOwoKCX0KCgkvLyBBcnJheUVsZW1lbnQKCglfc2V0VmFsdWVfYXJyYXlFbGVtZW50KCBidWZmZXIsIG9mZnNldCApIHsKCgkJdGhpcy5yZXNvbHZlZFByb3BlcnR5WyB0aGlzLnByb3BlcnR5SW5kZXggXSA9IGJ1ZmZlclsgb2Zmc2V0IF07CgoJfQoKCV9zZXRWYWx1ZV9hcnJheUVsZW1lbnRfc2V0TmVlZHNVcGRhdGUoIGJ1ZmZlciwgb2Zmc2V0ICkgewoKCQl0aGlzLnJlc29sdmVkUHJvcGVydHlbIHRoaXMucHJvcGVydHlJbmRleCBdID0gYnVmZmVyWyBvZmZzZXQgXTsKCQl0aGlzLnRhcmdldE9iamVjdC5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJfQoKCV9zZXRWYWx1ZV9hcnJheUVsZW1lbnRfc2V0TWF0cml4V29ybGROZWVkc1VwZGF0ZSggYnVmZmVyLCBvZmZzZXQgKSB7CgoJCXRoaXMucmVzb2x2ZWRQcm9wZXJ0eVsgdGhpcy5wcm9wZXJ0eUluZGV4IF0gPSBidWZmZXJbIG9mZnNldCBdOwoJCXRoaXMudGFyZ2V0T2JqZWN0Lm1hdHJpeFdvcmxkTmVlZHNVcGRhdGUgPSB0cnVlOwoKCX0KCgkvLyBIYXNUb0Zyb21BcnJheQoKCV9zZXRWYWx1ZV9mcm9tQXJyYXkoIGJ1ZmZlciwgb2Zmc2V0ICkgewoKCQl0aGlzLnJlc29sdmVkUHJvcGVydHkuZnJvbUFycmF5KCBidWZmZXIsIG9mZnNldCApOwoKCX0KCglfc2V0VmFsdWVfZnJvbUFycmF5X3NldE5lZWRzVXBkYXRlKCBidWZmZXIsIG9mZnNldCApIHsKCgkJdGhpcy5yZXNvbHZlZFByb3BlcnR5LmZyb21BcnJheSggYnVmZmVyLCBvZmZzZXQgKTsKCQl0aGlzLnRhcmdldE9iamVjdC5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJfQoKCV9zZXRWYWx1ZV9mcm9tQXJyYXlfc2V0TWF0cml4V29ybGROZWVkc1VwZGF0ZSggYnVmZmVyLCBvZmZzZXQgKSB7CgoJCXRoaXMucmVzb2x2ZWRQcm9wZXJ0eS5mcm9tQXJyYXkoIGJ1ZmZlciwgb2Zmc2V0ICk7CgkJdGhpcy50YXJnZXRPYmplY3QubWF0cml4V29ybGROZWVkc1VwZGF0ZSA9IHRydWU7CgoJfQoKCV9nZXRWYWx1ZV91bmJvdW5kKCB0YXJnZXRBcnJheSwgb2Zmc2V0ICkgewoKCQl0aGlzLmJpbmQoKTsKCQl0aGlzLmdldFZhbHVlKCB0YXJnZXRBcnJheSwgb2Zmc2V0ICk7CgoJfQoKCV9zZXRWYWx1ZV91bmJvdW5kKCBzb3VyY2VBcnJheSwgb2Zmc2V0ICkgewoKCQl0aGlzLmJpbmQoKTsKCQl0aGlzLnNldFZhbHVlKCBzb3VyY2VBcnJheSwgb2Zmc2V0ICk7CgoJfQoKCS8vIGNyZWF0ZSBnZXR0ZXIgLyBzZXR0ZXIgcGFpciBmb3IgYSBwcm9wZXJ0eSBpbiB0aGUgc2NlbmUgZ3JhcGgKCWJpbmQoKSB7CgoJCWxldCB0YXJnZXRPYmplY3QgPSB0aGlzLm5vZGU7CgkJY29uc3QgcGFyc2VkUGF0aCA9IHRoaXMucGFyc2VkUGF0aDsKCgkJY29uc3Qgb2JqZWN0TmFtZSA9IHBhcnNlZFBhdGgub2JqZWN0TmFtZTsKCQljb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXJzZWRQYXRoLnByb3BlcnR5TmFtZTsKCQlsZXQgcHJvcGVydHlJbmRleCA9IHBhcnNlZFBhdGgucHJvcGVydHlJbmRleDsKCgkJaWYgKCAhIHRhcmdldE9iamVjdCApIHsKCgkJCXRhcmdldE9iamVjdCA9IFByb3BlcnR5QmluZGluZy5maW5kTm9kZSggdGhpcy5yb290Tm9kZSwgcGFyc2VkUGF0aC5ub2RlTmFtZSApOwoKCQkJdGhpcy5ub2RlID0gdGFyZ2V0T2JqZWN0OwoKCQl9CgoJCS8vIHNldCBmYWlsIHN0YXRlIHNvIHdlIGNhbiBqdXN0ICdyZXR1cm4nIG9uIGVycm9yCgkJdGhpcy5nZXRWYWx1ZSA9IHRoaXMuX2dldFZhbHVlX3VuYXZhaWxhYmxlOwoJCXRoaXMuc2V0VmFsdWUgPSB0aGlzLl9zZXRWYWx1ZV91bmF2YWlsYWJsZTsKCgkJLy8gZW5zdXJlIHRoZXJlIGlzIGEgdmFsdWUgbm9kZQoJCWlmICggISB0YXJnZXRPYmplY3QgKSB7CgoJCQljb25zb2xlLndhcm4oICdUSFJFRS5Qcm9wZXJ0eUJpbmRpbmc6IE5vIHRhcmdldCBub2RlIGZvdW5kIGZvciB0cmFjazogJyArIHRoaXMucGF0aCArICcuJyApOwoJCQlyZXR1cm47CgoJCX0KCgkJaWYgKCBvYmplY3ROYW1lICkgewoKCQkJbGV0IG9iamVjdEluZGV4ID0gcGFyc2VkUGF0aC5vYmplY3RJbmRleDsKCgkJCS8vIHNwZWNpYWwgY2FzZXMgd2VyZSB3ZSBuZWVkIHRvIHJlYWNoIGRlZXBlciBpbnRvIHRoZSBoaWVyYXJjaHkgdG8gZ2V0IHRoZSBmYWNlIG1hdGVyaWFscy4uLi4KCQkJc3dpdGNoICggb2JqZWN0TmFtZSApIHsKCgkJCQljYXNlICdtYXRlcmlhbHMnOgoKCQkJCQlpZiAoICEgdGFyZ2V0T2JqZWN0Lm1hdGVyaWFsICkgewoKCQkJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLlByb3BlcnR5QmluZGluZzogQ2FuIG5vdCBiaW5kIHRvIG1hdGVyaWFsIGFzIG5vZGUgZG9lcyBub3QgaGF2ZSBhIG1hdGVyaWFsLicsIHRoaXMgKTsKCQkJCQkJcmV0dXJuOwoKCQkJCQl9CgoJCQkJCWlmICggISB0YXJnZXRPYmplY3QubWF0ZXJpYWwubWF0ZXJpYWxzICkgewoKCQkJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLlByb3BlcnR5QmluZGluZzogQ2FuIG5vdCBiaW5kIHRvIG1hdGVyaWFsLm1hdGVyaWFscyBhcyBub2RlLm1hdGVyaWFsIGRvZXMgbm90IGhhdmUgYSBtYXRlcmlhbHMgYXJyYXkuJywgdGhpcyApOwoJCQkJCQlyZXR1cm47CgoJCQkJCX0KCgkJCQkJdGFyZ2V0T2JqZWN0ID0gdGFyZ2V0T2JqZWN0Lm1hdGVyaWFsLm1hdGVyaWFsczsKCgkJCQkJYnJlYWs7CgoJCQkJY2FzZSAnYm9uZXMnOgoKCQkJCQlpZiAoICEgdGFyZ2V0T2JqZWN0LnNrZWxldG9uICkgewoKCQkJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLlByb3BlcnR5QmluZGluZzogQ2FuIG5vdCBiaW5kIHRvIGJvbmVzIGFzIG5vZGUgZG9lcyBub3QgaGF2ZSBhIHNrZWxldG9uLicsIHRoaXMgKTsKCQkJCQkJcmV0dXJuOwoKCQkJCQl9CgoJCQkJCS8vIHBvdGVudGlhbCBmdXR1cmUgb3B0aW1pemF0aW9uOiBza2lwIHRoaXMgaWYgcHJvcGVydHlJbmRleCBpcyBhbHJlYWR5IGFuIGludGVnZXIKCQkJCQkvLyBhbmQgY29udmVydCB0aGUgaW50ZWdlciBzdHJpbmcgdG8gYSB0cnVlIGludGVnZXIuCgoJCQkJCXRhcmdldE9iamVjdCA9IHRhcmdldE9iamVjdC5za2VsZXRvbi5ib25lczsKCgkJCQkJLy8gc3VwcG9ydCByZXNvbHZpbmcgbW9ycGhUYXJnZXQgbmFtZXMgaW50byBpbmRpY2VzLgoJCQkJCWZvciAoIGxldCBpID0gMDsgaSA8IHRhcmdldE9iamVjdC5sZW5ndGg7IGkgKysgKSB7CgoJCQkJCQlpZiAoIHRhcmdldE9iamVjdFsgaSBdLm5hbWUgPT09IG9iamVjdEluZGV4ICkgewoKCQkJCQkJCW9iamVjdEluZGV4ID0gaTsKCQkJCQkJCWJyZWFrOwoKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgJ21hcCc6CgoJCQkJCWlmICggJ21hcCcgaW4gdGFyZ2V0T2JqZWN0ICkgewoKCQkJCQkJdGFyZ2V0T2JqZWN0ID0gdGFyZ2V0T2JqZWN0Lm1hcDsKCQkJCQkJYnJlYWs7CgoJCQkJCX0KCgkJCQkJaWYgKCAhIHRhcmdldE9iamVjdC5tYXRlcmlhbCApIHsKCgkJCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5Qcm9wZXJ0eUJpbmRpbmc6IENhbiBub3QgYmluZCB0byBtYXRlcmlhbCBhcyBub2RlIGRvZXMgbm90IGhhdmUgYSBtYXRlcmlhbC4nLCB0aGlzICk7CgkJCQkJCXJldHVybjsKCgkJCQkJfQoKCQkJCQlpZiAoICEgdGFyZ2V0T2JqZWN0Lm1hdGVyaWFsLm1hcCApIHsKCgkJCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5Qcm9wZXJ0eUJpbmRpbmc6IENhbiBub3QgYmluZCB0byBtYXRlcmlhbC5tYXAgYXMgbm9kZS5tYXRlcmlhbCBkb2VzIG5vdCBoYXZlIGEgbWFwLicsIHRoaXMgKTsKCQkJCQkJcmV0dXJuOwoKCQkJCQl9CgoJCQkJCXRhcmdldE9iamVjdCA9IHRhcmdldE9iamVjdC5tYXRlcmlhbC5tYXA7CgkJCQkJYnJlYWs7CgoJCQkJZGVmYXVsdDoKCgkJCQkJaWYgKCB0YXJnZXRPYmplY3RbIG9iamVjdE5hbWUgXSA9PT0gdW5kZWZpbmVkICkgewoKCQkJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLlByb3BlcnR5QmluZGluZzogQ2FuIG5vdCBiaW5kIHRvIG9iamVjdE5hbWUgb2Ygbm9kZSB1bmRlZmluZWQuJywgdGhpcyApOwoJCQkJCQlyZXR1cm47CgoJCQkJCX0KCgkJCQkJdGFyZ2V0T2JqZWN0ID0gdGFyZ2V0T2JqZWN0WyBvYmplY3ROYW1lIF07CgoJCQl9CgoKCQkJaWYgKCBvYmplY3RJbmRleCAhPT0gdW5kZWZpbmVkICkgewoKCQkJCWlmICggdGFyZ2V0T2JqZWN0WyBvYmplY3RJbmRleCBdID09PSB1bmRlZmluZWQgKSB7CgoJCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5Qcm9wZXJ0eUJpbmRpbmc6IFRyeWluZyB0byBiaW5kIHRvIG9iamVjdEluZGV4IG9mIG9iamVjdE5hbWUsIGJ1dCBpcyB1bmRlZmluZWQuJywgdGhpcywgdGFyZ2V0T2JqZWN0ICk7CgkJCQkJcmV0dXJuOwoKCQkJCX0KCgkJCQl0YXJnZXRPYmplY3QgPSB0YXJnZXRPYmplY3RbIG9iamVjdEluZGV4IF07CgoJCQl9CgoJCX0KCgkJLy8gcmVzb2x2ZSBwcm9wZXJ0eQoJCWNvbnN0IG5vZGVQcm9wZXJ0eSA9IHRhcmdldE9iamVjdFsgcHJvcGVydHlOYW1lIF07CgoJCWlmICggbm9kZVByb3BlcnR5ID09PSB1bmRlZmluZWQgKSB7CgoJCQljb25zdCBub2RlTmFtZSA9IHBhcnNlZFBhdGgubm9kZU5hbWU7CgoJCQljb25zb2xlLmVycm9yKCAnVEhSRUUuUHJvcGVydHlCaW5kaW5nOiBUcnlpbmcgdG8gdXBkYXRlIHByb3BlcnR5IGZvciB0cmFjazogJyArIG5vZGVOYW1lICsKCQkJCScuJyArIHByb3BlcnR5TmFtZSArICcgYnV0IGl0IHdhc25cJ3QgZm91bmQuJywgdGFyZ2V0T2JqZWN0ICk7CgkJCXJldHVybjsKCgkJfQoKCQkvLyBkZXRlcm1pbmUgdmVyc2lvbmluZyBzY2hlbWUKCQlsZXQgdmVyc2lvbmluZyA9IHRoaXMuVmVyc2lvbmluZy5Ob25lOwoKCQl0aGlzLnRhcmdldE9iamVjdCA9IHRhcmdldE9iamVjdDsKCgkJaWYgKCB0YXJnZXRPYmplY3QubmVlZHNVcGRhdGUgIT09IHVuZGVmaW5lZCApIHsgLy8gbWF0ZXJpYWwKCgkJCXZlcnNpb25pbmcgPSB0aGlzLlZlcnNpb25pbmcuTmVlZHNVcGRhdGU7CgoJCX0gZWxzZSBpZiAoIHRhcmdldE9iamVjdC5tYXRyaXhXb3JsZE5lZWRzVXBkYXRlICE9PSB1bmRlZmluZWQgKSB7IC8vIG5vZGUgdHJhbnNmb3JtCgoJCQl2ZXJzaW9uaW5nID0gdGhpcy5WZXJzaW9uaW5nLk1hdHJpeFdvcmxkTmVlZHNVcGRhdGU7CgoJCX0KCgkJLy8gZGV0ZXJtaW5lIGhvdyB0aGUgcHJvcGVydHkgZ2V0cyBib3VuZAoJCWxldCBiaW5kaW5nVHlwZSA9IHRoaXMuQmluZGluZ1R5cGUuRGlyZWN0OwoKCQlpZiAoIHByb3BlcnR5SW5kZXggIT09IHVuZGVmaW5lZCApIHsKCgkJCS8vIGFjY2VzcyBhIHN1YiBlbGVtZW50IG9mIHRoZSBwcm9wZXJ0eSBhcnJheSAob25seSBwcmltaXRpdmVzIGFyZSBzdXBwb3J0ZWQgcmlnaHQgbm93KQoKCQkJaWYgKCBwcm9wZXJ0eU5hbWUgPT09ICdtb3JwaFRhcmdldEluZmx1ZW5jZXMnICkgewoKCQkJCS8vIHBvdGVudGlhbCBvcHRpbWl6YXRpb24sIHNraXAgdGhpcyBpZiBwcm9wZXJ0eUluZGV4IGlzIGFscmVhZHkgYW4gaW50ZWdlciwgYW5kIGNvbnZlcnQgdGhlIGludGVnZXIgc3RyaW5nIHRvIGEgdHJ1ZSBpbnRlZ2VyLgoKCQkJCS8vIHN1cHBvcnQgcmVzb2x2aW5nIG1vcnBoVGFyZ2V0IG5hbWVzIGludG8gaW5kaWNlcy4KCQkJCWlmICggISB0YXJnZXRPYmplY3QuZ2VvbWV0cnkgKSB7CgoJCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5Qcm9wZXJ0eUJpbmRpbmc6IENhbiBub3QgYmluZCB0byBtb3JwaFRhcmdldEluZmx1ZW5jZXMgYmVjYXVzZSBub2RlIGRvZXMgbm90IGhhdmUgYSBnZW9tZXRyeS4nLCB0aGlzICk7CgkJCQkJcmV0dXJuOwoKCQkJCX0KCgkJCQlpZiAoICEgdGFyZ2V0T2JqZWN0Lmdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcyApIHsKCgkJCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLlByb3BlcnR5QmluZGluZzogQ2FuIG5vdCBiaW5kIHRvIG1vcnBoVGFyZ2V0SW5mbHVlbmNlcyBiZWNhdXNlIG5vZGUgZG9lcyBub3QgaGF2ZSBhIGdlb21ldHJ5Lm1vcnBoQXR0cmlidXRlcy4nLCB0aGlzICk7CgkJCQkJcmV0dXJuOwoKCQkJCX0KCgkJCQlpZiAoIHRhcmdldE9iamVjdC5tb3JwaFRhcmdldERpY3Rpb25hcnlbIHByb3BlcnR5SW5kZXggXSAhPT0gdW5kZWZpbmVkICkgewoKCQkJCQlwcm9wZXJ0eUluZGV4ID0gdGFyZ2V0T2JqZWN0Lm1vcnBoVGFyZ2V0RGljdGlvbmFyeVsgcHJvcGVydHlJbmRleCBdOwoKCQkJCX0KCgkJCX0KCgkJCWJpbmRpbmdUeXBlID0gdGhpcy5CaW5kaW5nVHlwZS5BcnJheUVsZW1lbnQ7CgoJCQl0aGlzLnJlc29sdmVkUHJvcGVydHkgPSBub2RlUHJvcGVydHk7CgkJCXRoaXMucHJvcGVydHlJbmRleCA9IHByb3BlcnR5SW5kZXg7CgoJCX0gZWxzZSBpZiAoIG5vZGVQcm9wZXJ0eS5mcm9tQXJyYXkgIT09IHVuZGVmaW5lZCAmJiBub2RlUHJvcGVydHkudG9BcnJheSAhPT0gdW5kZWZpbmVkICkgewoKCQkJLy8gbXVzdCB1c2UgY29weSBmb3IgT2JqZWN0M0QuRXVsZXIvUXVhdGVybmlvbgoKCQkJYmluZGluZ1R5cGUgPSB0aGlzLkJpbmRpbmdUeXBlLkhhc0Zyb21Ub0FycmF5OwoKCQkJdGhpcy5yZXNvbHZlZFByb3BlcnR5ID0gbm9kZVByb3BlcnR5OwoKCQl9IGVsc2UgaWYgKCBBcnJheS5pc0FycmF5KCBub2RlUHJvcGVydHkgKSApIHsKCgkJCWJpbmRpbmdUeXBlID0gdGhpcy5CaW5kaW5nVHlwZS5FbnRpcmVBcnJheTsKCgkJCXRoaXMucmVzb2x2ZWRQcm9wZXJ0eSA9IG5vZGVQcm9wZXJ0eTsKCgkJfSBlbHNlIHsKCgkJCXRoaXMucHJvcGVydHlOYW1lID0gcHJvcGVydHlOYW1lOwoKCQl9CgoJCS8vIHNlbGVjdCBnZXR0ZXIgLyBzZXR0ZXIKCQl0aGlzLmdldFZhbHVlID0gdGhpcy5HZXR0ZXJCeUJpbmRpbmdUeXBlWyBiaW5kaW5nVHlwZSBdOwoJCXRoaXMuc2V0VmFsdWUgPSB0aGlzLlNldHRlckJ5QmluZGluZ1R5cGVBbmRWZXJzaW9uaW5nWyBiaW5kaW5nVHlwZSBdWyB2ZXJzaW9uaW5nIF07CgoJfQoKCXVuYmluZCgpIHsKCgkJdGhpcy5ub2RlID0gbnVsbDsKCgkJLy8gYmFjayB0byB0aGUgcHJvdG90eXBlIHZlcnNpb24gb2YgZ2V0VmFsdWUgLyBzZXRWYWx1ZQoJCS8vIG5vdGU6IGF2b2lkaW5nIHRvIG11dGF0ZSB0aGUgc2hhcGUgb2YgJ3RoaXMnIHZpYSAnZGVsZXRlJwoJCXRoaXMuZ2V0VmFsdWUgPSB0aGlzLl9nZXRWYWx1ZV91bmJvdW5kOwoJCXRoaXMuc2V0VmFsdWUgPSB0aGlzLl9zZXRWYWx1ZV91bmJvdW5kOwoKCX0KCn0KClByb3BlcnR5QmluZGluZy5Db21wb3NpdGUgPSBDb21wb3NpdGU7CgpQcm9wZXJ0eUJpbmRpbmcucHJvdG90eXBlLkJpbmRpbmdUeXBlID0gewoJRGlyZWN0OiAwLAoJRW50aXJlQXJyYXk6IDEsCglBcnJheUVsZW1lbnQ6IDIsCglIYXNGcm9tVG9BcnJheTogMwp9OwoKUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5WZXJzaW9uaW5nID0gewoJTm9uZTogMCwKCU5lZWRzVXBkYXRlOiAxLAoJTWF0cml4V29ybGROZWVkc1VwZGF0ZTogMgp9OwoKUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5HZXR0ZXJCeUJpbmRpbmdUeXBlID0gWwoKCVByb3BlcnR5QmluZGluZy5wcm90b3R5cGUuX2dldFZhbHVlX2RpcmVjdCwKCVByb3BlcnR5QmluZGluZy5wcm90b3R5cGUuX2dldFZhbHVlX2FycmF5LAoJUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5fZ2V0VmFsdWVfYXJyYXlFbGVtZW50LAoJUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5fZ2V0VmFsdWVfdG9BcnJheSwKCl07CgpQcm9wZXJ0eUJpbmRpbmcucHJvdG90eXBlLlNldHRlckJ5QmluZGluZ1R5cGVBbmRWZXJzaW9uaW5nID0gWwoKCVsKCQkvLyBEaXJlY3QKCQlQcm9wZXJ0eUJpbmRpbmcucHJvdG90eXBlLl9zZXRWYWx1ZV9kaXJlY3QsCgkJUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5fc2V0VmFsdWVfZGlyZWN0X3NldE5lZWRzVXBkYXRlLAoJCVByb3BlcnR5QmluZGluZy5wcm90b3R5cGUuX3NldFZhbHVlX2RpcmVjdF9zZXRNYXRyaXhXb3JsZE5lZWRzVXBkYXRlLAoKCV0sIFsKCgkJLy8gRW50aXJlQXJyYXkKCgkJUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5fc2V0VmFsdWVfYXJyYXksCgkJUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5fc2V0VmFsdWVfYXJyYXlfc2V0TmVlZHNVcGRhdGUsCgkJUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5fc2V0VmFsdWVfYXJyYXlfc2V0TWF0cml4V29ybGROZWVkc1VwZGF0ZSwKCgldLCBbCgoJCS8vIEFycmF5RWxlbWVudAoJCVByb3BlcnR5QmluZGluZy5wcm90b3R5cGUuX3NldFZhbHVlX2FycmF5RWxlbWVudCwKCQlQcm9wZXJ0eUJpbmRpbmcucHJvdG90eXBlLl9zZXRWYWx1ZV9hcnJheUVsZW1lbnRfc2V0TmVlZHNVcGRhdGUsCgkJUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5fc2V0VmFsdWVfYXJyYXlFbGVtZW50X3NldE1hdHJpeFdvcmxkTmVlZHNVcGRhdGUsCgoJXSwgWwoKCQkvLyBIYXNUb0Zyb21BcnJheQoJCVByb3BlcnR5QmluZGluZy5wcm90b3R5cGUuX3NldFZhbHVlX2Zyb21BcnJheSwKCQlQcm9wZXJ0eUJpbmRpbmcucHJvdG90eXBlLl9zZXRWYWx1ZV9mcm9tQXJyYXlfc2V0TmVlZHNVcGRhdGUsCgkJUHJvcGVydHlCaW5kaW5nLnByb3RvdHlwZS5fc2V0VmFsdWVfZnJvbUFycmF5X3NldE1hdHJpeFdvcmxkTmVlZHNVcGRhdGUsCgoJXQoKXTsKCi8qKgogKgogKiBBIGdyb3VwIG9mIG9iamVjdHMgdGhhdCByZWNlaXZlcyBhIHNoYXJlZCBhbmltYXRpb24gc3RhdGUuCiAqCiAqIFVzYWdlOgogKgogKiAgLSBBZGQgb2JqZWN0cyB5b3Ugd291bGQgb3RoZXJ3aXNlIHBhc3MgYXMgJ3Jvb3QnIHRvIHRoZQogKiAgICBjb25zdHJ1Y3RvciBvciB0aGUgLmNsaXBBY3Rpb24gbWV0aG9kIG9mIEFuaW1hdGlvbk1peGVyLgogKgogKiAgLSBJbnN0ZWFkIHBhc3MgdGhpcyBvYmplY3QgYXMgJ3Jvb3QnLgogKgogKiAgLSBZb3UgY2FuIGFsc28gYWRkIGFuZCByZW1vdmUgb2JqZWN0cyBsYXRlciB3aGVuIHRoZSBtaXhlcgogKiAgICBpcyBydW5uaW5nLgogKgogKiBOb3RlOgogKgogKiAgICBPYmplY3RzIG9mIHRoaXMgY2xhc3MgYXBwZWFyIGFzIG9uZSBvYmplY3QgdG8gdGhlIG1peGVyLAogKiAgICBzbyBjYWNoZSBjb250cm9sIG9mIHRoZSBpbmRpdmlkdWFsIG9iamVjdHMgbXVzdCBiZSBkb25lCiAqICAgIG9uIHRoZSBncm91cC4KICoKICogTGltaXRhdGlvbjoKICoKICogIC0gVGhlIGFuaW1hdGVkIHByb3BlcnRpZXMgbXVzdCBiZSBjb21wYXRpYmxlIGFtb25nIHRoZQogKiAgICBhbGwgb2JqZWN0cyBpbiB0aGUgZ3JvdXAuCiAqCiAqICAtIEEgc2luZ2xlIHByb3BlcnR5IGNhbiBlaXRoZXIgYmUgY29udHJvbGxlZCB0aHJvdWdoIGEKICogICAgdGFyZ2V0IGdyb3VwIG9yIGRpcmVjdGx5LCBidXQgbm90IGJvdGguCiAqLwoKY2xhc3MgQW5pbWF0aW9uT2JqZWN0R3JvdXAgewoKCWNvbnN0cnVjdG9yKCkgewoKCQl0aGlzLmlzQW5pbWF0aW9uT2JqZWN0R3JvdXAgPSB0cnVlOwoKCQl0aGlzLnV1aWQgPSBnZW5lcmF0ZVVVSUQoKTsKCgkJLy8gY2FjaGVkIG9iamVjdHMgZm9sbG93ZWQgYnkgdGhlIGFjdGl2ZSBvbmVzCgkJdGhpcy5fb2JqZWN0cyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBhcmd1bWVudHMgKTsKCgkJdGhpcy5uQ2FjaGVkT2JqZWN0c18gPSAwOyAvLyB0aHJlc2hvbGQKCQkvLyBub3RlOiByZWFkIGJ5IFByb3BlcnR5QmluZGluZy5Db21wb3NpdGUKCgkJY29uc3QgaW5kaWNlcyA9IHt9OwoJCXRoaXMuX2luZGljZXNCeVVVSUQgPSBpbmRpY2VzOyAvLyBmb3IgYm9va2tlZXBpbmcKCgkJZm9yICggbGV0IGkgPSAwLCBuID0gYXJndW1lbnRzLmxlbmd0aDsgaSAhPT0gbjsgKysgaSApIHsKCgkJCWluZGljZXNbIGFyZ3VtZW50c1sgaSBdLnV1aWQgXSA9IGk7CgoJCX0KCgkJdGhpcy5fcGF0aHMgPSBbXTsgLy8gaW5zaWRlOiBzdHJpbmcKCQl0aGlzLl9wYXJzZWRQYXRocyA9IFtdOyAvLyBpbnNpZGU6IHsgd2UgZG9uJ3QgY2FyZSwgaGVyZSB9CgkJdGhpcy5fYmluZGluZ3MgPSBbXTsgLy8gaW5zaWRlOiBBcnJheTwgUHJvcGVydHlCaW5kaW5nID4KCQl0aGlzLl9iaW5kaW5nc0luZGljZXNCeVBhdGggPSB7fTsgLy8gaW5zaWRlOiBpbmRpY2VzIGluIHRoZXNlIGFycmF5cwoKCQljb25zdCBzY29wZSA9IHRoaXM7CgoJCXRoaXMuc3RhdHMgPSB7CgoJCQlvYmplY3RzOiB7CgkJCQlnZXQgdG90YWwoKSB7CgoJCQkJCXJldHVybiBzY29wZS5fb2JqZWN0cy5sZW5ndGg7CgoJCQkJfSwKCQkJCWdldCBpblVzZSgpIHsKCgkJCQkJcmV0dXJuIHRoaXMudG90YWwgLSBzY29wZS5uQ2FjaGVkT2JqZWN0c187CgoJCQkJfQoJCQl9LAoJCQlnZXQgYmluZGluZ3NQZXJPYmplY3QoKSB7CgoJCQkJcmV0dXJuIHNjb3BlLl9iaW5kaW5ncy5sZW5ndGg7CgoJCQl9CgoJCX07CgoJfQoKCWFkZCgpIHsKCgkJY29uc3Qgb2JqZWN0cyA9IHRoaXMuX29iamVjdHMsCgkJCWluZGljZXNCeVVVSUQgPSB0aGlzLl9pbmRpY2VzQnlVVUlELAoJCQlwYXRocyA9IHRoaXMuX3BhdGhzLAoJCQlwYXJzZWRQYXRocyA9IHRoaXMuX3BhcnNlZFBhdGhzLAoJCQliaW5kaW5ncyA9IHRoaXMuX2JpbmRpbmdzLAoJCQluQmluZGluZ3MgPSBiaW5kaW5ncy5sZW5ndGg7CgoJCWxldCBrbm93bk9iamVjdCA9IHVuZGVmaW5lZCwKCQkJbk9iamVjdHMgPSBvYmplY3RzLmxlbmd0aCwKCQkJbkNhY2hlZE9iamVjdHMgPSB0aGlzLm5DYWNoZWRPYmplY3RzXzsKCgkJZm9yICggbGV0IGkgPSAwLCBuID0gYXJndW1lbnRzLmxlbmd0aDsgaSAhPT0gbjsgKysgaSApIHsKCgkJCWNvbnN0IG9iamVjdCA9IGFyZ3VtZW50c1sgaSBdLAoJCQkJdXVpZCA9IG9iamVjdC51dWlkOwoJCQlsZXQgaW5kZXggPSBpbmRpY2VzQnlVVUlEWyB1dWlkIF07CgoJCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgoJCQkJLy8gdW5rbm93biBvYmplY3QgLT4gYWRkIGl0IHRvIHRoZSBBQ1RJVkUgcmVnaW9uCgoJCQkJaW5kZXggPSBuT2JqZWN0cyArKzsKCQkJCWluZGljZXNCeVVVSURbIHV1aWQgXSA9IGluZGV4OwoJCQkJb2JqZWN0cy5wdXNoKCBvYmplY3QgKTsKCgkJCQkvLyBhY2NvdW50aW5nIGlzIGRvbmUsIG5vdyBkbyB0aGUgc2FtZSBmb3IgYWxsIGJpbmRpbmdzCgoJCQkJZm9yICggbGV0IGogPSAwLCBtID0gbkJpbmRpbmdzOyBqICE9PSBtOyArKyBqICkgewoKCQkJCQliaW5kaW5nc1sgaiBdLnB1c2goIG5ldyBQcm9wZXJ0eUJpbmRpbmcoIG9iamVjdCwgcGF0aHNbIGogXSwgcGFyc2VkUGF0aHNbIGogXSApICk7CgoJCQkJfQoKCQkJfSBlbHNlIGlmICggaW5kZXggPCBuQ2FjaGVkT2JqZWN0cyApIHsKCgkJCQlrbm93bk9iamVjdCA9IG9iamVjdHNbIGluZGV4IF07CgoJCQkJLy8gbW92ZSBleGlzdGluZyBvYmplY3QgdG8gdGhlIEFDVElWRSByZWdpb24KCgkJCQljb25zdCBmaXJzdEFjdGl2ZUluZGV4ID0gLS0gbkNhY2hlZE9iamVjdHMsCgkJCQkJbGFzdENhY2hlZE9iamVjdCA9IG9iamVjdHNbIGZpcnN0QWN0aXZlSW5kZXggXTsKCgkJCQlpbmRpY2VzQnlVVUlEWyBsYXN0Q2FjaGVkT2JqZWN0LnV1aWQgXSA9IGluZGV4OwoJCQkJb2JqZWN0c1sgaW5kZXggXSA9IGxhc3RDYWNoZWRPYmplY3Q7CgoJCQkJaW5kaWNlc0J5VVVJRFsgdXVpZCBdID0gZmlyc3RBY3RpdmVJbmRleDsKCQkJCW9iamVjdHNbIGZpcnN0QWN0aXZlSW5kZXggXSA9IG9iamVjdDsKCgkJCQkvLyBhY2NvdW50aW5nIGlzIGRvbmUsIG5vdyBkbyB0aGUgc2FtZSBmb3IgYWxsIGJpbmRpbmdzCgoJCQkJZm9yICggbGV0IGogPSAwLCBtID0gbkJpbmRpbmdzOyBqICE9PSBtOyArKyBqICkgewoKCQkJCQljb25zdCBiaW5kaW5nc0ZvclBhdGggPSBiaW5kaW5nc1sgaiBdLAoJCQkJCQlsYXN0Q2FjaGVkID0gYmluZGluZ3NGb3JQYXRoWyBmaXJzdEFjdGl2ZUluZGV4IF07CgoJCQkJCWxldCBiaW5kaW5nID0gYmluZGluZ3NGb3JQYXRoWyBpbmRleCBdOwoKCQkJCQliaW5kaW5nc0ZvclBhdGhbIGluZGV4IF0gPSBsYXN0Q2FjaGVkOwoKCQkJCQlpZiAoIGJpbmRpbmcgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkJCS8vIHNpbmNlIHdlIGRvIG5vdCBib3RoZXIgdG8gY3JlYXRlIG5ldyBiaW5kaW5ncwoJCQkJCQkvLyBmb3Igb2JqZWN0cyB0aGF0IGFyZSBjYWNoZWQsIHRoZSBiaW5kaW5nIG1heQoJCQkJCQkvLyBvciBtYXkgbm90IGV4aXN0CgoJCQkJCQliaW5kaW5nID0gbmV3IFByb3BlcnR5QmluZGluZyggb2JqZWN0LCBwYXRoc1sgaiBdLCBwYXJzZWRQYXRoc1sgaiBdICk7CgoJCQkJCX0KCgkJCQkJYmluZGluZ3NGb3JQYXRoWyBmaXJzdEFjdGl2ZUluZGV4IF0gPSBiaW5kaW5nOwoKCQkJCX0KCgkJCX0gZWxzZSBpZiAoIG9iamVjdHNbIGluZGV4IF0gIT09IGtub3duT2JqZWN0ICkgewoKCQkJCWNvbnNvbGUuZXJyb3IoICdUSFJFRS5BbmltYXRpb25PYmplY3RHcm91cDogRGlmZmVyZW50IG9iamVjdHMgd2l0aCB0aGUgc2FtZSBVVUlEICcgKwoJCQkJCSdkZXRlY3RlZC4gQ2xlYW4gdGhlIGNhY2hlcyBvciByZWNyZWF0ZSB5b3VyIGluZnJhc3RydWN0dXJlIHdoZW4gcmVsb2FkaW5nIHNjZW5lcy4nICk7CgoJCQl9IC8vIGVsc2UgdGhlIG9iamVjdCBpcyBhbHJlYWR5IHdoZXJlIHdlIHdhbnQgaXQgdG8gYmUKCgkJfSAvLyBmb3IgYXJndW1lbnRzCgoJCXRoaXMubkNhY2hlZE9iamVjdHNfID0gbkNhY2hlZE9iamVjdHM7CgoJfQoKCXJlbW92ZSgpIHsKCgkJY29uc3Qgb2JqZWN0cyA9IHRoaXMuX29iamVjdHMsCgkJCWluZGljZXNCeVVVSUQgPSB0aGlzLl9pbmRpY2VzQnlVVUlELAoJCQliaW5kaW5ncyA9IHRoaXMuX2JpbmRpbmdzLAoJCQluQmluZGluZ3MgPSBiaW5kaW5ncy5sZW5ndGg7CgoJCWxldCBuQ2FjaGVkT2JqZWN0cyA9IHRoaXMubkNhY2hlZE9iamVjdHNfOwoKCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSBhcmd1bWVudHMubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJY29uc3Qgb2JqZWN0ID0gYXJndW1lbnRzWyBpIF0sCgkJCQl1dWlkID0gb2JqZWN0LnV1aWQsCgkJCQlpbmRleCA9IGluZGljZXNCeVVVSURbIHV1aWQgXTsKCgkJCWlmICggaW5kZXggIT09IHVuZGVmaW5lZCAmJiBpbmRleCA+PSBuQ2FjaGVkT2JqZWN0cyApIHsKCgkJCQkvLyBtb3ZlIGV4aXN0aW5nIG9iamVjdCBpbnRvIHRoZSBDQUNIRUQgcmVnaW9uCgoJCQkJY29uc3QgbGFzdENhY2hlZEluZGV4ID0gbkNhY2hlZE9iamVjdHMgKyssCgkJCQkJZmlyc3RBY3RpdmVPYmplY3QgPSBvYmplY3RzWyBsYXN0Q2FjaGVkSW5kZXggXTsKCgkJCQlpbmRpY2VzQnlVVUlEWyBmaXJzdEFjdGl2ZU9iamVjdC51dWlkIF0gPSBpbmRleDsKCQkJCW9iamVjdHNbIGluZGV4IF0gPSBmaXJzdEFjdGl2ZU9iamVjdDsKCgkJCQlpbmRpY2VzQnlVVUlEWyB1dWlkIF0gPSBsYXN0Q2FjaGVkSW5kZXg7CgkJCQlvYmplY3RzWyBsYXN0Q2FjaGVkSW5kZXggXSA9IG9iamVjdDsKCgkJCQkvLyBhY2NvdW50aW5nIGlzIGRvbmUsIG5vdyBkbyB0aGUgc2FtZSBmb3IgYWxsIGJpbmRpbmdzCgoJCQkJZm9yICggbGV0IGogPSAwLCBtID0gbkJpbmRpbmdzOyBqICE9PSBtOyArKyBqICkgewoKCQkJCQljb25zdCBiaW5kaW5nc0ZvclBhdGggPSBiaW5kaW5nc1sgaiBdLAoJCQkJCQlmaXJzdEFjdGl2ZSA9IGJpbmRpbmdzRm9yUGF0aFsgbGFzdENhY2hlZEluZGV4IF0sCgkJCQkJCWJpbmRpbmcgPSBiaW5kaW5nc0ZvclBhdGhbIGluZGV4IF07CgoJCQkJCWJpbmRpbmdzRm9yUGF0aFsgaW5kZXggXSA9IGZpcnN0QWN0aXZlOwoJCQkJCWJpbmRpbmdzRm9yUGF0aFsgbGFzdENhY2hlZEluZGV4IF0gPSBiaW5kaW5nOwoKCQkJCX0KCgkJCX0KCgkJfSAvLyBmb3IgYXJndW1lbnRzCgoJCXRoaXMubkNhY2hlZE9iamVjdHNfID0gbkNhY2hlZE9iamVjdHM7CgoJfQoKCS8vIHJlbW92ZSAmIGZvcmdldAoJdW5jYWNoZSgpIHsKCgkJY29uc3Qgb2JqZWN0cyA9IHRoaXMuX29iamVjdHMsCgkJCWluZGljZXNCeVVVSUQgPSB0aGlzLl9pbmRpY2VzQnlVVUlELAoJCQliaW5kaW5ncyA9IHRoaXMuX2JpbmRpbmdzLAoJCQluQmluZGluZ3MgPSBiaW5kaW5ncy5sZW5ndGg7CgoJCWxldCBuQ2FjaGVkT2JqZWN0cyA9IHRoaXMubkNhY2hlZE9iamVjdHNfLAoJCQluT2JqZWN0cyA9IG9iamVjdHMubGVuZ3RoOwoKCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSBhcmd1bWVudHMubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJY29uc3Qgb2JqZWN0ID0gYXJndW1lbnRzWyBpIF0sCgkJCQl1dWlkID0gb2JqZWN0LnV1aWQsCgkJCQlpbmRleCA9IGluZGljZXNCeVVVSURbIHV1aWQgXTsKCgkJCWlmICggaW5kZXggIT09IHVuZGVmaW5lZCApIHsKCgkJCQlkZWxldGUgaW5kaWNlc0J5VVVJRFsgdXVpZCBdOwoKCQkJCWlmICggaW5kZXggPCBuQ2FjaGVkT2JqZWN0cyApIHsKCgkJCQkJLy8gb2JqZWN0IGlzIGNhY2hlZCwgc2hyaW5rIHRoZSBDQUNIRUQgcmVnaW9uCgoJCQkJCWNvbnN0IGZpcnN0QWN0aXZlSW5kZXggPSAtLSBuQ2FjaGVkT2JqZWN0cywKCQkJCQkJbGFzdENhY2hlZE9iamVjdCA9IG9iamVjdHNbIGZpcnN0QWN0aXZlSW5kZXggXSwKCQkJCQkJbGFzdEluZGV4ID0gLS0gbk9iamVjdHMsCgkJCQkJCWxhc3RPYmplY3QgPSBvYmplY3RzWyBsYXN0SW5kZXggXTsKCgkJCQkJLy8gbGFzdCBjYWNoZWQgb2JqZWN0IHRha2VzIHRoaXMgb2JqZWN0J3MgcGxhY2UKCQkJCQlpbmRpY2VzQnlVVUlEWyBsYXN0Q2FjaGVkT2JqZWN0LnV1aWQgXSA9IGluZGV4OwoJCQkJCW9iamVjdHNbIGluZGV4IF0gPSBsYXN0Q2FjaGVkT2JqZWN0OwoKCQkJCQkvLyBsYXN0IG9iamVjdCBnb2VzIHRvIHRoZSBhY3RpdmF0ZWQgc2xvdCBhbmQgcG9wCgkJCQkJaW5kaWNlc0J5VVVJRFsgbGFzdE9iamVjdC51dWlkIF0gPSBmaXJzdEFjdGl2ZUluZGV4OwoJCQkJCW9iamVjdHNbIGZpcnN0QWN0aXZlSW5kZXggXSA9IGxhc3RPYmplY3Q7CgkJCQkJb2JqZWN0cy5wb3AoKTsKCgkJCQkJLy8gYWNjb3VudGluZyBpcyBkb25lLCBub3cgZG8gdGhlIHNhbWUgZm9yIGFsbCBiaW5kaW5ncwoKCQkJCQlmb3IgKCBsZXQgaiA9IDAsIG0gPSBuQmluZGluZ3M7IGogIT09IG07ICsrIGogKSB7CgoJCQkJCQljb25zdCBiaW5kaW5nc0ZvclBhdGggPSBiaW5kaW5nc1sgaiBdLAoJCQkJCQkJbGFzdENhY2hlZCA9IGJpbmRpbmdzRm9yUGF0aFsgZmlyc3RBY3RpdmVJbmRleCBdLAoJCQkJCQkJbGFzdCA9IGJpbmRpbmdzRm9yUGF0aFsgbGFzdEluZGV4IF07CgoJCQkJCQliaW5kaW5nc0ZvclBhdGhbIGluZGV4IF0gPSBsYXN0Q2FjaGVkOwoJCQkJCQliaW5kaW5nc0ZvclBhdGhbIGZpcnN0QWN0aXZlSW5kZXggXSA9IGxhc3Q7CgkJCQkJCWJpbmRpbmdzRm9yUGF0aC5wb3AoKTsKCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vIG9iamVjdCBpcyBhY3RpdmUsIGp1c3Qgc3dhcCB3aXRoIHRoZSBsYXN0IGFuZCBwb3AKCgkJCQkJY29uc3QgbGFzdEluZGV4ID0gLS0gbk9iamVjdHMsCgkJCQkJCWxhc3RPYmplY3QgPSBvYmplY3RzWyBsYXN0SW5kZXggXTsKCgkJCQkJaWYgKCBsYXN0SW5kZXggPiAwICkgewoKCQkJCQkJaW5kaWNlc0J5VVVJRFsgbGFzdE9iamVjdC51dWlkIF0gPSBpbmRleDsKCgkJCQkJfQoKCQkJCQlvYmplY3RzWyBpbmRleCBdID0gbGFzdE9iamVjdDsKCQkJCQlvYmplY3RzLnBvcCgpOwoKCQkJCQkvLyBhY2NvdW50aW5nIGlzIGRvbmUsIG5vdyBkbyB0aGUgc2FtZSBmb3IgYWxsIGJpbmRpbmdzCgoJCQkJCWZvciAoIGxldCBqID0gMCwgbSA9IG5CaW5kaW5nczsgaiAhPT0gbTsgKysgaiApIHsKCgkJCQkJCWNvbnN0IGJpbmRpbmdzRm9yUGF0aCA9IGJpbmRpbmdzWyBqIF07CgoJCQkJCQliaW5kaW5nc0ZvclBhdGhbIGluZGV4IF0gPSBiaW5kaW5nc0ZvclBhdGhbIGxhc3RJbmRleCBdOwoJCQkJCQliaW5kaW5nc0ZvclBhdGgucG9wKCk7CgoJCQkJCX0KCgkJCQl9IC8vIGNhY2hlZCBvciBhY3RpdmUKCgkJCX0gLy8gaWYgb2JqZWN0IGlzIGtub3duCgoJCX0gLy8gZm9yIGFyZ3VtZW50cwoKCQl0aGlzLm5DYWNoZWRPYmplY3RzXyA9IG5DYWNoZWRPYmplY3RzOwoKCX0KCgkvLyBJbnRlcm5hbCBpbnRlcmZhY2UgdXNlZCBieSBiZWZyaWVuZGVkIFByb3BlcnR5QmluZGluZy5Db21wb3NpdGU6CgoJc3Vic2NyaWJlXyggcGF0aCwgcGFyc2VkUGF0aCApIHsKCgkJLy8gcmV0dXJucyBhbiBhcnJheSBvZiBiaW5kaW5ncyBmb3IgdGhlIGdpdmVuIHBhdGggdGhhdCBpcyBjaGFuZ2VkCgkJLy8gYWNjb3JkaW5nIHRvIHRoZSBjb250YWluZWQgb2JqZWN0cyBpbiB0aGUgZ3JvdXAKCgkJY29uc3QgaW5kaWNlc0J5UGF0aCA9IHRoaXMuX2JpbmRpbmdzSW5kaWNlc0J5UGF0aDsKCQlsZXQgaW5kZXggPSBpbmRpY2VzQnlQYXRoWyBwYXRoIF07CgkJY29uc3QgYmluZGluZ3MgPSB0aGlzLl9iaW5kaW5nczsKCgkJaWYgKCBpbmRleCAhPT0gdW5kZWZpbmVkICkgcmV0dXJuIGJpbmRpbmdzWyBpbmRleCBdOwoKCQljb25zdCBwYXRocyA9IHRoaXMuX3BhdGhzLAoJCQlwYXJzZWRQYXRocyA9IHRoaXMuX3BhcnNlZFBhdGhzLAoJCQlvYmplY3RzID0gdGhpcy5fb2JqZWN0cywKCQkJbk9iamVjdHMgPSBvYmplY3RzLmxlbmd0aCwKCQkJbkNhY2hlZE9iamVjdHMgPSB0aGlzLm5DYWNoZWRPYmplY3RzXywKCQkJYmluZGluZ3NGb3JQYXRoID0gbmV3IEFycmF5KCBuT2JqZWN0cyApOwoKCQlpbmRleCA9IGJpbmRpbmdzLmxlbmd0aDsKCgkJaW5kaWNlc0J5UGF0aFsgcGF0aCBdID0gaW5kZXg7CgoJCXBhdGhzLnB1c2goIHBhdGggKTsKCQlwYXJzZWRQYXRocy5wdXNoKCBwYXJzZWRQYXRoICk7CgkJYmluZGluZ3MucHVzaCggYmluZGluZ3NGb3JQYXRoICk7CgoJCWZvciAoIGxldCBpID0gbkNhY2hlZE9iamVjdHMsIG4gPSBvYmplY3RzLmxlbmd0aDsgaSAhPT0gbjsgKysgaSApIHsKCgkJCWNvbnN0IG9iamVjdCA9IG9iamVjdHNbIGkgXTsKCQkJYmluZGluZ3NGb3JQYXRoWyBpIF0gPSBuZXcgUHJvcGVydHlCaW5kaW5nKCBvYmplY3QsIHBhdGgsIHBhcnNlZFBhdGggKTsKCgkJfQoKCQlyZXR1cm4gYmluZGluZ3NGb3JQYXRoOwoKCX0KCgl1bnN1YnNjcmliZV8oIHBhdGggKSB7CgoJCS8vIHRlbGxzIHRoZSBncm91cCB0byBmb3JnZXQgYWJvdXQgYSBwcm9wZXJ0eSBwYXRoIGFuZCBubyBsb25nZXIKCQkvLyB1cGRhdGUgdGhlIGFycmF5IHByZXZpb3VzbHkgb2J0YWluZWQgd2l0aCAnc3Vic2NyaWJlXycKCgkJY29uc3QgaW5kaWNlc0J5UGF0aCA9IHRoaXMuX2JpbmRpbmdzSW5kaWNlc0J5UGF0aCwKCQkJaW5kZXggPSBpbmRpY2VzQnlQYXRoWyBwYXRoIF07CgoJCWlmICggaW5kZXggIT09IHVuZGVmaW5lZCApIHsKCgkJCWNvbnN0IHBhdGhzID0gdGhpcy5fcGF0aHMsCgkJCQlwYXJzZWRQYXRocyA9IHRoaXMuX3BhcnNlZFBhdGhzLAoJCQkJYmluZGluZ3MgPSB0aGlzLl9iaW5kaW5ncywKCQkJCWxhc3RCaW5kaW5nc0luZGV4ID0gYmluZGluZ3MubGVuZ3RoIC0gMSwKCQkJCWxhc3RCaW5kaW5ncyA9IGJpbmRpbmdzWyBsYXN0QmluZGluZ3NJbmRleCBdLAoJCQkJbGFzdEJpbmRpbmdzUGF0aCA9IHBhdGhbIGxhc3RCaW5kaW5nc0luZGV4IF07CgoJCQlpbmRpY2VzQnlQYXRoWyBsYXN0QmluZGluZ3NQYXRoIF0gPSBpbmRleDsKCgkJCWJpbmRpbmdzWyBpbmRleCBdID0gbGFzdEJpbmRpbmdzOwoJCQliaW5kaW5ncy5wb3AoKTsKCgkJCXBhcnNlZFBhdGhzWyBpbmRleCBdID0gcGFyc2VkUGF0aHNbIGxhc3RCaW5kaW5nc0luZGV4IF07CgkJCXBhcnNlZFBhdGhzLnBvcCgpOwoKCQkJcGF0aHNbIGluZGV4IF0gPSBwYXRoc1sgbGFzdEJpbmRpbmdzSW5kZXggXTsKCQkJcGF0aHMucG9wKCk7CgoJCX0KCgl9Cgp9CgpjbGFzcyBBbmltYXRpb25BY3Rpb24gewoKCWNvbnN0cnVjdG9yKCBtaXhlciwgY2xpcCwgbG9jYWxSb290ID0gbnVsbCwgYmxlbmRNb2RlID0gY2xpcC5ibGVuZE1vZGUgKSB7CgoJCXRoaXMuX21peGVyID0gbWl4ZXI7CgkJdGhpcy5fY2xpcCA9IGNsaXA7CgkJdGhpcy5fbG9jYWxSb290ID0gbG9jYWxSb290OwoJCXRoaXMuYmxlbmRNb2RlID0gYmxlbmRNb2RlOwoKCQljb25zdCB0cmFja3MgPSBjbGlwLnRyYWNrcywKCQkJblRyYWNrcyA9IHRyYWNrcy5sZW5ndGgsCgkJCWludGVycG9sYW50cyA9IG5ldyBBcnJheSggblRyYWNrcyApOwoKCQljb25zdCBpbnRlcnBvbGFudFNldHRpbmdzID0gewoJCQllbmRpbmdTdGFydDogWmVyb0N1cnZhdHVyZUVuZGluZywKCQkJZW5kaW5nRW5kOiBaZXJvQ3VydmF0dXJlRW5kaW5nCgkJfTsKCgkJZm9yICggbGV0IGkgPSAwOyBpICE9PSBuVHJhY2tzOyArKyBpICkgewoKCQkJY29uc3QgaW50ZXJwb2xhbnQgPSB0cmFja3NbIGkgXS5jcmVhdGVJbnRlcnBvbGFudCggbnVsbCApOwoJCQlpbnRlcnBvbGFudHNbIGkgXSA9IGludGVycG9sYW50OwoJCQlpbnRlcnBvbGFudC5zZXR0aW5ncyA9IGludGVycG9sYW50U2V0dGluZ3M7CgoJCX0KCgkJdGhpcy5faW50ZXJwb2xhbnRTZXR0aW5ncyA9IGludGVycG9sYW50U2V0dGluZ3M7CgoJCXRoaXMuX2ludGVycG9sYW50cyA9IGludGVycG9sYW50czsgLy8gYm91bmQgYnkgdGhlIG1peGVyCgoJCS8vIGluc2lkZTogUHJvcGVydHlNaXhlciAobWFuYWdlZCBieSB0aGUgbWl4ZXIpCgkJdGhpcy5fcHJvcGVydHlCaW5kaW5ncyA9IG5ldyBBcnJheSggblRyYWNrcyApOwoKCQl0aGlzLl9jYWNoZUluZGV4ID0gbnVsbDsgLy8gZm9yIHRoZSBtZW1vcnkgbWFuYWdlcgoJCXRoaXMuX2J5Q2xpcENhY2hlSW5kZXggPSBudWxsOyAvLyBmb3IgdGhlIG1lbW9yeSBtYW5hZ2VyCgoJCXRoaXMuX3RpbWVTY2FsZUludGVycG9sYW50ID0gbnVsbDsKCQl0aGlzLl93ZWlnaHRJbnRlcnBvbGFudCA9IG51bGw7CgoJCXRoaXMubG9vcCA9IExvb3BSZXBlYXQ7CgkJdGhpcy5fbG9vcENvdW50ID0gLSAxOwoKCQkvLyBnbG9iYWwgbWl4ZXIgdGltZSB3aGVuIHRoZSBhY3Rpb24gaXMgdG8gYmUgc3RhcnRlZAoJCS8vIGl0J3Mgc2V0IGJhY2sgdG8gJ251bGwnIHVwb24gc3RhcnQgb2YgdGhlIGFjdGlvbgoJCXRoaXMuX3N0YXJ0VGltZSA9IG51bGw7CgoJCS8vIHNjYWxlZCBsb2NhbCB0aW1lIG9mIHRoZSBhY3Rpb24KCQkvLyBnZXRzIGNsYW1wZWQgb3Igd3JhcHBlZCB0byAwLi5jbGlwLmR1cmF0aW9uIGFjY29yZGluZyB0byBsb29wCgkJdGhpcy50aW1lID0gMDsKCgkJdGhpcy50aW1lU2NhbGUgPSAxOwoJCXRoaXMuX2VmZmVjdGl2ZVRpbWVTY2FsZSA9IDE7CgoJCXRoaXMud2VpZ2h0ID0gMTsKCQl0aGlzLl9lZmZlY3RpdmVXZWlnaHQgPSAxOwoKCQl0aGlzLnJlcGV0aXRpb25zID0gSW5maW5pdHk7IC8vIG5vLiBvZiByZXBldGl0aW9ucyB3aGVuIGxvb3BpbmcKCgkJdGhpcy5wYXVzZWQgPSBmYWxzZTsgLy8gdHJ1ZSAtPiB6ZXJvIGVmZmVjdGl2ZSB0aW1lIHNjYWxlCgkJdGhpcy5lbmFibGVkID0gdHJ1ZTsgLy8gZmFsc2UgLT4gemVybyBlZmZlY3RpdmUgd2VpZ2h0CgoJCXRoaXMuY2xhbXBXaGVuRmluaXNoZWQgPSBmYWxzZTsvLyBrZWVwIGZlZWRpbmcgdGhlIGxhc3QgZnJhbWU/CgoJCXRoaXMuemVyb1Nsb3BlQXRTdGFydCA9IHRydWU7Ly8gZm9yIHNtb290aCBpbnRlcnBvbGF0aW9uIHcvbyBzZXBhcmF0ZQoJCXRoaXMuemVyb1Nsb3BlQXRFbmQgPSB0cnVlOy8vIGNsaXBzIGZvciBzdGFydCwgbG9vcCBhbmQgZW5kCgoJfQoKCS8vIFN0YXRlICYgU2NoZWR1bGluZwoKCXBsYXkoKSB7CgoJCXRoaXMuX21peGVyLl9hY3RpdmF0ZUFjdGlvbiggdGhpcyApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc3RvcCgpIHsKCgkJdGhpcy5fbWl4ZXIuX2RlYWN0aXZhdGVBY3Rpb24oIHRoaXMgKTsKCgkJcmV0dXJuIHRoaXMucmVzZXQoKTsKCgl9CgoJcmVzZXQoKSB7CgoJCXRoaXMucGF1c2VkID0gZmFsc2U7CgkJdGhpcy5lbmFibGVkID0gdHJ1ZTsKCgkJdGhpcy50aW1lID0gMDsgLy8gcmVzdGFydCBjbGlwCgkJdGhpcy5fbG9vcENvdW50ID0gLSAxOy8vIGZvcmdldCBwcmV2aW91cyBsb29wcwoJCXRoaXMuX3N0YXJ0VGltZSA9IG51bGw7Ly8gZm9yZ2V0IHNjaGVkdWxpbmcKCgkJcmV0dXJuIHRoaXMuc3RvcEZhZGluZygpLnN0b3BXYXJwaW5nKCk7CgoJfQoKCWlzUnVubmluZygpIHsKCgkJcmV0dXJuIHRoaXMuZW5hYmxlZCAmJiAhIHRoaXMucGF1c2VkICYmIHRoaXMudGltZVNjYWxlICE9PSAwICYmCgkJCXRoaXMuX3N0YXJ0VGltZSA9PT0gbnVsbCAmJiB0aGlzLl9taXhlci5faXNBY3RpdmVBY3Rpb24oIHRoaXMgKTsKCgl9CgoJLy8gcmV0dXJuIHRydWUgd2hlbiBwbGF5IGhhcyBiZWVuIGNhbGxlZAoJaXNTY2hlZHVsZWQoKSB7CgoJCXJldHVybiB0aGlzLl9taXhlci5faXNBY3RpdmVBY3Rpb24oIHRoaXMgKTsKCgl9CgoJc3RhcnRBdCggdGltZSApIHsKCgkJdGhpcy5fc3RhcnRUaW1lID0gdGltZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldExvb3AoIG1vZGUsIHJlcGV0aXRpb25zICkgewoKCQl0aGlzLmxvb3AgPSBtb2RlOwoJCXRoaXMucmVwZXRpdGlvbnMgPSByZXBldGl0aW9uczsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCS8vIFdlaWdodAoKCS8vIHNldCB0aGUgd2VpZ2h0IHN0b3BwaW5nIGFueSBzY2hlZHVsZWQgZmFkaW5nCgkvLyBhbHRob3VnaCAuZW5hYmxlZCA9IGZhbHNlIHlpZWxkcyBhbiBlZmZlY3RpdmUgd2VpZ2h0IG9mIHplcm8sIHRoaXMKCS8vIG1ldGhvZCBkb2VzICpub3QqIGNoYW5nZSAuZW5hYmxlZCwgYmVjYXVzZSBpdCB3b3VsZCBiZSBjb25mdXNpbmcKCXNldEVmZmVjdGl2ZVdlaWdodCggd2VpZ2h0ICkgewoKCQl0aGlzLndlaWdodCA9IHdlaWdodDsKCgkJLy8gbm90ZTogc2FtZSBsb2dpYyBhcyB3aGVuIHVwZGF0ZWQgYXQgcnVudGltZQoJCXRoaXMuX2VmZmVjdGl2ZVdlaWdodCA9IHRoaXMuZW5hYmxlZCA/IHdlaWdodCA6IDA7CgoJCXJldHVybiB0aGlzLnN0b3BGYWRpbmcoKTsKCgl9CgoJLy8gcmV0dXJuIHRoZSB3ZWlnaHQgY29uc2lkZXJpbmcgZmFkaW5nIGFuZCAuZW5hYmxlZAoJZ2V0RWZmZWN0aXZlV2VpZ2h0KCkgewoKCQlyZXR1cm4gdGhpcy5fZWZmZWN0aXZlV2VpZ2h0OwoKCX0KCglmYWRlSW4oIGR1cmF0aW9uICkgewoKCQlyZXR1cm4gdGhpcy5fc2NoZWR1bGVGYWRpbmcoIGR1cmF0aW9uLCAwLCAxICk7CgoJfQoKCWZhZGVPdXQoIGR1cmF0aW9uICkgewoKCQlyZXR1cm4gdGhpcy5fc2NoZWR1bGVGYWRpbmcoIGR1cmF0aW9uLCAxLCAwICk7CgoJfQoKCWNyb3NzRmFkZUZyb20oIGZhZGVPdXRBY3Rpb24sIGR1cmF0aW9uLCB3YXJwICkgewoKCQlmYWRlT3V0QWN0aW9uLmZhZGVPdXQoIGR1cmF0aW9uICk7CgkJdGhpcy5mYWRlSW4oIGR1cmF0aW9uICk7CgoJCWlmICggd2FycCApIHsKCgkJCWNvbnN0IGZhZGVJbkR1cmF0aW9uID0gdGhpcy5fY2xpcC5kdXJhdGlvbiwKCQkJCWZhZGVPdXREdXJhdGlvbiA9IGZhZGVPdXRBY3Rpb24uX2NsaXAuZHVyYXRpb24sCgoJCQkJc3RhcnRFbmRSYXRpbyA9IGZhZGVPdXREdXJhdGlvbiAvIGZhZGVJbkR1cmF0aW9uLAoJCQkJZW5kU3RhcnRSYXRpbyA9IGZhZGVJbkR1cmF0aW9uIC8gZmFkZU91dER1cmF0aW9uOwoKCQkJZmFkZU91dEFjdGlvbi53YXJwKCAxLjAsIHN0YXJ0RW5kUmF0aW8sIGR1cmF0aW9uICk7CgkJCXRoaXMud2FycCggZW5kU3RhcnRSYXRpbywgMS4wLCBkdXJhdGlvbiApOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0KCgljcm9zc0ZhZGVUbyggZmFkZUluQWN0aW9uLCBkdXJhdGlvbiwgd2FycCApIHsKCgkJcmV0dXJuIGZhZGVJbkFjdGlvbi5jcm9zc0ZhZGVGcm9tKCB0aGlzLCBkdXJhdGlvbiwgd2FycCApOwoKCX0KCglzdG9wRmFkaW5nKCkgewoKCQljb25zdCB3ZWlnaHRJbnRlcnBvbGFudCA9IHRoaXMuX3dlaWdodEludGVycG9sYW50OwoKCQlpZiAoIHdlaWdodEludGVycG9sYW50ICE9PSBudWxsICkgewoKCQkJdGhpcy5fd2VpZ2h0SW50ZXJwb2xhbnQgPSBudWxsOwoJCQl0aGlzLl9taXhlci5fdGFrZUJhY2tDb250cm9sSW50ZXJwb2xhbnQoIHdlaWdodEludGVycG9sYW50ICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCS8vIFRpbWUgU2NhbGUgQ29udHJvbAoKCS8vIHNldCB0aGUgdGltZSBzY2FsZSBzdG9wcGluZyBhbnkgc2NoZWR1bGVkIHdhcnBpbmcKCS8vIGFsdGhvdWdoIC5wYXVzZWQgPSB0cnVlIHlpZWxkcyBhbiBlZmZlY3RpdmUgdGltZSBzY2FsZSBvZiB6ZXJvLCB0aGlzCgkvLyBtZXRob2QgZG9lcyAqbm90KiBjaGFuZ2UgLnBhdXNlZCwgYmVjYXVzZSBpdCB3b3VsZCBiZSBjb25mdXNpbmcKCXNldEVmZmVjdGl2ZVRpbWVTY2FsZSggdGltZVNjYWxlICkgewoKCQl0aGlzLnRpbWVTY2FsZSA9IHRpbWVTY2FsZTsKCQl0aGlzLl9lZmZlY3RpdmVUaW1lU2NhbGUgPSB0aGlzLnBhdXNlZCA/IDAgOiB0aW1lU2NhbGU7CgoJCXJldHVybiB0aGlzLnN0b3BXYXJwaW5nKCk7CgoJfQoKCS8vIHJldHVybiB0aGUgdGltZSBzY2FsZSBjb25zaWRlcmluZyB3YXJwaW5nIGFuZCAucGF1c2VkCglnZXRFZmZlY3RpdmVUaW1lU2NhbGUoKSB7CgoJCXJldHVybiB0aGlzLl9lZmZlY3RpdmVUaW1lU2NhbGU7CgoJfQoKCXNldER1cmF0aW9uKCBkdXJhdGlvbiApIHsKCgkJdGhpcy50aW1lU2NhbGUgPSB0aGlzLl9jbGlwLmR1cmF0aW9uIC8gZHVyYXRpb247CgoJCXJldHVybiB0aGlzLnN0b3BXYXJwaW5nKCk7CgoJfQoKCXN5bmNXaXRoKCBhY3Rpb24gKSB7CgoJCXRoaXMudGltZSA9IGFjdGlvbi50aW1lOwoJCXRoaXMudGltZVNjYWxlID0gYWN0aW9uLnRpbWVTY2FsZTsKCgkJcmV0dXJuIHRoaXMuc3RvcFdhcnBpbmcoKTsKCgl9CgoJaGFsdCggZHVyYXRpb24gKSB7CgoJCXJldHVybiB0aGlzLndhcnAoIHRoaXMuX2VmZmVjdGl2ZVRpbWVTY2FsZSwgMCwgZHVyYXRpb24gKTsKCgl9CgoJd2FycCggc3RhcnRUaW1lU2NhbGUsIGVuZFRpbWVTY2FsZSwgZHVyYXRpb24gKSB7CgoJCWNvbnN0IG1peGVyID0gdGhpcy5fbWl4ZXIsCgkJCW5vdyA9IG1peGVyLnRpbWUsCgkJCXRpbWVTY2FsZSA9IHRoaXMudGltZVNjYWxlOwoKCQlsZXQgaW50ZXJwb2xhbnQgPSB0aGlzLl90aW1lU2NhbGVJbnRlcnBvbGFudDsKCgkJaWYgKCBpbnRlcnBvbGFudCA9PT0gbnVsbCApIHsKCgkJCWludGVycG9sYW50ID0gbWl4ZXIuX2xlbmRDb250cm9sSW50ZXJwb2xhbnQoKTsKCQkJdGhpcy5fdGltZVNjYWxlSW50ZXJwb2xhbnQgPSBpbnRlcnBvbGFudDsKCgkJfQoKCQljb25zdCB0aW1lcyA9IGludGVycG9sYW50LnBhcmFtZXRlclBvc2l0aW9ucywKCQkJdmFsdWVzID0gaW50ZXJwb2xhbnQuc2FtcGxlVmFsdWVzOwoKCQl0aW1lc1sgMCBdID0gbm93OwoJCXRpbWVzWyAxIF0gPSBub3cgKyBkdXJhdGlvbjsKCgkJdmFsdWVzWyAwIF0gPSBzdGFydFRpbWVTY2FsZSAvIHRpbWVTY2FsZTsKCQl2YWx1ZXNbIDEgXSA9IGVuZFRpbWVTY2FsZSAvIHRpbWVTY2FsZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXN0b3BXYXJwaW5nKCkgewoKCQljb25zdCB0aW1lU2NhbGVJbnRlcnBvbGFudCA9IHRoaXMuX3RpbWVTY2FsZUludGVycG9sYW50OwoKCQlpZiAoIHRpbWVTY2FsZUludGVycG9sYW50ICE9PSBudWxsICkgewoKCQkJdGhpcy5fdGltZVNjYWxlSW50ZXJwb2xhbnQgPSBudWxsOwoJCQl0aGlzLl9taXhlci5fdGFrZUJhY2tDb250cm9sSW50ZXJwb2xhbnQoIHRpbWVTY2FsZUludGVycG9sYW50ICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCS8vIE9iamVjdCBBY2Nlc3NvcnMKCglnZXRNaXhlcigpIHsKCgkJcmV0dXJuIHRoaXMuX21peGVyOwoKCX0KCglnZXRDbGlwKCkgewoKCQlyZXR1cm4gdGhpcy5fY2xpcDsKCgl9CgoJZ2V0Um9vdCgpIHsKCgkJcmV0dXJuIHRoaXMuX2xvY2FsUm9vdCB8fCB0aGlzLl9taXhlci5fcm9vdDsKCgl9CgoJLy8gSW50ZXJuYQoKCV91cGRhdGUoIHRpbWUsIGRlbHRhVGltZSwgdGltZURpcmVjdGlvbiwgYWNjdUluZGV4ICkgewoKCQkvLyBjYWxsZWQgYnkgdGhlIG1peGVyCgoJCWlmICggISB0aGlzLmVuYWJsZWQgKSB7CgoJCQkvLyBjYWxsIC5fdXBkYXRlV2VpZ2h0KCkgdG8gdXBkYXRlIC5fZWZmZWN0aXZlV2VpZ2h0CgoJCQl0aGlzLl91cGRhdGVXZWlnaHQoIHRpbWUgKTsKCQkJcmV0dXJuOwoKCQl9CgoJCWNvbnN0IHN0YXJ0VGltZSA9IHRoaXMuX3N0YXJ0VGltZTsKCgkJaWYgKCBzdGFydFRpbWUgIT09IG51bGwgKSB7CgoJCQkvLyBjaGVjayBmb3Igc2NoZWR1bGVkIHN0YXJ0IG9mIGFjdGlvbgoKCQkJY29uc3QgdGltZVJ1bm5pbmcgPSAoIHRpbWUgLSBzdGFydFRpbWUgKSAqIHRpbWVEaXJlY3Rpb247CgkJCWlmICggdGltZVJ1bm5pbmcgPCAwIHx8IHRpbWVEaXJlY3Rpb24gPT09IDAgKSB7CgoJCQkJZGVsdGFUaW1lID0gMDsKCgkJCX0gZWxzZSB7CgoKCQkJCXRoaXMuX3N0YXJ0VGltZSA9IG51bGw7IC8vIHVuc2NoZWR1bGUKCQkJCWRlbHRhVGltZSA9IHRpbWVEaXJlY3Rpb24gKiB0aW1lUnVubmluZzsKCgkJCX0KCgkJfQoKCQkvLyBhcHBseSB0aW1lIHNjYWxlIGFuZCBhZHZhbmNlIHRpbWUKCgkJZGVsdGFUaW1lICo9IHRoaXMuX3VwZGF0ZVRpbWVTY2FsZSggdGltZSApOwoJCWNvbnN0IGNsaXBUaW1lID0gdGhpcy5fdXBkYXRlVGltZSggZGVsdGFUaW1lICk7CgoJCS8vIG5vdGU6IF91cGRhdGVUaW1lIG1heSBkaXNhYmxlIHRoZSBhY3Rpb24gcmVzdWx0aW5nIGluCgkJLy8gYW4gZWZmZWN0aXZlIHdlaWdodCBvZiAwCgoJCWNvbnN0IHdlaWdodCA9IHRoaXMuX3VwZGF0ZVdlaWdodCggdGltZSApOwoKCQlpZiAoIHdlaWdodCA+IDAgKSB7CgoJCQljb25zdCBpbnRlcnBvbGFudHMgPSB0aGlzLl9pbnRlcnBvbGFudHM7CgkJCWNvbnN0IHByb3BlcnR5TWl4ZXJzID0gdGhpcy5fcHJvcGVydHlCaW5kaW5nczsKCgkJCXN3aXRjaCAoIHRoaXMuYmxlbmRNb2RlICkgewoKCQkJCWNhc2UgQWRkaXRpdmVBbmltYXRpb25CbGVuZE1vZGU6CgoJCQkJCWZvciAoIGxldCBqID0gMCwgbSA9IGludGVycG9sYW50cy5sZW5ndGg7IGogIT09IG07ICsrIGogKSB7CgoJCQkJCQlpbnRlcnBvbGFudHNbIGogXS5ldmFsdWF0ZSggY2xpcFRpbWUgKTsKCQkJCQkJcHJvcGVydHlNaXhlcnNbIGogXS5hY2N1bXVsYXRlQWRkaXRpdmUoIHdlaWdodCApOwoKCQkJCQl9CgoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgTm9ybWFsQW5pbWF0aW9uQmxlbmRNb2RlOgoJCQkJZGVmYXVsdDoKCgkJCQkJZm9yICggbGV0IGogPSAwLCBtID0gaW50ZXJwb2xhbnRzLmxlbmd0aDsgaiAhPT0gbTsgKysgaiApIHsKCgkJCQkJCWludGVycG9sYW50c1sgaiBdLmV2YWx1YXRlKCBjbGlwVGltZSApOwoJCQkJCQlwcm9wZXJ0eU1peGVyc1sgaiBdLmFjY3VtdWxhdGUoIGFjY3VJbmRleCwgd2VpZ2h0ICk7CgoJCQkJCX0KCgkJCX0KCgkJfQoKCX0KCglfdXBkYXRlV2VpZ2h0KCB0aW1lICkgewoKCQlsZXQgd2VpZ2h0ID0gMDsKCgkJaWYgKCB0aGlzLmVuYWJsZWQgKSB7CgoJCQl3ZWlnaHQgPSB0aGlzLndlaWdodDsKCQkJY29uc3QgaW50ZXJwb2xhbnQgPSB0aGlzLl93ZWlnaHRJbnRlcnBvbGFudDsKCgkJCWlmICggaW50ZXJwb2xhbnQgIT09IG51bGwgKSB7CgoJCQkJY29uc3QgaW50ZXJwb2xhbnRWYWx1ZSA9IGludGVycG9sYW50LmV2YWx1YXRlKCB0aW1lIClbIDAgXTsKCgkJCQl3ZWlnaHQgKj0gaW50ZXJwb2xhbnRWYWx1ZTsKCgkJCQlpZiAoIHRpbWUgPiBpbnRlcnBvbGFudC5wYXJhbWV0ZXJQb3NpdGlvbnNbIDEgXSApIHsKCgkJCQkJdGhpcy5zdG9wRmFkaW5nKCk7CgoJCQkJCWlmICggaW50ZXJwb2xhbnRWYWx1ZSA9PT0gMCApIHsKCgkJCQkJCS8vIGZhZGVkIG91dCwgZGlzYWJsZQoJCQkJCQl0aGlzLmVuYWJsZWQgPSBmYWxzZTsKCgkJCQkJfQoKCQkJCX0KCgkJCX0KCgkJfQoKCQl0aGlzLl9lZmZlY3RpdmVXZWlnaHQgPSB3ZWlnaHQ7CgkJcmV0dXJuIHdlaWdodDsKCgl9CgoJX3VwZGF0ZVRpbWVTY2FsZSggdGltZSApIHsKCgkJbGV0IHRpbWVTY2FsZSA9IDA7CgoJCWlmICggISB0aGlzLnBhdXNlZCApIHsKCgkJCXRpbWVTY2FsZSA9IHRoaXMudGltZVNjYWxlOwoKCQkJY29uc3QgaW50ZXJwb2xhbnQgPSB0aGlzLl90aW1lU2NhbGVJbnRlcnBvbGFudDsKCgkJCWlmICggaW50ZXJwb2xhbnQgIT09IG51bGwgKSB7CgoJCQkJY29uc3QgaW50ZXJwb2xhbnRWYWx1ZSA9IGludGVycG9sYW50LmV2YWx1YXRlKCB0aW1lIClbIDAgXTsKCgkJCQl0aW1lU2NhbGUgKj0gaW50ZXJwb2xhbnRWYWx1ZTsKCgkJCQlpZiAoIHRpbWUgPiBpbnRlcnBvbGFudC5wYXJhbWV0ZXJQb3NpdGlvbnNbIDEgXSApIHsKCgkJCQkJdGhpcy5zdG9wV2FycGluZygpOwoKCQkJCQlpZiAoIHRpbWVTY2FsZSA9PT0gMCApIHsKCgkJCQkJCS8vIG1vdGlvbiBoYXMgaGFsdGVkLCBwYXVzZQoJCQkJCQl0aGlzLnBhdXNlZCA9IHRydWU7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyB3YXJwIGRvbmUgLSBhcHBseSBmaW5hbCB0aW1lIHNjYWxlCgkJCQkJCXRoaXMudGltZVNjYWxlID0gdGltZVNjYWxlOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQl9CgoJCXRoaXMuX2VmZmVjdGl2ZVRpbWVTY2FsZSA9IHRpbWVTY2FsZTsKCQlyZXR1cm4gdGltZVNjYWxlOwoKCX0KCglfdXBkYXRlVGltZSggZGVsdGFUaW1lICkgewoKCQljb25zdCBkdXJhdGlvbiA9IHRoaXMuX2NsaXAuZHVyYXRpb247CgkJY29uc3QgbG9vcCA9IHRoaXMubG9vcDsKCgkJbGV0IHRpbWUgPSB0aGlzLnRpbWUgKyBkZWx0YVRpbWU7CgkJbGV0IGxvb3BDb3VudCA9IHRoaXMuX2xvb3BDb3VudDsKCgkJY29uc3QgcGluZ1BvbmcgPSAoIGxvb3AgPT09IExvb3BQaW5nUG9uZyApOwoKCQlpZiAoIGRlbHRhVGltZSA9PT0gMCApIHsKCgkJCWlmICggbG9vcENvdW50ID09PSAtIDEgKSByZXR1cm4gdGltZTsKCgkJCXJldHVybiAoIHBpbmdQb25nICYmICggbG9vcENvdW50ICYgMSApID09PSAxICkgPyBkdXJhdGlvbiAtIHRpbWUgOiB0aW1lOwoKCQl9CgoJCWlmICggbG9vcCA9PT0gTG9vcE9uY2UgKSB7CgoJCQlpZiAoIGxvb3BDb3VudCA9PT0gLSAxICkgewoKCQkJCS8vIGp1c3Qgc3RhcnRlZAoKCQkJCXRoaXMuX2xvb3BDb3VudCA9IDA7CgkJCQl0aGlzLl9zZXRFbmRpbmdzKCB0cnVlLCB0cnVlLCBmYWxzZSApOwoKCQkJfQoKCQkJaGFuZGxlX3N0b3A6IHsKCgkJCQlpZiAoIHRpbWUgPj0gZHVyYXRpb24gKSB7CgoJCQkJCXRpbWUgPSBkdXJhdGlvbjsKCgkJCQl9IGVsc2UgaWYgKCB0aW1lIDwgMCApIHsKCgkJCQkJdGltZSA9IDA7CgoJCQkJfSBlbHNlIHsKCgkJCQkJdGhpcy50aW1lID0gdGltZTsKCgkJCQkJYnJlYWsgaGFuZGxlX3N0b3A7CgoJCQkJfQoKCQkJCWlmICggdGhpcy5jbGFtcFdoZW5GaW5pc2hlZCApIHRoaXMucGF1c2VkID0gdHJ1ZTsKCQkJCWVsc2UgdGhpcy5lbmFibGVkID0gZmFsc2U7CgoJCQkJdGhpcy50aW1lID0gdGltZTsKCgkJCQl0aGlzLl9taXhlci5kaXNwYXRjaEV2ZW50KCB7CgkJCQkJdHlwZTogJ2ZpbmlzaGVkJywgYWN0aW9uOiB0aGlzLAoJCQkJCWRpcmVjdGlvbjogZGVsdGFUaW1lIDwgMCA/IC0gMSA6IDEKCQkJCX0gKTsKCgkJCX0KCgkJfSBlbHNlIHsgLy8gcmVwZXRpdGl2ZSBSZXBlYXQgb3IgUGluZ1BvbmcKCgkJCWlmICggbG9vcENvdW50ID09PSAtIDEgKSB7CgoJCQkJLy8ganVzdCBzdGFydGVkCgoJCQkJaWYgKCBkZWx0YVRpbWUgPj0gMCApIHsKCgkJCQkJbG9vcENvdW50ID0gMDsKCgkJCQkJdGhpcy5fc2V0RW5kaW5ncyggdHJ1ZSwgdGhpcy5yZXBldGl0aW9ucyA9PT0gMCwgcGluZ1BvbmcgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQkvLyB3aGVuIGxvb3BpbmcgaW4gcmV2ZXJzZSBkaXJlY3Rpb24sIHRoZSBpbml0aWFsCgkJCQkJLy8gdHJhbnNpdGlvbiB0aHJvdWdoIHplcm8gY291bnRzIGFzIGEgcmVwZXRpdGlvbiwKCQkJCQkvLyBzbyBsZWF2ZSBsb29wQ291bnQgYXQgLTEKCgkJCQkJdGhpcy5fc2V0RW5kaW5ncyggdGhpcy5yZXBldGl0aW9ucyA9PT0gMCwgdHJ1ZSwgcGluZ1BvbmcgKTsKCgkJCQl9CgoJCQl9CgoJCQlpZiAoIHRpbWUgPj0gZHVyYXRpb24gfHwgdGltZSA8IDAgKSB7CgoJCQkJLy8gd3JhcCBhcm91bmQKCgkJCQljb25zdCBsb29wRGVsdGEgPSBNYXRoLmZsb29yKCB0aW1lIC8gZHVyYXRpb24gKTsgLy8gc2lnbmVkCgkJCQl0aW1lIC09IGR1cmF0aW9uICogbG9vcERlbHRhOwoKCQkJCWxvb3BDb3VudCArPSBNYXRoLmFicyggbG9vcERlbHRhICk7CgoJCQkJY29uc3QgcGVuZGluZyA9IHRoaXMucmVwZXRpdGlvbnMgLSBsb29wQ291bnQ7CgoJCQkJaWYgKCBwZW5kaW5nIDw9IDAgKSB7CgoJCQkJCS8vIGhhdmUgdG8gc3RvcCAoc3dpdGNoIHN0YXRlLCBjbGFtcCB0aW1lLCBmaXJlIGV2ZW50KQoKCQkJCQlpZiAoIHRoaXMuY2xhbXBXaGVuRmluaXNoZWQgKSB0aGlzLnBhdXNlZCA9IHRydWU7CgkJCQkJZWxzZSB0aGlzLmVuYWJsZWQgPSBmYWxzZTsKCgkJCQkJdGltZSA9IGRlbHRhVGltZSA+IDAgPyBkdXJhdGlvbiA6IDA7CgoJCQkJCXRoaXMudGltZSA9IHRpbWU7CgoJCQkJCXRoaXMuX21peGVyLmRpc3BhdGNoRXZlbnQoIHsKCQkJCQkJdHlwZTogJ2ZpbmlzaGVkJywgYWN0aW9uOiB0aGlzLAoJCQkJCQlkaXJlY3Rpb246IGRlbHRhVGltZSA+IDAgPyAxIDogLSAxCgkJCQkJfSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vIGtlZXAgcnVubmluZwoKCQkJCQlpZiAoIHBlbmRpbmcgPT09IDEgKSB7CgoJCQkJCQkvLyBlbnRlcmluZyB0aGUgbGFzdCByb3VuZAoKCQkJCQkJY29uc3QgYXRTdGFydCA9IGRlbHRhVGltZSA8IDA7CgkJCQkJCXRoaXMuX3NldEVuZGluZ3MoIGF0U3RhcnQsICEgYXRTdGFydCwgcGluZ1BvbmcgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXRoaXMuX3NldEVuZGluZ3MoIGZhbHNlLCBmYWxzZSwgcGluZ1BvbmcgKTsKCgkJCQkJfQoKCQkJCQl0aGlzLl9sb29wQ291bnQgPSBsb29wQ291bnQ7CgoJCQkJCXRoaXMudGltZSA9IHRpbWU7CgoJCQkJCXRoaXMuX21peGVyLmRpc3BhdGNoRXZlbnQoIHsKCQkJCQkJdHlwZTogJ2xvb3AnLCBhY3Rpb246IHRoaXMsIGxvb3BEZWx0YTogbG9vcERlbHRhCgkJCQkJfSApOwoKCQkJCX0KCgkJCX0gZWxzZSB7CgoJCQkJdGhpcy50aW1lID0gdGltZTsKCgkJCX0KCgkJCWlmICggcGluZ1BvbmcgJiYgKCBsb29wQ291bnQgJiAxICkgPT09IDEgKSB7CgoJCQkJLy8gaW52ZXJ0IHRpbWUgZm9yIHRoZSAicG9uZyByb3VuZCIKCgkJCQlyZXR1cm4gZHVyYXRpb24gLSB0aW1lOwoKCQkJfQoKCQl9CgoJCXJldHVybiB0aW1lOwoKCX0KCglfc2V0RW5kaW5ncyggYXRTdGFydCwgYXRFbmQsIHBpbmdQb25nICkgewoKCQljb25zdCBzZXR0aW5ncyA9IHRoaXMuX2ludGVycG9sYW50U2V0dGluZ3M7CgoJCWlmICggcGluZ1BvbmcgKSB7CgoJCQlzZXR0aW5ncy5lbmRpbmdTdGFydCA9IFplcm9TbG9wZUVuZGluZzsKCQkJc2V0dGluZ3MuZW5kaW5nRW5kID0gWmVyb1Nsb3BlRW5kaW5nOwoKCQl9IGVsc2UgewoKCQkJLy8gYXNzdW1pbmcgZm9yIExvb3BPbmNlIGF0U3RhcnQgPT0gYXRFbmQgPT0gdHJ1ZQoKCQkJaWYgKCBhdFN0YXJ0ICkgewoKCQkJCXNldHRpbmdzLmVuZGluZ1N0YXJ0ID0gdGhpcy56ZXJvU2xvcGVBdFN0YXJ0ID8gWmVyb1Nsb3BlRW5kaW5nIDogWmVyb0N1cnZhdHVyZUVuZGluZzsKCgkJCX0gZWxzZSB7CgoJCQkJc2V0dGluZ3MuZW5kaW5nU3RhcnQgPSBXcmFwQXJvdW5kRW5kaW5nOwoKCQkJfQoKCQkJaWYgKCBhdEVuZCApIHsKCgkJCQlzZXR0aW5ncy5lbmRpbmdFbmQgPSB0aGlzLnplcm9TbG9wZUF0RW5kID8gWmVyb1Nsb3BlRW5kaW5nIDogWmVyb0N1cnZhdHVyZUVuZGluZzsKCgkJCX0gZWxzZSB7CgoJCQkJc2V0dGluZ3MuZW5kaW5nRW5kIAkgPSBXcmFwQXJvdW5kRW5kaW5nOwoKCQkJfQoKCQl9CgoJfQoKCV9zY2hlZHVsZUZhZGluZyggZHVyYXRpb24sIHdlaWdodE5vdywgd2VpZ2h0VGhlbiApIHsKCgkJY29uc3QgbWl4ZXIgPSB0aGlzLl9taXhlciwgbm93ID0gbWl4ZXIudGltZTsKCQlsZXQgaW50ZXJwb2xhbnQgPSB0aGlzLl93ZWlnaHRJbnRlcnBvbGFudDsKCgkJaWYgKCBpbnRlcnBvbGFudCA9PT0gbnVsbCApIHsKCgkJCWludGVycG9sYW50ID0gbWl4ZXIuX2xlbmRDb250cm9sSW50ZXJwb2xhbnQoKTsKCQkJdGhpcy5fd2VpZ2h0SW50ZXJwb2xhbnQgPSBpbnRlcnBvbGFudDsKCgkJfQoKCQljb25zdCB0aW1lcyA9IGludGVycG9sYW50LnBhcmFtZXRlclBvc2l0aW9ucywKCQkJdmFsdWVzID0gaW50ZXJwb2xhbnQuc2FtcGxlVmFsdWVzOwoKCQl0aW1lc1sgMCBdID0gbm93OwoJCXZhbHVlc1sgMCBdID0gd2VpZ2h0Tm93OwoJCXRpbWVzWyAxIF0gPSBub3cgKyBkdXJhdGlvbjsKCQl2YWx1ZXNbIDEgXSA9IHdlaWdodFRoZW47CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNvbnN0IF9jb250cm9sSW50ZXJwb2xhbnRzUmVzdWx0QnVmZmVyID0gbmV3IEZsb2F0MzJBcnJheSggMSApOwoKCmNsYXNzIEFuaW1hdGlvbk1peGVyIGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyIHsKCgljb25zdHJ1Y3Rvciggcm9vdCApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5fcm9vdCA9IHJvb3Q7CgkJdGhpcy5faW5pdE1lbW9yeU1hbmFnZXIoKTsKCQl0aGlzLl9hY2N1SW5kZXggPSAwOwoJCXRoaXMudGltZSA9IDA7CgkJdGhpcy50aW1lU2NhbGUgPSAxLjA7CgoJfQoKCV9iaW5kQWN0aW9uKCBhY3Rpb24sIHByb3RvdHlwZUFjdGlvbiApIHsKCgkJY29uc3Qgcm9vdCA9IGFjdGlvbi5fbG9jYWxSb290IHx8IHRoaXMuX3Jvb3QsCgkJCXRyYWNrcyA9IGFjdGlvbi5fY2xpcC50cmFja3MsCgkJCW5UcmFja3MgPSB0cmFja3MubGVuZ3RoLAoJCQliaW5kaW5ncyA9IGFjdGlvbi5fcHJvcGVydHlCaW5kaW5ncywKCQkJaW50ZXJwb2xhbnRzID0gYWN0aW9uLl9pbnRlcnBvbGFudHMsCgkJCXJvb3RVdWlkID0gcm9vdC51dWlkLAoJCQliaW5kaW5nc0J5Um9vdCA9IHRoaXMuX2JpbmRpbmdzQnlSb290QW5kTmFtZTsKCgkJbGV0IGJpbmRpbmdzQnlOYW1lID0gYmluZGluZ3NCeVJvb3RbIHJvb3RVdWlkIF07CgoJCWlmICggYmluZGluZ3NCeU5hbWUgPT09IHVuZGVmaW5lZCApIHsKCgkJCWJpbmRpbmdzQnlOYW1lID0ge307CgkJCWJpbmRpbmdzQnlSb290WyByb290VXVpZCBdID0gYmluZGluZ3NCeU5hbWU7CgoJCX0KCgkJZm9yICggbGV0IGkgPSAwOyBpICE9PSBuVHJhY2tzOyArKyBpICkgewoKCQkJY29uc3QgdHJhY2sgPSB0cmFja3NbIGkgXSwKCQkJCXRyYWNrTmFtZSA9IHRyYWNrLm5hbWU7CgoJCQlsZXQgYmluZGluZyA9IGJpbmRpbmdzQnlOYW1lWyB0cmFja05hbWUgXTsKCgkJCWlmICggYmluZGluZyAhPT0gdW5kZWZpbmVkICkgewoKCQkJCSsrIGJpbmRpbmcucmVmZXJlbmNlQ291bnQ7CgkJCQliaW5kaW5nc1sgaSBdID0gYmluZGluZzsKCgkJCX0gZWxzZSB7CgoJCQkJYmluZGluZyA9IGJpbmRpbmdzWyBpIF07CgoJCQkJaWYgKCBiaW5kaW5nICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJCS8vIGV4aXN0aW5nIGJpbmRpbmcsIG1ha2Ugc3VyZSB0aGUgY2FjaGUga25vd3MKCgkJCQkJaWYgKCBiaW5kaW5nLl9jYWNoZUluZGV4ID09PSBudWxsICkgewoKCQkJCQkJKysgYmluZGluZy5yZWZlcmVuY2VDb3VudDsKCQkJCQkJdGhpcy5fYWRkSW5hY3RpdmVCaW5kaW5nKCBiaW5kaW5nLCByb290VXVpZCwgdHJhY2tOYW1lICk7CgoJCQkJCX0KCgkJCQkJY29udGludWU7CgoJCQkJfQoKCQkJCWNvbnN0IHBhdGggPSBwcm90b3R5cGVBY3Rpb24gJiYgcHJvdG90eXBlQWN0aW9uLgoJCQkJCV9wcm9wZXJ0eUJpbmRpbmdzWyBpIF0uYmluZGluZy5wYXJzZWRQYXRoOwoKCQkJCWJpbmRpbmcgPSBuZXcgUHJvcGVydHlNaXhlcigKCQkJCQlQcm9wZXJ0eUJpbmRpbmcuY3JlYXRlKCByb290LCB0cmFja05hbWUsIHBhdGggKSwKCQkJCQl0cmFjay5WYWx1ZVR5cGVOYW1lLCB0cmFjay5nZXRWYWx1ZVNpemUoKSApOwoKCQkJCSsrIGJpbmRpbmcucmVmZXJlbmNlQ291bnQ7CgkJCQl0aGlzLl9hZGRJbmFjdGl2ZUJpbmRpbmcoIGJpbmRpbmcsIHJvb3RVdWlkLCB0cmFja05hbWUgKTsKCgkJCQliaW5kaW5nc1sgaSBdID0gYmluZGluZzsKCgkJCX0KCgkJCWludGVycG9sYW50c1sgaSBdLnJlc3VsdEJ1ZmZlciA9IGJpbmRpbmcuYnVmZmVyOwoKCQl9CgoJfQoKCV9hY3RpdmF0ZUFjdGlvbiggYWN0aW9uICkgewoKCQlpZiAoICEgdGhpcy5faXNBY3RpdmVBY3Rpb24oIGFjdGlvbiApICkgewoKCQkJaWYgKCBhY3Rpb24uX2NhY2hlSW5kZXggPT09IG51bGwgKSB7CgoJCQkJLy8gdGhpcyBhY3Rpb24gaGFzIGJlZW4gZm9yZ290dGVuIGJ5IHRoZSBjYWNoZSwgYnV0IHRoZSB1c2VyCgkJCQkvLyBhcHBlYXJzIHRvIGJlIHN0aWxsIHVzaW5nIGl0IC0+IHJlYmluZAoKCQkJCWNvbnN0IHJvb3RVdWlkID0gKCBhY3Rpb24uX2xvY2FsUm9vdCB8fCB0aGlzLl9yb290ICkudXVpZCwKCQkJCQljbGlwVXVpZCA9IGFjdGlvbi5fY2xpcC51dWlkLAoJCQkJCWFjdGlvbnNGb3JDbGlwID0gdGhpcy5fYWN0aW9uc0J5Q2xpcFsgY2xpcFV1aWQgXTsKCgkJCQl0aGlzLl9iaW5kQWN0aW9uKCBhY3Rpb24sCgkJCQkJYWN0aW9uc0ZvckNsaXAgJiYgYWN0aW9uc0ZvckNsaXAua25vd25BY3Rpb25zWyAwIF0gKTsKCgkJCQl0aGlzLl9hZGRJbmFjdGl2ZUFjdGlvbiggYWN0aW9uLCBjbGlwVXVpZCwgcm9vdFV1aWQgKTsKCgkJCX0KCgkJCWNvbnN0IGJpbmRpbmdzID0gYWN0aW9uLl9wcm9wZXJ0eUJpbmRpbmdzOwoKCQkJLy8gaW5jcmVtZW50IHJlZmVyZW5jZSBjb3VudHMgLyBzb3J0IG91dCBzdGF0ZQoJCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSBiaW5kaW5ncy5sZW5ndGg7IGkgIT09IG47ICsrIGkgKSB7CgoJCQkJY29uc3QgYmluZGluZyA9IGJpbmRpbmdzWyBpIF07CgoJCQkJaWYgKCBiaW5kaW5nLnVzZUNvdW50ICsrID09PSAwICkgewoKCQkJCQl0aGlzLl9sZW5kQmluZGluZyggYmluZGluZyApOwoJCQkJCWJpbmRpbmcuc2F2ZU9yaWdpbmFsU3RhdGUoKTsKCgkJCQl9CgoJCQl9CgoJCQl0aGlzLl9sZW5kQWN0aW9uKCBhY3Rpb24gKTsKCgkJfQoKCX0KCglfZGVhY3RpdmF0ZUFjdGlvbiggYWN0aW9uICkgewoKCQlpZiAoIHRoaXMuX2lzQWN0aXZlQWN0aW9uKCBhY3Rpb24gKSApIHsKCgkJCWNvbnN0IGJpbmRpbmdzID0gYWN0aW9uLl9wcm9wZXJ0eUJpbmRpbmdzOwoKCQkJLy8gZGVjcmVtZW50IHJlZmVyZW5jZSBjb3VudHMgLyBzb3J0IG91dCBzdGF0ZQoJCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSBiaW5kaW5ncy5sZW5ndGg7IGkgIT09IG47ICsrIGkgKSB7CgoJCQkJY29uc3QgYmluZGluZyA9IGJpbmRpbmdzWyBpIF07CgoJCQkJaWYgKCAtLSBiaW5kaW5nLnVzZUNvdW50ID09PSAwICkgewoKCQkJCQliaW5kaW5nLnJlc3RvcmVPcmlnaW5hbFN0YXRlKCk7CgkJCQkJdGhpcy5fdGFrZUJhY2tCaW5kaW5nKCBiaW5kaW5nICk7CgoJCQkJfQoKCQkJfQoKCQkJdGhpcy5fdGFrZUJhY2tBY3Rpb24oIGFjdGlvbiApOwoKCQl9CgoJfQoKCS8vIE1lbW9yeSBtYW5hZ2VyCgoJX2luaXRNZW1vcnlNYW5hZ2VyKCkgewoKCQl0aGlzLl9hY3Rpb25zID0gW107IC8vICduQWN0aXZlQWN0aW9ucycgZm9sbG93ZWQgYnkgaW5hY3RpdmUgb25lcwoJCXRoaXMuX25BY3RpdmVBY3Rpb25zID0gMDsKCgkJdGhpcy5fYWN0aW9uc0J5Q2xpcCA9IHt9OwoJCS8vIGluc2lkZToKCQkvLyB7CgkJLy8gCWtub3duQWN0aW9uczogQXJyYXk8IEFuaW1hdGlvbkFjdGlvbiA+IC0gdXNlZCBhcyBwcm90b3R5cGVzCgkJLy8gCWFjdGlvbkJ5Um9vdDogQW5pbWF0aW9uQWN0aW9uIC0gbG9va3VwCgkJLy8gfQoKCgkJdGhpcy5fYmluZGluZ3MgPSBbXTsgLy8gJ25BY3RpdmVCaW5kaW5ncycgZm9sbG93ZWQgYnkgaW5hY3RpdmUgb25lcwoJCXRoaXMuX25BY3RpdmVCaW5kaW5ncyA9IDA7CgoJCXRoaXMuX2JpbmRpbmdzQnlSb290QW5kTmFtZSA9IHt9OyAvLyBpbnNpZGU6IE1hcDwgbmFtZSwgUHJvcGVydHlNaXhlciA+CgoKCQl0aGlzLl9jb250cm9sSW50ZXJwb2xhbnRzID0gW107IC8vIHNhbWUgZ2FtZSBhcyBhYm92ZQoJCXRoaXMuX25BY3RpdmVDb250cm9sSW50ZXJwb2xhbnRzID0gMDsKCgkJY29uc3Qgc2NvcGUgPSB0aGlzOwoKCQl0aGlzLnN0YXRzID0gewoKCQkJYWN0aW9uczogewoJCQkJZ2V0IHRvdGFsKCkgewoKCQkJCQlyZXR1cm4gc2NvcGUuX2FjdGlvbnMubGVuZ3RoOwoKCQkJCX0sCgkJCQlnZXQgaW5Vc2UoKSB7CgoJCQkJCXJldHVybiBzY29wZS5fbkFjdGl2ZUFjdGlvbnM7CgoJCQkJfQoJCQl9LAoJCQliaW5kaW5nczogewoJCQkJZ2V0IHRvdGFsKCkgewoKCQkJCQlyZXR1cm4gc2NvcGUuX2JpbmRpbmdzLmxlbmd0aDsKCgkJCQl9LAoJCQkJZ2V0IGluVXNlKCkgewoKCQkJCQlyZXR1cm4gc2NvcGUuX25BY3RpdmVCaW5kaW5nczsKCgkJCQl9CgkJCX0sCgkJCWNvbnRyb2xJbnRlcnBvbGFudHM6IHsKCQkJCWdldCB0b3RhbCgpIHsKCgkJCQkJcmV0dXJuIHNjb3BlLl9jb250cm9sSW50ZXJwb2xhbnRzLmxlbmd0aDsKCgkJCQl9LAoJCQkJZ2V0IGluVXNlKCkgewoKCQkJCQlyZXR1cm4gc2NvcGUuX25BY3RpdmVDb250cm9sSW50ZXJwb2xhbnRzOwoKCQkJCX0KCQkJfQoKCQl9OwoKCX0KCgkvLyBNZW1vcnkgbWFuYWdlbWVudCBmb3IgQW5pbWF0aW9uQWN0aW9uIG9iamVjdHMKCglfaXNBY3RpdmVBY3Rpb24oIGFjdGlvbiApIHsKCgkJY29uc3QgaW5kZXggPSBhY3Rpb24uX2NhY2hlSW5kZXg7CgkJcmV0dXJuIGluZGV4ICE9PSBudWxsICYmIGluZGV4IDwgdGhpcy5fbkFjdGl2ZUFjdGlvbnM7CgoJfQoKCV9hZGRJbmFjdGl2ZUFjdGlvbiggYWN0aW9uLCBjbGlwVXVpZCwgcm9vdFV1aWQgKSB7CgoJCWNvbnN0IGFjdGlvbnMgPSB0aGlzLl9hY3Rpb25zLAoJCQlhY3Rpb25zQnlDbGlwID0gdGhpcy5fYWN0aW9uc0J5Q2xpcDsKCgkJbGV0IGFjdGlvbnNGb3JDbGlwID0gYWN0aW9uc0J5Q2xpcFsgY2xpcFV1aWQgXTsKCgkJaWYgKCBhY3Rpb25zRm9yQ2xpcCA9PT0gdW5kZWZpbmVkICkgewoKCQkJYWN0aW9uc0ZvckNsaXAgPSB7CgoJCQkJa25vd25BY3Rpb25zOiBbIGFjdGlvbiBdLAoJCQkJYWN0aW9uQnlSb290OiB7fQoKCQkJfTsKCgkJCWFjdGlvbi5fYnlDbGlwQ2FjaGVJbmRleCA9IDA7CgoJCQlhY3Rpb25zQnlDbGlwWyBjbGlwVXVpZCBdID0gYWN0aW9uc0ZvckNsaXA7CgoJCX0gZWxzZSB7CgoJCQljb25zdCBrbm93bkFjdGlvbnMgPSBhY3Rpb25zRm9yQ2xpcC5rbm93bkFjdGlvbnM7CgoJCQlhY3Rpb24uX2J5Q2xpcENhY2hlSW5kZXggPSBrbm93bkFjdGlvbnMubGVuZ3RoOwoJCQlrbm93bkFjdGlvbnMucHVzaCggYWN0aW9uICk7CgoJCX0KCgkJYWN0aW9uLl9jYWNoZUluZGV4ID0gYWN0aW9ucy5sZW5ndGg7CgkJYWN0aW9ucy5wdXNoKCBhY3Rpb24gKTsKCgkJYWN0aW9uc0ZvckNsaXAuYWN0aW9uQnlSb290WyByb290VXVpZCBdID0gYWN0aW9uOwoKCX0KCglfcmVtb3ZlSW5hY3RpdmVBY3Rpb24oIGFjdGlvbiApIHsKCgkJY29uc3QgYWN0aW9ucyA9IHRoaXMuX2FjdGlvbnMsCgkJCWxhc3RJbmFjdGl2ZUFjdGlvbiA9IGFjdGlvbnNbIGFjdGlvbnMubGVuZ3RoIC0gMSBdLAoJCQljYWNoZUluZGV4ID0gYWN0aW9uLl9jYWNoZUluZGV4OwoKCQlsYXN0SW5hY3RpdmVBY3Rpb24uX2NhY2hlSW5kZXggPSBjYWNoZUluZGV4OwoJCWFjdGlvbnNbIGNhY2hlSW5kZXggXSA9IGxhc3RJbmFjdGl2ZUFjdGlvbjsKCQlhY3Rpb25zLnBvcCgpOwoKCQlhY3Rpb24uX2NhY2hlSW5kZXggPSBudWxsOwoKCgkJY29uc3QgY2xpcFV1aWQgPSBhY3Rpb24uX2NsaXAudXVpZCwKCQkJYWN0aW9uc0J5Q2xpcCA9IHRoaXMuX2FjdGlvbnNCeUNsaXAsCgkJCWFjdGlvbnNGb3JDbGlwID0gYWN0aW9uc0J5Q2xpcFsgY2xpcFV1aWQgXSwKCQkJa25vd25BY3Rpb25zRm9yQ2xpcCA9IGFjdGlvbnNGb3JDbGlwLmtub3duQWN0aW9ucywKCgkJCWxhc3RLbm93bkFjdGlvbiA9CgkJCQlrbm93bkFjdGlvbnNGb3JDbGlwWyBrbm93bkFjdGlvbnNGb3JDbGlwLmxlbmd0aCAtIDEgXSwKCgkJCWJ5Q2xpcENhY2hlSW5kZXggPSBhY3Rpb24uX2J5Q2xpcENhY2hlSW5kZXg7CgoJCWxhc3RLbm93bkFjdGlvbi5fYnlDbGlwQ2FjaGVJbmRleCA9IGJ5Q2xpcENhY2hlSW5kZXg7CgkJa25vd25BY3Rpb25zRm9yQ2xpcFsgYnlDbGlwQ2FjaGVJbmRleCBdID0gbGFzdEtub3duQWN0aW9uOwoJCWtub3duQWN0aW9uc0ZvckNsaXAucG9wKCk7CgoJCWFjdGlvbi5fYnlDbGlwQ2FjaGVJbmRleCA9IG51bGw7CgoKCQljb25zdCBhY3Rpb25CeVJvb3QgPSBhY3Rpb25zRm9yQ2xpcC5hY3Rpb25CeVJvb3QsCgkJCXJvb3RVdWlkID0gKCBhY3Rpb24uX2xvY2FsUm9vdCB8fCB0aGlzLl9yb290ICkudXVpZDsKCgkJZGVsZXRlIGFjdGlvbkJ5Um9vdFsgcm9vdFV1aWQgXTsKCgkJaWYgKCBrbm93bkFjdGlvbnNGb3JDbGlwLmxlbmd0aCA9PT0gMCApIHsKCgkJCWRlbGV0ZSBhY3Rpb25zQnlDbGlwWyBjbGlwVXVpZCBdOwoKCQl9CgoJCXRoaXMuX3JlbW92ZUluYWN0aXZlQmluZGluZ3NGb3JBY3Rpb24oIGFjdGlvbiApOwoKCX0KCglfcmVtb3ZlSW5hY3RpdmVCaW5kaW5nc0ZvckFjdGlvbiggYWN0aW9uICkgewoKCQljb25zdCBiaW5kaW5ncyA9IGFjdGlvbi5fcHJvcGVydHlCaW5kaW5nczsKCgkJZm9yICggbGV0IGkgPSAwLCBuID0gYmluZGluZ3MubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJY29uc3QgYmluZGluZyA9IGJpbmRpbmdzWyBpIF07CgoJCQlpZiAoIC0tIGJpbmRpbmcucmVmZXJlbmNlQ291bnQgPT09IDAgKSB7CgoJCQkJdGhpcy5fcmVtb3ZlSW5hY3RpdmVCaW5kaW5nKCBiaW5kaW5nICk7CgoJCQl9CgoJCX0KCgl9CgoJX2xlbmRBY3Rpb24oIGFjdGlvbiApIHsKCgkJLy8gWyBhY3RpdmUgYWN0aW9ucyB8ICBpbmFjdGl2ZSBhY3Rpb25zICBdCgkJLy8gWyAgYWN0aXZlIGFjdGlvbnMgPnwgaW5hY3RpdmUgYWN0aW9ucyBdCgkJLy8gICAgICAgICAgICAgICAgIHMgICAgICAgIGEKCQkvLyAgICAgICAgICAgICAgICAgIDwtc3dhcC0+CgkJLy8gICAgICAgICAgICAgICAgIGEgICAgICAgIHMKCgkJY29uc3QgYWN0aW9ucyA9IHRoaXMuX2FjdGlvbnMsCgkJCXByZXZJbmRleCA9IGFjdGlvbi5fY2FjaGVJbmRleCwKCgkJCWxhc3RBY3RpdmVJbmRleCA9IHRoaXMuX25BY3RpdmVBY3Rpb25zICsrLAoKCQkJZmlyc3RJbmFjdGl2ZUFjdGlvbiA9IGFjdGlvbnNbIGxhc3RBY3RpdmVJbmRleCBdOwoKCQlhY3Rpb24uX2NhY2hlSW5kZXggPSBsYXN0QWN0aXZlSW5kZXg7CgkJYWN0aW9uc1sgbGFzdEFjdGl2ZUluZGV4IF0gPSBhY3Rpb247CgoJCWZpcnN0SW5hY3RpdmVBY3Rpb24uX2NhY2hlSW5kZXggPSBwcmV2SW5kZXg7CgkJYWN0aW9uc1sgcHJldkluZGV4IF0gPSBmaXJzdEluYWN0aXZlQWN0aW9uOwoKCX0KCglfdGFrZUJhY2tBY3Rpb24oIGFjdGlvbiApIHsKCgkJLy8gWyAgYWN0aXZlIGFjdGlvbnMgIHwgaW5hY3RpdmUgYWN0aW9ucyBdCgkJLy8gWyBhY3RpdmUgYWN0aW9ucyB8PCBpbmFjdGl2ZSBhY3Rpb25zICBdCgkJLy8gICAgICAgIGEgICAgICAgIHMKCQkvLyAgICAgICAgIDwtc3dhcC0+CgkJLy8gICAgICAgIHMgICAgICAgIGEKCgkJY29uc3QgYWN0aW9ucyA9IHRoaXMuX2FjdGlvbnMsCgkJCXByZXZJbmRleCA9IGFjdGlvbi5fY2FjaGVJbmRleCwKCgkJCWZpcnN0SW5hY3RpdmVJbmRleCA9IC0tIHRoaXMuX25BY3RpdmVBY3Rpb25zLAoKCQkJbGFzdEFjdGl2ZUFjdGlvbiA9IGFjdGlvbnNbIGZpcnN0SW5hY3RpdmVJbmRleCBdOwoKCQlhY3Rpb24uX2NhY2hlSW5kZXggPSBmaXJzdEluYWN0aXZlSW5kZXg7CgkJYWN0aW9uc1sgZmlyc3RJbmFjdGl2ZUluZGV4IF0gPSBhY3Rpb247CgoJCWxhc3RBY3RpdmVBY3Rpb24uX2NhY2hlSW5kZXggPSBwcmV2SW5kZXg7CgkJYWN0aW9uc1sgcHJldkluZGV4IF0gPSBsYXN0QWN0aXZlQWN0aW9uOwoKCX0KCgkvLyBNZW1vcnkgbWFuYWdlbWVudCBmb3IgUHJvcGVydHlNaXhlciBvYmplY3RzCgoJX2FkZEluYWN0aXZlQmluZGluZyggYmluZGluZywgcm9vdFV1aWQsIHRyYWNrTmFtZSApIHsKCgkJY29uc3QgYmluZGluZ3NCeVJvb3QgPSB0aGlzLl9iaW5kaW5nc0J5Um9vdEFuZE5hbWUsCgkJCWJpbmRpbmdzID0gdGhpcy5fYmluZGluZ3M7CgoJCWxldCBiaW5kaW5nQnlOYW1lID0gYmluZGluZ3NCeVJvb3RbIHJvb3RVdWlkIF07CgoJCWlmICggYmluZGluZ0J5TmFtZSA9PT0gdW5kZWZpbmVkICkgewoKCQkJYmluZGluZ0J5TmFtZSA9IHt9OwoJCQliaW5kaW5nc0J5Um9vdFsgcm9vdFV1aWQgXSA9IGJpbmRpbmdCeU5hbWU7CgoJCX0KCgkJYmluZGluZ0J5TmFtZVsgdHJhY2tOYW1lIF0gPSBiaW5kaW5nOwoKCQliaW5kaW5nLl9jYWNoZUluZGV4ID0gYmluZGluZ3MubGVuZ3RoOwoJCWJpbmRpbmdzLnB1c2goIGJpbmRpbmcgKTsKCgl9CgoJX3JlbW92ZUluYWN0aXZlQmluZGluZyggYmluZGluZyApIHsKCgkJY29uc3QgYmluZGluZ3MgPSB0aGlzLl9iaW5kaW5ncywKCQkJcHJvcEJpbmRpbmcgPSBiaW5kaW5nLmJpbmRpbmcsCgkJCXJvb3RVdWlkID0gcHJvcEJpbmRpbmcucm9vdE5vZGUudXVpZCwKCQkJdHJhY2tOYW1lID0gcHJvcEJpbmRpbmcucGF0aCwKCQkJYmluZGluZ3NCeVJvb3QgPSB0aGlzLl9iaW5kaW5nc0J5Um9vdEFuZE5hbWUsCgkJCWJpbmRpbmdCeU5hbWUgPSBiaW5kaW5nc0J5Um9vdFsgcm9vdFV1aWQgXSwKCgkJCWxhc3RJbmFjdGl2ZUJpbmRpbmcgPSBiaW5kaW5nc1sgYmluZGluZ3MubGVuZ3RoIC0gMSBdLAoJCQljYWNoZUluZGV4ID0gYmluZGluZy5fY2FjaGVJbmRleDsKCgkJbGFzdEluYWN0aXZlQmluZGluZy5fY2FjaGVJbmRleCA9IGNhY2hlSW5kZXg7CgkJYmluZGluZ3NbIGNhY2hlSW5kZXggXSA9IGxhc3RJbmFjdGl2ZUJpbmRpbmc7CgkJYmluZGluZ3MucG9wKCk7CgoJCWRlbGV0ZSBiaW5kaW5nQnlOYW1lWyB0cmFja05hbWUgXTsKCgkJaWYgKCBPYmplY3Qua2V5cyggYmluZGluZ0J5TmFtZSApLmxlbmd0aCA9PT0gMCApIHsKCgkJCWRlbGV0ZSBiaW5kaW5nc0J5Um9vdFsgcm9vdFV1aWQgXTsKCgkJfQoKCX0KCglfbGVuZEJpbmRpbmcoIGJpbmRpbmcgKSB7CgoJCWNvbnN0IGJpbmRpbmdzID0gdGhpcy5fYmluZGluZ3MsCgkJCXByZXZJbmRleCA9IGJpbmRpbmcuX2NhY2hlSW5kZXgsCgoJCQlsYXN0QWN0aXZlSW5kZXggPSB0aGlzLl9uQWN0aXZlQmluZGluZ3MgKyssCgoJCQlmaXJzdEluYWN0aXZlQmluZGluZyA9IGJpbmRpbmdzWyBsYXN0QWN0aXZlSW5kZXggXTsKCgkJYmluZGluZy5fY2FjaGVJbmRleCA9IGxhc3RBY3RpdmVJbmRleDsKCQliaW5kaW5nc1sgbGFzdEFjdGl2ZUluZGV4IF0gPSBiaW5kaW5nOwoKCQlmaXJzdEluYWN0aXZlQmluZGluZy5fY2FjaGVJbmRleCA9IHByZXZJbmRleDsKCQliaW5kaW5nc1sgcHJldkluZGV4IF0gPSBmaXJzdEluYWN0aXZlQmluZGluZzsKCgl9CgoJX3Rha2VCYWNrQmluZGluZyggYmluZGluZyApIHsKCgkJY29uc3QgYmluZGluZ3MgPSB0aGlzLl9iaW5kaW5ncywKCQkJcHJldkluZGV4ID0gYmluZGluZy5fY2FjaGVJbmRleCwKCgkJCWZpcnN0SW5hY3RpdmVJbmRleCA9IC0tIHRoaXMuX25BY3RpdmVCaW5kaW5ncywKCgkJCWxhc3RBY3RpdmVCaW5kaW5nID0gYmluZGluZ3NbIGZpcnN0SW5hY3RpdmVJbmRleCBdOwoKCQliaW5kaW5nLl9jYWNoZUluZGV4ID0gZmlyc3RJbmFjdGl2ZUluZGV4OwoJCWJpbmRpbmdzWyBmaXJzdEluYWN0aXZlSW5kZXggXSA9IGJpbmRpbmc7CgoJCWxhc3RBY3RpdmVCaW5kaW5nLl9jYWNoZUluZGV4ID0gcHJldkluZGV4OwoJCWJpbmRpbmdzWyBwcmV2SW5kZXggXSA9IGxhc3RBY3RpdmVCaW5kaW5nOwoKCX0KCgoJLy8gTWVtb3J5IG1hbmFnZW1lbnQgb2YgSW50ZXJwb2xhbnRzIGZvciB3ZWlnaHQgYW5kIHRpbWUgc2NhbGUKCglfbGVuZENvbnRyb2xJbnRlcnBvbGFudCgpIHsKCgkJY29uc3QgaW50ZXJwb2xhbnRzID0gdGhpcy5fY29udHJvbEludGVycG9sYW50cywKCQkJbGFzdEFjdGl2ZUluZGV4ID0gdGhpcy5fbkFjdGl2ZUNvbnRyb2xJbnRlcnBvbGFudHMgKys7CgoJCWxldCBpbnRlcnBvbGFudCA9IGludGVycG9sYW50c1sgbGFzdEFjdGl2ZUluZGV4IF07CgoJCWlmICggaW50ZXJwb2xhbnQgPT09IHVuZGVmaW5lZCApIHsKCgkJCWludGVycG9sYW50ID0gbmV3IExpbmVhckludGVycG9sYW50KAoJCQkJbmV3IEZsb2F0MzJBcnJheSggMiApLCBuZXcgRmxvYXQzMkFycmF5KCAyICksCgkJCQkxLCBfY29udHJvbEludGVycG9sYW50c1Jlc3VsdEJ1ZmZlciApOwoKCQkJaW50ZXJwb2xhbnQuX19jYWNoZUluZGV4ID0gbGFzdEFjdGl2ZUluZGV4OwoJCQlpbnRlcnBvbGFudHNbIGxhc3RBY3RpdmVJbmRleCBdID0gaW50ZXJwb2xhbnQ7CgoJCX0KCgkJcmV0dXJuIGludGVycG9sYW50OwoKCX0KCglfdGFrZUJhY2tDb250cm9sSW50ZXJwb2xhbnQoIGludGVycG9sYW50ICkgewoKCQljb25zdCBpbnRlcnBvbGFudHMgPSB0aGlzLl9jb250cm9sSW50ZXJwb2xhbnRzLAoJCQlwcmV2SW5kZXggPSBpbnRlcnBvbGFudC5fX2NhY2hlSW5kZXgsCgoJCQlmaXJzdEluYWN0aXZlSW5kZXggPSAtLSB0aGlzLl9uQWN0aXZlQ29udHJvbEludGVycG9sYW50cywKCgkJCWxhc3RBY3RpdmVJbnRlcnBvbGFudCA9IGludGVycG9sYW50c1sgZmlyc3RJbmFjdGl2ZUluZGV4IF07CgoJCWludGVycG9sYW50Ll9fY2FjaGVJbmRleCA9IGZpcnN0SW5hY3RpdmVJbmRleDsKCQlpbnRlcnBvbGFudHNbIGZpcnN0SW5hY3RpdmVJbmRleCBdID0gaW50ZXJwb2xhbnQ7CgoJCWxhc3RBY3RpdmVJbnRlcnBvbGFudC5fX2NhY2hlSW5kZXggPSBwcmV2SW5kZXg7CgkJaW50ZXJwb2xhbnRzWyBwcmV2SW5kZXggXSA9IGxhc3RBY3RpdmVJbnRlcnBvbGFudDsKCgl9CgoJLy8gcmV0dXJuIGFuIGFjdGlvbiBmb3IgYSBjbGlwIG9wdGlvbmFsbHkgdXNpbmcgYSBjdXN0b20gcm9vdCB0YXJnZXQKCS8vIG9iamVjdCAodGhpcyBtZXRob2QgYWxsb2NhdGVzIGEgbG90IG9mIGR5bmFtaWMgbWVtb3J5IGluIGNhc2UgYQoJLy8gcHJldmlvdXNseSB1bmtub3duIGNsaXAvcm9vdCBjb21iaW5hdGlvbiBpcyBzcGVjaWZpZWQpCgljbGlwQWN0aW9uKCBjbGlwLCBvcHRpb25hbFJvb3QsIGJsZW5kTW9kZSApIHsKCgkJY29uc3Qgcm9vdCA9IG9wdGlvbmFsUm9vdCB8fCB0aGlzLl9yb290LAoJCQlyb290VXVpZCA9IHJvb3QudXVpZDsKCgkJbGV0IGNsaXBPYmplY3QgPSB0eXBlb2YgY2xpcCA9PT0gJ3N0cmluZycgPyBBbmltYXRpb25DbGlwLmZpbmRCeU5hbWUoIHJvb3QsIGNsaXAgKSA6IGNsaXA7CgoJCWNvbnN0IGNsaXBVdWlkID0gY2xpcE9iamVjdCAhPT0gbnVsbCA/IGNsaXBPYmplY3QudXVpZCA6IGNsaXA7CgoJCWNvbnN0IGFjdGlvbnNGb3JDbGlwID0gdGhpcy5fYWN0aW9uc0J5Q2xpcFsgY2xpcFV1aWQgXTsKCQlsZXQgcHJvdG90eXBlQWN0aW9uID0gbnVsbDsKCgkJaWYgKCBibGVuZE1vZGUgPT09IHVuZGVmaW5lZCApIHsKCgkJCWlmICggY2xpcE9iamVjdCAhPT0gbnVsbCApIHsKCgkJCQlibGVuZE1vZGUgPSBjbGlwT2JqZWN0LmJsZW5kTW9kZTsKCgkJCX0gZWxzZSB7CgoJCQkJYmxlbmRNb2RlID0gTm9ybWFsQW5pbWF0aW9uQmxlbmRNb2RlOwoKCQkJfQoKCQl9CgoJCWlmICggYWN0aW9uc0ZvckNsaXAgIT09IHVuZGVmaW5lZCApIHsKCgkJCWNvbnN0IGV4aXN0aW5nQWN0aW9uID0gYWN0aW9uc0ZvckNsaXAuYWN0aW9uQnlSb290WyByb290VXVpZCBdOwoKCQkJaWYgKCBleGlzdGluZ0FjdGlvbiAhPT0gdW5kZWZpbmVkICYmIGV4aXN0aW5nQWN0aW9uLmJsZW5kTW9kZSA9PT0gYmxlbmRNb2RlICkgewoKCQkJCXJldHVybiBleGlzdGluZ0FjdGlvbjsKCgkJCX0KCgkJCS8vIHdlIGtub3cgdGhlIGNsaXAsIHNvIHdlIGRvbid0IGhhdmUgdG8gcGFyc2UgYWxsCgkJCS8vIHRoZSBiaW5kaW5ncyBhZ2FpbiBidXQgY2FuIGp1c3QgY29weQoJCQlwcm90b3R5cGVBY3Rpb24gPSBhY3Rpb25zRm9yQ2xpcC5rbm93bkFjdGlvbnNbIDAgXTsKCgkJCS8vIGFsc28sIHRha2UgdGhlIGNsaXAgZnJvbSB0aGUgcHJvdG90eXBlIGFjdGlvbgoJCQlpZiAoIGNsaXBPYmplY3QgPT09IG51bGwgKQoJCQkJY2xpcE9iamVjdCA9IHByb3RvdHlwZUFjdGlvbi5fY2xpcDsKCgkJfQoKCQkvLyBjbGlwIG11c3QgYmUga25vd24gd2hlbiBzcGVjaWZpZWQgdmlhIHN0cmluZwoJCWlmICggY2xpcE9iamVjdCA9PT0gbnVsbCApIHJldHVybiBudWxsOwoKCQkvLyBhbGxvY2F0ZSBhbGwgcmVzb3VyY2VzIHJlcXVpcmVkIHRvIHJ1biBpdAoJCWNvbnN0IG5ld0FjdGlvbiA9IG5ldyBBbmltYXRpb25BY3Rpb24oIHRoaXMsIGNsaXBPYmplY3QsIG9wdGlvbmFsUm9vdCwgYmxlbmRNb2RlICk7CgoJCXRoaXMuX2JpbmRBY3Rpb24oIG5ld0FjdGlvbiwgcHJvdG90eXBlQWN0aW9uICk7CgoJCS8vIGFuZCBtYWtlIHRoZSBhY3Rpb24ga25vd24gdG8gdGhlIG1lbW9yeSBtYW5hZ2VyCgkJdGhpcy5fYWRkSW5hY3RpdmVBY3Rpb24oIG5ld0FjdGlvbiwgY2xpcFV1aWQsIHJvb3RVdWlkICk7CgoJCXJldHVybiBuZXdBY3Rpb247CgoJfQoKCS8vIGdldCBhbiBleGlzdGluZyBhY3Rpb24KCWV4aXN0aW5nQWN0aW9uKCBjbGlwLCBvcHRpb25hbFJvb3QgKSB7CgoJCWNvbnN0IHJvb3QgPSBvcHRpb25hbFJvb3QgfHwgdGhpcy5fcm9vdCwKCQkJcm9vdFV1aWQgPSByb290LnV1aWQsCgoJCQljbGlwT2JqZWN0ID0gdHlwZW9mIGNsaXAgPT09ICdzdHJpbmcnID8KCQkJCUFuaW1hdGlvbkNsaXAuZmluZEJ5TmFtZSggcm9vdCwgY2xpcCApIDogY2xpcCwKCgkJCWNsaXBVdWlkID0gY2xpcE9iamVjdCA/IGNsaXBPYmplY3QudXVpZCA6IGNsaXAsCgoJCQlhY3Rpb25zRm9yQ2xpcCA9IHRoaXMuX2FjdGlvbnNCeUNsaXBbIGNsaXBVdWlkIF07CgoJCWlmICggYWN0aW9uc0ZvckNsaXAgIT09IHVuZGVmaW5lZCApIHsKCgkJCXJldHVybiBhY3Rpb25zRm9yQ2xpcC5hY3Rpb25CeVJvb3RbIHJvb3RVdWlkIF0gfHwgbnVsbDsKCgkJfQoKCQlyZXR1cm4gbnVsbDsKCgl9CgoJLy8gZGVhY3RpdmF0ZXMgYWxsIHByZXZpb3VzbHkgc2NoZWR1bGVkIGFjdGlvbnMKCXN0b3BBbGxBY3Rpb24oKSB7CgoJCWNvbnN0IGFjdGlvbnMgPSB0aGlzLl9hY3Rpb25zLAoJCQluQWN0aW9ucyA9IHRoaXMuX25BY3RpdmVBY3Rpb25zOwoKCQlmb3IgKCBsZXQgaSA9IG5BY3Rpb25zIC0gMTsgaSA+PSAwOyAtLSBpICkgewoKCQkJYWN0aW9uc1sgaSBdLnN0b3AoKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJLy8gYWR2YW5jZSB0aGUgdGltZSBhbmQgdXBkYXRlIGFwcGx5IHRoZSBhbmltYXRpb24KCXVwZGF0ZSggZGVsdGFUaW1lICkgewoKCQlkZWx0YVRpbWUgKj0gdGhpcy50aW1lU2NhbGU7CgoJCWNvbnN0IGFjdGlvbnMgPSB0aGlzLl9hY3Rpb25zLAoJCQluQWN0aW9ucyA9IHRoaXMuX25BY3RpdmVBY3Rpb25zLAoKCQkJdGltZSA9IHRoaXMudGltZSArPSBkZWx0YVRpbWUsCgkJCXRpbWVEaXJlY3Rpb24gPSBNYXRoLnNpZ24oIGRlbHRhVGltZSApLAoKCQkJYWNjdUluZGV4ID0gdGhpcy5fYWNjdUluZGV4IF49IDE7CgoJCS8vIHJ1biBhY3RpdmUgYWN0aW9ucwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgIT09IG5BY3Rpb25zOyArKyBpICkgewoKCQkJY29uc3QgYWN0aW9uID0gYWN0aW9uc1sgaSBdOwoKCQkJYWN0aW9uLl91cGRhdGUoIHRpbWUsIGRlbHRhVGltZSwgdGltZURpcmVjdGlvbiwgYWNjdUluZGV4ICk7CgoJCX0KCgkJLy8gdXBkYXRlIHNjZW5lIGdyYXBoCgoJCWNvbnN0IGJpbmRpbmdzID0gdGhpcy5fYmluZGluZ3MsCgkJCW5CaW5kaW5ncyA9IHRoaXMuX25BY3RpdmVCaW5kaW5nczsKCgkJZm9yICggbGV0IGkgPSAwOyBpICE9PSBuQmluZGluZ3M7ICsrIGkgKSB7CgoJCQliaW5kaW5nc1sgaSBdLmFwcGx5KCBhY2N1SW5kZXggKTsKCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJLy8gQWxsb3dzIHlvdSB0byBzZWVrIHRvIGEgc3BlY2lmaWMgdGltZSBpbiBhbiBhbmltYXRpb24uCglzZXRUaW1lKCB0aW1lSW5TZWNvbmRzICkgewoKCQl0aGlzLnRpbWUgPSAwOyAvLyBaZXJvIG91dCB0aW1lIGF0dHJpYnV0ZSBmb3IgQW5pbWF0aW9uTWl4ZXIgb2JqZWN0OwoJCWZvciAoIGxldCBpID0gMDsgaSA8IHRoaXMuX2FjdGlvbnMubGVuZ3RoOyBpICsrICkgewoKCQkJdGhpcy5fYWN0aW9uc1sgaSBdLnRpbWUgPSAwOyAvLyBaZXJvIG91dCB0aW1lIGF0dHJpYnV0ZSBmb3IgYWxsIGFzc29jaWF0ZWQgQW5pbWF0aW9uQWN0aW9uIG9iamVjdHMuCgoJCX0KCgkJcmV0dXJuIHRoaXMudXBkYXRlKCB0aW1lSW5TZWNvbmRzICk7IC8vIFVwZGF0ZSB1c2VkIHRvIHNldCBleGFjdCB0aW1lLiBSZXR1cm5zICJ0aGlzIiBBbmltYXRpb25NaXhlciBvYmplY3QuCgoJfQoKCS8vIHJldHVybiB0aGlzIG1peGVyJ3Mgcm9vdCB0YXJnZXQgb2JqZWN0CglnZXRSb290KCkgewoKCQlyZXR1cm4gdGhpcy5fcm9vdDsKCgl9CgoJLy8gZnJlZSBhbGwgcmVzb3VyY2VzIHNwZWNpZmljIHRvIGEgcGFydGljdWxhciBjbGlwCgl1bmNhY2hlQ2xpcCggY2xpcCApIHsKCgkJY29uc3QgYWN0aW9ucyA9IHRoaXMuX2FjdGlvbnMsCgkJCWNsaXBVdWlkID0gY2xpcC51dWlkLAoJCQlhY3Rpb25zQnlDbGlwID0gdGhpcy5fYWN0aW9uc0J5Q2xpcCwKCQkJYWN0aW9uc0ZvckNsaXAgPSBhY3Rpb25zQnlDbGlwWyBjbGlwVXVpZCBdOwoKCQlpZiAoIGFjdGlvbnNGb3JDbGlwICE9PSB1bmRlZmluZWQgKSB7CgoJCQkvLyBub3RlOiBqdXN0IGNhbGxpbmcgX3JlbW92ZUluYWN0aXZlQWN0aW9uIHdvdWxkIG1lc3MgdXAgdGhlCgkJCS8vIGl0ZXJhdGlvbiBzdGF0ZSBhbmQgYWxzbyByZXF1aXJlIHVwZGF0aW5nIHRoZSBzdGF0ZSB3ZSBjYW4KCQkJLy8ganVzdCB0aHJvdyBhd2F5CgoJCQljb25zdCBhY3Rpb25zVG9SZW1vdmUgPSBhY3Rpb25zRm9yQ2xpcC5rbm93bkFjdGlvbnM7CgoJCQlmb3IgKCBsZXQgaSA9IDAsIG4gPSBhY3Rpb25zVG9SZW1vdmUubGVuZ3RoOyBpICE9PSBuOyArKyBpICkgewoKCQkJCWNvbnN0IGFjdGlvbiA9IGFjdGlvbnNUb1JlbW92ZVsgaSBdOwoKCQkJCXRoaXMuX2RlYWN0aXZhdGVBY3Rpb24oIGFjdGlvbiApOwoKCQkJCWNvbnN0IGNhY2hlSW5kZXggPSBhY3Rpb24uX2NhY2hlSW5kZXgsCgkJCQkJbGFzdEluYWN0aXZlQWN0aW9uID0gYWN0aW9uc1sgYWN0aW9ucy5sZW5ndGggLSAxIF07CgoJCQkJYWN0aW9uLl9jYWNoZUluZGV4ID0gbnVsbDsKCQkJCWFjdGlvbi5fYnlDbGlwQ2FjaGVJbmRleCA9IG51bGw7CgoJCQkJbGFzdEluYWN0aXZlQWN0aW9uLl9jYWNoZUluZGV4ID0gY2FjaGVJbmRleDsKCQkJCWFjdGlvbnNbIGNhY2hlSW5kZXggXSA9IGxhc3RJbmFjdGl2ZUFjdGlvbjsKCQkJCWFjdGlvbnMucG9wKCk7CgoJCQkJdGhpcy5fcmVtb3ZlSW5hY3RpdmVCaW5kaW5nc0ZvckFjdGlvbiggYWN0aW9uICk7CgoJCQl9CgoJCQlkZWxldGUgYWN0aW9uc0J5Q2xpcFsgY2xpcFV1aWQgXTsKCgkJfQoKCX0KCgkvLyBmcmVlIGFsbCByZXNvdXJjZXMgc3BlY2lmaWMgdG8gYSBwYXJ0aWN1bGFyIHJvb3QgdGFyZ2V0IG9iamVjdAoJdW5jYWNoZVJvb3QoIHJvb3QgKSB7CgoJCWNvbnN0IHJvb3RVdWlkID0gcm9vdC51dWlkLAoJCQlhY3Rpb25zQnlDbGlwID0gdGhpcy5fYWN0aW9uc0J5Q2xpcDsKCgkJZm9yICggY29uc3QgY2xpcFV1aWQgaW4gYWN0aW9uc0J5Q2xpcCApIHsKCgkJCWNvbnN0IGFjdGlvbkJ5Um9vdCA9IGFjdGlvbnNCeUNsaXBbIGNsaXBVdWlkIF0uYWN0aW9uQnlSb290LAoJCQkJYWN0aW9uID0gYWN0aW9uQnlSb290WyByb290VXVpZCBdOwoKCQkJaWYgKCBhY3Rpb24gIT09IHVuZGVmaW5lZCApIHsKCgkJCQl0aGlzLl9kZWFjdGl2YXRlQWN0aW9uKCBhY3Rpb24gKTsKCQkJCXRoaXMuX3JlbW92ZUluYWN0aXZlQWN0aW9uKCBhY3Rpb24gKTsKCgkJCX0KCgkJfQoKCQljb25zdCBiaW5kaW5nc0J5Um9vdCA9IHRoaXMuX2JpbmRpbmdzQnlSb290QW5kTmFtZSwKCQkJYmluZGluZ0J5TmFtZSA9IGJpbmRpbmdzQnlSb290WyByb290VXVpZCBdOwoKCQlpZiAoIGJpbmRpbmdCeU5hbWUgIT09IHVuZGVmaW5lZCApIHsKCgkJCWZvciAoIGNvbnN0IHRyYWNrTmFtZSBpbiBiaW5kaW5nQnlOYW1lICkgewoKCQkJCWNvbnN0IGJpbmRpbmcgPSBiaW5kaW5nQnlOYW1lWyB0cmFja05hbWUgXTsKCQkJCWJpbmRpbmcucmVzdG9yZU9yaWdpbmFsU3RhdGUoKTsKCQkJCXRoaXMuX3JlbW92ZUluYWN0aXZlQmluZGluZyggYmluZGluZyApOwoKCQkJfQoKCQl9CgoJfQoKCS8vIHJlbW92ZSBhIHRhcmdldGVkIGNsaXAgZnJvbSB0aGUgY2FjaGUKCXVuY2FjaGVBY3Rpb24oIGNsaXAsIG9wdGlvbmFsUm9vdCApIHsKCgkJY29uc3QgYWN0aW9uID0gdGhpcy5leGlzdGluZ0FjdGlvbiggY2xpcCwgb3B0aW9uYWxSb290ICk7CgoJCWlmICggYWN0aW9uICE9PSBudWxsICkgewoKCQkJdGhpcy5fZGVhY3RpdmF0ZUFjdGlvbiggYWN0aW9uICk7CgkJCXRoaXMuX3JlbW92ZUluYWN0aXZlQWN0aW9uKCBhY3Rpb24gKTsKCgkJfQoKCX0KCn0KCmNsYXNzIFVuaWZvcm0gewoKCWNvbnN0cnVjdG9yKCB2YWx1ZSApIHsKCgkJdGhpcy52YWx1ZSA9IHZhbHVlOwoKCX0KCgljbG9uZSgpIHsKCgkJcmV0dXJuIG5ldyBVbmlmb3JtKCB0aGlzLnZhbHVlLmNsb25lID09PSB1bmRlZmluZWQgPyB0aGlzLnZhbHVlIDogdGhpcy52YWx1ZS5jbG9uZSgpICk7CgoJfQoKfQoKbGV0IF9pZCA9IDA7CgpjbGFzcyBVbmlmb3Jtc0dyb3VwIGV4dGVuZHMgRXZlbnREaXNwYXRjaGVyIHsKCgljb25zdHJ1Y3RvcigpIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5pc1VuaWZvcm1zR3JvdXAgPSB0cnVlOwoKCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRoaXMsICdpZCcsIHsgdmFsdWU6IF9pZCArKyB9ICk7CgoJCXRoaXMubmFtZSA9ICcnOwoKCQl0aGlzLnVzYWdlID0gU3RhdGljRHJhd1VzYWdlOwoJCXRoaXMudW5pZm9ybXMgPSBbXTsKCgl9CgoJYWRkKCB1bmlmb3JtICkgewoKCQl0aGlzLnVuaWZvcm1zLnB1c2goIHVuaWZvcm0gKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXJlbW92ZSggdW5pZm9ybSApIHsKCgkJY29uc3QgaW5kZXggPSB0aGlzLnVuaWZvcm1zLmluZGV4T2YoIHVuaWZvcm0gKTsKCgkJaWYgKCBpbmRleCAhPT0gLSAxICkgdGhpcy51bmlmb3Jtcy5zcGxpY2UoIGluZGV4LCAxICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXROYW1lKCBuYW1lICkgewoKCQl0aGlzLm5hbWUgPSBuYW1lOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0VXNhZ2UoIHZhbHVlICkgewoKCQl0aGlzLnVzYWdlID0gdmFsdWU7CgoJCXJldHVybiB0aGlzOwoKCX0KCglkaXNwb3NlKCkgewoKCQl0aGlzLmRpc3BhdGNoRXZlbnQoIHsgdHlwZTogJ2Rpc3Bvc2UnIH0gKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvcHkoIHNvdXJjZSApIHsKCgkJdGhpcy5uYW1lID0gc291cmNlLm5hbWU7CgkJdGhpcy51c2FnZSA9IHNvdXJjZS51c2FnZTsKCgkJY29uc3QgdW5pZm9ybXNTb3VyY2UgPSBzb3VyY2UudW5pZm9ybXM7CgoJCXRoaXMudW5pZm9ybXMubGVuZ3RoID0gMDsKCgkJZm9yICggbGV0IGkgPSAwLCBsID0gdW5pZm9ybXNTb3VyY2UubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWNvbnN0IHVuaWZvcm1zID0gQXJyYXkuaXNBcnJheSggdW5pZm9ybXNTb3VyY2VbIGkgXSApID8gdW5pZm9ybXNTb3VyY2VbIGkgXSA6IFsgdW5pZm9ybXNTb3VyY2VbIGkgXSBdOwoKCQkJZm9yICggbGV0IGogPSAwOyBqIDwgdW5pZm9ybXMubGVuZ3RoOyBqICsrICkgewoKCQkJCXRoaXMudW5pZm9ybXMucHVzaCggdW5pZm9ybXNbIGogXS5jbG9uZSgpICk7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KCB0aGlzICk7CgoJfQoKfQoKY2xhc3MgSW5zdGFuY2VkSW50ZXJsZWF2ZWRCdWZmZXIgZXh0ZW5kcyBJbnRlcmxlYXZlZEJ1ZmZlciB7CgoJY29uc3RydWN0b3IoIGFycmF5LCBzdHJpZGUsIG1lc2hQZXJBdHRyaWJ1dGUgPSAxICkgewoKCQlzdXBlciggYXJyYXksIHN0cmlkZSApOwoKCQl0aGlzLmlzSW5zdGFuY2VkSW50ZXJsZWF2ZWRCdWZmZXIgPSB0cnVlOwoKCQl0aGlzLm1lc2hQZXJBdHRyaWJ1dGUgPSBtZXNoUGVyQXR0cmlidXRlOwoKCX0KCgljb3B5KCBzb3VyY2UgKSB7CgoJCXN1cGVyLmNvcHkoIHNvdXJjZSApOwoKCQl0aGlzLm1lc2hQZXJBdHRyaWJ1dGUgPSBzb3VyY2UubWVzaFBlckF0dHJpYnV0ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsb25lKCBkYXRhICkgewoKCQljb25zdCBpYiA9IHN1cGVyLmNsb25lKCBkYXRhICk7CgoJCWliLm1lc2hQZXJBdHRyaWJ1dGUgPSB0aGlzLm1lc2hQZXJBdHRyaWJ1dGU7CgoJCXJldHVybiBpYjsKCgl9CgoJdG9KU09OKCBkYXRhICkgewoKCQljb25zdCBqc29uID0gc3VwZXIudG9KU09OKCBkYXRhICk7CgoJCWpzb24uaXNJbnN0YW5jZWRJbnRlcmxlYXZlZEJ1ZmZlciA9IHRydWU7CgkJanNvbi5tZXNoUGVyQXR0cmlidXRlID0gdGhpcy5tZXNoUGVyQXR0cmlidXRlOwoKCQlyZXR1cm4ganNvbjsKCgl9Cgp9CgpjbGFzcyBHTEJ1ZmZlckF0dHJpYnV0ZSB7CgoJY29uc3RydWN0b3IoIGJ1ZmZlciwgdHlwZSwgaXRlbVNpemUsIGVsZW1lbnRTaXplLCBjb3VudCApIHsKCgkJdGhpcy5pc0dMQnVmZmVyQXR0cmlidXRlID0gdHJ1ZTsKCgkJdGhpcy5uYW1lID0gJyc7CgoJCXRoaXMuYnVmZmVyID0gYnVmZmVyOwoJCXRoaXMudHlwZSA9IHR5cGU7CgkJdGhpcy5pdGVtU2l6ZSA9IGl0ZW1TaXplOwoJCXRoaXMuZWxlbWVudFNpemUgPSBlbGVtZW50U2l6ZTsKCQl0aGlzLmNvdW50ID0gY291bnQ7CgoJCXRoaXMudmVyc2lvbiA9IDA7CgoJfQoKCXNldCBuZWVkc1VwZGF0ZSggdmFsdWUgKSB7CgoJCWlmICggdmFsdWUgPT09IHRydWUgKSB0aGlzLnZlcnNpb24gKys7CgoJfQoKCXNldEJ1ZmZlciggYnVmZmVyICkgewoKCQl0aGlzLmJ1ZmZlciA9IGJ1ZmZlcjsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldFR5cGUoIHR5cGUsIGVsZW1lbnRTaXplICkgewoKCQl0aGlzLnR5cGUgPSB0eXBlOwoJCXRoaXMuZWxlbWVudFNpemUgPSBlbGVtZW50U2l6ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEl0ZW1TaXplKCBpdGVtU2l6ZSApIHsKCgkJdGhpcy5pdGVtU2l6ZSA9IGl0ZW1TaXplOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0Q291bnQoIGNvdW50ICkgewoKCQl0aGlzLmNvdW50ID0gY291bnQ7CgoJCXJldHVybiB0aGlzOwoKCX0KCn0KCmNsYXNzIFJheWNhc3RlciB7CgoJY29uc3RydWN0b3IoIG9yaWdpbiwgZGlyZWN0aW9uLCBuZWFyID0gMCwgZmFyID0gSW5maW5pdHkgKSB7CgoJCXRoaXMucmF5ID0gbmV3IFJheSggb3JpZ2luLCBkaXJlY3Rpb24gKTsKCQkvLyBkaXJlY3Rpb24gaXMgYXNzdW1lZCB0byBiZSBub3JtYWxpemVkIChmb3IgYWNjdXJhdGUgZGlzdGFuY2UgY2FsY3VsYXRpb25zKQoKCQl0aGlzLm5lYXIgPSBuZWFyOwoJCXRoaXMuZmFyID0gZmFyOwoJCXRoaXMuY2FtZXJhID0gbnVsbDsKCQl0aGlzLmxheWVycyA9IG5ldyBMYXllcnMoKTsKCgkJdGhpcy5wYXJhbXMgPSB7CgkJCU1lc2g6IHt9LAoJCQlMaW5lOiB7IHRocmVzaG9sZDogMSB9LAoJCQlMT0Q6IHt9LAoJCQlQb2ludHM6IHsgdGhyZXNob2xkOiAxIH0sCgkJCVNwcml0ZToge30KCQl9OwoKCX0KCglzZXQoIG9yaWdpbiwgZGlyZWN0aW9uICkgewoKCQkvLyBkaXJlY3Rpb24gaXMgYXNzdW1lZCB0byBiZSBub3JtYWxpemVkIChmb3IgYWNjdXJhdGUgZGlzdGFuY2UgY2FsY3VsYXRpb25zKQoKCQl0aGlzLnJheS5zZXQoIG9yaWdpbiwgZGlyZWN0aW9uICk7CgoJfQoKCXNldEZyb21DYW1lcmEoIGNvb3JkcywgY2FtZXJhICkgewoKCQlpZiAoIGNhbWVyYS5pc1BlcnNwZWN0aXZlQ2FtZXJhICkgewoKCQkJdGhpcy5yYXkub3JpZ2luLnNldEZyb21NYXRyaXhQb3NpdGlvbiggY2FtZXJhLm1hdHJpeFdvcmxkICk7CgkJCXRoaXMucmF5LmRpcmVjdGlvbi5zZXQoIGNvb3Jkcy54LCBjb29yZHMueSwgMC41ICkudW5wcm9qZWN0KCBjYW1lcmEgKS5zdWIoIHRoaXMucmF5Lm9yaWdpbiApLm5vcm1hbGl6ZSgpOwoJCQl0aGlzLmNhbWVyYSA9IGNhbWVyYTsKCgkJfSBlbHNlIGlmICggY2FtZXJhLmlzT3J0aG9ncmFwaGljQ2FtZXJhICkgewoKCQkJdGhpcy5yYXkub3JpZ2luLnNldCggY29vcmRzLngsIGNvb3Jkcy55LCAoIGNhbWVyYS5uZWFyICsgY2FtZXJhLmZhciApIC8gKCBjYW1lcmEubmVhciAtIGNhbWVyYS5mYXIgKSApLnVucHJvamVjdCggY2FtZXJhICk7IC8vIHNldCBvcmlnaW4gaW4gcGxhbmUgb2YgY2FtZXJhCgkJCXRoaXMucmF5LmRpcmVjdGlvbi5zZXQoIDAsIDAsIC0gMSApLnRyYW5zZm9ybURpcmVjdGlvbiggY2FtZXJhLm1hdHJpeFdvcmxkICk7CgkJCXRoaXMuY2FtZXJhID0gY2FtZXJhOwoKCQl9IGVsc2UgewoKCQkJY29uc29sZS5lcnJvciggJ1RIUkVFLlJheWNhc3RlcjogVW5zdXBwb3J0ZWQgY2FtZXJhIHR5cGU6ICcgKyBjYW1lcmEudHlwZSApOwoKCQl9CgoJfQoKCWludGVyc2VjdE9iamVjdCggb2JqZWN0LCByZWN1cnNpdmUgPSB0cnVlLCBpbnRlcnNlY3RzID0gW10gKSB7CgoJCWludGVyc2VjdE9iamVjdCggb2JqZWN0LCB0aGlzLCBpbnRlcnNlY3RzLCByZWN1cnNpdmUgKTsKCgkJaW50ZXJzZWN0cy5zb3J0KCBhc2NTb3J0ICk7CgoJCXJldHVybiBpbnRlcnNlY3RzOwoKCX0KCglpbnRlcnNlY3RPYmplY3RzKCBvYmplY3RzLCByZWN1cnNpdmUgPSB0cnVlLCBpbnRlcnNlY3RzID0gW10gKSB7CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IG9iamVjdHMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCWludGVyc2VjdE9iamVjdCggb2JqZWN0c1sgaSBdLCB0aGlzLCBpbnRlcnNlY3RzLCByZWN1cnNpdmUgKTsKCgkJfQoKCQlpbnRlcnNlY3RzLnNvcnQoIGFzY1NvcnQgKTsKCgkJcmV0dXJuIGludGVyc2VjdHM7CgoJfQoKfQoKZnVuY3Rpb24gYXNjU29ydCggYSwgYiApIHsKCglyZXR1cm4gYS5kaXN0YW5jZSAtIGIuZGlzdGFuY2U7Cgp9CgpmdW5jdGlvbiBpbnRlcnNlY3RPYmplY3QoIG9iamVjdCwgcmF5Y2FzdGVyLCBpbnRlcnNlY3RzLCByZWN1cnNpdmUgKSB7CgoJaWYgKCBvYmplY3QubGF5ZXJzLnRlc3QoIHJheWNhc3Rlci5sYXllcnMgKSApIHsKCgkJb2JqZWN0LnJheWNhc3QoIHJheWNhc3RlciwgaW50ZXJzZWN0cyApOwoKCX0KCglpZiAoIHJlY3Vyc2l2ZSA9PT0gdHJ1ZSApIHsKCgkJY29uc3QgY2hpbGRyZW4gPSBvYmplY3QuY2hpbGRyZW47CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQlpbnRlcnNlY3RPYmplY3QoIGNoaWxkcmVuWyBpIF0sIHJheWNhc3RlciwgaW50ZXJzZWN0cywgdHJ1ZSApOwoKCQl9CgoJfQoKfQoKLyoqCiAqIFJlZjogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3BoZXJpY2FsX2Nvb3JkaW5hdGVfc3lzdGVtCiAqCiAqIFRoZSBwb2xhciBhbmdsZSAocGhpKSBpcyBtZWFzdXJlZCBmcm9tIHRoZSBwb3NpdGl2ZSB5LWF4aXMuIFRoZSBwb3NpdGl2ZSB5LWF4aXMgaXMgdXAuCiAqIFRoZSBhemltdXRoYWwgYW5nbGUgKHRoZXRhKSBpcyBtZWFzdXJlZCBmcm9tIHRoZSBwb3NpdGl2ZSB6LWF4aXMuCiAqLwoKCmNsYXNzIFNwaGVyaWNhbCB7CgoJY29uc3RydWN0b3IoIHJhZGl1cyA9IDEsIHBoaSA9IDAsIHRoZXRhID0gMCApIHsKCgkJdGhpcy5yYWRpdXMgPSByYWRpdXM7CgkJdGhpcy5waGkgPSBwaGk7IC8vIHBvbGFyIGFuZ2xlCgkJdGhpcy50aGV0YSA9IHRoZXRhOyAvLyBhemltdXRoYWwgYW5nbGUKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldCggcmFkaXVzLCBwaGksIHRoZXRhICkgewoKCQl0aGlzLnJhZGl1cyA9IHJhZGl1czsKCQl0aGlzLnBoaSA9IHBoaTsKCQl0aGlzLnRoZXRhID0gdGhldGE7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb3B5KCBvdGhlciApIHsKCgkJdGhpcy5yYWRpdXMgPSBvdGhlci5yYWRpdXM7CgkJdGhpcy5waGkgPSBvdGhlci5waGk7CgkJdGhpcy50aGV0YSA9IG90aGVyLnRoZXRhOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJLy8gcmVzdHJpY3QgcGhpIHRvIGJlIGJldHdlZW4gRVBTIGFuZCBQSS1FUFMKCW1ha2VTYWZlKCkgewoKCQljb25zdCBFUFMgPSAwLjAwMDAwMTsKCQl0aGlzLnBoaSA9IE1hdGgubWF4KCBFUFMsIE1hdGgubWluKCBNYXRoLlBJIC0gRVBTLCB0aGlzLnBoaSApICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tVmVjdG9yMyggdiApIHsKCgkJcmV0dXJuIHRoaXMuc2V0RnJvbUNhcnRlc2lhbkNvb3Jkcyggdi54LCB2LnksIHYueiApOwoKCX0KCglzZXRGcm9tQ2FydGVzaWFuQ29vcmRzKCB4LCB5LCB6ICkgewoKCQl0aGlzLnJhZGl1cyA9IE1hdGguc3FydCggeCAqIHggKyB5ICogeSArIHogKiB6ICk7CgoJCWlmICggdGhpcy5yYWRpdXMgPT09IDAgKSB7CgoJCQl0aGlzLnRoZXRhID0gMDsKCQkJdGhpcy5waGkgPSAwOwoKCQl9IGVsc2UgewoKCQkJdGhpcy50aGV0YSA9IE1hdGguYXRhbjIoIHgsIHogKTsKCQkJdGhpcy5waGkgPSBNYXRoLmFjb3MoIGNsYW1wKCB5IC8gdGhpcy5yYWRpdXMsIC0gMSwgMSApICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KCB0aGlzICk7CgoJfQoKfQoKLyoqCiAqIFJlZjogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3lsaW5kcmljYWxfY29vcmRpbmF0ZV9zeXN0ZW0KICovCgpjbGFzcyBDeWxpbmRyaWNhbCB7CgoJY29uc3RydWN0b3IoIHJhZGl1cyA9IDEsIHRoZXRhID0gMCwgeSA9IDAgKSB7CgoJCXRoaXMucmFkaXVzID0gcmFkaXVzOyAvLyBkaXN0YW5jZSBmcm9tIHRoZSBvcmlnaW4gdG8gYSBwb2ludCBpbiB0aGUgeC16IHBsYW5lCgkJdGhpcy50aGV0YSA9IHRoZXRhOyAvLyBjb3VudGVyY2xvY2t3aXNlIGFuZ2xlIGluIHRoZSB4LXogcGxhbmUgbWVhc3VyZWQgaW4gcmFkaWFucyBmcm9tIHRoZSBwb3NpdGl2ZSB6LWF4aXMKCQl0aGlzLnkgPSB5OyAvLyBoZWlnaHQgYWJvdmUgdGhlIHgteiBwbGFuZQoKCQlyZXR1cm4gdGhpczsKCgl9CgoJc2V0KCByYWRpdXMsIHRoZXRhLCB5ICkgewoKCQl0aGlzLnJhZGl1cyA9IHJhZGl1czsKCQl0aGlzLnRoZXRhID0gdGhldGE7CgkJdGhpcy55ID0geTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNvcHkoIG90aGVyICkgewoKCQl0aGlzLnJhZGl1cyA9IG90aGVyLnJhZGl1czsKCQl0aGlzLnRoZXRhID0gb3RoZXIudGhldGE7CgkJdGhpcy55ID0gb3RoZXIueTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEZyb21WZWN0b3IzKCB2ICkgewoKCQlyZXR1cm4gdGhpcy5zZXRGcm9tQ2FydGVzaWFuQ29vcmRzKCB2LngsIHYueSwgdi56ICk7CgoJfQoKCXNldEZyb21DYXJ0ZXNpYW5Db29yZHMoIHgsIHksIHogKSB7CgoJCXRoaXMucmFkaXVzID0gTWF0aC5zcXJ0KCB4ICogeCArIHogKiB6ICk7CgkJdGhpcy50aGV0YSA9IE1hdGguYXRhbjIoIHgsIHogKTsKCQl0aGlzLnkgPSB5OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJY2xvbmUoKSB7CgoJCXJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLmNvcHkoIHRoaXMgKTsKCgl9Cgp9Cgpjb25zdCBfdmVjdG9yJDQgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IyKCk7CgpjbGFzcyBCb3gyIHsKCgljb25zdHJ1Y3RvciggbWluID0gbmV3IFZlY3RvcjIoICsgSW5maW5pdHksICsgSW5maW5pdHkgKSwgbWF4ID0gbmV3IFZlY3RvcjIoIC0gSW5maW5pdHksIC0gSW5maW5pdHkgKSApIHsKCgkJdGhpcy5pc0JveDIgPSB0cnVlOwoKCQl0aGlzLm1pbiA9IG1pbjsKCQl0aGlzLm1heCA9IG1heDsKCgl9CgoJc2V0KCBtaW4sIG1heCApIHsKCgkJdGhpcy5taW4uY29weSggbWluICk7CgkJdGhpcy5tYXguY29weSggbWF4ICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzZXRGcm9tUG9pbnRzKCBwb2ludHMgKSB7CgoJCXRoaXMubWFrZUVtcHR5KCk7CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSBwb2ludHMubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQl0aGlzLmV4cGFuZEJ5UG9pbnQoIHBvaW50c1sgaSBdICk7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXNldEZyb21DZW50ZXJBbmRTaXplKCBjZW50ZXIsIHNpemUgKSB7CgoJCWNvbnN0IGhhbGZTaXplID0gX3ZlY3RvciQ0LmNvcHkoIHNpemUgKS5tdWx0aXBseVNjYWxhciggMC41ICk7CgkJdGhpcy5taW4uY29weSggY2VudGVyICkuc3ViKCBoYWxmU2l6ZSApOwoJCXRoaXMubWF4LmNvcHkoIGNlbnRlciApLmFkZCggaGFsZlNpemUgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KCB0aGlzICk7CgoJfQoKCWNvcHkoIGJveCApIHsKCgkJdGhpcy5taW4uY29weSggYm94Lm1pbiApOwoJCXRoaXMubWF4LmNvcHkoIGJveC5tYXggKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCW1ha2VFbXB0eSgpIHsKCgkJdGhpcy5taW4ueCA9IHRoaXMubWluLnkgPSArIEluZmluaXR5OwoJCXRoaXMubWF4LnggPSB0aGlzLm1heC55ID0gLSBJbmZpbml0eTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWlzRW1wdHkoKSB7CgoJCS8vIHRoaXMgaXMgYSBtb3JlIHJvYnVzdCBjaGVjayBmb3IgZW1wdHkgdGhhbiAoIHZvbHVtZSA8PSAwICkgYmVjYXVzZSB2b2x1bWUgY2FuIGdldCBwb3NpdGl2ZSB3aXRoIHR3byBuZWdhdGl2ZSBheGVzCgoJCXJldHVybiAoIHRoaXMubWF4LnggPCB0aGlzLm1pbi54ICkgfHwgKCB0aGlzLm1heC55IDwgdGhpcy5taW4ueSApOwoKCX0KCglnZXRDZW50ZXIoIHRhcmdldCApIHsKCgkJcmV0dXJuIHRoaXMuaXNFbXB0eSgpID8gdGFyZ2V0LnNldCggMCwgMCApIDogdGFyZ2V0LmFkZFZlY3RvcnMoIHRoaXMubWluLCB0aGlzLm1heCApLm11bHRpcGx5U2NhbGFyKCAwLjUgKTsKCgl9CgoJZ2V0U2l6ZSggdGFyZ2V0ICkgewoKCQlyZXR1cm4gdGhpcy5pc0VtcHR5KCkgPyB0YXJnZXQuc2V0KCAwLCAwICkgOiB0YXJnZXQuc3ViVmVjdG9ycyggdGhpcy5tYXgsIHRoaXMubWluICk7CgoJfQoKCWV4cGFuZEJ5UG9pbnQoIHBvaW50ICkgewoKCQl0aGlzLm1pbi5taW4oIHBvaW50ICk7CgkJdGhpcy5tYXgubWF4KCBwb2ludCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXhwYW5kQnlWZWN0b3IoIHZlY3RvciApIHsKCgkJdGhpcy5taW4uc3ViKCB2ZWN0b3IgKTsKCQl0aGlzLm1heC5hZGQoIHZlY3RvciApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXhwYW5kQnlTY2FsYXIoIHNjYWxhciApIHsKCgkJdGhpcy5taW4uYWRkU2NhbGFyKCAtIHNjYWxhciApOwoJCXRoaXMubWF4LmFkZFNjYWxhciggc2NhbGFyICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb250YWluc1BvaW50KCBwb2ludCApIHsKCgkJcmV0dXJuIHBvaW50LnggPCB0aGlzLm1pbi54IHx8IHBvaW50LnggPiB0aGlzLm1heC54IHx8CgkJCXBvaW50LnkgPCB0aGlzLm1pbi55IHx8IHBvaW50LnkgPiB0aGlzLm1heC55ID8gZmFsc2UgOiB0cnVlOwoKCX0KCgljb250YWluc0JveCggYm94ICkgewoKCQlyZXR1cm4gdGhpcy5taW4ueCA8PSBib3gubWluLnggJiYgYm94Lm1heC54IDw9IHRoaXMubWF4LnggJiYKCQkJdGhpcy5taW4ueSA8PSBib3gubWluLnkgJiYgYm94Lm1heC55IDw9IHRoaXMubWF4Lnk7CgoJfQoKCWdldFBhcmFtZXRlciggcG9pbnQsIHRhcmdldCApIHsKCgkJLy8gVGhpcyBjYW4gcG90ZW50aWFsbHkgaGF2ZSBhIGRpdmlkZSBieSB6ZXJvIGlmIHRoZSBib3gKCQkvLyBoYXMgYSBzaXplIGRpbWVuc2lvbiBvZiAwLgoKCQlyZXR1cm4gdGFyZ2V0LnNldCgKCQkJKCBwb2ludC54IC0gdGhpcy5taW4ueCApIC8gKCB0aGlzLm1heC54IC0gdGhpcy5taW4ueCApLAoJCQkoIHBvaW50LnkgLSB0aGlzLm1pbi55ICkgLyAoIHRoaXMubWF4LnkgLSB0aGlzLm1pbi55ICkKCQkpOwoKCX0KCglpbnRlcnNlY3RzQm94KCBib3ggKSB7CgoJCS8vIHVzaW5nIDQgc3BsaXR0aW5nIHBsYW5lcyB0byBydWxlIG91dCBpbnRlcnNlY3Rpb25zCgoJCXJldHVybiBib3gubWF4LnggPCB0aGlzLm1pbi54IHx8IGJveC5taW4ueCA+IHRoaXMubWF4LnggfHwKCQkJYm94Lm1heC55IDwgdGhpcy5taW4ueSB8fCBib3gubWluLnkgPiB0aGlzLm1heC55ID8gZmFsc2UgOiB0cnVlOwoKCX0KCgljbGFtcFBvaW50KCBwb2ludCwgdGFyZ2V0ICkgewoKCQlyZXR1cm4gdGFyZ2V0LmNvcHkoIHBvaW50ICkuY2xhbXAoIHRoaXMubWluLCB0aGlzLm1heCApOwoKCX0KCglkaXN0YW5jZVRvUG9pbnQoIHBvaW50ICkgewoKCQlyZXR1cm4gdGhpcy5jbGFtcFBvaW50KCBwb2ludCwgX3ZlY3RvciQ0ICkuZGlzdGFuY2VUbyggcG9pbnQgKTsKCgl9CgoJaW50ZXJzZWN0KCBib3ggKSB7CgoJCXRoaXMubWluLm1heCggYm94Lm1pbiApOwoJCXRoaXMubWF4Lm1pbiggYm94Lm1heCApOwoKCQlpZiAoIHRoaXMuaXNFbXB0eSgpICkgdGhpcy5tYWtlRW1wdHkoKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCXVuaW9uKCBib3ggKSB7CgoJCXRoaXMubWluLm1pbiggYm94Lm1pbiApOwoJCXRoaXMubWF4Lm1heCggYm94Lm1heCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJdHJhbnNsYXRlKCBvZmZzZXQgKSB7CgoJCXRoaXMubWluLmFkZCggb2Zmc2V0ICk7CgkJdGhpcy5tYXguYWRkKCBvZmZzZXQgKTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWVxdWFscyggYm94ICkgewoKCQlyZXR1cm4gYm94Lm1pbi5lcXVhbHMoIHRoaXMubWluICkgJiYgYm94Lm1heC5lcXVhbHMoIHRoaXMubWF4ICk7CgoJfQoKfQoKY29uc3QgX3N0YXJ0UCA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX3N0YXJ0RW5kID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwoKY2xhc3MgTGluZTMgewoKCWNvbnN0cnVjdG9yKCBzdGFydCA9IG5ldyBWZWN0b3IzKCksIGVuZCA9IG5ldyBWZWN0b3IzKCkgKSB7CgoJCXRoaXMuc3RhcnQgPSBzdGFydDsKCQl0aGlzLmVuZCA9IGVuZDsKCgl9CgoJc2V0KCBzdGFydCwgZW5kICkgewoKCQl0aGlzLnN0YXJ0LmNvcHkoIHN0YXJ0ICk7CgkJdGhpcy5lbmQuY29weSggZW5kICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb3B5KCBsaW5lICkgewoKCQl0aGlzLnN0YXJ0LmNvcHkoIGxpbmUuc3RhcnQgKTsKCQl0aGlzLmVuZC5jb3B5KCBsaW5lLmVuZCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZ2V0Q2VudGVyKCB0YXJnZXQgKSB7CgoJCXJldHVybiB0YXJnZXQuYWRkVmVjdG9ycyggdGhpcy5zdGFydCwgdGhpcy5lbmQgKS5tdWx0aXBseVNjYWxhciggMC41ICk7CgoJfQoKCWRlbHRhKCB0YXJnZXQgKSB7CgoJCXJldHVybiB0YXJnZXQuc3ViVmVjdG9ycyggdGhpcy5lbmQsIHRoaXMuc3RhcnQgKTsKCgl9CgoJZGlzdGFuY2VTcSgpIHsKCgkJcmV0dXJuIHRoaXMuc3RhcnQuZGlzdGFuY2VUb1NxdWFyZWQoIHRoaXMuZW5kICk7CgoJfQoKCWRpc3RhbmNlKCkgewoKCQlyZXR1cm4gdGhpcy5zdGFydC5kaXN0YW5jZVRvKCB0aGlzLmVuZCApOwoKCX0KCglhdCggdCwgdGFyZ2V0ICkgewoKCQlyZXR1cm4gdGhpcy5kZWx0YSggdGFyZ2V0ICkubXVsdGlwbHlTY2FsYXIoIHQgKS5hZGQoIHRoaXMuc3RhcnQgKTsKCgl9CgoJY2xvc2VzdFBvaW50VG9Qb2ludFBhcmFtZXRlciggcG9pbnQsIGNsYW1wVG9MaW5lICkgewoKCQlfc3RhcnRQLnN1YlZlY3RvcnMoIHBvaW50LCB0aGlzLnN0YXJ0ICk7CgkJX3N0YXJ0RW5kLnN1YlZlY3RvcnMoIHRoaXMuZW5kLCB0aGlzLnN0YXJ0ICk7CgoJCWNvbnN0IHN0YXJ0RW5kMiA9IF9zdGFydEVuZC5kb3QoIF9zdGFydEVuZCApOwoJCWNvbnN0IHN0YXJ0RW5kX3N0YXJ0UCA9IF9zdGFydEVuZC5kb3QoIF9zdGFydFAgKTsKCgkJbGV0IHQgPSBzdGFydEVuZF9zdGFydFAgLyBzdGFydEVuZDI7CgoJCWlmICggY2xhbXBUb0xpbmUgKSB7CgoJCQl0ID0gY2xhbXAoIHQsIDAsIDEgKTsKCgkJfQoKCQlyZXR1cm4gdDsKCgl9CgoJY2xvc2VzdFBvaW50VG9Qb2ludCggcG9pbnQsIGNsYW1wVG9MaW5lLCB0YXJnZXQgKSB7CgoJCWNvbnN0IHQgPSB0aGlzLmNsb3Nlc3RQb2ludFRvUG9pbnRQYXJhbWV0ZXIoIHBvaW50LCBjbGFtcFRvTGluZSApOwoKCQlyZXR1cm4gdGhpcy5kZWx0YSggdGFyZ2V0ICkubXVsdGlwbHlTY2FsYXIoIHQgKS5hZGQoIHRoaXMuc3RhcnQgKTsKCgl9CgoJYXBwbHlNYXRyaXg0KCBtYXRyaXggKSB7CgoJCXRoaXMuc3RhcnQuYXBwbHlNYXRyaXg0KCBtYXRyaXggKTsKCQl0aGlzLmVuZC5hcHBseU1hdHJpeDQoIG1hdHJpeCApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZXF1YWxzKCBsaW5lICkgewoKCQlyZXR1cm4gbGluZS5zdGFydC5lcXVhbHMoIHRoaXMuc3RhcnQgKSAmJiBsaW5lLmVuZC5lcXVhbHMoIHRoaXMuZW5kICk7CgoJfQoKCWNsb25lKCkgewoKCQlyZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoKS5jb3B5KCB0aGlzICk7CgoJfQoKfQoKY29uc3QgX3ZlY3RvciQzID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwoKY2xhc3MgU3BvdExpZ2h0SGVscGVyIGV4dGVuZHMgT2JqZWN0M0QgewoKCWNvbnN0cnVjdG9yKCBsaWdodCwgY29sb3IgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMubGlnaHQgPSBsaWdodDsKCgkJdGhpcy5tYXRyaXggPSBsaWdodC5tYXRyaXhXb3JsZDsKCQl0aGlzLm1hdHJpeEF1dG9VcGRhdGUgPSBmYWxzZTsKCgkJdGhpcy5jb2xvciA9IGNvbG9yOwoKCQl0aGlzLnR5cGUgPSAnU3BvdExpZ2h0SGVscGVyJzsKCgkJY29uc3QgZ2VvbWV0cnkgPSBuZXcgQnVmZmVyR2VvbWV0cnkoKTsKCgkJY29uc3QgcG9zaXRpb25zID0gWwoJCQkwLCAwLCAwLCAJMCwgMCwgMSwKCQkJMCwgMCwgMCwgCTEsIDAsIDEsCgkJCTAsIDAsIDAsCS0gMSwgMCwgMSwKCQkJMCwgMCwgMCwgCTAsIDEsIDEsCgkJCTAsIDAsIDAsIAkwLCAtIDEsIDEKCQldOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGogPSAxLCBsID0gMzI7IGkgPCBsOyBpICsrLCBqICsrICkgewoKCQkJY29uc3QgcDEgPSAoIGkgLyBsICkgKiBNYXRoLlBJICogMjsKCQkJY29uc3QgcDIgPSAoIGogLyBsICkgKiBNYXRoLlBJICogMjsKCgkJCXBvc2l0aW9ucy5wdXNoKAoJCQkJTWF0aC5jb3MoIHAxICksIE1hdGguc2luKCBwMSApLCAxLAoJCQkJTWF0aC5jb3MoIHAyICksIE1hdGguc2luKCBwMiApLCAxCgkJCSk7CgoJCX0KCgkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb25zLCAzICkgKTsKCgkJY29uc3QgbWF0ZXJpYWwgPSBuZXcgTGluZUJhc2ljTWF0ZXJpYWwoIHsgZm9nOiBmYWxzZSwgdG9uZU1hcHBlZDogZmFsc2UgfSApOwoKCQl0aGlzLmNvbmUgPSBuZXcgTGluZVNlZ21lbnRzKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTsKCQl0aGlzLmFkZCggdGhpcy5jb25lICk7CgoJCXRoaXMudXBkYXRlKCk7CgoJfQoKCWRpc3Bvc2UoKSB7CgoJCXRoaXMuY29uZS5nZW9tZXRyeS5kaXNwb3NlKCk7CgkJdGhpcy5jb25lLm1hdGVyaWFsLmRpc3Bvc2UoKTsKCgl9CgoJdXBkYXRlKCkgewoKCQl0aGlzLmxpZ2h0LnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoJCXRoaXMubGlnaHQudGFyZ2V0LnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoKCQljb25zdCBjb25lTGVuZ3RoID0gdGhpcy5saWdodC5kaXN0YW5jZSA/IHRoaXMubGlnaHQuZGlzdGFuY2UgOiAxMDAwOwoJCWNvbnN0IGNvbmVXaWR0aCA9IGNvbmVMZW5ndGggKiBNYXRoLnRhbiggdGhpcy5saWdodC5hbmdsZSApOwoKCQl0aGlzLmNvbmUuc2NhbGUuc2V0KCBjb25lV2lkdGgsIGNvbmVXaWR0aCwgY29uZUxlbmd0aCApOwoKCQlfdmVjdG9yJDMuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCB0aGlzLmxpZ2h0LnRhcmdldC5tYXRyaXhXb3JsZCApOwoKCQl0aGlzLmNvbmUubG9va0F0KCBfdmVjdG9yJDMgKTsKCgkJaWYgKCB0aGlzLmNvbG9yICE9PSB1bmRlZmluZWQgKSB7CgoJCQl0aGlzLmNvbmUubWF0ZXJpYWwuY29sb3Iuc2V0KCB0aGlzLmNvbG9yICk7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLmNvbmUubWF0ZXJpYWwuY29sb3IuY29weSggdGhpcy5saWdodC5jb2xvciApOwoKCQl9CgoJfQoKfQoKY29uc3QgX3ZlY3RvciQyID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfYm9uZU1hdHJpeCA9IC8qQF9fUFVSRV9fKi8gbmV3IE1hdHJpeDQoKTsKY29uc3QgX21hdHJpeFdvcmxkSW52ID0gLypAX19QVVJFX18qLyBuZXcgTWF0cml4NCgpOwoKCmNsYXNzIFNrZWxldG9uSGVscGVyIGV4dGVuZHMgTGluZVNlZ21lbnRzIHsKCgljb25zdHJ1Y3Rvciggb2JqZWN0ICkgewoKCQljb25zdCBib25lcyA9IGdldEJvbmVMaXN0KCBvYmplY3QgKTsKCgkJY29uc3QgZ2VvbWV0cnkgPSBuZXcgQnVmZmVyR2VvbWV0cnkoKTsKCgkJY29uc3QgdmVydGljZXMgPSBbXTsKCQljb25zdCBjb2xvcnMgPSBbXTsKCgkJY29uc3QgY29sb3IxID0gbmV3IENvbG9yKCAwLCAwLCAxICk7CgkJY29uc3QgY29sb3IyID0gbmV3IENvbG9yKCAwLCAxLCAwICk7CgoJCWZvciAoIGxldCBpID0gMDsgaSA8IGJvbmVzLmxlbmd0aDsgaSArKyApIHsKCgkJCWNvbnN0IGJvbmUgPSBib25lc1sgaSBdOwoKCQkJaWYgKCBib25lLnBhcmVudCAmJiBib25lLnBhcmVudC5pc0JvbmUgKSB7CgoJCQkJdmVydGljZXMucHVzaCggMCwgMCwgMCApOwoJCQkJdmVydGljZXMucHVzaCggMCwgMCwgMCApOwoJCQkJY29sb3JzLnB1c2goIGNvbG9yMS5yLCBjb2xvcjEuZywgY29sb3IxLmIgKTsKCQkJCWNvbG9ycy5wdXNoKCBjb2xvcjIuciwgY29sb3IyLmcsIGNvbG9yMi5iICk7CgoJCQl9CgoJCX0KCgkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdmVydGljZXMsIDMgKSApOwoJCWdlb21ldHJ5LnNldEF0dHJpYnV0ZSggJ2NvbG9yJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIGNvbG9ycywgMyApICk7CgoJCWNvbnN0IG1hdGVyaWFsID0gbmV3IExpbmVCYXNpY01hdGVyaWFsKCB7IHZlcnRleENvbG9yczogdHJ1ZSwgZGVwdGhUZXN0OiBmYWxzZSwgZGVwdGhXcml0ZTogZmFsc2UsIHRvbmVNYXBwZWQ6IGZhbHNlLCB0cmFuc3BhcmVudDogdHJ1ZSB9ICk7CgoJCXN1cGVyKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTsKCgkJdGhpcy5pc1NrZWxldG9uSGVscGVyID0gdHJ1ZTsKCgkJdGhpcy50eXBlID0gJ1NrZWxldG9uSGVscGVyJzsKCgkJdGhpcy5yb290ID0gb2JqZWN0OwoJCXRoaXMuYm9uZXMgPSBib25lczsKCgkJdGhpcy5tYXRyaXggPSBvYmplY3QubWF0cml4V29ybGQ7CgkJdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gZmFsc2U7CgoJfQoKCXVwZGF0ZU1hdHJpeFdvcmxkKCBmb3JjZSApIHsKCgkJY29uc3QgYm9uZXMgPSB0aGlzLmJvbmVzOwoKCQljb25zdCBnZW9tZXRyeSA9IHRoaXMuZ2VvbWV0cnk7CgkJY29uc3QgcG9zaXRpb24gPSBnZW9tZXRyeS5nZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicgKTsKCgkJX21hdHJpeFdvcmxkSW52LmNvcHkoIHRoaXMucm9vdC5tYXRyaXhXb3JsZCApLmludmVydCgpOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGogPSAwOyBpIDwgYm9uZXMubGVuZ3RoOyBpICsrICkgewoKCQkJY29uc3QgYm9uZSA9IGJvbmVzWyBpIF07CgoJCQlpZiAoIGJvbmUucGFyZW50ICYmIGJvbmUucGFyZW50LmlzQm9uZSApIHsKCgkJCQlfYm9uZU1hdHJpeC5tdWx0aXBseU1hdHJpY2VzKCBfbWF0cml4V29ybGRJbnYsIGJvbmUubWF0cml4V29ybGQgKTsKCQkJCV92ZWN0b3IkMi5zZXRGcm9tTWF0cml4UG9zaXRpb24oIF9ib25lTWF0cml4ICk7CgkJCQlwb3NpdGlvbi5zZXRYWVooIGosIF92ZWN0b3IkMi54LCBfdmVjdG9yJDIueSwgX3ZlY3RvciQyLnogKTsKCgkJCQlfYm9uZU1hdHJpeC5tdWx0aXBseU1hdHJpY2VzKCBfbWF0cml4V29ybGRJbnYsIGJvbmUucGFyZW50Lm1hdHJpeFdvcmxkICk7CgkJCQlfdmVjdG9yJDIuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCBfYm9uZU1hdHJpeCApOwoJCQkJcG9zaXRpb24uc2V0WFlaKCBqICsgMSwgX3ZlY3RvciQyLngsIF92ZWN0b3IkMi55LCBfdmVjdG9yJDIueiApOwoKCQkJCWogKz0gMjsKCgkJCX0KCgkJfQoKCQlnZW9tZXRyeS5nZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicgKS5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJCXN1cGVyLnVwZGF0ZU1hdHJpeFdvcmxkKCBmb3JjZSApOwoKCX0KCglkaXNwb3NlKCkgewoKCQl0aGlzLmdlb21ldHJ5LmRpc3Bvc2UoKTsKCQl0aGlzLm1hdGVyaWFsLmRpc3Bvc2UoKTsKCgl9Cgp9CgoKZnVuY3Rpb24gZ2V0Qm9uZUxpc3QoIG9iamVjdCApIHsKCgljb25zdCBib25lTGlzdCA9IFtdOwoKCWlmICggb2JqZWN0LmlzQm9uZSA9PT0gdHJ1ZSApIHsKCgkJYm9uZUxpc3QucHVzaCggb2JqZWN0ICk7CgoJfQoKCWZvciAoIGxldCBpID0gMDsgaSA8IG9iamVjdC5jaGlsZHJlbi5sZW5ndGg7IGkgKysgKSB7CgoJCWJvbmVMaXN0LnB1c2guYXBwbHkoIGJvbmVMaXN0LCBnZXRCb25lTGlzdCggb2JqZWN0LmNoaWxkcmVuWyBpIF0gKSApOwoKCX0KCglyZXR1cm4gYm9uZUxpc3Q7Cgp9CgpjbGFzcyBQb2ludExpZ2h0SGVscGVyIGV4dGVuZHMgTWVzaCB7CgoJY29uc3RydWN0b3IoIGxpZ2h0LCBzcGhlcmVTaXplLCBjb2xvciApIHsKCgkJY29uc3QgZ2VvbWV0cnkgPSBuZXcgU3BoZXJlR2VvbWV0cnkoIHNwaGVyZVNpemUsIDQsIDIgKTsKCQljb25zdCBtYXRlcmlhbCA9IG5ldyBNZXNoQmFzaWNNYXRlcmlhbCggeyB3aXJlZnJhbWU6IHRydWUsIGZvZzogZmFsc2UsIHRvbmVNYXBwZWQ6IGZhbHNlIH0gKTsKCgkJc3VwZXIoIGdlb21ldHJ5LCBtYXRlcmlhbCApOwoKCQl0aGlzLmxpZ2h0ID0gbGlnaHQ7CgoJCXRoaXMuY29sb3IgPSBjb2xvcjsKCgkJdGhpcy50eXBlID0gJ1BvaW50TGlnaHRIZWxwZXInOwoKCQl0aGlzLm1hdHJpeCA9IHRoaXMubGlnaHQubWF0cml4V29ybGQ7CgkJdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gZmFsc2U7CgoJCXRoaXMudXBkYXRlKCk7CgoKCQkvKgoJLy8gVE9ETzogZGVsZXRlIHRoaXMgY29tbWVudD8KCWNvbnN0IGRpc3RhbmNlR2VvbWV0cnkgPSBuZXcgVEhSRUUuSWNvc2FoZWRyb25HZW9tZXRyeSggMSwgMiApOwoJY29uc3QgZGlzdGFuY2VNYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoQmFzaWNNYXRlcmlhbCggeyBjb2xvcjogaGV4Q29sb3IsIGZvZzogZmFsc2UsIHdpcmVmcmFtZTogdHJ1ZSwgb3BhY2l0eTogMC4xLCB0cmFuc3BhcmVudDogdHJ1ZSB9ICk7CgoJdGhpcy5saWdodFNwaGVyZSA9IG5ldyBUSFJFRS5NZXNoKCBidWxiR2VvbWV0cnksIGJ1bGJNYXRlcmlhbCApOwoJdGhpcy5saWdodERpc3RhbmNlID0gbmV3IFRIUkVFLk1lc2goIGRpc3RhbmNlR2VvbWV0cnksIGRpc3RhbmNlTWF0ZXJpYWwgKTsKCgljb25zdCBkID0gbGlnaHQuZGlzdGFuY2U7CgoJaWYgKCBkID09PSAwLjAgKSB7CgoJCXRoaXMubGlnaHREaXN0YW5jZS52aXNpYmxlID0gZmFsc2U7CgoJfSBlbHNlIHsKCgkJdGhpcy5saWdodERpc3RhbmNlLnNjYWxlLnNldCggZCwgZCwgZCApOwoKCX0KCgl0aGlzLmFkZCggdGhpcy5saWdodERpc3RhbmNlICk7CgkqLwoKCX0KCglkaXNwb3NlKCkgewoKCQl0aGlzLmdlb21ldHJ5LmRpc3Bvc2UoKTsKCQl0aGlzLm1hdGVyaWFsLmRpc3Bvc2UoKTsKCgl9CgoJdXBkYXRlKCkgewoKCQl0aGlzLmxpZ2h0LnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoKCQlpZiAoIHRoaXMuY29sb3IgIT09IHVuZGVmaW5lZCApIHsKCgkJCXRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0KCB0aGlzLmNvbG9yICk7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLm1hdGVyaWFsLmNvbG9yLmNvcHkoIHRoaXMubGlnaHQuY29sb3IgKTsKCgkJfQoKCQkvKgoJCWNvbnN0IGQgPSB0aGlzLmxpZ2h0LmRpc3RhbmNlOwoKCQlpZiAoIGQgPT09IDAuMCApIHsKCgkJCXRoaXMubGlnaHREaXN0YW5jZS52aXNpYmxlID0gZmFsc2U7CgoJCX0gZWxzZSB7CgoJCQl0aGlzLmxpZ2h0RGlzdGFuY2UudmlzaWJsZSA9IHRydWU7CgkJCXRoaXMubGlnaHREaXN0YW5jZS5zY2FsZS5zZXQoIGQsIGQsIGQgKTsKCgkJfQoJCSovCgoJfQoKfQoKY29uc3QgX3ZlY3RvciQxID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfY29sb3IxID0gLypAX19QVVJFX18qLyBuZXcgQ29sb3IoKTsKY29uc3QgX2NvbG9yMiA9IC8qQF9fUFVSRV9fKi8gbmV3IENvbG9yKCk7CgpjbGFzcyBIZW1pc3BoZXJlTGlnaHRIZWxwZXIgZXh0ZW5kcyBPYmplY3QzRCB7CgoJY29uc3RydWN0b3IoIGxpZ2h0LCBzaXplLCBjb2xvciApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5saWdodCA9IGxpZ2h0OwoKCQl0aGlzLm1hdHJpeCA9IGxpZ2h0Lm1hdHJpeFdvcmxkOwoJCXRoaXMubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwoKCQl0aGlzLmNvbG9yID0gY29sb3I7CgoJCXRoaXMudHlwZSA9ICdIZW1pc3BoZXJlTGlnaHRIZWxwZXInOwoKCQljb25zdCBnZW9tZXRyeSA9IG5ldyBPY3RhaGVkcm9uR2VvbWV0cnkoIHNpemUgKTsKCQlnZW9tZXRyeS5yb3RhdGVZKCBNYXRoLlBJICogMC41ICk7CgoJCXRoaXMubWF0ZXJpYWwgPSBuZXcgTWVzaEJhc2ljTWF0ZXJpYWwoIHsgd2lyZWZyYW1lOiB0cnVlLCBmb2c6IGZhbHNlLCB0b25lTWFwcGVkOiBmYWxzZSB9ICk7CgkJaWYgKCB0aGlzLmNvbG9yID09PSB1bmRlZmluZWQgKSB0aGlzLm1hdGVyaWFsLnZlcnRleENvbG9ycyA9IHRydWU7CgoJCWNvbnN0IHBvc2l0aW9uID0gZ2VvbWV0cnkuZ2V0QXR0cmlidXRlKCAncG9zaXRpb24nICk7CgkJY29uc3QgY29sb3JzID0gbmV3IEZsb2F0MzJBcnJheSggcG9zaXRpb24uY291bnQgKiAzICk7CgoJCWdlb21ldHJ5LnNldEF0dHJpYnV0ZSggJ2NvbG9yJywgbmV3IEJ1ZmZlckF0dHJpYnV0ZSggY29sb3JzLCAzICkgKTsKCgkJdGhpcy5hZGQoIG5ldyBNZXNoKCBnZW9tZXRyeSwgdGhpcy5tYXRlcmlhbCApICk7CgoJCXRoaXMudXBkYXRlKCk7CgoJfQoKCWRpc3Bvc2UoKSB7CgoJCXRoaXMuY2hpbGRyZW5bIDAgXS5nZW9tZXRyeS5kaXNwb3NlKCk7CgkJdGhpcy5jaGlsZHJlblsgMCBdLm1hdGVyaWFsLmRpc3Bvc2UoKTsKCgl9CgoJdXBkYXRlKCkgewoKCQljb25zdCBtZXNoID0gdGhpcy5jaGlsZHJlblsgMCBdOwoKCQlpZiAoIHRoaXMuY29sb3IgIT09IHVuZGVmaW5lZCApIHsKCgkJCXRoaXMubWF0ZXJpYWwuY29sb3Iuc2V0KCB0aGlzLmNvbG9yICk7CgoJCX0gZWxzZSB7CgoJCQljb25zdCBjb2xvcnMgPSBtZXNoLmdlb21ldHJ5LmdldEF0dHJpYnV0ZSggJ2NvbG9yJyApOwoKCQkJX2NvbG9yMS5jb3B5KCB0aGlzLmxpZ2h0LmNvbG9yICk7CgkJCV9jb2xvcjIuY29weSggdGhpcy5saWdodC5ncm91bmRDb2xvciApOwoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gY29sb3JzLmNvdW50OyBpIDwgbDsgaSArKyApIHsKCgkJCQljb25zdCBjb2xvciA9ICggaSA8ICggbCAvIDIgKSApID8gX2NvbG9yMSA6IF9jb2xvcjI7CgoJCQkJY29sb3JzLnNldFhZWiggaSwgY29sb3IuciwgY29sb3IuZywgY29sb3IuYiApOwoKCQkJfQoKCQkJY29sb3JzLm5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJfQoKCQl0aGlzLmxpZ2h0LnVwZGF0ZVdvcmxkTWF0cml4KCB0cnVlLCBmYWxzZSApOwoKCQltZXNoLmxvb2tBdCggX3ZlY3RvciQxLnNldEZyb21NYXRyaXhQb3NpdGlvbiggdGhpcy5saWdodC5tYXRyaXhXb3JsZCApLm5lZ2F0ZSgpICk7CgoJfQoKfQoKY2xhc3MgR3JpZEhlbHBlciBleHRlbmRzIExpbmVTZWdtZW50cyB7CgoJY29uc3RydWN0b3IoIHNpemUgPSAxMCwgZGl2aXNpb25zID0gMTAsIGNvbG9yMSA9IDB4NDQ0NDQ0LCBjb2xvcjIgPSAweDg4ODg4OCApIHsKCgkJY29sb3IxID0gbmV3IENvbG9yKCBjb2xvcjEgKTsKCQljb2xvcjIgPSBuZXcgQ29sb3IoIGNvbG9yMiApOwoKCQljb25zdCBjZW50ZXIgPSBkaXZpc2lvbnMgLyAyOwoJCWNvbnN0IHN0ZXAgPSBzaXplIC8gZGl2aXNpb25zOwoJCWNvbnN0IGhhbGZTaXplID0gc2l6ZSAvIDI7CgoJCWNvbnN0IHZlcnRpY2VzID0gW10sIGNvbG9ycyA9IFtdOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGogPSAwLCBrID0gLSBoYWxmU2l6ZTsgaSA8PSBkaXZpc2lvbnM7IGkgKyssIGsgKz0gc3RlcCApIHsKCgkJCXZlcnRpY2VzLnB1c2goIC0gaGFsZlNpemUsIDAsIGssIGhhbGZTaXplLCAwLCBrICk7CgkJCXZlcnRpY2VzLnB1c2goIGssIDAsIC0gaGFsZlNpemUsIGssIDAsIGhhbGZTaXplICk7CgoJCQljb25zdCBjb2xvciA9IGkgPT09IGNlbnRlciA/IGNvbG9yMSA6IGNvbG9yMjsKCgkJCWNvbG9yLnRvQXJyYXkoIGNvbG9ycywgaiApOyBqICs9IDM7CgkJCWNvbG9yLnRvQXJyYXkoIGNvbG9ycywgaiApOyBqICs9IDM7CgkJCWNvbG9yLnRvQXJyYXkoIGNvbG9ycywgaiApOyBqICs9IDM7CgkJCWNvbG9yLnRvQXJyYXkoIGNvbG9ycywgaiApOyBqICs9IDM7CgoJCX0KCgkJY29uc3QgZ2VvbWV0cnkgPSBuZXcgQnVmZmVyR2VvbWV0cnkoKTsKCQlnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCB2ZXJ0aWNlcywgMyApICk7CgkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAnY29sb3InLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggY29sb3JzLCAzICkgKTsKCgkJY29uc3QgbWF0ZXJpYWwgPSBuZXcgTGluZUJhc2ljTWF0ZXJpYWwoIHsgdmVydGV4Q29sb3JzOiB0cnVlLCB0b25lTWFwcGVkOiBmYWxzZSB9ICk7CgoJCXN1cGVyKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTsKCgkJdGhpcy50eXBlID0gJ0dyaWRIZWxwZXInOwoKCX0KCglkaXNwb3NlKCkgewoKCQl0aGlzLmdlb21ldHJ5LmRpc3Bvc2UoKTsKCQl0aGlzLm1hdGVyaWFsLmRpc3Bvc2UoKTsKCgl9Cgp9CgpjbGFzcyBQb2xhckdyaWRIZWxwZXIgZXh0ZW5kcyBMaW5lU2VnbWVudHMgewoKCWNvbnN0cnVjdG9yKCByYWRpdXMgPSAxMCwgc2VjdG9ycyA9IDE2LCByaW5ncyA9IDgsIGRpdmlzaW9ucyA9IDY0LCBjb2xvcjEgPSAweDQ0NDQ0NCwgY29sb3IyID0gMHg4ODg4ODggKSB7CgoJCWNvbG9yMSA9IG5ldyBDb2xvciggY29sb3IxICk7CgkJY29sb3IyID0gbmV3IENvbG9yKCBjb2xvcjIgKTsKCgkJY29uc3QgdmVydGljZXMgPSBbXTsKCQljb25zdCBjb2xvcnMgPSBbXTsKCgkJLy8gY3JlYXRlIHRoZSBzZWN0b3JzCgoJCWlmICggc2VjdG9ycyA+IDEgKSB7CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBzZWN0b3JzOyBpICsrICkgewoKCQkJCWNvbnN0IHYgPSAoIGkgLyBzZWN0b3JzICkgKiAoIE1hdGguUEkgKiAyICk7CgoJCQkJY29uc3QgeCA9IE1hdGguc2luKCB2ICkgKiByYWRpdXM7CgkJCQljb25zdCB6ID0gTWF0aC5jb3MoIHYgKSAqIHJhZGl1czsKCgkJCQl2ZXJ0aWNlcy5wdXNoKCAwLCAwLCAwICk7CgkJCQl2ZXJ0aWNlcy5wdXNoKCB4LCAwLCB6ICk7CgoJCQkJY29uc3QgY29sb3IgPSAoIGkgJiAxICkgPyBjb2xvcjEgOiBjb2xvcjI7CgoJCQkJY29sb3JzLnB1c2goIGNvbG9yLnIsIGNvbG9yLmcsIGNvbG9yLmIgKTsKCQkJCWNvbG9ycy5wdXNoKCBjb2xvci5yLCBjb2xvci5nLCBjb2xvci5iICk7CgoJCQl9CgoJCX0KCgkJLy8gY3JlYXRlIHRoZSByaW5ncwoKCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCByaW5nczsgaSArKyApIHsKCgkJCWNvbnN0IGNvbG9yID0gKCBpICYgMSApID8gY29sb3IxIDogY29sb3IyOwoKCQkJY29uc3QgciA9IHJhZGl1cyAtICggcmFkaXVzIC8gcmluZ3MgKiBpICk7CgoJCQlmb3IgKCBsZXQgaiA9IDA7IGogPCBkaXZpc2lvbnM7IGogKysgKSB7CgoJCQkJLy8gZmlyc3QgdmVydGV4CgoJCQkJbGV0IHYgPSAoIGogLyBkaXZpc2lvbnMgKSAqICggTWF0aC5QSSAqIDIgKTsKCgkJCQlsZXQgeCA9IE1hdGguc2luKCB2ICkgKiByOwoJCQkJbGV0IHogPSBNYXRoLmNvcyggdiApICogcjsKCgkJCQl2ZXJ0aWNlcy5wdXNoKCB4LCAwLCB6ICk7CgkJCQljb2xvcnMucHVzaCggY29sb3IuciwgY29sb3IuZywgY29sb3IuYiApOwoKCQkJCS8vIHNlY29uZCB2ZXJ0ZXgKCgkJCQl2ID0gKCAoIGogKyAxICkgLyBkaXZpc2lvbnMgKSAqICggTWF0aC5QSSAqIDIgKTsKCgkJCQl4ID0gTWF0aC5zaW4oIHYgKSAqIHI7CgkJCQl6ID0gTWF0aC5jb3MoIHYgKSAqIHI7CgoJCQkJdmVydGljZXMucHVzaCggeCwgMCwgeiApOwoJCQkJY29sb3JzLnB1c2goIGNvbG9yLnIsIGNvbG9yLmcsIGNvbG9yLmIgKTsKCgkJCX0KCgkJfQoKCQljb25zdCBnZW9tZXRyeSA9IG5ldyBCdWZmZXJHZW9tZXRyeSgpOwoJCWdlb21ldHJ5LnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHZlcnRpY2VzLCAzICkgKTsKCQlnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoICdjb2xvcicsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCBjb2xvcnMsIDMgKSApOwoKCQljb25zdCBtYXRlcmlhbCA9IG5ldyBMaW5lQmFzaWNNYXRlcmlhbCggeyB2ZXJ0ZXhDb2xvcnM6IHRydWUsIHRvbmVNYXBwZWQ6IGZhbHNlIH0gKTsKCgkJc3VwZXIoIGdlb21ldHJ5LCBtYXRlcmlhbCApOwoKCQl0aGlzLnR5cGUgPSAnUG9sYXJHcmlkSGVscGVyJzsKCgl9CgoJZGlzcG9zZSgpIHsKCgkJdGhpcy5nZW9tZXRyeS5kaXNwb3NlKCk7CgkJdGhpcy5tYXRlcmlhbC5kaXNwb3NlKCk7CgoJfQoKfQoKY29uc3QgX3YxID0gLypAX19QVVJFX18qLyBuZXcgVmVjdG9yMygpOwpjb25zdCBfdjIgPSAvKkBfX1BVUkVfXyovIG5ldyBWZWN0b3IzKCk7CmNvbnN0IF92MyA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKCmNsYXNzIERpcmVjdGlvbmFsTGlnaHRIZWxwZXIgZXh0ZW5kcyBPYmplY3QzRCB7CgoJY29uc3RydWN0b3IoIGxpZ2h0LCBzaXplLCBjb2xvciApIHsKCgkJc3VwZXIoKTsKCgkJdGhpcy5saWdodCA9IGxpZ2h0OwoKCQl0aGlzLm1hdHJpeCA9IGxpZ2h0Lm1hdHJpeFdvcmxkOwoJCXRoaXMubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwoKCQl0aGlzLmNvbG9yID0gY29sb3I7CgoJCXRoaXMudHlwZSA9ICdEaXJlY3Rpb25hbExpZ2h0SGVscGVyJzsKCgkJaWYgKCBzaXplID09PSB1bmRlZmluZWQgKSBzaXplID0gMTsKCgkJbGV0IGdlb21ldHJ5ID0gbmV3IEJ1ZmZlckdlb21ldHJ5KCk7CgkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggWwoJCQktIHNpemUsIHNpemUsIDAsCgkJCXNpemUsIHNpemUsIDAsCgkJCXNpemUsIC0gc2l6ZSwgMCwKCQkJLSBzaXplLCAtIHNpemUsIDAsCgkJCS0gc2l6ZSwgc2l6ZSwgMAoJCV0sIDMgKSApOwoKCQljb25zdCBtYXRlcmlhbCA9IG5ldyBMaW5lQmFzaWNNYXRlcmlhbCggeyBmb2c6IGZhbHNlLCB0b25lTWFwcGVkOiBmYWxzZSB9ICk7CgoJCXRoaXMubGlnaHRQbGFuZSA9IG5ldyBMaW5lKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTsKCQl0aGlzLmFkZCggdGhpcy5saWdodFBsYW5lICk7CgoJCWdlb21ldHJ5ID0gbmV3IEJ1ZmZlckdlb21ldHJ5KCk7CgkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggWyAwLCAwLCAwLCAwLCAwLCAxIF0sIDMgKSApOwoKCQl0aGlzLnRhcmdldExpbmUgPSBuZXcgTGluZSggZ2VvbWV0cnksIG1hdGVyaWFsICk7CgkJdGhpcy5hZGQoIHRoaXMudGFyZ2V0TGluZSApOwoKCQl0aGlzLnVwZGF0ZSgpOwoKCX0KCglkaXNwb3NlKCkgewoKCQl0aGlzLmxpZ2h0UGxhbmUuZ2VvbWV0cnkuZGlzcG9zZSgpOwoJCXRoaXMubGlnaHRQbGFuZS5tYXRlcmlhbC5kaXNwb3NlKCk7CgkJdGhpcy50YXJnZXRMaW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKCQl0aGlzLnRhcmdldExpbmUubWF0ZXJpYWwuZGlzcG9zZSgpOwoKCX0KCgl1cGRhdGUoKSB7CgoJCXRoaXMubGlnaHQudXBkYXRlV29ybGRNYXRyaXgoIHRydWUsIGZhbHNlICk7CgkJdGhpcy5saWdodC50YXJnZXQudXBkYXRlV29ybGRNYXRyaXgoIHRydWUsIGZhbHNlICk7CgoJCV92MS5zZXRGcm9tTWF0cml4UG9zaXRpb24oIHRoaXMubGlnaHQubWF0cml4V29ybGQgKTsKCQlfdjIuc2V0RnJvbU1hdHJpeFBvc2l0aW9uKCB0aGlzLmxpZ2h0LnRhcmdldC5tYXRyaXhXb3JsZCApOwoJCV92My5zdWJWZWN0b3JzKCBfdjIsIF92MSApOwoKCQl0aGlzLmxpZ2h0UGxhbmUubG9va0F0KCBfdjIgKTsKCgkJaWYgKCB0aGlzLmNvbG9yICE9PSB1bmRlZmluZWQgKSB7CgoJCQl0aGlzLmxpZ2h0UGxhbmUubWF0ZXJpYWwuY29sb3Iuc2V0KCB0aGlzLmNvbG9yICk7CgkJCXRoaXMudGFyZ2V0TGluZS5tYXRlcmlhbC5jb2xvci5zZXQoIHRoaXMuY29sb3IgKTsKCgkJfSBlbHNlIHsKCgkJCXRoaXMubGlnaHRQbGFuZS5tYXRlcmlhbC5jb2xvci5jb3B5KCB0aGlzLmxpZ2h0LmNvbG9yICk7CgkJCXRoaXMudGFyZ2V0TGluZS5tYXRlcmlhbC5jb2xvci5jb3B5KCB0aGlzLmxpZ2h0LmNvbG9yICk7CgoJCX0KCgkJdGhpcy50YXJnZXRMaW5lLmxvb2tBdCggX3YyICk7CgkJdGhpcy50YXJnZXRMaW5lLnNjYWxlLnogPSBfdjMubGVuZ3RoKCk7CgoJfQoKfQoKY29uc3QgX3ZlY3RvciA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKY29uc3QgX2NhbWVyYSA9IC8qQF9fUFVSRV9fKi8gbmV3IENhbWVyYSgpOwoKLyoqCiAqCS0gc2hvd3MgZnJ1c3R1bSwgbGluZSBvZiBzaWdodCBhbmQgdXAgb2YgdGhlIGNhbWVyYQogKgktIHN1aXRhYmxlIGZvciBmYXN0IHVwZGF0ZXMKICogCS0gYmFzZWQgb24gZnJ1c3R1bSB2aXN1YWxpemF0aW9uIGluIGxpZ2h0Z2wuanMgc2hhZG93bWFwIGV4YW1wbGUKICoJCWh0dHBzOi8vZ2l0aHViLmNvbS9ldmFudy9saWdodGdsLmpzL2Jsb2IvbWFzdGVyL3Rlc3RzL3NoYWRvd21hcC5odG1sCiAqLwoKY2xhc3MgQ2FtZXJhSGVscGVyIGV4dGVuZHMgTGluZVNlZ21lbnRzIHsKCgljb25zdHJ1Y3RvciggY2FtZXJhICkgewoKCQljb25zdCBnZW9tZXRyeSA9IG5ldyBCdWZmZXJHZW9tZXRyeSgpOwoJCWNvbnN0IG1hdGVyaWFsID0gbmV3IExpbmVCYXNpY01hdGVyaWFsKCB7IGNvbG9yOiAweGZmZmZmZiwgdmVydGV4Q29sb3JzOiB0cnVlLCB0b25lTWFwcGVkOiBmYWxzZSB9ICk7CgoJCWNvbnN0IHZlcnRpY2VzID0gW107CgkJY29uc3QgY29sb3JzID0gW107CgoJCWNvbnN0IHBvaW50TWFwID0ge307CgoJCS8vIG5lYXIKCgkJYWRkTGluZSggJ24xJywgJ24yJyApOwoJCWFkZExpbmUoICduMicsICduNCcgKTsKCQlhZGRMaW5lKCAnbjQnLCAnbjMnICk7CgkJYWRkTGluZSggJ24zJywgJ24xJyApOwoKCQkvLyBmYXIKCgkJYWRkTGluZSggJ2YxJywgJ2YyJyApOwoJCWFkZExpbmUoICdmMicsICdmNCcgKTsKCQlhZGRMaW5lKCAnZjQnLCAnZjMnICk7CgkJYWRkTGluZSggJ2YzJywgJ2YxJyApOwoKCQkvLyBzaWRlcwoKCQlhZGRMaW5lKCAnbjEnLCAnZjEnICk7CgkJYWRkTGluZSggJ24yJywgJ2YyJyApOwoJCWFkZExpbmUoICduMycsICdmMycgKTsKCQlhZGRMaW5lKCAnbjQnLCAnZjQnICk7CgoJCS8vIGNvbmUKCgkJYWRkTGluZSggJ3AnLCAnbjEnICk7CgkJYWRkTGluZSggJ3AnLCAnbjInICk7CgkJYWRkTGluZSggJ3AnLCAnbjMnICk7CgkJYWRkTGluZSggJ3AnLCAnbjQnICk7CgoJCS8vIHVwCgoJCWFkZExpbmUoICd1MScsICd1MicgKTsKCQlhZGRMaW5lKCAndTInLCAndTMnICk7CgkJYWRkTGluZSggJ3UzJywgJ3UxJyApOwoKCQkvLyB0YXJnZXQKCgkJYWRkTGluZSggJ2MnLCAndCcgKTsKCQlhZGRMaW5lKCAncCcsICdjJyApOwoKCQkvLyBjcm9zcwoKCQlhZGRMaW5lKCAnY24xJywgJ2NuMicgKTsKCQlhZGRMaW5lKCAnY24zJywgJ2NuNCcgKTsKCgkJYWRkTGluZSggJ2NmMScsICdjZjInICk7CgkJYWRkTGluZSggJ2NmMycsICdjZjQnICk7CgoJCWZ1bmN0aW9uIGFkZExpbmUoIGEsIGIgKSB7CgoJCQlhZGRQb2ludCggYSApOwoJCQlhZGRQb2ludCggYiApOwoKCQl9CgoJCWZ1bmN0aW9uIGFkZFBvaW50KCBpZCApIHsKCgkJCXZlcnRpY2VzLnB1c2goIDAsIDAsIDAgKTsKCQkJY29sb3JzLnB1c2goIDAsIDAsIDAgKTsKCgkJCWlmICggcG9pbnRNYXBbIGlkIF0gPT09IHVuZGVmaW5lZCApIHsKCgkJCQlwb2ludE1hcFsgaWQgXSA9IFtdOwoKCQkJfQoKCQkJcG9pbnRNYXBbIGlkIF0ucHVzaCggKCB2ZXJ0aWNlcy5sZW5ndGggLyAzICkgLSAxICk7CgoJCX0KCgkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggdmVydGljZXMsIDMgKSApOwoJCWdlb21ldHJ5LnNldEF0dHJpYnV0ZSggJ2NvbG9yJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIGNvbG9ycywgMyApICk7CgoJCXN1cGVyKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTsKCgkJdGhpcy50eXBlID0gJ0NhbWVyYUhlbHBlcic7CgoJCXRoaXMuY2FtZXJhID0gY2FtZXJhOwoJCWlmICggdGhpcy5jYW1lcmEudXBkYXRlUHJvamVjdGlvbk1hdHJpeCApIHRoaXMuY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTsKCgkJdGhpcy5tYXRyaXggPSBjYW1lcmEubWF0cml4V29ybGQ7CgkJdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gZmFsc2U7CgoJCXRoaXMucG9pbnRNYXAgPSBwb2ludE1hcDsKCgkJdGhpcy51cGRhdGUoKTsKCgkJLy8gY29sb3JzCgoJCWNvbnN0IGNvbG9yRnJ1c3R1bSA9IG5ldyBDb2xvciggMHhmZmFhMDAgKTsKCQljb25zdCBjb2xvckNvbmUgPSBuZXcgQ29sb3IoIDB4ZmYwMDAwICk7CgkJY29uc3QgY29sb3JVcCA9IG5ldyBDb2xvciggMHgwMGFhZmYgKTsKCQljb25zdCBjb2xvclRhcmdldCA9IG5ldyBDb2xvciggMHhmZmZmZmYgKTsKCQljb25zdCBjb2xvckNyb3NzID0gbmV3IENvbG9yKCAweDMzMzMzMyApOwoKCQl0aGlzLnNldENvbG9ycyggY29sb3JGcnVzdHVtLCBjb2xvckNvbmUsIGNvbG9yVXAsIGNvbG9yVGFyZ2V0LCBjb2xvckNyb3NzICk7CgoJfQoKCXNldENvbG9ycyggZnJ1c3R1bSwgY29uZSwgdXAsIHRhcmdldCwgY3Jvc3MgKSB7CgoJCWNvbnN0IGdlb21ldHJ5ID0gdGhpcy5nZW9tZXRyeTsKCgkJY29uc3QgY29sb3JBdHRyaWJ1dGUgPSBnZW9tZXRyeS5nZXRBdHRyaWJ1dGUoICdjb2xvcicgKTsKCgkJLy8gbmVhcgoKCQljb2xvckF0dHJpYnV0ZS5zZXRYWVooIDAsIGZydXN0dW0uciwgZnJ1c3R1bS5nLCBmcnVzdHVtLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAxLCBmcnVzdHVtLnIsIGZydXN0dW0uZywgZnJ1c3R1bS5iICk7IC8vIG4xLCBuMgoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggMiwgZnJ1c3R1bS5yLCBmcnVzdHVtLmcsIGZydXN0dW0uYiApOyBjb2xvckF0dHJpYnV0ZS5zZXRYWVooIDMsIGZydXN0dW0uciwgZnJ1c3R1bS5nLCBmcnVzdHVtLmIgKTsgLy8gbjIsIG40CgkJY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCA0LCBmcnVzdHVtLnIsIGZydXN0dW0uZywgZnJ1c3R1bS5iICk7IGNvbG9yQXR0cmlidXRlLnNldFhZWiggNSwgZnJ1c3R1bS5yLCBmcnVzdHVtLmcsIGZydXN0dW0uYiApOyAvLyBuNCwgbjMKCQljb2xvckF0dHJpYnV0ZS5zZXRYWVooIDYsIGZydXN0dW0uciwgZnJ1c3R1bS5nLCBmcnVzdHVtLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCA3LCBmcnVzdHVtLnIsIGZydXN0dW0uZywgZnJ1c3R1bS5iICk7IC8vIG4zLCBuMQoKCQkvLyBmYXIKCgkJY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCA4LCBmcnVzdHVtLnIsIGZydXN0dW0uZywgZnJ1c3R1bS5iICk7IGNvbG9yQXR0cmlidXRlLnNldFhZWiggOSwgZnJ1c3R1bS5yLCBmcnVzdHVtLmcsIGZydXN0dW0uYiApOyAvLyBmMSwgZjIKCQljb2xvckF0dHJpYnV0ZS5zZXRYWVooIDEwLCBmcnVzdHVtLnIsIGZydXN0dW0uZywgZnJ1c3R1bS5iICk7IGNvbG9yQXR0cmlidXRlLnNldFhZWiggMTEsIGZydXN0dW0uciwgZnJ1c3R1bS5nLCBmcnVzdHVtLmIgKTsgLy8gZjIsIGY0CgkJY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAxMiwgZnJ1c3R1bS5yLCBmcnVzdHVtLmcsIGZydXN0dW0uYiApOyBjb2xvckF0dHJpYnV0ZS5zZXRYWVooIDEzLCBmcnVzdHVtLnIsIGZydXN0dW0uZywgZnJ1c3R1bS5iICk7IC8vIGY0LCBmMwoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggMTQsIGZydXN0dW0uciwgZnJ1c3R1bS5nLCBmcnVzdHVtLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAxNSwgZnJ1c3R1bS5yLCBmcnVzdHVtLmcsIGZydXN0dW0uYiApOyAvLyBmMywgZjEKCgkJLy8gc2lkZXMKCgkJY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAxNiwgZnJ1c3R1bS5yLCBmcnVzdHVtLmcsIGZydXN0dW0uYiApOyBjb2xvckF0dHJpYnV0ZS5zZXRYWVooIDE3LCBmcnVzdHVtLnIsIGZydXN0dW0uZywgZnJ1c3R1bS5iICk7IC8vIG4xLCBmMQoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggMTgsIGZydXN0dW0uciwgZnJ1c3R1bS5nLCBmcnVzdHVtLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAxOSwgZnJ1c3R1bS5yLCBmcnVzdHVtLmcsIGZydXN0dW0uYiApOyAvLyBuMiwgZjIKCQljb2xvckF0dHJpYnV0ZS5zZXRYWVooIDIwLCBmcnVzdHVtLnIsIGZydXN0dW0uZywgZnJ1c3R1bS5iICk7IGNvbG9yQXR0cmlidXRlLnNldFhZWiggMjEsIGZydXN0dW0uciwgZnJ1c3R1bS5nLCBmcnVzdHVtLmIgKTsgLy8gbjMsIGYzCgkJY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAyMiwgZnJ1c3R1bS5yLCBmcnVzdHVtLmcsIGZydXN0dW0uYiApOyBjb2xvckF0dHJpYnV0ZS5zZXRYWVooIDIzLCBmcnVzdHVtLnIsIGZydXN0dW0uZywgZnJ1c3R1bS5iICk7IC8vIG40LCBmNAoKCQkvLyBjb25lCgoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggMjQsIGNvbmUuciwgY29uZS5nLCBjb25lLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAyNSwgY29uZS5yLCBjb25lLmcsIGNvbmUuYiApOyAvLyBwLCBuMQoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggMjYsIGNvbmUuciwgY29uZS5nLCBjb25lLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAyNywgY29uZS5yLCBjb25lLmcsIGNvbmUuYiApOyAvLyBwLCBuMgoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggMjgsIGNvbmUuciwgY29uZS5nLCBjb25lLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAyOSwgY29uZS5yLCBjb25lLmcsIGNvbmUuYiApOyAvLyBwLCBuMwoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggMzAsIGNvbmUuciwgY29uZS5nLCBjb25lLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAzMSwgY29uZS5yLCBjb25lLmcsIGNvbmUuYiApOyAvLyBwLCBuNAoKCQkvLyB1cAoKCQljb2xvckF0dHJpYnV0ZS5zZXRYWVooIDMyLCB1cC5yLCB1cC5nLCB1cC5iICk7IGNvbG9yQXR0cmlidXRlLnNldFhZWiggMzMsIHVwLnIsIHVwLmcsIHVwLmIgKTsgLy8gdTEsIHUyCgkJY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAzNCwgdXAuciwgdXAuZywgdXAuYiApOyBjb2xvckF0dHJpYnV0ZS5zZXRYWVooIDM1LCB1cC5yLCB1cC5nLCB1cC5iICk7IC8vIHUyLCB1MwoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggMzYsIHVwLnIsIHVwLmcsIHVwLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAzNywgdXAuciwgdXAuZywgdXAuYiApOyAvLyB1MywgdTEKCgkJLy8gdGFyZ2V0CgoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggMzgsIHRhcmdldC5yLCB0YXJnZXQuZywgdGFyZ2V0LmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCAzOSwgdGFyZ2V0LnIsIHRhcmdldC5nLCB0YXJnZXQuYiApOyAvLyBjLCB0CgkJY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCA0MCwgY3Jvc3MuciwgY3Jvc3MuZywgY3Jvc3MuYiApOyBjb2xvckF0dHJpYnV0ZS5zZXRYWVooIDQxLCBjcm9zcy5yLCBjcm9zcy5nLCBjcm9zcy5iICk7IC8vIHAsIGMKCgkJLy8gY3Jvc3MKCgkJY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCA0MiwgY3Jvc3MuciwgY3Jvc3MuZywgY3Jvc3MuYiApOyBjb2xvckF0dHJpYnV0ZS5zZXRYWVooIDQzLCBjcm9zcy5yLCBjcm9zcy5nLCBjcm9zcy5iICk7IC8vIGNuMSwgY24yCgkJY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCA0NCwgY3Jvc3MuciwgY3Jvc3MuZywgY3Jvc3MuYiApOyBjb2xvckF0dHJpYnV0ZS5zZXRYWVooIDQ1LCBjcm9zcy5yLCBjcm9zcy5nLCBjcm9zcy5iICk7IC8vIGNuMywgY240CgoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggNDYsIGNyb3NzLnIsIGNyb3NzLmcsIGNyb3NzLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCA0NywgY3Jvc3MuciwgY3Jvc3MuZywgY3Jvc3MuYiApOyAvLyBjZjEsIGNmMgoJCWNvbG9yQXR0cmlidXRlLnNldFhZWiggNDgsIGNyb3NzLnIsIGNyb3NzLmcsIGNyb3NzLmIgKTsgY29sb3JBdHRyaWJ1dGUuc2V0WFlaKCA0OSwgY3Jvc3MuciwgY3Jvc3MuZywgY3Jvc3MuYiApOyAvLyBjZjMsIGNmNAoKCQljb2xvckF0dHJpYnV0ZS5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJfQoKCXVwZGF0ZSgpIHsKCgkJY29uc3QgZ2VvbWV0cnkgPSB0aGlzLmdlb21ldHJ5OwoJCWNvbnN0IHBvaW50TWFwID0gdGhpcy5wb2ludE1hcDsKCgkJY29uc3QgdyA9IDEsIGggPSAxOwoKCQkvLyB3ZSBuZWVkIGp1c3QgY2FtZXJhIHByb2plY3Rpb24gbWF0cml4IGludmVyc2UKCQkvLyB3b3JsZCBtYXRyaXggbXVzdCBiZSBpZGVudGl0eQoKCQlfY2FtZXJhLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlLmNvcHkoIHRoaXMuY2FtZXJhLnByb2plY3Rpb25NYXRyaXhJbnZlcnNlICk7CgoJCS8vIGNlbnRlciAvIHRhcmdldAoKCQlzZXRQb2ludCggJ2MnLCBwb2ludE1hcCwgZ2VvbWV0cnksIF9jYW1lcmEsIDAsIDAsIC0gMSApOwoJCXNldFBvaW50KCAndCcsIHBvaW50TWFwLCBnZW9tZXRyeSwgX2NhbWVyYSwgMCwgMCwgMSApOwoKCQkvLyBuZWFyCgoJCXNldFBvaW50KCAnbjEnLCBwb2ludE1hcCwgZ2VvbWV0cnksIF9jYW1lcmEsIC0gdywgLSBoLCAtIDEgKTsKCQlzZXRQb2ludCggJ24yJywgcG9pbnRNYXAsIGdlb21ldHJ5LCBfY2FtZXJhLCB3LCAtIGgsIC0gMSApOwoJCXNldFBvaW50KCAnbjMnLCBwb2ludE1hcCwgZ2VvbWV0cnksIF9jYW1lcmEsIC0gdywgaCwgLSAxICk7CgkJc2V0UG9pbnQoICduNCcsIHBvaW50TWFwLCBnZW9tZXRyeSwgX2NhbWVyYSwgdywgaCwgLSAxICk7CgoJCS8vIGZhcgoKCQlzZXRQb2ludCggJ2YxJywgcG9pbnRNYXAsIGdlb21ldHJ5LCBfY2FtZXJhLCAtIHcsIC0gaCwgMSApOwoJCXNldFBvaW50KCAnZjInLCBwb2ludE1hcCwgZ2VvbWV0cnksIF9jYW1lcmEsIHcsIC0gaCwgMSApOwoJCXNldFBvaW50KCAnZjMnLCBwb2ludE1hcCwgZ2VvbWV0cnksIF9jYW1lcmEsIC0gdywgaCwgMSApOwoJCXNldFBvaW50KCAnZjQnLCBwb2ludE1hcCwgZ2VvbWV0cnksIF9jYW1lcmEsIHcsIGgsIDEgKTsKCgkJLy8gdXAKCgkJc2V0UG9pbnQoICd1MScsIHBvaW50TWFwLCBnZW9tZXRyeSwgX2NhbWVyYSwgdyAqIDAuNywgaCAqIDEuMSwgLSAxICk7CgkJc2V0UG9pbnQoICd1MicsIHBvaW50TWFwLCBnZW9tZXRyeSwgX2NhbWVyYSwgLSB3ICogMC43LCBoICogMS4xLCAtIDEgKTsKCQlzZXRQb2ludCggJ3UzJywgcG9pbnRNYXAsIGdlb21ldHJ5LCBfY2FtZXJhLCAwLCBoICogMiwgLSAxICk7CgoJCS8vIGNyb3NzCgoJCXNldFBvaW50KCAnY2YxJywgcG9pbnRNYXAsIGdlb21ldHJ5LCBfY2FtZXJhLCAtIHcsIDAsIDEgKTsKCQlzZXRQb2ludCggJ2NmMicsIHBvaW50TWFwLCBnZW9tZXRyeSwgX2NhbWVyYSwgdywgMCwgMSApOwoJCXNldFBvaW50KCAnY2YzJywgcG9pbnRNYXAsIGdlb21ldHJ5LCBfY2FtZXJhLCAwLCAtIGgsIDEgKTsKCQlzZXRQb2ludCggJ2NmNCcsIHBvaW50TWFwLCBnZW9tZXRyeSwgX2NhbWVyYSwgMCwgaCwgMSApOwoKCQlzZXRQb2ludCggJ2NuMScsIHBvaW50TWFwLCBnZW9tZXRyeSwgX2NhbWVyYSwgLSB3LCAwLCAtIDEgKTsKCQlzZXRQb2ludCggJ2NuMicsIHBvaW50TWFwLCBnZW9tZXRyeSwgX2NhbWVyYSwgdywgMCwgLSAxICk7CgkJc2V0UG9pbnQoICdjbjMnLCBwb2ludE1hcCwgZ2VvbWV0cnksIF9jYW1lcmEsIDAsIC0gaCwgLSAxICk7CgkJc2V0UG9pbnQoICdjbjQnLCBwb2ludE1hcCwgZ2VvbWV0cnksIF9jYW1lcmEsIDAsIGgsIC0gMSApOwoKCQlnZW9tZXRyeS5nZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicgKS5uZWVkc1VwZGF0ZSA9IHRydWU7CgoJfQoKCWRpc3Bvc2UoKSB7CgoJCXRoaXMuZ2VvbWV0cnkuZGlzcG9zZSgpOwoJCXRoaXMubWF0ZXJpYWwuZGlzcG9zZSgpOwoKCX0KCn0KCgpmdW5jdGlvbiBzZXRQb2ludCggcG9pbnQsIHBvaW50TWFwLCBnZW9tZXRyeSwgY2FtZXJhLCB4LCB5LCB6ICkgewoKCV92ZWN0b3Iuc2V0KCB4LCB5LCB6ICkudW5wcm9qZWN0KCBjYW1lcmEgKTsKCgljb25zdCBwb2ludHMgPSBwb2ludE1hcFsgcG9pbnQgXTsKCglpZiAoIHBvaW50cyAhPT0gdW5kZWZpbmVkICkgewoKCQljb25zdCBwb3NpdGlvbiA9IGdlb21ldHJ5LmdldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJyApOwoKCQlmb3IgKCBsZXQgaSA9IDAsIGwgPSBwb2ludHMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCXBvc2l0aW9uLnNldFhZWiggcG9pbnRzWyBpIF0sIF92ZWN0b3IueCwgX3ZlY3Rvci55LCBfdmVjdG9yLnogKTsKCgkJfQoKCX0KCn0KCmNvbnN0IF9ib3ggPSAvKkBfX1BVUkVfXyovIG5ldyBCb3gzKCk7CgpjbGFzcyBCb3hIZWxwZXIgZXh0ZW5kcyBMaW5lU2VnbWVudHMgewoKCWNvbnN0cnVjdG9yKCBvYmplY3QsIGNvbG9yID0gMHhmZmZmMDAgKSB7CgoJCWNvbnN0IGluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoIFsgMCwgMSwgMSwgMiwgMiwgMywgMywgMCwgNCwgNSwgNSwgNiwgNiwgNywgNywgNCwgMCwgNCwgMSwgNSwgMiwgNiwgMywgNyBdICk7CgkJY29uc3QgcG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheSggOCAqIDMgKTsKCgkJY29uc3QgZ2VvbWV0cnkgPSBuZXcgQnVmZmVyR2VvbWV0cnkoKTsKCQlnZW9tZXRyeS5zZXRJbmRleCggbmV3IEJ1ZmZlckF0dHJpYnV0ZSggaW5kaWNlcywgMSApICk7CgkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgQnVmZmVyQXR0cmlidXRlKCBwb3NpdGlvbnMsIDMgKSApOwoKCQlzdXBlciggZ2VvbWV0cnksIG5ldyBMaW5lQmFzaWNNYXRlcmlhbCggeyBjb2xvcjogY29sb3IsIHRvbmVNYXBwZWQ6IGZhbHNlIH0gKSApOwoKCQl0aGlzLm9iamVjdCA9IG9iamVjdDsKCQl0aGlzLnR5cGUgPSAnQm94SGVscGVyJzsKCgkJdGhpcy5tYXRyaXhBdXRvVXBkYXRlID0gZmFsc2U7CgoJCXRoaXMudXBkYXRlKCk7CgoJfQoKCXVwZGF0ZSggb2JqZWN0ICkgewoKCQlpZiAoIG9iamVjdCAhPT0gdW5kZWZpbmVkICkgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuQm94SGVscGVyOiAudXBkYXRlKCkgaGFzIG5vIGxvbmdlciBhcmd1bWVudHMuJyApOwoKCQl9CgoJCWlmICggdGhpcy5vYmplY3QgIT09IHVuZGVmaW5lZCApIHsKCgkJCV9ib3guc2V0RnJvbU9iamVjdCggdGhpcy5vYmplY3QgKTsKCgkJfQoKCQlpZiAoIF9ib3guaXNFbXB0eSgpICkgcmV0dXJuOwoKCQljb25zdCBtaW4gPSBfYm94Lm1pbjsKCQljb25zdCBtYXggPSBfYm94Lm1heDsKCgkJLyoKCQkJNV9fX180CgkJMS9fX18wL3wKCQl8IDZfX3xfNwoJCTIvX19fMy8KCgkJMDogbWF4LngsIG1heC55LCBtYXguegoJCTE6IG1pbi54LCBtYXgueSwgbWF4LnoKCQkyOiBtaW4ueCwgbWluLnksIG1heC56CgkJMzogbWF4LngsIG1pbi55LCBtYXguegoJCTQ6IG1heC54LCBtYXgueSwgbWluLnoKCQk1OiBtaW4ueCwgbWF4LnksIG1pbi56CgkJNjogbWluLngsIG1pbi55LCBtaW4uegoJCTc6IG1heC54LCBtaW4ueSwgbWluLnoKCQkqLwoKCQljb25zdCBwb3NpdGlvbiA9IHRoaXMuZ2VvbWV0cnkuYXR0cmlidXRlcy5wb3NpdGlvbjsKCQljb25zdCBhcnJheSA9IHBvc2l0aW9uLmFycmF5OwoKCQlhcnJheVsgMCBdID0gbWF4Lng7IGFycmF5WyAxIF0gPSBtYXgueTsgYXJyYXlbIDIgXSA9IG1heC56OwoJCWFycmF5WyAzIF0gPSBtaW4ueDsgYXJyYXlbIDQgXSA9IG1heC55OyBhcnJheVsgNSBdID0gbWF4Lno7CgkJYXJyYXlbIDYgXSA9IG1pbi54OyBhcnJheVsgNyBdID0gbWluLnk7IGFycmF5WyA4IF0gPSBtYXguejsKCQlhcnJheVsgOSBdID0gbWF4Lng7IGFycmF5WyAxMCBdID0gbWluLnk7IGFycmF5WyAxMSBdID0gbWF4Lno7CgkJYXJyYXlbIDEyIF0gPSBtYXgueDsgYXJyYXlbIDEzIF0gPSBtYXgueTsgYXJyYXlbIDE0IF0gPSBtaW4uejsKCQlhcnJheVsgMTUgXSA9IG1pbi54OyBhcnJheVsgMTYgXSA9IG1heC55OyBhcnJheVsgMTcgXSA9IG1pbi56OwoJCWFycmF5WyAxOCBdID0gbWluLng7IGFycmF5WyAxOSBdID0gbWluLnk7IGFycmF5WyAyMCBdID0gbWluLno7CgkJYXJyYXlbIDIxIF0gPSBtYXgueDsgYXJyYXlbIDIyIF0gPSBtaW4ueTsgYXJyYXlbIDIzIF0gPSBtaW4uejsKCgkJcG9zaXRpb24ubmVlZHNVcGRhdGUgPSB0cnVlOwoKCQl0aGlzLmdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwoKCX0KCglzZXRGcm9tT2JqZWN0KCBvYmplY3QgKSB7CgoJCXRoaXMub2JqZWN0ID0gb2JqZWN0OwoJCXRoaXMudXBkYXRlKCk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgljb3B5KCBzb3VyY2UsIHJlY3Vyc2l2ZSApIHsKCgkJc3VwZXIuY29weSggc291cmNlLCByZWN1cnNpdmUgKTsKCgkJdGhpcy5vYmplY3QgPSBzb3VyY2Uub2JqZWN0OwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZGlzcG9zZSgpIHsKCgkJdGhpcy5nZW9tZXRyeS5kaXNwb3NlKCk7CgkJdGhpcy5tYXRlcmlhbC5kaXNwb3NlKCk7CgoJfQoKfQoKY2xhc3MgQm94M0hlbHBlciBleHRlbmRzIExpbmVTZWdtZW50cyB7CgoJY29uc3RydWN0b3IoIGJveCwgY29sb3IgPSAweGZmZmYwMCApIHsKCgkJY29uc3QgaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSggWyAwLCAxLCAxLCAyLCAyLCAzLCAzLCAwLCA0LCA1LCA1LCA2LCA2LCA3LCA3LCA0LCAwLCA0LCAxLCA1LCAyLCA2LCAzLCA3IF0gKTsKCgkJY29uc3QgcG9zaXRpb25zID0gWyAxLCAxLCAxLCAtIDEsIDEsIDEsIC0gMSwgLSAxLCAxLCAxLCAtIDEsIDEsIDEsIDEsIC0gMSwgLSAxLCAxLCAtIDEsIC0gMSwgLSAxLCAtIDEsIDEsIC0gMSwgLSAxIF07CgoJCWNvbnN0IGdlb21ldHJ5ID0gbmV3IEJ1ZmZlckdlb21ldHJ5KCk7CgoJCWdlb21ldHJ5LnNldEluZGV4KCBuZXcgQnVmZmVyQXR0cmlidXRlKCBpbmRpY2VzLCAxICkgKTsKCgkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggcG9zaXRpb25zLCAzICkgKTsKCgkJc3VwZXIoIGdlb21ldHJ5LCBuZXcgTGluZUJhc2ljTWF0ZXJpYWwoIHsgY29sb3I6IGNvbG9yLCB0b25lTWFwcGVkOiBmYWxzZSB9ICkgKTsKCgkJdGhpcy5ib3ggPSBib3g7CgoJCXRoaXMudHlwZSA9ICdCb3gzSGVscGVyJzsKCgkJdGhpcy5nZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTsKCgl9CgoJdXBkYXRlTWF0cml4V29ybGQoIGZvcmNlICkgewoKCQljb25zdCBib3ggPSB0aGlzLmJveDsKCgkJaWYgKCBib3guaXNFbXB0eSgpICkgcmV0dXJuOwoKCQlib3guZ2V0Q2VudGVyKCB0aGlzLnBvc2l0aW9uICk7CgoJCWJveC5nZXRTaXplKCB0aGlzLnNjYWxlICk7CgoJCXRoaXMuc2NhbGUubXVsdGlwbHlTY2FsYXIoIDAuNSApOwoKCQlzdXBlci51cGRhdGVNYXRyaXhXb3JsZCggZm9yY2UgKTsKCgl9CgoJZGlzcG9zZSgpIHsKCgkJdGhpcy5nZW9tZXRyeS5kaXNwb3NlKCk7CgkJdGhpcy5tYXRlcmlhbC5kaXNwb3NlKCk7CgoJfQoKfQoKY2xhc3MgUGxhbmVIZWxwZXIgZXh0ZW5kcyBMaW5lIHsKCgljb25zdHJ1Y3RvciggcGxhbmUsIHNpemUgPSAxLCBoZXggPSAweGZmZmYwMCApIHsKCgkJY29uc3QgY29sb3IgPSBoZXg7CgoJCWNvbnN0IHBvc2l0aW9ucyA9IFsgMSwgLSAxLCAwLCAtIDEsIDEsIDAsIC0gMSwgLSAxLCAwLCAxLCAxLCAwLCAtIDEsIDEsIDAsIC0gMSwgLSAxLCAwLCAxLCAtIDEsIDAsIDEsIDEsIDAgXTsKCgkJY29uc3QgZ2VvbWV0cnkgPSBuZXcgQnVmZmVyR2VvbWV0cnkoKTsKCQlnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCBwb3NpdGlvbnMsIDMgKSApOwoJCWdlb21ldHJ5LmNvbXB1dGVCb3VuZGluZ1NwaGVyZSgpOwoKCQlzdXBlciggZ2VvbWV0cnksIG5ldyBMaW5lQmFzaWNNYXRlcmlhbCggeyBjb2xvcjogY29sb3IsIHRvbmVNYXBwZWQ6IGZhbHNlIH0gKSApOwoKCQl0aGlzLnR5cGUgPSAnUGxhbmVIZWxwZXInOwoKCQl0aGlzLnBsYW5lID0gcGxhbmU7CgoJCXRoaXMuc2l6ZSA9IHNpemU7CgoJCWNvbnN0IHBvc2l0aW9uczIgPSBbIDEsIDEsIDAsIC0gMSwgMSwgMCwgLSAxLCAtIDEsIDAsIDEsIDEsIDAsIC0gMSwgLSAxLCAwLCAxLCAtIDEsIDAgXTsKCgkJY29uc3QgZ2VvbWV0cnkyID0gbmV3IEJ1ZmZlckdlb21ldHJ5KCk7CgkJZ2VvbWV0cnkyLnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIHBvc2l0aW9uczIsIDMgKSApOwoJCWdlb21ldHJ5Mi5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTsKCgkJdGhpcy5hZGQoIG5ldyBNZXNoKCBnZW9tZXRyeTIsIG5ldyBNZXNoQmFzaWNNYXRlcmlhbCggeyBjb2xvcjogY29sb3IsIG9wYWNpdHk6IDAuMiwgdHJhbnNwYXJlbnQ6IHRydWUsIGRlcHRoV3JpdGU6IGZhbHNlLCB0b25lTWFwcGVkOiBmYWxzZSB9ICkgKSApOwoKCX0KCgl1cGRhdGVNYXRyaXhXb3JsZCggZm9yY2UgKSB7CgoJCXRoaXMucG9zaXRpb24uc2V0KCAwLCAwLCAwICk7CgoJCXRoaXMuc2NhbGUuc2V0KCAwLjUgKiB0aGlzLnNpemUsIDAuNSAqIHRoaXMuc2l6ZSwgMSApOwoKCQl0aGlzLmxvb2tBdCggdGhpcy5wbGFuZS5ub3JtYWwgKTsKCgkJdGhpcy50cmFuc2xhdGVaKCAtIHRoaXMucGxhbmUuY29uc3RhbnQgKTsKCgkJc3VwZXIudXBkYXRlTWF0cml4V29ybGQoIGZvcmNlICk7CgoJfQoKCWRpc3Bvc2UoKSB7CgoJCXRoaXMuZ2VvbWV0cnkuZGlzcG9zZSgpOwoJCXRoaXMubWF0ZXJpYWwuZGlzcG9zZSgpOwoJCXRoaXMuY2hpbGRyZW5bIDAgXS5nZW9tZXRyeS5kaXNwb3NlKCk7CgkJdGhpcy5jaGlsZHJlblsgMCBdLm1hdGVyaWFsLmRpc3Bvc2UoKTsKCgl9Cgp9Cgpjb25zdCBfYXhpcyA9IC8qQF9fUFVSRV9fKi8gbmV3IFZlY3RvcjMoKTsKbGV0IF9saW5lR2VvbWV0cnksIF9jb25lR2VvbWV0cnk7CgpjbGFzcyBBcnJvd0hlbHBlciBleHRlbmRzIE9iamVjdDNEIHsKCgkvLyBkaXIgaXMgYXNzdW1lZCB0byBiZSBub3JtYWxpemVkCgoJY29uc3RydWN0b3IoIGRpciA9IG5ldyBWZWN0b3IzKCAwLCAwLCAxICksIG9yaWdpbiA9IG5ldyBWZWN0b3IzKCAwLCAwLCAwICksIGxlbmd0aCA9IDEsIGNvbG9yID0gMHhmZmZmMDAsIGhlYWRMZW5ndGggPSBsZW5ndGggKiAwLjIsIGhlYWRXaWR0aCA9IGhlYWRMZW5ndGggKiAwLjIgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMudHlwZSA9ICdBcnJvd0hlbHBlcic7CgoJCWlmICggX2xpbmVHZW9tZXRyeSA9PT0gdW5kZWZpbmVkICkgewoKCQkJX2xpbmVHZW9tZXRyeSA9IG5ldyBCdWZmZXJHZW9tZXRyeSgpOwoJCQlfbGluZUdlb21ldHJ5LnNldEF0dHJpYnV0ZSggJ3Bvc2l0aW9uJywgbmV3IEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUoIFsgMCwgMCwgMCwgMCwgMSwgMCBdLCAzICkgKTsKCgkJCV9jb25lR2VvbWV0cnkgPSBuZXcgQ3lsaW5kZXJHZW9tZXRyeSggMCwgMC41LCAxLCA1LCAxICk7CgkJCV9jb25lR2VvbWV0cnkudHJhbnNsYXRlKCAwLCAtIDAuNSwgMCApOwoKCQl9CgoJCXRoaXMucG9zaXRpb24uY29weSggb3JpZ2luICk7CgoJCXRoaXMubGluZSA9IG5ldyBMaW5lKCBfbGluZUdlb21ldHJ5LCBuZXcgTGluZUJhc2ljTWF0ZXJpYWwoIHsgY29sb3I6IGNvbG9yLCB0b25lTWFwcGVkOiBmYWxzZSB9ICkgKTsKCQl0aGlzLmxpbmUubWF0cml4QXV0b1VwZGF0ZSA9IGZhbHNlOwoJCXRoaXMuYWRkKCB0aGlzLmxpbmUgKTsKCgkJdGhpcy5jb25lID0gbmV3IE1lc2goIF9jb25lR2VvbWV0cnksIG5ldyBNZXNoQmFzaWNNYXRlcmlhbCggeyBjb2xvcjogY29sb3IsIHRvbmVNYXBwZWQ6IGZhbHNlIH0gKSApOwoJCXRoaXMuY29uZS5tYXRyaXhBdXRvVXBkYXRlID0gZmFsc2U7CgkJdGhpcy5hZGQoIHRoaXMuY29uZSApOwoKCQl0aGlzLnNldERpcmVjdGlvbiggZGlyICk7CgkJdGhpcy5zZXRMZW5ndGgoIGxlbmd0aCwgaGVhZExlbmd0aCwgaGVhZFdpZHRoICk7CgoJfQoKCXNldERpcmVjdGlvbiggZGlyICkgewoKCQkvLyBkaXIgaXMgYXNzdW1lZCB0byBiZSBub3JtYWxpemVkCgoJCWlmICggZGlyLnkgPiAwLjk5OTk5ICkgewoKCQkJdGhpcy5xdWF0ZXJuaW9uLnNldCggMCwgMCwgMCwgMSApOwoKCQl9IGVsc2UgaWYgKCBkaXIueSA8IC0gMC45OTk5OSApIHsKCgkJCXRoaXMucXVhdGVybmlvbi5zZXQoIDEsIDAsIDAsIDAgKTsKCgkJfSBlbHNlIHsKCgkJCV9heGlzLnNldCggZGlyLnosIDAsIC0gZGlyLnggKS5ub3JtYWxpemUoKTsKCgkJCWNvbnN0IHJhZGlhbnMgPSBNYXRoLmFjb3MoIGRpci55ICk7CgoJCQl0aGlzLnF1YXRlcm5pb24uc2V0RnJvbUF4aXNBbmdsZSggX2F4aXMsIHJhZGlhbnMgKTsKCgkJfQoKCX0KCglzZXRMZW5ndGgoIGxlbmd0aCwgaGVhZExlbmd0aCA9IGxlbmd0aCAqIDAuMiwgaGVhZFdpZHRoID0gaGVhZExlbmd0aCAqIDAuMiApIHsKCgkJdGhpcy5saW5lLnNjYWxlLnNldCggMSwgTWF0aC5tYXgoIDAuMDAwMSwgbGVuZ3RoIC0gaGVhZExlbmd0aCApLCAxICk7IC8vIHNlZSAjMTc0NTgKCQl0aGlzLmxpbmUudXBkYXRlTWF0cml4KCk7CgoJCXRoaXMuY29uZS5zY2FsZS5zZXQoIGhlYWRXaWR0aCwgaGVhZExlbmd0aCwgaGVhZFdpZHRoICk7CgkJdGhpcy5jb25lLnBvc2l0aW9uLnkgPSBsZW5ndGg7CgkJdGhpcy5jb25lLnVwZGF0ZU1hdHJpeCgpOwoKCX0KCglzZXRDb2xvciggY29sb3IgKSB7CgoJCXRoaXMubGluZS5tYXRlcmlhbC5jb2xvci5zZXQoIGNvbG9yICk7CgkJdGhpcy5jb25lLm1hdGVyaWFsLmNvbG9yLnNldCggY29sb3IgKTsKCgl9CgoJY29weSggc291cmNlICkgewoKCQlzdXBlci5jb3B5KCBzb3VyY2UsIGZhbHNlICk7CgoJCXRoaXMubGluZS5jb3B5KCBzb3VyY2UubGluZSApOwoJCXRoaXMuY29uZS5jb3B5KCBzb3VyY2UuY29uZSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJZGlzcG9zZSgpIHsKCgkJdGhpcy5saW5lLmdlb21ldHJ5LmRpc3Bvc2UoKTsKCQl0aGlzLmxpbmUubWF0ZXJpYWwuZGlzcG9zZSgpOwoJCXRoaXMuY29uZS5nZW9tZXRyeS5kaXNwb3NlKCk7CgkJdGhpcy5jb25lLm1hdGVyaWFsLmRpc3Bvc2UoKTsKCgl9Cgp9CgpjbGFzcyBBeGVzSGVscGVyIGV4dGVuZHMgTGluZVNlZ21lbnRzIHsKCgljb25zdHJ1Y3Rvciggc2l6ZSA9IDEgKSB7CgoJCWNvbnN0IHZlcnRpY2VzID0gWwoJCQkwLCAwLCAwLAlzaXplLCAwLCAwLAoJCQkwLCAwLCAwLAkwLCBzaXplLCAwLAoJCQkwLCAwLCAwLAkwLCAwLCBzaXplCgkJXTsKCgkJY29uc3QgY29sb3JzID0gWwoJCQkxLCAwLCAwLAkxLCAwLjYsIDAsCgkJCTAsIDEsIDAsCTAuNiwgMSwgMCwKCQkJMCwgMCwgMSwJMCwgMC42LCAxCgkJXTsKCgkJY29uc3QgZ2VvbWV0cnkgPSBuZXcgQnVmZmVyR2VvbWV0cnkoKTsKCQlnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoICdwb3NpdGlvbicsIG5ldyBGbG9hdDMyQnVmZmVyQXR0cmlidXRlKCB2ZXJ0aWNlcywgMyApICk7CgkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAnY29sb3InLCBuZXcgRmxvYXQzMkJ1ZmZlckF0dHJpYnV0ZSggY29sb3JzLCAzICkgKTsKCgkJY29uc3QgbWF0ZXJpYWwgPSBuZXcgTGluZUJhc2ljTWF0ZXJpYWwoIHsgdmVydGV4Q29sb3JzOiB0cnVlLCB0b25lTWFwcGVkOiBmYWxzZSB9ICk7CgoJCXN1cGVyKCBnZW9tZXRyeSwgbWF0ZXJpYWwgKTsKCgkJdGhpcy50eXBlID0gJ0F4ZXNIZWxwZXInOwoKCX0KCglzZXRDb2xvcnMoIHhBeGlzQ29sb3IsIHlBeGlzQ29sb3IsIHpBeGlzQ29sb3IgKSB7CgoJCWNvbnN0IGNvbG9yID0gbmV3IENvbG9yKCk7CgkJY29uc3QgYXJyYXkgPSB0aGlzLmdlb21ldHJ5LmF0dHJpYnV0ZXMuY29sb3IuYXJyYXk7CgoJCWNvbG9yLnNldCggeEF4aXNDb2xvciApOwoJCWNvbG9yLnRvQXJyYXkoIGFycmF5LCAwICk7CgkJY29sb3IudG9BcnJheSggYXJyYXksIDMgKTsKCgkJY29sb3Iuc2V0KCB5QXhpc0NvbG9yICk7CgkJY29sb3IudG9BcnJheSggYXJyYXksIDYgKTsKCQljb2xvci50b0FycmF5KCBhcnJheSwgOSApOwoKCQljb2xvci5zZXQoIHpBeGlzQ29sb3IgKTsKCQljb2xvci50b0FycmF5KCBhcnJheSwgMTIgKTsKCQljb2xvci50b0FycmF5KCBhcnJheSwgMTUgKTsKCgkJdGhpcy5nZW9tZXRyeS5hdHRyaWJ1dGVzLmNvbG9yLm5lZWRzVXBkYXRlID0gdHJ1ZTsKCgkJcmV0dXJuIHRoaXM7CgoJfQoKCWRpc3Bvc2UoKSB7CgoJCXRoaXMuZ2VvbWV0cnkuZGlzcG9zZSgpOwoJCXRoaXMubWF0ZXJpYWwuZGlzcG9zZSgpOwoKCX0KCn0KCmNsYXNzIFNoYXBlUGF0aCB7CgoJY29uc3RydWN0b3IoKSB7CgoJCXRoaXMudHlwZSA9ICdTaGFwZVBhdGgnOwoKCQl0aGlzLmNvbG9yID0gbmV3IENvbG9yKCk7CgoJCXRoaXMuc3ViUGF0aHMgPSBbXTsKCQl0aGlzLmN1cnJlbnRQYXRoID0gbnVsbDsKCgl9CgoJbW92ZVRvKCB4LCB5ICkgewoKCQl0aGlzLmN1cnJlbnRQYXRoID0gbmV3IFBhdGgoKTsKCQl0aGlzLnN1YlBhdGhzLnB1c2goIHRoaXMuY3VycmVudFBhdGggKTsKCQl0aGlzLmN1cnJlbnRQYXRoLm1vdmVUbyggeCwgeSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJbGluZVRvKCB4LCB5ICkgewoKCQl0aGlzLmN1cnJlbnRQYXRoLmxpbmVUbyggeCwgeSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJcXVhZHJhdGljQ3VydmVUbyggYUNQeCwgYUNQeSwgYVgsIGFZICkgewoKCQl0aGlzLmN1cnJlbnRQYXRoLnF1YWRyYXRpY0N1cnZlVG8oIGFDUHgsIGFDUHksIGFYLCBhWSApOwoKCQlyZXR1cm4gdGhpczsKCgl9CgoJYmV6aWVyQ3VydmVUbyggYUNQMXgsIGFDUDF5LCBhQ1AyeCwgYUNQMnksIGFYLCBhWSApIHsKCgkJdGhpcy5jdXJyZW50UGF0aC5iZXppZXJDdXJ2ZVRvKCBhQ1AxeCwgYUNQMXksIGFDUDJ4LCBhQ1AyeSwgYVgsIGFZICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCglzcGxpbmVUaHJ1KCBwdHMgKSB7CgoJCXRoaXMuY3VycmVudFBhdGguc3BsaW5lVGhydSggcHRzICk7CgoJCXJldHVybiB0aGlzOwoKCX0KCgl0b1NoYXBlcyggaXNDQ1cgKSB7CgoJCWZ1bmN0aW9uIHRvU2hhcGVzTm9Ib2xlcyggaW5TdWJwYXRocyApIHsKCgkJCWNvbnN0IHNoYXBlcyA9IFtdOwoKCQkJZm9yICggbGV0IGkgPSAwLCBsID0gaW5TdWJwYXRocy5sZW5ndGg7IGkgPCBsOyBpICsrICkgewoKCQkJCWNvbnN0IHRtcFBhdGggPSBpblN1YnBhdGhzWyBpIF07CgoJCQkJY29uc3QgdG1wU2hhcGUgPSBuZXcgU2hhcGUoKTsKCQkJCXRtcFNoYXBlLmN1cnZlcyA9IHRtcFBhdGguY3VydmVzOwoKCQkJCXNoYXBlcy5wdXNoKCB0bXBTaGFwZSApOwoKCQkJfQoKCQkJcmV0dXJuIHNoYXBlczsKCgkJfQoKCQlmdW5jdGlvbiBpc1BvaW50SW5zaWRlUG9seWdvbiggaW5QdCwgaW5Qb2x5Z29uICkgewoKCQkJY29uc3QgcG9seUxlbiA9IGluUG9seWdvbi5sZW5ndGg7CgoJCQkvLyBpblB0IG9uIHBvbHlnb24gY29udG91ciA9PiBpbW1lZGlhdGUgc3VjY2VzcyAgICBvcgoJCQkvLyB0b2dnbGluZyBvZiBpbnNpZGUvb3V0c2lkZSBhdCBldmVyeSBzaW5nbGUhIGludGVyc2VjdGlvbiBwb2ludCBvZiBhbiBlZGdlCgkJCS8vICB3aXRoIHRoZSBob3Jpem9udGFsIGxpbmUgdGhyb3VnaCBpblB0LCBsZWZ0IG9mIGluUHQKCQkJLy8gIG5vdCBjb3VudGluZyBsb3dlclkgZW5kcG9pbnRzIG9mIGVkZ2VzIGFuZCB3aG9sZSBlZGdlcyBvbiB0aGF0IGxpbmUKCQkJbGV0IGluc2lkZSA9IGZhbHNlOwoJCQlmb3IgKCBsZXQgcCA9IHBvbHlMZW4gLSAxLCBxID0gMDsgcSA8IHBvbHlMZW47IHAgPSBxICsrICkgewoKCQkJCWxldCBlZGdlTG93UHQgPSBpblBvbHlnb25bIHAgXTsKCQkJCWxldCBlZGdlSGlnaFB0ID0gaW5Qb2x5Z29uWyBxIF07CgoJCQkJbGV0IGVkZ2VEeCA9IGVkZ2VIaWdoUHQueCAtIGVkZ2VMb3dQdC54OwoJCQkJbGV0IGVkZ2VEeSA9IGVkZ2VIaWdoUHQueSAtIGVkZ2VMb3dQdC55OwoKCQkJCWlmICggTWF0aC5hYnMoIGVkZ2VEeSApID4gTnVtYmVyLkVQU0lMT04gKSB7CgoJCQkJCS8vIG5vdCBwYXJhbGxlbAoJCQkJCWlmICggZWRnZUR5IDwgMCApIHsKCgkJCQkJCWVkZ2VMb3dQdCA9IGluUG9seWdvblsgcSBdOyBlZGdlRHggPSAtIGVkZ2VEeDsKCQkJCQkJZWRnZUhpZ2hQdCA9IGluUG9seWdvblsgcCBdOyBlZGdlRHkgPSAtIGVkZ2VEeTsKCgkJCQkJfQoKCQkJCQlpZiAoICggaW5QdC55IDwgZWRnZUxvd1B0LnkgKSB8fCAoIGluUHQueSA+IGVkZ2VIaWdoUHQueSApICkgCQljb250aW51ZTsKCgkJCQkJaWYgKCBpblB0LnkgPT09IGVkZ2VMb3dQdC55ICkgewoKCQkJCQkJaWYgKCBpblB0LnggPT09IGVkZ2VMb3dQdC54ICkJCXJldHVybgl0cnVlOwkJLy8gaW5QdCBpcyBvbiBjb250b3VyID8KCQkJCQkJLy8gY29udGludWU7CQkJCS8vIG5vIGludGVyc2VjdGlvbiBvciBlZGdlTG93UHQgPT4gZG9lc24ndCBjb3VudCAhISEKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCWNvbnN0IHBlcnBFZGdlID0gZWRnZUR5ICogKCBpblB0LnggLSBlZGdlTG93UHQueCApIC0gZWRnZUR4ICogKCBpblB0LnkgLSBlZGdlTG93UHQueSApOwoJCQkJCQlpZiAoIHBlcnBFZGdlID09PSAwICkJCQkJcmV0dXJuCXRydWU7CQkvLyBpblB0IGlzIG9uIGNvbnRvdXIgPwoJCQkJCQlpZiAoIHBlcnBFZGdlIDwgMCApIAkJCQljb250aW51ZTsKCQkJCQkJaW5zaWRlID0gISBpbnNpZGU7CQkvLyB0cnVlIGludGVyc2VjdGlvbiBsZWZ0IG9mIGluUHQKCgkJCQkJfQoKCQkJCX0gZWxzZSB7CgoJCQkJCS8vIHBhcmFsbGVsIG9yIGNvbGxpbmVhcgoJCQkJCWlmICggaW5QdC55ICE9PSBlZGdlTG93UHQueSApIAkJY29udGludWU7CQkJLy8gcGFyYWxsZWwKCQkJCQkvLyBlZGdlIGxpZXMgb24gdGhlIHNhbWUgaG9yaXpvbnRhbCBsaW5lIGFzIGluUHQKCQkJCQlpZiAoICggKCBlZGdlSGlnaFB0LnggPD0gaW5QdC54ICkgJiYgKCBpblB0LnggPD0gZWRnZUxvd1B0LnggKSApIHx8CgkJCQkJCSAoICggZWRnZUxvd1B0LnggPD0gaW5QdC54ICkgJiYgKCBpblB0LnggPD0gZWRnZUhpZ2hQdC54ICkgKSApCQlyZXR1cm4JdHJ1ZTsJLy8gaW5QdDogUG9pbnQgb24gY29udG91ciAhCgkJCQkJLy8gY29udGludWU7CgoJCQkJfQoKCQkJfQoKCQkJcmV0dXJuCWluc2lkZTsKCgkJfQoKCQljb25zdCBpc0Nsb2NrV2lzZSA9IFNoYXBlVXRpbHMuaXNDbG9ja1dpc2U7CgoJCWNvbnN0IHN1YlBhdGhzID0gdGhpcy5zdWJQYXRoczsKCQlpZiAoIHN1YlBhdGhzLmxlbmd0aCA9PT0gMCApIHJldHVybiBbXTsKCgkJbGV0IHNvbGlkLCB0bXBQYXRoLCB0bXBTaGFwZTsKCQljb25zdCBzaGFwZXMgPSBbXTsKCgkJaWYgKCBzdWJQYXRocy5sZW5ndGggPT09IDEgKSB7CgoJCQl0bXBQYXRoID0gc3ViUGF0aHNbIDAgXTsKCQkJdG1wU2hhcGUgPSBuZXcgU2hhcGUoKTsKCQkJdG1wU2hhcGUuY3VydmVzID0gdG1wUGF0aC5jdXJ2ZXM7CgkJCXNoYXBlcy5wdXNoKCB0bXBTaGFwZSApOwoJCQlyZXR1cm4gc2hhcGVzOwoKCQl9CgoJCWxldCBob2xlc0ZpcnN0ID0gISBpc0Nsb2NrV2lzZSggc3ViUGF0aHNbIDAgXS5nZXRQb2ludHMoKSApOwoJCWhvbGVzRmlyc3QgPSBpc0NDVyA/ICEgaG9sZXNGaXJzdCA6IGhvbGVzRmlyc3Q7CgoJCS8vIGNvbnNvbGUubG9nKCJIb2xlcyBmaXJzdCIsIGhvbGVzRmlyc3QpOwoKCQljb25zdCBiZXR0ZXJTaGFwZUhvbGVzID0gW107CgkJY29uc3QgbmV3U2hhcGVzID0gW107CgkJbGV0IG5ld1NoYXBlSG9sZXMgPSBbXTsKCQlsZXQgbWFpbklkeCA9IDA7CgkJbGV0IHRtcFBvaW50czsKCgkJbmV3U2hhcGVzWyBtYWluSWR4IF0gPSB1bmRlZmluZWQ7CgkJbmV3U2hhcGVIb2xlc1sgbWFpbklkeCBdID0gW107CgoJCWZvciAoIGxldCBpID0gMCwgbCA9IHN1YlBhdGhzLmxlbmd0aDsgaSA8IGw7IGkgKysgKSB7CgoJCQl0bXBQYXRoID0gc3ViUGF0aHNbIGkgXTsKCQkJdG1wUG9pbnRzID0gdG1wUGF0aC5nZXRQb2ludHMoKTsKCQkJc29saWQgPSBpc0Nsb2NrV2lzZSggdG1wUG9pbnRzICk7CgkJCXNvbGlkID0gaXNDQ1cgPyAhIHNvbGlkIDogc29saWQ7CgoJCQlpZiAoIHNvbGlkICkgewoKCQkJCWlmICggKCAhIGhvbGVzRmlyc3QgKSAmJiAoIG5ld1NoYXBlc1sgbWFpbklkeCBdICkgKQltYWluSWR4ICsrOwoKCQkJCW5ld1NoYXBlc1sgbWFpbklkeCBdID0geyBzOiBuZXcgU2hhcGUoKSwgcDogdG1wUG9pbnRzIH07CgkJCQluZXdTaGFwZXNbIG1haW5JZHggXS5zLmN1cnZlcyA9IHRtcFBhdGguY3VydmVzOwoKCQkJCWlmICggaG9sZXNGaXJzdCApCW1haW5JZHggKys7CgkJCQluZXdTaGFwZUhvbGVzWyBtYWluSWR4IF0gPSBbXTsKCgkJCQkvL2NvbnNvbGUubG9nKCdjdycsIGkpOwoKCQkJfSBlbHNlIHsKCgkJCQluZXdTaGFwZUhvbGVzWyBtYWluSWR4IF0ucHVzaCggeyBoOiB0bXBQYXRoLCBwOiB0bXBQb2ludHNbIDAgXSB9ICk7CgoJCQkJLy9jb25zb2xlLmxvZygnY2N3JywgaSk7CgoJCQl9CgoJCX0KCgkJLy8gb25seSBIb2xlcz8gLT4gcHJvYmFibHkgYWxsIFNoYXBlcyB3aXRoIHdyb25nIG9yaWVudGF0aW9uCgkJaWYgKCAhIG5ld1NoYXBlc1sgMCBdICkJcmV0dXJuCXRvU2hhcGVzTm9Ib2xlcyggc3ViUGF0aHMgKTsKCgoJCWlmICggbmV3U2hhcGVzLmxlbmd0aCA+IDEgKSB7CgoJCQlsZXQgYW1iaWd1b3VzID0gZmFsc2U7CgkJCWxldCB0b0NoYW5nZSA9IDA7CgoJCQlmb3IgKCBsZXQgc0lkeCA9IDAsIHNMZW4gPSBuZXdTaGFwZXMubGVuZ3RoOyBzSWR4IDwgc0xlbjsgc0lkeCArKyApIHsKCgkJCQliZXR0ZXJTaGFwZUhvbGVzWyBzSWR4IF0gPSBbXTsKCgkJCX0KCgkJCWZvciAoIGxldCBzSWR4ID0gMCwgc0xlbiA9IG5ld1NoYXBlcy5sZW5ndGg7IHNJZHggPCBzTGVuOyBzSWR4ICsrICkgewoKCQkJCWNvbnN0IHNobyA9IG5ld1NoYXBlSG9sZXNbIHNJZHggXTsKCgkJCQlmb3IgKCBsZXQgaElkeCA9IDA7IGhJZHggPCBzaG8ubGVuZ3RoOyBoSWR4ICsrICkgewoKCQkJCQljb25zdCBobyA9IHNob1sgaElkeCBdOwoJCQkJCWxldCBob2xlX3VuYXNzaWduZWQgPSB0cnVlOwoKCQkJCQlmb3IgKCBsZXQgczJJZHggPSAwOyBzMklkeCA8IG5ld1NoYXBlcy5sZW5ndGg7IHMySWR4ICsrICkgewoKCQkJCQkJaWYgKCBpc1BvaW50SW5zaWRlUG9seWdvbiggaG8ucCwgbmV3U2hhcGVzWyBzMklkeCBdLnAgKSApIHsKCgkJCQkJCQlpZiAoIHNJZHggIT09IHMySWR4ICkJdG9DaGFuZ2UgKys7CgoJCQkJCQkJaWYgKCBob2xlX3VuYXNzaWduZWQgKSB7CgoJCQkJCQkJCWhvbGVfdW5hc3NpZ25lZCA9IGZhbHNlOwoJCQkJCQkJCWJldHRlclNoYXBlSG9sZXNbIHMySWR4IF0ucHVzaCggaG8gKTsKCgkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQlhbWJpZ3VvdXMgPSB0cnVlOwoKCQkJCQkJCX0KCgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAoIGhvbGVfdW5hc3NpZ25lZCApIHsKCgkJCQkJCWJldHRlclNoYXBlSG9sZXNbIHNJZHggXS5wdXNoKCBobyApOwoKCQkJCQl9CgoJCQkJfQoKCQkJfQoKCQkJaWYgKCB0b0NoYW5nZSA+IDAgJiYgYW1iaWd1b3VzID09PSBmYWxzZSApIHsKCgkJCQluZXdTaGFwZUhvbGVzID0gYmV0dGVyU2hhcGVIb2xlczsKCgkJCX0KCgkJfQoKCQlsZXQgdG1wSG9sZXM7CgoJCWZvciAoIGxldCBpID0gMCwgaWwgPSBuZXdTaGFwZXMubGVuZ3RoOyBpIDwgaWw7IGkgKysgKSB7CgoJCQl0bXBTaGFwZSA9IG5ld1NoYXBlc1sgaSBdLnM7CgkJCXNoYXBlcy5wdXNoKCB0bXBTaGFwZSApOwoJCQl0bXBIb2xlcyA9IG5ld1NoYXBlSG9sZXNbIGkgXTsKCgkJCWZvciAoIGxldCBqID0gMCwgamwgPSB0bXBIb2xlcy5sZW5ndGg7IGogPCBqbDsgaiArKyApIHsKCgkJCQl0bXBTaGFwZS5ob2xlcy5wdXNoKCB0bXBIb2xlc1sgaiBdLmggKTsKCgkJCX0KCgkJfQoKCQkvL2NvbnNvbGUubG9nKCJzaGFwZSIsIHNoYXBlcyk7CgoJCXJldHVybiBzaGFwZXM7CgoJfQoKfQoKaWYgKCB0eXBlb2YgX19USFJFRV9ERVZUT09MU19fICE9PSAndW5kZWZpbmVkJyApIHsKCglfX1RIUkVFX0RFVlRPT0xTX18uZGlzcGF0Y2hFdmVudCggbmV3IEN1c3RvbUV2ZW50KCAncmVnaXN0ZXInLCB7IGRldGFpbDogewoJCXJldmlzaW9uOiBSRVZJU0lPTiwKCX0gfSApICk7Cgp9CgppZiAoIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICkgewoKCWlmICggd2luZG93Ll9fVEhSRUVfXyApIHsKCgkJY29uc29sZS53YXJuKCAnV0FSTklORzogTXVsdGlwbGUgaW5zdGFuY2VzIG9mIFRocmVlLmpzIGJlaW5nIGltcG9ydGVkLicgKTsKCgl9IGVsc2UgewoKCQl3aW5kb3cuX19USFJFRV9fID0gUkVWSVNJT047CgoJfQoKfQoKZXhwb3J0IHsgQUNFU0ZpbG1pY1RvbmVNYXBwaW5nLCBBZGRFcXVhdGlvbiwgQWRkT3BlcmF0aW9uLCBBZGRpdGl2ZUFuaW1hdGlvbkJsZW5kTW9kZSwgQWRkaXRpdmVCbGVuZGluZywgQWdYVG9uZU1hcHBpbmcsIEFscGhhRm9ybWF0LCBBbHdheXNDb21wYXJlLCBBbHdheXNEZXB0aCwgQWx3YXlzU3RlbmNpbEZ1bmMsIEFtYmllbnRMaWdodCwgQW5pbWF0aW9uQWN0aW9uLCBBbmltYXRpb25DbGlwLCBBbmltYXRpb25Mb2FkZXIsIEFuaW1hdGlvbk1peGVyLCBBbmltYXRpb25PYmplY3RHcm91cCwgQW5pbWF0aW9uVXRpbHMsIEFyY0N1cnZlLCBBcnJheUNhbWVyYSwgQXJyb3dIZWxwZXIsIEF0dGFjaGVkQmluZE1vZGUsIEF1ZGlvLCBBdWRpb0FuYWx5c2VyLCBBdWRpb0NvbnRleHQsIEF1ZGlvTGlzdGVuZXIsIEF1ZGlvTG9hZGVyLCBBeGVzSGVscGVyLCBCYWNrU2lkZSwgQmFzaWNEZXB0aFBhY2tpbmcsIEJhc2ljU2hhZG93TWFwLCBCYXRjaGVkTWVzaCwgQm9uZSwgQm9vbGVhbktleWZyYW1lVHJhY2ssIEJveDIsIEJveDMsIEJveDNIZWxwZXIsIEJveEdlb21ldHJ5LCBCb3hIZWxwZXIsIEJ1ZmZlckF0dHJpYnV0ZSwgQnVmZmVyR2VvbWV0cnksIEJ1ZmZlckdlb21ldHJ5TG9hZGVyLCBCeXRlVHlwZSwgQ2FjaGUsIENhbWVyYSwgQ2FtZXJhSGVscGVyLCBDYW52YXNUZXh0dXJlLCBDYXBzdWxlR2VvbWV0cnksIENhdG11bGxSb21DdXJ2ZTMsIENpbmVvblRvbmVNYXBwaW5nLCBDaXJjbGVHZW9tZXRyeSwgQ2xhbXBUb0VkZ2VXcmFwcGluZywgQ2xvY2ssIENvbG9yLCBDb2xvcktleWZyYW1lVHJhY2ssIENvbG9yTWFuYWdlbWVudCwgQ29tcHJlc3NlZEFycmF5VGV4dHVyZSwgQ29tcHJlc3NlZEN1YmVUZXh0dXJlLCBDb21wcmVzc2VkVGV4dHVyZSwgQ29tcHJlc3NlZFRleHR1cmVMb2FkZXIsIENvbmVHZW9tZXRyeSwgQ29uc3RhbnRBbHBoYUZhY3RvciwgQ29uc3RhbnRDb2xvckZhY3RvciwgQ3ViZUNhbWVyYSwgQ3ViZVJlZmxlY3Rpb25NYXBwaW5nLCBDdWJlUmVmcmFjdGlvbk1hcHBpbmcsIEN1YmVUZXh0dXJlLCBDdWJlVGV4dHVyZUxvYWRlciwgQ3ViZVVWUmVmbGVjdGlvbk1hcHBpbmcsIEN1YmljQmV6aWVyQ3VydmUsIEN1YmljQmV6aWVyQ3VydmUzLCBDdWJpY0ludGVycG9sYW50LCBDdWxsRmFjZUJhY2ssIEN1bGxGYWNlRnJvbnQsIEN1bGxGYWNlRnJvbnRCYWNrLCBDdWxsRmFjZU5vbmUsIEN1cnZlLCBDdXJ2ZVBhdGgsIEN1c3RvbUJsZW5kaW5nLCBDdXN0b21Ub25lTWFwcGluZywgQ3lsaW5kZXJHZW9tZXRyeSwgQ3lsaW5kcmljYWwsIERhdGEzRFRleHR1cmUsIERhdGFBcnJheVRleHR1cmUsIERhdGFUZXh0dXJlLCBEYXRhVGV4dHVyZUxvYWRlciwgRGF0YVV0aWxzLCBEZWNyZW1lbnRTdGVuY2lsT3AsIERlY3JlbWVudFdyYXBTdGVuY2lsT3AsIERlZmF1bHRMb2FkaW5nTWFuYWdlciwgRGVwdGhGb3JtYXQsIERlcHRoU3RlbmNpbEZvcm1hdCwgRGVwdGhUZXh0dXJlLCBEZXRhY2hlZEJpbmRNb2RlLCBEaXJlY3Rpb25hbExpZ2h0LCBEaXJlY3Rpb25hbExpZ2h0SGVscGVyLCBEaXNjcmV0ZUludGVycG9sYW50LCBEaXNwbGF5UDNDb2xvclNwYWNlLCBEb2RlY2FoZWRyb25HZW9tZXRyeSwgRG91YmxlU2lkZSwgRHN0QWxwaGFGYWN0b3IsIERzdENvbG9yRmFjdG9yLCBEeW5hbWljQ29weVVzYWdlLCBEeW5hbWljRHJhd1VzYWdlLCBEeW5hbWljUmVhZFVzYWdlLCBFZGdlc0dlb21ldHJ5LCBFbGxpcHNlQ3VydmUsIEVxdWFsQ29tcGFyZSwgRXF1YWxEZXB0aCwgRXF1YWxTdGVuY2lsRnVuYywgRXF1aXJlY3Rhbmd1bGFyUmVmbGVjdGlvbk1hcHBpbmcsIEVxdWlyZWN0YW5ndWxhclJlZnJhY3Rpb25NYXBwaW5nLCBFdWxlciwgRXZlbnREaXNwYXRjaGVyLCBFeHRydWRlR2VvbWV0cnksIEZpbGVMb2FkZXIsIEZsb2F0MTZCdWZmZXJBdHRyaWJ1dGUsIEZsb2F0MzJCdWZmZXJBdHRyaWJ1dGUsIEZsb2F0NjRCdWZmZXJBdHRyaWJ1dGUsIEZsb2F0VHlwZSwgRm9nLCBGb2dFeHAyLCBGcmFtZWJ1ZmZlclRleHR1cmUsIEZyb250U2lkZSwgRnJ1c3R1bSwgR0xCdWZmZXJBdHRyaWJ1dGUsIEdMU0wxLCBHTFNMMywgR3JlYXRlckNvbXBhcmUsIEdyZWF0ZXJEZXB0aCwgR3JlYXRlckVxdWFsQ29tcGFyZSwgR3JlYXRlckVxdWFsRGVwdGgsIEdyZWF0ZXJFcXVhbFN0ZW5jaWxGdW5jLCBHcmVhdGVyU3RlbmNpbEZ1bmMsIEdyaWRIZWxwZXIsIEdyb3VwLCBIYWxmRmxvYXRUeXBlLCBIZW1pc3BoZXJlTGlnaHQsIEhlbWlzcGhlcmVMaWdodEhlbHBlciwgSWNvc2FoZWRyb25HZW9tZXRyeSwgSW1hZ2VCaXRtYXBMb2FkZXIsIEltYWdlTG9hZGVyLCBJbWFnZVV0aWxzLCBJbmNyZW1lbnRTdGVuY2lsT3AsIEluY3JlbWVudFdyYXBTdGVuY2lsT3AsIEluc3RhbmNlZEJ1ZmZlckF0dHJpYnV0ZSwgSW5zdGFuY2VkQnVmZmVyR2VvbWV0cnksIEluc3RhbmNlZEludGVybGVhdmVkQnVmZmVyLCBJbnN0YW5jZWRNZXNoLCBJbnQxNkJ1ZmZlckF0dHJpYnV0ZSwgSW50MzJCdWZmZXJBdHRyaWJ1dGUsIEludDhCdWZmZXJBdHRyaWJ1dGUsIEludFR5cGUsIEludGVybGVhdmVkQnVmZmVyLCBJbnRlcmxlYXZlZEJ1ZmZlckF0dHJpYnV0ZSwgSW50ZXJwb2xhbnQsIEludGVycG9sYXRlRGlzY3JldGUsIEludGVycG9sYXRlTGluZWFyLCBJbnRlcnBvbGF0ZVNtb290aCwgSW52ZXJ0U3RlbmNpbE9wLCBLZWVwU3RlbmNpbE9wLCBLZXlmcmFtZVRyYWNrLCBMT0QsIExhdGhlR2VvbWV0cnksIExheWVycywgTGVzc0NvbXBhcmUsIExlc3NEZXB0aCwgTGVzc0VxdWFsQ29tcGFyZSwgTGVzc0VxdWFsRGVwdGgsIExlc3NFcXVhbFN0ZW5jaWxGdW5jLCBMZXNzU3RlbmNpbEZ1bmMsIExpZ2h0LCBMaWdodFByb2JlLCBMaW5lLCBMaW5lMywgTGluZUJhc2ljTWF0ZXJpYWwsIExpbmVDdXJ2ZSwgTGluZUN1cnZlMywgTGluZURhc2hlZE1hdGVyaWFsLCBMaW5lTG9vcCwgTGluZVNlZ21lbnRzLCBMaW5lYXJEaXNwbGF5UDNDb2xvclNwYWNlLCBMaW5lYXJFbmNvZGluZywgTGluZWFyRmlsdGVyLCBMaW5lYXJJbnRlcnBvbGFudCwgTGluZWFyTWlwTWFwTGluZWFyRmlsdGVyLCBMaW5lYXJNaXBNYXBOZWFyZXN0RmlsdGVyLCBMaW5lYXJNaXBtYXBMaW5lYXJGaWx0ZXIsIExpbmVhck1pcG1hcE5lYXJlc3RGaWx0ZXIsIExpbmVhclNSR0JDb2xvclNwYWNlLCBMaW5lYXJUb25lTWFwcGluZywgTGluZWFyVHJhbnNmZXIsIExvYWRlciwgTG9hZGVyVXRpbHMsIExvYWRpbmdNYW5hZ2VyLCBMb29wT25jZSwgTG9vcFBpbmdQb25nLCBMb29wUmVwZWF0LCBMdW1pbmFuY2VBbHBoYUZvcm1hdCwgTHVtaW5hbmNlRm9ybWF0LCBNT1VTRSwgTWF0ZXJpYWwsIE1hdGVyaWFsTG9hZGVyLCBNYXRoVXRpbHMsIE1hdHJpeDMsIE1hdHJpeDQsIE1heEVxdWF0aW9uLCBNZXNoLCBNZXNoQmFzaWNNYXRlcmlhbCwgTWVzaERlcHRoTWF0ZXJpYWwsIE1lc2hEaXN0YW5jZU1hdGVyaWFsLCBNZXNoTGFtYmVydE1hdGVyaWFsLCBNZXNoTWF0Y2FwTWF0ZXJpYWwsIE1lc2hOb3JtYWxNYXRlcmlhbCwgTWVzaFBob25nTWF0ZXJpYWwsIE1lc2hQaHlzaWNhbE1hdGVyaWFsLCBNZXNoU3RhbmRhcmRNYXRlcmlhbCwgTWVzaFRvb25NYXRlcmlhbCwgTWluRXF1YXRpb24sIE1pcnJvcmVkUmVwZWF0V3JhcHBpbmcsIE1peE9wZXJhdGlvbiwgTXVsdGlwbHlCbGVuZGluZywgTXVsdGlwbHlPcGVyYXRpb24sIE5lYXJlc3RGaWx0ZXIsIE5lYXJlc3RNaXBNYXBMaW5lYXJGaWx0ZXIsIE5lYXJlc3RNaXBNYXBOZWFyZXN0RmlsdGVyLCBOZWFyZXN0TWlwbWFwTGluZWFyRmlsdGVyLCBOZWFyZXN0TWlwbWFwTmVhcmVzdEZpbHRlciwgTmV2ZXJDb21wYXJlLCBOZXZlckRlcHRoLCBOZXZlclN0ZW5jaWxGdW5jLCBOb0JsZW5kaW5nLCBOb0NvbG9yU3BhY2UsIE5vVG9uZU1hcHBpbmcsIE5vcm1hbEFuaW1hdGlvbkJsZW5kTW9kZSwgTm9ybWFsQmxlbmRpbmcsIE5vdEVxdWFsQ29tcGFyZSwgTm90RXF1YWxEZXB0aCwgTm90RXF1YWxTdGVuY2lsRnVuYywgTnVtYmVyS2V5ZnJhbWVUcmFjaywgT2JqZWN0M0QsIE9iamVjdExvYWRlciwgT2JqZWN0U3BhY2VOb3JtYWxNYXAsIE9jdGFoZWRyb25HZW9tZXRyeSwgT25lRmFjdG9yLCBPbmVNaW51c0NvbnN0YW50QWxwaGFGYWN0b3IsIE9uZU1pbnVzQ29uc3RhbnRDb2xvckZhY3RvciwgT25lTWludXNEc3RBbHBoYUZhY3RvciwgT25lTWludXNEc3RDb2xvckZhY3RvciwgT25lTWludXNTcmNBbHBoYUZhY3RvciwgT25lTWludXNTcmNDb2xvckZhY3RvciwgT3J0aG9ncmFwaGljQ2FtZXJhLCBQM1ByaW1hcmllcywgUENGU2hhZG93TWFwLCBQQ0ZTb2Z0U2hhZG93TWFwLCBQTVJFTUdlbmVyYXRvciwgUGF0aCwgUGVyc3BlY3RpdmVDYW1lcmEsIFBsYW5lLCBQbGFuZUdlb21ldHJ5LCBQbGFuZUhlbHBlciwgUG9pbnRMaWdodCwgUG9pbnRMaWdodEhlbHBlciwgUG9pbnRzLCBQb2ludHNNYXRlcmlhbCwgUG9sYXJHcmlkSGVscGVyLCBQb2x5aGVkcm9uR2VvbWV0cnksIFBvc2l0aW9uYWxBdWRpbywgUHJvcGVydHlCaW5kaW5nLCBQcm9wZXJ0eU1peGVyLCBRdWFkcmF0aWNCZXppZXJDdXJ2ZSwgUXVhZHJhdGljQmV6aWVyQ3VydmUzLCBRdWF0ZXJuaW9uLCBRdWF0ZXJuaW9uS2V5ZnJhbWVUcmFjaywgUXVhdGVybmlvbkxpbmVhckludGVycG9sYW50LCBSRURfR1JFRU5fUkdUQzJfRm9ybWF0LCBSRURfUkdUQzFfRm9ybWF0LCBSRVZJU0lPTiwgUkdCQURlcHRoUGFja2luZywgUkdCQUZvcm1hdCwgUkdCQUludGVnZXJGb3JtYXQsIFJHQkFfQVNUQ18xMHgxMF9Gb3JtYXQsIFJHQkFfQVNUQ18xMHg1X0Zvcm1hdCwgUkdCQV9BU1RDXzEweDZfRm9ybWF0LCBSR0JBX0FTVENfMTB4OF9Gb3JtYXQsIFJHQkFfQVNUQ18xMngxMF9Gb3JtYXQsIFJHQkFfQVNUQ18xMngxMl9Gb3JtYXQsIFJHQkFfQVNUQ180eDRfRm9ybWF0LCBSR0JBX0FTVENfNXg0X0Zvcm1hdCwgUkdCQV9BU1RDXzV4NV9Gb3JtYXQsIFJHQkFfQVNUQ182eDVfRm9ybWF0LCBSR0JBX0FTVENfNng2X0Zvcm1hdCwgUkdCQV9BU1RDXzh4NV9Gb3JtYXQsIFJHQkFfQVNUQ184eDZfRm9ybWF0LCBSR0JBX0FTVENfOHg4X0Zvcm1hdCwgUkdCQV9CUFRDX0Zvcm1hdCwgUkdCQV9FVEMyX0VBQ19Gb3JtYXQsIFJHQkFfUFZSVENfMkJQUFYxX0Zvcm1hdCwgUkdCQV9QVlJUQ180QlBQVjFfRm9ybWF0LCBSR0JBX1MzVENfRFhUMV9Gb3JtYXQsIFJHQkFfUzNUQ19EWFQzX0Zvcm1hdCwgUkdCQV9TM1RDX0RYVDVfRm9ybWF0LCBSR0JfQlBUQ19TSUdORURfRm9ybWF0LCBSR0JfQlBUQ19VTlNJR05FRF9Gb3JtYXQsIFJHQl9FVEMxX0Zvcm1hdCwgUkdCX0VUQzJfRm9ybWF0LCBSR0JfUFZSVENfMkJQUFYxX0Zvcm1hdCwgUkdCX1BWUlRDXzRCUFBWMV9Gb3JtYXQsIFJHQl9TM1RDX0RYVDFfRm9ybWF0LCBSR0Zvcm1hdCwgUkdJbnRlZ2VyRm9ybWF0LCBSYXdTaGFkZXJNYXRlcmlhbCwgUmF5LCBSYXljYXN0ZXIsIFJlYzcwOVByaW1hcmllcywgUmVjdEFyZWFMaWdodCwgUmVkRm9ybWF0LCBSZWRJbnRlZ2VyRm9ybWF0LCBSZWluaGFyZFRvbmVNYXBwaW5nLCBSZW5kZXJUYXJnZXQsIFJlcGVhdFdyYXBwaW5nLCBSZXBsYWNlU3RlbmNpbE9wLCBSZXZlcnNlU3VidHJhY3RFcXVhdGlvbiwgUmluZ0dlb21ldHJ5LCBTSUdORURfUkVEX0dSRUVOX1JHVEMyX0Zvcm1hdCwgU0lHTkVEX1JFRF9SR1RDMV9Gb3JtYXQsIFNSR0JDb2xvclNwYWNlLCBTUkdCVHJhbnNmZXIsIFNjZW5lLCBTaGFkZXJDaHVuaywgU2hhZGVyTGliLCBTaGFkZXJNYXRlcmlhbCwgU2hhZG93TWF0ZXJpYWwsIFNoYXBlLCBTaGFwZUdlb21ldHJ5LCBTaGFwZVBhdGgsIFNoYXBlVXRpbHMsIFNob3J0VHlwZSwgU2tlbGV0b24sIFNrZWxldG9uSGVscGVyLCBTa2lubmVkTWVzaCwgU291cmNlLCBTcGhlcmUsIFNwaGVyZUdlb21ldHJ5LCBTcGhlcmljYWwsIFNwaGVyaWNhbEhhcm1vbmljczMsIFNwbGluZUN1cnZlLCBTcG90TGlnaHQsIFNwb3RMaWdodEhlbHBlciwgU3ByaXRlLCBTcHJpdGVNYXRlcmlhbCwgU3JjQWxwaGFGYWN0b3IsIFNyY0FscGhhU2F0dXJhdGVGYWN0b3IsIFNyY0NvbG9yRmFjdG9yLCBTdGF0aWNDb3B5VXNhZ2UsIFN0YXRpY0RyYXdVc2FnZSwgU3RhdGljUmVhZFVzYWdlLCBTdGVyZW9DYW1lcmEsIFN0cmVhbUNvcHlVc2FnZSwgU3RyZWFtRHJhd1VzYWdlLCBTdHJlYW1SZWFkVXNhZ2UsIFN0cmluZ0tleWZyYW1lVHJhY2ssIFN1YnRyYWN0RXF1YXRpb24sIFN1YnRyYWN0aXZlQmxlbmRpbmcsIFRPVUNILCBUYW5nZW50U3BhY2VOb3JtYWxNYXAsIFRldHJhaGVkcm9uR2VvbWV0cnksIFRleHR1cmUsIFRleHR1cmVMb2FkZXIsIFRvcnVzR2VvbWV0cnksIFRvcnVzS25vdEdlb21ldHJ5LCBUcmlhbmdsZSwgVHJpYW5nbGVGYW5EcmF3TW9kZSwgVHJpYW5nbGVTdHJpcERyYXdNb2RlLCBUcmlhbmdsZXNEcmF3TW9kZSwgVHViZUdlb21ldHJ5LCBVVk1hcHBpbmcsIFVpbnQxNkJ1ZmZlckF0dHJpYnV0ZSwgVWludDMyQnVmZmVyQXR0cmlidXRlLCBVaW50OEJ1ZmZlckF0dHJpYnV0ZSwgVWludDhDbGFtcGVkQnVmZmVyQXR0cmlidXRlLCBVbmlmb3JtLCBVbmlmb3Jtc0dyb3VwLCBVbmlmb3Jtc0xpYiwgVW5pZm9ybXNVdGlscywgVW5zaWduZWRCeXRlVHlwZSwgVW5zaWduZWRJbnQyNDhUeXBlLCBVbnNpZ25lZEludFR5cGUsIFVuc2lnbmVkU2hvcnQ0NDQ0VHlwZSwgVW5zaWduZWRTaG9ydDU1NTFUeXBlLCBVbnNpZ25lZFNob3J0VHlwZSwgVlNNU2hhZG93TWFwLCBWZWN0b3IyLCBWZWN0b3IzLCBWZWN0b3I0LCBWZWN0b3JLZXlmcmFtZVRyYWNrLCBWaWRlb1RleHR1cmUsIFdlYkdMMVJlbmRlcmVyLCBXZWJHTDNEUmVuZGVyVGFyZ2V0LCBXZWJHTEFycmF5UmVuZGVyVGFyZ2V0LCBXZWJHTENvb3JkaW5hdGVTeXN0ZW0sIFdlYkdMQ3ViZVJlbmRlclRhcmdldCwgV2ViR0xNdWx0aXBsZVJlbmRlclRhcmdldHMsIFdlYkdMUmVuZGVyVGFyZ2V0LCBXZWJHTFJlbmRlcmVyLCBXZWJHTFV0aWxzLCBXZWJHUFVDb29yZGluYXRlU3lzdGVtLCBXaXJlZnJhbWVHZW9tZXRyeSwgV3JhcEFyb3VuZEVuZGluZywgWmVyb0N1cnZhdHVyZUVuZGluZywgWmVyb0ZhY3RvciwgWmVyb1Nsb3BlRW5kaW5nLCBaZXJvU3RlbmNpbE9wLCBfU1JHQkFGb3JtYXQsIGNyZWF0ZUNhbnZhc0VsZW1lbnQsIHNSR0JFbmNvZGluZyB9Owo=",
    // 可选：three.min.js 的 base64
        INLINE_ORBIT_BASE64: "aW1wb3J0IHsKCUV2ZW50RGlzcGF0Y2hlciwKCU1PVVNFLAoJUXVhdGVybmlvbiwKCVNwaGVyaWNhbCwKCVRPVUNILAoJVmVjdG9yMiwKCVZlY3RvcjMsCglQbGFuZSwKCVJheSwKCU1hdGhVdGlscwp9IGZyb20gJ3RocmVlJzsKCi8vIE9yYml0Q29udHJvbHMgcGVyZm9ybXMgb3JiaXRpbmcsIGRvbGx5aW5nICh6b29taW5nKSwgYW5kIHBhbm5pbmcuCi8vIFVubGlrZSBUcmFja2JhbGxDb250cm9scywgaXQgbWFpbnRhaW5zIHRoZSAidXAiIGRpcmVjdGlvbiBvYmplY3QudXAgKCtZIGJ5IGRlZmF1bHQpLgovLwovLyAgICBPcmJpdCAtIGxlZnQgbW91c2UgLyB0b3VjaDogb25lLWZpbmdlciBtb3ZlCi8vICAgIFpvb20gLSBtaWRkbGUgbW91c2UsIG9yIG1vdXNld2hlZWwgLyB0b3VjaDogdHdvLWZpbmdlciBzcHJlYWQgb3Igc3F1aXNoCi8vICAgIFBhbiAtIHJpZ2h0IG1vdXNlLCBvciBsZWZ0IG1vdXNlICsgY3RybC9tZXRhL3NoaWZ0S2V5LCBvciBhcnJvdyBrZXlzIC8gdG91Y2g6IHR3by1maW5nZXIgbW92ZQoKY29uc3QgX2NoYW5nZUV2ZW50ID0geyB0eXBlOiAnY2hhbmdlJyB9Owpjb25zdCBfc3RhcnRFdmVudCA9IHsgdHlwZTogJ3N0YXJ0JyB9Owpjb25zdCBfZW5kRXZlbnQgPSB7IHR5cGU6ICdlbmQnIH07CmNvbnN0IF9yYXkgPSBuZXcgUmF5KCk7CmNvbnN0IF9wbGFuZSA9IG5ldyBQbGFuZSgpOwpjb25zdCBUSUxUX0xJTUlUID0gTWF0aC5jb3MoIDcwICogTWF0aFV0aWxzLkRFRzJSQUQgKTsKCmNsYXNzIE9yYml0Q29udHJvbHMgZXh0ZW5kcyBFdmVudERpc3BhdGNoZXIgewoKCWNvbnN0cnVjdG9yKCBvYmplY3QsIGRvbUVsZW1lbnQgKSB7CgoJCXN1cGVyKCk7CgoJCXRoaXMub2JqZWN0ID0gb2JqZWN0OwoJCXRoaXMuZG9tRWxlbWVudCA9IGRvbUVsZW1lbnQ7CgkJdGhpcy5kb21FbGVtZW50LnN0eWxlLnRvdWNoQWN0aW9uID0gJ25vbmUnOyAvLyBkaXNhYmxlIHRvdWNoIHNjcm9sbAoKCQkvLyBTZXQgdG8gZmFsc2UgdG8gZGlzYWJsZSB0aGlzIGNvbnRyb2wKCQl0aGlzLmVuYWJsZWQgPSB0cnVlOwoKCQkvLyAidGFyZ2V0IiBzZXRzIHRoZSBsb2NhdGlvbiBvZiBmb2N1cywgd2hlcmUgdGhlIG9iamVjdCBvcmJpdHMgYXJvdW5kCgkJdGhpcy50YXJnZXQgPSBuZXcgVmVjdG9yMygpOwoKCQkvLyBTZXRzIHRoZSAzRCBjdXJzb3IgKHNpbWlsYXIgdG8gQmxlbmRlciksIGZyb20gd2hpY2ggdGhlIG1heFRhcmdldFJhZGl1cyB0YWtlcyBlZmZlY3QKCQl0aGlzLmN1cnNvciA9IG5ldyBWZWN0b3IzKCk7CgoJCS8vIEhvdyBmYXIgeW91IGNhbiBkb2xseSBpbiBhbmQgb3V0ICggUGVyc3BlY3RpdmVDYW1lcmEgb25seSApCgkJdGhpcy5taW5EaXN0YW5jZSA9IDA7CgkJdGhpcy5tYXhEaXN0YW5jZSA9IEluZmluaXR5OwoKCQkvLyBIb3cgZmFyIHlvdSBjYW4gem9vbSBpbiBhbmQgb3V0ICggT3J0aG9ncmFwaGljQ2FtZXJhIG9ubHkgKQoJCXRoaXMubWluWm9vbSA9IDA7CgkJdGhpcy5tYXhab29tID0gSW5maW5pdHk7CgoJCS8vIExpbWl0IGNhbWVyYSB0YXJnZXQgd2l0aGluIGEgc3BoZXJpY2FsIGFyZWEgYXJvdW5kIHRoZSBjdXJzb3IKCQl0aGlzLm1pblRhcmdldFJhZGl1cyA9IDA7CgkJdGhpcy5tYXhUYXJnZXRSYWRpdXMgPSBJbmZpbml0eTsKCgkJLy8gSG93IGZhciB5b3UgY2FuIG9yYml0IHZlcnRpY2FsbHksIHVwcGVyIGFuZCBsb3dlciBsaW1pdHMuCgkJLy8gUmFuZ2UgaXMgMCB0byBNYXRoLlBJIHJhZGlhbnMuCgkJdGhpcy5taW5Qb2xhckFuZ2xlID0gMDsgLy8gcmFkaWFucwoJCXRoaXMubWF4UG9sYXJBbmdsZSA9IE1hdGguUEk7IC8vIHJhZGlhbnMKCgkJLy8gSG93IGZhciB5b3UgY2FuIG9yYml0IGhvcml6b250YWxseSwgdXBwZXIgYW5kIGxvd2VyIGxpbWl0cy4KCQkvLyBJZiBzZXQsIHRoZSBpbnRlcnZhbCBbIG1pbiwgbWF4IF0gbXVzdCBiZSBhIHN1Yi1pbnRlcnZhbCBvZiBbIC0gMiBQSSwgMiBQSSBdLCB3aXRoICggbWF4IC0gbWluIDwgMiBQSSApCgkJdGhpcy5taW5BemltdXRoQW5nbGUgPSAtIEluZmluaXR5OyAvLyByYWRpYW5zCgkJdGhpcy5tYXhBemltdXRoQW5nbGUgPSBJbmZpbml0eTsgLy8gcmFkaWFucwoKCQkvLyBTZXQgdG8gdHJ1ZSB0byBlbmFibGUgZGFtcGluZyAoaW5lcnRpYSkKCQkvLyBJZiBkYW1waW5nIGlzIGVuYWJsZWQsIHlvdSBtdXN0IGNhbGwgY29udHJvbHMudXBkYXRlKCkgaW4geW91ciBhbmltYXRpb24gbG9vcAoJCXRoaXMuZW5hYmxlRGFtcGluZyA9IGZhbHNlOwoJCXRoaXMuZGFtcGluZ0ZhY3RvciA9IDAuMDU7CgoJCS8vIFRoaXMgb3B0aW9uIGFjdHVhbGx5IGVuYWJsZXMgZG9sbHlpbmcgaW4gYW5kIG91dDsgbGVmdCBhcyAiem9vbSIgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoJCS8vIFNldCB0byBmYWxzZSB0byBkaXNhYmxlIHpvb21pbmcKCQl0aGlzLmVuYWJsZVpvb20gPSB0cnVlOwoJCXRoaXMuem9vbVNwZWVkID0gMS4wOwoKCQkvLyBTZXQgdG8gZmFsc2UgdG8gZGlzYWJsZSByb3RhdGluZwoJCXRoaXMuZW5hYmxlUm90YXRlID0gdHJ1ZTsKCQl0aGlzLnJvdGF0ZVNwZWVkID0gMS4wOwoKCQkvLyBTZXQgdG8gZmFsc2UgdG8gZGlzYWJsZSBwYW5uaW5nCgkJdGhpcy5lbmFibGVQYW4gPSB0cnVlOwoJCXRoaXMucGFuU3BlZWQgPSAxLjA7CgkJdGhpcy5zY3JlZW5TcGFjZVBhbm5pbmcgPSB0cnVlOyAvLyBpZiBmYWxzZSwgcGFuIG9ydGhvZ29uYWwgdG8gd29ybGQtc3BhY2UgZGlyZWN0aW9uIGNhbWVyYS51cAoJCXRoaXMua2V5UGFuU3BlZWQgPSA3LjA7CS8vIHBpeGVscyBtb3ZlZCBwZXIgYXJyb3cga2V5IHB1c2gKCQl0aGlzLnpvb21Ub0N1cnNvciA9IGZhbHNlOwoKCQkvLyBTZXQgdG8gdHJ1ZSB0byBhdXRvbWF0aWNhbGx5IHJvdGF0ZSBhcm91bmQgdGhlIHRhcmdldAoJCS8vIElmIGF1dG8tcm90YXRlIGlzIGVuYWJsZWQsIHlvdSBtdXN0IGNhbGwgY29udHJvbHMudXBkYXRlKCkgaW4geW91ciBhbmltYXRpb24gbG9vcAoJCXRoaXMuYXV0b1JvdGF0ZSA9IGZhbHNlOwoJCXRoaXMuYXV0b1JvdGF0ZVNwZWVkID0gMi4wOyAvLyAzMCBzZWNvbmRzIHBlciBvcmJpdCB3aGVuIGZwcyBpcyA2MAoKCQkvLyBUaGUgZm91ciBhcnJvdyBrZXlzCgkJdGhpcy5rZXlzID0geyBMRUZUOiAnQXJyb3dMZWZ0JywgVVA6ICdBcnJvd1VwJywgUklHSFQ6ICdBcnJvd1JpZ2h0JywgQk9UVE9NOiAnQXJyb3dEb3duJyB9OwoKCQkvLyBNb3VzZSBidXR0b25zCgkJdGhpcy5tb3VzZUJ1dHRvbnMgPSB7IExFRlQ6IE1PVVNFLlJPVEFURSwgTUlERExFOiBNT1VTRS5ET0xMWSwgUklHSFQ6IE1PVVNFLlBBTiB9OwoKCQkvLyBUb3VjaCBmaW5nZXJzCgkJdGhpcy50b3VjaGVzID0geyBPTkU6IFRPVUNILlJPVEFURSwgVFdPOiBUT1VDSC5ET0xMWV9QQU4gfTsKCgkJLy8gZm9yIHJlc2V0CgkJdGhpcy50YXJnZXQwID0gdGhpcy50YXJnZXQuY2xvbmUoKTsKCQl0aGlzLnBvc2l0aW9uMCA9IHRoaXMub2JqZWN0LnBvc2l0aW9uLmNsb25lKCk7CgkJdGhpcy56b29tMCA9IHRoaXMub2JqZWN0Lnpvb207CgoJCS8vIHRoZSB0YXJnZXQgRE9NIGVsZW1lbnQgZm9yIGtleSBldmVudHMKCQl0aGlzLl9kb21FbGVtZW50S2V5RXZlbnRzID0gbnVsbDsKCgkJLy8KCQkvLyBwdWJsaWMgbWV0aG9kcwoJCS8vCgoJCXRoaXMuZ2V0UG9sYXJBbmdsZSA9IGZ1bmN0aW9uICgpIHsKCgkJCXJldHVybiBzcGhlcmljYWwucGhpOwoKCQl9OwoKCQl0aGlzLmdldEF6aW11dGhhbEFuZ2xlID0gZnVuY3Rpb24gKCkgewoKCQkJcmV0dXJuIHNwaGVyaWNhbC50aGV0YTsKCgkJfTsKCgkJdGhpcy5nZXREaXN0YW5jZSA9IGZ1bmN0aW9uICgpIHsKCgkJCXJldHVybiB0aGlzLm9iamVjdC5wb3NpdGlvbi5kaXN0YW5jZVRvKCB0aGlzLnRhcmdldCApOwoKCQl9OwoKCQl0aGlzLmxpc3RlblRvS2V5RXZlbnRzID0gZnVuY3Rpb24gKCBkb21FbGVtZW50ICkgewoKCQkJZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCAna2V5ZG93bicsIG9uS2V5RG93biApOwoJCQl0aGlzLl9kb21FbGVtZW50S2V5RXZlbnRzID0gZG9tRWxlbWVudDsKCgkJfTsKCgkJdGhpcy5zdG9wTGlzdGVuVG9LZXlFdmVudHMgPSBmdW5jdGlvbiAoKSB7CgoJCQl0aGlzLl9kb21FbGVtZW50S2V5RXZlbnRzLnJlbW92ZUV2ZW50TGlzdGVuZXIoICdrZXlkb3duJywgb25LZXlEb3duICk7CgkJCXRoaXMuX2RvbUVsZW1lbnRLZXlFdmVudHMgPSBudWxsOwoKCQl9OwoKCQl0aGlzLnNhdmVTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKCgkJCXNjb3BlLnRhcmdldDAuY29weSggc2NvcGUudGFyZ2V0ICk7CgkJCXNjb3BlLnBvc2l0aW9uMC5jb3B5KCBzY29wZS5vYmplY3QucG9zaXRpb24gKTsKCQkJc2NvcGUuem9vbTAgPSBzY29wZS5vYmplY3Quem9vbTsKCgkJfTsKCgkJdGhpcy5yZXNldCA9IGZ1bmN0aW9uICgpIHsKCgkJCXNjb3BlLnRhcmdldC5jb3B5KCBzY29wZS50YXJnZXQwICk7CgkJCXNjb3BlLm9iamVjdC5wb3NpdGlvbi5jb3B5KCBzY29wZS5wb3NpdGlvbjAgKTsKCQkJc2NvcGUub2JqZWN0Lnpvb20gPSBzY29wZS56b29tMDsKCgkJCXNjb3BlLm9iamVjdC51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgkJCXNjb3BlLmRpc3BhdGNoRXZlbnQoIF9jaGFuZ2VFdmVudCApOwoKCQkJc2NvcGUudXBkYXRlKCk7CgoJCQlzdGF0ZSA9IFNUQVRFLk5PTkU7CgoJCX07CgoJCS8vIHRoaXMgbWV0aG9kIGlzIGV4cG9zZWQsIGJ1dCBwZXJoYXBzIGl0IHdvdWxkIGJlIGJldHRlciBpZiB3ZSBjYW4gbWFrZSBpdCBwcml2YXRlLi4uCgkJdGhpcy51cGRhdGUgPSBmdW5jdGlvbiAoKSB7CgoJCQljb25zdCBvZmZzZXQgPSBuZXcgVmVjdG9yMygpOwoKCQkJLy8gc28gY2FtZXJhLnVwIGlzIHRoZSBvcmJpdCBheGlzCgkJCWNvbnN0IHF1YXQgPSBuZXcgUXVhdGVybmlvbigpLnNldEZyb21Vbml0VmVjdG9ycyggb2JqZWN0LnVwLCBuZXcgVmVjdG9yMyggMCwgMSwgMCApICk7CgkJCWNvbnN0IHF1YXRJbnZlcnNlID0gcXVhdC5jbG9uZSgpLmludmVydCgpOwoKCQkJY29uc3QgbGFzdFBvc2l0aW9uID0gbmV3IFZlY3RvcjMoKTsKCQkJY29uc3QgbGFzdFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwoJCQljb25zdCBsYXN0VGFyZ2V0UG9zaXRpb24gPSBuZXcgVmVjdG9yMygpOwoKCQkJY29uc3QgdHdvUEkgPSAyICogTWF0aC5QSTsKCgkJCXJldHVybiBmdW5jdGlvbiB1cGRhdGUoIGRlbHRhVGltZSA9IG51bGwgKSB7CgoJCQkJY29uc3QgcG9zaXRpb24gPSBzY29wZS5vYmplY3QucG9zaXRpb247CgoJCQkJb2Zmc2V0LmNvcHkoIHBvc2l0aW9uICkuc3ViKCBzY29wZS50YXJnZXQgKTsKCgkJCQkvLyByb3RhdGUgb2Zmc2V0IHRvICJ5LWF4aXMtaXMtdXAiIHNwYWNlCgkJCQlvZmZzZXQuYXBwbHlRdWF0ZXJuaW9uKCBxdWF0ICk7CgoJCQkJLy8gYW5nbGUgZnJvbSB6LWF4aXMgYXJvdW5kIHktYXhpcwoJCQkJc3BoZXJpY2FsLnNldEZyb21WZWN0b3IzKCBvZmZzZXQgKTsKCgkJCQlpZiAoIHNjb3BlLmF1dG9Sb3RhdGUgJiYgc3RhdGUgPT09IFNUQVRFLk5PTkUgKSB7CgoJCQkJCXJvdGF0ZUxlZnQoIGdldEF1dG9Sb3RhdGlvbkFuZ2xlKCBkZWx0YVRpbWUgKSApOwoKCQkJCX0KCgkJCQlpZiAoIHNjb3BlLmVuYWJsZURhbXBpbmcgKSB7CgoJCQkJCXNwaGVyaWNhbC50aGV0YSArPSBzcGhlcmljYWxEZWx0YS50aGV0YSAqIHNjb3BlLmRhbXBpbmdGYWN0b3I7CgkJCQkJc3BoZXJpY2FsLnBoaSArPSBzcGhlcmljYWxEZWx0YS5waGkgKiBzY29wZS5kYW1waW5nRmFjdG9yOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXNwaGVyaWNhbC50aGV0YSArPSBzcGhlcmljYWxEZWx0YS50aGV0YTsKCQkJCQlzcGhlcmljYWwucGhpICs9IHNwaGVyaWNhbERlbHRhLnBoaTsKCgkJCQl9CgoJCQkJLy8gcmVzdHJpY3QgdGhldGEgdG8gYmUgYmV0d2VlbiBkZXNpcmVkIGxpbWl0cwoKCQkJCWxldCBtaW4gPSBzY29wZS5taW5BemltdXRoQW5nbGU7CgkJCQlsZXQgbWF4ID0gc2NvcGUubWF4QXppbXV0aEFuZ2xlOwoKCQkJCWlmICggaXNGaW5pdGUoIG1pbiApICYmIGlzRmluaXRlKCBtYXggKSApIHsKCgkJCQkJaWYgKCBtaW4gPCAtIE1hdGguUEkgKSBtaW4gKz0gdHdvUEk7IGVsc2UgaWYgKCBtaW4gPiBNYXRoLlBJICkgbWluIC09IHR3b1BJOwoKCQkJCQlpZiAoIG1heCA8IC0gTWF0aC5QSSApIG1heCArPSB0d29QSTsgZWxzZSBpZiAoIG1heCA+IE1hdGguUEkgKSBtYXggLT0gdHdvUEk7CgoJCQkJCWlmICggbWluIDw9IG1heCApIHsKCgkJCQkJCXNwaGVyaWNhbC50aGV0YSA9IE1hdGgubWF4KCBtaW4sIE1hdGgubWluKCBtYXgsIHNwaGVyaWNhbC50aGV0YSApICk7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlzcGhlcmljYWwudGhldGEgPSAoIHNwaGVyaWNhbC50aGV0YSA+ICggbWluICsgbWF4ICkgLyAyICkgPwoJCQkJCQkJTWF0aC5tYXgoIG1pbiwgc3BoZXJpY2FsLnRoZXRhICkgOgoJCQkJCQkJTWF0aC5taW4oIG1heCwgc3BoZXJpY2FsLnRoZXRhICk7CgoJCQkJCX0KCgkJCQl9CgoJCQkJLy8gcmVzdHJpY3QgcGhpIHRvIGJlIGJldHdlZW4gZGVzaXJlZCBsaW1pdHMKCQkJCXNwaGVyaWNhbC5waGkgPSBNYXRoLm1heCggc2NvcGUubWluUG9sYXJBbmdsZSwgTWF0aC5taW4oIHNjb3BlLm1heFBvbGFyQW5nbGUsIHNwaGVyaWNhbC5waGkgKSApOwoKCQkJCXNwaGVyaWNhbC5tYWtlU2FmZSgpOwoKCgkJCQkvLyBtb3ZlIHRhcmdldCB0byBwYW5uZWQgbG9jYXRpb24KCgkJCQlpZiAoIHNjb3BlLmVuYWJsZURhbXBpbmcgPT09IHRydWUgKSB7CgoJCQkJCXNjb3BlLnRhcmdldC5hZGRTY2FsZWRWZWN0b3IoIHBhbk9mZnNldCwgc2NvcGUuZGFtcGluZ0ZhY3RvciApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXNjb3BlLnRhcmdldC5hZGQoIHBhbk9mZnNldCApOwoKCQkJCX0KCgkJCQkvLyBMaW1pdCB0aGUgdGFyZ2V0IGRpc3RhbmNlIGZyb20gdGhlIGN1cnNvciB0byBjcmVhdGUgYSBzcGhlcmUgYXJvdW5kIHRoZSBjZW50ZXIgb2YgaW50ZXJlc3QKCQkJCXNjb3BlLnRhcmdldC5zdWIoIHNjb3BlLmN1cnNvciApOwoJCQkJc2NvcGUudGFyZ2V0LmNsYW1wTGVuZ3RoKCBzY29wZS5taW5UYXJnZXRSYWRpdXMsIHNjb3BlLm1heFRhcmdldFJhZGl1cyApOwoJCQkJc2NvcGUudGFyZ2V0LmFkZCggc2NvcGUuY3Vyc29yICk7CgoJCQkJLy8gYWRqdXN0IHRoZSBjYW1lcmEgcG9zaXRpb24gYmFzZWQgb24gem9vbSBvbmx5IGlmIHdlJ3JlIG5vdCB6b29taW5nIHRvIHRoZSBjdXJzb3Igb3IgaWYgaXQncyBhbiBvcnRobyBjYW1lcmEKCQkJCS8vIHdlIGFkanVzdCB6b29tIGxhdGVyIGluIHRoZXNlIGNhc2VzCgkJCQlpZiAoIHNjb3BlLnpvb21Ub0N1cnNvciAmJiBwZXJmb3JtQ3Vyc29yWm9vbSB8fCBzY29wZS5vYmplY3QuaXNPcnRob2dyYXBoaWNDYW1lcmEgKSB7CgoJCQkJCXNwaGVyaWNhbC5yYWRpdXMgPSBjbGFtcERpc3RhbmNlKCBzcGhlcmljYWwucmFkaXVzICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJc3BoZXJpY2FsLnJhZGl1cyA9IGNsYW1wRGlzdGFuY2UoIHNwaGVyaWNhbC5yYWRpdXMgKiBzY2FsZSApOwoKCQkJCX0KCgkJCQlvZmZzZXQuc2V0RnJvbVNwaGVyaWNhbCggc3BoZXJpY2FsICk7CgoJCQkJLy8gcm90YXRlIG9mZnNldCBiYWNrIHRvICJjYW1lcmEtdXAtdmVjdG9yLWlzLXVwIiBzcGFjZQoJCQkJb2Zmc2V0LmFwcGx5UXVhdGVybmlvbiggcXVhdEludmVyc2UgKTsKCgkJCQlwb3NpdGlvbi5jb3B5KCBzY29wZS50YXJnZXQgKS5hZGQoIG9mZnNldCApOwoKCQkJCXNjb3BlLm9iamVjdC5sb29rQXQoIHNjb3BlLnRhcmdldCApOwoKCQkJCWlmICggc2NvcGUuZW5hYmxlRGFtcGluZyA9PT0gdHJ1ZSApIHsKCgkJCQkJc3BoZXJpY2FsRGVsdGEudGhldGEgKj0gKCAxIC0gc2NvcGUuZGFtcGluZ0ZhY3RvciApOwoJCQkJCXNwaGVyaWNhbERlbHRhLnBoaSAqPSAoIDEgLSBzY29wZS5kYW1waW5nRmFjdG9yICk7CgoJCQkJCXBhbk9mZnNldC5tdWx0aXBseVNjYWxhciggMSAtIHNjb3BlLmRhbXBpbmdGYWN0b3IgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlzcGhlcmljYWxEZWx0YS5zZXQoIDAsIDAsIDAgKTsKCgkJCQkJcGFuT2Zmc2V0LnNldCggMCwgMCwgMCApOwoKCQkJCX0KCgkJCQkvLyBhZGp1c3QgY2FtZXJhIHBvc2l0aW9uCgkJCQlsZXQgem9vbUNoYW5nZWQgPSBmYWxzZTsKCQkJCWlmICggc2NvcGUuem9vbVRvQ3Vyc29yICYmIHBlcmZvcm1DdXJzb3Jab29tICkgewoKCQkJCQlsZXQgbmV3UmFkaXVzID0gbnVsbDsKCQkJCQlpZiAoIHNjb3BlLm9iamVjdC5pc1BlcnNwZWN0aXZlQ2FtZXJhICkgewoKCQkJCQkJLy8gbW92ZSB0aGUgY2FtZXJhIGRvd24gdGhlIHBvaW50ZXIgcmF5CgkJCQkJCS8vIHRoaXMgbWV0aG9kIGF2b2lkcyBmbG9hdGluZyBwb2ludCBlcnJvcgoJCQkJCQljb25zdCBwcmV2UmFkaXVzID0gb2Zmc2V0Lmxlbmd0aCgpOwoJCQkJCQluZXdSYWRpdXMgPSBjbGFtcERpc3RhbmNlKCBwcmV2UmFkaXVzICogc2NhbGUgKTsKCgkJCQkJCWNvbnN0IHJhZGl1c0RlbHRhID0gcHJldlJhZGl1cyAtIG5ld1JhZGl1czsKCQkJCQkJc2NvcGUub2JqZWN0LnBvc2l0aW9uLmFkZFNjYWxlZFZlY3RvciggZG9sbHlEaXJlY3Rpb24sIHJhZGl1c0RlbHRhICk7CgkJCQkJCXNjb3BlLm9iamVjdC51cGRhdGVNYXRyaXhXb3JsZCgpOwoKCQkJCQl9IGVsc2UgaWYgKCBzY29wZS5vYmplY3QuaXNPcnRob2dyYXBoaWNDYW1lcmEgKSB7CgoJCQkJCQkvLyBhZGp1c3QgdGhlIG9ydGhvIGNhbWVyYSBwb3NpdGlvbiBiYXNlZCBvbiB6b29tIGNoYW5nZXMKCQkJCQkJY29uc3QgbW91c2VCZWZvcmUgPSBuZXcgVmVjdG9yMyggbW91c2UueCwgbW91c2UueSwgMCApOwoJCQkJCQltb3VzZUJlZm9yZS51bnByb2plY3QoIHNjb3BlLm9iamVjdCApOwoKCQkJCQkJc2NvcGUub2JqZWN0Lnpvb20gPSBNYXRoLm1heCggc2NvcGUubWluWm9vbSwgTWF0aC5taW4oIHNjb3BlLm1heFpvb20sIHNjb3BlLm9iamVjdC56b29tIC8gc2NhbGUgKSApOwoJCQkJCQlzY29wZS5vYmplY3QudXBkYXRlUHJvamVjdGlvbk1hdHJpeCgpOwoJCQkJCQl6b29tQ2hhbmdlZCA9IHRydWU7CgoJCQkJCQljb25zdCBtb3VzZUFmdGVyID0gbmV3IFZlY3RvcjMoIG1vdXNlLngsIG1vdXNlLnksIDAgKTsKCQkJCQkJbW91c2VBZnRlci51bnByb2plY3QoIHNjb3BlLm9iamVjdCApOwoKCQkJCQkJc2NvcGUub2JqZWN0LnBvc2l0aW9uLnN1YiggbW91c2VBZnRlciApLmFkZCggbW91c2VCZWZvcmUgKTsKCQkJCQkJc2NvcGUub2JqZWN0LnVwZGF0ZU1hdHJpeFdvcmxkKCk7CgoJCQkJCQluZXdSYWRpdXMgPSBvZmZzZXQubGVuZ3RoKCk7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQljb25zb2xlLndhcm4oICdXQVJOSU5HOiBPcmJpdENvbnRyb2xzLmpzIGVuY291bnRlcmVkIGFuIHVua25vd24gY2FtZXJhIHR5cGUgLSB6b29tIHRvIGN1cnNvciBkaXNhYmxlZC4nICk7CgkJCQkJCXNjb3BlLnpvb21Ub0N1cnNvciA9IGZhbHNlOwoKCQkJCQl9CgoJCQkJCS8vIGhhbmRsZSB0aGUgcGxhY2VtZW50IG9mIHRoZSB0YXJnZXQKCQkJCQlpZiAoIG5ld1JhZGl1cyAhPT0gbnVsbCApIHsKCgkJCQkJCWlmICggdGhpcy5zY3JlZW5TcGFjZVBhbm5pbmcgKSB7CgoJCQkJCQkJLy8gcG9zaXRpb24gdGhlIG9yYml0IHRhcmdldCBpbiBmcm9udCBvZiB0aGUgbmV3IGNhbWVyYSBwb3NpdGlvbgoJCQkJCQkJc2NvcGUudGFyZ2V0LnNldCggMCwgMCwgLSAxICkKCQkJCQkJCQkudHJhbnNmb3JtRGlyZWN0aW9uKCBzY29wZS5vYmplY3QubWF0cml4ICkKCQkJCQkJCQkubXVsdGlwbHlTY2FsYXIoIG5ld1JhZGl1cyApCgkJCQkJCQkJLmFkZCggc2NvcGUub2JqZWN0LnBvc2l0aW9uICk7CgoJCQkJCQl9IGVsc2UgewoKCQkJCQkJCS8vIGdldCB0aGUgcmF5IGFuZCB0cmFuc2xhdGlvbiBwbGFuZSB0byBjb21wdXRlIHRhcmdldAoJCQkJCQkJX3JheS5vcmlnaW4uY29weSggc2NvcGUub2JqZWN0LnBvc2l0aW9uICk7CgkJCQkJCQlfcmF5LmRpcmVjdGlvbi5zZXQoIDAsIDAsIC0gMSApLnRyYW5zZm9ybURpcmVjdGlvbiggc2NvcGUub2JqZWN0Lm1hdHJpeCApOwoKCQkJCQkJCS8vIGlmIHRoZSBjYW1lcmEgaXMgMjAgZGVncmVlcyBhYm92ZSB0aGUgaG9yaXpvbiB0aGVuIGRvbid0IGFkanVzdCB0aGUgZm9jdXMgdGFyZ2V0IHRvIGF2b2lkCgkJCQkJCQkvLyBleHRyZW1lbHkgbGFyZ2UgdmFsdWVzCgkJCQkJCQlpZiAoIE1hdGguYWJzKCBzY29wZS5vYmplY3QudXAuZG90KCBfcmF5LmRpcmVjdGlvbiApICkgPCBUSUxUX0xJTUlUICkgewoKCQkJCQkJCQlvYmplY3QubG9va0F0KCBzY29wZS50YXJnZXQgKTsKCgkJCQkJCQl9IGVsc2UgewoKCQkJCQkJCQlfcGxhbmUuc2V0RnJvbU5vcm1hbEFuZENvcGxhbmFyUG9pbnQoIHNjb3BlLm9iamVjdC51cCwgc2NvcGUudGFyZ2V0ICk7CgkJCQkJCQkJX3JheS5pbnRlcnNlY3RQbGFuZSggX3BsYW5lLCBzY29wZS50YXJnZXQgKTsKCgkJCQkJCQl9CgoJCQkJCQl9CgoJCQkJCX0KCgkJCQl9IGVsc2UgaWYgKCBzY29wZS5vYmplY3QuaXNPcnRob2dyYXBoaWNDYW1lcmEgKSB7CgoJCQkJCXpvb21DaGFuZ2VkID0gc2NhbGUgIT09IDE7CgoJCQkJCWlmICggem9vbUNoYW5nZWQgKSB7CgoJCQkJCQlzY29wZS5vYmplY3Quem9vbSA9IE1hdGgubWF4KCBzY29wZS5taW5ab29tLCBNYXRoLm1pbiggc2NvcGUubWF4Wm9vbSwgc2NvcGUub2JqZWN0Lnpvb20gLyBzY2FsZSApICk7CgkJCQkJCXNjb3BlLm9iamVjdC51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7CgoJCQkJCX0KCgkJCQl9CgoJCQkJc2NhbGUgPSAxOwoJCQkJcGVyZm9ybUN1cnNvclpvb20gPSBmYWxzZTsKCgkJCQkvLyB1cGRhdGUgY29uZGl0aW9uIGlzOgoJCQkJLy8gbWluKGNhbWVyYSBkaXNwbGFjZW1lbnQsIGNhbWVyYSByb3RhdGlvbiBpbiByYWRpYW5zKV4yID4gRVBTCgkJCQkvLyB1c2luZyBzbWFsbC1hbmdsZSBhcHByb3hpbWF0aW9uIGNvcyh4LzIpID0gMSAtIHheMiAvIDgKCgkJCQlpZiAoIHpvb21DaGFuZ2VkIHx8CgkJCQkJbGFzdFBvc2l0aW9uLmRpc3RhbmNlVG9TcXVhcmVkKCBzY29wZS5vYmplY3QucG9zaXRpb24gKSA+IEVQUyB8fAoJCQkJCTggKiAoIDEgLSBsYXN0UXVhdGVybmlvbi5kb3QoIHNjb3BlLm9iamVjdC5xdWF0ZXJuaW9uICkgKSA+IEVQUyB8fAoJCQkJCWxhc3RUYXJnZXRQb3NpdGlvbi5kaXN0YW5jZVRvU3F1YXJlZCggc2NvcGUudGFyZ2V0ICkgPiAwICkgewoKCQkJCQlzY29wZS5kaXNwYXRjaEV2ZW50KCBfY2hhbmdlRXZlbnQgKTsKCgkJCQkJbGFzdFBvc2l0aW9uLmNvcHkoIHNjb3BlLm9iamVjdC5wb3NpdGlvbiApOwoJCQkJCWxhc3RRdWF0ZXJuaW9uLmNvcHkoIHNjb3BlLm9iamVjdC5xdWF0ZXJuaW9uICk7CgkJCQkJbGFzdFRhcmdldFBvc2l0aW9uLmNvcHkoIHNjb3BlLnRhcmdldCApOwoKCQkJCQlyZXR1cm4gdHJ1ZTsKCgkJCQl9CgoJCQkJcmV0dXJuIGZhbHNlOwoKCQkJfTsKCgkJfSgpOwoKCQl0aGlzLmRpc3Bvc2UgPSBmdW5jdGlvbiAoKSB7CgoJCQlzY29wZS5kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoICdjb250ZXh0bWVudScsIG9uQ29udGV4dE1lbnUgKTsKCgkJCXNjb3BlLmRvbUVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3BvaW50ZXJkb3duJywgb25Qb2ludGVyRG93biApOwoJCQlzY29wZS5kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoICdwb2ludGVyY2FuY2VsJywgb25Qb2ludGVyVXAgKTsKCQkJc2NvcGUuZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAnd2hlZWwnLCBvbk1vdXNlV2hlZWwgKTsKCgkJCXNjb3BlLmRvbUVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ3BvaW50ZXJtb3ZlJywgb25Qb2ludGVyTW92ZSApOwoJCQlzY29wZS5kb21FbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoICdwb2ludGVydXAnLCBvblBvaW50ZXJVcCApOwoKCgkJCWlmICggc2NvcGUuX2RvbUVsZW1lbnRLZXlFdmVudHMgIT09IG51bGwgKSB7CgoJCQkJc2NvcGUuX2RvbUVsZW1lbnRLZXlFdmVudHMucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ2tleWRvd24nLCBvbktleURvd24gKTsKCQkJCXNjb3BlLl9kb21FbGVtZW50S2V5RXZlbnRzID0gbnVsbDsKCgkJCX0KCgkJCS8vc2NvcGUuZGlzcGF0Y2hFdmVudCggeyB0eXBlOiAnZGlzcG9zZScgfSApOyAvLyBzaG91bGQgdGhpcyBiZSBhZGRlZCBoZXJlPwoKCQl9OwoKCQkvLwoJCS8vIGludGVybmFscwoJCS8vCgoJCWNvbnN0IHNjb3BlID0gdGhpczsKCgkJY29uc3QgU1RBVEUgPSB7CgkJCU5PTkU6IC0gMSwKCQkJUk9UQVRFOiAwLAoJCQlET0xMWTogMSwKCQkJUEFOOiAyLAoJCQlUT1VDSF9ST1RBVEU6IDMsCgkJCVRPVUNIX1BBTjogNCwKCQkJVE9VQ0hfRE9MTFlfUEFOOiA1LAoJCQlUT1VDSF9ET0xMWV9ST1RBVEU6IDYKCQl9OwoKCQlsZXQgc3RhdGUgPSBTVEFURS5OT05FOwoKCQljb25zdCBFUFMgPSAwLjAwMDAwMTsKCgkJLy8gY3VycmVudCBwb3NpdGlvbiBpbiBzcGhlcmljYWwgY29vcmRpbmF0ZXMKCQljb25zdCBzcGhlcmljYWwgPSBuZXcgU3BoZXJpY2FsKCk7CgkJY29uc3Qgc3BoZXJpY2FsRGVsdGEgPSBuZXcgU3BoZXJpY2FsKCk7CgoJCWxldCBzY2FsZSA9IDE7CgkJY29uc3QgcGFuT2Zmc2V0ID0gbmV3IFZlY3RvcjMoKTsKCgkJY29uc3Qgcm90YXRlU3RhcnQgPSBuZXcgVmVjdG9yMigpOwoJCWNvbnN0IHJvdGF0ZUVuZCA9IG5ldyBWZWN0b3IyKCk7CgkJY29uc3Qgcm90YXRlRGVsdGEgPSBuZXcgVmVjdG9yMigpOwoKCQljb25zdCBwYW5TdGFydCA9IG5ldyBWZWN0b3IyKCk7CgkJY29uc3QgcGFuRW5kID0gbmV3IFZlY3RvcjIoKTsKCQljb25zdCBwYW5EZWx0YSA9IG5ldyBWZWN0b3IyKCk7CgoJCWNvbnN0IGRvbGx5U3RhcnQgPSBuZXcgVmVjdG9yMigpOwoJCWNvbnN0IGRvbGx5RW5kID0gbmV3IFZlY3RvcjIoKTsKCQljb25zdCBkb2xseURlbHRhID0gbmV3IFZlY3RvcjIoKTsKCgkJY29uc3QgZG9sbHlEaXJlY3Rpb24gPSBuZXcgVmVjdG9yMygpOwoJCWNvbnN0IG1vdXNlID0gbmV3IFZlY3RvcjIoKTsKCQlsZXQgcGVyZm9ybUN1cnNvclpvb20gPSBmYWxzZTsKCgkJY29uc3QgcG9pbnRlcnMgPSBbXTsKCQljb25zdCBwb2ludGVyUG9zaXRpb25zID0ge307CgoJCWxldCBjb250cm9sQWN0aXZlID0gZmFsc2U7CgoJCWZ1bmN0aW9uIGdldEF1dG9Sb3RhdGlvbkFuZ2xlKCBkZWx0YVRpbWUgKSB7CgoJCQlpZiAoIGRlbHRhVGltZSAhPT0gbnVsbCApIHsKCgkJCQlyZXR1cm4gKCAyICogTWF0aC5QSSAvIDYwICogc2NvcGUuYXV0b1JvdGF0ZVNwZWVkICkgKiBkZWx0YVRpbWU7CgoJCQl9IGVsc2UgewoKCQkJCXJldHVybiAyICogTWF0aC5QSSAvIDYwIC8gNjAgKiBzY29wZS5hdXRvUm90YXRlU3BlZWQ7CgoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gZ2V0Wm9vbVNjYWxlKCBkZWx0YSApIHsKCgkJCWNvbnN0IG5vcm1hbGl6ZWREZWx0YSA9IE1hdGguYWJzKCBkZWx0YSAqIDAuMDEgKTsKCQkJcmV0dXJuIE1hdGgucG93KCAwLjk1LCBzY29wZS56b29tU3BlZWQgKiBub3JtYWxpemVkRGVsdGEgKTsKCgkJfQoKCQlmdW5jdGlvbiByb3RhdGVMZWZ0KCBhbmdsZSApIHsKCgkJCXNwaGVyaWNhbERlbHRhLnRoZXRhIC09IGFuZ2xlOwoKCQl9CgoJCWZ1bmN0aW9uIHJvdGF0ZVVwKCBhbmdsZSApIHsKCgkJCXNwaGVyaWNhbERlbHRhLnBoaSAtPSBhbmdsZTsKCgkJfQoKCQljb25zdCBwYW5MZWZ0ID0gZnVuY3Rpb24gKCkgewoKCQkJY29uc3QgdiA9IG5ldyBWZWN0b3IzKCk7CgoJCQlyZXR1cm4gZnVuY3Rpb24gcGFuTGVmdCggZGlzdGFuY2UsIG9iamVjdE1hdHJpeCApIHsKCgkJCQl2LnNldEZyb21NYXRyaXhDb2x1bW4oIG9iamVjdE1hdHJpeCwgMCApOyAvLyBnZXQgWCBjb2x1bW4gb2Ygb2JqZWN0TWF0cml4CgkJCQl2Lm11bHRpcGx5U2NhbGFyKCAtIGRpc3RhbmNlICk7CgoJCQkJcGFuT2Zmc2V0LmFkZCggdiApOwoKCQkJfTsKCgkJfSgpOwoKCQljb25zdCBwYW5VcCA9IGZ1bmN0aW9uICgpIHsKCgkJCWNvbnN0IHYgPSBuZXcgVmVjdG9yMygpOwoKCQkJcmV0dXJuIGZ1bmN0aW9uIHBhblVwKCBkaXN0YW5jZSwgb2JqZWN0TWF0cml4ICkgewoKCQkJCWlmICggc2NvcGUuc2NyZWVuU3BhY2VQYW5uaW5nID09PSB0cnVlICkgewoKCQkJCQl2LnNldEZyb21NYXRyaXhDb2x1bW4oIG9iamVjdE1hdHJpeCwgMSApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXYuc2V0RnJvbU1hdHJpeENvbHVtbiggb2JqZWN0TWF0cml4LCAwICk7CgkJCQkJdi5jcm9zc1ZlY3RvcnMoIHNjb3BlLm9iamVjdC51cCwgdiApOwoKCQkJCX0KCgkJCQl2Lm11bHRpcGx5U2NhbGFyKCBkaXN0YW5jZSApOwoKCQkJCXBhbk9mZnNldC5hZGQoIHYgKTsKCgkJCX07CgoJCX0oKTsKCgkJLy8gZGVsdGFYIGFuZCBkZWx0YVkgYXJlIGluIHBpeGVsczsgcmlnaHQgYW5kIGRvd24gYXJlIHBvc2l0aXZlCgkJY29uc3QgcGFuID0gZnVuY3Rpb24gKCkgewoKCQkJY29uc3Qgb2Zmc2V0ID0gbmV3IFZlY3RvcjMoKTsKCgkJCXJldHVybiBmdW5jdGlvbiBwYW4oIGRlbHRhWCwgZGVsdGFZICkgewoKCQkJCWNvbnN0IGVsZW1lbnQgPSBzY29wZS5kb21FbGVtZW50OwoKCQkJCWlmICggc2NvcGUub2JqZWN0LmlzUGVyc3BlY3RpdmVDYW1lcmEgKSB7CgoJCQkJCS8vIHBlcnNwZWN0aXZlCgkJCQkJY29uc3QgcG9zaXRpb24gPSBzY29wZS5vYmplY3QucG9zaXRpb247CgkJCQkJb2Zmc2V0LmNvcHkoIHBvc2l0aW9uICkuc3ViKCBzY29wZS50YXJnZXQgKTsKCQkJCQlsZXQgdGFyZ2V0RGlzdGFuY2UgPSBvZmZzZXQubGVuZ3RoKCk7CgoJCQkJCS8vIGhhbGYgb2YgdGhlIGZvdiBpcyBjZW50ZXIgdG8gdG9wIG9mIHNjcmVlbgoJCQkJCXRhcmdldERpc3RhbmNlICo9IE1hdGgudGFuKCAoIHNjb3BlLm9iamVjdC5mb3YgLyAyICkgKiBNYXRoLlBJIC8gMTgwLjAgKTsKCgkJCQkJLy8gd2UgdXNlIG9ubHkgY2xpZW50SGVpZ2h0IGhlcmUgc28gYXNwZWN0IHJhdGlvIGRvZXMgbm90IGRpc3RvcnQgc3BlZWQKCQkJCQlwYW5MZWZ0KCAyICogZGVsdGFYICogdGFyZ2V0RGlzdGFuY2UgLyBlbGVtZW50LmNsaWVudEhlaWdodCwgc2NvcGUub2JqZWN0Lm1hdHJpeCApOwoJCQkJCXBhblVwKCAyICogZGVsdGFZICogdGFyZ2V0RGlzdGFuY2UgLyBlbGVtZW50LmNsaWVudEhlaWdodCwgc2NvcGUub2JqZWN0Lm1hdHJpeCApOwoKCQkJCX0gZWxzZSBpZiAoIHNjb3BlLm9iamVjdC5pc09ydGhvZ3JhcGhpY0NhbWVyYSApIHsKCgkJCQkJLy8gb3J0aG9ncmFwaGljCgkJCQkJcGFuTGVmdCggZGVsdGFYICogKCBzY29wZS5vYmplY3QucmlnaHQgLSBzY29wZS5vYmplY3QubGVmdCApIC8gc2NvcGUub2JqZWN0Lnpvb20gLyBlbGVtZW50LmNsaWVudFdpZHRoLCBzY29wZS5vYmplY3QubWF0cml4ICk7CgkJCQkJcGFuVXAoIGRlbHRhWSAqICggc2NvcGUub2JqZWN0LnRvcCAtIHNjb3BlLm9iamVjdC5ib3R0b20gKSAvIHNjb3BlLm9iamVjdC56b29tIC8gZWxlbWVudC5jbGllbnRIZWlnaHQsIHNjb3BlLm9iamVjdC5tYXRyaXggKTsKCgkJCQl9IGVsc2UgewoKCQkJCQkvLyBjYW1lcmEgbmVpdGhlciBvcnRob2dyYXBoaWMgbm9yIHBlcnNwZWN0aXZlCgkJCQkJY29uc29sZS53YXJuKCAnV0FSTklORzogT3JiaXRDb250cm9scy5qcyBlbmNvdW50ZXJlZCBhbiB1bmtub3duIGNhbWVyYSB0eXBlIC0gcGFuIGRpc2FibGVkLicgKTsKCQkJCQlzY29wZS5lbmFibGVQYW4gPSBmYWxzZTsKCgkJCQl9CgoJCQl9OwoKCQl9KCk7CgoJCWZ1bmN0aW9uIGRvbGx5T3V0KCBkb2xseVNjYWxlICkgewoKCQkJaWYgKCBzY29wZS5vYmplY3QuaXNQZXJzcGVjdGl2ZUNhbWVyYSB8fCBzY29wZS5vYmplY3QuaXNPcnRob2dyYXBoaWNDYW1lcmEgKSB7CgoJCQkJc2NhbGUgLz0gZG9sbHlTY2FsZTsKCgkJCX0gZWxzZSB7CgoJCQkJY29uc29sZS53YXJuKCAnV0FSTklORzogT3JiaXRDb250cm9scy5qcyBlbmNvdW50ZXJlZCBhbiB1bmtub3duIGNhbWVyYSB0eXBlIC0gZG9sbHkvem9vbSBkaXNhYmxlZC4nICk7CgkJCQlzY29wZS5lbmFibGVab29tID0gZmFsc2U7CgoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gZG9sbHlJbiggZG9sbHlTY2FsZSApIHsKCgkJCWlmICggc2NvcGUub2JqZWN0LmlzUGVyc3BlY3RpdmVDYW1lcmEgfHwgc2NvcGUub2JqZWN0LmlzT3J0aG9ncmFwaGljQ2FtZXJhICkgewoKCQkJCXNjYWxlICo9IGRvbGx5U2NhbGU7CgoJCQl9IGVsc2UgewoKCQkJCWNvbnNvbGUud2FybiggJ1dBUk5JTkc6IE9yYml0Q29udHJvbHMuanMgZW5jb3VudGVyZWQgYW4gdW5rbm93biBjYW1lcmEgdHlwZSAtIGRvbGx5L3pvb20gZGlzYWJsZWQuJyApOwoJCQkJc2NvcGUuZW5hYmxlWm9vbSA9IGZhbHNlOwoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIHVwZGF0ZVpvb21QYXJhbWV0ZXJzKCB4LCB5ICkgewoKCQkJaWYgKCAhIHNjb3BlLnpvb21Ub0N1cnNvciApIHsKCgkJCQlyZXR1cm47CgoJCQl9CgoJCQlwZXJmb3JtQ3Vyc29yWm9vbSA9IHRydWU7CgoJCQljb25zdCByZWN0ID0gc2NvcGUuZG9tRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCQkJY29uc3QgZHggPSB4IC0gcmVjdC5sZWZ0OwoJCQljb25zdCBkeSA9IHkgLSByZWN0LnRvcDsKCQkJY29uc3QgdyA9IHJlY3Qud2lkdGg7CgkJCWNvbnN0IGggPSByZWN0LmhlaWdodDsKCgkJCW1vdXNlLnggPSAoIGR4IC8gdyApICogMiAtIDE7CgkJCW1vdXNlLnkgPSAtICggZHkgLyBoICkgKiAyICsgMTsKCgkJCWRvbGx5RGlyZWN0aW9uLnNldCggbW91c2UueCwgbW91c2UueSwgMSApLnVucHJvamVjdCggc2NvcGUub2JqZWN0ICkuc3ViKCBzY29wZS5vYmplY3QucG9zaXRpb24gKS5ub3JtYWxpemUoKTsKCgkJfQoKCQlmdW5jdGlvbiBjbGFtcERpc3RhbmNlKCBkaXN0ICkgewoKCQkJcmV0dXJuIE1hdGgubWF4KCBzY29wZS5taW5EaXN0YW5jZSwgTWF0aC5taW4oIHNjb3BlLm1heERpc3RhbmNlLCBkaXN0ICkgKTsKCgkJfQoKCQkvLwoJCS8vIGV2ZW50IGNhbGxiYWNrcyAtIHVwZGF0ZSB0aGUgb2JqZWN0IHN0YXRlCgkJLy8KCgkJZnVuY3Rpb24gaGFuZGxlTW91c2VEb3duUm90YXRlKCBldmVudCApIHsKCgkJCXJvdGF0ZVN0YXJ0LnNldCggZXZlbnQuY2xpZW50WCwgZXZlbnQuY2xpZW50WSApOwoKCQl9CgoJCWZ1bmN0aW9uIGhhbmRsZU1vdXNlRG93bkRvbGx5KCBldmVudCApIHsKCgkJCXVwZGF0ZVpvb21QYXJhbWV0ZXJzKCBldmVudC5jbGllbnRYLCBldmVudC5jbGllbnRYICk7CgkJCWRvbGx5U3RhcnQuc2V0KCBldmVudC5jbGllbnRYLCBldmVudC5jbGllbnRZICk7CgoJCX0KCgkJZnVuY3Rpb24gaGFuZGxlTW91c2VEb3duUGFuKCBldmVudCApIHsKCgkJCXBhblN0YXJ0LnNldCggZXZlbnQuY2xpZW50WCwgZXZlbnQuY2xpZW50WSApOwoKCQl9CgoJCWZ1bmN0aW9uIGhhbmRsZU1vdXNlTW92ZVJvdGF0ZSggZXZlbnQgKSB7CgoJCQlyb3RhdGVFbmQuc2V0KCBldmVudC5jbGllbnRYLCBldmVudC5jbGllbnRZICk7CgoJCQlyb3RhdGVEZWx0YS5zdWJWZWN0b3JzKCByb3RhdGVFbmQsIHJvdGF0ZVN0YXJ0ICkubXVsdGlwbHlTY2FsYXIoIHNjb3BlLnJvdGF0ZVNwZWVkICk7CgoJCQljb25zdCBlbGVtZW50ID0gc2NvcGUuZG9tRWxlbWVudDsKCgkJCXJvdGF0ZUxlZnQoIDIgKiBNYXRoLlBJICogcm90YXRlRGVsdGEueCAvIGVsZW1lbnQuY2xpZW50SGVpZ2h0ICk7IC8vIHllcywgaGVpZ2h0CgoJCQlyb3RhdGVVcCggMiAqIE1hdGguUEkgKiByb3RhdGVEZWx0YS55IC8gZWxlbWVudC5jbGllbnRIZWlnaHQgKTsKCgkJCXJvdGF0ZVN0YXJ0LmNvcHkoIHJvdGF0ZUVuZCApOwoKCQkJc2NvcGUudXBkYXRlKCk7CgoJCX0KCgkJZnVuY3Rpb24gaGFuZGxlTW91c2VNb3ZlRG9sbHkoIGV2ZW50ICkgewoKCQkJZG9sbHlFbmQuc2V0KCBldmVudC5jbGllbnRYLCBldmVudC5jbGllbnRZICk7CgoJCQlkb2xseURlbHRhLnN1YlZlY3RvcnMoIGRvbGx5RW5kLCBkb2xseVN0YXJ0ICk7CgoJCQlpZiAoIGRvbGx5RGVsdGEueSA+IDAgKSB7CgoJCQkJZG9sbHlPdXQoIGdldFpvb21TY2FsZSggZG9sbHlEZWx0YS55ICkgKTsKCgkJCX0gZWxzZSBpZiAoIGRvbGx5RGVsdGEueSA8IDAgKSB7CgoJCQkJZG9sbHlJbiggZ2V0Wm9vbVNjYWxlKCBkb2xseURlbHRhLnkgKSApOwoKCQkJfQoKCQkJZG9sbHlTdGFydC5jb3B5KCBkb2xseUVuZCApOwoKCQkJc2NvcGUudXBkYXRlKCk7CgoJCX0KCgkJZnVuY3Rpb24gaGFuZGxlTW91c2VNb3ZlUGFuKCBldmVudCApIHsKCgkJCXBhbkVuZC5zZXQoIGV2ZW50LmNsaWVudFgsIGV2ZW50LmNsaWVudFkgKTsKCgkJCXBhbkRlbHRhLnN1YlZlY3RvcnMoIHBhbkVuZCwgcGFuU3RhcnQgKS5tdWx0aXBseVNjYWxhciggc2NvcGUucGFuU3BlZWQgKTsKCgkJCXBhbiggcGFuRGVsdGEueCwgcGFuRGVsdGEueSApOwoKCQkJcGFuU3RhcnQuY29weSggcGFuRW5kICk7CgoJCQlzY29wZS51cGRhdGUoKTsKCgkJfQoKCQlmdW5jdGlvbiBoYW5kbGVNb3VzZVdoZWVsKCBldmVudCApIHsKCgkJCXVwZGF0ZVpvb21QYXJhbWV0ZXJzKCBldmVudC5jbGllbnRYLCBldmVudC5jbGllbnRZICk7CgoJCQlpZiAoIGV2ZW50LmRlbHRhWSA8IDAgKSB7CgoJCQkJZG9sbHlJbiggZ2V0Wm9vbVNjYWxlKCBldmVudC5kZWx0YVkgKSApOwoKCQkJfSBlbHNlIGlmICggZXZlbnQuZGVsdGFZID4gMCApIHsKCgkJCQlkb2xseU91dCggZ2V0Wm9vbVNjYWxlKCBldmVudC5kZWx0YVkgKSApOwoKCQkJfQoKCQkJc2NvcGUudXBkYXRlKCk7CgoJCX0KCgkJZnVuY3Rpb24gaGFuZGxlS2V5RG93biggZXZlbnQgKSB7CgoJCQlsZXQgbmVlZHNVcGRhdGUgPSBmYWxzZTsKCgkJCXN3aXRjaCAoIGV2ZW50LmNvZGUgKSB7CgoJCQkJY2FzZSBzY29wZS5rZXlzLlVQOgoKCQkJCQlpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fCBldmVudC5zaGlmdEtleSApIHsKCgkJCQkJCXJvdGF0ZVVwKCAyICogTWF0aC5QSSAqIHNjb3BlLnJvdGF0ZVNwZWVkIC8gc2NvcGUuZG9tRWxlbWVudC5jbGllbnRIZWlnaHQgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXBhbiggMCwgc2NvcGUua2V5UGFuU3BlZWQgKTsKCgkJCQkJfQoKCQkJCQluZWVkc1VwZGF0ZSA9IHRydWU7CgkJCQkJYnJlYWs7CgoJCQkJY2FzZSBzY29wZS5rZXlzLkJPVFRPTToKCgkJCQkJaWYgKCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQuc2hpZnRLZXkgKSB7CgoJCQkJCQlyb3RhdGVVcCggLSAyICogTWF0aC5QSSAqIHNjb3BlLnJvdGF0ZVNwZWVkIC8gc2NvcGUuZG9tRWxlbWVudC5jbGllbnRIZWlnaHQgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXBhbiggMCwgLSBzY29wZS5rZXlQYW5TcGVlZCApOwoKCQkJCQl9CgoJCQkJCW5lZWRzVXBkYXRlID0gdHJ1ZTsKCQkJCQlicmVhazsKCgkJCQljYXNlIHNjb3BlLmtleXMuTEVGVDoKCgkJCQkJaWYgKCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQuc2hpZnRLZXkgKSB7CgoJCQkJCQlyb3RhdGVMZWZ0KCAyICogTWF0aC5QSSAqIHNjb3BlLnJvdGF0ZVNwZWVkIC8gc2NvcGUuZG9tRWxlbWVudC5jbGllbnRIZWlnaHQgKTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCXBhbiggc2NvcGUua2V5UGFuU3BlZWQsIDAgKTsKCgkJCQkJfQoKCQkJCQluZWVkc1VwZGF0ZSA9IHRydWU7CgkJCQkJYnJlYWs7CgoJCQkJY2FzZSBzY29wZS5rZXlzLlJJR0hUOgoKCQkJCQlpZiAoIGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSB8fCBldmVudC5zaGlmdEtleSApIHsKCgkJCQkJCXJvdGF0ZUxlZnQoIC0gMiAqIE1hdGguUEkgKiBzY29wZS5yb3RhdGVTcGVlZCAvIHNjb3BlLmRvbUVsZW1lbnQuY2xpZW50SGVpZ2h0ICk7CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlwYW4oIC0gc2NvcGUua2V5UGFuU3BlZWQsIDAgKTsKCgkJCQkJfQoKCQkJCQluZWVkc1VwZGF0ZSA9IHRydWU7CgkJCQkJYnJlYWs7CgoJCQl9CgoJCQlpZiAoIG5lZWRzVXBkYXRlICkgewoKCQkJCS8vIHByZXZlbnQgdGhlIGJyb3dzZXIgZnJvbSBzY3JvbGxpbmcgb24gY3Vyc29yIGtleXMKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJc2NvcGUudXBkYXRlKCk7CgoJCQl9CgoKCQl9CgoJCWZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnRSb3RhdGUoIGV2ZW50ICkgewoKCQkJaWYgKCBwb2ludGVycy5sZW5ndGggPT09IDEgKSB7CgoJCQkJcm90YXRlU3RhcnQuc2V0KCBldmVudC5wYWdlWCwgZXZlbnQucGFnZVkgKTsKCgkJCX0gZWxzZSB7CgoJCQkJY29uc3QgcG9zaXRpb24gPSBnZXRTZWNvbmRQb2ludGVyUG9zaXRpb24oIGV2ZW50ICk7CgoJCQkJY29uc3QgeCA9IDAuNSAqICggZXZlbnQucGFnZVggKyBwb3NpdGlvbi54ICk7CgkJCQljb25zdCB5ID0gMC41ICogKCBldmVudC5wYWdlWSArIHBvc2l0aW9uLnkgKTsKCgkJCQlyb3RhdGVTdGFydC5zZXQoIHgsIHkgKTsKCgkJCX0KCgkJfQoKCQlmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0UGFuKCBldmVudCApIHsKCgkJCWlmICggcG9pbnRlcnMubGVuZ3RoID09PSAxICkgewoKCQkJCXBhblN0YXJ0LnNldCggZXZlbnQucGFnZVgsIGV2ZW50LnBhZ2VZICk7CgoJCQl9IGVsc2UgewoKCQkJCWNvbnN0IHBvc2l0aW9uID0gZ2V0U2Vjb25kUG9pbnRlclBvc2l0aW9uKCBldmVudCApOwoKCQkJCWNvbnN0IHggPSAwLjUgKiAoIGV2ZW50LnBhZ2VYICsgcG9zaXRpb24ueCApOwoJCQkJY29uc3QgeSA9IDAuNSAqICggZXZlbnQucGFnZVkgKyBwb3NpdGlvbi55ICk7CgoJCQkJcGFuU3RhcnQuc2V0KCB4LCB5ICk7CgoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydERvbGx5KCBldmVudCApIHsKCgkJCWNvbnN0IHBvc2l0aW9uID0gZ2V0U2Vjb25kUG9pbnRlclBvc2l0aW9uKCBldmVudCApOwoKCQkJY29uc3QgZHggPSBldmVudC5wYWdlWCAtIHBvc2l0aW9uLng7CgkJCWNvbnN0IGR5ID0gZXZlbnQucGFnZVkgLSBwb3NpdGlvbi55OwoKCQkJY29uc3QgZGlzdGFuY2UgPSBNYXRoLnNxcnQoIGR4ICogZHggKyBkeSAqIGR5ICk7CgoJCQlkb2xseVN0YXJ0LnNldCggMCwgZGlzdGFuY2UgKTsKCgkJfQoKCQlmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0RG9sbHlQYW4oIGV2ZW50ICkgewoKCQkJaWYgKCBzY29wZS5lbmFibGVab29tICkgaGFuZGxlVG91Y2hTdGFydERvbGx5KCBldmVudCApOwoKCQkJaWYgKCBzY29wZS5lbmFibGVQYW4gKSBoYW5kbGVUb3VjaFN0YXJ0UGFuKCBldmVudCApOwoKCQl9CgoJCWZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnREb2xseVJvdGF0ZSggZXZlbnQgKSB7CgoJCQlpZiAoIHNjb3BlLmVuYWJsZVpvb20gKSBoYW5kbGVUb3VjaFN0YXJ0RG9sbHkoIGV2ZW50ICk7CgoJCQlpZiAoIHNjb3BlLmVuYWJsZVJvdGF0ZSApIGhhbmRsZVRvdWNoU3RhcnRSb3RhdGUoIGV2ZW50ICk7CgoJCX0KCgkJZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlUm90YXRlKCBldmVudCApIHsKCgkJCWlmICggcG9pbnRlcnMubGVuZ3RoID09IDEgKSB7CgoJCQkJcm90YXRlRW5kLnNldCggZXZlbnQucGFnZVgsIGV2ZW50LnBhZ2VZICk7CgoJCQl9IGVsc2UgewoKCQkJCWNvbnN0IHBvc2l0aW9uID0gZ2V0U2Vjb25kUG9pbnRlclBvc2l0aW9uKCBldmVudCApOwoKCQkJCWNvbnN0IHggPSAwLjUgKiAoIGV2ZW50LnBhZ2VYICsgcG9zaXRpb24ueCApOwoJCQkJY29uc3QgeSA9IDAuNSAqICggZXZlbnQucGFnZVkgKyBwb3NpdGlvbi55ICk7CgoJCQkJcm90YXRlRW5kLnNldCggeCwgeSApOwoKCQkJfQoKCQkJcm90YXRlRGVsdGEuc3ViVmVjdG9ycyggcm90YXRlRW5kLCByb3RhdGVTdGFydCApLm11bHRpcGx5U2NhbGFyKCBzY29wZS5yb3RhdGVTcGVlZCApOwoKCQkJY29uc3QgZWxlbWVudCA9IHNjb3BlLmRvbUVsZW1lbnQ7CgoJCQlyb3RhdGVMZWZ0KCAyICogTWF0aC5QSSAqIHJvdGF0ZURlbHRhLnggLyBlbGVtZW50LmNsaWVudEhlaWdodCApOyAvLyB5ZXMsIGhlaWdodAoKCQkJcm90YXRlVXAoIDIgKiBNYXRoLlBJICogcm90YXRlRGVsdGEueSAvIGVsZW1lbnQuY2xpZW50SGVpZ2h0ICk7CgoJCQlyb3RhdGVTdGFydC5jb3B5KCByb3RhdGVFbmQgKTsKCgkJfQoKCQlmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmVQYW4oIGV2ZW50ICkgewoKCQkJaWYgKCBwb2ludGVycy5sZW5ndGggPT09IDEgKSB7CgoJCQkJcGFuRW5kLnNldCggZXZlbnQucGFnZVgsIGV2ZW50LnBhZ2VZICk7CgoJCQl9IGVsc2UgewoKCQkJCWNvbnN0IHBvc2l0aW9uID0gZ2V0U2Vjb25kUG9pbnRlclBvc2l0aW9uKCBldmVudCApOwoKCQkJCWNvbnN0IHggPSAwLjUgKiAoIGV2ZW50LnBhZ2VYICsgcG9zaXRpb24ueCApOwoJCQkJY29uc3QgeSA9IDAuNSAqICggZXZlbnQucGFnZVkgKyBwb3NpdGlvbi55ICk7CgoJCQkJcGFuRW5kLnNldCggeCwgeSApOwoKCQkJfQoKCQkJcGFuRGVsdGEuc3ViVmVjdG9ycyggcGFuRW5kLCBwYW5TdGFydCApLm11bHRpcGx5U2NhbGFyKCBzY29wZS5wYW5TcGVlZCApOwoKCQkJcGFuKCBwYW5EZWx0YS54LCBwYW5EZWx0YS55ICk7CgoJCQlwYW5TdGFydC5jb3B5KCBwYW5FbmQgKTsKCgkJfQoKCQlmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmVEb2xseSggZXZlbnQgKSB7CgoJCQljb25zdCBwb3NpdGlvbiA9IGdldFNlY29uZFBvaW50ZXJQb3NpdGlvbiggZXZlbnQgKTsKCgkJCWNvbnN0IGR4ID0gZXZlbnQucGFnZVggLSBwb3NpdGlvbi54OwoJCQljb25zdCBkeSA9IGV2ZW50LnBhZ2VZIC0gcG9zaXRpb24ueTsKCgkJCWNvbnN0IGRpc3RhbmNlID0gTWF0aC5zcXJ0KCBkeCAqIGR4ICsgZHkgKiBkeSApOwoKCQkJZG9sbHlFbmQuc2V0KCAwLCBkaXN0YW5jZSApOwoKCQkJZG9sbHlEZWx0YS5zZXQoIDAsIE1hdGgucG93KCBkb2xseUVuZC55IC8gZG9sbHlTdGFydC55LCBzY29wZS56b29tU3BlZWQgKSApOwoKCQkJZG9sbHlPdXQoIGRvbGx5RGVsdGEueSApOwoKCQkJZG9sbHlTdGFydC5jb3B5KCBkb2xseUVuZCApOwoKCQkJY29uc3QgY2VudGVyWCA9ICggZXZlbnQucGFnZVggKyBwb3NpdGlvbi54ICkgKiAwLjU7CgkJCWNvbnN0IGNlbnRlclkgPSAoIGV2ZW50LnBhZ2VZICsgcG9zaXRpb24ueSApICogMC41OwoKCQkJdXBkYXRlWm9vbVBhcmFtZXRlcnMoIGNlbnRlclgsIGNlbnRlclkgKTsKCgkJfQoKCQlmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmVEb2xseVBhbiggZXZlbnQgKSB7CgoJCQlpZiAoIHNjb3BlLmVuYWJsZVpvb20gKSBoYW5kbGVUb3VjaE1vdmVEb2xseSggZXZlbnQgKTsKCgkJCWlmICggc2NvcGUuZW5hYmxlUGFuICkgaGFuZGxlVG91Y2hNb3ZlUGFuKCBldmVudCApOwoKCQl9CgoJCWZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZURvbGx5Um90YXRlKCBldmVudCApIHsKCgkJCWlmICggc2NvcGUuZW5hYmxlWm9vbSApIGhhbmRsZVRvdWNoTW92ZURvbGx5KCBldmVudCApOwoKCQkJaWYgKCBzY29wZS5lbmFibGVSb3RhdGUgKSBoYW5kbGVUb3VjaE1vdmVSb3RhdGUoIGV2ZW50ICk7CgoJCX0KCgkJLy8KCQkvLyBldmVudCBoYW5kbGVycyAtIEZTTTogbGlzdGVuIGZvciBldmVudHMgYW5kIHJlc2V0IHN0YXRlCgkJLy8KCgkJZnVuY3Rpb24gb25Qb2ludGVyRG93biggZXZlbnQgKSB7CgoJCQlpZiAoIHNjb3BlLmVuYWJsZWQgPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJaWYgKCBwb2ludGVycy5sZW5ndGggPT09IDAgKSB7CgoJCQkJc2NvcGUuZG9tRWxlbWVudC5zZXRQb2ludGVyQ2FwdHVyZSggZXZlbnQucG9pbnRlcklkICk7CgoJCQkJc2NvcGUuZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCAncG9pbnRlcm1vdmUnLCBvblBvaW50ZXJNb3ZlICk7CgkJCQlzY29wZS5kb21FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdwb2ludGVydXAnLCBvblBvaW50ZXJVcCApOwoKCQkJfQoKCQkJLy8KCgkJCWFkZFBvaW50ZXIoIGV2ZW50ICk7CgoJCQlpZiAoIGV2ZW50LnBvaW50ZXJUeXBlID09PSAndG91Y2gnICkgewoKCQkJCW9uVG91Y2hTdGFydCggZXZlbnQgKTsKCgkJCX0gZWxzZSB7CgoJCQkJb25Nb3VzZURvd24oIGV2ZW50ICk7CgoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gb25Qb2ludGVyTW92ZSggZXZlbnQgKSB7CgoJCQlpZiAoIHNjb3BlLmVuYWJsZWQgPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJaWYgKCBldmVudC5wb2ludGVyVHlwZSA9PT0gJ3RvdWNoJyApIHsKCgkJCQlvblRvdWNoTW92ZSggZXZlbnQgKTsKCgkJCX0gZWxzZSB7CgoJCQkJb25Nb3VzZU1vdmUoIGV2ZW50ICk7CgoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gb25Qb2ludGVyVXAoIGV2ZW50ICkgewoKCQkJcmVtb3ZlUG9pbnRlciggZXZlbnQgKTsKCgkJCXN3aXRjaCAoIHBvaW50ZXJzLmxlbmd0aCApIHsKCgkJCQljYXNlIDA6CgoJCQkJCXNjb3BlLmRvbUVsZW1lbnQucmVsZWFzZVBvaW50ZXJDYXB0dXJlKCBldmVudC5wb2ludGVySWQgKTsKCgkJCQkJc2NvcGUuZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAncG9pbnRlcm1vdmUnLCBvblBvaW50ZXJNb3ZlICk7CgkJCQkJc2NvcGUuZG9tRWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAncG9pbnRlcnVwJywgb25Qb2ludGVyVXAgKTsKCgkJCQkJc2NvcGUuZGlzcGF0Y2hFdmVudCggX2VuZEV2ZW50ICk7CgoJCQkJCXN0YXRlID0gU1RBVEUuTk9ORTsKCgkJCQkJYnJlYWs7CgoJCQkJY2FzZSAxOgoKCQkJCQljb25zdCBwb2ludGVySWQgPSBwb2ludGVyc1sgMCBdOwoJCQkJCWNvbnN0IHBvc2l0aW9uID0gcG9pbnRlclBvc2l0aW9uc1sgcG9pbnRlcklkIF07CgoJCQkJCS8vIG1pbmltYWwgcGxhY2Vob2xkZXIgZXZlbnQgLSBhbGxvd3Mgc3RhdGUgY29ycmVjdGlvbiBvbiBwb2ludGVyLXVwCgkJCQkJb25Ub3VjaFN0YXJ0KCB7IHBvaW50ZXJJZDogcG9pbnRlcklkLCBwYWdlWDogcG9zaXRpb24ueCwgcGFnZVk6IHBvc2l0aW9uLnkgfSApOwoKCQkJCQlicmVhazsKCgkJCX0KCgkJfQoKCQlmdW5jdGlvbiBvbk1vdXNlRG93biggZXZlbnQgKSB7CgoJCQlsZXQgbW91c2VBY3Rpb247CgoJCQlzd2l0Y2ggKCBldmVudC5idXR0b24gKSB7CgoJCQkJY2FzZSAwOgoKCQkJCQltb3VzZUFjdGlvbiA9IHNjb3BlLm1vdXNlQnV0dG9ucy5MRUZUOwoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgMToKCgkJCQkJbW91c2VBY3Rpb24gPSBzY29wZS5tb3VzZUJ1dHRvbnMuTUlERExFOwoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgMjoKCgkJCQkJbW91c2VBY3Rpb24gPSBzY29wZS5tb3VzZUJ1dHRvbnMuUklHSFQ7CgkJCQkJYnJlYWs7CgoJCQkJZGVmYXVsdDoKCgkJCQkJbW91c2VBY3Rpb24gPSAtIDE7CgoJCQl9CgoJCQlzd2l0Y2ggKCBtb3VzZUFjdGlvbiApIHsKCgkJCQljYXNlIE1PVVNFLkRPTExZOgoKCQkJCQlpZiAoIHNjb3BlLmVuYWJsZVpvb20gPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJCQloYW5kbGVNb3VzZURvd25Eb2xseSggZXZlbnQgKTsKCgkJCQkJc3RhdGUgPSBTVEFURS5ET0xMWTsKCgkJCQkJYnJlYWs7CgoJCQkJY2FzZSBNT1VTRS5ST1RBVEU6CgoJCQkJCWlmICggZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LnNoaWZ0S2V5ICkgewoKCQkJCQkJaWYgKCBzY29wZS5lbmFibGVQYW4gPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJCQkJaGFuZGxlTW91c2VEb3duUGFuKCBldmVudCApOwoKCQkJCQkJc3RhdGUgPSBTVEFURS5QQU47CgoJCQkJCX0gZWxzZSB7CgoJCQkJCQlpZiAoIHNjb3BlLmVuYWJsZVJvdGF0ZSA9PT0gZmFsc2UgKSByZXR1cm47CgoJCQkJCQloYW5kbGVNb3VzZURvd25Sb3RhdGUoIGV2ZW50ICk7CgoJCQkJCQlzdGF0ZSA9IFNUQVRFLlJPVEFURTsKCgkJCQkJfQoKCQkJCQlicmVhazsKCgkJCQljYXNlIE1PVVNFLlBBTjoKCgkJCQkJaWYgKCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQuc2hpZnRLZXkgKSB7CgoJCQkJCQlpZiAoIHNjb3BlLmVuYWJsZVJvdGF0ZSA9PT0gZmFsc2UgKSByZXR1cm47CgoJCQkJCQloYW5kbGVNb3VzZURvd25Sb3RhdGUoIGV2ZW50ICk7CgoJCQkJCQlzdGF0ZSA9IFNUQVRFLlJPVEFURTsKCgkJCQkJfSBlbHNlIHsKCgkJCQkJCWlmICggc2NvcGUuZW5hYmxlUGFuID09PSBmYWxzZSApIHJldHVybjsKCgkJCQkJCWhhbmRsZU1vdXNlRG93blBhbiggZXZlbnQgKTsKCgkJCQkJCXN0YXRlID0gU1RBVEUuUEFOOwoKCQkJCQl9CgoJCQkJCWJyZWFrOwoKCQkJCWRlZmF1bHQ6CgoJCQkJCXN0YXRlID0gU1RBVEUuTk9ORTsKCgkJCX0KCgkJCWlmICggc3RhdGUgIT09IFNUQVRFLk5PTkUgKSB7CgoJCQkJc2NvcGUuZGlzcGF0Y2hFdmVudCggX3N0YXJ0RXZlbnQgKTsKCgkJCX0KCgkJfQoKCQlmdW5jdGlvbiBvbk1vdXNlTW92ZSggZXZlbnQgKSB7CgoJCQlzd2l0Y2ggKCBzdGF0ZSApIHsKCgkJCQljYXNlIFNUQVRFLlJPVEFURToKCgkJCQkJaWYgKCBzY29wZS5lbmFibGVSb3RhdGUgPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJCQloYW5kbGVNb3VzZU1vdmVSb3RhdGUoIGV2ZW50ICk7CgoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgU1RBVEUuRE9MTFk6CgoJCQkJCWlmICggc2NvcGUuZW5hYmxlWm9vbSA9PT0gZmFsc2UgKSByZXR1cm47CgoJCQkJCWhhbmRsZU1vdXNlTW92ZURvbGx5KCBldmVudCApOwoKCQkJCQlicmVhazsKCgkJCQljYXNlIFNUQVRFLlBBTjoKCgkJCQkJaWYgKCBzY29wZS5lbmFibGVQYW4gPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJCQloYW5kbGVNb3VzZU1vdmVQYW4oIGV2ZW50ICk7CgoJCQkJCWJyZWFrOwoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIG9uTW91c2VXaGVlbCggZXZlbnQgKSB7CgoJCQlpZiAoIHNjb3BlLmVuYWJsZWQgPT09IGZhbHNlIHx8IHNjb3BlLmVuYWJsZVpvb20gPT09IGZhbHNlIHx8IHN0YXRlICE9PSBTVEFURS5OT05FICkgcmV0dXJuOwoKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCXNjb3BlLmRpc3BhdGNoRXZlbnQoIF9zdGFydEV2ZW50ICk7CgoJCQloYW5kbGVNb3VzZVdoZWVsKCBjdXN0b21XaGVlbEV2ZW50KCBldmVudCApICk7CgoJCQlzY29wZS5kaXNwYXRjaEV2ZW50KCBfZW5kRXZlbnQgKTsKCgkJfQoKCQlmdW5jdGlvbiBjdXN0b21XaGVlbEV2ZW50KCBldmVudCApIHsKCgkJCWNvbnN0IG1vZGUgPSBldmVudC5kZWx0YU1vZGU7CgoJCQkvLyBtaW5pbWFsIHdoZWVsIGV2ZW50IGFsdGVyZWQgdG8gbWVldCBkZWx0YS16b29tIGRlbWFuZAoJCQljb25zdCBuZXdFdmVudCA9IHsKCQkJCWNsaWVudFg6IGV2ZW50LmNsaWVudFgsCgkJCQljbGllbnRZOiBldmVudC5jbGllbnRZLAoJCQkJZGVsdGFZOiBldmVudC5kZWx0YVksCgkJCX07CgoJCQlzd2l0Y2ggKCBtb2RlICkgewoKCQkJCWNhc2UgMTogLy8gTElORV9NT0RFCgkJCQkJbmV3RXZlbnQuZGVsdGFZICo9IDE2OwoJCQkJCWJyZWFrOwoKCQkJCWNhc2UgMjogLy8gUEFHRV9NT0RFCgkJCQkJbmV3RXZlbnQuZGVsdGFZICo9IDEwMDsKCQkJCQlicmVhazsKCgkJCX0KCgkJCS8vIGRldGVjdCBpZiBldmVudCB3YXMgdHJpZ2dlcmVkIGJ5IHBpbmNoaW5nCgkJCWlmICggZXZlbnQuY3RybEtleSAmJiAhIGNvbnRyb2xBY3RpdmUgKSB7CgoJCQkJbmV3RXZlbnQuZGVsdGFZICo9IDEwOwoKCQkJfQoKCQkJcmV0dXJuIG5ld0V2ZW50OwoKCQl9CgoJCWZ1bmN0aW9uIGludGVyY2VwdENvbnRyb2xEb3duKCBldmVudCApIHsKCgkJCWlmICggZXZlbnQua2V5ID09PSAnQ29udHJvbCcgKSB7CgoJCQkJY29udHJvbEFjdGl2ZSA9IHRydWU7CgoKCQkJCWNvbnN0IGRvY3VtZW50ID0gc2NvcGUuZG9tRWxlbWVudC5nZXRSb290Tm9kZSgpOyAvLyBvZmZzY3JlZW4gY2FudmFzIGNvbXBhdGliaWxpdHkKCgkJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAna2V5dXAnLCBpbnRlcmNlcHRDb250cm9sVXAsIHsgcGFzc2l2ZTogdHJ1ZSwgY2FwdHVyZTogdHJ1ZSB9ICk7CgoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gaW50ZXJjZXB0Q29udHJvbFVwKCBldmVudCApIHsKCgkJCWlmICggZXZlbnQua2V5ID09PSAnQ29udHJvbCcgKSB7CgoJCQkJY29udHJvbEFjdGl2ZSA9IGZhbHNlOwoKCgkJCQljb25zdCBkb2N1bWVudCA9IHNjb3BlLmRvbUVsZW1lbnQuZ2V0Um9vdE5vZGUoKTsgLy8gb2Zmc2NyZWVuIGNhbnZhcyBjb21wYXRpYmlsaXR5CgoJCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ2tleXVwJywgaW50ZXJjZXB0Q29udHJvbFVwLCB7IHBhc3NpdmU6IHRydWUsIGNhcHR1cmU6IHRydWUgfSApOwoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIG9uS2V5RG93biggZXZlbnQgKSB7CgoJCQlpZiAoIHNjb3BlLmVuYWJsZWQgPT09IGZhbHNlIHx8IHNjb3BlLmVuYWJsZVBhbiA9PT0gZmFsc2UgKSByZXR1cm47CgoJCQloYW5kbGVLZXlEb3duKCBldmVudCApOwoKCQl9CgoJCWZ1bmN0aW9uIG9uVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJCQl0cmFja1BvaW50ZXIoIGV2ZW50ICk7CgoJCQlzd2l0Y2ggKCBwb2ludGVycy5sZW5ndGggKSB7CgoJCQkJY2FzZSAxOgoKCQkJCQlzd2l0Y2ggKCBzY29wZS50b3VjaGVzLk9ORSApIHsKCgkJCQkJCWNhc2UgVE9VQ0guUk9UQVRFOgoKCQkJCQkJCWlmICggc2NvcGUuZW5hYmxlUm90YXRlID09PSBmYWxzZSApIHJldHVybjsKCgkJCQkJCQloYW5kbGVUb3VjaFN0YXJ0Um90YXRlKCBldmVudCApOwoKCQkJCQkJCXN0YXRlID0gU1RBVEUuVE9VQ0hfUk9UQVRFOwoKCQkJCQkJCWJyZWFrOwoKCQkJCQkJY2FzZSBUT1VDSC5QQU46CgoJCQkJCQkJaWYgKCBzY29wZS5lbmFibGVQYW4gPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJCQkJCWhhbmRsZVRvdWNoU3RhcnRQYW4oIGV2ZW50ICk7CgoJCQkJCQkJc3RhdGUgPSBTVEFURS5UT1VDSF9QQU47CgoJCQkJCQkJYnJlYWs7CgoJCQkJCQlkZWZhdWx0OgoKCQkJCQkJCXN0YXRlID0gU1RBVEUuTk9ORTsKCgkJCQkJfQoKCQkJCQlicmVhazsKCgkJCQljYXNlIDI6CgoJCQkJCXN3aXRjaCAoIHNjb3BlLnRvdWNoZXMuVFdPICkgewoKCQkJCQkJY2FzZSBUT1VDSC5ET0xMWV9QQU46CgoJCQkJCQkJaWYgKCBzY29wZS5lbmFibGVab29tID09PSBmYWxzZSAmJiBzY29wZS5lbmFibGVQYW4gPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJCQkJCWhhbmRsZVRvdWNoU3RhcnREb2xseVBhbiggZXZlbnQgKTsKCgkJCQkJCQlzdGF0ZSA9IFNUQVRFLlRPVUNIX0RPTExZX1BBTjsKCgkJCQkJCQlicmVhazsKCgkJCQkJCWNhc2UgVE9VQ0guRE9MTFlfUk9UQVRFOgoKCQkJCQkJCWlmICggc2NvcGUuZW5hYmxlWm9vbSA9PT0gZmFsc2UgJiYgc2NvcGUuZW5hYmxlUm90YXRlID09PSBmYWxzZSApIHJldHVybjsKCgkJCQkJCQloYW5kbGVUb3VjaFN0YXJ0RG9sbHlSb3RhdGUoIGV2ZW50ICk7CgoJCQkJCQkJc3RhdGUgPSBTVEFURS5UT1VDSF9ET0xMWV9ST1RBVEU7CgoJCQkJCQkJYnJlYWs7CgoJCQkJCQlkZWZhdWx0OgoKCQkJCQkJCXN0YXRlID0gU1RBVEUuTk9ORTsKCgkJCQkJfQoKCQkJCQlicmVhazsKCgkJCQlkZWZhdWx0OgoKCQkJCQlzdGF0ZSA9IFNUQVRFLk5PTkU7CgoJCQl9CgoJCQlpZiAoIHN0YXRlICE9PSBTVEFURS5OT05FICkgewoKCQkJCXNjb3BlLmRpc3BhdGNoRXZlbnQoIF9zdGFydEV2ZW50ICk7CgoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gb25Ub3VjaE1vdmUoIGV2ZW50ICkgewoKCQkJdHJhY2tQb2ludGVyKCBldmVudCApOwoKCQkJc3dpdGNoICggc3RhdGUgKSB7CgoJCQkJY2FzZSBTVEFURS5UT1VDSF9ST1RBVEU6CgoJCQkJCWlmICggc2NvcGUuZW5hYmxlUm90YXRlID09PSBmYWxzZSApIHJldHVybjsKCgkJCQkJaGFuZGxlVG91Y2hNb3ZlUm90YXRlKCBldmVudCApOwoKCQkJCQlzY29wZS51cGRhdGUoKTsKCgkJCQkJYnJlYWs7CgoJCQkJY2FzZSBTVEFURS5UT1VDSF9QQU46CgoJCQkJCWlmICggc2NvcGUuZW5hYmxlUGFuID09PSBmYWxzZSApIHJldHVybjsKCgkJCQkJaGFuZGxlVG91Y2hNb3ZlUGFuKCBldmVudCApOwoKCQkJCQlzY29wZS51cGRhdGUoKTsKCgkJCQkJYnJlYWs7CgoJCQkJY2FzZSBTVEFURS5UT1VDSF9ET0xMWV9QQU46CgoJCQkJCWlmICggc2NvcGUuZW5hYmxlWm9vbSA9PT0gZmFsc2UgJiYgc2NvcGUuZW5hYmxlUGFuID09PSBmYWxzZSApIHJldHVybjsKCgkJCQkJaGFuZGxlVG91Y2hNb3ZlRG9sbHlQYW4oIGV2ZW50ICk7CgoJCQkJCXNjb3BlLnVwZGF0ZSgpOwoKCQkJCQlicmVhazsKCgkJCQljYXNlIFNUQVRFLlRPVUNIX0RPTExZX1JPVEFURToKCgkJCQkJaWYgKCBzY29wZS5lbmFibGVab29tID09PSBmYWxzZSAmJiBzY29wZS5lbmFibGVSb3RhdGUgPT09IGZhbHNlICkgcmV0dXJuOwoKCQkJCQloYW5kbGVUb3VjaE1vdmVEb2xseVJvdGF0ZSggZXZlbnQgKTsKCgkJCQkJc2NvcGUudXBkYXRlKCk7CgoJCQkJCWJyZWFrOwoKCQkJCWRlZmF1bHQ6CgoJCQkJCXN0YXRlID0gU1RBVEUuTk9ORTsKCgkJCX0KCgkJfQoKCQlmdW5jdGlvbiBvbkNvbnRleHRNZW51KCBldmVudCApIHsKCgkJCWlmICggc2NvcGUuZW5hYmxlZCA9PT0gZmFsc2UgKSByZXR1cm47CgoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQl9CgoJCWZ1bmN0aW9uIGFkZFBvaW50ZXIoIGV2ZW50ICkgewoKCQkJcG9pbnRlcnMucHVzaCggZXZlbnQucG9pbnRlcklkICk7CgoJCX0KCgkJZnVuY3Rpb24gcmVtb3ZlUG9pbnRlciggZXZlbnQgKSB7CgoJCQlkZWxldGUgcG9pbnRlclBvc2l0aW9uc1sgZXZlbnQucG9pbnRlcklkIF07CgoJCQlmb3IgKCBsZXQgaSA9IDA7IGkgPCBwb2ludGVycy5sZW5ndGg7IGkgKysgKSB7CgoJCQkJaWYgKCBwb2ludGVyc1sgaSBdID09IGV2ZW50LnBvaW50ZXJJZCApIHsKCgkJCQkJcG9pbnRlcnMuc3BsaWNlKCBpLCAxICk7CgkJCQkJcmV0dXJuOwoKCQkJCX0KCgkJCX0KCgkJfQoKCQlmdW5jdGlvbiB0cmFja1BvaW50ZXIoIGV2ZW50ICkgewoKCQkJbGV0IHBvc2l0aW9uID0gcG9pbnRlclBvc2l0aW9uc1sgZXZlbnQucG9pbnRlcklkIF07CgoJCQlpZiAoIHBvc2l0aW9uID09PSB1bmRlZmluZWQgKSB7CgoJCQkJcG9zaXRpb24gPSBuZXcgVmVjdG9yMigpOwoJCQkJcG9pbnRlclBvc2l0aW9uc1sgZXZlbnQucG9pbnRlcklkIF0gPSBwb3NpdGlvbjsKCgkJCX0KCgkJCXBvc2l0aW9uLnNldCggZXZlbnQucGFnZVgsIGV2ZW50LnBhZ2VZICk7CgoJCX0KCgkJZnVuY3Rpb24gZ2V0U2Vjb25kUG9pbnRlclBvc2l0aW9uKCBldmVudCApIHsKCgkJCWNvbnN0IHBvaW50ZXJJZCA9ICggZXZlbnQucG9pbnRlcklkID09PSBwb2ludGVyc1sgMCBdICkgPyBwb2ludGVyc1sgMSBdIDogcG9pbnRlcnNbIDAgXTsKCgkJCXJldHVybiBwb2ludGVyUG9zaXRpb25zWyBwb2ludGVySWQgXTsKCgkJfQoKCQkvLwoKCQlzY29wZS5kb21FbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdjb250ZXh0bWVudScsIG9uQ29udGV4dE1lbnUgKTsKCgkJc2NvcGUuZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCAncG9pbnRlcmRvd24nLCBvblBvaW50ZXJEb3duICk7CgkJc2NvcGUuZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCAncG9pbnRlcmNhbmNlbCcsIG9uUG9pbnRlclVwICk7CgkJc2NvcGUuZG9tRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCAnd2hlZWwnLCBvbk1vdXNlV2hlZWwsIHsgcGFzc2l2ZTogZmFsc2UgfSApOwoKCQljb25zdCBkb2N1bWVudCA9IHNjb3BlLmRvbUVsZW1lbnQuZ2V0Um9vdE5vZGUoKTsgLy8gb2Zmc2NyZWVuIGNhbnZhcyBjb21wYXRpYmlsaXR5CgoJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICdrZXlkb3duJywgaW50ZXJjZXB0Q29udHJvbERvd24sIHsgcGFzc2l2ZTogdHJ1ZSwgY2FwdHVyZTogdHJ1ZSB9ICk7CgoJCS8vIGZvcmNlIGFuIHVwZGF0ZSBhdCBzdGFydAoKCQl0aGlzLnVwZGF0ZSgpOwoKCX0KCn0KCmV4cG9ydCB7IE9yYml0Q29udHJvbHMgfTsK",
    // 可选：OrbitControls.js 的 base64
        INLINE_USDZ_BASE64: "aW1wb3J0IHsKCUJ1ZmZlckF0dHJpYnV0ZSwKCUJ1ZmZlckdlb21ldHJ5LAoJQ2xhbXBUb0VkZ2VXcmFwcGluZywKCUZpbGVMb2FkZXIsCglHcm91cCwKCU5vQ29sb3JTcGFjZSwKCUxvYWRlciwKCU1lc2gsCglNZXNoUGh5c2ljYWxNYXRlcmlhbCwKCU1pcnJvcmVkUmVwZWF0V3JhcHBpbmcsCglSZXBlYXRXcmFwcGluZywKCVNSR0JDb2xvclNwYWNlLAoJVGV4dHVyZUxvYWRlciwKCU9iamVjdDNELAoJVmVjdG9yMgp9IGZyb20gJ3RocmVlJzsKCmltcG9ydCAqIGFzIGZmbGF0ZSBmcm9tICcuLi9saWJzL2ZmbGF0ZS5tb2R1bGUuanMnOwoKY2xhc3MgVVNEQVBhcnNlciB7CgoJcGFyc2UoIHRleHQgKSB7CgoJCWNvbnN0IGRhdGEgPSB7fTsKCgkJY29uc3QgbGluZXMgPSB0ZXh0LnNwbGl0KCAnXG4nICk7CgoJCWxldCBzdHJpbmcgPSBudWxsOwoJCWxldCB0YXJnZXQgPSBkYXRhOwoKCQljb25zdCBzdGFjayA9IFsgZGF0YSBdOwoKCQkvLyBkZWJ1Z2dlcjsKCgkJZm9yICggY29uc3QgbGluZSBvZiBsaW5lcyApIHsKCgkJCS8vIGNvbnNvbGUubG9nKCBsaW5lICk7CgoJCQlpZiAoIGxpbmUuaW5jbHVkZXMoICc9JyApICkgewoKCQkJCWNvbnN0IGFzc2lnbm1lbnQgPSBsaW5lLnNwbGl0KCAnPScgKTsKCgkJCQljb25zdCBsaHMgPSBhc3NpZ25tZW50WyAwIF0udHJpbSgpOwoJCQkJY29uc3QgcmhzID0gYXNzaWdubWVudFsgMSBdLnRyaW0oKTsKCgkJCQlpZiAoIHJocy5lbmRzV2l0aCggJ3snICkgKSB7CgoJCQkJCWNvbnN0IGdyb3VwID0ge307CgkJCQkJc3RhY2sucHVzaCggZ3JvdXAgKTsKCgkJCQkJdGFyZ2V0WyBsaHMgXSA9IGdyb3VwOwoJCQkJCXRhcmdldCA9IGdyb3VwOwoKCQkJCX0gZWxzZSB7CgoJCQkJCXRhcmdldFsgbGhzIF0gPSByaHM7CgoJCQkJfQoKCQkJfSBlbHNlIGlmICggbGluZS5lbmRzV2l0aCggJ3snICkgKSB7CgoJCQkJY29uc3QgZ3JvdXAgPSB0YXJnZXRbIHN0cmluZyBdIHx8IHt9OwoJCQkJc3RhY2sucHVzaCggZ3JvdXAgKTsKCgkJCQl0YXJnZXRbIHN0cmluZyBdID0gZ3JvdXA7CgkJCQl0YXJnZXQgPSBncm91cDsKCgkJCX0gZWxzZSBpZiAoIGxpbmUuZW5kc1dpdGgoICd9JyApICkgewoKCQkJCXN0YWNrLnBvcCgpOwoKCQkJCWlmICggc3RhY2subGVuZ3RoID09PSAwICkgY29udGludWU7CgoJCQkJdGFyZ2V0ID0gc3RhY2tbIHN0YWNrLmxlbmd0aCAtIDEgXTsKCgkJCX0gZWxzZSBpZiAoIGxpbmUuZW5kc1dpdGgoICcoJyApICkgewoKCQkJCWNvbnN0IG1ldGEgPSB7fTsKCQkJCXN0YWNrLnB1c2goIG1ldGEgKTsKCgkJCQlzdHJpbmcgPSBsaW5lLnNwbGl0KCAnKCcgKVsgMCBdLnRyaW0oKSB8fCBzdHJpbmc7CgoJCQkJdGFyZ2V0WyBzdHJpbmcgXSA9IG1ldGE7CgkJCQl0YXJnZXQgPSBtZXRhOwoKCQkJfSBlbHNlIGlmICggbGluZS5lbmRzV2l0aCggJyknICkgKSB7CgoJCQkJc3RhY2sucG9wKCk7CgoJCQkJdGFyZ2V0ID0gc3RhY2tbIHN0YWNrLmxlbmd0aCAtIDEgXTsKCgkJCX0gZWxzZSB7CgoJCQkJc3RyaW5nID0gbGluZS50cmltKCk7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIGRhdGE7CgoJfQoKfQoKY2xhc3MgVVNEWkxvYWRlciBleHRlbmRzIExvYWRlciB7CgoJY29uc3RydWN0b3IoIG1hbmFnZXIgKSB7CgoJCXN1cGVyKCBtYW5hZ2VyICk7CgoJfQoKCWxvYWQoIHVybCwgb25Mb2FkLCBvblByb2dyZXNzLCBvbkVycm9yICkgewoKCQljb25zdCBzY29wZSA9IHRoaXM7CgoJCWNvbnN0IGxvYWRlciA9IG5ldyBGaWxlTG9hZGVyKCBzY29wZS5tYW5hZ2VyICk7CgkJbG9hZGVyLnNldFBhdGgoIHNjb3BlLnBhdGggKTsKCQlsb2FkZXIuc2V0UmVzcG9uc2VUeXBlKCAnYXJyYXlidWZmZXInICk7CgkJbG9hZGVyLnNldFJlcXVlc3RIZWFkZXIoIHNjb3BlLnJlcXVlc3RIZWFkZXIgKTsKCQlsb2FkZXIuc2V0V2l0aENyZWRlbnRpYWxzKCBzY29wZS53aXRoQ3JlZGVudGlhbHMgKTsKCQlsb2FkZXIubG9hZCggdXJsLCBmdW5jdGlvbiAoIHRleHQgKSB7CgoJCQl0cnkgewoKCQkJCW9uTG9hZCggc2NvcGUucGFyc2UoIHRleHQgKSApOwoKCQkJfSBjYXRjaCAoIGUgKSB7CgoJCQkJaWYgKCBvbkVycm9yICkgewoKCQkJCQlvbkVycm9yKCBlICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJY29uc29sZS5lcnJvciggZSApOwoKCQkJCX0KCgkJCQlzY29wZS5tYW5hZ2VyLml0ZW1FcnJvciggdXJsICk7CgoJCQl9CgoJCX0sIG9uUHJvZ3Jlc3MsIG9uRXJyb3IgKTsKCgl9CgoJcGFyc2UoIGJ1ZmZlciApIHsKCgkJY29uc3QgcGFyc2VyID0gbmV3IFVTREFQYXJzZXIoKTsKCgkJZnVuY3Rpb24gcGFyc2VBc3NldHMoIHppcCApIHsKCgkJCWNvbnN0IGRhdGEgPSB7fTsKCQkJY29uc3QgbG9hZGVyID0gbmV3IEZpbGVMb2FkZXIoKTsKCQkJbG9hZGVyLnNldFJlc3BvbnNlVHlwZSggJ2FycmF5YnVmZmVyJyApOwoKCQkJZm9yICggY29uc3QgZmlsZW5hbWUgaW4gemlwICkgewoKCQkJCWlmICggZmlsZW5hbWUuZW5kc1dpdGgoICdwbmcnICkgKSB7CgoJCQkJCWNvbnN0IGJsb2IgPSBuZXcgQmxvYiggWyB6aXBbIGZpbGVuYW1lIF0gXSwgeyB0eXBlOiB7IHR5cGU6ICdpbWFnZS9wbmcnIH0gfSApOwoJCQkJCWRhdGFbIGZpbGVuYW1lIF0gPSBVUkwuY3JlYXRlT2JqZWN0VVJMKCBibG9iICk7CgoJCQkJfQoKCQkJCWlmICggZmlsZW5hbWUuZW5kc1dpdGgoICd1c2QnICkgfHwgZmlsZW5hbWUuZW5kc1dpdGgoICd1c2RhJyApICkgewoKCQkJCQlpZiAoIGlzQ3JhdGVGaWxlKCB6aXBbIGZpbGVuYW1lIF0gKSApIHsKCgkJCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLlVTRFpMb2FkZXI6IENyYXRlIGZpbGVzICgudXNkYyBvciBiaW5hcnkgLnVzZCkgYXJlIG5vdCBzdXBwb3J0ZWQuJyApOwoJCQkJCQljb250aW51ZTsKCgkJCQkJfQoKCQkJCQljb25zdCB0ZXh0ID0gZmZsYXRlLnN0ckZyb21VOCggemlwWyBmaWxlbmFtZSBdICk7CgkJCQkJZGF0YVsgZmlsZW5hbWUgXSA9IHBhcnNlci5wYXJzZSggdGV4dCApOwoKCQkJCX0KCgkJCX0KCgkJCXJldHVybiBkYXRhOwoKCQl9CgoJCWZ1bmN0aW9uIGlzQ3JhdGVGaWxlKCBidWZmZXIgKSB7CgoJCQkvLyBDaGVjayBpZiB0aGlzIGEgY3JhdGUgZmlsZS4gRmlyc3QgNyBieXRlcyBvZiBhIGNyYXRlIGZpbGUgYXJlICJQWFItVVNEQyIuCgkJCWNvbnN0IGZpbGVIZWFkZXIgPSBidWZmZXIuc2xpY2UoIDAsIDcgKTsKCQkJY29uc3QgY3JhdGVIZWFkZXIgPSBuZXcgVWludDhBcnJheSggWyAweDUwLCAweDU4LCAweDUyLCAweDJELCAweDU1LCAweDUzLCAweDQ0LCAweDQzIF0gKTsKCgkJCS8vIElmIHRoaXMgaXMgbm90IGEgY3JhdGUgZmlsZSwgd2UgYXNzdW1lIGl0IGlzIGEgcGxhaW4gVVNEQSBmaWxlLgoJCQlyZXR1cm4gZmlsZUhlYWRlci5ldmVyeSggKCB2YWx1ZSwgaW5kZXggKSA9PiB2YWx1ZSA9PT0gY3JhdGVIZWFkZXJbIGluZGV4IF0gKTsKCgkJfQoKCQlmdW5jdGlvbiBmaW5kVVNEKCB6aXAgKSB7CgoJCQlpZiAoIHppcC5sZW5ndGggPCAxICkgcmV0dXJuIHVuZGVmaW5lZDsKCgkJCWNvbnN0IGZpcnN0RmlsZU5hbWUgPSBPYmplY3Qua2V5cyggemlwIClbIDAgXTsKCQkJbGV0IGlzQ3JhdGUgPSBmYWxzZTsKCgkJCS8vIEFzIHBlciB0aGUgVVNEIHNwZWNpZmljYXRpb24sIHRoZSBmaXJzdCBlbnRyeSBpbiB0aGUgemlwIGFyY2hpdmUgaXMgdXNlZCBhcyB0aGUgbWFpbiBmaWxlICgiVXNkU3RhZ2UiKS4KCQkJLy8gQVNDSUkgZmlsZXMgY2FuIGVuZCBpbiBlaXRoZXIgLnVzZGEgb3IgLnVzZC4KCQkJLy8gU2VlIGh0dHBzOi8vb3BlbnVzZC5vcmcvcmVsZWFzZS9zcGVjX3VzZHouaHRtbCNsYXlvdXQKCQkJaWYgKCBmaXJzdEZpbGVOYW1lLmVuZHNXaXRoKCAndXNkYScgKSApIHJldHVybiB6aXBbIGZpcnN0RmlsZU5hbWUgXTsKCgkJCWlmICggZmlyc3RGaWxlTmFtZS5lbmRzV2l0aCggJ3VzZGMnICkgKSB7CgoJCQkJaXNDcmF0ZSA9IHRydWU7CgoJCQl9IGVsc2UgaWYgKCBmaXJzdEZpbGVOYW1lLmVuZHNXaXRoKCAndXNkJyApICkgewoKCQkJCS8vIElmIHRoaXMgaXMgbm90IGEgY3JhdGUgZmlsZSwgd2UgYXNzdW1lIGl0IGlzIGEgcGxhaW4gVVNEQSBmaWxlLgoJCQkJaWYgKCAhIGlzQ3JhdGVGaWxlKCB6aXBbIGZpcnN0RmlsZU5hbWUgXSApICkgewoKCQkJCQlyZXR1cm4gemlwWyBmaXJzdEZpbGVOYW1lIF07CgoJCQkJfSBlbHNlIHsKCgkJCQkJaXNDcmF0ZSA9IHRydWU7CgoJCQkJfQoKCQkJfQoKCQkJaWYgKCBpc0NyYXRlICkgewoKCQkJCWNvbnNvbGUud2FybiggJ1RIUkVFLlVTRFpMb2FkZXI6IENyYXRlIGZpbGVzICgudXNkYyBvciBiaW5hcnkgLnVzZCkgYXJlIG5vdCBzdXBwb3J0ZWQuJyApOwoKCQkJfQoKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCgkJfQoKCQljb25zdCB6aXAgPSBmZmxhdGUudW56aXBTeW5jKCBuZXcgVWludDhBcnJheSggYnVmZmVyICkgKTsKCgkJLy8gY29uc29sZS5sb2coIHppcCApOwoKCQljb25zdCBhc3NldHMgPSBwYXJzZUFzc2V0cyggemlwICk7CgoJCS8vIGNvbnNvbGUubG9nKCBhc3NldHMgKQoKCQljb25zdCBmaWxlID0gZmluZFVTRCggemlwICk7CgoJCWlmICggZmlsZSA9PT0gdW5kZWZpbmVkICkgewoKCQkJY29uc29sZS53YXJuKCAnVEhSRUUuVVNEWkxvYWRlcjogTm8gdXNkYSBmaWxlIGZvdW5kLicgKTsKCgkJCXJldHVybiBuZXcgR3JvdXAoKTsKCgkJfQoKCgkJLy8gUGFyc2UgZmlsZQoKCQljb25zdCB0ZXh0ID0gZmZsYXRlLnN0ckZyb21VOCggZmlsZSApOwoJCWNvbnN0IHJvb3QgPSBwYXJzZXIucGFyc2UoIHRleHQgKTsKCgkJLy8gQnVpbGQgc2NlbmUKCgkJZnVuY3Rpb24gZmluZE1lc2hHZW9tZXRyeSggZGF0YSApIHsKCgkJCWlmICggISBkYXRhICkgcmV0dXJuIHVuZGVmaW5lZDsKCgkJCWlmICggJ3ByZXBlbmQgcmVmZXJlbmNlcycgaW4gZGF0YSApIHsKCgkJCQljb25zdCByZWZlcmVuY2UgPSBkYXRhWyAncHJlcGVuZCByZWZlcmVuY2VzJyBdOwoJCQkJY29uc3QgcGFydHMgPSByZWZlcmVuY2Uuc3BsaXQoICdAJyApOwoJCQkJY29uc3QgcGF0aCA9IHBhcnRzWyAxIF0ucmVwbGFjZSggL14uXC8vLCAnJyApOwoJCQkJY29uc3QgaWQgPSBwYXJ0c1sgMiBdLnJlcGxhY2UoIC9ePFwvLywgJycgKS5yZXBsYWNlKCAvPiQvLCAnJyApOwoKCQkJCXJldHVybiBmaW5kR2VvbWV0cnkoIGFzc2V0c1sgcGF0aCBdLCBpZCApOwoKCQkJfQoKCQkJcmV0dXJuIGZpbmRHZW9tZXRyeSggZGF0YSApOwoKCQl9CgoJCWZ1bmN0aW9uIGZpbmRHZW9tZXRyeSggZGF0YSwgaWQgKSB7CgoJCQlpZiAoICEgZGF0YSApIHJldHVybiB1bmRlZmluZWQ7CgoJCQlpZiAoIGlkICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJY29uc3QgZGVmID0gYGRlZiBNZXNoICIke2lkfSJgOwoKCQkJCWlmICggZGVmIGluIGRhdGEgKSB7CgoJCQkJCXJldHVybiBkYXRhWyBkZWYgXTsKCgkJCQl9CgoJCQl9CgoJCQlmb3IgKCBjb25zdCBuYW1lIGluIGRhdGEgKSB7CgoJCQkJY29uc3Qgb2JqZWN0ID0gZGF0YVsgbmFtZSBdOwoKCQkJCWlmICggbmFtZS5zdGFydHNXaXRoKCAnZGVmIE1lc2gnICkgKSB7CgoJCQkJCS8vIE1vdmUgcG9pbnRzIHRvIE1lc2gKCgkJCQkJaWYgKCAncG9pbnQzZltdIHBvaW50cycgaW4gZGF0YSApIHsKCgkJCQkJCW9iamVjdFsgJ3BvaW50M2ZbXSBwb2ludHMnIF0gPSBkYXRhWyAncG9pbnQzZltdIHBvaW50cycgXTsKCgkJCQkJfQoKCQkJCQkvLyBNb3ZlIHN0IHRvIE1lc2gKCgkJCQkJaWYgKCAndGV4Q29vcmQyZltdIHByaW12YXJzOnN0JyBpbiBkYXRhICkgewoKCQkJCQkJb2JqZWN0WyAndGV4Q29vcmQyZltdIHByaW12YXJzOnN0JyBdID0gZGF0YVsgJ3RleENvb3JkMmZbXSBwcmltdmFyczpzdCcgXTsKCgkJCQkJfQoKCQkJCQkvLyBNb3ZlIHN0IGluZGljZXMgdG8gTWVzaAoKCQkJCQlpZiAoICdpbnRbXSBwcmltdmFyczpzdDppbmRpY2VzJyBpbiBkYXRhICkgewoKCQkJCQkJb2JqZWN0WyAnaW50W10gcHJpbXZhcnM6c3Q6aW5kaWNlcycgXSA9IGRhdGFbICdpbnRbXSBwcmltdmFyczpzdDppbmRpY2VzJyBdOwoKCQkJCQl9CgoJCQkJCXJldHVybiBvYmplY3Q7CgoJCQkJfQoKCgkJCQlpZiAoIHR5cGVvZiBvYmplY3QgPT09ICdvYmplY3QnICkgewoKCQkJCQljb25zdCBnZW9tZXRyeSA9IGZpbmRHZW9tZXRyeSggb2JqZWN0ICk7CgoJCQkJCWlmICggZ2VvbWV0cnkgKSByZXR1cm4gZ2VvbWV0cnk7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIGJ1aWxkR2VvbWV0cnkoIGRhdGEgKSB7CgoJCQlpZiAoICEgZGF0YSApIHJldHVybiB1bmRlZmluZWQ7CgoJCQlsZXQgZ2VvbWV0cnkgPSBuZXcgQnVmZmVyR2VvbWV0cnkoKTsKCgkJCWlmICggJ2ludFtdIGZhY2VWZXJ0ZXhJbmRpY2VzJyBpbiBkYXRhICkgewoKCQkJCWNvbnN0IGluZGljZXMgPSBKU09OLnBhcnNlKCBkYXRhWyAnaW50W10gZmFjZVZlcnRleEluZGljZXMnIF0gKTsKCQkJCWdlb21ldHJ5LnNldEluZGV4KCBpbmRpY2VzICk7CgoJCQl9CgoJCQlpZiAoICdwb2ludDNmW10gcG9pbnRzJyBpbiBkYXRhICkgewoKCQkJCWNvbnN0IHBvc2l0aW9ucyA9IEpTT04ucGFyc2UoIGRhdGFbICdwb2ludDNmW10gcG9pbnRzJyBdLnJlcGxhY2UoIC9bKCldKi9nLCAnJyApICk7CgkJCQljb25zdCBhdHRyaWJ1dGUgPSBuZXcgQnVmZmVyQXR0cmlidXRlKCBuZXcgRmxvYXQzMkFycmF5KCBwb3NpdGlvbnMgKSwgMyApOwoJCQkJZ2VvbWV0cnkuc2V0QXR0cmlidXRlKCAncG9zaXRpb24nLCBhdHRyaWJ1dGUgKTsKCgkJCX0KCgkJCWlmICggJ25vcm1hbDNmW10gbm9ybWFscycgaW4gZGF0YSApIHsKCgkJCQljb25zdCBub3JtYWxzID0gSlNPTi5wYXJzZSggZGF0YVsgJ25vcm1hbDNmW10gbm9ybWFscycgXS5yZXBsYWNlKCAvWygpXSovZywgJycgKSApOwoJCQkJY29uc3QgYXR0cmlidXRlID0gbmV3IEJ1ZmZlckF0dHJpYnV0ZSggbmV3IEZsb2F0MzJBcnJheSggbm9ybWFscyApLCAzICk7CgkJCQlnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoICdub3JtYWwnLCBhdHRyaWJ1dGUgKTsKCgkJCX0gZWxzZSB7CgoJCQkJZ2VvbWV0cnkuY29tcHV0ZVZlcnRleE5vcm1hbHMoKTsKCgkJCX0KCgkJCWlmICggJ2Zsb2F0MltdIHByaW12YXJzOnN0JyBpbiBkYXRhICkgewoKCQkJCWRhdGFbICd0ZXhDb29yZDJmW10gcHJpbXZhcnM6c3QnIF0gPSBkYXRhWyAnZmxvYXQyW10gcHJpbXZhcnM6c3QnIF07CgoJCQl9CgoJCQlpZiAoICd0ZXhDb29yZDJmW10gcHJpbXZhcnM6c3QnIGluIGRhdGEgKSB7CgoJCQkJY29uc3QgdXZzID0gSlNPTi5wYXJzZSggZGF0YVsgJ3RleENvb3JkMmZbXSBwcmltdmFyczpzdCcgXS5yZXBsYWNlKCAvWygpXSovZywgJycgKSApOwoJCQkJY29uc3QgYXR0cmlidXRlID0gbmV3IEJ1ZmZlckF0dHJpYnV0ZSggbmV3IEZsb2F0MzJBcnJheSggdXZzICksIDIgKTsKCgkJCQlpZiAoICdpbnRbXSBwcmltdmFyczpzdDppbmRpY2VzJyBpbiBkYXRhICkgewoKCQkJCQlnZW9tZXRyeSA9IGdlb21ldHJ5LnRvTm9uSW5kZXhlZCgpOwoKCQkJCQljb25zdCBpbmRpY2VzID0gSlNPTi5wYXJzZSggZGF0YVsgJ2ludFtdIHByaW12YXJzOnN0OmluZGljZXMnIF0gKTsKCQkJCQlnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoICd1dicsIHRvRmxhdEJ1ZmZlckF0dHJpYnV0ZSggYXR0cmlidXRlLCBpbmRpY2VzICkgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlnZW9tZXRyeS5zZXRBdHRyaWJ1dGUoICd1dicsIGF0dHJpYnV0ZSApOwoKCQkJCX0KCgkJCX0KCgkJCXJldHVybiBnZW9tZXRyeTsKCgkJfQoKCQlmdW5jdGlvbiB0b0ZsYXRCdWZmZXJBdHRyaWJ1dGUoIGF0dHJpYnV0ZSwgaW5kaWNlcyApIHsKCgkJCWNvbnN0IGFycmF5ID0gYXR0cmlidXRlLmFycmF5OwoJCQljb25zdCBpdGVtU2l6ZSA9IGF0dHJpYnV0ZS5pdGVtU2l6ZTsKCgkJCWNvbnN0IGFycmF5MiA9IG5ldyBhcnJheS5jb25zdHJ1Y3RvciggaW5kaWNlcy5sZW5ndGggKiBpdGVtU2l6ZSApOwoKCQkJbGV0IGluZGV4ID0gMCwgaW5kZXgyID0gMDsKCgkJCWZvciAoIGxldCBpID0gMCwgbCA9IGluZGljZXMubGVuZ3RoOyBpIDwgbDsgaSArKyApIHsKCgkJCQlpbmRleCA9IGluZGljZXNbIGkgXSAqIGl0ZW1TaXplOwoKCQkJCWZvciAoIGxldCBqID0gMDsgaiA8IGl0ZW1TaXplOyBqICsrICkgewoKCQkJCQlhcnJheTJbIGluZGV4MiArKyBdID0gYXJyYXlbIGluZGV4ICsrIF07CgoJCQkJfQoKCQkJfQoKCQkJcmV0dXJuIG5ldyBCdWZmZXJBdHRyaWJ1dGUoIGFycmF5MiwgaXRlbVNpemUgKTsKCgkJfQoKCQlmdW5jdGlvbiBmaW5kTWVzaE1hdGVyaWFsKCBkYXRhICkgewoKCQkJaWYgKCAhIGRhdGEgKSByZXR1cm4gdW5kZWZpbmVkOwoKCQkJaWYgKCAncmVsIG1hdGVyaWFsOmJpbmRpbmcnIGluIGRhdGEgKSB7CgoJCQkJY29uc3QgcmVmZXJlbmNlID0gZGF0YVsgJ3JlbCBtYXRlcmlhbDpiaW5kaW5nJyBdOwoJCQkJY29uc3QgaWQgPSByZWZlcmVuY2UucmVwbGFjZSggL148XC8vLCAnJyApLnJlcGxhY2UoIC8+JC8sICcnICk7CgkJCQljb25zdCBwYXJ0cyA9IGlkLnNwbGl0KCAnLycgKTsKCgkJCQlyZXR1cm4gZmluZE1hdGVyaWFsKCByb290LCBgICIkeyBwYXJ0c1sgMSBdIH0iYCApOwoKCQkJfQoKCQkJcmV0dXJuIGZpbmRNYXRlcmlhbCggZGF0YSApOwoKCQl9CgoJCWZ1bmN0aW9uIGZpbmRNYXRlcmlhbCggZGF0YSwgaWQgPSAnJyApIHsKCgkJCWZvciAoIGNvbnN0IG5hbWUgaW4gZGF0YSApIHsKCgkJCQljb25zdCBvYmplY3QgPSBkYXRhWyBuYW1lIF07CgoJCQkJaWYgKCBuYW1lLnN0YXJ0c1dpdGgoICdkZWYgTWF0ZXJpYWwnICsgaWQgKSApIHsKCgkJCQkJcmV0dXJuIG9iamVjdDsKCgkJCQl9CgoJCQkJaWYgKCB0eXBlb2Ygb2JqZWN0ID09PSAnb2JqZWN0JyApIHsKCgkJCQkJY29uc3QgbWF0ZXJpYWwgPSBmaW5kTWF0ZXJpYWwoIG9iamVjdCwgaWQgKTsKCgkJCQkJaWYgKCBtYXRlcmlhbCApIHJldHVybiBtYXRlcmlhbDsKCgkJCQl9CgoJCQl9CgoJCX0KCgkJZnVuY3Rpb24gc2V0VGV4dHVyZVBhcmFtcyggbWFwLCBkYXRhX3ZhbHVlICkgewoKCQkJLy8gcm90YXRpb24sIHNjYWxlIGFuZCB0cmFuc2xhdGlvbgoKCQkJaWYgKCBkYXRhX3ZhbHVlWyAnZmxvYXQgaW5wdXRzOnJvdGF0aW9uJyBdICkgewoKCQkJCW1hcC5yb3RhdGlvbiA9IHBhcnNlRmxvYXQoIGRhdGFfdmFsdWVbICdmbG9hdCBpbnB1dHM6cm90YXRpb24nIF0gKTsKCgkJCX0KCgkJCWlmICggZGF0YV92YWx1ZVsgJ2Zsb2F0MiBpbnB1dHM6c2NhbGUnIF0gKSB7CgoJCQkJbWFwLnJlcGVhdCA9IG5ldyBWZWN0b3IyKCkuZnJvbUFycmF5KCBKU09OLnBhcnNlKCAnWycgKyBkYXRhX3ZhbHVlWyAnZmxvYXQyIGlucHV0czpzY2FsZScgXS5yZXBsYWNlKCAvWygpXSovZywgJycgKSArICddJyApICk7CgoJCQl9CgoJCQlpZiAoIGRhdGFfdmFsdWVbICdmbG9hdDIgaW5wdXRzOnRyYW5zbGF0aW9uJyBdICkgewoKCQkJCW1hcC5vZmZzZXQgPSBuZXcgVmVjdG9yMigpLmZyb21BcnJheSggSlNPTi5wYXJzZSggJ1snICsgZGF0YV92YWx1ZVsgJ2Zsb2F0MiBpbnB1dHM6dHJhbnNsYXRpb24nIF0ucmVwbGFjZSggL1soKV0qL2csICcnICkgKyAnXScgKSApOwoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIGJ1aWxkTWF0ZXJpYWwoIGRhdGEgKSB7CgoJCQljb25zdCBtYXRlcmlhbCA9IG5ldyBNZXNoUGh5c2ljYWxNYXRlcmlhbCgpOwoKCQkJaWYgKCBkYXRhICE9PSB1bmRlZmluZWQgKSB7CgoJCQkJaWYgKCAnZGVmIFNoYWRlciAiUHJldmlld1N1cmZhY2UiJyBpbiBkYXRhICkgewoKCQkJCQljb25zdCBzdXJmYWNlID0gZGF0YVsgJ2RlZiBTaGFkZXIgIlByZXZpZXdTdXJmYWNlIicgXTsKCgkJCQkJaWYgKCAnY29sb3IzZiBpbnB1dHM6ZGlmZnVzZUNvbG9yLmNvbm5lY3QnIGluIHN1cmZhY2UgKSB7CgoJCQkJCQljb25zdCBwYXRoID0gc3VyZmFjZVsgJ2NvbG9yM2YgaW5wdXRzOmRpZmZ1c2VDb2xvci5jb25uZWN0JyBdOwoJCQkJCQljb25zdCBzYW1wbGVyID0gZmluZFRleHR1cmUoIHJvb3QsIC8oXHcrKS5vdXRwdXQvLmV4ZWMoIHBhdGggKVsgMSBdICk7CgoJCQkJCQltYXRlcmlhbC5tYXAgPSBidWlsZFRleHR1cmUoIHNhbXBsZXIgKTsKCQkJCQkJbWF0ZXJpYWwubWFwLmNvbG9yU3BhY2UgPSBTUkdCQ29sb3JTcGFjZTsKCgkJCQkJCWlmICggJ2RlZiBTaGFkZXIgIlRyYW5zZm9ybTJkX2RpZmZ1c2UiJyBpbiBkYXRhICkgewoKCQkJCQkJCXNldFRleHR1cmVQYXJhbXMoIG1hdGVyaWFsLm1hcCwgZGF0YVsgJ2RlZiBTaGFkZXIgIlRyYW5zZm9ybTJkX2RpZmZ1c2UiJyBdICk7CgoJCQkJCQl9CgoJCQkJCX0gZWxzZSBpZiAoICdjb2xvcjNmIGlucHV0czpkaWZmdXNlQ29sb3InIGluIHN1cmZhY2UgKSB7CgoJCQkJCQljb25zdCBjb2xvciA9IHN1cmZhY2VbICdjb2xvcjNmIGlucHV0czpkaWZmdXNlQ29sb3InIF0ucmVwbGFjZSggL1soKV0qL2csICcnICk7CgkJCQkJCW1hdGVyaWFsLmNvbG9yLmZyb21BcnJheSggSlNPTi5wYXJzZSggJ1snICsgY29sb3IgKyAnXScgKSApOwoKCQkJCQl9CgoJCQkJCWlmICggJ2NvbG9yM2YgaW5wdXRzOmVtaXNzaXZlQ29sb3IuY29ubmVjdCcgaW4gc3VyZmFjZSApIHsKCgkJCQkJCWNvbnN0IHBhdGggPSBzdXJmYWNlWyAnY29sb3IzZiBpbnB1dHM6ZW1pc3NpdmVDb2xvci5jb25uZWN0JyBdOwoJCQkJCQljb25zdCBzYW1wbGVyID0gZmluZFRleHR1cmUoIHJvb3QsIC8oXHcrKS5vdXRwdXQvLmV4ZWMoIHBhdGggKVsgMSBdICk7CgoJCQkJCQltYXRlcmlhbC5lbWlzc2l2ZU1hcCA9IGJ1aWxkVGV4dHVyZSggc2FtcGxlciApOwoJCQkJCQltYXRlcmlhbC5lbWlzc2l2ZU1hcC5jb2xvclNwYWNlID0gU1JHQkNvbG9yU3BhY2U7CgkJCQkJCW1hdGVyaWFsLmVtaXNzaXZlLnNldCggMHhmZmZmZmYgKTsKCgkJCQkJCWlmICggJ2RlZiBTaGFkZXIgIlRyYW5zZm9ybTJkX2VtaXNzaXZlIicgaW4gZGF0YSApIHsKCgkJCQkJCQlzZXRUZXh0dXJlUGFyYW1zKCBtYXRlcmlhbC5lbWlzc2l2ZU1hcCwgZGF0YVsgJ2RlZiBTaGFkZXIgIlRyYW5zZm9ybTJkX2VtaXNzaXZlIicgXSApOwoKCQkJCQkJfQoKCQkJCQl9IGVsc2UgaWYgKCAnY29sb3IzZiBpbnB1dHM6ZW1pc3NpdmVDb2xvcicgaW4gc3VyZmFjZSApIHsKCgkJCQkJCWNvbnN0IGNvbG9yID0gc3VyZmFjZVsgJ2NvbG9yM2YgaW5wdXRzOmVtaXNzaXZlQ29sb3InIF0ucmVwbGFjZSggL1soKV0qL2csICcnICk7CgkJCQkJCW1hdGVyaWFsLmVtaXNzaXZlLmZyb21BcnJheSggSlNPTi5wYXJzZSggJ1snICsgY29sb3IgKyAnXScgKSApOwoKCQkJCQl9CgoJCQkJCWlmICggJ25vcm1hbDNmIGlucHV0czpub3JtYWwuY29ubmVjdCcgaW4gc3VyZmFjZSApIHsKCgkJCQkJCWNvbnN0IHBhdGggPSBzdXJmYWNlWyAnbm9ybWFsM2YgaW5wdXRzOm5vcm1hbC5jb25uZWN0JyBdOwoJCQkJCQljb25zdCBzYW1wbGVyID0gZmluZFRleHR1cmUoIHJvb3QsIC8oXHcrKS5vdXRwdXQvLmV4ZWMoIHBhdGggKVsgMSBdICk7CgoJCQkJCQltYXRlcmlhbC5ub3JtYWxNYXAgPSBidWlsZFRleHR1cmUoIHNhbXBsZXIgKTsKCQkJCQkJbWF0ZXJpYWwubm9ybWFsTWFwLmNvbG9yU3BhY2UgPSBOb0NvbG9yU3BhY2U7CgoJCQkJCQlpZiAoICdkZWYgU2hhZGVyICJUcmFuc2Zvcm0yZF9ub3JtYWwiJyBpbiBkYXRhICkgewoKCQkJCQkJCXNldFRleHR1cmVQYXJhbXMoIG1hdGVyaWFsLm5vcm1hbE1hcCwgZGF0YVsgJ2RlZiBTaGFkZXIgIlRyYW5zZm9ybTJkX25vcm1hbCInIF0gKTsKCgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAoICdmbG9hdCBpbnB1dHM6cm91Z2huZXNzLmNvbm5lY3QnIGluIHN1cmZhY2UgKSB7CgoJCQkJCQljb25zdCBwYXRoID0gc3VyZmFjZVsgJ2Zsb2F0IGlucHV0czpyb3VnaG5lc3MuY29ubmVjdCcgXTsKCQkJCQkJY29uc3Qgc2FtcGxlciA9IGZpbmRUZXh0dXJlKCByb290LCAvKFx3Kykub3V0cHV0Ly5leGVjKCBwYXRoIClbIDEgXSApOwoKCQkJCQkJbWF0ZXJpYWwucm91Z2huZXNzID0gMS4wOwoJCQkJCQltYXRlcmlhbC5yb3VnaG5lc3NNYXAgPSBidWlsZFRleHR1cmUoIHNhbXBsZXIgKTsKCQkJCQkJbWF0ZXJpYWwucm91Z2huZXNzTWFwLmNvbG9yU3BhY2UgPSBOb0NvbG9yU3BhY2U7CgoJCQkJCQlpZiAoICdkZWYgU2hhZGVyICJUcmFuc2Zvcm0yZF9yb3VnaG5lc3MiJyBpbiBkYXRhICkgewoKCQkJCQkJCXNldFRleHR1cmVQYXJhbXMoIG1hdGVyaWFsLnJvdWdobmVzc01hcCwgZGF0YVsgJ2RlZiBTaGFkZXIgIlRyYW5zZm9ybTJkX3JvdWdobmVzcyInIF0gKTsKCgkJCQkJCX0KCgkJCQkJfSBlbHNlIGlmICggJ2Zsb2F0IGlucHV0czpyb3VnaG5lc3MnIGluIHN1cmZhY2UgKSB7CgoJCQkJCQltYXRlcmlhbC5yb3VnaG5lc3MgPSBwYXJzZUZsb2F0KCBzdXJmYWNlWyAnZmxvYXQgaW5wdXRzOnJvdWdobmVzcycgXSApOwoKCQkJCQl9CgoJCQkJCWlmICggJ2Zsb2F0IGlucHV0czptZXRhbGxpYy5jb25uZWN0JyBpbiBzdXJmYWNlICkgewoKCQkJCQkJY29uc3QgcGF0aCA9IHN1cmZhY2VbICdmbG9hdCBpbnB1dHM6bWV0YWxsaWMuY29ubmVjdCcgXTsKCQkJCQkJY29uc3Qgc2FtcGxlciA9IGZpbmRUZXh0dXJlKCByb290LCAvKFx3Kykub3V0cHV0Ly5leGVjKCBwYXRoIClbIDEgXSApOwoKCQkJCQkJbWF0ZXJpYWwubWV0YWxuZXNzID0gMS4wOwoJCQkJCQltYXRlcmlhbC5tZXRhbG5lc3NNYXAgPSBidWlsZFRleHR1cmUoIHNhbXBsZXIgKTsKCQkJCQkJbWF0ZXJpYWwubWV0YWxuZXNzTWFwLmNvbG9yU3BhY2UgPSBOb0NvbG9yU3BhY2U7CgoJCQkJCQlpZiAoICdkZWYgU2hhZGVyICJUcmFuc2Zvcm0yZF9tZXRhbGxpYyInIGluIGRhdGEgKSB7CgoJCQkJCQkJc2V0VGV4dHVyZVBhcmFtcyggbWF0ZXJpYWwubWV0YWxuZXNzTWFwLCBkYXRhWyAnZGVmIFNoYWRlciAiVHJhbnNmb3JtMmRfbWV0YWxsaWMiJyBdICk7CgoJCQkJCQl9CgoJCQkJCX0gZWxzZSBpZiAoICdmbG9hdCBpbnB1dHM6bWV0YWxsaWMnIGluIHN1cmZhY2UgKSB7CgoJCQkJCQltYXRlcmlhbC5tZXRhbG5lc3MgPSBwYXJzZUZsb2F0KCBzdXJmYWNlWyAnZmxvYXQgaW5wdXRzOm1ldGFsbGljJyBdICk7CgoJCQkJCX0KCgkJCQkJaWYgKCAnZmxvYXQgaW5wdXRzOmNsZWFyY29hdC5jb25uZWN0JyBpbiBzdXJmYWNlICkgewoKCQkJCQkJY29uc3QgcGF0aCA9IHN1cmZhY2VbICdmbG9hdCBpbnB1dHM6Y2xlYXJjb2F0LmNvbm5lY3QnIF07CgkJCQkJCWNvbnN0IHNhbXBsZXIgPSBmaW5kVGV4dHVyZSggcm9vdCwgLyhcdyspLm91dHB1dC8uZXhlYyggcGF0aCApWyAxIF0gKTsKCgkJCQkJCW1hdGVyaWFsLmNsZWFyY29hdCA9IDEuMDsKCQkJCQkJbWF0ZXJpYWwuY2xlYXJjb2F0TWFwID0gYnVpbGRUZXh0dXJlKCBzYW1wbGVyICk7CgkJCQkJCW1hdGVyaWFsLmNsZWFyY29hdE1hcC5jb2xvclNwYWNlID0gTm9Db2xvclNwYWNlOwoKCQkJCQkJaWYgKCAnZGVmIFNoYWRlciAiVHJhbnNmb3JtMmRfY2xlYXJjb2F0IicgaW4gZGF0YSApIHsKCgkJCQkJCQlzZXRUZXh0dXJlUGFyYW1zKCBtYXRlcmlhbC5jbGVhcmNvYXRNYXAsIGRhdGFbICdkZWYgU2hhZGVyICJUcmFuc2Zvcm0yZF9jbGVhcmNvYXQiJyBdICk7CgoJCQkJCQl9CgoJCQkJCX0gZWxzZSBpZiAoICdmbG9hdCBpbnB1dHM6Y2xlYXJjb2F0JyBpbiBzdXJmYWNlICkgewoKCQkJCQkJbWF0ZXJpYWwuY2xlYXJjb2F0ID0gcGFyc2VGbG9hdCggc3VyZmFjZVsgJ2Zsb2F0IGlucHV0czpjbGVhcmNvYXQnIF0gKTsKCgkJCQkJfQoKCQkJCQlpZiAoICdmbG9hdCBpbnB1dHM6Y2xlYXJjb2F0Um91Z2huZXNzLmNvbm5lY3QnIGluIHN1cmZhY2UgKSB7CgoJCQkJCQljb25zdCBwYXRoID0gc3VyZmFjZVsgJ2Zsb2F0IGlucHV0czpjbGVhcmNvYXRSb3VnaG5lc3MuY29ubmVjdCcgXTsKCQkJCQkJY29uc3Qgc2FtcGxlciA9IGZpbmRUZXh0dXJlKCByb290LCAvKFx3Kykub3V0cHV0Ly5leGVjKCBwYXRoIClbIDEgXSApOwoKCQkJCQkJbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzID0gMS4wOwoJCQkJCQltYXRlcmlhbC5jbGVhcmNvYXRSb3VnaG5lc3NNYXAgPSBidWlsZFRleHR1cmUoIHNhbXBsZXIgKTsKCQkJCQkJbWF0ZXJpYWwuY2xlYXJjb2F0Um91Z2huZXNzTWFwLmNvbG9yU3BhY2UgPSBOb0NvbG9yU3BhY2U7CgoJCQkJCQlpZiAoICdkZWYgU2hhZGVyICJUcmFuc2Zvcm0yZF9jbGVhcmNvYXRSb3VnaG5lc3MiJyBpbiBkYXRhICkgewoKCQkJCQkJCXNldFRleHR1cmVQYXJhbXMoIG1hdGVyaWFsLmNsZWFyY29hdFJvdWdobmVzc01hcCwgZGF0YVsgJ2RlZiBTaGFkZXIgIlRyYW5zZm9ybTJkX2NsZWFyY29hdFJvdWdobmVzcyInIF0gKTsKCgkJCQkJCX0KCgkJCQkJfSBlbHNlIGlmICggJ2Zsb2F0IGlucHV0czpjbGVhcmNvYXRSb3VnaG5lc3MnIGluIHN1cmZhY2UgKSB7CgoJCQkJCQltYXRlcmlhbC5jbGVhcmNvYXRSb3VnaG5lc3MgPSBwYXJzZUZsb2F0KCBzdXJmYWNlWyAnZmxvYXQgaW5wdXRzOmNsZWFyY29hdFJvdWdobmVzcycgXSApOwoKCQkJCQl9CgoJCQkJCWlmICggJ2Zsb2F0IGlucHV0czppb3InIGluIHN1cmZhY2UgKSB7CgoJCQkJCQltYXRlcmlhbC5pb3IgPSBwYXJzZUZsb2F0KCBzdXJmYWNlWyAnZmxvYXQgaW5wdXRzOmlvcicgXSApOwoKCQkJCQl9CgoJCQkJCWlmICggJ2Zsb2F0IGlucHV0czpvY2NsdXNpb24uY29ubmVjdCcgaW4gc3VyZmFjZSApIHsKCgkJCQkJCWNvbnN0IHBhdGggPSBzdXJmYWNlWyAnZmxvYXQgaW5wdXRzOm9jY2x1c2lvbi5jb25uZWN0JyBdOwoJCQkJCQljb25zdCBzYW1wbGVyID0gZmluZFRleHR1cmUoIHJvb3QsIC8oXHcrKS5vdXRwdXQvLmV4ZWMoIHBhdGggKVsgMSBdICk7CgoJCQkJCQltYXRlcmlhbC5hb01hcCA9IGJ1aWxkVGV4dHVyZSggc2FtcGxlciApOwoJCQkJCQltYXRlcmlhbC5hb01hcC5jb2xvclNwYWNlID0gTm9Db2xvclNwYWNlOwoKCQkJCQkJaWYgKCAnZGVmIFNoYWRlciAiVHJhbnNmb3JtMmRfb2NjbHVzaW9uIicgaW4gZGF0YSApIHsKCgkJCQkJCQlzZXRUZXh0dXJlUGFyYW1zKCBtYXRlcmlhbC5hb01hcCwgZGF0YVsgJ2RlZiBTaGFkZXIgIlRyYW5zZm9ybTJkX29jY2x1c2lvbiInIF0gKTsKCgkJCQkJCX0KCgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoICdkZWYgU2hhZGVyICJkaWZmdXNlQ29sb3JfdGV4dHVyZSInIGluIGRhdGEgKSB7CgoJCQkJCWNvbnN0IHNhbXBsZXIgPSBkYXRhWyAnZGVmIFNoYWRlciAiZGlmZnVzZUNvbG9yX3RleHR1cmUiJyBdOwoKCQkJCQltYXRlcmlhbC5tYXAgPSBidWlsZFRleHR1cmUoIHNhbXBsZXIgKTsKCQkJCQltYXRlcmlhbC5tYXAuY29sb3JTcGFjZSA9IFNSR0JDb2xvclNwYWNlOwoKCQkJCX0KCgkJCQlpZiAoICdkZWYgU2hhZGVyICJub3JtYWxfdGV4dHVyZSInIGluIGRhdGEgKSB7CgoJCQkJCWNvbnN0IHNhbXBsZXIgPSBkYXRhWyAnZGVmIFNoYWRlciAibm9ybWFsX3RleHR1cmUiJyBdOwoKCQkJCQltYXRlcmlhbC5ub3JtYWxNYXAgPSBidWlsZFRleHR1cmUoIHNhbXBsZXIgKTsKCQkJCQltYXRlcmlhbC5ub3JtYWxNYXAuY29sb3JTcGFjZSA9IE5vQ29sb3JTcGFjZTsKCgkJCQl9CgoJCQl9CgoJCQlyZXR1cm4gbWF0ZXJpYWw7CgoJCX0KCgkJZnVuY3Rpb24gZmluZFRleHR1cmUoIGRhdGEsIGlkICkgewoKCQkJZm9yICggY29uc3QgbmFtZSBpbiBkYXRhICkgewoKCQkJCWNvbnN0IG9iamVjdCA9IGRhdGFbIG5hbWUgXTsKCgkJCQlpZiAoIG5hbWUuc3RhcnRzV2l0aCggYGRlZiBTaGFkZXIgIiR7IGlkIH0iYCApICkgewoKCQkJCQlyZXR1cm4gb2JqZWN0OwoKCQkJCX0KCgkJCQlpZiAoIHR5cGVvZiBvYmplY3QgPT09ICdvYmplY3QnICkgewoKCQkJCQljb25zdCB0ZXh0dXJlID0gZmluZFRleHR1cmUoIG9iamVjdCwgaWQgKTsKCgkJCQkJaWYgKCB0ZXh0dXJlICkgcmV0dXJuIHRleHR1cmU7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCWZ1bmN0aW9uIGJ1aWxkVGV4dHVyZSggZGF0YSApIHsKCgkJCWlmICggJ2Fzc2V0IGlucHV0czpmaWxlJyBpbiBkYXRhICkgewoKCQkJCWNvbnN0IHBhdGggPSBkYXRhWyAnYXNzZXQgaW5wdXRzOmZpbGUnIF0ucmVwbGFjZSggL0AqL2csICcnICk7CgoJCQkJY29uc3QgbG9hZGVyID0gbmV3IFRleHR1cmVMb2FkZXIoKTsKCgkJCQljb25zdCB0ZXh0dXJlID0gbG9hZGVyLmxvYWQoIGFzc2V0c1sgcGF0aCBdICk7CgoJCQkJY29uc3QgbWFwID0gewoJCQkJCSciY2xhbXAiJzogQ2xhbXBUb0VkZ2VXcmFwcGluZywKCQkJCQknIm1pcnJvciInOiBNaXJyb3JlZFJlcGVhdFdyYXBwaW5nLAoJCQkJCScicmVwZWF0Iic6IFJlcGVhdFdyYXBwaW5nCgkJCQl9OwoKCQkJCWlmICggJ3Rva2VuIGlucHV0czp3cmFwUycgaW4gZGF0YSApIHsKCgkJCQkJdGV4dHVyZS53cmFwUyA9IG1hcFsgZGF0YVsgJ3Rva2VuIGlucHV0czp3cmFwUycgXSBdOwoKCQkJCX0KCgkJCQlpZiAoICd0b2tlbiBpbnB1dHM6d3JhcFQnIGluIGRhdGEgKSB7CgoJCQkJCXRleHR1cmUud3JhcFQgPSBtYXBbIGRhdGFbICd0b2tlbiBpbnB1dHM6d3JhcFQnIF0gXTsKCgkJCQl9CgoJCQkJcmV0dXJuIHRleHR1cmU7CgoJCQl9CgoJCQlyZXR1cm4gbnVsbDsKCgkJfQoKCQlmdW5jdGlvbiBidWlsZE9iamVjdCggZGF0YSApIHsKCgkJCWNvbnN0IGdlb21ldHJ5ID0gYnVpbGRHZW9tZXRyeSggZmluZE1lc2hHZW9tZXRyeSggZGF0YSApICk7CgkJCWNvbnN0IG1hdGVyaWFsID0gYnVpbGRNYXRlcmlhbCggZmluZE1lc2hNYXRlcmlhbCggZGF0YSApICk7CgoJCQljb25zdCBtZXNoID0gZ2VvbWV0cnkgPyBuZXcgTWVzaCggZ2VvbWV0cnksIG1hdGVyaWFsICkgOiBuZXcgT2JqZWN0M0QoKTsKCgkJCWlmICggJ21hdHJpeDRkIHhmb3JtT3A6dHJhbnNmb3JtJyBpbiBkYXRhICkgewoKCQkJCWNvbnN0IGFycmF5ID0gSlNPTi5wYXJzZSggJ1snICsgZGF0YVsgJ21hdHJpeDRkIHhmb3JtT3A6dHJhbnNmb3JtJyBdLnJlcGxhY2UoIC9bKCldKi9nLCAnJyApICsgJ10nICk7CgoJCQkJbWVzaC5tYXRyaXguZnJvbUFycmF5KCBhcnJheSApOwoJCQkJbWVzaC5tYXRyaXguZGVjb21wb3NlKCBtZXNoLnBvc2l0aW9uLCBtZXNoLnF1YXRlcm5pb24sIG1lc2guc2NhbGUgKTsKCgkJCX0KCgkJCXJldHVybiBtZXNoOwoKCQl9CgoJCWZ1bmN0aW9uIGJ1aWxkSGllcmFyY2h5KCBkYXRhLCBncm91cCApIHsKCgkJCWZvciAoIGNvbnN0IG5hbWUgaW4gZGF0YSApIHsKCgkJCQlpZiAoIG5hbWUuc3RhcnRzV2l0aCggJ2RlZiBTY29wZScgKSApIHsKCgkJCQkJYnVpbGRIaWVyYXJjaHkoIGRhdGFbIG5hbWUgXSwgZ3JvdXAgKTsKCgkJCQl9IGVsc2UgaWYgKCBuYW1lLnN0YXJ0c1dpdGgoICdkZWYgWGZvcm0nICkgKSB7CgoJCQkJCWNvbnN0IG1lc2ggPSBidWlsZE9iamVjdCggZGF0YVsgbmFtZSBdICk7CgoJCQkJCWlmICggL2RlZiBYZm9ybSAiKFx3KykiLy50ZXN0KCBuYW1lICkgKSB7CgoJCQkJCQltZXNoLm5hbWUgPSAvZGVmIFhmb3JtICIoXHcrKSIvLmV4ZWMoIG5hbWUgKVsgMSBdOwoKCQkJCQl9CgoJCQkJCWdyb3VwLmFkZCggbWVzaCApOwoKCQkJCQlidWlsZEhpZXJhcmNoeSggZGF0YVsgbmFtZSBdLCBtZXNoICk7CgoJCQkJfQoKCQkJfQoKCQl9CgoJCWNvbnN0IGdyb3VwID0gbmV3IEdyb3VwKCk7CgoJCWJ1aWxkSGllcmFyY2h5KCByb290LCBncm91cCApOwoKCQlyZXR1cm4gZ3JvdXA7CgoJfQoKfQoKZXhwb3J0IHsgVVNEWkxvYWRlciB9Owo="
    // 可选：USDZLoader.js 的 base64
    };

    /* ----------------- 设备检测（动态） ----------------- */
    const ua = navigator.userAgent || navigator.vendor || window.opera || '';
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const isMac = /Macintosh/i.test(ua);
    const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
    const isAppleDevice = isIOS || (isMac && isSafari);

    /* ----------------- 全局状态 ----------------- */
    let scanTimer = null;
    let foundUSDZUrls = [];
    let threeJsLoaded = false;
    let threeJsLoading = false;

    /* ----------------- 样式定义（中文界面） ----------------- */
    const STYLES = `
        #${CONFIG.PANEL_ID} {
            position: fixed;
            right: 18px;
            bottom: 18px;
            width: 360px;
            max-height: 60vh;
            background: rgba(20,20,20,0.94);
            color: #fff;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            z-index: ${CONFIG.Z_INDEX};
            overflow: hidden;
        }

        #${CONFIG.PANEL_ID} header {
            padding: 10px 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(30,30,30,0.9);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #${CONFIG.PANEL_ID} header .count {
            background: #ff3b30;
            color: #fff;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        #${CONFIG.PANEL_ID} .list {
            overflow: auto;
            max-height: calc(60vh - 92px);
            padding: 8px 10px;
        }

        #${CONFIG.PANEL_ID} .item {
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            display: flex;
            gap: 8px;
            align-items: flex-start;
            transition: background 0.2s;
        }

        #${CONFIG.PANEL_ID} .item:hover {
            background: rgba(255,255,255,0.06);
        }

        #${CONFIG.PANEL_ID} .item .meta {
            flex: 1;
            font-size: 12px;
            word-break: break-all;
            color: #ddd;
        }

        #${CONFIG.PANEL_ID} .item .btns {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #${CONFIG.PANEL_ID} button {
            background: rgba(255,255,255,0.06);
            color: #fff;
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        #${CONFIG.PANEL_ID} button:hover {
            background: rgba(255,255,255,0.1);
        }

        #${CONFIG.PANEL_ID} button.download-btn {
            background: #34c759;
        }

        #${CONFIG.PANEL_ID} button.download-btn:hover {
            background: #28a745;
        }

        #${CONFIG.PANEL_ID} button.preview-btn {
            background: #0071e3;
        }

        #${CONFIG.PANEL_ID} button.preview-btn:hover {
            background: #0066cc;
        }

        #${CONFIG.PANEL_ID} .footer {
            padding: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 12px;
            color: #aaa;
            background: rgba(30,30,30,0.9);
        }

        #${CONFIG.PANEL_ID} .close {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255,255,255,0.06);
            padding: 4px 6px;
            border-radius: 6px;
        }

        /* 模态框样式 */
        #${CONFIG.MODAL_ID} {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.75);
            z-index: ${CONFIG.Z_INDEX + 1};
        }

        #${CONFIG.MODAL_ID} .inner {
            width: min(1100px, 92%);
            height: min(720px, 92%);
            background: #111;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
        }

        #${CONFIG.MODAL_ID} .inner .head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            color: #fff;
            margin-bottom: 8px;
        }

        #${CONFIG.MODAL_ID} .preview-container {
            flex: 1;
            background: #000;
            border-radius: 6px;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        #${CONFIG.MODAL_ID} .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10;
        }

        #${CONFIG.MODAL_ID} .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top: 5px solid #0071e3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #${CONFIG.MODAL_ID} .error-message {
            color: #ff3b30;
            padding: 20px;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            border-radius: 8px;
            max-width: 80%;
            z-index: 10;
        }

        /* 通知样式 */
        .usdz-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background: #34c759;
            color: white;
            border-radius: 6px;
            font-size: 13px;
            z-index: 2147483647;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.3s;
        }

        .usdz-notification.error {
            background: #ff3b30;
        }

        .usdz-notification.warning {
            background: #ffc107;
            color: #333;
        }
    `;

    /* ----------------- 初始化样式 ----------------- */
    function initStyles() {
        GM_addStyle(STYLES);
    }

    /* ----------------- Three.js 加载（**强制 Base64 内联**） ----------------- */
    function loadThreeJsLibraries() {
        return new Promise((resolve, reject) => {
            try {
                if (threeJsLoaded) {
                    resolve();
                    return;
                }

                if (threeJsLoading) {
                    const checkLoaded = () => {
                        if (threeJsLoaded) {
                            resolve();
                        } else if (!threeJsLoading) {
                            reject(new Error('Three.js 加载已取消'));
                        } else {
                            setTimeout(checkLoaded, 100);
                        }
                    };
                    checkLoaded();
                    return;
                }

                threeJsLoading = true;

                // >>>>> 修改后的核心逻辑：只尝试内联 Base64，移除 CDN 逻辑 <<<<<
                if (CONFIG.INLINE_THREE_BASE64 && CONFIG.INLINE_ORBIT_BASE64 && CONFIG.INLINE_USDZ_BASE64) {
                    try {
                        // 注入 three
                        const threeCode = atob(CONFIG.INLINE_THREE_BASE64);
                        new Function(threeCode)();
                        
                        // 注入 orbit
                        const orbitCode = atob(CONFIG.INLINE_ORBIT_BASE64);
                        new Function(orbitCode)();
                        
                        // 注入 usdz loader
                        const usdzCode = atob(CONFIG.INLINE_USDZ_BASE64);
                        new Function(usdzCode)();

                        // 兼容挂载（确保 THREE 对象存在，尤其是针对 module.js）
                        if (window.OrbitControls && window.THREE && !window.THREE.OrbitControls) {
                            window.THREE.OrbitControls = window.OrbitControls;
                        }
                        if (window.USDZLoader && window.THREE && !window.THREE.USDZLoader) {
                            window.THREE.USDZLoader = window.USDZLoader;
                        }

                        // set flags
                        threeJsLoaded = true;
                        threeJsLoading = false;
                        console.log('Three.js（内联）加载完成');
                        resolve();
                        return;
                    } catch (e) {
                        // 如果 Base64 加载失败，直接报错，不再尝试 CDN
                        threeJsLoading = false;
                        console.error('Three.js 内联加载失败：', e);
                        reject(new Error('Three.js 内联加载失败。请检查 Base64 内容是否完整或格式正确。'));
                        return;
                    }
                }

                // 如果未提供 Base64，直接报错，因为 CDN 必然被 CSP 阻止
                threeJsLoading = false;
                console.error('Base64 配置缺失：无法加载 Three.js');
                reject(new Error('预览模块需要 Base64 内容，但配置项为空。请在 CONFIG 中填入 Base64 内容。'));

            } catch (error) {
                threeJsLoading = false;
                reject(error);
            }
        });
    }

    /* ----------------- 创建面板（中文 UI） ----------------- */
    function createPanel() {
        if (document.getElementById(CONFIG.PANEL_ID)) return;

        const panel = document.createElement('div');
        panel.id = CONFIG.PANEL_ID;
        panel.innerHTML = `
            <header>
                <div>USDZ 文件助手</div>
                <div class="count" id="${CONFIG.PANEL_ID}-count">0</div>
            </header>
            <div class="list" id="${CONFIG.PANEL_ID}-list">
                <div style="color:#888; font-size:13px;">正在扫描页面 <code>.usdz</code> …</div>
            </div>
            <div class="footer">
                <div style="display:flex; gap:8px;">
                    <button id="${CONFIG.PANEL_ID}-refresh">重新扫描</button>
                    <button id="${CONFIG.PANEL_ID}-copy">复制全部链接</button>
                </div>
                <button class="close" id="${CONFIG.PANEL_ID}-close">隐藏</button>
            </div>
        `;

        document.body.appendChild(panel);

        // 绑定事件
        document.getElementById(`${CONFIG.PANEL_ID}-close`).addEventListener('click', () => {
            panel.style.display = 'none';
        });

        document.getElementById(`${CONFIG.PANEL_ID}-refresh`).addEventListener('click', () => {
            scanAndRender(true);
        });

        document.getElementById(`${CONFIG.PANEL_ID}-copy`).addEventListener('click', copyAllUrls);
    }

    /* ----------------- 扫描 USDZ 文件 ----------------- */
    function scanForUsdz() {
        const found = new Set();

        // 1) 检查元素属性
        const attrSelectors = [
            'a[href]', 'link[href]', 'source[src]', 'img[src]',
            'video[src]', 'meta[content]', 'script[src]',
            'iframe[src]', '*[data-src]', '*[data-url]'
        ];

        attrSelectors.forEach(selector => {
            document.querySelectorAll(selector).forEach(element => {
                const attributes = ['href', 'src', 'content', 'data-src', 'data-url'];
                attributes.forEach(attr => {
                    if (!element.hasAttribute(attr)) return;

                    const value = element.getAttribute(attr);
                    if (!value) return;

                    // 匹配 USDZ URL（绝对或相对）
                    const usdzMatch = value.match(/https?:\/\/[^'"]+?\.usdz(\?[^'"]*)?/i) ||
                                         value.match(/\/[^'"]+?\.usdz(\?[^'"]*)?/i);

                    if (usdzMatch) {
                        try {
                            const url = new URL(usdzMatch[0], window.location.href).toString();
                            found.add(url);
                        } catch (e) {
                            found.add(usdzMatch[0]);
                        }
                    }
                });
            });
        });

        // 2) 检查脚本内容和页面 HTML
        document.querySelectorAll('script').forEach(script => {
            const text = script.innerText || script.textContent || '';
            if (!text) return;

            const fullUrlRegex = /https?:\/\/[^"'\\\s>]+?\.usdz(\?[^"'\\\s>]*)?/ig;
            let match;
            while ((match = fullUrlRegex.exec(text)) !== null) {
                found.add(match[0]);
            }

            const relativeUrlRegex = /\/[^"'\\\s>]+?\.usdz(\?[^"'\\\s>]*)?/ig;
            while ((match = relativeUrlRegex.exec(text)) !== null) {
                try {
                    found.add(new URL(match[0], window.location.href).toString());
                } catch (e) {
                    found.add(match[0]);
                }
            }
        });

        // 3) 最终检查整个 HTML
        try {
            const html = document.documentElement.innerHTML;
            const regex = /https?:\/\/[^"'\\\s>]+?\.usdz(\?[^"'\\\s>]*)?/ig;
            let match;
            while ((match = regex.exec(html)) !== null) {
                found.add(match[0]);
            }
        } catch (e) {
            console.warn('Failed to scan HTML:', e);
        }

        foundUSDZUrls = Array.from(found);
        return foundUSDZUrls;
    }

    /* ----------------- 渲染列表（中文） ----------------- */
    function renderList(urls) {
        createPanel();

        const listEl = document.getElementById(`${CONFIG.PANEL_ID}-list`);
        const countEl = document.getElementById(`${CONFIG.PANEL_ID}-count`);

        listEl.innerHTML = '';
        countEl.textContent = urls.length;

        if (urls.length === 0) {
            listEl.innerHTML = `
                <div style="color:#888; font-size:13px;">
                    在此页面未检测到 .usdz 文件（尝试点击“重新扫描”）。
                    若页面通过 JS 动态加载，请先滚动或展开相关模块后再重新扫描。
                </div>
            `;
            return;
        }

        urls.forEach((url, index) => {
            const item = document.createElement('div');
            item.className = 'item';

            const fileName = url.split('/').pop().split('?')[0] || `model-${index + 1}.usdz`;

            // 按钮显示策略：根据设备动态决定
            const showQuickLook = isAppleDevice; // 仅在 Apple 设备上显示 Quick Look
            const showOpenRaw = isAppleDevice; // Open raw/AR 链接仅在支持的平台显示

            item.innerHTML = `
                <div class="meta">
                    <div style="font-weight:700; color:#fff; margin-bottom:6px;">${fileName}</div>
                    <div class="url">${url}</div>
                </div>
                <div class="btns">
                    <button class="btn-download">下载</button>
                    <button class="btn-open">打开</button>
                    ${ showQuickLook ? '<button class="btn-quick">Quick Look（仅 iOS）</button>' : '' }
                    <button class="btn-preview">预览模型</button>
                </div>
            `;

            listEl.appendChild(item);

            // 绑定下载按钮
            item.querySelector('.btn-download').addEventListener('click', () => {
                downloadUSDZ(url, fileName);
            });

            // 绑定打开按钮
            item.querySelector('.btn-open').addEventListener('click', () => {
                window.open(url, '_blank');
            });

            // 绑定 Quick Look（仅当按钮存在并且设备支持）
            const quickBtn = item.querySelector('.btn-quick');
            if (quickBtn) {
                quickBtn.addEventListener('click', () => {
                    openQuickLook(url);
                });
            }

            // 绑定预览按钮
            item.querySelector('.btn-preview').addEventListener('click', async () => {
                try {
                    await loadThreeJsLibraries();
                    openPreviewModal(url, fileName);
                } catch (error) {
                    console.error('预览失败:', error);
                    showNotification(`预览失败: ${error.message || 'Three.js 库加载失败'}`, 'error');
                }
            });
        });
    }

    /* ----------------- 模态框预览（中文 UI） ----------------- */
    function createModal() {
        let modal = document.getElementById(CONFIG.MODAL_ID);
        if (modal) return modal;

        modal = document.createElement('div');
        modal.id = CONFIG.MODAL_ID;
        modal.innerHTML = `
            <div class="inner">
                <div class="head">
                    <div class="title">USDZ 预览</div>
                    <div style="display:flex; gap:8px;">
                        <a id="usdz-openraw" target="_blank" style="color:#0071e3; cursor:pointer;">打开原始文件</a>
                        <button id="usdz-close" style="background:#ff3b30; border:none; color:#fff; padding:6px 12px; border-radius:6px; cursor:pointer;">关闭</button>
                    </div>
                </div>
                <div class="preview-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>正在加载模型…</div>
                    </div>
                    <div id="threejs-container" style="width:100%; height:100%;"></div>
                </div>
                <div class="note" style="color:#ccc; font-size:12px; margin-top:8px;">
                    拖动以旋转 • 滚动以缩放 • 右键拖动以平移
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // 绑定事件
        modal.querySelector('#usdz-close').addEventListener('click', () => {
            modal.style.display = 'none';
            cleanupThreeJs();
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
                cleanupThreeJs();
            }
        });

        return modal;
    }

    function showLoading(modal) {
        const loading = modal.querySelector('.loading');
        if (loading) {
            loading.style.display = 'flex';
        }
    }

    function hideLoading(modal) {
        const loading = modal.querySelector('.loading');
        if (loading) {
            loading.style.display = 'none';
        }
    }

    function showError(modal, message) {
        hideLoading(modal);

        let errorElement = modal.querySelector('.error-message');
        if (!errorElement) {
            errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            modal.querySelector('.preview-container').appendChild(errorElement);
        }

        errorElement.innerHTML = `
            <h3>预览错误</h3>
            <p>${message}</p>
            <p style="margin-top: 10px; font-size: 12px; color: #888;">
                建议：尝试下载文件或在新标签页打开
            </p>
        `;
    }

    let threeJsScene = null;
    let threeJsRenderer = null;

    function cleanupThreeJs() {
        if (threeJsRenderer) {
            try {
                // 清理渲染器
                threeJsRenderer.dispose && threeJsRenderer.dispose();
            } catch (e) { /* ignore */ }
            threeJsRenderer = null;
        }
        threeJsScene = null;

        // 清理 THREE 库的全局变量（可选，但安全）
        if (window.THREE) {
             // 仅在确认不再使用时清理。如果 three.module.js 注入的是 module 作用域，清理可能无效
             // 但对于大多数简单的 base64 注入，清理是可行的。
             // window.THREE = undefined; // 暂时不执行此操作，避免影响其他可能的脚本
        }
    }

    function openPreviewModal(usdzUrl, fileName) {
        const modal = createModal();
        modal.style.display = 'flex';

        const container = modal.querySelector('#threejs-container');
        const openRawLink = modal.querySelector('#usdz-openraw');

        openRawLink.href = usdzUrl;
        modal.querySelector('.title').textContent = `预览：${fileName}`;

        showLoading(modal);

        const errorElement = modal.querySelector('.error-message');
        if (errorElement) {
            errorElement.remove();
        }

        cleanupThreeJs();

        try {
            // 运行时检查 THREE 库
            if (!window.THREE || !window.THREE.USDZLoader || !window.THREE.OrbitControls) {
                // 如果 base64 注入成功，此时应该存在
                throw new Error('Three.js 或其依赖项（OrbitControls/USDZLoader）未正确加载');
            }

            const scene = new THREE.Scene();
            threeJsScene = scene;

            const width = container.clientWidth;
            const height = container.clientHeight;
            const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(0.5, 0.5, 1.5);

            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio || 1);
            renderer.setClearColor(0x000000);

            container.innerHTML = '';
            container.appendChild(renderer.domElement);
            threeJsRenderer = renderer;

            // 光源
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);

            // 辅助
            try {
                const gridHelper = new THREE.GridHelper(2, 20, 0x444444, 0x222222);
                scene.add(gridHelper);
            } catch (e) { /* ignore */ }

            try {
                const axesHelper = new THREE.AxesHelper(0.5);
                scene.add(axesHelper);
            } catch (e) { /* ignore */ }

            // 控制器
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.target.set(0,0,0);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = true;
            controls.enablePan = true;
            controls.update();

            const onWindowResize = () => {
                const w = container.clientWidth;
                const h = container.clientHeight;
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                renderer.setSize(w, h);
            };
            window.addEventListener('resize', onWindowResize);

            // USDZ 加载
            const loader = new THREE.USDZLoader();
            loader.load(usdzUrl, (object) => {
                scene.add(object);
                // 居中
                const box = new THREE.Box3().setFromObject(object);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3()).length();
                object.position.sub(center);
                const distance = size * 1.5;
                camera.position.set(distance, distance * 0.8, distance);
                controls.target.set(0,0,0);
                controls.update();

                hideLoading(modal);

                const animate = () => {
                    if (!threeJsScene) return;
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                };
                animate();
            }, undefined, (err) => {
                console.error('加载 USDZ 失败：', err);
                showError(modal, '加载 3D 模型失败，请检查文件是否完整');
            });

        } catch (err) {
            console.error('初始化 Three.js 失败：', err);
            showError(modal, `初始化 3D 预览失败: ${err.message}`);
        }
    }

    /* ----------------- 辅助函数（下载 / Quick Look / 复制） ----------------- */
    function downloadUSDZ(url, fileName) {
        try {
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName || 'model.usdz';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification(`正在下载 ${fileName}`);
        } catch (e) {
            console.error('下载失败:', e);
            showNotification('下载失败', 'error');
        }
    }

    function openQuickLook(url) {
        try {
            // Quick Look / AR 链接仅在 iOS Safari 支持
            const link = document.createElement('a');
            link.rel = 'ar';
            link.href = url;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            setTimeout(() => document.body.removeChild(link), 1000);
            showNotification('正在打开 Quick Look（仅 iOS 支持）');
        } catch (e) {
            console.error('Quick Look 失败：', e);
            showNotification('Quick Look 仅在 iOS Safari 上支持', 'error');
        }
    }

    function copyAllUrls() {
        if (foundUSDZUrls.length === 0) {
            showNotification('未找到 USDZ 文件', 'error');
            return;
        }
        const text = foundUSDZUrls.join('\n');
        navigator.clipboard.writeText(text).then(() => {
            showNotification(`已复制 ${foundUSDZUrls.length} 个 USDZ 链接到剪贴板`);
        }).catch(() => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showNotification(`已复制 ${foundUSDZUrls.length} 个 USDZ 链接到剪贴板`);
        });
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `usdz-notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                try { document.body.removeChild(notification); } catch(e) {}
            }, 300);
        }, 3000);
    }

    /* ----------------- 主函数 ----------------- */
    function scanAndRender(showNote = false) {
        const urls = scanForUsdz();
        renderList(urls);
        if (showNote) {
            showNotification(`找到 ${urls.length} 个 USDZ 文件`);
        }
        console.log('USDZ Finder: 找到', urls.length, '个文件', urls);
    }

    /* ----------------- 初始化 ----------------- */
    async function init() {
        initStyles();
        createPanel();

        setTimeout(() => scanAndRender(), CONFIG.SCAN_DELAY);

        const observer = new MutationObserver(() => {
            if (scanTimer) clearTimeout(scanTimer);
            scanTimer = setTimeout(() => scanAndRender(), 1000);
        });
        observer.observe(document.body, { childList: true, subtree: true });

        GM_registerMenuCommand('显示 USDZ 工具', () => {
            const panel = document.getElementById(CONFIG.PANEL_ID);
            if (panel) {
                panel.style.display = 'block';
            } else {
                createPanel();
                scanAndRender(true);
            }
        });

        console.log('USDZ Finder（混合版）加载成功');
    }

    init();

})();