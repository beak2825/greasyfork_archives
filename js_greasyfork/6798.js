// ==UserScript==
// @name        TLS Def Package
// @version     0.1
// @author      Unfriendly Sander
// @namespace   none
// @description none
// @grant       none
// @include     http://nl*.tribalwars.nl*
// @downloadURL https://update.greasyfork.org/scripts/6798/TLS%20Def%20Package.user.js
// @updateURL https://update.greasyfork.org/scripts/6798/TLS%20Def%20Package.meta.js
// ==/UserScript==
$(document).ready(function(){scriptPage()});var scriptPage=function(){var e=game_data.mode;var t=game_data.screen;var n=function(){var e=$('<a href="#" class="btn" id="stopTimer">Stop Timers</a>'+'<a href="#" class="btn" id="groupCom">Groepeer</a>');var t=$("#incomings_table").find('img[src*="attack.png"]').closest("tr");$("#incomings_table").find("tbody").find("tr").first().find("th").first().append(e);$("#stopTimer").on("click",stopTimers);$("#groupCom").on("click",groupIncomings);commandsColoring(t)};var r=function(){var e=$("#show_incoming_units");if(e.length>0){var t=incomingsCounter(e),n={"margin-left":"10%",color:"red"};var r=$("<strong>"+t+" Aanvallen</strong>").css(n);e.find("h4").first().append(r);renameHotkeys();var i=e.find('img[src*="attack.png"]').closest("tr");commandsColoring(i)}};if(game_data.player.ally==="33842"){switch(t){case"overview_villages":n();break;case"overview":r();break}}};var colorScheme={OK:"#008000",DODGED:"#C0BD0B","ONTWIJK;":"#F1880F",GEVRAAGD:"#FFBF00"};var stopTimers=function(e){e.stopPropagation();e.preventDefault();var t=$("#incomings_table").find("tbody").find("tr");for(var n=1,r=t.length-1;n<r;n++){var i=t.eq(n).find("td").last();i.html(i.find("span").text())}$("#stopTimer").off("click")};var color=function(e){$(".marked").addClass("defaultColor");for(var t in colorScheme){e.find("span.quickedit:contains("+t+")").parent().find(".defaultColor, .marked").removeClass("defaultColor").addClass("marked").css("background-color",colorScheme[t])}$(".defaultColor").css("background-color","red")};var commandsColoring=function(e){var t={display:"inline-block",border:"solid black 1px",width:"10px",height:"10px"};for(var n=0,r=e.length;n<r;n++){$('<span class="defaultColor"></span>').css(t).insertAfter(e.eq(n).find("td").first().find("input").last())}color(e)};var calculateDefTroops=function(e){if(typeof e=="object"){return amountOfDef}else{return"Error"}};var renameCommand=function(e,t){var n=game_data.link_base_pure+"info_command&ajaxaction=edit_other_comment&id="+t+"&h="+game_data.csrf;$.ajax({url:n,type:"POST",data:{text:e},success:function(){$('span[data-id="'+t+'"]').find("span.quickedit-label").text(e)}})};var incomingsCounter=function(e){return e.find('img[src*="attack.png"]').closest("tr").length};var incomingsRenamer=function(e,t){var n=t.find('img[src*="attack.png"]').closest("tr"),r={},i=0;for(i,amountOfRows=n.length-1;i<amountOfRows;i++){var s=n.eq(i).find("td").first();r[s.find("span.quickedit").data("id")]=s.find("span.quickedit-label").text()}var o=n.eq(i).find("td").first();if(o.find("span.quickedit-label").text().contains("LAATSTE;")){r[o.find("span.quickedit").data("id")]=o.find("span.quickedit-label").text()}else{r[o.find("span.quickedit").data("id")]=o.find("span.quickedit-label").text()+" LAATSTE;"}var u=/OK|DODGED|ONTWIJK;|MARKEREN;|GEVRAAGD;/;for(var a in r){if(r[a].match(u).length>0){r[a]=r[a].replace(u,e)}else{r[a]=e+" "+r[a]}renameCommand(r[a],a)}};var groupIncomings=function(e){e.stopPropagation();e.preventDefault()};var addHotkeyPlugin=function(){(function(e){function t(t){if(typeof t.data!=="string"){return}var n=t.handler,r=t.data.toLowerCase().split(" ");t.handler=function(t){if(this!==t.target&&(/textarea|select/i.test(t.target.nodeName)||t.target.type==="text")){return}var i=t.type!=="keypress"&&e.hotkeys.specialKeys[t.which],s=String.fromCharCode(t.which).toLowerCase(),o,u="",a={};if(t.altKey&&i!=="alt"){u+="alt+"}if(t.ctrlKey&&i!=="ctrl"){u+="ctrl+"}if(t.metaKey&&!t.ctrlKey&&i!=="meta"){u+="meta+"}if(t.shiftKey&&i!=="shift"){u+="shift+"}if(i){a[u+i]=true}else{a[u+s]=true;a[u+e.hotkeys.shiftNums[s]]=true;if(u==="shift+"){a[e.hotkeys.shiftNums[s]]=true}}for(var f=0,l=r.length;f<l;f++){if(a[r[f]]){return n.apply(this,arguments)}}}}e.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}};e.each(["keydown","keyup","keypress"],function(){e.event.special[this]={add:t}})})(jQuery)};var shortcutGenerator=function(e,t){return function(){incomingsRenamer(e,t);$(document).ajaxComplete(function(){var e=t.find('img[src*="attack.png"]').closest("tr");color(e)});return false}};var renameHotkeys=function(){addHotkeyPlugin;var e={s:"OK",d:"DODGED",r:"MARKEREN;",g:"GEVRAAGD;",e:"ONTWIJK;"},t=$("#show_incoming_units");for(var n in e){$(document).bind("keydown",n,shortcutGenerator(e[n],t))}}