// ==UserScript==
// @name         CRG Tools Suite
// @namespace    http://lamansion-crg.net
// @version      0.0.4
// @description  Marcadores, listas, backups y personalizaci√≥n para La Mansi√≥n CRG
// @author       Pinocchio
// @match        *://*lamansion-crg.net/*
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        GM_registerMenuCommand
// @grant        GM_setClipboard
// @require      https://cdn.jsdelivr.net/npm/winbox@0.2.82/dist/winbox.bundle.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js
// @license      MIT
// @downloadURL https://update.greasyfork.org/scripts/562272/CRG%20Tools%20Suite.user.js
// @updateURL https://update.greasyfork.org/scripts/562272/CRG%20Tools%20Suite.meta.js
// ==/UserScript==
!function(t){"use strict";if(window.self!==window.top)return;const e=t.createInstance({name:"CRG_Comicteca_DB",storeName:"markers"}),n=t.createInstance({name:"CRG_Comicteca_DB",storeName:"subforums"}),o=t.createInstance({name:"CRG_Comicteca_DB",storeName:"topics"});async function r(){const t={};return await e.iterate((e,n)=>{t[n]=e}),t}var a=Object.freeze({__proto__:null,getAllMarkers:r,markersDB:e,subforumsDB:n,topicsDB:o});const i={default:{0:"üóí",1:"‚úÖ",2:"‚òëÔ∏è",3:"‚õîÔ∏è",4:"üíô"},minimal:{0:"‚óã",1:"‚úì",2:"‚ñ†",3:"‚úó",4:"‚ô•"},circles:{0:"‚óØ",1:"üü¢",2:"üîµ",3:"üî¥",4:"üü£"}},s='<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEc0lEQVR4nNWZW4hVVRjHf9NlyHKsULqhaWQZUYgMZKQPMcykUvQShZAv9hDdILpg0ktED1FWRleNCInIsEmJCosKooLMLjTd7zQ6EeLo5EyGY9qOD/4bFqu911p7e86ZOX/4GGafdfvv9d03tB8uAd4HhoFtwNW0IaYBu4HMk9toM9xXQCLT7bQNTgXGSoj8SRvh8RISJhtoE8wBDgSI9NImeCFA4nfgaNoAFwKHA0TWuINnAf3AqGQzMI/JgdcCJEzmuyT2FAywZzMnlgOLIyS+dAf3BwZuYmLxQYTIKnfwaGDgPm/hy4EhYCewrMkkroiQOOxrTIiIH2h2Or/taCKJo4CBCJF3/UmbA4P7J4jIiggJk5X+pHkBYz/HG7tMZIzE0iaR6AR+jZD4Wwnk/zBThr1P0l9AolU4G9geIbKRSYQuoAdYLsM+0/t9EfAycKiAiDmdCcdxisajJXHhduBEL896WI7HxuwCjq2zsS20XrZxUH/X6XmdW/gkwZDHgCeAc725twKr65C4LOCe7XlfxfVWJZDIvFjxhs7RQU2cFYkxecCcXWHNE4DPKpLJJAOyp8qE1idu8HSFvMkwHXgxktFmAbHGwylViLjBLySDCWv1qDAy75RjqlRzbw0y35fFkSKMJy5qB4xhg8aaK10LnOH8thD4ogaZZ1OJ7Ehc8LeEtRYVxINPHfvqEKFrgfsT9z2oEiSKdYkLPhVYY5bz9u8E/vXmjgB3e2rSIRtK2fv6FCJzEr2WH5FzTFHMeEf5k+FiueA7vBvfD7wJ3OzMt+j9gF7ADyX7P0gi+nTYMhJlcaTTK1HfLqg2lxfcUAY8AhxfULcPF4y9hwqYLRc7KAcwKHUquwnzRq+XOIWN6hbmB12iMmK7bCaTDEu173KS1y6l949K9TY1sw10XkJBZLIVmOHNNdv4sGDskNSsdmSvgil6e/sruM/d0vElSt0NpwNbgH8Kxn+rbuNNwDXApY0k0CnPMVQjDrgyrnwqx0nKALpLir5Khh6qpxfq7RS1+OuKxZnHgAu8/ebrlvyWqXnAJEzTG+mVkd0rIx5p4OHLZAT4Gljg1TFzdabuKjbzcwsOHJO/gIfkRGrjlQYcZFy32VtSslaRvQqwbwEnVyFivv6jIyRxpfORJvRZoIpsqXMr5jm+q7HZmEPCPNDnDVS3xdSERfBfKmw04Oj0DH15DY3/GDhfkTqLiK11RDgtoUTdo6Bo3gWR+THBO+VNDEsQY0TcWFMbXUr+/I7fe8CNTgvH4swN8jihQ1nCeJXmLEiwoa00EMeoRdOttML+d9GX0CXMZbUTr2J2eKggUDYUpkYX6VBfVbCjNc7txb5IZY1IR0KYGvlIWaZO+ccZ+4D5fMKcbxy7ayp6tFnsQLucLoq1PF9KmHNAatwy2MFuUSOiSL+fcXpR00sKryK5rpUkfEIr1Iz+Sbqd1xr57aWm/GuZhJgre0rtLj7XqoqwKpaqfinrhrjypLzZpIelPBYIrQnxqvKwP9SVsTK2Fv4D4+uprmViiM0AAAAASUVORK5CYII=" alt="Limpiar atajo" style="width: 16px; height: 16px;">',c=i.default,l={saturation:97,lightness:87,hueOffset:0,borderWidth:1,borderRadius:4,fontWeight:400,fontStyle:"normal",boxShadow:1,forceBlackText:!1,useFlatColors:!1,flatBackgroundColor:"#ffffff",flatTextColor:"#000000",commentDotColor:"#000000",starColors:{empty:[0,0,0],half:[30,70,50],full:[0,70,50],perfect:[211,70,50]},iconSet:c,keyboardShortcuts:{backup:{ctrl:!0,shift:!1,alt:!0,key:"B"},merge:{ctrl:!0,shift:!1,alt:!0,key:"M"},graphics:{ctrl:!0,shift:!1,alt:!0,key:"G"},toggleEd2kButton:{ctrl:!0,shift:!1,alt:!0,key:"D"},copyEd2kLinks:{ctrl:!0,shift:!1,alt:!0,key:"C"}},ed2kEnabled:!1,ed2kButton:{mode:"text",positioning:"fixed",position:{top:10,left:10},buttonText:"ED2K",fontSize:12,fontWeight:400,fontStyle:"normal",borderRadius:4,boxShadow:1,color:"#ffffff",backgroundColor:"#343a40",iconContent:"üìã",iconSize:32}},d={includePrefs:!0,includeScraped:!1,autoBackup:{enabled:!1,interval:24,lastBackup:0}},u=[{key:"id",label:"ID",enabled:!0},{key:"title",label:"T√≠tulo",enabled:!0},{key:"subtitle",label:"Subt√≠tulo",enabled:!0},{key:"author",label:"Autor",enabled:!0},{key:"date",label:"Creado",enabled:!0},{key:"lastActionDate",label:"Modificado",enabled:!0},{key:"subforo",label:"Subforo",enabled:!0},{key:"url",label:"URL",enabled:!0},{key:"status",label:"Marcador",enabled:!0},{key:"rating",label:"Valoraci√≥n",enabled:!1}],p="CRG_UX_Settings",g="CRG_CSV_Settings",f="CRG_Backup_Settings",b="CRG_List_Filter_History",m=["76","81"],h=["76","72","5","71","81","34","37"],y="CRG_StaleTopics",x=new Set(["showtopic=32666","showtopic=30202","showtopic=32667","showtopic=110414","showtopic=109282","showforum=5"]),w={Jan:"01",Feb:"02",Mar:"03",Apr:"04",May:"05",Jun:"06",Jul:"07",Aug:"08",Sep:"09",Oct:"10",Nov:"11",Dec:"12",January:"01",February:"02",March:"03",April:"04",June:"06",July:"07",August:"08",September:"09",October:"10",November:"11",December:"12"};function v(t){return t.normalize("NFKD").replace(/\p{Mark}/gu,"").toLowerCase()}function k(t,e=!1){const n=document.getElementById("crg-tooltip");n&&n.remove();const o=document.createElement("div");o.id="crg-tooltip",o.textContent=t,o.className="crg-notification show",document.body.appendChild(o),e||setTimeout(()=>{const t=document.getElementById("crg-tooltip");t&&(t.classList.remove("show"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300))},5e3)}function S(t=""){return t.replace(/[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{2B50}\u{2B55}\u{203C}\u{2049}\u{2757}‚ú®‚≠ê‚ô•‚ù§‚ùó]/gu,"").replace(/[\u00A0]/g," ").replace(/[\r\n\t]+/g," ").trim()}function C(t){let e=new Date,n=!1;if(t.startsWith("Hoy,")){const o=t.match(/Hoy, (\d{1,2}):(\d{2})/);if(o){const[,t,r]=o;e=new Date,e.setHours(parseInt(t,10),parseInt(r,10),0,0),n=!0}}else if(t.startsWith("Ayer,")){const o=t.match(/Ayer, (\d{1,2}):(\d{2})/);if(o){const[,t,r]=o;e=new Date,e.setDate(e.getDate()-1),e.setHours(parseInt(t,10),parseInt(r,10),0,0),n=!0}}else{const o=t.match(/(\d{1,2})(?:st|nd|rd|th)? (\w+) (\d{4})(?: - (\d{1,2}):(\d{2}))?/);if(o){const[,t,r,a,i,s]=o,c=w[r];c&&(e=new Date(parseInt(a,10),parseInt(c,10)-1,parseInt(t,10)),i&&s&&(e.setHours(parseInt(i,10),parseInt(s,10),0,0),n=!0))}else{const o=t.match(/(\w{3}) (\d{1,2}) (\d{4})(?:, (\d{1,2}):(\d{2}))?/)||t.match(/(\d{1,2}) (\w{3}) (\d{4})(?:,? (\d{1,2}):(\d{2}))?/);if(o){const[,t,r,a,i,s]=o,c=t&&t in w?t:r&&r in w?r:null,l=t&&t in w?r:t,d=c?w[c]:null;d&&l&&(e=new Date(parseInt(a,10),parseInt(d,10)-1,parseInt(l,10)),i&&s&&(e.setHours(parseInt(i,10),parseInt(s,10),0,0),n=!0))}else e=new Date}}const o=e.getFullYear(),r=(e.getMonth()+1).toString().padStart(2,"0"),a=e.getDate().toString().padStart(2,"0"),i=e.getHours().toString().padStart(2,"0"),s=e.getMinutes().toString().padStart(2,"0");return{display:n?`${o}/${r}/${a} ${i}:${s}`:`${o}/${r}/${a} 00:00`,unix:e.getTime(),iso:e.toISOString()}}function E(t,e,n=""){const o=function(t){return t?btoa(unescape(encodeURIComponent(t))):""}(n.trim());return 0!==t||0!==e||o?`${t}:${e}:${o}`:"0:0"}function $(t){return t.match(/#[^\s#]+/g)||[]}let B=l,T=null,q="";function A(t){B=t}function L(){return B?.iconSet&&"object"==typeof B.iconSet?B.iconSet:c}function I(t,e,n){t.className=`lm-tm status-${e}`;const o=L()[e]||"üóí";t.textContent=o,n?t.classList.add("has-comment"):t.classList.remove("has-comment")}function M(t="grey"){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("viewBox","0 0 10 10"),e.style.width="10px",e.style.height="10px",e.style.display="inline-block";const n=document.createElementNS("http://www.w3.org/2000/svg","path");return n.setAttribute("d","M5 0 L6.3 3 L9.5 3 L7 5 L7.8 8 L5 6.5 L2.2 8 L3 5 L0.5 3 L3.7 3 Z"),n.setAttribute("fill",t),n.setAttribute("stroke","transparent"),n.setAttribute("stroke-width","0.5"),e.appendChild(n),e}function z(t,e){const n=B;t.forEach((t,o)=>{let r="transparent",a="lightgrey";if(e>=o+.5){let t;t=5===e?"perfect":e>=o+1?"full":"half";const i=n?.starColors?.[t]||[0,70,50];r=`hsl(${i[0]}, ${i[1]}%, ${i[2]}%)`,a="transparent"}else r="transparent",a="grey";t.querySelector("path")?.setAttribute("fill",r),t.querySelector("path")?.setAttribute("stroke",a)})}function D(t){t.forEach(t=>{const e=t.querySelector("path")?.getAttribute("fill");t.style.display="transparent"===e?"none":"inline-block"})}function O(t){return T&&T[t]?T[t]:{status:0,rating:0,comment:""}}function R(t){T=t,q=JSON.stringify(t)}function N(){return q}function F(t){const e=document.head.querySelector("#crg-markers-data");e&&(e.textContent=JSON.stringify(t))}let H=null,W=!1,j=0;async function _(t){const e=t.href.split("?")[1]?.split("#")[0]||"";if(x.has(e)||e.includes("act=Search"))return;if(!/^(?:showtopic=\d+|act=ST.*&t=\d+)(?:&hl=)?$/.test(e))return;if(t.closest(".signature"))return;const n=e.match(/(?:showtopic|t)=(\d+)/);if(!n)return;const o=n[1],r=O(o);let a=t.nextElementSibling;for(;a&&(a.classList.contains("lm-tm")||a.classList.contains("rating-stars")||a.classList.contains("tag-badges"));){const t=a.nextElementSibling;a.remove(),a=t}const i=document.createElement("span");i.className="lm-tm",i.title=r.comment||"",I(i,r.status,!!r.comment);let s=r,c=i;i.onclick=async t=>{if(t.preventDefault(),t.stopPropagation(),t.ctrlKey||t.metaKey){const t=prompt("Escribe un comentario:",s.comment);if(null===t)return;const e=t.trim();s.comment=e,i.title=e||"",I(i,s.status,!!e),await G(c,s.comment),await P(o,s.status,s.rating,e),window.updateTopicData&&window.updateTopicData(o,s.status,s.rating,s.comment,$(s.comment))}else{const t=s.status>=4?0:s.status+1;s.status=t,I(i,t,!!s.comment),i.title=s.comment||"",await P(o,t,s.rating,s.comment),window.updateTopicData&&window.updateTopicData(o,t,s.rating,s.comment,$(s.comment)),document.getElementById("crg-list-popup")&&"function"==typeof window.refreshListFilter&&window.refreshListFilter()}},t.after(i);const l=document.createElement("div");l.className="rating-stars",l.style.display="inline-block",l.style.verticalAlign="top";const d=0===r.rating,u=[];for(let t=0;t<5;t++){const t=M();l.appendChild(t),u.push(t)}if(z(u,r.rating),D(u),d){for(let t=1;t<5;t++)u[t].style.display="none";u[0].style.display="inline-block"}i.after(l),l.dataset.id=o,l.dataset.rating=r.rating.toString(),l.dataset.collapsed=d?"1":"0",l.currentData=s,c=l,await G(c,r.comment)}async function G(t,e){let n=t.nextElementSibling;for(;n&&n.classList.contains("tag-badges");){const t=n.nextElementSibling;n.remove(),n=t}const o=$(e);if(o.length>0){const e=document.createElement("span");e.className="tag-badges";for(const t of o){const n=document.createElement("span");n.className="tag-badge",n.textContent=t.slice(1);const o=await K(t);n.style.background=o.background,n.style.color=o.color,e.appendChild(n)}t.after(e)}}async function K(t){if(B.useFlatColors)return{background:B.flatBackgroundColor,color:B.flatTextColor};let e=0;for(let n=0;n<t.length;n++)e+=.618033988749895*t.charCodeAt(n),e-=Math.floor(e);e-=Math.floor(e);const n=Math.floor((360*e+B.hueOffset)%360),o=B.saturation,r=B.lightness;return{background:`hsl(${n}, ${o}%, ${r}%)`,color:B.forceBlackText||r>60?"#000":"#fff"}}async function P(t,e,n,o=""){try{const r=E(e,n,o),i=document.head.querySelector("#crg-markers-data");if(i){const e=JSON.parse(i.textContent||"{}");"0:0"===r?delete e[t]:e[t]=r,i.textContent=JSON.stringify(e)}const{markersDB:s}=await Promise.resolve().then(function(){return a});if("0:0"===r)await s.removeItem(t);else{const e=function(t){if(!t)return{status:0,rating:0,comment:""};const e=t.split(":"),n=Math.max(0,Math.min(4,e[0]?+e[0]:0)),o=Math.round(2*Math.max(0,Math.min(5,e[1]?+e[1]:0)))/2,r=e.slice(2).join(":");return{status:n,rating:o,comment:r?function(t){if(!t)return"";try{return decodeURIComponent(escape(atob(t)))}catch(e){return t}}(r):""}}(r);await s.setItem(t,e)}T=null,await Y()}catch(r){const a=document.head.querySelector("#crg-markers-data");if(a)try{const r=JSON.parse(a.textContent||"{}"),i=E(e,n,o);"0:0"===i?delete r[t]:r[t]=i,a.textContent=JSON.stringify(r)}catch(t){}}}async function Y(){const{markersDB:t}=await Promise.resolve().then(function(){return a}),e={};return await t.iterate((t,n)=>{e[n]=t}),T=e,q=JSON.stringify(e),e}async function J(t){for(const e of t)try{await _(e)}catch(t){}}var V=Object.freeze({__proto__:null,addMarkerToLink:_,createStar:M,getAllMarkers:Y,getCachedVersion:N,getEffectiveIconSet:L,getMarkerData:O,initializeMarkerInjection:function(){if(window.top!==window.self)return;const t=document.querySelectorAll('a[href^="http://lamansion-crg.net/forum/index.php?"][href*="showtopic="], a[href^="http://lamansion-crg.net/forum/index.php?"][href*="act=ST"]');J(Array.from(t)),window.addCRGMarkerToLink=_,document.addEventListener("mousedown",t=>{if(t.target&&t.target.closest(".rating-stars")){if(H=t.target.closest(".rating-stars"),W=!0,"1"===H.dataset.collapsed){H.dataset.collapsed="0",j=0;const t=H.querySelectorAll("svg");z(Array.from(t),0),D(Array.from(t)),t.forEach(t=>t.style.display="inline-block")}t.preventDefault()}}),document.addEventListener("mousemove",t=>{if(!W||!H)return;const e=H.getBoundingClientRect(),n=Math.max(0,Math.min(e.width,t.clientX-e.left)),o=.5*Math.round(n/e.width*10)||0;j=o;const r=H.querySelectorAll("svg");z(Array.from(r),j),r.forEach(t=>t.style.display="inline-block")}),document.addEventListener("mouseup",async()=>{if(W&&H){W=!1;const t=H.querySelectorAll("svg");if(0===j){H.dataset.collapsed="1",D(Array.from(t));for(let e=1;e<5;e++)t[e].style.display="none";t[0].style.display="inline-block"}else H.dataset.collapsed="0",D(Array.from(t));const e=H.dataset.id,n=O(e),o=E(n.status,j,n.comment);F({[e]:o}),await P(e,n.status,j,n.comment),H.currentData&&(H.currentData.rating=j),window.updateTopicData&&window.updateTopicData(e,n.status,j,n.comment,$(n.comment)),document.getElementById("crg-list-popup")&&"function"==typeof window.refreshListFilter&&window.refreshListFilter(),H=null}})},processLinks:J,setCachedDB:R,setCurrentPrefs:A,updateDOMExport:F,updateDisplay:D,updateMarkerIcon:I,updateStars:z});let U=l;const X=t=>{if(!t)return"No asignado";const e=[];return t.ctrl&&e.push("Ctrl"),t.shift&&e.push("Shift"),t.alt&&e.push("Alt"),e.push(t.key.toUpperCase()),e.join("+")},Z=()=>Object.entries(i).map(([t,e])=>`<div class="dropdown-option" data-set="${t}">${"default"===t?"Predeterminado":"minimal"===t?"Minimal":"C√≠rculos"}: ${Object.values(e).join(" ")}</div>`).join(""),Q=()=>`\n  /* Custom WinBox header styling */\n  .winbox .wb-title { color: white !important; font-weight: bold !important; }\n  .winbox { background: #252b4e !important; }\n\n  /* Hide fullscreen button */\n  .winbox .wb-full,\n  .winbox .wb-fullscreen,\n  .winbox button[title*="full"],\n  .winbox button[title*="Full"] {\n    display: none !important;\n  }\n  .wb-body { background: #f5f5f5 !important; }\n\n  /* Window content container with bottom padding for fixed buttons */\n  .crg-window-content {\n    position: relative;\n    padding-bottom: 70px; /* Space for fixed footer buttons */\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n  }\n\n  /* Tab navigation styles */\n  .crg-tab-nav {\n    display: flex;\n    border-bottom: 2px solid #ddd;\n    margin-bottom: 20px;\n    flex-shrink: 0;  /* Don't shrink */\n  }\n  .crg-tab-btn {\n    flex: 1;\n    padding: 10px 15px;\n    background: #f8f9fa;\n    border: none;\n    border-bottom: 2px solid transparent;\n    cursor: pointer;\n    font-size: 14px;\n    font-weight: 500;\n    color: #666;\n    transition: all 0.2s ease;\n  }\n  .crg-tab-btn:hover {\n    background: #e9ecef;\n    color: #333;\n  }\n  .crg-tab-btn.active {\n    background: #fff;\n    color: #007bff;\n    border-bottom-color: #007bff;\n  }\n\n  /* Tab content styles */\n  .crg-tab-content {\n    flex: 1;  /* Take remaining space */\n    overflow-y: auto;\n    min-height: 0;  /* Allow shrinking */\n  }\n  .crg-tab-panel {\n    display: none;\n  }\n  .crg-tab-panel.active {\n    display: block;\n  }\n\n  /* Fixed footer buttons */\n  .crg-panel-footer-fixed {\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    padding: 15px 20px;\n    background: #f5f5f5;\n    border-top: 1px solid #ddd;\n    display: flex;\n    justify-content: center;\n    gap: 10px;\n  }\n\n  /* Shortcut recording styles */\n  .shortcut-recording {\n    background: #fff3cd !important;\n    border-color: #ffeeba !important;\n    animation: pulse 1s infinite;\n  }\n  @keyframes pulse {\n    0% { opacity: 1; }\n    50% { opacity: 0.7; }\n    100% { opacity: 1; }\n  }\n\n  /* Icon button styles */\n  .crg-btn-icon {\n    width: 28px !important;\n    height: 28px !important;\n    padding: 0 !important;\n    font-size: 14px !important;\n    font-weight: bold !important;\n    color: white !important;\n    background: black !important;\n    display: flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n  }\n\n  /* Merge panel table header override - prevent inheritance from website */\n  .crg-window-content table thead tr {\n    background: #343a40 !important;\n    color: white !important;\n  }\n\n  /* Shared styles */\n  ${function(t,e={}){const n={border:"1px solid #ccc",borderRadius:"4px",padding:"15px",marginBottom:"25px",legendFontWeight:"bold",legendColor:"#333",legendPadding:"0 10px",legendFontSize:"inherit",...e};return`\n    ${t} {\n      border: ${n.border};\n      border-radius: ${n.borderRadius};\n      padding: ${n.padding};\n      margin-bottom: ${n.marginBottom};\n    }\n\n    ${t} legend {\n      font-weight: ${n.legendFontWeight};\n      color: ${n.legendColor};\n      padding: ${n.legendPadding};\n      font-size: ${n.legendFontSize};\n    }\n  `}("fieldset")}\n  ${function(t,e={}){const n={triggerBackground:"white",triggerColor:"#333",triggerBorder:"1px solid #ccc",triggerBorderRadius:"3px",triggerPadding:"4px 8px",triggerHoverBackground:"#f8f8f8",optionsBackground:"white",optionsBorder:"1px solid #ccc",optionsMaxHeight:"200px",optionPadding:"6px 8px",optionHoverBackground:"#007bff",optionHoverColor:"white",zIndex:"1000",...e};return`\n    ${t} {\n      position: relative;\n      display: inline-block;\n    }\n\n    ${t} .dropdown-trigger {\n      background: ${n.triggerBackground};\n      color: ${n.triggerColor};\n      border: ${n.triggerBorder};\n      border-radius: ${n.triggerBorderRadius};\n      padding: ${n.triggerPadding};\n      cursor: pointer;\n      user-select: none;\n      text-align: center;\n    }\n\n    ${t} .dropdown-trigger:hover {\n      background: ${n.triggerHoverBackground};\n    }\n\n    ${t} .dropdown-options {\n      display: none;\n      position: absolute;\n      top: 100%;\n      left: 0;\n      right: 0;\n      background: ${n.optionsBackground};\n      border: ${n.optionsBorder};\n      border-top: none;\n      z-index: ${n.zIndex};\n      max-height: ${n.optionsMaxHeight};\n      overflow-y: auto;\n    }\n\n    ${t} .dropdown-option {\n      padding: ${n.optionPadding};\n      cursor: pointer;\n      text-align: center;\n    }\n\n    ${t} .dropdown-option:hover {\n      background: ${n.optionHoverBackground};\n      color: ${n.optionHoverColor};\n    }\n\n    ${t}.open .dropdown-options {\n      display: block;\n    }\n  `}(".custom-dropdown")}\n  \n    /* Base button class with CSS variables for customization */\n    .crg-button {\n      display: inline-block;\n      padding: var(--btn-padding, 8px 16px);\n      font-size: var(--btn-font-size, 14px);\n      font-weight: var(--btn-font-weight, normal);\n      color: var(--btn-color, white);\n      background: var(--btn-bg, #28a745);\n      border: var(--btn-border, none);\n      border-radius: var(--btn-radius, 4px);\n      cursor: var(--btn-cursor, pointer);\n      transition: var(--btn-transition, all 0.2s ease);\n      box-shadow: var(--btn-shadow, none);\n      transform: var(--btn-transform, none);\n      text-decoration: none;\n      user-select: none;\n    }\n\n    .crg-button:hover:not(:disabled) {\n      background: var(--btn-hover-bg, #218838);\n      box-shadow: var(--btn-hover-shadow, 0 2px 4px rgba(0,0,0,0.2));\n      transform: var(--btn-hover-transform, translateY(-1px));\n    }\n\n    .crg-button:active:not(:disabled) {\n      background: var(--btn-active-bg, #1e7e34);\n      box-shadow: var(--btn-active-shadow, 0 1px 2px rgba(0,0,0,0.2));\n      transform: var(--btn-active-transform, translateY(0));\n    }\n\n    .crg-button:disabled {\n      background: var(--btn-disabled-bg, #6c757d);\n      color: var(--btn-disabled-color, #adb5bd);\n      cursor: not-allowed;\n      transform: none;\n      box-shadow: none;\n      opacity: 0.6;\n    }\n\n    .crg-button:disabled:hover {\n      background: var(--btn-disabled-bg, #6c757d);\n      transform: none;\n      box-shadow: none;\n    }\n\n    /* Button variants using CSS variables */\n    .crg-btn-primary {\n      --btn-bg: #002966;\n      --btn-hover-bg: #001b4d;\n      --btn-active-bg: #000d33;\n    }\n\n    .crg-btn-danger {\n      --btn-bg: #c1121f;\n      --btn-hover-bg: #a10e1a;\n      --btn-active-bg: #8b0d15;\n    }\n\n    .crg-btn-secondary {\n      --btn-bg: #0052CC;\n      --btn-hover-bg: #004099;\n      --btn-active-bg: #002966;\n    }\n\n    .crg-btn-warning {\n      --btn-bg: #ffc107;\n      --btn-color: #000;\n      --btn-hover-bg: #e0a800;\n      --btn-active-bg: #d39e00;\n    }\n\n    .crg-btn-info {\n      --btn-bg: #17a2b8;\n      --btn-hover-bg: #138496;\n      --btn-active-bg: #117a8b;\n    }\n\n    .crg-btn-gray {\n      --btn-bg: #6c757d;\n      --btn-hover-bg: #5a6268;\n      --btn-active-bg: #545b62;\n    }\n\n    .crg-btn-compact {\n      --btn-padding: 4px 8px;\n      --btn-font-size: 12px;\n    }\n\n    .crg-btn-medium {\n      --btn-padding: 6px 12px;\n      --btn-font-size: 13px;\n    }\n\n    /* Utility classes for spacing and sizing */\n    .crg-btn-wide {\n      min-width: 160px;\n    }\n\n    .crg-btn-spacer {\n      margin-right: 8px;\n    }\n\n    .crg-btn-spacer-lg {\n      margin-right: 10px;\n    }\n\n    /* Layout utility classes */\n    .crg-panel {\n      display: flex;\n      flex-direction: column;\n      padding: 15px;\n    }\n\n    .crg-toolbar {\n      margin-bottom: 15px;\n      display: flex;\n      justify-content: center;\n      gap: 8px;\n    }\n\n    .crg-panel-footer {\n      margin-top: 30px;\n      text-align: center;\n      border-top: 1px solid #ddd;\n      padding-top: 20px;\n    }\n\n    /* Component utility classes */\n    .crg-fieldset {\n      border: 1px solid #ccc;\n      border-radius: 4px;\n      margin-bottom: 25px;\n      padding: 15px;\n    }\n\n    .crg-section {\n      margin-bottom: 25px;\n    }\n\n    .crg-section-center {\n      margin-bottom: 25px;\n      display: flex;\n      justify-content: center;\n    }\n\n    .crg-section-indent {\n      margin-left: 20px;\n    }\n  \n  \n    /* Base notification class with CSS variables for customization */\n    .crg-notification {\n      position: var(--notif-position, fixed);\n      top: var(--notif-top, 10px);\n      right: var(--notif-right, 10px);\n      bottom: var(--notif-bottom, auto);\n      left: var(--notif-left, auto);\n      background: var(--notif-bg, #343a40);\n      color: var(--notif-color, #fff);\n      padding: var(--notif-padding, 8px 16px);\n      border-radius: var(--notif-radius, 4px);\n      font-size: var(--notif-font-size, 14px);\n      font-weight: var(--notif-font-weight, normal);\n      z-index: var(--notif-z-index, 10000);\n      box-shadow: var(--notif-shadow, 0 2px 8px rgba(0,0,0,0.3));\n      border: var(--notif-border, none);\n      max-width: var(--notif-max-width, 400px);\n      text-align: var(--notif-text-align, left);\n      pointer-events: none;\n      user-select: none;\n      opacity: 0;\n      transform: translateY(-10px);\n      transition: all 0.3s ease;\n    }\n\n    .crg-notification.show {\n      opacity: 1;\n      transform: translateY(0);\n    }\n\n    /* Notification variants */\n    .crg-notification-success {\n      --notif-bg: #28a745;\n      --notif-color: #fff;\n    }\n\n    .crg-notification-error {\n      --notif-bg: #dc3545;\n      --notif-color: #fff;\n    }\n\n    .crg-notification-warning {\n      --notif-bg: #ffc107;\n      --notif-color: #000;\n    }\n\n    .crg-notification-info {\n      --notif-bg: #17a2b8;\n      --notif-color: #fff;\n    }\n\n    /* Position variants */\n    .crg-notification-top-left {\n      --notif-top: 10px;\n      --notif-right: auto;\n      --notif-left: 10px;\n    }\n\n    .crg-notification-top-center {\n      --notif-top: 10px;\n      --notif-right: 50%;\n      --notif-left: 50%;\n      --notif-text-align: center;\n      transform: translateX(-50%) translateY(-10px);\n    }\n\n    .crg-notification-top-center.show {\n      transform: translateX(-50%) translateY(0);\n    }\n\n    .crg-notification-bottom-right {\n      --notif-top: auto;\n      --notif-bottom: 10px;\n      --notif-left: auto;\n      --notif-right: 10px;\n      transform: translateY(10px);\n    }\n\n    .crg-notification-bottom-right.show {\n      transform: translateY(0);\n    }\n\n    .crg-notification-bottom-center {\n      --notif-top: auto;\n      --notif-bottom: 10px;\n      --notif-left: 50%;\n      --notif-right: 50%;\n      --notif-text-align: center;\n      transform: translateX(-50%) translateY(10px);\n    }\n\n    .crg-notification-bottom-center.show {\n      transform: translateX(-50%) translateY(0);\n    }\n\n    /* Size variants */\n    .crg-notification-compact {\n      --notif-padding: 4px 8px;\n      --notif-font-size: 12px;\n    }\n\n    .crg-notification-large {\n      --notif-padding: 12px 20px;\n      --notif-font-size: 16px;\n    }\n  \n\n  /* Disabled preset buttons */\n  .preset-btn:disabled {\n    opacity: 0.4;\n    cursor: not-allowed !important;\n    pointer-events: none;\n  }\n  .preset-btn:disabled:hover {\n    background: #ccc !important;\n  }\n\n  /* Disabled checkbox styling */\n  input[type="checkbox"]:disabled {\n    opacity: 0.5;\n    cursor: not-allowed;\n  }\n  input[type="checkbox"]:disabled + strong,\n  input[type="checkbox"]:disabled + em {\n    opacity: 0.7;\n    cursor: not-allowed;\n  }\n`;let tt=null;async function et(){try{const t=GM_getValue(f,null);return t?{...d,...t}:d}catch(t){return d}}async function nt(t){try{GM_setValue(f,t)}catch(t){}}async function ot(t=!0,n=!1){const o={};await e.iterate((t,e)=>{o[e]=t});const r={version:1,timestamp:Date.now(),settings:{includePrefs:t,includeScraped:!1},data:{markers:o}};if(t)try{const t=GM_getValue(p,{});t&&Object.keys(t).length>0&&(r.data.prefs=t)}catch(t){}return r}async function rt(t){const e=JSON.stringify(t),n=new CompressionStream("gzip"),o=n.writable.getWriter(),r=n.readable.getReader();o.write((new TextEncoder).encode(e)),o.close();const a=[];let i=!1;for(;!i;){const{value:t,done:e}=await r.read();i=e,t&&a.push(t)}return new Blob(a,{type:"application/gzip"})}async function at(t){const e=new DecompressionStream("gzip"),n=e.writable.getWriter(),o=e.readable.getReader();n.write(await t.arrayBuffer()),n.close();const r=[];let a=!1;for(;!a;){const{value:t,done:e}=await o.read();a=e,t&&r.push(...t)}const i=(new TextDecoder).decode(new Uint8Array(r));return JSON.parse(i)}async function it(t=!0,e=!1){try{const n=await ot(t,e),o=await rt(n),r=`crg-backup-${(new Date).toISOString().slice(0,19).replace(/:/g,"-").replace("T","_")}.json.gz`,a=URL.createObjectURL(o),i=document.createElement("a");return i.href=a,i.download=r,i.click(),URL.revokeObjectURL(a),!0}catch(t){return alert("Error al crear la copia de seguridad: "+t.message),!1}}async function st(){return new Promise(t=>{const n=document.createElement("input");n.type="file",n.accept=".crg-backup-*.json.gz",n.onchange=async n=>{const o=n.target.files?.[0];if(!o)return t(!1);try{const n=await at(o);if(!n.version||!n.data)throw new Error("Formato de archivo inv√°lido");const r=`¬øImportar copia de seguridad?\n\nMarcadores: ${Object.keys(n.data.markers||{}).length}\nPreferencias: ${n.data.prefs?"S√≠":"No"}\n\nEsto sobrescribir√° los datos existentes.`;if(!confirm(r))return t(!1);if(n.data.markers){await e.clear();for(const[t,o]of Object.entries(n.data.markers))await e.setItem(t,o)}n.data.prefs&&GM_setValue(p,n.data.prefs),alert("Copia de seguridad importada correctamente. La p√°gina se recargar√°."),location.reload(),t(!0)}catch(n){alert("Error al importar la copia: "+n.message),t(!1)}},n.click()})}async function ct(){try{const t=await et();if(!t.autoBackup.enabled)return;const n=Date.now();(n-t.autoBackup.lastBackup)/36e5>=t.autoBackup.interval&&await e.length()>0&&await it(t.includePrefs,t.includeScraped)&&(t.autoBackup.lastBackup=n,await nt(t))}catch(t){}}async function lt(){if(tt)return void tt.focus();const t=document.createElement("div");t.style.cssText="padding:20px; font-family:Arial,sans-serif;";const e=await et();t.innerHTML=`\n    \x3c!-- WINDOW CONTENT CONTAINER --\x3e\n    <div class="crg-window-content">\n      <fieldset class="crg-fieldset">\n        <legend style="font-weight:bold; color:#333; padding:0 10px;">Contenido a incluir</legend>\n\n        <label style="display: block; margin-bottom: 10px;">\n          <input type="checkbox" id="backup-markers" checked disabled style="margin-right: 8px;">\n          Marcadores y comentarios (siempre incluido)\n        </label>\n\n        <label style="display: block; margin-bottom: 10px;">\n          <input type="checkbox" id="backup-prefs" ${e.includePrefs?"checked":""} style="margin-right: 8px;">\n          Preferencias de apariencia\n        </label>\n      </fieldset>\n\n      <fieldset class="crg-fieldset">\n        <legend style="font-weight:bold; color:#333; padding:0 10px;">Copia autom√°tica</legend>\n\n        <label style="display: block; margin-bottom: 10px;">\n          <input type="checkbox" id="auto-backup-enabled" ${e.autoBackup.enabled?"checked":""} style="margin-right: 8px;">\n          Habilitar copias autom√°ticas\n        </label>\n\n        <div class="crg-section-indent">\n          <label style="display: block; margin-bottom: 5px;">\n            Intervalo:\n            <div class="custom-dropdown" id="auto-backup-interval" ${e.autoBackup.enabled?"":"disabled"} style="margin-left: 8px;">\n              <div class="dropdown-trigger">${12===e.autoBackup.interval?"Cada 12 horas":24===e.autoBackup.interval?"Cada 24 horas":48===e.autoBackup.interval?"Cada 48 horas":"Cada 7 d√≠as"} ‚ñº</div>\n              <div class="dropdown-options">\n                <div class="dropdown-option" data-value="12">Cada 12 horas</div>\n                <div class="dropdown-option" data-value="24">Cada 24 horas</div>\n                <div class="dropdown-option" data-value="48">Cada 48 horas</div>\n                <div class="dropdown-option" data-value="168">Cada 7 d√≠as</div>\n              </div>\n            </div>\n          </label>\n\n          <div style="margin-top: 10px;">\n            <span style="color: #666;">Las copias se guardar√°n en la carpeta de descargas por defecto</span>\n          </div>\n        </div>\n      </fieldset>\n\n      <fieldset class="crg-fieldset">\n        <legend style="font-weight:bold; color:#333; padding:0 10px;">Copia manual</legend>\n\n        <div class="crg-section-center">\n          <button id="manual-export" class="crg-button crg-btn-secondary crg-btn-medium crg-btn-spacer-lg">\n            Exportar\n          </button>\n          <button id="manual-import" class="crg-button crg-btn-secondary crg-btn-medium">\n            Importar\n          </button>\n        </div>\n      </fieldset>\n    </div>\n\n    \x3c!-- FIXED FOOTER BUTTONS --\x3e\n    <div class="crg-panel-footer-fixed">\n      <button id="backup-save" class="crg-button crg-btn-primary">\n        Guardar\n      </button>\n    </div>\n  `;const n=new WinBox({id:"crg-backup-panel",title:"Copias de Seguridad",width:"375px",height:"610px",x:"right",y:"center",right:20,mount:t,class:"modern",index:9999,background:"#343a40",onclose:()=>{tt=null}});t.innerHTML+=`<style>${Q()}</style>`,tt=n;const o=t.querySelector("#auto-backup-enabled"),r=t.querySelector("#auto-backup-interval");o.onchange=()=>{o.checked?(r.removeAttribute("disabled"),r.style.opacity="1",r.style.pointerEvents="auto"):(r.setAttribute("disabled","true"),r.style.opacity="0.5",r.style.pointerEvents="none")};const a=r.querySelector(".dropdown-trigger"),i=r.querySelector(".dropdown-options");a&&i&&(a.addEventListener("click",e=>{e.stopPropagation(),t.querySelectorAll(".custom-dropdown.open").forEach(t=>{t!==r&&t.classList.remove("open")}),r.classList.toggle("open")}),i.querySelectorAll(".dropdown-option").forEach(t=>{t.addEventListener("click",()=>{const e=t.getAttribute("data-value"),n=t.textContent;a&&e&&n&&(a.textContent=n+" ‚ñº"),r.classList.remove("open")})}),document.addEventListener("click",t=>{r.contains(t.target)||r.classList.remove("open")})),t.querySelector("#manual-export").onclick=async()=>{const e=t.querySelector("#backup-prefs").checked;await it(e,!1)&&k("Copia de seguridad exportada correctamente")},t.querySelector("#manual-import").onclick=async()=>{await st()},t.querySelector("#backup-save").onclick=async()=>{try{const o=t.querySelector("#backup-prefs")?.checked??!0,r=t.querySelector("#auto-backup-enabled")?.checked??!1,a=t.querySelector("#auto-backup-interval").querySelector(".dropdown-trigger");let i=24;if(a){const t=a.textContent?.replace(" ‚ñº","");"Cada 12 horas"===t?i=12:"Cada 24 horas"===t?i=24:"Cada 48 horas"===t?i=48:"Cada 7 d√≠as"===t&&(i=168)}const s={includePrefs:o,includeScraped:!1,autoBackup:{enabled:r,interval:i,lastBackup:e.autoBackup.lastBackup}};await nt(s),n.close(),k("Configuraci√≥n guardada")}catch(t){k("Error al guardar configuraci√≥n",!0)}}}var dt=Object.freeze({__proto__:null,checkAutoBackup:ct,compressData:rt,createBackupData:ot,decompressData:at,exportBackup:it,importBackup:st,loadBackupSettings:et,saveBackupSettings:nt,showBackupPanel:lt});async function ut(){let t,e=null;return"function"==typeof GM_getValue&&(e=GM_getValue(p,null)),t=e?{...l,...e}:l,function(t){const e={};if(e.saturation=Math.max(0,Math.min(100,"number"==typeof t.saturation?t.saturation:75)),e.lightness=Math.max(0,Math.min(100,"number"==typeof t.lightness?t.lightness:65)),e.hueOffset=Math.max(0,Math.min(359,"number"==typeof t.hueOffset?t.hueOffset:0)),e.forceBlackText="boolean"!=typeof t.forceBlackText||t.forceBlackText,e.useFlatColors="boolean"==typeof t.useFlatColors&&t.useFlatColors,e.ed2kEnabled="boolean"!=typeof t.ed2kEnabled||t.ed2kEnabled,e.borderWidth=Math.max(0,Math.min(3,"number"==typeof t.borderWidth?t.borderWidth:1)),e.borderRadius=Math.max(0,Math.min(8,"number"==typeof t.borderRadius?t.borderRadius:3)),e.fontWeight=[400,700,900].includes(t.fontWeight)?t.fontWeight:700,e.fontStyle=["normal","italic"].includes(t.fontStyle)?t.fontStyle:"normal",e.boxShadow=Math.max(0,Math.min(3,"number"==typeof t.boxShadow?t.boxShadow:1)),e.flatBackgroundColor="string"==typeof t.flatBackgroundColor&&/^#[0-9A-Fa-f]{6}$/.test(t.flatBackgroundColor)?t.flatBackgroundColor:"#ffffff",e.flatTextColor="string"==typeof t.flatTextColor&&/^#[0-9A-Fa-f]{6}$/.test(t.flatTextColor)?t.flatTextColor:"#000000",e.commentDotColor="string"==typeof t.commentDotColor&&/^#[0-9A-Fa-f]{6}$/.test(t.commentDotColor)?t.commentDotColor:"#00ff00",e.starColors={},["empty","half","full","perfect"].forEach(n=>{if(t.starColors&&Array.isArray(t.starColors[n])&&3===t.starColors[n].length)e.starColors[n]=[Math.max(0,Math.min(360,t.starColors[n][0])),Math.max(0,Math.min(100,t.starColors[n][1])),Math.max(0,Math.min(100,t.starColors[n][2]))];else{const t={empty:[0,0,0],half:[30,70,50],full:[0,70,50],perfect:[120,70,50]};e.starColors[n]=t[n].slice()}}),t.iconSet&&"object"==typeof t.iconSet&&!Array.isArray(t.iconSet)){const n={};for(let e=0;e<=4;e++)"string"==typeof t.iconSet[e]&&t.iconSet[e].length>0?n[e]=t.iconSet[e]:n[e]=c[e.toString()];e.iconSet=n}else e.iconSet={...c};e.keyboardShortcuts={};const n=l.keyboardShortcuts;["backup","merge","graphics","toggleEd2kButton","copyEd2kLinks"].forEach(o=>{const r=t.keyboardShortcuts?.[o];r&&"object"==typeof r&&void 0!==r.ctrl&&void 0!==r.alt&&void 0!==r.shift&&"string"==typeof r.key?e.keyboardShortcuts[o]={ctrl:!!r.ctrl,alt:!!r.alt,shift:!!r.shift,key:r.key.toUpperCase()}:e.keyboardShortcuts[o]={...n[o]}}),e.ed2kButton={};const o=l.ed2kButton;e.ed2kButton.mode="icon"===t.ed2kButton?.mode?"icon":"text",e.ed2kButton.positioning="absolute"===t.ed2kButton?.positioning?"absolute":"fixed";let r="number"==typeof t.ed2kButton?.position?.top?t.ed2kButton.position.top:o.position.top,a="number"==typeof t.ed2kButton?.position?.left?t.ed2kButton.position.left:o.position.left;return e.ed2kButton.position={top:Math.max(0,r),left:Math.max(0,a)},e.ed2kButton.buttonText="string"==typeof t.ed2kButton?.buttonText&&t.ed2kButton.buttonText.trim().length>0?t.ed2kButton.buttonText.trim():o.buttonText,e.ed2kButton.fontSize=Math.max(10,Math.min(18,"number"==typeof t.ed2kButton?.fontSize?t.ed2kButton.fontSize:o.fontSize)),e.ed2kButton.fontWeight=[400,700,900].includes(t.ed2kButton?.fontWeight)?t.ed2kButton.fontWeight:o.fontWeight,e.ed2kButton.fontStyle=["normal","italic"].includes(t.ed2kButton?.fontStyle)?t.ed2kButton.fontStyle:o.fontStyle,e.ed2kButton.borderRadius=Math.max(0,Math.min(8,"number"==typeof t.ed2kButton?.borderRadius?t.ed2kButton.borderRadius:o.borderRadius)),e.ed2kButton.boxShadow=Math.max(0,Math.min(3,"number"==typeof t.ed2kButton?.boxShadow?t.ed2kButton.boxShadow:o.boxShadow)),e.ed2kButton.color="string"==typeof t.ed2kButton?.color&&/^#[0-9A-Fa-f]{6}$/.test(t.ed2kButton.color)?t.ed2kButton.color:o.color,e.ed2kButton.backgroundColor="string"==typeof t.ed2kButton?.backgroundColor&&/^#[0-9A-Fa-f]{6}$/.test(t.ed2kButton.backgroundColor)?t.ed2kButton.backgroundColor:o.backgroundColor,e.ed2kButton.iconContent="string"==typeof t.ed2kButton?.iconContent&&t.ed2kButton.iconContent.trim().length>0?t.ed2kButton.iconContent.trim():o.iconContent,e.ed2kButton.iconSize=Math.max(16,Math.min(64,"number"==typeof t.ed2kButton?.iconSize?t.ed2kButton.iconSize:o.iconSize)),e}(t)}async function pt(t){try{"function"==typeof GM_setValue&&GM_setValue(p,t),window.updateGlobalTagStyles&&window.updateGlobalTagStyles(),window.updateAllTagColors&&window.updateAllTagColors()}catch(t){throw t}}const gt={get:(t,e)=>{if("function"==typeof GM_getValue)return GM_getValue(t,e);{const n=localStorage.getItem(t);return null!==n?JSON.parse(n):e}},set:(t,e)=>{"function"==typeof GM_setValue?GM_setValue(t,e):localStorage.setItem(t,JSON.stringify(e))},delete:t=>{"function"==typeof GM_deleteValue?GM_deleteValue(t):localStorage.removeItem(t)}};async function ft(){try{const t=location.href.match(/showforum=(\d+)/)?.[1];if(!t)return null;if(await n.getItem(t)){const e=[];return await o.iterate((n,o)=>{n.subforumId===t&&e.push(n)}),e.length>0?e:null}return null}catch(t){return null}}async function bt(t,e,r=[],a=[],i=0){try{const s=await n.getItem(t)||{id:t,name:e,topicCount:i,lastCached:0};s.topicCount=i+r.length,s.lastCached=Date.now(),await n.setItem(t,s);for(const e of r){const n=e.url.match(/showtopic=(\d+)/)?.[1];n&&(e.id=n,e.subforumId=t,await o.setItem(n,e))}for(const e of a){const n=e.url.match(/showtopic=(\d+)/)?.[1];n&&(e.id=n,e.subforumId=t,await o.setItem(n,e))}}catch(t){}}async function mt(t){try{const e=location.href.match(/showforum=(\d+)/)?.[1];if(!e)return;const r=document.querySelectorAll("#navstrip a"),a=Array.from(r).slice(1).map(t=>t.textContent?.trim()||""),i=Array.from(r).slice(1).map(t=>t.href.match(/showforum=(\d+)/)?.[1]).filter(t=>void 0!==t),s=i[0],c=e;for(let o=0;o<i.length;o++){const r=i[o],c=r===e,l=await n.getItem(r),d={id:r||"",name:a[o]||"",parentId:i[o-1]||null,rootId:s||"",pathIds:i.slice(0,o+1).filter(t=>void 0!==t),pathNames:a.slice(0,o+1).filter(t=>void 0!==t),topicCount:c?t.length:l?.topicCount||0,hasChildren:l?.hasChildren||!1,lastCached:Date.now()};await n.setItem(r,d)}if(i.length>1){const t=i[i.length-2];if(t){const e=await n.getItem(t);e&&!e.hasChildren&&(e.hasChildren=!0,await n.setItem(t,e))}}for(const e of t){const t=e.url.match(/showtopic=(\d+)/)?.[1];t&&(e.id=t,e.subforumId=c,e.rootId=s,e.pathIds=i.filter(t=>void 0!==t),e.pathNames=a.filter(t=>void 0!==t),await o.setItem(t,e))}}catch(t){}}async function ht(){const t=await n.keys(),e=[];for(const o of t){const t=await n.getItem(o);t&&t.topicCount>0&&e.push({id:o,name:t.name||`Forum ${o}`,count:t.topicCount,date:(()=>{const e=new Date(t.lastCached);return`${e.getFullYear()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`})(),lastCached:t.lastCached,topics:[]})}return e}function yt(t,e,n=!1){t.forEach(t=>{const o=t.url.match(/showtopic=(\d+)/)?.[1];if(o&&e[o]){const n=e[o];t.status=n.status,t.rating=n.rating,t.comment=n.comment,t.tags=n.tags||[]}else n&&(t.status=0,t.rating=0,t.comment="",t.tags=[])})}async function xt(t){try{const e=await fetch(t,{credentials:"same-origin"});if(!e.ok)return null;const n=await e.arrayBuffer(),o=new TextDecoder("iso-8859-1").decode(n),r=(new DOMParser).parseFromString(o,"text/html");return r.body?r:null}catch(t){return null}}function wt(t,e){const n=Array.from(t.querySelectorAll("#navstrip a"))[1],o="comicteca"+("81"===n?.href.match(/showforum=(\d+)/)?.[1]?"_completos":"")+"_";Array.from(t.querySelectorAll("td.darkrow1 b")).find(t=>t.textContent?.includes("Discusiones"));let r=[];const a=t.querySelectorAll('a[id^="tid-link-"]');r=Array.from(a).filter(t=>{const e=t.closest("tr");return e&&!e.querySelector('img[src*="f_pinned"]')});const i=[];return r.forEach(t=>{const n=t,r=n.closest("tr");if(!r)return;if(r.querySelector('img[src*="f_pinned"]'))return;const a=n.href.match(/showtopic=(\d+)/)?.[1];if(!a)return;const s=t.textContent||"",c=r.querySelector(".desc span")?.textContent||"",l=r.cells[4],d=l?.querySelector("a")?.textContent||"",u=l?.querySelector('span[style*="color:#666"], span')?.textContent||"",p=r.cells[6],g=p?.querySelector(".lastaction")?.textContent?.split("<br>")[0]?.trim()||"",f=S(s),b=S(c),m=d,h=C(u.trim()),y=C(g.trim());i.push({id:a,title:f,subtitle:b,author:m,date:h,lastActionDate:y,url:n.href,subforo:o+e})}),i}async function vt(t,e,n="full",o=0){const r=`http://lamansion-crg.net/forum/index.php?showforum=${t}&sort_by=Z-A&sort_key=last_post&topicfilter=all&prune_day=100`,a=`${r}&st=0`,i=await xt(a);if(!i)return"incremental"===n?{newTopics:[],updatedTopics:[]}:[];const s=function(t,e){let n=0;t.querySelectorAll('.pagelink a, .pagelinklast a, span.pagelink a, td > a[href*="&st="]').forEach(t=>{const e=t;if("A"===e.tagName){const t=e.href||"",o=e.title||e.textContent||"";if(/(\d+|\>|¬ª|Siguiente|√öltima|P√°gina|Ir|Next|Last)/i.test(o)){const e=t.match(/&st=(\d+)/);e&&(n=Math.max(n,+e[1]))}}}),0===n&&t.querySelectorAll('a[href*="&st="]').forEach(t=>{const e=t.href.match(/&st=(\d+)/);e&&(n=Math.max(n,+e[1]))});const o=e.match(/&st=(\d+)/);o&&(n=Math.max(n,+o[1])),n>2970&&(n=2970);const r=[];for(let t=0;t<=n;t+=30)r.push(`${e}&st=${t}`);return r}(i,r);if("incremental"===n){const t=[],n=[];let r=wt(i,e);await kt(r,t,0,o);const a=r.map(t=>t.lastActionDate?.unix||0);if(a.length>0&&Math.max(...a)>o)for(let n=1;n<s.length;n++){const r=s[n];k(`Actualizaci√≥n incremental: p√°gina ${n+1}/${s.length}...`,!0);const a=await xt(r);if(!a)continue;const i=wt(a,e);if(!await kt(i,t,0,o))break}return{newTopics:t,updatedTopics:n}}{const t=[...wt(i,e)];for(let n=1;n<s.length;n++){const o=s[n];k(`Cargando p√°gina ${n+1}/${s.length}...`,!0);const r=await xt(o);if(!r)continue;const a=wt(r,e);t.push(...a)}return t}}async function kt(t,e,n,o,r){const a=t.map(t=>t.lastActionDate?.unix||0);if(0===a.length)return!1;if(Math.max(...a)<o)return!1;for(const n of t)if((n.lastActionDate?.unix||0)>o){const t=n.url.match(/showtopic=(\d+)/)?.[1];t&&(n.id=t,e.push(n))}return!0}function St(){try{const t=((t,e)=>{if("function"==typeof GM_getValue)return GM_getValue(t,e);{const n=localStorage.getItem(t);return null!==n?JSON.parse(n):e}})(b,[]);return Array.isArray(t)?t:[]}catch(t){return[]}}function Ct(t){if(t.trim())try{const o=St(),r=o.indexOf(t);r>-1&&o.splice(r,1),o.unshift(t),o.length>10&&o.splice(10),e=b,n=o,"function"==typeof GM_setValue?GM_setValue(e,n):localStorage.setItem(e,JSON.stringify(n))}catch(t){}var e,n}async function Et(t,e){const n=[];return await e.iterate((e,o)=>{e.name&&e.name.toLowerCase()===t.toLowerCase()&&n.push(e)}),n.length>0||(await e.iterate((e,o)=>{e.name&&e.name.toLowerCase().startsWith(t.toLowerCase())&&n.push(e)}),n.length>0||await e.iterate((e,o)=>{e.name&&e.name.toLowerCase().includes(t.toLowerCase())&&n.push(e)})),n}async function $t(t,e){const n=[],o=await e.getItem(t);return o&&n.push(o),await e.iterate((e,o)=>{o!==t&&e.pathIds&&e.pathIds.includes(t)&&n.push(e)}),n}let Bt=null;function Tt(){try{const t=((t,e)=>{if("function"==typeof GM_getValue)return GM_getValue(t,e);{const n=localStorage.getItem(t);return null!==n?JSON.parse(n):e}})(g,u.map(t=>({...t})));return Array.isArray(t)?t:u.map(t=>({...t}))}catch(t){return u.map(t=>({...t}))}}function qt(){if(Bt)return void Bt.focus();let t=Tt();const e=document.createElement("div");e.style.cssText="padding:20px; font-family:Arial,sans-serif;",e.innerHTML='\n    \x3c!-- WINDOW CONTENT CONTAINER --\x3e\n    <div class="crg-window-content">\n      <div style="margin-bottom: 10px; font-size: 13px;">\n        Arrastra las filas para cambiar el orden ¬∑ Haz clic en la casilla para activar/desactivar\n      </div>\n      <div id="crg-csv-columns-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; background: #f9f9f9;"></div>\n    </div>\n\n    \x3c!-- FIXED FOOTER BUTTONS --\x3e\n    <div class="crg-panel-footer-fixed">\n      <button id="crg-csv-save" class="crg-button crg-btn-primary">Guardar</button>\n    </div>\n  ';const n=new WinBox({title:"Configuraci√≥n de las columnas CSV",width:"375px",height:"610px",x:"right",y:"center",right:20,mount:e,class:"modern",index:9999,background:"#343a40",onclose:()=>{Bt=null}});Bt=n,e.innerHTML+=`<style>${Q()}</style>`;const o=e.querySelector("#crg-csv-columns-list"),r=()=>{o&&(o.innerHTML="",t.forEach((e,n)=>{const a=document.createElement("div");a.draggable=!0,a.style.cssText="display:flex;align-items:center;padding:8px;margin:4px 0;border:1px solid #ddd;border-radius:4px;cursor:move;user-select:none;background:#fff;",a.innerHTML=`\n        <input type="checkbox" ${e.enabled?"checked":""} style="margin-right:10px;transform:scale(1.2);cursor:pointer;">\n        <span style="font-weight:bold;margin-right:10px;">${n+1}.</span>\n        <span style="flex:1;">${e.label}</span>\n      `;const i=a.querySelector("input");i&&(i.onclick=e=>{e.stopPropagation(),t[n].enabled=!t[n].enabled,r()}),a.addEventListener("dragstart",t=>{t.dataTransfer?.setData("text/plain",n.toString()),a.style.opacity="0.5"}),a.addEventListener("dragover",t=>t.preventDefault()),a.addEventListener("dragend",()=>a.style.opacity="1"),a.addEventListener("drop",e=>{e.preventDefault();const o=parseInt(e.dataTransfer?.getData("text/plain")||"0",10),a=n;if(o===a)return;const[i]=t.splice(o,1);t.splice(a,0,i),r()}),o.appendChild(a)}))},a=e.querySelector("#crg-csv-save");a&&(a.onclick=()=>{!function(t){try{e=g,n=t,"function"==typeof GM_setValue?GM_setValue(e,n):localStorage.setItem(e,JSON.stringify(n))}catch(t){}var e,n}(t),n&&n.close()}),r()}let At=null;function Lt(t,e=[]){if(At)return void At.focus();const n=document.createElement("div");n.style.cssText="width: 100%; height: 100%; display: flex; flex-direction: column; color: #000;",n.innerHTML='\n    <div id="crg-topics-table-container" style="border: 1px solid #ddd; flex: 1; overflow: auto; padding: 0 16px; box-sizing: border-box;">\n      <div style="max-width: 1600px; margin: 0 auto; width: 100%;">\n        <div style="position: sticky; top: 0; background: #f9f9fa; z-index: 11; padding:8px;display:flex;align-items:center;">\n          <span id="crg-counter" style="margin-right:12px;font-weight:bold;white-space:nowrap;">0 / 0</span>\n          <input type="text" id="crg-filter-input" placeholder="Filtrar temas... prefijos :regex: :c: :s: :r:" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:14px;">\n          <div style="position: relative; display: inline-block; margin-left: 8px;">\n            <span id="crg-filter-history" style="cursor:pointer;color:#666;font-size:14px;" title="Historial de filtros">‚ñº</span>\n          </div>\n          <button id="crg-reload-filter" style="margin-left:8px;padding:6px 12px;background:#343a40;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;" title="Actualizar">‚Üª</button>\n          <button id="crg-export-csv" style="margin-left:8px;padding:6px 12px;background:#343a40;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;" title="Exportar a CSV">CSV</button>\n          <button id="crg-csv-config" style="margin-left:4px;padding:6px 12px;background:#343a40;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;" title="Configurar columnas CSV">‚öô</button>\n        </div>\n        <div id="crg-topics-table" style="width: 100%;">\n          <div id="crg-table-header" style="display: flex; background: #f0f0f0; z-index: 9; border-bottom: 2px solid #ddd;">\n            <div data-col="0" style="flex: 5; min-width: 220px; border-right: 1px solid #ddd; padding: 8px; text-align: left; cursor: pointer;">T√≠tulo</div>\n            <div data-col="1" style="flex: 1.2; min-width: 100px; border-right: 1px solid #ddd; padding: 8px; text-align: center; cursor: pointer;">Autor</div>\n            <div data-col="2" style="flex: 0.8; min-width: 90px; border-right: 1px solid #ddd; padding: 8px; text-align: center; cursor: pointer;">Creado</div>\n            <div data-col="3" style="flex: 0.8; min-width: 90px; border-right: 1px solid #ddd; padding: 8px; text-align: center; cursor: pointer;">Modificado</div>\n            <div data-col="4" style="flex: 1.2; min-width: 140px; padding: 8px; text-align: left; cursor: pointer;">Subforo</div>\n          </div>\n          <div id="virtual-rows" style="position: relative; min-height: 400px;"></div>\n        </div>\n      </div>\n    </div>\n  ';const o=new WinBox({title:"Lista de temas",width:"90%",height:"90%",x:"center",y:"center",mount:n,class:"modern",index:9999,background:"#343a40",onclose:()=>{window.crgCurrentTopics=null,window.crgOriginalTopics=null,window.refreshListFilter=null,At=null}});At=o;const r=n.querySelector('div[style*="flex: 1; overflow: auto"]');setTimeout(()=>{const t=n.querySelector('div[style*="position: sticky; top: 0"]'),e=n.querySelector("#crg-table-header"),a=n.querySelector("#virtual-rows");if(!t||!e||!a)return;const i=()=>{const n=t.offsetHeight,o=n+e.offsetHeight;a.style.paddingTop=o+"px",e.style.position="sticky",e.style.top=n+"px",e.style.borderTop="2px solid #ccc",e.style.borderBottom="2px solid #ddd",e.style.background="#f9f9fa",t.style.zIndex="11",e.style.zIndex="10",t.style.boxShadow="0 4px 8px -4px rgba(0,0,0,0.12)",e.style.boxShadow="0 4px 8px -4px rgba(0,0,0,0.18)",e.style.transform="translateZ(0)",t.style.transform="translateZ(0)",a.style.transform="translateZ(0)"};i(),r?.addEventListener("scroll",i);const s=new ResizeObserver(i);s.observe(t),s.observe(e),r&&s.observe(r);const c=o.onclose||(()=>{});o.onclose=()=>{s.disconnect(),c()}},150);const a=[...t];let i=[...t];window.crgCurrentTopics=i,window.crgOriginalTopics=a;let s=-1,c=1,l={};const d=["title","author","date","lastActionDate","subforo"],u={0:"",1:"",2:"",3:"",4:""},p=new Intl.Collator("es",{sensitivity:"base"}),g=n.querySelector("#crg-counter"),f=()=>{g&&(g.textContent=`${i.length} / ${a.length}`)},b=()=>{const t=n.querySelector("#virtual-rows");if(!t||!r)return;const e=r.scrollTop,o=r.clientHeight,a=Math.max(0,Math.floor(e/48)-20),s=Math.min(i.length-1,Math.ceil((e+o)/48)+20),c=i.slice(a,s+1),l=Array.from(document.querySelectorAll("#navstrip a")).slice(2).map(t=>t.textContent?.trim()||""),d=l.length>0?l[l.length-1]:"Principal",u=c.map((t,e)=>{const n=a+e,o=48*n,r=t.subforumName||d;return`<div style="position: absolute; top: 0; left: 0; width: 100%; height: 48px; transform: translateY(${o}px); display: flex; background: ${n%2==0?"#f9f9fa":"#fdfdfd"}; border-bottom: 1px solid #e9ecef;">\n        <div style="flex: 5; min-width: 220px; border-right: 1px solid #ddd; padding: 8px; text-align: left;"><a href="${t.url}" target="_blank" style="color:#000; line-height: 1.7;"><b>${t.title}</b> ${t.subtitle}</a></div>\n        <div style="flex: 1.2; min-width: 100px; border-right: 1px solid #ddd; padding: 8px; text-align: center; color:#000;">${t.author}</div>\n        <div style="flex: 0.8; min-width: 90px; border-right: 1px solid #ddd; padding: 8px; text-align: center; color:#000;">${t.date.display}</div>\n        <div style="flex: 0.8; min-width: 90px; border-right: 1px solid #ddd; padding: 8px; text-align: center; color:#000;">${t.lastActionDate?.display||""}</div>\n        <div style="flex: 1.2; min-width: 140px; padding: 8px; text-align: left; color:#000;">${r}</div>\n      </div>`}).join("");t.innerHTML=u;const p=48*i.length,g=o+384;t.style.height=Math.max(p,g)+"px",r.style.background="#f9f9fa",t.style.background="#f9f9fa","function"==typeof window.addCRGMarkerToLink&&t.querySelectorAll('a[href*="showtopic="], a[href*="act=ST"]').forEach(window.addCRGMarkerToLink)},m=()=>{const t=n.querySelector("#crg-filter-input");if(!t)return;const e=t.value.trim();if(!e)return i=[...a],r&&(r.scrollTop=0),b(),void f();i=function(t,e,n){if(!e)return[...t];const o=e.split(/\s+/).filter(t=>t),r={status:null,rating:null,comment:null,regex:null},a=[];return o.forEach(t=>{if(t.startsWith(":s:"))r.status=t.slice(3).split("|").map(Number);else if(t.startsWith(":r:"))r.rating=t.slice(3).split("|").map(t=>{let e=!1;t.startsWith("!")&&(e=!0,t=t.slice(1));let n=!1;t.endsWith("+")&&(n=!0,t=t.slice(0,-1));const o=parseFloat(t);return isNaN(o)?null:{val:o,min:n,exclude:e}}).filter(t=>null!==t);else if(t.startsWith(":c:"))r.comment=t.slice(3);else if(t.startsWith(":regex:"))r.regex=t.slice(7);else{const e=t.includes("|")?t.split("|"):[t];a.push(e)}}),(r.status||r.rating||r.comment)&&(n||(n=JSON.parse(document.getElementById("crg-markers-data")?.textContent||"{}")),yt(t,n)),t.filter(t=>{const e=[t.title,t.subtitle,t.author].join(" ");let n=a.every(t=>t.some(t=>v(e).includes(v(t))));if(n&&r.status&&(n=r.status.includes(t.status||0)),n&&r.rating&&(n=r.rating.some(e=>{const n=t.rating||0,o=e.min?n>=e.val:n===e.val;return e.exclude?!o:o})),n&&r.comment&&(n=v(t.comment||"").includes(v(r.comment))),n&&r.regex)try{n=new RegExp(r.regex,"i").test(v(e))}catch(t){n=!1}return n})}(a,e,l),r&&(r.scrollTop=0),b(),f()};n.querySelectorAll("div[data-col]").forEach(t=>{t.addEventListener("click",()=>{(t=>{let e=1;s===t&&(e=-c),s=t,c=e,Object.keys(u).forEach(t=>{u[t]=""}),u[t.toString()]=1===e?" ‚ñ≤":" ‚ñº",i.sort((n,o)=>{let r=n[d[t]],a=o[d[t]];return 2===t||3===t?((r?.unix||0)-(a?.unix||0))*e:e*p.compare(String(r),String(a))}),r&&(r.scrollTop=0),b(),n.querySelectorAll("div[data-col]").forEach(t=>{const e=parseInt(t.getAttribute("data-col")||"0"),n=t.textContent?.replace(/[ ‚ñ≤‚ñº]/g,"")||"";t.textContent=n+u[e.toString()]})})(parseInt(t.getAttribute("data-col")||"0"))})}),r&&r.addEventListener("scroll",()=>b());let h=null;const y=n.querySelector("#crg-filter-input");y&&y.addEventListener("input",()=>{null!==h&&clearTimeout(h),h=window.setTimeout(m,300)});const x=n.querySelector("#crg-reload-filter");x&&x.addEventListener("click",()=>{const t=n.querySelector("#crg-filter-input")?.value.trim();t&&Ct(t),l=JSON.parse(document.getElementById("crg-markers-data")?.textContent||"{}"),yt(a,l),m()});const w=n.querySelector("#crg-export-csv");w&&w.addEventListener("click",()=>{const t=(new Date).toISOString().slice(0,19).replace(/:/g,"-").replace("T","_"),e=`crg-lista-${i.length}-${t}.csv`;!function(t){const e=Tt().filter(t=>t.enabled);if(0===e.length)return;const n="\ufeff"+[e.map(t=>t.label).join(","),...t.map(t=>e.map(e=>{let n=t[e.key]||"";return"date"!==e.key&&"lastActionDate"!==e.key||n&&"object"==typeof n&&n.display&&(n=n.display),`"${String(n).replace(/"/g,'""')}"`}).join(","))].join("\r\n"),o=(new Date).toISOString().slice(0,19).replace(/:/g,"-").replace("T","_"),r=`crg-lista-${t.length}-${o}.csv`,a=new Blob([n],{type:"text/csv;charset=utf-8"}),i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download=r,s.click(),URL.revokeObjectURL(i)}(i),k(`CSV exportado: ${e}`)});const S=n.querySelector("#crg-csv-config");S&&S.addEventListener("click",()=>qt());const C=n.querySelector('div[style*="margin-left: 8px"]'),E=n.querySelector("#crg-filter-history");E&&E.addEventListener("click",t=>{t.stopPropagation();const e=St();if(0===e.length)return;const o=document.getElementById("crg-filter-dropdown");o&&o.remove();const r=document.createElement("div");r.id="crg-filter-dropdown",r.style.cssText="\n        position: absolute;\n        background: #fff;\n        border: 1px solid #ccc;\n        border-radius: 4px;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n        z-index: 10001;\n        max-height: 200px;\n        overflow-y: auto;\n        min-width: 200px;\n        top: 100%;\n        left: 0;\n      ",e.forEach((t,o)=>{const a=document.createElement("div");a.textContent=t,a.style.cssText="\n          padding: 6px 12px;\n          cursor: pointer;\n          border-bottom: 1px solid #eee;\n          color: #000;\n        ",a.onmouseover=()=>a.style.background="#f0f0f0",a.onmouseout=()=>a.style.background="",a.onclick=()=>{const e=n.querySelector("#crg-filter-input");e&&(e.value=t),r.remove(),Ct(t),m()},o===e.length-1&&(a.style.borderBottom="none"),r.appendChild(a)}),C&&C.appendChild(r);const a=t=>{r.contains(t.target)||t.target===E||(r.remove(),document.removeEventListener("click",a))};setTimeout(()=>document.addEventListener("click",a),0)}),window.refreshListFilter=m,setTimeout(()=>{const t=n.querySelector("#crg-filter-input");t&&t.focus()},100),b(),f()}let It=null;async function Mt(){if(It)return void It.focus();const t=document.createElement("div");t.style.cssText="width: 100%; height: 100%; display: flex; flex-direction: column; color: #000;";const e=await window.subforumsDB.keys();let n=[];for(const t of e){const e=await window.subforumsDB.getItem(t);if(e){const o=e.topicCount||0;o>0&&n.push({id:t,name:e.name||`Forum ${t}`,count:o,date:(()=>{const t=new Date(e.lastCached);return`${t.getFullYear()}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getDate().toString().padStart(2,"0")} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`})(),lastCached:e.lastCached,topics:[]})}}const o=window.Storage.get(y,[]);if(o.length>0&&n.push({id:"000",name:"Desubicados",topicCount:o.length,count:o.length,date:(()=>{const t=new Date;return`${t.getFullYear()}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getDate().toString().padStart(2,"0")} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`})(),lastCached:Date.now(),isVirtual:!0,topics:o}),0===n.length)return void k("No hay listas en cach√© para combinar");t.innerHTML='\n    <div class="crg-panel">\n      <div class="crg-toolbar">\n        <button id="crg-toggle-selection" class="crg-button crg-btn-secondary crg-btn-wide crg-btn-spacer">‚òë Seleccionar todo</button>\n        <button id="crg-update-selected" class="crg-button crg-btn-warning crg-btn-spacer">Actualizar</button>\n        <button id="crg-force-update-selected" class="crg-button crg-btn-warning crg-btn-spacer">Forzar actualizaci√≥n</button>\n        <button id="crg-delete-selected" class="crg-button crg-btn-danger crg-btn-spacer">Eliminar</button>\n        <button id="crg-generate-merged" class="crg-button crg-btn-primary">Generar lista</button>\n      </div>\n      <div class="crg-toolbar">\n        <button id="crg-show-desubicados" class="crg-button crg-btn-info">Desubicados</button>\n        <button id="crg-filter-comicteca" class="crg-button crg-btn-info">Comicteca</button>\n        <button id="crg-filter-completos" class="crg-button crg-btn-info">Completos</button>\n      </div>\n      <div style="margin-bottom: 10px;">\n        <input type="text" id="crg-subforum-filter" placeholder="Buscar subforo..." style="width: 95%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">\n      </div>\n      <div id="crg-subforum-table-container" style="border: 1px solid #ddd; flex: 1; overflow: auto;">\n        <table id="crg-subforum-table" style="width: 100%; border-collapse: collapse;">\n          <thead>\n            <tr style="position: sticky; top: 0; z-index: 1;">\n              <th data-col="0" style="padding: 8px; border: 1px solid #ddd; text-align: center; cursor: pointer; user-select: none; background: #343a40; color: white;">Seleccionar</th>\n              <th data-col="1" style="padding: 8px; border: 1px solid #ddd; text-align: center; cursor: pointer; user-select: none; background: #343a40; color: white;">ID</th>\n              <th data-col="2" style="padding: 8px; border: 1px solid #ddd; text-align: left; cursor: pointer; user-select: none; background: #343a40; color: white;">Subforo</th>\n              <th data-col="3" style="padding: 8px; border: 1px solid #ddd; text-align: center; cursor: pointer; user-select: none; background: #343a40; color: white;">Temas</th>\n              <th data-col="4" style="padding: 8px; border: 1px solid #ddd; text-align: center; cursor: pointer; user-select: none; background: #343a40; color: white;">Actualizado</th>\n            </tr>\n          </thead>\n          <tbody id="crg-subforum-tbody">\n          </tbody>\n        </table>\n      </div>\n    </div>\n  ';const r=new WinBox({title:"Combinar listas en cach√©",width:"60%",height:"60%",x:"center",y:"center",mount:t,class:"modern",index:9999,background:"#343a40",onclose:()=>{It=null}});It=r,t.innerHTML+="\n    <style>\n      \n    /* Base button class with CSS variables for customization */\n    .crg-button {\n      display: inline-block;\n      padding: var(--btn-padding, 8px 16px);\n      font-size: var(--btn-font-size, 14px);\n      font-weight: var(--btn-font-weight, normal);\n      color: var(--btn-color, white);\n      background: var(--btn-bg, #28a745);\n      border: var(--btn-border, none);\n      border-radius: var(--btn-radius, 4px);\n      cursor: var(--btn-cursor, pointer);\n      transition: var(--btn-transition, all 0.2s ease);\n      box-shadow: var(--btn-shadow, none);\n      transform: var(--btn-transform, none);\n      text-decoration: none;\n      user-select: none;\n    }\n\n    .crg-button:hover:not(:disabled) {\n      background: var(--btn-hover-bg, #218838);\n      box-shadow: var(--btn-hover-shadow, 0 2px 4px rgba(0,0,0,0.2));\n      transform: var(--btn-hover-transform, translateY(-1px));\n    }\n\n    .crg-button:active:not(:disabled) {\n      background: var(--btn-active-bg, #1e7e34);\n      box-shadow: var(--btn-active-shadow, 0 1px 2px rgba(0,0,0,0.2));\n      transform: var(--btn-active-transform, translateY(0));\n    }\n\n    .crg-button:disabled {\n      background: var(--btn-disabled-bg, #6c757d);\n      color: var(--btn-disabled-color, #adb5bd);\n      cursor: not-allowed;\n      transform: none;\n      box-shadow: none;\n      opacity: 0.6;\n    }\n\n    .crg-button:disabled:hover {\n      background: var(--btn-disabled-bg, #6c757d);\n      transform: none;\n      box-shadow: none;\n    }\n\n    /* Button variants using CSS variables */\n    .crg-btn-primary {\n      --btn-bg: #002966;\n      --btn-hover-bg: #001b4d;\n      --btn-active-bg: #000d33;\n    }\n\n    .crg-btn-danger {\n      --btn-bg: #c1121f;\n      --btn-hover-bg: #a10e1a;\n      --btn-active-bg: #8b0d15;\n    }\n\n    .crg-btn-secondary {\n      --btn-bg: #0052CC;\n      --btn-hover-bg: #004099;\n      --btn-active-bg: #002966;\n    }\n\n    .crg-btn-warning {\n      --btn-bg: #ffc107;\n      --btn-color: #000;\n      --btn-hover-bg: #e0a800;\n      --btn-active-bg: #d39e00;\n    }\n\n    .crg-btn-info {\n      --btn-bg: #17a2b8;\n      --btn-hover-bg: #138496;\n      --btn-active-bg: #117a8b;\n    }\n\n    .crg-btn-gray {\n      --btn-bg: #6c757d;\n      --btn-hover-bg: #5a6268;\n      --btn-active-bg: #545b62;\n    }\n\n    .crg-btn-compact {\n      --btn-padding: 4px 8px;\n      --btn-font-size: 12px;\n    }\n\n    .crg-btn-medium {\n      --btn-padding: 6px 12px;\n      --btn-font-size: 13px;\n    }\n\n    /* Utility classes for spacing and sizing */\n    .crg-btn-wide {\n      min-width: 160px;\n    }\n\n    .crg-btn-spacer {\n      margin-right: 8px;\n    }\n\n    .crg-btn-spacer-lg {\n      margin-right: 10px;\n    }\n\n    /* Layout utility classes */\n    .crg-panel {\n      display: flex;\n      flex-direction: column;\n      padding: 15px;\n    }\n\n    .crg-toolbar {\n      margin-bottom: 15px;\n      display: flex;\n      justify-content: center;\n      gap: 8px;\n    }\n\n    .crg-panel-footer {\n      margin-top: 30px;\n      text-align: center;\n      border-top: 1px solid #ddd;\n      padding-top: 20px;\n    }\n\n    /* Component utility classes */\n    .crg-fieldset {\n      border: 1px solid #ccc;\n      border-radius: 4px;\n      margin-bottom: 25px;\n      padding: 15px;\n    }\n\n    .crg-section {\n      margin-bottom: 25px;\n    }\n\n    .crg-section-center {\n      margin-bottom: 25px;\n      display: flex;\n      justify-content: center;\n    }\n\n    .crg-section-indent {\n      margin-left: 20px;\n    }\n  \n    </style>\n  ",setTimeout(()=>{const e=t.querySelector("#crg-subforum-filter");e&&e.focus()},100);const a=t.querySelector("#crg-subforum-tbody"),i=t.querySelector("#crg-generate-merged");let s=new Set,c=[...n],l=-1,d=1;const u=()=>{a&&(a.innerHTML=c.map(t=>`\n      <tr style="background: ${s.has(t.id)?"#e3f2fd":"white"};">\n        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">\n          <input type="checkbox" data-id="${t.id}" style="transform: scale(1.2);" ${s.has(t.id)?"checked":""}>\n        </td>\n        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: #000;">${t.id}</td>\n        <td style="padding: 8px; border: 1px solid #ddd; text-align: left; color: #000;">${t.name}</td>\n        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: #000;">${t.count}</td>\n        <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: #000;">${t.date}</td>\n      </tr>\n    `).join(""),i&&(i.disabled=0===s.size,i.style.opacity=0===s.size?"0.5":"1"))},p=e=>{let n=1;l===e&&(n=-d),l=e,d=n,t.querySelectorAll("th[data-col]").forEach(t=>{const e=t.textContent?.replace(/[ ‚ñ≤‚ñº]/g,"")||"";t.textContent=e}),c.sort((t,o)=>{let r,a;switch(e){case 1:r=parseInt(t.id),a=parseInt(o.id);break;case 2:r=t.name.toLowerCase(),a=o.name.toLowerCase();break;case 3:r=t.count,a=o.count;break;case 4:r=new Date(t.date),a=new Date(o.date);break;default:return 0}return 4===e||"number"==typeof r?(r-a)*n:r.localeCompare(a)*n});const o=t.querySelector(`th[data-col="${e}"]`);o&&(o.textContent+=1===n?" ‚ñ≤":" ‚ñº"),u()},g=async()=>{const e=t.querySelector("#crg-subforum-filter");if(!e)return;const o=e.value.trim();if(o.includes(":m:")){const t=/\b\d{1,3}\b/.test(o),e=[],r=o.match(/:m:[^\s]+/g)||[];for(const t of r){const o=t.slice(3),r=[],a=o.split(",");for(const t of a){const e=t.trim();e&&r.push(e)}0===r.length&&r.push(o);for(const t of r){const o=t.trim();if(!o)continue;const r=o.startsWith('"')&&o.endsWith('"'),a=r?o.slice(1,-1):o;if(r){const t=await Et(a,window.subforumsDB);for(const n of t){const t=await $t(n.id,window.subforumsDB);e.push(...t)}}else{if(!/^\d+$/.test(a)){k(`Sintaxis inv√°lida: ${a} (usa comillas para nombres)`);continue}if("000"===a){const t=n.find(t=>"000"===t.id);t?e.push(t):k(`Subforo ${a} no encontrado`)}else if(await window.subforumsDB.getItem(a)){const t=await $t(a,window.subforumsDB);e.push(...t)}else k(`Subforo ${a} no encontrado`)}}}if(t){const t=o.split(/\s+/).filter(t=>!t.startsWith(":m:")&&/^\d{1,3}$/.test(t));for(const n of t){const t=n,o=await window.subforumsDB.getItem(t);o&&e.push(o)}}const a=e.filter((t,e,n)=>e===n.findIndex(e=>e.id===t.id));if(0===a.length)return k("No se encontraron subforos para los criterios especificados"),c=[],void u();const i=a.filter(t=>t.topicCount>0).map(t=>({id:t.id,name:t.name||`Forum ${t.id}`,count:t.topicCount||0,date:(()=>{const e=new Date(t.lastCached);return`${e.getFullYear()}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`})(),lastCached:t.lastCached}));c=i,k(`Mostrando ${i.length} subforos`),l>=0?p(l):u()}else{if(o){const t=window.normalizeText(o);c=n.filter(e=>window.normalizeText(e.name).includes(t))}else c=[...n];l>=0?p(l):u()}},f=t.querySelector("#crg-toggle-selection");f&&(f.onclick=()=>{c.every(t=>s.has(t.id))?c.forEach(t=>s.delete(t.id)):c.forEach(t=>s.add(t.id)),$(),u()});const b=t.querySelector("#crg-update-selected");b&&(b.onclick=async()=>{if(0===s.size)return void k("Selecciona al menos una lista para actualizar");const t=Array.from(s);k(`Actualizando ${t.length} lista(s) en cach√©...`,!0);try{let e=0,o=0,r=0;for(let a=0;a<t.length;a++){const i=t[a],s=n.find(t=>t.id===i)?.name||`Forum ${i}`;k(`Actualizando ${s} (${a+1}/${t.length})...`,!0);try{const t=[];await window.topicsDB.iterate((e,n)=>{e.subforumId===i&&t.push(e)});const o=n.find(t=>t.id===i)?.lastCached||0,a=await window.scrapeForumTopics(i,s,"incremental",o),c=new Map;t.forEach(t=>{c.set(t.id,t)});const l=[...t];let d=0,u=0;for(const t of a.newTopics)l.push(t),d++;for(const t of a.updatedTopics){const e=t.url.match(/showtopic=(\d+)/)?.[1];if(e){const n=l.findIndex(t=>t.url.match(/showtopic=(\d+)/)?.[1]===e);-1!==n&&(l[n]=t,u++)}}await window.saveChangedTopicsSelectively(i,s,a.newTopics,a.updatedTopics,t.length),r+=d+u,e++}catch(t){o++}}n=await ht(),c=[...n],u(),k(0===o?`Actualizadas ${e} lista(s) en cach√© (${r} temas)`:`Actualizadas ${e} lista(s), ${o} error(es) (${r} temas)`)}catch(t){k("Error en la actualizaci√≥n por lotes",!0)}});const m=t.querySelector("#crg-force-update-selected");m&&(m.onclick=async()=>{if(0===s.size)return void k("Selecciona al menos una lista para forzar actualizaci√≥n");const t=Array.from(s),e=`¬øForzar actualizaci√≥n completa de ${t.length} lista(s)?\n\nEsto volver√° a descargar todos los temas desde cero.`;if(confirm(e)){k(`Forzando actualizaci√≥n completa de ${t.length} lista(s)...`,!0);try{let e=0,o=0,r=0;for(let a=0;a<t.length;a++){const i=t[a],s=n.find(t=>t.id===i)?.name||`Forum ${i}`;k(`Forzando actualizaci√≥n de ${s} (${a+1}/${t.length})...`,!0);try{const t=await window.scrapeForumTopics(i,s,"full");await window.saveTopicsToCache(i,s,t),r+=t.length,e++}catch(t){o++}}n=await ht(),c=[...n],u(),k(0===o?`Actualizaci√≥n forzada completada (${r} temas en ${e} lista(s))`:`Actualizaci√≥n forzada: ${e} exitosa(s), ${o} error(es)`)}catch(t){k("Error en la actualizaci√≥n forzada",!0)}}});const h=t.querySelector("#crg-delete-selected");h&&(h.onclick=async()=>{if(0===s.size)return void k("Selecciona al menos una lista para eliminar");const t=Array.from(s);if(t.includes("000")){const t=`¬øEliminar todos los temas desubicados (${window.Storage.get("CRG_StaleTopics",[]).length})?\n\nEsto no se puede deshacer.`;if(!confirm(t))return;try{window.Storage.set("CRG_StaleTopics",[]),k("Temas desubicados eliminados"),r.close(),Mt()}catch(t){k("Error al eliminar temas desubicados",!0)}return}const e=`¬øEliminar ${t.length} lista(s) en cach√© seleccionada(s)?\n\nEsto no se puede deshacer.`;if(confirm(e))try{for(const e of t){await window.subforumsDB.removeItem(e);const t=[];await window.topicsDB.iterate((n,o)=>{n.subforumId===e&&t.push(o)});for(const e of t)await window.topicsDB.removeItem(e)}n=await ht(),c=[...n];const e=new Set(n.map(t=>t.id));s=new Set([...s].filter(t=>e.has(t))),u(),k(`Eliminadas ${t.length} lista(s) en cach√©`)}catch(t){k("Error al eliminar listas en cach√©",!0)}}),t.addEventListener("change",t=>{const e=t.target;if("checkbox"===e.type){const t=e.getAttribute("data-id");t&&(e.checked?s.add(t):s.delete(t),u())}}),(async()=>{const e=window.Storage.get("CRG_StaleTopics",[]),n=t.querySelector("#crg-show-desubicados");n&&(e.length>0?(n.textContent=`Desubicados (${e.length})`,n.style.background="#dc3545",n.style.color="#fff"):(n.textContent="Desubicados",n.style.background="#17a2b8",n.style.color="#fff"))})();const x=t.querySelector("#crg-show-desubicados");x&&(x.onclick=()=>{const e=t.querySelector("#crg-subforum-filter");e&&(e.value="desubicados",g())});const w=t.querySelector("#crg-filter-comicteca");w&&(w.onclick=()=>{const e=t.querySelector("#crg-subforum-filter");e&&(e.value=":m:76",g())});const v=t.querySelector("#crg-filter-completos");v&&(v.onclick=()=>{const e=t.querySelector("#crg-subforum-filter");e&&(e.value=":m:81",g())});const S=t.querySelector("#crg-generate-merged");S&&(S.onclick=async()=>{if(0===s.size)return;const t=Array.from(s);if(t.includes("000")){const t=window.Storage.get("CRG_StaleTopics",[]);return 0===t.length?void k("No hay temas desubicados para mostrar"):(yt(t,JSON.parse(document.getElementById("crg-markers-data")?.textContent||"{}"),!0),Lt(t,["Desubicados"]),r.close(),void k(`Lista de temas desubicados generada con ${t.length} temas`))}const e=[],o=[];if(await window.topicsDB.iterate((r,a)=>{if(t.includes(r.subforumId)){const t={...r},a=n.find(t=>t.id===r.subforumId);a&&(t.subforumName=a.name,o.push(a.name)),e.push(t)}}),0===e.length)return void k("No se encontraron temas en las listas seleccionadas");const a=JSON.parse(document.getElementById("crg-markers-data")?.textContent||"{}");yt(e,a,!0),Lt(e,o),r.close(),k(`Lista combinada generada con ${e.length} temas`)}),t.querySelectorAll("th[data-col]").forEach(t=>{t.addEventListener("click",()=>{const e=parseInt(t.getAttribute("data-col")||"0");e>0&&p(e)})});let C=null;const E=t.querySelector("#crg-subforum-filter");E&&E.addEventListener("input",()=>{null!==C&&clearTimeout(C),C=window.setTimeout(g,300)});const $=()=>{const e=t.querySelector("#crg-toggle-selection");if(e){const t=c.every(t=>s.has(t.id));e.textContent=t?"‚òê Deseleccionar todo":"‚òë Seleccionar todo"}};u(),$()}async function zt(t=!1){let e=[];if(!t){const t=await ft();t&&(e=t,k("Lista cargada desde cach√©"))}if(0===e.length||t){const n=location.href.match(/showforum=(\d+)/)?.[1],o=Array.from(document.querySelectorAll("#navstrip a")).slice(2).map(t=>t.textContent?.trim().replace(/[^a-zA-Z0-9√Ä-√ø_]/g,"_")||"").join("_")||"root",r=await ft(),a=r&&r.length>0;if(!t&&a){k("Buscando actualizaciones...",!0);const t=r.length>0?Math.max(...r.map(t=>t.lastActionDate?.unix||0)):0;if(n&&o){const a=await vt(n,o,"incremental",t);if(0===a.newTopics.length&&0===a.updatedTopics.length)k("Este subforo no necesita actualizaci√≥n"),e=r;else{k(`Actualizaci√≥n incremental: ${a.newTopics.length} nuevos, ${a.updatedTopics.length} modificados`,!0);const t=new Map;r.forEach(e=>{const n=e.url.match(/showtopic=(\d+)/)?.[1];n&&t.set(n,e)});const i=[...r];for(const t of a.newTopics)i.push(t);for(const t of a.updatedTopics){const e=t.url.match(/showtopic=(\d+)/)?.[1];if(e){const n=i.findIndex(t=>t.url.match(/showtopic=(\d+)/)?.[1]===e);-1!==n&&(i[n]=t)}}e=i,await bt(n,o,a.newTopics,a.updatedTopics,r.length);const s=document.getElementById("crg-tooltip");s&&s.remove(),k(`Lista actualizada: ${a.newTopics.length} nuevos, ${a.updatedTopics.length} modificados`)}const i=await window.subforumsDB.getItem(n);i&&await window.subforumsDB.setItem(n,{...i,lastCached:Date.now()})}}else n&&o&&(e=await vt(n,o,"full"),await mt(e),k(`Lista completa generada: ${e.length} temas`));"function"==typeof window.updateCRGListButton&&await window.updateCRGListButton()}yt(e,JSON.parse(document.getElementById("crg-markers-data")?.textContent||"{}"),!0),Lt(e),k("Lista generada")}function Dt(t,e,n){let o,r,a;if(t/=360,n/=100,0==(e/=100))o=r=a=n;else{const i=(t,e,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+(e-t)*(2/3-n)*6:t),s=n<.5?n*(1+e):n+e-n*e,c=2*n-s;o=i(c,s,t+1/3),r=i(c,s,t),a=i(c,s,t-1/3)}const i=t=>Math.round(255*t).toString(16).padStart(2,"0");return`#${i(o)}${i(r)}${i(a)}`}function Ot(t){let e,n=parseInt(t.slice(1,3),16)/255,o=parseInt(t.slice(3,5),16)/255,r=parseInt(t.slice(5,7),16)/255,a=Math.max(n,o,r),i=Math.min(n,o,r),s=0,c=(a+i)/2;if(a===i)s=e=0;else{let t=a-i;switch(e=c>.5?t/(2-a-i):t/(a+i),a){case n:s=(o-r)/t+(o<r?6:0);break;case o:s=(r-n)/t+2;break;case r:s=(n-o)/t+4}s/=6}return[Math.round(360*s),Math.round(100*e),Math.round(100*c)]}async function Rt(t,e){if(e.useFlatColors)return{background:e.flatBackgroundColor,color:e.flatTextColor};let n=0;for(let e=0;e<t.length;e++)n+=.618033988749895*t.charCodeAt(e),n-=Math.floor(n);n-=Math.floor(n);const o=Math.floor((360*n+e.hueOffset)%360),r=e.saturation,a=e.lightness;return{background:`hsl(${o}, ${r}%, ${a}%)`,color:e.forceBlackText||a>60?"#000":"#fff"}}function Nt(t,e){const n=document.querySelector(`.star-preview[data-star="${t}"]`);n&&(n.style.backgroundColor=`hsl(${e[0]}, ${e[1]}%, ${e[2]}%)`)}function Ft(t,e){const n=e[t];document.querySelectorAll(".lm-tm").forEach(t=>{const e=t.className.match(/status-(\d)/)?.[1]||"0";t.textContent=n[e]||n[0]})}function Ht(t,e,n){const o=document.querySelector(t);o&&(o.value=e,n&&(o.oninput=()=>n(o.value)))}let Wt=null;function jt(t,e){const n=t.querySelector("#theme-color"),o=t.querySelector("#bold-text"),r=t.querySelector("#italic-text"),a=t.querySelector("#black-text"),i=t.querySelector("#flat-bg-color"),s=t.querySelector("#flat-text-color"),c=t.querySelector("#radius-dropdown"),l=t.querySelector("#shadow-dropdown");let d=e.hueOffset,u=e.saturation,p=e.lightness;if(n?.value){const[t,e,o]=Ot(n.value);d=t,u=e,p=o}return{...e,saturation:u,lightness:p,hueOffset:d,borderRadius:parseInt(c?.querySelector(".dropdown-trigger")?.textContent?.replace("px ‚ñº","")||"0"),fontWeight:o?.checked?700:400,fontStyle:r?.checked?"italic":"normal",boxShadow:[0,1,2,3].findIndex(t=>l?.querySelector(".dropdown-trigger")?.textContent?.includes(["Ninguna","Suave","Media","Fuerte"][t]))||0,forceBlackText:a?.checked||!1,useFlatColors:"flat"===t.querySelector('input[name="color-system"]:checked')?.value,flatBackgroundColor:i?.value||"#ffffff",flatTextColor:s?.value||"#000000"}}async function _t(){if(Wt)return void Wt.focus();if(!window.coreScriptLoaded&&!document.getElementById("crg-core-marker"))return void alert("Core script not detected.\n\nOpen the configuration on a page with visible badges.");const t=await ut(),e=document.createElement("div");e.id="crg-tag-config",e.style.cssText="padding:20px; font-family:Arial,sans-serif;",e.innerHTML=`\n    \x3c!-- WINDOW CONTENT CONTAINER --\x3e\n    <div class="crg-window-content">\n      \x3c!-- TAB NAVIGATION --\x3e\n      <div class="crg-tab-nav">\n        <button class="crg-tab-btn active" data-tab="etiquetas">Etiquetas</button>\n        <button class="crg-tab-btn" data-tab="marcadores">Marcadores</button>\n        <button class="crg-tab-btn" data-tab="ed2k">ED2K</button>\n        <button class="crg-tab-btn" data-tab="shortcuts">Shortcuts</button>\n      </div>\n\n      \x3c!-- TAB CONTENT CONTAINER WITH FIXED HEIGHT --\x3e\n      <div class="crg-tab-content">\n        \x3c!-- ETIQUETAS TAB --\x3e\n        <div id="tab-etiquetas" class="crg-tab-panel active">\n          <fieldset style="border:1px solid #ccc; border-radius:4px; margin-bottom:15px; padding:15px;">\n            <legend style="font-weight:bold; color:#333; padding:0 10px;">Etiquetas</legend>\n            <div style="margin-bottom:15px;">\n              <label style="margin-right:20px;">Bordes curvados:\n                <div class="custom-dropdown" id="radius-dropdown">\n                  <div class="dropdown-trigger">${t.borderRadius}px ‚ñº</div>\n                  <div class="dropdown-options">\n                    <div class="dropdown-option" data-value="0">0px</div>\n                    <div class="dropdown-option" data-value="2">2px</div>\n                    <div class="dropdown-option" data-value="4">4px</div>\n                    <div class="dropdown-option" data-value="6">6px</div>\n                    <div class="dropdown-option" data-value="8">8px</div>\n                  </div>\n                </div>\n              </label>\n              <label>Sombra:\n                <div class="custom-dropdown" id="shadow-dropdown">\n                  <div class="dropdown-trigger">${0===t.boxShadow?"Ninguna":1===t.boxShadow?"Suave":2===t.boxShadow?"Media":"Fuerte"} ‚ñº</div>\n                  <div class="dropdown-options">\n                    <div class="dropdown-option" data-value="0">Ninguna</div>\n                    <div class="dropdown-option" data-value="1">Suave</div>\n                    <div class="dropdown-option" data-value="2">Media</div>\n                    <div class="dropdown-option" data-value="3">Fuerte</div>\n                  </div>\n                </div>\n              </label>\n            </div>\n            <div style="margin-bottom:15px;">\n              <label style="margin-right:10px;"><input type="checkbox" id="bold-text" ${700===t.fontWeight?"checked":""}> <strong>Negrita</strong></label>\n              <label style="margin-right:10px;"><input type="checkbox" id="italic-text" ${"italic"===t.fontStyle?"checked":""}> <em>It√°lica</em></label>\n              <label><input type="checkbox" id="black-text" ${t.forceBlackText?"checked":""}> Forzar texto negro</label>\n            </div>\n          </fieldset>\n\n          \x3c!-- COLORES SECTION --\x3e\n          <fieldset style="border:1px solid #ccc; border-radius:4px; margin-bottom:15px; padding:15px;">\n            <legend style="font-weight:bold; color:#333; padding:0 10px;">Colores</legend>\n            <p style="margin-bottom: 15px; color: #666;">Selecciona uno de los dos sistemas para configurar los colores de las etiquetas</p>\n            <div style="margin-bottom:15px;">\n              <label style="margin-right:15px;">\n                <input type="radio" name="color-system" value="random" ${t.useFlatColors?"":"checked"}> Aleatorios\n              </label>\n              <label>\n                <input type="radio" name="color-system" value="flat" ${t.useFlatColors?"checked":""}> Planos\n              </label>\n            </div>\n            <div id="random-colors-section" style="display: ${t.useFlatColors?"none":"block"}; margin-bottom:25px;">\n              <div style="display: flex; align-items: center;">\n                <div style="flex: 0 0 100px; text-align: left; padding-right: 10px; padding-left: 4px;">\n                  Color base:\n                </div>\n                <input type="color" id="theme-color" style="margin-left:10px;width:40px;height:30px;border:none;">\n              </div>\n            </div>\n            <div id="flat-colors-section" style="display: ${t.useFlatColors?"block":"none"}; margin-bottom:15px;">\n              <div style="display: flex; gap: 20px;">\n                <label style="display: flex; align-items: center;">\n                  Color del texto:\n                  <input type="color" id="flat-text-color" style="margin-left:10px;width:40px;height:30px;border:none;">\n                </label>\n                <label style="display: flex; align-items: center;">\n                  Color de fondo:\n                  <input type="color" id="flat-bg-color" style="margin-left:10px;width:40px;height:30px;border:none;">\n                </label>\n              </div>\n            </div>\n          </fieldset>\n        </div>\n\n        \x3c!-- MARCADORES TAB --\x3e\n        <div id="tab-marcadores" class="crg-tab-panel">\n          \x3c!-- ICONOS DE ESTADO --\x3e\n          <fieldset style="border:1px solid #ccc; border-radius:4px; margin-bottom:15px; padding:15px;">\n            <legend style="font-weight:bold; color:#333; padding:0 10px;">Iconos de estado</legend>\n            <label style="display: block;">\n              Conjunto de iconos:\n              <div class="custom-dropdown" id="icon-set-dropdown" style="margin-top:5px;">\n                <div class="dropdown-trigger">Predeterminado ‚ñº</div>\n                <div class="dropdown-options">\n                  ${Z()}\n                </div>\n              </div>\n            </label>\n          </fieldset>\n\n          \x3c!-- COLORES DE LAS ESTRELLAS --\x3e\n          <fieldset style="border:1px solid #ccc; border-radius:4px; margin-bottom:15px; padding:15px;">\n            <legend style="font-weight:bold; color:#333; padding:0 10px;">Colores de las estrellas</legend>\n            <div style="display: flex; gap: 15px;">\n              <label style="display: flex; align-items: center;">\n                Media:\n                <input type="color" class="star-color" data-star="half" style="margin-left:10px;width:30px;height:25px;border:none;">\n              </label>\n              <label style="display: flex; align-items: center;">\n                Completa:\n                <input type="color" class="star-color" data-star="full" style="margin-left:10px;width:30px;height:25px;border:none;">\n              </label>\n              <label style="display: flex; align-items: center;">\n                Perfectas:\n                <input type="color" class="star-color" data-star="perfect" style="margin-left:10px;width:30px;height:25px;border:none;">\n              </label>\n            </div>\n          </fieldset>\n\n          \x3c!-- COMENTARIO --\x3e\n          <fieldset style="border:1px solid #ccc; border-radius:4px; margin-bottom:15px; padding:15px;">\n            <legend style="font-weight:bold; color:#333; padding:0 10px;">Comentario</legend>\n            <label style="display: flex; align-items: center;">\n              Indicador de comentario:\n              <input type="color" id="comment-dot-color" style="margin-left:10px;width:40px;height:30px;border:none;">\n            </label>\n          </fieldset>\n        </div>\n\n        \x3c!-- ED2K TAB --\x3e\n        <div id="tab-ed2k" class="crg-tab-panel">\n          <fieldset style="border:1px solid #ccc; border-radius:4px; margin-bottom:15px; padding:15px;">\n            <legend style="font-weight:bold; color:#333; padding:0 10px;">ED2K Links</legend>\n            <div style="margin-bottom:10px;">\n              <label style="display: block;">\n                <input type="checkbox" id="ed2k-enabled" ${t.ed2kEnabled?"checked":""}>\n                Mostrar bot√≥n/icono\n              </label>\n            </div>\n          </fieldset>\n\n          <fieldset style="border:1px solid #ccc; border-radius:4px; margin-bottom:55px; padding:20px;">  \x3c!-- 15 20 --\x3e\n            <legend style="font-weight:bold; color:#333; padding:0 10px;">Ajustes del bot√≥n</legend>\n\n            \x3c!-- Mode Selection --\x3e\n            <div style="margin-bottom:15px;">\n              <label style="margin-right:15px;">\n                <input type="radio" name="ed2k-mode" value="text" id="ed2k-mode-text" ${"text"===t.ed2kButton.mode?"checked":""}> Texto\n              </label>\n              <label>\n                <input type="radio" name="ed2k-mode" value="icon" id="ed2k-mode-icon" ${"icon"===t.ed2kButton.mode?"checked":""}> Icono\n              </label>\n            </div>\n\n            \x3c!-- Text Mode Settings --\x3e\n            <div id="ed2k-text-mode" style="display: ${"text"===t.ed2kButton.mode?"block":"none"};">\n              <div style="margin-bottom:15px;">\n                <label style="display: block;">\n                  Texto del bot√≥n:\n                  <input type="text" id="ed2k-button-text" style="margin-top:5px; width: calc(100% - 12px); max-width: 200px; padding:6px; border:1px solid #ccc; border-radius:4px;" value="${t.ed2kButton.buttonText}" placeholder="ED2K">\n                </label>\n              </div>\n\n              <div style="margin-bottom:15px;">\n                <label style="margin-right:20px;">Bordes curvados:\n                  <div class="custom-dropdown" id="ed2k-border-radius">\n                    <div class="dropdown-trigger" data-value="${t.ed2kButton.borderRadius}">${t.ed2kButton.borderRadius}px ‚ñº</div>\n                    <div class="dropdown-options">\n                      <div class="dropdown-option" data-value="0">0px</div>\n                      <div class="dropdown-option" data-value="2">2px</div>\n                      <div class="dropdown-option" data-value="4">4px</div>\n                      <div class="dropdown-option" data-value="6">6px</div>\n                      <div class="dropdown-option" data-value="8">8px</div>\n                    </div>\n                  </div>\n                </label>\n                <label>Sombra:\n                  <div class="custom-dropdown" id="ed2k-shadow">\n                    <div class="dropdown-trigger" data-value="${t.ed2kButton.boxShadow}">${0===t.ed2kButton.boxShadow?"Ninguna":1===t.ed2kButton.boxShadow?"Suave":2===t.ed2kButton.boxShadow?"Media":"Fuerte"} ‚ñº</div>\n                    <div class="dropdown-options">\n                      <div class="dropdown-option" data-value="0">Ninguna</div>\n                      <div class="dropdown-option" data-value="1">Suave</div>\n                      <div class="dropdown-option" data-value="2">Media</div>\n                      <div class="dropdown-option" data-value="3">Fuerte</div>\n                    </div>\n                  </div>\n                </label>\n              </div>\n              <div style="margin-bottom:15px;">\n                <label style="margin-right:10px;"><input type="checkbox" id="ed2k-bold" ${700===t.ed2kButton.fontWeight?"checked":""}> <strong>Negrita</strong></label>\n                <label style="margin-right:10px;"><input type="checkbox" id="ed2k-italic" ${"italic"===t.ed2kButton.fontStyle?"checked":""}> <em>It√°lica</em></label>\n                <label style="margin-right:20px;">Tama√±o:\n                  <div class="custom-dropdown" id="ed2k-font-size">\n                    <div class="dropdown-trigger" data-value="${t.ed2kButton.fontSize}">${t.ed2kButton.fontSize}px ‚ñº</div>\n                    <div class="dropdown-options">\n                      <div class="dropdown-option" data-value="10">10px</div>\n                      <div class="dropdown-option" data-value="12">12px</div>\n                      <div class="dropdown-option" data-value="14">14px</div>\n                      <div class="dropdown-option" data-value="16">16px</div>\n                      <div class="dropdown-option" data-value="18">18px</div>\n                    </div>\n                  </div>\n                </label>\n              </div>\n              <div style="margin-bottom:15px;">\n                <div style="display: flex; gap: 20px;">\n                  <label style="display: flex; align-items: center;">\n                    Color del texto:\n                    <input type="color" id="ed2k-text-color" style="margin-left:10px;width:40px;height:30px;border:none;">\n                  </label>\n                  <label style="display: flex; align-items: center;">\n                    Color de fondo:\n                    <input type="color" id="ed2k-bg-color" style="margin-left:10px;width:40px;height:30px;border:none;">\n                  </label>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- Icon Mode Settings --\x3e\n            <div id="ed2k-icon-mode" style="display: ${"icon"===t.ed2kButton.mode?"block":"none"};">\n              <div style="margin-bottom:15px;">\n                <label style="display: block;">\n                  Icono (emoji, SVG o base64):\n                  <input type="text" id="ed2k-icon-content" style="margin-top:5px; width: calc(100% - 12px); max-width: 200px; padding:6px; border:1px solid #ccc; border-radius:4px;" placeholder="üìã o data:image/... o <svg>...">\n                </label>\n                <small style="margin-top: 5px; color:#666; font-size:11px;">Usa emojis como üìã, im√°genes base64 que empiecen con 'data:image/', SVG que empiecen con &lt;svg&gt; o pega directamente etiquetas &lt;img&gt; de sitios web</small>\n              </div>\n              <div style="margin-bottom:15px;">\n                <label style="display: flex; align-items: center;">\n                  Tama√±o del icono:\n                  <input type="range" id="ed2k-icon-size" min="16" max="64" value="${t.ed2kButton.iconSize}" style="margin-left:10px; flex:1;">\n                  <span id="icon-size-display" style="margin-left:10px; min-width:35px;">${t.ed2kButton.iconSize}px</span>\n                </label>\n              </div>\n            </div>\n          </fieldset>\n        </div>\n\n        \x3c!-- SHORTCUTS TAB --\x3e\n        <div id="tab-shortcuts" class="crg-tab-panel">\n          <fieldset style="border:1px solid #ccc; border-radius:4px; margin-bottom:15px; padding:15px;">\n            <legend style="font-weight:bold; color:#333; padding:0 10px;">Atajos de Teclado</legend>\n            <div style="margin-bottom: 20px;">\n              Haz clic en una de las cajas de texto e introduce la combinaci√≥n de teclas deseada.\n            </div>\n            <div style="margin-bottom:15px;">\n              <label style="display: block; margin-bottom: 8px;">\n                <strong>Copias de Seguridad:</strong>\n                <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">\n                  <input type="text" id="shortcut-backup" readonly style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;" value="">\n                  <button id="clear-backup-shortcut" style="background: transparent; border: none; padding: 0; cursor: pointer;" title="Limpiar atajo">${s}</button>\n                </div>\n              </label>\n            </div>\n            <div style="margin-bottom:15px;">\n              <label style="display: block; margin-bottom: 8px;">\n                <strong>Agrupar Listas:</strong>\n                <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">\n                  <input type="text" id="shortcut-merge" readonly style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;" value="">\n                  <button id="clear-merge-shortcut" style="background: transparent; border: none; padding: 0; cursor: pointer;" title="Limpiar atajo">${s}</button>\n                </div>\n              </label>\n            </div>\n            <div style="margin-bottom:15px;">\n              <label style="display: block; margin-bottom: 8px;">\n                <strong>Configuraci√≥n:</strong>\n                <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">\n                  <input type="text" id="shortcut-graphics" readonly style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;" value="">\n                  <button id="clear-graphics-shortcut" style="background: transparent; border: none; padding: 0; cursor: pointer;" title="Limpiar atajo">${s}</button>\n                </div>\n              </label>\n            </div>\n            <div style="margin-bottom:15px;">\n              <label style="display: block; margin-bottom: 8px;">\n                <strong>Mostrar bot√≥n ED2K:</strong>\n                <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">\n                  <input type="text" id="shortcut-toggle-ed2k" readonly style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;" value="">\n                  <button id="clear-toggle-ed2k-shortcut" style="background: transparent; border: none; padding: 0; cursor: pointer;" title="Limpiar atajo">${s}</button>\n                </div>\n              </label>\n            </div>\n            <div style="margin-bottom:15px;">\n              <label style="display: block; margin-bottom: 8px;">\n                <strong>Copiar enlaces ED2K:</strong>\n                <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">\n                  <input type="text" id="shortcut-copy-ed2k" readonly style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9;" value="">\n                  <button id="clear-copy-ed2k-shortcut" style="background: transparent; border: none; padding: 0; cursor: pointer;" title="Limpiar atajo">${s}</button>\n                </div>\n              </label>\n            </div>\n          </fieldset>\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- FIXED FOOTER BUTTONS --\x3e\n    <div class="crg-panel-footer-fixed">\n      <button id="save-prefs" class="crg-button crg-btn-primary">Guardar</button>\n    </div>\n  `;const n=window.WinBox({title:"Configuraci√≥n",id:"crg-tag-config",width:"380px",height:"680px",x:"right",y:"center",right:20,mount:e,class:"modern",index:9999,background:"#343a40",onclose:()=>{Wt=null}});Wt=n,e.innerHTML+=`<style>${Q()}</style>`;const o=e.querySelector("#ed2k-icon-content");o&&(o.value=t.ed2kButton.iconContent||"üìã"),function(t){const e=t.querySelectorAll(".crg-tab-btn"),n=t.querySelectorAll(".crg-tab-panel");e.forEach(o=>{o.addEventListener("click",()=>{const r=o.getAttribute("data-tab");if(!r)return;e.forEach(t=>t.classList.remove("active")),n.forEach(t=>t.classList.remove("active")),o.classList.add("active");const a=t.querySelector(`#tab-${r}`);a&&a.classList.add("active")})})}(e),function(t){const e=t.querySelectorAll(".custom-dropdown");e.forEach(e=>{const n=e.querySelector(".dropdown-trigger"),o=e.querySelector(".dropdown-options");n&&o&&(n.addEventListener("click",n=>{n.stopPropagation(),t.querySelectorAll(".custom-dropdown.open").forEach(t=>{t!==e&&t.classList.remove("open")}),e.classList.toggle("open")}),o.querySelectorAll(".dropdown-option").forEach(t=>{t.addEventListener("click",()=>{const o=t.getAttribute("data-value")||t.getAttribute("data-set");if(o){const e=t.textContent?.split(":")[0]||t.textContent||"";n.textContent=e+" ‚ñº",n.dataset.value=o}e.classList.remove("open")})}))}),document.addEventListener("click",n=>{t.contains(n.target)||e.forEach(t=>t.classList.remove("open"))})}(e),function(t,e){const n={backup:t.querySelector("#shortcut-backup"),merge:t.querySelector("#shortcut-merge"),graphics:t.querySelector("#shortcut-graphics"),"toggle-ed2k":t.querySelector("#shortcut-toggle-ed2k"),"copy-ed2k":t.querySelector("#shortcut-copy-ed2k")},o={"toggle-ed2k":"toggleEd2kButton","copy-ed2k":"copyEd2kLinks"};Object.entries(n).forEach(([t,n])=>{if(n){const r=o[t]||t,a=e.keyboardShortcuts[r];n.value=X(a)}})}(e,t),function(t,e){t.querySelectorAll('.star-color:not([data-star="empty"])').forEach(t=>{const n=t.getAttribute("data-star");if(n&&"empty"!==n){const t=e.starColors[n],o=Dt(t[0],t[1],t[2]);Ht(`.star-color[data-star="${n}"]`,o,t=>{const e=Ot(t);Nt(n,e),function(t,e){document.querySelectorAll(".rating-stars").forEach(n=>{const o=n.querySelectorAll("svg"),r=parseFloat(n.dataset.rating||"0");o.forEach((n,o)=>{let a="empty";if(r>=o+.5&&(a=5===r?"perfect":r>=o+1?"full":"half"),a===t){const t=n.querySelector("path");t&&t.setAttribute("fill",`hsl(${e[0]}, ${e[1]}%, ${e[2]}%)`)}})})}(n,e)}),Nt(n,t)}})}(e,t),function(t,e){Ht("#comment-dot-color",e.commentDotColor,t=>{document.documentElement.style.setProperty("--comment-dot-color",t)})}(0,t),Ht("#theme-color",Dt(t.hueOffset,t.saturation,t.lightness)),Ht("#flat-text-color",t.flatTextColor),Ht("#flat-bg-color",t.flatBackgroundColor),Ht("#ed2k-text-color",t.ed2kButton.color),Ht("#ed2k-bg-color",t.ed2kButton.backgroundColor),function(t,e){const n=t.querySelector("#icon-set-dropdown");if(!n)return;const o=n.querySelector(".dropdown-trigger");if(!o)return;const r=function(t){for(const[e,n]of Object.entries(i))if(Pt(t,n))return e;return"default"}(e.iconSet);o.textContent=({default:"Predeterminado",minimal:"Minimal",circles:"C√≠rculos"}[r]||"Predeterminado")+" ‚ñº"}(e,t);const{cleanup:r}=function(t,e){let n=null;const o=o=>{if(!n)return;if(["Control","Shift","Alt","Meta"].includes(o.key))return;o.preventDefault(),o.stopPropagation();const r=t.querySelector(`#shortcut-${n}`);if(!r)return;const i={ctrl:o.ctrlKey||o.metaKey,shift:o.shiftKey,alt:o.altKey,key:o.key.toUpperCase()},s=a[n]||n;e.keyboardShortcuts[s]=i,r.value=X(i),r.classList.remove("shortcut-recording"),n=null,r.blur()},r={backup:t.querySelector("#shortcut-backup"),merge:t.querySelector("#shortcut-merge"),graphics:t.querySelector("#shortcut-graphics"),"toggle-ed2k":t.querySelector("#shortcut-toggle-ed2k"),"copy-ed2k":t.querySelector("#shortcut-copy-ed2k")},a={"toggle-ed2k":"toggleEd2kButton","copy-ed2k":"copyEd2kLinks"};Object.entries(r).forEach(([t,o])=>{o&&(o.addEventListener("focus",()=>{n=t,window.isRecordingShortcut=!0,o.classList.add("shortcut-recording"),o.value="Presiona una combinaci√≥n de teclas..."}),o.addEventListener("blur",()=>{if(n===t){n=null,window.isRecordingShortcut=!1,o.classList.remove("shortcut-recording");const r=e.keyboardShortcuts[t];o.value=X(r)}}))});const i={backup:t.querySelector("#clear-backup-shortcut"),merge:t.querySelector("#clear-merge-shortcut"),graphics:t.querySelector("#clear-graphics-shortcut"),"toggle-ed2k":t.querySelector("#clear-toggle-ed2k-shortcut"),"copy-ed2k":t.querySelector("#clear-copy-ed2k-shortcut")};return Object.entries(i).forEach(([t,n])=>{n&&n.addEventListener("click",()=>{const n=r[t];if(n){const o=a[t]||t;e.keyboardShortcuts[o]=null,n.value="No asignado"}})}),document.addEventListener("keydown",o),{cleanup:()=>{window.isRecordingShortcut=!1,document.removeEventListener("keydown",o)}}}(e,t),a=e.querySelector("#theme-color"),c=e.querySelector("#bold-text"),l=e.querySelector("#italic-text"),d=e.querySelector("#black-text"),u=e.querySelector("#flat-bg-color"),p=e.querySelector("#flat-text-color"),g=e.querySelector("#ed2k-enabled"),f=e.querySelector("#ed2k-bold"),b=e.querySelector("#ed2k-italic"),m=e.querySelector("#ed2k-text-color"),h=e.querySelector("#ed2k-bg-color"),y=e.querySelector("#ed2k-icon-size"),x=e.querySelector("#icon-size-display"),w=e.querySelector("#ed2k-button-text"),v=e.querySelector("#ed2k-icon-content"),S=()=>{!async function(t,e){const n=e.querySelector("#sat-val"),o=e.querySelector("#light-val"),r=e.querySelector("#hue-val");n&&(n.textContent=t.saturation.toString()),o&&(o.textContent=t.lightness.toString()),r&&(r.textContent=t.hueOffset.toString()),document.querySelectorAll(".tag-badge").forEach(async e=>{const n="#"+e.textContent,o=await Rt(n,t);e.style.background=o.background,e.style.color=o.color,e.style.border="1px solid rgba(0,0,0,0.2)",e.style.borderRadius=`${t.borderRadius}px`,e.style.fontWeight=t.fontWeight.toString(),e.style.fontStyle=t.fontStyle,e.style.boxShadow=0===t.boxShadow?"none":1===t.boxShadow?"0 1px 3px rgba(0,0,0,0.2)":2===t.boxShadow?"0 2px 6px rgba(0,0,0,0.25)":"0 4px 12px rgba(0,0,0,0.3)"})}(jt(e,t),e)};a&&(a.oninput=S),c&&(c.onchange=S),l&&(l.onchange=S),d&&(d.onchange=S),u&&(u.oninput=S),p&&(p.oninput=S);const C=()=>{!function(t,e){const n=document.querySelector(".ed2k-btn");if(!n)return;const o=Wt?function(t){const e=t.querySelector("#ed2k-mode-text"),n=t.querySelector("#ed2k-button-text"),o=t.querySelector("#ed2k-icon-content"),r=t.querySelector("#ed2k-icon-size"),a=t.querySelector("#ed2k-font-size .dropdown-trigger"),i=parseInt(a?.dataset.value||a?.textContent?.replace("px ‚ñº","")||"12",10),s=t.querySelector("#ed2k-bold")?.checked?700:400,c=t.querySelector("#ed2k-italic")?.checked?"italic":"normal",l=t.querySelector("#ed2k-border-radius .dropdown-trigger"),d=parseInt(l?.dataset.value||l?.textContent?.replace("px ‚ñº","")||"4",10),u=t.querySelector("#ed2k-shadow .dropdown-trigger"),p=u?.dataset.value?parseInt(u.dataset.value,10):[0,1,2,3].findIndex(t=>u?.textContent?.includes(["Ninguna","Suave","Media","Fuerte"][t]))||1,g=t.querySelector("#ed2k-text-color")?.value||"#ffffff",f=t.querySelector("#ed2k-bg-color")?.value||"#343a40";return{mode:e?.checked?"text":"icon",buttonText:n?.value?.trim()||"ED2K",fontSize:i,fontWeight:s,fontStyle:c,borderRadius:d,boxShadow:p>=0?p:1,color:g,backgroundColor:f,iconContent:o?.value?.trim()||"üìã",iconSize:parseInt(r?.value||"32")}}(t):e.ed2kButton;if("icon"===o.mode){const t=Kt(o.iconContent);if(t.toLowerCase().startsWith("<svg")){n.innerHTML=t;const e=n.querySelector("svg");e&&(e.style.width=`${o.iconSize}px`,e.style.height=`${o.iconSize}px`)}else t.startsWith("data:image/")?n.innerHTML=`<img src="${t}" style="width: ${o.iconSize}px; height: ${o.iconSize}px; object-fit: contain;" alt="ED2K">`:(n.textContent=t,n.style.fontSize=`${o.iconSize}px`);n.style.backgroundColor="transparent",n.style.border="none",n.style.boxShadow="none",n.style.borderRadius="0",n.style.color="inherit"}else n.textContent=o.buttonText.trim()||"ED2K",n.style.borderRadius=`${o.borderRadius}px`,n.style.boxShadow=["none","0 1px 2px rgba(0,0,0,0.3)","0 2px 4px rgba(0,0,0,0.4)","0 4px 8px rgba(0,0,0,0.5)"][o.boxShadow],n.style.fontWeight=o.fontWeight.toString(),n.style.fontStyle=o.fontStyle,n.style.fontSize=`${o.fontSize}px`,n.style.color=o.color,n.style.backgroundColor=o.backgroundColor}(e,t)};f&&(f.onchange=C),b&&(b.onchange=C),m&&(m.oninput=C),h&&(h.oninput=C),w&&w.addEventListener("input",()=>{const t=w.value.trim()||"ED2K",e=document.querySelector(".ed2k-btn");e&&(e.textContent=t,e.innerHTML="")}),v&&v.addEventListener("input",()=>{const t=Kt(v.value.trim()||"üìã"),e=document.querySelector(".ed2k-btn");if(e)if(t.toLowerCase().startsWith("<svg")){e.innerHTML=t;const n=e.querySelector("svg");if(n){const t=parseInt(y?.value||"32");n.style.width=`${t}px`,n.style.height=`${t}px`}}else t.startsWith("data:image/")?e.innerHTML=`<img src="${t}" style="width: ${parseInt(y?.value||"32")}px; height: ${parseInt(y?.value||"32")}px; object-fit: contain;" alt="ED2K">`:(e.textContent=t,e.innerHTML="")}),e.querySelectorAll('input[name="ed2k-mode"]').forEach(t=>{t.addEventListener("change",()=>{const n=t.value,o=e.querySelector("#ed2k-text-mode"),r=e.querySelector("#ed2k-icon-mode");o&&(o.style.display="text"===n?"block":"none"),r&&(r.style.display="icon"===n?"block":"none"),C()})}),y&&x&&y.addEventListener("input",()=>{const t=parseInt(y.value);x.textContent=`${t}px`,C()}),[e.querySelector("#ed2k-border-radius"),e.querySelector("#ed2k-shadow"),e.querySelector("#ed2k-font-size")].forEach(t=>{if(!t)return;const e=t.querySelector(".dropdown-options");e&&e.querySelectorAll(".dropdown-option").forEach(e=>{e.addEventListener("mouseenter",()=>{const n=t.id;!function(t,e){const n=document.querySelector(".ed2k-btn");if(n)if(n._originalStyles||(n._originalStyles={borderRadius:n.style.borderRadius,boxShadow:n.style.boxShadow,fontSize:n.style.fontSize}),"ed2k-border-radius"===e)n.style.borderRadius=`${t}px`;else if("ed2k-shadow"===e){const e=["none","0 1px 2px rgba(0,0,0,0.3)","0 2px 4px rgba(0,0,0,0.4)","0 4px 8px rgba(0,0,0,0.5)"];n.style.boxShadow=e[t]||e[1]}else"ed2k-font-size"===e&&(n.style.fontSize=`${t}px`)}(parseInt(e.getAttribute("data-value")||"0"),n)}),e.addEventListener("click",()=>{C()})})}),g&&(g.onchange=async()=>{const t=g.checked;try{const e=await ut();e.ed2kEnabled=t,await pt(e);const{updateEd2kButtonVisibility:n}=await Promise.resolve().then(function(){return ne});await n(t),k(t?"Bot√≥n ED2K habilitado":"Bot√≥n ED2K deshabilitado")}catch(t){k("Error al cambiar estado del bot√≥n ED2K")}}),e.querySelectorAll('input[name="color-system"]').forEach(t=>{t.onchange=()=>{const n=t.value,o=e.querySelector("#random-colors-section"),r=e.querySelector("#flat-colors-section"),a=e.querySelector("#black-text");o&&(o.style.display="random"===n?"block":"none"),r&&(r.style.display="flat"===n?"block":"none"),a&&(a.disabled="flat"===n),S()}});const E=e.querySelector("#radius-dropdown"),$=e.querySelector("#shadow-dropdown");[E,$].forEach(n=>{if(!n)return;const o=n.querySelector(".dropdown-options");o&&o.querySelectorAll(".dropdown-option").forEach(o=>{o.addEventListener("mouseenter",()=>{!async function(t,e,n){const o={...n};"radius-dropdown"===e?o.borderRadius=t:"shadow-dropdown"===e&&(o.boxShadow=t),document.querySelectorAll(".tag-badge").forEach(async t=>{const e="#"+t.textContent,n=await Rt(e,o);t.style.background=n.background,t.style.color=n.color,t.style.border="1px solid rgba(0,0,0,0.2)",t.style.borderRadius=`${o.borderRadius}px`,t.style.fontWeight=o.fontWeight.toString(),t.style.fontStyle=o.fontStyle,t.style.boxShadow=0===o.boxShadow?"none":1===o.boxShadow?"0 1px 3px rgba(0,0,0,0.2)":2===o.boxShadow?"0 2px 6px rgba(0,0,0,0.25)":"0 4px 12px rgba(0,0,0,0.3)"})}(parseInt(o.getAttribute("data-value")||"0"),n.id,jt(e,t))}),o.addEventListener("click",()=>{S()})})});const B=e.querySelector("#icon-set-dropdown");if(B){const t=B.querySelector(".dropdown-options");t&&t.querySelectorAll(".dropdown-option").forEach(t=>{t.addEventListener("mouseenter",()=>{Ft(t.getAttribute("data-set")||"default",i)}),t.addEventListener("click",()=>{Ft(t.getAttribute("data-set")||"default",i)})})}const T=e.querySelector("#save-prefs");T&&(T.onclick=async()=>{!function(t,e){const n={empty:e.starColors.empty,half:e.starColors.half,full:e.starColors.full,perfect:e.starColors.perfect};t.querySelectorAll('.star-color:not([data-star="empty"])').forEach(t=>{const e=t.getAttribute("data-star");if(e&&"empty"!==e&&["half","full","perfect"].includes(e)){const o=Ot(t.value);n[e]=o}}),e.starColors=n}(e,t);const o=e.querySelector("#theme-color");let r=t.hueOffset,a=t.saturation,i=t.lightness;if(o?.value){const[t,e,n]=Ot(o.value);r=t,a=e,i=n}const s={saturation:a,lightness:i,hueOffset:r,borderWidth:1,borderRadius:parseInt(E?.querySelector(".dropdown-trigger")?.textContent?.replace("px ‚ñº","")||"0"),fontWeight:c?.checked?700:400,fontStyle:l?.checked?"italic":"normal",boxShadow:[0,1,2,3].findIndex(t=>$?.querySelector(".dropdown-trigger")?.textContent?.includes(["Ninguna","Suave","Media","Fuerte"][t]))||0,forceBlackText:d?.checked||!1,useFlatColors:"flat"===e.querySelector('input[name="color-system"]:checked')?.value,flatBackgroundColor:u?.value||"#ffffff",flatTextColor:p?.value||"#000000",commentDotColor:e.querySelector("#comment-dot-color")?.value||t.commentDotColor,starColors:t.starColors,iconSet:Gt(e),keyboardShortcuts:t.keyboardShortcuts,ed2kEnabled:e.querySelector("#ed2k-enabled")?.checked||!1,ed2kButton:{mode:e.querySelector("#ed2k-mode-icon")?.checked?"icon":"text",positioning:t.ed2kButton.positioning,position:(()=>{const e=sessionStorage.getItem("crg-ed2k-position");if(e)try{const t=JSON.parse(e);return sessionStorage.removeItem("crg-ed2k-position"),t}catch(t){}return t.ed2kButton.position})(),buttonText:e.querySelector("#ed2k-button-text")?.value?.trim()||"ED2K",fontSize:parseInt(e.querySelector("#ed2k-font-size .dropdown-trigger")?.textContent?.replace("px ‚ñº","")||"12"),fontWeight:e.querySelector("#ed2k-bold")?.checked?700:400,fontStyle:e.querySelector("#ed2k-italic")?.checked?"italic":"normal",borderRadius:parseInt(e.querySelector("#ed2k-border-radius .dropdown-trigger")?.textContent?.replace("px ‚ñº","")||"4"),boxShadow:[0,1,2,3].findIndex(t=>e.querySelector("#ed2k-shadow .dropdown-trigger")?.textContent?.includes(["Ninguna","Suave","Media","Fuerte"][t]))||1,color:e.querySelector("#ed2k-text-color")?.value||"#ffffff",backgroundColor:e.querySelector("#ed2k-bg-color")?.value||"#343a40",iconContent:e.querySelector("#ed2k-icon-content")?.value?.trim()||"üìã",iconSize:parseInt(e.querySelector("#ed2k-icon-size")?.value||"32")}};await pt(s),window.updateGlobalTagStyles&&window.updateGlobalTagStyles(),window.updateGlobalKeyboardShortcuts&&await window.updateGlobalKeyboardShortcuts(),k("¬°Preferencias guardadas correctamente!"),n.close(!0)}),n.onclose=()=>{r(),Wt=null}}function Gt(t){const e=t.querySelector("#icon-set-dropdown");if(!e)return i.default;const n=e.querySelector(".dropdown-trigger");if(!n)return i.default;const o=n.textContent?.replace(" ‚ñº","")||"";return i[{Predeterminado:"default",Minimal:"minimal","C√≠rculos":"circles"}[o]||"default"]||i.default}function Kt(t){const e=t.trim();if(e.toLowerCase().startsWith("<svg"))return e;const n=e.match(/<img[^>]+src=["']([^"']*data:image\/[^"']*)["'][^>]*>/i);return n?n[1]:e}function Pt(t,e){if(t===e)return!0;if(null==t||null==e)return!1;if("object"!=typeof t||"object"!=typeof e)return!1;const n=Object.keys(t),o=Object.keys(e);if(n.length!==o.length)return!1;for(const r of n)if(!o.includes(r)||t[r]!==e[r])return!1;return!0}function Yt(){const{valid:t,broken:e}=function(){const t=new Set;let e=0;const n=document.documentElement.outerHTML.matchAll(/ed2k:\/\/\|file\|[^|]+?\|\d+?\|[0-9A-Fa-f]{32}(?:\|[^|]*?)?\|\/(?:\|sources,[^|]*:\d+\|\/)?/gi);for(const o of Array.from(n)){const n=Jt(o[0]);n.valid?t.add(n.url):e++}return document.querySelectorAll('a[href^="ed2k://"], area[href^="ed2k://"], *[ref^="ed2k://"]').forEach(n=>{const o=n.href||n.getAttribute("ref")||"",r=Jt(o);r.valid?t.add(r.url):o.includes("ed2k://")&&e++}),{valid:Array.from(t),broken:e}}(),n=t.length;if(0!==n)try{"function"==typeof GM_setClipboard?(GM_setClipboard(t.join("\n"),"text"),k(`Se han copiado ${n} eLinks v√†lido${n>1?"s":""}!${e>0?` (${e} broken ignored)`:""}`)):navigator.clipboard.writeText(t.join("\n")).then(()=>{k(`Copied ${n} valid link${n>1?"s":""}!${e>0?` (${e} broken ignored)`:""}`)}).catch(()=>{k("Failed to copy to clipboard")})}catch(t){k("Failed to copy to clipboard")}else k("No se han encontrado eLinks v√°lidos"+(e>0?` (${e} broken detected)`:""))}function Jt(t,e){let n=(o=t.trim(),Vt.innerHTML=o,Vt.value);var o;const r=n.split("|");if(r.length<5||!/^\d+$/.test(r[3])||!/^[0-9A-Fa-f]{32}$/.test(r[4]))return{valid:!1,url:n};let a=r[2];a=a.replace(/%(?![0-9A-Fa-f]{2})/g,"%25");try{a=decodeURIComponent(a)}catch(t){a=unescape(a)}return r[2]=encodeURIComponent(a),n=r.join("|").replace(/\|+$/,"|"),n.endsWith("/")||(n+="/"),{valid:!0,url:n}}const Vt=document.createElement("textarea");async function Ut(){window.top===window.self&&"function"==typeof GM_registerMenuCommand&&GM_registerMenuCommand("üí† Configuraci√≥n",_t),await async function(){try{const t=await ut();Xt=t.keyboardShortcuts,function(){const t=(t,e)=>!!e&&e.ctrl===(t.ctrlKey||t.metaKey)&&e.shift===t.shiftKey&&e.alt===t.altKey&&e.key===t.key.toUpperCase();document.addEventListener("keydown",e=>{if(!window.isRecordingShortcut)return e.ctrlKey&&e.altKey&&e.key.toUpperCase(),t(e,Xt.backup)?(e.preventDefault(),e.stopImmediatePropagation(),void lt()):t(e,Xt.merge)?(e.preventDefault(),e.stopImmediatePropagation(),void Mt()):t(e,Xt.graphics)?(e.preventDefault(),e.stopImmediatePropagation(),void _t()):t(e,Xt.toggleEd2kButton)?(e.preventDefault(),e.stopImmediatePropagation(),void async function(){try{const t=await ut(),e=!t.ed2kEnabled;t.ed2kEnabled=e,await pt(t),await Zt(e),function(t){const e=document.querySelector("#ed2k-enabled");e&&(e.checked=t)}(e),k(e?"Bot√≥n ED2K habilitado":"Bot√≥n ED2K deshabilitado")}catch(t){k("Error al cambiar estado del bot√≥n ED2K")}}()):t(e,Xt.copyEd2kLinks)?(e.preventDefault(),e.stopImmediatePropagation(),void Yt()):void 0},{capture:!0,passive:!1})}()}catch(t){}}();try{const t=await ut();await Zt(t.ed2kEnabled)}catch(t){}}let Xt={backup:null,merge:null,graphics:null,toggleEd2kButton:null,copyEd2kLinks:null};async function Zt(t){const e=document.querySelector(".ed2k-btn");if(function(){if(document.querySelector("#crg-ed2k-styles"))return;const t=document.createElement("style");t.id="crg-ed2k-styles",t.textContent="\n    .ed2k-btn {\n      position: fixed;\n      z-index: 9999;\n      padding: 4px 8px;\n      background: #343a40;\n      color: #ffffff;\n      border: 1px solid #000;\n      border-radius: 4px;\n      font: 12px Arial;\n      cursor: pointer;\n      user-select: none;\n    }\n\n    .ed2k-btn.dragging {\n      opacity: 0.8;\n      cursor: move !important;\n      box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n    }\n  ",document.head.appendChild(t)}(),t){const t=await ut();if(!e){const e=document.createElement("button");if(e.className="ed2k-btn",e.title="Copiar eLinks al portapapeles\nSHIFT+CLICK mueve el bot√≥n/icono a otra posici√≥n\nCTRL+CLICK fija el bot√≥n/icono a una posici√≥n","icon"===t.ed2kButton.mode){const n=Qt(t.ed2kButton.iconContent);if(n.toLowerCase().startsWith("<svg")){e.innerHTML=n;const o=e.querySelector("svg");o&&(o.style.width=`${t.ed2kButton.iconSize}px`,o.style.height=`${t.ed2kButton.iconSize}px`)}else n.startsWith("data:image/")?e.innerHTML=`<img src="${n}" style="width: ${t.ed2kButton.iconSize}px; height: ${t.ed2kButton.iconSize}px; object-fit: contain;" alt="ED2K">`:e.textContent=n}else e.textContent=t.ed2kButton.buttonText;document.body.appendChild(e);let n=!1;e.addEventListener("click",async t=>{if(t.ctrlKey){t.preventDefault(),t.stopPropagation();const e=await ut(),n="fixed"===e.ed2kButton.positioning?"absolute":"fixed";return e.ed2kButton.positioning=n,await pt(e),await te(),void k("Bot√≥n ED2K: modo "+("fixed"===n?"flotante":"fijo"))}if(n)return t.preventDefault(),t.stopPropagation(),void(n=!1);e.classList.contains("dragging")||Yt()}),function(t,e){let n=!1,o=0,r=0,a=0,i=0;t.addEventListener("mousedown",s=>{if(e&&e(s.shiftKey),!s.shiftKey)return;s.preventDefault(),s.stopPropagation(),n=!0,o=s.clientX,r=s.clientY;const c=t.getBoundingClientRect();a=c.left,i=c.top,t.classList.add("dragging"),k("Arrastrando bot√≥n ED2K - suelta para colocar")});document.addEventListener("mousemove",e=>{if(!n)return;e.preventDefault();const s=e.clientX-o,c=e.clientY-r,l=Math.max(0,Math.min(window.innerWidth-t.offsetWidth,a+s)),d=Math.max(0,Math.min(window.innerHeight-t.offsetHeight,i+c));t.style.left=`${l}px`,t.style.top=`${d}px`,t.style.right="auto",t.style.bottom="auto";const u={top:d,left:l};sessionStorage.setItem("crg-ed2k-position",JSON.stringify(u))}),document.addEventListener("mouseup",async()=>{if(!n)return;n=!1,t.classList.remove("dragging");const e=t.getBoundingClientRect(),o={top:Math.round(e.top),left:Math.round(e.left)};try{const t=await ut();t.ed2kButton.position=o,await pt(t),sessionStorage.removeItem("crg-ed2k-position"),k("Posici√≥n guardada")}catch(t){k("Error al guardar posici√≥n")}})}(e,t=>{n=t})}await te(),function(){let t;ee();const e=()=>{clearTimeout(t),t=window.setTimeout(()=>{te()},100)};window.ed2kResizeHandler=e,window.addEventListener("resize",e)}()}else e&&e.remove(),ee()}function Qt(t){const e=t.trim();if(e.toLowerCase().startsWith("<svg"))return e;const n=e.match(/<img[^>]+src=["']([^"']*data:image\/[^"']*)["'][^>]*>/i);return n?n[1]:e}async function te(){const t=document.querySelector(".ed2k-btn");if(t)try{const e=(await ut()).ed2kButton;let n=e.position;const o=sessionStorage.getItem("crg-ed2k-position");if(o)try{n=JSON.parse(o)}catch(t){}let r="number"==typeof n.left?Math.round(n.left):10;const a="number"==typeof n.top?Math.round(n.top):10;let i=r;if("fixed"===e.positioning){const e=t.offsetWidth||60,n=12,o=window.innerWidth-e-n;r>o&&(i=Math.max(8,o))}if("absolute"===e.positioning){t.style.position="absolute";const e=window.pageYOffset||document.documentElement.scrollTop,n=window.pageXOffset||document.documentElement.scrollLeft;t.style.left=`${i+n}px`,t.style.top=`${a+e}px`}else t.style.position="fixed",t.style.left=`${i}px`,t.style.top=`${a}px`;t.style.right="auto",t.style.bottom="auto";const s=["none","0 1px 2px rgba(0,0,0,0.3)","0 2px 4px rgba(0,0,0,0.4)","0 4px 8px rgba(0,0,0,0.5)"];if("icon"===e.mode){const n=Qt(e.iconContent);if(n.toLowerCase().startsWith("<svg")){t.innerHTML=n;const o=t.querySelector("svg");o&&(o.style.width=`${e.iconSize}px`,o.style.height=`${e.iconSize}px`)}else n.startsWith("data:image/")?t.innerHTML=`<img src="${n}" style="width: ${e.iconSize}px; height: ${e.iconSize}px; object-fit: contain;" alt="ED2K">`:(t.textContent=n,t.style.fontSize=`${e.iconSize}px`);t.style.backgroundColor="transparent",t.style.border="none",t.style.boxShadow="none",t.style.borderRadius="0",t.style.color="inherit"}else t.textContent=e.buttonText.trim()||"ED2K",t.style.borderRadius=`${e.borderRadius}px`,t.style.boxShadow=s[e.boxShadow],t.style.fontWeight=e.fontWeight.toString(),t.style.fontStyle=e.fontStyle,t.style.fontSize=`${e.fontSize}px`,t.style.color=e.color,t.style.backgroundColor=e.backgroundColor}catch(t){}}function ee(){const t=window.ed2kResizeHandler;t&&(window.removeEventListener("resize",t),delete window.ed2kResizeHandler)}window.updateGlobalKeyboardShortcuts=async function(){try{const t=await ut();Xt=t.keyboardShortcuts}catch(t){}};var ne=Object.freeze({__proto__:null,applyCurrentEd2kButtonStyling:te,formatShortcut:X,generateIconSetOptions:Z,getTagColorPrefs:ut,getTagColorsWithPrefs:Rt,hexToHsl:Ot,hslToHex:Dt,initUX:Ut,openTagColorConfig:_t,updateEd2kButtonVisibility:Zt});window.loadFromCache=ft,window.saveToCache=mt,window.saveChangedTopicsSelectively=bt,window.clearAllCache=async function(){try{await n.clear(),await o.clear(),gt.delete("CRG_CacheData")}catch(t){}},window.saveTopicsToCache=async function(t,e,r){try{const a=[];await o.iterate((e,n)=>{e.subforumId===t&&a.push(e)});const i=new Set(r.map(t=>t.url.match(/showtopic=(\d+)/)?.[1]).filter(Boolean)),s=a.filter(t=>!i.has(t.id));if(s.length,s.length>0){const t=gt.get(y,[]),e=new Set(t.map(t=>t.id)),n=s.filter(t=>!e.has(t.id));if(n.length>0){for(const t of n)await o.removeItem(t.id);const e=[...t,...n];gt.set(y,e)}}const c=["76","81"].includes(t)?t:"76",l=["76",t],d=["La mansi√≥n del CRG",e];await n.setItem(t,{id:t,name:e,parentId:l[l.length-2]||null,rootId:c,pathIds:l,pathNames:d,topicCount:r.length,lastCached:Date.now()});for(const e of r){const n=e.url.match(/showtopic=(\d+)/)?.[1];n&&(e.id=n,e.subforumId=t,e.rootId=c,e.pathIds=l,e.pathNames=d,await o.setItem(n,e))}}catch(t){}},window.scrapeForumTopics=vt,window.showMergePanel=Mt,window.showTopicsPopup=Lt,window.updateTopicData=function(t,e,n,o,r){const a=document.head.querySelector("#crg-markers-data");if(a){const r=JSON.parse(a.textContent||"{}");r[t]={status:e,rating:n,comment:o},a.textContent=JSON.stringify(r)}if(window.crgCurrentTopics&&window.crgOriginalTopics){const a=t=>{t.status=e,t.rating=n,t.comment=o,t.tags=r},i=window.crgCurrentTopics.find(e=>e.url.match(/showtopic=(\d+)/)?.[1]===t);i&&a(i);const s=window.crgOriginalTopics.find(e=>e.url.match(/showtopic=(\d+)/)?.[1]===t);s&&a(s)}const i=document.getElementById("crg-list-popup");i&&"function"==typeof window.addCRGMarkerToLink&&i.querySelectorAll('#virtual-rows a[href*="showtopic="]').forEach(e=>{const n=e.href.match(/showtopic=(\d+)/)?.[1];n===t&&window.addCRGMarkerToLink(e)})},window.enrichTopicsWithMarkers=yt,window.normalizeText=v,window.subforumsDB=n,window.topicsDB=o,window.Storage=gt,window._crgSuiteInitialized||(window._crgSuiteInitialized=!0,(async()=>{try{await async function(){window.coreScriptLoaded=!0,function(){const t=document.createElement("style");t.textContent="\n    .lm-tm {\n      cursor: pointer;\n      margin-left: 6px;\n      user-select: none;\n      position: relative;\n      font-size: 0.9em;\n    }\n    .lm-tm.has-comment::before {\n      content: '‚óè';\n      position: absolute;\n      top: -9px;\n      left: 50%;\n      transform: translateX(-49.7%);\n      font-size: 5px;\n      color: var(--comment-dot-color, green);\n      pointer-events: none;\n      z-index: 1;\n    }\n    .rating-stars {\n      cursor: pointer;\n      margin-left: 4px;\n    }\n    .rating-stars svg {\n      pointer-events: none;\n    }\n    .tag-badges {\n      margin-left: 4px;\n      font-size: 0.7em;\n    }\n    .tag-badge {\n      display: inline-block;\n      background: #e0e0e0;\n      padding: 1px 3px;\n      margin: 0 2px;\n      border-radius: 3px;\n      color: #333;\n      font-weight: bold;\n    }\n  ",document.head.appendChild(t);const e=document.createElement("style");e.id="crg-tagbadge-dynamic",e.textContent="\n    .tag-badge {\n      border: 1px solid rgba(0,0,0,0.2);\n      border-radius: 3px;\n      font-weight: 700;\n      box-shadow: 0 1px 3px rgba(0,0,0,0.2);\n    }\n  ",document.head.appendChild(e);const n=document.createElement("style");n.id="crg-notification-styles",n.textContent="\n    /* Base notification class with CSS variables for customization */\n    .crg-notification {\n      position: var(--notif-position, fixed);\n      top: var(--notif-top, 10px);\n      right: var(--notif-right, 10px);\n      bottom: var(--notif-bottom, auto);\n      left: var(--notif-left, auto);\n      background: var(--notif-bg, #343a40);\n      color: var(--notif-color, #fff);\n      padding: var(--notif-padding, 8px 16px);\n      border-radius: var(--notif-radius, 4px);\n      font-size: var(--notif-font-size, 14px);\n      font-weight: var(--notif-font-weight, normal);\n      z-index: var(--notif-z-index, 10000);\n      box-shadow: var(--notif-shadow, 0 2px 8px rgba(0,0,0,0.3));\n      border: var(--notif-border, none);\n      max-width: var(--notif-max-width, 400px);\n      text-align: var(--notif-text-align, left);\n      pointer-events: none;\n      user-select: none;\n      opacity: 0;\n      transform: translateY(-10px);\n      transition: all 0.3s ease;\n    }\n\n    .crg-notification.show {\n      opacity: 1;\n      transform: translateY(0);\n    }\n\n    /* Notification variants */\n    .crg-notification-success {\n      --notif-bg: #28a745;\n      --notif-color: #fff;\n    }\n\n    .crg-notification-error {\n      --notif-bg: #dc3545;\n      --notif-color: #fff;\n    }\n\n    .crg-notification-warning {\n      --notif-bg: #ffc107;\n      --notif-color: #000;\n    }\n\n    .crg-notification-info {\n      --notif-bg: #17a2b8;\n      --notif-color: #fff;\n    }\n\n    /* Position variants */\n    .crg-notification-top-left {\n      --notif-top: 10px;\n      --notif-right: auto;\n      --notif-left: 10px;\n    }\n\n    .crg-notification-top-center {\n      --notif-top: 10px;\n      --notif-right: 50%;\n      --notif-left: 50%;\n      --notif-text-align: center;\n      transform: translateX(-50%) translateY(-10px);\n    }\n\n    .crg-notification-top-center.show {\n      transform: translateX(-50%) translateY(0);\n    }\n\n    .crg-notification-bottom-right {\n      --notif-top: auto;\n      --notif-bottom: 10px;\n      --notif-left: auto;\n      --notif-right: 10px;\n      transform: translateY(10px);\n    }\n\n    .crg-notification-bottom-right.show {\n      transform: translateY(0);\n    }\n\n    .crg-notification-bottom-center {\n      --notif-top: auto;\n      --notif-bottom: 10px;\n      --notif-left: 50%;\n      --notif-right: 50%;\n      --notif-text-align: center;\n      transform: translateX(-50%) translateY(10px);\n    }\n\n    .crg-notification-bottom-center.show {\n      transform: translateX(-50%) translateY(0);\n    }\n\n    /* Size variants */\n    .crg-notification-compact {\n      --notif-padding: 4px 8px;\n      --notif-font-size: 12px;\n    }\n\n    .crg-notification-large {\n      --notif-padding: 12px 20px;\n      --notif-font-size: 16px;\n    }\n  ",document.head.appendChild(n)}(),function(){const t=document.createElement("div");t.id="crg-core-marker",t.style.display="none",document.documentElement.appendChild(t)}();const t=await ut();A(t),function(t){U=t}(t),R(await r()),function(){const t=U,e=document.getElementById("crg-tagbadge-dynamic");e&&(e.textContent=`.tag-badge {\n      border: ${t.borderWidth}px solid rgba(0,0,0,0.2);\n      border-radius: ${t.borderRadius}px;\n      font-weight: ${t.fontWeight};\n      font-style: ${t.fontStyle};\n      box-shadow: ${0==t.boxShadow?"none":1==t.boxShadow?"0 1px 3px rgba(0,0,0,0.2)":2==t.boxShadow?"0 2px 6px rgba(0,0,0,0.25)":"0 4px 12px rgba(0,0,0,0.3)"};\n    }`),document.documentElement.style.setProperty("--comment-dot-color",t.commentDotColor)}(),function(){const t=U;t.useFlatColors?document.querySelectorAll(".tag-badge").forEach(e=>{e.style.background=t.flatBackgroundColor,e.style.color=t.flatTextColor}):document.querySelectorAll(".tag-badge").forEach(e=>{const n="#"+e.textContent.trim();let o=0;for(let t=0;t<n.length;t++)o+=.618033988749895*n.charCodeAt(t),o-=Math.floor(o);o-=Math.floor(o);const r=`hsl(${Math.floor((360*o+t.hueOffset)%360)}, ${t.saturation}%, ${t.lightness}%)`,a=t.forceBlackText||t.lightness>60?"#000":"#fff";e.style.background=r,e.style.color=a})}();const{initializeMarkerInjection:e}=await Promise.resolve().then(function(){return V});e();const n=document.createElement("script");n.type="application/json",n.id="crg-markers-data",n.textContent=N(),document.head.appendChild(n),window.top===window.self&&GM_registerMenuCommand("üíæ Copias de Seguridad",async()=>{const{showBackupPanel:t}=await Promise.resolve().then(function(){return dt});await t()}),setTimeout(ct,1e4)}(),await async function(){window.top===window.self&&GM_registerMenuCommand("üìã Agrupar Listas",Mt),function(){const t=Array.from(document.querySelectorAll("#navstrip a"));if(t.length<1)return!1;const e=t[1],n=e?.href.match(/showforum=(\d+)/)?.[1];return!!n&&m.includes(n)}()&&function(){const t=location.href.match(/showforum=(\d+)/)?.[1];return!!t&&!h.includes(t)}()&&function(){const t=document.getElementById("navstrip");if(!t)return;const e=document.createElement("div");e.style.cssText="display:inline;margin-left:10px;";const n=document.createElement("button");n.style.cssText="padding:4px 8px;background:#343a40;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;";const o=async()=>{await ft()?(n.innerHTML='Lista <svg width="10" height="10"><circle cx="5" cy="5" r="4" fill="#479ee5"/></svg>',n.onclick=async t=>{if(t.ctrlKey){const t=location.href.match(/showforum=(\d+)/)?.[1],e=Array.from(document.querySelectorAll("#navstrip a")).slice(2).map(t=>t.textContent?.trim().replace(/[^a-zA-Z0-9√Ä-√ø_]/g,"_")||"").join("_")||"root";if(!t)return void k("No se pudo determinar el ID del foro",!0);try{const n=await async function(t,e){k("Actualizando lista...",!0);const n=[];await window.topicsDB.iterate((e,o)=>{e.subforumId===t&&n.push(e)});const o=n.length>0?Math.max(...n.map(t=>t.lastActionDate?.unix||0)):0,r=await vt(t,e,"incremental",o),a=new Map;n.forEach(t=>{const e=t.url.match(/showtopic=(\d+)/)?.[1];e&&a.set(e,t)});const i=[...n];let s=0,c=0;for(const t of r.newTopics)i.push(t),s++;for(const t of r.updatedTopics){const e=t.url.match(/showtopic=(\d+)/)?.[1];if(e){const n=i.findIndex(t=>t.url.match(/showtopic=(\d+)/)?.[1]===e);-1!==n&&(i[n]=t,c++)}}return await bt(t,e,r.newTopics,r.updatedTopics,n.length),k(`Lista actualizada: +${s} nuevos, ${c} modificados`),i}(t,e);"function"==typeof window.updateCRGListButton&&await window.updateCRGListButton(),yt(n,JSON.parse(document.getElementById("crg-markers-data")?.textContent||"{}"),!0),Lt(n)}catch(t){k("Error al actualizar la lista",!0)}}else zt(!1)},n.title="Click: cargar lista en cach√©\nCTRL+Click: actualizar incrementalmente",n.style.borderRadius="4px",e.innerHTML="",e.appendChild(n)):(n.innerHTML='Lista <svg width="10" height="10"><circle cx="5" cy="5" r="4" fill="#808080"/></svg>',n.onclick=()=>zt(!0),n.style.borderRadius="4px",n.style.position="relative",n.style.display="inline-block",e.innerHTML="",e.appendChild(n))};o(),window.updateCRGListButton=()=>{o()},t.appendChild(e)}()}(),await Ut()}catch(t){}})())}(localforage);
