// ==UserScript==
// @name         MangaBuff Card Statistics
// @namespace    http://tampermonkey.net/
// @version      1.1.0
// @description  Показывает статистику владельцев/желающих, цены на лоты и число обменов пользователей
// @author       zamoroz
// @match        https://mangabuff.ru/cards*
// @match        https://mangabuff.ru/users/*
// @match        https://mangabuff.ru/market*
// @match        https://mangabuff.ru/decks/*
// @match        https://mangabuff.ru/clubs/*/boost
// @match        https://mangabuff.ru/manga/*
// @grant        GM_xmlhttpRequest
// @connect      mangabuff.ru
// @license MIT
// @downloadURL https://update.greasyfork.org/scripts/563924/MangaBuff%20Card%20Statistics.user.js
// @updateURL https://update.greasyfork.org/scripts/563924/MangaBuff%20Card%20Statistics.meta.js
// ==/UserScript==

!function(){"use strict";const t="mangabuff_card_stats_cache",e=168,n="mangabuff_card_lots_cache",r=1,a="mangabuff_user_trades_cache",o=24;const s=function(){try{const n=localStorage.getItem(t);if(!n)return{};const r=JSON.parse(n),a=Date.now();return Object.keys(r).forEach((t=>{r[t].timestamp&&a-r[t].timestamp>60*e*60*1e3&&delete r[t]})),r}catch(t){return console.error("[MangaBuff Stats] Ошибка загрузки кеша:",t),{}}}(),c=function(){try{const t=localStorage.getItem(n);if(!t)return{};const e=JSON.parse(t),a=Date.now();return Object.keys(e).forEach((t=>{e[t].timestamp&&a-e[t].timestamp>60*r*60*1e3&&delete e[t]})),e}catch(t){return console.error("[MangaBuff Stats] Ошибка загрузки кеша лотов:",t),{}}}(),i=function(){try{const t=localStorage.getItem(a);if(!t)return{};const e=JSON.parse(t),n=Date.now();return Object.keys(e).forEach((t=>{e[t].timestamp&&n-e[t].timestamp>60*o*60*1e3&&delete e[t]})),e}catch(t){return console.error("[MangaBuff Stats] Ошибка загрузки кеша обменов:",t),{}}}(),l=500,d=3,u=2e3;let f=0;const p=[];let m=!1;const g=[];let w=!1,b=null;const h=[{name:"standard",cardSelector:".manga-cards__item[data-card-id]",wrapperSelector:".manga-cards__item-wrapper",idAttribute:"data-card-id",idLocation:"card"},{name:"deck",cardSelector:".deck__item[data-card-id]",wrapperSelector:null,idAttribute:"data-card-id",idLocation:"card"},{name:"lootbox",cardSelector:".lootbox__card[data-id]",wrapperSelector:null,idAttribute:"data-id",idLocation:"card"},{name:"market",cardSelector:".market-list__cards--all .manga-cards__item",wrapperSelector:".manga-cards__item-wrapper",idAttribute:"data-id",idLocation:"wrapper"},{name:"club-boost",cardSelector:".club-boost__inner",wrapperSelector:null,idAttribute:null,idLocation:"link",linkSelector:'a[href*="/cards/"]'}],y=document.createElement("style");function _(t){return new Promise((e=>setTimeout(e,t)))}async function S(){if(0===f)return void(f=Date.now());const t=Date.now()-f;t<l&&await _(l-t),f=Date.now()}function x(t){return new Promise(((e,n)=>{p.push({requestFn:t,resolve:e,reject:n}),async function(){if(m||0===p.length)return;m=!0;for(;p.length>0;){const{requestFn:t,resolve:e,reject:n}=p.shift();try{e(await t())}catch(t){n(t)}}m=!1}()}))}async function v(t,e=0){return await S(),new Promise(((n,r)=>{GM_xmlhttpRequest({method:"GET",url:t,onload:async function(a){if(429===a.status)if(e<d){console.log(`[MangaBuff Stats] 429 ошибка для ${t}, повторная попытка ${e+1}/${d}`),await _(u*(e+1));try{const r=await v(t,e+1);n(r)}catch(t){r(t)}}else console.error(`[MangaBuff Stats] Превышено количество попыток для ${t}`),r(new Error("Too many retries"));else a.status>=200&&a.status<300?n(a.responseText):r(new Error(`HTTP ${a.status}`))},onerror:function(t){r(t)}})}))}function k(t){const e=(new DOMParser).parseFromString(t,"text/html").querySelectorAll(".pagination__button a");let n=1;return e.forEach((t=>{const e=t.getAttribute("href");if(e&&e.includes("page=")){const t=e.match(/page=(\d+)/);if(t){const e=parseInt(t[1]);e>n&&(n=e)}}})),n}async function q(n){if(s[n]){const t=s[n],r=t.timestamp&&Date.now()-t.timestamp<60*e*60*1e3,a=null!==t.owners&&null!==t.wanters;if(r&&a)return E(n,{owners:t.owners,wanters:t.wanters}),{owners:t.owners,wanters:t.wanters}}return x((async()=>{let e,r;await S();try{e=k(await v(`https://mangabuff.ru/cards/${n}/offers/want`))}catch(t){e=null}E(n,{wanters:e}),await S();try{r=k(await v(`https://mangabuff.ru/cards/${n}/users`))}catch(t){r=null}if(E(n,{owners:r}),null!==r&&null!==e){const a={owners:r,wanters:e,timestamp:Date.now()};s[n]=a,function(){try{localStorage.setItem(t,JSON.stringify(s))}catch(t){console.error("[MangaBuff Stats] Ошибка сохранения кеша:",t)}}()}return{owners:r,wanters:e}}))}async function A(t){if(c[t]){const e=c[t];if(e.timestamp&&Date.now()-e.timestamp<60*r*60*1e3&&e.lots&&e.lots.length>0)return e.lots}return x((async()=>{try{const e=function(t){const e=(new DOMParser).parseFromString(t,"text/html").querySelectorAll(".market-show__lots .market-show__item"),n=[],r=new Set;for(const t of e){const e=t.getAttribute("href"),a=e?e.split("/market/")[1]:null;if(!a)continue;const o=t.querySelector(".market-show__user-cards-rank"),s=o?o.textContent.trim():null;if(s&&!r.has(s)&&(r.add(s),n.push({lotId:a,price:s}),n.length>=5))break}return n}(await v(`https://mangabuff.ru/market/card/${t}`));return e.length>0&&(c[t]={lots:e,timestamp:Date.now()},function(){try{localStorage.setItem(n,JSON.stringify(c))}catch(t){console.error("[MangaBuff Stats] Ошибка сохранения кеша лотов:",t)}}()),e}catch(e){return console.error(`[MangaBuff Stats] Ошибка загрузки лотов для карты ${t}:`,e),[]}}))}async function L(t){if(i[t]){const e=i[t];if(e.timestamp&&Date.now()-e.timestamp<60*o*60*1e3&&null!==e.count)return{count:e.count,isBlocked:e.isBlocked||!1}}return x((async()=>{try{const e=function(t){const e=(new DOMParser).parseFromString(t,"text/html"),n=e.querySelector(".trade__header-name span");let r=null;return n&&(r=n.textContent.trim()),{count:r,isBlocked:null!==e.querySelector(".trade__block")}}(await v(`https://mangabuff.ru/trades/offers/${t}`));return null!==e.count&&(i[t]={count:e.count,isBlocked:e.isBlocked,timestamp:Date.now()},function(){try{localStorage.setItem(a,JSON.stringify(i))}catch(t){console.error("[MangaBuff Stats] Ошибка сохранения кеша обменов:",t)}}()),e}catch(t){return{count:null,isBlocked:!1}}}))}async function M(){const t=document.querySelector(".profile[data-user-id]");if(!t)return;const e=t.getAttribute("data-user-id");if(!e)return;const n=document.querySelector(".profile__name")||document.querySelector(".mobile-profile__name");if(!n)return;if(n.querySelector(".profile__trades-count"))return;const r=await L(e);if(r&&null!==r.count){const t=document.createElement("span");t.className="profile__trades-count",t.textContent=r.count,t.title="Количество обменов",n.appendChild(t);const e=document.querySelector(".profile__info--ignore-btn"),a=e&&e.textContent.includes("Удалить из черного списка");if(r.isBlocked||a){const t=document.createElement("span");t.className="profile__trades-blocked",t.textContent="✖",n.appendChild(t)}}}function B(t){const e=document.createElement("div");return e.className="card-stats-overlay",e.innerHTML=`\n            <div class="card-stats-row">\n                <span class="card-stats-label">Владельцев:</span>\n                <span class="card-stats-value owners card-stats-loading" data-card-id="${t}" data-type="owners">...</span>\n            </div>\n            <div class="card-stats-row">\n                <span class="card-stats-label">Желают:</span>\n                <span class="card-stats-value wanters card-stats-loading" data-card-id="${t}" data-type="wanters">...</span>\n            </div>\n        `,e}function E(t,e){const n=document.querySelectorAll(`[data-card-id="${t}"][data-type="owners"]`),r=document.querySelectorAll(`[data-card-id="${t}"][data-type="wanters"]`);void 0!==e.owners&&n.forEach((t=>{t.textContent=null!==e.owners?e.owners:"Ошибка",t.classList.remove("card-stats-loading")})),void 0!==e.wanters&&r.forEach((t=>{t.textContent=null!==e.wanters?e.wanters:"Ошибка",t.classList.remove("card-stats-loading")}))}async function D(t,e){if(e.querySelector(".card-lots-overlay"))return;const n=await A(t);if(n&&n.length>0){const t=function(t){if(!t||0===t.length)return null;const e=document.createElement("div");e.className="card-lots-overlay";const n=t.map((t=>t.price)).join(", ");return e.innerHTML=`\n            <div class="card-lots-label">Цены:</div>\n            <div class="card-lots-prices">${n}</div>\n        `,e}(n);t&&e.appendChild(t)}}function $(t,e){g.push({cardId:t,wrapper:e}),async function(){if(w||0===g.length)return;w=!0;for(;g.length>0;){const{cardId:t,wrapper:e}=g.shift();document.contains(e)&&!e.querySelector(".card-lots-overlay")&&await D(t,e)}w=!1}()}function C(){if(document.querySelector(".profile[data-user-id]"))return;const t=Date.now();console.log("[MangaBuff Stats] Начало processCards"),h.forEach((t=>{const e=document.querySelectorAll(t.cardSelector);if(e.length>0&&console.log(`[MangaBuff Stats] Найдено ${e.length} карточек типа ${t.name}`),"market"!==t.name)e.forEach((e=>{const n=function(t,e){if(e.wrapperSelector){const n=t.closest(e.wrapperSelector);if(n)return n.style.position="relative",n}return t.style.position="relative",t}(e,t);if(!n)return;if(n.querySelector(".card-stats-overlay"))return;const r=function(t,e){if("card"===e.idLocation)return t.getAttribute(e.idAttribute);if("wrapper"===e.idLocation){const n=t.closest(e.wrapperSelector);return n?n.getAttribute(e.idAttribute):null}if("link"===e.idLocation){const n=t.querySelector(e.linkSelector);if(n){const t=n.getAttribute("href").match(/\/cards\/(\d+)/);return t?t[1]:null}}return null}(e,t);if(!r)return;const a=B(r);n.appendChild(a),q(r)}));else{document.querySelector(".market-list__cards--all")&&(b||(b=new IntersectionObserver((t=>{t.forEach((t=>{if(t.isIntersecting){const e=t.target,n=e.getAttribute("data-id");n&&($(n,e),b.unobserve(e))}}))}),{rootMargin:"50px"})),e.forEach((e=>{const n=e.closest(t.wrapperSelector);n&&b&&b.observe(n)})))}})),console.log(`[MangaBuff Stats] processCards завершен за ${Date.now()-t}мс`)}y.textContent="\n        .card-stats-overlay {\n            background: rgba(0, 0, 0, 0.85);\n            color: white;\n            padding: 4px 6px;\n            border-radius: 3px;\n            font-size: 9px;\n            z-index: 10;\n            backdrop-filter: blur(5px);\n            line-height: 1.3;\n        }\n        .card-stats-row {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin: 1px 0;\n            white-space: nowrap;\n        }\n        .card-stats-label {\n            color: #aaa;\n            margin-right: 4px;\n            font-size: 8px;\n        }\n        .card-stats-value {\n            font-weight: bold;\n            font-size: 9px;\n        }\n        .card-stats-value.owners {\n            color: #4ade80;\n        }\n        .card-stats-value.wanters {\n            color: #fb923c;\n        }\n        .card-stats-loading {\n            color: #888;\n            font-style: italic;\n        }\n        .manga-cards__item-wrapper {\n            position: relative;\n        }\n        .deck__item {\n            position: relative;\n        }\n        .club-boost__inner {\n            position: relative;\n        }\n        .lootbox__list {\n            padding-bottom: 40px;\n        }\n        .lootbox__card {\n            position: relative;\n        }\n        .card-lots-overlay {\n            position: absolute;\n            top: 8px;\n            right: 5px;\n            background: rgba(0, 0, 0, 0.85);\n            color: white;\n            padding: 4px 6px;\n            border-radius: 3px;\n            font-size: 8px;\n            z-index: 10;\n            backdrop-filter: blur(5px);\n            max-width: 110px;\n            line-height: 1.4;\n        }\n        .card-lots-label {\n            color: #aaa;\n            font-weight: 500;\n            margin-bottom: 2px;\n        }\n        .card-lots-prices {\n            color: #fbbf24;\n            font-weight: bold;\n        }\n        .profile__trades-count {\n            display: inline-block;\n            margin-left: 8px;\n            padding: 2px 8px;\n            background: rgba(139, 0, 255, 0.5);\n            border: 1px solid rgba(139, 0, 255, 0.8);\n            border-radius: 12px;\n            font-size: 12px;\n            color: #a78bfa;\n            font-weight: 500;\n            vertical-align: middle;\n        }\n        .profile__trades-blocked {\n            display: inline-block;\n            margin-left: 4px;\n            color: #ef4444;\n            font-size: 16px;\n            font-weight: bold;\n            vertical-align: middle;\n            cursor: help;\n        }\n    ",document.head.appendChild(y);const N=new MutationObserver((t=>{let e=!1,n=!1;for(const r of t){if(r.addedNodes.length>0){const t=Array.from(r.addedNodes).some((t=>1===t.nodeType&&(t.classList?.contains("tabs__page")||t.querySelector?.(".manga-cards__item")||t.classList?.contains("lootbox__card")||t.querySelector?.(".lootbox__card")||t.classList?.contains("lootbox__list")))),n=Array.from(r.addedNodes).some((t=>1===t.nodeType&&(t.classList?.contains("market-list__cards--all")||t.querySelector?.(".market-list__cards--all"))));(t||n)&&(e=!0)}if(r.removedNodes.length>0){Array.from(r.removedNodes).some((t=>1===t.nodeType&&(t.classList?.contains("lootbox__card")||t.querySelector?.(".lootbox__card"))))&&(e=!0)}if("attributes"===r.type&&"data-id"===r.attributeName){const t=r.target;if(t.classList.contains("lootbox__card")){n=!0;const e=t.querySelector(".card-stats-overlay");e&&e.remove();const r=t.getAttribute("data-id");if(r){t.style.position="relative";const e=B(r);t.appendChild(e),q(r)}}}}e?setTimeout(C,100):n||C()}));"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{C(),M(),N.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-id"]})})):(C(),M(),N.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-id"]}))}();