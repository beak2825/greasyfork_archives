// ==UserScript==
// @name             隐藏哔哩哔哩的广告和推广区域
// @name:ar          إخفاء الإعلانات والأقسام الترويجية في Bilibili
// @name:bg          Скриване на реклами и промоционални секции в Bilibili
// @name:cs          Skrýt reklamy a propagační sekce na Bilibili
// @name:da          Skjul reklamer og reklamefremstød på Bilibili
// @name:de          Werbung und Werbebereiche auf Bilibili ausblenden
// @name:el          Απόκρυψη διαφημίσεων και προωθητικών ενοτήτων στο Bilibili
// @name:en          Hide Bilibili Ads and Promotional Sections
// @name:eo          Kaŝi reklamojn kaj promociiajn sekciojn en Bilibili
// @name:es          Ocultar anuncios y secciones promocionales de Bilibili
// @name:fi          Piilota Bilibilin mainokset ja mainososiot
// @name:fr          Masquer les publicités et sections promotionnelles de Bilibili
// @name:fr-CA       Masquer les publicités et sections promotionnelles de Bilibili
// @name:he          הסתר פרסומות וסעיפים קידומיים בביליבילי
// @name:hr          Sakrij oglase i promotivne odjeljke na Bilibiliju
// @name:hu          Bilibili hirdetések és promóciós szakaszok elrejtése
// @name:id          Sembunyikan Iklan dan Bagian Promosi di Bilibili
// @name:it          Nascondi annunci e sezioni promozionali di Bilibili
// @name:ja          Bilibilのバナー広告やプロモーションセクションを非表示
// @name:ka          Bilibili-ს რეკლამებისა და სარეკლამო სექციების დამალვა
// @name:ko          Bilibili의 광고 및 프로모션 섹션 숨기기
// @name:nb          Skjul annonser og reklameavdelinger på Bilibili
// @name:nl          Advertenties en promotiesecties op Bilibili verbergen
// @name:pl          Ukryj reklamy i sekcje promocyjne w Bilibili
// @name:pt-BR       Ocultar anúncios e seções promocionais do Bilibili
// @name:ro          Ascunde reclamele și secțiunile promoționale de pe Bilibili
// @name:ru          Скрыть рекламу и рекламные разделы на Bilibili
// @name:sk          Skryť reklamy a propagačné sekcie na Bilibili
// @name:sr          Сакриј рекламе и промотивне одељке на Билибилију
// @name:sv          Dölj annonser och reklamavsnitt på Bilibili
// @name:th          ซ่อนโฆษณาและส่วนส่งเสริมการขายบน Bilibili
// @name:tr          Bilibili'deki reklamları ve tanıtım bölümlerini gizle
// @name:ug          Bilibili دىكى ئېلان ۋە تەشۋىقات بۆلۈملىرىنى يوشۇرۇش
// @name:uk          Приховати рекламу та рекламні розділи на Bilibili
// @name:vi          Ẩn quảng cáo và các phần quảng bá trên Bilibili
// @name:zh-CN       隐藏哔哩哔哩的广告和推广区域
// @name:zh-HK       隱藏哔哩哔哩的廣告和推廣區域
// @name:zh-SG       隐藏哔哩哔哩的广告和推广区域
// @name:zh-TW       隱藏哔哩哔哩的廣告和推廣區域
// @name:af          Versteek Bilibili-advertensies en promosie-afdelings
// @name:am          በBilibili ላይ ማስታወቂያዎችን እና የማበረታቻ ክፍሎችን ደብቅ
// @name:az          Bilibili-də reklamları və promosyon bölmələrini gizlət
// @name:be          Схаваць рэкламу і прома-раздзелы на Bilibili
// @name:bn          Bilibili-তে বিজ্ঞাপন ও প্রচার বিভাগগুলি লুকিয়ে রাখুন
// @name:ca          Amaga els anuncis i les seccions promocionals de Bilibili
// @name:et          Peida Bilibili reklaamid ja kampaaniajaotised
// @name:eu          Ezkutatu Bilibili-ko iragarkiak eta promozio atalak
// @name:fa          پنهان کردن تبلیغات و بخش‌های ترویجی در Bilibili
// @name:ga          Folaigh fógráin agus rannóga chur chun cinn Bilibili
// @name:gl          Agochar os anuncios e seccións promocionais de Bilibili
// @name:hi          Bilibili पर विज्ञापन और प्रचार अनुभाग छिपाएँ
// @name:is          Fela auglýsingar og kynningarhluta á Bilibili
// @name:kk          Bilibili сайтындағы жарнамалар мен жарнамалық бөлімдерді жасыру
// @name:lt          Paslėpti Bilibili skelbimus ir reklaminius skyrius
// @name:lv          Paslēpt Bilibili reklāmas un reklāmas sadaļas
// @name:mk          Скриј ги рекламите и промотивните секции на Bilibili
// @name:ml          Bilibiliയിലെ പരസ്യങ്ങളും പ്രമോഷൻ വിഭാഗങ്ങളും മറച്ചു വയ്ക്കുക
// @name:mr          Bilibili वरील जाहिराती आणि प्रचार विभाग लपवा
// @name:ms          Sembunyikan iklan dan bahagian promosi di Bilibili
// @name:my          Bilibili တွင် ကြော်ငြာများနှင့် ပရိုမိုးရှင်းအပိုင်းများကို ဝှက်ထားပါ
// @name:ne          Bilibili मा विज्ञापन र प्रवर्द्धन खण्डहरू लुकाउनुहोस्
// @name:pa          Bilibili 'ਤੇ ਵਿਗਿਆਪਨ ਅਤੇ ਪ੍ਰਚਾਰ ਭਾਗ ਲੁਕਾਓ
// @name:pt          Ocultar anúncios e seções promocionais do Bilibili
// @name:sl          Skrij oglase in promocijske razdelke na Bilibili
// @name:ta          Bilibili இல் விளம்பரங்கள் மற்றும் முன்னேற்றப் பகுதிகளை மறைக்கவும்
// @name:te          Bilibili లో ప్రకటనలు మరియు ప్రమోషన్ విభాగాలను దాచండి
// @name:ur          Bilibili پر اشتہارات اور تشہیری حصوں کو چھپائیں
// @description      隐藏B站视频详情页右侧的“活动推广”、“大家围观的直播”、视频简介和评论区之间的广告。隐藏B站首页推荐视频feed流的广告卡片。隐藏B站首页右下角的下载客户端的推广弹窗。隐藏首页左侧轮播图。隐藏直播首页顶部自动播放的直播。
// @description:ar   استخدام MutationObserver لإخفاء الأقسام الترويجية وبث المباريات الحية على صفحات فيديو Bilibili، بالإضافة إلى الإعلانات الرئيسية، لتحسين تجربة التصفح
// @description:bg   Използване на MutationObserver за скриване на промоционални секции и live предавания на видео страници в Bilibili, както и реклами на начална страница, за подобряване на потребителското изживяване
// @description:cs   Použití MutationObserveru pro skrytí propagačních sekcí a živých přenosů na stránkách videí Bilibili, stejně jako reklam na úvodní stránce, pro vylepšení prohlížení
// @description:da   Brug af MutationObserver til at skjule reklamefremstød og livestreams på Bilibili-videosider samt forsidereklamer for at forbedre browsingoplevelsen
// @description:de   Verwendung von MutationObserver zum Ausblenden von Werbebereichen und Livestreams auf Bilibili-Videoseiten sowie von Werbung auf der Startseite zur Verbesserung des Surferlebnisses
// @description:el   Χρήση του MutationObserver για απόκρυψη προωθητικών ενοτήτων και ζωντανών μεταδόσεων σε σελίδες βίντεο του Bilibili, καθώς και διαφημίσεων της αρχικής σελίδας, για βελτίωση της εμπειρίας περιήγησης
// @description:en   Use MutationObserver to hide promotional sections and live broadcasts on Bilibili video pages, as well as homepage advertisements, to enhance browsing experience
// @description:eo   Uzi MutationObserver por kaŝi promociiajn sekciojn kaj tutvendajn elsendojn en Bilibili-videaj paĝoj, same kiel ĉefpaĝajn reklamojn, por plibonigi retuman sperton
// @description:es   Utilizar MutationObserver para ocultar secciones promocionales y transmisiones en vivo en páginas de video de Bilibili, así como anuncios de la página de inicio, para mejorar la experiencia de navegación
// @description:fi   Käytä MutationObserveria piilottaaksesi mainososiot ja suorat lähetykset Bilibili-videosivuilta sekä etusivun mainokset käyttökokemuksen parantamiseksi
// @description:fr   Utiliser MutationObserver pour masquer les sections promotionnelles et les diffusions en direct sur les pages vidéo de Bilibili, ainsi que les publicités de la page d'accueil, afin d'améliorer l'expérience de navigation
// @description:fr-CA Utiliser MutationObserver pour masquer les sections promotionnelles et les diffusions en direct sur les pages vidéo de Bilibili, ainsi que les publicités de la page d'accueil, afin d'améliorer l'expérience de navigation
// @description:he   השתמש ב-MutationObserver כדי להסתיר מדורים קידומיים והזרמות חיות בדפי וידאו של Bilibili, וכן מודעות בדף הבית, כדי לשפר את חוויית הגלישה
// @description:hr   Korištenje MutationObservera za skrivanje promotivnih odjeljaka i izravnih prijenosa na stranicama videozapisa Bilibilija, kao i oglasa na početnoj stranici, radi poboljšanja iskustva pregledavanja
// @description:hu   A MutationObserver használata a Bilibili videóoldalak promóciós szakaszainak és élő közvetítéseinek, valamint a kezdőoldali hirdetéseknek az elrejtésére a böngészési élmény javítása érdekében
// @description:id   Gunakan MutationObserver untuk menyembunyikan bagian promosi dan siaran langsung di halaman video Bilibili, serta iklan beranda, untuk meningkatkan pengalaman browsing
// @description:it   Utilizzare MutationObserver per nascondere sezioni promozionali e trasmissioni live nelle pagine video di Bilibili, nonché gli annunci della home page, per migliorare l'esperienza di navigazione
// @description:ja   Bilibilのビデオページにおけるプロモーションセクションとライブ配信、およびホームページの広告をMutationObserverで非表示にし、ブラウジング体験を向上
// @description:ka   MutationObserver-ის გამოყენება Bilibili-ს ვიდეო გვერდებზე სარეკლამო სექციებისა და პირდაპირი ეთერების დასამალად, აგრეთვე საწყისი გვერდის რეკლამებისა, ბრაუზინგის გამოცდილების გასაუმჯობესებლად
// @description:ko   Bilibili 비디오 페이지의 프로모션 섹션과 라이브 방송, 그리고 홈페이지 광고를 MutationObserver를 사용하여 숨겨 브라우징 경험을 향상
// @description:nb   Bruk av MutationObserver for å skjule reklameavdelinger og direktesendinger på Bilibili-videosider, samt forsideannonser, for å forbedre nettleseropplevelsen
// @description:nl   Gebruik MutationObserver om promotiesecties en live uitzendingen op Bilibili-videopagina's, evenals advertenties op de startpagina, te verbergen om de browse-ervaring te verbeteren
// @description:pl   Użycie MutationObserver do ukrycia sekcji promocyjnych i transmisji na żywo na stronach wideo Bilibili, a także reklam na stronie głównej, w celu poprawy wrażeń podczas przeglądania
// @description:pt-BR Usar MutationObserver para ocultar seções promocionais e transmissões ao vivo em páginas de vídeo do Bilibili, bem como anúncios da página inicial, para aprimorar a experiência de navegação
// @description:ro   Utilizarea MutationObserver pentru a ascunde secțiunile promoționale și transmisiunile live de pe paginile video Bilibili, precum și reclamele de pe pagina principală, pentru a îmbunătăți experiența de navigare
// @description:ru   Использование MutationObserver для скрытия рекламных разделов и прямых трансляций на страницах видео Bilibili, а также рекламы на домашней странице, для улучшения опыта просмотра
// @description:sk   Použitie MutationObservera na skrytie propagačných sekcií a živých prenosov na videostránkach Bilibili, ako aj reklám na úvodnej stránke, na zlepšenie zážitku z prehliadania
// @description:sr   Коришћење MutationObserver-а за скривање промотивних одељака и директних преноса на страницама видео записа Билибилија, као и реклама на почетној страници, ради побољшања искуства прегледања
// @description:sv   Använd MutationObserver för att dölja reklamavsnitt och direktsändningar på Bilibili-videosidor samt startsidans annonser för att förbättra surfupplevelsen
// @description:th   ใช้ MutationObserver เพื่อซ่อนส่วนส่งเสริมการขายและการถ่ายทอดสดบนหน้าวิดีโอ Bilibili รวมถึงโฆษณาหน้าแรก เพื่อปรับปรุงประสบการณ์การเรียกดู
// @description:tr   Bilibili video sayfalarındaki tanıtım bölümlerini ve canlı yayınları, ayrıca ana sayfa reklamlarını gizlemek için MutationObserver kullanarak tarama deneyimini geliştirin
// @description:ug   Bilibili سەھىپىسىدىكى تەشۋىقات بۆلۈملىرى ۋە جانلىق يېyىملارنى، شۇنداقلا باش بەت ئېلانلىرىنى MutationObserver ئارقىلىق يوشۇرۇپ، كۆرۈش تەجرىبىسىنى ياخشىلاش
// @description:uk   Використання MutationObserver для приховування рекламних розділів та прямих трансляцій на відео-сторінках Bilibili, а також реклами на головній сторінці, для покращення досвіду перегляду
// @description:vi   Sử dụng MutationObserver để ẩn các phần quảng bá và phát trực tiếp trên các trang video Bilibili, cũng như quảng cáo trên trang chủ, để nâng cao trải nghiệm duyệt web
// @description:zh-CN 使用MutationObserver隐藏Bilibili视频详情页右侧的"活动推广"和"大家围观的直播"模块，以及首页的广告内容，提升浏览体验
// @description:zh-HK 使用MutationObserver隱藏Bilibili影片詳情頁右側的「活動推廣」和「大家圍觀的直播」模組，以及首頁的廣告內容，提升瀏覽體驗
// @description:zh-SG 使用MutationObserver隐藏Bilibili视频详情页右侧的"活动推广"和"大家围观的直播"模块，以及首页的广告内容，提升浏览体验
// @description:zh-TW 使用MutationObserver隱藏Bilibili影片詳情頁右側的「活動推廣」和「大家圍觀的直播」模組，以及首頁的廣告內容，提升瀏覽體驗
// @description:af   Gebruik MutationObserver om promosie-afdelings en regstreekse uitsendings op Bilibili-videobladsye, sowel as tuisbladadvertensies, te versteek en die blaai-ervaring te verbeter
// @description:am   የMutationObserver መሳሪያን በመጠቀም በBilibili ቪዲዮ ገፆች ላይ ያሉ ማበረታቻ ክፍሎችንና ቀጥታ ስርጭቶችን፣ እንዲሁም የመነሻ ገጽ ማስታወቂያዎችን ደብቅ ስለሚያደርግ ተመልከት ተሞክሮን ያሻሽላል
// @description:az   MutationObserver-dən istifadə edərək Bilibili video səhifələrindəki promo bölmələri və canlı yayımları, eləcə də əsas səhifə reklamlarını gizlədin və brauzer təcrübəsini yaxşılaşdırın
// @description:be   Выкарыстоўвайце MutationObserver, каб хаваць прома-раздзелы і прамыя трансляцыі на відэастаронках Bilibili, а таксама рэкламу галоўнай старонкі, паляпшаючы вопыт прагляду
// @description:bn   MutationObserver ব্যবহার করে Bilibili ভিডিও পাতার প্রচার বিভাগ ও লাইভ সম্প্রচার, পাশাপাশি হোমপেজ বিজ্ঞাপন লুকিয়ে রেখে ব্রাউজের অভিজ্ঞতা উন্নত করুন
// @description:ca   Utilitza MutationObserver per amagar les seccions promocionals i les emissions en directe a les pàgines de vídeo de Bilibili, així com els anuncis de la pàgina inicial, i millorar l'experiència de navegació
// @description:et   Kasuta MutationObserverit, et peita Bilibili videolehtede kampaaniajaotised ja otseülekanded ning avalehe reklaamid, parandades sirvimiskogemust
// @description:eu   Erabili MutationObserver Bilibili bideo orrialdeetako promozio atalak eta zuzeneko emisioak, baita hasierako orrialdeko iragarkiak ere, ezkutatzeko eta nabigazio esperientzia hobetzeko
// @description:fa   برای بهبود تجربه مرور، از MutationObserver استفاده کنید تا بخش‌های ترویجی و پخش‌های زنده در صفحات ویدیوی Bilibili و همچنین تبلیغات صفحه اصلی پنهان شوند
// @description:ga   Úsáid MutationObserver chun rannóga ardúcháin agus craoltaí beo ar leathanaigh físe Bilibili, mar aon le fógraí an phríomhleathanaigh, a cheilt agus taithí brabhsála níos fearr a thabhairt
// @description:gl   Usa MutationObserver para agochar as seccións promocionais e as emisións en directo nas páxinas de vídeo de Bilibili, así como os anuncios da páxina de inicio, mellorando a experiencia de navegación
// @description:hi   MutationObserver का उपयोग करके Bilibili वीडियो पृष्ठों पर प्रचार अनुभाग और लाइव प्रसारण तथा होमपेज विज्ञापनों को छिपाएँ ताकि ब्राउज़िंग अनुभव बेहतर हो
// @description:is   Notaðu MutationObserver til að fela kynningarhluta og beinar útsendingar á Bilibili myndbandasíðum, auk auglýsinga á forsíðunni, og bæta þannig vafraupplifunina
// @description:kk   MutationObserver арқылы Bilibili бейне беттеріндегі жарнамалық бөлімдер мен тікелей трансляцияларды, сондай-ақ басты беттегі жарнамаларды жасырып, шолу тәжірибесін жақсартыңыз
// @description:lt   Naudokite MutationObserver, kad paslėptumėte Bilibili vaizdo puslapių reklaminius skyrius ir tiesiogines transliacijas bei pagrindinio puslapio skelbimus, taip pagerindami naršymo patirtį
// @description:lv   Izmantojiet MutationObserver, lai paslēptu reklāmas sadaļas un tiešraides Bilibili video lapās, kā arī sākumlapas reklāmas, un uzlabojiet pārlūkošanas pieredzi
// @description:mk   Користете MutationObserver за да ги сокриете промотивните секции и преносите во живо на видео страниците на Bilibili, како и рекламите на почетната страница, за подобро искуство при прелистување
// @description:ml   MutationObserver ഉപയോഗിച്ച് Bilibili വീഡിയോ പേജുകളിലെ പ്രമോഷൻ വിഭാഗങ്ങളും തത്സമയ സംപ്രേഷണങ്ങളും, കൂടാതെ ഹോംപേജ് പരസ്യങ്ങളും മറച്ചു വച്ച് ബ്രൗസിങ് അനുഭവം മെച്ചപ്പെടുത്തുക
// @description:mr   MutationObserver चा वापर करून Bilibili व्हिडिओ पृष्ठांवरील प्रचार विभाग आणि थेट प्रसारण तसेच मुख्य पृष्ठावरील जाहिराती लपवा आणि ब्राउझिंगचा अनुभव सुधारवा
// @description:ms   Gunakan MutationObserver untuk menyembunyikan bahagian promosi dan siaran langsung pada halaman video Bilibili serta iklan halaman utama supaya pengalaman melayar bertambah baik
// @description:my   MutationObserver ကိုအသုံးပြုပြီး Bilibili ဗီဒီယိုစာမျက်နှာများရှိ ပရိုမိုးရှင်းအပိုင်းများနှင့် တိုက်ရိုက်ထုတ်လွှင့်မှုများနှင့်အတူ မူလစာမျက်နှာကြော်ငြာများကို ဖျောက်ထား၍ လှည့်ဖြတ်ကြည့်ရှုမှုအတွေ့အကြုံကို မြှင့်တင်ပါ
// @description:ne   MutationObserver प्रयोग गरेर Bilibili भिडियो पृष्ठका प्रवर्द्धन खण्ड, प्रत्यक्ष प्रसारण तथा होमपेज विज्ञापनहरू लुकाउनुहोस् र ब्राउजिङ अनुभव सुधार्नुहोस्
// @description:pa   MutationObserver ਦੀ ਵਰਤੋਂ ਕਰਕੇ Bilibili ਵੀਡੀਓ ਪੰਨਿਆਂ ਉੱਤੇ ਪ੍ਰਚਾਰ ਭਾਗ ਅਤੇ ਲਾਈਵ ਪ੍ਰਸਾਰਣ, ਨਾਲ ਹੀ ਮੁੱਖ ਸਫ਼ੇ ਦੇ ਵਿਗਿਆਪਨ ਲੁਕਾਓ, ਤਾਂ ਜੋ ਬ੍ਰਾਊਜ਼ਿੰਗ ਅਨੁਭਵ ਸੁਧਰੇ
// @description:pt   Use o MutationObserver para ocultar as seções promocionais e transmissões ao vivo nas páginas de vídeo do Bilibili, bem como os anúncios da página inicial, melhorando a experiência de navegação
// @description:sl   Z uporabo MutationObserverja skrijte promocijske razdelke in prenose v živo na video straneh Bilibili ter oglase na domači strani, da izboljšate izkušnjo brskanja
// @description:ta   MutationObserver-ஐ பயன்படுத்தி Bilibili வீடியோப் பக்கங்களில் உள்ள விளம்பர மற்றும் முன்னேற்றப் பிரிவுகளையும் முகப்புப் பக்க விளம்பரங்களையும் மறைத்து உலாவல் அனுபவத்தை மேம்படுத்துங்கள்
// @description:te   MutationObserver ఉపయోగించి Bilibili వీడియో పేజీలలోని ప్రచార విభాగాలు, ప్రత్యక్ష ప్రసారాలు మరియు హోమ్‌పేజ్ ప్రకటనలను దాచండి, తద్వారా బ్రౌజింగ్ అనుభవం మెరుగుపడుతుంది
// @description:ur   MutationObserver کا استعمال کرتے ہوئے Bilibili ویڈیو صفحات پر پروموشنل حصے اور لائیو نشریات کے ساتھ ساتھ ہوم پیج کے اشتہارات کو چھپائیں تاکہ براؤزنگ کا تجربہ بہتر ہو
// @namespace    http://tampermonkey.net/
// @version      0.2.6.1
// @author       aspen138
// @match        *://www.bilibili.com/video/*
// @match        *://www.bilibili.com/*
// @match        *://www.bilibili.com
// @match        *://search.bilibili.com/*
// @match        *://*.bilibili.com/*
// @icon         https://www.bilibili.com/favicon.ico
// @grant        GM_registerMenuCommand
// @grant        GM_unregisterMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_notification
// @grant        GM_info
// @grant        GM_addStyle
// @grant        window.onurlchange
// @license      MIT
// @downloadURL https://update.greasyfork.org/scripts/485350/%E9%9A%90%E8%97%8F%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9%E7%9A%84%E5%B9%BF%E5%91%8A%E5%92%8C%E6%8E%A8%E5%B9%BF%E5%8C%BA%E5%9F%9F.user.js
// @updateURL https://update.greasyfork.org/scripts/485350/%E9%9A%90%E8%97%8F%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9%E7%9A%84%E5%B9%BF%E5%91%8A%E5%92%8C%E6%8E%A8%E5%B9%BF%E5%8C%BA%E5%9F%9F.meta.js
// ==/UserScript==



// ↓↓↓↓↓↓↓↓↓模板，建议直接复制 //

// 自定义 urlchange 事件（用来监听 URL 变化）
function addUrlChangeEvent() {
    history.pushState = (f => function pushState() {
        var ret = f.apply(this, arguments);
        window.dispatchEvent(new Event('pushstate'));
        window.dispatchEvent(new Event('urlchange'));
        return ret;
    })(history.pushState);

    history.replaceState = (f => function replaceState() {
        var ret = f.apply(this, arguments);
        window.dispatchEvent(new Event('replacestate'));
        window.dispatchEvent(new Event('urlchange'));
        return ret;
    })(history.replaceState);

    window.addEventListener('popstate', () => {
        window.dispatchEvent(new Event('urlchange'))
    });
}


var menu_ALL = [
        ['menu_isEnableHideTheCarouselImageOnTheLeftSideOfTheHomepage', '隐藏首页左侧轮播图', '隐藏首页左侧轮播图', true]
    ],
    menu_ID = [];
for (let i = 0; i < menu_ALL.length; i++) { // 如果读取到的值为 null 就写入默认值
    if (GM_getValue(menu_ALL[i][0]) == null) {
        GM_setValue(menu_ALL[i][0], menu_ALL[i][3])
    };
}


// 注册脚本菜单
function registerMenuCommand() {
    if (menu_ID.length >= menu_ALL.length) { // 如果菜单ID数组长度大于等于菜单数组长度，说明不是首次添加菜单，需要卸载所有脚本菜单
        for (let i = 0; i < menu_ID.length; i++) {
            GM_unregisterMenuCommand(menu_ID[i]);
        }
    }
    for (let i = 0; i < menu_ALL.length; i++) { // 循环注册脚本菜单
        menu_ALL[i][3] = GM_getValue(menu_ALL[i][0]);
        menu_ID[i] = GM_registerMenuCommand(`${menu_ALL[i][3]?'✅':'❌'} ${menu_ALL[i][1]}`, function() {
            menu_switch(`${menu_ALL[i][3]}`, `${menu_ALL[i][0]}`, `${menu_ALL[i][2]}`)
        });
    }
}


// 菜单开关
function menu_switch(menu_status, Name, Tips) {
    if (menu_status == 'true') {
        GM_setValue(`${Name}`, false);
        GM_notification({
            text: `已关闭 [${Tips}] 功能\n（点击刷新网页后生效）`,
            timeout: 3500,
            onclick: function() {
                location.reload();
            }
        });
    } else {
        GM_setValue(`${Name}`, true);
        GM_notification({
            text: `已开启 [${Tips}] 功能\n（点击刷新网页后生效）`,
            timeout: 3500,
            onclick: function() {
                location.reload();
            }
        });
    }
    registerMenuCommand(); // 重新注册脚本菜单
};


// 返回菜单值
function menu_value(menuName) {
    for (let menu of menu_ALL) {
        if (menu[0] == menuName) {
            return menu[3]
        }
    }
}

for (let i = 0; i < menu_ALL.length; i++) { // 如果读取到的值为 null 就写入默认值
    if (GM_getValue(menu_ALL[i][0]) == null) {
        GM_setValue(menu_ALL[i][0], menu_ALL[i][3])
    };
}
registerMenuCommand();
if (window.onurlchange === undefined) {
    addUrlChangeEvent();
} // Tampermonkey v4.11 版本添加的 onurlchange 事件 grant，可以监控 pjax 等网页的 URL 变化

// ↑↑↑↑↑↑↑↑↑↑↑↑模板，建议直接复制 //




(function() {
    'use strict';

    // Core Utilities
    const Utils = {
        injectStyle(css) {
            const style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
        },

        hideElement(element) {
            if (!element) return;
            const hideStyles = {
                'display': 'none !important',
                'visibility': 'hidden !important',
                'opacity': '0 !important',
                'background': 'white !important',
                'color': 'white !important',
                'pointer-events': 'none !important',
                'height': '0 !important',
                'width': '0 !important',
                'overflow': 'hidden !important',
                'position': 'absolute !important',
                'z-index': '-9999 !important',
                'clip': 'rect(0, 0, 0, 0) !important'
            };

            Object.entries(hideStyles).forEach(([property, value]) => {
                element.style.setProperty(
                    property,
                    value.replace(' !important', ''),
                    'important'
                );
            });

            Array.from(element.children).forEach(child => this.hideElement(child));
            element.onclick = null;
            element.onmouseover = null;
            element.onmouseenter = null;
            element.onmouseleave = null;
        }
    };

    // Bilibili General Features
    const BilibiliGeneral = {
        hideLoginPrompts() {
            if (window.location.hostname.includes('bilibili.com')) {
                Utils.injectStyle(`
                    .lazy-img,
                    .login-tip,
                    .vip-login,
                    .vip-login-tip,
                    .login-panel-popover {
                        display: none !important;
                    }
                `);
            }
        },

        handleLoginState() {
            if (document.cookie.includes('DedeUserID')) {
                Utils.injectStyle(`
                    .desktop-download-tip {
                        display: none !important;
                    }
                `);
            } else {
                const originAppendChild = Node.prototype.appendChild;

                // 打开注释，无法登录。
                Node.prototype.appendChild = function(childElement) {
                    if (childElement.tagName === 'SCRIPT' &&
                        childElement.src.includes("login")) {
                        return null;
                    }
                    return originAppendChild.call(this, childElement);
                };
            }
        },

        hideAds() {
            document.querySelectorAll('a[href*="cm.bilibili.com/cm/api"]').forEach(element => {
                const parentCard = element.closest('.bili-video-card');
                if (parentCard) {
                    const originalHeight = parentCard.children[0]?.children[0]?.offsetHeight || 100;
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `
                        background-color: #f0f0f0;
                        color: #666;
                        padding: 15px;
                        text-align: center;
                        font-size: 14px;
                        height: ${originalHeight}px;
                        min-height: 100px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-sizing: border-box;
                    `;
                    messageDiv.textContent = "The AD content is hidden";
                    parentCard.innerHTML = '';
                    parentCard.appendChild(messageDiv);
                }
            });
        }
    };

    // Ad Blocking Module
    const AdBlocker = {
        targetSelectors: [
            '#slide-ad-exp', '#slide_ad', '#right-bottom-banner',
            '.pop-live-small-mode.part-1', '.ad-floor-cover.b-img',
            '#bannerAd', '.vcd', 'a[data-loc-id="4331"]',
            '#activity_vote', '.ad-report.video-card-ad-small',
            '.ad-report.ad-floor-exp', '.slide-ad-exp',
            '.activity-m-v1.act-now', '.video-page-special-card-small',
            '.btn-ad', 'div[data-v-2ce37bb8].btn-ad',
            '.palette-button-adcard.is-bottom', '.palette-button-adcard'
        ],

        hideAllTargetElements() {
            this.targetSelectors.forEach(selector => {
                document.querySelectorAll(selector)
                    .forEach(element => Utils.hideElement(element));
            });
        },

        setupObserver() {
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) {
                                const targets = [
                                    'slide_ad', 'slide-ad-exp', 'ad-report',
                                    'activity-m-v1', 'video-page-special-card-small',
                                    'btn-ad', 'palette-button-adcard'
                                ];
                                if (targets.includes(node.id) ||
                                    targets.some(cls => node.classList.contains(cls))) {
                                    Utils.hideElement(node);
                                }
                                node.querySelectorAll(targets.map(t => `#${t}, .${t}`).join(', '))
                                    .forEach(Utils.hideElement);
                            }
                        });
                    }
                    if (mutation.type === 'attributes') {
                        const targets = mutation.target;
                        const checkList = ['slide_ad', 'slide-ad-exp', 'ad-report',
                            'activity-m-v1', 'video-page-special-card-small',
                            'btn-ad', 'palette-button-adcard'
                        ];
                        if (checkList.includes(targets.id) ||
                            checkList.some(cls => targets.classList.contains(cls))) {
                            Utils.hideElement(targets);
                        }
                    }
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['style', 'class']
            });

            return observer;
        },

        initialize() {
            this.hideAllTargetElements();
            const observer = this.setupObserver();
            const interval = setInterval(() => this.hideAllTargetElements(), 1000);
            setTimeout(() => {
                clearInterval(interval);
                observer.disconnect();
            }, 30000);
        }
    };

    // Page Specific Features
    const PageSpecific = {
        handleLivePage() {
            // Inject CSS to hide elements
            GM_addStyle(`
             #game-id {
               display: none;
             }
            .gift-panel.base-panel.live-skin-coloration-area.gift-corner-mark-ui {
               display: none;
             }
           `);


            const {
                hostname,
                pathname
            } = window.location;
            if (hostname === 'live.bilibili.com' && (pathname === '/' || pathname === '')) {
                Utils.injectStyle(`
                    .player-area-ctnr.border-box.p-relative.t-center {
                        display: none !important;
                    }
                `);
                const originalPlay = HTMLMediaElement.prototype.play;
                HTMLMediaElement.prototype.play = function() {
                    const stack = new Error().stack || '';
                    if (stack.includes('home-player.prod.min.js')) {
                        this.pause();
                        this.currentTime = 0;
                        this.removeAttribute('autoplay');
                        return Promise.reject(new DOMException('play() failed'));
                    }
                    return originalPlay.apply(this, arguments);
                };
            }

            if (hostname === 't.bilibili.com' && (pathname === '/' || pathname === '')) {
                Utils.injectStyle(`
                    .bili-dyn-ads { display: none !important; }
                `);
            }
        },

        handleMainPage() {
            const {
                hostname,
                pathname
            } = window.location;
            if (hostname === 'www.bilibili.com' && (pathname === '/' || pathname === '')) {
                Utils.injectStyle(`
                    .bili-video-card__skeleton.loading_animation,
                    .bili-live-card.is-rcmd.enable-no-interest,
                    .ad-report.ad-floor-exp.left-banner,
                    .floor-single-card,
                    .fixed-card { display: none !important; }
                    .feed-card { margin-top: 0 !important; }
                `);

                // .recommended-swipe.grid-anchor,

                if (GM_getValue('menu_isEnableHideTheCarouselImageOnTheLeftSideOfTheHomepage', true)) {
                    Utils.injectStyle(`
                    .recommended-swipe,
                    .fixed-card { display: none !important; }
                    .feed-card { margin-top: 0 !important; }
                `);
                }

                const selectors = {
                    pseudo: '.bili-video-card.is-rcmd',
                    icons: '.vui_icon.bili-video-card__stats--icon',
                    adFeed: '.bili-video-card__mask .bili-video-card__stats--text'
                };

                const isBlocked = element => {
                    if (element.dataset.checked) return element.dataset.blocked === 'true';
                    const content = getComputedStyle(element, '::before').content;
                    const blocked = content.includes('AdGuard') || content.includes('AdBlock');
                    element.dataset.checked = 'true';
                    element.dataset.blocked = blocked;
                    return blocked;
                };

                const checkElements = (selector, condition, parentSelector) => {
                    document.querySelectorAll(selector).forEach(el => {
                        const target = parentSelector ? el.closest(parentSelector) : el;
                        if (target && (!condition || condition(el))) {
                            target.style.display = 'none';
                            target.dataset.processed = 'true';
                        }
                    });
                };

                const debounce = (fn, delay = 100) => {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => fn(...args), delay);
                    };
                };

                const observer = new MutationObserver(debounce(() => {
                    checkElements(selectors.pseudo, el =>
                        isBlocked(el) || [...el.children].some(isBlocked));
                    checkElements(selectors.icons, null, '.bili-video-card');
                    checkElements(selectors.adFeed, el =>
                        el.textContent.includes('广告'), '.bili-video-card__wrap');
                }));

                observer.observe(document.body, {
                    subtree: true,
                    childList: true
                });
            }
        },

        handleVideoPage() {
            const {
                hostname,
                pathname
            } = window.location;
            if (hostname === 'www.bilibili.com' && pathname.startsWith('/video/')) {
                Utils.injectStyle(`
                  .bpx-player-qoeFeedback,
                  .bili-danmaku-x-guide.bili-danmaku-x-show,
                  .bili-danmaku-x-cmd-shrink,
                  .bili-danmaku-x-link.bili-danmaku-x-show,
                  .bili-danmaku-x-scoreSum.bili-danmaku-x-show,
                  .bili-danmaku-x-vote.bili-danmaku-x-show,
                  .bili-danmaku-x-score.bili-danmaku-x-show,
                  .bili-danmaku-x-guide-all.bili-danmaku-x-guide.bili-danmaku-x-show,
                  .bili-danmaku-x-follow-to-electric.bili-danmaku-x-guide-all.bili-danmaku-x-guide.bili-danmaku-x-show,
                  .ad-report.strip-ad.left-banner,
                  .ad-report.ad-floor-exp.left-banner,
                  .ad-report.ad-floor-exp.right-bottom-banner,
                  .activity-m-v1.act-end,
                  .activity-m-v1.act-now,
                  .video-card-ad-small,
                  .video-page-game-card-small,
                  .slide-ad-exp { display: none !important; }
              `);
            }
        }
    };

    // Initialize all modules
    function init() {
        BilibiliGeneral.hideLoginPrompts();
        BilibiliGeneral.handleLoginState();
        BilibiliGeneral.hideAds();
        AdBlocker.initialize();
        PageSpecific.handleLivePage();
        PageSpecific.handleMainPage();
        PageSpecific.handleVideoPage();
    }

    init();
})();
