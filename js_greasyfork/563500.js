// ==UserScript==
// @name         Dollar Sale Nav+ (Hunt Mode & OCB)
// @namespace    dollar.sale
// @version      7.6
// @description  Navigate bazaars, auto-sort, skip empty, Hunt for $1 deals, One-Click Buy, and Jump to Index
// @author       Oatshead [3487562]
// @license      Private to Oatshead [3487562] - cannot be used or duplicated in any form
// @icon         https://www.google.com/s2/favicons?sz=64&domain=torn.com
// @match        https://www.torn.com/*
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_addStyle
// @downloadURL https://update.greasyfork.org/scripts/563500/Dollar%20Sale%20Nav%2B%20%28Hunt%20Mode%20%20OCB%29.user.js
// @updateURL https://update.greasyfork.org/scripts/563500/Dollar%20Sale%20Nav%2B%20%28Hunt%20Mode%20%20OCB%29.meta.js
// ==/UserScript==

(() => {
    'use strict';

    if (typeof GM === 'undefined') window.GM = {};
    if (!GM.addStyle) {
        GM.addStyle = css => {
            const style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
        };
    }

    // --- CONFIGURATION ---
    const DEFAULTS = {
        huntMode: false,
        soundAlert: true,
        oneClickBuy: 'off',
        minProfit: 95
    };
    
    let config = JSON.parse(localStorage.getItem('bazaarNavConfig')) || DEFAULTS;
    
    const saveConfig = () => {
        localStorage.setItem('bazaarNavConfig', JSON.stringify(config));
    };

    // --- SOUND ALERT ---
    const playSound = () => {
        if (!config.soundAlert) return;
        const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        audio.volume = 0.5;
        audio.play().catch(e => console.log("Audio play failed (user interaction needed first):", e));
    };

    // --- HELPER: ROBUST PRICE PARSER ---
    // Extract price only from direct text nodes to avoid grabbing TornTools percentage badges
    const getPriceFromElement = (priceEl) => {
        if (!priceEl) return 0;
        let textPart = "";
        
        // Iterate over child nodes to find the text node containing the price
        priceEl.childNodes.forEach(node => {
            if (node.nodeType === 3) { // Node.TEXT_NODE
                textPart += node.nodeValue;
            }
        });

        // If no text nodes found (rare), fall back to innerText but be careful
        if (!textPart.trim()) textPart = priceEl.innerText;

        // Remove everything that isn't a digit
        const cleanPrice = textPart.replace(/[^0-9]/g, '');
        return parseInt(cleanPrice, 10) || 0;
    };

    // --- NAVIGATION LIST ---
    const userIds = [
        3445243, 2693254, 1145056, 1636350, 2668560, 1853324, 2263400, 3182441, 2541678,
        3237207, 2321305, 3244939, 3444185, 3369647, 3338586, 3484482, 3304959, 2203576,
        2812113, 3400186, 2962007, 3394866, 2459465, 2352900, 3198458, 2334174, 3392180,
        3468210, 3466754, 1821105, 2700933, 3259246, 360330, 2332873, 3455398, 3528214,
        2649236, 3621114, 3570456, 3385583, 3390097, 3327900, 3504237, 3474044, 3480404,
        3249592, 3187441, 3284969, 3493798, 333493, 3372209, 2215721, 3443006, 3325064,
        3306975, 3488406, 2018311, 1441750, 3615849, 1826175, 2759415, 3561791, 2373781,
        3617287, 3351015, 1403609, 2865837, 3588663, 3455607, 3303003, 3532830, 286232,
        2601828, 3661330, 3484674, 3665796, 3200247, 3108759, 3220837, 3571449, 2656557,
        3357431, 3424078, 3603393, 1496324, 3347008, 2176411, 2418443, 3060802, 1010587,
        3476656, 3192720, 3399085, 3555668, 2561006, 830027, 2718606, 2676295, 3499388,
        3554441, 3340956, 3781236, 3886744, 1853324, 3847806, 3447147, 3866371, 2086491,
        3927595, 3881939, 3923113, 3400805, 3253836, 432195, 288160, 3771812, 3721851,
        2716931, 3255037, 3397129, 3602729, 3834576, 3626986, 3866430, 3441997, 3743314,
        3983199, 2747394, 1927218, 3303958, 2011336, 3461279, 4024844, 1472890, 3078118,
        3836407, 3710468, 4030854, 2362815, 3186340, 3910168, 3298281, 3611992, 3984512,
        3926588, 3796565, 4022180, 3167471, 3994916, 3619793, 3731118, 3691632, 3051400,
        3838787, 3542741, 3691958, 3951073, 3868072, 3568309, 2844835, 3833126, 3372673,
        2875897, 3081881, 3888369, 2930086, 3854156, 3997472, 3580365, 1636350, 3926486,
        3049928, 3953370, 4041472, 3761056, 3776271, 2862776, 3927108, 3212450, 2547411,
        3500427, 2933938, 3873176, 3569967, 3600571, 2472641, 3805449, 3705327, 2239233,
        3364078, 3961834, 3787131, 3695179, 3964395, 2893074, 3720718, 2679474, 2865837,
        3187441, 2734979, 3521694, 3579175, 2810688, 3811054, 3509935, 2159915, 3866455,
        3722369, 3947246, 2139384, 2129107, 2140939, 3604688, 3666082, 1195734, 3997144,
        2306783, 3724375, 3722185, 3253015, 3660990, 3422789, 1671788, 3826294, 3994198,
        3323759, 3976608, 3567556, 2214372, 3773668, 3650134, 3818468, 3686366, 3637460,
        3388065, 3719659, 3948359, 2020991, 3852121, 3629768, 3930508, 2012516, 2681780,
        2917986, 3651460, 3995536, 3858431, 2450348, 3493805, 4023063, 2833278, 3307942,
        3922073, 3862460, 3569298, 3587388, 3222877, 3156929, 3615043, 3462910, 3407376,
        3739829, 2771196, 3246784, 3249754, 3385583, 3761832, 2302881, 3619531, 3686371,
        3640032, 3968916, 3591323, 3239282, 3809686, 3575213, 3624845, 2493409, 3944524,
        3473887, 2203576, 3438807, 584064, 3364003, 3949473, 3895467, 2679739, 3827190,
        4002824, 1010587, 3971464, 3980841, 3551559, 3738196, 3994964, 2738349, 3820285,
        2332873, 3462942, 1956938, 3808616, 3626269, 3265425, 3919319, 3899139, 2116132,
        3793448, 3965144, 4029787, 3687321, 3847962, 2225461, 3450172, 3432973, 3894335,
        1593313, 3654521, 3967206, 3619801, 3856170, 2147483, 2607439, 3555103, 4024627,
        3256909, 3750519, 428979, 3922407, 3254494, 3618339, 3719931, 3803990, 3824738,
        3757038, 3651060, 3070994, 4028735, 3730653, 3597510, 3717775, 3848713, 4000942,
        1744050, 3453364, 2882256, 2588026, 2693254, 3392671, 3798256, 3764713, 2998841,
        3086632, 3682529, 3558926, 2511408, 3717504, 3492334, 3052315, 3528504, 3636359,
        3724222, 2827667, 3018883, 3406986, 3672282, 3459303, 3060802, 3850852, 3535240,
        3941741, 3518826, 3281538, 3546845, 3738139, 3791635, 3894434, 2848966, 4031276,
        2493371, 3631100, 4009755, 2842410, 3707287, 3665161, 3793153, 3555974, 3206782,
        3784786, 3700521, 3938048, 3981846, 3614193, 3472422, 3327900, 2874289, 3620283,
        1930138, 3696702, 3652887, 2376795, 4019233, 3675809, 3722234, 3690537, 2117183,
        2463591, 3376978, 3830259, 4010962, 3290610, 3892061, 3639067, 2776257, 3892668,
        2596327, 3901718, 3690575, 3888768, 3097913, 3818717, 3232732, 3315050, 3253282,
        3853187, 2144033, 3047259, 2066510, 2972834, 3104527, 35057, 3219128, 3899032,
        2115907, 3884387, 3843640, 3359319, 3047036, 3320707, 3291194, 3156484, 3377841,
        3960348, 3996254, 3954112, 3922678, 2954103, 4002200, 4009728, 2271807, 3465045,
        3195976, 3841443, 3608846, 3857133, 3591054, 3485561, 2858099, 3917365, 3295105,
        4025343, 3904141, 3284714, 3922170, 3765290, 3860190, 3067803, 3785796, 1969077,
        3751347, 3729018, 3575655, 3354720, 3799808, 1553098, 3986880, 2642809, 3782506,
        2527029, 3606077, 2393169, 2456369, 3762779, 3674054, 3799915, 3770016, 3927927,
        1459902, 3038676, 3961355, 3831844, 2394194, 3984597, 3232880, 3607569, 1449781,
        3673591, 3680897, 2271357, 3725123, 3607812, 3989123, 3646376, 3532827, 3546645,
        2872803, 3672758, 3472828, 3857782, 3903290, 3684766, 1902305, 3300790, 4000321,
        3920168, 3866874, 3824831, 3641879, 3570143, 3879016, 3318207, 3865762, 3889143,
        3561810, 4030026, 3582902, 2159949, 3597723, 3679342, 436833, 2020528, 3916419,
        3776209, 4016118, 2621818, 3212620, 3761489, 3734251, 3085088, 3666159, 3651030,
        2580166, 2961389, 3919614, 3676603, 3871773, 2620009, 2911228, 4006029, 3528757,
        3048647, 2629513, 3973261, 3986024, 2303407, 3249836, 1098199, 3405216, 2562431,
        3402938, 3599411, 2604788, 3869108, 1974799, 3372639, 3617990, 3547685, 3252040,
        2926089, 3187708, 3525946, 3408836, 3260944, 3337745, 2598727, 3786567, 2968469,
        3908929, 3582864, 3710591, 3167683, 3752991, 3522249, 3373313, 3706203, 3646655,
        3775229, 3108759, 2017141, 3624099, 2635479, 3688898, 3611300, 3462112, 3819111,
        3975284, 895818, 3322204, 3395229, 2942523, 3306634, 3774090, 3707463, 2233878,
        3924461, 3641938, 2841690, 442754, 2287159, 3988509, 2649236, 3284199, 3369647,
        3969397, 3900273, 3900293, 2768491, 3993565, 3722989, 3752772, 3084925, 3916788,
        2393019, 2507533, 3909344, 3963530, 3862651, 3363483, 3445801, 3654022, 3921027,
        3597279, 3754486, 2491066, 1044045, 3766128, 2821802, 3368826, 3934148, 1649861,
        3645329, 3916362, 1728844, 3864808, 3393752, 3444131, 3675575, 584226, 3910559,
        4017762, 2905897, 1831710, 3956426, 3968754, 3941151, 906479, 3622282, 2658048,
        170748, 2756511, 3628284, 3953997, 3456643, 3678283, 3859772, 3331202, 3499926,
        3771189, 3517252, 1959051, 3556905, 3768564, 3854244, 2788598, 2312438, 3952653,
        2354402, 3656832, 2858406, 3466760, 4001089, 4000160, 3762989, 3123657, 3864390,
        1947349, 2584558, 3851662, 3806221, 2317218, 3662930, 3456323, 3384523, 2147833,
        3814304, 2152388, 3789971, 1680626, 3377937, 3685855, 3787178, 3944280, 3554441,
        3391877, 3869545, 3746161, 2710089, 2408166, 2536667, 3937636, 3616667, 3586730,
        3025664, 2673537, 3867848, 3823373, 3952796, 3347571, 3794639, 3530041, 3737845,
        3546856, 2118516, 2380865, 3931445, 2555816, 3164366, 4000144, 3854442, 3758850,
        3176362, 3275557, 3843184, 3699862, 3851236, 2036364, 3753958, 4030226, 3338219,
        2810641, 3651667, 3862157, 2296126, 3381340, 3029707, 3976623, 3100991, 3831612,
        3908352, 3543912, 1607805, 2111827, 2597990, 2870610, 3625266, 3256454, 3987513,
        2528008, 3186403, 2043237, 3611876, 2066257, 3944381, 2833165, 2526801, 3101086,
        3601335, 2246161, 3899630, 3351110, 2087604, 3657154, 3606359, 1530994, 3847949,
        2825765, 3732210, 2369712, 3784383, 1166743, 3666058, 3384524, 3571937, 4020052,
        3965825, 3327037, 2113568, 2692348, 3780401, 2739076, 2347538, 2886081, 3808908,
        3348825, 3207966, 3829277, 3761151, 3485263, 3736622, 1945424, 2610869, 265004,
        3832385, 3730115, 3889202, 2653459, 3461706, 3892774, 2660187, 2426345, 2179286,
        3957216, 3705067, 2770601, 2076208, 2113213, 3629600, 3037616, 284713, 3995562,
        3724309, 3445172, 3770426, 3694680, 3753796, 2084614, 3805527, 2091252, 3982365,
        3457287, 3909535, 3581353, 1517593, 2023155, 2934662, 3620838, 3676762, 3162006,
        3266243, 3820457, 3717211, 993345, 3719214, 2540975, 2361277, 3769295, 2332039,
        3160631, 3808537, 3953123, 1942711, 3488518, 2682477, 3681506, 2974185, 3711996,
        3598247, 2733671, 3399399, 3588606, 2665582, 3797461, 1067811, 3912433, 3395902,
        3205898, 2976986, 2687984, 3212695, 3971187, 3480404, 3622610, 2925274, 1322847,
        3297814, 2151678, 2610810, 3981071, 1884782, 3674178, 3860624, 3972619, 3594053,
        2650886, 2593057, 3517477, 4023653, 3619816, 3517179, 3738593, 3631069, 2858160,
        3892088, 3561957, 3255504, 3945464, 2143927, 3452026, 2773585, 3875439, 3557550,
        3788836, 3579391, 3644356, 2370525, 3398575, 3489922, 3473040, 1125545, 3705449,
        2769269, 3995125, 3262941, 3246140, 4030124, 3893118, 3719564, 3560762, 1865163,
        2932759, 3488844, 3485049, 2986359, 3697081, 3853561, 3568177, 1786080, 3284969,
        3587169, 3504012, 4057423, 3076063, 2738354, 3465742, 2646714, 2628715, 2216949,
        2571177, 2941533, 3379315, 3461692, 3260986, 2490688, 3448506, 3834815, 3289701,
        2654260, 3433535, 3496677, 1461511, 3037400, 2214797, 3556481, 3129205, 2431659,
        3653078, 1021253, 3306311, 3226223, 3842452, 3563756, 2332327, 3583749, 3915449,
        1899107, 3790052, 3845537, 3608783, 2176661, 3734598, 3451220, 3812421, 3959375,
        3787170, 3367394, 3813223, 3990228, 2258134, 3862240, 3394411, 3661918, 3804482,
        3718462, 3010022, 3371236, 3303046, 3610265, 926714, 3764087, 3845031, 2668259,
        3589856, 2159403, 3954378, 3516982, 3744376, 3680590, 3546902, 3751479, 2669086,
        3617564, 3513925, 1691090, 3460793, 2486141, 3552714, 3938390, 3522448, 2456018,
        3150073, 3032698, 3994379, 2838827, 3805039, 3706860, 2458597, 2807699, 3815953,
        3533904, 3712336, 3829031, 27156, 2964437, 3830494, 3181495, 3627803, 1693002,
        3642969, 2421661, 3701742, 3555668, 3187951, 2786154, 3808593, 3722459, 3251847,
        1284087, 1652358, 1941593, 3997402, 1914349, 3754698, 3856028, 3626674, 3926388,
        3677719, 3883057, 1456839, 2809463, 1945749, 3667377, 3820989, 2209507, 3880819,
        2871497, 3837212, 2948723, 3268887, 3342667, 1308211, 3856756, 3907167, 3814099,
        1853567, 3500071, 2284141, 3856430, 3595626, 3892302, 2665791, 3263564, 3066322,
        520168, 2208584, 3924307, 853016, 3735047, 3355804, 2813921, 3880039, 3504219,
        3427458, 3572984, 2771697, 3651823, 3425780, 2520656, 3808834, 2894685, 3275003,
        3389861, 2747762, 2580769, 3564733, 3796866, 3687934, 3520225, 517092, 2165976,
        2402229, 2797424, 3603618, 3879604, 3399249, 3247514, 3715327, 2686393, 3410946,
        868049, 2859995, 2289608, 3690834, 3600272, 3928869, 3501100, 3089152, 3104119,
        3688974, 3463792, 3641202, 3163918, 2691603, 3658354, 3370531, 3728962, 915570,
        572361, 3571606, 3713214, 2335887, 3829396, 2966467, 2348396, 3835540, 3947404,
        3800746, 3649806, 1996403, 2736835, 3758069, 3199578, 3124433, 3575996, 3889633,
        3399067, 2121748, 3866312, 2846820, 3584339, 3766196, 1422575, 3841498, 1943686,
        3434976, 2531658, 1953020, 2623179, 3055124, 3256609, 3050103, 3905891, 2173250,
        3950893, 3742235, 3731476, 3510712, 3927048, 3818287, 865555, 3310273, 3627062,
        2748515, 3167318, 2158118, 3968915, 3523008, 3556442, 2097278, 3385131, 166801,
        2803893, 3770521, 3461402, 3462863, 3396944, 3711244, 3466638, 3380659, 2462411,
        179706, 3907184, 2789915, 3230825, 2865045, 2815954, 3955690, 3719436, 3353611,
        3803115, 3284826, 3012215, 871983, 2265611, 3884132, 3974828, 3815886, 3627718,
        2282334, 3816413, 3636627, 2795154, 3997124, 3603750, 2470308, 2178080, 2733917,
        3798630, 3571528, 3948482, 3418855, 3887781, 3934419, 3700430, 2760890, 2031870,
        3859889, 3380499, 3738338, 2107747, 3602758, 3829997, 3724491, 3626740, 3789613,
        3187410, 2925723, 3267285, 3327897, 3969705, 3803913, 3727834, 3729667, 2846278,
        3525140, 3724878, 3778291, 3048320, 3988333, 2462610, 2256339, 3994965, 3793260,
        3508910, 2955596, 3456314, 3657848, 3077711, 2137326, 3361700, 2491196, 2863370,
        4043373, 3443326, 2750555, 3055628, 3738537, 3318595, 3882931, 2811578, 2711321,
        3866974, 3393074, 3662270, 3858734, 3824349, 3385220, 561149, 3389970, 3714674,
        2264684, 3469889, 3397072, 3606896, 3770465, 3166756, 3851147, 3829304, 3192720,
        3792163, 3589987, 3915035, 3637371, 3662581, 3115370, 3631423, 2645263, 1679488,
        3393260, 3944515, 3893001, 3397012, 2043915, 2937508, 3635642, 3205207, 2996187,
        2927870, 3253694, 3382057, 3777463, 3877650, 2588452, 3570175, 3721193, 3482187,
        3931449, 3778921, 3673921, 2205411, 3702183, 2210476, 3516612, 2473265, 3658723,
        4032937, 3719804, 3159255, 3162586, 3662283, 3662629, 3925335, 3292502, 3469779,
        3888622, 2746162, 3205707, 3613656, 3707561, 2833112, 2094624, 351634, 1328306,
        3452107, 3904547, 3890724, 2194856, 3766838, 3976024, 3949566, 3507322, 3604035,
        3857858, 3382288, 3041683, 3334091, 2730828, 2971724, 3785534, 2309119, 3919802,
        3730330, 3629229, 3480078, 3506751, 1016857, 3736919, 3861210, 3685736, 3158768,
        3272175, 2029519, 3865765, 3824821, 2877889, 2622871, 2437960, 780675, 3870828,
        3674202, 3052861, 3304261, 3436339, 3818795, 25719, 2575508, 3613810, 2933884,
        968180, 1947068, 3064815, 2554742, 2945349, 3736023, 298394, 342933, 2478658,
        3802738, 2804823, 3630585, 3794188, 3910428, 3983761, 3905175, 3723048, 1558160,
        3869677, 40078, 3703493, 3622070, 1760815, 2677069, 2813561, 2885947, 3761165,
        2589248, 3983075, 1394565, 2781369, 3714844, 3756398, 3863535, 3819903, 3622236,
        2817301, 3816832, 3122246, 3941885, 3247296, 2048355, 1181260, 2771563, 1060649,
        3881194, 3900454, 2479061, 3697912, 3298506, 270923, 3305509, 1516555, 3974560,
        3740297, 2256247, 3880817, 3112208, 2570054, 3001847, 3787164, 3992115, 1553286,
        4001129, 3019238, 477943, 3727160, 3738008, 3722724, 3316456, 3356549, 3495004,
        100495, 3164489, 3801852, 3670242, 3884298, 3479752, 3415189, 450465, 2646654,
        3581377, 3493633, 3629117, 3250742, 3576871, 2654334, 2554385, 3528843, 3757213,
        105693, 3710485, 3637659, 2796797, 3763890, 4043340, 2556276, 2419424, 3515455,
        3764571, 3338484, 876657, 3323829, 1626029, 3945933, 3605545, 2049725, 3270701,
        2656557, 2629346, 3167358, 3642719, 2491536, 3414258, 4017028, 2661787, 1468133,
        3887257, 3489900, 3803453, 3819625, 3462534, 2329218, 3438058, 3812583, 3748830,
        3656741, 2334691, 2071139, 1506169, 3709679, 3929364, 2016637, 3233521, 3895739,
        3568989, 3437711, 3826255, 1975293, 2477509, 3159705, 2730058, 2309885, 2362436,
        2422319, 3997807, 3892099, 3128467, 3149902, 2848525, 2493021, 465462, 3370606,
        3776401, 2812148, 3736248, 3244531, 3045370, 3618261, 3620149, 2013868, 3497038,
        1569338, 3822826, 2412888, 3439779, 1712720, 3219017, 3487551, 3777264, 3942927,
        2852232, 2219193, 1944535, 3782255, 3905343, 3682058, 3990813, 2546988, 3559370,
        2042837, 3846569, 3886652, 2694550, 3946191, 2692348, 3501161, 3171494, 3537233,
        3688008, 4001345, 1983752, 2067633, 3743574, 3626655, 3841554, 3676638, 2617783,
        2356280, 390687, 2748863, 3728275, 3882188, 2670135, 3940659, 3455398, 1876013,
        3280284, 2132278, 958018, 2035529, 2879457, 3703453, 2184051, 3046912, 3694306,
        3992921, 2938257, 3442750, 2207130, 1422545, 3720119, 2988142, 2870951, 3503365,
        2787426, 3356188, 669537, 3650207, 995650, 3748427, 3891296, 3982047, 3755992,
        2190604, 3927851, 887806, 3684331, 3672625, 3615092, 3346067, 1728529, 2609042,
        2532986, 2191164, 3425725, 3814520, 3999305, 3811687, 1601153, 3491379, 3611484,
        2990808, 2319365, 3313837, 3997270, 3279273, 3978962, 3342580, 3021004, 3804695,
        3735146, 3699079, 3689729, 3839259, 3528214, 1970120, 949675, 2051709, 2520438,
        3562106, 3902815, 1828077, 3745794, 3835599, 3937575, 3221787, 3774821, 3876052,
        2739026, 2655250, 3945032, 3950070, 3417265, 4024204, 2254540, 2820434, 1827272,
        2290210, 3404197, 3486395, 1887242, 2609855, 2659286, 3972955, 1424461, 3599627,
        1879126, 3692769, 3785905, 3845988, 2404622, 2547386, 3763210, 2545294, 2464933,
        3869507, 1467510, 3092042, 3108514, 3284189, 995183, 2130449, 2837832, 3480148,
        3957533, 3401783, 3985427, 2344024, 3602611, 300483, 3299133, 3916258, 2766222,
        3934494, 2114385, 3899578, 3932657, 3464116, 3450684, 2076695, 3817323, 3893089,
        2668021, 3220972, 3430608, 2354326, 3164886, 3026454, 2516513, 3856189, 3375303,
        3460886, 3826089, 2695635, 2640855, 3862514, 3420493, 3623374, 3767507, 3302920,
        3762024, 3439382, 3862800, 3966761, 3911263, 3760465, 2600814, 278009, 3092061,
        4041998, 2481284, 3364959, 3938906, 210359, 3886585, 1937884, 3653858, 2306068,
        3560480, 1781240, 3650111, 3609966, 1987545, 2518745, 341748, 3484943, 3036995,
        2848140, 3229608, 3766565, 3807485, 3507070, 3908684, 3979910, 3732692, 3927622,
        3948559, 3589774, 3693001, 3996581, 2341376, 2855343, 3911302, 3227533, 2700863,
        3383077, 3616134, 3837955, 3808379, 3473266, 2400206, 3534837, 3504237, 2748862,
        4009667, 3324405, 3912262, 3671875, 2489589, 3745062, 3778858, 3888401, 2042756,
        3549684, 3917716, 2901480, 1984387, 2059361, 3574080, 3420565, 3731348, 575512,
        3072801, 2408966, 711045, 3583311, 3162003, 4028582, 3491213, 2653035, 3672701,
        2828195, 3570272, 3586704, 3674209, 3681068, 1690195, 2892911, 1707214, 9338,
        3188399, 1562600, 3810785, 3733347, 3846330, 2680219, 3831405, 3861178, 3627937,
        3725376, 3612204, 3940010, 3570499, 1630778, 3811803, 1843412, 3913862, 3768801,
        211261, 3982438, 3030733, 3721774, 1423049, 2178894, 3587867, 269622, 2914067,
        3455435, 1028410, 3710821, 3995246, 3455607, 3755965, 3273135, 3731053, 3921779,
        2292694, 2563735, 3461650, 2301042, 3833612, 3139175, 4030083, 2612376, 3317459,
        3291154, 3839456, 3396143, 2477200, 3362882, 3809379, 3778178, 3893401, 3772610,
        3779505, 904398, 3727615, 3552453, 2769425, 3532858, 4029303, 3776936, 3441586,
        3785499, 2481495, 3379859, 3955030, 2726818, 2635446, 3937017, 2905417, 3533538,
        2125914, 2783284, 3846049, 1797568, 3753830, 1617888, 3407522, 3750491, 3492805,
        3958133, 2943548, 1884523, 3905643, 3535815, 3146146, 3811052, 3261402, 2863294,
        2149285, 2076604, 2664822, 3701198, 3937243, 3808867, 3532145, 2916354, 3848972,
        3033184, 3436802, 2736720, 2214641, 3277080, 3740199, 3070514, 3765588, 2681853,
        3788470, 3650538, 3140975, 2684392, 3935281, 3733741, 3725079, 3708772, 3919104,
        3353676, 3615786, 3653048, 2505320, 3982364, 2395964, 2973179, 3395301, 3340751,
        1180625, 3670910, 3621730, 3116388, 2558381, 3637644, 2665838, 3708390, 822634,
        2008507, 3692357, 4018972, 3549234, 3116792, 3619469, 3920730, 3944579, 2737115,
        116017, 3777324, 3434492, 3487438, 2127595, 2465123, 2515711, 3684659, 3034887,
        2377737, 4021293, 1281622, 3283753, 2062714, 3963952, 3442846, 2894269, 3673648,
        2543047, 2850338, 3237196, 3646065, 3384691, 711817, 3441395, 3943974, 6588,
        3115122, 2638036, 3747698, 2659296, 879273, 3498701, 3694419, 3747251, 3832642,
        3495489, 3399085, 2889011, 3107878, 592103, 2587645, 3378512, 3169900, 3954859,
        3153489, 3296925, 2106640, 3432692, 3447999, 3268429, 2718606, 2557917, 2192197,
        3973672, 2884227, 3403848, 2284998, 3685189, 2147182, 3917905, 3049308, 3203087,
        3649436, 3435615, 3574668, 3797614, 2565606, 2848729, 1726603, 2164056, 236240,
        2982417, 2727380, 2271465, 3503183, 2482076, 3595133, 796969, 3752181, 2733993,
        3589196, 3711798, 3183048, 3809109, 3809179, 3148924, 3376350, 3331441, 3859196,
        3598628, 3755084, 3165990, 3883828, 2351421, 3970810, 3524573, 2763589, 2029635,
        3425383, 3446218, 3629199, 2799051, 3898775, 2238276, 2077158, 4041081, 610407,
        3872638, 3564151, 1935018, 3708737, 2846590, 289811, 2375137, 2137207, 3634256,
        2825453, 2715649, 3229007, 3900591, 3392846, 3774480, 2866914, 3945465, 3032252,
        3747515, 3825160, 3552837, 2722347, 1644402, 2959456, 3942691, 2732494, 3696648,
        3186796, 3730575, 530571, 3783582, 3274471, 3301682, 3648659, 2975823, 3626448,
        2340664, 3516884, 2833111, 3126502, 1392656, 3772277, 3103393, 3161038, 3941530,
        2154897, 3671252, 3453763, 3368029, 3785518, 3757521, 3766011, 3304611, 984073,
        2978694, 3928917, 1301201, 2203458, 1645019, 3674108, 3680435, 1458813, 1561953,
        226322, 3003484, 3485633, 3721178, 3422711, 3858382, 1443076, 3378387, 3852490,
        1899678, 3669053, 2025939, 3636795, 3707395, 111337, 3763507, 3886032, 3824909,
        2117019, 2007373, 3597879, 1616187, 2746056, 3789513, 3534730, 3876225, 3788667,
        3748735, 3959451, 3942658, 3695907, 1589551, 2176987, 2795356, 3224029, 3429042,
        3536091, 75086, 3090973, 3611449, 3481577, 3190705, 1326025, 4002361, 3801443,
        3618422, 1868280, 2053144, 3811079, 3245878, 2036550, 3820729, 3856621, 47186,
        834584, 3701512, 3934254, 2613546, 3044497, 3761973, 3235719, 3649672, 3741311,
        2899416, 2704065, 3928755, 3932991, 3877028, 3713717, 3700726, 593980, 2688183,
        3860470, 3707768, 2774660, 3384537, 2107545, 3820565, 2693850, 3803892, 3756465,
        3660191, 3681108, 3811308, 3674183, 3076430, 3061877, 2908576, 3549950, 1980720,
        1664115, 3972942, 2764234, 1870193, 2108165, 3700389, 3896873, 3482246, 3284051,
        1669430, 3553469, 2449933, 2844788, 1826175, 3639349, 2802767, 2216424, 3300773,
        3440392, 3895986, 209485, 3378439, 2367561, 3810666, 2065355, 2692283, 2900034,
        3684235, 3739960, 3237502, 2777105, 3188105, 3255006, 1546499, 3166757, 2855542,
        3653826, 320224, 3962693, 2639705, 3444463, 2602187, 3906495, 3433832, 3719522,
        3022914, 2633591, 2376679, 2200818, 3490911, 1171959, 2762401, 2057764, 365236,
        1775453, 3258975, 2564260, 3782314, 2147989, 3927408, 584291, 322162, 3986466,
        1939400, 3616363, 3878658, 4040494, 2866126, 2814291, 2773281, 3582855, 3767605,
        3683869, 2379242, 2432069, 2165664, 3730937, 2308239, 132684, 3747921, 331868,
        3639456, 3889756, 3818240, 3470051, 3912268, 2744898, 2146069, 3693842, 3899422,
        3016725, 3969343, 3663460, 3956967, 133687, 3776862, 3555620, 4035448, 182490,
        3813096, 2650146, 4009037, 1670630, 3146495, 1514633, 3905920, 2837873, 3241185,
        2767810, 3070418, 3951855, 2963248, 3975931, 3013911, 2862590, 2049334, 2803425,
        2798434, 3881168, 3922682, 3728821, 3877515, 3605743, 2736668, 3490471, 3126570,
        1195126, 3629708, 882958, 3082657, 3120566, 3077786, 3801814, 1780160, 3484178,
        3711309, 3139891, 1551755, 1461614, 3041544, 3709623, 2112841, 2304727, 2898585,
        2697665, 3638971, 2090073, 3215917, 3745298, 3864314, 3681772, 3857250, 3956850,
        2982436, 3736401, 3291178, 3717938, 3854483, 3673166, 3912051, 4000098, 3354734,
        2903713, 3715509, 3347008, 453406, 2933781, 2610023, 3591141, 2563226, 2317895,
        3265109, 1265093, 2042927, 3924206, 2443070, 3259686, 3464845, 2707135, 3078862,
        1846544, 1941743, 226933, 3133548, 3775111, 2351227, 1402611, 519021, 3942909,
        3605711, 3638922, 2764215, 2802630, 3389800, 2317379, 3645122, 1985295, 3626654,
        2220265, 3076511, 2822967, 3343005, 2464549, 3522637, 3249261, 1972571, 3645617,
        3631033, 2268293, 2205869, 2573844, 1293206, 3233522, 3274409, 3750983, 2292071,
        375179, 3812429, 2294535, 3614114, 2420436, 3968693, 3872184, 2485197, 3470015,
        2972877, 11255, 1284243, 2377693, 3896231, 3409761, 3107636, 3985754, 2348559,
        3708085, 3248078, 2934092, 2164507, 3589926, 3674547, 2662883, 3608977, 3455584,
        3642449, 2085898, 3067397, 3696054, 2467192, 2830577, 3525640, 3904830, 1537338,
        3331497, 3875095, 3254961, 3826154, 3199664, 3658251, 2803473, 3267257, 3943754,
        1263842, 3675204, 2625639, 3679545, 1591697, 1900418, 462964, 3574253, 3180860,
        3186681, 2901143, 3919720, 1631560, 1458462, 1415254, 3930253, 3925204, 2669481,
        3446244, 2917282, 3128236, 2919609, 2700584, 3955993, 2671892, 2995427, 2834735,
        2017762, 3797116, 2987640, 2673937, 3555917, 3896879, 1739851, 2813661, 2935526,
        2368599, 2722740, 795535, 3539899, 1478582, 3849210, 3990138, 3274382, 2609161,
        3607845, 2387478, 3393691, 1755293, 3416468, 3671963, 3885855, 1738833, 3784191,
        3578340, 2965137, 3258430, 3690970, 3587237, 3736642, 1767972, 2495004, 2910604,
        3249148, 1467784, 1969256, 2406158, 3617748, 2606239, 3326198, 3657243, 2596817,
        3682737, 3211927, 126091, 2006058, 2414664, 3266203, 1950421, 3652839, 582200,
        2369333, 477315, 3623827, 3965956, 3621015, 3921540, 1971470, 3353935, 3378765,
        3524060, 3085382, 2431471, 4020155, 2194317, 2292332, 3968781, 3139320, 3830200,
        2740099, 1744761, 3714539, 3288946, 1993692, 4041280, 2872673, 3719401, 2385204,
        3947539, 1676878, 3719901, 3407521, 2499512, 3774306, 3838104, 3213771, 3824342,
        14505, 1900106, 2029408, 3267899, 3703402, 191408, 3818798, 2668185, 3918423,
        1960140, 2919386, 3973763, 2733711, 2553578, 3634653, 3867140, 575944, 2095703,
        3925794, 3623913, 1176863, 2730760, 2990761, 3579766, 2313341, 2220919, 3852188,
        3793281, 2488850, 3334993, 3949304, 3997199, 2873995, 2664379, 144716, 3959018,
        2821553, 3664271, 2683796, 3440650, 3041479, 3497354, 3842840, 3613240, 3317544,
        3367566, 2778996, 2390255, 1590521, 2224509, 3463781, 1729068, 2696369, 3409934,
        492030, 3025578, 2553504, 3687075, 3841404, 3722318, 3271177, 3305184, 2684774,
        3369867, 1025410, 3673113, 2971378, 3559310, 3377199, 3503002, 276310, 3780555,
        2125473, 3519117, 2145030, 3827289, 2387171, 1980360, 2155953, 3669868, 3714036,
        3933582, 2986324, 2135633, 652644, 2631745, 1311704, 2812526, 1742147, 3629063,
        3999063, 3279069, 2592588, 2370388, 3890076, 3852059, 3643941, 2653583, 1493272,
        3171075, 3937122, 2153284, 3797407, 3869778, 3936591, 186969, 2016825, 2690367,
        2262686, 2535050, 2158024, 935765, 2678885, 3851478, 3886317, 2190778, 1761961,
        2902388, 3852943, 2972863, 2317358, 3136034, 3968119, 3767570, 669879, 3907513,
        2636681, 2242061, 1599081, 3740093, 3236566, 301575, 3370093, 3351677, 3225726,
        2678810, 3370821, 3970923, 2689047, 3753239, 3086184, 3755930, 2811867, 3934067,
        3952341, 2254039, 3927481, 1833280, 3840391, 529322, 2627676, 2641757, 3718561,
        2783529, 1581042, 3441577, 1479920, 3957823, 3863061, 1021081, 3357000, 3927359,
        3476078, 2700953, 3827803, 3055396, 3486841, 3859378, 2740703, 977323, 3087379,
        2526867, 3880612, 3054343, 3107991, 2784302, 2675756, 2250292, 931420, 2770571,
        2586567, 2877046, 2598095, 3465799, 2763100, 1554256, 3977208, 3835009, 931242,
        3828347, 3992696, 2800860, 1403609, 3555347, 2737756, 2617705, 3816482, 2151279,
        1613634, 293121, 3030404, 2930776, 3624529, 3077578, 3560070, 3864725, 3517573,
        2875380, 2065939, 3766499, 3901076, 2992467, 3764344, 2603070, 2196923, 2892821,
        3032987, 3716053, 3693919, 2735737, 3936212, 3418295, 3905941, 2222916, 2761851,
        375128, 3240891, 2493703, 3794807, 1459457, 3881205, 2952405, 2379430, 2113808,
        2669746, 3298906, 2818703, 2486288, 2010305, 3028172, 3801839, 2002310, 3320382,
        1825359, 1772426, 2663799, 2543019, 3515500, 3748710, 3694001, 2780568, 3579490,
        2072407, 3824234, 3736720, 3447417, 3638886, 1985535, 3901883, 788155, 1913794,
        1565696, 2351162, 3465377, 3460225, 3186801, 494682, 2412448, 2114261, 3806431,
        2784135, 2495658, 3623419, 1904594, 2589323, 3454427, 3833072, 3026499, 3524907,
        3313059, 3830715, 3727633, 3472762, 4041190, 3259881, 3671408, 3204874, 3448640,
        3699199, 2441321, 995195, 3715000, 2288115, 906148, 3457251, 3773104, 3781333,
        2627675, 3150665, 2491140, 3853023, 3782766, 3225339, 3360464, 1595040, 2730602,
        2109428, 2806147, 3989752, 3605986, 2145872, 2746695, 3357431, 3541922, 3961304,
        3889665, 3964309, 3975962, 3726331, 3877332, 3633850, 2300830, 3354776, 2678501,
        2328418, 3909557, 375942, 3192063, 3767949, 2121413, 541153, 1947901, 3656122,
        2083884, 2505503, 3928216, 3496182, 2312928, 482795, 2702120, 3976683, 3935112,
        3198379, 3889727, 3915740, 3292000, 2995048, 3431920, 3065632, 3188191, 1858760,
        3938021, 2319127, 2755768, 3985936, 2816733, 3678168, 1531493, 1354213, 3460274,
        1097729, 3894656, 3768665, 3957483, 1602025, 1987122, 1268851, 1684471, 2486204,
        3429759, 3105951, 3722338, 2834133, 3645520, 3592540, 1962806, 3864824, 2236253,
        2224243, 1855129, 3669615, 3970891, 3674090, 3154841, 2687065, 3191297, 2459981,
        3090574, 2158066, 2248048, 2719800, 3298541, 3604911, 3758466, 3933623, 3475871,
        2495310, 2576669, 1719736, 2909873, 3324494, 3502574, 2174260, 2101000, 3706238,
        148961, 3890528, 1335182, 848125, 2173157, 2037780, 2746730, 3358388, 2138317,
        2699637, 2540965, 73918, 1035227, 3197599, 1703767, 2863086, 3475427, 2770464,
        2676040, 2606891, 2617076, 2712193, 3911680, 4023121, 3424559, 3730418, 2413095,
        2121132, 2713663, 3162809, 3703633, 2864733, 3069664, 3987439, 3635821, 1566810,
        3195591, 3558973, 2954369, 2667122, 1824444, 39551, 1339003, 2104167, 2984016,
        2153592, 2880949, 2008252, 3971906, 3110429, 983541, 3859109, 4019046, 3584826,
        3849384, 3665982, 3949598, 3728748, 3985266, 3723470, 3888897, 2771823, 2617864,
        3900097, 526419, 860546, 3623212, 1726273, 2741547, 2303784, 1660950, 2664004,
        3559127, 3971602, 1948472, 2587269, 2639163, 2757408, 1907670, 2795597, 3674446,
        2016827, 3759000, 2211830, 1828226, 2362565, 2076124, 3840608, 3465168, 2224800,
        3721906, 3831642, 2843677, 3185895, 3865502, 3395795, 2081854, 3729911, 3411403,
        3687863, 3077690, 3165209, 3648841, 3630051, 2175926, 3101625, 3650325, 791623,
        2555764, 3224266, 4042748, 2826456, 3942894, 3604193, 3703768, 3141394, 1921284,
        3788998, 2303770, 2969778, 1625200, 2589338, 1817159, 3798271, 1663951, 2957997,
        2084191, 185678, 3907844, 4002817, 3430681, 2388688, 2709470, 2561078, 2855415,
        3247727, 3580620, 3014862, 3562315, 4017638, 3821568, 3121557, 3563375, 3183416,
        550495, 3819444, 1609347, 3667373, 2650112, 3184355, 3861345, 2734501, 3385071,
        1875583, 2920393, 2711756, 2282199, 1553925, 3799841, 2459330, 2817353, 2467257,
        2877863, 2731350, 2558864, 3897481, 3865367, 3187426, 3674071, 2658996, 1961495,
        1289040, 2269292, 3714911, 3669067, 4058376, 1948535, 3803366, 3893038, 3582765,
        2146422, 2469700, 3780587, 2693291, 2107656, 3568348, 2165632, 3221005, 3070863,
        3888830, 3734916, 1505500, 3219038, 2819346, 2946673, 3157265, 3800224, 2798565,
        3404706, 3746618, 2653062, 1573075, 1161882, 2732755, 3460072, 3709698, 4013032,
        3089234, 158696, 2205288, 3627936, 4012815, 3052896, 3143713, 2195062, 3153509,
        2652864, 3183701, 2119205, 3132600, 3619452, 3181704, 2863584, 2301676, 2465105,
        3760317, 2057218, 3840211, 1139512, 3254819, 1946221, 3080876, 3483221, 4046692,
        2213705, 3884536, 3624998, 3862245, 3914288, 3615648, 3757243, 4039301, 3908857,
        3672854, 3851995, 2344040, 3986918, 2747571, 2837843, 3839279, 2487783, 745660,
        3872830, 2962758, 2571265, 1966780, 3567202, 2700522, 2687623, 3613163, 3892564,
        3806177, 3738638, 3798601, 3651630, 3323621, 3547804, 3560357, 2696067, 522924,
        2069731, 1988578, 3701791, 2378358, 3077283, 3016153, 3089509, 3177169, 3803457,
        445588, 2016129, 3839967, 3972500, 3543820, 3825693, 3419171, 1827223, 3508706,
        2016121, 2785999, 3583719, 2064237, 3853782, 2023858, 2735322, 2319576, 194414,
        1198956, 2364065, 3182862, 3863648
    ];

    const links = userIds.map(id => `https://www.torn.com/bazaar.php?userId=${id}`);

    let index = +localStorage.getItem('bazaarLinkIndex') || 0;
    if (index >= links.length) index = 0;

    // --- UI STYLES ---
    GM.addStyle(`
        #bazaarNavFloat {
            z-index: 999999;
            position: fixed;
            bottom: 80px;
            left: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #f9d835, #f1b600);
            color: #222;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 14px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.25);
            overflow: hidden;
            user-select: none;
            width: 140px;
        }
        #bazaarNavFloat button {
            background: linear-gradient(180deg, #fff799 0%, #ffd700 100%);
            border: 1px solid #b38f00;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            width: 100%;
            color: #333;
            text-shadow: 0 1px 1px #fff;
            transition: background 0.3s;
        }
        #bazaarNavFloat button:hover {
            background: linear-gradient(180deg, #ffe066 0%, #ffcc00 100%);
        }
        #bazaarNavFloat button.stopBtn {
            background: linear-gradient(180deg, #ff9999 0%, #ff4444 100%);
            color: white;
            border-color: #990000;
        }
        #bazaarNavFloat button.stopBtn:hover {
            background: linear-gradient(180deg, #ff6666 0%, #cc0000 100%);
        }
        #bazaarCounter {
            padding: 10px 14px;
            background: #fff2b0;
            color: #000;
            width: 100%;
            text-align: center;
            border-bottom: 1px solid #e6c200;
            position: relative;
        }
        #bazaarSettings {
            background: #fff;
            padding: 10px;
            font-size: 12px;
            text-align: left;
            border-top: 1px solid #ccc;
            display: none;
        }
        #bazaarSettings.show { display: block; }
        .setting-row { margin-bottom: 8px; }
        .setting-row input[type="number"] { width: 50px; }
        
        /* NEW: Highlight Class for Targets */
        .dsn-highlight {
            background-color: #e6ffec !important; /* Light Green */
            outline: 2px solid #00c853 !important; /* Strong Green border */
            box-shadow: 0 0 10px rgba(0, 200, 83, 0.4);
        }
    `);

    // --- UI CREATION ---
    const container = document.createElement('div');
    container.id = 'bazaarNavFloat';

    const counter = document.createElement('div');
    counter.id = 'bazaarCounter';
    counter.textContent = `${index + 1} / ${links.length}`;

    // Settings Toggle
    const settingsBtn = document.createElement('button');
    settingsBtn.textContent = 'âš™ Settings';
    settingsBtn.style.fontSize = '12px';
    settingsBtn.style.padding = '4px';
    settingsBtn.onclick = () => {
        settingsDiv.classList.toggle('show');
    };

    // Settings Panel
    const settingsDiv = document.createElement('div');
    settingsDiv.id = 'bazaarSettings';
    settingsDiv.innerHTML = `
        <div class="setting-row">
            <label><input type="checkbox" id="huntModeCheck"> <b>Hunt Mode</b></label>
        </div>
        <div class="setting-row">
            One-Click Buy:
            <select id="ocbSelect" style="font-size: 11px; margin-left: 5px;">
                <option value="off">Off</option>
                <option value="dollar">$1 Only</option>
                <option value="all">All Items</option>
            </select>
        </div>
        <div class="setting-row">
            <label><input type="checkbox" id="soundCheck"> Sound Alert</label>
        </div>
        <div class="setting-row">
            Min Profit %: <input type="number" id="profitInput" value="${config.minProfit}">
        </div>
        <div class="setting-row" style="border-top:1px solid #eee; padding-top:5px; margin-top:5px;">
            Jump to #: <input type="number" id="jumpInput" placeholder="#" style="width: 40px;">
            <button id="jumpBtn" style="width: auto; padding: 2px 6px; font-size: 10px; float: right;">GO</button>
        </div>
    `;

    // Next Button
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'Next';
    nextBtn.id = 'nextBtn';
    nextBtn.onclick = () => {
        index = (index + 1) % links.length;
        localStorage.setItem('bazaarLinkIndex', index);
        counter.textContent = `${index + 1} / ${links.length}`;
        window.location.href = links[index];
    };

    // Stop Button (Hidden by default)
    const stopBtn = document.createElement('button');
    stopBtn.textContent = 'STOP HUNT';
    stopBtn.className = 'stopBtn';
    stopBtn.style.display = 'none';
    stopBtn.onclick = () => {
        config.huntMode = false;
        saveConfig();
        huntCheck.checked = false;
        toggleStopBtn(false);
        console.log("Hunt stopped manually.");
    };

    const toggleStopBtn = (show) => {
        stopBtn.style.display = show ? 'block' : 'none';
        nextBtn.style.display = show ? 'none' : 'block';
    };

    // Attach to DOM
    container.append(counter, stopBtn, nextBtn, settingsBtn, settingsDiv);
    document.body.appendChild(container);

    // Event Listeners for Settings
    const huntCheck = settingsDiv.querySelector('#huntModeCheck');
    const ocbSelect = settingsDiv.querySelector('#ocbSelect');
    const soundCheck = settingsDiv.querySelector('#soundCheck');
    const profitInput = settingsDiv.querySelector('#profitInput');
    const jumpInput = settingsDiv.querySelector('#jumpInput');
    const jumpBtn = settingsDiv.querySelector('#jumpBtn');

    huntCheck.checked = config.huntMode;
    if (config.oneClickBuy === true) config.oneClickBuy = 'all';
    if (config.oneClickBuy === false) config.oneClickBuy = 'off';
    ocbSelect.value = config.oneClickBuy;
    soundCheck.checked = config.soundAlert;

    if(config.huntMode) toggleStopBtn(true);

    huntCheck.onchange = () => {
        config.huntMode = huntCheck.checked;
        saveConfig();
        toggleStopBtn(config.huntMode);
        if(config.huntMode) checkBazaar();
    };

    ocbSelect.onchange = () => {
        config.oneClickBuy = ocbSelect.value;
        saveConfig();
    };

    soundCheck.onchange = () => {
        config.soundAlert = soundCheck.checked;
        saveConfig();
    };

    profitInput.onchange = () => {
        config.minProfit = Number(profitInput.value);
        saveConfig();
    };

    // Jump Logic
    jumpBtn.onclick = () => {
        const targetIndex = parseInt(jumpInput.value, 10);
        if (targetIndex > 0 && targetIndex <= links.length) {
            index = targetIndex - 1; // Convert 1-based to 0-based
            localStorage.setItem('bazaarLinkIndex', index);
            counter.textContent = `${index + 1} / ${links.length}`;
            window.location.href = links[index];
        } else {
            alert(`Please enter a number between 1 and ${links.length}`);
        }
    };

    // --- LOGIC: RESET HOLD ---
    let pressTimer;
    const jumpToFirstLink = () => {
        index = 0;
        localStorage.setItem('bazaarLinkIndex', index);
        counter.textContent = `${index + 1} / ${links.length}`;
        counter.classList.remove('loading');
        window.location.href = links[0];
    };
    const startHold = () => {
        counter.classList.add('loading');
        pressTimer = setTimeout(jumpToFirstLink, 3000);
    };
    const clearHold = () => {
        counter.classList.remove('loading');
        clearTimeout(pressTimer);
    };
    counter.addEventListener('mousedown', startHold);
    counter.addEventListener('mouseup', clearHold);
    counter.addEventListener('mouseleave', clearHold);
    counter.addEventListener('touchstart', startHold);
    counter.addEventListener('touchend', clearHold);

    // --- LOGIC: ONE-CLICK BUY (OCB) ---
    // We detect if user initiated a purchase to prevent accidental auto-clicks
    let autoBuyActive = false;
    let autoBuyTimer = null;

    document.addEventListener('click', (e) => {
        if (config.oneClickBuy === 'off') return;
    
        // 1. Check if the clicked element is the shopping cart button
        const cartBtn = e.target.closest('button[data-testid="activate-buy-button"]');
    
        if (cartBtn) {
            let shouldBuy = false;

            if (config.oneClickBuy === 'all') {
                shouldBuy = true;
            } 
            else if (config.oneClickBuy === 'dollar') {
                // 2. Find the common parent container (Item Description)
                // We use 'item-description' because it contains both the button and the price
                const itemContainer = cartBtn.closest('[data-testid="item-description"]');
                
                if (itemContainer) {
                    // 3. Find the price element inside this specific item
                    const priceEl = itemContainer.querySelector('[data-testid="price"]');
                    
                    if (priceEl) {
                        const price = getPriceFromElement(priceEl);
                        console.log(`OCB Debug: Clicked item price parsed as: $${price}`);

                        if (price === 1) shouldBuy = true;
                    } else {
                        console.log("OCB Debug: Price element not found!");
                    }
                } else {
                    console.log("OCB Debug: Item container not found!");
                }
            }

            // 6. Trigger the Auto-Buy Sequence if matched
            if (shouldBuy) {
                autoBuyActive = true;
                clearTimeout(autoBuyTimer);
                autoBuyTimer = setTimeout(() => { autoBuyActive = false; }, 2000);
                console.log("OCB: Auto-buy activated.");
            }
        }
    });

    const checkAutoBuy = () => {
        if (config.oneClickBuy === 'off' || !autoBuyActive) return;

        // Step 2: "Buy" button (in the quantity modal)
        const buyBtn = document.querySelector('button[data-testid="buy-button"]');
        if (buyBtn) {
            buyBtn.click();
            return;
        }

        // Step 3: "Yes" button (final confirmation)
        const yesBtn = document.querySelector('button[aria-label="Yes"]');
        if (yesBtn) {
            yesBtn.click();
            autoBuyActive = false; // Reset cycle
            return;
        }
    };


    // --- MAIN BAZAAR LOGIC ---
    if (window.location.href.includes('bazaar.php') || window.location.href.includes('userId=')) {
        
        let sorted = false;
        let actionTaken = false;

        const checkBazaar = () => {
            // Priority check for OCB every cycle
            checkAutoBuy();

            if (actionTaken) return;

            // 1. Sort by Cost first
            if (!sorted) {
                const costButton = document.querySelector('button[aria-label="Search bar button: Cost"]');
                if (costButton) {
                    if (!costButton.className.includes('active')) {
                        costButton.click();
                    }
                    sorted = true;
                    // Wait a split second for sort to apply before scanning items
                    setTimeout(checkBazaar, 500); 
                    return;
                }
            }

            // 2. Check for "Closed" or "Empty"
            const allDivs = document.querySelectorAll('div');
            for (let div of allDivs) {
                if (div.textContent === "This user has no items in their bazaar" || 
                    div.textContent === "This bazaar is currently closed") {
                    
                    console.log("Skipping closed/empty bazaar...");
                    actionTaken = true;
                    nextBtn.click();
                    return;
                }
            }

            // 3. HUNT MODE LOGIC
            if (config.huntMode && sorted) {
                const items = document.querySelectorAll('div[class*="item___"]'); // General item container selector
                let foundTarget = false;
                let foundMessage = "";

                items.forEach(item => {
                    // Check if Locked (red lock icon or grayed out)
                    const isLocked = item.querySelector('.lockedOverlay___bUSpP') || item.querySelector('.isBlockedForBuying___dv7DR');
                    if (isLocked) return; // Skip locked items completely

                    const priceEl = item.querySelector('div[data-testid="price"]');
                    if (!priceEl) return;
                    
                    const price = getPriceFromElement(priceEl);
                    let isTarget = false;

                    // Check for $1 Item
                    if (price === 1) {
                        foundTarget = true;
                        isTarget = true;
                        foundMessage = "FOUND $1!";
                    }

                    // Check for Profit % (TornTools)
                    const rateDiv = item.querySelector('.rates___YCU9W');
                    if (rateDiv) {
                        // CRITICAL: Check if class contains 'low' (Profit)
                        if (rateDiv.className.includes('low')) {
                            const rateSpan = rateDiv.querySelector('span');
                            if (rateSpan) {
                                const profitTxt = rateSpan.textContent.replace('%', '');
                                const profit = parseFloat(profitTxt);
                                
                                if (profit >= config.minProfit) {
                                    foundTarget = true;
                                    isTarget = true;
                                    foundMessage = `PROFIT ${profit}%!`;
                                }
                            }
                        }
                    }

                    // HIGHLIGHT TARGET ITEM
                    if (isTarget) {
                        item.classList.add('dsn-highlight');
                    }
                });

                if (foundTarget) {
                    // Stop! Don't click next.
                    console.log(foundMessage);
                    counter.style.background = "#55ff55"; // Green alert
                    counter.textContent = foundMessage;
                    
                    // Stop, but allow resume on next click
                    toggleStopBtn(false); // Show Next Button
                    
                    playSound();
                    actionTaken = true; // Prevents further loops
                } else {
                    // Nothing found, and we are in Hunt Mode -> NEXT
                    console.log("No targets found. Next...");
                    actionTaken = true;
                    nextBtn.click();
                }
            }
        };

        // Observe for loading changes
        const observer = new MutationObserver(() => {
            checkBazaar();
        });
        observer.observe(document.body, { childList: true, subtree: true });
    }

})();