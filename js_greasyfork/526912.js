// ==UserScript==
// @name         Blik spam bot
// @namespace    http://tampermonkey.net/
// @version      0.0.4
// @license MIT
// @description  Make blik fun again
// @author       Serhii T
// @include http*://*.the-west.*/game.php*
// @include http*://*.the-west.*.*/game.php*
// @require https://update.greasyfork.org/scripts/490628/1468386/Ajax%20Async%20Lib.js
// @icon         https://www.google.com/s2/favicons?sz=64&domain=ru.com
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/526912/Blik%20spam%20bot.user.js
// @updateURL https://update.greasyfork.org/scripts/526912/Blik%20spam%20bot.meta.js
// ==/UserScript==


/*
  * `window.Map.blikSpamBot.start()` - start spamming
 */
(function() {
  'use strict';

  const mailExcludedPlayers = [];
  const friendExcludedPlayers = [];
  const FRIEND_MIN_LEVEL = 120;
  let totalPages = 0;
  let currentPage = 1;
  let pages = [];
  let isFullListOfFriends = false;
  let playersSendCound = 0;

  const suggestions = [
    "Игрок регулярно использует оскорбительные выражения в чате, унижая других участников. Такое поведение нарушает правила и создает токсичную атмосферу в сообществе.",
    "Игрок замечен в использовании сторонних программ, дающих ему преимущество над другими. Это подрывает честность игры и нарушает баланс.",
    "Пользователь постоянно отправляет одинаковые сообщения в чат, создавая бесполезный поток информации. Это мешает нормальному общению и затрудняет координацию команды.",
    "Игрок выдает себя за администратора, вводя других в заблуждение. Это может привести к потере доверия к официальным представителям игры.",
    "Никнейм пользователя содержит ненормативную лексику и оскорбления. Это нарушает правила игры и может быть неприятным для других участников.",
    "Аватар игрока содержит непристойные изображения, которые могут оскорбить других участников сообщества. Администрация должна принять меры по удалению такого контента.",
    "Игрок часто бездействует во время важных игровых событий, оставляя команду без поддержки. Это мешает честной игре и ухудшает игровой опыт для остальных.",
    "Игрок намеренно атакует своих союзников, нанося им урон и мешая игровому процессу. Такое поведение разрушает командную игру и нарушает правила честного соперничества.",
    "Игрок распространяет в чате агрессивные высказывания, направленные на разжигание конфликтов. Это создает негативную атмосферу и может привести к конфликтам в сообществе.",
    "Пользователь использует игровые баги для получения личной выгоды, обходя стандартные механики. Это нарушает баланс и делает игру нечестной.",
    "Игрок занимается продажей аккаунтов, что запрещено правилами. Такие действия могут привести к мошенничеству и потере доступа к учетным записям.",
    "Игрок постоянно выпрашивает у других ресурсы, мешая нормальному взаимодействию. Такое поведение раздражает других пользователей и мешает честной игре.",
    "Пользователь рекламирует сторонние ресурсы в чате, отправляя ссылки на подозрительные сайты. Это может привести к фишинговым атакам и утечке личных данных.",
    "Игрок обманывает других участников, выдавая ложную информацию о сделках или игровых механиках. Это создает недоверие и вредит сообществу.",
    "В чате регулярно появляются оскорбительные высказывания на почве национальности, что нарушает правила игры. Такое поведение недопустимо и требует немедленного вмешательства администрации.",
    "Игрок оскорбляет людей по религиозным убеждениям, провоцируя конфликты в сообществе. Это противоречит принципам уважения и равенства в игре.",
    "Пользователь использует гендерные оскорбления для унижения других игроков. Такое поведение нарушает правила игры и создает небезопасную среду.",
    "Игрок распространяет ложные сведения о механиках игры, вводя новичков в заблуждение. Это мешает новым участникам адаптироваться и усложняет их игровой процесс.",
    "Создание множества фейковых аккаунтов для накрутки голосов или обхода наказаний подрывает честность игры. Администрация должна принять меры для предотвращения подобных действий.",
    "Игрок массово рассылает фейковые новости о событиях в игре, вызывая паническую реакцию у других пользователей. Это дестабилизирует сообщество и нарушает игровой баланс.",
    "Пользователь систематически провоцирует других игроков в чате, создавая напряженную обстановку. Это ухудшает игровой опыт и вызывает ненужные конфликты.",
    "Игрок запугивает других пользователей, угрожая им в личных сообщениях. Такое поведение недопустимо и должно быть немедленно остановлено.",
    "Игрок нарушает правила торговли, намеренно занижая или завышая цены на предметы. Это вредит экономике игры и мешает честной конкуренции.",
    "Пользователь пытается обойти систему банов, создавая новые учетные записи после блокировки. Такое поведение нарушает политику честной игры.",
    "Игрок систематически отправляет одинаковые сообщения в чат, создавая помехи для других участников. Такое поведение мешает общению и делает чат нечитаемым.",
    "Пользователь публикует ложные сведения о предстоящих игровых событиях, сбивая с толку других игроков. Это создает хаос в игровом сообществе.",
    "Игрок нарушает правила форума, публикуя оскорбительные или неуместные сообщения. Это ухудшает качество общения и создаёт негативную атмосферу.",
    "Игрок злоупотребляет возможностью голосования в игровых опросах, накручивая голоса. Это нарушает принципы честности и мешает объективному принятию решений.",
    "Пользователь рассылает личные сообщения с угрозами другим игрокам. Это создаёт небезопасную среду и должно быть пресечено.",
    "Игрок постоянно использует токсичный юмор и провокационные комментарии, унижая окружающих. Это формирует враждебную атмосферу и мешает нормальному общению.",
    "Пользователь намеренно создаёт помехи в командных боях, срывая стратегии союзников. Такое поведение делает игру несправедливой.",
    "Игрок отказывается выполнять договорённости в торговле, обманывая партнёров. Это снижает доверие между участниками и ухудшает игровой опыт.",
    "Пользователь публикует в чате запрещённый контент, включая сцены насилия и экстремизм. Это нарушает правила и должно быть удалено.",
    "Игрок выдаёт себя за другого человека, используя чужие никнеймы и аватары. Это вводит в заблуждение других пользователей и мешает идентификации.",
    "Пользователь спамит чат бессмысленными символами, мешая другим игрокам следить за важной информацией. Это делает общение невозможным.",
    "Игрок целенаправленно мешает новым участникам освоиться, дезинформируя их и создавая преграды. Такое поведение недопустимо в дружелюбном сообществе.",
    "Игрок использует ненормативную лексику в чате, оскорбляя других участников. Это нарушает правила игры и создаёт негативную атмосферу.",
    "Пользователь неоднократно использует сторонние программы для получения нечестного преимущества. Это делает игру несправедливой.",
    "Игрок постоянно спамит одинаковыми сообщениями в чате, мешая нормальному общению. Это раздражает участников и затрудняет координацию.",
    "Пользователь выдаёт себя за администратора, вводя других игроков в заблуждение. Это может привести к недоверию к реальным модераторам.",
    "Игрок использует никнейм с оскорбительными словами, что нарушает правила игры и может задеть других пользователей.",
    "Аватар игрока содержит непристойные или запрещённые изображения. Это нарушает правила сообщества и должно быть удалено.",
    "Игрок намеренно бездействует в командных боях, оставляя союзников в невыгодном положении. Это мешает честной игре.",
    "Пользователь атакует союзников, мешая команде выполнять задания. Это подрывает командный дух и портит игровой процесс.",
    "Пользователь распространяет в чате сообщения с агрессивным содержанием, провоцируя конфликты между игроками. Это создаёт токсичную обстановку.",
    "Игрок использует баги для получения игрового преимущества, нарушая баланс игры. Это делает игру несправедливой для других участников.",
    "Пользователь занимается продажей игровых аккаунтов, что запрещено правилами. Это может привести к мошенничеству и потере доступа к аккаунтам.",
    "Игрок выпрашивает у других ресурсы, создавая дискомфорт для остальных участников. Такое поведение раздражает и мешает игре.",
    "Пользователь рассылает ссылки на сторонние сайты, рекламируя непроверенные ресурсы. Это может быть опасно для безопасности данных игроков.",
    "Игрок вводит новичков в заблуждение, сообщая им ложную информацию о механиках игры. Это мешает их адаптации и ухудшает игровой опыт.",
    "Пользователь создаёт фейковые аккаунты для обхода блокировок. Это нарушает политику честной игры и требует мер со стороны администрации.",
    "Игрок намеренно распространяет ложные сведения о событиях в игре, вызывая хаос в сообществе. Это дестабилизирует игровую среду.",
    "Пользователь провоцирует других игроков, подстрекая их на конфликты. Это создаёт враждебную атмосферу и портит игру.",
    "Игрок отправляет личные сообщения с угрозами другим пользователям. Такое поведение нарушает правила безопасности сообщества.",
    "Игрок манипулирует игровыми ценами, искусственно завышая или занижая их. Это подрывает честную экономику в игре.",
    "Пользователь систематически флудит в игровом чате, делая его нечитаемым для других игроков. Это мешает нормальному взаимодействию.",
    "Игрок нарушает правила форума, публикуя неуместные или оскорбительные комментарии. Это ухудшает качество общения.",
    "Пользователь злоупотребляет голосованиями, накручивая голоса в опросах. Это мешает объективному принятию решений в игре.",
    "Игрок публикует запрещённый контент, включая сцены насилия и экстремизм. Это нарушает правила платформы и должно быть удалено.",
    "Пользователь создаёт множество аккаунтов для накрутки рейтинга. Это подрывает соревновательный баланс в игре.",
    "Игрок намеренно дезинформирует других участников, вводя их в заблуждение. Это мешает справедливому игровому процессу.",
    "Пользователь спамит в чате бессмысленными символами, затрудняя чтение важных сообщений. Это раздражает других игроков.",
    "Игрок целенаправленно мешает новым пользователям освоиться в игре. Это создаёт негативный опыт для новичков.",
    "Пользователь рассылает сообщения с мошенническими предложениями. Это угрожает безопасности других игроков.",
    "Игрок намеренно выходит из игры во время матчей, оставляя команду в невыгодном положении. Это снижает качество игрового процесса.",
    "Пользователь злоупотребляет функцией жалоб, отправляя ложные репорты на других игроков. Это мешает честному разбирательству нарушений.",
    "Игрок использует ботов для автоматического сбора ресурсов. Это нарушает баланс и честную конкуренцию.",
    "Пользователь намеренно задерживает игровое время, не выполняя действий в решающие моменты. Это мешает нормальному игровому процессу.",
    "Игрок регулярно меняет ники, чтобы скрыть свою личность после нарушений. Это затрудняет модерацию и требует вмешательства администрации.",
    "Пользователь намеренно использует уязвимости в игре для получения нелегитимного преимущества. Это подрывает честную игру.",
    "Игрок создаёт мультиаккаунты для искусственного увеличения своих игровых показателей. Это нарушает политику честной игры.",
    "Пользователь устраивает личные разборки в игровом чате, отвлекая других игроков от процесса. Это создаёт негативную атмосферу.",
    "Игрок игнорирует игровые события, не вносит вклад в команду, но получает награды. Это несправедливо по отношению к активным участникам.",
    "Пользователь намеренно мешает другим выполнять квесты, блокируя доступ к важным ресурсам. Это нарушает принципы честной игры.",
    "Игрок рассылает в чате ссылки на сторонние сервисы, предлагающие читы и взломанные версии игры. Это недопустимо.",
    "Пользователь намеренно выдаёт себя за другого человека, используя схожие никнеймы. Это вводит в заблуждение сообщество.",
    "Игрок использует нецензурные выражения в адрес администрации, демонстрируя неуважение к правилам. Такое поведение должно быть пресечено.",
    "Игрок сознательно вступает в команды противников, чтобы передавать им информацию о стратегии. Это нарушает принципы честной конкуренции.",
    "Пользователь угрожает раскрытием личных данных других игроков. Это серьёзное нарушение безопасности.",
    "Игрок злоупотребляет функцией жалоб, создавая давление на модераторов без реальных оснований. Это мешает работе администрации.",
    "Пользователь создаёт кланы исключительно для троллинга и провокаций. Это портит атмосферу в игровом сообществе.",
    "Игрок намеренно затягивает сражения, избегая участия в боях. Это замедляет игровой процесс и раздражает других участников."
  ];


  let blikSpamBot = {};
  window.Map.blikSpamBot = blikSpamBot;

  blikSpamBot.start = async function() {
    await banDoctor();

    const allPlayers = await getAllPlayers();

    // send mass mail every 30 seconds
    setInterval(() => {
      if (playersSendCound < 500) {
        sendMail(allPlayers);
      }
    }, 5000);

    // send chat messages every 5 seconds
    setInterval(() => {
      sendMessageToAllChats();
    }, 5000);

    // Send friends invite
    // await sendInvites(allPlayers);

    // run until all pages are handled
    do {
      await postSuggestionsForCurrentPage();
    } while (!!pages.length);
  }

  blikSpamBot.postSuggestion = async function(playerId, suggestion) {
    console.log('Posting suggestion for player', playerId);
    PlayerProfileWindow.open(playerId);
    await wait();
    $('.interact-affront').click();
    await wait();
    $('#iss_desc').val(suggestion || getRandomSuggestion());
    await wait(1000);
    Suggestion.submit();
    // Suggestion.cancel(); // for testing
    await wait();
    $('#thr').hide();
    $(`.playerprofile-${playerId}`).find('.tw2gui_window_buttons_close').click();
    Suggestion.cancel();
  }

  async function banDoctor() {
    const playerId = 5261784; // Дохтор
    await blikSpamBot.postSuggestion(playerId, 'Этот человек забирает все летние пончо');
    await sendFriendInvite('Дохтор');
  }

  async function postSuggestionsForCurrentPage() {
    console.log('Spam players for page', currentPage);
    const players = await getPlayersForPage(currentPage);

    for (let i = 0; i < players.length; i++) {
      const player = players[i];
      // Send suggestion
      await blikSpamBot.postSuggestion(player.player_id);
    }
  }

  async function sendInvites(players) {
    const allowedFriends = players.filter(player => !friendExcludedPlayers.includes(player.name) && player.level > FRIEND_MIN_LEVEL);
    for (let i = 0; i < allowedFriends.length; i++) {
      if (isFullListOfFriends) {
        break;
      }
      const player = allowedFriends[i];
      await sendFriendInvite(player.name);
      await wait(3000);
    }
  }

  function sendFriendInvite(playerName) {
    return AjaxAsync.remoteCall('character', 'add_friend', {friend_name: playerName})
      .then(function (json) {
        if (json.error && json.msg === 'Достигнуто максимальное количество друзей') {
          isFullListOfFriends = true;
          console.log('Stop sending friend invites. The list is full');
        }
    });
  }

  async function sendMail(players) {
    const to = players
      .slice(playersSendCound, playersSendCound + 5)
      .map(player => player.name)
      .filter((name) => !mailExcludedPlayers.includes(name))
      .join(';');
    const resp = await AjaxAsync.remoteCall('messages', 'send', {
      to: to,
      subject: 'Свободу доктору!',
      text: 'Доктору нужна ваша помощь! Он заблокирован злой админшей и не может выбраться. Помогите ему вернуться на свободу!',
      masstelegramm: true
    });

    // Check if some players blocked me
    if (!resp[0]) {
      if (resp[2] != null && (resp[2][0] == 'block' || resp[2][0] == 'not_found')) {
        mailExcludedPlayers.push(...resp[2][1]);
        await sendMail(players);
      }
    } else {
      playersSendCound += 5;
    }
  }

  function sendMessageToAllChats() {
    const emoji = [':)', ':D', ':(', ';)', ':x', '>.<', '-.-', 'O.o', '^_^', 'add me'];
    const randomEmoji = emoji[Math.floor(Math.random() * emoji.length)];
    const randomCount = Math.floor(Math.random() * 10) + 1;
    const randomEmojiString = `${randomEmoji} `.repeat(randomCount);

    const rooms = Object.keys(Chat.MyClient.rooms);
    const activeRooms = rooms.filter((room)=> Chat.MyClient.rooms[room]);
    activeRooms.forEach((room) => {
      Chat.Request.Send(randomEmojiString, room);
    })
  }

  async function getPlayersForPage(page) {
    return AjaxAsync.remoteCallMode('ranking', 'get_data', {
      page: page,
      tab: 'experience',
    }).then(function (json) {
      if (!json.error) {
        totalPages = Math.min(json.pages, 60);
        if (!pages.length) {
          // Create array [1,2,3,... json.pages]
          pages = Array.from({ length: totalPages }, (_, i) => i + 1);
        }
        console.log('pages', pages);
        currentPage = getRandomPage(pages);

        return json.ranking;
      }
    })
  }

  async function getAllPlayers() {
    return AjaxAsync.remoteCallMode('ranking', 'get_data', {
      page: 0,
      tab: 'experience',
      entries_per_page: 1000
    }).then(function (json) {
      return json.ranking || [];
    })
  }

   async function wait(time = 3000) {
    return new Promise((resolve) => {
      setTimeout(() => {
        resolve();
      }, time);
    });
  }

  function getRandomPage(arr) {
    const randomIndex = Math.floor(Math.random() * arr.length); // Get random index
    const randomValue = arr[randomIndex]; // Get random value
    arr.splice(randomIndex, 1); // Remove it from the array
    return randomValue;
  };

  function getRandomSuggestion() {
    const randomIndex = Math.floor(Math.random() * suggestions.length);
    return suggestions[randomIndex];
  }
})();
