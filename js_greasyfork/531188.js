// ==UserScript==
// @name         Notion clipper
// @namespace    http://tampermonkey.net/
// @version      22.2.9
// @description  ä»æ¼«ç”»/å°è¯´ç½‘ç«™æå–ä¿¡æ¯å¹¶å¯¼å…¥Notionæ•°æ®åº“ï¼Œæ”¯æŒå¯è§†åŒ–CSSé€‰æ‹©å™¨è·å–å’Œè‡ªå®šä¹‰é…ç½®ï¼Œæ”¯æŒæ•°æ®è‡ªåŠ¨æ›´æ–°å’ŒAPIé…ç½®
// @author       pipi
// @match        *://*/*
// @grant        GM_xmlhttpRequest
// @grant        GM_notification
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_deleteValue
// @grant        GM_listValues
// @grant        GM_setClipboard
// @grant        GM_addStyle
// @grant        GM_registerMenuCommand
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@11
// @require      https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js
// @connect      notion.com
// @connect      api.notion.com
// @connect      api.github.com
// @license      pipi
// @icon         https://github.com/pipiorange030/photoroom-public/blob/main/%E7%B4%A0%E6%9D%90/20251026153607.png?raw=true
// @downloadURL https://update.greasyfork.org/scripts/531188/Notion%20clipper.user.js
// @updateURL https://update.greasyfork.org/scripts/531188/Notion%20clipper.meta.js
// ==/UserScript==

(function() {
    'use strict';
    // ============================================================================
    // 1. æ ¸å¿ƒæ¨¡å—ï¼šæ™ºèƒ½äº¤äº’æ§åˆ¶ (æ‹–æ‹½ã€å¸é™„ã€é•¿æŒ‰ã€ç‚¹å‡»åˆ†ç¦»)
    // ============================================================================
    const SmartInteract = (() => {
        // --- é…ç½®å‚æ•° ---
        const CONFIG = {
            LONG_PRESS_DELAY: 500,  // é•¿æŒ‰åˆ¤å®šæ—¶é—´(ms)
            DRAG_THRESHOLD: 3,      // ç§»åŠ¨è¶…è¿‡3åƒç´ è§†ä¸ºæ‹–æ‹½
            SNAP_MARGIN: 16,        // å¸é™„è¾¹è·
            VIBRATE_DURATION: 50    // éœ‡åŠ¨æ—¶é•¿
        };

        /**
     * ç»‘å®šäº¤äº’äº‹ä»¶
     * @param {HTMLElement} trigger - è§¦å‘äº¤äº’çš„å…ƒç´ 
     * @param {HTMLElement} container - éœ€è¦ç§»åŠ¨çš„å®¹å™¨
     * @param {Object} callbacks - å›è°ƒ { onClick, onLongPress, onDown, onUp, onDragStart }
     */
        function bind(trigger, container, callbacks = {}) {
            const { onClick, onLongPress, onDown: extOnDown, onUp: extOnUp, onDragStart } = callbacks;

            // --- çŠ¶æ€å˜é‡ ---
            let state = {
                shiftX: 0, shiftY: 0,   // åç§»é‡
                startX: 0, startY: 0,   // åˆå§‹åæ ‡
                timer: null,            // é•¿æŒ‰å®šæ—¶å™¨
                isDragging: false,      // æ˜¯å¦æ‹–æ‹½ä¸­
                isLongPress: false,     // æ˜¯å¦é•¿æŒ‰
                hasMoved: false         // æ˜¯å¦å‘ç”Ÿç§»åŠ¨
            };

            // --- å†…éƒ¨å‡½æ•°ï¼šè¾¹ç¼˜å¸é™„é€»è¾‘ ---
            const snapToEdge = () => {
                if (!container) return;

                // 1. å¼€å¯è¿‡æ¸¡åŠ¨ç”»
                container.style.transition = 'all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';

                const rect = container.getBoundingClientRect();
                const { innerWidth: vw, innerHeight: vh } = window;
                const margin = CONFIG.SNAP_MARGIN;

                // 2. è®¡ç®—å››è¾¹è·ç¦»
                const dists = {
                    left: rect.left,
                    right: vw - rect.right,
                    top: rect.top,
                    bottom: vh - rect.bottom
                };

                // 3. å–æœ€è¿‘è¾¹
                const minKey = Object.keys(dists).reduce((a, b) => dists[a] < dists[b] ? a : b);

                // 4. é‡ç½®å®šä½æ ·å¼
                container.style.left = container.style.right = container.style.top = container.style.bottom = 'auto';

                // 5. åº”ç”¨å¸é™„ä½ç½®
                if (minKey === 'left') {
                    container.style.left = margin + 'px';
                    container.style.top = rect.top + 'px';
                } else if (minKey === 'right') {
                    container.style.right = margin + 'px';
                    container.style.top = rect.top + 'px';
                } else if (minKey === 'top') {
                    container.style.top = margin + 'px';
                    container.style.left = rect.left + 'px';
                } else { // bottom
                    container.style.bottom = margin + 'px';
                    container.style.left = rect.left + 'px';
                }

                // 6. æŒä¹…åŒ–ä¿å­˜ä½ç½®
                setTimeout(() => {
                    const final = container.getBoundingClientRect();
                    GM_setValue('float_btn_left', Math.max(0, Math.round(final.left)));
                    GM_setValue('float_btn_bottom', Math.max(0, Math.round(vh - final.bottom)));
                    container.style.transition = 'none'; // å…³é—­åŠ¨ç”»
                }, 300);

                // å…¼å®¹å¤–éƒ¨å®šä½ä¿®æ­£
                try { if(typeof positionTagButton === 'function') positionTagButton(); } catch (_) {}
            };

            // --- äº‹ä»¶ï¼šæŒ‰ä¸‹ (MouseDown / TouchStart) ---
            const onDown = (e) => {
                if (e.type === 'mousedown' && e.button !== 0) return; // ä»…å·¦é”®

                // æ‰§è¡Œå¤–éƒ¨ä¼ å…¥çš„æŒ‰ä¸‹å›è°ƒ (ç”¨äºTagæŒ‰é’®å˜è‰²)
                if (extOnDown) extOnDown(e);

                const p = e.touches ? e.touches[0] : e;

                // é”å®šåæ ‡ï¼Œå‡†å¤‡æ‹–æ‹½
                if (container) {
                    container.style.transition = 'none';
                    container.style.willChange = 'left, top';
                    const rect = container.getBoundingClientRect();
                    state.shiftX = p.clientX - rect.left;
                    state.shiftY = p.clientY - rect.top;
                    container.style.left = rect.left + 'px';
                    container.style.top = rect.top + 'px';
                    container.style.right = 'auto';
                    container.style.bottom = 'auto';
                }

                // é‡ç½®çŠ¶æ€
                state.startX = p.clientX;
                state.startY = p.clientY;
                state.isDragging = state.isLongPress = state.hasMoved = false;

                // å¯åŠ¨é•¿æŒ‰å®šæ—¶å™¨
                if (onLongPress) {
                    state.timer = setTimeout(() => {
                        if (!state.isDragging && !state.hasMoved) {
                            state.isLongPress = true;
                            if (navigator.vibrate) navigator.vibrate(CONFIG.VIBRATE_DURATION);
                            onLongPress(e);
                        }
                    }, CONFIG.LONG_PRESS_DELAY);
                }

                // ç»‘å®šåç»­äº‹ä»¶
                const moveEvent = e.type === 'touchstart' ? 'touchmove' : 'mousemove';
                const upEvent = e.type === 'touchstart' ? 'touchend' : 'mouseup';
                window.addEventListener(moveEvent, onMove, { passive: false });
                window.addEventListener(upEvent, onUp, { passive: false });
            };

            // --- äº‹ä»¶ï¼šç§»åŠ¨ (MouseMove / TouchMove) ---
            const onMove = (e) => {
                const p = e.touches ? e.touches[0] : e;
                const dx = p.clientX - state.startX;
                const dy = p.clientY - state.startY;

                // åˆ¤å®šæ˜¯å¦å¼€å§‹æ‹–æ‹½
                if (!state.hasMoved && (Math.abs(dx) > CONFIG.DRAG_THRESHOLD || Math.abs(dy) > CONFIG.DRAG_THRESHOLD)) {
                    state.hasMoved = true;
                    if (state.timer) clearTimeout(state.timer); // å–æ¶ˆé•¿æŒ‰

                    // [å…³é”®ä¿®å¤] ä¸€æ—¦å¼€å§‹æ‹–æ‹½ï¼Œé€šçŸ¥å¤–éƒ¨ (ç”¨äºå–æ¶ˆTagæŒ‰é’®å†…éƒ¨çš„å®šæ—¶å™¨)
                    if (onDragStart) onDragStart(e);
                }

                // æ‰§è¡Œæ‹–æ‹½
                if (state.hasMoved && container) {
                    state.isDragging = true;
                    if (e.cancelable) e.preventDefault();
                    container.style.left = (p.clientX - state.shiftX) + 'px';
                    container.style.top = (p.clientY - state.shiftY) + 'px';
                }
            };

            // --- äº‹ä»¶ï¼šæŠ¬èµ· (MouseUp / TouchEnd) ---
            const onUp = (e) => {
                if (state.timer) clearTimeout(state.timer);
                if (container) container.style.willChange = 'auto';

                // æ‰§è¡Œå¤–éƒ¨ä¼ å…¥çš„æŠ¬èµ·å›è°ƒ (ç”¨äºTagæŒ‰é’®æ¢å¤æ ·å¼)
                if (extOnUp) extOnUp(e);

                // ç§»é™¤ç›‘å¬
                window.removeEventListener('touchmove', onMove);
                window.removeEventListener('touchend', onUp);
                window.removeEventListener('mousemove', onMove);
                window.removeEventListener('mouseup', onUp);

                // åˆ†æ”¯é€»è¾‘
                if (state.isDragging) {
                    snapToEdge(); // å¸é™„
                    // é˜»æ­¢ç‚¹å‡»
                    const prevent = (ev) => { ev.stopPropagation(); ev.preventDefault(); };
                    trigger.addEventListener('click', prevent, { capture: true, once: true });
                } else if (!state.isLongPress && onClick) {
                    // æ‰§è¡Œç‚¹å‡»
                    if (e.cancelable) e.preventDefault();
                    onClick(e);
                }
            };

            // ç»‘å®šåˆå§‹äº‹ä»¶
            trigger.addEventListener('mousedown', onDown);
            trigger.addEventListener('touchstart', onDown, { passive: false });
            trigger.addEventListener('contextmenu', e => e.preventDefault());
        }

        return { bind };
    })();


    // ============================================================================
    // 2. ä¸»å‡½æ•°ï¼šåˆ›å»ºä¸ç»„è£…æŒ‰é’®
    // ============================================================================
    async function addButtons() {
        if (document.getElementById('notion-import-btn-container')) return;

        // --- 1. ç¯å¢ƒä¸é…ç½®å‡†å¤‡ ---
        const currentHost = window.location.hostname;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const customConfigs = loadCustomConfigs();
        const allConfigs = { ...DEFAULT_SITE_CONFIGS, ...customConfigs };
        const hasConfig = Object.keys(allConfigs).some(host => currentHost.includes(host));

        // --- 2. è¾…åŠ©å·¥å‚å‡½æ•° ---
        const createBtnElement = (id, title, content, style = {}) => {
            const btn = document.createElement('div');
            btn.id = id;
            btn.title = title;
            if (content) {
                const inner = document.createElement('span');
                inner.textContent = content;
                btn.appendChild(inner);
            }
            Object.assign(btn.style, style);
            return btn;
        };

        // --- 3. åˆ›å»ºä¸»å®¹å™¨ ---
        const container = document.createElement('div');
        container.id = 'notion-import-btn-container';
        Object.assign(container.style, {
            position: 'fixed', zIndex: '2147483647',
            display: 'flex', gap: '12px', alignItems: 'center',
            touchAction: 'none', userSelect: 'none', transition: 'none'
        });

        // --- 4. æ¢å¤å®¹å™¨ä½ç½® ---
        const savedLeft = GM_getValue('float_btn_left');
        const savedBottom = GM_getValue('float_btn_bottom');
        if (typeof savedLeft === 'number' && typeof savedBottom === 'number') {
            container.style.left = savedLeft + 'px';
            container.style.bottom = savedBottom + 'px';
        } else {
            container.style.right = '16px';
            container.style.bottom = '30px';
        }

        // --- 5. å®ä¾‹åŒ–æŒ‰é’® ---

        // [æŒ‰é’® A] å¯¼å…¥æŒ‰é’® (Import)
        const importBtn = createBtnElement('import-to-notion-btn',
                                           hasConfig ? 'å¯¼å…¥åˆ°Notion (é•¿æŒ‰åˆ é™¤)' : 'é…ç½®ç½‘ç«™è§„åˆ™');


        SmartInteract.bind(importBtn, container, {
            onClick: async () => {
                if (currentHost.includes('boylove.cc') && !isMobile && !Object.keys(customConfigs).some(h => currentHost.includes(h))) {
                    showNotification('è¯·å…ˆé…ç½®ç½‘ç«™è§„åˆ™', 'info');
                    GM_getValue('useStepConfig', false) ? showStepConfigDialog() : showConfigDialog();
                    return;
                }
                try { await handleImport(); } catch (e) { showError(e.message); }
            },
            onLongPress: async () => { try { await deletePageFromNotion(); } catch (_) {} }
        });
        container.appendChild(importBtn);

        // [æŒ‰é’® B] é…ç½®æŒ‰é’® (Config)
        const configBtn = createBtnElement('config-site-btn', 'é…ç½®ç½‘ç«™è§„åˆ™ (é•¿æŒ‰æ‰“å¼€Notion)');

        SmartInteract.bind(configBtn, container, {
            onClick: () => {
                const siteConfig = getSiteConfig();
                const hasExistingConfig = !siteConfig.isDefaultConfig;
                const useStepConfig = GM_getValue('useStepConfig', false);

                // é€»è¾‘ï¼šåªæœ‰åœ¨æ²¡æœ‰ç°æœ‰é…ç½®ä¸”å¯ç”¨äº†é€æ­¥é…ç½®æ—¶ï¼Œæ‰æ˜¾ç¤ºå‘å¯¼
                if (!hasExistingConfig && useStepConfig) {
                    showStepConfigDialog();
                } else {
                    showConfigDialog();
                }
            },
            onLongPress: () => {
                try {
                    const pageId = (typeof existingPageIdCache !== 'undefined' && existingPageIdCache)
                    || GM_getValue('lastPageId_' + window.location.href);
                    if (pageId) {
                        const url = `https://www.notion.so/${pageId.replace(/-/g, '')}`;
                        showNotification('æ­£åœ¨æ‰“å¼€ Notion...', 'success');
                        isMobile ? (window.location.href = url) : window.open(url, '_blank');
                    } else {
                        showNotification('æœªæ‰¾åˆ°å…³è”çš„ Notion æ•°æ®', 'warning');
                    }
                } catch (err) { showNotification('æ“ä½œå¤±è´¥: ' + err.message, 'error'); }
            }
        });
        container.appendChild(configBtn);

        // [æŒ‰é’® C] è¿½åŠ æŒ‰é’® (Append - å¯é€‰)
        if (APPEND_BUTTON_CONFIG.showAppendButton) {
            const appendBtn = createBtnElement('append-content-btn', 'è¿½åŠ å†…å®¹', '+', {
                width: '40px', height: '40px', borderRadius: '50%',
                background: 'linear-gradient(135deg, var(--primarycolor), var(--primarycolor-light))',
                display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer',
                boxShadow: 'var(--shadow-md)', color: 'white', fontWeight: 'bold'
            });
            SmartInteract.bind(appendBtn, container, {
                onClick: async () => { try { await showAppendContentDialog(); } catch (e) { showError(e.message); } }
            });
            container.appendChild(appendBtn);
        }

        // [æŒ‰é’® D] TagæŒ‰é’® (Tag - ç‰¹æ®Šå¤„ç†)
        if (!tagButton) {
            const iconMode = GM_getValue('icon_mode', '1');
            const styleMode = GM_getValue('tag_btn_style_mode', 'bordered');
            const initIcon = GM_getValue('button_icon', 'â™¥');

            tagButton = document.createElement('div');
            tagButton.className = `notion-tag-btn icon-mode-${iconMode} style-mode-${styleMode}`;
            if (initIcon === 'FILL') tagButton.classList.add('icon-fill');
            tagButton.title = 'ç‚¹å‡»æ·»åŠ æ ‡ç­¾åˆ°Notion';
            tagButton.id = 'notion-tag-btn';

            if (typeof updateTagButtonIcon === 'function') updateTagButtonIcon();

            // ç»‘å®šæ™ºèƒ½äº¤äº’ (ä¼ å…¥ onDragStart è§£å†³å†²çª)
            SmartInteract.bind(tagButton, container, {
                onClick: handleTagButtonClick,

                // æŒ‰ä¸‹ï¼šè§¦å‘æ ·å¼/è®¡æ—¶
                onDown: (e) => {
                    if (typeof handleTagButtonMouseDown === 'function') handleTagButtonMouseDown(e);
                },

                // æŠ¬èµ·ï¼šæ¢å¤æ ·å¼
                onUp: (e) => {
                    if (typeof handleTagButtonMouseUp === 'function') handleTagButtonMouseUp(e);
                },

                // æ‹–æ‹½å¼€å§‹ï¼šå¼ºåˆ¶ä¸­æ–­ Tag å†…éƒ¨çš„é•¿æŒ‰è®¡æ—¶
                onDragStart: () => {
                    if (typeof handleTagButtonMouseUp === 'function') handleTagButtonMouseUp();
                }
            });
        }

        // ç¡®ä¿ Tag æŒ‰é’®åœ¨å®¹å™¨æœ«å°¾
        if (tagButton.parentElement !== container) {
            Object.assign(tagButton.style, {
                position: 'static', left: 'auto', top: 'auto', bottom: 'auto', margin: '0', zIndex: 'auto'
            });
            container.appendChild(tagButton);
        }

        // --- 6. æŒ‚è½½ä¸å…œåº• ---
        document.body.appendChild(container);

        // å®¹å™¨æœ¬èº«å…è®¸æ‹–æ‹½ (ç‚¹å‡»ç©ºç™½å¤„)
        SmartInteract.bind(container, container, {});

        // è¶Šç•Œæ£€æŸ¥ä¸ Tag çŠ¶æ€æ›´æ–°
        const initCheckDelay = ENHANCED_AUTO_UPDATE_CONFIG?.initCheckDelayMs || GM_getValue('auto_update_init_check_delay_ms', 100);
        setTimeout(() => {
            const rect = container.getBoundingClientRect();
            if (rect.left < 0 || rect.top < 0 || rect.right > window.innerWidth || rect.bottom > window.innerHeight) {
                container.style.left = 'auto'; container.style.top = 'auto';
                container.style.right = '16px'; container.style.bottom = '30px';
            }
            if (typeof updateTagButtonStatus === 'function') updateTagButtonStatus(true);
        }, initCheckDelay);
    }

    // å°åœ†ç‚¹æŒ‰é’®å‡½æ•°
    function createTagButton() {
        // å¦‚æœtagæŒ‰é’®å·²å­˜åœ¨ï¼Œç¡®ä¿å®ƒåœ¨æŒ‰é’®ç»„ä¸­
        if (tagButton) {
            const btnContainer = document.getElementById('notion-import-btn-container');
            if (btnContainer && tagButton.parentElement !== btnContainer) {
                // å¦‚æœæŒ‰é’®ç»„å­˜åœ¨ä½†tagæŒ‰é’®ä¸åœ¨å…¶ä¸­ï¼Œç§»åŠ¨åˆ°æŒ‰é’®ç»„
                btnContainer.appendChild(tagButton);
                tagButton.style.position = 'static';
                tagButton.style.left = 'auto';
                tagButton.style.top = 'auto';
                tagButton.style.bottom = 'auto';
                tagButton.style.margin = '0';
                tagButton.style.zIndex = 'auto';
            }
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (typeof updateTagButtonStatus === 'function') {
                updateTagButtonStatus(true);
            }
            return;
        }

        // å¦‚æœæŒ‰é’®ç»„ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºæŒ‰é’®ç»„
        const btnContainer = document.getElementById('notion-import-btn-container');
        if (!btnContainer) {
            // æŒ‰é’®ç»„ä¼šåœ¨ addButtons ä¸­åˆ›å»ºï¼Œè¿™é‡Œåªè¿”å›
            // tagæŒ‰é’®ä¼šåœ¨ addButtons ä¸­åˆ›å»º
            return;
        }

        // å¦‚æœæŒ‰é’®ç»„å·²å­˜åœ¨ï¼ŒtagæŒ‰é’®åº”è¯¥åœ¨ addButtons ä¸­å·²ç»åˆ›å»º
        // è¿™é‡ŒåªåšçŠ¶æ€æ›´æ–°
        if (typeof updateTagButtonStatus === 'function') {
            updateTagButtonStatus(true);
        }
    }

    // æ›´æ–°æ ‡ç­¾æŒ‰é’®å›¾æ ‡å’Œå¤§å°
    function updateTagButtonIcon() {
        if (!tagButton) return;

        const selectedIcon = GM_getValue('button_icon', 'â™¥');
        const iconSize = GM_getValue('button_icon_size', '14');

        // æ ¹æ®é€‰æ‹©çš„å›¾æ ‡ç”Ÿæˆå¯¹åº”çš„ç©ºå¿ƒå’Œå®å¿ƒç‰ˆæœ¬
        const iconMappings = {
            'â™¥': { hollow: 'â™¡', solid: 'â™¥', solidPlus: 'â™¥âº' },
            'â–²': { hollow: 'â–³', solid: 'â–²', solidPlus: 'â–²âº' },
            'â–¼': { hollow: 'â–½', solid: 'â–¼', solidPlus: 'â–¼âº' },
            'â—': { hollow: 'â—‹', solid: 'â—', solidPlus: 'â—âº' },
            'â—†': { hollow: 'â—‡', solid: 'â—†', solidPlus: 'â—†âº' },
            'â¹ï¸': { hollow: 'â¸ï¸', solid: 'â¹ï¸', solidPlus: 'â¹ï¸âº' },
            'â˜…': { hollow: 'â˜†', solid: 'â˜…', solidPlus: 'â˜…âº' },
            'âœ¤': { hollow: 'âœ£', solid: 'âœ¤', solidPlus: 'âœ¤âº' },
            'â˜€': { hollow: 'â˜ª', solid: 'â˜€', solidPlus: 'â˜€âº' },
            'â™ ': { hollow: 'â™¤', solid: 'â™ ', solidPlus: 'â™ âº' },
            'â™¦': { hollow: 'â™¢', solid: 'â™¦', solidPlus: 'â™¦âº' },
            'â™£': { hollow: 'â™§', solid: 'â™£', solidPlus: 'â™£âº' },
            'âœ¿': { hollow: 'â€', solid: 'âœ¿', solidPlus: 'âœ¿âº' },
            'âœ¦': { hollow: 'âŸ¡', solid: 'âœ¦', solidPlus: 'âœ¦âº' },
            'âœ±': { hollow: 'âœ²', solid: 'âœ±', solidPlus: 'âœ±âº' },
            'âˆ¼': { hollow: 'â€’', solid: 'âˆ¼', solidPlus: 'âˆ¼âº' },
            'âœ»': { hollow: 'âœ¼', solid: 'âœ»', solidPlus: 'âœ»âº' },
            'â†': { hollow: 'â„', solid: 'â†', solidPlus: 'â†âº' },
            'ğŸ­': { hollow: 'ğŸ¬', solid: 'ğŸ­', solidPlus: 'ğŸ®' },
            'â€¢': { hollow: 'âŠ¹', solid: 'â€¢', solidPlus: 'â€¢âº' },
            'âŸ': { hollow: 'â‹†', solid: 'âŸ', solidPlus: 'âŸâº' },
            'âœª': { hollow: 'âœ«', solid: 'âœª', solidPlus: 'âœªâº' },
            'â—‹': { hollow: 'â—Œ', solid: 'â—‹', solidPlus: 'â—‹âº' },
        };

        const mapping = iconMappings[selectedIcon] || iconMappings['â™¥'];

        if (selectedIcon === 'FILL') {
            tagButton.classList.add('icon-fill');
        } else {
            tagButton.classList.remove('icon-fill');
            tagButton.style.setProperty('--button-icon-hollow', `"${mapping.hollow}"`);
            tagButton.style.setProperty('--button-icon-solid', `"${mapping.solid}"`);
            tagButton.style.setProperty('--button-icon-solid-plus', `"${mapping.solidPlus}"`);
        }
        tagButton.style.setProperty('--icon-size', `${iconSize}px`);
    }

    // æ ¹æ®æŒ‰é’®å®¹å™¨åŠ¨æ€å®šä½æŒ‰é’®ï¼Œé¿å…ä¸è¿½åŠ æŒ‰é’®é‡å 
    function positionTagButton() {
        // tagæŒ‰é’®ç°åœ¨é›†æˆåœ¨æŒ‰é’®ç»„ä¸­ï¼Œä¸å†éœ€è¦å•ç‹¬å®šä½
        // å¦‚æœtagæŒ‰é’®ä¸åœ¨æŒ‰é’®ç»„ä¸­ï¼Œå°è¯•ç§»åŠ¨åˆ°æŒ‰é’®ç»„
        if (!tagButton) return;
        const container = document.getElementById('notion-import-btn-container');
        if (container && tagButton.parentElement !== container) {
            // ç§»åŠ¨åˆ°æŒ‰é’®ç»„
            container.appendChild(tagButton);
            tagButton.style.position = 'static';
            tagButton.style.left = 'auto';
            tagButton.style.top = 'auto';
            tagButton.style.bottom = 'auto';
            tagButton.style.margin = '0';
            tagButton.style.zIndex = 'auto';
        }
    }

    // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼ˆä¸åšé˜²æŠ–ï¼Œæ¯æ¬¡éƒ½ç›´æ¥ä»Notionè·å–æœ€æ–°çŠ¶æ€ï¼‰
    async function updateTagButtonStatus(force = false) {
        if (!tagButton) return;
        try {
            isPageExistsInNotion = await checkCurrentPageExists();
        } catch (e) {
            console.error('æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€å¤±è´¥:', e);
            isPageExistsInNotion = false;
            hasExistingTag = false;
        }
        updateButtonIcon();
    }

    // æ›´æ–°æŒ‰é’®å›¾æ ‡
    function updateButtonIcon() {
        if (!tagButton) return;

        // æ¸…é™¤æ‰€æœ‰çŠ¶æ€ç±»
        tagButton.classList.remove('page-exists', 'has-tag');
        tagButton.classList.remove('style-mode-plain', 'style-mode-bordered', 'style-mode-gradient', 'style-mode-solid');

        if (isPageExistsInNotion) {
            // é¡µé¢å­˜åœ¨äºNotion
            tagButton.classList.add('page-exists');

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¦æ·»åŠ çš„æ ‡ç­¾
            if (hasExistingTag) {
                tagButton.classList.add('has-tag');
                tagButton.title = 'ç‚¹å‡»æ·»åŠ æ ‡ç­¾åˆ°Notion';
                tagButton.classList.add('style-mode-gradient');
            } else {
                tagButton.title = 'ç‚¹å‡»æ·»åŠ æ ‡ç­¾åˆ°Notion';
                tagButton.classList.add('style-mode-bordered');
            }
        } else {
            // é¡µé¢ä¸å­˜åœ¨äºNotion
            tagButton.title = 'ç‚¹å‡»å¯¼å…¥åˆ°Notion';
            tagButton.classList.add('style-mode-plain');
        }

        // æ›´æ–°å›¾æ ‡å’Œå¤§å°
        updateTagButtonIcon();
    }

    function updateTagDotStatus() {
        if (!tagButton) return;
        updateButtonIcon();
    }

    // å¤„ç†å°åœ†ç‚¹æŒ‰é’®ç‚¹å‡» - æ€»æ˜¯å¯¼å…¥å¸¦é»˜è®¤æ ‡ç­¾çš„æ•°æ®
    async function handleTagButtonClick() {
        // å¦‚æœæ­£åœ¨é•¿æŒ‰ï¼Œå¿½ç•¥ç‚¹å‡»äº‹ä»¶
        if (isLongPressing) {
            return;
        }

        // é˜²é‡å¤ç‚¹å‡»é€»è¾‘
        const currentTime = Date.now();
        if (isProcessingClick || (currentTime - lastClickTime) < CLICK_DEBOUNCE_TIME) {
            console.log('ç‚¹å‡»è¢«é˜²æŠ–é˜»æ­¢');
            return;
        }

        isProcessingClick = true;
        lastClickTime = currentTime;

        // ç«‹å³æ˜¾ç¤ºç‚¹å‡»åé¦ˆ
        tagButton.style.transform = 'scale(0.9)';
        tagButton.style.background = 'var(--primarycolor)';
        tagButton.style.color = 'white';

        // å»¶è¿Ÿæ¢å¤æŒ‰é’®æ ·å¼
        setTimeout(() => {
            tagButton.style.transform = '';
            tagButton.style.background = '';
            tagButton.style.color = '';
        }, 150);

        // æ£€æŸ¥æ˜¯å¦å·²ç»é…ç½®è¿‡æ ‡ç­¾è®¾ç½®
        // ä¼˜å…ˆä½¿ç”¨å…¶ä»–è®¾ç½®ä¸­ä¿å­˜çš„å€¼ï¼Œç¡®ä¿è®¾ç½®åŒæ­¥
        const savedPropertyName = GM_getValue('tagPropertyName', GM_getValue('tag_dot_property_name', null));
        const savedTagText = GM_getValue('tagContent', GM_getValue('tag_dot_tag_text', null));

        // åŒæ­¥æ›´æ–°ä¸¤å¤„è®¾ç½®ï¼Œç¡®ä¿ä¸€è‡´æ€§
        if (savedPropertyName) GM_setValue('tag_dot_property_name', savedPropertyName);
        if (savedTagText) GM_setValue('tag_dot_tag_text', savedTagText);

        // åªæœ‰åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼ˆæ²¡æœ‰ä¿å­˜è¿‡è®¾ç½®ï¼‰æ—¶æ‰æ˜¾ç¤ºé…ç½®ç•Œé¢
        if (!savedPropertyName || !savedTagText) {
            isProcessingClick = false; // é‡ç½®å¤„ç†æ ‡å¿—
            showTagDotConfigDialog();
            return;
        }

        // ç¡®ä¿ä½¿ç”¨ä¿å­˜çš„è®¾ç½®
        customTagSettings.propertyName = savedPropertyName;
        customTagSettings.tagText = savedTagText;

        try {
            const sourceURL = window.location.href;
            const siteConfig = getSiteConfig();
            const ct = siteConfig.contentType || 'clip';
            if (!isPageExistsInNotion) {
                const defaultId = await checkExistingPage(sourceURL, ct);
                if (!defaultId) {
                    const verifyHit = await checkInVerifyDatabase(sourceURL);
                    if (verifyHit) {
                        showNotification('è¯¥æ¨¡å¼ä¸æ”¯æŒæ·»åŠ æ ‡ç­¾', 'info');
                        isProcessingClick = false;
                        return;
                    }
                }
            }
        } catch(_) {}

        if (!isPageExistsInNotion) {
            showNotification('æ­£åœ¨å¯¼å…¥é¡µé¢å¹¶æ·»åŠ æ ‡ç­¾...', 'info');
            try {
                await importPageWithTag();
                isPageExistsInNotion = true;
                hasExistingTag = true;
                updateButtonIcon();
                isProcessingClick = false;
                return;
            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showNotification('å¯¼å…¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                isProcessingClick = false;
                return;
            }
        } else {
            if (!hasExistingTag) {
                const tagOk = await addTagToNotionPage();
                if (tagOk) {
                    hasExistingTag = true;
                    updateButtonIcon();
                }
            } else {
                showNotification(`æ ‡ç­¾"${customTagSettings.tagText}"å·²å­˜åœ¨`, 'info');
                hasExistingTag = true;
                updateButtonIcon();
            }
            isProcessingClick = false;
        }
    }

    // å¯¼å…¥å¸¦æ ‡ç­¾çš„é¡µé¢ï¼ˆå‡å°‘APIè°ƒç”¨ï¼‰
    async function importPageWithTag() {
        try {
            const siteConfig = getSiteConfig();
            const sourceURL = window.location.href;

            // æ£€æŸ¥é…ç½®
            if (siteConfig.requireConfiguration && !siteConfig.isDefaultConfig) {
                showNotification('è¯·å…ˆé…ç½®ç½‘ç«™è§„åˆ™', 'info');
                const useStepConfig = GM_getValue('useStepConfig', false);
                if (useStepConfig) {
                    showStepConfigDialog();
                } else {
                    showConfigDialog();
                }
                return;
            }

            // æå–é¡µé¢æ•°æ®
            const comicData = await extractComicData(siteConfig, false);

            const evalRes = evaluateAutoTagRouting(sourceURL, comicData.æ ‡é¢˜ || comicData.ä¹¦å || document.title || '', getPageTextSnippet(), siteConfig);
            if (evalRes.tags && evalRes.tags.length) {
                const prop = evalRes.tagProperty || 'ç±»å‹';
                const existingRaw = comicData[prop];
                const existing = Array.isArray(existingRaw) ? existingRaw : (existingRaw ? [existingRaw] : []);
                const names = new Set(existing.map(v => typeof v === 'object' ? v.name : String(v)));
                for (const name of evalRes.tags) {
                    if (!names.has(name)) {
                        if (!Array.isArray(comicData[prop])) comicData[prop] = [];
                        comicData[prop].push({ name, color: "pink" });
                    }
                }
            }

            // æ·»åŠ æ ‡ç­¾åˆ°æ•°æ®ä¸­
            if (customTagSettings.propertyName && customTagSettings.tagText) {
                comicData[customTagSettings.propertyName] = [{
                    name: customTagSettings.tagText,
                    color: "pink"
                }];
            }

            // ç›´æ¥åˆ›å»ºå¸¦æ ‡ç­¾çš„é¡µé¢ï¼šå¦‚æœåŒ¹é…äº†åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™ï¼Œä½¿ç”¨æ˜ å°„æ•°æ®åº“ï¼›å¦åˆ™ä½¿ç”¨æ™®é€šè§„åˆ™çš„routeType
            const finalRouteType = (comicData['_useMappingDatabase'] && comicData['_autoRouteType'])
            ? comicData['_autoRouteType']
            : (evalRes.routeType || siteConfig.contentType);
            const result = await createNotionPage(comicData, sourceURL, finalRouteType);

            if (result && result.success) {
                showNotification(`å·²å¯¼å…¥é¡µé¢å¹¶æ·»åŠ æ ‡ç­¾"${customTagSettings.tagText}"`, 'success');
                return result;
            } else {
                throw new Error(result?.message || 'åˆ›å»ºé¡µé¢å¤±è´¥');
            }
        } catch (error) {
            console.error('å¯¼å…¥å¸¦æ ‡ç­¾é¡µé¢å¤±è´¥:', error);
            throw error;
        }
    }

    // æ˜¾ç¤ºæ ‡ç­¾é…ç½®å¯¹è¯æ¡†
    function showTagDotConfigDialog() {
        // æ·»åŠ è‡ªå®šä¹‰CSSæ ·å¼ï¼Œä½¿ç•Œé¢æ›´ç¾è§‚
        const customStyle = `
            <style>
                .tag-config-container {
                    text-align: left;
                    margin-bottom: 20px;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                }
                .tag-config-field {
                    margin-bottom: 18px;
                    position: relative;
                }
                .tag-config-label {
                    display: block;
                    margin-bottom: 8px;
                    font-weight: 500;
                    color: #374151;
                    font-size: 14px;
                }
                .tag-config-input {
                    width: -webkit-fill-available;
                    width: -webkit-fill-available;
                    padding: 10px 16px;
                    border: 1px solid #E5E7EB;
                    border-radius: 20px;
                    font-size: 14px;
                    transition: all 0.3s ease;
                    background: #F9FAFB;
                    box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
                }
                .tag-config-input:focus {
                    outline: none;
                    border-color: #FF8FAB;
                    box-shadow: 0 0 0 3px rgba(255,143,171,0.15);
                    background: white;
                }
                .tag-config-hint {
                    font-size: 12px;
                    color: #6B7280;
                    margin-top: 6px;
                    font-style: italic;
                }
                /* ç§»åŠ¨ç«¯é€‚é… */
                @media (max-width: 768px) {
                    .tag-config-input {
                        padding: 12px 14px;
                        font-size: 16px; /* æ›´å¤§çš„å­—ä½“åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ›´æ˜“ç‚¹å‡» */
                    }
                }
            </style>
        `;

        Swal.fire({
            title: 'æ ‡ç­¾è®¾ç½®',
            html: customStyle + `
                <div class="tag-config-container">
                    <div class="tag-config-field">
                        <label class="tag-config-label">æ ‡ç­¾å±æ€§åç§°</label>
                        <input id="tag-property-name" class="tag-config-input" placeholder="è¾“å…¥Notionä¸­çš„å¤šé€‰å±æ€§åç§°" value="${customTagSettings.propertyName}">
                        <div class="tag-config-hint">æ­¤å±æ€§å¿…é¡»æ˜¯Notionæ•°æ®åº“ä¸­çš„å¤šé€‰ç±»å‹</div>
                    </div>
                    <div class="tag-config-field">
                        <label class="tag-config-label">æ ‡ç­¾å†…å®¹</label>
                        <input id="tag-text" class="tag-config-input" placeholder="è¾“å…¥è¦æ·»åŠ çš„æ ‡ç­¾" value="${customTagSettings.tagText}">
                        <div class="tag-config-hint">ç‚¹å‡»å°åœ†ç‚¹æŒ‰é’®æ—¶å°†æ·»åŠ æ­¤æ ‡ç­¾</div>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'ä¿å­˜',
            cancelButtonText: 'å–æ¶ˆ',
            confirmButtonColor: '#FF6B9D',
            cancelButtonColor: '#6B7280',
            width: '360px',
            padding: '20px',
            background: 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)',
            backdrop: 'rgba(0,0,0,0.4)',
            customClass: {
                title: 'swal2-title-custom',
                popup: 'swal2-popup-custom'
            },
            showClass: {
                popup: 'animate__animated animate__fadeInUp animate__faster'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutDown animate__faster'
            },
            preConfirm: () => {
                const propertyName = document.getElementById('tag-property-name').value;
                const tagText = document.getElementById('tag-text').value;

                if (!propertyName || !tagText) {
                    Swal.showValidationMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
                    return false;
                }

                return {
                    propertyName,
                    tagText
                };
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                customTagSettings.propertyName = result.value.propertyName;
                customTagSettings.tagText = result.value.tagText;

                // ä¿å­˜è®¾ç½®
                GM_setValue('tag_dot_property_name', customTagSettings.propertyName);
                GM_setValue('tag_dot_tag_text', customTagSettings.tagText);
                // åŒæ—¶æ›´æ–°å…¶ä»–è®¾ç½®ä¸­ä½¿ç”¨çš„é”®å€¼
                GM_setValue('tagPropertyName', customTagSettings.propertyName);
                GM_setValue('tagContent', customTagSettings.tagText);

                // æ·»åŠ æ ‡ç­¾
                await addTagToNotionPage();
            }
        });
    }

    // æ·»åŠ æ ‡ç­¾åˆ°Notioné¡µé¢
    async function addTagToNotionPage() {
        try {
            const sourceURL = window.location.href;
            const siteConfig = getSiteConfig();

            // è·å–ç°æœ‰é¡µé¢ID
            let existingPageId = existingPageIdCache;
            if (!existingPageId) {
                const ct = siteConfig.contentType || 'clip';
                existingPageId = await checkExistingPage(sourceURL, ct);
                if (!existingPageId) {
                    const tryTypes = ['comic', 'novel', 'clip'].filter(t => t !== ct);
                    for (const t of tryTypes) {
                        existingPageId = await checkExistingPage(sourceURL, t);
                        if (existingPageId) break;
                    }
                }
            }

            if (!existingPageId) {
                showNotification('æœªæ‰¾åˆ°å¯¹åº”çš„Notioné¡µé¢', 'error');
                return false;
            }

            // è·å–é¡µé¢åŸå§‹å±æ€§ï¼Œç›´æ¥åŸºäºé¡µé¢å±æ€§åˆ¤æ–­ä¸æ›´æ–°
            const pageProperties = await getNotionPageRawProperties(existingPageId);

            if (!pageProperties || typeof pageProperties !== 'object') {
                showNotification('æ— æ³•è·å–Notioné¡µé¢æ•°æ®', 'error');
                return false;
            }

            // æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨äºé¡µé¢ï¼ˆå³æ•°æ®åº“æ¨¡æ¿ï¼‰ä¸­
            if (!Object.prototype.hasOwnProperty.call(pageProperties, customTagSettings.propertyName)) {
                showNotification(`æ•°æ®åº“ä¸­ä¸å­˜åœ¨"${customTagSettings.propertyName}"å±æ€§ï¼Œè¯·æ£€æŸ¥æ ‡ç­¾é…ç½®`, 'error');
                return false;
            }

            // å‡†å¤‡æ›´æ–°æ•°æ®
            const updateData = {};

            const targetProp = pageProperties[customTagSettings.propertyName];
            const propType = targetProp && targetProp.type;

            if (propType === 'multi_select') {
                const existingSelections = Array.isArray(targetProp.multi_select) ? targetProp.multi_select : [];
                const existingNames = existingSelections.map(o => o && o.name).filter(Boolean);
                if (!existingNames.includes(customTagSettings.tagText)) {
                    const newSelections = existingSelections.concat({ name: customTagSettings.tagText });
                    updateData[customTagSettings.propertyName] = { multi_select: newSelections };
                    const result = await sendNotionRequest(
                        "PATCH",
                        `https://api.notion.com/v1/pages/${existingPageId}`,
                        { properties: updateData }
                    );
                    if (result) {
                        showNotification(`å·²æ·»åŠ æ ‡ç­¾"${customTagSettings.tagText}"`, 'success');
                        try {
                            const key = existingPageId + '|' + customTagSettings.propertyName + '|' + customTagSettings.tagText;
                            if (window.__TAG_EXIST_CACHE__ && window.__TAG_EXIST_EXPIRY__) {
                                window.__TAG_EXIST_CACHE__.delete(key);
                                window.__TAG_EXIST_EXPIRY__.delete(key);
                            }
                        } catch(_) {}
                        return true;
                    } else {
                        throw new Error("APIè¯·æ±‚å¤±è´¥");
                    }
                } else {
                    showNotification(`æ ‡ç­¾"${customTagSettings.tagText}"å·²å­˜åœ¨`, 'info');
                    return true;
                }
            } else if (propType === 'select') {
                const current = targetProp.select && targetProp.select.name;
                if (current === customTagSettings.tagText) {
                    showNotification(`æ ‡ç­¾"${customTagSettings.tagText}"å·²å­˜åœ¨`, 'info');
                    return true;
                } else {
                    updateData[customTagSettings.propertyName] = { select: { name: customTagSettings.tagText } };
                    const result = await sendNotionRequest(
                        "PATCH",
                        `https://api.notion.com/v1/pages/${existingPageId}`,
                        { properties: updateData }
                    );
                    if (result) {
                        showNotification(`å·²è®¾ç½®æ ‡ç­¾"${customTagSettings.tagText}"`, 'success');
                        try {
                            const key = existingPageId + '|' + customTagSettings.propertyName + '|' + customTagSettings.tagText;
                            if (window.__TAG_EXIST_CACHE__ && window.__TAG_EXIST_EXPIRY__) {
                                window.__TAG_EXIST_CACHE__.delete(key);
                                window.__TAG_EXIST_EXPIRY__.delete(key);
                            }
                        } catch(_) {}
                        return true;
                    } else {
                        throw new Error("APIè¯·æ±‚å¤±è´¥");
                    }
                }
            } else if (propType === 'rich_text') {
                const plain = (Array.isArray(targetProp.rich_text) ? targetProp.rich_text : []).map(rt => rt && rt.plain_text || '').join('');
                if (plain && plain.includes(customTagSettings.tagText)) {
                    showNotification(`æ ‡ç­¾æ–‡æœ¬å·²åŒ…å«"${customTagSettings.tagText}"`, 'info');
                    return true;
                } else {
                    const newText = plain ? `${plain} ${customTagSettings.tagText}` : customTagSettings.tagText;
                    updateData[customTagSettings.propertyName] = {
                        rich_text: [{ type: 'text', text: { content: newText } }]
                    };
                    const result = await sendNotionRequest(
                        "PATCH",
                        `https://api.notion.com/v1/pages/${existingPageId}`,
                        { properties: updateData }
                    );
                    if (result) {
                        showNotification(`å·²å†™å…¥æ ‡ç­¾æ–‡æœ¬"${customTagSettings.tagText}"`, 'success');
                        try {
                            const key = existingPageId + '|' + customTagSettings.propertyName + '|' + customTagSettings.tagText;
                            if (window.__TAG_EXIST_CACHE__ && window.__TAG_EXIST_EXPIRY__) {
                                window.__TAG_EXIST_CACHE__.delete(key);
                                window.__TAG_EXIST_EXPIRY__.delete(key);
                            }
                        } catch(_) {}
                        return true;
                    } else {
                        throw new Error("APIè¯·æ±‚å¤±è´¥");
                    }
                }
            } else {
                showNotification('å½“å‰å±æ€§ç±»å‹ä¸æ”¯æŒæ·»åŠ æ ‡ç­¾', 'warning');
                return false;
            }
        } catch (error) {
            console.error('æ·»åŠ æ ‡ç­¾å¤±è´¥:', error);
            showNotification('æ·»åŠ æ ‡ç­¾å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            return false;
        }
    }

    async function deleteTagFromNotionPage() {
        try {
            if (!existingPageIdCache) {
                const sourceURL = window.location.href;
                const verifyId = GM_getValue('notion_verify_database_id', '');
                if (verifyId) {
                    const verifyHit = await checkInVerifyDatabase(sourceURL);
                    if (verifyHit) { showNotification('è¯¥æ¨¡å¼ä¸æ”¯æŒæ·»åŠ æ ‡ç­¾', 'info'); return false; }
                }
                showNotification('æ­¤é¡µé¢ä¸å­˜åœ¨äºNotionæ•°æ®åº“ä¸­', 'warning');
                return false;
            }
            const savedPropertyName = GM_getValue('tagPropertyName', GM_getValue('tag_dot_property_name', null));
            const savedTagText = GM_getValue('tagContent', GM_getValue('tag_dot_tag_text', null));
            const propName = savedPropertyName || 'è‡ªå®šä¹‰æ ‡ç­¾';
            const tagText = savedTagText || '';
            if (!tagText) { showNotification('æœªé…ç½®æ ‡ç­¾æ–‡æœ¬', 'warning'); return false; }
            const props = await getNotionPageRawProperties(existingPageIdCache);
            const currentProp = props && props[propName];
            if (!currentProp) { showNotification('é¡µé¢æ— è¯¥æ ‡ç­¾å±æ€§', 'warning'); return false; }
            let update = null;
            if (currentProp.type === 'multi_select') {
                const items = Array.isArray(currentProp.multi_select) ? currentProp.multi_select : [];
                const filtered = items.filter(it => it && it.name !== tagText);
                update = { [propName]: { multi_select: filtered } };
            } else if (currentProp.type === 'select') {
                const isSame = currentProp.select && currentProp.select.name === tagText;
                update = { [propName]: { select: isSame ? null : currentProp.select } };
            } else if (currentProp.type === 'rich_text') {
                const text = (currentProp.rich_text && currentProp.rich_text.map(x => x.plain_text).join('')) || '';
                const newText = text.replace(new RegExp(tagText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), '').trim();
                update = { [propName]: { rich_text: newText ? [{ type: 'text', text: { content: newText } }] : [] } };
            } else {
                showNotification('ä¸æ”¯æŒçš„æ ‡ç­¾å±æ€§ç±»å‹', 'error');
                return false;
            }
            await sendNotionRequest('PATCH', `https://api.notion.com/v1/pages/${existingPageIdCache}`, { properties: update });
            showNotification('å·²åˆ é™¤æ ‡ç­¾', 'success');
            hasExistingTag = false;
            updateButtonIcon();
            return true;
        } catch (e) {
            console.error('åˆ é™¤æ ‡ç­¾å¤±è´¥', e);
            showNotification('åˆ é™¤æ ‡ç­¾å¤±è´¥', 'error');
            return false;
        }
    }

    // æ·»åŠ ç²¾ç¾æ ·å¼
    GM_addStyle(`
    /* ==========================================================================
        1. å…¨å±€å˜é‡å®šä¹‰ (Root Variables)
        ========================================================================== */
    :root {
        --primarycolor: #ff8fab;
        --primarycolor-light: #ffd1e1;
        --primarycolor-lighter: #ffecf2;
        --primarycolor-dark: #ff6b9d;
        --theme-name: pink;
        --success: #94bbe9;
        --error: #f43682;
        --text-dark: #000000;
        --text-light: #FFFFFF;
        --text-muted: #999999;
        --panel-bg: #FFFFFF;
        --panel-border: #F0F0F0;
        --input-bg: #FFFFFF;
        --input-border: #E0E0E0;
        --input-focus: var(--primarycolor-lighter);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        --border-radius-sm: 8px;
        --border-radius-md: 18px;
        --border-radius-btn: 50px;
        --notion-font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif;
        --notion-font-size: 14px;
        --notion-border-radius: 20px;
    }

    /* ==========================================================================
        2. å…¨å±€é€šç”¨æ ·å¼ & åŠ¨ç”» (Global & Animations)
        ========================================================================== */
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    ::-webkit-scrollbar-track {
        background: #F5F5F5;
        border-radius: 20px;
    }
    ::-webkit-scrollbar-thumb {
        background: #CCCCCC;
        border-radius: 20px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #AAAAAA;
    }

    /* é€šç”¨åŠ¨ç”»å®šä¹‰ */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes twinkle {
        0%, 100% { opacity: 0.6; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.12); }
    }
    @keyframes previewPulse {
        0% { background: rgba(255,255,255,0.85); }
        50% { background: rgba(255,255,255,0.70); border-color: rgba(0,0,0,0.08); }
        100% { background: rgba(255,255,255,0.85); }
    }
    @keyframes selector-pulse {
        0% { outline-color: var(--primarycolor-light); box-shadow: 0 0 12px var(--primarycolor-lighter); }
        50% { outline-color: var(--primarycolor); box-shadow: 0 0 18px var(--primarycolor-lighter); }
        100% { outline-color: var(--primarycolor-dark); box-shadow: 0 0 12px var(--primarycolor-light); }
    }
    @keyframes selector-hover-pulse {
        0% { outline-color: var(--primarycolor-light); box-shadow: 0 0 12px var(--primarycolor-lighter); }
        50% { outline-color: var(--primarycolor-dark); box-shadow: 0 0 18px var(--primarycolor-lighter); }
        100% { outline-color: var(--primarycolor-light); box-shadow: 0 0 12px var(--primarycolor-lighter); }
    }
    @keyframes batch-pulse {
        0%, 100% { transform: scale(1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px var(--primarycolor-lighter); }
        50% { transform: scale(1.01); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15), 0 0 0 2px var(--primarycolor); }
    }
    @keyframes batch-progress {
        0% { width: 0%; }
        100% { width: -webkit-fill-available; }
    }

    /* é€šç”¨è¾…åŠ©ç±» */
    .draggable {
        cursor: move;
        user-select: none;
    }
    /* å¼ºåˆ¶æŒ‰é’®æ–‡å­—å±…ä¸­ (å…¨å±€æœ€é«˜ä¼˜å…ˆçº§) */
    html body button[class*="selector"],
    html body button[class*="dialog"],
    html body button[class*="filter"],
    html body .selector-picker-btn,
    html body .selector-test-btn,
    html body .filter-btn,
    html body .dialog-btn {
        text-align: center !important;
        text-align-last: center !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        direction: ltr !important;
    }

    /* ==========================================================================
        3. æµ®åŠ¨å…¥å£æŒ‰é’® (Floating Action Buttons)
        ========================================================================== */
    /* ä¸»æŒ‰é’®å®¹å™¨ */
    #notion-import-btn-container {
        position: fixed;
        bottom: 30px;
        z-index: 2147483647;
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 12px;
        align-items: center !important;
        filter: drop-shadow(var(--shadow-sm));
        transition: none;
    }

    /* Notionå¯¼å…¥æŒ‰é’® & é…ç½®æŒ‰é’® */
    #import-to-notion-btn,
    #config-site-btn {
        width: 44px;
        height: 44px;
        border-radius: var(--border-radius-btn);
        background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: var(--shadow-md);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }
    #config-site-btn {
        background: var(--panel-bg);
    }
    #import-to-notion-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 4px 12px var(--primarycolor-lighter);
    }
    #config-site-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        background: var(--primarycolor-lighter);
    }
    #import-to-notion-btn::before {
        content: "+";
        font-size: 28px;
        color: white;
        font-weight: bold;
        transition: var(--transition);
        z-index: 1;
    }
    #import-to-notion-btn:hover::before {
        transform: rotate(90deg);
    }
    #config-site-btn::before {
        content: "âš™";
        font-size: 18px;
        color: var(--primarycolor-dark);
        transition: var(--transition);
    }
    #config-site-btn:hover::before {
        transform: rotate(30deg);
    }
    #import-to-notion-btn::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: -webkit-fill-available;
        height: 100%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
        transform: translateX(-100%);
        transition: 0.6s;
    }
    #import-to-notion-btn:hover::after {
        transform: translateX(100%);
    }

    /* å°åœ†ç‚¹ Tag æŒ‰é’® */
    .notion-tag-btn {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #FFFFFF;
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 2147483647;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
        font-size: 12px;
        color: var(--primarycolor);
        font-weight: bold;
        position: fixed;
        bottom: 41px;
        left: 145px;
    }
    /* å½“æŒ‰é’®åœ¨æŒ‰é’®ç»„ä¸­æ—¶ï¼Œä½¿ç”¨é™æ€å®šä½ï¼Œè·ŸéšæŒ‰é’®ç»„ç§»åŠ¨ */
    #notion-import-btn-container .notion-tag-btn {
        position: static !important;
        bottom: auto !important;
        left: auto !important;
        top: auto !important;
        margin: 0 !important;
        z-index: auto !important;
    }
    .notion-tag-btn:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-md);
        background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));
        color: white;
    }
    .notion-tag-btn:active {
        transform: scale(0.95);
    }
    .notion-tag-btn.longpress-active {
        transform: scale(0.9);
        background: var(--error);
        transition: all 0.3s ease;
    }
    .notion-tag-btn.longpress-active::before {
        color: #FFFFFF;
        transform: scale(0.8);
    }

    .preview-expand-btn {
        position: static;
        transform: none;
        border: none;
        background: rgba(255,255,255,0.9);
        color: var(--primarycolor, #FF8FAB);
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        display: none;
        flex-shrink: 0;
        margin-left: auto;

    }

    .preview-expand-btn:hover {
        background: var(--primarycolor-light, #ffd1e1);
        color: #fff;
    }

    /* TagæŒ‰é’®ï¼šé£æ ¼æ¨¡å¼ */
    .notion-tag-btn.style-mode-plain { background: #FFFFFF; border: none; color: var(--primarycolor); }
    .notion-tag-btn.style-mode-plain:hover { background: #FFFFFF; color: var(--primarycolor); }

    .notion-tag-btn.style-mode-bordered { background: #FFFFFF; border: 2px solid var(--primarycolor-light); color: var(--primarycolor); }
    .notion-tag-btn.style-mode-bordered:hover { background: #FFFFFF; color: var(--primarycolor); }

    .notion-tag-btn.style-mode-gradient { background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); border: none; color: #FFFFFF; }
    .notion-tag-btn.style-mode-gradient:hover { background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color: #FFFFFF; }

    .notion-tag-btn.style-mode-solid { background: var(--primarycolor); border: none; color: #FFFFFF; }
    .notion-tag-btn.style-mode-solid:hover { background: var(--primarycolor); color: #FFFFFF; }

    /* TagæŒ‰é’®ï¼šå›¾æ ‡æ¨¡å¼ä¸çŠ¶æ€ */
    .notion-tag-btn.icon-mode-1::before { content: var(--button-icon-hollow, "â™¡"); font-size: var(--icon-size, 14px); transition: all 0.3s ease; }
    .notion-tag-btn.icon-mode-1.page-exists::before { content: var(--button-icon-solid, "â™¥"); }
    .notion-tag-btn.icon-mode-1.page-exists.has-tag::before { content: var(--button-icon-solid-plus, "â™¥âº"); }

    .notion-tag-btn.icon-mode-2::before { content: ""; font-size: var(--icon-size, 14px); transition: all 0.3s ease; }
    .notion-tag-btn.icon-mode-2.page-exists::before { content: var(--button-icon-hollow, "â™¡"); }
    .notion-tag-btn.icon-mode-2.page-exists.has-tag::before { content: var(--button-icon-solid, "â™¥"); }

    .notion-tag-btn.icon-fill::before { content: ''; display: none; }

    /* å–æ¶ˆé€‰æ‹©æŒ‰é’® (Float) */
    #selector-cancel-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 14px 24px;
        background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 30px;
        box-shadow: 0 6px 20px var(--primarycolor-lighter);
        cursor: pointer;
        font-weight: 600;
        font-size: 15px;
        z-index: 2147483646;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    #selector-cancel-btn::before {
        content: "ğŸŒ¸";
        font-size: 16px;
    }
    #selector-cancel-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 25px var(--primarycolor-lighter);
        background: linear-gradient(135deg, var(--primarycolor-light, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
        letter-spacing: 0.5px;
    }
    #selector-cancel-btn:active {
        transform: translateY(1px);
        box-shadow: 0 4px 15px var(--primarycolor-lighter);
    }

    /* ==========================================================================
        4. å¼¹çª—ä¸å®¹å™¨ (Dialogs & Containers)
        ========================================================================== */
    /* ä¸»é…ç½®å¯¹è¯æ¡† */
    #config-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--panel-bg);
        padding: 0;
        border-radius: 16px !important;
        box-shadow: 0 12px 30px rgba(0,0,0,0.18) !important;
        z-index: 10000;
        width: 90%;
        max-width: 520px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        filter: drop-shadow(var(--shadow-md));
        border: 1px solid var(--panel-border) !important;
    }
    #config-dialog-content {
        padding: 10px;
        overflow-y: auto;
        max-height: 75vh;
    }
    /* SweetAlert è‡ªå®šä¹‰ */
    .swal-custom-popup {
        border-radius: 16px !important;
        padding: 24px 20px !important;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
    }

    /* å…¶ä»–åŠŸèƒ½ç±»å¼¹çª—ç»Ÿä¸€å¡ç‰‡æ ·å¼ */
    #other-functions-dialog,
    .selector-dialog,
    .notion-Recordwebpage-dialog,
    .notion-ImportExport-dialog {
        border-radius: 18px;
        box-shadow: 0 18px 40px rgba(15,23,42,0.16) !important;
        border: 1px solid rgba(226,232,240,0.9) !important;
    }

    /* æ‰¹é‡å¯¼å…¥å¯¹è¯æ¡† */
    #batch-import-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #FFFFFF !important;
        padding: 0;
        border-radius: 18px !important;
        box-shadow: 0 18px 40px rgba(15,23,42,0.16) !important;
        z-index: 10001;
        width: 90%;
        max-width: 520px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(226,232,240,0.9) !important;
        box-sizing: border-box;
    }
    #batch-import-dialog-content {
        padding: 24px;
        overflow-y: auto;
        max-height: 60vh;
        width: -webkit-fill-available;
        box-sizing: border-box;
    }

    /* é®ç½©å±‚ */
    #dialogOverlay { display: none !important; }

    /* ==========================================================================
        5. å¤´éƒ¨ä¸åº•éƒ¨ (Headers & Footers)
        ========================================================================== */
    /* å¯¹è¯æ¡†å¤´éƒ¨ (é€šç”¨ + è£…é¥°æ¡) */
    #config-dialog-header,
    #batch-import-dialog-header {
        padding: 18px 24px;
        background: linear-gradient(135deg, var(--primarycolor, #FF6B9D), var(--primarycolor-dark, #D94D7B)) !important;
        color: var(--text-light);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative !important;
    }
    /* å¤´éƒ¨åº•éƒ¨è£…é¥°æ¡ */
    #config-dialog-header::after {
        content: "";
        position: absolute;
        left: 0; right: 0; bottom: -6px;
        height: 6px;
        background: none;
        border-radius: 20px;
        box-shadow: 0 6px 14px rgba(0,0,0,.08), 0 0 0 1px rgba(255,255,255,.25) inset;
    }

    /* å…³é—­æŒ‰é’® */
    #config-dialog-close,
    #batch-import-dialog-close {
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 22px;
        cursor: pointer;
        padding: 4px;
        opacity: 0.8;
        transition: var(--transition);
    }
    #config-dialog-close:hover,
    #batch-import-dialog-close:hover {
        opacity: 1;
        transform: rotate(90deg);
    }

    /* å¯¹è¯æ¡†åº•éƒ¨æ“ä½œæ  */
    #config-dialog-actions,
    #batch-import-dialog-actions {
        display: flex;
        gap: 12px;
        padding: 18px 24px;
        border-top: 1px solid var(--panel-border);
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        background: #F8F9FA; /* æ‰¹é‡å¯¼å…¥ä½¿ç”¨æµ…ç°èƒŒæ™¯ */
    }
    #config-dialog-actions { background: transparent; } /* é…ç½®å¯¹è¯æ¡†ä¿æŒé€æ˜/ç™½è‰² */

    /* æ ‡é¢˜æ ·å¼ */
    #config-dialog h3,
    #other-functions-dialog h3,
    .selector-dialog h3 {
        font-size: 18px !important;
        font-weight: 700 !important;
        color: #1F2937 !important;
        margin: 0 0 12px 0 !important;
        background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    #other-functions-dialog h3, .selector-dialog h3 {
        font-size: 22px !important;
        margin-bottom: 20px !important;
    }

    /* ==========================================================================
        6. è¡¨å•æ§ä»¶ (Inputs, Selects, Labels)
        ========================================================================== */
    /* Label æ ·å¼ */
    #config-dialog label,
    .selector-field-card label {
        display: block;
        margin-bottom: 8px;
        font-size: 15px !important;
        font-weight: 600 !important;
        color: #374151 !important;
    }

    /* è¾“å…¥æ¡†ç»„å®¹å™¨ */
    #config-dialog .input-group {
        display: flex !important;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: nowrap;
        width: 100% !important;
        background: #FFFFFF !important;
        border: 1px solid #E2E8F0 !important;
        border-radius: 12px !important;
        padding: 10px !important;
        box-sizing: border-box !important;
    }
    /* ç§»é™¤å†…è”æ ·å¼çš„å¹²æ‰° */
    #config-dialog [style*="border: 1px solid #E5E7EB"],
    #config-dialog [style*="background: white"] {
        border: none !important;
        background: transparent !important;
    }

    /* ç»Ÿä¸€è¾“å…¥æ¡†æ ·å¼ (Text, URL, Number, Textarea, Select) */
    #config-dialog input[type="text"],
    #config-dialog input[type="url"],
    #config-dialog input[type="number"],
    #config-dialog select,
    #config-dialog textarea,
    .selector-index-input,
    .notion-import-input,
    .filter-input,
    .filter-mode-select,
    #content-type-select {
        flex: 1;
        height: 36px !important;
        min-height: 36px !important;
        line-height: 36px !important;
        padding: 0 16px !important;
        border: 1px solid #E2E8F0 !important; /* ç»Ÿä¸€è¾¹æ¡†é¢œè‰² */
        border-radius: var(--notion-border-radius, 12px) !important;
        font-size: 14px;
        font-family: var(--notion-font-family) !important;
        color: #111827 !important;
        background: #FFFFFF !important;
        transition: all 0.2s ease !important;
        box-shadow: none !important;
        outline: none !important;
        box-sizing: border-box !important;
        margin: 0 !important;
    }

    /* è¾“å…¥æ¡†èšç„¦æ€ */
    #config-dialog input:focus,
    #config-dialog select:focus,
    #config-dialog textarea:focus,
    .selector-index-input:focus,
    .notion-import-input:focus,
    .filter-input:focus {
        border-color: #93C5FD !important;
        box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.3) !important;
        background: #FFFFFF !important;
    }

    /* ç‰¹æ®Šè¾“å…¥æ¡†ï¼šæ•°å­—ç´¢å¼• */
    .selector-index-input {
        min-width: 70px !important;
        max-width: 90px !important;
        text-align: center !important;
        font-weight: 500 !important;
        color: #374151 !important;
        -moz-appearance: textfield;
    }

    /* ç‰¹æ®Šè¾“å…¥æ¡†ï¼šTextarea */
    #config-dialog textarea {
        height: auto !important;
        padding: 12px !important;
        resize: vertical;
        line-height: 1.5 !important;
    }

    /* ç‰¹æ®Šè¾“å…¥æ¡†ï¼šå†…å®¹ç±»å‹é€‰æ‹© */
    #content-type-select {
        appearance: none !important;
        background: white url("data:image/svg+xml;utf8,<svg fill='%23FF6B9D' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>") no-repeat !important;
        background-position: right 16px center !important;
        color: #555 !important;
        position: relative;
        z-index: 2;
    }

    /* è¿‡æ»¤å®¹å™¨ */
    .filter-input-container {
        width: -webkit-fill-available !important;
        display: none;
        margin-top: 8px;
        padding: 12px;
        background: #ffffff3d;
        border-radius: 20px;
        border: 1px solid #E2E8F0;
        position: relative;
    }
    .filter-mode-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        margin-top: 10px;
        gap: 8px;
        width: -webkit-fill-available;
    }
    .filter-input{
    width:-webkit-fill-available;
    }

    .filter-preview {
    margin-bottom: 10px;
    }

    .filter-mode-select {
        margin-top: 8px;
        cursor: pointer;
        line-height: 20px;
    }

    /* å†…å®¹ç±»å‹åˆ‡æ¢æ ‡ç­¾ (Tabs) */
    #config-dialog .content-type-tabs {
        display: inline-flex;
        gap: 10px;
        border-radius: 20px;
        background: rgba(255,255,255,0.4);
        padding: 6px;
        border: 1px solid rgba(229,231,235,0.9);
    }
    #config-dialog .content-type-tab {
        padding: 8px 14px;
        border: none;
        border-radius: 20px;
        background: transparent;
        color: #374151;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 13px;
        min-width: 64px;
    }
    #config-dialog .content-type-tab.active {
        background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
        color: #ffffff;
        box-shadow: 0 6px 14px var(--primarycolor-lighter);
    }
    #config-dialog .content-type-tab:not(.active):hover {
        background: rgba(248,250,252,0.9);
    }

    /* ç±»å‹æ˜ å°„é…ç½® */
    .type-mapping-field {
        margin-bottom: 16px;
        border-radius: var(--border-radius-sm);
        padding: 5px;
    }
    .type-mapping-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        cursor: pointer;
    }
    .type-mapping-content { display: none; margin-top: 8px; }
    .type-mapping-content.show { display: block; }
    .type-mapping-row {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 8px !important;
        margin-bottom: 8px !important;
        align-items: center !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }
    /* å¼ºåˆ¶ç±»å‹æ˜ å°„è¾“å…¥æ¡†æ¯”ä¾‹ */
    html body .type-mapping-standard {
        width: 30% !important; min-width: 80px !important; max-width: 30% !important; flex: 0 0 30% !important;
    }
    html body .type-mapping-variants {
        width: 60% !important; min-width: 150px !important; flex: 0 0 60% !important;
    }
    .type-mapping-row button:hover {
        background: #FFD6E5 !important;
        border-color: #FF8FAB !important;
        color: #FF4081 !important;
        transform: scale(1.05) !important;
        box-shadow: 0 2px 5px var(--primarycolor-lighter) !important;
    }

    /* ==========================================================================
        7. æŒ‰é’®ç»„ä»¶ (Buttons)
        ========================================================================== */
    /* é€šç”¨æŒ‰é’®æ ·å¼å®šä¹‰ */
    .selector-picker-btn,
    .selector-test-btn,
    .filter-btn,
    .dialog-btn,
    .filter-test-btn {
        height: 36px !important;
        flex: 1 !important;
        padding: 0 16px !important;
        min-width: 60px !important;
        border-radius: var(--notion-border-radius, 24px) !important;
        font-size: 13px;
        font-weight: 500 !important;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        white-space: nowrap !important;
        position: relative !important;
        overflow: hidden !important;
    }

    /* ä¸»æ“ä½œæŒ‰é’® (Picker, Primary Dialog) */
    .selector-picker-btn,
    .dialog-btn-primarycolor,
    .filter-test-btn {
        background: linear-gradient(135deg, var(--primarycolor, #FF6B9D), var(--primarycolor-dark, #D94D7B)) !important;
        color: #FFFFFF !important;
        border: none !important;
    }
    .selector-picker-btn:hover,
    .dialog-btn-primarycolor:hover,
    .filter-test-btn:hover {
        background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-light)) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 6px 16px var(--primarycolor-lighter) !important;
        filter: brightness(0.98);
    }

    /* æ¬¡è¦/æµ‹è¯•æŒ‰é’® (Test, Filter, Secondary Dialog) */
    .selector-test-btn,
    .filter-btn,
    .dialog-btn-secondary {
        background: rgba(255,255,255,0.5) !important;
        border: 1px solid #E2E8F0 !important;
        color: #374151 !important;
    }
    .selector-test-btn:hover,
    .filter-btn:hover,
    .dialog-btn-secondary:hover {
        background: #F8FAFC !important;
        box-shadow: var(--shadow-md) !important;
        color: var(--primarycolor) !important;
        transform: translateY(-1px) !important;
    }
    .filter-btn.active {
        background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)) !important;
        color: white !important;
        border-color: transparent !important;
    }

    /* å±é™©/åˆ é™¤æŒ‰é’® */
    .dialog-btn-danger {
        background: linear-gradient(135deg, var(--primarycolor, #FF6B9D), var(--primarycolor-dark, #D94D7B)) !important;
        color: #FFFFFF !important;
        border: none !important;
    }
    .dialog-btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(var(--primarycolor-lighter), 0.5) !important;
    }

    /* æŒ‰é’®ç»„å®¹å™¨ */
    .input-group-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
        gap: 8px;
        flex: 1;
        justify-content: stretch;
        align-items: center;
    }
    .buttons-row button {
        background: linear-gradient(135deg, var(--primarycolor, #FF6B9D), var(--primarycolor-dark, #D94D7B)) !important;
    }


    /* ==========================================================================
        8. é¢„è§ˆç»„ä»¶ (Previews)
        ========================================================================== */
    /* å®æ—¶æ–‡æœ¬é¢„è§ˆ */
    .selector-live-preview {
        margin-top: 15px !important;
        margin-bottom: 6px !important;
        font-size: 13px;
        min-height: 24px !important;
        line-height: 1.4 !important;
        padding: 8px 12px !important;
        max-width: 100% !important;
        white-space: normal !important;
        word-break: break-word !important;
        overflow: hidden !important;
        border: 1px solid #E2E8F0 !important;
        font-weight: 400 !important;
        transition: all 0.2s ease !important;
        color: #4A5568 !important;
        position: relative !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        background: #ffffff3d;
        border-radius: 20px;
    }
    .selector-live-preview::before {
        content: "â—" !important;
        font-size: 8px !important;
        opacity: 0.6 !important;
        flex-shrink: 0 !important;
        color: #718096 !important;
    }
    .selector-live-preview:hover {
        background: #F7FAFC;
        border-color: #CBD5E0;
        color: #2D3748;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    }
    .selector-live-preview.expanded {
        max-height: 240px;
        overflow-y: auto;
        white-space: normal;
        word-break: break-word;
    }
    .selector-field-card .selector-live-preview {
        border: 1px solid rgba(229,231,235,0.85) !important;
        border-left: 3px solid var(--primarycolor) !important;
    }

    /* å°é¢å›¾é¢„è§ˆ */
    #config-cover-preview {
        margin-bottom: 16px;
        width: -webkit-fill-available;
        height: 160px;
        border-radius: 20px;
        background-color: var(--input-bg);
        display: none;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        box-sizing: border-box;
        position: relative;
        box-shadow: 0 10px 24px var(--box-shadow-color, rgba(0,0,0,.10));
    }
    #config-cover-preview.show { display: flex; }
    #config-cover-preview-img {
        max-width: -webkit-fill-available;
        max-height: 100%;
        object-fit: cover;
        border-radius: 6px;
        display: none;
    }
    #config-cover-preview.show #config-cover-preview-img { display: block; }
    #config-cover-preview-text {
        color: var(--text-muted);
        font-size: 14px;
        text-align: center;
        padding: 20px;
    }
    #config-cover-preview.show #config-cover-preview-text { display: none; }

    /* å¯¹è¯æ¡†å†…çš„å°å›¾é¢„è§ˆ */
    #config-dialog-preview {
        display: none;
        margin-top: 16px;
        text-align: center;
    }
    #config-dialog-preview img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 20px;
        box-shadow: none;
        border: none;
    }

    /* ==========================================================================
        9. é€šçŸ¥ä¸é«˜äº® (Notifications & Highlights)
        ========================================================================== */
    /* é¡µé¢å…ƒç´ é€‰æ‹©å™¨é«˜äº® */
    .selector-highlight {
        outline: 2px solid var(--primarycolor) !important;
        outline-offset: 0 !important;
        box-shadow: none !important;
        animation: none;
        cursor: pointer;
        transition: none;
    }
    .selector-hover-highlight {
        outline: 2px dashed var(--primarycolor-light) !important;
        outline-offset: 0 !important;
        box-shadow: none !important;
        animation: none;
        cursor: pointer;
        transition: none;
    }

    /* å·¥å…·æç¤º (Tooltip) */
    .selector-tooltip {
        position: absolute;
        background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
        color: white;
        padding: 10px 22px;
        border-radius: 25px;
        font-size: 15px;
        font-weight: 600;
        pointer-events: none;
        z-index: 2147483647;
        box-shadow: 0 6px 16px var(--primarycolor-lighter), 0 0 0 1px rgba(255, 255, 255, 0.1);
        opacity: 0;
        transform: translateY(5px);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        max-width: 320px;
        text-align: center;
        border: 2px solid rgba(255, 255, 255, 0.3);
        letter-spacing: 0.5px;
    }
    .selector-tooltip::before { content: "ğŸ’• "; }
    .selector-tooltip.visible { opacity: 1; transform: translateY(0); }

    /* è‡ªå®šä¹‰é€šçŸ¥æ¡ */
    .custom-notification {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));
        color: var(--text-light);
        padding: 16px 24px;
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-lg);
        z-index: 2147483647;
        display: flex;
        align-items: center;
        gap: 12px;
        max-width: 320px;
        transform: translateY(20px);
        opacity: 0;
        transition: var(--transition);
    }
    .custom-notification.visible { transform: translateY(0); opacity: 1; }
    .custom-notification.success { background: linear-gradient(135deg, var(--primarycolor-dark), var(--primarycolor)); }
    .custom-notification.error { background: linear-gradient(135deg, var(--primarycolor-lighter), var(--primarycolor-lighter)); }
    .custom-notification.info { background: linear-gradient(135deg, var(--primarycolor-dark), var(--primarycolor)); }

    /* æ‰¹é‡å¯¼å…¥çŠ¶æ€æ¡ */
    .batch-import-url-status {
        margin: 16px 0;
        padding: 20px 24px;
        border-radius: 20px;
        font-size: 14px;
        width: -webkit-fill-available;
        box-sizing: border-box;
        word-break: break-all;
        border: 1px solid transparent;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
        font-weight: 500;
    }
    .batch-import-url-status::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
        border-radius: 16px 16px 0 0; background: var(--primarycolor); opacity: 0.8;
    }
    .batch-import-url-status::after {
        content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(135deg, var(--primarycolor-lighter), transparent);
        opacity: 0.1; pointer-events: none;
    }
    /* çŠ¶æ€é¢œè‰² */
    .batch-import-url-status.success {
        background: linear-gradient(135deg, var(--panel-bg), rgba(255, 255, 255, 0.8));
        color: var(--primarycolor); border-color: var(--primarycolor);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px var(--primarycolor-lighter);
    }
    .batch-import-url-status.error {
        background: linear-gradient(135deg, var(--panel-bg), rgba(255, 255, 255, 0.8));
        color: #dc2626; border-color: #ef4444;
        box-shadow: 0 8px 32px rgba(239, 68, 68, 0.15), 0 0 0 1px rgba(239, 68, 68, 0.2);
    }
    .batch-import-url-status.error::before { background: linear-gradient(135deg, #ef4444, #dc2626); opacity: 1; }
    .batch-import-url-status.pending {
        background: linear-gradient(135deg, var(--panel-bg), rgba(255, 255, 255, 0.9));
        color: var(--text-color); border-color: var(--primarycolor);
        animation: batch-pulse 2s ease-in-out infinite;
    }
    .batch-import-url-status.pending::before {
        background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));
        opacity: 1; animation: batch-progress 2s ease-in-out infinite;
    }

    /* ==========================================================================
        10. ç§»åŠ¨ç«¯é€‚é… (Mobile Responsive) - ç»Ÿä¸€ç®¡ç†
        ========================================================================== */
    @media (max-width: 768px) {
        /* 1. æµ®åŠ¨å…¥å£ä¸å–æ¶ˆæŒ‰é’® */
        #selector-cancel-btn {
            bottom: 20px !important;
            right: 20px !important;
            padding: 10px 18px !important;
            border-radius: 12px !important;
            font-size: 14px;
        }
        .expand-btn-row {
            display: flex !important; flex-direction: column !important; gap: 10px !important;
        }
        .expand-btn-row > div { width: 100% !important; }

        /* 2. å¼¹çª—å®¹å™¨å°ºå¯¸ */
        #config-dialog,
        #other-functions-dialog,
        .selector-dialog,
        #batch-import-dialog,
        .notion-Recordwebpage-dialog,
        .notion-ImportExport-dialog {
            width: 90% !important;
            max-width: 420px !important;
            max-height: 90vh !important;
        }
        #other-functions-desc {
        display: none !important
        }

        #other-functions-dialog div button {
        align-items: center !important;
        }

        #config-dialog-content {
            padding: 16px !important;
            gap: 14px !important;
        }

        /* 3. è¡¨å•å¸ƒå±€ä¼˜åŒ– */
        /* æ–‡æœ¬æ¡†ç‹¬å ä¸€åˆ— */
        #config-dialog input[type="text"]:not(.type-mapping-standard):not(.type-mapping-variants) {
            grid-column: 1 / 2 !important;
            width: 100% !important;
            height: 40px !important;
            border-radius: 50px !important;
        }
        /* æ•°å­—ç´¢å¼•æ¡† */
        #config-dialog .input-group .selector-index-input {
            grid-column: 2 / 3 !important;
            width: 80px !important; max-width: 80px !important;
            height: 40px !important;
            border-radius: 50px !important;
        }
        /* æŒ‰é’®ç»„ */
        #config-dialog .input-group .input-group-buttons {
            grid-column: 3 / 5 !important;
            display: flex !important;
            width: 100% !important;
            gap: 6px !important;
        }

        /* ç±»å‹æ˜ å°„ç‰¹æ®Šå¸ƒå±€ */
        html body #config-dialog .type-mapping-row {
            flex-wrap: nowrap !important; gap: 4px !important;
        }
        html body #config-dialog .type-mapping-standard {
            width: 33.33% !important; min-width: 80px !important;
        }
        html body #config-dialog .type-mapping-variants {
            width: 66.67% !important; max-width: calc(100% - 40px - 33.33%) !important;
        }
        .type-mapping-row .dialog-btn-secondary {
            width: 32px !important; min-width: 32px !important; padding: 0 !important;
        }

        /* 4. æŒ‰é’®ä¼˜åŒ– */
        html body .selector-picker-btn,
        html body .selector-test-btn,
        html body .filter-btn,
        .dialog-btn {
            height: 40px !important;
            font-size: 13px;
            border-radius: 20px !important;
            padding: 0 8px !important;
            flex: 1 !important;
            text-align: center !important;
        }
        /* åº•éƒ¨æ“ä½œæ å•è¡Œæ’åˆ— */
        #config-dialog-actions {
            flex-direction: row; gap: 8px; flex-wrap: nowrap;
        }

        /* 6. å…¶ä»–å¾®è°ƒ */
        .selector-field-card .selector-control-group {
            grid-template-columns: 1fr !important;
        }
        .filter-mode-container { flex-wrap: wrap; }
        .filter-mode-text { margin-bottom: 4px; }
        .notion-ImportExport-dialog > div:nth-of-type(5) {grid-template-columns: 1fr 1fr !important;}

    }


    /* ==========================================================================
        11. è‡ªå®šä¹‰æ ·å¼è¦†ç›– (Custom Style Override)
        ========================================================================== */
    [data-custom-style="1"] #config-dialog-content *,
    [data-custom-style="1"] #other-functions-dialog,
    [data-custom-style="1"] #other-functions-dialog *,
    [data-custom-style="1"] .notion-style-dialog,
    [data-custom-style="1"] .notion-style-dialog *,
    [data-custom-style="1"] .notion-config-dialog,
    [data-custom-style="1"] .notion-config-dialog *,
    [data-custom-style="1"] .selector-dialog,
    [data-custom-style="1"] .selector-dialog *,
    [data-custom-style="1"] #batch-import-dialog,
    [data-custom-style="1"] #batch-import-dialog *,
    [data-custom-style="1"] .custom-notification-message,
    [data-custom-style="1"] #config-dialog-actions button,
    [data-custom-style="1"] .notion-index-dialog,
    [data-custom-style="1"] #config-dialog-header,
    [data-custom-style="1"] #config-dialog-header::after,
    [data-custom-style="1"] .notion-index-dialog *,
    [data-custom-style="1"] #config-anchor-nav,
    [data-custom-style="1"] #config-anchor-nav *,
    [data-custom-style="1"] .notion-ImportExport-dialog,
    [data-custom-style="1"] .notion-ImportExport-dialog *,
    [data-custom-style="1"] .notion-AutoUpdate-dialog,
    [data-custom-style="1"] .notion-AutoUpdate-dialog *,
    [data-custom-style="1"] #github-config-dialog,
    [data-custom-style="1"] #github-config-dialog *,
    [data-custom-style="1"] #path-config-dialog,
    [data-custom-style="1"] #path-config-dialog *,
    [data-custom-style="1"] .markdown-convertion,
    [data-custom-style="1"] .markdown-convertion *,
    [data-custom-style="1"] .auto-tag,
    [data-custom-style="1"] .auto-tag *,
    [data-custom-style="1"] .notion-Recordwebpage-dialog,
    [data-custom-style="1"] .notion-Recordwebpage-dialog *,
    [data-custom-style="1"] .notion-HotkeySettings-dialog,
    [data-custom-style="1"] .notion-HotkeySettings-dialog *,
    [data-custom-style="1"] .notion-DatabaseStats-dialog,
    [data-custom-style="1"] .notion-DatabaseStats-dialog *,
    [data-custom-style="1"] .notion-othersetting-dialog,
    [data-custom-style="1"] .notion-othersetting-dialog *,
    [data-custom-style="1"] #other-settings-anchor-nav,
    [data-custom-style="1"] #other-settings-anchor-nav *,
    [data-custom-style="1"] .notion-reset-dialog,
    [data-custom-style="1"] .notion-reset-dialog *,
    [data-custom-style="1"] .notion-CustomTags-dialog
    {
        font-size: var(--notion-font-size) !important;
        font-family: var(--notion-font-family) !important;
        border-radius: var(--notion-border-radius) !important;
    }

    [data-custom-style="1"] .notion-Recordwebpage-dialog textarea,
    [data-custom-style="1"] #batch-import-urls,
    [data-custom-style="1"] #batch-import-status {
        border-radius: calc(var(--notion-border-radius) - 10px) !important;
    }

    [data-custom-style="1"] #notion-import-btn-container * {
        border-radius: var(--notion-border-radius) !important;
    }

    [data-custom-style="1"] #other-functions-dialog h3,
    [data-custom-style="1"] .notion-othersetting-dialog h3,
    [data-custom-style="1"] .notion-ImportExport-dialog h3,
    [data-custom-style="1"] .notion-HotkeySettings-dialog h3,
    [data-custom-style="1"] .notion-Recordwebpage-dialog h3,
    [data-custom-style="1"] .auto-tag h3,
    [data-custom-style="1"] .markdown-convertion h3,
    [data-custom-style="1"] .notion-style-dialog h3,
    [data-custom-style="1"] .notion-AutoUpdate-dialog h3,
    [data-custom-style="1"] .selector-dialog h3,
    [data-custom-style="1"] #other-functions-dialog div div > div div:nth-of-type(1),
    [data-custom-style="1"] #github-config-dialog h2,
    [data-custom-style="1"] .notion-config-dialog h2

    {
    font-size: calc(var(--notion-font-size) + 5px) !important;
    }


    [data-custom-style="1"] .notion-DatabaseStats-dialog > div:nth-of-type(1) div,
    [data-custom-style="1"] #batch-import-dialog-header,
    [data-custom-style="1"] #config-dialog-header,
    [data-custom-style="1"] .type-container label
    {
    font-size: calc(var(--notion-font-size) + 2px) !important;
    }

    [data-custom-style="1"] #other-functions-desc,
    [data-custom-style="1"] #otherfunctons-subtitle-text
    {
    font-size: calc(var(--notion-font-size) - 2px) !important;
    }

    [data-custom-style="1"] #github-config-dialog h2,
    [data-custom-style="1"] .notion-config-dialog h2 {
            border-radius: 0px !important
        }

    div#anchor-content-type { border: none !important; }
    #path-config-dialog > div > div:nth-of-type(2) div:nth-of-type(3) { margin-top: 10px; }

    `);
    // å­˜å‚¨å¯ç”¨çš„è·¯å¾„æ¨¡å¼ï¼ˆæ–°ç‰ˆï¼‰
    const ENABLED_PATTERNS_KEY = 'enabledPatternsV2';
    // å…¨å±€æŒ‰é’®æ˜¾ç¤ºå¼€å…³
    const GLOBAL_SHOW_BUTTONS_KEY = 'globalShowButtons';
    // å…¨å±€ï¼šæ·»åŠ æ—¶å¼¹å‡ºå¤‡æ³¨è¾“å…¥
    const GLOBAL_REMARK_ON_ADD_KEY = 'global_enable_remark_on_add';

    // åˆå§‹åŒ–å­˜å‚¨
    if (!GM_getValue(ENABLED_PATTERNS_KEY)) {
        GM_setValue(ENABLED_PATTERNS_KEY, []);
    }
    if (GM_getValue(GLOBAL_SHOW_BUTTONS_KEY) === undefined) {
        GM_setValue(GLOBAL_SHOW_BUTTONS_KEY, false);
        try {
            const legacy = GM_getValue('global_show_buttons');
            if (typeof legacy !== 'undefined') {
                GM_setValue(GLOBAL_SHOW_BUTTONS_KEY, legacy);
            }
        } catch(_) {}
    }

    function showOtherSettingsDialog() {
        // [Redesigned UI]
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.25); z-index: 10002; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(8px); opacity: 0; animation: fadeIn 0.3s forwards;';

        const dialog = document.createElement('div');
        dialog.className = 'notion-othersetting-dialog';
        dialog.style.cssText = 'background: #FFFFFF; border-radius: 24px; width: 700px; max-width: 92vw; max-height: 85vh; box-shadow: 0 40px 80px -20px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.03); position: relative; overflow: hidden; display: flex; flex-direction: column; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;';

        // Add Global Styles for Dialog
        const styleId = 'dialog-enhanced-styles';
        if (!document.getElementById(styleId)) {
            const s = document.createElement('style');
            s.id = styleId;
            s.textContent = `
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                .notion-othersetting-dialog-content::-webkit-scrollbar { width: 6px; }
                .notion-othersetting-dialog-content::-webkit-scrollbar-track { background: transparent; }
                .notion-othersetting-dialog-content::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 3px; }
                .notion-othersetting-dialog-content::-webkit-scrollbar-thumb:hover { background: #D1D5DB; }
                .setting-card { background: #FFFFFF; border-radius: 16px; border: 1px solid #F3F4F6; padding: 20px; margin-bottom: 16px; transition: all 0.2s ease; }
                .setting-card:hover { border-color: #E5E7EB; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
                .setting-card-header { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #F9FAFB; display: flex; align-items: center; gap: 8px; }
                .setting-card-title { font-size: 15px; font-weight: 600; color: #1F2937; }
                .setting-card-icon { font-size: 16px; color: var(--primarycolor, #FF6B9D); }
                .setting-desc { font-size: 13px; color: #9CA3AF; margin-bottom: 12px; line-height: 1.5; }
                .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; }
                .custom-checkbox-wrapper { display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 6px 0; }
            `;
            document.head.appendChild(s);
        }

        // Header
        const header = document.createElement('div');
        header.style.cssText = 'padding: 20px 24px; border-bottom: 1px solid #F3F4F6; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 10; display: flex; align-items: center; justify-content: space-between;';

        const titleGroup = document.createElement('div');
        titleGroup.style.cssText = 'display: flex; align-items: center; gap: 12px;';
        const titleIcon = document.createElement('div');
        titleIcon.textContent = 'âœ¦';
        titleIcon.style.cssText = 'width: 32px; height: 32px; border-radius: 10px; background: linear-gradient(135deg, var(--primarycolor-lighter, #FFF0F5), #FFF); color: var(--primarycolor, #FF6B9D); display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);';
        const titleText = document.createElement('h3');
        titleText.textContent = 'å…¶ä»–è®¾ç½®';
        titleText.style.cssText = 'margin: 0; font-size: 18px; font-weight: 700; color: #111827;';
        titleGroup.appendChild(titleIcon);
        titleGroup.appendChild(titleText);
        header.appendChild(titleGroup);
        dialog.appendChild(header);

        // Content
        const contentArea = document.createElement('div');
        contentArea.className = 'notion-othersetting-dialog-content';
        contentArea.style.cssText = 'flex: 1; overflow-y: auto; overflow-x: hidden; padding: 24px; scroll-behavior: smooth; background: #FAFAFA;';

        const list = document.createElement('div');
        list.style.cssText = 'display: flex; flex-direction: column; gap: 4px;';
        contentArea.appendChild(list);
        dialog.appendChild(contentArea);

        // --- Anchor Nav (White Style) ---
        const topNav = document.createElement('div');
        topNav.id = 'other-settings-anchor-nav';
        (function ensureAnchorStyles(){
            let st = document.getElementById('other-settings-anchor-styles');
            if (!st) { st = document.createElement('style'); st.id = 'other-settings-anchor-styles'; document.head.appendChild(st); }
            st.textContent = `
                #other-settings-anchor-nav {
                    position: fixed;
                    left: 24px;
                    top: 24px;
                    z-index: 10003;
                    display: flex;
                    flex-direction: column;
                    gap: 6px;
                    padding: 12px;
                    margin: 0;
                    border-radius: 20px;
                    border: 1px solid rgba(255,255,255,0.8);
                    background: rgba(255, 255, 255, 0.9);
                    backdrop-filter: saturate(180%) blur(20px);
                    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.02);
                    max-height: 85vh;
                    overflow-y: auto;
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }
                #other-settings-anchor-nav::-webkit-scrollbar {
                    display: none;
                }
                #other-settings-anchor-nav .anchor-btn {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 9px 14px;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 500;
                    color: #6B7280;
                    background: transparent;
                    transition: all 0.2s ease;
                    text-align: left;
                    width: 130px;
                }
                #other-settings-anchor-nav .anchor-btn .em {
                    font-size: 15px;
                    color: #9CA3AF;
                    width: 20px;
                    display: flex;
                    justify-content: center;
                }
                #other-settings-anchor-nav .anchor-btn:hover {
                    background: rgba(0,0,0,0.04);
                    color: #111827;
                    transform: translateX(2px);
                }
                #other-settings-anchor-nav .anchor-btn.active {
                    background: var(--primarycolor-lighter, #FFF0F5);
                    color: var(--primarycolor, #FF6B9D);
                }
                #other-settings-anchor-nav .anchor-btn.active .em {
                    color: var(--primarycolor, #FF6B9D);
                }
                @media (max-width: 1100px) {
                    #other-settings-anchor-nav { display: none; }
                }
            `;
        })();

        const navItems = [
            { label: 'å…¨å±€åŠŸèƒ½', targetId: 'other-anchor-global-toggles', icon: 'âœ“' },
            { label: 'æŒ‰é’®æ˜¾ç¤º', targetId: 'other-anchor-buttons', icon: 'ğŸ”˜' },
            { label: 'é€‰æ‹©å™¨æ ·å¼', targetId: 'other-anchor-visual-style', icon: 'âœ¨' },
            { label: 'é“¾æ¥åŠ é€Ÿ', targetId: 'other-anchor-accel', icon: 'âš¡' },
            { label: 'å¤„ç†æ ‡é¢˜', targetId: 'other-anchor-title-cleanup', icon: 'ğŸ“' },
            { label: 'åˆå¹¶ç¬¦å·', targetId: 'other-anchor-merge-sep', icon: 'âˆ‘' },
            { label: 'ç®€ä»‹å±•å¼€', targetId: 'other-anchor-expand', icon: 'â–¾' },
            { label: 'å®šä½é¢æ¿', targetId: 'other-anchor-quick-panel', icon: 'ğŸ“' },
            { label: 'é»˜è®¤æ ‡ç­¾', targetId: 'other-anchor-tag-defaults', icon: 'ğŸ·ï¸' },
            { label: 'å›¾æ ‡è®¾ç½®', targetId: 'other-anchor-icon-settings', icon: 'âŸ' },
            { label: 'æ™ºèƒ½æå–', targetId: 'other-anchor-smart-extract', icon: 'ğŸ§ ' },
            { label: 'ä»£ç†é“¾æ¥', targetId: 'cover-proxy-prefix', icon: 'ğŸ”—' }
        ];

        const btnMap = {};
        let suppressAutoActiveUntil = 0;
        navItems.forEach(it => {
            const btn = document.createElement('button');
            btn.className = 'anchor-btn';
            const icon = document.createElement('span');
            icon.className = 'em';
            icon.textContent = it.icon || 'âœ¦';
            const text = document.createElement('span');
            text.textContent = it.label;
            btn.appendChild(icon);
            btn.appendChild(text);
            btn.addEventListener('click', () => {
                suppressAutoActiveUntil = Date.now() + 500;
                const target = dialog.querySelector('#' + it.targetId);
                if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                Object.values(btnMap).forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
            btnMap[it.targetId] = btn;
            topNav.appendChild(btn);
        });
        const setActiveById = (id) => {
            const btn = btnMap[id];
            if (!btn) return;
            Object.values(btnMap).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const nav = topNav;
            if (nav) {
                const btnRect = btn.getBoundingClientRect();
                const navRect = nav.getBoundingClientRect();
                if (btnRect.top < navRect.top || btnRect.bottom > navRect.bottom) {
                    btn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        };

        // --- Helper to Create Sections (Cards) ---
        const createSection = (id, title, icon) => {
            const card = document.createElement('div');
            card.className = 'setting-card';
            if (id) card.id = id;

            const header = document.createElement('div');
            header.className = 'setting-card-header';

            const iconEl = document.createElement('span');
            iconEl.className = 'setting-card-icon';
            iconEl.textContent = icon || 'âœ¦';

            const titleEl = document.createElement('span');
            titleEl.className = 'setting-card-title';
            titleEl.textContent = title;

            header.appendChild(iconEl);
            header.appendChild(titleEl);
            card.appendChild(header);

            const content = document.createElement('div');
            content.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
            card.appendChild(content);

            list.appendChild(card);
            return content;
        };

        // 1. Global Toggles
        const globalSection = createSection('other-anchor-global-toggles', 'å…¨å±€åŠŸèƒ½å¼€å…³', 'âœ“');
        globalSection.appendChild(createCustomCheckbox('global-remark-on-add', GM_getValue('global_enable_remark_on_add', false), 'æ·»åŠ æ—¶å¼¹å‡ºå¤‡æ³¨è¾“å…¥ï¼ˆæ¼«ç”»/å°è¯´ï¼‰'));
        globalSection.appendChild(createCustomCheckbox('global-enable-rating', GM_getValue('rating_enabled', true), 'å¯ç”¨è¯„åˆ†å¼¹çª—ï¼ˆæ¼«ç”»/å°è¯´ï¼‰'));
        globalSection.appendChild(createCustomCheckbox('global-show-append', GM_getValue('show_append_button', false), 'æ˜¾ç¤ºå·¦ä¸‹è§’â€œè¿½åŠ å†…å®¹â€æŒ‰é’®'));

        // 2. Button Visibility
        const btnSection = createSection('other-anchor-buttons', 'æŒ‰é’®æ˜¾ç¤ºè®¾ç½®', 'ğŸ”˜');
        const btnGrid = document.createElement('div');
        btnGrid.style.cssText = 'display: grid; gap: 12px; grid-template-columns: repeat(2, 1fr); margin-top: 8px;';
        [
            createCustomCheckbox('show-filter-btn', GM_getValue('show-filter-btn', true), 'æ˜¾ç¤ºè¿‡æ»¤æŒ‰é’®'),
            createCustomCheckbox('show-test-btn', GM_getValue('show-test-btn', true), 'æ˜¾ç¤ºæµ‹è¯•æŒ‰é’®'),
            createCustomCheckbox('show-highlight-btn', GM_getValue('show-highlight-btn', true), 'æ˜¾ç¤ºé«˜äº®æŒ‰é’®'),
            createCustomCheckbox('show-locate-btn', GM_getValue('show-locate-btn', true), 'æ˜¾ç¤ºå®šä½æŒ‰é’®'),
            createCustomCheckbox('show-select-btn', GM_getValue('show-select-btn', true), 'æ˜¾ç¤ºé€‰æ‹©æŒ‰é’®')
        ].forEach(el => btnGrid.appendChild(el));
        btnSection.appendChild(btnGrid);

        // Immediate preview hooks
        try {
            ['show-filter-btn','show-test-btn','show-highlight-btn','show-locate-btn','show-select-btn'].forEach(id => {
                const box = document.getElementById(id);
                if (box) box.addEventListener('change', () => {
                    GM_setValue(id, !!box.checked);
                    applyButtonVisibilitySettings();
                });
            });
        } catch(_) {}

        // 3. Selector Style
        const visualSection = createSection('other-anchor-visual-style', 'é€‰æ‹©å™¨æ ·å¼', 'âœ¨');
        const visualRow = document.createElement('div');
        visualRow.className = 'setting-row';
        const visualLabel = document.createElement('label');
        visualLabel.className = 'setting-label';
        visualLabel.textContent = 'å¯è§†åŒ–æ ·å¼:';
        const visualSelect = document.createElement('select');
        visualSelect.id = 'selector-visual-style-select';
        const currVisual = GM_getValue('selector_visual_style', 'minimal');
        visualSelect.innerHTML = '<option value="minimal">æç®€ç¨³å®š</option><option value="fancy">ç²¾ç¾åŠ¨ç”»</option>';
        visualSelect.value = currVisual;
        visualSelect.style.cssText = 'padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 8px; background: #FFF; font-size: 14px; outline: none; min-width: 120px;';
        visualSelect.addEventListener('change', () => {
            GM_setValue('selector_visual_style', visualSelect.value);
            applySelectorVisualStyle();
        });
        visualRow.appendChild(visualLabel);
        visualRow.appendChild(visualSelect);
        visualSection.appendChild(visualRow);

        // 4. Link Acceleration
        const accelSection = createSection('other-anchor-accel', 'é“¾æ¥åŠ é€Ÿ', 'âš¡');
        const accelDesc = document.createElement('div');
        accelDesc.className = 'setting-desc';
        accelDesc.textContent = 'å¯¹å°é¢/å›¾ç‰‡é“¾æ¥ä½¿ç”¨ jsDelivr åŠ é€Ÿã€‚';
        accelSection.appendChild(accelDesc);
        accelSection.appendChild(createCustomCheckbox('global-use-jsdelivr', GM_getValue('use_jsdelivr_acceleration', false), 'ä½¿ç”¨ jsDelivr åŠ é€Ÿ'));

        // 5. Title Cleanup
        const titleSection = createSection('other-anchor-title-cleanup', 'å¤„ç†æ ‡é¢˜', 'ğŸ“');
        const titleDesc = document.createElement('div');
        titleDesc.className = 'setting-desc';
        titleDesc.textContent = 'æ§åˆ¶é»˜è®¤æ ‡é¢˜æ¸…æ´—è§„åˆ™ï¼ˆç½‘é¡µâ†’Notion ä¸ å‰ªè— åŒæ ·ç”Ÿæ•ˆï¼‰';
        titleSection.appendChild(titleDesc);
        titleSection.appendChild(createCustomCheckbox('title-remove-brackets', GM_getValue('title_remove_brackets', true), 'å»é™¤æ‹¬å·åŠå†…å®¹ () [] {}'));
        titleSection.appendChild(createCustomCheckbox('title-trim-underscore', GM_getValue('title_trim_underscore', true), 'å»æ‰ä¸‹åˆ’çº¿_åŠä¹‹åå†…å®¹'));

        // 6. Merge Separator
        const mergeSection = createSection('other-anchor-merge-sep', 'é€‰æ‹©å™¨åˆå¹¶ç¬¦å·', 'âˆ‘');
        const mergeDesc = document.createElement('div');
        mergeDesc.className = 'setting-desc';
        mergeDesc.textContent = 'å¤šé€‰/èŒƒå›´æå–æ—¶çš„è¿æ¥ç¬¦ï¼Œæ”¯æŒ \\n æ¢è¡Œã€‚';
        mergeSection.appendChild(mergeDesc);
        const mergeRow = document.createElement('div');
        mergeRow.className = 'setting-row';
        const mergeLabel = document.createElement('label');
        mergeLabel.className = 'setting-label';
        mergeLabel.textContent = 'åˆå¹¶ç¬¦å·:';
        const mergeInput = document.createElement('input');
        mergeInput.type = 'text';
        mergeInput.id = 'selector-merge-separator';
        mergeInput.value = GM_getValue('selector_merge_separator', '');
        mergeInput.placeholder = 'ä¾‹å¦‚ï¼šï¼Œ æˆ– \\n';
        mergeInput.style.cssText = 'flex: 1; margin-left: 12px; padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 14px; outline: none;';
        mergeRow.appendChild(mergeLabel);
        mergeRow.appendChild(mergeInput);
        mergeSection.appendChild(mergeRow);

        // 7. Expand Settings
        const expandSection = createSection('other-anchor-expand', 'ç®€ä»‹å±•å¼€è®¾ç½®', 'â–¾');
        const expandRow = document.createElement('div');
        expandRow.className = 'setting-row';
        const expandLabel = document.createElement('label');
        expandLabel.className = 'setting-label';
        expandLabel.textContent = 'ç‚¹å‡»é—´éš”(ms):';
        const expandInput = document.createElement('input');
        expandInput.type = 'number';
        expandInput.min = '0';
        expandInput.id = 'global-expand-click-interval';
        try { expandInput.value = String(GM_getValue('expand_click_interval_ms', 150)); } catch(_) { expandInput.value = '150'; }
        expandInput.style.cssText = 'flex: 1; margin-left: 12px; padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 14px; outline: none;';
        expandRow.appendChild(expandLabel);
        expandRow.appendChild(expandInput);
        expandSection.appendChild(expandRow);

        // 8. Quick Panel
        const panelSection = createSection('other-anchor-quick-panel', 'å¿«æ·å®šä½é¢æ¿', 'ğŸ“');
        panelSection.appendChild(createCustomCheckbox('global-show-config-anchor', GM_getValue('show_config_anchor_nav', true), 'æ˜¾ç¤ºå¿«æ·å®šä½é¢æ¿'));

        // 9. Default Tags
        const tagSection = createSection('other-anchor-tag-defaults', 'é»˜è®¤æ ‡ç­¾è®¾ç½®', 'ğŸ·ï¸');
        const tagDesc = document.createElement('div');
        tagDesc.className = 'setting-desc';
        tagDesc.textContent = 'ç‚¹å‡»å°åœ†ç‚¹æŒ‰é’®æ—¶æ·»åŠ çš„æ ‡ç­¾å±æ€§å’Œå†…å®¹';
        tagSection.appendChild(tagDesc);

        const createInputRow = (label, id, val, ph) => {
            const r = document.createElement('div');
            r.className = 'setting-row';
            const l = document.createElement('label');
            l.className = 'setting-label';
            l.style.width = '100px';
            l.textContent = label;
            const i = document.createElement('input');
            i.id = id;
            i.type = 'text';
            i.value = val;
            i.placeholder = ph;
            i.style.cssText = 'flex: 1; padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s;';
            i.addEventListener('focus', () => i.style.borderColor = 'var(--primarycolor)');
            i.addEventListener('blur', () => i.style.borderColor = '#D1D5DB');
            r.appendChild(l);
            r.appendChild(i);
            return r;
        };
        tagSection.appendChild(createInputRow('å±æ€§åç§°:', 'tag-property-name', GM_getValue('tag_dot_property_name', GM_getValue('tagPropertyName', 'æ ‡ç­¾')), 'Notionå±æ€§å'));
        tagSection.appendChild(createInputRow('æ ‡ç­¾å†…å®¹:', 'tag-content', GM_getValue('tag_dot_tag_text', GM_getValue('tagContent', 'æ”¶è—')), 'æ ‡ç­¾å†…å®¹'));

        // 10. Icon Settings
        const iconSection = createSection('other-anchor-icon-settings', 'æŒ‰é’®å›¾æ ‡è®¾ç½®', 'âŸ');
        const iconDesc = document.createElement('div');
        iconDesc.className = 'setting-desc';
        iconDesc.textContent = 'è®¾ç½®å°åœ†ç‚¹æŒ‰é’®çš„æ˜¾ç¤ºæ¨¡å¼ã€å›¾æ ‡æ ·å¼å’Œå¤§å°';
        iconSection.appendChild(iconDesc);

        // -- Icon Mode --
        const modeLabel = document.createElement('div');
        modeLabel.textContent = 'æ˜¾ç¤ºæ¨¡å¼';
        modeLabel.style.cssText = 'font-size: 14px; font-weight: 600; color: #4B5563; margin-top:8px;';
        iconSection.appendChild(modeLabel);

        const modeRow = document.createElement('div');
        modeRow.style.cssText = 'display: flex; gap: 12px; margin-top: 8px;';
        const currIconMode = GM_getValue('icon_mode', '1');

        const createModeOpt = (val, label, desc, previewHtml) => {
            const d = document.createElement('div');
            d.style.cssText = 'flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px; border: 2px solid transparent; border-radius: 12px; cursor: pointer; background: #F9FAFB; transition: all 0.2s;';
            if (currIconMode === val) {
                d.style.borderColor = 'var(--primarycolor)';
                d.style.background = 'var(--primarycolor-lighter)';
            }

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'icon-mode';
            radio.value = val;
            radio.checked = (currIconMode === val);
            radio.style.display = 'none';
            d.appendChild(radio);

            const prev = document.createElement('div');
            prev.innerHTML = previewHtml;
            d.appendChild(prev);

            const l = document.createElement('div');
            l.textContent = label;
            l.style.cssText = 'font-size: 12px; font-weight: 600; color: #4B5563;';
            d.appendChild(l);

            const de = document.createElement('div');
            de.textContent = desc;
            de.style.cssText = 'font-size: 10px; color: #9CA3AF;';
            d.appendChild(de);

            d.addEventListener('click', () => {
                document.querySelectorAll('input[name="icon-mode"]').forEach(r => {
                    r.checked = false;
                    r.parentNode.style.borderColor = 'transparent';
                    r.parentNode.style.background = '#F9FAFB';
                });
                radio.checked = true;
                d.style.borderColor = 'var(--primarycolor)';
                d.style.background = 'var(--primarycolor-lighter)';
            });
            return d;
        };

        modeRow.appendChild(createModeOpt('1', 'æ¨¡å¼1', 'ç©ºå¿ƒâ†’å®å¿ƒâ†’å®å¿ƒâº',
                                          '<span style="color:var(--primarycolor)">â™¡</span> <span style="color:var(--primarycolor)">â™¥</span> <span style="color:var(--primarycolor)">â™¥âº</span>'));
        modeRow.appendChild(createModeOpt('2', 'æ¨¡å¼2', 'æ— å†…å®¹â†’ç©ºå¿ƒâ†’å®å¿ƒ',
                                          '<span style="display:inline-block;width:14px;height:14px;border:1px dashed #ccc;border-radius:50%"></span> <span style="color:var(--primarycolor)">â™¡</span> <span style="color:var(--primarycolor)">â™¥</span>'));
        iconSection.appendChild(modeRow);

        // -- Icon Style --
        const iconStyleLabel = document.createElement('div');
        iconStyleLabel.textContent = 'å›¾æ ‡æ ·å¼';
        iconStyleLabel.style.cssText = 'font-size: 14px; font-weight: 600; color: #4B5563; margin-top:16px; margin-bottom:8px;';
        iconSection.appendChild(iconStyleLabel);

        const iconGrid = document.createElement('div');
        iconGrid.style.cssText = 'display: grid; gap: 8px; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));';
        const iconOpts = [
            {v:'â™¥',l:'â™¥'},{v:'â–²',l:'â–²'},{v:'â–¼',l:'â–¼'},{v:'â—',l:'â—'},{v:'â—†',l:'â—†'},{v:'â¹ï¸',l:'â¹ï¸'},{v:'â˜…',l:'â˜…'},
            {v:'âœ¤',l:'âœ¤'},{v:'â˜€',l:'â˜€'},{v:'â™ ',l:'â™ '},{v:'â™¦',l:'â™¦'},{v:'â™£',l:'â™£'},{v:'âœ¿',l:'âœ¿'},{v:'âœª',l:'âœª'},
            {v:'â—‹',l:'â—‹'},{v:'âœ¦',l:'âœ¦'},{v:'âœ±',l:'âœ±'},{v:'âˆ¼',l:'âˆ¼'},{v:'âœ»',l:'âœ»'},{v:'â†',l:'â†'},{v:'âŸ',l:'âŸ'},
            {v:'â€¢',l:'â€¢'},{v:'ğŸ­',l:'ğŸ­'},{v:'FILL',l:'', bg:true}
        ];
        const currIcon = GM_getValue('button_icon', 'â™¥');

        iconOpts.forEach(opt => {
            const d = document.createElement('div');
            d.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 40px; border-radius: 8px; cursor: pointer; border: 1px solid #F3F4F6; background: #FFF; transition: all 0.2s;';
            if (currIcon === opt.v) {
                d.style.borderColor = 'var(--primarycolor)';
                d.style.background = 'var(--primarycolor-lighter)';
            }

            if (opt.bg) {
                const sp = document.createElement('span');
                sp.style.cssText = 'width: 16px; height: 16px; border-radius: 50%; background: var(--primarycolor);';
                d.appendChild(sp);
            } else {
                const sp = document.createElement('span');
                sp.textContent = opt.l;
                sp.style.cssText = 'color: var(--primarycolor); font-size: 18px; line-height: 1;';
                d.appendChild(sp);
            }

            const r = document.createElement('input');
            r.type = 'radio';
            r.name = 'button-icon';
            r.value = opt.v;
            r.checked = (currIcon === opt.v);
            r.style.display = 'none';
            d.appendChild(r);

            d.addEventListener('click', () => {
                document.querySelectorAll('input[name="button-icon"]').forEach(i => {
                    i.checked = false;
                    i.parentNode.style.borderColor = '#F3F4F6';
                    i.parentNode.style.background = '#FFF';
                });
                r.checked = true;
                d.style.borderColor = 'var(--primarycolor)';
                d.style.background = 'var(--primarycolor-lighter)';
            });
            iconGrid.appendChild(d);
        });
        iconSection.appendChild(iconGrid);

        // 11. Smart Extraction
        const smartSection = createSection('other-anchor-smart-extract', 'æ™ºèƒ½æå–', 'ğŸ§ ');
        const smartDesc = document.createElement('div');
        smartDesc.className = 'setting-desc';
        smartDesc.textContent = 'å½“æœªé…ç½®é€‰æ‹©å™¨æˆ–æå–å¤±è´¥æ—¶ï¼Œå°è¯•è‡ªåŠ¨åˆ†æç½‘é¡µå†…å®¹æå–ä¿¡æ¯ã€‚';
        smartSection.appendChild(smartDesc);
        smartSection.appendChild(createCustomCheckbox('smart-extraction-enabled', GM_getValue('smart_extraction_enabled', true), 'å¯ç”¨æ™ºèƒ½æå–ä¼˜åŒ–'));

        // 12. Proxy
        const proxySection = createSection('cover-proxy-prefix', 'å°é¢ä»£ç†å‰ç¼€', 'ğŸ”—');
        const proxyDesc = document.createElement('div');
        proxyDesc.className = 'setting-desc';
        proxyDesc.textContent = 'è®¾ç½®å°é¢å›¾ç‰‡çš„ä»£ç†é“¾æ¥å‰ç¼€ã€‚æ ¼å¼ï¼šhttps://example.com/?url=';
        proxySection.appendChild(proxyDesc);
        proxySection.appendChild(createInputRow('ä»£ç†å‰ç¼€:', 'cover-proxy-prefix', COVER_BED_CONFIG.proxyPrefix || '', 'è¯·è¾“å…¥ä»£ç†é“¾æ¥...'));

        // Footer Actions
        const footer = document.createElement('div');
        footer.style.cssText = 'padding: 20px 24px; border-top: 1px solid #F3F4F6; background: #FFFFFF; display: flex; justify-content: flex-end; gap: 12px;';

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = 'padding: 10px 18px; border: 1px solid #E5E7EB; border-radius: 12px; background: #FFF; cursor: pointer; color: #374151; font-weight: 500; transition: all 0.2s;';
        cancelBtn.addEventListener('mouseenter', () => cancelBtn.style.background = '#F9FAFB');
        cancelBtn.addEventListener('mouseleave', () => cancelBtn.style.background = '#FFF');

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'ä¿å­˜è®¾ç½®';
        saveBtn.style.cssText = 'padding: 10px 24px; border: none; border-radius: 12px; background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); color: #fff; cursor: pointer; font-weight: 500; box-shadow: 0 4px 12px rgba(255, 107, 157, 0.25); transition: all 0.2s;';

        cancelBtn.onclick = () => {
            overlay.style.opacity = '0';
            setTimeout(() => { if(overlay.parentNode) overlay.parentNode.removeChild(overlay); }, 300);
        };

        saveBtn.onclick = () => {
            // Save logic
            const remarkChecked = document.getElementById('global-remark-on-add')?.checked;
            const ratingChecked = document.getElementById('global-enable-rating')?.checked;
            const appendChecked = document.getElementById('global-show-append')?.checked;
            const jsdelivrChecked = document.getElementById('global-use-jsdelivr')?.checked;
            const tagPropertyName = document.getElementById('tag-property-name')?.value;
            const tagContent = document.getElementById('tag-content')?.value;
            const removeBracketsChecked = document.getElementById('title-remove-brackets')?.checked;
            const trimUnderscoreChecked = document.getElementById('title-trim-underscore')?.checked;
            const smartExtractionChecked = document.getElementById('smart-extraction-enabled')?.checked;

            if (typeof remarkChecked === 'boolean') GM_setValue('global_enable_remark_on_add', remarkChecked);
            if (typeof ratingChecked === 'boolean') {
                GM_setValue('rating_enabled', ratingChecked);
                if (typeof RATING_CONFIG !== 'undefined') RATING_CONFIG.enabled = ratingChecked;
            }
            if (typeof appendChecked === 'boolean') {
                GM_setValue('show_append_button', appendChecked);
                const appendButton = document.getElementById('append-content-btn');
                if (appendButton) appendButton.style.display = appendChecked ? 'flex' : 'none';
            }
            if (typeof jsdelivrChecked === 'boolean') GM_setValue('use_jsdelivr_acceleration', jsdelivrChecked);
            if (typeof removeBracketsChecked === 'boolean') GM_setValue('title_remove_brackets', removeBracketsChecked);
            if (typeof trimUnderscoreChecked === 'boolean') GM_setValue('title_trim_underscore', trimUnderscoreChecked);

            ['show-filter-btn','show-test-btn','show-highlight-btn','show-locate-btn','show-select-btn'].forEach(id => {
                const el = document.getElementById(id);
                if (el) GM_setValue(id, !!el.checked);
            });

            if (typeof smartExtractionChecked === 'boolean') {
                GM_setValue('smart_extraction_enabled', smartExtractionChecked);
                if (typeof SMART_EXTRACTION_CONFIG !== 'undefined') SMART_EXTRACTION_CONFIG.enabled = smartExtractionChecked;
            }

            const mergeSep = document.getElementById('selector-merge-separator')?.value;
            if (mergeSep !== undefined) GM_setValue('selector_merge_separator', mergeSep);

            const expandInterval = parseInt(document.getElementById('global-expand-click-interval')?.value, 10);
            if (!isNaN(expandInterval)) GM_setValue('expand_click_interval_ms', expandInterval);

            const showAnchor = document.getElementById('global-show-config-anchor')?.checked;
            if (typeof showAnchor === 'boolean') {
                GM_setValue('show_config_anchor_nav', showAnchor);
                // Update anchor visibility immediately if possible
            }

            if (tagPropertyName) {
                GM_setValue('tagPropertyName', tagPropertyName);
                GM_setValue('tag_dot_property_name', tagPropertyName);
            }
            if (tagContent) {
                GM_setValue('tagContent', tagContent);
                GM_setValue('tag_dot_tag_text', tagContent);
            }

            const iconMode = document.querySelector('input[name="icon-mode"]:checked')?.value || '1';
            GM_setValue('icon_mode', iconMode);
            const iconVal = document.querySelector('input[name="button-icon"]:checked')?.value || 'â™¥';
            GM_setValue('button_icon', iconVal);

            const proxyPrefix = document.getElementById('cover-proxy-prefix')?.value?.trim() || '';
            GM_setValue('cover_proxy_prefix', proxyPrefix);
            if (typeof COVER_BED_CONFIG !== 'undefined') COVER_BED_CONFIG.proxyPrefix = proxyPrefix;

            // Trigger updates
            const tagBtn = document.querySelector('.notion-tag-btn');
            if (tagBtn) {
                tagBtn.classList.remove('icon-mode-1', 'icon-mode-2');
                tagBtn.classList.add('icon-mode-' + iconMode);
                if (typeof updateTagButtonIcon === 'function') updateTagButtonIcon();
            }
            if (typeof customTagSettings !== 'undefined') {
                customTagSettings.propertyName = tagPropertyName || 'æ ‡ç­¾';
                customTagSettings.tagText = tagContent || 'æ”¶è—';
            }

            showNotification('å·²ä¿å­˜å…¶ä»–è®¾ç½®', 'success');
            overlay.style.opacity = '0';
            setTimeout(() => { if(overlay.parentNode) overlay.parentNode.removeChild(overlay); }, 300);
            applyButtonVisibilitySettings();
        };

        footer.appendChild(cancelBtn);
        footer.appendChild(saveBtn);
        dialog.appendChild(footer);

        overlay.appendChild(dialog);
        overlay.appendChild(topNav); // Append nav last
        document.body.appendChild(overlay);

        // Draggable Nav Logic
        try {
            const savedLeft = GM_getValue('other_settings_anchor_left');
            const savedTop = GM_getValue('other_settings_anchor_top');
            if (typeof savedLeft === 'number' && typeof savedTop === 'number') {
                topNav.style.left = Math.max(0, savedLeft) + 'px';
                topNav.style.top = Math.max(0, savedTop) + 'px';
            }

            let isDragging = false;
            let startX, startY, initLeft, initTop;
            let didDrag = false;
            let originalTransition = '';

            topNav.addEventListener('mousedown', e => {
                if (e.button !== 0) return;
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                isDragging = true;
                didDrag = false;
                startX = e.clientX;
                startY = e.clientY;
                const rect = topNav.getBoundingClientRect();
                initLeft = rect.left;
                initTop = rect.top;
                document.documentElement.style.userSelect = 'none';
                originalTransition = topNav.style.transition;
                topNav.style.transition = 'none';
                e.preventDefault();
            });

            window.addEventListener('mousemove', e => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                if (!didDrag) {
                    if (Math.abs(dx) < 2 && Math.abs(dy) < 2) return;
                    didDrag = true;
                }
                topNav.style.left = (initLeft + dx) + 'px';
                topNav.style.top = (initTop + dy) + 'px';
            });

            window.addEventListener('mouseup', () => {
                if (!isDragging) return;
                isDragging = false;
                const rect = topNav.getBoundingClientRect();
                GM_setValue('other_settings_anchor_left', rect.left);
                GM_setValue('other_settings_anchor_top', rect.top);
                document.documentElement.style.userSelect = '';
                topNav.style.transition = originalTransition;
            });
        } catch(_) {}

        const handleScroll = () => {
            if (Date.now() < suppressAutoActiveUntil) return;
            const container = contentArea;
            if (!container) return;
            const containerRect = container.getBoundingClientRect();
            const triggerLine = containerRect.top + 100;
            let activeId = null;
            for (let i = navItems.length - 1; i >= 0; i--) {
                const it = navItems[i];
                const el = document.getElementById(it.targetId);
                if (!el) continue;
                const rect = el.getBoundingClientRect();
                if (rect.top <= triggerLine + 50) {
                    activeId = it.targetId;
                    break;
                }
            }
            if (!activeId && container.scrollTop < 50 && navItems.length > 0) {
                activeId = navItems[0].targetId;
            }
            if (activeId) setActiveById(activeId);
        };
        contentArea.addEventListener('scroll', () => {
            if (window.requestAnimationFrame) requestAnimationFrame(handleScroll);
            else setTimeout(handleScroll, 16);
        });
        handleScroll();
    }

    if (GM_getValue(GLOBAL_REMARK_ON_ADD_KEY) === undefined) {
        GM_setValue(GLOBAL_REMARK_ON_ADD_KEY, false);
    }

    // GitHubå›¾åºŠåŸŸåé…ç½®
    const DOMAIN_GITHUB_CONFIG = {
        useGithub: GM_getValue('domain_github_use', false),  // æ˜¯å¦å¯ç”¨GitHubå›¾åºŠ
        type: GM_getValue('domain_github_type', 'raw'),     // åŸŸåç±»å‹ï¼šraw, pages, custom
        customDomain: GM_getValue('domain_github_custom', '') // è‡ªå®šä¹‰åŸŸå
    };
    // ç½‘ç«™ç‰¹å®šçš„GitHubå›¾åºŠé…ç½®
    const WEBSITE_GITHUB_CONFIG = GM_getValue('website_github_config', {});

    // å°é¢å›¾åºŠé…ç½®
    const COVER_BED_CONFIG = {
        enabled: GM_getValue('cover_bed_enabled', false), // æ˜¯å¦å¯ç”¨å°é¢å›¾åºŠ
        replaceNotionGithub: GM_getValue('replace_notion_github', false), // æ˜¯å¦æ›¿æ¢Notion GitHubé“¾æ¥
        proxyPrefix: GM_getValue('cover_proxy_prefix', '') // å°é¢ä»£ç†å‰ç¼€ï¼Œä¸å¡«åˆ™ä¸ä½¿ç”¨ä»£ç†
    };

    // ç”Ÿæˆä»£ç†URLçš„è¾…åŠ©å‡½æ•°
    function getProxyUrl(imageUrl) {
        // æ£€æŸ¥ç«™ç‚¹é…ç½®ä¸­æ˜¯å¦å¯ç”¨ä»£ç†å‰ç¼€ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
        const siteConfig = getSiteConfig();
        const useProxyPrefix = siteConfig.useProxyPrefix !== false; // é»˜è®¤ä¸º true

        if (!useProxyPrefix) {
            // å¦‚æœç«™ç‚¹é…ç½®ä¸­ç¦ç”¨äº†ä»£ç†å‰ç¼€ï¼Œç›´æ¥è¿”å›åŸå§‹URL
            return imageUrl;
        }

        if (!COVER_BED_CONFIG.proxyPrefix || !COVER_BED_CONFIG.proxyPrefix.trim()) {
            // å¦‚æœæ²¡æœ‰é…ç½®ä»£ç†å‰ç¼€ï¼Œç›´æ¥è¿”å›åŸå§‹URL
            return imageUrl;
        }
        // ä½¿ç”¨é…ç½®çš„ä»£ç†å‰ç¼€ç”Ÿæˆä»£ç†URL
        return `${COVER_BED_CONFIG.proxyPrefix}${encodeURIComponent(imageUrl)}`;
    }



    // è¿½åŠ å†…å®¹æŒ‰é’®é…ç½®
    const APPEND_BUTTON_CONFIG = {
        showAppendButton: GM_getValue('show_append_button', false) // æ˜¯å¦æ˜¾ç¤ºè¿½åŠ å†…å®¹æŒ‰é’®
    };

    // å…¨å±€æ›´æ–°æ¨¡å¼æ ‡è®°
    let isUpdateMode = false;
    window._existingNotionCoverUrl = '';
    let coverUploadTriggeredAutoUpdate = false;
    let autoUpdateTriggeredByDataChange = false;
    let autoUpdateSuspendedDueToCover = false;

    // å…¨å±€å°é¢å¤„ç†çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤ä¸Šä¼ 
    const COVER_PROCESSING_STATE = {
        processedCovers: new Set(), // å·²å¤„ç†çš„å°é¢URLé›†åˆ
        processedCoverResults: new Map(), // è®°å½•å°é¢å¤„ç†ç»“æœï¼Œé¿å…é‡å¤ä¸Šä¼ 
        currentPageUrl: window.location.href, // å½“å‰é¡µé¢URL
        isProcessingCover: false // æ˜¯å¦æ­£åœ¨å¤„ç†å°é¢ï¼ˆé˜²æ­¢é‡å¤å¤„ç†ï¼‰
    };

    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“é¡µé¢é‡æ–°å¯è§æ—¶é‡ç½®çŠ¶æ€
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œæ£€æŸ¥URLæ˜¯å¦å˜åŒ–
            if (COVER_PROCESSING_STATE.currentPageUrl !== window.location.href) {
                console.log('é¡µé¢URLå˜åŒ–ï¼Œé‡ç½®å°é¢å¤„ç†çŠ¶æ€');
                COVER_PROCESSING_STATE.processedCovers.clear();
                COVER_PROCESSING_STATE.processedCoverResults.clear();
                COVER_PROCESSING_STATE.currentPageUrl = window.location.href;
                COVER_PROCESSING_STATE.isProcessingCover = false;
                coverUploadTriggeredAutoUpdate = false;
                autoUpdateTriggeredByDataChange = false;
                autoUpdateSuspendedDueToCover = false;
            }
        }
    });

    // ç›‘å¬é¡µé¢åŠ è½½å®Œæˆï¼Œç¡®ä¿çŠ¶æ€æ­£ç¡®
    window.addEventListener('load', function() {
        // é¡µé¢åŠ è½½å®Œæˆæ—¶ï¼Œé‡ç½®å°é¢å¤„ç†çŠ¶æ€
        COVER_PROCESSING_STATE.processedCovers.clear();
        COVER_PROCESSING_STATE.processedCoverResults.clear();
        COVER_PROCESSING_STATE.currentPageUrl = window.location.href;
        COVER_PROCESSING_STATE.isProcessingCover = false;
        coverUploadTriggeredAutoUpdate = false;
        autoUpdateTriggeredByDataChange = false;
        autoUpdateSuspendedDueToCover = false;
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œé‡ç½®å°é¢å¤„ç†çŠ¶æ€');
    });

    // è¯„åˆ†ç³»ç»Ÿé…ç½®
    const RATING_CONFIG = {
        enabled: GM_getValue('rating_enabled', true), // æ˜¯å¦å¯ç”¨è¯„åˆ†ç³»ç»Ÿ
        defaultRating: GM_getValue('default_rating', 0), // é»˜è®¤è¯„åˆ†
        ratingField: GM_getValue('rating_field_name', 'è¯„åˆ†') // Notionä¸­çš„è¯„åˆ†å­—æ®µå
    };

    // ç±»å‹ç»Ÿä¸€åŒ–é…ç½®
    const DEFAULT_TYPE_MAPPINGS = {
        'æ›´æ–°çŠ¶æ€': {
            'è¿è½½ä¸­': 'è¿è½½,è¿è½½ä¸­,æ›´æ–°ä¸­,è¿æ›´,è¿æ›´ä¸­',
            'å·²å®Œç»“': 'å®Œç»“,å·²å®Œ,å·²å®Œç»“,å®Œæ›´'
        },
        'åœ°åŒº': {
            'éŸ©æ¼«': 'éŸ©å›½,éŸ©æ¼«',
            'æ—¥æ¼«': 'æ—¥æœ¬,æ—¥æ¼«',
            'å›½æ¼«': 'ä¸­å›½,å¤§é™†,å°æ¹¾,é¦™æ¸¯,æ¾³é—¨,å›½æ¼«',
            'æ¬§ç¾æ¼«': 'æ¬§ç¾,ç¾å›½,è‹±å›½,æ³•å›½,å¾·å›½'
        },
        'ç±»å‹': {
            'BL': 'BL,Boys Love,ç”·ç”·,è€½ç¾',
            'GL': 'GL,Girls Love,å¥³å¥³,ç™¾åˆ',
            'æ‹çˆ±': 'æ‹çˆ±,çˆ±æƒ…,è¨€æƒ…',
            'å¥‡å¹»': 'å¥‡å¹»,é­”å¹»,ç„å¹»'
        }
    };

    // åŠ è½½ç±»å‹æ˜ å°„é…ç½®
    function loadTypeMappings() {
        const saved = GM_getValue('typeMappings');
        if (saved) {
            // æ£€æŸ¥savedæ˜¯å¦æ‹¥æœ‰æ‰€æœ‰å¿…è¦çš„å­—æ®µ
            const result = {};
            const fields = ['æ›´æ–°çŠ¶æ€', 'åœ°åŒº', 'ç±»å‹'];

            for (const field of fields) {
                result[field] = saved[field] || {};
            }

            return result;
        }
        return JSON.parse(JSON.stringify(DEFAULT_TYPE_MAPPINGS));
    }

    function getConfiguredExpandSelectors(config) {
        if (!config) return [];
        const selectors = [];
        if (Array.isArray(config.expandBtnSelectors)) {
            selectors.push(...config.expandBtnSelectors.filter(Boolean));
        }
        if (config.expandBtnSelector && !selectors.includes(config.expandBtnSelector)) {
            selectors.push(config.expandBtnSelector);
        }
        return selectors;
    }

    // æ™ºèƒ½æå–è·¯å¾„æ¨¡å¼ï¼ˆå¢å¼ºï¼šæ”¯æŒéæ•°å­—ç»“å°¾ï¼Œä¿ç•™çˆ¶çº§åŒ¹é…ï¼‰

    function extractSmartPattern(urlStr) {
        try {
            const url = new URL(urlStr);
            let path = url.pathname;

            const parts = path.split('/').filter(Boolean);

            if (parts.length > 0) {
                const last = parts[parts.length - 1];
                if (last.includes('*')) {
                } else {
                    const replaced = /\d/.test(last) ? last.replace(/\d+/g, '*') : last.replace(/\d+$/, '*');
                    parts[parts.length - 1] = replaced;
                }
                path = '/' + parts.join('/');
            }

            if (url.search && !path.endsWith('*')) {
                path += '*';
            }

            if (!path.startsWith('/')) {
                path = '/' + path;
            }

            let parentPath = '';
            if (parts.length > 1) {
                const parentParts = [...parts];
                parentParts.pop();
                parentPath = '/' + parentParts.join('/') + '/*';
            }

            return {
                domain: url.hostname,
                pattern: path,
                fullPattern: `${url.hostname}${path}`,
                parentPattern: parentPath ? `${url.hostname}${parentPath}` : null
            };
        } catch (e) {
            console.error('URLè§£æå¤±è´¥:', e);
            return null;
        }
    }

    // æ”¹è¿›çš„è·¯å¾„åŒ¹é…æ£€æŸ¥
    // å°†é€šé…æ¨¡å¼è½¬æ¢ä¸ºæ­£åˆ™ï¼š
    // - å…ˆè½¬ä¹‰æ‰€æœ‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦ï¼ˆä¿ç•™ *ï¼‰
    // - å°† * ä½œä¸ºå•å±‚é€šé…ï¼Œæ›¿æ¢ä¸º [^/]+ï¼ˆåªåŒ¹é…éæ–œæ å­—ç¬¦ï¼Œä¸åŒ¹é…å¤šå±‚çº§è·¯å¾„ï¼‰
    // - ä½¿ç”¨ ^ å’Œ $ é”šå®šå®Œæ•´åŒ¹é…
    function createRegexFromPattern(fullPattern) {
        // è½¬ä¹‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦ï¼ˆä¸åŒ…å« *ï¼Œç¨åå¤„ç†ï¼‰
        const escaped = fullPattern.replace(/[-\/\\^$+?.()|[\]{}]/g, '\\$&');
        // å°† * æ›¿æ¢ä¸º [^/]+ï¼ŒåªåŒ¹é…å•å±‚è·¯å¾„ï¼ˆä¸åŒ…å«æ–œæ çš„å­—ç¬¦åºåˆ—ï¼‰
        const source = '^' + escaped.replace(/\*/g, '[^/]+') + '$';
        return new RegExp(source);
    }

    function isCurrentPageEnabled() {
        // å…¨å±€å¼€å…³ä¼˜å…ˆ
        if (GM_getValue(GLOBAL_SHOW_BUTTONS_KEY, false)) return true;
        const enabledPatterns = GM_getValue(ENABLED_PATTERNS_KEY, []);
        const currentUrl = window.location.href;
        const current = extractSmartPattern(currentUrl);

        if (!current) return false;

        return enabledPatterns.some(savedPattern => {
            // å®Œå…¨åŒ¹é…æ¨¡å¼
            if (savedPattern.fullPattern === current.fullPattern) return true;

            // çˆ¶è·¯å¾„åŒ¹é… (æ–°å¢) - æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†çˆ¶è·¯å¾„æ¨¡å¼
            if (savedPattern.parentPattern && current.fullPattern.startsWith(savedPattern.parentPattern.replace(/\*$/, ''))) {
                return true;
            }

            // é€šé…ç¬¦åŒ¹é…ï¼ˆå‡çº§ï¼šå®‰å…¨è½¬ä¹‰ + å¤šå±‚ * æ”¯æŒï¼‰
            const regex = createRegexFromPattern(savedPattern.fullPattern);
            return regex.test(current.fullPattern);
        });
    }

    // ç±»å‹ç»Ÿä¸€åŒ–å¤„ç†
    function normalizeField(field, value, typeMappings) {
        if (!value || !typeMappings[field]) return value;

        const lowerValue = value.toLowerCase();
        const fieldMappings = typeMappings[field];

        for (const [standard, variantsStr] of Object.entries(fieldMappings)) {
            const variants = variantsStr.split(',').map(v => v.trim());
            for (const variant of variants) {
                if (variant && lowerValue.includes(variant.toLowerCase())) {
                    return standard;
                }
            }
        }

        return value; // æ²¡æœ‰åŒ¹é…é¡¹ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
    }

    // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ç¹ä½“å­—ç¬¦
    function containsTraditionalChinese(text) {
        if (!text) return false;
        // å¸¸è§ç¹ä½“å­—ç¬¦èŒƒå›´
        const traditionalRanges = [
            [0x4E00, 0x9FFF],   // åŸºæœ¬æ±‰å­—
            [0x3400, 0x4DBF],   // æ‰©å±•A
            [0x20000, 0x2A6DF], // æ‰©å±•B
            [0x2A700, 0x2B73F], // æ‰©å±•C
            [0x2B740, 0x2B81F], // æ‰©å±•D
            [0x2B820, 0x2CEAF], // æ‰©å±•E
            [0x2CEB0, 0x2EBEF], // æ‰©å±•F
            [0x30000, 0x3134F], // æ‰©å±•G
            [0x31350, 0x323AF]  // æ‰©å±•H
        ];

        for (let i = 0; i < text.length; i++) {
            const charCode = text.charCodeAt(i);
            for (const [start, end] of traditionalRanges) {
                if (charCode >= start && charCode <= end) {
                    return true;
                }
            }
        }
        return false;
    }

    // ç¹ç®€è½¬æ¢å‡½æ•°ï¼ˆä»…åœ¨æ£€æµ‹åˆ°ç¹ä½“æ—¶è½¬æ¢ï¼‰
    function convertToSimplified(text) {
        if (!text || !containsTraditionalChinese(text)) return text;
        try {
            const converter = OpenCC.Converter({ from: 'hk', to: 'cn' });
            return converter(text);
        } catch (error) {
            console.error('ç¹ç®€è½¬æ¢å¤±è´¥:', error);
            return text;
        }
    }

    // å¢å¼ºç‰ˆå›¾ç‰‡æå–å™¨
    function extractImageUrl(element) {
        if (!element) return '';

        if (typeof element === 'string') {
            element = document.querySelector(element);
            if (!element) return '';
        }

        // 1. æ£€æŸ¥å„ç§å¯èƒ½çš„å›¾ç‰‡å±æ€§
        const attrs = ['data-original', 'data-src', 'data-lazy-src', 'src', 'data-url', 'data-srcset', 'srcset', 'data-bg', 'data-original-src', 'data-poster', 'data-thumb', 'data-large'];
        for (const attr of attrs) {
            const url = element.getAttribute(attr);
            if (url) {
                // å¤„ç†srcsetæƒ…å†µ
                if (attr === 'data-srcset' || attr === 'srcset') {
                    const urls = url.split(',').map(item => item.trim().split(' ')[0]);
                    if (urls.length > 0) {
                        const finalUrl = urls[0].startsWith('//') ? 'https:' + urls[0] : urls[0];
                        return finalUrl;
                    }
                }

                if (url.startsWith('http') || url.startsWith('//') || url.startsWith('/')) {
                    if (url.startsWith('//')) {
                        return 'https:' + url;
                    } else if (url.startsWith('/')) {
                        return window.location.origin + url;
                    } else {
                        return url;
                    }
                }
            }
        }

        // 2. æ£€æŸ¥èƒŒæ™¯å›¾ç‰‡
        const computedStyle = window.getComputedStyle(element);
        if (computedStyle.backgroundImage && computedStyle.backgroundImage !== 'none') {
            const match = computedStyle.backgroundImage.match(/url\(['"]?([^'"()]+)['"]?\)/);
            if (match && match[1]) {
                const url = match[1];
                if (url.startsWith('//')) {
                    return 'https:' + url;
                } else if (url.startsWith('/')) {
                    return window.location.origin + url;
                } else {
                    return url;
                }
            }
        }

        // 3. æ£€æŸ¥data-styleå±æ€§
        const dataStyle = element.getAttribute('data-style');
        if (dataStyle) {
            const bgMatch = dataStyle.match(/background-image\s*:\s*url\(['"]?([^'"()]+)['"]?\)/i);
            if (bgMatch && bgMatch[1]) {
                const url = bgMatch[1];
                if (url.startsWith('//')) {
                    return 'https:' + url;
                } else if (url.startsWith('/')) {
                    return window.location.origin + url;
                } else {
                    return url;
                }
            }
        }

        // 4. æ£€æŸ¥å­å…ƒç´ ä¸­çš„å›¾ç‰‡ (ä¸ä»…æ˜¯ç¬¬ä¸€ä¸ªå­imgï¼Œæ£€æŸ¥æ‰€æœ‰å­imgï¼Œå–ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„)
        const imgChildren = element.querySelectorAll('img');
        for (const imgChild of imgChildren) {
            // å…ˆæ£€æŸ¥å±æ€§
            for (const attr of attrs) {
                const url = imgChild.getAttribute(attr);
                if (url) {
                    if (url.startsWith('//')) {
                        return 'https:' + url;
                    } else if (url.startsWith('/')) {
                        return window.location.origin + url;
                    } else if (url.startsWith('http')) {
                        return url;
                    }
                }
            }
        }

        // 5. æ£€æŸ¥metaæ ‡ç­¾
        const metaImages = [
            'meta[property="og:image"]',
            'meta[name="twitter:image"]',
            'meta[itemprop="image"]',
            'meta[name="thumbnail"]'
        ];

        for (const selector of metaImages) {
            const meta = document.querySelector(selector);
            if (meta && meta.content) {
                const url = meta.content;
                if (url.startsWith('//')) {
                    return 'https:' + url;
                } else if (url.startsWith('/')) {
                    return window.location.origin + url;
                } else {
                    return url;
                }
            }
        }

        // 6. æ£€æŸ¥linkæ ‡ç­¾
        const linkImages = [
            'link[rel="image_src"]',
            'link[rel="apple-touch-icon"]',
            'link[rel="icon"]'
        ];

        for (const selector of linkImages) {
            const link = document.querySelector(selector);
            if (link && link.href) {
                return link.href;
            }
        }

        // 7. æ£€æŸ¥JSON-LDæ•°æ®
        try {
            const jsonLdScripts = document.querySelectorAll('script[type="application/ld+json"]');
            for (const jsonLd of jsonLdScripts) {
                try {
                    const data = JSON.parse(jsonLd.textContent);

                    // å¤„ç†åµŒå¥—ç»“æ„
                    function findImageInObject(obj) {
                        if (!obj) return null;

                        // ç›´æ¥æ£€æŸ¥imageå­—æ®µ
                        if (obj.image) {
                            if (typeof obj.image === 'string') {
                                return obj.image;
                            } else if (typeof obj.image === 'object' && obj.image.url) {
                                return obj.image.url;
                            } else if (Array.isArray(obj.image) && obj.image.length > 0) {
                                const firstImage = obj.image[0];
                                if (typeof firstImage === 'string') {
                                    return firstImage;
                                } else if (typeof firstImage === 'object' && firstImage.url) {
                                    return firstImage.url;
                                }
                            }
                        }

                        // æ£€æŸ¥thumbnailå­—æ®µ
                        if (obj.thumbnail) {
                            if (typeof obj.thumbnail === 'string') {
                                return obj.thumbnail;
                            } else if (typeof obj.thumbnail === 'object' && obj.thumbnail.url) {
                                return obj.thumbnail.url;
                            }
                        }

                        // æ·±å…¥æ£€æŸ¥åµŒå¥—å¯¹è±¡
                        for (const key in obj) {
                            if (typeof obj[key] === 'object') {
                                const foundImage = findImageInObject(obj[key]);
                                if (foundImage) return foundImage;
                            }
                        }

                        return null;
                    }

                    const imageUrl = findImageInObject(data);
                    if (imageUrl) {
                        if (imageUrl.startsWith('//')) {
                            return 'https:' + imageUrl;
                        } else if (imageUrl.startsWith('/')) {
                            return window.location.origin + imageUrl;
                        } else {
                            return imageUrl;
                        }
                    }
                } catch (e) {
                    console.log('è§£æå•ä¸ªJSON-LDå¤±è´¥:', e);
                    // ç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªJSON-LD
                }
            }
        } catch (e) {
            console.error('è§£æJSON-LDå¤±è´¥:', e);
        }

        // 8. å°è¯•æŒ‰æƒ¯ä¾‹æ‰¾å°é¢å›¾æ ‡ä½ç½®
        const commonCoverSelectors = [
            '.cover img', '.book-cover img', '.cover-image', '.poster img',
            '.thumbnail img', '.book-img img', '.comic-cover img',
            'img.cover', 'img.book-cover', 'img.thumbnail'
        ];

        for (const selector of commonCoverSelectors) {
            try {
                const coverElem = document.querySelector(selector);
                if (coverElem) {
                    for (const attr of attrs) {
                        const url = coverElem.getAttribute(attr);
                        if (url) {
                            if (url.startsWith('//')) {
                                return 'https:' + url;
                            } else if (url.startsWith('/')) {
                                return window.location.origin + url;
                            } else if (url.startsWith('http')) {
                                return url;
                            }
                        }
                    }
                }
            } catch (e) {
                console.log('æŸ¥æ‰¾å¸¸è§å°é¢é€‰æ‹©å™¨å¤±è´¥:', e);
            }
        }

        return '';
    }



    // Notioné…ç½®
    const NOTION_CONFIG = {
        apiKey: GM_getValue('notion_api_key', ""),
        databaseIds: {
            comic: GM_getValue('notion_database_comic', ""),
            novel: GM_getValue('notion_database_novel', ""),
            clip: GM_getValue('notion_database_clip', "")
        }
    };

    const CUSTOM_DB_MAP = GM_getValue('notion_database_custom_map', {});
    function resolveDatabaseId(type) {
        const t = type === 'record' ? 'clip' : type;
        return NOTION_CONFIG.databaseIds[t] || CUSTOM_DB_MAP[t] || NOTION_CONFIG.databaseIds.clip;
    }

    function getPageTextSnippet() {
        try {
            const txt = document.body ? (document.body.innerText || '') : '';
            return txt.slice(0, 5000);
        } catch (_) { return ''; }
    }

    function evaluateAutoTagRouting(url, title, text, siteConfig) {
        const rules = GM_getValue('auto_tag_routing_rules', []);
        let hostname = '';
        let pathname = '';
        try { const u = new URL(String(url || '')); hostname = (u.hostname || '').toLowerCase(); pathname = (u.pathname || '').toLowerCase(); } catch(_) {}
        const t = String(title || '').toLowerCase();
        const x = String(text || '').toLowerCase();
        const tags = [];
        let routeType = '';
        let tagProperty = '';
        const arr = Array.isArray(rules) ? rules : [];
        for (const r of arr) {
            if (r && r.enabled === false) continue;
            const domains = Array.isArray(r.domains) ? r.domains.map(s => String(s || '').toLowerCase()) : [];
            const paths = Array.isArray(r.paths) ? r.paths.map(s => String(s || '').toLowerCase()) : [];
            const keywords = Array.isArray(r.keywords) ? r.keywords.map(s => String(s || '').toLowerCase()) : [];
            const hasDomains = domains.length > 0;
            const hasPaths = paths.length > 0;
            const hasKeywords = keywords.length > 0;
            const hasTags = Array.isArray(r.tags) && r.tags.length > 0;

            // å¦‚æœè§„åˆ™åªæœ‰tagsï¼ˆæ²¡æœ‰domainsã€pathsã€keywordsï¼‰ï¼Œåˆ™è·³è¿‡ï¼Œè¿™ç§è§„åˆ™åªç”¨äºåŒ¹é…æ˜ å°„æ•°æ®åº“
            if (!hasDomains && !hasPaths && !hasKeywords && hasTags) {
                continue;
            }

            let ok = true;
            if (hasDomains) ok = domains.some(d => hostname.includes(d));
            if (ok && hasPaths) ok = paths.some(p => pathname.includes(p));
            if (ok && hasKeywords) ok = keywords.some(k => t.includes(k) || x.includes(k));
            if (ok) {
                // åªæœ‰åŒ¹é…äº†domains/paths/keywordsçš„è§„åˆ™æ‰ä¼šè‡ªåŠ¨æ‰“æ ‡ç­¾
                if (hasTags) {
                    for (const tg of r.tags) {
                        const name = String(tg || '').trim();
                        if (name && !tags.includes(name)) tags.push(name);
                    }
                }
                if (!routeType && r.routeType) routeType = r.routeType;
                if (!tagProperty && r.tagProperty) tagProperty = String(r.tagProperty || '').trim();
            }
        }
        if (!routeType) routeType = (siteConfig && siteConfig.contentType) ? siteConfig.contentType : 'clip';
        if (!tagProperty) tagProperty = 'ç±»å‹';
        return { tags, routeType, tagProperty };
    }

    // æ£€æŸ¥ç”¨æˆ·é€‰æ‹©çš„æ ‡ç­¾æ˜¯å¦åŒ¹é…åªæœ‰tagsçš„è§„åˆ™ï¼Œè¿”å›åŒ¹é…çš„è§„åˆ™ä¿¡æ¯
    // è¿™ä¸ªå‡½æ•°åªç”¨äºåŒ¹é…æ˜ å°„æ•°æ®åº“ï¼Œä¸ç”¨äºè‡ªåŠ¨æ‰“æ ‡ç­¾
    function checkTagOnlyRule(selectedTags, tagProperty) {
        const rules = GM_getValue('auto_tag_routing_rules', []);
        const arr = Array.isArray(rules) ? rules : [];

        // å°†é€‰ä¸­çš„æ ‡ç­¾è½¬æ¢ä¸ºåç§°æ•°ç»„
        const selectedTagNames = selectedTags.map(tag => {
            if (typeof tag === 'string') return tag.trim();
            if (typeof tag === 'object' && tag.name) return String(tag.name).trim();
            return String(tag).trim();
        }).filter(Boolean);

        // éå†è§„åˆ™ï¼ŒæŸ¥æ‰¾åªæœ‰tagsä¸”åŒ¹é…çš„è§„åˆ™ï¼ˆç”¨äºåŒ¹é…æ˜ å°„æ•°æ®åº“ï¼‰
        for (const r of arr) {
            if (r && r.enabled === false) continue;

            // æ£€æŸ¥æ˜¯å¦æ˜¯åªæœ‰tagsçš„è§„åˆ™ï¼ˆæ²¡æœ‰domainsã€pathsã€keywordsï¼‰
            const hasDomains = Array.isArray(r.domains) && r.domains.length > 0;
            const hasPaths = Array.isArray(r.paths) && r.paths.length > 0;
            const hasKeywords = Array.isArray(r.keywords) && r.keywords.length > 0;
            const hasTags = Array.isArray(r.tags) && r.tags.length > 0;

            // å¦‚æœæ˜¯åªæœ‰tagsçš„è§„åˆ™ï¼Œç”¨äºåŒ¹é…æ˜ å°„æ•°æ®åº“
            if (!hasDomains && !hasPaths && !hasKeywords && hasTags) {
                // æ£€æŸ¥tagPropertyæ˜¯å¦åŒ¹é…
                const ruleTagProperty = String(r.tagProperty || 'ç±»å‹').trim();
                if (tagProperty && ruleTagProperty !== tagProperty) continue;

                // æ£€æŸ¥é€‰ä¸­çš„æ ‡ç­¾æ˜¯å¦åœ¨è§„åˆ™çš„tagsä¸­ï¼ˆå¿…é¡»å®Œå…¨åŒ¹é…ï¼‰
                const ruleTags = r.tags.map(t => String(t || '').trim()).filter(Boolean);
                const hasMatchingTag = selectedTagNames.some(selectedName =>
                                                             ruleTags.some(ruleTag => ruleTag === selectedName || ruleTag.toLowerCase() === selectedName.toLowerCase())
                                                            );

                if (hasMatchingTag) {
                    return {
                        routeType: r.routeType || 'clip',
                        tagProperty: ruleTagProperty,
                        matchedTags: ruleTags.filter(rt =>
                                                     selectedTagNames.some(st => rt === st || rt.toLowerCase() === st.toLowerCase())
                                                    ),
                        isTagOnlyRule: true // æ ‡è®°è¿™æ˜¯åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™
                    };
                }
            }
        }

        return null;
    }

    // GitHubå›¾åºŠé…ç½®
    const GITHUB_CONFIG = {
        token: GM_getValue('github_token', ""),
        username: GM_getValue('github_username', ""),
        repo: GM_getValue('github_repo', ""),
        branch: GM_getValue('github_branch', "main"),
        coverPath: GM_getValue('github_cover_path', "images/cover/"), // å°é¢å›¾ç‰‡è·¯å¾„
        contentPath: GM_getValue('github_content_path', "images/content/"), // å‰ªè—å†…å®¹å›¾ç‰‡è·¯å¾„
        pathModes: GM_getValue('github_path_modes', {}), // å†…å®¹æ¨¡å¼è·¯å¾„é…ç½®
        // æ–°å¢ï¼šæ–‡ä»¶å¤¹æ¨¡å¼é…ç½®
        folderMode: GM_getValue('github_folder_mode', false), // æ˜¯å¦å¯ç”¨æ–‡ä»¶å¤¹æ¨¡å¼
        folderIncludeCover: GM_getValue('github_folder_include_cover', false) // æ–‡ä»¶å¤¹æ¨¡å¼ä¸‹æ˜¯å¦åŒ…å«å°é¢
    };

    // åŸŸåGitHubå›¾åºŠé…ç½®
    const GITHUB_DOMAIN_CONFIG = GM_getValue('github_domain_config', {});

    // ä¿å­˜Notioné…ç½®å‡½æ•°
    function saveNotionConfig(apiKey, comicDatabaseId, novelDatabaseId, clipDatabaseId) {
        GM_setValue('notion_api_key', apiKey);
        GM_setValue('notion_database_comic', comicDatabaseId);
        GM_setValue('notion_database_novel', novelDatabaseId);
        GM_setValue('notion_database_clip', clipDatabaseId);

        // æ›´æ–°å½“å‰è¿è¡Œä¸­çš„é…ç½®
        NOTION_CONFIG.apiKey = apiKey;
        NOTION_CONFIG.databaseIds.comic = comicDatabaseId;
        NOTION_CONFIG.databaseIds.novel = novelDatabaseId;
        NOTION_CONFIG.databaseIds.clip = clipDatabaseId;

        return true;
    }

    // ä¿å­˜GitHubå›¾åºŠé…ç½®å‡½æ•°
    function saveGitHubConfig(token, username, repo, branch, coverPath, contentPath, pathModes = null, folderMode = null, folderIncludeCover = null) {
        GM_setValue('github_token', token);
        GM_setValue('github_username', username);
        GM_setValue('github_repo', repo);
        GM_setValue('github_branch', branch);
        GM_setValue('github_cover_path', coverPath);
        GM_setValue('github_content_path', contentPath);

        // å¦‚æœæä¾›äº†è·¯å¾„æ¨¡å¼é…ç½®ï¼Œåˆ™ä¿å­˜
        if (pathModes !== null) {
            GM_setValue('github_path_modes', pathModes);
            GITHUB_CONFIG.pathModes = pathModes;
        }

        // å¦‚æœæä¾›äº†æ–‡ä»¶å¤¹æ¨¡å¼é…ç½®ï¼Œåˆ™ä¿å­˜
        if (folderMode !== null) {
            GM_setValue('github_folder_mode', folderMode);
            GITHUB_CONFIG.folderMode = folderMode;
        }

        if (folderIncludeCover !== null) {
            GM_setValue('github_folder_include_cover', folderIncludeCover);
            GITHUB_CONFIG.folderIncludeCover = folderIncludeCover;
        }

        // æ›´æ–°å½“å‰è¿è¡Œä¸­çš„é…ç½®
        GITHUB_CONFIG.token = token;
        GITHUB_CONFIG.username = username;
        GITHUB_CONFIG.repo = repo;
        GITHUB_CONFIG.branch = branch;
        GITHUB_CONFIG.coverPath = coverPath;
        GITHUB_CONFIG.contentPath = contentPath;
    }

    // ä¿å­˜è·¯å¾„æ¨¡å¼é…ç½®å‡½æ•°
    function savePathModesConfig(pathModes) {
        GM_setValue('github_path_modes', pathModes);
        GITHUB_CONFIG.pathModes = pathModes;
        return true;
    }

    // è·å–å†…å®¹æ¨¡å¼å¯¹åº”çš„è·¯å¾„
    function getContentModePath(contentType, imageType = 'content') {
        const pathModes = GITHUB_CONFIG.pathModes || {};

        // å¦‚æœå¯ç”¨äº†æ–‡ä»¶å¤¹æ¨¡å¼ä¸”ä¸ºå‰ªè—æ¨¡å¼ï¼Œä½¿ç”¨é¡µé¢æ ‡é¢˜ä½œä¸ºæ–‡ä»¶å¤¹å
        if (GITHUB_CONFIG.folderMode && contentType === 'clip') {
            const pageData = getLastPageData();
            let folderName = '';

            // å°è¯•è·å–é¡µé¢æ ‡é¢˜
            if (window._currentBatchImportData) {
                folderName = sanitizeFileNamePart(window._currentBatchImportData.ä¹¦å || window._currentBatchImportData.æ ‡é¢˜ || 'æœªå‘½å');
            } else {
                const extractedTitle = (typeof smartExtractTitle === 'function' ? smartExtractTitle() : '') || '';
                folderName = sanitizeFileNamePart(extractedTitle || pageData.ä¹¦å || pageData.æ ‡é¢˜ || document.title || 'æœªå‘½å');
            }

            // è·å–ç”¨æˆ·é…ç½®çš„åŸºç¡€è·¯å¾„
            let basePath = '';
            if (imageType === 'cover' && !GITHUB_CONFIG.folderIncludeCover) {
                // å¦‚æœæ˜¯å°é¢ä¸”è®¾ç½®ä¸åŒ…å«åœ¨æ–‡ä»¶å¤¹ä¸­ï¼Œä½¿ç”¨å°é¢è·¯å¾„é…ç½®
                basePath = pathModes['clip_cover'] || 'images/clip/cover/';
                return basePath;
            } else {
                // ä½¿ç”¨å†…å®¹è·¯å¾„é…ç½®ä½œä¸ºåŸºç¡€è·¯å¾„
                basePath = pathModes['clip_content'] || 'images/clip/content/';
                // ç¡®ä¿è·¯å¾„ä»¥/ç»“å°¾
                if (!basePath.endsWith('/')) {
                    basePath += '/';
                }
                // åœ¨ç”¨æˆ·è®¾ç½®çš„è·¯å¾„ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹
                return basePath + `${folderName}/`;
            }
        }

        // åŸæœ‰é€»è¾‘ï¼šæ ¹æ®å†…å®¹ç±»å‹å’Œå›¾ç‰‡ç±»å‹ç¡®å®šä½¿ç”¨å“ªä¸ªè·¯å¾„é…ç½®
        let pathKey = `${contentType}_${imageType}`;

        // è·å–é…ç½®çš„è·¯å¾„ï¼Œå¦‚æœæ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„
        let path = pathModes[pathKey];
        if (!path) {
            // ä½¿ç”¨é»˜è®¤è·¯å¾„æ ¼å¼
            path = `images/${contentType}/${imageType}/`;
        }

        // ç¡®ä¿è·¯å¾„ä»¥/ç»“å°¾
        if (!path.endsWith('/')) {
            path += '/';
        }

        return path;
    }

    // æµ‹è¯•è·¯å¾„é…ç½®åŠŸèƒ½
    function testPathConfig() {
        console.log('ğŸ§ª æµ‹è¯•è·¯å¾„é…ç½®åŠŸèƒ½:');
        console.log('æ¼«ç”»å†…å®¹è·¯å¾„:', getContentModePath('comic', 'content'));
        console.log('æ¼«ç”»å°é¢è·¯å¾„:', getContentModePath('comic', 'cover'));
        console.log('å°è¯´å†…å®¹è·¯å¾„:', getContentModePath('novel', 'content'));
        console.log('å°è¯´å°é¢è·¯å¾„:', getContentModePath('novel', 'cover'));
        console.log('å‰ªè—å†…å®¹è·¯å¾„:', getContentModePath('clip', 'content'));
        console.log('å‰ªè—å°é¢è·¯å¾„:', getContentModePath('clip', 'cover'));
    }

    // ä¿å­˜åŸŸåé…ç½®å‡½æ•°
    function saveDomainGitHubConfig(useGithub, domainType, customDomain) {
        GM_setValue('domain_github_use', useGithub);
        GM_setValue('domain_github_type', domainType);
        GM_setValue('domain_github_custom', customDomain);

        // æ›´æ–°å½“å‰è¿è¡Œä¸­çš„é…ç½®
        DOMAIN_GITHUB_CONFIG.useGithub = useGithub;
        DOMAIN_GITHUB_CONFIG.type = domainType;
        DOMAIN_GITHUB_CONFIG.customDomain = customDomain;
    }


    // ä¿å­˜åŸŸåGitHubå›¾åºŠé…ç½®å‡½æ•°
    function saveGitHubDomainConfig(domainConfig) {
        GM_setValue('github_domain_config', domainConfig);
        return true;
    }

    // ä¿å­˜åŸŸåCDNé…ç½®å‡½æ•°
    function saveDomainCdnConfig(domain, enabled) {
        const currentConfig = GM_getValue('github_domain_config', {});
        currentConfig[domain] = currentConfig[domain] || {};
        currentConfig[domain].enabled = enabled;
        GM_setValue('github_domain_config', currentConfig);

        // æ›´æ–°å½“å‰è¿è¡Œä¸­çš„é…ç½®
        GITHUB_DOMAIN_CONFIG[domain] = GITHUB_DOMAIN_CONFIG[domain] || {};
        GITHUB_DOMAIN_CONFIG[domain].enabled = enabled;

        console.log(`ğŸŒ åŸŸåCDNé…ç½®å·²ä¿å­˜: ${domain} = ${enabled}`);
        return true;
    }

    // ä¿å­˜å°é¢å›¾åºŠé…ç½®å‡½æ•°
    function saveCoverBedConfig(enabled, replaceNotionGithub = false) {
        GM_setValue('cover_bed_enabled', enabled);
        GM_setValue('replace_notion_github', replaceNotionGithub);
        COVER_BED_CONFIG.enabled = enabled;
        COVER_BED_CONFIG.replaceNotionGithub = replaceNotionGithub;
    }

    function buildGlobalConfigObject(includeSensitive = true) {
        const cfg = {
            notion: {
                apiKey: NOTION_CONFIG.apiKey,
                databaseIds: {
                    comic: NOTION_CONFIG.databaseIds.comic,
                    novel: NOTION_CONFIG.databaseIds.novel,
                    clip: NOTION_CONFIG.databaseIds.clip
                }
            },
            github: {
                token: GITHUB_CONFIG.token,
                username: GITHUB_CONFIG.username,
                repo: GITHUB_CONFIG.repo,
                branch: GITHUB_CONFIG.branch,
                coverPath: GITHUB_CONFIG.coverPath,
                contentPath: GITHUB_CONFIG.contentPath,
                pathModes: GITHUB_CONFIG.pathModes
            },
            domainGithub: {
                useGithub: DOMAIN_GITHUB_CONFIG.useGithub,
                type: DOMAIN_GITHUB_CONFIG.type,
                customDomain: DOMAIN_GITHUB_CONFIG.customDomain
            },
            coverBed: {
                enabled: COVER_BED_CONFIG.enabled,
                replaceNotionGithub: COVER_BED_CONFIG.replaceNotionGithub,
                proxyPrefix: COVER_BED_CONFIG.proxyPrefix || ''
            },
            rating: {
                enabled: RATING_CONFIG.enabled,
                defaultRating: RATING_CONFIG.defaultRating,
                ratingField: RATING_CONFIG.ratingField
            },
            autoUpdate: {
                enabled: !GM_getValue('autoUpdateDisabled', false),
                checkInterval: ENHANCED_AUTO_UPDATE_CONFIG.checkInterval,
                smartDetection: ENHANCED_AUTO_UPDATE_CONFIG.smartDetection,
                updateNotification: ENHANCED_AUTO_UPDATE_CONFIG.updateNotification,
                rapidRetryEnabled: ENHANCED_AUTO_UPDATE_CONFIG.rapidRetryEnabled,
                rapidRetryCount: ENHANCED_AUTO_UPDATE_CONFIG.rapidRetryCount,
                rapidRetryInterval: ENHANCED_AUTO_UPDATE_CONFIG.rapidRetryInterval,
                observerEnabled: ENHANCED_AUTO_UPDATE_CONFIG.observerEnabled,
                visibilityTrigger: ENHANCED_AUTO_UPDATE_CONFIG.visibilityTrigger,
                domDebounceMs: ENHANCED_AUTO_UPDATE_CONFIG.domDebounceMs,
                cacheTtlMs: ENHANCED_AUTO_UPDATE_CONFIG.cacheTtlMs,
                initCheckDelayMs: ENHANCED_AUTO_UPDATE_CONFIG.initCheckDelayMs
            },
            customStyle: {
                enabled: CUSTOM_STYLE_CONFIG.enabled,
                vars: {
                    primarycolor: GM_getValue('custom_primarycolor', ''),
                    primarycolorDark: GM_getValue('custom_primarycolor_dark', ''),
                    primarycolorLight: GM_getValue('custom_primarycolor_light', ''),
                    primarycolorLighter: GM_getValue('custom_primarycolor_lighter', ''),
                    primarycolorAlpha: GM_getValue('custom_primarycolor_alpha', 100),
                    primarycolorDarkAlpha: GM_getValue('custom_primarycolor_dark_alpha', 100),
                    primarycolorLightAlpha: GM_getValue('custom_primarycolor_light_alpha', 100),
                    primarycolorLighterAlpha: GM_getValue('custom_primarycolor_lighter_alpha', 100),
                    textColor: GM_getValue('custom_text_color2', ''),
                    shadowColor: GM_getValue('custom_shadow_color', '')
                },
                primarycolor: CUSTOM_STYLE_CONFIG.primarycolor,
                secondaryColor: CUSTOM_STYLE_CONFIG.secondaryColor,
                backgroundColor: CUSTOM_STYLE_CONFIG.backgroundColor,
                textColor: CUSTOM_STYLE_CONFIG.textColor,
                borderRadius: CUSTOM_STYLE_CONFIG.borderRadius,
                shadow: CUSTOM_STYLE_CONFIG.shadow,
                fontSize: GM_getValue('custom_font_size', '14px'),
                fontFamily: GM_getValue('custom_font_family', 'system-ui, -apple-system, sans-serif')
            },
            smartExtraction: {
                enabled: SMART_EXTRACTION_CONFIG.enabled,
                fallbackSelectors: SMART_EXTRACTION_CONFIG.fallbackSelectors,
                contentAnalysis: SMART_EXTRACTION_CONFIG.contentAnalysis,
                autoCleanup: SMART_EXTRACTION_CONFIG.autoCleanup,
                confidenceThreshold: SMART_EXTRACTION_CONFIG.confidenceThreshold
            },
            expandIntervalMs: (function(){
                try { return parseInt(GM_getValue('expand_click_interval_ms', 150), 10) || 150; } catch(_) { return 150; }
            })(),
            stepConfig: {
                enabled: GM_getValue('useStepConfig', false)
            },
            visibleSelectors: {
                comic: GM_getValue('visibleSelectors_comic', {
                    æ ‡é¢˜: true, ä½œè€…: true, ç®€ä»‹: true, æœ€æ–°ç« èŠ‚: true, æ›´æ–°çŠ¶æ€: true,
                    å°é¢: true, è¿½æ›´: true, åˆ«å: true, åœ°åŒº: true, ç±»å‹: true
                }),
                novel: GM_getValue('visibleSelectors_novel', {
                    æ ‡é¢˜: true, ä½œè€…: true, ç®€ä»‹: true, æœ€æ–°ç« èŠ‚: true, æ›´æ–°çŠ¶æ€: true,
                    å°é¢: true, è¿½æ›´: true, åˆ«å: true, åœ°åŒº: true, ç±»å‹: true
                }),
                clip: GM_getValue('visibleSelectors_clip', {
                    æ ‡é¢˜: true, ä½œè€…: true, ç®€ä»‹: true, å°é¢: true
                })
            },
            websiteGithub: WEBSITE_GITHUB_CONFIG,
            customConfigs: GM_getValue('customConfigs', {}),
            enabledPatterns: GM_getValue(ENABLED_PATTERNS_KEY, []),
            typeMappings: GM_getValue('typeMappings', {}),
            showAppendButton: GM_getValue('show_append_button', false),
            customTags: {
                novel: GM_getValue('custom_tags_novel', []),
                comic: GM_getValue('custom_tags_comic', []),
                clip: GM_getValue('custom_tags_clip', [])
            },
            customTagGroups: {
                novel: GM_getValue('custom_tag_groups_novel', {}),
                comic: GM_getValue('custom_tag_groups_comic', {}),
                clip: GM_getValue('custom_tag_groups_clip', {})
            },
            customMainGroups: {
                novel: GM_getValue('custom_main_groups_novel', {}),
                comic: GM_getValue('custom_main_groups_comic', {}),
                clip: GM_getValue('custom_main_groups_clip', {})
            },
            autoTagRoutingRules: GM_getValue('auto_tag_routing_rules', []),
            notionDatabaseCustomMap: GM_getValue('notion_database_custom_map', {}),
            clipTypesWithColors: GM_getValue('clip_types_with_colors', []),
            clipTypes: GM_getValue('clip_types', []),
            markdownTransformEnabled: GM_getValue('markdown_transform_enabled', false),
            markdownTransformRules: GM_getValue('markdown_transform_rules', []),
            markdownTransformUseDomain: GM_getValue('markdown_transform_use_domain', false),
            markdownTransformDomainConfigs: (() => {
                const allKeys = GM_listValues();
                const domainConfigs = {};
                allKeys.forEach(key => {
                    if (key.startsWith('markdown_transform_enabled_') || key.startsWith('markdown_transform_rules_')) {
                        const domain = key.replace('markdown_transform_enabled_', '').replace('markdown_transform_rules_', '');
                        if (!domainConfigs[domain]) domainConfigs[domain] = {};
                        if (key.startsWith('markdown_transform_enabled_')) {
                            domainConfigs[domain].enabled = GM_getValue(key);
                        } else if (key.startsWith('markdown_transform_rules_')) {
                            domainConfigs[domain].rules = GM_getValue(key);
                        }
                    }
                });
                return Object.keys(domainConfigs).length > 0 ? domainConfigs : undefined;
            })(),
            tagDotTitle: GM_getValue('tag_dot_title', 'è‡ªå®šä¹‰æ ‡ç­¾'),
            tagDotTags: GM_getValue('tag_dot_tags', ''),
            tagDotPropertyName: GM_getValue('tag_dot_property_name', 'è‡ªå®šä¹‰æ ‡ç­¾'),
            tagDotTagText: GM_getValue('tag_dot_tag_text', ''),
            tagPropertyName: GM_getValue('tagPropertyName', null),
            tagContent: GM_getValue('tagContent', null),
            currentMainGroupNovel: GM_getValue('current_main_group_novel', null),
            currentMainGroupComic: GM_getValue('current_main_group_comic', null),
            currentMainGroupClip: GM_getValue('current_main_group_clip', null),
            tagUsageStatsNovel: GM_getValue('tag_usage_stats_novel', {}),
            tagUsageStatsComic: GM_getValue('tag_usage_stats_comic', {}),
            tagUsageStatsClip: GM_getValue('tag_usage_stats_clip', {}),
            githubFolderMode: GM_getValue('github_folder_mode', false),
            githubFolderIncludeCover: GM_getValue('github_folder_include_cover', false),
            globalShowButtons: GM_getValue('globalShowButtons', GM_getValue('global_show_buttons', false)),
            globalRemarkOnAdd: GM_getValue('global_remark_on_add', false),
            selectorMergeSeparator: (function(){
                try { return GM_getValue('selector_merge_separator', ''); } catch(_) { return ''; }
            })(),
            buttonStyle: {
                iconMode: GM_getValue('icon_mode', '1'),
                styleMode: GM_getValue('tag_btn_style_mode', 'bordered'),
                buttonIcon: GM_getValue('button_icon', 'â™¥'),
                buttonIconSize: GM_getValue('button_icon_size', '14')
            },
            configUiToggles: {
                showSelectBtn: GM_getValue('show-select-btn', true),
                showFilterBtn: GM_getValue('show-filter-btn', true),
                showTestBtn: GM_getValue('show-test-btn', true),
                showHighlightBtn: GM_getValue('show-highlight-btn', true),
                showLocateBtn: GM_getValue('show-locate-btn', true),
                showConfigAnchorNav: GM_getValue('show_config_anchor_nav', true)
            },
            request: {
                timeout: GM_getValue('requestTimeout', 10000),
                parallelRequests: GM_getValue('parallelRequests', true),
                useJsdelivrAcceleration: GM_getValue('use_jsdelivr_acceleration', false)
            },
            notionVerifyDatabaseId: GM_getValue('notion_verify_database_id', ''),
            titleClean: {
                removeBrackets: (function(){ try { return GM_getValue('title_remove_brackets', true); } catch(_) { return true; } })(),
                trimUnderscore: (function(){ try { return GM_getValue('title_trim_underscore', true); } catch(_) { return true; } })()
            },
            githubDomainConfig: GITHUB_DOMAIN_CONFIG,
            enhancedAutoUpdateEnabled: GM_getValue('enhanced_auto_update_enabled', true),
            siteConfigs: (function(){
                try {
                    const allKeys = GM_listValues();
                    const result = {};
                    const isDefaultLike = (host, cfg) => {
                        const def = DEFAULT_SITE_CONFIGS[host];
                        if (!def || !cfg) return false;
                        const selEq = JSON.stringify(cfg.selectors || {}) === JSON.stringify(def.selectors || {});
                        const idxEq = JSON.stringify(cfg.selectorIndices || {}) === JSON.stringify(def.selectorIndices || {});
                        const typeEq = String(cfg.contentType || '') === String(def.contentType || '');
                        const extraKeys = Object.keys(cfg).filter(k => !['selectors','selectorIndices','adjustSelectors','contentType'].includes(k));
                        return selEq && idxEq && typeEq && extraKeys.length === 0;
                    };
                    allKeys.forEach(key => {
                        if (key.startsWith('site_config_')) {
                            const host = key.replace('site_config_', '');
                            const val = GM_getValue(key);
                            if (val !== undefined) {
                                if (!isDefaultLike(host.replace(/\/.*$/, ''), val)) {
                                    result[host] = val;
                                }
                            }
                        }
                    });
                    return Object.keys(result).length ? result : undefined;
                } catch(_) { return undefined; }
            })(),
            exportTime: new Date().toISOString(),
            version: '3.0'
        };
        if (!includeSensitive) {
            try { cfg.notion.apiKey = ''; } catch(_) {}
            try { cfg.github.token = ''; } catch(_) {}
        }
        return cfg;
    }

    function buildPartialExportConfig(selectedKeys, excludeSensitive) {
        const full = buildGlobalConfigObject(!excludeSensitive);
        const result = {};
        selectedKeys.forEach(k => {
            if (k in full) {
                result[k] = full[k];
            }
        });
        result.exportTime = new Date().toISOString();
        result.version = '3.0';
        result.exportedModules = selectedKeys.slice();
        return result;
    }


    // å¯¼å‡ºå…¨å±€é…ç½®å‡½æ•°
    function exportGlobalConfig() {
        try {
            const config = buildGlobalConfigObject(true);

            // åˆ›å»ºJSONå­—ç¬¦ä¸²
            const configJson = JSON.stringify(config, null, 2);

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([configJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
            const a = document.createElement('a');
            a.href = url;
            a.download = `notion-clipper-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // æ¸…ç†URLå¯¹è±¡
            URL.revokeObjectURL(url);

            showNotification('é…ç½®å·²å¯¼å‡º', 'success');
            console.log('é…ç½®å¯¼å‡ºæˆåŠŸ:', config);

        } catch (error) {
            console.error('å¯¼å‡ºé…ç½®å¤±è´¥:', error);
            showNotification('å¯¼å‡ºé…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    // å¯¼å…¥å…¨å±€é…ç½®å‡½æ•°
    function importGlobalConfig(configJson) {
        try {
            const config = JSON.parse(configJson);

            // éªŒè¯é…ç½®æ ¼å¼
            if (!config.version || !config.notion || !config.github) {
                throw new Error('é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
            }

            // å¯¼å…¥Notioné…ç½®
            if (config.notion.apiKey) {
                NOTION_CONFIG.apiKey = config.notion.apiKey;
                GM_setValue('notion_api_key', config.notion.apiKey);
            }

            if (config.notion.databaseIds) {
                NOTION_CONFIG.databaseIds.comic = config.notion.databaseIds.comic || '';
                NOTION_CONFIG.databaseIds.novel = config.notion.databaseIds.novel || '';
                NOTION_CONFIG.databaseIds.clip = config.notion.databaseIds.clip || '';

                GM_setValue('notion_database_comic', NOTION_CONFIG.databaseIds.comic);
                GM_setValue('notion_database_novel', NOTION_CONFIG.databaseIds.novel);
                GM_setValue('notion_database_clip', NOTION_CONFIG.databaseIds.clip);
            }

            // å¯¼å…¥GitHubé…ç½®
            if (config.github.token) {
                GITHUB_CONFIG.token = config.github.token;
                GM_setValue('github_token', config.github.token);
            }

            if (config.github.username) {
                GITHUB_CONFIG.username = config.github.username;
                GM_setValue('github_username', config.github.username);
            }

            if (config.github.repo) {
                GITHUB_CONFIG.repo = config.github.repo;
                GM_setValue('github_repo', config.github.repo);
            }

            if (config.github.branch) {
                GITHUB_CONFIG.branch = config.github.branch;
                GM_setValue('github_branch', config.github.branch);
            }

            if (config.github.coverPath) {
                GITHUB_CONFIG.coverPath = config.github.coverPath;
                GM_setValue('github_cover_path', config.github.coverPath);
            }

            if (config.github.contentPath) {
                GITHUB_CONFIG.contentPath = config.github.contentPath;
                GM_setValue('github_content_path', config.github.contentPath);
            }

            if (config.github.pathModes) {
                GITHUB_CONFIG.pathModes = config.github.pathModes;
                GM_setValue('github_path_modes', config.github.pathModes);
            }

            // å¯¼å…¥åŸŸåGitHubé…ç½®
            if (config.domainGithub) {
                DOMAIN_GITHUB_CONFIG.useGithub = config.domainGithub.useGithub || false;
                DOMAIN_GITHUB_CONFIG.type = config.domainGithub.type || 'raw';
                DOMAIN_GITHUB_CONFIG.customDomain = config.domainGithub.customDomain || '';

                GM_setValue('domain_github_use', DOMAIN_GITHUB_CONFIG.useGithub);
                GM_setValue('domain_github_type', DOMAIN_GITHUB_CONFIG.type);
                GM_setValue('domain_github_custom', DOMAIN_GITHUB_CONFIG.customDomain);
            }

            // å¯¼å…¥å°é¢å›¾åºŠé…ç½®
            if (config.coverBed) {
                COVER_BED_CONFIG.enabled = config.coverBed.enabled || false;
                COVER_BED_CONFIG.replaceNotionGithub = config.coverBed.replaceNotionGithub || false;
                COVER_BED_CONFIG.proxyPrefix = config.coverBed.proxyPrefix || '';

                GM_setValue('cover_bed_enabled', COVER_BED_CONFIG.enabled);
                GM_setValue('replace_notion_github', COVER_BED_CONFIG.replaceNotionGithub);
                GM_setValue('cover_proxy_prefix', COVER_BED_CONFIG.proxyPrefix);
            }

            // å¯¼å…¥å…¶ä»–é…ç½®
            if (config.websiteGithub) {
                GM_setValue('website_github_config', config.websiteGithub);
            }

            if (config.customConfigs) {
                GM_setValue('customConfigs', config.customConfigs);
            }

            if (config.enabledPatterns) {
                GM_setValue(ENABLED_PATTERNS_KEY, config.enabledPatterns);
            }

            if (config.typeMappings) {
                GM_setValue('typeMappings', config.typeMappings);
            }

            if (typeof config.ratingEnabled !== 'undefined') {
                GM_setValue('rating_enabled', config.ratingEnabled);
            }

            if (typeof config.showAppendButton !== 'undefined') {
                GM_setValue('show_append_button', config.showAppendButton);
            }

            // å¯¼å…¥è‡ªå®šä¹‰æ ‡ç­¾é…ç½®
            if (config.customTags) {
                if (config.customTags.novel) {
                    GM_setValue('custom_tags_novel', config.customTags.novel);
                }
                if (config.customTags.comic) {
                    GM_setValue('custom_tags_comic', config.customTags.comic);
                }
                if (config.customTags.clip) {
                    GM_setValue('custom_tags_clip', config.customTags.clip);
                }
            }

            // å¯¼å…¥è‡ªå®šä¹‰æ ‡ç­¾åˆ†ç»„é…ç½®
            if (config.customTagGroups) {
                if (config.customTagGroups.novel) {
                    GM_setValue('custom_tag_groups_novel', config.customTagGroups.novel);
                }
                if (config.customTagGroups.comic) {
                    GM_setValue('custom_tag_groups_comic', config.customTagGroups.comic);
                }
                if (config.customTagGroups.clip) {
                    GM_setValue('custom_tag_groups_clip', config.customTagGroups.clip);
                }
            }

            // å¯¼å…¥è‡ªå®šä¹‰ä¸»åˆ†ç»„é…ç½®
            if (config.customMainGroups) {
                if (config.customMainGroups.novel) {
                    GM_setValue('custom_main_groups_novel', config.customMainGroups.novel);
                }
                if (config.customMainGroups.comic) {
                    GM_setValue('custom_main_groups_comic', config.customMainGroups.comic);
                }
                if (config.customMainGroups.clip) {
                    GM_setValue('custom_main_groups_clip', config.customMainGroups.clip);
                }
            }

            // å¯¼å…¥è¯„åˆ†é…ç½®
            if (config.rating) {
                GM_setValue('rating_enabled', config.rating.enabled !== false);
                GM_setValue('default_rating', config.rating.defaultRating || 0);
                GM_setValue('rating_field_name', config.rating.ratingField || 'è¯„åˆ†');
            }

            // å¯¼å…¥è‡ªåŠ¨æ›´æ–°é…ç½®
            if (config.autoUpdate) {
                GM_setValue('autoUpdateDisabled', !config.autoUpdate.enabled);
                GM_setValue('auto_update_check_interval', config.autoUpdate.checkInterval || 5);
                GM_setValue('smart_update_detection', config.autoUpdate.smartDetection !== false);
                GM_setValue('update_notification_enabled', config.autoUpdate.updateNotification !== false);
                GM_setValue('auto_update_rapid_retry_enabled', config.autoUpdate.rapidRetryEnabled !== false);
                GM_setValue('auto_update_rapid_retry_count', config.autoUpdate.rapidRetryCount ?? 6);
                GM_setValue('auto_update_rapid_retry_interval', config.autoUpdate.rapidRetryInterval ?? 30);
                GM_setValue('auto_update_dom_observer_enabled', config.autoUpdate.observerEnabled !== false);
                GM_setValue('auto_update_visibility_trigger', config.autoUpdate.visibilityTrigger !== false);
                GM_setValue('auto_update_dom_debounce_ms', config.autoUpdate.domDebounceMs ?? 2000);
                GM_setValue('existing_page_cache_ttl_ms', config.autoUpdate.cacheTtlMs ?? 10000);
                GM_setValue('auto_update_init_check_delay_ms', config.autoUpdate.initCheckDelayMs ?? 100);
            }

            // å¯¼å…¥è‡ªå®šä¹‰æ ·å¼é…ç½®
            if (config.customStyle) {
                GM_setValue('custom_style_enabled', config.customStyle.enabled || false);
                if (config.customStyle.vars) {
                    const v = config.customStyle.vars;
                    GM_setValue('custom_primarycolor', v.primarycolor || '');
                    GM_setValue('custom_primarycolor_dark', v.primarycolorDark || '');
                    GM_setValue('custom_primarycolor_light', v.primarycolorLight || '');
                    GM_setValue('custom_primarycolor_lighter', v.primarycolorLighter || '');
                    GM_setValue('custom_primarycolor_alpha', v.primarycolorAlpha ?? 100);
                    GM_setValue('custom_primarycolor_dark_alpha', v.primarycolorDarkAlpha ?? 100);
                    GM_setValue('custom_primarycolor_light_alpha', v.primarycolorLightAlpha ?? 100);
                    GM_setValue('custom_primarycolor_lighter_alpha', v.primarycolorLighterAlpha ?? 100);
                    if (typeof v.textColor === 'string') GM_setValue('custom_text_color2', v.textColor);
                    if (typeof v.shadowColor === 'string') GM_setValue('custom_shadow_color', v.shadowColor);
                }
                // å…¼å®¹æ—§å­—æ®µ
                GM_setValue('custom_primarycolor_color', config.customStyle.primarycolor || '#FF8FAB');
                GM_setValue('custom_secondary_color', config.customStyle.secondaryColor || '#FF6B9D');
                GM_setValue('custom_background_color', config.customStyle.backgroundColor || '#FFFFFF');
                GM_setValue('custom_text_color', config.customStyle.textColor || '#333333');
                GM_setValue('custom_border_radius', config.customStyle.borderRadius || '8px');
                GM_setValue('custom_shadow', config.customStyle.shadow || '0 2px 4px rgba(0,0,0,0.1)');
            }

            // å¯¼å…¥æ™ºèƒ½æå–é…ç½®
            if (config.smartExtraction) {
                GM_setValue('smart_extraction_enabled', config.smartExtraction.enabled !== false);
                GM_setValue('fallback_selectors_enabled', config.smartExtraction.fallbackSelectors !== false);
                GM_setValue('content_analysis_enabled', config.smartExtraction.contentAnalysis !== false);
                GM_setValue('auto_cleanup_enabled', config.smartExtraction.autoCleanup !== false);
                GM_setValue('confidence_threshold', config.smartExtraction.confidenceThreshold || 0.7);
            }

            if (typeof config.expandIntervalMs !== 'undefined') {
                try {
                    const v = parseInt(config.expandIntervalMs, 10);
                    GM_setValue('expand_click_interval_ms', (!isNaN(v) && v >= 0) ? v : 150);
                } catch (_) { GM_setValue('expand_click_interval_ms', 150); }
            } else if (config.expandSettings && typeof config.expandSettings.clickIntervalMs !== 'undefined') {
                try {
                    const v = parseInt(config.expandSettings.clickIntervalMs, 10);
                    GM_setValue('expand_click_interval_ms', (!isNaN(v) && v >= 0) ? v : 150);
                } catch (_) { GM_setValue('expand_click_interval_ms', 150); }
            }

            // å¯¼å…¥é€æ­¥é…ç½®è®¾ç½®
            if (config.stepConfig) {
                GM_setValue('useStepConfig', config.stepConfig.enabled || false);
            }

            // å¯¼å…¥æ˜¾ç¤ºé€‰æ‹©å™¨é…ç½®
            if (config.visibleSelectors) {
                if (config.visibleSelectors.comic) {
                    GM_setValue('visibleSelectors_comic', config.visibleSelectors.comic);
                }
                if (config.visibleSelectors.novel) {
                    GM_setValue('visibleSelectors_novel', config.visibleSelectors.novel);
                }
                if (config.visibleSelectors.clip) {
                    GM_setValue('visibleSelectors_clip', config.visibleSelectors.clip);
                }
            }

            // å¯¼å…¥ç«™ç‚¹çº§é…ç½®
            if (config.siteConfigs && typeof config.siteConfigs === 'object') {
                try {
                    Object.entries(config.siteConfigs).forEach(([host, cfg]) => {
                        GM_setValue('site_config_' + host, cfg);
                    });
                } catch (_) {}
            }

            // å¯¼å…¥åˆå¹¶åˆ†éš”ç¬¦
            if (typeof config.selectorMergeSeparator !== 'undefined') {
                const raw = String(config.selectorMergeSeparator || '').trim();
                if (raw) {
                    GM_setValue('selector_merge_separator', raw);
                } else {
                    try { GM_deleteValue('selector_merge_separator'); } catch (_) {}
                }
            }

            // å¯¼å…¥è‡ªåŠ¨åˆ†æµä¸æ ‡ç­¾è§„åˆ™
            if (config.autoTagRoutingRules) {
                // è§„èŒƒåŒ–è§„åˆ™æ•°æ®ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
                const normalizedRules = Array.isArray(config.autoTagRoutingRules) ? config.autoTagRoutingRules.map((rule, index) => {
                    if (!rule || typeof rule !== 'object') return null;
                    return {
                        name: String(rule.name || '').trim() || `è§„åˆ™ ${index + 1}`,
                        enabled: rule.enabled !== false,
                        domains: Array.isArray(rule.domains) ? rule.domains : [],
                        paths: Array.isArray(rule.paths) ? rule.paths : [],
                        keywords: Array.isArray(rule.keywords) ? rule.keywords : [],
                        tags: Array.isArray(rule.tags) ? rule.tags : [],
                        tagProperty: String(rule.tagProperty || 'ç±»å‹').trim(),
                        routeType: String(rule.routeType || 'clip').trim()
                    };
                }).filter(rule => rule !== null) : [];
                GM_setValue('auto_tag_routing_rules', normalizedRules);
            }
            if (config.notionDatabaseCustomMap) {
                GM_setValue('notion_database_custom_map', config.notionDatabaseCustomMap);
            }

            // å¯¼å…¥ç±»å‹æ ‡ç­¾é…ç½®
            if (config.clipTypesWithColors) {
                GM_setValue('clip_types_with_colors', config.clipTypesWithColors);
            }
            if (config.clipTypes) {
                GM_setValue('clip_types', config.clipTypes);
            }

            // å¯¼å…¥Markdownè½¬æ¢è§„åˆ™
            if (typeof config.markdownTransformEnabled !== 'undefined') {
                GM_setValue('markdown_transform_enabled', config.markdownTransformEnabled);
            }
            if (config.markdownTransformRules) {
                GM_setValue('markdown_transform_rules', config.markdownTransformRules);
            }
            if (typeof config.markdownTransformUseDomain !== 'undefined') {
                GM_setValue('markdown_transform_use_domain', config.markdownTransformUseDomain);
            }
            // å¯¼å…¥æŒ‰åŸŸåå­˜å‚¨çš„Markdownè½¬æ¢è§„åˆ™
            if (config.markdownTransformDomainConfigs) {
                Object.entries(config.markdownTransformDomainConfigs).forEach(([domain, domainConfig]) => {
                    if (typeof domainConfig.enabled !== 'undefined') {
                        GM_setValue(`markdown_transform_enabled_${domain}`, domainConfig.enabled);
                    }
                    if (domainConfig.rules) {
                        GM_setValue(`markdown_transform_rules_${domain}`, domainConfig.rules);
                    }
                });
            }

            // å¯¼å…¥å°åœ†ç‚¹æ ‡ç­¾é…ç½®
            if (config.tagDotTitle) {
                GM_setValue('tag_dot_title', config.tagDotTitle);
            }
            if (config.tagDotTags) {
                GM_setValue('tag_dot_tags', config.tagDotTags);
            }
            if (config.tagDotPropertyName) {
                GM_setValue('tag_dot_property_name', config.tagDotPropertyName);
            }
            if (config.tagDotTagText) {
                GM_setValue('tag_dot_tag_text', config.tagDotTagText);
            }
            if (config.tagPropertyName) {
                GM_setValue('tagPropertyName', config.tagPropertyName);
            }
            if (config.tagContent) {
                GM_setValue('tagContent', config.tagContent);
            }

            // å¯¼å…¥å½“å‰ä¸»åˆ†ç»„
            if (config.currentMainGroupNovel) {
                GM_setValue('current_main_group_novel', config.currentMainGroupNovel);
            }
            if (config.currentMainGroupComic) {
                GM_setValue('current_main_group_comic', config.currentMainGroupComic);
            }
            if (config.currentMainGroupClip) {
                GM_setValue('current_main_group_clip', config.currentMainGroupClip);
            }

            // å¯¼å…¥æ ‡ç­¾ä½¿ç”¨ç»Ÿè®¡
            if (config.tagUsageStatsNovel) {
                GM_setValue('tag_usage_stats_novel', config.tagUsageStatsNovel);
            }
            if (config.tagUsageStatsComic) {
                GM_setValue('tag_usage_stats_comic', config.tagUsageStatsComic);
            }
            if (config.tagUsageStatsClip) {
                GM_setValue('tag_usage_stats_clip', config.tagUsageStatsClip);
            }

            // å¯¼å…¥GitHubæ–‡ä»¶å¤¹æ¨¡å¼é…ç½®
            if (typeof config.githubFolderMode !== 'undefined') {
                GM_setValue('github_folder_mode', config.githubFolderMode);
            }
            if (typeof config.githubFolderIncludeCover !== 'undefined') {
                GM_setValue('github_folder_include_cover', config.githubFolderIncludeCover);
            }

            // å¯¼å…¥å…¨å±€æŒ‰é’®æ˜¾ç¤ºè®¾ç½®
            if (typeof config.globalShowButtons !== 'undefined') {
                GM_setValue('globalShowButtons', config.globalShowButtons);
                GM_setValue('global_show_buttons', config.globalShowButtons);
            }
            if (typeof config.globalRemarkOnAdd !== 'undefined') {
                GM_setValue('global_remark_on_add', config.globalRemarkOnAdd);
            }
            if (config.enabledPatterns) {
                GM_setValue(ENABLED_PATTERNS_KEY, config.enabledPatterns);
            }

            if (config.customStyle && typeof config.customStyle.fontSize !== 'undefined') {
                GM_setValue('custom_font_size', config.customStyle.fontSize);
            }
            if (config.customStyle && typeof config.customStyle.fontFamily !== 'undefined') {
                GM_setValue('custom_font_family', config.customStyle.fontFamily);
            }
            if (typeof config.globalRemarkOnAdd !== 'undefined') {
                GM_setValue('global_enable_remark_on_add', config.globalRemarkOnAdd);
            }
            if (config.buttonStyle) {
                if (typeof config.buttonStyle.iconMode !== 'undefined') GM_setValue('icon_mode', config.buttonStyle.iconMode);
                if (typeof config.buttonStyle.styleMode !== 'undefined') GM_setValue('tag_btn_style_mode', config.buttonStyle.styleMode);
                if (typeof config.buttonStyle.buttonIcon !== 'undefined') GM_setValue('button_icon', config.buttonStyle.buttonIcon);
                if (typeof config.buttonStyle.buttonIconSize !== 'undefined') GM_setValue('button_icon_size', config.buttonStyle.buttonIconSize);
            }
            if (config.configUiToggles) {
                if (typeof config.configUiToggles.showSelectBtn !== 'undefined') GM_setValue('show-select-btn', config.configUiToggles.showSelectBtn);
                if (typeof config.configUiToggles.showFilterBtn !== 'undefined') GM_setValue('show-filter-btn', config.configUiToggles.showFilterBtn);
                if (typeof config.configUiToggles.showTestBtn !== 'undefined') GM_setValue('show-test-btn', config.configUiToggles.showTestBtn);
                if (typeof config.configUiToggles.showHighlightBtn !== 'undefined') GM_setValue('show-highlight-btn', config.configUiToggles.showHighlightBtn);
                if (typeof config.configUiToggles.showLocateBtn !== 'undefined') GM_setValue('show-locate-btn', config.configUiToggles.showLocateBtn);
                if (typeof config.configUiToggles.showConfigAnchorNav !== 'undefined') GM_setValue('show_config_anchor_nav', config.configUiToggles.showConfigAnchorNav);
            }
            if (config.request) {
                if (typeof config.request.timeout !== 'undefined') GM_setValue('requestTimeout', config.request.timeout);
                if (typeof config.request.parallelRequests !== 'undefined') GM_setValue('parallelRequests', config.request.parallelRequests);
                if (typeof config.request.useJsdelivrAcceleration !== 'undefined') GM_setValue('use_jsdelivr_acceleration', config.request.useJsdelivrAcceleration);
            }
            if (typeof config.notionVerifyDatabaseId !== 'undefined') {
                GM_setValue('notion_verify_database_id', config.notionVerifyDatabaseId);
            }
            if (config.titleClean) {
                if (typeof config.titleClean.removeBrackets !== 'undefined') GM_setValue('title_remove_brackets', config.titleClean.removeBrackets);
                if (typeof config.titleClean.trimUnderscore !== 'undefined') GM_setValue('title_trim_underscore', config.titleClean.trimUnderscore);
            }
            if (config.githubDomainConfig) {
                GM_setValue('github_domain_config', config.githubDomainConfig);
            }
            if (typeof config.enhancedAutoUpdateEnabled !== 'undefined') {
                GM_setValue('enhanced_auto_update_enabled', config.enhancedAutoUpdateEnabled);
            }

            showNotification('é…ç½®å¯¼å…¥æˆåŠŸ', 'success');
            console.log('é…ç½®å¯¼å…¥æˆåŠŸ:', config);

        } catch (error) {
            console.error('å¯¼å…¥é…ç½®å¤±è´¥:', error);
            showNotification('å¯¼å…¥é…ç½®å¤±è´¥: ' + error.message, 'error');
        }
    }

    // æ˜¾ç¤ºå¯¼å…¥/å¯¼å‡ºé…ç½®å¯¹è¯æ¡†
    function showImportExportDialog() {
        return new Promise((resolve) => {
            const isMobile = window.innerWidth <= 768;

            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: -webkit-fill-available;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                ${isMobile ? 'padding: 16px;' : ''}
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                border-radius: ${isMobile ? '16px' : '20px'};
                padding: ${isMobile ? '16px' : '24px'} !important;
                max-width: ${isMobile ? '100%' : '600px'};
                width: ${isMobile ? '100%' : '90%'};
                max-height: ${isMobile ? '90vh' : '85vh'};
                overflow-y: auto;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                border: 1px solid rgba(255, 255, 255, 0.2);
                position: relative;
            `;
            dialog.className = 'notion-ImportExport-dialog';

            const decorationBar = document.createElement('div');
            decorationBar.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                border-radius: var(--notion-border-radius,20px);
            `;
            dialog.appendChild(decorationBar);

            const title = document.createElement('h3');
            title.textContent = 'âœ¦ å¯¼å…¥/å¯¼å‡ºé…ç½®';
            title.style.cssText = `
                font-size: ${isMobile ? '20px' : '24px'};
                font-weight: 800;
                color: #1f2937;
                text-align: center;
                margin: 0 0 ${isMobile ? '16px' : '20px'} 0;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                letter-spacing: 0.5px;
            `;

            const sitesWrap = document.createElement('div');
            sitesWrap.style.cssText = `
                border: 1px solid #e5e7eb;
                border-radius: ${isMobile ? '12px' : '16px'};
                padding: ${isMobile ? '12px' : '16px'};
                max-height: ${isMobile ? '200px' : '320px'};
                overflow: auto;
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                `;
            const sitesHeader = document.createElement('div');
            sitesHeader.style.cssText = `display:flex; align-items:center; justify-content: space-between; margin-bottom: ${isMobile ? '8px' : '12px'}; ${isMobile ? 'flex-wrap: wrap; gap: 8px;' : ''}`;
            const sitesTitle = document.createElement('div');
            sitesTitle.textContent = 'é€‰æ‹©è¦å¯¼å‡ºçš„åŸŸåï¼ˆè‡ªåŠ¨æ•´åˆå­åŸŸåï¼‰';
            sitesTitle.style.cssText = `font-weight:600; color:#374151; font-size:${isMobile ? '13px' : '14px'}; ${isMobile ? 'width: -webkit-fill-available;' : ''}`;
            const selectAll = document.createElement('button');
            selectAll.textContent = 'å…¨é€‰/å…¨ä¸é€‰';
            selectAll.style.cssText = `padding:${isMobile ? '6px 10px' : '8px 12px'}; border:1px solid #d1d5db; border-radius: 20px; background:#fff; font-size:${isMobile ? '12px' : '13px'}; cursor:pointer; transition: all 0.2s ease; ${isMobile ? 'width: -webkit-fill-available;' : ''}`;
            selectAll.addEventListener('mouseenter', () => {
                selectAll.style.background = 'linear-gradient(135deg, var(--primarycolor-lighter, #fdf2f8), var(--primarycolor-light, #FFE4EA))';
                selectAll.style.borderColor = 'var(--primarycolor, #FF8FAB)';
            });
            selectAll.addEventListener('mouseleave', () => {
                selectAll.style.background = '#fff';
                selectAll.style.borderColor = '#d1d5db';
            });
            sitesHeader.appendChild(sitesTitle);
            sitesHeader.appendChild(selectAll);

            const sitesList = document.createElement('div');
            sitesList.style.cssText = `display:grid; grid-template-columns: ${isMobile ? '1fr' : 'repeat(auto-fill, minmax(210px,1fr))'}; gap:${isMobile ? '6px' : '8px'}; align-items:start;`;

            function getBaseDomain(host) {
                try {
                    const parts = String(host || '').split('.').filter(Boolean);
                    if (parts.length <= 2) return host;
                    const tld = parts[parts.length - 1];
                    const sld = parts[parts.length - 2];
                    const sldList = ['co','com','org','net','gov','edu'];
                    if (tld.length === 2 && sldList.includes(sld)) {
                        return parts.slice(-3).join('.');
                    }
                    return parts.slice(-2).join('.');
                } catch (_) { return host; }
            }

            const allKeys = GM_listValues();
            const hosts = allKeys.filter(k => k.startsWith('site_config_')).map(k => k.replace('site_config_', ''));
            const domainToHosts = {};
            hosts.forEach(h => {
                const hostname = String(h).split('/')[0];
                const d = getBaseDomain(hostname);
                if (!domainToHosts[d]) domainToHosts[d] = [];
                domainToHosts[d].push(h);
            });

            const domainEntries = Object.entries(domainToHosts).sort((a,b)=> a[0].localeCompare(b[0]));
            const domainCheckboxes = [];
            if (domainEntries.length === 0) {
                const empty = document.createElement('div');
                empty.textContent = 'æš‚æ— ç«™ç‚¹é…ç½®';
                empty.style.cssText = 'color:#6b7280; font-size:13px;';
                sitesList.appendChild(empty);
            } else {
                domainEntries.forEach(([domain, hs]) => {
                    const id = 'export-domain-' + domain;
                    const item = createCustomCheckbox(id, true, domain);
                    item.style.margin = '0';
                    item.style.padding = '8px 10px';
                    item.style.border = '1px solid #e5e7eb';
                    item.style.borderRadius = '20px';
                    const input = item.querySelector('input');
                    domainCheckboxes.push({ domain, input, hosts: hs });
                    sitesList.appendChild(item);
                });
            }
            selectAll.onclick = () => {
                const allChecked = domainCheckboxes.every(x => x.input && x.input.checked);
                domainCheckboxes.forEach(x => {
                    if (x.input) {
                        x.input.checked = !allChecked;
                        try { x.input.dispatchEvent(new Event('change')); } catch (_) {}
                    }
                });
            };
            sitesWrap.appendChild(sitesHeader);
            sitesWrap.appendChild(sitesList);

            const modulesWrap = document.createElement('div');
            modulesWrap.style.cssText = `
                border: 1px solid #e5e7eb;
                border-radius: ${isMobile ? '12px' : '16px'};
                padding: ${isMobile ? '12px' : '16px'};
                margin-top: ${isMobile ? '10px' : '12px'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                `;
            const modulesHeader = document.createElement('div');
            modulesHeader.style.cssText = `display:flex; align-items:center; justify-content: space-between; margin-bottom: ${isMobile ? '8px' : '12px'}; ${isMobile ? 'flex-wrap: wrap; gap: 8px;' : ''}`;
            const modulesTitle = document.createElement('div');
            modulesTitle.textContent = 'é€‰æ‹©è¦å¯¼å‡ºçš„æ¨¡å—';
            modulesTitle.style.cssText = `font-weight:600; color:#374151; font-size:${isMobile ? '13px' : '14px'}; ${isMobile ? 'width: -webkit-fill-available;' : ''}`;
            const selectAllModules = document.createElement('button');
            selectAllModules.textContent = 'å…¨é€‰/å…¨ä¸é€‰';
            selectAllModules.style.cssText = `padding:${isMobile ? '6px 10px' : '8px 12px'}; border:1px solid #d1d5db; border-radius: 20px; background:#fff; font-size:${isMobile ? '12px' : '13px'}; cursor:pointer; transition: all 0.2s ease; ${isMobile ? 'width: -webkit-fill-available;' : ''}`;
            selectAllModules.addEventListener('mouseenter', () => {
                selectAllModules.style.background = 'linear-gradient(135deg, var(--primarycolor-lighter, #fdf2f8), var(--primarycolor-light, #FFE4EA))';
                selectAllModules.style.borderColor = 'var(--primarycolor, #FF8FAB)';
            });
            selectAllModules.addEventListener('mouseleave', () => {
                selectAllModules.style.background = '#fff';
                selectAllModules.style.borderColor = '#d1d5db';
            });
            const toggleModulesBtn = document.createElement('button');
            toggleModulesBtn.textContent = 'å±•å¼€æ¨¡å—åˆ—è¡¨';
            toggleModulesBtn.style.cssText = `padding:${isMobile ? '6px 10px' : '8px 12px'}; border:1px solid #d1d5db; border-radius: 20px; background:#fff; font-size:${isMobile ? '12px' : '13px'}; cursor:pointer; transition: all 0.2s ease; ${isMobile ? 'width: -webkit-fill-available;' : ''}`;
            toggleModulesBtn.addEventListener('mouseenter', () => {
                toggleModulesBtn.style.background = 'linear-gradient(135deg, var(--primarycolor-lighter, #fdf2f8), var(--primarycolor-light, #FFE4EA))';
                toggleModulesBtn.style.borderColor = 'var(--primarycolor, #FF8FAB)';
            });
            toggleModulesBtn.addEventListener('mouseleave', () => {
                toggleModulesBtn.style.background = '#fff';
                toggleModulesBtn.style.borderColor = '#d1d5db';
            });
            const headerActions = document.createElement('div');
            headerActions.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; ${isMobile ? 'width: -webkit-fill-available;' : ''}; ${isMobile ? 'justify-content: space-between;' : ''}`;
            headerActions.appendChild(toggleModulesBtn);
            headerActions.appendChild(selectAllModules);
            modulesHeader.appendChild(modulesTitle);
            modulesHeader.appendChild(headerActions);
            const modulesList = document.createElement('div');
            modulesList.style.cssText = `display:grid; grid-template-columns: ${isMobile ? '1fr' : 'repeat(auto-fill, minmax(210px,1fr))'}; gap:${isMobile ? '6px' : '8px'}; align-items:start; max-height:${isMobile ? '280px' : '360px'}; overflow:auto;`;
            const moduleDefs = [
                ['notion','Notion é…ç½®'],['github','GitHub é…ç½®'],['domainGithub','åŸŸåå›¾åºŠ'],['coverBed','å°é¢å›¾åºŠ'],
                ['rating','è¯„åˆ†è®¾ç½®'],['autoUpdate','è‡ªåŠ¨æ›´æ–°'],['customStyle','è‡ªå®šä¹‰æ ·å¼'],['smartExtraction','æ™ºèƒ½æå–'],
                ['expandIntervalMs','å±•å¼€é—´éš”'],['stepConfig','é€æ­¥é…ç½®'],['visibleSelectors','å­—æ®µå¯è§æ€§'],['websiteGithub','ç½‘ç«™GitHubé…ç½®'],
                ['customConfigs','ç«™ç‚¹é€‰æ‹©å™¨'],['enabledPatterns','å¯ç”¨è·¯å¾„æ¨¡å¼'],['typeMappings','ç±»å‹æ˜ å°„'],['showAppendButton','æ˜¾ç¤ºè¿½åŠ æŒ‰é’®'],
                ['customTags','è‡ªå®šä¹‰æ ‡ç­¾'],['customTagGroups','æ ‡ç­¾åˆ†ç»„'],['customMainGroups','ä¸»åˆ†ç»„'],['autoTagRoutingRules','è‡ªåŠ¨åˆ†æµè§„åˆ™'],
                ['notionDatabaseCustomMap','æ•°æ®åº“æ˜ å°„'],['clipTypesWithColors','ç±»å‹é¢œè‰²'],['clipTypes','ç±»å‹åˆ—è¡¨'],
                ['markdownTransformEnabled','Markdownå¯ç”¨'],['markdownTransformRules','Markdownè§„åˆ™'],['markdownTransformUseDomain','MarkdownæŒ‰åŸŸå'],
                ['markdownTransformDomainConfigs','MarkdownåŸŸåè§„åˆ™'],['tagDotTitle','å°åœ†ç‚¹æ ‡é¢˜'],['tagDotTags','å°åœ†ç‚¹æ ‡ç­¾'],
                ['tagDotPropertyName','å°åœ†ç‚¹å±æ€§å'],['tagDotTagText','å°åœ†ç‚¹æ–‡æœ¬'],['tagPropertyName','æ ‡ç­¾å±æ€§å'],['tagContent','æ ‡ç­¾å†…å®¹'],
                ['currentMainGroupNovel','å½“å‰ä¸»åˆ†ç»„(å°è¯´)'],['currentMainGroupComic','å½“å‰ä¸»åˆ†ç»„(æ¼«ç”»)'],['currentMainGroupClip','å½“å‰ä¸»åˆ†ç»„(å‰ªè—)'],
                ['tagUsageStatsNovel','æ ‡ç­¾ç»Ÿè®¡(å°è¯´)'],['tagUsageStatsComic','æ ‡ç­¾ç»Ÿè®¡(æ¼«ç”»)'],['tagUsageStatsClip','æ ‡ç­¾ç»Ÿè®¡(å‰ªè—)'],
                ['githubFolderMode','GitHubæ–‡ä»¶å¤¹æ¨¡å¼'],['githubFolderIncludeCover','GitHubåŒ…å«å°é¢'],
                ['globalShowButtons','å…¨å±€æ˜¾ç¤ºæŒ‰é’®'],['globalRemarkOnAdd','æ·»åŠ æ—¶å¤‡æ³¨'],['selectorMergeSeparator','é€‰æ‹©å™¨åˆå¹¶åˆ†éš”ç¬¦'],
                ['buttonStyle','æŒ‰é’®æ ·å¼'],['configUiToggles','é…ç½®ç•Œé¢å¼€å…³'],['request','ç½‘ç»œè¯·æ±‚è®¾ç½®'],
                ['notionVerifyDatabaseId','NotionéªŒè¯æ•°æ®åº“ID'],['titleClean','æ ‡é¢˜æ¸…ç†åå¥½'],
                ['githubDomainConfig','åŸŸåCDNé…ç½®'],['enhancedAutoUpdateEnabled','å¢å¼ºè‡ªåŠ¨æ›´æ–°å¼€å…³'],
                ['siteConfigs','ç½‘ç«™é…ç½®']
            ];
            const moduleCheckboxes = [];
            moduleDefs.forEach(([id,label]) => {
                const item = createCustomCheckbox('export-module-' + id, false, label);
                item.style.margin = '0';
                item.style.padding = '8px 10px';
                item.style.border = '1px solid #e5e7eb';
                item.style.borderRadius = '20px';
                const input = item.querySelector('input');
                moduleCheckboxes.push({ id, input });
                modulesList.appendChild(item);
            });
            let modulesExpanded = false;
            modulesList.style.display = 'none';
            toggleModulesBtn.onclick = () => {
                modulesExpanded = !modulesExpanded;
                if (modulesExpanded) {
                    modulesList.style.display = 'grid';
                    toggleModulesBtn.textContent = 'æ”¶èµ·æ¨¡å—åˆ—è¡¨';
                } else {
                    modulesList.style.display = 'none';
                    toggleModulesBtn.textContent = 'å±•å¼€æ¨¡å—åˆ—è¡¨';
                }
            };
            selectAllModules.onclick = () => {
                const allChecked = moduleCheckboxes.every(x => x.input && x.input.checked);
                moduleCheckboxes.forEach(x => {
                    if (x.input) {
                        x.input.checked = !allChecked;
                        try { x.input.dispatchEvent(new Event('change')); } catch (_) {}
                    }
                });
            };
            const excludeSensitiveContainer = createCustomCheckbox('export-exclude-sensitive', true, 'ç§»é™¤æ•æ„Ÿå­—æ®µ');
            excludeSensitiveContainer.style.cssText = `margin-top:${isMobile ? '8px' : '10px'};`;
            modulesWrap.appendChild(modulesHeader);
            modulesWrap.appendChild(modulesList);
            modulesWrap.appendChild(excludeSensitiveContainer);

            const copyAllBtn = document.createElement('button');
            copyAllBtn.textContent = 'ğŸ“‹ å¤åˆ¶å…¨éƒ¨é…ç½®';
            copyAllBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 6px 14px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;

            const exportBtn = document.createElement('button');
            exportBtn.textContent = 'ğŸ“¤ å¯¼å‡ºå…¨éƒ¨é…ç½®';
            exportBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 6px 14px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;

            const exportSelectedBtn = document.createElement('button');
            exportSelectedBtn.textContent = 'ğŸŒ å¯¼å‡ºæ‰€é€‰ç«™ç‚¹';
            exportSelectedBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 6px 14px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;

            const copySelectedSitesBtn = document.createElement('button');
            copySelectedSitesBtn.textContent = 'ğŸ“‹ å¤åˆ¶é€‰å®šç«™ç‚¹';
            copySelectedSitesBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 6px 14px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;

            const importAllBtn = document.createElement('button');
            importAllBtn.textContent = 'ğŸ“¥ å¯¼å…¥å…¨éƒ¨é…ç½®';
            importAllBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 6px 14px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;

            const importAppendBtn = document.createElement('button');
            importAppendBtn.textContent = 'ğŸ“¥ è¿½åŠ å¯¼å…¥é…ç½®';
            importAppendBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: 2px solid var(--primarycolor, #FF8FAB);
                border-radius: 20px;
                background: white;
                color: var(--primarycolor-dark, #FF6B9D);
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 4px 8px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;

            const pasteFullConfigBtn = document.createElement('button');
            pasteFullConfigBtn.textContent = 'ğŸ“ ç²˜è´´å…¨éƒ¨é…ç½®';
            pasteFullConfigBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: 1px dashed var(--primarycolor, #FF8FAB);
                border-radius: 20px;
                background: rgba(255,255,255,0.9);
                color: var(--primarycolor-dark, #FF6B9D);
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 2px 6px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;

            const pasteAppendConfigBtn = document.createElement('button');
            pasteAppendConfigBtn.textContent = 'ğŸ“ ç²˜è´´è¿½åŠ é…ç½®';
            pasteAppendConfigBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: 1px dashed var(--primarycolor, #FF8FAB);
                border-radius: 20px;
                background: rgba(255,255,255,0.9);
                color: var(--primarycolor-dark, #FF6B9D);
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 2px 6px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: 1px solid var(--input-border, #d1d5db);
                border-radius: 20px;
                background: white;
                color: var(--text-muted, #6b7280);
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                transition: all 0.2s ease;
                box-shadow: 0 2px 4px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;

            const addHoverEffect = (btn, isPrimary = true) => {
                if (isPrimary) {
                    btn.addEventListener('mouseenter', () => {
                        btn.style.background = 'linear-gradient(135deg, var(--primarycolor-dark, #FF6B9D), var(--primarycolor, #FF5184))';
                        btn.style.transform = 'translateY(-2px)';
                        btn.style.boxShadow = '0 8px 20px var(--primarycolor-lighter)';
                    });
                    btn.addEventListener('mouseleave', () => {
                        btn.style.background = 'linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D))';
                        btn.style.transform = 'translateY(0)';
                        btn.style.boxShadow = '0 6px 14px var(--primarycolor-lighter)';
                    });
                } else {
                    btn.addEventListener('mouseenter', () => {
                        btn.style.background = 'linear-gradient(135deg, var(--primarycolor, #FF9BB3), var(--primarycolor-dark, #FF8FA3))';
                        btn.style.transform = 'translateY(-2px)';
                        btn.style.boxShadow = '0 8px 20px var(--primarycolor-lighter)';
                    });
                    btn.addEventListener('mouseleave', () => {
                        btn.style.background = 'linear-gradient(135deg, var(--primarycolor-light, #FFB6C1), var(--primarycolor, #FFA0B4))';
                        btn.style.transform = 'translateY(0)';
                        btn.style.boxShadow = '0 6px 14px var(--primarycolor-lighter)';
                    });
                }
            };

            addHoverEffect(exportBtn, true);
            addHoverEffect(copyAllBtn, false);
            addHoverEffect(exportSelectedBtn, false);
            addHoverEffect(copySelectedSitesBtn, false);
            addHoverEffect(importAllBtn, true);
            addHoverEffect(pasteFullConfigBtn, false);
            addHoverEffect(pasteAppendConfigBtn, false);

            const exportModulesBtn = document.createElement('button');
            exportModulesBtn.textContent = 'ğŸ“¤ å¯¼å‡ºé€‰å®šæ¨¡å—';
            exportModulesBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 6px 14px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;
            const copySelectedModulesBtn = document.createElement('button');
            copySelectedModulesBtn.textContent = 'ğŸ“‹ å¤åˆ¶é€‰å®šæ¨¡å—';
            copySelectedModulesBtn.style.cssText = `
                padding: ${isMobile ? '10px 16px' : '12px 20px'};
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: ${isMobile ? '13px' : '14px'};
                font-weight: 500;
                transition: all 0.2s ease;
                box-shadow: 0 6px 14px var(--primarycolor-lighter);
                ${isMobile ? 'width: -webkit-fill-available;' : ''}
            `;
            addHoverEffect(exportModulesBtn, true);
            addHoverEffect(copySelectedModulesBtn, false);

            importAppendBtn.addEventListener('mouseenter', () => {
                importAppendBtn.style.background = 'var(--primarycolor-lighter, #fdf2f8)';
                importAppendBtn.style.transform = 'translateY(-2px)';
                importAppendBtn.style.boxShadow = '0 6px 12px var(--primarycolor-lighter)';
            });
            importAppendBtn.addEventListener('mouseleave', () => {
                importAppendBtn.style.background = 'white';
                importAppendBtn.style.transform = 'translateY(0)';
                importAppendBtn.style.boxShadow = '0 4px 8px var(--primarycolor-lighter)';
            });

            pasteFullConfigBtn.addEventListener('mouseenter', () => {
                pasteFullConfigBtn.style.background = 'var(--primarycolor-lighter, #fdf2f8)';
                pasteFullConfigBtn.style.transform = 'translateY(-2px)';
            });
            pasteFullConfigBtn.addEventListener('mouseleave', () => {
                pasteFullConfigBtn.style.background = 'rgba(255,255,255,0.9)';
                pasteFullConfigBtn.style.transform = 'translateY(0)';
            });

            pasteAppendConfigBtn.addEventListener('mouseenter', () => {
                pasteAppendConfigBtn.style.background = 'var(--primarycolor-lighter, #fdf2f8)';
                pasteAppendConfigBtn.style.transform = 'translateY(-2px)';
            });
            pasteAppendConfigBtn.addEventListener('mouseleave', () => {
                pasteAppendConfigBtn.style.background = 'rgba(255,255,255,0.9)';
                pasteAppendConfigBtn.style.transform = 'translateY(0)';
            });

            cancelBtn.addEventListener('mouseenter', () => {
                cancelBtn.style.background = '#f9fafb';
                cancelBtn.style.borderColor = '#9ca3af';
                cancelBtn.style.transform = 'translateY(-1px)';
            });
            cancelBtn.addEventListener('mouseleave', () => {
                cancelBtn.style.background = 'white';
                cancelBtn.style.borderColor = '#d1d5db';
                cancelBtn.style.transform = 'translateY(0)';
            });

            const handleConfigImportFromString = (configJson) => {
                const content = (configJson || '').trim();
                if (!content) {
                    showNotification('é…ç½®å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¯¼å…¥', 'warning');
                    return false;
                }
                try {
                    const parsed = JSON.parse(content);
                    if (parsed && parsed.siteDomains && typeof parsed.siteDomains === 'object') {
                        let count = 0;
                        Object.values(parsed.siteDomains).forEach(group => {
                            const hostsObj = (group && group.hosts) || {};
                            Object.entries(hostsObj).forEach(([host, cfg]) => {
                                GM_setValue('site_config_' + host, cfg);
                                count++;
                            });
                        });
                        showNotification(`å·²å¯¼å…¥ ${count} ä¸ªç«™ç‚¹é…ç½®ï¼ˆåŒåŸŸå/åŒhostå·²è¦†ç›–ï¼‰`, 'success');
                        return true;
                    }
                    if (parsed && parsed.siteConfigs && typeof parsed.siteConfigs === 'object') {
                        const entries = Object.entries(parsed.siteConfigs);
                        entries.forEach(([host, cfg]) => {
                            GM_setValue('site_config_' + host, cfg);
                        });
                        showNotification(`å·²å¯¼å…¥ ${entries.length} ä¸ªç«™ç‚¹é…ç½®ï¼ˆåŒåŸŸåå·²è¦†ç›–ï¼‰`, 'success');
                        return true;
                    }
                    importGlobalConfig(content);
                    showNotification('é…ç½®å·²å¯¼å…¥', 'success');
                    return true;
                } catch (_) {
                    try {
                        importGlobalConfig(content);
                        showNotification('é…ç½®å·²å¯¼å…¥', 'success');
                        return true;
                    } catch (error) {
                        console.error('å¯¼å…¥é…ç½®å¤±è´¥:', error);
                        showNotification('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
                        return false;
                    }
                }
            };

            copyAllBtn.addEventListener('click', () => {
                try {
                    const allKeys = GM_listValues();
                    const configsToExport = {};
                    const blacklist = ['notion_databases_cache', 'last_auto_update_check', 'last_version'];
                    allKeys.forEach(key => {
                        if (!blacklist.includes(key)) {
                            try {
                                const value = GM_getValue(key);
                                if (value !== undefined) {
                                    configsToExport[key] = value;
                                }
                            } catch (e) {
                                console.warn(`è·³è¿‡æ— æ³•è¯»å–çš„é…ç½®é¡¹: ${key}`, e);
                            }
                        }
                    });
                    const exportData = {
                        meta: {
                            version: '5.0',
                            exportDate: new Date().toISOString(),
                            description: 'Notion Clipper å…¨é‡é…ç½®å¤‡ä»½ï¼ˆåŒ…å«æ‰€æœ‰ç”¨æˆ·è®¾ç½®ï¼‰',
                            configCount: Object.keys(configsToExport).length
                        },
                        configs: configsToExport
                    };
                    const configJson = JSON.stringify(exportData, null, 2);
                    GM_setClipboard(configJson);
                    showNotification(`å·²å¤åˆ¶å…¨éƒ¨é…ç½®åˆ°å‰ªè´´æ¿ï¼ˆå…± ${exportData.meta.configCount} é¡¹ï¼‰`, 'success');
                    document.body.removeChild(overlay);
                    resolve(true);
                } catch (error) {
                    console.error('å¤åˆ¶é…ç½®å¤±è´¥:', error);
                    showNotification('å¤åˆ¶é…ç½®å¤±è´¥: ' + error.message, 'error');
                }
            });

            exportBtn.addEventListener('click', () => {
                exportGlobalConfig();
                document.body.removeChild(overlay);
                resolve(true);
            });

            exportSelectedBtn.addEventListener('click', () => {
                const selectedDomains = domainCheckboxes.filter(x => x.input && x.input.checked);
                try {
                    const siteDomains = {};
                    selectedDomains.forEach(({ domain, hosts }) => {
                        const hostMap = {};
                        hosts.forEach(h => {
                            const v = GM_getValue('site_config_' + h);
                            if (v) hostMap[h] = v;
                        });
                        if (Object.keys(hostMap).length > 0) siteDomains[domain] = { hosts: hostMap };
                    });
                    const exportJson = JSON.stringify({ version: 'sites-domains-1.0', siteDomains }, null, 2);
                    const blob = new Blob([exportJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `notion-clipper-sites-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showNotification('å·²æŒ‰åŸŸåå¯¼å‡ºæ‰€é€‰é…ç½®', 'success');
                    document.body.removeChild(overlay);
                    resolve(true);
                } catch (e) {
                    console.error('å¯¼å‡ºæ‰€é€‰ç«™ç‚¹å¤±è´¥:', e);
                    showNotification('å¯¼å‡ºå¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            });

            copySelectedSitesBtn.addEventListener('click', () => {
                const selectedDomains = domainCheckboxes.filter(x => x.input && x.input.checked);
                try {
                    const siteDomains = {};
                    selectedDomains.forEach(({ domain, hosts }) => {
                        const hostMap = {};
                        hosts.forEach(h => {
                            const v = GM_getValue('site_config_' + h);
                            if (v) hostMap[h] = v;
                        });
                        if (Object.keys(hostMap).length > 0) siteDomains[domain] = { hosts: hostMap };
                    });
                    const exportJson = JSON.stringify({ version: 'sites-domains-1.0', siteDomains }, null, 2);
                    GM_setClipboard(exportJson);
                    showNotification('å·²å¤åˆ¶æ‰€é€‰ç«™ç‚¹é…ç½®åˆ°å‰ªè´´æ¿', 'success');
                    document.body.removeChild(overlay);
                    resolve(true);
                } catch (e) {
                    console.error('å¤åˆ¶æ‰€é€‰ç«™ç‚¹å¤±è´¥:', e);
                    showNotification('å¤åˆ¶å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            });

            exportModulesBtn.addEventListener('click', () => {
                const selected = moduleCheckboxes.filter(x => x.input && x.input.checked).map(x => x.id);
                if (!selected.length) {
                    showNotification('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„æ¨¡å—', 'warning');
                    return;
                }
                try {
                    const excludeSensitive = document.getElementById('export-exclude-sensitive')?.checked;
                    const exportObj = buildPartialExportConfig(selected, !!excludeSensitive);
                    const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `notion-clipper-config-selected-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showNotification('å·²å¯¼å‡ºé€‰å®šæ¨¡å—', 'success');
                    document.body.removeChild(overlay);
                    resolve(true);
                } catch (e) {
                    showNotification('å¯¼å‡ºå¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            });

            copySelectedModulesBtn.addEventListener('click', () => {
                const selected = moduleCheckboxes.filter(x => x.input && x.input.checked).map(x => x.id);
                if (!selected.length) {
                    showNotification('è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„æ¨¡å—', 'warning');
                    return;
                }
                try {
                    const excludeSensitive = document.getElementById('export-exclude-sensitive')?.checked;
                    const exportObj = buildPartialExportConfig(selected, !!excludeSensitive);
                    GM_setClipboard(JSON.stringify(exportObj, null, 2));
                    showNotification('é€‰å®šæ¨¡å—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    document.body.removeChild(overlay);
                    resolve(true);
                } catch (e) {
                    showNotification('å¤åˆ¶å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            });

            importAllBtn.addEventListener('click', () => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';

                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const configJson = e.target.result;
                                importGlobalConfig(configJson);
                            } catch (error) {
                                showNotification('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message, 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                };

                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
                document.body.removeChild(overlay);
                resolve(true);
            });

            importAppendBtn.addEventListener('click', () => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';
                fileInput.style.display = 'none';

                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const configJson = e.target.result;
                                const success = handleConfigImportFromString(configJson);
                                if (success) {
                                    document.body.removeChild(overlay);
                                    resolve(true);
                                }
                            } catch (error) {
                                showNotification('æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message, 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                };

                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            });

            let pasteMode = 'append';

            const pastePanel = document.createElement('div');
            pastePanel.style.cssText = `
                display:none;
                flex-direction:column;
                gap:10px;
                margin-top:12px;
                padding:12px;
                border:1px solid var(--input-border);
                border-radius: 20px;
                background:rgba(255,255,255,0.95);
                `;

            const pastePanelTitle = document.createElement('div');
            pastePanelTitle.textContent = 'ç²˜è´´é…ç½®å†…å®¹';
            pastePanelTitle.style.fontSize = '14px';
            pastePanelTitle.style.fontWeight = '600';

            const pasteTextarea = document.createElement('textarea');
            pasteTextarea.style.cssText = `
                width:100%;
                min-height:140px;
                border:1px solid var(--input-border);
                border-radius: 20px;
                padding:10px;
                font-size:13px;
                resize:vertical;
                `;
            pasteTextarea.placeholder = 'å°†å¤åˆ¶çš„é…ç½®JSONç²˜è´´åˆ°æ­¤å¤„â€¦';

            const pasteActionRow = document.createElement('div');
            pasteActionRow.style.cssText = 'display:flex; justify-content:flex-end; gap:8px;';

            const pasteCancelInner = document.createElement('button');
            pasteCancelInner.textContent = 'å–æ¶ˆ';
            pasteCancelInner.className = 'selector-test-btn';
            pasteCancelInner.addEventListener('click', (e) => {
                e.preventDefault();
                pasteTextarea.value = '';
                pastePanel.style.display = 'none';
            });

            const pasteConfirmInner = document.createElement('button');
            pasteConfirmInner.textContent = 'å¯¼å…¥';
            pasteConfirmInner.className = 'selector-picker-btn';
            pasteConfirmInner.addEventListener('click', (e) => {
                e.preventDefault();
                let success;
                if (pasteMode === 'full') {
                    importGlobalConfig(pasteTextarea.value);
                    success = true;
                } else {
                    success = handleConfigImportFromString(pasteTextarea.value);
                }
                if (success) {
                    document.body.removeChild(overlay);
                    resolve(true);
                }
            });

            pasteActionRow.appendChild(pasteCancelInner);
            pasteActionRow.appendChild(pasteConfirmInner);

            pastePanel.appendChild(pastePanelTitle);
            pastePanel.appendChild(pasteTextarea);
            pastePanel.appendChild(pasteActionRow);

            pasteFullConfigBtn.addEventListener('click', (e) => {
                e.preventDefault();
                pasteMode = 'full';
                pastePanelTitle.textContent = 'ç²˜è´´å…¨éƒ¨é…ç½®å†…å®¹';
                pastePanel.style.display = 'flex';
                pasteTextarea.focus();
            });

            pasteAppendConfigBtn.addEventListener('click', (e) => {
                e.preventDefault();
                pasteMode = 'append';
                pastePanelTitle.textContent = 'ç²˜è´´è¿½åŠ é…ç½®å†…å®¹';
                pastePanel.style.display = 'flex';
                pasteTextarea.focus();
            });

            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                resolve(false);
            });

            dialog.appendChild(title);
            dialog.appendChild(sitesWrap);
            dialog.appendChild(modulesWrap);
            dialog.appendChild(pastePanel);

            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `display:grid; grid-template-columns: 1fr; gap:${isMobile ? '10px' : '12px'}; margin-top:${isMobile ? '16px' : '20px'};`;

            if (isMobile) {
                buttonContainer.appendChild(copyAllBtn);
                buttonContainer.appendChild(exportBtn);
                buttonContainer.appendChild(exportModulesBtn);
                buttonContainer.appendChild(copySelectedModulesBtn);
                buttonContainer.appendChild(exportSelectedBtn);
                buttonContainer.appendChild(copySelectedSitesBtn);
                buttonContainer.appendChild(importAllBtn);
                buttonContainer.appendChild(importAppendBtn);
                buttonContainer.appendChild(pasteFullConfigBtn);
                buttonContainer.appendChild(pasteAppendConfigBtn);
            } else {
                const row1 = document.createElement('div');
                row1.style.cssText = 'display:grid; grid-template-columns: 1fr 1fr; gap:10px;';
                row1.appendChild(copyAllBtn);
                row1.appendChild(exportBtn);

                const row2 = document.createElement('div');
                row2.style.cssText = 'display:grid; grid-template-columns: 1fr 1fr; gap:10px;';
                row2.appendChild(exportModulesBtn);
                row2.appendChild(copySelectedModulesBtn);

                const row3 = document.createElement('div');
                row3.style.cssText = 'display:grid; grid-template-columns: 1fr 1fr; gap:10px;';
                row3.appendChild(exportSelectedBtn);
                row3.appendChild(copySelectedSitesBtn);

                const row4 = document.createElement('div');
                row4.style.cssText = 'display:grid; grid-template-columns: 1fr 1fr; gap:10px;';
                row4.appendChild(importAllBtn);
                row4.appendChild(importAppendBtn);

                const row5 = document.createElement('div');
                row5.style.cssText = 'display:grid; grid-template-columns: 1fr 1fr; gap:10px;';
                row5.appendChild(pasteFullConfigBtn);
                row5.appendChild(pasteAppendConfigBtn);

                buttonContainer.appendChild(row1);
                buttonContainer.appendChild(row2);
                buttonContainer.appendChild(row3);
                buttonContainer.appendChild(row4);
                buttonContainer.appendChild(row5);
            }

            const rowCancel = document.createElement('div');
            rowCancel.style.cssText = `display:flex; justify-content:center; margin-top:${isMobile ? '12px' : '16px'};`;
            rowCancel.appendChild(cancelBtn);

            dialog.appendChild(buttonContainer);
            dialog.appendChild(rowCancel);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    resolve(false);
                }
            });
        });
    }

    // éªŒè¯GitHubé…ç½®
    function validateGitHubConfig(config = GITHUB_CONFIG) {
        return !!config.token && !!config.username && !!config.repo;
    }

    // åˆå§‹åŒ–Notioné…ç½®ï¼ˆå¦‚æœä¸ºç©ºï¼‰
    if (!NOTION_CONFIG.apiKey) {
        NOTION_CONFIG.apiKey = "";
    }

    if (!NOTION_CONFIG.databaseIds.comic) {
        NOTION_CONFIG.databaseIds.comic = "";
    }

    if (!NOTION_CONFIG.databaseIds.novel) {
        NOTION_CONFIG.databaseIds.novel = "";
    }

    if (!NOTION_CONFIG.databaseIds.clip) {
        NOTION_CONFIG.databaseIds.clip = "";
    }

    // é»˜è®¤ç«™ç‚¹é…ç½®
    const DEFAULT_SITE_CONFIGS = {
        'manwa.me': {
            selectors: {
                ç®€ä»‹: "p.detail-desc",
                ä¹¦å: "h1.detail-main-info-title",
                ä½œè€…: ".detail-main-info-value a",
                æœ€æ–°ç« èŠ‚: "p:nth-of-type(4) span.detail-main-info-value",
                æ›´æ–°çŠ¶æ€: "p:nth-of-type(3) span.detail-main-info-value",
                å°é¢: ".detail-main-cover .lazy",
                è¿½æ›´: "a.chapteritem.active",
                åˆ«å: "p:nth-of-type(1) span.detail-main-info-value",
                åœ°åŒº: "p:nth-of-type(6) span.detail-main-info-value",
                ç±»å‹: "p:nth-of-type(7) span.detail-main-info-value"
            },
            selectorIndices: {
                ç®€ä»‹: 0,
                ä¹¦å: 0,
                ä½œè€…: "all",
                æœ€æ–°ç« èŠ‚: 0,
                æ›´æ–°çŠ¶æ€: 0,
                å°é¢: 0,
                è¿½æ›´: 0,
                åˆ«å: 0,
                åœ°åŒº: 0,
                ç±»å‹: 0
            },
            adjustSelectors: function() {
                const aliasLabel = document.querySelector('p:nth-of-type(1) span.detail-main-info-author-field');
                return !aliasLabel?.textContent?.includes('åˆ«åï¼š');
            },
            contentType: "comic"
        }
    };

    const DEFAULT_SELECTOR_SEPARATOR = 'ï¼Œ';

    function normalizeIndexValue(value, fallback = '0') {
        if (value === null || value === undefined) return fallback;
        const str = String(value).trim();
        return str === '' ? fallback : str;
    }

    function normalizeIndexExpressionForStorage(value) {
        const normalized = normalizeIndexValue(value, '0');
        if (normalized.toLowerCase() === 'all') return 'all';
        return normalized.replace(/ï¼Œ/g, ',').replace(/\s+/g, '');
    }

    function convertIndexAlias(token) {
        let trimmed = token.trim();
        trimmed = trimmed.replace(/last(?=\s*-|$)/gi, '0');
        trimmed = trimmed.replace(/first(?=\s*-|$)/gi, '1');
        return trimmed;
    }

    function tokenToIndex(token, length) {
        if (!length || length <= 0) return null;
        const num = parseInt(token, 10);
        if (isNaN(num)) return null;
        if (num === 0) return Math.max(length - 1, 0);
        if (num > 0) return Math.min(num - 1, length - 1);
        const fromEnd = Math.abs(num);
        return Math.max(length - fromEnd, 0);
    }

    function parseIndexTokens(value, length) {
        const indices = [];
        const seen = new Set();
        const parts = value.split(',').map(part => part.trim()).filter(Boolean);
        const addIndex = (idx) => {
            if (idx === null || idx === undefined || isNaN(idx)) return;
            const bounded = Math.min(Math.max(idx, 0), Math.max(length - 1, 0));
            if (!seen.has(bounded) && length > 0) {
                seen.add(bounded);
                indices.push(bounded);
            }
        };

        const targets = parts.length ? parts : [value];
        for (const part of targets) {
            const aliasPart = convertIndexAlias(part);
            const rangeMatch = aliasPart.match(/^(-?\d+)\s*-\s*(-?\d+)$/);
            if (rangeMatch) {
                const start = tokenToIndex(rangeMatch[1], length);
                const end = tokenToIndex(rangeMatch[2], length);
                if (start === null || end === null) continue;
                const step = start <= end ? 1 : -1;
                for (let i = start; step === 1 ? i <= end : i >= end; i += step) {
                    addIndex(i);
                }
            } else {
                const idx = tokenToIndex(aliasPart, length);
                if (idx !== null) addIndex(idx);
            }
        }

        if (indices.length === 0 && length > 0) {
            const fallbackIndex = tokenToIndex('1', length);
            if (fallbackIndex !== null) addIndex(fallbackIndex);
        }

        return indices;
    }

    function calculateIndexSelection(length, rawValue) {
        if (!length || length <= 0) {
            return { mode: 'none', indices: [] };
        }
        const normalized = normalizeIndexValue(rawValue, '0');
        if (normalized.toLowerCase() === 'all') {
            const allIndices = Array.from({ length }, (_, idx) => idx);
            return { mode: 'all', indices: allIndices };
        }

        const indices = parseIndexTokens(normalized, length);
        if (!indices.length) {
            return { mode: 'single', indices: [0] };
        }

        return {
            mode: indices.length > 1 ? 'multiple' : 'single',
            indices
        };
    }

    function resolveElementSelection(elementsInput, rawValue) {
        const elements = Array.from(elementsInput || []);
        const selection = calculateIndexSelection(elements.length, rawValue);
        if (selection.mode === 'none') {
            return { ...selection, elements: [] };
        }
        const selectedElements = selection.mode === 'all'
        ? elements
        : selection.indices.map(idx => elements[idx]).filter(Boolean);
        return { ...selection, elements: selectedElements };
    }

    function interpretSeparatorValue(value) {
        if (typeof value !== 'string') return value;
        if (!value.trim()) return '';
        return value
            .replace(/\\n/g, '\n')
            .replace(/\\r/g, '\r')
            .replace(/\\t/g, '\t')
            .replace(/\\s/g, ' ')
            .replace(/\\u([0-9a-fA-F]{4})/g, (_, hex) => {
            try {
                return String.fromCharCode(parseInt(hex, 16));
            } catch (_) {
                return '';
            }
        });
    }

    function getSelectorMergeSeparator(fieldName) {
        const fallback = fieldName === 'ç®€ä»‹' ? '\n' : DEFAULT_SELECTOR_SEPARATOR;
        try {
            const stored = GM_getValue('selector_merge_separator');
            if (typeof stored === 'string' && stored.trim()) {
                const interpreted = interpretSeparatorValue(stored);
                return interpreted || fallback;
            }
        } catch (_) {}
        return fallback;
    }

    function joinTextsWithSeparator(fieldName, texts) {
        if (!Array.isArray(texts) || !texts.length) return '';
        const separator = getSelectorMergeSeparator(fieldName);
        return texts.join(separator);
    }

    // è·å–å½“å‰ç½‘ç«™çš„é…ç½®
    function getSiteConfig() {
        const hostname = window.location.hostname;
        const customConfigs = loadCustomConfigs();
        const scopeKey = (typeof getConfigScopeKey === 'function') ? getConfigScopeKey() : `${hostname}/`;

        // ä¼˜å…ˆä½¿ç”¨åŒåŸŸçš„ä¸»æœºçº§é…ç½®ï¼Œå…¶æ¬¡æ‰æ˜¯å­è·¯å¾„çº§é…ç½®
        if (customConfigs[hostname]) {
            const config = customConfigs[hostname];
            try { console.log('[Config] ä½¿ç”¨ç«™ç‚¹çº§é…ç½®:', hostname, config); } catch (_) {}
            if (hostname.includes('manwa.me')) adjustManwaSelectors(config);
            return config;
        }
        if (customConfigs[scopeKey]) {
            const config = customConfigs[scopeKey];
            try { console.log('[Config] ä½¿ç”¨å­è·¯å¾„çº§é…ç½®:', scopeKey, config); } catch (_) {}
            if (hostname.includes('manwa.me')) adjustManwaSelectors(config);
            return config;
        }

        // boylove.ccç‰¹æ®Šå¤„ç†
        if (hostname.includes('boylove.cc')) {
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                // ç§»åŠ¨ç«¯ä½¿ç”¨ä¼˜åŒ–åçš„é»˜è®¤é…ç½®
                return {
                    selectors: {
                        ç®€ä»‹: "p.book-desc",
                        ä¹¦å: "p.book-title",
                        ä½œè€…: ".info a",
                        æœ€æ–°ç« èŠ‚: "li:nth-of-type(6) span",
                        æ›´æ–°çŠ¶æ€: ".pl-0 li:nth-of-type(2)",
                        å°é¢: "div.cover img",
                        è¿½æ›´: ".seen",
                        ç±»å‹: "BL", // å›ºå®šä¸ºBL
                        åœ°åŒº: ".tag span", // éœ€è¦ç‰¹æ®Šå¤„ç†
                        åˆ«å: "" // boylove.ccæ²¡æœ‰åˆ«åå­—æ®µ
                    },
                    mergeKeys: ["ä½œè€…"],
                    firstMatchKeys: [],
                    lastMatchKeys: ["è¿½æ›´"],
                    adjustSelectors: function() { return false; },
                    contentType: "comic",
                    // æ ‡è®°ä¸ºé»˜è®¤é…ç½®
                    isDefaultConfig: true
                };
            } else {
                // PCç«¯è¿”å›ç©ºé…ç½®ï¼Œå¼ºåˆ¶ç”¨æˆ·æ‰‹åŠ¨é…ç½®
                return {
                    selectors: {
                        ç®€ä»‹: "", ä¹¦å: "", ä½œè€…: "", æœ€æ–°ç« èŠ‚: "", æ›´æ–°çŠ¶æ€: "",
                        å°é¢: "", è¿½æ›´: "", åˆ«å: "", åœ°åŒº: "", ç±»å‹: ""
                    },
                    mergeKeys: [],
                    firstMatchKeys: [],
                    lastMatchKeys: [],
                    adjustSelectors: function() { return false; },
                    contentType: "comic",
                    // æ ‡è®°ä¸ºéœ€è¦é…ç½®
                    requireConfiguration: true
                };
            }
        }
        if (hostname.includes('manwa.me')) {
            const config = JSON.parse(JSON.stringify(DEFAULT_SITE_CONFIGS['manwa.me'])); // æ·±æ‹·è´
            adjustManwaSelectors(config);
            return config;
        }

        return {
            selectors: {},
            mergeKeys: [],
            firstMatchKeys: [],
            lastMatchKeys: [],
            adjustSelectors: function() { return false; },
            contentType: 'comic',
            requireConfiguration: true
        };
    }

    // è¾…åŠ©å‡½æ•°ï¼šè°ƒæ•´manwa.meçš„é€‰æ‹©å™¨
    function adjustManwaSelectors(config) {
        if (!config) return config;

        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨åˆ«åå­—æ®µ
        const aliasCheck = document.querySelector('p:nth-of-type(1) span.detail-main-info-author-field');
        const aliasExists = aliasCheck && aliasCheck.textContent && aliasCheck.textContent.includes('åˆ«åï¼š');

        // æ ¹æ®åˆ«åå­—æ®µå­˜åœ¨ä¸å¦è°ƒæ•´å…¶ä»–å­—æ®µçš„é€‰æ‹©å™¨
        if (!aliasExists) {
            // è‹¥æ— åˆ«åå­—æ®µï¼Œéœ€è°ƒæ•´å…¶ä»–å­—æ®µçš„é€‰æ‹©å™¨
            const adjustments = {
                'æ›´æ–°çŠ¶æ€': 'p:nth-of-type(2) span.detail-main-info-value',
                'æœ€æ–°ç« èŠ‚': 'p:nth-of-type(3) span.detail-main-info-value',
                'åœ°åŒº': 'p:nth-of-type(5) span.detail-main-info-value',
                'ç±»å‹': 'p:nth-of-type(6) span.detail-main-info-value'
            };

            // åº”ç”¨è°ƒæ•´
            Object.keys(adjustments).forEach(field => {
                if (config.selectors[field]) {
                    config.selectors[field] = adjustments[field];
                }
            });
        }

        // ä¸å†å¼ºåˆ¶è®¾ç½®ä½œè€…å­—æ®µçš„ç´¢å¼•ä¸º"all"ï¼Œè®©ç”¨æˆ·è‡ªå·±å†³å®š

        return config;
    }
    // CSSé€‰æ‹©å™¨å·¥å…·ç±»
    class SelectorTool {
        constructor() {
            this.isActive = false;
            this.selectedElement = null;
            this.ignoreClasses = ['selector-highlight', 'selector-hover-highlight', 'overflow-hidden'];
            this.currentField = null;
            this.tooltip = null;
            this.tooltipTimer = null;
            this.hoveredElement = null;
            this.clickListener = null;
            this.moveListener = null;
            this.cancelButton = null;
            this.prevBodyUserSelect = '';
            this.prevHtmlUserSelect = '';
            this.lastHoverTime = 0;
            this.initTooltip();
        }

        initTooltip() {
            this.tooltip = document.createElement('div');
            this.tooltip.className = 'selector-tooltip';
            document.body.appendChild(this.tooltip);
        }

        createCancelButton() {
            // ç§»é™¤å·²å­˜åœ¨çš„å–æ¶ˆæŒ‰é’®
            document.getElementById('selector-cancel-btn')?.remove();

            const cancelBtn = document.createElement('button');
            cancelBtn.id = 'selector-cancel-btn';
            cancelBtn.textContent = 'å–æ¶ˆé€‰æ‹©';
            cancelBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.stopSelection();
                // æ™ºèƒ½æ£€æµ‹å½“å‰é…ç½®å¯¹è¯æ¡†ç±»å‹
                this.showConfigDialog();
            });
            document.body.appendChild(cancelBtn);
            this.cancelButton = cancelBtn;
        }

        // æ™ºèƒ½æ˜¾ç¤ºé…ç½®å¯¹è¯æ¡†
        showConfigDialog() {
            const configDialog = document.getElementById('config-dialog');
            if (configDialog) {
                configDialog.style.display = 'flex';
            }
        }

        toggleSelectionMode(e, field = null) {
            e.stopPropagation();
            e.preventDefault();

            this.currentField = field;
            this.isActive = !this.isActive;

            if (this.isActive) {
                // ä¿å­˜ç›‘å¬å™¨å¼•ç”¨ï¼Œä»¥ä¾¿ä¹‹åèƒ½ç§»é™¤æ­£ç¡®çš„å‡½æ•°
                this.clickListener = this.handleElementClick.bind(this);
                this.moveListener = this.handleElementHover.bind(this);

                document.addEventListener('click', this.clickListener, true);
                document.addEventListener('mousemove', this.moveListener, true);
                document.body.style.cursor = 'crosshair';
                try {
                    this.prevBodyUserSelect = document.body.style.userSelect || '';
                    this.prevHtmlUserSelect = document.documentElement.style.userSelect || '';
                    document.body.style.userSelect = 'none';
                    document.documentElement.style.userSelect = 'none';
                    document.body.style.webkitUserSelect = 'none';
                    document.documentElement.style.webkitUserSelect = 'none';
                } catch(_) {}
                this.showTooltip('ç‚¹å‡»é¡µé¢å…ƒç´ è·å–é€‰æ‹©å™¨', e.clientX, e.clientY - 30);
                this.createCancelButton();
                const cfg = document.getElementById('config-dialog');
                if (cfg) cfg.style.display = 'none';
                const anchor = document.getElementById('config-anchor-nav');
                if (anchor) anchor.style.display = 'none';
            } else {
                this.stopSelection();
            }
        }

        handleElementHover(e) {
            const now = Date.now();
            if (now - this.lastHoverTime < 50) {
                return;
            }
            this.lastHoverTime = now;
            const element = document.elementFromPoint(e.clientX, e.clientY);

            if (element.closest('#notion-import-btn-container') ||
                element.closest('#config-dialog') ||
                element.closest('div[style*="backdrop-filter"]') ||
                element.id === 'selector-cancel-btn') {
                this.removeHoverHighlight();
                return;
            }

            if (element !== this.hoveredElement) {
                this.removeHoverHighlight();
                this.hoveredElement = element;
                this.highlightElement(element, 'hover');

                const tagName = element.tagName.toLowerCase();
                const id = element.id ? `#${element.id}` : '';
                const classSelector = this.getShortestClassSelector(element);

                this.showTooltip(`${tagName}${id}${classSelector}`, e.clientX, e.clientY + 15);
            }
        }

        getShortestClassSelector(element) {
            if (!element.className) return '';

            const classes = Array.from(element.classList)
            .filter(c => !this.ignoreClasses.includes(c) && c.length > 0);

            const stablePref = classes.filter(c => {
                if (/\d/.test(c)) return false;
                if (/^[a-f0-9]{6,}$/i.test(c)) return false;
                if (/^(js-|jsx-|react-|css-|ant-|ng-|v-)/i.test(c)) return false;
                return true;
            });

            const candidates = stablePref.length ? stablePref : classes;
            if (candidates.length === 0) return '';

            candidates.sort((a, b) => a.length - b.length);
            return `.${candidates[0]}`;
        }

        handleElementClick(e) {
            if (e.target.closest('#notion-import-btn-container') ||
                e.target.closest('#config-dialog') ||
                e.target.closest('div[style*="backdrop-filter"]') ||
                e.target.id === 'selector-cancel-btn') {
                this.stopSelection();
                return;
            }

            e.preventDefault();
            e.stopPropagation();

            this.removeHoverHighlight();
            this.selectedElement = e.target;
            this.highlightElement(this.selectedElement, 'selected');

            const selector = this.generateUniqueSelector(this.selectedElement);

            if (this.currentField === 'contentSelector') {
                // ç‰¹æ®Šå¤„ç†å†…å®¹é€‰æ‹©å™¨ï¼Œä¼˜å…ˆå›å¡«åˆ°å½“å‰æ´»åŠ¨è¡Œ
                const candidates = [];
                const activeInput = document.getElementById('content-selector-input');
                if (activeInput) candidates.push(activeInput);
                const listInput = document.querySelector('input.content-selector-input');
                if (listInput && !candidates.includes(listInput)) candidates.push(listInput);
                const dataFieldInput = document.querySelector('input[data-field="contentSelector"]');
                if (dataFieldInput && !candidates.includes(dataFieldInput)) candidates.push(dataFieldInput);
                const stepInput = document.getElementById('step-config-content-selector');
                if (stepInput && !candidates.includes(stepInput)) candidates.push(stepInput);

                const targetInput = candidates.find(Boolean);
                if (targetInput) {
                    targetInput.value = selector;
                    try {
                        const event = new Event('input', { bubbles: true });
                        targetInput.dispatchEvent(event);
                    } catch (_) {}

                    // ç«‹å³è¿”å›é…ç½®é¡µé¢
                    this.stopSelection();
                    this.showConfigDialog();

                    // æ˜¾ç¤ºæç¤º
                    showNotification('å†…å®¹é€‰æ‹©å™¨å·²è®¾ç½®', 'success');
                } else {
                    this.stopSelection();
                    this.showConfigDialog();
                }
            } else if (this.currentField === 'markdownContentSelector') {
                const markdownInput = document.getElementById('markdown-content-selector-input');
                if (markdownInput) {
                    markdownInput.value = selector;
                    try {
                        const event = new Event('input', { bubbles: true });
                        markdownInput.dispatchEvent(event);
                    } catch (_) {}
                    this.stopSelection();
                    this.showConfigDialog();
                    showNotification('Markdown å†…å®¹é€‰æ‹©å™¨å·²è®¾ç½®', 'success');
                } else {
                    this.stopSelection();
                    this.showConfigDialog();
                }
            } else if (this.currentField === 'excludeSelector') {
                const activeExclude = document.querySelector('#exclude-selectors-list .exclude-selector-input[data-active-exclude="1"]') ||
                      document.querySelector('#exclude-selectors-list .exclude-selector-input');
                if (activeExclude) {
                    activeExclude.value = selector;
                    try {
                        const event = new Event('input', { bubbles: true });
                        activeExclude.dispatchEvent(event);
                    } catch(_) {}
                    this.stopSelection();
                    this.showConfigDialog();
                    showNotification('æ’é™¤é€‰æ‹©å™¨å·²è®¾ç½®', 'success');
                } else {
                    this.stopSelection();
                    this.showConfigDialog();
                }
            } else if (this.currentField) {
                const input = document.querySelector(`input[data-field="${this.currentField}"]`);
                if (input) {
                    input.value = selector;

                    // æ·»åŠ ï¼šé€‰æ‹©åç«‹å³è§¦å‘é¢„è§ˆ
                    const event = new Event('input', { bubbles: true });
                    input.dispatchEvent(event);

                    setTimeout(() => {
                        this.stopSelection();
                        this.showConfigDialog();
                    }, 500); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿ç§»åŠ¨ç«¯èƒ½æ­£ç¡®å¤„ç†
                } else if (this.currentField === 'expandBtn') {
                    // ç‰¹æ®Šå¤„ç†å±•å¼€æŒ‰é’®
                    const activeInput = document.querySelector('.expand-btn-selector-input.active') ||
                          document.querySelector('.expand-btn-selector-input') ||
                          document.getElementById('expand-btn-selector');
                    if (activeInput) {
                        activeInput.value = selector;

                        // å°è¯•ç«‹å³æ¨¡æ‹Ÿç‚¹å‡»å±•å¼€æŒ‰é’®
                        try {
                            this.selectedElement.click();
                            showNotification('å·²ç‚¹å‡»å±•å¼€æŒ‰é’®ï¼Œå†…å®¹å·²å±•å¼€', 'success');
                        } catch (error) {
                            console.error('ç‚¹å‡»å±•å¼€æŒ‰é’®å¤±è´¥:', error);
                            showNotification('ç‚¹å‡»å±•å¼€æŒ‰é’®å¤±è´¥', 'error');
                        }

                        // ç«‹å³è¿”å›é…ç½®é¡µé¢
                        this.stopSelection();
                        this.showConfigDialog();
                    }
                } else if (this.currentField === 'clipTypeSelector') {
                    // ç‰¹æ®Šå¤„ç†å‰ªè—ç±»å‹é€‰æ‹©å™¨
                    const clipTypeSelectorInput = document.getElementById('clip-type-selector-input');
                    if (clipTypeSelectorInput) {
                        clipTypeSelectorInput.value = selector;

                        // ç«‹å³è¿”å›é…ç½®é¡µé¢
                        this.stopSelection();
                        this.showConfigDialog();

                        // æ˜¾ç¤ºæç¤º
                        showNotification('å‰ªè—ç±»å‹é€‰æ‹©å™¨å·²è®¾ç½®', 'success');
                    }
                }
            } else {
                this.stopSelection();
            }
        }

        generateUniqueSelector(element) {
            if (!element || element === document.documentElement) return null;

            let selector = this.getBaseSelector(element);
            if (this.isUnique(selector)) return selector;

            const positionSelectors = this.generatePositionSelector(element);
            if (positionSelectors && positionSelectors.length) {
                for (const suffix of positionSelectors) {
                    const newSelector = `${selector}${suffix}`;
                    if (this.isUnique(newSelector)) return newSelector;
                }
            }

            return this.addParentSelectors(element, selector);
        }

        generatePositionSelector(element) {
            const parent = element.parentElement;
            if (!parent) return null;

            const sameTypeElements = Array.from(parent.children)
            .filter(el => el.tagName === element.tagName);

            if (sameTypeElements.length <= 1) return [':first-of-type'];

            const positionSelectors = [];
            const sameTypeIndex = sameTypeElements.indexOf(element) + 1;
            const sameTypeFromEnd = sameTypeElements.length - sameTypeIndex + 1;
            const siblings = Array.from(parent.children);
            const childIndex = siblings.indexOf(element) + 1;
            const childFromEnd = siblings.length - childIndex + 1;

            if (sameTypeIndex > 0) {
                positionSelectors.push(`:nth-of-type(${sameTypeIndex})`);
            }
            if (sameTypeFromEnd > 0) {
                positionSelectors.push(`:nth-last-of-type(${sameTypeFromEnd})`);
            }
            if (childIndex > 0) {
                positionSelectors.push(`:nth-child(${childIndex})`);
            }
            if (childFromEnd > 0) {
                positionSelectors.push(`:nth-last-child(${childFromEnd})`);
            }

            if (sameTypeIndex === 1) positionSelectors.push(':first-of-type');
            if (sameTypeIndex === sameTypeElements.length) positionSelectors.push(':last-of-type');
            if (childIndex === 1) positionSelectors.push(':first-child');
            if (childIndex === siblings.length) positionSelectors.push(':last-child');

            return Array.from(new Set(positionSelectors));
        }

        getBaseSelector(element) {
            const tag = element.tagName.toLowerCase();
            if (element.id) return `#${element.id}`;

            const esc = (s) => (window.CSS && CSS.escape) ? CSS.escape(s) : String(s).replace(/["\\]/g, '\\$&');
            const attrCandidates = [
                'data-testid','data-test','data-id','data-role','data-name','data-qa',
                'aria-label','aria-labelledby','role','name'
            ];
            for (const a of attrCandidates) {
                const v = element.getAttribute(a);
                if (v && v.length) {
                    return `${tag}[${a}="${esc(v)}"]`;
                }
            }

            const classSelector = this.getShortestClassSelector(element);
            return classSelector ? `${tag}${classSelector}` : tag;
        }

        addParentSelectors(element, selector, depth = 0, maxDepth = 3) {
            if (depth >= maxDepth || !element.parentElement) return selector;

            const parent = element.parentElement;
            const parentSelector = this.getBaseSelector(parent);

            if (!parentSelector) return selector;

            const newSelector = `${parentSelector} > ${selector}`;

            if (this.isUnique(newSelector)) return newSelector;

            const positionSelectors = this.generatePositionSelector(element);
            if (positionSelectors && positionSelectors.length) {
                for (const suffix of positionSelectors) {
                    const positionedSelector = `${newSelector}${suffix}`;
                    if (this.isUnique(positionedSelector)) return positionedSelector;
                }
            }

            return this.addParentSelectors(parent, newSelector, depth + 1, maxDepth);
        }

        isUnique(selector) {
            try {
                return document.querySelectorAll(selector).length === 1;
            } catch (e) {
                return false;
            }
        }

        highlightElement(element, type = 'selected') {
            if (!element) return;

            if (type === 'hover') {
                element.classList.add('selector-hover-highlight');
            } else {
                element.classList.add('selector-highlight');
            }
        }

        removeHoverHighlight() {
            if (this.hoveredElement) {
                this.hoveredElement.classList.remove('selector-hover-highlight');
                this.hoveredElement = null;
            }
        }

        removeHighlight() {
            if (this.selectedElement) {
                this.selectedElement.classList.remove('selector-highlight');
                this.selectedElement = null;
            }
        }

        stopSelection() {
            if (this.clickListener) {
                document.removeEventListener('click', this.clickListener, true);
                this.clickListener = null;
            }

            if (this.moveListener) {
                document.removeEventListener('mousemove', this.moveListener, true);
                this.moveListener = null;
            }

            document.body.style.cursor = '';
            try {
                document.body.style.userSelect = this.prevBodyUserSelect || '';
                document.documentElement.style.userSelect = this.prevHtmlUserSelect || '';
                document.body.style.webkitUserSelect = this.prevBodyUserSelect || '';
                document.documentElement.style.webkitUserSelect = this.prevHtmlUserSelect || '';
            } catch(_) {}
            this.removeHoverHighlight();
            this.removeHighlight();
            this.hideTooltip();
            this.isActive = false;
            this.currentField = null;

            // ç§»é™¤å–æ¶ˆæŒ‰é’®
            if (this.cancelButton) {
                this.cancelButton.remove();
                this.cancelButton = null;
            }

            document.querySelectorAll('.selector-highlight, .selector-hover-highlight').forEach(el => {
                el.classList.remove('selector-highlight', 'selector-hover-highlight');
            });

            // æ¢å¤é…ç½®ç•Œé¢æ˜¾ç¤º
            const configDialog = document.getElementById('config-dialog');
            if (configDialog && configDialog.style.display === 'none') {
                configDialog.style.display = 'flex';
            }

            // æ¢å¤é€æ­¥é…ç½®å¯¹è¯æ¡†æ˜¾ç¤º
            const stepConfigOverlay = document.querySelector('div[style*="backdrop-filter"]');
            if (stepConfigOverlay && stepConfigOverlay.style.display === 'none') {
                stepConfigOverlay.style.display = 'flex';
            }

            // æ¢å¤æ‚¬æµ®ä¸»æŒ‰é’®ä¸é”šç‚¹å¯¼èˆª
            try {
                const btns = document.getElementById('notion-import-btn-container');
                if (btns) btns.style.display = 'flex';
                const anchor = document.getElementById('config-anchor-nav');
                if (anchor) anchor.style.display = 'flex';
            } catch(_) {}
        }

        showTooltip(text, x, y) {
            this.tooltip.textContent = text;
            this.tooltip.style.left = `${x}px`;
            this.tooltip.style.top = `${y}px`;
            this.tooltip.classList.add('visible');

            if (this.tooltipTimer) clearTimeout(this.tooltipTimer);
            this.tooltipTimer = setTimeout(() => {
                this.tooltip.classList.remove('visible');
            }, 2000);
        }

        hideTooltip() {
            this.tooltip.classList.remove('visible');
            if (this.tooltipTimer) clearTimeout(this.tooltipTimer);
        }
    }

    // ç”Ÿæˆå½“å‰é¡µé¢çš„é…ç½®ä½œç”¨åŸŸé”®ï¼šhostname + é¦–çº§è·¯å¾„æ®µï¼ˆç¡®ä¿åŒåŸŸä¸åŒå­è·¯å¾„ç‹¬ç«‹ï¼‰
    function getConfigScopeKey(url = window.location) {
        try {
            const hostname = url.hostname || window.location.hostname;
            const pathname = url.pathname || window.location.pathname;
            const firstSegment = (pathname || '/').split('/').filter(Boolean)[0] || '';
            const segmentPart = firstSegment ? `/${firstSegment}` : '/';
            return `${hostname}${segmentPart}`;
        } catch (_) {
            return `${window.location.hostname}/`;
        }
    }

    // åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰é…ç½®
    function loadCustomConfigs() {
        const customConfigs = {};
        const savedConfigs = GM_listValues().filter(key => key.startsWith('site_config_'));

        savedConfigs.forEach(key => {
            const host = key.replace('site_config_', '');
            try {
                customConfigs[host] = GM_getValue(key);
            } catch (error) {
                console.error(`åŠ è½½é…ç½® ${key} å¤±è´¥:`, error);
            }
        });

        return customConfigs;
    }

    // ä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰é…ç½®
    function saveCustomConfig(host, config) {
        try {
            GM_setValue(`site_config_${host}`, config);
            return true;
        } catch (error) {
            console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
            showError('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message);
            return false;
        }
    }

    // åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰é…ç½®
    function deleteCustomConfig(host) {
        try {
            let deleted = false;
            // åˆ é™¤æ ‡å‡†æ ¼å¼çš„é…ç½®
            if (GM_getValue(`site_config_${host}`) !== undefined) {
                GM_deleteValue(`site_config_${host}`);
                deleted = true;
            }
            return deleted;
        } catch (error) {
            console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
            showError('åˆ é™¤é…ç½®å¤±è´¥: ' + error.message);
            return false;
        }
    }

    // åˆ›å»ºç±»å‹æ˜ å°„é…ç½®UI
    function createTypeMappingUI(typeMappings) {
        const container = document.createElement('div');
        container.style.marginTop = '24px';
        container.style.borderTop = 'none';
        container.style.paddingTop = '0';
        container.id = 'type-mapping-container';
        container.style.cssText = 'margin-top: 24px !important; padding: 16px !important; border-radius: 12px ; background:rgba(255,255,255,0.4)!important; box-sizing: border-box !important;border:1px solid rgba(229, 231, 235, 0.85)';

        const title = document.createElement('h3');
        title.textContent = 'ç±»å‹ç»Ÿä¸€åŒ–é…ç½®';
        title.style.marginBottom = '12px';
        title.style.fontSize = '16px';
        title.style.fontWeight = '700';
        title.style.background = 'linear-gradient(135deg, var(--primarycolor-dark, #FF8FAB), var(--primarycolor, #FF6B9D))';
        title.style.webkitBackgroundClip = 'text';
        title.style.webkitTextFillColor = 'transparent';
        title.style.backgroundClip = 'text';
        container.appendChild(title);

        const desc = document.createElement('p');
        desc.textContent = 'é…ç½®å­—æ®µå€¼çš„æ ‡å‡†åŒ–æ˜ å°„';
        desc.style.fontSize = '13px';
        desc.style.color = 'var(--text-dark)';
        desc.style.marginBottom = '12px';
        container.appendChild(desc);

        // ä¸ºæ¯ä¸ªå­—æ®µåˆ›å»ºé…ç½®åŒºåŸŸ
        for (const field in typeMappings) {
            const fieldContainer = document.createElement('div');
            fieldContainer.className = 'type-mapping-field';
            fieldContainer.dataset.field = field;

            const header = document.createElement('div');
            header.className = 'type-mapping-header';
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.padding = '10px 15px';
            header.style.borderRadius = '50px';
            header.style.cursor = 'pointer';
            header.style.marginBottom = '10px';
            header.style.transition = 'all 0.25s ease';
            header.style.border = '1px solid var(--input-border)';

            const fieldTitle = document.createElement('strong');
            fieldTitle.textContent = field;
            fieldTitle.style.fontSize = '14px';
            fieldTitle.style.color = 'var(--primarycolor)';

            const dropdownIcon = document.createElement('span');
            dropdownIcon.textContent = 'â–¼';
            dropdownIcon.style.fontSize = '12px';
            dropdownIcon.style.color = 'var(--primarycolor)';
            dropdownIcon.style.backgroundColor = 'rgba(120, 120, 255, 0.1)';
            dropdownIcon.style.borderRadius = '50%';
            dropdownIcon.style.width = '22px';
            dropdownIcon.style.height = '22px';
            dropdownIcon.style.display = 'flex';
            dropdownIcon.style.alignItems = 'center';
            dropdownIcon.style.justifyContent = 'center';
            dropdownIcon.style.transition = 'transform 0.3s ease';

            header.appendChild(fieldTitle);
            header.appendChild(dropdownIcon);

            const content = document.createElement('div');
            content.className = 'type-mapping-content';
            content.style.padding = '8px';
            content.style.border = '1px solid rgba(229,231,235,0.85)';
            content.style.borderRadius = '10px';
            content.style.background = 'rgba(255,255,255,0.5)';

            // æ·»åŠ ç°æœ‰çš„æ˜ å°„
            for (const [standard, variantsStr] of Object.entries(typeMappings[field])) {
                const row = document.createElement('div');
                row.className = 'type-mapping-row';
                row.style.cssText = 'display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; align-items: center !important; width: 100% !important; gap: 8px !important; margin-bottom: 8px !important; box-sizing: border-box !important; padding-right: 4px !important;';

                const standardInput = document.createElement('input');
                standardInput.type = 'text';
                standardInput.className = 'type-mapping-standard';
                standardInput.value = standard;
                standardInput.placeholder = 'æ ‡å‡†å€¼';
                standardInput.style.cssText = 'height: 36px !important; width: 30% !important; min-width: 80px !important; max-width: 30% !important; flex: 0 0 30% !important; box-sizing: border-box !important; border: 1px solid #e0e0e0 !important; border-radius: var(--notion-border-radius,12px) !important ; padding: 0 15px !important;font-size:13px';

                const variantsInput = document.createElement('input');
                variantsInput.type = 'text';
                variantsInput.className = 'type-mapping-variants';
                variantsInput.value = variantsStr;
                variantsInput.placeholder = 'å¤šä¸ªè¯ç”¨é€—å·åˆ†éš”';
                variantsInput.style.cssText = 'height: 36px !important; width: 60% !important; min-width: 15px !important; flex: 0 0 60% !important; box-sizing: border-box !important; border: 1px solid #e0e0e0 !important; border-radius: var(--notion-border-radius,12px) !important; padding: 0 15px !important;';

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Ã—';
                removeBtn.className = 'dialog-btn-secondary';
                removeBtn.style.cssText = 'padding: 0 !important; width: 28px !important; min-width: 28px !important; max-width: 28px !important; flex: 0 0 28px !important; height: 36px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: var(--notion-border-radius,12px) !important ; font-size: 16px !important; background: var(--primarycolor-lighter) !important; border: 1px solid var(--primarycolor) !important; color:  var(--primarycolor) !important; box-sizing: border-box !important; transition: all 0.2s ease !important; box-shadow: 0 1px 2px var(--primarycolor-lighter) !important; cursor: pointer !important;';
                removeBtn.addEventListener('click', () => row.remove());

                row.appendChild(standardInput);
                row.appendChild(variantsInput);
                row.appendChild(removeBtn);
                content.appendChild(row);
            }

            // æ·»åŠ æ–°æ˜ å°„çš„æŒ‰é’®
            const addBtn = document.createElement('button');
            addBtn.textContent = '+ æ·»åŠ æ˜ å°„';
            addBtn.className = 'dialog-btn-secondary type-mapping-add-btn';
            addBtn.addEventListener('click', () => {
                const row = document.createElement('div');
                row.className = 'type-mapping-row';
                row.style.cssText = 'display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; align-items: center !important; width: 100% !important; gap: 8px !important; margin-bottom: 8px !important; box-sizing: border-box !important; padding-right: 4px !important;';

                const standardInput = document.createElement('input');
                standardInput.type = 'text';
                standardInput.className = 'type-mapping-standard';
                standardInput.placeholder = 'æ ‡å‡†å€¼';
                standardInput.style.cssText = 'height: 36px !important; width: 30% !important; min-width: 80px !important; max-width: 30% !important; flex: 0 0 30% !important; box-sizing: border-box !important; border: 1px solid #e0e0e0 !important; border-radius: var(--notion-border-radius,12px) !important ; padding: 0 10px !important;';

                const variantsInput = document.createElement('input');
                variantsInput.type = 'text';
                variantsInput.className = 'type-mapping-variants';
                variantsInput.placeholder = 'å¤šä¸ªè¯ç”¨é€—å·åˆ†éš”';
                variantsInput.style.cssText = 'height: 36px !important; width: 60% !important; min-width: 150px !important; flex: 0 0 60% !important; box-sizing: border-box !important; border: 1px solid #e0e0e0 !important;border-radius: var(--notion-border-radius,12px) !important ; padding: 0 10px !important;';

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Ã—';
                removeBtn.className = 'dialog-btn-secondary';
                removeBtn.style.cssText = 'padding: 0 !important; width: 28px !important; min-width: 28px !important; max-width: 28px !important; flex: 0 0 28px !important; height: 36px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: var(--notion-border-radius,12px) !important ; font-size: 16px !important; background: var(--primarycolor-lighter) !important; border: 1px solid var(--primarycolor) !important; color: var(--primarycolor) !important; box-sizing: border-box !important; transition: all 0.2s ease !important; box-shadow: 0 1px 2px var(--primarycolor-lighter) !important; cursor: pointer !important;';
                removeBtn.addEventListener('click', () => row.remove());

                row.appendChild(standardInput);
                row.appendChild(variantsInput);
                row.appendChild(removeBtn);
                content.insertBefore(row, addBtn);
            });

            content.appendChild(addBtn);
            fieldContainer.appendChild(header);
            fieldContainer.appendChild(content);

            // ç‚¹å‡»æ ‡é¢˜å±•å¼€/æŠ˜å 
            header.addEventListener('click', () => {
                content.classList.toggle('show');
                const isExpanded = content.classList.contains('show');
                dropdownIcon.textContent = isExpanded ? 'â–²' : 'â–¼';
                dropdownIcon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(0deg)';
                header.style.backgroundColor = isExpanded ? 'var(--primarycolor-lighter)' : 'var(--input-bg)';
                header.style.borderColor = isExpanded ? 'var(--primarycolor)' : 'var(--input-border)';
            });

            // é»˜è®¤æŠ˜å 
            content.classList.remove('show');
            dropdownIcon.textContent = 'â–¼';

            container.appendChild(fieldContainer);
        }

        return container;
    }

    // ä»ç±»å‹æ˜ å°„UIè·å–é…ç½®
    function getTypeMappingsFromUI(container) {
        const result = {};

        const fields = container.querySelectorAll('.type-mapping-field');
        fields.forEach(fieldContainer => {
            const fieldName = fieldContainer.dataset.field;
            result[fieldName] = {};

            const rows = fieldContainer.querySelectorAll('.type-mapping-row');
            rows.forEach(row => {
                const standard = row.querySelector('.type-mapping-standard').value.trim();
                const variants = row.querySelector('.type-mapping-variants').value.trim();

                if (standard && variants) {
                    result[fieldName][standard] = variants;
                }
            });
        });

        return result;
    }
    // æ˜¾ç¤ºé…ç½®å¯¹è¯æ¡†
    function showConfigDialog() {
        const currentHost = window.location.hostname;
        const currentKey = getConfigScopeKey ? getConfigScopeKey() : currentHost;
        const customConfigs = loadCustomConfigs();
        // ç»Ÿä¸€ä¼˜å…ˆçº§ï¼šå…ˆè¯»å–ç«™ç‚¹çº§é…ç½®ï¼Œå†è¯»å–å­è·¯å¾„çº§é…ç½®
        const existingConfig = customConfigs[currentHost] || customConfigs[currentKey] || DEFAULT_SITE_CONFIGS[currentHost] || {
            selectors: {
                ç®€ä»‹: "", ä¹¦å: "", ä½œè€…: "", æœ€æ–°ç« èŠ‚: "", æ›´æ–°çŠ¶æ€: "",
                å°é¢: "", è¿½æ›´: "", åˆ«å: "", åœ°åŒº: "", ç±»å‹: ""
            },
            selectorIndices: {
                ç®€ä»‹: 0, ä¹¦å: 0, ä½œè€…: 0, æœ€æ–°ç« èŠ‚: 0, æ›´æ–°çŠ¶æ€: 0,
                å°é¢: 0, è¿½æ›´: 0, åˆ«å: 0, åœ°åŒº: 0, ç±»å‹: 0
            },
            contentType: "comic"
        };

        // ç¡®ä¿selectorIndiceså­˜åœ¨
        if (!existingConfig.selectorIndices) {
            existingConfig.selectorIndices = {
                ç®€ä»‹: 0, ä¹¦å: 0, ä½œè€…: 0, æœ€æ–°ç« èŠ‚: 0, æ›´æ–°çŠ¶æ€: 0,
                å°é¢: 0, è¿½æ›´: 0, åˆ«å: 0, åœ°åŒº: 0, ç±»å‹: 0
            };
        }

        // ç¡®ä¿enableCustomTagså­˜åœ¨ï¼Œé»˜è®¤å¼€å¯
        if (existingConfig.enableCustomTags === undefined) {
            existingConfig.enableCustomTags = true;
        }

        // è°ƒè¯•ä¿¡æ¯ï¼šæŸ¥çœ‹åŠ è½½çš„é…ç½®æ•°æ®
        console.log('å®Œæ•´é…ç½®ç•Œé¢åŠ è½½çš„é…ç½®:', existingConfig);
        console.log('åŠ è½½çš„é€‰æ‹©å™¨æ•°æ®:', existingConfig.selectors);
        console.log('åŠ è½½çš„ç´¢å¼•æ•°æ®:', existingConfig.selectorIndices);

        const selectorTool = new SelectorTool();
        const typeMappings = loadTypeMappings();

        const form = document.createElement('div');
        form.id = 'config-dialog-content';

        // æ ·å¼ç»Ÿä¸€ï¼šåˆ†ç»„å¡ç‰‡ä¸é¢„è§ˆã€ç§»åŠ¨ç«¯é€‚é…
        try {
            GM_addStyle(`
            #config-dialog .selector-section-card,
            #config-dialog .selector-field-card {
                border-radius: 20px;
                border:1px solid rgba(229, 231, 235, 0.85);
                padding: 12px;
                margin-bottom: 16px;
                background: rgba(255,255,255,0.3);

            }
            #config-dialog .input-group {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            #config-dialog .selector-control-group {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            #config-cover-preview {
                display: none;
                padding: 12px;
                border-radius: 20px;
                margin-bottom: 16px;
                background: rgba(255,255,255,0.4);

            }
            #config-cover-preview-img {
                height: auto;
                border-radius: 20px;
                display: block;
                margin-bottom: 8px;
            }
            @media (max-width: 768px) {
                #config-dialog-content { padding: 10px !important; }
                #config-dialog .selector-section-card,
                #config-dialog .selector-field-card { padding: 10px; margin-bottom: 12px; }
            }
            `);
        } catch(_) {}

        // æ·»åŠ å†…å®¹ç±»å‹é€‰æ‹©
        const typeContainer = document.createElement('div');
        typeContainer.style.marginBottom = '20px';
        typeContainer.style.marginBottom = '20px';
        typeContainer.id = 'anchor-content-type';
        typeContainer.className = 'selector-section-card';

        const typeLabel = document.createElement('label');
        typeLabel.textContent = 'å†…å®¹ç±»å‹';
        typeLabel.style.display = 'block';
        typeLabel.style.marginBottom = '10px';
        typeLabel.style.fontSize = '14px';
        typeLabel.style.fontWeight = '500';

        const typeSelect = document.createElement('select');
        typeSelect.id = 'content-type-select';
        typeSelect.style.display = 'none';

        const typeTabs = document.createElement('div');
        typeTabs.className = 'content-type-tabs';
        typeTabs.style.display = 'grid';
        typeTabs.style.gridTemplateColumns = '1fr 1fr 1fr';


        const comicOption = document.createElement('option');
        comicOption.value = 'comic';
        comicOption.textContent = 'æ¼«ç”»';
        typeSelect.appendChild(comicOption);

        const novelOption = document.createElement('option');
        novelOption.value = 'novel';
        novelOption.textContent = 'å°è¯´';
        typeSelect.appendChild(novelOption);

        // å‰ªè—æ¨¡å¼ä»ä½œä¸ºå†…å®¹ç±»å‹å­˜åœ¨ï¼Œåªæ˜¯åœ¨â€œæ˜¾ç¤ºé€‰æ‹©å™¨é…ç½®â€ä¸­ä¸æä¾›å‰ªè—å…¥å£
        const clipOption = document.createElement('option');
        clipOption.value = 'clip';
        clipOption.textContent = 'å‰ªè—';
        typeSelect.appendChild(clipOption);

        if (existingConfig.contentType === 'novel') {
            novelOption.selected = true;
        } else if (existingConfig.contentType === 'clip') {
            clipOption.selected = true;
        } else {
            comicOption.selected = true;
        }

        const initialType = typeSelect.value || 'comic';
        const tabComic = document.createElement('button');
        tabComic.className = 'content-type-tab';
        tabComic.textContent = 'æ¼«ç”»';
        const tabNovel = document.createElement('button');
        tabNovel.className = 'content-type-tab';
        tabNovel.textContent = 'å°è¯´';
        const tabClip = document.createElement('button');
        tabClip.className = 'content-type-tab';
        tabClip.textContent = 'å‰ªè—';

        const updateActiveTab = (value) => {
            tabComic.classList.toggle('active', value === 'comic');
            tabNovel.classList.toggle('active', value === 'novel');
            tabClip.classList.toggle('active', value === 'clip');
        };

        updateActiveTab(initialType);

        tabComic.addEventListener('click', () => {
            if (typeSelect.value !== 'comic') {
                typeSelect.value = 'comic';
                typeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });

        tabNovel.addEventListener('click', () => {
            if (typeSelect.value !== 'novel') {
                typeSelect.value = 'novel';
                typeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });

        tabClip.addEventListener('click', () => {
            if (typeSelect.value !== 'clip') {
                typeSelect.value = 'clip';
                typeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });

        typeTabs.appendChild(tabComic);
        typeTabs.appendChild(tabNovel);
        typeTabs.appendChild(tabClip);

        typeSelect.addEventListener('change', (e) => {
            updateActiveTab(e.target.value);
        });

        typeContainer.appendChild(typeLabel);
        typeContainer.appendChild(typeTabs);
        typeContainer.appendChild(typeSelect);
        form.appendChild(typeContainer);





        // æ·»åŠ å°é¢é¢„è§ˆå®¹å™¨ï¼ˆåœ¨å°é¢é€‰æ‹©å™¨å‰ï¼‰
        const coverPreviewContainer = document.createElement('div');
        coverPreviewContainer.id = 'config-cover-preview';

        const coverPreviewImg = document.createElement('img');
        coverPreviewImg.id = 'config-cover-preview-img';

        const coverPreviewText = document.createElement('span');
        coverPreviewText.id = 'config-cover-preview-text';
        coverPreviewText.textContent = 'å°é¢é¢„è§ˆåŒºåŸŸ';

        coverPreviewContainer.appendChild(coverPreviewImg);
        coverPreviewContainer.appendChild(coverPreviewText);

        // æ·»åŠ å°é¢é€‰æ‹©å™¨
        const coverContainer = document.createElement('div');
        coverContainer.style.marginBottom = '20px';
        coverContainer.id = 'anchor-cover-selector';
        coverContainer.className = 'selector-section-card';

        const coverLabel = document.createElement('label');
        coverLabel.textContent = 'å°é¢';
        coverLabel.style.display = 'block';
        coverLabel.style.marginBottom = '8px';
        coverLabel.style.fontSize = '14px';
        coverLabel.style.fontWeight = '500';

        const coverInputGroup = document.createElement('div');
        coverInputGroup.className = 'input-group';

        const coverInput = document.createElement('input');
        coverInput.type = 'text';
        coverInput.className = 'notion-import-input'; // æ·»åŠ è‡ªå®šä¹‰ç±»å
        coverInput.value = existingConfig.selectors['å°é¢'] || '';
        coverInput.style.width = '30%';
        coverInput.style.padding = '12px';
        coverInput.style.border = '1px solid var(--input-border)';
        coverInput.style.borderRadius = '17px'; // æ¤­åœ†å½¢
        coverInput.dataset.field = 'å°é¢';
        coverInput.placeholder = 'ç•™ç©ºè¡¨ç¤ºä¸æå–æ­¤å­—æ®µ';

        const coverButtonsContainer = document.createElement('div');
        coverButtonsContainer.className = 'input-group-buttons';

        const coverPickerBtn = document.createElement('button');
        coverPickerBtn.className = 'selector-picker-btn';
        try { coverPickerBtn.dataset.btnType = 'select'; } catch(_) {}
        coverPickerBtn.textContent = 'é€‰æ‹©';
        coverPickerBtn.addEventListener('click', (e) => {
            // éšè—é…ç½®ç•Œé¢
            const configDialog = document.getElementById('config-dialog');
            if (configDialog) {
                configDialog.style.display = 'none';
            }
            selectorTool.toggleSelectionMode(e, 'å°é¢');
        });

        // åˆ›å»ºç´¢å¼•è¾“å…¥æ¡†
        const coverIndexInput = document.createElement('input');
        coverIndexInput.type = 'text';
        coverIndexInput.placeholder = 'ç´¢å¼•/all/èŒƒå›´';
        coverIndexInput.value = normalizeIndexValue(existingConfig.selectorIndices['å°é¢'], '0');
        coverIndexInput.className = 'selector-index-input';
        coverIndexInput.dataset.field = 'å°é¢';
        coverIndexInput.title = 'æ”¯æŒ: 1=ç¬¬ä¸€ä¸ª, 0/last=æœ€åä¸€ä¸ª, -2=å€’æ•°ç¬¬äºŒ, 2,3,5=å¤šé€‰, 2-5=èŒƒå›´, all=å…¨éƒ¨';

        // å°†æŒ‰é’®æ·»åŠ åˆ°æŒ‰é’®å®¹å™¨
        coverButtonsContainer.appendChild(coverPickerBtn);
        coverButtonsContainer.appendChild(coverIndexInput);

        // å°†è¾“å…¥æ¡†å’ŒæŒ‰é’®å®¹å™¨æ·»åŠ åˆ°è¾“å…¥ç»„
        coverInputGroup.appendChild(coverInput);
        coverInputGroup.appendChild(coverButtonsContainer);

        // æ·»åŠ å°é¢é¢„è§ˆåŠŸèƒ½
        // ç§»é™¤å•ç‹¬çš„æµ‹è¯•æŒ‰é’®ï¼Œæ”¹ä¸ºé€‰æ‹©å™¨å†…å®¹å˜åŒ–æ—¶è‡ªåŠ¨é¢„è§ˆ
        coverInput.addEventListener('input', () => {
            updateCoverPreview(coverInput.value, coverIndexInput.value);
        });

        coverIndexInput.addEventListener('input', () => {
            updateCoverPreview(coverInput.value, coverIndexInput.value);
        });

        // æ›´æ–°å°é¢é¢„è§ˆçš„å‡½æ•° - æ”¯æŒæ‰‹æœºç«¯
        function updateCoverPreview(selector, index) {
            if (!selector) {
                coverPreviewContainer.classList.remove('show');
                return;
            }

            try {
                const elements = document.querySelectorAll(selector);
                if (elements.length === 0) {
                    coverPreviewContainer.classList.add('show');
                    coverPreviewText.textContent = 'æœªæ‰¾åˆ°åŒ¹é…å…ƒç´ ';
                    return;
                }

                const selection = resolveElementSelection(elements, index || '0');
                if (!selection.elements.length) {
                    coverPreviewContainer.classList.add('show');
                    coverPreviewText.textContent = 'ç´¢å¼•æœªåŒ¹é…åˆ°å…ƒç´ ';
                    return;
                }

                const element = selection.elements[0];

                const imageUrl = extractImageUrl(element);
                if (imageUrl) {
                    coverPreviewContainer.classList.add('show');
                    coverPreviewImg.src = imageUrl;
                    coverPreviewImg.alt = 'å°é¢é¢„è§ˆ';
                    // æ·»åŠ é”™è¯¯å¤„ç†
                    coverPreviewImg.onerror = () => {
                        coverPreviewText.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                    };
                    coverPreviewImg.onload = () => {
                        // å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œç¡®ä¿æ˜¾ç¤º
                        coverPreviewContainer.classList.add('show');
                    };
                    if (selection.mode !== 'single') {
                        coverPreviewText.textContent = `åŒ¹é…${selection.elements.length}ä¸ªå…ƒç´ ï¼Œé¢„è§ˆç¬¬1ä¸ª`;
                    } else {
                        coverPreviewText.textContent = 'å°é¢é¢„è§ˆ';
                    }
                } else {
                    coverPreviewContainer.classList.add('show');
                    coverPreviewText.textContent = 'æœªæ‰¾åˆ°å›¾ç‰‡é“¾æ¥';
                }
            } catch (error) {
                console.error('é¢„è§ˆå°é¢å¤±è´¥:', error);
                coverPreviewContainer.classList.add('show');
                coverPreviewText.textContent = 'é¢„è§ˆå¤±è´¥: ' + error.message;
            }
        }

        coverContainer.appendChild(coverLabel);
        coverContainer.appendChild(coverInputGroup);

        // å…ˆæ”¾ç½®å°é¢é¢„è§ˆå®¹å™¨ï¼Œå†æ”¾å°é¢é€‰æ‹©å™¨
        form.appendChild(coverPreviewContainer);
        form.appendChild(coverContainer);

        // åˆå§‹åŒ–å°é¢é¢„è§ˆ
        if (existingConfig.selectors['å°é¢']) {
            updateCoverPreview(existingConfig.selectors['å°é¢'], existingConfig.selectorIndices['å°é¢']);
        }

        const info = document.createElement('p');
        info.textContent = 'ä¸ºå½“å‰ç½‘ç«™é…ç½®CSSé€‰æ‹©å™¨æ¥æå–ä¿¡æ¯:';
        info.style.marginBottom = '16px';
        info.style.fontSize = '15px';
        form.appendChild(info);

        const fields = [
            'ä¹¦å', 'ä½œè€…', 'ç®€ä»‹', 'æœ€æ–°ç« èŠ‚', 'æ›´æ–°çŠ¶æ€',
            'è¿½æ›´', 'åˆ«å', 'åœ°åŒº', 'ç±»å‹'
        ];

        // æ ¹æ®é€‰æ‹©çš„å†…å®¹ç±»å‹å†³å®šæ˜¾ç¤ºå“ªäº›å­—æ®µ
        const updateFieldVisibility = (contentType) => {
            const clipFieldsOnly = ['ä¹¦å', 'ä½œè€…', 'å°é¢']; // å‰ªè—æ¨¡å¼ä½¿ç”¨ä¹¦åã€ä½œè€…ã€å°é¢å­—æ®µ
            const contentSelectorContainer = document.getElementById('content-selector-container');
            const expandBtnContainer = document.querySelector('div[style*="ç®€ä»‹å±•å¼€æŒ‰é’®é€‰æ‹©å™¨"]');
            // ä¼˜å…ˆä½¿ç”¨IDï¼Œç„¶åä½¿ç”¨å¤šç§æ–¹æ³•æŸ¥æ‰¾ç±»å‹ç»Ÿä¸€åŒ–é…ç½®å®¹å™¨
            let typeMappingContainer = document.getElementById('type-mapping-container');

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾æ ‡é¢˜ä¸º"ç±»å‹ç»Ÿä¸€åŒ–é…ç½®"çš„h3å…ƒç´ 
            if (!typeMappingContainer) {
                const h3Elements = document.querySelectorAll('h3');
                for (const h3 of h3Elements) {
                    if (h3.textContent.includes('ç±»å‹ç»Ÿä¸€åŒ–é…ç½®')) {
                        typeMappingContainer = h3.closest('div');
                        break;
                    }
                }
            }

            // å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–é€‰æ‹©å™¨
            if (!typeMappingContainer) {
                typeMappingContainer = document.querySelector('div[style*="ç±»å‹ç»Ÿä¸€åŒ–é…ç½®"]');
            }

            // æ˜¾ç¤º/éšè—å†…å®¹é€‰æ‹©å™¨ï¼ˆåªåœ¨å‰ªè—ç±»å‹æ—¶æ˜¾ç¤ºï¼‰
            if (contentSelectorContainer) {
                contentSelectorContainer.style.display = contentType === 'clip' ? 'block' : 'none';
            }

            // æ˜¾ç¤º/éšè—æ’é™¤é€‰æ‹©å™¨ï¼ˆåªåœ¨å‰ªè—ç±»å‹æ—¶æ˜¾ç¤ºï¼‰
            const excludeSelectorsContainerEl = document.getElementById('exclude-selectors-container');
            if (excludeSelectorsContainerEl) {
                excludeSelectorsContainerEl.style.display = contentType === 'clip' ? 'block' : 'none';
            }

            // æ˜¾ç¤º/éšè—å‰ªè—ç±»å‹é€‰æ‹©å™¨ï¼ˆåªåœ¨å‰ªè—ç±»å‹æ—¶æ˜¾ç¤ºï¼‰
            const clipTypeSelectorContainer = document.getElementById('clip-type-selector-container');
            if (clipTypeSelectorContainer) {
                clipTypeSelectorContainer.style.display = contentType === 'clip' ? 'block' : 'none';
            }

            // æ˜¾ç¤º/éšè—ç®€ä»‹å±•å¼€æŒ‰é’®é€‰æ‹©å™¨ï¼ˆå‰ªè—ç±»å‹ä¸æ˜¾ç¤ºï¼‰
            if (expandBtnContainer) {
                expandBtnContainer.style.display = contentType === 'clip' ? 'none' : 'block';
            }

            // æ ¹æ®å†…å®¹ç±»å‹è°ƒæ•´ç±»å‹ç»Ÿä¸€åŒ–é…ç½®
            // ä¼˜å…ˆä½¿ç”¨IDé€‰æ‹©å™¨æŸ¥æ‰¾ç±»å‹æ˜ å°„å®¹å™¨ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†ä½¿ç”¨æ ·å¼é€‰æ‹©å™¨
            const typeMappingContainerById = document.getElementById('type-mapping-container');
            const actualTypeMappingContainer = typeMappingContainerById || typeMappingContainer;

            if (actualTypeMappingContainer) {
                if (contentType === 'clip') {
                    // å‰ªè—ç±»å‹å®Œå…¨ä¸æ˜¾ç¤ºç±»å‹ç»Ÿä¸€åŒ–é…ç½®
                    actualTypeMappingContainer.style.display = 'none';
                } else {
                    actualTypeMappingContainer.style.display = 'block';

                    // ç®¡ç†ç±»å‹æ˜ å°„å­—æ®µå¯è§æ€§
                    const mappingFields = actualTypeMappingContainer.querySelectorAll('.type-mapping-field');
                    mappingFields.forEach(field => {
                        const fieldName = field.dataset.field;
                        if (fieldName === 'åœ°åŒº') {
                            // åªæœ‰æ¼«ç”»æ˜¾ç¤ºåœ°åŒºé€‰é¡¹
                            field.style.display = contentType === 'comic' ? 'block' : 'none';
                        } else if (fieldName === 'æ›´æ–°çŠ¶æ€') {
                            // å°è¯´å’Œæ¼«ç”»éƒ½æ˜¾ç¤ºæ›´æ–°çŠ¶æ€
                            field.style.display = 'block';
                        } else if (fieldName === 'ç±»å‹') {
                            // å°è¯´å’Œæ¼«ç”»éƒ½æ˜¾ç¤ºç±»å‹
                            field.style.display = 'block';
                        } else {
                            // å…¶ä»–å­—æ®µåªæœ‰æ¼«ç”»æ˜¾ç¤º
                            field.style.display = contentType === 'comic' ? 'block' : 'none';
                        }
                    });
                }
            }

            const visibleSelectors = getVisibleSelectorsConfig(contentType);

            // éå†æ‰€æœ‰å­—æ®µ
            fields.forEach(field => {
                // é€šè¿‡data-fieldå±æ€§æŸ¥æ‰¾å­—æ®µå®¹å™¨
                const fieldContainer = form.querySelector(`div[data-field="${field}"]`);
                if (fieldContainer) {
                    // æ ¹æ®å†…å®¹ç±»å‹æ˜¾ç¤ºä¸åŒå­—æ®µ
                    if (contentType === 'novel') {
                        // å°è¯´æ¨¡å¼ï¼šç»Ÿä¸€ä½¿ç”¨æ˜¾ç¤ºé€‰æ‹©å™¨åŠŸèƒ½æ§åˆ¶
                        fieldContainer.style.display = visibleSelectors[field] !== false ? 'block' : 'none';
                    } else if (contentType === 'clip') {
                        // å‰ªè—ç±»å‹åªæ˜¾ç¤ºæ ‡é¢˜å’Œä½œè€…å­—æ®µ
                        fieldContainer.style.display = clipFieldsOnly.includes(field) ? 'block' : 'none';
                    } else {
                        // æ¼«ç”»æ¨¡å¼ï¼šç»Ÿä¸€ä½¿ç”¨æ˜¾ç¤ºé€‰æ‹©å™¨åŠŸèƒ½æ§åˆ¶
                        fieldContainer.style.display = visibleSelectors[field] !== false ? 'block' : 'none';
                    }
                }
            });

            // å¤‡æ³¨å¼€å…³æ˜¾éšï¼šä»…æ¼«ç”»/å°è¯´æ˜¾ç¤ºï¼ˆå¤‡æ³¨å¼€å…³å·²ç§»åŠ¨åˆ°"å…¶ä»–è®¾ç½®"ä¸­ï¼‰
            // æ³¨é‡Šï¼šremarkToggleContainer å˜é‡å·²ä¸å­˜åœ¨ï¼Œå¤‡æ³¨å¼€å…³å·²ç§»åŠ¨åˆ°å…¶ä»–è®¾ç½®
            // if (remarkToggleContainer) {
            //     remarkToggleContainer.style.display = (contentType === 'comic' || contentType === 'novel') ? 'block' : 'none';
            // }
        };

        // æ›´æ–°å­—æ®µæ ‡ç­¾æ˜¾ç¤º
        const updateFieldLabels = (contentType) => {
            console.log('æ›´æ–°å­—æ®µæ ‡ç­¾ï¼Œæ¨¡å¼:', contentType);

            // ç‰¹åˆ«å¤„ç†"ä¹¦å"å­—æ®µçš„æ ‡ç­¾æ›´æ–°
            if (contentType === 'clip') {
                // å‰ªè—æ¨¡å¼ï¼šå°†"ä¹¦å"å­—æ®µæ˜¾ç¤ºä¸º"æ ‡é¢˜"
                const bookNameContainer = document.querySelector('[data-field="ä¹¦å"]');
                if (bookNameContainer) {
                    const label = bookNameContainer.querySelector('label');
                    if (label) {
                        console.log(`å‰ªè—æ¨¡å¼ï¼šå°†"ä¹¦å"æ ‡ç­¾ä» "${label.textContent}" æ›´æ–°ä¸º "æ ‡é¢˜"`);
                        label.textContent = 'æ ‡é¢˜';
                    }
                }
            } else {
                // å…¶ä»–æ¨¡å¼ï¼šå°†"ä¹¦å"å­—æ®µæ˜¾ç¤ºä¸º"ä¹¦å"
                const bookNameContainer = document.querySelector('[data-field="ä¹¦å"]');
                if (bookNameContainer) {
                    const label = bookNameContainer.querySelector('label');
                    if (label) {
                        console.log(`å…¶ä»–æ¨¡å¼ï¼šå°†"ä¹¦å"æ ‡ç­¾ä» "${label.textContent}" æ›´æ–°ä¸º "ä¹¦å"`);
                        label.textContent = 'ä¹¦å';
                    }
                }
            }

            // å¤„ç†å…¶ä»–å­—æ®µï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
            fields.forEach(field => {
                if (field !== 'ä¹¦å') { // è·³è¿‡å·²å¤„ç†çš„"ä¹¦å"å­—æ®µ
                    const fieldContainer = document.querySelector(`[data-field="${field}"]`);
                    if (fieldContainer) {
                        const label = fieldContainer.querySelector('label');
                        if (label) {
                            // å…¶ä»–å­—æ®µä¿æŒåŸæ ·
                            const displayText = field;
                            if (label.textContent !== displayText) {
                                console.log(`å­—æ®µ ${field} æ ‡ç­¾ä» "${label.textContent}" æ›´æ–°ä¸º "${displayText}"`);
                                label.textContent = displayText;
                            }
                        }
                    }
                }
            });

            // åŒæ—¶æ›´æ–°å†…å®¹é€‰æ‹©å™¨æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const contentSelectorContainer = document.getElementById('content-selector-container');
            if (contentSelectorContainer) {
                const contentSelectorLabel = contentSelectorContainer.querySelector('label');
                if (contentSelectorLabel) {
                    // å†…å®¹é€‰æ‹©å™¨æ ‡ç­¾åœ¨æ‰€æœ‰æ¨¡å¼ä¸‹éƒ½ä¿æŒ"å†…å®¹é€‰æ‹©å™¨"
                    contentSelectorLabel.textContent = 'å†…å®¹é€‰æ‹©å™¨';
                }
            }
        };

        // å†…å®¹ç±»å‹å˜æ›´æ—¶æ›´æ–°å­—æ®µå¯è§æ€§
        typeSelect.addEventListener('change', (e) => {
            console.log('ç±»å‹é€‰æ‹©å™¨æ”¹å˜äº‹ä»¶è§¦å‘ï¼Œæ–°å€¼:', e.target.value);
            updateFieldVisibility(e.target.value);
            updateFieldLabels(e.target.value); // æ›´æ–°å­—æ®µæ ‡ç­¾
            // ç¡®ä¿ç±»å‹ç»Ÿä¸€åŒ–é…ç½®å¯è§æ€§ç«‹å³ç”Ÿæ•ˆ
            if (e.target.value === 'clip') {
                const mappingElement = document.getElementById('type-mapping-container');
                if (mappingElement) {
                    mappingElement.style.display = 'none';
                }

                // æŸ¥æ‰¾æ ‡é¢˜å…ƒç´ å¹¶éšè—æ•´ä¸ªå®¹å™¨
                const titles = document.querySelectorAll('h3');
                for (const title of titles) {
                    if (title.textContent.includes('ç±»å‹ç»Ÿä¸€åŒ–é…ç½®')) {
                        const container = title.closest('div');
                        if (container) {
                            container.style.display = 'none';
                        }
                        break;
                    }
                }
            }
        });

        // åˆå§‹åŒ–æ—¶è®¾ç½®å­—æ®µå¯è§æ€§
        setTimeout(() => {
            updateFieldVisibility(typeSelect.value);
            updateFieldLabels(typeSelect.value); // åˆå§‹åŒ–å­—æ®µæ ‡ç­¾
        }, 10);

        fields.forEach(field => {
            const fieldContainer = document.createElement('div');
            fieldContainer.style.marginBottom = '20px';
            fieldContainer.dataset.field = field; // æ·»åŠ data-fieldå±æ€§
            fieldContainer.className = 'selector-field-card';

            const label = document.createElement('label');
            // åœ¨å‰ªè—æ¨¡å¼ä¸‹ï¼Œå°†"ä¹¦å"å­—æ®µæ˜¾ç¤ºä¸º"æ ‡é¢˜"
            const displayText = (field === 'ä¹¦å' && typeSelect.value === 'clip') ? 'æ ‡é¢˜' : field;
            label.textContent = displayText;
            label.style.display = 'block';
            label.style.marginBottom = '8px';
            label.style.fontSize = '14px';
            label.style.fontWeight = '500';

            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'notion-import-input'; // æ·»åŠ è‡ªå®šä¹‰ç±»å
            input.value = existingConfig.selectors[field] || '';
            input.style.padding = '12px';
            input.style.border = '1px solid var(--input-border)';
            input.style.borderRadius = '17px'; // æ¤­åœ†å½¢
            input.dataset.field = field;
            input.placeholder = 'ç•™ç©ºè¡¨ç¤ºä¸æå–æ­¤å­—æ®µ';

            // æ·»åŠ æ§åˆ¶ç»„ - æ•°å­—é€‰æ‹©å™¨å’ŒæŒ‰é’®
            const controlGroup = document.createElement('div');
            controlGroup.className = 'selector-control-group';

            // æ•°å­—é€‰æ‹©å™¨ï¼ˆå¯¹manwa.meéšè—ï¼‰
            const indexInput = document.createElement('input');
            indexInput.type = 'text'; // æ”¹ä¸ºtextç±»å‹ä»¥æ”¯æŒ"all"å€¼
            indexInput.className = 'selector-index-input';
            indexInput.placeholder = 'ç´¢å¼•/all/èŒƒå›´';
            indexInput.title = 'ç´¢å¼•è¯­æ³•: 1=ç¬¬1ä¸ª, 0/last=æœ€åä¸€ä¸ª, -2=å€’æ•°ç¬¬äºŒ, 2,3,5=å¤šé€‰, 2-5=èŒƒå›´, all=å…¨éƒ¨';

            // ä¼˜å…ˆä½¿ç”¨å·²ä¿å­˜çš„é…ç½®ä¸­çš„ç´¢å¼•å€¼ï¼ˆæ‰€æœ‰ç«™ç‚¹å‡æ˜¾ç¤ºç´¢å¼•è¾“å…¥ï¼‰
            if (existingConfig.selectorIndices && existingConfig.selectorIndices[field] !== undefined) {
                indexInput.value = normalizeIndexValue(existingConfig.selectorIndices[field]);
            } else {
                // è®¾ç½®é»˜è®¤ç´¢å¼•å€¼ï¼šæ‰€æœ‰å­—æ®µé»˜è®¤ä¸º"0"
                indexInput.value = "0";
            }

            indexInput.dataset.field = field;
            controlGroup.appendChild(indexInput);

            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'input-group-buttons';

            const pickerBtn = document.createElement('button');
            const pickerIcon = document.createElement('span');
            pickerIcon.className = 'btn-icon';
            pickerIcon.textContent = 'âœ¦';
            pickerBtn.appendChild(pickerIcon);
            pickerBtn.appendChild(document.createTextNode('é€‰æ‹©'));
            pickerBtn.className = 'selector-picker-btn';
            pickerBtn.dataset.field = field;
            try { pickerBtn.dataset.btnType = 'select'; } catch(_) {}
            try { pickerBtn.style.display = GM_getValue('show-select-btn', true) ? '' : 'none'; } catch(_) {}

            pickerBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (selectorTool.isActive) {
                    selectorTool.stopSelection();
                    return;
                }

                document.getElementById('config-dialog').style.display = 'none';
                selectorTool.toggleSelectionMode(e, field);
            });

            const filterBtn = document.createElement('button');
            const filterIcon = document.createElement('span');
            filterIcon.className = 'btn-icon';
            filterIcon.textContent = 'ğŸ”';
            filterBtn.appendChild(filterIcon);
            filterBtn.appendChild(document.createTextNode('è¿‡æ»¤'));
            filterBtn.className = 'filter-btn';
            filterBtn.dataset.field = field;
            filterBtn.dataset.btnType = 'filter';
            try { filterBtn.style.display = GM_getValue('show-filter-btn', true) ? '' : 'none'; } catch(_) { filterBtn.style.display = 'block'; }

            filterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const field = e.target.dataset.field;
                const filterContainer = document.querySelector(`.filter-input-container[data-field="${field}"]`);

                if (filterContainer.style.display === 'block') {
                    filterContainer.style.display = 'none';
                    filterBtn.classList.remove('active');
                } else {
                    filterContainer.style.display = 'block';
                    filterBtn.classList.add('active');
                }
            });

            const testButton = document.createElement('button');
            const testIcon = document.createElement('span');
            testIcon.className = 'btn-icon';
            testIcon.textContent = 'ğŸ«§';
            testButton.appendChild(testIcon);
            testButton.appendChild(document.createTextNode('æµ‹è¯•'));
            testButton.className = 'selector-test-btn';
            testButton.dataset.field = field;
            testButton.dataset.btnType = 'test';
            try { testButton.style.display = GM_getValue('show-test-btn', true) ? '' : 'none'; } catch(_) {}

            const matchCount = document.createElement('span');
            matchCount.style.cssText = 'display:none;color:#6B7280;font-size:12px;margin-left:8px;';
            const highlightBtn = document.createElement('button');
            const highlightIcon = document.createElement('span');
            highlightIcon.className = 'btn-icon';
            highlightIcon.textContent = 'âœ¨';
            highlightBtn.appendChild(highlightIcon);
            highlightBtn.appendChild(document.createTextNode('é«˜äº®'));
            highlightBtn.className = 'selector-test-btn';
            highlightBtn.dataset.btnType = 'highlight';
            try { highlightBtn.style.display = GM_getValue('show-highlight-btn', true) ? '' : 'none'; } catch(_) {}
            const locateBtn = document.createElement('button');
            const locateIcon = document.createElement('span');
            locateIcon.className = 'btn-icon';
            locateIcon.textContent = 'ğŸ“';
            locateBtn.appendChild(locateIcon);
            locateBtn.appendChild(document.createTextNode('å®šä½'));
            locateBtn.className = 'selector-test-btn';
            locateBtn.dataset.btnType = 'locate';
            try { locateBtn.style.display = GM_getValue('show-locate-btn', true) ? '' : 'none'; } catch(_) {}
            let __highlightOn = false;
            let __highlightedEls = [];
            function clearFieldHighlight() {
                __highlightedEls.forEach(el => { try { el.classList.remove('selector-highlight'); el.style.outline=''; el.style.outlineOffset=''; el.style.boxShadow=''; } catch(_){} });
                __highlightedEls = [];
            }
            function refreshFieldHighlight() {
                if (!__highlightOn) return;
                clearFieldHighlight();
                const selector = input.value.trim();
                if (!selector) return;
                try {
                    const elements = document.querySelectorAll(selector);
                    matchCount.textContent = elements.length ? ('åŒ¹é… ' + elements.length + ' ä¸ª') : '';
                    const selection = resolveElementSelection(elements, indexInput.value);
                    const targets = selection.mode === 'single' ? selection.elements : Array.from(selection.elements);
                    targets.forEach(el => { try { el.classList.add('selector-highlight'); __highlightedEls.push(el);} catch(_){} });
                } catch (_) {}
            }
            function updateMatchCountOnly() {
                const selector = input.value.trim();
                if (!selector) { matchCount.textContent = ''; return; }
                try { const elements = document.querySelectorAll(selector); matchCount.textContent = elements.length ? ('åŒ¹é… ' + elements.length + ' ä¸ª') : ''; } catch(_) { matchCount.textContent = ''; }
            }
            highlightBtn.addEventListener('click', () => {
                __highlightOn = !__highlightOn;
                highlightBtn.textContent = __highlightOn ? 'å–æ¶ˆé«˜äº®' : 'é«˜äº®';
                if (__highlightOn) refreshFieldHighlight(); else clearFieldHighlight();
            });
            locateBtn.addEventListener('click', () => {
                const selector = input.value.trim();
                if (!selector) return;
                try {
                    const elements = document.querySelectorAll(selector);
                    const selection = resolveElementSelection(elements, indexInput.value);
                    const el = selection.elements[0];
                    if (el && el.scrollIntoView) el.scrollIntoView({ behavior:'smooth', block:'center' });
                } catch(_){}
            });

            // åˆ›å»ºå®æ—¶é¢„è§ˆå…ƒç´ 
            const livePreview = document.createElement('div');
            livePreview.className = 'selector-live-preview';
            livePreview.dataset.field = field;
            setPreviewBubble(livePreview, 'è¾“å…¥é€‰æ‹©å™¨é¢„è§ˆ');

            // æ·»åŠ åˆå§‹åŒ–é¢„è§ˆï¼Œé’ˆå¯¹å·²æœ‰é€‰æ‹©å™¨
            setTimeout(() => {
                const initialSelector = input.value.trim();
                if (initialSelector) {
                    try {
                        const elements = document.querySelectorAll(initialSelector);
                        if (elements.length > 0) {
                            const selection = resolveElementSelection(elements, indexInput.value);
                            if (selection.mode === 'all') {
                                const textContent = selection.elements
                                .map(el => field === 'ç®€ä»‹' ? convertHtmlToNewlines(el.innerHTML) : el.textContent.trim())
                                .filter(Boolean);
                                const merged = joinTextsWithSeparator(field, textContent);
                                const displayText = merged.substring(0, 50) + (merged.length > 50 ? '...' : '');
                                setPreviewBubble(livePreview, `åˆå¹¶${selection.elements.length}ä¸ªå…ƒç´ : ${displayText}`, merged);
                            } else if (selection.mode === 'multiple') {
                                const textContent = selection.elements
                                .map(el => field === 'ç®€ä»‹' ? convertHtmlToNewlines(el.innerHTML) : el.textContent.trim())
                                .filter(Boolean);
                                const merged = joinTextsWithSeparator(field, textContent);
                                const displayText = merged.substring(0, 50) + (merged.length > 50 ? '...' : '');
                                setPreviewBubble(livePreview, `å¤šé€‰${selection.elements.length}ä¸ª: ${displayText}`, merged);
                            } else if (selection.elements.length) {
                                const element = selection.elements[0];
                                const idx = selection.indices[0] ?? 0;
                                const text = field === 'ç®€ä»‹' ? convertHtmlToNewlines(element.innerHTML) : element.textContent.trim();
                                const snippet = text.substring(0, 50) + (text.length > 50 ? '...' : '');
                                setPreviewBubble(livePreview, `ç¬¬${idx + 1}/${elements.length}ä¸ª: ${snippet}`, text);
                            }
                        }
                    } catch (error) {
                        console.error('åˆå§‹åŒ–é¢„è§ˆå¤±è´¥:', error);
                    }
                }
            }, 100);

            // å®æ—¶é¢„è§ˆæ›´æ–°å‡½æ•°
            // é˜²æŠ–ï¼Œé¿å…ç§»åŠ¨ç«¯è¾“å…¥ all æ—¶é¢„è§ˆæŠ–åŠ¨
            let __updatePreviewTimer;

            function getPreviewTextNode(previewElement) {
                if (!previewElement) return null;
                let span = previewElement.querySelector('.selector-live-preview-text');
                if (!span) {
                    span = document.createElement('span');
                    span.className = 'selector-live-preview-text';
                    previewElement.insertBefore(span, previewElement.firstChild || null);
                }
                return span;
            }

            function updatePreviewText(previewElement) {
                if (!previewElement) return;
                const textNode = getPreviewTextNode(previewElement);
                if (!textNode) return;
                const snippet = previewElement.dataset.snippet ?? '';
                const fullText = previewElement.dataset.fullText ?? snippet;
                const isExpanded = previewElement.dataset.expanded === 'true';
                const shouldShowFull = isExpanded && !!fullText && fullText !== snippet;
                textNode.textContent = shouldShowFull ? fullText : (snippet || fullText || '');
                previewElement.title = (fullText || snippet || '').trim();
                previewElement.classList.toggle('expanded', shouldShowFull);
            }

            function ensurePreviewExpandButton(previewElement) {
                if (!previewElement) return;
                let btn = previewElement.querySelector('.preview-expand-btn');
                if (!btn) {
                    btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'preview-expand-btn';
                    btn.textContent = 'å±•å¼€';
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        const currentlyExpanded = previewElement.dataset.expanded === 'true';
                        previewElement.dataset.expanded = currentlyExpanded ? 'false' : 'true';
                        updatePreviewText(previewElement);
                        btn.textContent = currentlyExpanded ? 'å±•å¼€' : 'æ”¶èµ·';
                    });
                    previewElement.appendChild(btn);
                }

                const snippet = (previewElement.dataset.snippet || '').trim();
                const fullText = (previewElement.dataset.fullText || '').trim();
                const hasDiff = !!fullText && !!snippet && fullText !== snippet;
                btn.style.display = hasDiff ? 'inline-flex' : 'none';
                if (!hasDiff) {
                    previewElement.dataset.expanded = 'false';
                }
                btn.textContent = (previewElement.dataset.expanded === 'true') ? 'æ”¶èµ·' : 'å±•å¼€';
            }


            function setPreviewBubble(previewElement, displayText, fullText) {
                if (!previewElement) return;
                const snippet = displayText === undefined || displayText === null ? '' : String(displayText);
                const resolvedFullText = fullText === undefined || fullText === null ? snippet : String(fullText);
                previewElement.dataset.snippet = snippet;
                previewElement.dataset.fullText = resolvedFullText;
                if (!previewElement.dataset.expanded) {
                    previewElement.dataset.expanded = 'false';
                }
                ensurePreviewExpandButton(previewElement);
                updatePreviewText(previewElement);
            }

            function updateLivePreview(field, selectorInput, indexInput, previewElement) {
                if (__updatePreviewTimer) clearTimeout(__updatePreviewTimer);
                const doWork = () => {
                    const selector = selectorInput.value.trim();

                    // æ·»åŠ æ›´æ–°åŠ¨ç”»
                    previewElement.classList.remove('preview-success', 'preview-error');
                    previewElement.classList.add('preview-updating');

                    if (!selector) {
                        setPreviewBubble(previewElement, 'è¾“å…¥é€‰æ‹©å™¨é¢„è§ˆ');
                        previewElement.classList.remove('preview-updating');
                        return;
                    }

                    try {
                        const elements = document.querySelectorAll(selector);
                        if (elements.length === 0) {
                            setPreviewBubble(previewElement, 'æœªæ‰¾åˆ°åŒ¹é…å…ƒç´ ');
                            previewElement.classList.remove('preview-updating');
                            previewElement.classList.add('preview-error');
                            return;
                        }

                        const selection = resolveElementSelection(elements, indexInput.value);
                        if (!selection.elements.length) {
                            setPreviewBubble(previewElement, 'ç´¢å¼•æœªåŒ¹é…åˆ°å…ƒç´ ');
                            previewElement.classList.remove('preview-updating');
                            previewElement.classList.add('preview-error');
                            return;
                        }

                        if (selection.mode === 'all') {
                            let textContent = selection.elements
                            .map(el => field === 'ç®€ä»‹' ? convertHtmlToNewlines(el.innerHTML) : el.textContent.trim())
                            .filter(Boolean);
                            const merged = joinTextsWithSeparator(field, textContent);
                            let snippet = merged.substring(0, 50);
                            if (merged.length > 50) snippet += '...';
                            setPreviewBubble(previewElement, `åˆå¹¶${selection.elements.length}ä¸ªå…ƒç´ : ${snippet}`, merged);
                        } else if (selection.mode === 'multiple') {
                            let textContent = selection.elements
                            .map(el => field === 'ç®€ä»‹' ? convertHtmlToNewlines(el.innerHTML) : el.textContent.trim())
                            .filter(Boolean);
                            const merged = joinTextsWithSeparator(field, textContent);
                            let snippet = merged.substring(0, 50);
                            if (merged.length > 50) snippet += '...';
                            setPreviewBubble(previewElement, `å¤šé€‰${selection.elements.length}ä¸ª: ${snippet}`, merged);
                        } else {
                            const element = selection.elements[0];
                            const text = field === 'ç®€ä»‹' ? convertHtmlToNewlines(element.innerHTML) : element.textContent.trim();
                            let snippet = text.substring(0, 50);
                            if (text.length > 50) snippet += '...';
                            const idx = selection.indices[0] ?? 0;
                            setPreviewBubble(previewElement, `ç¬¬${idx + 1}/${elements.length}ä¸ª: ${snippet}`, text);
                        }

                        // æ·»åŠ æˆåŠŸçŠ¶æ€
                        previewElement.classList.remove('preview-updating');
                        previewElement.classList.add('preview-success');

                        // å»¶è¿Ÿç§»é™¤æˆåŠŸçŠ¶æ€ï¼Œä¿æŒè§†è§‰åé¦ˆ
                        setTimeout(() => {
                            previewElement.classList.remove('preview-success');
                        }, 2000);

                    } catch (error) {
                        setPreviewBubble(previewElement, 'é€‰æ‹©å™¨æ— æ•ˆ: ' + error.message);
                        previewElement.classList.remove('preview-updating');
                        previewElement.classList.add('preview-error');
                    }
                };
                // ç§»åŠ¨ç«¯æ›´é•¿çš„å»¶è¿Ÿï¼Œå‡å°‘æŠ–åŠ¨
                __updatePreviewTimer = setTimeout(doWork, /Android|iPhone|iPad|Mobile/i.test(navigator.userAgent) ? 220 : 80);
            }

            // ä¸ºé€‰æ‹©å™¨è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œé»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªå…ƒç´ 
            input.addEventListener('input', function() {
                const selector = this.value.trim();
                if (!selector) {
                    setPreviewBubble(livePreview, 'è¾“å…¥é€‰æ‹©å™¨é¢„è§ˆ');
                    matchCount.textContent = '';
                    if (__highlightOn) clearFieldHighlight();
                    return;
                }

                try {
                    const elements = document.querySelectorAll(selector);
                    if (elements.length === 0) {
                        setPreviewBubble(livePreview, 'æœªæ‰¾åˆ°åŒ¹é…å…ƒç´ ');
                        return;
                    }

                    // æ— è®ºç´¢å¼•æ¡†æœ‰æ²¡æœ‰å€¼ï¼Œå…ˆæ˜¾ç¤ºç¬¬ä¸€ä¸ªå…ƒç´ çš„é¢„è§ˆ
                    const element = elements[0];
                    const rawText = field === 'ç®€ä»‹' ? convertHtmlToNewlines(element.innerHTML) : element.textContent.trim();
                    const text = rawText.substring(0, 50) +
                          (rawText.length > 50 ? '...' : '');
                    setPreviewBubble(livePreview, `é»˜è®¤ç¬¬1/${elements.length}ä¸ª: ${text}`, rawText);

                    // ç„¶åæ ¹æ®ç´¢å¼•æ¡†çš„å€¼æ›´æ–°é¢„è§ˆ
                    updateLivePreview(field, input, indexInput, livePreview);
                    updateMatchCountOnly();
                    refreshFieldHighlight();
                } catch (error) {
                    setPreviewBubble(livePreview, 'é€‰æ‹©å™¨æ— æ•ˆ: ' + error.message);
                }
            });

            // ä¸ºç´¢å¼•è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œæ›´æ–°é¢„è§ˆ
            indexInput.addEventListener('input', function() {
                // åªæœ‰å½“é€‰æ‹©å™¨æœ‰å€¼æ—¶æ‰è§¦å‘
                if (input.value.trim()) {
                    updateLivePreview(field, input, indexInput, livePreview);
                    updateMatchCountOnly();
                    refreshFieldHighlight();
                }
            });

            indexInput.addEventListener('change', function() {
                // åªæœ‰å½“é€‰æ‹©å™¨æœ‰å€¼æ—¶æ‰è§¦å‘
                if (input.value.trim()) {
                    updateLivePreview(field, input, indexInput, livePreview);
                    updateMatchCountOnly();
                    refreshFieldHighlight();
                }
            });

            testButton.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const selector = input.value;
                const filterInput = document.querySelector(`.filter-input[data-field="${field}"]`);
                const filterText = filterInput ? filterInput.value : '';

                document.querySelectorAll('.selector-highlight, .selector-hover-highlight').forEach(el => {
                    el.classList.remove('selector-highlight', 'selector-hover-highlight');
                    el.style.outline = '';
                });

                if (!selector) {
                    showNotification('é€‰æ‹©å™¨ä¸ºç©ºï¼Œæ­¤å­—æ®µå°†ç•™ç©º', 'info');
                    return;
                }

                try {
                    const elements = document.querySelectorAll(selector);
                    if (elements.length > 0) {
                        document.getElementById('config-dialog').style.display = 'none';

                        const selection = resolveElementSelection(elements, indexInput.value);
                        if (!selection.elements.length) {
                            showNotification('ç´¢å¼•æœªåŒ¹é…åˆ°å…ƒç´ ', 'warning');
                            document.getElementById('config-dialog').style.display = 'flex';
                            return;
                        }

                        const cleanup = () => {
                            document.getElementById('config-dialog').style.display = 'flex';
                            selection.elements.forEach(el => {
                                el.classList.remove('selector-highlight');
                                el.style.outline = '';
                            });
                        };

                        const applyFilterText = (text) => {
                            if (filterText && text.includes(filterText)) {
                                try {
                                    return text.replace(new RegExp(filterText, 'g'), '');
                                } catch (_) {
                                    return text.replace(filterText, '');
                                }
                            }
                            return text;
                        };

                        if (selection.mode === 'all' || selection.mode === 'multiple') {
                            selection.elements.forEach(el => {
                                el.classList.add('selector-highlight');
                                el.style.outline = '2px solid var(--primarycolor)';
                                el.style.outlineOffset = '2px';
                            });

                            const combinedTexts = selection.elements
                            .map(el => applyFilterText(el.textContent.trim()))
                            .filter(Boolean);
                            const merged = joinTextsWithSeparator(field, combinedTexts);
                            const displayText = merged.substring(0, 30) + (merged.length > 30 ? '...' : '');
                            const modeLabel = selection.mode === 'all' ? 'å…¨éƒ¨å…ƒç´ ' : `é€‰ä¸­çš„ ${selection.elements.length} ä¸ªå…ƒç´ `;

                            showNotification(`æ‰¾åˆ° ${elements.length} ä¸ªåŒ¹é…å…ƒç´ ï¼Œä½¿ç”¨${modeLabel}ï¼š
                                "${displayText}"`, 'success');

                            setTimeout(cleanup, 3000);
                        } else {
                            const element = selection.elements[0];
                            const idx = selection.indices[0] ?? 0;
                            element.classList.add('selector-highlight');
                            element.style.outline = '2px solid var(--primarycolor)';
                            element.style.outlineOffset = '2px';

                            let textContent = applyFilterText(element.textContent.trim());
                            const displayText = textContent.substring(0, 30) +
                                  (textContent.length > 30 ? '...' : '');

                            showNotification(`æ‰¾åˆ° ${elements.length} ä¸ªåŒ¹é…å…ƒç´ ï¼Œä½¿ç”¨ç¬¬ ${idx + 1} ä¸ªï¼š
                                "${displayText}"`, 'success');

                            setTimeout(cleanup, 3000);
                        }
                    } else {
                        showNotification('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å…ƒç´ ', 'error');
                    }
                } catch (error) {
                    showNotification('é€‰æ‹©å™¨æ— æ•ˆ: ' + error.message, 'error');
                }
            });

            buttonsContainer.appendChild(pickerBtn);
            buttonsContainer.appendChild(filterBtn);
            buttonsContainer.appendChild(testButton);
            buttonsContainer.appendChild(highlightBtn);
            buttonsContainer.appendChild(locateBtn);
            buttonsContainer.appendChild(matchCount);
            controlGroup.appendChild(buttonsContainer);

            inputGroup.appendChild(input);

            const filterInputContainer = document.createElement('div');
            filterInputContainer.className = 'filter-input-container';
            filterInputContainer.dataset.field = field;
            filterInputContainer.style.display = 'none';

            const filterInput = document.createElement('input');
            filterInput.type = 'text';
            filterInput.className = 'filter-input';
            filterInput.placeholder = 'è¾“å…¥è¦è¿‡æ»¤çš„æ–‡æœ¬æˆ–æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¦‚: /æ ‡é¢˜:.*/ æˆ– (\\d+) ç”¨äºæå–æ•°å­—';
            filterInput.dataset.field = field;
            filterInput.value = existingConfig.selectors[`${field}_filter`] || '';

            // æ·»åŠ è¿‡æ»¤æ¨¡å¼é€‰æ‹©
            const filterModeContainer = document.createElement('div');
            filterModeContainer.className = 'filter-mode-container';

            const filterModeText = document.createElement('span');
            filterModeText.className = 'filter-mode-text';
            filterModeText.textContent = 'è¿‡æ»¤æ¨¡å¼: ';

            const filterModeSelect = document.createElement('select');
            filterModeSelect.className = 'filter-mode-select';
            filterModeSelect.dataset.field = field;

            const modeOptions = [
                { value: 'remove', text: 'åˆ é™¤åŒ¹é…æ–‡æœ¬' },
                { value: 'regex', text: 'ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼' },
                { value: 'extract', text: 'æå–åŒ¹é…å†…å®¹' }
            ];

            modeOptions.forEach(option => {
                const optionEl = document.createElement('option');
                optionEl.value = option.value;
                optionEl.textContent = option.text;
                if (existingConfig.selectors[`${field}_filter_mode`] === option.value) {
                    optionEl.selected = true;
                }
                filterModeSelect.appendChild(optionEl);
            });

            // å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡æ¨¡å¼ï¼Œé»˜è®¤ä¸ºåˆ é™¤æ¨¡å¼
            if (!existingConfig.selectors[`${field}_filter_mode`]) {
                filterModeSelect.value = 'remove';
            }

            filterModeContainer.appendChild(filterModeText);
            filterModeContainer.appendChild(filterModeSelect);

            // æ·»åŠ è¿‡æ»¤é¢„è§ˆå’Œæµ‹è¯•æŒ‰é’®
            const filterPreview = document.createElement('div');
            filterPreview.className = 'filter-preview';
            filterPreview.dataset.field = field;
            filterPreview.textContent = 'è¿‡æ»¤é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º';

            const filterTestBtn = document.createElement('button');
            filterTestBtn.className = 'filter-test-btn';
            filterTestBtn.textContent = 'æµ‹è¯•è¿‡æ»¤';
            filterTestBtn.dataset.field = field;

            filterTestBtn.addEventListener('click', (e) => {
                e.preventDefault();

                const field = e.target.dataset.field;
                const selector = document.querySelector(`input[data-field="${field}"]`).value;
                const filterText = filterInput.value;
                const filterMode = filterModeSelect.value;

                if (!selector || !filterText) {
                    filterPreview.textContent = 'è¯·å…ˆè¾“å…¥é€‰æ‹©å™¨å’Œè¿‡æ»¤æ¡ä»¶';
                    return;
                }

                try {
                    const elements = document.querySelectorAll(selector);
                    if (elements.length === 0) {
                        filterPreview.textContent = 'é€‰æ‹©å™¨æœªåŒ¹é…åˆ°å…ƒç´ ';
                        return;
                    }

                    const indexInputEl = document.querySelector(`.selector-index-input[data-field="${field}"]`);
                    const selection = resolveElementSelection(elements, indexInputEl ? indexInputEl.value : '0');
                    if (!selection.elements.length) {
                        filterPreview.textContent = 'ç´¢å¼•æœªåŒ¹é…åˆ°å…ƒç´ ';
                        return;
                    }

                    const textExtractor = (el) => {
                        const raw = field === 'ç®€ä»‹' ? el.innerHTML : el.textContent;
                        return (raw || '').trim();
                    };

                    const originalSegments = selection.elements
                    .map(textExtractor)
                    .filter(text => text.length > 0);

                    let originalText = selection.mode === 'single' ? (originalSegments[0] || '') : originalSegments.join('\n');
                    if (!originalText) {
                        filterPreview.textContent = 'æœªè·å–åˆ°å¯ç”¨äºè¿‡æ»¤çš„æ–‡æœ¬å†…å®¹';
                        return;
                    }

                    const escapeHtml = (s) => String(s).replace(/[&<>]/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
                    const asRegex = (src) => {
                        const m = src.match(/^\/(.*?)\/([gimuy]*)$/);
                        if (m) return new RegExp(m[1], m[2] || 'g');
                        return new RegExp(src, 'g');
                    };

                    let filteredText = originalText;
                    let regex = null;
                    let matches = [];
                    try { regex = asRegex(filterText); } catch (regexError) {
                        filterPreview.textContent = `æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯: ${regexError.message}`;
                        return;
                    }

                    if (filterMode === 'remove') {
                        filteredText = originalText.replace(regex, '');
                        matches = Array.from(originalText.matchAll(regex)).map(m => m[0]);
                    } else if (filterMode === 'regex') {
                        filteredText = originalText.replace(regex, '');
                        matches = Array.from(originalText.matchAll(regex)).map(m => m[0]);
                    } else if (filterMode === 'extract') {
                        const arr = [];
                        let m;
                        while ((m = regex.exec(originalText)) !== null) {
                            arr.push((m[1] || m[0]).trim());
                        }
                        matches = arr;
                        filteredText = matches.length > 0 ? joinTextsWithSeparator(field, matches) : originalText;
                    }

                    const highlightMatches = (text, regex) => {
                        try {
                            return escapeHtml(text).replace(regex, (m) => `<mark style="background: var(--primarycolor-lighter); color:#111827; border-radius: 20px; padding:0 2px;">${escapeHtml(m)}</mark>`);
                        } catch(_) { return escapeHtml(text); }
                    };

                    const originalHtml = (filterMode === 'extract') ? escapeHtml(originalText) : highlightMatches(originalText, asRegex(filterText));
                    const filteredHtml = escapeHtml(filteredText);
                    const count = matches.length;

                    const modeLabel = (function(m){
                        if (m === 'remove') return 'åˆ é™¤åŒ¹é…';
                        if (m === 'regex') return 'æ­£åˆ™æ›¿æ¢';
                        if (m === 'extract') return 'æå–å†…å®¹';
                        return String(m);
                    })(filterMode);
                    const chipsHtml = (matches||[]).slice(0,8).map(x => `<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border:1px solid rgba(229,231,235,0.85);border-radius:999px;background:#FFF;box-shadow:0 2px 6px rgba(0,0,0,.04);font-size:12px;color:#0F172A;">${escapeHtml(x)}</span>`).join(' ');
                    setSafeHtml(filterPreview, `
                        <div style="display:grid; grid-template-columns: repeat(${window.innerWidth>768?2:1}, 1fr); gap:12px;">
                            <div style="grid-column: 1 / -1; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border:1px solid rgba(229,231,235,0.85); border-radius: 20px; background: linear-gradient(180deg, #FFFFFF 0%, #F8FAFC 100%);">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)) ; color:white; font-size:12px; border:none;">æ¨¡å¼ï¼š${modeLabel}</span>
                                <span style="display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:var(--primarycolor-lighter); color:var(--primarycolor); font-size:12px; border:1px solid var(--primarycolor);">åŒ¹é…ï¼š<strong style="color:var(--primarycolor)">${count}</strong></span>
                            </div>
                            <div style="display:flex; gap:6px;">
                                <button class="copy-original" style="padding:6px 10px; border-radius: 20px; border:1px solid rgba(229,231,235,0.85); background:#fff; cursor:pointer; font-size:12px; color:#111827;">å¤åˆ¶åŸæ–‡</button>
                                <button class="copy-filtered" style="padding:6px 10px; border-radius: 20px; border:none; background: linear-gradient(135deg, var(--primarycolor,#FF6B9D), var(--primarycolor-dark,#FF8FAB)); cursor:pointer; font-size:12px; color:#fff; box-shadow: 0 2px 8px var(--primarycolor-lighter);">å¤åˆ¶ç»“æœ</button>
                            </div>
                            </div>
                            <div style="border:1px solid #E5E7EB !important; border-radius: 20px; padding:10px; background:#FFFFFF;">
                            <div style="font-size:12px; color:#6B7280; margin-bottom:6px; display:flex; align-items:center; justify-content:space-between;">
                                <span>è¿‡æ»¤å‰</span>
                            </div>
                            <div style="font-size:13px; color:#111827; white-space:pre-wrap; word-break:break-all; line-height:1.6;">${originalHtml}</div>
                            ${chipsHtml ? `<div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;">${chipsHtml}</div>` : ''}
                            </div>
                            <div style="border:1px solid #E5E7EB !important; border-radius: 20px; padding:10px; background:#F9FAFB;">
                            <div style="font-size:12px; color:#6B7280; margin-bottom:6px;">è¿‡æ»¤å</div>
                            <div style="font-size:13px; color:#111827; white-space:pre-wrap; word-break:break-all; line-height:1.6;">${filteredHtml}</div>
                            </div>
                        </div>
                        `);

                    try {
                        const copyOriginalBtn = filterPreview.querySelector('.copy-original');
                        const copyFilteredBtn = filterPreview.querySelector('.copy-filtered');
                        if (copyOriginalBtn) copyOriginalBtn.onclick = () => { try { if (typeof GM_setClipboard === 'function') GM_setClipboard(originalText); else navigator.clipboard?.writeText(originalText); } catch(_){} };
                        if (copyFilteredBtn) copyFilteredBtn.onclick = () => { try { if (typeof GM_setClipboard === 'function') GM_setClipboard(filteredText); else navigator.clipboard?.writeText(filteredText); } catch(_){} };
                    } catch(_) {}

                } catch (error) {
                    filterPreview.textContent = `æµ‹è¯•å¤±è´¥: ${error.message}`;
                }
            });

            // å¸®åŠ©å‡½æ•°ï¼šè½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            filterInputContainer.appendChild(filterInput);
            filterInputContainer.appendChild(filterModeContainer);
            filterInputContainer.appendChild(filterPreview);
            filterInputContainer.appendChild(filterTestBtn);

            fieldContainer.appendChild(label);
            fieldContainer.appendChild(inputGroup);
            fieldContainer.appendChild(controlGroup);
            fieldContainer.appendChild(livePreview); // æ·»åŠ å®æ—¶é¢„è§ˆå…ƒç´ 
            fieldContainer.appendChild(filterInputContainer);
            form.appendChild(fieldContainer);
        });

        // æ·»åŠ å‰ªè—å†…å®¹é€‰æ‹©å™¨ï¼ˆé»˜è®¤éšè—ï¼‰ - ç°æ”¯æŒå¤šä¸ª
        const contentSelectorContainer = document.createElement('div');
        contentSelectorContainer.id = 'content-selector-container';
        contentSelectorContainer.style.marginBottom = '20px';
        contentSelectorContainer.style.display = 'none'; // é»˜è®¤éšè—
        contentSelectorContainer.className = 'selector-section-card';

        const contentSelectorLabel = document.createElement('label');
        contentSelectorLabel.textContent = 'å†…å®¹é€‰æ‹©å™¨';
        contentSelectorLabel.style.display = 'block';
        contentSelectorLabel.style.marginBottom = '8px';
        contentSelectorLabel.style.fontWeight = '500';

        const contentSelectorDesc = document.createElement('p');
        contentSelectorDesc.textContent = 'è¾“å…¥è¦å‰ªè—çš„å†…å®¹åŒºåŸŸçš„CSSé€‰æ‹©å™¨';
        contentSelectorDesc.style.fontSize = '13px';
        contentSelectorDesc.style.marginBottom = '8px';

        const contentSelectorsList = document.createElement('div');
        contentSelectorsList.id = 'content-selectors-list';
        contentSelectorsList.style.display = 'flex';
        contentSelectorsList.style.flexDirection = 'column';
        contentSelectorsList.style.gap = '8px';

        function createContentSelectorRow(value = '') {
            const row = document.createElement('div');
            row.className = 'input-group';
            row.style.display = 'flex';
            row.style.gap = '8px';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'notion-import-input content-selector-input';
            input.placeholder = 'ä¾‹å¦‚ï¼š#content, .article-content, main';
            input.style.width = '100%';
            input.style.padding = '10px';
            input.style.height = '42px';
            input.style.lineHeight = '22px';
            input.style.fontSize = '14px';
            input.style.border = '1px solid #ddd';
            input.style.borderRadius = '17px';
            input.style.boxSizing = 'border-box';
            input.value = value || '';
            input.setAttribute('data-field', 'contentSelector');
            // èšç„¦æ—¶å°†è¯¥è¾“å…¥æ ‡è®°ä¸ºå½“å‰å†…å®¹é€‰æ‹©å™¨è¾“å…¥ï¼ˆç”¨äºè‡ªåŠ¨å¡«å……ï¼‰
            input.addEventListener('focus', () => {
                try {
                    const prev = document.getElementById('content-selector-input');
                    if (prev && prev !== input) prev.removeAttribute('id');
                    input.id = 'content-selector-input';
                } catch(_){}
            });
            // å¦‚æœå½“å‰è¿˜æ²¡æœ‰æ ‡è®°çš„è¾“å…¥ï¼Œç»™é¦–ä¸ªåˆ›å»ºçš„èµ‹äºˆidï¼Œä¾¿äºè‡ªåŠ¨å¡«å……
            if (!document.getElementById('content-selector-input')) {
                input.id = 'content-selector-input';
            }

            const btns = document.createElement('div');
            btns.className = 'input-group-buttons';

            const pickBtn = document.createElement('button');
            pickBtn.className = 'selector-picker-btn';
            try { pickBtn.dataset.btnType = 'select'; } catch(_) {}
            pickBtn.textContent = 'é€‰æ‹©';
            pickBtn.addEventListener('click', (e) => {
                document.getElementById('config-dialog').style.display = 'none';
                // æ ‡è®°å½“å‰è¡Œçš„è¾“å…¥ä¸ºæ´»åŠ¨è¾“å…¥ï¼Œä¾›é€‰æ‹©å™¨å›å¡«
                try {
                    const prev = document.getElementById('content-selector-input');
                    if (prev && prev !== input) prev.removeAttribute('id');
                    input.id = 'content-selector-input';
                } catch(_){}
                selectorTool.toggleSelectionMode(e, 'contentSelector');
            });

            const testBtn = document.createElement('button');
            testBtn.className = 'selector-test-btn';
            testBtn.textContent = 'é¢„è§ˆ';
            try { testBtn.dataset.btnType = 'test'; } catch(_) {}
            testBtn.addEventListener('click', () => {
                const selector = input.value.trim();
                if (!selector) {
                    showNotification('è¯·å…ˆè¾“å…¥é€‰æ‹©å™¨', 'error');
                    return;
                }
                try {
                    const elements = document.querySelectorAll(selector);
                    if (elements.length === 0) {
                        showNotification('æœªæ‰¾åˆ°åŒ¹é…å†…å®¹', 'error');
                        return;
                    }
                    let contentPreview = '';
                    elements.forEach(el => {
                        let text = el.innerText || el.textContent;
                        if (text) {
                            text = text.trim().substring(0, 100);
                            contentPreview += text + (text.length > 100 ? '...\n' : '\n');
                        }
                    });
                    showNotification(`é¢„è§ˆå†…å®¹:\n${contentPreview}`, 'info');
                } catch (error) {
                    showNotification('é€‰æ‹©å™¨æ— æ•ˆ: ' + error.message, 'error');
                }
            });

            const removeBtn = document.createElement('button');
            removeBtn.className = 'selector-test-btn';
            removeBtn.textContent = 'åˆ é™¤';
            removeBtn.addEventListener('click', () => {
                contentSelectorsList.removeChild(row);
            });

            btns.appendChild(pickBtn);
            btns.appendChild(testBtn);
            btns.appendChild(removeBtn);
            row.appendChild(input);
            row.appendChild(btns);
            return row;
        }

        // åˆå§‹åŒ–ï¼ˆå…¼å®¹æ—§é…ç½®ï¼‰
        const existingSelectors = Array.isArray(existingConfig.contentSelectors)
        ? existingConfig.contentSelectors
        : (existingConfig.contentSelector ? [existingConfig.contentSelector] : []);
        if (existingSelectors.length > 0) {
            existingSelectors.forEach(sel => contentSelectorsList.appendChild(createContentSelectorRow(sel)));
        } else {
            contentSelectorsList.appendChild(createContentSelectorRow(''));
        }

        const addSelectorBtn = document.createElement('button');
        addSelectorBtn.className = 'selector-picker-btn';
        try { addSelectorBtn.dataset.btnType = 'select'; } catch(_) {}
        addSelectorBtn.textContent = 'ï¼‹ æ·»åŠ å†…å®¹é€‰æ‹©å™¨';
        addSelectorBtn.style.marginTop = '8px';
        addSelectorBtn.addEventListener('click', () => {
            contentSelectorsList.appendChild(createContentSelectorRow(''));
        });

        // é€‰æ‹©å™¨æŒ‰é’®ç»„
        const contentSelectorBtnGroup = document.createElement('div');
        contentSelectorBtnGroup.className = 'input-group-buttons';
        contentSelectorBtnGroup.style.marginTop = '10px';

        const contentSelectorPickerBtn = document.createElement('button');
        contentSelectorPickerBtn.className = 'selector-picker-btn';
        contentSelectorPickerBtn.textContent = 'é€‰æ‹©å…ƒç´ ';
        contentSelectorPickerBtn.addEventListener('click', (e) => {
            document.getElementById('config-dialog').style.display = 'none';
            selectorTool.toggleSelectionMode(e, 'contentSelector');
        });
        try { contentSelectorPickerBtn.dataset.btnType = 'select'; } catch(_) {}
        try { contentSelectorPickerBtn.style.display = GM_getValue('show-select-btn', true) ? '' : 'none'; } catch(_) {}

        const contentSelectorTestBtn = document.createElement('button');
        contentSelectorTestBtn.className = 'selector-test-btn';
        contentSelectorTestBtn.textContent = 'é¢„è§ˆå†…å®¹';
        try { contentSelectorTestBtn.dataset.btnType = 'test'; } catch(_) {}
        try { contentSelectorTestBtn.style.display = GM_getValue('show-test-btn', true) ? '' : 'none'; } catch(_) {}
        contentSelectorTestBtn.addEventListener('click', () => {
            const selector = contentSelectorInput.value.trim();
            if (!selector) {
                showNotification('è¯·å…ˆè¾“å…¥é€‰æ‹©å™¨', 'error');
                return;
            }

            try {
                const elements = document.querySelectorAll(selector);
                if (elements.length === 0) {
                    showNotification('æœªæ‰¾åˆ°åŒ¹é…å†…å®¹', 'error');
                    return;
                }

                let contentPreview = '';
                elements.forEach(el => {
                    // æå–æ–‡æœ¬å†…å®¹
                    let text = el.innerText || el.textContent;
                    if (text) {
                        text = text.trim().substring(0, 100);
                        contentPreview += text + (text.length > 100 ? '...\n' : '\n');
                    }

                    // æŸ¥æ‰¾å›¾ç‰‡
                    const images = el.querySelectorAll('img');
                    if (images.length > 0) {
                        contentPreview += `[åŒ…å« ${images.length} å¼ å›¾ç‰‡]\n`;
                    }

                    if (contentData.videos && contentData.videos.length > 0) {
                        contentPreview += `[åŒ…å« ${contentData.videos.length} ä¸ªè§†é¢‘]\n`;
                    }
                });

                showNotification(`é¢„è§ˆå†…å®¹:\n${contentPreview}`, 'info');
            } catch (error) {
                showNotification('é€‰æ‹©å™¨æ— æ•ˆ: ' + error.message, 'error');
            }
        });

        contentSelectorBtnGroup.appendChild(contentSelectorPickerBtn);
        contentSelectorBtnGroup.appendChild(contentSelectorTestBtn);

        contentSelectorContainer.appendChild(contentSelectorLabel);
        contentSelectorContainer.appendChild(contentSelectorDesc);
        contentSelectorContainer.appendChild(contentSelectorsList);
        contentSelectorContainer.appendChild(addSelectorBtn);
        form.appendChild(contentSelectorContainer);

        // æ·»åŠ å‰ªè—æ’é™¤é€‰æ‹©å™¨ï¼ˆé»˜è®¤éšè—ï¼Œå¯æ·»åŠ å¤šä¸ªï¼‰
        const excludeSelectorsContainer = document.createElement('div');
        excludeSelectorsContainer.id = 'exclude-selectors-container';
        excludeSelectorsContainer.style.marginBottom = '20px';
        excludeSelectorsContainer.style.display = 'none';
        excludeSelectorsContainer.className = 'selector-section-card';

        const excludeSelectorsLabel = document.createElement('label');
        excludeSelectorsLabel.textContent = 'ä¸å¯¼å…¥çš„å†…å®¹é€‰æ‹©å™¨';
        excludeSelectorsLabel.style.display = 'block';
        excludeSelectorsLabel.style.marginBottom = '8px';
        excludeSelectorsLabel.style.fontWeight = '500';

        const excludeSelectorsDesc = document.createElement('p');
        excludeSelectorsDesc.textContent = 'å¡«å†™åœ¨å‰ªè—å†…å®¹åŒºåŸŸä¸­éœ€è¦æ’é™¤ï¼ˆä¸å¯¼å…¥ï¼‰çš„å…ƒç´ é€‰æ‹©å™¨ï¼Œç‚¹å‡»å³ä¾§"+"å¯æ·»åŠ å¤šä¸ªã€‚';
        excludeSelectorsDesc.style.fontSize = '13px';
        excludeSelectorsDesc.style.marginBottom = '8px';

        const excludeList = document.createElement('div');
        excludeList.id = 'exclude-selectors-list';
        excludeList.style.display = 'flex';
        excludeList.style.flexDirection = 'column';
        excludeList.style.gap = '8px';

        function createExcludeRow(value = '') {
            const row = document.createElement('div');
            row.className = 'input-group';
            row.style.display = 'flex';
            row.style.gap = '8px';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'notion-import-input exclude-selector-input';
            input.placeholder = 'ä¾‹å¦‚ï¼š.ad, .share, .copyright, script, style';
            input.style.width = '100%';
            input.style.padding = '10px';
            input.style.height = '42px';
            input.style.lineHeight = '22px';
            input.style.fontSize = '14px';
            input.style.border = '1px solid #ddd';
            input.style.boxSizing = 'border-box';
            input.value = value || '';

            const btns = document.createElement('div');
            btns.className = 'input-group-buttons';

            const pickBtn = document.createElement('button');
            pickBtn.className = 'selector-picker-btn';
            pickBtn.textContent = 'é€‰æ‹©å…ƒç´ ';
            pickBtn.addEventListener('click', (e) => {
                try {
                    document.querySelectorAll('#exclude-selectors-list .exclude-selector-input').forEach(el => { try { delete el.dataset.activeExclude; } catch(_){} });
                    input.dataset.activeExclude = '1';
                } catch(_) {}
                const cfg = document.getElementById('config-dialog');
                if (cfg) cfg.style.display = 'none';
                if (selectorTool && typeof selectorTool.toggleSelectionMode === 'function') {
                    selectorTool.toggleSelectionMode(e, 'excludeSelector');
                }
            });

            const removeBtn = document.createElement('button');
            removeBtn.className = 'selector-test-btn';
            removeBtn.textContent = 'åˆ é™¤';
            removeBtn.addEventListener('click', () => row.remove());

            btns.appendChild(pickBtn);
            btns.appendChild(removeBtn);
            row.appendChild(input);
            row.appendChild(btns);
            return row;
        }

        // å·²æœ‰é…ç½®å›å¡«
        const existingExclude = Array.isArray(existingConfig.clipExcludeSelectors) ? existingConfig.clipExcludeSelectors : [];
        if (existingExclude.length > 0) {
            existingExclude.forEach(sel => excludeList.appendChild(createExcludeRow(sel)));
        } else {
            excludeList.appendChild(createExcludeRow(''));
        }

        const addExcludeBtn = document.createElement('button');
        addExcludeBtn.className = 'selector-picker-btn';
        addExcludeBtn.textContent = 'ï¼‹ æ·»åŠ æ’é™¤é€‰æ‹©å™¨';
        addExcludeBtn.style.marginTop = '8px';
        addExcludeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            excludeList.appendChild(createExcludeRow(''));
        });

        excludeSelectorsContainer.appendChild(excludeSelectorsLabel);
        excludeSelectorsContainer.appendChild(excludeSelectorsDesc);
        excludeSelectorsContainer.appendChild(excludeList);
        excludeSelectorsContainer.appendChild(addExcludeBtn);
        form.appendChild(excludeSelectorsContainer);

        // æ·»åŠ å‰ªè—ç±»å‹é€‰æ‹©å™¨é…ç½®ï¼ˆé»˜è®¤éšè—ï¼‰
        const clipTypeSelectorContainer = document.createElement('div');
        clipTypeSelectorContainer.id = 'clip-type-selector-container';
        clipTypeSelectorContainer.style.marginBottom = '20px';
        clipTypeSelectorContainer.style.display = 'none'; // é»˜è®¤éšè—

        const clipTypeSelectorLabel = document.createElement('label');
        clipTypeSelectorLabel.textContent = 'ç±»å‹é€‰æ‹©å™¨';
        clipTypeSelectorLabel.style.display = 'block';
        clipTypeSelectorLabel.style.marginBottom = '8px';
        clipTypeSelectorLabel.style.fontWeight = '500';

        const clipTypeSelectorDesc = document.createElement('p');
        clipTypeSelectorDesc.textContent = 'è¾“å…¥ç±»å‹å­—æ®µçš„CSSé€‰æ‹©å™¨ï¼ˆå¯é€‰ï¼Œä¸è®¾ç½®å°†å¼¹å‡ºç±»å‹é€‰æ‹©çª—å£ï¼‰';
        clipTypeSelectorDesc.style.fontSize = '13px';
        clipTypeSelectorDesc.style.marginBottom = '8px';

        // æ·»åŠ ç±»å‹é€‰æ‹©å™¨å¼€å…³
        const typeSelectorToggleContainer = document.createElement('div');
        typeSelectorToggleContainer.style.marginBottom = '12px';
        typeSelectorToggleContainer.style.padding = '16px';
        typeSelectorToggleContainer.style.border = '1px solid #e5e7eb';
        typeSelectorToggleContainer.style.borderRadius = '20px';

        const typeSelectorCheckboxContainer = createCustomCheckbox(
            'clip-type-selector-toggle',
            existingConfig.enableTypeSelector !== undefined ? existingConfig.enableTypeSelector : true,
            'å¯ç”¨ç±»å‹é€‰æ‹©å™¨ï¼ˆå‹¾é€‰æ—¶ä½¿ç”¨ç±»å‹é€‰æ‹©å™¨å¼¹çª—ç•Œé¢ï¼Œä¸å‹¾é€‰æ—¶ä½¿ç”¨è¾“å…¥é€‰æ‹©å™¨ï¼‰'
        );
        typeSelectorToggleContainer.appendChild(typeSelectorCheckboxContainer);

        // åˆ›å»ºè¾“å…¥æ¡†å®¹å™¨
        const clipTypeSelectorInputGroup = document.createElement('div');
        clipTypeSelectorInputGroup.style.cssText = `
            display: flex;
            gap: 8px;
            align-items: center;
        `;
        const clipTypeSelectorInput = document.createElement('input');
        clipTypeSelectorInput.type = 'text';
        clipTypeSelectorInput.id = 'clip-type-selector-input';
        clipTypeSelectorInput.className = 'notion-import-input';
        clipTypeSelectorInput.value = existingConfig.clipTypeSelector || '';
        clipTypeSelectorInput.placeholder = 'ä¾‹å¦‚ï¼š.type, .category, [data-type]';
        clipTypeSelectorInput.style.flex = '1';
        clipTypeSelectorInput.style.padding = '10px';
        clipTypeSelectorInput.style.height = '42px';
        clipTypeSelectorInput.style.lineHeight = '22px';
        clipTypeSelectorInput.style.fontSize = '14px';
        clipTypeSelectorInput.style.border = '1px solid #ddd';
        clipTypeSelectorInput.style.borderRadius = '17px';
        clipTypeSelectorInput.style.backgroundColor = '#f8f9fa';
        clipTypeSelectorInput.style.boxSizing = 'border-box';

        // åˆ›å»ºå¯è§†åŒ–é€‰æ‹©å™¨æŒ‰é’®
        const clipTypeSelectorPickerBtn = document.createElement('button');
        const clipTypeIcon = document.createElement('span');
        clipTypeIcon.className = 'btn-icon';
        clipTypeIcon.textContent = 'âœ¦';
        clipTypeSelectorPickerBtn.appendChild(clipTypeIcon);
        clipTypeSelectorPickerBtn.appendChild(document.createTextNode('é€‰æ‹©'));
        clipTypeSelectorPickerBtn.className = 'selector-picker-btn';
        clipTypeSelectorPickerBtn.style.cssText = `
            padding: 10px 16px;
            height: 42px;
            border: 1px solid #ddd;
            border-radius: 17px;
            background: linear-gradient(135deg, var(--primarycolor-light, var(--primarycolor, #FF8FAB)) 0%, var(--primarycolor, var(--primarycolor-dark, #FF6B9D)) 100%);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 4px var(--primarycolor-lighter);
        `;

        // æŒ‰é’®æ‚¬åœæ•ˆæœ
        clipTypeSelectorPickerBtn.addEventListener('mouseenter', () => {
            clipTypeSelectorPickerBtn.style.background = 'linear-gradient(135deg, var(--primarycolor, #FF6B9D) 0%, var(--primarycolor-dark, #FF5184) 100%)';
            clipTypeSelectorPickerBtn.style.transform = 'translateY(-1px)';
            clipTypeSelectorPickerBtn.style.boxShadow = '0 4px 8px var(--primarycolor-lighter)';
        });

        clipTypeSelectorPickerBtn.addEventListener('mouseleave', () => {
            clipTypeSelectorPickerBtn.style.background = 'linear-gradient(135deg, var(--primarycolor-light, #FF8FAB) 0%, var(--primarycolor, #FF6B9D) 100%)';
            clipTypeSelectorPickerBtn.style.transform = 'translateY(0)';
            clipTypeSelectorPickerBtn.style.boxShadow = '0 2px 4px var(--primarycolor-lighter)';
        });

        // æ·»åŠ é€‰æ‹©å™¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        clipTypeSelectorPickerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            if (selectorTool && typeof selectorTool.toggleSelectionMode === 'function') {
                // éšè—é…ç½®å¯¹è¯æ¡†
                document.getElementById('config-dialog').style.display = 'none';
                // å¯åŠ¨é€‰æ‹©å™¨å·¥å…·ï¼Œä½¿ç”¨ç‰¹æ®Šå­—æ®µå 'clipTypeSelector'
                selectorTool.toggleSelectionMode(e, 'clipTypeSelector');
            }
        });

        // å°†è¾“å…¥æ¡†å’ŒæŒ‰é’®æ·»åŠ åˆ°å®¹å™¨
        clipTypeSelectorInputGroup.appendChild(clipTypeSelectorInput);
        clipTypeSelectorInputGroup.appendChild(clipTypeSelectorPickerBtn);

        // åˆ›å»ºé¢„è§ˆåŒºåŸŸ - ä¸å…¶ä»–é¢„è§ˆæ ·å¼ä¿æŒä¸€è‡´
        const previewContainer = document.createElement('div');
        previewContainer.id = 'clip-type-selector-preview';
        previewContainer.className = 'selector-live-preview';
        previewContainer.style.cssText = `
            margin-top: 8px;
            padding: 8px 12px;
            background: #F7FAFC;
            border: 1px solid #E2E8F0;
            font-size: 13px;
            color: #4A5568;
            min-height: 20px;
            display: none;
            transition: all 0.3s ease;
            position: relative;
        `;

        // é¢„è§ˆå†…å®¹ - ç›´æ¥æ˜¾ç¤ºå†…å®¹ï¼Œä¸æ˜¾ç¤º"é¢„è§ˆï¼š"æ ‡ç­¾
        const previewContent = document.createElement('span');
        previewContent.id = 'clip-type-selector-preview-content';
        previewContent.style.cssText = `
            color: #4A5568;
        `;

        previewContainer.appendChild(previewContent);

        // æ›´æ–°é¢„è§ˆå†…å®¹çš„å‡½æ•° - ä¸å…¶ä»–é¢„è§ˆä¿æŒä¸€è‡´
        function updatePreview() {
            const selector = clipTypeSelectorInput.value.trim();

            // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€
            previewContainer.classList.remove('preview-success', 'preview-error');

            if (selector) {
                // æ·»åŠ æ›´æ–°åŠ¨ç”»
                previewContainer.classList.add('preview-updating');
                previewContainer.style.display = 'block';

                try {
                    const elements = document.querySelectorAll(selector);
                    if (elements.length > 0) {
                        const previews = Array.from(elements).slice(0, 3).map(el => {
                            const text = el.textContent?.trim() || el.innerText?.trim() || '';
                            return text.length > 20 ? text.substring(0, 20) + '...' : text;
                        }).filter(text => text);

                        if (previews.length > 0) {
                            previewContent.textContent = `æ‰¾åˆ°${elements.length}ä¸ªå…ƒç´ : ${previews.join(', ')}`;
                            previewContainer.classList.remove('preview-updating');
                            previewContainer.classList.add('preview-success');

                            // å»¶è¿Ÿç§»é™¤æˆåŠŸçŠ¶æ€
                            setTimeout(() => {
                                previewContainer.classList.remove('preview-success');
                            }, 2000);
                        } else {
                            previewContent.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„å…ƒç´ ';
                            previewContainer.classList.remove('preview-updating');
                            previewContainer.classList.add('preview-error');
                        }
                    } else {
                        previewContent.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„å…ƒç´ ';
                        previewContainer.classList.remove('preview-updating');
                        previewContainer.classList.add('preview-error');
                    }
                } catch (error) {
                    previewContent.textContent = 'é€‰æ‹©å™¨æ— æ•ˆ: ' + error.message;
                    previewContainer.classList.remove('preview-updating');
                    previewContainer.classList.add('preview-error');
                }
            } else {
                previewContent.textContent = 'è¾“å…¥é€‰æ‹©å™¨é¢„è§ˆ';
                previewContainer.style.display = 'none';
            }
        }

        // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–
        clipTypeSelectorInput.addEventListener('input', updatePreview);
        clipTypeSelectorInput.addEventListener('blur', updatePreview);

        // æ·»åŠ å¼€å…³æ§åˆ¶é€»è¾‘ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå…ƒç´ å·²åˆ›å»ºï¼‰
        setTimeout(() => {
            const typeSelectorToggle = document.getElementById('clip-type-selector-toggle');
            console.log('æŸ¥æ‰¾ç±»å‹é€‰æ‹©å™¨å¼€å…³:', typeSelectorToggle);
            if (typeSelectorToggle) {
                console.log('ç±»å‹é€‰æ‹©å™¨å¼€å…³çŠ¶æ€:', typeSelectorToggle.checked);

                // æ£€æŸ¥æ˜¯å¦åœ¨é€æ­¥é…ç½®æ¨¡å¼
                const isStepConfig = document.querySelector('div[style*="backdrop-filter"]') !== null;

                typeSelectorToggle.addEventListener('change', () => {
                    console.log('ç±»å‹é€‰æ‹©å™¨å¼€å…³çŠ¶æ€æ”¹å˜:', typeSelectorToggle.checked);
                    // æ–°çš„é€»è¾‘ï¼šå‹¾é€‰æ—¶éšè—è¾“å…¥æ¡†å’Œé¢„è§ˆï¼Œä¸å‹¾é€‰æ—¶æ˜¾ç¤ºè¾“å…¥æ¡†å’Œé¢„è§ˆ
                    clipTypeSelectorInputGroup.style.display = typeSelectorToggle.checked ? 'none' : 'flex';
                    if (typeSelectorToggle.checked) {
                        // å‹¾é€‰æ—¶ï¼šéšè—è¾“å…¥æ¡†å’Œé¢„è§ˆï¼Œä½¿ç”¨ç±»å‹é€‰æ‹©å™¨å¼¹çª—
                        previewContainer.style.display = 'none';
                        previewContent.textContent = '';
                    } else {
                        // ä¸å‹¾é€‰æ—¶ï¼šæ˜¾ç¤ºè¾“å…¥æ¡†å’Œé¢„è§ˆï¼Œä½¿ç”¨è¾“å…¥é€‰æ‹©å™¨
                        previewContainer.style.display = 'block';
                        updatePreview();
                    }
                });

                // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
                // æ–°çš„é€»è¾‘ï¼šå‹¾é€‰æ—¶éšè—è¾“å…¥æ¡†å’Œé¢„è§ˆï¼Œä¸å‹¾é€‰æ—¶æ˜¾ç¤ºè¾“å…¥æ¡†å’Œé¢„è§ˆ
                clipTypeSelectorInputGroup.style.display = typeSelectorToggle.checked ? 'none' : 'flex';
                if (typeSelectorToggle.checked) {
                    // å‹¾é€‰æ—¶ï¼šéšè—è¾“å…¥æ¡†å’Œé¢„è§ˆï¼Œä½¿ç”¨ç±»å‹é€‰æ‹©å™¨å¼¹çª—
                    previewContainer.style.display = 'none';
                    previewContent.textContent = '';
                } else {
                    // ä¸å‹¾é€‰æ—¶ï¼šæ˜¾ç¤ºè¾“å…¥æ¡†å’Œé¢„è§ˆï¼Œä½¿ç”¨è¾“å…¥é€‰æ‹©å™¨
                    if (!isStepConfig) {
                        previewContainer.style.display = 'block';
                        try { updatePreview(); } catch (_) {}
                    } else {
                        previewContainer.style.display = 'none';
                        previewContent.textContent = '';
                    }
                }
                console.log('ç±»å‹é€‰æ‹©å™¨è¾“å…¥æ¡†ç»„æ˜¾ç¤ºçŠ¶æ€:', clipTypeSelectorInputGroup.style.display);
                // åˆå§‹åŒ–é¢„è§ˆç”±ä¸Šé¢é€»è¾‘å¤„ç†
            } else {
                console.error('æœªæ‰¾åˆ°ç±»å‹é€‰æ‹©å™¨å¼€å…³å…ƒç´ ');
            }
        }, 200);

        clipTypeSelectorContainer.appendChild(clipTypeSelectorLabel);
        clipTypeSelectorContainer.appendChild(clipTypeSelectorDesc);
        clipTypeSelectorContainer.appendChild(typeSelectorToggleContainer);
        clipTypeSelectorContainer.appendChild(clipTypeSelectorInputGroup);
        clipTypeSelectorContainer.appendChild(previewContainer);
        /* moved: clipTypeSelectorContainer will be appended inside customTagsContainer */

        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾é…ç½®ï¼ˆæ‰€æœ‰æ¨¡å¼éƒ½æ˜¾ç¤ºï¼‰
        const customTagsContainer = document.createElement('div');
        customTagsContainer.id = 'custom-tags-container';
        customTagsContainer.style.marginBottom = '20px';
        customTagsContainer.style.padding = '16px';
        customTagsContainer.style.borderRadius = '20px';
        customTagsContainer.style.background = 'rgba(255,255,255,0.3)';
        customTagsContainer.style.border = '1px solid rgba(229, 231, 235, 0.55)';

        const customTagsLabel = document.createElement('label');
        customTagsLabel.textContent = 'è‡ªå®šä¹‰æ ‡ç­¾';
        customTagsLabel.style.display = 'block';
        customTagsLabel.style.marginBottom = '8px';
        customTagsLabel.style.fontWeight = '500';
        customTagsLabel.style.fontSize = '16px';
        customTagsLabel.style.color = '#374151';

        const customTagsDesc = document.createElement('p');
        customTagsDesc.textContent = 'å¯ç”¨åï¼Œåœ¨å¯¼å…¥æ—¶ä¼šå¼¹å‡ºè‡ªå®šä¹‰æ ‡ç­¾é€‰æ‹©çª—å£';
        customTagsDesc.style.fontSize = '13px';
        customTagsDesc.style.marginBottom = '8px';
        customTagsDesc.style.color = '#6B7280';

        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾å¼€å…³
        const customTagsToggleContainer = document.createElement('div');
        customTagsToggleContainer.style.marginBottom = '12px';
        customTagsToggleContainer.style.padding = '16px';
        customTagsToggleContainer.style.border = '1px solid #e5e7eb';
        customTagsToggleContainer.style.borderRadius = '20px';

        // æ ¹æ®å†…å®¹ç±»å‹è®¾ç½®é»˜è®¤å€¼ï¼šå°è¯´å’Œæ¼«ç”»é»˜è®¤å…³é—­ï¼Œå‰ªè—é»˜è®¤å¼€å¯
        const getDefaultCustomTagsValue = () => {
            const contentType = document.getElementById('content-type-select')?.value || existingConfig.contentType || 'comic';
            if (contentType === 'novel' || contentType === 'comic') {
                return false; // å°è¯´å’Œæ¼«ç”»é»˜è®¤å…³é—­
            }
            return true; // å‰ªè—é»˜è®¤å¼€å¯
        };

        const customTagsCheckboxContainer = createCustomCheckbox(
            'custom-tags-toggle',
            existingConfig.enableCustomTags !== undefined ? existingConfig.enableCustomTags : getDefaultCustomTagsValue(),
            'å¯ç”¨è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆå‹¾é€‰æ—¶ä¼šåœ¨å¯¼å…¥æ—¶å¼¹å‡ºæ ‡ç­¾é€‰æ‹©çª—å£ï¼‰'
        );
        customTagsToggleContainer.appendChild(customTagsCheckboxContainer);

        customTagsContainer.appendChild(customTagsLabel);
        customTagsContainer.appendChild(customTagsDesc);
        const customTagsRow = document.createElement('div');
        customTagsRow.style.display = 'grid';
        customTagsRow.style.gridTemplateColumns = window.innerWidth <= 768 ? '1fr' : '1fr';
        customTagsRow.style.gap = '12px';
        customTagsRow.appendChild(customTagsToggleContainer);
        customTagsRow.appendChild(clipTypeSelectorContainer);
        customTagsContainer.appendChild(customTagsRow);
        form.appendChild(customTagsContainer);

        // æ·»åŠ è·¯å¾„æ¨¡å¼é…ç½®éƒ¨åˆ†ï¼ˆæ”¾åœ¨æœ€åï¼‰
        const pathPatternContainer = document.createElement('div');
        pathPatternContainer.id = 'path-pattern-container';
        pathPatternContainer.style.marginBottom = '20px';
        pathPatternContainer.style.padding = '16px';
        pathPatternContainer.style.borderRadius = '20px';
        pathPatternContainer.style.border = '1px solid rgba(229, 231, 235, 0.85)';
        pathPatternContainer.style.background = 'rgba(255,255,255,0.4)';
        pathPatternContainer.style.boxSizing = 'border-box';
        pathPatternContainer.style.maxWidth = '100%';
        pathPatternContainer.style.overflow = 'visible';

        const pathPatternLabel = document.createElement('label');
        pathPatternLabel.textContent = 'è·¯å¾„æ¨¡å¼';
        pathPatternLabel.style.display = 'block';
        pathPatternLabel.style.marginBottom = '8px';
        pathPatternLabel.style.fontSize = '16px';
        pathPatternLabel.style.fontWeight = '600';
        pathPatternLabel.style.color = '#374151';

        const pathPatternDesc = document.createElement('p');
        pathPatternDesc.textContent = 'åœ¨æ­¤ç½‘ç«™å“ªäº›è·¯å¾„ä¸‹æ˜¾ç¤ºå¯¼å…¥æŒ‰é’®';
        pathPatternDesc.style.fontSize = '13px';
        pathPatternDesc.style.color = 'var(--text-dark)';
        pathPatternDesc.style.marginBottom = '8px';

        const pathPatternTextarea = document.createElement('textarea');
        pathPatternTextarea.style.width = '100%';
        pathPatternTextarea.style.minHeight = '80px';
        pathPatternTextarea.style.height = '80px';
        pathPatternTextarea.style.padding = '10px 14px';
        pathPatternTextarea.style.border = '1px solid #D1D5DB';
        pathPatternTextarea.style.borderRadius = '20px';
        pathPatternTextarea.style.background = '#F9FAFB';
        pathPatternTextarea.style.boxSizing = 'border-box';
        pathPatternTextarea.style.overflow = 'auto';
        pathPatternTextarea.style.resize = 'vertical';
        pathPatternTextarea.className = 'multiline';

        // è‡ªåŠ¨ç”Ÿæˆå­è·¯å¾„æŒ‰é’®
        const genSubpathsBtn = document.createElement('button');
        genSubpathsBtn.textContent = 'è‡ªåŠ¨ç”Ÿæˆå­è·¯å¾„';
        genSubpathsBtn.className = 'dialog-btn dialog-btn-primarycolor';
        genSubpathsBtn.style.display = 'inline-flex';
        genSubpathsBtn.style.color = 'white !important'
        genSubpathsBtn.style.alignItems = 'center';
        genSubpathsBtn.style.justifyContent = 'center';
        genSubpathsBtn.style.margin = '8px 0 12px 0';
        genSubpathsBtn.style.borderRadius = '20px';
        genSubpathsBtn.style.padding = '10px 14px';
        genSubpathsBtn.style.boxShadow = '0 4px 12px var(--primarycolor-lighter)';
        genSubpathsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            try {
                const url = new URL(window.location.href);
                const host = url.hostname;
                const parts = (url.pathname || '/').split('/').filter(Boolean);
                const candidates = [];

                // åŠ å…¥æ™ºèƒ½æå–çš„ç²¾ç¡®æ¨¡å¼ï¼ˆå¦‚ /slug/* æˆ–æœ€åæ®µå¸¦*ï¼‰
                const smart = extractSmartPattern(window.location.href);
                if (smart && smart.fullPattern) {
                    candidates.push(smart.fullPattern);
                }
                // åˆå¹¶å·²æœ‰è¡Œå¹¶å»é‡
                const existing = pathPatternTextarea.value.split('\n').map(s => s.trim()).filter(Boolean);
                const merged = Array.from(new Set([...existing, ...candidates]));
                pathPatternTextarea.value = merged.join('\n');
                showNotification('å·²ç”Ÿæˆå­è·¯å¾„æ¨¡å¼', 'success');
            } catch (err) {
                console.error('ç”Ÿæˆå­è·¯å¾„å¤±è´¥:', err);
                showNotification('ç”Ÿæˆå­è·¯å¾„å¤±è´¥', 'error');
            }
        });

        // æ˜¾ç¤ºå½“å‰è·¯å¾„æ¨¡å¼
        const enabledPatterns = GM_getValue(ENABLED_PATTERNS_KEY, []);
        pathPatternTextarea.value = enabledPatterns
            .filter(p => p.domain === currentHost)
            .map(p => p.fullPattern)
            .join('\n');

        pathPatternContainer.appendChild(pathPatternLabel);
        pathPatternContainer.appendChild(pathPatternDesc);
        pathPatternContainer.appendChild(genSubpathsBtn);
        pathPatternContainer.appendChild(pathPatternTextarea);
        form.appendChild(pathPatternContainer);

        // æ·»åŠ ä»£ç†å‰ç¼€é€‰é¡¹
        const proxyPrefixContainer = document.createElement('div');
        proxyPrefixContainer.style.marginBottom = '20px';
        proxyPrefixContainer.style.padding = '16px';
        proxyPrefixContainer.style.borderRadius = '20px';
        proxyPrefixContainer.style.border = '1px solid rgba(229, 231, 235, 0.85)';
        proxyPrefixContainer.style.background = 'rgba(255,255,255,0.4)';
        proxyPrefixContainer.style.boxSizing = 'border-box';
        proxyPrefixContainer.style.maxWidth = '100%';
        proxyPrefixContainer.style.overflow = 'visible';

        const proxyPrefixLabel = document.createElement('label');
        proxyPrefixLabel.textContent = 'ä»£ç†é“¾æ¥è®¾ç½®';
        proxyPrefixLabel.style.display = 'block';
        proxyPrefixLabel.style.marginBottom = '8px';
        proxyPrefixLabel.style.fontSize = '16px';
        proxyPrefixLabel.style.fontWeight = '600';
        proxyPrefixLabel.style.color = '#374151';

        const proxyPrefixDesc = document.createElement('p');
        proxyPrefixDesc.textContent = 'æ˜¯å¦åœ¨æ­¤ç½‘ç«™ä½¿ç”¨ä»£ç†é“¾æ¥ï¼ˆå½“å°é¢å›¾åºŠæœªå¯ç”¨æ—¶ï¼‰';
        proxyPrefixDesc.style.fontSize = '13px';
        proxyPrefixDesc.style.color = 'var(--text-dark)';
        proxyPrefixDesc.style.marginBottom = '12px';

        // è¯»å–å½“å‰ç«™ç‚¹é…ç½®ï¼Œé»˜è®¤ä¸º true
        const currentSiteConfig = getSiteConfig();
        const proxyPrefixCheckboxContainer = createCustomCheckbox(
            'site-use-proxy-prefix',
            currentSiteConfig.useProxyPrefix !== false, // é»˜è®¤ä¸º true
            'å¯ç”¨ä»£ç†é“¾æ¥'
        );
        proxyPrefixContainer.appendChild(proxyPrefixLabel);
        proxyPrefixContainer.appendChild(proxyPrefixDesc);
        proxyPrefixContainer.appendChild(proxyPrefixCheckboxContainer);
        form.appendChild(proxyPrefixContainer);

        // æ·»åŠ ç±»å‹æ˜ å°„é…ç½®
        const typeMappingUI = createTypeMappingUI(typeMappings);
        typeMappingUI.id = 'type-mapping-container'; // æ·»åŠ IDä»¥ä¾¿æ›´å®¹æ˜“é€‰æ‹©
        form.appendChild(typeMappingUI);

        // å¤‡æ³¨/è¯„åˆ†/è¿½åŠ æŒ‰é’®å¼€å…³å·²ç§»åŠ¨åˆ°â€œå…¶ä»–è®¾ç½®â€

        const buttonContainer = document.createElement('div');
        buttonContainer.id = 'config-dialog-actions';
        const saveButton = document.createElement('button');
        saveButton.className = 'dialog-btn dialog-btn-primarycolor';
        const saveIcon = document.createElement('span');
        saveIcon.textContent = 'ğŸ’¾';
        saveButton.appendChild(saveIcon);
        saveButton.appendChild(document.createTextNode(' ä¿å­˜é…ç½®'));
        saveButton.style.display = 'flex';
        saveButton.style.alignItems = 'center';
        saveButton.style.justifyContent = 'center';
        saveButton.style.color = 'white';
        saveButton.style.background = 'linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark))';
        saveButton.addEventListener('mouseenter', () => {
            saveButton.style.background = 'linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark))';
            saveButton.style.color = '#fff';
        });
        saveButton.addEventListener('mouseleave', () => {
            saveButton.style.background = 'linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark))';
            saveButton.style.color = '#fff';
        });
        saveButton.addEventListener('mouseenter', (e) => { e.stopPropagation(); });
        saveButton.addEventListener('mouseover', (e) => { e.stopPropagation(); });

        saveButton.addEventListener('click', () => {
            try {
                const contentType = document.getElementById('content-type-select').value;
                const newConfig = {
                    selectors: {},
                    selectorIndices: {},
                    adjustSelectors: function() { return false; },
                    contentType: contentType
                };

                const pathPatterns = pathPatternTextarea.value.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(fullPattern => {
                    const pattern = extractSmartPattern(`https://${currentHost}${fullPattern.replace(currentHost, '')}`);
                    return pattern || { domain: currentHost, pattern: '/*', fullPattern: `${currentHost}/*` };
                });

                const otherPatterns = enabledPatterns.filter(p => p.domain !== currentHost);
                GM_setValue(ENABLED_PATTERNS_KEY, [...otherPatterns, ...pathPatterns]);

                const newTypeMappings = getTypeMappingsFromUI(typeMappingUI);
                GM_setValue('typeMappings', newTypeMappings);

                newConfig.selectors['å°é¢'] = coverInput.value.trim();
                newConfig.selectorIndices['å°é¢'] = normalizeIndexExpressionForStorage(coverIndexInput.value);

                const expandInputs = Array.from(document.querySelectorAll('.expand-btn-selector-input'));
                const expandSelectors = expandInputs.map(input => input.value.trim()).filter(Boolean);
                newConfig.expandBtnSelectors = expandSelectors;
                newConfig.expandBtnSelector = expandSelectors[0] || '';



                const domainIconInput = document.getElementById('domain-icon-url-input');
                if (domainIconInput) {
                    newConfig.domainIconUrl = domainIconInput.value.trim();
                }

                fields.forEach(field => {
                    const input = form.querySelector(`input[data-field="${field}"]`);
                    const indexInput = form.querySelector(`.selector-index-input[data-field="${field}"]`);

                    newConfig.selectors[field] = input.value.trim();
                    newConfig.selectorIndices[field] = normalizeIndexExpressionForStorage(indexInput.value);

                    const filterInput = form.querySelector(`.filter-input[data-field="${field}"]`);
                    if (filterInput) {
                        newConfig.selectors[`${field}_filter`] = filterInput.value.trim();

                        const filterModeSelect = form.querySelector(`.filter-mode-select[data-field="${field}"]`);
                        if (filterModeSelect) {
                            newConfig.selectors[`${field}_filter_mode`] = filterModeSelect.value;
                        }
                    }
                });

                if (contentType === 'clip') {
                    const list = document.getElementById('content-selectors-list');
                    if (list) {
                        const inputs = Array.from(list.querySelectorAll('input.content-selector-input'));
                        const selectors = inputs.map(i => i.value.trim()).filter(Boolean);
                        newConfig.contentSelectors = selectors;
                        newConfig.contentSelector = selectors[0] || '';
                    }

                    const clipTypeSelectorInput = document.getElementById('clip-type-selector-input');
                    if (clipTypeSelectorInput) {
                        newConfig.clipTypeSelector = clipTypeSelectorInput.value.trim();
                    }

                    const typeSelectorToggle = document.getElementById('clip-type-selector-toggle');
                    if (typeSelectorToggle) {
                        newConfig.enableTypeSelector = typeSelectorToggle.checked;
                    }

                    const excludeInputs = Array.from(document.querySelectorAll('#exclude-selectors-list .exclude-selector-input'));
                    newConfig.clipExcludeSelectors = excludeInputs
                        .map(i => i.value.trim())
                        .filter(v => v.length > 0);
                }

                const customTagsToggle = document.getElementById('custom-tags-toggle');
                if (customTagsToggle) {
                    newConfig.enableCustomTags = customTagsToggle.checked;
                }

                // ä¿å­˜ä»£ç†å‰ç¼€é€‰é¡¹
                const useProxyPrefixCheckbox = document.getElementById('site-use-proxy-prefix');
                if (useProxyPrefixCheckbox) {
                    newConfig.useProxyPrefix = useProxyPrefixCheckbox.checked;
                }

                const scopeKey = getConfigScopeKey ? getConfigScopeKey() : currentHost;
                const savedScope = saveCustomConfig(scopeKey, newConfig);
                let savedHost = true;
                if (scopeKey !== currentHost) {
                    savedHost = saveCustomConfig(currentHost, newConfig);
                }
                if (savedScope || savedHost) {
                    try {
                        const allKeys = GM_listValues();
                        const prefix = `site_config_${currentHost}/`;
                        const subScopeKeys = allKeys.filter(k => k.startsWith(prefix));
                        subScopeKeys.forEach(k => {
                            const hostKey = k.replace('site_config_', '');
                            deleteCustomConfig(hostKey);
                        });
                    } catch (_) {}

                    showNotification('é…ç½®å·²ä¿å­˜', 'success');

                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification('ä¿å­˜å¤±è´¥ï¼šæ— æ³•å†™å…¥ç«™ç‚¹é…ç½®', 'error');
                }
            } catch (error) {
                try { showNotification('ä¿å­˜å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error'); } catch (_) {}
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
            }
        });

        // æ·»åŠ å…¶ä»–åŠŸèƒ½æŒ‰é’®
        const otherFuncButton = document.createElement('button');
        otherFuncButton.className = 'dialog-btn dialog-btn-danger';
        const otherIcon = document.createElement('span');
        otherIcon.textContent = 'âš™ï¸';
        otherFuncButton.appendChild(otherIcon);
        otherFuncButton.appendChild(document.createTextNode(' å…¶ä»–åŠŸèƒ½'));
        otherFuncButton.style.display = 'flex';
        otherFuncButton.style.alignItems = 'center';
        otherFuncButton.style.justifyContent = 'center';
        otherFuncButton.addEventListener('click', (e) => {
            e.stopPropagation();
            try {
                const anchor = document.getElementById('config-anchor-nav');
                if (anchor) anchor.remove();
                GM_setValue('show_config_anchor_nav', false);
            } catch(_) {}
            try {
                // å…ˆå…³é—­é…ç½®å¯¹è¯æ¡†
                const configDialog = document.getElementById('config-dialog');
                if (configDialog) configDialog.style.display = 'none';

                if (typeof showOtherFunctionsDialog === 'function') {
                    showOtherFunctionsDialog();
                } else {
                    showNotification('æœªæ‰¾åˆ°å…¶ä»–åŠŸèƒ½é¢æ¿', 'warning');
                }
            } catch(err) { console.error(err); }
        });
        buttonContainer.appendChild(otherFuncButton);

        if (customConfigs[currentKey] || customConfigs[currentHost]) {
            const deleteButton = document.createElement('button');
            deleteButton.className = 'dialog-btn dialog-btn-danger';
            const delIcon = document.createElement('span');
            delIcon.textContent = 'ğŸ—‘ï¸';
            deleteButton.appendChild(delIcon);
            deleteButton.appendChild(document.createTextNode(' åˆ é™¤é…ç½®'));
            deleteButton.style.display = 'flex';
            deleteButton.style.alignItems = 'center';
            deleteButton.style.justifyContent = 'center';
            deleteButton.style.color = 'white';
            deleteButton.style.background = 'linear-gradient(135deg, var(--error), #C62828)';
            deleteButton.addEventListener('mouseenter', () => {
                deleteButton.style.background = 'linear-gradient(135deg, var(--error), #C62828)';
                deleteButton.style.color = '#fff';
            });
            deleteButton.addEventListener('mouseleave', () => {
                deleteButton.style.background = 'linear-gradient(135deg, var(--error), #C62828)';
                deleteButton.style.color = '#fff';
            });
            deleteButton.addEventListener('mouseenter', (e) => { e.stopPropagation(); });
            deleteButton.addEventListener('mouseover', (e) => { e.stopPropagation(); });

            deleteButton.addEventListener('click', () => {
                const delKey = getConfigScopeKey ? getConfigScopeKey() : currentHost;
                let deleted = false;

                // å°è¯•åˆ é™¤ä¸¤ç§æ ¼å¼çš„é…ç½®
                if (deleteCustomConfig(delKey)) {
                    deleted = true;
                }
                if (delKey !== currentHost && deleteCustomConfig(currentHost)) {
                    deleted = true;
                }

                if (deleted) {
                    showNotification('é…ç½®å·²åˆ é™¤ï¼', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification('æœªæ‰¾åˆ°å¯åˆ é™¤çš„é…ç½®', 'error');
                }
            });

            buttonContainer.appendChild(deleteButton);
        }



        const cancelButton = document.createElement('button');
        cancelButton.className = 'dialog-btn dialog-btn-secondary';
        const cancelIcon = document.createElement('span');
        cancelIcon.textContent = 'â¨‰';
        cancelButton.appendChild(cancelIcon);
        cancelButton.appendChild(document.createTextNode(' å–æ¶ˆ'));
        cancelButton.style.display = 'flex';
        cancelButton.style.alignItems = 'center';
        cancelButton.style.justifyContent = 'center';

        cancelButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (selectorTool && typeof selectorTool.stopSelection === 'function') {
                selectorTool.stopSelection();
            }
            // ç§»é™¤é…ç½®å¯¹è¯æ¡†
            const configDialog = document.getElementById('config-dialog');
            if (configDialog) {
                configDialog.remove();
            }
            const anchor = document.getElementById('config-anchor-nav');
            if (anchor) anchor.remove();
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ overlay èƒŒæ™¯å±‚ï¼ˆé€æ­¥é…ç½®æ¨¡å¼ï¼‰
            const stepConfigOverlay = document.querySelector('div[style*="backdrop-filter"]');
            if (stepConfigOverlay) {
                stepConfigOverlay.remove();
            }
        });

        buttonContainer.appendChild(cancelButton);
        buttonContainer.appendChild(saveButton);

        const dialog = document.createElement('div');
        dialog.id = 'config-dialog';
        dialog.style.cssText = 'background:linear-gradient(135deg,#eef2ff,#f1f5f9); backdrop-filter: saturate(180%) blur(10px); border-radius: 20px; padding: 5px; width: 540px; max-width: 92vw; box-shadow: 0 25px 50px -12px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.05); border: 1px solid rgba(229,231,235,.85); position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); z-index: 10002; display:flex; flex-direction: column; gap: 10px; animation: configSlideIn 0.38s cubic-bezier(0.34, 1.56, 0.64, 1); max-height: 90vh; overflow: hidden;';
        let anim = document.getElementById('config-dialog-animations');
        if (!anim) {
            anim = document.createElement('style');
            anim.id = 'config-dialog-animations';
            anim.textContent = '@keyframes configSlideIn { from { opacity: 0; transform: translate(-50%, -50%) translateY(10px) scale(0.98); } to { opacity: 1; transform: translate(-50%, -50%) translateY(0) scale(1); } }';
            document.head.appendChild(anim);
        }

        const titleBar = document.createElement('div');
        titleBar.id = 'config-dialog-header';
        titleBar.textContent = `é…ç½® ${currentHost} çš„æŠ“å–è§„åˆ™`;
        titleBar.className = 'draggable';
        titleBar.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; border-radius: 20px; background: linear-gradient(135deg, var(--primarycolor, #FF6B9D), var(--primarycolor-dark, #D94D7B)); color: #fff; box-shadow: 0 6px 14px rgba(0,0,0,.08);';

        const closeButton = document.createElement('button');
        closeButton.id = 'config-dialog-close';
        closeButton.textContent = 'Ã—';
        closeButton.style.cssText = 'margin-left:auto; border: 0; background: rgba(255,255,255,.15); color: #fff; border-radius: 20px; width: 32px; height: 32px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all .2s ease;';
        closeButton.addEventListener('mouseenter', () => { closeButton.style.transform = 'translateY(-1px)'; });
        closeButton.addEventListener('mouseleave', () => { closeButton.style.transform = 'translateY(0)'; });

        closeButton.addEventListener('click', (e) => {
            e.stopPropagation();
            selectorTool.stopSelection();
            dialog.remove();
            const anchor = document.getElementById('config-anchor-nav');
            if (anchor) anchor.remove();
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ overlay èƒŒæ™¯å±‚ï¼ˆé€æ­¥é…ç½®æ¨¡å¼ï¼‰
            const stepConfigOverlay = document.querySelector('div[style*="backdrop-filter"]');
            if (stepConfigOverlay) {
                stepConfigOverlay.remove();
            }
        });

        titleBar.appendChild(closeButton);
        dialog.appendChild(titleBar);
        dialog.appendChild(form);
        dialog.appendChild(buttonContainer);
        document.body.appendChild(dialog);

        try { applyButtonVisibilitySettings(); } catch(_) {}
        try { applySelectorVisualStyle(); } catch(_) {}

        makeDialogDraggable(dialog, titleBar);

        try {
            if (GM_getValue('show_config_anchor_nav', true)) {
                createConfigAnchorNav(dialog);
            }
        } catch(_) {}

        dialog.addEventListener('click', (e) => e.stopPropagation());

        // æ·»åŠ ç®€ä»‹å±•å¼€é€‰æ‹©å™¨é…ç½®
        const expandBtnContainer = document.createElement('div');
        expandBtnContainer.style.marginBottom = '20px';
        expandBtnContainer.style.marginTop = '20px';
        expandBtnContainer.style.padding = '16px';
        expandBtnContainer.style.borderRadius = '20px';
        expandBtnContainer.style.border = '1px solid rgba(229, 231, 235, 0.85)';
        expandBtnContainer.style.background = 'rgba(255,255,255,0.4)';
        expandBtnContainer.style.display = existingConfig.contentType === 'clip' ? 'none' : 'block';
        expandBtnContainer.id = 'anchor-expand-btn';

        const expandBtnLabel = document.createElement('label');
        expandBtnLabel.textContent = 'âœ¦ ç®€ä»‹å±•å¼€æŒ‰é’®';
        expandBtnLabel.style.display = 'block';
        expandBtnLabel.style.margin = '0';
        expandBtnLabel.style.fontSize = '14px';
        expandBtnLabel.style.fontWeight = '600';

        const expandBtnDesc = document.createElement('p');
        expandBtnDesc.textContent = 'æŒ‰é¡ºåºæ·»åŠ é€‰æ‹©å™¨ã€‚';
        expandBtnDesc.style.fontSize = '12px';
        expandBtnDesc.style.color = 'var(--text-dark)';
        expandBtnDesc.style.margin = '0';
        const expandHeader = document.createElement('div');
        expandHeader.style.display = 'flex';
        expandHeader.style.alignItems = 'center';
        expandHeader.style.justifyContent = 'space-between';
        expandHeader.style.marginBottom = '12px';
        expandHeader.style.paddingBottom = '6px';
        expandHeader.style.borderBottom = '1px solid var(--input-border)';
        expandHeader.appendChild(expandBtnLabel);
        expandHeader.appendChild(expandBtnDesc);

        const expandBtnList = document.createElement('div');
        expandBtnList.id = 'expand-btn-selector-list';
        expandBtnList.style.display = 'flex';
        expandBtnList.style.flexDirection = 'column';
        expandBtnList.style.gap = '10px';

        let expandSelectorCounter = 0;
        const setActiveExpandInput = (input) => {
            document.querySelectorAll('.expand-btn-selector-input.active').forEach(el => el.classList.remove('active'));
            if (input) {
                input.classList.add('active');
            }
        };
        const updateExpandRemoveState = () => {
            const rows = expandBtnList.querySelectorAll('.expand-btn-row');
            const disableRemove = rows.length <= 1;
            rows.forEach(row => {
                const removeBtn = row.querySelector('.expand-btn-remove-btn');
                if (removeBtn) removeBtn.disabled = disableRemove;
            });
        };

        const createExpandSelectorRow = (value = '') => {
            const row = document.createElement('div');
            row.className = 'expand-btn-row';
            row.style.display = 'grid';
            row.style.gridTemplateColumns = '1fr max-content';
            row.style.gap = '10px';
            row.style.alignItems = 'center';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'expand-btn-selector-input';
            input.value = value || '';
            input.style.flex = '1';
            input.style.padding = '12px';
            input.style.border = '1px solid var(--input-border)';
            input.style.borderRadius = '20px';
            input.placeholder = 'è¾“å…¥å±•å¼€æŒ‰é’®é€‰æ‹©å™¨';
            if (expandSelectorCounter === 0) {
                input.id = 'expand-btn-selector';
            }
            input.addEventListener('focus', () => setActiveExpandInput(input));

            const buttonGroup = document.createElement('div');
            buttonGroup.style.display = 'flex';
            buttonGroup.style.gap = '8px';
            buttonGroup.style.alignItems = 'center';
            buttonGroup.style.justifyContent = 'flex-end';

            const pickerBtn = document.createElement('button');
            const pickerIcon2 = document.createElement('span');
            pickerIcon2.className = 'btn-icon';
            pickerIcon2.textContent = 'âœ¦';
            pickerBtn.appendChild(pickerIcon2);
            pickerBtn.appendChild(document.createTextNode('é€‰æ‹©'));
            pickerBtn.className = 'selector-picker-btn';
            pickerBtn.style.padding = '8px 12px';
            pickerBtn.style.border = '1px solid var(--input-border)';
            pickerBtn.style.borderRadius = '999px';
            pickerBtn.style.background = 'transparent';
            pickerBtn.style.color = 'inherit';
            try { pickerBtn.dataset.btnType = 'select'; } catch(_) {}
            try { pickerBtn.style.display = GM_getValue('show-select-btn', true) ? '' : 'none'; } catch(_) {}
            pickerBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                setActiveExpandInput(input);
                if (selectorTool.isActive) {
                    selectorTool.stopSelection();
                    return;
                }
                document.getElementById('config-dialog').style.display = 'none';
                selectorTool.toggleSelectionMode(e, 'expandBtn');
            });

            const testBtn = document.createElement('button');
            const testIcon2 = document.createElement('span');
            testIcon2.className = 'btn-icon';
            testIcon2.textContent = 'ğŸ«§';
            testBtn.appendChild(testIcon2);
            testBtn.appendChild(document.createTextNode('æµ‹è¯•'));
            testBtn.className = 'selector-test-btn';
            testBtn.style.padding = '8px 12px';
            testBtn.style.border = '1px solid var(--input-border)';
            testBtn.style.borderRadius = '999px';
            testBtn.style.background = 'transparent';
            testBtn.style.color = 'inherit';
            try { testBtn.dataset.btnType = 'test'; } catch(_) {}
            try { testBtn.style.display = GM_getValue('show-test-btn', true) ? '' : 'none'; } catch(_) {}
            testBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const selector = input.value.trim();
                if (!selector) {
                    showNotification('é€‰æ‹©å™¨ä¸ºç©ºï¼Œä¸ä¼šè¿›è¡Œå±•å¼€æ“ä½œ', 'info');
                    return;
                }
                try {
                    const expandBtn = document.querySelector(selector);
                    if (expandBtn) {
                        expandBtn.click();
                        showNotification('å·²ç‚¹å‡»å±•å¼€æŒ‰é’®ï¼Œè¯·æ£€æŸ¥ç®€ä»‹æ˜¯å¦å±•å¼€', 'success');
                    } else {
                        showNotification('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å±•å¼€æŒ‰é’®', 'error');
                    }
                } catch (error) {
                    showNotification('é€‰æ‹©å™¨æ— æ•ˆ: ' + error.message, 'error');
                }
            });

            const removeBtn = document.createElement('button');
            const rmIcon = document.createElement('span');
            rmIcon.className = 'btn-icon';
            rmIcon.textContent = 'âœ•';
            removeBtn.appendChild(rmIcon);
            removeBtn.className = 'dialog-btn-secondary';
            removeBtn.style.padding = '8px 12px';
            removeBtn.style.border = '1px solid var(--input-border)';
            removeBtn.style.borderRadius = 'var(--notion-border-radius)';
            removeBtn.style.background = 'transparent';
            removeBtn.style.color = 'inherit';
            removeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (expandBtnList.contains(row)) {
                    const wasActive = input.classList.contains('active');
                    expandBtnList.removeChild(row);
                    updateExpandRemoveState();
                    if (wasActive) {
                        const fallback = expandBtnList.querySelector('.expand-btn-selector-input');
                        if (fallback) {
                            setActiveExpandInput(fallback);
                        }
                    }
                }
            });

            buttonGroup.appendChild(pickerBtn);
            buttonGroup.appendChild(testBtn);
            buttonGroup.appendChild(removeBtn);

            row.appendChild(input);
            row.appendChild(buttonGroup);
            expandSelectorCounter++;

            if (!document.querySelector('.expand-btn-selector-input.active')) {
                setActiveExpandInput(input);
            }
            return row;
        };

        const expandSelectors = getConfiguredExpandSelectors(existingConfig);
        if (expandSelectors.length) {
            expandSelectors.forEach(selector => {
                expandBtnList.appendChild(createExpandSelectorRow(selector));
            });
        } else {
            expandBtnList.appendChild(createExpandSelectorRow(''));
        }
        updateExpandRemoveState();

        const addExpandBtn = document.createElement('button');
        addExpandBtn.textContent = 'âœ¦ æ·»åŠ é€‰æ‹©å™¨';
        addExpandBtn.className = 'selector-test-btn';
        addExpandBtn.style.marginTop = '12px ';
        addExpandBtn.style.width = '100%';
        addExpandBtn.style.borderRadius = '999px';
        addExpandBtn.style.fontSize = '13px';
        addExpandBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const row = createExpandSelectorRow('');
            expandBtnList.appendChild(row);
            updateExpandRemoveState();
            const input = row.querySelector('.expand-btn-selector-input');
            if (input) {
                input.focus();
            }
        });

        expandBtnContainer.appendChild(expandHeader);
        expandBtnContainer.appendChild(expandBtnList);


        expandBtnContainer.appendChild(addExpandBtn);
        form.appendChild(expandBtnContainer);

        // åŸŸåå›¾æ ‡é…ç½®
        const domainIconContainer = document.createElement('div');
        domainIconContainer.id = 'domain-icon-container';
        domainIconContainer.style.marginBottom = '20px';
        domainIconContainer.style.padding = '16px';
        domainIconContainer.style.borderRadius = '20px';
        domainIconContainer.style.background = 'rgba(255,255,255,0.4)';
        domainIconContainer.style.border = '1px solid rgba(229, 231, 235, 0.85)';

        const domainIconLabel = document.createElement('label');
        domainIconLabel.textContent = 'âœ¦ åŸŸåå›¾æ ‡';
        domainIconLabel.style.display = 'block';
        domainIconLabel.style.margin = '0';
        domainIconLabel.style.fontSize = '14px';
        domainIconLabel.style.fontWeight = '600';

        const domainIconDesc = document.createElement('p');
        domainIconDesc.textContent = 'ä¸ºå½“å‰åŸŸåè®¾ç½®é¡µé¢å›¾æ ‡ã€‚';
        domainIconDesc.style.fontSize = '12px';
        domainIconDesc.style.color = 'var(--text-dark)';
        domainIconDesc.style.margin = '0';
        const domainIconHeader = document.createElement('div');
        domainIconHeader.style.display = 'flex';
        domainIconHeader.style.alignItems = 'center';
        domainIconHeader.style.justifyContent = 'space-between';
        domainIconHeader.style.marginBottom = '10px';
        domainIconHeader.appendChild(domainIconLabel);
        domainIconHeader.appendChild(domainIconDesc);

        const domainIconInput = document.createElement('input');
        domainIconInput.type = 'text';
        domainIconInput.id = 'domain-icon-url-input';
        domainIconInput.value = existingConfig.domainIconUrl || '';
        domainIconInput.style.width = '100%';
        domainIconInput.style.padding = '12px';
        domainIconInput.style.border = '1px solid var(--input-border)';
        domainIconInput.style.borderRadius = '20px';
        domainIconInput.placeholder = 'å›¾æ ‡é“¾æ¥ï¼ˆå»ºè®®CDNï¼‰';

        const domainIconPreview = document.createElement('div');
        domainIconPreview.style.marginTop = '8px';
        domainIconPreview.style.display = 'flex';
        domainIconPreview.style.alignItems = 'center';
        domainIconPreview.style.gap = '12px';

        const domainIconImg = document.createElement('img');
        domainIconImg.style.width = '40px';
        domainIconImg.style.height = '40px';
        domainIconImg.style.borderRadius = '10px';
        domainIconImg.style.objectFit = 'cover';
        domainIconImg.style.border = '1px solid var(--input-border)';
        domainIconImg.style.background = 'transparent';

        const domainIconPreviewText = document.createElement('span');
        domainIconPreviewText.style.fontSize = '13px';
        domainIconPreviewText.style.color = 'var(--text-dark)';

        const updateDomainIconPreview = (url) => {
            if (url && isValidUrl(url)) {
                domainIconImg.src = url;
                domainIconImg.style.display = 'block';
                domainIconPreviewText.textContent = 'é¢„è§ˆ';
            } else {
                domainIconImg.removeAttribute('src');
                domainIconImg.style.display = 'none';
                domainIconPreviewText.textContent = 'æœªè®¾ç½®';
            }
        };
        updateDomainIconPreview(domainIconInput.value.trim());
        domainIconInput.addEventListener('input', () => updateDomainIconPreview(domainIconInput.value.trim()));

        domainIconPreview.appendChild(domainIconImg);
        domainIconPreview.appendChild(domainIconPreviewText);

        const domainIconRow = document.createElement('div');
        domainIconRow.style.display = 'flex';
        domainIconRow.style.alignItems = 'center';
        domainIconRow.style.gap = '12px';
        domainIconRow.appendChild(domainIconInput);
        domainIconRow.appendChild(domainIconPreview);

        domainIconContainer.appendChild(domainIconHeader);
        domainIconContainer.appendChild(domainIconRow);
        form.appendChild(domainIconContainer);

    }

    // ä½¿å¯¹è¯æ¡†å¯æ‹–åŠ¨
    function makeDialogDraggable(dialog, handle) {
        let isDragging = false;
        let offsetX, offsetY;

        handle.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - dialog.getBoundingClientRect().left;
            offsetY = e.clientY - dialog.getBoundingClientRect().top;
            dialog.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            dialog.style.left = (e.clientX - offsetX) + 'px';
            dialog.style.top = (e.clientY - offsetY) + 'px';
            dialog.style.transform = 'none';
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            dialog.style.cursor = '';
        });
    }


    // æ ‡å‡†åŒ–æ›´æ–°çŠ¶æ€
    function normalizeStatus(status) {
        if (!status) return status;
        if (/è¿è½½|è¿è½½|æ›´æ–°ä¸­|è¿æ›´|è¿æ›´/i.test(status)) return "è¿è½½ä¸­";
        if (/å®Œç»“|å®Œç»“|å·²å®Œ|å·²å®Œç»“|å®Œæ›´/i.test(status)) return "å·²å®Œç»“";
        return status;
    }

    function decodeHtmlEntities(text) {
        if (!text) return '';
        try {
            const doc = new DOMParser().parseFromString(String(text), 'text/html');
            return (doc.body && doc.body.textContent) ? doc.body.textContent : (doc.documentElement && doc.documentElement.textContent) ? doc.documentElement.textContent : '';
        } catch (_) {
            return String(text);
        }
    }
    function setSafeHtml(el, html) {
        try {
            while (el.firstChild) el.removeChild(el.firstChild);
            const doc = new DOMParser().parseFromString(String(html || ''), 'text/html');
            const root = doc.body || doc.documentElement;
            const frag = document.createDocumentFragment();
            Array.from(root.childNodes).forEach(n => frag.appendChild(n));
            el.appendChild(frag);
        } catch (_) {
            el.textContent = String(html || '');
        }
    }

    // åœ¨æ–‡ä»¶é¡¶éƒ¨å˜é‡å£°æ˜åŒºåŸŸæ·»åŠ 
    // å­˜å‚¨å±•å¼€æŒ‰é’®çš„çˆ¶å…ƒç´ é€‰æ‹©å™¨
    let selectorToParent = null;

    // ä¿®æ”¹convertHtmlToNewlineså‡½æ•°
    function convertHtmlToNewlines(html) {
        if (!html) return "";

        // å°è¯•è·å–å±•å¼€åçš„å†…å®¹
        if (selectorToParent) {
            try {
                const parentElement = document.querySelector(selectorToParent);
                if (parentElement) {
                    // è·å–å±•å¼€åçš„å®Œæ•´å†…å®¹
                    const expandedContent = parentElement.innerHTML || parentElement.outerHTML;
                    if (expandedContent && expandedContent.length > html.length) {
                        html = expandedContent;
                        console.log('æˆåŠŸè·å–å±•å¼€åçš„å†…å®¹');
                    }
                }
            } catch (e) {
                console.log("æ— æ³•è·å–å±•å¼€åçš„å†…å®¹", e);
            }
        }

        // å»é™¤å±•å¼€æŒ‰é’®åŠå…¶æ–‡æœ¬å†…å®¹
        html = html.replace(/<button[^>]*>.*?<\/button>/gi, '')
            .replace(/<a[^>]*class="[^"]*\b(expand|more|show-all|toggle)[^"]*"[^>]*>.*?<\/a>/gi, '')
            .replace(/<div[^>]*class="[^"]*\b(expand|more|show-all|toggle)[^"]*"[^>]*>.*?<\/div>/gi, '')
            .replace(/<span[^>]*class="[^"]*\b(expand|more|show-all|toggle)[^"]*"[^>]*>.*?<\/span>/gi, '');

        // å¤„ç†HTMLè½¬æ¢ä¸ºçº¯æ–‡æœ¬
        let text = html
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/<\/p>/gi, '\n')
        .replace(/<\/div>/gi, '\n')
        .replace(/<\/h\d>/gi, '\n')
        .replace(/<[^>]+>/g, '')
        .replace(/\n{3,}/g, '\n\n')
        .trim();

        return text;
    }

    // ç”Ÿæˆå…ƒç´ çš„å”¯ä¸€é€‰æ‹©å™¨
    function generateUniqueSelector(element) {
        if (!element || element === document.documentElement) return null;

        // å°è¯•ä½¿ç”¨ID
        if (element.id) {
            return `#${element.id}`;
        }

        // å°è¯•ä½¿ç”¨ç±»
        if (element.className) {
            const classes = Array.from(element.classList)
            .filter(c => c.length > 0 && !c.includes('selector-'));

            if (classes.length > 0) {
                const classSelector = `.${classes.join('.')}`;
                if (document.querySelectorAll(classSelector).length === 1) {
                    return classSelector;
                }
            }
        }

        // å°è¯•ä½¿ç”¨æ ‡ç­¾+å±æ€§
        const tagName = element.tagName.toLowerCase();
        const parent = element.parentElement;

        if (!parent) return tagName;

        // æ‰¾å‡ºå…ƒç´ åœ¨çˆ¶å…ƒç´ ä¸­çš„ä½ç½®
        const siblings = Array.from(parent.children)
        .filter(el => el.tagName === element.tagName);

        if (siblings.length > 1) {
            const index = siblings.indexOf(element) + 1;
            return `${tagName}:nth-of-type(${index})`;
        }

        return tagName;
    }
    // æ¸…ç†è¿‡æœŸç¼“å­˜çš„å‡½æ•°
    function cleanExpiredCache() {
        try {
            const allKeys = GM_listValues();
            const now = Date.now();
            const cacheTimeout = 30000; // 30ç§’

            allKeys.forEach(key => {
                if (key.startsWith('extractCache_')) {
                    try {
                        const data = GM_getValue(key);
                        const { timestamp } = JSON.parse(data);
                        if (now - timestamp > cacheTimeout * 2) { // è¶…è¿‡1åˆ†é’Ÿå°±åˆ é™¤
                            GM_deleteValue(key);
                        }
                    } catch (e) {
                        // å¦‚æœè§£æå¤±è´¥ï¼Œåˆ é™¤è¿™ä¸ªé”®
                        GM_deleteValue(key);
                    }
                }
            });
        } catch (e) {
            console.log('æ¸…ç†ç¼“å­˜æ—¶å‡ºé”™:', e);
        }
    }

    // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
    async function waitForPageLoad() {
        return new Promise((resolve) => {
            // å¦‚æœé¡µé¢å·²ç»å®Œå…¨åŠ è½½
            if (document.readyState === 'complete') {
                // é¢å¤–ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿åŠ¨æ€å†…å®¹åŠ è½½å®Œæˆ
                setTimeout(resolve, 100);
                return;
            }

            // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
            const checkLoad = () => {
                if (document.readyState === 'complete') {
                    // é¢å¤–ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿åŠ¨æ€å†…å®¹åŠ è½½å®Œæˆ
                    setTimeout(resolve, 200);
                } else {
                    setTimeout(checkLoad, 50);
                }
            };

            // ç›‘å¬loadäº‹ä»¶
            window.addEventListener('load', () => {
                setTimeout(resolve, 300);
            }, { once: true });

            // å¼€å§‹æ£€æŸ¥
            checkLoad();
        });
    }

    // ä¿®æ”¹ extractComicData å‡½æ•°å£°æ˜ä¸º async
    async function extractComicData(siteConfig, isUpdateMode = false) {
        // è®¾ç½®å…¨å±€æ›´æ–°æ¨¡å¼æ ‡è®°
        window.isUpdateMode = isUpdateMode;

        // å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
        if (Math.random() < 0.1) { // 10%çš„æ¦‚ç‡æ¸…ç†ç¼“å­˜
            cleanExpiredCache();
        }
        // ç”Ÿæˆé¡µé¢ç‰¹å®šçš„ç¼“å­˜é”®ï¼Œä½¿ç”¨URLå“ˆå¸Œå’Œæ›´æ–°æ¨¡å¼
        const pageHash = btoa(window.location.href).replace(/[^a-zA-Z0-9]/g, '').substring(0, 16);
        const extractCacheKey = `extractCache_${pageHash}_${isUpdateMode ? 'update' : 'add'}`;
        const cacheTimeout = 5000; // 5ç§’ç¼“å­˜ï¼Œå‡å°‘ç¼“å­˜æ—¶é—´ç¡®ä¿æ•°æ®å®æ—¶æ€§
        const now = Date.now();

        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ç¼“å­˜
        const cachedData = GM_getValue(extractCacheKey);
        if (cachedData) {
            try {
                const { data, timestamp, pageUrl } = JSON.parse(cachedData);
                // ç¡®ä¿ç¼“å­˜æ¥è‡ªåŒä¸€é¡µé¢ä¸”æœªè¿‡æœŸ
                if (pageUrl === window.location.href && now - timestamp < cacheTimeout) {
                    console.log('æå–æ•°æ®: ä½¿ç”¨é¡µé¢ç¼“å­˜æ•°æ®', { pageUrl, isUpdateMode });
                    return data;
                }
            } catch (e) {
                console.log('ç¼“å­˜æ•°æ®è§£æå¤±è´¥ï¼Œé‡æ–°æå–');
            }
        }

        // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½ï¼Œç¡®ä¿é€‰æ‹©å™¨èƒ½å¤Ÿæ‰¾åˆ°å…ƒç´ 
        await waitForPageLoad();

        const result = {};
        const shouldAdjust = siteConfig.adjustSelectors ? siteConfig.adjustSelectors() : false;
        const typeMappings = loadTypeMappings();
        const currentHost = window.location.hostname;

        // é‡ç½®å±•å¼€é€‰æ‹©å™¨
        selectorToParent = null;

        // ç¡®ä¿selectorIndiceså­˜åœ¨
        if (!siteConfig.selectorIndices) {
            siteConfig.selectorIndices = {};
        }

        // manwa.meç½‘ç«™ç‰¹æ®Šå¤„ç†
        if (currentHost.includes('manwa.me')) {
            // è°ƒæ•´manwa.meçš„é€‰æ‹©å™¨
            adjustManwaSelectors(siteConfig);
        }

        // å¤„ç†å°é¢
        if (siteConfig.selectors['å°é¢']) {
            const coverElements = document.querySelectorAll(siteConfig.selectors['å°é¢']);
            let coverEl = null;

            if (coverElements.length > 0) {
                const selection = resolveElementSelection(coverElements, siteConfig.selectorIndices['å°é¢'] ?? '0');
                if (selection.elements.length) {
                    coverEl = selection.elements[0];
                    const resolvedIndex = selection.indices && selection.indices.length ? selection.indices[0] : 0;
                    console.log(`å°é¢é€‰æ‹©å™¨æ‰¾åˆ°${coverElements.length}ä¸ªå…ƒç´ ï¼Œç´¢å¼•è§„åˆ™: ${siteConfig.selectorIndices['å°é¢'] ?? '0'}ï¼Œé¢„è§ˆç¬¬${resolvedIndex + 1}ä¸ªå…ƒç´ `);
                }
            }

            result['å°é¢'] = extractImageUrl(coverEl);

            // å¦‚æœé€šè¿‡é€‰æ‹©å™¨æ²¡æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
            if (!result['å°é¢']) {
                // å°è¯•ä»metaæ ‡ç­¾è·å–
                const metaImage = document.querySelector('meta[property="og:image"]') ||
                      document.querySelector('meta[name="twitter:image"]');
                if (metaImage && metaImage.content) {
                    result['å°é¢'] = metaImage.content;
                }

                // å°è¯•ä»JSON-LDè·å–
                if (!result['å°é¢']) {
                    try {
                        const jsonLd = document.querySelector('script[type="application/ld+json"]');
                        if (jsonLd) {
                            const data = JSON.parse(jsonLd.textContent);
                            if (data.image) {
                                result['å°é¢'] = data.image;
                            }
                        }
                    } catch (e) {
                        console.error('è§£æJSON-LDå¤±è´¥:', e);
                    }
                }
            }

            // å¤„ç†ç›¸å¯¹è·¯å¾„
            if (result['å°é¢'] && !result['å°é¢'].startsWith('http')) {
                result['å°é¢'] = new URL(result['å°é¢'], window.location.href).href;
            }

            // å¤„ç†å°é¢å›¾ç‰‡URL
            if (result['å°é¢']) {
                console.log('åŸå§‹å°é¢URL:', result['å°é¢']);

                if (window.isUpdateMode) {
                    const currentHost = window.location.hostname;
                    const domainCdnEnabled = !!(GITHUB_DOMAIN_CONFIG[currentHost] && GITHUB_DOMAIN_CONFIG[currentHost].enabled);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯base64çº¯ç™½è‰²å°é¢
                    let isWhiteBase64 = false;
                    if (isBase64ImageUrl(result['å°é¢'])) {
                        isWhiteBase64 = await isWhiteImage(result['å°é¢']);
                        if (isWhiteBase64) {
                            console.log('æ›´æ–°æ¨¡å¼ï¼šæ£€æµ‹åˆ°å°é¢æ˜¯base64çº¯ç™½è‰²ï¼Œéœ€è¦æ›¿æ¢');
                        }
                    }

                    if (!COVER_BED_CONFIG.enabled && !domainCdnEnabled && !isWhiteBase64) {
                        try {
                            result['å°é¢'] = await processImageUrl(result['å°é¢'], {
                                isCover: true,
                                skipGithubUpload: true,
                                contentType: siteConfig.contentType
                            });
                            console.log('æ›´æ–°æ¨¡å¼ï¼šå°é¢å›¾åºŠæœªå¯ç”¨ï¼Œä½¿ç”¨ä»£ç†é“¾æ¥');
                        } catch (error) {
                            console.error('æ›´æ–°æ¨¡å¼ï¼šå¤„ç†å°é¢ä»£ç†å¤±è´¥ï¼Œä¿æŒåŸå§‹é“¾æ¥', error);
                        }
                    } else if (isGitHubImageUrl(result['å°é¢']) && !isWhiteBase64) {
                        try {
                            result['å°é¢'] = await processImageUrl(result['å°é¢'], {
                                isCover: true,
                                skipGithubUpload: true,
                                contentType: siteConfig.contentType
                            });
                            console.log('æ›´æ–°æ¨¡å¼ï¼šå°é¢ä¸ºGitHubé“¾æ¥ï¼Œå·²æŒ‰é«˜çº§è·¯å¾„é‡å†™');
                        } catch (_) {}
                    } else {
                        console.log('æ›´æ–°æ¨¡å¼ï¼šå°é¢å›¾åºŠå¯ç”¨æˆ–æ£€æµ‹åˆ°base64çº¯ç™½è‰²å°é¢ï¼Œä¸Šä¼ å°é¢åˆ°GitHub');
                        try {
                            result['å°é¢'] = await processImageUrl(result['å°é¢'], {
                                isCover: true,
                                skipGithubUpload: false,
                                contentType: siteConfig.contentType
                            });
                            console.log('æ›´æ–°æ¨¡å¼ï¼šå¤„ç†åçš„å°é¢URL:', result['å°é¢']);
                        } catch (error) {
                            console.error('æ›´æ–°æ¨¡å¼ï¼šå°é¢ä¸Šä¼ å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é“¾æ¥', error);
                        }
                    }
                } else {
                    // æ·»åŠ æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å¤„ç†å°é¢ï¼Œé¿å…é‡å¤å¤„ç†
                    if (COVER_PROCESSING_STATE.isProcessingCover) {
                        console.log('æ·»åŠ æ¨¡å¼ï¼šå°é¢æ­£åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡é‡å¤å¤„ç†');
                        // ä¿æŒåŸæ ·ï¼Œä¸é‡å¤å¤„ç†
                    } else {
                        // æ ‡è®°æ­£åœ¨å¤„ç†å°é¢
                        COVER_PROCESSING_STATE.isProcessingCover = true;

                        try {
                            // æ£€æŸ¥æ˜¯å¦ä¸æ˜¯GitHubé“¾æ¥ï¼Œå¦‚æœä¸æ˜¯ä¸”å¯ç”¨äº†æ›¿æ¢é€‰é¡¹ï¼Œåˆ™ä¸Šä¼ åˆ°GitHub
                            if (!isGitHubImageUrl(result['å°é¢']) && COVER_BED_CONFIG.replaceNotionGithub) {
                                console.log('æ£€æµ‹åˆ°éGitHubé“¾æ¥ï¼Œä¸Šä¼ å°é¢åˆ°GitHub');
                                // ä¸Šä¼ åˆ°GitHub
                                result['å°é¢'] = await processImageUrl(result['å°é¢'], {
                                    isCover: true,
                                    skipGithubUpload: false,
                                    contentType: siteConfig.contentType
                                });
                            } else {
                                // æ­£å¸¸å¤„ç†å°é¢
                                result['å°é¢'] = await processImageUrl(result['å°é¢'], {
                                    isCover: true,
                                    skipGithubUpload: false,
                                    contentType: siteConfig.contentType
                                });
                            }
                            console.log('å¤„ç†åçš„å°é¢URL:', result['å°é¢']);
                        } finally {
                            // å¤„ç†å®Œæˆåé‡ç½®çŠ¶æ€
                            COVER_PROCESSING_STATE.isProcessingCover = false;
                        }
                    }
                }
            }
        } else {
            result['å°é¢'] = "";
        }

        // æå–ä¹¦åå’Œå…¶ä»–åŸºæœ¬å­—æ®µ
        const fields = [
            'ä¹¦å', 'ç®€ä»‹', 'æœ€æ–°ç« èŠ‚', 'æ›´æ–°çŠ¶æ€', 'è¿½æ›´', 'åˆ«å', 'åœ°åŒº', 'ç±»å‹'
        ];

        for (const field of fields) {
            if (siteConfig.selectors[field]) {
                console.log(`å°è¯•æå–${field}å­—æ®µï¼Œé€‰æ‹©å™¨: ${siteConfig.selectors[field]}`);
                // å‰ªè—æ¨¡å¼ä¸‹ï¼šç±»å‹ä¼˜å…ˆæ ¹æ®å•ç‹¬é…ç½®çš„ç±»å‹é€‰æ‹©å™¨è¯»å–
                const selectorForField = (siteConfig.contentType === 'clip' && field === 'ç±»å‹' && siteConfig.clipTypeSelector)
                ? siteConfig.clipTypeSelector
                : siteConfig.selectors[field];
                const elements = document.querySelectorAll(selectorForField);
                if (elements.length > 0) {
                    const selection = resolveElementSelection(elements, siteConfig.selectorIndices[field] ?? '0');
                    if (!selection.elements.length) {
                        result[field] = "";
                        continue;
                    }

                    const processText = (el, indexInSelection = 0) => {
                        let text = field === 'ç®€ä»‹' ? el.innerHTML : el.textContent;
                        if (siteConfig.selectors[`${field}_filter`]) {
                            const filterMode = siteConfig.selectors[`${field}_filter_mode`] || 'remove';
                            text = applyFilter(text, siteConfig.selectors[`${field}_filter`], filterMode, field);
                        }

                        if (field === 'ç®€ä»‹') {
                            if (selection.mode === 'all' && indexInSelection === 0 && !window.__expand_handled_pre) {
                                const expandSelectorsToTry = getConfiguredExpandSelectors(siteConfig);
                                if (expandSelectorsToTry.length) {
                                    const delayMs = (typeof siteConfig.expandClickIntervalMs === 'number' && siteConfig.expandClickIntervalMs >= 0)
                                    ? siteConfig.expandClickIntervalMs
                                    : 150;
                                    for (const selector of expandSelectorsToTry) {
                                        try {
                                            const expandButton = document.querySelector(selector);
                                            if (expandButton && !expandButton.classList.contains('hide') && !expandButton.classList.contains('expanded') && !expandButton.disabled) {
                                                expandButton.click();
                                                console.log('å°è¯•å±•å¼€ç®€ä»‹ (multi/allæ¨¡å¼)', selector);
                                            }
                                        } catch (error) {
                                            console.error('å±•å¼€ç®€ä»‹å¤±è´¥ (multi/allæ¨¡å¼):', selector, error);
                                        }
                                    }
                                }
                            }
                            text = convertHtmlToNewlines(text);
                            text = decodeHtmlEntities(text);
                            const cleaned = cleanTextWithNewlines(text);
                            return cleaned;
                        }

                        return cleanText(text);
                    };

                    if (selection.mode === 'all' || selection.mode === 'multiple') {
                        const processedTexts = selection.elements
                        .map((el, idx) => processText(el, idx))
                        .filter(Boolean);

                        if (!processedTexts.length) {
                            result[field] = "";
                        } else if (field === 'ç®€ä»‹') {
                            result[field] = processedTexts.join('\n');
                        } else {
                            result[field] = joinTextsWithSeparator(field, processedTexts);
                        }
                    } else {
                        const element = selection.elements[0];
                        let text = processText(element);

                        if (field === 'ä¹¦å') {
                            result[field] = cleanTitle(text);
                        } else if (field === 'åœ°åŒº') {
                            let regionText = normalizeField('åœ°åŒº', cleanText(text), typeMappings);
                            result[field] = convertRegion(regionText);
                        } else if (field === 'ç±»å‹') {
                            result[field] = normalizeField('ç±»å‹', cleanText(text), typeMappings);
                        } else if (field === 'æ›´æ–°çŠ¶æ€') {
                            result[field] = normalizeField('æ›´æ–°çŠ¶æ€', cleanText(text), typeMappings);
                        } else {
                            if (field === 'ç®€ä»‹') {
                                result[field] = cleanTextWithNewlines(text);
                            } else {
                                result[field] = cleanText(text);
                            }
                        }
                    }

                    if (result[field]) {
                        if (field === 'åœ°åŒº') {
                            let regionText = normalizeField('åœ°åŒº', result[field], typeMappings);
                            result[field] = convertRegion(regionText);
                        } else if (field === 'ç±»å‹') {
                            result[field] = normalizeField('ç±»å‹', result[field], typeMappings);
                        } else if (field === 'æ›´æ–°çŠ¶æ€') {
                            result[field] = normalizeField('æ›´æ–°çŠ¶æ€', result[field], typeMappings);
                        } else if (field === 'ä¹¦å') {
                            result[field] = cleanTitle(result[field]);
                        }
                    }
                } else {
                    result[field] = "";
                }
            } else {
                result[field] = "";
            }
        }

        // ç‰¹æ®Šå¤„ç†ä½œè€…å­—æ®µï¼ˆå¯èƒ½éœ€è¦åˆå¹¶å¤šä¸ªï¼‰
        if (siteConfig.selectors['ä½œè€…']) {
            const elements = document.querySelectorAll(siteConfig.selectors['ä½œè€…']);
            // è·å–ä½œè€…å­—æ®µçš„ç´¢å¼•å€¼ï¼Œmanwa.meé»˜è®¤ä¸º"all"ï¼Œå…¶ä»–ç½‘ç«™é»˜è®¤ä¸º"0"
            const defaultIndex = currentHost.includes('manwa.me') ? 'all' : (siteConfig.selectorIndices['ä½œè€…'] ?? '0');
            const selection = resolveElementSelection(elements, defaultIndex);

            if (!selection.elements.length) {
                result['ä½œè€…'] = "";
            } else if (selection.mode === 'all' || selection.mode === 'multiple') {
                const texts = selection.elements
                .map(el => {
                    let text = cleanText(el.textContent);
                    if (siteConfig.selectors['ä½œè€…_filter']) {
                        try {
                            text = text.replace(new RegExp(siteConfig.selectors['ä½œè€…_filter'], 'g'), '');
                        } catch (_) {}
                    }
                    return text;
                })
                .filter(Boolean);
                result['ä½œè€…'] = joinTextsWithSeparator('ä½œè€…', texts) || "";
            } else {
                const element = selection.elements[0];
                let text = cleanText(element.textContent);
                if (siteConfig.selectors['ä½œè€…_filter']) {
                    try {
                        text = text.replace(new RegExp(siteConfig.selectors['ä½œè€…_filter'], 'g'), '');
                    } catch (_) {}
                }
                result['ä½œè€…'] = text;
            }
        } else {
            result['ä½œè€…'] = "";
        }

        // å‰ªè—æ¨¡å¼ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœå¯ç”¨äº†ç±»å‹é€‰æ‹©å™¨ï¼Œåˆ™å¼¹å‡ºç±»å‹é€‰æ‹©çª—å£ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
        if (siteConfig.contentType === 'clip' && siteConfig.enableTypeSelector && result['ç±»å‹'] !== null && (!result['ç±»å‹'] || (Array.isArray(result['ç±»å‹']) && result['ç±»å‹'].length === 0))) {
            try {
                const selectedType = await showTypeSelectionDialog();
                if (selectedType && selectedType.length) {
                    result['ç±»å‹'] = selectedType;
                    // æ£€æŸ¥æ˜¯å¦æœ‰åªå¡«å†™äº†æ‰“æ ‡ç­¾çš„è§„åˆ™åŒ¹é…ï¼ˆç”¨äºåŒ¹é…æ˜ å°„æ•°æ®åº“ï¼‰
                    const tagOnlyRule = checkTagOnlyRule(selectedType, 'ç±»å‹');
                    if (tagOnlyRule) {
                        // å°†åŒ¹é…çš„routeTypeå­˜å‚¨åˆ°resultä¸­ï¼Œä¾›åç»­å¯¼å…¥ä½¿ç”¨ï¼ˆæ˜ å°„æ•°æ®åº“ï¼‰
                        result['_autoRouteType'] = tagOnlyRule.routeType;
                        result['_useMappingDatabase'] = true; // æ ‡è®°ä½¿ç”¨æ˜ å°„æ•°æ®åº“
                        console.log('æ£€æµ‹åˆ°åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™åŒ¹é…ï¼Œå°†ä½¿ç”¨æ˜ å°„æ•°æ®åº“routeType:', tagOnlyRule.routeType);
                    } else {
                        // å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œæ¸…é™¤ä¹‹å‰çš„æ ‡è®°ï¼Œä½¿ç”¨æ™®é€šè§„åˆ™
                        delete result['_autoRouteType'];
                        delete result['_useMappingDatabase'];
                    }
                } else if (selectedType === null) {
                    // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œè®¾ç½®ç‰¹æ®Šæ ‡è®°é¿å…é‡å¤å¼¹å‡º
                    console.log('ç”¨æˆ·å–æ¶ˆäº†ç±»å‹é€‰æ‹©');
                    result['ç±»å‹'] = null; // ä½¿ç”¨nullæ ‡è®°ç”¨æˆ·å·²å–æ¶ˆ
                } else {
                    // å…¶ä»–æƒ…å†µï¼Œè®¾ç½®é»˜è®¤ç±»å‹
                    result['ç±»å‹'] = ['å…¶ä»–'];
                }
            } catch (error) {
                console.error('ç±»å‹é€‰æ‹©å¼¹çª—å¤±è´¥:', error);
                // å¦‚æœå¼¹çª—å¤±è´¥ï¼Œè®¾ç½®é»˜è®¤ç±»å‹
                result['ç±»å‹'] = ['å…¶ä»–'];
            }
        }

        // è‡ªå®šä¹‰æ ‡ç­¾å¤„ç†ï¼šæ ¹æ®æ¨¡å¼å†³å®šæ˜¯å¦å¼¹å‡ºæ ‡ç­¾é€‰æ‹©çª—å£
        // ä»…å½“æ˜¾å¼å¯ç”¨æ—¶æ‰å¼¹å‡º
        if (siteConfig.enableCustomTags === true) {
            let shouldShowDialog = false;

            // è°ƒæ•´ï¼šå½“å¯ç”¨è‡ªå®šä¹‰æ ‡ç­¾æ—¶ï¼Œåœ¨å°è¯´/æ¼«ç”»æ¨¡å¼ä¹Ÿå¼¹çª—ï¼ˆä¸ä¸å‰ªè—å…±äº«æ ‡ç­¾ï¼‰
            // è§„åˆ™ï¼š
            // - å‰ªè—æ¨¡å¼ï¼šå§‹ç»ˆå¼¹å‡º
            // - å°è¯´/æ¼«ç”»ï¼šä»…åœ¨â€œæ·»åŠ â€ï¼ˆæ•°æ®åº“ä¸å­˜åœ¨è¯¥é“¾æ¥ï¼‰æ—¶å¼¹å‡ºï¼›æ›´æ–°ä¸å¼¹
            if (siteConfig.contentType === 'clip') {
                shouldShowDialog = true;
            } else if (siteConfig.contentType === 'novel' || siteConfig.contentType === 'comic') {
                shouldShowDialog = !window.isUpdateMode;
            } else {
                shouldShowDialog = !window.isUpdateMode;
            }

            if (shouldShowDialog) {
                try {
                    const selectedTags = await showCustomTagsDialog(siteConfig.contentType);
                    if (selectedTags && typeof selectedTags === 'object') {
                        // å°†åˆ†ç»„ç»“æœåˆå¹¶åˆ°ä¸»ç»“æœä¸­
                        Object.keys(selectedTags).forEach(notionProperty => {
                            if (selectedTags[notionProperty] && selectedTags[notionProperty].length > 0) {
                                result[notionProperty] = selectedTags[notionProperty];
                                // æ£€æŸ¥æ˜¯å¦æœ‰åªå¡«å†™äº†æ‰“æ ‡ç­¾çš„è§„åˆ™åŒ¹é…ï¼ˆç”¨äºåŒ¹é…æ˜ å°„æ•°æ®åº“ï¼‰
                                const tagOnlyRule = checkTagOnlyRule(selectedTags[notionProperty], notionProperty);
                                if (tagOnlyRule) {
                                    // å°†åŒ¹é…çš„routeTypeå­˜å‚¨åˆ°resultä¸­ï¼Œä¾›åç»­å¯¼å…¥ä½¿ç”¨ï¼ˆæ˜ å°„æ•°æ®åº“ï¼‰
                                    result['_autoRouteType'] = tagOnlyRule.routeType;
                                    result['_useMappingDatabase'] = true; // æ ‡è®°ä½¿ç”¨æ˜ å°„æ•°æ®åº“
                                    console.log('æ£€æµ‹åˆ°åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™åŒ¹é…ï¼Œå°†ä½¿ç”¨æ˜ å°„æ•°æ®åº“routeType:', tagOnlyRule.routeType);
                                }
                            }
                        });
                        // å¦‚æœæ²¡æœ‰ä»»ä½•åŒ¹é…çš„è§„åˆ™ï¼Œæ¸…é™¤æ ‡è®°
                        if (!result['_useMappingDatabase']) {
                            delete result['_autoRouteType'];
                            delete result['_useMappingDatabase'];
                        }
                        console.log('ç”¨æˆ·é€‰æ‹©çš„åˆ†ç»„æ ‡ç­¾:', selectedTags);
                    } else if (selectedTags === null) {
                        // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œä¸è®¾ç½®è‡ªå®šä¹‰æ ‡ç­¾
                        console.log('ç”¨æˆ·å–æ¶ˆäº†è‡ªå®šä¹‰æ ‡ç­¾é€‰æ‹©');
                    }
                } catch (error) {
                    console.error('è‡ªå®šä¹‰æ ‡ç­¾é€‰æ‹©å¼¹çª—å¤±è´¥:', error);
                }
            }
        }

        // åº”ç”¨æ™ºèƒ½æå–ä¼˜åŒ–
        const enhancedResult = enhanceExtractionAccuracy(siteConfig, result);

        // ä¿å­˜åˆ°é¡µé¢ç‰¹å®šç¼“å­˜
        try {
            GM_setValue(extractCacheKey, JSON.stringify({
                data: enhancedResult,
                timestamp: now,
                pageUrl: window.location.href,
                isUpdateMode: isUpdateMode
            }));
            console.log('æå–æ•°æ®: å·²ä¿å­˜åˆ°é¡µé¢ç¼“å­˜', { pageUrl: window.location.href, isUpdateMode });
        } catch (e) {
            console.log('ç¼“å­˜ä¿å­˜å¤±è´¥ï¼Œä½†ä¸å½±å“åŠŸèƒ½');
        }

        try {
            __setLastExtract({
                ts: Date.now(),
                contentType: siteConfig.contentType || '',
                url: window.location.href || '',
                ä¹¦å: enhancedResult['ä¹¦å'] || '',
                æ ‡é¢˜: enhancedResult['æ ‡é¢˜'] || '',
                ä½œè€…: enhancedResult['ä½œè€…'] || '',
                ç±»å‹: Array.isArray(enhancedResult['ç±»å‹']) ? enhancedResult['ç±»å‹'] : (enhancedResult['ç±»å‹'] ? [enhancedResult['ç±»å‹']] : []),
                å°é¢: enhancedResult['å°é¢'] || '',
                ç®€ä»‹: String(enhancedResult['ç®€ä»‹'] || '').slice(0, 600),
                å¤‡æ³¨: String(enhancedResult['å¤‡æ³¨'] || '').slice(0, 600),
                è¿½æ›´: String(enhancedResult['è¿½æ›´'] || '').slice(0, 600)
            });
        } catch(_) {}

        return enhancedResult;
    }

    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒé“¾æ¥çš„æ¡ç›®
    function invalidateExistingPageCache(url) {
        try {
            const cache = window.__EXISTING_PAGE_CACHE__;
            const expiry = window.__EXISTING_PAGE_EXPIRY__;
            const inflight = window.__EXISTING_PAGE_INFLIGHT__;
            if (!cache || !(cache instanceof Map)) return;
            const suffix = '|' + url;
            const keys = Array.from(cache.keys());
            for (const key of keys) {
                if (typeof key === 'string' && key.endsWith(suffix)) {
                    cache.delete(key);
                    if (expiry && expiry instanceof Map) expiry.delete(key);
                    if (inflight && inflight instanceof Map) inflight.delete(key);
                }
            }
        } catch (_) {}
    }

    async function checkExistingPage(url, contentType = 'comic') {
        try {
            // éªŒè¯æ•°æ®åº“IDæ˜¯å¦å­˜åœ¨
            const databaseId = resolveDatabaseId(contentType);
            if (!databaseId) {
                console.error(`æœªæ‰¾åˆ°${contentType}æ•°æ®åº“IDï¼Œè¯·å…ˆé…ç½®`);
                return null;
            }

            const cacheKey = `${contentType}|${url}`;
            const ttlMs = GM_getValue('existing_page_cache_ttl_ms', 10000);
            window.__EXISTING_PAGE_CACHE__ = window.__EXISTING_PAGE_CACHE__ || new Map();
            window.__EXISTING_PAGE_EXPIRY__ = window.__EXISTING_PAGE_EXPIRY__ || new Map();
            window.__EXISTING_PAGE_INFLIGHT__ = window.__EXISTING_PAGE_INFLIGHT__ || new Map();
            const exp = window.__EXISTING_PAGE_EXPIRY__.get(cacheKey);
            const val = window.__EXISTING_PAGE_CACHE__.get(cacheKey);
            if (exp && exp > Date.now()) return val || null;
            const inflight = window.__EXISTING_PAGE_INFLIGHT__.get(cacheKey);
            if (inflight) return inflight;

            const query = {
                filter: {
                    property: "é“¾æ¥",
                    rich_text: {
                        equals: url
                    }
                }
            };

            const p = sendNotionRequest("POST", `https://api.notion.com/v1/databases/${databaseId}/query`, query)
            .then(res => {
                let id = null;
                if (res && Array.isArray(res.results) && res.results.length > 0) {
                    const active = res.results.find(page => !page.archived);
                    id = active ? active.id : null;
                }
                window.__EXISTING_PAGE_CACHE__.set(cacheKey, id);
                window.__EXISTING_PAGE_EXPIRY__.set(cacheKey, Date.now() + ttlMs);
                window.__EXISTING_PAGE_INFLIGHT__.delete(cacheKey);
                return id;
            })
            .catch(err => {
                window.__EXISTING_PAGE_INFLIGHT__.delete(cacheKey);
                throw err;
            });
            window.__EXISTING_PAGE_INFLIGHT__.set(cacheKey, p);
            return p;
        } catch (error) {
            console.error('æ£€æŸ¥ç°æœ‰é¡µé¢å‡ºé”™:', error);
            throw error;
        }
    }

    async function checkInVerifyDatabase(url) {
        try {
            const verifyId = GM_getValue('notion_verify_database_id', '');
            if (!verifyId) return null;
            const query = {
                filter: {
                    property: "é“¾æ¥",
                    rich_text: { equals: url }
                }
            };
            return new Promise((resolve, reject) => {
                GM_xmlhttpRequest({
                    method: "POST",
                    url: `https://api.notion.com/v1/databases/${verifyId}/query`,
                    headers: {
                        "Authorization": `Bearer ${NOTION_CONFIG.apiKey}`,
                        "Content-Type": "application/json",
                        "Notion-Version": "2022-06-28"
                    },
                    data: JSON.stringify(query),
                    onload: function(response) {
                        if (response.status >= 200 && response.status < 300) {
                            const data = JSON.parse(response.responseText);
                            if (data.results.length > 0) {
                                resolve(data.results[0].id);
                            } else {
                                resolve(null);
                            }
                        } else {
                            resolve(null);
                        }
                    },
                    onerror: function() { resolve(null); }
                });
            });
        } catch (_) { return null; }
    }

    // åˆ›å»ºæ–°Notioné¡µé¢
    async function createNotionPage(comicData, sourceURL, contentType = 'comic') {
        const effectiveType = contentType === 'record' ? 'clip' : contentType;
        const databaseId = resolveDatabaseId(effectiveType);
        const properties = await buildNotionProperties(comicData, sourceURL, null, contentType);

        // æ„å»ºè¯·æ±‚æ•°æ®
        const data = {
            parent: { database_id: databaseId },
            properties: properties
        };

        if (comicData._domainIconUrl && isValidUrl(comicData._domainIconUrl)) {
            data.icon = {
                type: "external",
                external: { url: comicData._domainIconUrl }
            };
        }

        // æ·»åŠ å°é¢ - åªæœ‰åœ¨æœ‰æœ‰æ•ˆå°é¢URLæ—¶æ‰æ·»åŠ 
        if (comicData.å°é¢ && comicData.å°é¢.trim() !== '' && isValidUrl(comicData.å°é¢)) {
            data.cover = {
                type: "external",
                external: { url: comicData.å°é¢ }
            };
        }

        // å¤„ç†å‰ªè—å†…å®¹
        if (comicData.content) {
            try {
                const cfg = getMarkdownTransformConfig();
                if (cfg.enabled && !comicData._mdTransformApplied) {
                    try {
                        comicData.content = applyMarkdownTransformRules(comicData.content, cfg.rules);
                    } catch(_) {}
                }

                window.__CURRENT_CONTENT_TYPE__ = contentType || '';
                const blocks = await convertToNotionBlocks(comicData.content);

                // åˆ†æ‰¹å¤„ç†å— - Notion APIé™åˆ¶æ¯æ¬¡è¯·æ±‚æœ€å¤š100ä¸ªå—
                if (blocks.length > 100) {
                    console.log(`å†…å®¹åŒ…å«${blocks.length}ä¸ªå—ï¼Œè¶…è¿‡Notion API 100ä¸ªå—çš„é™åˆ¶ï¼Œå°†åˆ†æ‰¹å¤„ç†`);
                    // åˆå§‹å—æ•°é‡é™åˆ¶ä¸º90ä¸ªï¼Œä»¥ä¾¿ä¿ç•™ä¸€å®šç©ºé—´ç»™åç»­å¤„ç†
                    data.children = blocks.slice(0, 90);

                    // è®°å½•è¦åœ¨é¡µé¢åˆ›å»ºåæ·»åŠ çš„å‰©ä½™å—
                    comicData.remainingBlocks = blocks.slice(90);
                    showNotification(`å†…å®¹è¾ƒé•¿ï¼Œå°†åˆ†${Math.ceil(blocks.length / 90)}æ‰¹å¯¼å…¥`, 'info');
                } else {
                    data.children = blocks;
                }

                // è®°å½•æ‰€æœ‰å›¾ç‰‡URLä»¥ä¾¿è°ƒè¯•ï¼Œå¹¶è¿›è¡Œæœ€ç»ˆéªŒè¯
                const imageBlocks = blocks.filter(block => block.type === 'image');
                if (imageBlocks.length > 0) {
                    console.log(`é¡µé¢åŒ…å«${imageBlocks.length}ä¸ªå›¾ç‰‡å—`);

                    // æœ€ç»ˆéªŒè¯æ‰€æœ‰å›¾ç‰‡URL
                    const validImageBlocks = [];
                    for (const block of imageBlocks) {
                        const imageUrl = block.image.external.url;
                        if (isValidImageUrl(imageUrl)) {
                            validImageBlocks.push(block);
                        } else {
                            console.warn('å‘ç°æ— æ•ˆå›¾ç‰‡URLï¼Œå°†è·³è¿‡:', imageUrl);
                        }
                    }

                    // æ›´æ–°blocksæ•°ç»„ï¼Œç§»é™¤æ— æ•ˆçš„å›¾ç‰‡å—
                    const filteredBlocks = blocks.filter(block => {
                        if (block.type === 'image') {
                            return isValidImageUrl(block.image.external.url);
                        }
                        return true;
                    });

                    // æ›´æ–°data.children
                    if (blocks.length > 100) {
                        data.children = filteredBlocks.slice(0, 90);
                        comicData.remainingBlocks = filteredBlocks.slice(90);
                    } else {
                        data.children = filteredBlocks;
                    }

                    console.log(`è¿‡æ»¤åæœ‰æ•ˆå›¾ç‰‡å—æ•°é‡: ${validImageBlocks.length}`);
                    if (validImageBlocks.length > 0) {
                        console.log('æœ‰æ•ˆå›¾ç‰‡URLç¤ºä¾‹:', validImageBlocks[0].image.external.url);
                    }
                }
            } catch (error) {
                console.error('è½¬æ¢å†…å®¹ä¸ºNotionå—å¤±è´¥:', error);
                showNotification('å†…å®¹è½¬æ¢å¤±è´¥: ' + error.message, 'error');
            }

            try {
            } catch (_) {}
        }

        try {
            __setLastUpload({
                ts: Date.now(),
                op: 'create',
                contentType,
                title: comicData.æ ‡é¢˜ || comicData.ä¹¦å || '',
                link: sourceURL || '',
                cover: comicData.å°é¢ || '',
                properties: Object.keys(properties || {}),
                text: {
                    ç®€ä»‹: String(comicData.ç®€ä»‹ || ''),
                    å¤‡æ³¨: String(comicData.å¤‡æ³¨ || ''),
                    è¿½æ›´: String(comicData.è¿½æ›´ || '')
                },
                childrenCount: Array.isArray(data.children) ? data.children.length : 0,
                imageBlocks: Array.isArray(comicData.remainingBlocks) ? (Array.isArray(comicData.remainingBlocks) ? (Array.isArray(data.children) ? data.children.filter(b => b.type === 'image').length : 0) : 0) : (Array.isArray(data.children) ? data.children.filter(b => b.type === 'image').length : 0)
            });
        } catch(_) {}

        try {
            const result = await sendNotionRequest("POST", "https://api.notion.com/v1/pages", data);

            // å¦‚æœæœ‰å‰©ä½™å—ï¼Œåˆ†æ‰¹æ·»åŠ 
            if (comicData.remainingBlocks && comicData.remainingBlocks.length > 0) {
                const pageId = result.id;
                console.log(`åˆ›å»ºé¡µé¢æˆåŠŸï¼Œå¼€å§‹æ·»åŠ å‰©ä½™${comicData.remainingBlocks.length}ä¸ªå—`);

                // æ‰¹æ¬¡å¤§å°ä¸º90ä¸ªå—
                const batchSize = 90;
                const totalBatches = Math.ceil(comicData.remainingBlocks.length / batchSize);

                for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                    const start = batchIndex * batchSize;
                    const end = Math.min(start + batchSize, comicData.remainingBlocks.length);
                    const currentBatch = comicData.remainingBlocks.slice(start, end);

                    console.log(`æ·»åŠ ç¬¬${batchIndex + 1}/${totalBatches}æ‰¹ï¼ŒåŒ…å«${currentBatch.length}ä¸ªå—`);
                    try {
                        // åœ¨ä¸¤æ¬¡è¯·æ±‚ä¹‹é—´æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…APIé™åˆ¶
                        if (batchIndex > 0) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }

                        await sendNotionRequest("PATCH", `https://api.notion.com/v1/blocks/${pageId}/children`, {
                            children: currentBatch
                        });

                        console.log(`ç¬¬${batchIndex + 1}æ‰¹æ·»åŠ æˆåŠŸ`);
                    } catch (batchError) {
                        console.error(`ç¬¬${batchIndex + 1}æ‰¹æ·»åŠ å¤±è´¥:`, batchError);
                        showNotification(`éƒ¨åˆ†å†…å®¹å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•`, 'warning');
                    }
                }
            }

            try {
                if (!['clip','comic','novel'].includes(contentType)) {
                    const verifyId = GM_getValue('notion_verify_database_id', '');
                    if (verifyId) {
                        const titleText = comicData.æ ‡é¢˜ || comicData.ä¹¦å || (document.title || '');
                        const body = {
                            parent: { database_id: verifyId },
                            properties: {
                                "æ ‡é¢˜": { title: [{ text: { content: String(titleText || '') } }] },
                                "é“¾æ¥": { rich_text: [{ type: 'text', text: { content: String(sourceURL || '') } }] },
                                "æ˜ å°„": { select: { name: String(contentType) } }
                            }
                        };
                        await sendNotionRequest("POST", "https://api.notion.com/v1/pages", body);
                    }
                }
            } catch (_) {}

            // ç¼“å­˜é¡µé¢ID
            if (result && result.id) {
                try { GM_setValue(`lastPageId_${sourceURL}`, result.id); } catch(_) {}
            }
            return {...result, contentType, isUpdate: false};
        } catch (error) {
            console.error('åˆ›å»ºNotioné¡µé¢å¤±è´¥:', error);
            // å°è¯•è®°å½•æ›´å¤šä¿¡æ¯
            if (error.message.includes('Invalid image url')) {
                console.error('å›¾ç‰‡URLæ— æ•ˆã€‚è¯·æ£€æŸ¥å›¾ç‰‡é“¾æ¥æ˜¯å¦å¯è®¿é—®ï¼Œæˆ–å°è¯•ä¸åŒçš„å›¾ç‰‡ã€‚');
            }
            throw error;
        }
    }
    // æ›´æ–°ç°æœ‰Notioné¡µé¢
    async function updateNotionPage(pageId, comicData, sourceURL, contentType = 'comic') {
        const existingData = await getNotionPageProperties(pageId);
        const properties = await buildNotionProperties(comicData, sourceURL, existingData, contentType);

        // æ„å»ºè¯·æ±‚æ•°æ®
        const data = {
            properties: properties
        };

        if (comicData._domainIconUrl && isValidUrl(comicData._domainIconUrl)) {
            data.icon = {
                type: "external",
                external: { url: comicData._domainIconUrl }
            };
        }

        // æ·»åŠ å°é¢
        if (comicData.å°é¢) {
            data.cover = {
                type: "external",
                external: { url: comicData.å°é¢ }
            };
        }

        try {
            __setLastUpload({
                ts: Date.now(),
                op: 'update',
                contentType,
                title: comicData.æ ‡é¢˜ || comicData.ä¹¦å || '',
                link: sourceURL || '',
                cover: comicData.å°é¢ || '',
                properties: Object.keys(properties || {}),
                text: {
                    ç®€ä»‹: String(comicData.ç®€ä»‹ || ''),
                    å¤‡æ³¨: String(comicData.å¤‡æ³¨ || ''),
                    è¿½æ›´: String(comicData.è¿½æ›´ || '')
                },
                childrenCount: 0,
                imageBlocks: 0
            });
        } catch(_) {}

        // å¤„ç†å‰ªè—å†…å®¹ - ç›´æ¥æ›´æ–°é¡µé¢å†…å®¹è€Œä¸æ˜¯åˆ é™¤é‡å»º
        if (comicData.content) {
            try {
                console.log('æ›´æ–°å‰ªè—é¡µé¢:', pageId);

                // å…ˆæ›´æ–°å±æ€§
                const result = await sendNotionRequest("PATCH", `https://api.notion.com/v1/pages/${pageId}`, data);
                console.log('å±æ€§æ›´æ–°æˆåŠŸ');

                try {
                    // è·å–é¡µé¢ç°æœ‰å—
                    const existingBlocksResponse = await sendNotionRequest("GET", `https://api.notion.com/v1/blocks/${pageId}/children`, {});
                    console.log('è·å–ç°æœ‰å—:', existingBlocksResponse.results?.length || 0);

                    // å¦‚æœæœ‰ç°æœ‰å—ï¼Œåˆ é™¤å®ƒä»¬
                    if (existingBlocksResponse.results && existingBlocksResponse.results.length > 0) {
                        console.log(`åˆ é™¤${existingBlocksResponse.results.length}ä¸ªç°æœ‰å—`);

                        // ä½¿ç”¨æ›´å¯é çš„åˆ é™¤æ–¹æ³•ï¼šæ‰¹é‡åˆ é™¤
                        const deletePromises = existingBlocksResponse.results.map(async (block, index) => {
                            try {
                                console.log(`æ­£åœ¨åˆ é™¤å— ${index + 1}/${existingBlocksResponse.results.length}: ${block.id}`);
                                await sendNotionRequest("DELETE", `https://api.notion.com/v1/blocks/${block.id}`, {});
                                console.log(`æˆåŠŸåˆ é™¤å—: ${block.id}`);
                                return true;
                            } catch (error) {
                                console.error(`åˆ é™¤å—${block.id}å¤±è´¥:`, error);
                                return false;
                            }
                        });

                        // ç­‰å¾…æ‰€æœ‰åˆ é™¤æ“ä½œå®Œæˆ
                        const deleteResults = await Promise.allSettled(deletePromises);
                        const successCount = deleteResults.filter(result => result.status === 'fulfilled' && result.value === true).length;
                        const failCount = deleteResults.length - successCount;

                        console.log(`åˆ é™¤æ“ä½œå®Œæˆ: æˆåŠŸ${successCount}ä¸ªï¼Œå¤±è´¥${failCount}ä¸ª`);

                        // åˆ é™¤å®Œæˆåç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç¡®ä¿åˆ é™¤æ“ä½œå®Œæˆ
                        console.log('ç­‰å¾…åˆ é™¤æ“ä½œå®Œæˆ...');
                        await new Promise(resolve => setTimeout(resolve, 2000));

                        // éªŒè¯åˆ é™¤æ˜¯å¦æˆåŠŸ
                        try {
                            const verifyResponse = await sendNotionRequest("GET", `https://api.notion.com/v1/blocks/${pageId}/children`, {});
                            console.log('åˆ é™¤åéªŒè¯ï¼Œå‰©ä½™å—æ•°é‡:', verifyResponse.results?.length || 0);

                            if (verifyResponse.results && verifyResponse.results.length > 0) {
                                console.warn('è­¦å‘Š: åˆ é™¤åä»æœ‰å—å­˜åœ¨ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ¸…ç†');
                            }
                        } catch (verifyError) {
                            console.error('éªŒè¯åˆ é™¤ç»“æœå¤±è´¥:', verifyError);
                        }
                    }
                } catch (blockError) {
                    console.error('è·å–æˆ–åˆ é™¤ç°æœ‰å—å¤±è´¥ï¼Œç»§ç»­å°è¯•æ·»åŠ æ–°å†…å®¹:', blockError);
                    // å³ä½¿æ— æ³•åˆ é™¤æ—§å—ï¼Œä¹Ÿå°è¯•æ·»åŠ æ–°å—
                }

                const cfg = getMarkdownTransformConfig();
                if (cfg.enabled && !comicData._mdTransformApplied) {
                    try { comicData.content = applyMarkdownTransformRules(comicData.content, cfg.rules); } catch(_) {}
                }
                window.__CURRENT_CONTENT_TYPE__ = contentType || '';
                const blocks = await convertToNotionBlocks(comicData.content);
                console.log('è½¬æ¢å†…å®¹ä¸ºå—ï¼Œå—æ•°é‡:', blocks.length);

                try {
                    // åˆ¤æ–­å—æ•°é‡æ˜¯å¦è¶…è¿‡100ä¸ª
                    if (blocks.length > 100) {
                        console.log(`æ›´æ–°å†…å®¹åŒ…å«${blocks.length}ä¸ªå—ï¼Œè¶…è¿‡Notion API 100ä¸ªå—çš„é™åˆ¶ï¼Œå°†åˆ†æ‰¹å¤„ç†`);
                        showNotification(`å†…å®¹è¾ƒé•¿ï¼Œå°†åˆ†${Math.ceil(blocks.length / 90)}æ‰¹æ›´æ–°`, 'info');

                        // æ‰¹æ¬¡å¤§å°ä¸º90ä¸ªå—
                        const batchSize = 90;
                        const totalBatches = Math.ceil(blocks.length / batchSize);

                        // æ·»åŠ ç¬¬ä¸€æ‰¹
                        console.log(`æ·»åŠ ç¬¬1/${totalBatches}æ‰¹ï¼ŒåŒ…å«${Math.min(batchSize, blocks.length)}ä¸ªå—`);
                        await sendNotionRequest("PATCH", `https://api.notion.com/v1/blocks/${pageId}/children`, {
                            children: blocks.slice(0, batchSize)
                        });

                        // æ·»åŠ å‰©ä½™æ‰¹æ¬¡
                        for (let batchIndex = 1; batchIndex < totalBatches; batchIndex++) {
                            const start = batchIndex * batchSize;
                            const end = Math.min(start + batchSize, blocks.length);
                            const currentBatch = blocks.slice(start, end);

                            console.log(`æ·»åŠ ç¬¬${batchIndex + 1}/${totalBatches}æ‰¹ï¼ŒåŒ…å«${currentBatch.length}ä¸ªå—`);
                            try {
                                // åœ¨ä¸¤æ¬¡è¯·æ±‚ä¹‹é—´æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…APIé™åˆ¶
                                await new Promise(resolve => setTimeout(resolve, 500));

                                await sendNotionRequest("PATCH", `https://api.notion.com/v1/blocks/${pageId}/children`, {
                                    children: currentBatch
                                });

                                console.log(`ç¬¬${batchIndex + 1}æ‰¹æ·»åŠ æˆåŠŸ`);
                            } catch (batchError) {
                                console.error(`ç¬¬${batchIndex + 1}æ‰¹æ·»åŠ å¤±è´¥:`, batchError);
                                showNotification(`ç¬¬${batchIndex + 1}æ‰¹å†…å®¹å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•`, 'warning');
                            }
                        }
                    } else {
                        // å—æ•°é‡ä¸å¤šï¼Œç›´æ¥æ·»åŠ 
                        await sendNotionRequest("PATCH", `https://api.notion.com/v1/blocks/${pageId}/children`, {
                            children: blocks
                        });
                    }
                    console.log('æ·»åŠ æ–°å—æˆåŠŸ');
                } catch (addBlockError) {
                    console.error('æ·»åŠ æ–°å—å¤±è´¥:', addBlockError);
                    // å±æ€§å·²æ›´æ–°ï¼Œå³ä½¿å—æ·»åŠ å¤±è´¥ï¼Œä¹Ÿè®¤ä¸ºæ˜¯éƒ¨åˆ†æˆåŠŸ
                    return {...result, contentType, warning: 'å†…å®¹éƒ¨åˆ†æ›´æ–°æˆåŠŸï¼Œä½†å—æ·»åŠ å¤±è´¥'};
                }

                return {...result, contentType}; // è¿”å›ç»“æœ
            } catch (error) {
                console.error('æ›´æ–°å‰ªè—å†…å®¹å¤±è´¥:', error);
                throw error;
            }
        }

        const result = await sendNotionRequest("PATCH", `https://api.notion.com/v1/pages/${pageId}`, data);
        return {...result, contentType, isUpdate: true}; // æ·»åŠ contentTypeåˆ°ç»“æœä¸­
    }
    // æ„å»ºNotionå±æ€§å¯¹è±¡
    async function buildNotionProperties(comicData, sourceURL, existingData = null, contentType = 'comic') {
        const properties = {};
        const databaseId = resolveDatabaseId(contentType === 'record' ? 'clip' : contentType);
        const dbInfo = await getDatabaseInfo(databaseId);
        const dbProps = (dbInfo && dbInfo.properties) || {};
        const titlePropName = (() => {
            try { for (const [n, d] of Object.entries(dbProps)) { if (d && d.type === 'title') return n; } } catch (_) {}
            if (dbProps["æ ‡é¢˜"]) return "æ ‡é¢˜";
            if (dbProps["ä¹¦å"]) return "ä¹¦å";
            if (dbProps["Name"]) return "Name";
            return null;
        })();

        // record æ¨¡å¼ä¸åŠ é“¾æ¥ï¼›å…¶ä»–ç±»å‹ä¿ç•™é“¾æ¥
        if (contentType !== 'record') {
            properties["é“¾æ¥"] = {
                rich_text: [{
                    text: {
                        content: sourceURL,
                        link: { url: sourceURL }
                    }
                }]
            };
        }

        // å¤„ç†å°é¢å±æ€§ - åªæœ‰åœ¨comicDataä¸­æœ‰å°é¢æ•°æ®ä¸”ä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ 
        // åŒæ—¶æ£€æŸ¥æ•°æ®åº“æ˜¯å¦åŒ…å«"å°é¢"å±æ€§ï¼Œé¿å…validation_error
        if (comicData.å°é¢ && comicData.å°é¢.trim() !== '') {
            const hasCoverProperty = await checkDatabaseProperty(databaseId, "å°é¢");
            if (hasCoverProperty) {
                properties["å°é¢"] = {
                    files: [{
                        name: "å°é¢å›¾ç‰‡",
                        external: {
                            url: comicData.å°é¢
                        }
                    }]
                };
            } else {
                console.warn('æ•°æ®åº“ä¸åŒ…å«"å°é¢"å±æ€§ï¼Œè·³è¿‡å°é¢å±æ€§è®¾ç½®');
            }
        }

        // å¿«é€Ÿæ”¶è—ï¼šä¸ºå‰ªè—æ·»åŠ é»˜è®¤è‡ªå®šä¹‰æ ‡ç­¾"æœªå¤„ç†"ï¼ˆä»…åœ¨ç”¨æˆ·æ˜ç¡®å¯ç”¨æ—¶ï¼‰
        // æ³¨é‡Šï¼šç”¨æˆ·åé¦ˆä¸éœ€è¦è‡ªåŠ¨æ·»åŠ "æœªå¤„ç†"æ ‡ç­¾ï¼Œå› æ­¤ç§»é™¤è‡ªåŠ¨æ·»åŠ é€»è¾‘
        // if (contentType === 'clip' && (!comicData || !comicData.è‡ªå®šä¹‰æ ‡ç­¾)) {
        //     const existingColors = await getExistingTagColors(databaseId, "è‡ªå®šä¹‰æ ‡ç­¾");
        //     properties["è‡ªå®šä¹‰æ ‡ç­¾"] = await formatMultiSelect(["æœªå¤„ç†"], "pink", existingColors);
        // }
        // record æ¨¡å¼ï¼šä¸æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾

        // å¤„ç†ä¸åŒç±»å‹çš„æ•°æ®
        if (contentType === 'clip' || contentType === 'record') {
            // å‰ªè—ç±»å‹åªéœ€è¦æ ‡é¢˜ã€ä½œè€…ã€ç±»å‹å­—æ®µ
            if (comicData.æ ‡é¢˜ && titlePropName) {
                // å¤„ç†æ ‡é¢˜ï¼Œå»é™¤ä¹¦åå·
                let title = comicData.æ ‡é¢˜ || "æœªå‘½åå‰ªè—";
                // å¦‚æœæ ‡é¢˜è¢«ä¹¦åå·åŒ…å›´ï¼Œåˆ™å»é™¤ä¹¦åå·
                if (title.startsWith('ã€Š') && title.endsWith('ã€‹')) {
                    title = title.substring(1, title.length - 1);
                }
                properties[titlePropName] = {
                    title: [{
                        text: {
                            content: title
                        }
                    }]
                };
            }
            if (contentType === 'clip' && comicData.ä½œè€… && comicData.ä½œè€….trim() !== '' && dbProps["ä½œè€…"]) properties["ä½œè€…"] = formatRichText(comicData.ä½œè€…);
            if (contentType === 'clip' && comicData.ç±»å‹ && dbProps["ç±»å‹"]) {
                // å‰ªè—æ¨¡å¼ä½¿ç”¨å¤šé€‰ç±»å‹å±æ€§ï¼Œæ”¯æŒé¢œè‰²
                const types = Array.isArray(comicData.ç±»å‹) ? comicData.ç±»å‹ : [comicData.ç±»å‹];
                // è·å–æ•°æ®åº“ä¸­å·²å­˜åœ¨çš„æ ‡ç­¾é¢œè‰²
                const existingColors = await getExistingTagColors(databaseId, "ç±»å‹");
                // å¦‚æœtypesæ˜¯å¯¹è±¡æ•°ç»„ï¼ˆåŒ…å«é¢œè‰²ä¿¡æ¯ï¼‰ï¼Œç›´æ¥ä¼ é€’ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é¢œè‰²
                if (types.length > 0 && typeof types[0] === 'object' && types[0].name) {
                    properties["ç±»å‹"] = await formatMultiSelect(types, "default", existingColors);
                } else {
                    properties["ç±»å‹"] = await formatMultiSelect(types, "pink", existingColors);
                }
            }
            // åŠ¨æ€æ˜ å°„è‡ªå®šä¹‰åˆ†ç»„åˆ°å¯¹åº”çš„Notionå±æ€§ï¼ˆä¸ºæ–°æ ‡ç­¾è®¾ç½®é¢œè‰²ï¼Œå·²å­˜åœ¨çš„ä¸å˜ï¼‰
            const customGroupKeys = Object.keys(comicData || {}).filter(key => {
                if (!key) return false;
                // è·³è¿‡å·²çŸ¥å›ºå®šå­—æ®µï¼Œå‰©ä¸‹çš„è§†ä¸ºå¯èƒ½çš„è‡ªå®šä¹‰åˆ†ç»„å±æ€§
                const skip = ["é“¾æ¥","æ ‡é¢˜","ä½œè€…","ç±»å‹","å¤‡æ³¨","ä¹¦å","ç®€ä»‹","åˆ«å","æœ€æ–°ç« èŠ‚","åœ°åŒº","æ›´æ–°çŠ¶æ€","è¯„åˆ†","è‡ªå®šä¹‰æ ‡ç­¾","å°é¢","content","è¿½æ›´"];
                return !skip.includes(key) && comicData[key];
            });

            // ä½¿ç”¨Promise.allç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆ
            const customGroupPromises = customGroupKeys.map(async (key) => {
                const value = comicData[key];
                if (!dbProps[key]) return { key, result: null };
                const valuesArr = Array.isArray(value) ? value : [value];
                // è·å–æ•°æ®åº“ä¸­å·²å­˜åœ¨çš„è¯¥å­—æ®µçš„æ ‡ç­¾é¢œè‰²
                const existingColors = await getExistingTagColors(databaseId, key);

                // æ£€æŸ¥æ˜¯å¦ä¸ºå¯¹è±¡æ•°ç»„ï¼ˆåŒ…å«é¢œè‰²ä¿¡æ¯ï¼‰
                if (valuesArr.length > 0 && typeof valuesArr[0] === 'object' && valuesArr[0].name) {
                    // å¯¹è±¡æ•°ç»„ï¼Œç›´æ¥ä¼ é€’
                    return { key, result: await formatMultiSelect(valuesArr, "default", existingColors) };
                } else {
                    // å­—ç¬¦ä¸²æ•°ç»„ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                    return { key, result: await formatMultiSelect(valuesArr.map(v => String(v)), "pink", existingColors) };
                }
            });

            const customGroupResults = await Promise.all(customGroupPromises);
            customGroupResults.forEach(({ key, result }) => { if (result) properties[key] = result; });

            if (contentType === 'clip' && comicData.è‡ªå®šä¹‰æ ‡ç­¾ && dbProps["è‡ªå®šä¹‰æ ‡ç­¾"]) {
                const customTags = Array.isArray(comicData.è‡ªå®šä¹‰æ ‡ç­¾) ? comicData.è‡ªå®šä¹‰æ ‡ç­¾ : [comicData.è‡ªå®šä¹‰æ ‡ç­¾];
                const existingColors = await getExistingTagColors(databaseId, "è‡ªå®šä¹‰æ ‡ç­¾");
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¯¹è±¡æ•°ç»„ï¼ˆåŒ…å«é¢œè‰²ä¿¡æ¯ï¼‰
                if (customTags.length > 0 && typeof customTags[0] === 'object' && customTags[0].name) {
                    // å¯¹è±¡æ•°ç»„ï¼Œç›´æ¥ä¼ é€’
                    properties["è‡ªå®šä¹‰æ ‡ç­¾"] = await formatMultiSelect(customTags, "default", existingColors);
                } else {
                    // å­—ç¬¦ä¸²æ•°ç»„ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                    properties["è‡ªå®šä¹‰æ ‡ç­¾"] = await formatMultiSelect(customTags, "pink", existingColors);
                }
            }
            if (contentType === 'clip' && comicData.å¤‡æ³¨ && comicData.å¤‡æ³¨.trim() !== '' && dbProps["å¤‡æ³¨"]) properties["å¤‡æ³¨"] = formatRichText(comicData.å¤‡æ³¨);



            return properties;
        }

        // æ¼«ç”»æˆ–å°è¯´ç±»å‹çš„å±æ€§å¤„ç†
        // åªåœ¨ä¹¦åå­˜åœ¨æ—¶æ·»åŠ 
        if (comicData.ä¹¦å && titlePropName) {
            // ä¸ºä¹¦åå»é™¤ä¹¦åå·
            let bookTitle = comicData.ä¹¦å || "æœªå‘½åæ¼«ç”»";
            // å¦‚æœä¹¦åè¢«ä¹¦åå·åŒ…å›´ï¼Œåˆ™å»é™¤ä¹¦åå·
            if (bookTitle.startsWith('ã€Š') && bookTitle.endsWith('ã€‹')) {
                bookTitle = bookTitle.substring(1, bookTitle.length - 1);
            }
            properties[titlePropName] = {
                title: [{
                    text: {
                        content: bookTitle
                    }
                }]
            };
        }

        // æ·»åŠ å…¶ä»–å¯é€‰å­—æ®µ
        if (comicData.ç®€ä»‹ && comicData.ç®€ä»‹.trim() !== '' && dbProps["ç®€ä»‹"]) properties["ç®€ä»‹"] = formatRichText(comicData.ç®€ä»‹);
        if (comicData.å¤‡æ³¨ && comicData.å¤‡æ³¨.trim() !== '' && dbProps["å¤‡æ³¨"]) properties["å¤‡æ³¨"] = formatRichText(comicData.å¤‡æ³¨);

        // å¤„ç†è¿½æ›´å­—æ®µ - å¦‚æœæ–°æ•°æ®ä¸ºç©ºä¸”å­˜åœ¨ç°æœ‰æ•°æ®ï¼Œä¿ç•™ç°æœ‰æ•°æ®
        if (comicData.è¿½æ›´ && comicData.è¿½æ›´.trim() !== '' && dbProps["è¿½æ›´"]) {
            properties["è¿½æ›´"] = formatRichText(comicData.è¿½æ›´);
        } else if (existingData && existingData.è¿½æ›´ && dbProps["è¿½æ›´"]) {
            // ä¿ç•™ç°æœ‰çš„è¿½æ›´æ•°æ®
            properties["è¿½æ›´"] = formatRichText(existingData.è¿½æ›´);
        }

        if (comicData.ä½œè€… && comicData.ä½œè€….trim() !== '' && dbProps["ä½œè€…"]) properties["ä½œè€…"] = formatRichText(comicData.ä½œè€…);
        if (comicData.åˆ«å && comicData.åˆ«å.trim() !== '' && dbProps["åˆ«å"]) properties["åˆ«å"] = formatRichText(comicData.åˆ«å);
        if (comicData.æœ€æ–°ç« èŠ‚ && comicData.æœ€æ–°ç« èŠ‚.trim() !== '' && dbProps["æœ€æ–°ç« èŠ‚"]) properties["æœ€æ–°ç« èŠ‚"] = formatRichText(comicData.æœ€æ–°ç« èŠ‚);
        if (comicData.åœ°åŒº && dbProps["åœ°åŒº"]) properties["åœ°åŒº"] = formatSelect(comicData.åœ°åŒº, "pink");
        if (comicData.ç±»å‹) {
            // æ”¯æŒå•é€‰æˆ–å¤šé€‰ï¼šæ•°ç»„åˆ™å¤šé€‰ï¼Œå¦åˆ™å•é€‰
            if (Array.isArray(comicData.ç±»å‹) && dbProps["ç±»å‹"]) {
                // è·å–æ•°æ®åº“ä¸­å·²å­˜åœ¨çš„æ ‡ç­¾é¢œè‰²
                const existingColors = await getExistingTagColors(databaseId, "ç±»å‹");
                // å¦‚æœcomicData.ç±»å‹æ˜¯å¯¹è±¡æ•°ç»„ï¼ˆåŒ…å«é¢œè‰²ä¿¡æ¯ï¼‰ï¼Œç›´æ¥ä¼ é€’ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é¢œè‰²
                if (comicData.ç±»å‹.length > 0 && typeof comicData.ç±»å‹[0] === 'object' && comicData.ç±»å‹[0].name) {
                    properties["ç±»å‹"] = await formatMultiSelect(comicData.ç±»å‹, "default", existingColors);
                } else {
                    properties["ç±»å‹"] = await formatMultiSelect(comicData.ç±»å‹, "pink", existingColors);
                }
            } else if (dbProps["ç±»å‹"]) {
                properties["ç±»å‹"] = formatSelect(comicData.ç±»å‹, "pink");
            }
        }
        // åŠ¨æ€æ˜ å°„è‡ªå®šä¹‰åˆ†ç»„åˆ°å¯¹åº”çš„Notionå±æ€§ï¼ˆæ¼«ç”»/å°è¯´ï¼‰ï¼ˆä¸ºæ–°æ ‡ç­¾è®¾ç½®é¢œè‰²ï¼Œå·²å­˜åœ¨çš„ä¸å˜ï¼‰
        const customGroupKeys = Object.keys(comicData || {}).filter(key => {
            if (!key) return false;
            const skip = ["é“¾æ¥","æ ‡é¢˜","ä½œè€…","ç±»å‹","å¤‡æ³¨","ä¹¦å","ç®€ä»‹","åˆ«å","æœ€æ–°ç« èŠ‚","åœ°åŒº","æ›´æ–°çŠ¶æ€","è¯„åˆ†","è‡ªå®šä¹‰æ ‡ç­¾","å°é¢","content","è¿½æ›´"];
            return !skip.includes(key) && comicData[key];
        });

        // ä½¿ç”¨Promise.allç­‰å¾…æ‰€æœ‰å¼‚æ­¥æ“ä½œå®Œæˆ
        const customGroupPromises = customGroupKeys.map(async (key) => {
            const value = comicData[key];
            if (!dbProps[key]) return { key, result: null };
            const valuesArr = Array.isArray(value) ? value : [value];
            const existingColors = await getExistingTagColors(databaseId, key);

            // æ£€æŸ¥æ˜¯å¦ä¸ºå¯¹è±¡æ•°ç»„ï¼ˆåŒ…å«é¢œè‰²ä¿¡æ¯ï¼‰
            if (valuesArr.length > 0 && typeof valuesArr[0] === 'object' && valuesArr[0].name) {
                // å¯¹è±¡æ•°ç»„ï¼Œç›´æ¥ä¼ é€’
                return { key, result: await formatMultiSelect(valuesArr, "default", existingColors) };
            } else {
                // å­—ç¬¦ä¸²æ•°ç»„ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                return { key, result: await formatMultiSelect(valuesArr.map(v => String(v)), "pink", existingColors) };
            }
        });

        const customGroupResults = await Promise.all(customGroupPromises);
        customGroupResults.forEach(({ key, result }) => { if (result) properties[key] = result; });

        if (comicData.è‡ªå®šä¹‰æ ‡ç­¾ && dbProps["è‡ªå®šä¹‰æ ‡ç­¾"]) {
            const customTags = Array.isArray(comicData.è‡ªå®šä¹‰æ ‡ç­¾) ? comicData.è‡ªå®šä¹‰æ ‡ç­¾ : [comicData.è‡ªå®šä¹‰æ ‡ç­¾];
            const existingColors = await getExistingTagColors(databaseId, "è‡ªå®šä¹‰æ ‡ç­¾");
            // æ£€æŸ¥æ˜¯å¦ä¸ºå¯¹è±¡æ•°ç»„ï¼ˆåŒ…å«é¢œè‰²ä¿¡æ¯ï¼‰
            if (customTags.length > 0 && typeof customTags[0] === 'object' && customTags[0].name) {
                // å¯¹è±¡æ•°ç»„ï¼Œç›´æ¥ä¼ é€’
                properties["è‡ªå®šä¹‰æ ‡ç­¾"] = await formatMultiSelect(customTags, "default", existingColors);
            } else {
                // å­—ç¬¦ä¸²æ•°ç»„ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                properties["è‡ªå®šä¹‰æ ‡ç­¾"] = await formatMultiSelect(customTags, "pink", existingColors);
            }
        }
        if (comicData.æ›´æ–°çŠ¶æ€ && dbProps["æ›´æ–°çŠ¶æ€"]) properties["æ›´æ–°çŠ¶æ€"] = formatSelect(comicData.æ›´æ–°çŠ¶æ€, "default");

        // æ·»åŠ è¯„åˆ†å­—æ®µæ”¯æŒ
        if (RATING_CONFIG.enabled && comicData.è¯„åˆ† !== undefined && comicData.è¯„åˆ† !== null && dbProps[RATING_CONFIG.ratingField]) {
            const ratingFieldName = RATING_CONFIG.ratingField;
            properties[ratingFieldName] = {
                number: parseFloat(comicData.è¯„åˆ†) || 0
            };
        }

        return properties;
    }

    // å‘é€Notion APIè¯·æ±‚
    const NotionRequestQueue = (() => {
        const q = [];
        let running = false;
        let last = 0;
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        async function run() {
            if (running) return;
            running = true;
            while (q.length) {
                const minInterval = GM_getValue('notion_rate_limit_ms', 800);
                const now = Date.now();
                const wait = Math.max(0, minInterval - (now - last));
                if (wait) await sleep(wait);
                last = Date.now();
                const item = q.shift();
                try {
                    const res = await item.fn();
                    item.resolve(res);
                } catch (e) {
                    item.reject(e);
                }
            }
            running = false;
        }
        return {
            enqueue(fn) {
                return new Promise((resolve, reject) => {
                    q.push({ fn, resolve, reject });
                    run();
                });
            }
        };
    })();
    const REQUEST_CACHE = new Map();
    const REQUEST_CACHE_EXPIRY = new Map();
    const INFLIGHT_GET = new Map();
    function shouldCacheGet(url) { return /\/v1\/databases\//.test(url) || /\/v1\/pages\//.test(url) || /\/v1\/blocks\//.test(url); }
    if (!window.__API_DEBUG__) {
        window.__API_DEBUG__ = {
            enabled: GM_getValue('api_debug_enabled', true),
            notion: { total: 0, methods: {}, paths: {}, requests: [] },
            github: { total: 0, methods: {}, paths: {}, requests: [] },
            extraction: { last: null },
            upload: { last: null }
        };
    }
    function __incApi(vendor, method, url) {
        try {
            const v = window.__API_DEBUG__[vendor];
            if (!v) return;
            v.total = (v.total || 0) + 1;
            const m = String(method || '').toUpperCase();
            v.methods[m] = (v.methods[m] || 0) + 1;
            const path = String(url || '').replace(/^https?:\/\/[^/]+/i, '');
            v.paths[path] = (v.paths[path] || 0) + 1;
        } catch (_) {}
    }
    function __getApiSummary() {
        const n = window.__API_DEBUG__.notion;
        const g = window.__API_DEBUG__.github;
        function sum(obj) { return Object.entries(obj || {}).map(([k,v]) => `${k}:${v}`).join(' '); }
        return `Notion æ€»:${n.total} ${sum(n.methods)}\nGitHub æ€»:${g.total} ${sum(g.methods)}`;
    }
    function __resetApiCounters() {
        window.__API_DEBUG__.notion = { total: 0, methods: {}, paths: {} };
        window.__API_DEBUG__.github = { total: 0, methods: {}, paths: {} };
    }
    function getCacheTTL(url) {
        if (/\/v1\/databases\//.test(url)) return GM_getValue('notion_db_cache_ttl_ms', 600000);
        return GM_getValue('notion_get_cache_ttl_ms', 10000);
    }
    function invalidateRelatedCaches(url) {
        try {
            const path = String(url || '').replace(/^https?:\/\/[^/]+/i, '');
            let ids = [];
            const pageMatch = path.match(/\/v1\/pages\/([^/?]+)/);
            if (pageMatch && pageMatch[1]) {
                const id = pageMatch[1];
                ids.push(`GET https://api.notion.com/v1/pages/${id}`);
                ids.push(`GET https://api.notion.com/v1/blocks/${id}/children`);
            }
            const blockMatch = path.match(/\/v1\/blocks\/([^/?]+)/);
            if (blockMatch && blockMatch[1]) {
                const id = blockMatch[1];
                ids.push(`GET https://api.notion.com/v1/blocks/${id}`);
                ids.push(`GET https://api.notion.com/v1/blocks/${id}/children`);
            }
            if (!ids.length) return;
            for (const k of Array.from(REQUEST_CACHE.keys())) {
                if (ids.includes(k)) {
                    REQUEST_CACHE.delete(k);
                    REQUEST_CACHE_EXPIRY.delete(k);
                    INFLIGHT_GET.delete(k);
                }
            }
        } catch(_) {}
    }
    function __pushApiEvent(vendor, ev) {
        try {
            const v = window.__API_DEBUG__[vendor];
            if (!v) return;
            const arr = v.requests || (v.requests = []);
            arr.push(ev);
            const max = GM_getValue('api_debug_max_events', 50);
            if (arr.length > max) arr.splice(0, arr.length - max);
        } catch(_) {}
    }
    function __setLastExtract(obj) {
        try {
            window.__API_DEBUG__.extraction = window.__API_DEBUG__.extraction || {};
            window.__API_DEBUG__.extraction.last = obj;
        } catch(_) {}
    }
    function __setLastUpload(obj) {
        try {
            window.__API_DEBUG__.upload = window.__API_DEBUG__.upload || {};
            window.__API_DEBUG__.upload.last = obj;
        } catch(_) {}
    }
    function __safeLen(v) {
        try { return typeof v === 'string' ? v.length : 0; } catch(_){ return 0; }
    }
    function sendNotionRequest(method, url, data, attempt) {
        const tries = typeof attempt === 'number' ? attempt : 0;
        if (!NOTION_CONFIG.apiKey) return Promise.reject(new Error('Notion APIå¯†é’¥æœªé…ç½®'));
        const key = `${method} ${url}`;
        if (method === 'GET' && shouldCacheGet(url)) {
            const exp = REQUEST_CACHE_EXPIRY.get(key);
            const val = REQUEST_CACHE.get(key);
            if (exp && exp > Date.now() && val) return Promise.resolve(val);
            const inflight = INFLIGHT_GET.get(key);
            if (inflight) return inflight;
        }
        const timeout = GM_getValue('requestTimeout', 10000);
        const requestIsClip = data && data.properties ? (data.properties.æ ‡é¢˜ && !data.properties.ä¹¦å) : false;
        const requestTitle = (() => {
            if (data && data.properties) {
                if (requestIsClip) return (data.properties.æ ‡é¢˜?.title?.[0]?.text?.content || "æœªå‘½åå‰ªè—");
                return (data.properties.ä¹¦å?.title?.[0]?.text?.content || "æœªå‘½åæ¼«ç”»");
            }
            return "æœªå‘½å";
        })();
        const run = () => new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                method,
                url,
                headers: {
                    "Authorization": `Bearer ${NOTION_CONFIG.apiKey}`,
                    "Content-Type": "application/json",
                    "Notion-Version": "2022-06-28"
                },
                data: data ? JSON.stringify(data) : undefined,
                timeout: timeout,
                onload: function(response) {
                    if (response.status === 429) {
                        const maxRetry = 3;
                        if (tries < maxRetry) {
                            const backoff = Math.min(5000, 1000 * Math.pow(2, tries));
                            setTimeout(() => {
                                sendNotionRequest(method, url, data, tries + 1).then(resolve).catch(reject);
                            }, backoff);
                            return;
                        } else {
                            reject(new Error('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•'));
                            return;
                        }
                    }
                    if (response.status >= 200 && response.status < 300) {
                        try {
                            const result = JSON.parse(response.responseText);
                            try {
                                const p = String(url).replace(/^https?:\/\/[^/]+/i,'');
                                const ev = { ts: Date.now(), method, path: p, status: response.status };
                                if (typeof result === 'object' && result) {
                                    ev.pageId = result.id || '';
                                    ev.responseUrl = result.url || '';
                                    if (Array.isArray(result.results)) ev.results = result.results.length;
                                }
                                if (data && data.properties && method !== 'GET') {
                                    ev.title = requestTitle;
                                    ev.contentType = requestIsClip ? 'clip' : 'comic';
                                    ev.properties = Object.keys(data.properties);
                                    ev.text = {
                                        ç®€ä»‹: data.properties.ç®€ä»‹ && data.properties.ç®€ä»‹.rich_text ? __safeLen((data.properties.ç®€ä»‹.rich_text || []).map(x => String((x && x.text && x.text.content) || '')).join('')) : 0,
                                        å¤‡æ³¨: data.properties.å¤‡æ³¨ && data.properties.å¤‡æ³¨.rich_text ? __safeLen((data.properties.å¤‡æ³¨.rich_text || []).map(x => String((x && x.text && x.text.content) || '')).join('')) : 0,
                                        è¿½æ›´: data.properties.è¿½æ›´ && data.properties.è¿½æ›´.rich_text ? __safeLen((data.properties.è¿½æ›´.rich_text || []).map(x => String((x && x.text && x.text.content) || '')).join('')) : 0
                                    };
                                    ev.childrenCount = Array.isArray(data.children) ? data.children.length : 0;
                                }
                                __pushApiEvent('notion', ev);
                            } catch(_) {}
                            if (method === "GET") {
                                resolve(result);
                                return;
                            }
                            resolve({
                                success: true,
                                isUpdate: method === "PATCH",
                                title: requestTitle,
                                url: result.url,
                                contentType: requestIsClip ? 'clip' : 'comic',
                                ...result
                            });
                        } catch (parseError) {
                            reject(new Error(`è§£æå“åº”å¤±è´¥: ${parseError.message}`));
                        }
                    } else {
                        try {
                            const error = JSON.parse(response.responseText);
                            if (error.code === 'validation_error' && error.message && error.message.includes('archived')) {
                                const pageId = url.includes('/pages/') ? url.split('/pages/')[1] : 'æœªçŸ¥é¡µé¢ID';
                                const notionUrl = `https://notion.so/${pageId}`;
                                showNotification('é¡µé¢å·²è¢«å½’æ¡£ï¼Œè¯·å…ˆå–æ¶ˆå½’æ¡£', 'warning');
                                setTimeout(() => {
                                    reject(new Error(`é¡µé¢å·²è¢«å½’æ¡£ï¼Œæ— æ³•ç¼–è¾‘ã€‚\né¡µé¢é“¾æ¥: ${notionUrl}`));
                                }, 1000);
                            } else if (error.code === 'validation_error' && error.message && error.message.includes('Select option color doesn\'t match existing')) {
                                if (data && data.properties) {
                                    const modifiedData = JSON.parse(JSON.stringify(data));
                                    let hasModified = false;
                                    for (const [k, v] of Object.entries(modifiedData.properties)) {
                                        if (v && v.multi_select && Array.isArray(v.multi_select)) {
                                            const modifiedSelect = v.multi_select.map(item => {
                                                if (item.color) {
                                                    hasModified = true;
                                                    const { color, ...rest } = item;
                                                    return rest;
                                                }
                                                return item;
                                            });
                                            if (hasModified) {
                                                modifiedData.properties[k] = { ...v, multi_select: modifiedSelect };
                                            }
                                        }
                                    }
                                    if (hasModified) {
                                        showNotification('æ ‡ç­¾é¢œè‰²å†²çªï¼Œå·²è‡ªåŠ¨ç§»é™¤é¢œè‰²é‡æ–°å¯¼å…¥', 'info');
                                        sendNotionRequest(method, url, modifiedData).then(resolve).catch(reject);
                                        return;
                                    }
                                }
                                reject(new Error(`${error.code || 'æœªçŸ¥é”™è¯¯'}: ${error.message || 'è¯·æ±‚å¤±è´¥'}`));
                            } else if (error.code === 'validation_error' && error.message && error.message.includes('is not a property that exists')) {
                                const propertyMatch = error.message.match(/([^"]+) is not a property that exists/);
                                if (propertyMatch && data && data.properties) {
                                    const invalidProperty = propertyMatch[1];
                                    const modifiedData = JSON.parse(JSON.stringify(data));
                                    delete modifiedData.properties[invalidProperty];
                                    __incApi('notion', method, url);
                                    GM_xmlhttpRequest({
                                        method,
                                        url,
                                        headers: {
                                            "Authorization": `Bearer ${NOTION_CONFIG.apiKey}`,
                                            "Content-Type": "application/json",
                                            "Notion-Version": "2022-06-28"
                                        },
                                        data: JSON.stringify(modifiedData),
                                        timeout: timeout,
                                        onload: function(retryResponse) {
                                            if (retryResponse.status >= 200 && retryResponse.status < 300) {
                                                try {
                                                    const retryResult = JSON.parse(retryResponse.responseText);
                                                    resolve({
                                                        success: true,
                                                        isUpdate: method === "PATCH",
                                                        title: requestTitle,
                                                        url: retryResult.url,
                                                        contentType: requestIsClip ? 'clip' : 'comic',
                                                        warning: `å·²è‡ªåŠ¨ç§»é™¤ä¸å­˜åœ¨çš„å±æ€§: ${invalidProperty}`,
                                                        ...retryResult
                                                    });
                                                } catch (retryParseError) {
                                                    reject(new Error(`é‡è¯•åè§£æå“åº”å¤±è´¥: ${retryParseError.message}`));
                                                }
                                            } else {
                                                reject(new Error(`${error.code || 'æœªçŸ¥é”™è¯¯'}: ${error.message || 'è¯·æ±‚å¤±è´¥'}`));
                                            }
                                        },
                                        onerror: function() {
                                            reject(new Error(`${error.code || 'æœªçŸ¥é”™è¯¯'}: ${error.message || 'è¯·æ±‚å¤±è´¥'}`));
                                        }
                                    });
                                    return;
                                }
                                reject(new Error(`${error.code || 'æœªçŸ¥é”™è¯¯'}: ${error.message || 'è¯·æ±‚å¤±è´¥'}`));
                            } else {
                                reject(new Error(`${error.code || 'æœªçŸ¥é”™è¯¯'}: ${error.message || 'è¯·æ±‚å¤±è´¥'}`));
                            }
                        } catch (_) {
                            reject(new Error(`è¯·æ±‚å¤±è´¥: çŠ¶æ€ç ${response.status}`));
                        }
                    }
                },
                onerror: function(error) {
                    reject(new Error(`è¯·æ±‚å¤±è´¥: ${error ? error.message : 'æœªçŸ¥é”™è¯¯'}`));
                },
                ontimeout: function() {
                    reject(new Error('è¯·æ±‚è¶…æ—¶'));
                }
            });
        });
        __incApi('notion', method, url);
        const p = NotionRequestQueue.enqueue(run);
        if (method === 'GET' && shouldCacheGet(url)) {
            INFLIGHT_GET.set(key, p);
            return p.then(res => {
                INFLIGHT_GET.delete(key);
                const ttl = getCacheTTL(url);
                REQUEST_CACHE.set(key, res);
                REQUEST_CACHE_EXPIRY.set(key, Date.now() + ttl);
                return res;
            }).catch(err => {
                INFLIGHT_GET.delete(key);
                throw err;
            });
        }
        return p;
    }

    async function getDatabaseInfo(databaseId) {
        try {
            return await sendNotionRequest("GET", `https://api.notion.com/v1/databases/${databaseId}`);
        } catch (e) {
            return null;
        }
    }

    function findTitlePropertyName(dbInfo) {
        try {
            const props = (dbInfo && dbInfo.properties) || {};
            for (const [name, def] of Object.entries(props)) {
                if (def && def.type === 'title') return name;
            }
            return null;
        } catch (_) { return null; }
    }

    function getTransformRuleTarget(rule) {
        if (!rule) return 'markdown';
        const target = String(rule.target || rule.scope || rule.stage || '').toLowerCase();
        return target === 'html' ? 'html' : 'markdown';
    }

    function filterTransformRules(rules, target) {
        const desired = target === 'html' ? 'html' : 'markdown';
        return (Array.isArray(rules) ? rules : []).filter(rule => getTransformRuleTarget(rule) === desired);
    }

    function applyRegexRulesToString(input, ruleList) {
        let output = String(input ?? '');
        const rules = Array.isArray(ruleList) ? ruleList : [];
        for (const r of rules) {
            if (!r || r.enabled === false) continue;
            const patternRaw = String(r.pattern || '').trim();
            if (!patternRaw) continue;
            const replacementRaw = String(r.replacement ?? '');
            const fallbackFlags = String(r.flags || '').trim() || 'g';
            let regex = null;
            try {
                if (patternRaw.startsWith('/') && patternRaw.lastIndexOf('/') > 0) {
                    const body = patternRaw.slice(1, patternRaw.lastIndexOf('/'));
                    const inlineFlags = patternRaw.slice(patternRaw.lastIndexOf('/') + 1) || fallbackFlags;
                    regex = new RegExp(body, inlineFlags);
                } else {
                    regex = new RegExp(patternRaw, fallbackFlags);
                }
            } catch (_) {
                regex = null;
            }
            if (!regex) continue;
            try {
                let tpl = replacementRaw;
                tpl = tpl.replace(/\\n/g, '\n').replace(/\\t/g, '\t').replace(/\\r/g, '\r').replace(/\\s/g, ' ').replace(/\\v/g, '\v').replace(/\\f/g, '\f');
                tpl = tpl.replace(/\\x\{([0-9A-Fa-f]+)\}/g, (m, hex) => String.fromCodePoint(parseInt(hex, 16)));
                tpl = tpl.replace(/\\x([0-9A-Fa-f]{2})/g, (m, hh) => String.fromCharCode(parseInt(hh, 16)));
                tpl = tpl.replace(/\\u\{([0-9A-Fa-f]+)\}/g, (m, hex) => String.fromCodePoint(parseInt(hex, 16)));
                tpl = tpl.replace(/\\u([0-9A-Fa-f]{4})/g, (m, u) => String.fromCharCode(parseInt(u, 16)));
                output = output.replace(regex, function() {
                    const args = Array.from(arguments);
                    const lastArg = args[args.length - 1];
                    const hasGroups = lastArg && typeof lastArg === 'object' && lastArg !== null && !(lastArg instanceof String);
                    const groups = hasGroups ? lastArg : null;
                    const inputStr = hasGroups ? args[args.length - 2] : args[args.length - 1];
                    const offset = hasGroups ? args[args.length - 3] : args[args.length - 2];
                    const match = args[0];
                    const captures = args.slice(1, hasGroups ? -3 : -2);
                    let rep = String(tpl);
                    // å‘½ååˆ†ç»„
                    rep = rep.replace(/\$<([A-Za-z_][A-Za-z0-9_]*)>/g, (m, name) => (groups && groups[name] != null) ? String(groups[name]) : '');
                    rep = rep.replace(/\$\{([A-Za-z_][A-Za-z0-9_]*)\}/g, (m, name) => (groups && groups[name] != null) ? String(groups[name]) : '');
                    // æ•°å­—åˆ†ç»„ $1..$99
                    rep = rep.replace(/\$(\d{1,2})/g, (m, idxStr) => {
                        const idx = parseInt(idxStr, 10);
                        return captures[idx - 1] != null ? String(captures[idx - 1]) : '';
                    });
                    // ç‰¹æ®Šæ ‡è®°
                    rep = rep.replace(/\$\&/g, match);
                    rep = rep.replace(/\$`/g, inputStr.slice(0, offset));
                    rep = rep.replace(/\$\'/g, inputStr.slice(offset + match.length));
                    // $$ -> $
                    rep = rep.replace(/\$\$/g, '$');
                    if (/\\[ULEul]/.test(rep)) {
                        let out = '';
                        let mode = null; // 'upper' | 'lower' | null
                        for (let i = 0; i < rep.length; i++) {
                            const ch = rep[i];
                            if (ch === '\\') {
                                const nxt = rep[i + 1];
                                if (nxt === 'U') { mode = 'upper'; i++; continue; }
                                if (nxt === 'L') { mode = 'lower'; i++; continue; }
                                if (nxt === 'E') { mode = null; i++; continue; }
                                if (nxt === 'u' || nxt === 'l') {
                                    const target = rep[i + 2] || '';
                                    out += nxt === 'u' ? target.toUpperCase() : target.toLowerCase();
                                    i += 2;
                                    continue;
                                }
                                out += nxt || '';
                                i++;
                                continue;
                            }
                            out += mode === 'upper' ? ch.toUpperCase() : (mode === 'lower' ? ch.toLowerCase() : ch);
                        }
                        rep = out;
                    }
                    return rep;
                });
            } catch (_) {}
        }
        return output;
    }

    function applyHtmlTransformRules(html, rules) {
        if (!html) return html || '';
        const htmlRules = filterTransformRules(rules, 'html');
        if (!htmlRules.length) return html;

        // æ£€æŸ¥è§„åˆ™æ˜¯å¦æ ‡è®°ä¸ºæ–‡æœ¬æ¨¡å¼ï¼ˆé€šè¿‡è§„åˆ™åç§°æˆ–ç‰¹æ®Šæ ‡è®°åˆ¤æ–­ï¼‰
        // å¦‚æœè§„åˆ™åç§°åŒ…å«"æ–‡æœ¬"æˆ–"æ–‡å­—"ï¼Œåˆ™ä½¿ç”¨æ–‡æœ¬æ¨¡å¼
        const useTextMode = htmlRules.some(rule => {
            const name = String(rule.name || '').toLowerCase();
            return name.includes('æ–‡æœ¬') || name.includes('æ–‡å­—') || name.includes('text');
        });

        if (useTextMode) {
            try {
                const doc = new DOMParser().parseFromString(String(html), 'text/html');
                const root = doc.body || doc.documentElement;
                const processTextNodes = (node) => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        let text = node.textContent || '';
                        htmlRules.forEach(rule => {
                            if (!rule || rule.enabled === false) return;
                            const patternRaw = String(rule.pattern || '').trim();
                            if (!patternRaw) return;
                            const fallbackFlags = String(rule.flags || '').trim() || 'g';
                            let regex = null;
                            try {
                                if (patternRaw.startsWith('/') && patternRaw.lastIndexOf('/') > 0) {
                                    const body = patternRaw.slice(1, patternRaw.lastIndexOf('/'));
                                    const inlineFlags = patternRaw.slice(patternRaw.lastIndexOf('/') + 1) || fallbackFlags;
                                    regex = new RegExp(body, inlineFlags);
                                } else {
                                    regex = new RegExp(patternRaw, fallbackFlags);
                                }
                            } catch (_) {
                                regex = null;
                            }
                            if (regex) {
                                try {
                                    let tpl = String(rule.replacement ?? '');
                                    tpl = tpl.replace(/\\n/g, '\n').replace(/\\t/g, '\t').replace(/\\r/g, '\r').replace(/\\s/g, ' ').replace(/\\v/g, '\v').replace(/\\f/g, '\f');
                                    tpl = tpl.replace(/\\x\{([0-9A-Fa-f]+)\}/g, (m, hex) => String.fromCodePoint(parseInt(hex, 16)));
                                    tpl = tpl.replace(/\\x([0-9A-Fa-f]{2})/g, (m, hh) => String.fromCharCode(parseInt(hh, 16)));
                                    tpl = tpl.replace(/\\u\{([0-9A-Fa-f]+)\}/g, (m, hex) => String.fromCodePoint(parseInt(hex, 16)));
                                    tpl = tpl.replace(/\\u([0-9A-Fa-f]{4})/g, (m, u) => String.fromCharCode(parseInt(u, 16)));
                                    text = text.replace(regex, function() {
                                        const args = Array.from(arguments);
                                        const lastArg = args[args.length - 1];
                                        const hasGroups = lastArg && typeof lastArg === 'object' && lastArg !== null && !(lastArg instanceof String);
                                        const groups = hasGroups ? lastArg : null;
                                        const inputStr = hasGroups ? args[args.length - 2] : args[args.length - 1];
                                        const offset = hasGroups ? args[args.length - 3] : args[args.length - 2];
                                        const match = args[0];
                                        const captures = args.slice(1, hasGroups ? -3 : -2);
                                        let rep = String(tpl);
                                        rep = rep.replace(/\$<([A-Za-z_][A-Za-z0-9_]*)>/g, (m, name) => (groups && groups[name] != null) ? String(groups[name]) : '');
                                        rep = rep.replace(/\$\{([A-Za-z_][A-Za-z0-9_]*)\}/g, (m, name) => (groups && groups[name] != null) ? String(groups[name]) : '');
                                        rep = rep.replace(/\$(\d{1,2})/g, (m, idxStr) => { const idx = parseInt(idxStr, 10); return captures[idx - 1] != null ? String(captures[idx - 1]) : ''; });
                                        rep = rep.replace(/\$\&/g, match);
                                        rep = rep.replace(/\$`/g, inputStr.slice(0, offset));
                                        rep = rep.replace(/\$\'/g, inputStr.slice(offset + match.length));
                                        rep = rep.replace(/\$\$/g, '$');
                                        if (/\\[ULEul]/.test(rep)) {
                                            let out = '';
                                            let mode = null;
                                            for (let i = 0; i < rep.length; i++) {
                                                const ch = rep[i];
                                                if (ch === '\\') {
                                                    const nxt = rep[i + 1];
                                                    if (nxt === 'U') { mode = 'upper'; i++; continue; }
                                                    if (nxt === 'L') { mode = 'lower'; i++; continue; }
                                                    if (nxt === 'E') { mode = null; i++; continue; }
                                                    if (nxt === 'u' || nxt === 'l') {
                                                        const target = rep[i + 2] || '';
                                                        out += nxt === 'u' ? target.toUpperCase() : target.toLowerCase();
                                                        i += 2;
                                                        continue;
                                                    }
                                                    out += nxt || '';
                                                    i++;
                                                    continue;
                                                }
                                                out += mode === 'upper' ? ch.toUpperCase() : (mode === 'lower' ? ch.toLowerCase() : ch);
                                            }
                                            rep = out;
                                        }
                                        return rep;
                                    });
                                } catch (_) {}
                            }
                        });
                        node.textContent = text;
                    } else if (node.nodeType === Node.ELEMENT_NODE) {
                        Array.from(node.childNodes).forEach(processTextNodes);
                    }
                };
                Array.from(root.childNodes).forEach(processTextNodes);
                return root.innerHTML;
            } catch (error) {
                return applyRegexRulesToString(html, htmlRules);
            }
        } else {
            // åŸæœ‰çš„HTMLæ ‡ç­¾åŒ¹é…æ¨¡å¼ï¼ˆåŒ¹é…æ•´ä¸ªHTMLå­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬æ ‡ç­¾ï¼‰
            return applyRegexRulesToString(html, htmlRules);
        }
    }

    function applyMarkdownTransformRules(markdownData, rules) {
        const htmlRules = filterTransformRules(rules, 'html');
        const markdownRules = filterTransformRules(rules, 'markdown');
        let normalized = markdownData;
        if (typeof markdownData === 'string') {
            const str = String(markdownData || '');
            if (str.includes('<')) {
                const htmlContent = htmlRules.length ? applyRegexRulesToString(str, htmlRules) : str;
                const mdObj = convertHtmlToMarkdown(htmlContent);
                normalized = { markdown: mdObj.markdown || '', images: mdObj.images || [], videos: mdObj.videos || [], bookmarks: mdObj.bookmarks || [] };
            } else {
                normalized = { markdown: str, images: [], videos: [], bookmarks: [] };
            }
        } else if (typeof markdownData === 'object') {
            normalized = {
                markdown: (markdownData && markdownData.markdown) || '',
                images: Array.isArray(markdownData && markdownData.images) ? markdownData.images : [],
                videos: Array.isArray(markdownData && markdownData.videos) ? markdownData.videos : [],
                bookmarks: Array.isArray(markdownData && markdownData.bookmarks) ? markdownData.bookmarks : []
            };
        } else {
            normalized = { markdown: '', images: [], videos: [], bookmarks: [] };
        }
        let md = String(normalized.markdown || '');
        if (markdownRules.length) {
            md = applyRegexRulesToString(md, markdownRules);
        }
        return { markdown: md, images: normalized.images, videos: normalized.videos, bookmarks: normalized.bookmarks };
    }

    function getMarkdownTransformConfig() {
        try {
            const host = (location && location.hostname) ? location.hostname : '';
            const useDomain = !!GM_getValue('markdown_transform_use_domain', false);
            const enabledKey = useDomain ? ('markdown_transform_enabled_' + host) : 'markdown_transform_enabled';
            const enabled = GM_getValue(enabledKey, true);

            const hostRules = Array.isArray(GM_getValue('markdown_transform_rules_' + host, [])) ? GM_getValue('markdown_transform_rules_' + host, []) : [];
            const globalRules = Array.isArray(GM_getValue('markdown_transform_rules', [])) ? GM_getValue('markdown_transform_rules', []) : [];

            const combined = [].concat(hostRules || [], globalRules || []);
            const selectorRules = {};
            const generalRules = [];
            (combined || []).forEach(r => {
                if (!r || r.enabled === false) return;
                const sel = (r.selector || '').trim();
                if (sel) {
                    if (!selectorRules[sel]) selectorRules[sel] = [];
                    selectorRules[sel].push(r);
                } else {
                    generalRules.push(r);
                }
            });
            return { enabled, rules: generalRules, selectorRules, host, useDomain, enabledKey, hostRules, globalRules, allRules: combined };
        } catch(_) {
            return { enabled: true, rules: [], selectorRules: {}, host: '', useDomain: false, enabledKey: 'markdown_transform_enabled', hostRules: [], globalRules: [], allRules: [] };
        }
    }
    // è·å–æ•°æ®åº“ä¿¡æ¯ï¼ˆå±æ€§ã€åç§°ç­‰ï¼‰
    async function getNotionDatabaseInfo(databaseId) {
        try {
            return await sendNotionRequest("GET", `https://api.notion.com/v1/databases/${databaseId}`);
        } catch (e) {
            throw new Error(`è·å–æ•°æ®åº“ä¿¡æ¯å¤±è´¥: ${e.message}`);
        }
    }

    // ç»Ÿè®¡æ•°æ®åº“å†…é¡µé¢æ•°é‡ï¼ˆåˆ†é¡µè®¡æ•°ï¼‰
    async function countNotionDatabasePages(databaseId, abortSignal) {
        let hasMore = true;
        let startCursor = undefined;
        let total = 0;

        while (hasMore) {
            if (abortSignal && abortSignal.aborted) throw new Error('ç»Ÿè®¡å·²å–æ¶ˆ');
            const body = startCursor ? { page_size: 80, start_cursor: startCursor } : { page_size: 80 };
            const res = await sendNotionRequest("POST", `https://api.notion.com/v1/databases/${databaseId}/query`, body);
            total += Array.isArray(res.results) ? res.results.length : 0;
            hasMore = !!res.has_more;
            startCursor = res.next_cursor;
        }
        return total;
    }

    // æ±‡æ€»æ•°æ®åº“æ ‡ç­¾å±æ€§ï¼ˆä»…æ”¶é›†é…ç½®ï¼Œä¸åšé€é¡¹è®¡æ•°ä»¥å‡å°‘å¼€é”€ï¼‰
    function summarizeTagProperties(databaseInfo) {
        const props = databaseInfo && databaseInfo.properties ? databaseInfo.properties : {};
        const entries = Object.entries(props);
        const tagProps = [];
        for (const [name, def] of entries) {
            if (!def || !def.type) continue;
            if (def.type === 'multi_select' || def.type === 'select') {
                const options = (def[def.type] && Array.isArray(def[def.type].options)) ? def[def.type].options : [];
                tagProps.push({
                    name,
                    type: def.type,
                    optionCount: options.length,
                    sample: options.slice(0, 8).map(o => ({ name: o.name, color: o.color }))
                });
            }
        }
        return tagProps;
    }

    // è·å–Notioné¡µé¢å±æ€§
    async function getNotionPageProperties(pageId) {
        const data = await sendNotionRequest("GET", `https://api.notion.com/v1/pages/${pageId}`);
        const properties = data.properties || {};
        const coverFiles = Array.isArray(properties.å°é¢?.files) ? properties.å°é¢.files : [];
        const firstCoverFile = coverFiles.length > 0 ? coverFiles[0] : null;
        const propertyCoverUrl = firstCoverFile ? (firstCoverFile.external?.url || firstCoverFile.file?.url || '') : '';
        const pageCoverUrl = data.cover ? (data.cover.external?.url || data.cover.file?.url || '') : '';
        return {
            'ä¹¦å': properties.ä¹¦å?.title?.[0]?.text?.content || '',
            'æ ‡é¢˜': properties.æ ‡é¢˜?.title?.[0]?.text?.content || '',
            'ç®€ä»‹': properties.ç®€ä»‹?.rich_text?.[0]?.text?.content || '',
            'è¿½æ›´': properties.è¿½æ›´?.rich_text?.[0]?.text?.content || '',
            'ä½œè€…': properties.ä½œè€…?.rich_text?.[0]?.text?.content || '',
            'åˆ«å': properties.åˆ«å?.rich_text?.[0]?.text?.content || '',
            'æœ€æ–°ç« èŠ‚': properties.æœ€æ–°ç« èŠ‚?.rich_text?.[0]?.text?.content || '',
            'åœ°åŒº': properties.åœ°åŒº?.select?.name || '',
            'ç±»å‹': properties.ç±»å‹?.multi_select?.map(item => item.name).join('ï¼Œ') || properties.ç±»å‹?.select?.name || '',
            'æ›´æ–°çŠ¶æ€': properties.æ›´æ–°çŠ¶æ€?.select?.name || '',
            'è‡ªå®šä¹‰æ ‡ç­¾': properties.è‡ªå®šä¹‰æ ‡ç­¾?.multi_select?.map(item => item.name).join('ï¼Œ') || '',
            'propertyCoverUrl': propertyCoverUrl,
            'pageCoverUrl': pageCoverUrl,
            'coverUrl': propertyCoverUrl || pageCoverUrl || ''
        };
    }

    // è·å–Notioné¡µé¢åŸå§‹å±æ€§ï¼ˆè¿”å› Notion API çš„ properties å¯¹è±¡ï¼‰
    async function getNotionPageRawProperties(pageId) {
        const data = await sendNotionRequest("GET", `https://api.notion.com/v1/pages/${pageId}`);
        return data.properties || {};
    }

    // æ¯”è¾ƒæ•°æ®æ˜¯å¦æœ‰å˜åŒ–
    function normalizeUrlForCompare(url) {
        if (!url) return '';
        try {
            let u = decodeURIComponent(url.trim());
            if (/cdn\.jsdelivr\.net\/gh\//i.test(u)) {
                const m = u.match(/cdn\.jsdelivr\.net\/gh\/([^\/]+)\/([^@]+)@([^\/]+)\/(.+)/i);
                if (m) {
                    const user = m[1];
                    const repo = m[2];
                    const branch = m[3];
                    const path = m[4];
                    return `gh://${user}/${repo}@${branch}/${path}`;
                }
            }
            if (/raw\.githubusercontent\.com\//i.test(u)) {
                const m = u.match(/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)/i);
                if (m) {
                    const user = m[1];
                    const repo = m[2];
                    const branch = m[3];
                    const path = m[4];
                    return `gh://${user}/${repo}@${branch}/${path}`;
                }
            }
            if (/notion\.so\/image\//i.test(u)) {
                const inner = extractGithubUrlFromNotion(u);
                if (inner && /raw\.githubusercontent\.com\//i.test(inner)) {
                    const m = inner.match(/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)/i);
                    if (m) {
                        const user = m[1];
                        const repo = m[2];
                        const branch = m[3];
                        const path = m[4];
                        return `gh://${user}/${repo}@${branch}/${path}`;
                    }
                }
            }
            return u;
        } catch (_) {
            return url.trim();
        }
    }

    function compareDataForChanges(existingData, newData, siteConfig = null) {
        // å®šä¹‰éœ€è¦æ¯”è¾ƒçš„å­—æ®µï¼Œä¸åŒ…æ‹¬è‡ªå®šä¹‰æ ‡ç­¾å’Œåˆ†ç»„æ ‡ç­¾
        const fieldsToCompare = [
            'æœ€æ–°ç« èŠ‚', 'æ›´æ–°çŠ¶æ€'
        ];

        // æ ¹æ®æ•°æ®ç±»å‹æ£€æŸ¥æ ‡é¢˜å­—æ®µå˜åŒ–
        if (newData.æ ‡é¢˜ && existingData.æ ‡é¢˜ !== newData.æ ‡é¢˜) {
            console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°æ ‡é¢˜å˜åŒ– - "${existingData.æ ‡é¢˜}" -> "${newData.æ ‡é¢˜}"`);
            return true;
        }
        if (newData.ä¹¦å && existingData.ä¹¦å !== newData.ä¹¦å) {
            console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°ä¹¦åå˜åŒ– - "${existingData.ä¹¦å}" -> "${newData.ä¹¦å}"`);
            return true;
        }

        // ç‰¹æ®Šå¤„ç†è¿½æ›´å­—æ®µ - åªæœ‰å½“é…ç½®äº†é€‰æ‹©å™¨ä¸”æ–°æ•°æ®ä¸ä¸ºç©ºæ—¶æ‰æ¯”è¾ƒ
        if (siteConfig && siteConfig.selectors && siteConfig.selectors['è¿½æ›´']) {
            if (newData.è¿½æ›´ && newData.è¿½æ›´.trim() !== '') {
                const existingValue = cleanText(existingData.è¿½æ›´ || '');
                const newValue = cleanText(newData.è¿½æ›´ || '');

                if (existingValue !== newValue) {
                    console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°è¿½æ›´å˜åŒ– - "${existingValue}" -> "${newValue}"`);
                    return true;
                }
            }
        }

        // æ™ºèƒ½æ£€æµ‹ï¼šæ£€æŸ¥æœ€æ–°ç« èŠ‚æ˜¯å¦æœ‰æ›´æ–° - åªæœ‰å½“é…ç½®äº†é€‰æ‹©å™¨æ—¶æ‰æ¯”è¾ƒ
        if (ENHANCED_AUTO_UPDATE_CONFIG.smartDetection && siteConfig && siteConfig.selectors && siteConfig.selectors['æœ€æ–°ç« èŠ‚']) {
            if (newData.æœ€æ–°ç« èŠ‚) {
                const existingChapter = cleanText(existingData.æœ€æ–°ç« èŠ‚ || '');
                const newChapter = cleanText(newData.æœ€æ–°ç« èŠ‚ || '');

                if (existingChapter && newChapter && existingChapter !== newChapter) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç« èŠ‚æ›´æ–°ï¼ˆæ¯”å¦‚ä»ç¬¬10ç« åˆ°ç¬¬11ç« ï¼‰
                    const chapterPattern = /ç¬¬?(\d+)[ç« èŠ‚è¯é›†]/;
                    const existingMatch = existingChapter.match(chapterPattern);
                    const newMatch = newChapter.match(chapterPattern);

                    if (existingMatch && newMatch) {
                        const existingNum = parseInt(existingMatch[1]);
                        const newNum = parseInt(newMatch[1]);
                        if (newNum > existingNum) {
                            console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°ç« èŠ‚æ›´æ–° - "${existingChapter}" -> "${newChapter}"`);
                            return true;
                        }
                    } else if (existingChapter !== newChapter) {
                        console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°æœ€æ–°ç« èŠ‚å˜åŒ– - "${existingChapter}" -> "${newChapter}"`);
                        return true;
                    }
                }
            }
        }

        // æ£€æŸ¥å°é¢æ˜¯å¦å‘ç”Ÿå˜åŒ–
        if (newData.å°é¢ && newData.å°é¢.trim() !== '') {
            const existingCoverOriginal = existingData.coverUrl || existingData['å°é¢'] || '';
            const newCoverOriginal = newData.å°é¢ || '';
            const existingCoverUrl = normalizeUrlForCompare(existingCoverOriginal);
            const newCoverUrl = normalizeUrlForCompare(newCoverOriginal);
            if (existingCoverUrl !== newCoverUrl) {
                console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°å°é¢å˜åŒ– - "${existingCoverUrl}" -> "${newCoverUrl}"`);
                return true;
            }
            const jsEnabled = GM_getValue('use_jsdelivr_acceleration', false);
            if (jsEnabled) {
                const exIsJs = isJsDelivrImageUrl(existingCoverOriginal);
                const newIsJs = isJsDelivrImageUrl(newCoverOriginal);
                if (!exIsJs && newIsJs) {
                    console.log('è‡ªåŠ¨æ›´æ–°: JsDelivråŠ é€Ÿå¯ç”¨ï¼Œå°é¢ä»éjsdelivråˆ‡æ¢ä¸ºjsdelivrï¼Œè§¦å‘æ›´æ–°');
                    return true;
                }
            }
            // å¦‚æœç°æœ‰å°é¢æ˜¯base64çº¯ç™½è‰²ï¼Œå³ä½¿URLç›¸åŒä¹Ÿéœ€è¦æ›´æ–°ï¼ˆæ›¿æ¢æˆå›¾åºŠæ ¼å¼ï¼‰
            if (existingCoverUrl && COVER_BED_CONFIG.enabled && isBase64ImageUrl(existingCoverUrl)) {
                // å¼‚æ­¥æ£€æŸ¥æ˜¯å¦æ˜¯çº¯ç™½è‰²ï¼Œä½†è¿™é‡Œä¸èƒ½ä½¿ç”¨awaitï¼Œæ‰€ä»¥å…ˆç®€å•æ£€æŸ¥base64æ ¼å¼
                // å®é™…æ›¿æ¢ä¼šåœ¨processCoverImageä¸­å¤„ç†
                console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°ç°æœ‰å°é¢æ˜¯base64æ ¼å¼ï¼Œå¯èƒ½éœ€è¦æ›¿æ¢`);
                // æ³¨æ„ï¼šè¿™é‡Œä¸ç›´æ¥è¿”å›trueï¼Œå› ä¸ºURLç›¸åŒï¼Œä½†ä¼šåœ¨processCoverImageä¸­å¤„ç†æ›¿æ¢
            }
        }

        // æ£€æŸ¥å…¶ä»–å­—æ®µ - å¦‚æœå­—æ®µæ²¡æœ‰é…ç½®é€‰æ‹©å™¨ï¼Œåˆ™è·³è¿‡æ¯”è¾ƒ
        for (const field of fieldsToCompare) {
            // å¦‚æœé…ç½®äº†é€‰æ‹©å™¨ï¼Œæˆ–è€…å­—æ®µæ˜¯å¿…å¡«å­—æ®µï¼ˆç®€ä»‹ã€ä½œè€…ç­‰ï¼‰ï¼Œåˆ™è¿›è¡Œæ¯”è¾ƒ
            const hasSelector = siteConfig && siteConfig.selectors && siteConfig.selectors[field];
            // å¯¹äºæœ€æ–°ç« èŠ‚å­—æ®µï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©å™¨ï¼Œè·³è¿‡æ¯”è¾ƒ
            if (field === 'æœ€æ–°ç« èŠ‚' && !hasSelector) {
                continue;
            }

            const existingValue = cleanText(existingData[field] || '');
            const newValue = cleanText(newData[field] || '');

            // å¦‚æœæ–°æ•°æ®ä¸ºç©ºä¸”æ²¡æœ‰é…ç½®é€‰æ‹©å™¨ï¼Œè·³è¿‡æ¯”è¾ƒï¼ˆé¿å…è¯¯åˆ¤ï¼‰
            if (!newValue && !hasSelector && existingValue) {
                continue;
            }

            if (existingValue !== newValue) {
                console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°å˜åŒ– - ${field}: "${existingValue}" -> "${newValue}"`);
                return true;
            }
        }

        // ä¸æ£€æµ‹è‡ªå®šä¹‰æ ‡ç­¾å­—æ®µçš„å˜åŒ–
        // æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼Œè‡ªå®šä¹‰æ ‡ç­¾çš„å˜åŒ–ä¸ä¼šè§¦å‘è‡ªåŠ¨æ›´æ–°
        // if (existingData.è‡ªå®šä¹‰æ ‡ç­¾ || newData.è‡ªå®šä¹‰æ ‡ç­¾) {
        //     const existingTags = existingData.è‡ªå®šä¹‰æ ‡ç­¾ || '';
        //     const newTags = newData.è‡ªå®šä¹‰æ ‡ç­¾ || '';
        //
        //     if (existingTags !== newTags) {
        //         console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°å˜åŒ– - è‡ªå®šä¹‰æ ‡ç­¾: "${existingTags}" -> "${newTags}"`);
        //         return true;
        //     }
        // }

        return false;
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
        const existingNotification = document.querySelector('.custom-notification');
        if (existingNotification) {
            existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.className = `custom-notification ${type}`;

        const icon = document.createElement('span');
        icon.className = 'custom-notification-icon';

        const text = document.createElement('span');
        text.className = 'custom-notification-message';
        text.textContent = message;

        if (type === 'success') {
            icon.textContent = 'âœ“';
        } else if (type === 'error') {
            icon.textContent = 'âœ—';
        } else {
            icon.textContent = 'â„¹';
        }

        notification.appendChild(icon);
        notification.appendChild(text);
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('visible');
        }, 10);

        setTimeout(() => {
            notification.classList.remove('visible');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    function showConfirmDialog(title, message, confirmText = 'ç¡®è®¤', cancelText = 'å–æ¶ˆ') {
        return new Promise((resolve) => {
            // ç§»é™¤ç°æœ‰çš„ç¡®è®¤å¯¹è¯æ¡†
            const existingDialog = document.querySelector('.confirm-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }

            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'confirm-dialog-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: -webkit-fill-available;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // åˆ›å»ºå¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 24px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                transform: scale(0.9);
                transition: transform 0.2s ease;
            `;
            dialog.className = 'notion-showConfirmDialog-dialog';

            // åˆ›å»ºæ ‡é¢˜
            const titleEl = document.createElement('h3');
            titleEl.textContent = title;
            titleEl.style.cssText = `
                margin: 0 0 16px 0;
                font-size: 18px;
                font-weight: 600;
                color: #333;
            `;

            // åˆ›å»ºæ¶ˆæ¯
            const messageEl = document.createElement('p');
            messageEl.textContent = message;
            messageEl.style.cssText = `
                margin: 0 0 24px 0;
                font-size: 14px;
                color: #666;
                line-height: 1.5;
            `;

            // åˆ›å»ºæŒ‰é’®å®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 12px;
                justify-content: center;
            `;

            // åˆ›å»ºå–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = cancelText;
            cancelBtn.style.cssText = `
                padding: 10px 20px;
                border: 1px solid #ddd;
                background: white;
                color: #666;
                border-radius: 20px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s ease;
            `;

            // åˆ›å»ºç¡®è®¤æŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = confirmText;
            confirmBtn.style.cssText = `
                padding: 10px 20px;
                border: none;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                border-radius: 20px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s ease;
            `;

            // æ·»åŠ æ‚¬åœæ•ˆæœ
            cancelBtn.addEventListener('mouseenter', () => {
                cancelBtn.style.background = '#f5f5f5';
            });
            cancelBtn.addEventListener('mouseleave', () => {
                cancelBtn.style.background = 'white';
            });

            confirmBtn.addEventListener('mouseenter', () => {
                confirmBtn.style.transform = 'translateY(-2px)';
                confirmBtn.style.boxShadow = '0 4px 12px var(--primarycolor-lighter)';
            });
            confirmBtn.addEventListener('mouseleave', () => {
                confirmBtn.style.transform = 'translateY(0)';
                confirmBtn.style.boxShadow = 'none';
            });

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            cancelBtn.addEventListener('click', () => {
                overlay.remove();
                resolve(false);
            });

            confirmBtn.addEventListener('click', () => {
                overlay.remove();
                resolve(true);
            });

            // ç‚¹å‡»é®ç½©å±‚å…³é—­å¯¹è¯æ¡†
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    resolve(false);
                }
            });

            // ç»„è£…å¯¹è¯æ¡†
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(confirmBtn);
            dialog.appendChild(titleEl);
            dialog.appendChild(messageEl);
            dialog.appendChild(buttonContainer);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                dialog.style.transform = 'scale(1)';
            }, 10);

            // èšç„¦åˆ°ç¡®è®¤æŒ‰é’®
            setTimeout(() => {
                confirmBtn.focus();
            }, 100);
        });
    }
    // å¤„ç†é¢å¤–çš„å†…å®¹é€‰æ‹©å™¨
    async function processAdditionalSelectors(additionalSelectors, pageId, siteConfig) {
        try {
            const transformCfg = getMarkdownTransformConfig();
            const transformEnabled = !!(transformCfg && transformCfg.enabled);
            for (let i = 0; i < additionalSelectors.length; i++) {
                const selector = additionalSelectors[i];
                console.log(`å¤„ç†é¢å¤–é€‰æ‹©å™¨ ${i + 1}/${additionalSelectors.length}: ${selector}`);

                // æå–é€‰æ‹©å™¨å†…å®¹
                const contentElements = document.querySelectorAll(selector);
                console.log(`é¢å¤–é€‰æ‹©å™¨æ‰¾åˆ° ${contentElements.length} ä¸ªåŒ¹é…å…ƒç´ `);

                if (contentElements.length > 0) {
                    let contentHtml = '';
                    contentElements.forEach((el, elIndex) => {
                        const clone = el.cloneNode(true);
                        const excludes = Array.isArray(siteConfig.clipExcludeSelectors) ? siteConfig.clipExcludeSelectors : [];
                        excludes.forEach(sel => {
                            try { clone.querySelectorAll(sel).forEach(n => n.remove()); } catch (e) {}
                        });

                        const elementHtml = clone.outerHTML.trim();
                        if (elementHtml) {
                            contentHtml += elementHtml;
                        }
                    });

                    if (contentHtml) {
                        console.log(`é¢å¤–é€‰æ‹©å™¨ ${i + 1} HTMLå†…å®¹é•¿åº¦: ${contentHtml.length}`);

                        // è½¬æ¢ä¸ºMarkdown
                        const selectorSpecific = (transformCfg.selectorRules && selector) ? transformCfg.selectorRules[selector] : null;
                        const rulesForSel = Array.isArray(selectorSpecific) ? selectorSpecific : (transformCfg.rules || []);
                        const htmlForConversion = (transformEnabled && rulesForSel.length) ? applyHtmlTransformRules(contentHtml, rulesForSel) : contentHtml;
                        const contentData = convertHtmlToMarkdown(htmlForConversion);

                        const transformed = (transformEnabled && rulesForSel.length) ? applyMarkdownTransformRules(contentData, rulesForSel) : contentData;
                        const blocks = await convertToNotionBlocks(transformed);

                        if (blocks.length > 0) {
                            // æ·»åŠ åˆ†éš”ç¬¦å—
                            const separatorBlock = {
                                type: "divider",
                                divider: {}
                            };

                            // å°†åˆ†éš”ç¬¦å’Œå†…å®¹å—ä¸€èµ·è¿½åŠ åˆ°é¡µé¢
                            const blocksToAppend = [separatorBlock, ...blocks];

                            // åˆ†æ‰¹å¤„ç†å—
                            const batchSize = 90;
                            for (let j = 0; j < blocksToAppend.length; j += batchSize) {
                                const batch = blocksToAppend.slice(j, j + batchSize);
                                await sendNotionRequest("PATCH", `https://api.notion.com/v1/blocks/${pageId}/children`, {
                                    children: batch
                                });
                                console.log(`å·²è¿½åŠ é¢å¤–é€‰æ‹©å™¨ ${i + 1} çš„ç¬¬ ${Math.floor(j/batchSize) + 1} æ‰¹å— (${batch.length} ä¸ªå—)`);
                            }

                            console.log(`é¢å¤–é€‰æ‹©å™¨ ${i + 1} å†…å®¹å·²æˆåŠŸè¿½åŠ åˆ°é¡µé¢`);
                        }
                    } else {
                        console.warn(`é¢å¤–é€‰æ‹©å™¨ ${i + 1} æœªæ‰¾åˆ°å†…å®¹:`, selector);
                    }
                } else {
                    console.warn(`é¢å¤–é€‰æ‹©å™¨ ${i + 1} æœªåŒ¹é…åˆ°å…ƒç´ :`, selector);
                }
            }

            showNotification('æ‰€æœ‰é¢å¤–å†…å®¹å·²æˆåŠŸè¿½åŠ åˆ°é¡µé¢', 'success');
        } catch (error) {
            console.error('å¤„ç†é¢å¤–é€‰æ‹©å™¨å¤±è´¥:', error);
            showNotification('å¤„ç†é¢å¤–å†…å®¹æ—¶å‡ºé”™: ' + error.message, 'error');
        }
    }

    // æ˜¾ç¤ºè¿½åŠ å†…å®¹å¯¹è¯æ¡†
    async function showAppendContentDialog() {
        return new Promise((resolve) => {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: -webkit-fill-available;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // åˆ›å»ºå¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white;
                border-radius: 20px;
                padding: 24px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            `;
            dialog.className = 'notion-AppendContent-dialog'

            // æ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = 'è¿½åŠ å†…å®¹åˆ°é¡µé¢';
            title.style.cssText = `
                margin: 0 0 16px 0;
                font-size: 18px;
                font-weight: 700;
                background: linear-gradient(135deg, var(--primarycolor-light, #1F2937), var(--primarycolor, #374151));
                -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip:text;
            `;

            // å†…å®¹è¾“å…¥æ¡†
            const contentLabel = document.createElement('label');
            contentLabel.textContent = 'è¾“å…¥è¦è¿½åŠ çš„å†…å®¹ï¼š';
            contentLabel.style.cssText = `
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                font-weight: 500;
                color: #374151;
            `;

            const contentTextarea = document.createElement('textarea');
            contentTextarea.placeholder = 'è¯·è¾“å…¥è¦è¿½åŠ åˆ°é¡µé¢çš„å†…å®¹...';
            contentTextarea.style.cssText = `
                width: -webkit-fill-available;
                height: 120px;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 20px;
                font-size: 14px;
                font-family: inherit;
                resize: vertical;
                box-sizing: border-box;
            `;

            // æŒ‰é’®å®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 16px;
            `;

            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = `
                padding: 10px 16px;
                border: 1px solid var(--input-border);
                border-radius: 20px;
                background: linear-gradient(135deg, #FFFFFF, #F3F4F6);
                color: #374151;
                cursor: pointer;
                font-size: 14px;
                box-shadow: none;
            `;

            // ç¡®å®šæŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'è¿½åŠ å†…å®¹';
            confirmBtn.style.cssText = `
                padding: 10px 16px;
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s ease;
                box-shadow: 0 8px 20px var(--primarycolor-lighter);
            `;

            // æ·»åŠ æ‚¬åœæ•ˆæœ
            confirmBtn.addEventListener('mouseenter', () => {
                confirmBtn.style.background = 'linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark))';
                confirmBtn.style.transform = 'translateY(-2px)';
                confirmBtn.style.boxShadow = '0 10px 22px var(--primarycolor-lighter)';
            });

            confirmBtn.addEventListener('mouseleave', () => {
                confirmBtn.style.background = 'linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D))';
                confirmBtn.style.transform = 'translateY(0)';
                confirmBtn.style.boxShadow = '0 8px 20px var(--primarycolor-lighter)';
            });

            // äº‹ä»¶å¤„ç†
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                resolve(null);
            });

            confirmBtn.addEventListener('click', async () => {
                const content = contentTextarea.value.trim();
                if (!content) {
                    alert('è¯·è¾“å…¥è¦è¿½åŠ çš„å†…å®¹');
                    return;
                }

                try {
                    // è·å–å½“å‰é¡µé¢çš„URLä¸å½“å‰æ¨¡å¼ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„Notioné¡µé¢
                    const sourceURL = window.location.href;
                    const siteConfig = getSiteConfig();
                    const currentContentType = (siteConfig && siteConfig.contentType) ? siteConfig.contentType : 'clip';
                    let existingPageId = await checkExistingPage(sourceURL, currentContentType);

                    // å¦‚æœæ‰¾ä¸åˆ°ç°æœ‰é¡µé¢ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°é¡µé¢
                    if (!existingPageId) {
                        try {
                            // è·å–å½“å‰é¡µé¢ä¿¡æ¯ç”¨äºåˆ›å»ºæ–°é¡µé¢
                            const pageTitle = document.title || 'æ–°é¡µé¢';
                            const pageUrl = window.location.href;

                            // åˆ›å»ºæ–°é¡µé¢ï¼ˆæŒ‰å½“å‰æ¨¡å¼ï¼‰
                            const newPageData = {
                                parent: { database_id: NOTION_CONFIG.databaseIds[currentContentType] },
                                properties: {
                                    "æ ‡é¢˜": {
                                        title: [{ text: { content: pageTitle } }]
                                    },
                                    "é“¾æ¥": {
                                        rich_text: [{ text: { content: pageUrl } }]
                                    }
                                }
                            };

                            const createResponse = await sendNotionRequest("POST", "https://api.notion.com/v1/pages", newPageData);
                            existingPageId = createResponse.id;

                            showNotification('å·²è‡ªåŠ¨åˆ›å»ºæ–°é¡µé¢', 'info');
                        } catch (createError) {
                            console.error('åˆ›å»ºæ–°é¡µé¢å¤±è´¥:', createError);
                            alert('åˆ›å»ºæ–°é¡µé¢å¤±è´¥: ' + createError.message);
                            document.body.removeChild(overlay);
                            resolve(null);
                            return;
                        }
                    }

                    // å°†æ–‡æœ¬å†…å®¹è½¬æ¢ä¸ºNotionå—
                    const textBlock = {
                        type: 'paragraph',
                        paragraph: {
                            rich_text: [{
                                type: 'text',
                                text: { content: content }
                            }]
                        }
                    };

                    // è¿½åŠ å†…å®¹åˆ°Notioné¡µé¢
                    await sendNotionRequest("PATCH", `https://api.notion.com/v1/blocks/${existingPageId}/children`, {
                        children: [textBlock]
                    });

                    showNotification('å†…å®¹å·²æˆåŠŸè¿½åŠ åˆ°é¡µé¢', 'success');
                    document.body.removeChild(overlay);
                    resolve(true);
                } catch (error) {
                    console.error('è¿½åŠ å†…å®¹å¤±è´¥:', error);
                    alert('è¿½åŠ å†…å®¹å¤±è´¥: ' + error.message);
                }
            });

            // ç»„è£…å¯¹è¯æ¡†
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(confirmBtn);
            dialog.appendChild(title);
            dialog.appendChild(contentLabel);
            dialog.appendChild(contentTextarea);
            dialog.appendChild(buttonContainer);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                contentTextarea.focus();
            }, 100);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    resolve(null);
                }
            });
        });
    }

    // æ˜¾ç¤ºç»“æœ
    function showResult(result) {
        const contentType = result.contentType || 'comic';
        const title = result.title || 'æœªå‘½åå†…å®¹';

        if (contentType === 'clip') {
            showNotification(`"${title}" æ•°æ®${result.isUpdate ? 'å·²æ›´æ–°' : 'å·²æ·»åŠ '}`, 'success');
        } else {
            showNotification(`"${title}" ${result.isUpdate ? 'å·²æ›´æ–°' : 'å·²æ·»åŠ '}`, 'success');
        }
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
        showNotification(`å¯¼å…¥å¤±è´¥: ${message}`, 'error');
    }

    // åˆ›å»ºè‡ªå®šä¹‰æ¸å˜ç²‰è‰²åœ†å½¢å¤é€‰æ¡† - é‡å†™ç‰ˆæœ¬
    function createCustomCheckbox(id, checked = false, labelText = '') {
        const container = document.createElement('div');
        container.style.cssText = `
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            min-height: 24px;
        `;

        // åˆ›å»ºéšè—çš„åŸå§‹checkbox
        const hiddenCheckbox = document.createElement('input');
        hiddenCheckbox.type = 'checkbox';
        hiddenCheckbox.id = id;
        hiddenCheckbox.checked = checked;
        hiddenCheckbox.style.display = 'none';

        // åˆ›å»ºè‡ªå®šä¹‰åœ†å½¢å¤é€‰æ¡†
        const customCheckbox = document.createElement('div');
        customCheckbox.style.cssText = `
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
            margin-top: 0;
            margin-bottom: 0;
        `;

        // åˆ›å»ºå†…éƒ¨åœ†å½¢ï¼ˆé€‰ä¸­æ—¶æ˜¾ç¤ºï¼‰
        const innerCircle = document.createElement('div');
        innerCircle.style.cssText = `
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
        `;

        customCheckbox.appendChild(innerCircle);

        // åˆ›å»ºæ ‡ç­¾æ–‡æœ¬
        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = labelText;
        label.style.cssText = `
            cursor: pointer;
            user-select: none;
            font-size: 14px;
            color: #374151;
            line-height: 1.4;
            display: flex;
            align-items: center;
            margin: 0;
            padding: 0;
        `;

        // æ›´æ–°è§†è§‰çŠ¶æ€çš„å‡½æ•°
        const updateVisualState = (isChecked) => {
            if (isChecked) {
                customCheckbox.style.borderColor = 'var(--primarycolor, #FF8FAB)';
                customCheckbox.style.boxShadow = '0 6px 18px var(--primarycolor-lighter)';
                innerCircle.style.opacity = '1';
                innerCircle.style.transform = 'scale(1)';
            } else {
                customCheckbox.style.borderColor = '#e5e7eb';
                customCheckbox.style.boxShadow = 'none';
                innerCircle.style.opacity = '0';
                innerCircle.style.transform = 'scale(0)';
            }
        };

        // ç‚¹å‡»äº‹ä»¶å¤„ç† - ä½¿ç”¨æ›´ç®€å•çš„æ–¹å¼
        const handleClick = (e) => {
            e.preventDefault();
            e.stopPropagation();

            // ç›´æ¥åˆ‡æ¢çŠ¶æ€
            hiddenCheckbox.checked = !hiddenCheckbox.checked;
            updateVisualState(hiddenCheckbox.checked);

            try {
                hiddenCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
            } catch(_) {}

            console.log(`å¤é€‰æ¡† ${id} çŠ¶æ€åˆ‡æ¢ä¸º:`, hiddenCheckbox.checked);
        };

        // ç»‘å®šäº‹ä»¶
        container.addEventListener('click', handleClick);

        hiddenCheckbox.addEventListener('change', () => {
            updateVisualState(hiddenCheckbox.checked);
        });

        // æ‚¬åœæ•ˆæœ
        customCheckbox.addEventListener('mouseenter', () => {
            if (!hiddenCheckbox.checked) {
                customCheckbox.style.borderColor = 'var(--primarycolor, #FF8FAB)';
                customCheckbox.style.transform = 'scale(1.05)';
            }
        });

        customCheckbox.addEventListener('mouseleave', () => {
            if (!hiddenCheckbox.checked) {
                customCheckbox.style.borderColor = '#e5e7eb';
                customCheckbox.style.transform = 'scale(1)';
            }
        });

        // åˆå§‹åŒ–è§†è§‰çŠ¶æ€
        updateVisualState(checked);

        container.appendChild(hiddenCheckbox);
        container.appendChild(customCheckbox);
        container.appendChild(label);

        return container;
    }

    // åˆ›å»ºè¯„åˆ†ç»„ä»¶
    function createRatingComponent(id, initialRating = 0, labelText = 'è¯„åˆ†') {
        const container = document.createElement('div');
        container.style.cssText = `
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        `;

        // åˆ›å»ºæ ‡ç­¾
        const label = document.createElement('label');
        label.textContent = labelText;
        label.style.cssText = `
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            min-width: 60px;
        `;

        // åˆ›å»ºæ˜Ÿçº§å®¹å™¨
        const starsContainer = document.createElement('div');
        starsContainer.style.cssText = `
            display: flex;
            gap: 4px;
            align-items: center;
        `;

        // åˆ›å»ºéšè—çš„è¾“å…¥æ¡†å­˜å‚¨è¯„åˆ†å€¼
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.id = id;
        hiddenInput.value = initialRating;

        // åˆ›å»º5ä¸ªæ˜Ÿæ˜Ÿ
        const stars = [];
        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('span');
            star.textContent = 'â˜…';
            star.style.cssText = `
                font-size: 20px;
                color: #d1d5db;
                cursor: pointer;
                transition: color 0.2s ease;
                user-select: none;
            `;

            star.addEventListener('click', () => {
                hiddenInput.value = i;
                updateStars(stars, i);
            });

            star.addEventListener('mouseenter', () => {
                updateStars(stars, i, true);
            });

            starsContainer.appendChild(star);
            stars.push(star);
        }

        // æ·»åŠ é¼ æ ‡ç¦»å¼€äº‹ä»¶
        starsContainer.addEventListener('mouseleave', () => {
            updateStars(stars, parseInt(hiddenInput.value));
        });

        // æ›´æ–°æ˜Ÿæ˜Ÿæ˜¾ç¤ºçš„å‡½æ•°
        function updateStars(stars, rating, isHover = false) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.color = isHover ? '#fbbf24' : '#f59e0b';
                } else {
                    star.style.color = '#d1d5db';
                }
            });
        }

        // åˆå§‹åŒ–æ˜Ÿæ˜ŸçŠ¶æ€
        updateStars(stars, initialRating);

        container.appendChild(label);
        container.appendChild(starsContainer);
        container.appendChild(hiddenInput);

        return container;
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ¸…æ´—æ ‡é¢˜ï¼ˆå¯é…ç½®ï¼šå»æ‹¬å·ã€è£å‰ªä¸‹åˆ’çº¿ä¹‹åï¼‰
    function cleanTitle(str) {
        if (!str) return "";

        const removeBrackets = (() => { try { return GM_getValue('title_remove_brackets', true); } catch(_) { return true; } })();
        const trimUnderscore = (() => { try { return GM_getValue('title_trim_underscore', true); } catch(_) { return true; } })();

        let cleaned = String(str);

        if (removeBrackets) {
            cleaned = cleaned
                .replace(/\([^)]*\)/g, '')
                .replace(/\[[^\]]*\]/g, '')
                .replace(/\{[^}]*\}/g, '')
                .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, '')
                .replace(/ã€[^ã€‘]*ã€‘/g, '');
        }

        if (trimUnderscore) {
            const idx = cleaned.indexOf('_');
            if (idx > -1) cleaned = cleaned.slice(0, idx);
        }

        cleaned = cleaned.trim();

        return convertToSimplified(cleaned);
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ¸…æ´—æ–‡æœ¬å¹¶è½¬æ¢ä¸ºç®€ä½“ä¸­æ–‡
    function cleanText(str) {
        let cleaned = String(str || "")
        .replace(/[\u200B-\u200D\uFEFF]/g, '')
        .trim();

        return convertToSimplified(cleaned);
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ¸…æ´—æ–‡æœ¬ä½†ä¿ç•™æ¢è¡Œç¬¦ï¼ˆç”¨äºç®€ä»‹å­—æ®µï¼‰
    function cleanTextWithNewlines(str) {
        let cleaned = String(str || "")
        .replace(/[\u200B-\u200D\uFEFF]/g, '')
        .replace(/^\s+|\s+$/g, ''); // åªå»é™¤é¦–å°¾ç©ºç™½ï¼Œä¿ç•™å†…éƒ¨æ¢è¡Œ

        return convertToSimplified(cleaned);
    }

    // è¾…åŠ©å‡½æ•°ï¼šè½¬æ¢åœ°åŒº
    function convertRegion(region) {
        if (!region) return "";

        const regionMap = {
            "éŸ©å›½": "éŸ©æ¼«",
            "éŸ©æ¼«": "éŸ©æ¼«",
            "æ—¥æœ¬": "æ—¥æ¼«",
            "æ—¥æ¼«": "æ—¥æ¼«",
            "ä¸­å›½": "å›½æ¼«",
            "å›½æ¼«": "å›½æ¼«",
            "å¤§é™†": "å›½æ¼«",
            "å°æ¹¾": "å›½æ¼«",
            "é¦™æ¸¯": "å›½æ¼«",
            "æ¾³é—¨": "å›½æ¼«",
            "æ¬§ç¾": "æ¬§ç¾æ¼«",
            "ç¾å›½": "æ¬§ç¾æ¼«",
            "è‹±å›½": "æ¬§ç¾æ¼«",
            "æ³•å›½": "æ¬§ç¾æ¼«",
            "å¾·å›½": "æ¬§ç¾æ¼«",
            "å…¶ä»–": "å…¶ä»–"
        };

        if (region.endsWith("æ¼«") && region.length <= 3) {
            return region;
        }

        for (const key in regionMap) {
            if (region.includes(key)) {
                return regionMap[key];
            }
        }

        return region;
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–å¯Œæ–‡æœ¬
    function formatRichText(content) {
        return content ? {
            rich_text: [{
                text: { content: content }
            }]
        } : {
            rich_text: []
        };
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ™®é€šæ–‡æœ¬
    function formatText(content) {
        return content ? {
            text: { content: content }
        } : {
            text: { content: "" }
        };
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–é€‰æ‹©å±æ€§
    function formatSelect(name, color = "default") {
        return name ? {
            select: {
                name: name,
                color: color
            }
        } : {
            select: null
        };
    }

    // è¾…åŠ©å‡½æ•°ï¼šåˆ†å‰²é•¿æ–‡æœ¬
    function splitLongText(text, maxLength) {
        if (text.length <= maxLength) {
            return [text];
        }

        const chunks = [];
        let currentIndex = 0;

        while (currentIndex < text.length) {
            let endIndex = currentIndex + maxLength;

            // å¦‚æœä¸æ˜¯æœ€åä¸€å—ï¼Œå°è¯•åœ¨åˆé€‚çš„ä½ç½®åˆ†å‰²ï¼ˆå¦‚æ¢è¡Œç¬¦ï¼‰
            if (endIndex < text.length) {
                // å¯»æ‰¾æœ€è¿‘çš„æ¢è¡Œç¬¦
                const lastNewline = text.lastIndexOf('\n', endIndex);
                if (lastNewline > currentIndex) {
                    endIndex = lastNewline + 1; // åŒ…å«æ¢è¡Œç¬¦
                }
            }

            chunks.push(text.substring(currentIndex, endIndex));
            currentIndex = endIndex;
        }

        return chunks;
    }

    // è¾…åŠ©å‡½æ•°ï¼šéªŒè¯URLæ˜¯å¦æœ‰æ•ˆ
    function isValidUrl(string) {
        try {
            const url = new URL(string);
            return url.protocol === 'http:' || url.protocol === 'https:';
        } catch (_) {
            return false;
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ•°æ®åº“æ˜¯å¦åŒ…å«æŒ‡å®šå±æ€§
    async function checkDatabaseProperty(databaseId, propertyName) {
        return new Promise((resolve) => {
            GM_xmlhttpRequest({
                method: 'GET',
                url: `https://api.notion.com/v1/databases/${databaseId}`,
                headers: {
                    'Authorization': `Bearer ${NOTION_CONFIG.apiKey}`,
                    'Notion-Version': '2022-06-28',
                    'Content-Type': 'application/json'
                },
                onload: function(response) {
                    try {
                        if (response.status === 200) {
                            const data = JSON.parse(response.responseText);
                            resolve(data.properties && data.properties.hasOwnProperty(propertyName));
                        } else {
                            console.warn('è·å–æ•°æ®åº“ä¿¡æ¯å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                            resolve(false);
                        }
                    } catch (error) {
                        console.warn('æ£€æŸ¥æ•°æ®åº“å±æ€§å¤±è´¥:', error.message);
                        resolve(false);
                    }
                },
                onerror: function(error) {
                    console.warn('æ£€æŸ¥æ•°æ®åº“å±æ€§å¤±è´¥:', error);
                    resolve(false);
                }
            });
        });
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–æ•°æ®åº“ä¸­å·²å­˜åœ¨çš„æ ‡ç­¾é¢œè‰²
    async function getExistingTagColors(databaseId, fieldName) {
        return new Promise((resolve) => {
            GM_xmlhttpRequest({
                method: 'GET',
                url: `https://api.notion.com/v1/databases/${databaseId}`,
                headers: {
                    'Authorization': `Bearer ${NOTION_CONFIG.apiKey}`,
                    'Notion-Version': '2022-06-28',
                    'Content-Type': 'application/json'
                },
                onload: function(response) {
                    try {
                        if (response.status === 200) {
                            const data = JSON.parse(response.responseText);
                            const field = data.properties[fieldName];
                            if (field && field.multi_select && field.multi_select.options) {
                                const colorMap = {};
                                field.multi_select.options.forEach(option => {
                                    colorMap[option.name] = option.color;
                                });
                                resolve(colorMap);
                            } else {
                                resolve({});
                            }
                        } else {
                            console.warn('è·å–æ•°æ®åº“ä¿¡æ¯å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                            resolve({});
                        }
                    } catch (error) {
                        console.warn('è·å–å·²å­˜åœ¨æ ‡ç­¾é¢œè‰²å¤±è´¥:', error.message);
                        resolve({});
                    }
                },
                onerror: function(error) {
                    console.warn('è·å–å·²å­˜åœ¨æ ‡ç­¾é¢œè‰²å¤±è´¥:', error);
                    resolve({});
                }
            });
        });
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–å¤šé€‰å±æ€§ï¼ˆåªæœ‰æ–°æ ‡ç­¾æ‰è®¾ç½®é¢œè‰²ï¼Œå·²å­˜åœ¨æ ‡ç­¾ä¿æŒåŸè‰²ï¼‰
    async function formatMultiSelect(names, colors = "default", existingColors = {}) {
        if (!names || names.length === 0) {
            return { multi_select: [] };
        }

        // é¢œè‰²æ˜ å°„ï¼šå°†è‡ªå®šä¹‰é¢œè‰²åç§°æ˜ å°„åˆ°Notion APIæ”¯æŒçš„é¢œè‰²å€¼
        const colorMapping = {
            'default': 'default',
            'gray': 'gray',
            'brown': 'brown',
            'orange': 'orange',
            'yellow': 'yellow',
            'green': 'green',
            'blue': 'blue',
            'purple': 'purple',
            'pink': 'pink',
            'red': 'red'
        };

        console.log('formatMultiSelect - è¾“å…¥å‚æ•°:', { names, colors, existingColors });
        console.log('formatMultiSelect - namesç±»å‹:', Array.isArray(names) ? 'array' : typeof names);
        if (Array.isArray(names) && names.length > 0) {
            console.log('formatMultiSelect - ç¬¬ä¸€ä¸ªå…ƒç´ :', names[0], 'ç±»å‹:', typeof names[0]);
        }

        // å¦‚æœnamesæ˜¯å¯¹è±¡æ•°ç»„ï¼ˆåŒ…å«nameå’Œcolorï¼‰ï¼Œå¤„ç†é¢œè‰²é€»è¾‘
        if (Array.isArray(names) && names.length > 0 && typeof names[0] === 'object' && names[0].name) {
            const result = {
                multi_select: names.map(item => {
                    // ä¸¥æ ¼æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                    const existingTagName = Object.keys(existingColors).find(key => {
                        // ç¡®ä¿item.nameæ˜¯å­—ç¬¦ä¸²ç±»å‹
                        const nameStr = String(item.name || '');
                        return key.toLowerCase() === nameStr.toLowerCase();
                    });

                    if (existingTagName) {
                        const existingColor = existingColors[existingTagName];
                        const userColor = item.color;
                        const mappedUserColor = colorMapping[userColor] || userColor;

                        console.log(`æ ‡ç­¾ "${item.name}" é¢œè‰²å¤„ç†è¯¦æƒ…:`, {
                            existingColor,
                            userColor,
                            mappedUserColor,
                            colorMapping: colorMapping[userColor]
                        });

                        // åªæœ‰å½“Notionä¸­å·²å­˜åœ¨æ ‡ç­¾ä¸”é¢œè‰²ä¸åŒæ—¶ï¼Œæ‰ä¸è®¾ç½®é¢œè‰²ï¼ˆé¿å…æŠ¥é”™ï¼‰
                        if (existingColor && userColor && existingColor !== mappedUserColor) {
                            console.log(`æ ‡ç­¾ "${item.name}" å·²å­˜åœ¨ä¸”é¢œè‰²ä¸åŒï¼ˆNotion: ${existingColor}, ç”¨æˆ·è®¾ç½®: ${mappedUserColor}ï¼‰ï¼Œä¸è®¾ç½®é¢œè‰²ï¼Œä¿æŒåŸè‰²`);
                            return {
                                name: item.name
                                // ä¸è®¾ç½®colorå±æ€§ï¼Œè®©Notionä¿æŒåŸæœ‰é¢œè‰²
                            };
                        } else if (userColor) {
                            console.log(`æ ‡ç­¾ "${item.name}" å·²å­˜åœ¨ä¸”é¢œè‰²ç›¸åŒæˆ–ç”¨æˆ·è®¾ç½®é¢œè‰²ï¼Œä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„é¢œè‰²: ${mappedUserColor}`);
                            return {
                                name: item.name,
                                color: mappedUserColor
                            };
                        } else {
                            console.log(`æ ‡ç­¾ "${item.name}" å·²å­˜åœ¨ä½†ç”¨æˆ·æœªè®¾ç½®é¢œè‰²ï¼Œä¸è®¾ç½®é¢œè‰²ï¼Œä¿æŒåŸè‰²`);
                            return {
                                name: item.name
                                // ä¸è®¾ç½®colorå±æ€§ï¼Œè®©Notionä¿æŒåŸæœ‰é¢œè‰²
                            };
                        }
                    } else {
                        if (item.color) {
                            const mappedColor = colorMapping[item.color] || item.color;
                            console.log(`æ ‡ç­¾ "${item.name}" ä¸ºæ–°æ ‡ç­¾ï¼Œé¢œè‰²è¯¦æƒ…:`, {
                                originalColor: item.color,
                                mappedColor,
                                colorMapping: colorMapping[item.color]
                            });
                            return {
                                name: item.name,
                                color: mappedColor
                            };
                        } else {
                            console.log(`æ ‡ç­¾ "${item.name}" ä¸ºæ–°æ ‡ç­¾ä½†æœªè®¾ç½®é¢œè‰²ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²: pink`);
                            return {
                                name: item.name,
                                color: "pink"
                            };
                        }
                    }
                })
            };
            console.log('formatMultiSelect - å¯¹è±¡æ•°ç»„ç»“æœ:', result);
            return result;
        }

        // å¦‚æœcolorsæ˜¯æ•°ç»„ï¼ŒæŒ‰ç´¢å¼•åŒ¹é…
        if (Array.isArray(colors)) {
            const result = {
                multi_select: names.map((name, index) => {
                    // ä¸¥æ ¼æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                    const existingTagName = Object.keys(existingColors).find(key => {
                        // ç¡®ä¿nameæ˜¯å­—ç¬¦ä¸²ç±»å‹
                        const nameStr = String(name || '');
                        return key.toLowerCase() === nameStr.toLowerCase();
                    });

                    if (existingTagName) {
                        const existingColor = existingColors[existingTagName];
                        const userColor = colors[index] || "pink";
                        const mappedUserColor = colorMapping[userColor] || userColor;

                        // åªæœ‰å½“Notionä¸­å·²å­˜åœ¨æ ‡ç­¾ä¸”é¢œè‰²ä¸åŒæ—¶ï¼Œæ‰ä¸è®¾ç½®é¢œè‰²ï¼ˆé¿å…æŠ¥é”™ï¼‰
                        if (existingColor && existingColor !== mappedUserColor) {
                            console.log(`æ ‡ç­¾ "${name}" å·²å­˜åœ¨ä¸”é¢œè‰²ä¸åŒï¼ˆNotion: ${existingColor}, ç”¨æˆ·è®¾ç½®: ${mappedUserColor}ï¼‰ï¼Œä¸è®¾ç½®é¢œè‰²ï¼Œä¿æŒåŸè‰²`);
                            return {
                                name: name
                                // ä¸è®¾ç½®colorå±æ€§
                            };
                        } else {
                            console.log(`æ ‡ç­¾ "${name}" å·²å­˜åœ¨ä¸”é¢œè‰²ç›¸åŒæˆ–ç”¨æˆ·è®¾ç½®é¢œè‰²ï¼Œä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„é¢œè‰²: ${mappedUserColor}`);
                            return {
                                name: name,
                                color: mappedUserColor
                            };
                        }
                    } else {
                        const mappedColor = colorMapping[colors[index]] || colors[index] || "pink";
                        console.log(`æ ‡ç­¾ "${name}" ä¸ºæ–°æ ‡ç­¾ï¼Œè®¾ç½®é¢œè‰²: ${mappedColor}`);
                        // æ–°æ ‡ç­¾ï¼Œä½¿ç”¨æŒ‡å®šé¢œè‰²æˆ–é»˜è®¤ç²‰è‰²
                        return {
                            name: name,
                            color: mappedColor
                        };
                    }
                })
            };
            console.log('formatMultiSelect - é¢œè‰²æ•°ç»„ç»“æœ:', result);
            return result;
        }

        // å•ä¸ªé¢œè‰²ï¼Œåªå¯¹æ–°æ ‡ç­¾åº”ç”¨
        const result = {
            multi_select: names.map(name => {
                // ä¸¥æ ¼æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                const existingTagName = Object.keys(existingColors).find(key => {
                    // ç¡®ä¿nameæ˜¯å­—ç¬¦ä¸²ç±»å‹
                    const nameStr = String(name || '');
                    return key.toLowerCase() === nameStr.toLowerCase();
                });

                if (existingTagName) {
                    const existingColor = existingColors[existingTagName];
                    const userColor = colors;
                    const mappedUserColor = colorMapping[userColor] || userColor;

                    // åªæœ‰å½“Notionä¸­å·²å­˜åœ¨æ ‡ç­¾ä¸”é¢œè‰²ä¸åŒæ—¶ï¼Œæ‰ä¸è®¾ç½®é¢œè‰²ï¼ˆé¿å…æŠ¥é”™ï¼‰
                    if (existingColor && existingColor !== mappedUserColor) {
                        console.log(`æ ‡ç­¾ "${name}" å·²å­˜åœ¨ä¸”é¢œè‰²ä¸åŒï¼ˆNotion: ${existingColor}, ç”¨æˆ·è®¾ç½®: ${mappedUserColor}ï¼‰ï¼Œä¸è®¾ç½®é¢œè‰²ï¼Œä¿æŒåŸè‰²`);
                        return {
                            name: name
                            // ä¸è®¾ç½®colorå±æ€§
                        };
                    } else {
                        console.log(`æ ‡ç­¾ "${name}" å·²å­˜åœ¨ä¸”é¢œè‰²ç›¸åŒæˆ–ç”¨æˆ·è®¾ç½®é¢œè‰²ï¼Œä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„é¢œè‰²: ${mappedUserColor}`);
                        return {
                            name: name,
                            color: mappedUserColor
                        };
                    }
                } else {
                    const mappedColor = colorMapping[colors] || colors;
                    console.log(`æ ‡ç­¾ "${name}" ä¸ºæ–°æ ‡ç­¾ï¼Œè®¾ç½®é¢œè‰²: ${mappedColor}`);
                    // æ–°æ ‡ç­¾ï¼Œä½¿ç”¨æŒ‡å®šé¢œè‰²
                    return {
                        name: name,
                        color: mappedColor
                    };
                }
            })
        };
        console.log('formatMultiSelect - å•è‰²ç»“æœ:', result);
        return result;
    }
    // æ˜¾ç¤ºè‡ªå®šä¹‰æ ‡ç­¾é€‰æ‹©å¼¹çª—
    function showCustomTagsDialog(contentType) {
        return new Promise((resolve) => {
            // åˆ›å»ºå¼¹çª—èƒŒæ™¯
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: -webkit-fill-available;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // åˆ›å»ºå¼¹çª—å†…å®¹ - æ›´ç¾è§‚çš„è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                border-radius: 20px;
                padding: 0;
                max-width: 600px;
                width: 90%;
                max-height: 85vh;
                overflow: hidden;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.2);
                position: relative;
                display: flex;
                flex-direction: column;
            `;
            dialog.className = 'notion-CustomTags-dialog';

            // ç§»åŠ¨ç«¯é€‚é…
            if (window.innerWidth <= 768) {
                dialog.style.cssText = `
                    background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                    border-radius: 20px;
                    padding: 0;
                    max-width: 95%;
                    width: 95%;
                    max-height: 90vh;
                    overflow: hidden;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    position: relative;
                    display: flex;
                    flex-direction: column;
                `;
            }

            // æ·»åŠ è£…é¥°æ€§èƒŒæ™¯
            const decorationBg = document.createElement('div');
            decorationBg.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, var(--primarycolor-light, #FF8FAB) 0%, var(--primarycolor, #FF6B9D) 50%, var(--primarycolor-light, #FF8FAB) 100%);
                border-radius: 20px 20px 0 0;
            `;
            dialog.appendChild(decorationBg);


            // æ ‡é¢˜ - æ›´ç¾è§‚çš„è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const title = document.createElement('h3');
            title.textContent = 'è‡ªå®šä¹‰æ ‡ç­¾åˆ†ç»„ç®¡ç†';
            title.style.cssText = `
                margin: 0 0 0px 0;
                padding-top:15px;
                font-size: 20px;
                font-weight: 700;
                color: #1F2937;
                text-align: center;
                position: relative;
                background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            `;

            // ç§»åŠ¨ç«¯æ ‡é¢˜é€‚é…
            if (window.innerWidth <= 768) {
                title.style.fontSize = '18px';
                title.style.marginBottom = '12px';
            }

            // å®šä¹‰å¯ç”¨çš„é¢œè‰²é€‰é¡¹ - é©¬å¡é¾™æµ…è‰²å¯çˆ±ç³»
            const AVAILABLE_COLORS = [
                { name: 'default', label: 'é»˜è®¤', color: '#E5E7EB' },
                { name: 'gray', label: 'ç°è‰²', color: '#F3F4F6' },
                { name: 'brown', label: 'æ£•è‰²', color: '#F3E8D3' },
                { name: 'orange', label: 'æ©˜è‰²', color: '#FED7AA' },
                { name: 'yellow', label: 'é»„è‰²', color: '#FEF08A' },
                { name: 'green', label: 'ç»¿è‰²', color: '#D1FAE5' },
                { name: 'blue', label: 'è“è‰²', color: '#DBEAFE' },
                { name: 'purple', label: 'ç´«è‰²', color: '#E9D5FF' },
                { name: 'pink', label: 'ç²‰è‰²', color: '#FCE7F3' },
                { name: 'red', label: 'çº¢è‰²', color: '#FEE2E2' }
            ];

            // è½½å…¥ç”¨æˆ·ä¿å­˜çš„æ ‡ç­¾åˆ†ç»„æ•°æ®ï¼ˆæŒ‰æ¨¡å¼åˆ†åˆ«å­˜å‚¨ï¼‰
            let tagGroups = {};
            const savedGroupsKey = `custom_tag_groups_${contentType}`;
            const savedGroups = GM_getValue(savedGroupsKey);
            if (savedGroups && typeof savedGroups === 'object') {
                tagGroups = { ...savedGroups };
            } else {
                // å…¼å®¹æ—§ç‰ˆæœ¬æ•°æ®ï¼Œå°†å¹³é“ºçš„æ ‡ç­¾è½¬æ¢ä¸ºé»˜è®¤åˆ†ç»„
                const savedTagsKey = `custom_tags_${contentType}`;
                const savedTags = GM_getValue(savedTagsKey);
                if (savedTags && Array.isArray(savedTags) && savedTags.length > 0) {
                    tagGroups = {
                        'é»˜è®¤åˆ†ç»„': {
                            notionProperty: 'è‡ªå®šä¹‰æ ‡ç­¾',
                            tags: [...savedTags],
                            collapsed: false
                        }
                    };
                    // è¿ç§»æ•°æ®åˆ°æ–°æ ¼å¼
                    GM_setValue(savedGroupsKey, tagGroups);
                    GM_deleteValue(savedTagsKey);
                } else {
                    tagGroups = {
                        'é»˜è®¤åˆ†ç»„': {
                            notionProperty: 'è‡ªå®šä¹‰æ ‡ç­¾',
                            tags: [],
                            collapsed: false
                        }
                    };
                }
            }

            // è½½å…¥æ ‡ç­¾ä½¿ç”¨ç»Ÿè®¡
            let tagUsageStats = {};
            const usageStatsKey = `tag_usage_stats_${contentType}`;
            const savedUsageStats = GM_getValue(usageStatsKey);
            if (savedUsageStats && typeof savedUsageStats === 'object') {
                tagUsageStats = { ...savedUsageStats };
            }

            // è½½å…¥ä¸»åˆ†ç»„æ•°æ®
            let mainGroups = {};
            const savedMainGroupsKey = `main_groups_${contentType}`;
            const savedMainGroups = GM_getValue(savedMainGroupsKey);
            if (savedMainGroups && typeof savedMainGroups === 'object') {
                mainGroups = { ...savedMainGroups };
            } else {
                // åˆå§‹åŒ–é»˜è®¤ä¸»åˆ†ç»„
                mainGroups = {
                    'é»˜è®¤ä¸»åˆ†ç»„': {
                        name: 'é»˜è®¤ä¸»åˆ†ç»„',
                        subGroups: { ...tagGroups }, // å¤åˆ¶ç°æœ‰çš„å­åˆ†ç»„
                        sharedSubGroups: true, // é»˜è®¤å…±äº«å­åˆ†ç»„
                        isActive: true
                    }
                };
                GM_setValue(savedMainGroupsKey, mainGroups);
            }

            // å½“å‰é€‰ä¸­çš„ä¸»åˆ†ç»„
            let currentMainGroup = 'é»˜è®¤ä¸»åˆ†ç»„';
            const currentMainGroupKey = `current_main_group_${contentType}`;
            const savedCurrentMainGroup = GM_getValue(currentMainGroupKey);
            if (savedCurrentMainGroup && mainGroups[savedCurrentMainGroup]) {
                currentMainGroup = savedCurrentMainGroup;
            }

            // æ›´æ–°æ ‡ç­¾ä½¿ç”¨ç»Ÿè®¡
            function updateTagUsage(tagName, groupName) {
                const key = `${groupName}:${tagName}`;
                tagUsageStats[key] = (tagUsageStats[key] || 0) + 1;
                GM_setValue(usageStatsKey, tagUsageStats);
            }

            // åˆ›å»ºæœç´¢å’Œè¿‡æ»¤å®¹å™¨
            const searchFilterContainer = document.createElement('div');
            searchFilterContainer.style.cssText = `
                margin-bottom: 16px;
                padding: 16px;
                background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                border-radius: 20px;
                border: 1px solid #E2E8F0;
            `;

            // æœç´¢æ¡†
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'æœç´¢æ ‡ç­¾...';
            searchInput.style.cssText = `
                width: -webkit-fill-available;
                padding: 12px 16px;
                border: 2px solid #E2E8F0;
                border-radius: 20px;
                font-size: 14px;
                background: white;
                transition: all 0.2s ease;
                    margin-bottom: 12px;
                box-sizing: border-box;
            `;

            // é¢œè‰²è¿‡æ»¤å™¨
            const colorFilterContainer = document.createElement('div');
            colorFilterContainer.style.cssText = `
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 12px;
            `;

            const colorFilterLabel = document.createElement('span');
            colorFilterLabel.textContent = 'é¢œè‰²ç­›é€‰:';
            colorFilterLabel.style.cssText = `
                font-size: 13px;
                color: #6B7280;
                font-weight: 500;
                margin-right: 8px;
                align-self: center;
            `;

            // åˆ›å»ºé¢œè‰²ç­›é€‰æŒ‰é’®
            const colorFilterButtons = AVAILABLE_COLORS.map(color => {
                const btn = document.createElement('button');
                btn.style.cssText = `
                    width: 24px;
                    height: 24px;
                    border: 2px solid transparent;
                    border-radius: 50%;
                    background: ${color.color};
                    cursor: pointer;
                    transition: all 0.2s ease;
                    position: relative;
                `;
                btn.dataset.color = color.name;
                btn.title = color.label;

                btn.addEventListener('click', () => {
                    btn.style.borderColor = btn.style.borderColor === 'rgb(107, 114, 128)' ? 'transparent' : '#6B7280';
                    filterTags();
                });

                return btn;
            });

            // æœç´¢ç»“æœç»Ÿè®¡
            const searchStats = document.createElement('div');
            searchStats.style.cssText = `
                font-size: 12px;
                color: #6B7280;
                text-align: right;
                margin-top: 8px;
            `;

            colorFilterContainer.appendChild(colorFilterLabel);
            colorFilterButtons.forEach(btn => colorFilterContainer.appendChild(btn));

            searchFilterContainer.appendChild(searchInput);
            searchFilterContainer.appendChild(colorFilterContainer);
            searchFilterContainer.appendChild(searchStats);

            // åˆ›å»ºåˆ†ç»„å®¹å™¨
            const groupsContainer = document.createElement('div');
            groupsContainer.style.cssText = `
                margin-bottom: 20px;
                max-height: 400px;
                overflow-y: auto;
            `;

            // åˆ›å»ºä¸»åˆ†ç»„ç®¡ç†å®¹å™¨
            const mainGroupContainer = document.createElement('div');
            mainGroupContainer.style.cssText = `
                margin-bottom: 12px;
                padding: 12px;
                background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                border-radius: 20px;
                border: 1px solid #E2E8F0;
            `;

            // ä¸»åˆ†ç»„æ ‡é¢˜
            const mainGroupTitle = document.createElement('div');
            mainGroupTitle.textContent = 'ä¸»åˆ†ç»„ç®¡ç†';
            mainGroupTitle.style.cssText = `
                font-size: 14px;
                font-weight: 600;
                color: #1F2937;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 6px;
            `;

            // æ·»åŠ ä¸»åˆ†ç»„æŒ‰é’®ï¼ˆæ¨¡æ¿ï¼Œç”¨äºå…‹éš†ï¼‰
            const addMainGroupBtn = document.createElement('button');
            addMainGroupBtn.textContent = '+ æ–°å»ºä¸»åˆ†ç»„';
            addMainGroupBtn.style.cssText = `
                padding: 6px 12px;
                background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                color: #4B5563;
                border: 1px solid #E5E7EB;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: var(--primarycolor-lighter);
                position: relative;
                overflow: hidden;
            `;

            addMainGroupBtn.addEventListener('mouseenter', () => {
                addMainGroupBtn.style.background = 'linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%)';
                addMainGroupBtn.style.borderColor = '#93C5FD';
                addMainGroupBtn.style.color = '#1E40AF';
                addMainGroupBtn.style.transform = 'translateY(-2px)';
                addMainGroupBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
            });

            addMainGroupBtn.addEventListener('mouseleave', () => {
                addMainGroupBtn.style.background = 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)';
                addMainGroupBtn.style.borderColor = '#E5E7EB';
                addMainGroupBtn.style.color = '#4B5563';
                addMainGroupBtn.style.transform = 'translateY(0)';
                addMainGroupBtn.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
            });

            // ä¸»åˆ†ç»„åˆ—è¡¨å®¹å™¨
            const mainGroupListContainer = document.createElement('div');
            mainGroupListContainer.id = 'main-group-list';
            mainGroupListContainer.style.cssText = `
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                margin-top: 6px;
            `;

            // åˆ›å»ºåˆ†ç»„ç®¡ç†æŒ‰é’®å®¹å™¨
            const groupManagementContainer = document.createElement('div');
            groupManagementContainer.style.cssText = `
                margin-bottom: 12px;
                padding: 8px;
                background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                border-radius: 20px;
                border: 1px solid #E2E8F0;
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                align-items: center;
            `;

            // æ·»åŠ æ–°åˆ†ç»„æŒ‰é’®
            const addGroupBtn = document.createElement('button');
            addGroupBtn.textContent = '+ æ–°å»ºåˆ†ç»„';
            addGroupBtn.style.cssText = `
                padding: 10px 16px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                border: none;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                margin-right: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                min-width: 100px;
                position: relative;
                overflow: hidden;
            `;

            addGroupBtn.addEventListener('mouseenter', () => {
                addGroupBtn.style.transform = 'translateY(-2px)';
                addGroupBtn.style.boxShadow = '0 4px 12px var(--primarycolor-lighter)';
            });

            addGroupBtn.addEventListener('mouseleave', () => {
                addGroupBtn.style.transform = 'translateY(0)';
                addGroupBtn.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
            });

            // æ–°å»ºåˆ†ç»„åŠŸèƒ½
            addGroupBtn.addEventListener('click', () => {
                // åˆ›å»ºåˆ†ç»„åˆ›å»ºå¯¹è¯æ¡†
                const createGroupDialog = document.createElement('div');
                createGroupDialog.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: -webkit-fill-available;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                const createGroupContent = document.createElement('div');
                createGroupContent.style.cssText = `
                    background: white;
                    padding: 24px;
                    border-radius: 20px;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    width: 400px;
                    max-width: 90vw;
                `;

                setSafeHtml(createGroupContent, `
                    <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #1F2937; background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">åˆ›å»ºæ–°åˆ†ç»„</h3>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4B5563;">åˆ†ç»„åç§°:</label>
                        <input type="text" id="new-group-name" placeholder="è¯·è¾“å…¥åˆ†ç»„åç§°" style="width: -webkit-fill-available; padding: 12px; border: 1px solid #E5E7EB; border-radius: 20px; font-size: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: all 0.3s ease;">
                        <div style="margin-top: 4px; font-size: 13px; color: #6B7280;">åˆ†ç»„åç§°å°†åŒæ—¶ç”¨ä½œNotionå±æ€§å</div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #4B5563;">é»˜è®¤æ ‡ç­¾é¢œè‰²:</label>
                        <select id="new-group-default-color" style="width: -webkit-fill-available; padding: 12px; border: 1px solid #E5E7EB; border-radius: 20px; font-size: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); transition: all 0.3s ease;">
                            ${AVAILABLE_COLORS.map(color => `<option value="${color.name}">${color.label}</option>`).join('')}
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button id="cancel-create-group" style="padding: 10px 18px; background: #F9FAFB; color: #4B5563; border: 1px solid #E5E7EB; border-radius: 20px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;">å–æ¶ˆ</button>
                        <button id="confirm-create-group" style="padding: 10px 18px; background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 12px rgba(255,107,157,0.2); transition: all 0.2s ease;">åˆ›å»º</button>
                    </div>
                `);

                createGroupDialog.appendChild(createGroupContent);
                document.body.appendChild(createGroupDialog);

                // äº‹ä»¶ç›‘å¬
                const cancelCreateBtn = createGroupContent.querySelector('#cancel-create-group');
                const confirmCreateBtn = createGroupContent.querySelector('#confirm-create-group');
                const nameInput = createGroupContent.querySelector('#new-group-name');

                cancelCreateBtn.addEventListener('click', () => {
                    document.body.removeChild(createGroupDialog);
                });

                confirmCreateBtn.addEventListener('click', () => {
                    const groupName = nameInput.value.trim();
                    const propertyName = groupName; // ä½¿ç”¨åˆ†ç»„åç§°ä½œä¸ºNotionå±æ€§å
                    const defaultColor = createGroupContent.querySelector('#new-group-default-color').value;

                    if (!groupName) {
                        alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                        return;
                    }

                    // æ£€æŸ¥åˆ†ç»„åæ˜¯å¦å·²å­˜åœ¨
                    if (tagGroups[groupName]) {
                        alert('åˆ†ç»„åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                        return;
                    }

                    // åˆ›å»ºæ–°åˆ†ç»„ï¼ˆç»„åå³Notionå±æ€§åï¼‰
                    tagGroups[groupName] = {
                        notionProperty: propertyName,
                        tags: [],
                        collapsed: false,
                        defaultColor: defaultColor
                    };

                    document.body.removeChild(createGroupDialog);

                    // æ›´æ–°å½“å‰ä¸»åˆ†ç»„çš„å­åˆ†ç»„
                    if (mainGroups[currentMainGroup]) {
                        mainGroups[currentMainGroup].subGroups = { ...tagGroups };
                        GM_setValue(savedMainGroupsKey, mainGroups);
                    }

                    GM_setValue(savedGroupsKey, tagGroups);
                    updateGroupSelect();
                    renderGroups();

                    // è‡ªåŠ¨é€‰ä¸­æ–°åˆ†ç»„
                    groupSelect.value = groupName;
                });
            });

            // æ‰¹é‡æ“ä½œæŒ‰é’®ï¼ˆè“è‰²æ¸å˜ï¼‰
            const batchOpsBtn = document.createElement('button');
            batchOpsBtn.textContent = 'âŠ™ æ‰¹é‡æ“ä½œ';
            batchOpsBtn.style.cssText = `
                padding: 10px 16px;
                background: linear-gradient(135deg, #BFDBFE 0%, #93C5FD 100%);
                color: white;
                border: none;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                margin-right: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                min-width: 100px;
                position: relative;
                overflow: hidden;
            `;

            batchOpsBtn.addEventListener('mouseenter', () => {
                batchOpsBtn.style.transform = 'translateY(-2px)';
                batchOpsBtn.style.boxShadow = '0 4px 12px rgba(147, 197, 253, 0.3)';
            });

            batchOpsBtn.addEventListener('mouseleave', () => {
                batchOpsBtn.style.transform = 'translateY(0)';
                batchOpsBtn.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
            });

            // æ‰¹é‡æ“ä½œå¯¹è¯æ¡†
            function showBatchOperationsDialog() {
                const batchDialog = document.createElement('div');
                batchDialog.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: -webkit-fill-available;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                const batchContent = document.createElement('div');
                batchContent.id = 'batch-ops-dialog';
                batchContent.style.cssText = `
                    background: white;
                border-radius: 20px;
                    padding: 24px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                `;

                const batchTitle = document.createElement('h3');
                batchTitle.textContent = 'æ‰¹é‡æ“ä½œ';
                batchTitle.style.cssText = `
                    margin: 0 0 20px 0;
                    font-size: 18px;
                    font-weight: 600;
                    color: #1F2937;
                `;

                // æ“ä½œç±»å‹é€‰æ‹©
                const operationSelect = document.createElement('select');
                operationSelect.style.cssText = `
                    width: -webkit-fill-available;
                    padding: 12px;
                    border: 2px solid #E2E8F0;
                    border-radius: 20px;
                    font-size: 14px;
                    margin-bottom: 16px;
                `;

                const operations = [
                    { value: 'move', text: 'æ‰¹é‡ç§»åŠ¨æ ‡ç­¾åˆ°å…¶ä»–åˆ†ç»„' },
                    { value: 'color', text: 'æ‰¹é‡ä¿®æ”¹æ ‡ç­¾é¢œè‰²' },
                    { value: 'delete', text: 'æ‰¹é‡åˆ é™¤æ ‡ç­¾' },
                    { value: 'cleanup', text: 'æ¸…ç†æœªä½¿ç”¨çš„æ ‡ç­¾' }
                ];

                operations.forEach(op => {
                    const option = document.createElement('option');
                    option.value = op.value;
                    option.textContent = op.text;
                    operationSelect.appendChild(option);
                });

                // æ“ä½œå†…å®¹åŒºåŸŸ
                const operationContent = document.createElement('div');
                operationContent.id = 'batch-operation-content';

                // ç¡®è®¤å’Œå–æ¶ˆæŒ‰é’®
                const batchButtons = document.createElement('div');
                batchButtons.style.cssText = `
                    display: flex;
                    gap: 12px;
                    justify-content: flex-end;
                    margin-top: 20px;
                `;

                const batchConfirmBtn = document.createElement('button');
                batchConfirmBtn.textContent = 'æ‰§è¡Œ';
                batchConfirmBtn.className = 'btn-primarycolor';

                const batchCancelBtn = document.createElement('button');
                batchCancelBtn.textContent = 'å–æ¶ˆ';
                batchCancelBtn.className = 'btn-secondary';

                batchButtons.appendChild(batchCancelBtn);
                batchButtons.appendChild(batchConfirmBtn);

                batchContent.appendChild(batchTitle);
                batchContent.appendChild(operationSelect);
                batchContent.appendChild(operationContent);
                batchContent.appendChild(batchButtons);

                batchDialog.appendChild(batchContent);
                document.body.appendChild(batchDialog);

                // æ“ä½œç±»å‹å˜åŒ–äº‹ä»¶
                operationSelect.addEventListener('change', () => {
                    updateBatchOperationContent(operationSelect.value, operationContent);
                });

                // åˆå§‹åŒ–å†…å®¹
                updateBatchOperationContent('move', operationContent);

                // å–æ¶ˆæŒ‰é’®
                batchCancelBtn.addEventListener('click', () => {
                    document.body.removeChild(batchDialog);
                });

                // ç¡®è®¤æŒ‰é’®
                batchConfirmBtn.addEventListener('click', () => {
                    executeBatchOperation(operationSelect.value, operationContent);
                    document.body.removeChild(batchDialog);
                    renderGroups(); // é‡æ–°æ¸²æŸ“
                });

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                batchDialog.addEventListener('click', (e) => {
                    if (e.target === batchDialog) {
                        document.body.removeChild(batchDialog);
                    }
                });
            }

            // æ›´æ–°æ‰¹é‡æ“ä½œå†…å®¹
            function updateBatchOperationContent(operation, container) {
                container.textContent = '';

                switch (operation) {
                    case 'move':
                        const moveContent = document.createElement('div');
                        setSafeHtml(moveContent, `
                            <p style="margin: 0 0 12px 0; color: #6B7280; font-size: 14px;">é€‰æ‹©è¦ç§»åŠ¨çš„æ ‡ç­¾å’Œç›®æ ‡åˆ†ç»„ï¼š</p>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">æºåˆ†ç»„:</label>
                                <select id="source-group" style="width: -webkit-fill-available; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    ${Object.keys(tagGroups).map(name => `<option value="${name}">${name}</option>`).join('')}
                                </select>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">ç›®æ ‡åˆ†ç»„:</label>
                                <select id="target-group" style="width: -webkit-fill-available; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    ${Object.keys(tagGroups).map(name => `<option value="${name}">${name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <label style="font-weight: 500;">è¦ç§»åŠ¨çš„æ ‡ç­¾:</label>
                                    <button type="button" id="select-all-move" class="dialog-btn-secondary" style="padding: 6px 12px; font-size: 12px; border-radius: 6px;">å…¨é€‰</button>
                                </div>
                                <div id="tags-to-move" style="max-height: 240px; overflow-y: auto; border: 1px solid #E5E7EB; border-radius: 20px; padding: 8px; background: linear-gradient(135deg,#F8FAFC,#F1F5F9);">
                                    <!-- æ ‡ç­¾åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        `);
                        container.appendChild(moveContent);
                        updateMoveTagsList();
                        // ç›‘å¬åˆ†ç»„åˆ‡æ¢ï¼Œåˆ·æ–°å¯ç§»åŠ¨æ ‡ç­¾åˆ—è¡¨
                        const sourceGroupSelect = moveContent.querySelector('#source-group');
                        if (sourceGroupSelect) {
                            sourceGroupSelect.addEventListener('change', updateMoveTagsList);
                        }
                        // æ·»åŠ å…¨é€‰æŒ‰é’®äº‹ä»¶ç›‘å¬
                        const selectAllMoveBtn = moveContent.querySelector('#select-all-move');
                        if (selectAllMoveBtn) {
                            selectAllMoveBtn.addEventListener('click', () => {
                                const checkboxes = moveContent.querySelectorAll('#tags-to-move input[type="checkbox"]');
                                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                                checkboxes.forEach(cb => cb.checked = !allChecked);
                                selectAllMoveBtn.textContent = allChecked ? 'å…¨é€‰' : 'å…¨ä¸é€‰';
                            });
                        }
                        break;

                    case 'color':
                        const colorContent = document.createElement('div');
                        setSafeHtml(colorContent, `
                            <p style="margin: 0 0 12px 0; color: #6B7280; font-size: 14px;">é€‰æ‹©è¦ä¿®æ”¹é¢œè‰²çš„æ ‡ç­¾ï¼š</p>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">åˆ†ç»„:</label>
                                <select id="color-group" style="width: -webkit-fill-available; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    ${Object.keys(tagGroups).map(name => `<option value="${name}">${name}</option>`).join('')}
                                </select>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">æ–°é¢œè‰²:</label>
                                <select id="new-color" style="width: -webkit-fill-available; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    ${AVAILABLE_COLORS.map(color => `<option value="${color.name}">${color.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <label style="font-weight: 500;">è¦ä¿®æ”¹çš„æ ‡ç­¾:</label>
                                    <button type="button" id="select-all-color" class="dialog-btn-secondary" style="padding: 6px 12px; font-size: 12px; border-radius: 6px;">å…¨é€‰</button>
                                </div>
                                <div id="tags-to-color" style="max-height: 200px; overflow-y: auto; border: 1px solid #D1D5DB; border-radius: 6px; padding: 8px;">
                                    <!-- æ ‡ç­¾åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        `);
                        container.appendChild(colorContent);
                        updateColorTagsList();
                        // ç›‘å¬åˆ†ç»„åˆ‡æ¢ï¼Œåˆ·æ–°é¢œè‰²æ ‡ç­¾åˆ—è¡¨
                        const colorGroupSelect = colorContent.querySelector('#color-group');
                        if (colorGroupSelect) {
                            colorGroupSelect.addEventListener('change', updateColorTagsList);
                        }
                        // æ·»åŠ å…¨é€‰æŒ‰é’®äº‹ä»¶ç›‘å¬
                        const selectAllColorBtn = colorContent.querySelector('#select-all-color');
                        if (selectAllColorBtn) {
                            selectAllColorBtn.addEventListener('click', () => {
                                const checkboxes = colorContent.querySelectorAll('#tags-to-color input[type="checkbox"]');
                                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                                checkboxes.forEach(cb => cb.checked = !allChecked);
                                selectAllColorBtn.textContent = allChecked ? 'å…¨é€‰' : 'å…¨ä¸é€‰';
                            });
                        }
                        break;

                    case 'delete':
                        const deleteContent = document.createElement('div');
                        setSafeHtml(deleteContent, `
                            <p style="margin: 0 0 12px 0; color: #EF4444; font-size: 14px; background: #FEF2F2; padding: 8px 12px; border-radius: 6px; border-left: 3px solid #EF4444;">æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·è°¨æ…é€‰æ‹©è¦åˆ é™¤çš„æ ‡ç­¾</p>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">åˆ†ç»„:</label>
                                <select id="delete-group" style="width: -webkit-fill-available; padding: 8px; border: 1px solid #D1D5DB; border-radius: 6px;">
                                    ${Object.keys(tagGroups).map(name => `<option value="${name}">${name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <label style="font-weight: 500;">è¦åˆ é™¤çš„æ ‡ç­¾:</label>
                                    <button type="button" id="select-all-delete" class="dialog-btn-secondary" style="padding: 6px 12px; font-size: 12px; border-radius: 6px;">å…¨é€‰</button>
                                </div>
                                <div id="tags-to-delete" style="max-height: 200px; overflow-y: auto; border: 1px solid #FECACA; border-radius: 6px; padding: 8px; background: #FEFEFE;">
                                    <!-- æ ‡ç­¾åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        `);
                        container.appendChild(deleteContent);
                        updateDeleteTagsList();
                        // ç›‘å¬åˆ†ç»„åˆ‡æ¢ï¼Œåˆ·æ–°åˆ é™¤æ ‡ç­¾åˆ—è¡¨
                        const deleteGroupSelect = deleteContent.querySelector('#delete-group');
                        if (deleteGroupSelect) {
                            deleteGroupSelect.addEventListener('change', updateDeleteTagsList);
                        }
                        // æ·»åŠ å…¨é€‰æŒ‰é’®äº‹ä»¶ç›‘å¬
                        const selectAllDeleteBtn = deleteContent.querySelector('#select-all-delete');
                        if (selectAllDeleteBtn) {
                            selectAllDeleteBtn.addEventListener('click', () => {
                                const checkboxes = deleteContent.querySelectorAll('#tags-to-delete input[type="checkbox"]');
                                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                                checkboxes.forEach(cb => cb.checked = !allChecked);
                                selectAllDeleteBtn.textContent = allChecked ? 'å…¨é€‰' : 'å…¨ä¸é€‰';
                            });
                        }
                        break;

                    case 'cleanup':
                        const cleanupContent = document.createElement('div');
                        setSafeHtml(cleanupContent, `
                            <p style="margin: 0 0 12px 0; color: #6B7280; font-size: 14px;">æ¸…ç†æœªä½¿ç”¨çš„æ ‡ç­¾ï¼ˆä½¿ç”¨æ¬¡æ•°ä¸º0çš„æ ‡ç­¾ï¼‰ï¼š</p>
                            <div id="unused-tags" style="max-height: 300px; overflow-y: auto; border: 1px solid #D1D5DB; border-radius: 6px; padding: 8px;">
                                <!-- æœªä½¿ç”¨æ ‡ç­¾åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        `);
                        container.appendChild(cleanupContent);
                        updateUnusedTagsList();
                        break;
                }
            }

            // æ›´æ–°ç§»åŠ¨æ ‡ç­¾åˆ—è¡¨
            function updateMoveTagsList() {
                const sourceGroup = document.getElementById('source-group')?.value;
                const container = document.getElementById('tags-to-move');
                if (!sourceGroup || !container) return;

                container.textContent = '';
                const tags = tagGroups[sourceGroup]?.tags || [];

                tags.forEach(tag => {
                    const tagName = typeof tag === 'string' ? tag : tag.name;
                    const tagColor = (typeof tag === 'string' ? 'default' : (tag.color || 'default'));

                    const row = document.createElement('div');
                    row.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 6px;';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = tagName;
                    checkbox.id = `move-${tagName}`;

                    const pill = document.createElement('label');
                    pill.htmlFor = `move-${tagName}`;
                    pill.style.cssText = 'display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 20px; background: #F9FAFB; border: 1px solid #E5E7EB; cursor: pointer;';

                    const dot = document.createElement('span');
                    dot.style.cssText = `width: 10px; height: 10px; border-radius: 50%; background: ${(AVAILABLE_COLORS.find(c => c.name === tagColor)?.color) || '#E5E7EB'};`;

                    const text = document.createElement('span');
                    text.textContent = tagName;
                    text.style.cssText = 'font-size: 13px; color: #374151;';

                    pill.appendChild(dot);
                    pill.appendChild(text);

                    row.appendChild(checkbox);
                    row.appendChild(pill);
                    container.appendChild(row);
                });
            }

            // æ›´æ–°é¢œè‰²æ ‡ç­¾åˆ—è¡¨
            function updateColorTagsList() {
                const group = document.getElementById('color-group')?.value;
                const container = document.getElementById('tags-to-color');
                if (!group || !container) return;

                container.textContent = '';
                const tags = tagGroups[group]?.tags || [];

                tags.forEach(tag => {
                    const tagName = typeof tag === 'string' ? tag : tag.name;
                    const tagColor = (typeof tag === 'string' ? 'default' : (tag.color || 'default'));

                    const row = document.createElement('div');
                    row.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 6px;';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = tagName;
                    checkbox.id = `color-${tagName}`;

                    const pill = document.createElement('label');
                    pill.htmlFor = `color-${tagName}`;
                    pill.style.cssText = 'display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 20px; background: #F9FAFB; border: 1px solid #E5E7EB; cursor: pointer;';

                    const dot = document.createElement('span');
                    dot.style.cssText = `width: 10px; height: 10px; border-radius: 50%; background: ${(AVAILABLE_COLORS.find(c => c.name === tagColor)?.color) || '#E5E7EB'};`;

                    const text = document.createElement('span');
                    text.textContent = tagName;
                    text.style.cssText = 'font-size: 13px; color: #374151;';

                    pill.appendChild(dot);
                    pill.appendChild(text);

                    row.appendChild(checkbox);
                    row.appendChild(pill);
                    container.appendChild(row);
                });
            }

            // æ›´æ–°åˆ é™¤æ ‡ç­¾åˆ—è¡¨
            function updateDeleteTagsList() {
                const group = document.getElementById('delete-group')?.value;
                const container = document.getElementById('tags-to-delete');
                if (!group || !container) return;

                container.textContent = '';
                const tags = tagGroups[group]?.tags || [];

                tags.forEach(tag => {
                    const tagName = typeof tag === 'string' ? tag : tag.name;
                    const tagColor = (typeof tag === 'string' ? 'default' : (tag.color || 'default'));

                    const row = document.createElement('div');
                    row.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 6px;';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = tagName;
                    checkbox.id = `delete-${tagName}`;

                    const pill = document.createElement('label');
                    pill.htmlFor = `delete-${tagName}`;
                    pill.style.cssText = 'display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 20px; background: #FEF2F2; border: 1px solid #FECACA; cursor: pointer;';

                    const dot = document.createElement('span');
                    dot.style.cssText = `width: 10px; height: 10px; border-radius: 50%; background: ${(AVAILABLE_COLORS.find(c => c.name === tagColor)?.color) || '#FCA5A5'};`;

                    const text = document.createElement('span');
                    text.textContent = tagName;
                    text.style.cssText = 'font-size: 13px; color: #B91C1C; font-weight: 600;';

                    pill.appendChild(dot);
                    pill.appendChild(text);

                    row.appendChild(checkbox);
                    row.appendChild(pill);
                    container.appendChild(row);
                });
            }

            // æ›´æ–°æœªä½¿ç”¨æ ‡ç­¾åˆ—è¡¨
            function updateUnusedTagsList() {
                const container = document.getElementById('unused-tags');
                if (!container) return;

                container.textContent = '';
                const unusedTags = [];

                Object.keys(tagGroups).forEach(groupName => {
                    const tags = tagGroups[groupName].tags || [];
                    tags.forEach(tag => {
                        const tagName = typeof tag === 'string' ? tag : tag.name;
                        const usageCount = tagUsageStats[`${groupName}:${tagName}`] || 0;
                        if (usageCount === 0) {
                            unusedTags.push({ groupName, tagName });
                        }
                    });
                });

                if (unusedTags.length === 0) {
                    setSafeHtml(container, '<p style="color: #10B981; text-align: center; margin: 20px 0; background: #F0FDF4; padding: 12px; border-radius: 6px; border-left: 3px solid #10B981;">æ²¡æœ‰æœªä½¿ç”¨çš„æ ‡ç­¾ï¼</p>');
                    return;
                }

                unusedTags.forEach(({ groupName, tagName }) => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = `${groupName}:${tagName}`;
                    checkbox.id = `cleanup-${groupName}-${tagName}`;

                    const label = document.createElement('label');
                    label.htmlFor = `cleanup-${groupName}-${tagName}`;
                    label.textContent = `${groupName} - ${tagName}`;
                    label.style.cssText = 'margin-left: 8px; cursor: pointer;';

                    const div = document.createElement('div');
                    div.style.cssText = 'margin-bottom: 4px;';
                    div.appendChild(checkbox);
                    div.appendChild(label);

                    container.appendChild(div);
                });
            }

            // æ‰§è¡Œæ‰¹é‡æ“ä½œ
            function executeBatchOperation(operation, container) {
                switch (operation) {
                    case 'move':
                        const sourceGroup = document.getElementById('source-group')?.value;
                        const targetGroup = document.getElementById('target-group')?.value;
                        const moveCheckboxes = container.querySelectorAll('#tags-to-move input[type="checkbox"]:checked');

                        if (sourceGroup === targetGroup) {
                            alert('æºåˆ†ç»„å’Œç›®æ ‡åˆ†ç»„ä¸èƒ½ç›¸åŒï¼');
                            return;
                        }

                        moveCheckboxes.forEach(checkbox => {
                            const tagName = checkbox.value;
                            const tagIndex = tagGroups[sourceGroup].tags.findIndex(t =>
                                                                                   (typeof t === 'string' ? t : t.name) === tagName
                                                                                  );
                            if (tagIndex > -1) {
                                const tag = tagGroups[sourceGroup].tags.splice(tagIndex, 1)[0];
                                tagGroups[targetGroup].tags.push(tag);
                            }
                        });
                        GM_setValue(savedGroupsKey, tagGroups);
                        alert(`æˆåŠŸç§»åŠ¨ ${moveCheckboxes.length} ä¸ªæ ‡ç­¾åˆ° ${targetGroup}`);
                        break;

                    case 'color':
                        const colorGroup = document.getElementById('color-group')?.value;
                        const newColor = document.getElementById('new-color')?.value;
                        const colorCheckboxes = container.querySelectorAll('#tags-to-color input[type="checkbox"]:checked');

                        colorCheckboxes.forEach(checkbox => {
                            const tagName = checkbox.value;
                            const tagIndex = tagGroups[colorGroup].tags.findIndex(t =>
                                                                                  (typeof t === 'string' ? t : t.name) === tagName
                                                                                 );
                            if (tagIndex > -1) {
                                if (typeof tagGroups[colorGroup].tags[tagIndex] === 'string') {
                                    tagGroups[colorGroup].tags[tagIndex] = { name: tagGroups[colorGroup].tags[tagIndex], color: newColor };
                                } else {
                                    tagGroups[colorGroup].tags[tagIndex].color = newColor;
                                }
                            }
                        });
                        GM_setValue(savedGroupsKey, tagGroups);
                        alert(`æˆåŠŸä¿®æ”¹ ${colorCheckboxes.length} ä¸ªæ ‡ç­¾çš„é¢œè‰²`);
                        break;

                    case 'delete':
                        const deleteGroup = document.getElementById('delete-group')?.value;
                        const deleteCheckboxes = container.querySelectorAll('#tags-to-delete input[type="checkbox"]:checked');

                        if (deleteCheckboxes.length === 0) {
                            alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ ‡ç­¾ï¼');
                            return;
                        }

                        if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${deleteCheckboxes.length} ä¸ªæ ‡ç­¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                            return;
                        }

                        deleteCheckboxes.forEach(checkbox => {
                            const tagName = checkbox.value;
                            const tagIndex = tagGroups[deleteGroup].tags.findIndex(t =>
                                                                                   (typeof t === 'string' ? t : t.name) === tagName
                                                                                  );
                            if (tagIndex > -1) {
                                tagGroups[deleteGroup].tags.splice(tagIndex, 1);
                            }
                        });
                        GM_setValue(savedGroupsKey, tagGroups);
                        alert(`æˆåŠŸåˆ é™¤ ${deleteCheckboxes.length} ä¸ªæ ‡ç­¾`);
                        break;

                    case 'cleanup':
                        const cleanupCheckboxes = container.querySelectorAll('#unused-tags input[type="checkbox"]:checked');

                        if (cleanupCheckboxes.length === 0) {
                            alert('è¯·é€‰æ‹©è¦æ¸…ç†çš„æ ‡ç­¾ï¼');
                            return;
                        }

                        if (!confirm(`ç¡®å®šè¦æ¸…ç† ${cleanupCheckboxes.length} ä¸ªæœªä½¿ç”¨çš„æ ‡ç­¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                            return;
                        }

                        cleanupCheckboxes.forEach(checkbox => {
                            const [groupName, tagName] = checkbox.value.split(':');
                            const tagIndex = tagGroups[groupName].tags.findIndex(t =>
                                                                                 (typeof t === 'string' ? t : t.name) === tagName
                                                                                );
                            if (tagIndex > -1) {
                                tagGroups[groupName].tags.splice(tagIndex, 1);
                            }
                        });
                        GM_setValue(savedGroupsKey, tagGroups);
                        alert(`æˆåŠŸæ¸…ç† ${cleanupCheckboxes.length} ä¸ªæœªä½¿ç”¨çš„æ ‡ç­¾`);
                        break;
                }
            }

            // æ‰¹é‡æ“ä½œåŠŸèƒ½
            batchOpsBtn.addEventListener('click', () => {
                showBatchOperationsDialog();
            });

            // åˆ æ‰æœªå­˜åœ¨æ ‡ç­¾çš„å­åˆ†ç»„æŒ‰é’®ï¼ˆæ©™è‰²æ¸å˜ï¼‰
            const deleteEmptyGroupsBtn = document.createElement('button');
            deleteEmptyGroupsBtn.textContent = 'ğŸ—‘ï¸ åˆ æ‰ç©ºåˆ†ç»„';
            deleteEmptyGroupsBtn.style.cssText = `
                padding: 10px 16px;
                background: linear-gradient(135deg, #FED7AA 0%, #FDBA74 100%);
                color: white;
                text-shadow: 0 0 #26335945;
                border: none;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s ease;
                margin-right: 12px;
                box-shadow: 0 2px 8px rgba(253, 186, 116, 0.35);
                min-width: 100px;
            `;

            deleteEmptyGroupsBtn.addEventListener('mouseenter', () => {
                deleteEmptyGroupsBtn.style.transform = 'translateY(-1px)';
                deleteEmptyGroupsBtn.style.boxShadow = '0 6px 16px rgba(253, 186, 116, 0.45)';
            });

            deleteEmptyGroupsBtn.addEventListener('mouseleave', () => {
                deleteEmptyGroupsBtn.style.transform = 'translateY(0)';
                deleteEmptyGroupsBtn.style.boxShadow = '0 2px 8px rgba(253, 186, 116, 0.35)';
            });

            // åˆ æ‰ç©ºåˆ†ç»„åŠŸèƒ½
            deleteEmptyGroupsBtn.addEventListener('click', () => {
                const emptyGroups = [];
                Object.keys(tagGroups).forEach(groupName => {
                    if (!tagGroups[groupName].tags || tagGroups[groupName].tags.length === 0) {
                        emptyGroups.push(groupName);
                    }
                });

                if (emptyGroups.length === 0) {
                    alert('æ²¡æœ‰æ‰¾åˆ°ç©ºçš„å­åˆ†ç»„');
                    return;
                }

                const confirmMessage = `æ‰¾åˆ° ${emptyGroups.length} ä¸ªç©ºçš„å­åˆ†ç»„ï¼š\n${emptyGroups.join(', ')}\n\nç¡®å®šè¦åˆ é™¤è¿™äº›ç©ºåˆ†ç»„å—ï¼Ÿ`;
                if (confirm(confirmMessage)) {
                    emptyGroups.forEach(groupName => {
                        delete tagGroups[groupName];
                    });

                    // æ›´æ–°å½“å‰ä¸»åˆ†ç»„çš„å­åˆ†ç»„
                    if (mainGroups[currentMainGroup]) {
                        mainGroups[currentMainGroup].subGroups = { ...tagGroups };
                        GM_setValue(savedMainGroupsKey, mainGroups);
                    }

                    GM_setValue(savedGroupsKey, tagGroups);
                    updateGroupSelect();
                    renderGroups();
                    alert(`æˆåŠŸåˆ é™¤ ${emptyGroups.length} ä¸ªç©ºçš„å­åˆ†ç»„`);
                }
            });

            groupManagementContainer.appendChild(addGroupBtn);
            groupManagementContainer.appendChild(batchOpsBtn);
            groupManagementContainer.appendChild(deleteEmptyGroupsBtn);

            // ç§»åŠ¨ç«¯æŒ‰é’®å¸ƒå±€ä¼˜åŒ–ï¼šä¸‰ä¸ªæŒ‰é’®åœ¨ä¸€æ’
            function applyMobileLayout() {
                if (window.innerWidth <= 768) {
                    groupManagementContainer.style.cssText = `
                        margin-bottom: 12px;
                        padding: 8px;
                        background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                        border-radius: 20px;
                        border: 1px solid #E2E8F0;
                        display: flex;
                        flex-wrap: nowrap;
                        gap: 6px;
                        align-items: center;
                        justify-content: space-between;
                    `;

                    // ä¼˜åŒ–æŒ‰é’®æ ·å¼ï¼Œè®©å®ƒä»¬åœ¨ä¸€æ’æ˜¾ç¤º
                    [addGroupBtn, batchOpsBtn, deleteEmptyGroupsBtn].forEach(btn => {
                        btn.style.cssText = `
                            padding: 8px 10px;
                            border: none;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            flex: 1;
                            min-width: 0;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                        `;
                    });

                    // æ¢å¤å„æŒ‰é’®çš„ç‰¹å®šæ ·å¼
                    addGroupBtn.style.background = 'linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D))';
                    addGroupBtn.style.color = 'white';

                    batchOpsBtn.style.background = 'linear-gradient(135deg, #BFDBFE 0%, #93C5FD 100%)';
                    batchOpsBtn.style.color = 'white';

                    deleteEmptyGroupsBtn.style.background = 'linear-gradient(135deg, #FED7AA 0%, #FDBA74 100%)';
                    deleteEmptyGroupsBtn.style.color = 'white';
                } else {
                    // æ¡Œé¢ç«¯æ¢å¤åŸå§‹å¸ƒå±€
                    groupManagementContainer.style.cssText = `
                        margin-bottom: 12px;
                        padding: 8px;
                        background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                        border-radius: 20px;
                        border: 1px solid #E2E8F0;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 8px;
                        align-items: center;
                    `;
                }
            }

            // åˆå§‹åº”ç”¨å¸ƒå±€
            applyMobileLayout();

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', applyMobileLayout);

            // ä¸»åˆ†ç»„ç®¡ç†åŠŸèƒ½
            mainGroupContainer.appendChild(mainGroupTitle);
            mainGroupContainer.appendChild(mainGroupListContainer);


            // æ¸²æŸ“ä¸»åˆ†ç»„åˆ—è¡¨
            function renderMainGroups() {
                mainGroupListContainer.textContent = '';

                Object.keys(mainGroups).forEach(mainGroupName => {
                    const mainGroupData = mainGroups[mainGroupName];
                    const mainGroupElement = createMainGroupElement(mainGroupName, mainGroupData);
                    mainGroupListContainer.appendChild(mainGroupElement);
                });

                // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œåœ¨æœ€åä¸€ä¸ªä¸»åˆ†ç»„æŒ‰é’®ä¹‹åæ·»åŠ "æ–°å»ºä¸»åˆ†ç»„"æŒ‰é’®
                if (isDeleteMode) {
                    const addMainGroupBtnClone = addMainGroupBtn.cloneNode(true);
                    addMainGroupBtnClone.addEventListener('click', () => {
                        const mainGroupName = prompt('è¯·è¾“å…¥ä¸»åˆ†ç»„åç§°:');
                        if (!mainGroupName || !mainGroupName.trim()) return;
                        const trimmedMainGroupName = mainGroupName.trim();

                        // æ£€æŸ¥ä¸»åˆ†ç»„åæ˜¯å¦å·²å­˜åœ¨
                        if (mainGroups[trimmedMainGroupName]) {
                            alert('ä¸»åˆ†ç»„åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                            return;
                        }

                        // åˆ›å»ºæ–°ä¸»åˆ†ç»„
                        mainGroups[trimmedMainGroupName] = {
                            name: trimmedMainGroupName,
                            subGroups: {},
                            sharedSubGroups: true, // é»˜è®¤å…±äº«å­åˆ†ç»„
                            isActive: false
                        };

                        GM_setValue(savedMainGroupsKey, mainGroups);
                        renderMainGroups();
                    });
                    mainGroupListContainer.appendChild(addMainGroupBtnClone);
                }

                // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼æ—¶æ›´æ–°æŒ‰é’®æ˜¾ç¤º
                const allSettingButtons = mainGroupListContainer.querySelectorAll('button');
                allSettingButtons.forEach(btn => {
                    const t = btn.textContent || '';
                    if (t === 'âš™' || t === 'Ã—') {
                        btn.style.display = isDeleteMode ? 'inline-block' : 'none';
                    }
                });
            }

            // åˆ›å»ºä¸»åˆ†ç»„å…ƒç´ ï¼ˆæ ·å¼ä¸ç•Œé¢ä¸€è‡´ï¼šæœªé€‰ä¸­ä½¿ç”¨ç•Œé¢æ ‡å‡†é…è‰²ï¼Œé€‰ä¸­ä½¿ç”¨primarycoloræ¸å˜ï¼‰
            function createMainGroupElement(mainGroupName, mainGroupData) {
                const mainGroupElement = document.createElement('div');
                mainGroupElement.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    padding: 6px 12px;
                    background: ${mainGroupData.isActive ?
                    (isDeleteMode ?
                     'linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%)' : // ç¼–è¾‘æ¨¡å¼ä¸‹é€‰ä¸­çŠ¶æ€ï¼šè“è‰²æ¸å˜
                     'linear-gradient(135deg, var(--primarycolor) 0%, var(--primarycolor-light) 100%)') :
                (isDeleteMode ?
                 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)' : // ç¼–è¾‘æ¨¡å¼ä¸‹æœªé€‰ä¸­çŠ¶æ€ï¼šç™½è‰²æ¸å˜
                 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)')};
                    color: ${mainGroupData.isActive ?
                    (isDeleteMode ? '#1E40AF' : 'var(--text-light)') : // ç¼–è¾‘æ¨¡å¼ä¸‹é€‰ä¸­çŠ¶æ€ï¼šæ·±è“è‰²æ–‡å­—
                (isDeleteMode ? '#4B5563' : '#4B5563')}; // ç¼–è¾‘æ¨¡å¼ä¸‹æœªé€‰ä¸­çŠ¶æ€ï¼šæ·±ç°è‰²æ–‡å­—
                    border: 1px solid ${mainGroupData.isActive ?
                    (isDeleteMode ? '#3B82F6' : 'var(--primarycolor)') : // ç¼–è¾‘æ¨¡å¼ä¸‹é€‰ä¸­çŠ¶æ€ï¼šè“è‰²è¾¹æ¡†
                (isDeleteMode ? '#E5E7EB' : '#E5E7EB')}; // ç¼–è¾‘æ¨¡å¼ä¸‹æœªé€‰ä¸­çŠ¶æ€ï¼šæµ…ç°è‰²è¾¹æ¡†
                    border-radius: 20px;
                    -webkit-border-radius: 20px;
                    -moz-border-radius: 20px;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    cursor: pointer;
                    position: relative;
                    overflow: hidden;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                `;

                // ä¸»åˆ†ç»„åç§°
                const mainGroupNameSpan = document.createElement('span');
                mainGroupNameSpan.textContent = mainGroupName;
                mainGroupNameSpan.style.cssText = `
                    font-weight: 500;
                    font-size: 12px;
                `;

                // è®¾ç½®æŒ‰é’®
                const settingsBtn = document.createElement('button');
                settingsBtn.textContent = 'âš™';
                settingsBtn.style.cssText = `
                    padding: 3px 5px;
                    background: transparent;
                    color: inherit;
                    border: 1px solid transparent;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 11px;
                    transition: var(--transition);
                    display: ${isDeleteMode ? 'inline-block' : 'none'};
                `;

                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Ã—';
                deleteBtn.style.cssText = `
                    padding: 3px 5px;
                    background: transparent;
                    color: inherit;
                    border: 1px solid transparent;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 11px;
                    transition: var(--transition);
                    display: ${isDeleteMode ? 'inline-block' : 'none'};
                `;

                // å…‰æ³½è¦†ç›–å±‚ï¼ˆæ‚¬åœä¸é€‰ä¸­æ—¶æ˜¾ç°ï¼Œä¿æŒä¸å­æ ‡ç­¾ä¸€è‡´ï¼‰
                const gloss = document.createElement('div');
                gloss.style.cssText = `
                    position: absolute; inset: 0; pointer-events: none; opacity: 0; transition: opacity .25s ease; border-radius: 20px;
                    background: linear-gradient(135deg, rgba(255,255,255,.28), rgba(255,255,255,.12));
                `;
                mainGroupElement.appendChild(gloss);

                if (mainGroupData.isActive) gloss.style.opacity = '1';

                // æ·»åŠ æ‚¬åœæ•ˆæœ
                mainGroupElement.addEventListener('mouseenter', () => {
                    gloss.style.opacity = '1';
                    if (!mainGroupData.isActive) {
                        mainGroupElement.style.background = 'linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%)';
                        mainGroupElement.style.borderColor = '#93C5FD';
                        mainGroupElement.style.color = '#1E40AF';
                        mainGroupElement.style.transform = 'translateY(-2px)';
                        mainGroupElement.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
                    }
                });

                mainGroupElement.addEventListener('mouseleave', () => {
                    if (!mainGroupData.isActive) {
                        gloss.style.opacity = '0';
                        mainGroupElement.style.background = 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)';
                        mainGroupElement.style.borderColor = '#E5E7EB';
                        mainGroupElement.style.color = '#4B5563';
                        mainGroupElement.style.transform = 'translateY(0)';
                        mainGroupElement.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                    }
                });

                mainGroupElement.appendChild(mainGroupNameSpan);
                mainGroupElement.appendChild(settingsBtn);
                mainGroupElement.appendChild(deleteBtn);

                // ä¸»åˆ†ç»„ç‚¹å‡»äº‹ä»¶
                mainGroupElement.addEventListener('click', (e) => {
                    if (e.target === settingsBtn || e.target === deleteBtn) return;

                    // åˆ‡æ¢ä¸»åˆ†ç»„
                    Object.keys(mainGroups).forEach(key => {
                        mainGroups[key].isActive = false;
                    });
                    mainGroups[mainGroupName].isActive = true;
                    currentMainGroup = mainGroupName;

                    GM_setValue(savedMainGroupsKey, mainGroups);
                    GM_setValue(currentMainGroupKey, currentMainGroup);

                    // æ›´æ–°tagGroupsä¸ºå½“å‰ä¸»åˆ†ç»„çš„å­åˆ†ç»„
                    tagGroups = { ...mainGroups[mainGroupName].subGroups };
                    GM_setValue(savedGroupsKey, tagGroups);

                    renderMainGroups();
                    renderGroups();
                    updateGroupSelect(); // æ›´æ–°åˆ†ç»„é€‰æ‹©å™¨é€‰é¡¹
                });

                // è®¾ç½®æŒ‰é’®äº‹ä»¶ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹å¯è§ï¼‰
                settingsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showMainGroupSettingsDialog(mainGroupName, mainGroupData);
                });

                // åˆ é™¤æŒ‰é’®äº‹ä»¶ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹å¯è§ï¼‰
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`ç¡®å®šè¦åˆ é™¤ä¸»åˆ†ç»„"${mainGroupName}"å—ï¼Ÿè¿™å°†åˆ é™¤è¯¥ä¸»åˆ†ç»„ä¸‹çš„æ‰€æœ‰å­åˆ†ç»„å’Œæ ‡ç­¾ã€‚`)) {
                        delete mainGroups[mainGroupName];
                        GM_setValue(savedMainGroupsKey, mainGroups);

                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¸»åˆ†ç»„ï¼Œåˆ‡æ¢åˆ°é»˜è®¤ä¸»åˆ†ç»„
                        if (currentMainGroup === mainGroupName) {
                            currentMainGroup = 'é»˜è®¤ä¸»åˆ†ç»„';
                            GM_setValue(currentMainGroupKey, currentMainGroup);
                            tagGroups = { ...mainGroups[currentMainGroup].subGroups };
                            GM_setValue(savedGroupsKey, tagGroups);
                        }

                        renderMainGroups();
                        renderGroups();
                    }
                });

                return mainGroupElement;
            }

            // ä¸»åˆ†ç»„è®¾ç½®å¯¹è¯æ¡†
            function showMainGroupSettingsDialog(mainGroupName, mainGroupData) {
                const settingsDialog = document.createElement('div');
                settingsDialog.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: -webkit-fill-available;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10001;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                const settingsContent = document.createElement('div');
                settingsContent.style.cssText = `
                    background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                    border-radius: 20px;
                    padding: 16px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    border: 1px solid #E2E8F0;
                `;

                const settingsTitle = document.createElement('h3');
                settingsTitle.textContent = `ä¸»åˆ†ç»„è®¾ç½®: ${mainGroupName}`;
                settingsTitle.style.cssText = `
                    margin: 0 0 16px 0;
                    font-size: 16px;
                    font-weight: 600;
                    color: #1F2937;
                `;

                // é‡å‘½åè¾“å…¥æ¡†
                const renameLabel = document.createElement('label');
                renameLabel.textContent = 'é‡å‘½åä¸»åˆ†ç»„:';
                renameLabel.style.cssText = `
                    display: block;
                    margin-bottom: 8px;
                    font-weight: 500;
                    color: #374151;
                `;

                const renameInput = document.createElement('input');
                renameInput.type = 'text';
                renameInput.value = mainGroupName;
                renameInput.style.cssText = `
                    width: -webkit-fill-available;
                    padding: 6px 10px;
                    border: 1px solid #E2E8F0;
                    border-radius: 6px;
                    font-size: 13px;
                    margin-bottom: 12px;
                    box-sizing: border-box;
                `;

                // å­åˆ†ç»„å…±äº«è®¾ç½®
                const sharedLabel = document.createElement('label');
                sharedLabel.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    margin-bottom: 16px;
                    cursor: pointer;
                `;

                const sharedCheckbox = document.createElement('input');
                sharedCheckbox.type = 'checkbox';
                sharedCheckbox.checked = mainGroupData.sharedSubGroups;
                sharedCheckbox.style.cssText = `
                    width: 18px;
                    height: 18px;
                    border-radius: 50%;
                    background: linear-gradient(135deg, var(--primarycolor-light, #FF8FAB), var(--primarycolor, #FF6B9D));
                    border: 2px solid var(--primarycolor, #FF6B9D);
                    box-shadow: inset 0 0 0 2px rgba(255,255,255,.9), 0 4px 10px var(--primarycolor-lighter);
                    appearance: none;
                    cursor: pointer;
                    transition: all 0.2s ease;
                `;

                // æ·»åŠ å‹¾é€‰çŠ¶æ€æ ·å¼
                sharedCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        this.style.background = 'linear-gradient(135deg, var(--primarycolor-light, #FF8FAB), var(--primarycolor, #FF6B9D))';
                        this.style.boxShadow = 'inset 0 0 0 2px rgba(255,255,255,.9), 0 4px 10px var(--primarycolor-light)';
                    } else {
                        this.style.background = 'white';
                        this.style.boxShadow = 'inset 0 0 0 2px rgba(255,255,255,.9), 0 2px 4px rgba(0,0,0,0.1)';
                    }
                });

                const sharedText = document.createElement('span');
                sharedText.textContent = 'ä¸å…¶ä»–ä¸»åˆ†ç»„å…±äº«å­åˆ†ç»„';
                sharedText.style.cssText = `
                    font-size: 13px;
                    color: #374151;
                `;

                sharedLabel.appendChild(sharedCheckbox);
                sharedLabel.appendChild(sharedText);

                // æŒ‰é’®å®¹å™¨
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 8px;
                    justify-content: flex-end;
                `;

                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'ä¿å­˜';
                saveBtn.style.cssText = `
                    padding: 6px 12px;
                    background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 12px;
                `;

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'å–æ¶ˆ';
                cancelBtn.style.cssText = `
                    padding: 6px 12px;
                    background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                    color: #374151;
                    border: 1px solid #E2E8F0;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 12px;
                `;

                buttonContainer.appendChild(cancelBtn);
                buttonContainer.appendChild(saveBtn);

                settingsContent.appendChild(settingsTitle);
                settingsContent.appendChild(renameLabel);
                settingsContent.appendChild(renameInput);
                settingsContent.appendChild(sharedLabel);
                settingsContent.appendChild(buttonContainer);

                settingsDialog.appendChild(settingsContent);
                document.body.appendChild(settingsDialog);

                // ä¿å­˜æŒ‰é’®äº‹ä»¶
                saveBtn.addEventListener('click', () => {
                    const newName = renameInput.value.trim();
                    if (!newName) {
                        alert('ä¸»åˆ†ç»„åç§°ä¸èƒ½ä¸ºç©º');
                        return;
                    }

                    if (newName !== mainGroupName && mainGroups[newName]) {
                        alert('ä¸»åˆ†ç»„åç§°å·²å­˜åœ¨');
                        return;
                    }

                    // æ›´æ–°ä¸»åˆ†ç»„æ•°æ®
                    if (newName !== mainGroupName) {
                        mainGroups[newName] = { ...mainGroups[mainGroupName] };
                        mainGroups[newName].name = newName;
                        delete mainGroups[mainGroupName];

                        if (currentMainGroup === mainGroupName) {
                            currentMainGroup = newName;
                            GM_setValue(currentMainGroupKey, currentMainGroup);
                        }
                    }

                    mainGroups[newName].sharedSubGroups = sharedCheckbox.checked;
                    GM_setValue(savedMainGroupsKey, mainGroups);

                    document.body.removeChild(settingsDialog);
                    renderMainGroups();
                });

                // å–æ¶ˆæŒ‰é’®äº‹ä»¶
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(settingsDialog);
                });

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                settingsDialog.addEventListener('click', (e) => {
                    if (e.target === settingsDialog) {
                        document.body.removeChild(settingsDialog);
                    }
                });
            }


            // å·¥å…·å‡½æ•°ï¼šåˆ›å»ºåˆ†ç»„
            function createGroupElement(groupName, groupData) {
                const groupElement = document.createElement('div');
                groupElement.style.cssText = `
                    margin-bottom: 12px;
                    border: 1px solid #E2E8F0;
                    border-radius: 20px;
                    background: white;
                    overflow: hidden;
                `;

                // åˆ†ç»„å¤´éƒ¨
                const groupHeader = document.createElement('div');
                groupHeader.style.cssText = `
                    padding: 8px 12px;
                    background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                    border-bottom: 1px solid #E2E8F0;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                transition: all 0.2s ease;
                `;

                // åˆ†ç»„ä¿¡æ¯å®¹å™¨
                const groupInfo = document.createElement('div');
                groupInfo.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    flex: 1;
                `;

                // æŠ˜å /å±•å¼€å›¾æ ‡
                const collapseIcon = document.createElement('span');
                collapseIcon.textContent = groupData.collapsed ? 'â–¶' : 'â–¼';
                collapseIcon.style.cssText = `
                    font-size: 10px;
                    color: #6B7280;
                transition: transform 0.2s ease;
                `;

                // åˆ†ç»„åç§°
                const groupNameSpan = document.createElement('span');
                groupNameSpan.textContent = groupName;
                groupNameSpan.style.cssText = `
                    font-weight: 600;
                    color: #1F2937;
                    font-size: 13px;
                `;

                // Notionå±æ€§å­—æ®µ
                const notionPropertySpan = document.createElement('span');
                notionPropertySpan.textContent = ` ${groupData.notionProperty}`;
                notionPropertySpan.style.cssText = `
                    font-size: 10px;
                    color: #6B7280;
                    background: #F3F4F6;
                    padding: 2px 6px;
                    border-radius: 20px;
                `;

                groupInfo.appendChild(collapseIcon);
                groupInfo.appendChild(groupNameSpan);
                groupInfo.appendChild(notionPropertySpan);

                // åˆ†ç»„æ“ä½œæŒ‰é’®ï¼ˆç¼–è¾‘æ¨¡å¼æ—¶æ˜¾ç¤ºï¼‰
                const groupActions = document.createElement('div');
                groupActions.style.cssText = `
                    display: flex;
                    gap: 4px;
                    ${isDeleteMode ? '' : 'display:none;'}
                `;

                // ç¼–è¾‘åˆ†ç»„æŒ‰é’®
                const editGroupBtn = document.createElement('button');
                editGroupBtn.textContent = 'â€¢ ç¼–è¾‘';
                editGroupBtn.style.cssText = `
                    padding: 3px 6px;
                    border: 1px solid #D1D5DB;
                    background: #F9FAFB;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 10px;
                    color: #6B7280;
                    transition: all 0.2s ease;
                `;

                // æ¸…ç©ºæ ‡ç­¾æŒ‰é’®
                const clearTagsBtn = document.createElement('button');
                clearTagsBtn.textContent = 'ğŸ—‘ æ¸…ç©º';
                clearTagsBtn.style.cssText = `
                    padding: 3px 6px;
                    border: 1px solid var(--primarycolor-dark);
                    background: white;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 10px;
                    color: var(--primarycolor);
                    transition: all 0.2s ease;
                `;

                // åˆ é™¤åˆ†ç»„æŒ‰é’®
                const deleteGroupBtn = document.createElement('button');
                deleteGroupBtn.textContent = 'Ã— åˆ é™¤';
                deleteGroupBtn.style.cssText = `
                    padding: 3px 6px;
                    border: none;
                    background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 10px;
                    color: white;
                    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                    box-shadow: 0 1px 3px var(--primarycolor-lighter);
                `;

                groupActions.appendChild(editGroupBtn);
                groupActions.appendChild(clearTagsBtn);
                groupActions.appendChild(deleteGroupBtn);
                groupHeader.appendChild(groupInfo);
                groupHeader.appendChild(groupActions);

                // æ ‡ç­¾å®¹å™¨
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'tags-container';
                tagsContainer.style.cssText = `
                    padding: 8px;
                    display: ${groupData.collapsed ? 'none' : 'grid'};
                    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                    gap: 6px;
                `;

                // æŠ˜å /å±•å¼€åŠŸèƒ½
                groupHeader.addEventListener('click', (e) => {
                    if (e.target === editGroupBtn || e.target === deleteGroupBtn || isDeleteMode) return;

                    groupData.collapsed = !groupData.collapsed;
                    collapseIcon.textContent = groupData.collapsed ? 'â–¶' : 'â–¼';
                    tagsContainer.style.display = groupData.collapsed ? 'none' : 'grid';

                    // ä¿å­˜çŠ¶æ€
                    GM_setValue(savedGroupsKey, tagGroups);
                });

                // ç¼–è¾‘åˆ†ç»„åŠŸèƒ½ï¼ˆç¼–è¾‘æ¨¡å¼å…¥å£ï¼‰
                editGroupBtn.addEventListener('click', (e) => {
                    e.stopPropagation();

                    // åˆ›å»ºç¼–è¾‘åˆ†ç»„å¯¹è¯æ¡†
                    const editGroupDialog = document.createElement('div');
                    editGroupDialog.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: -webkit-fill-available;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                    `;

                    const editGroupContent = document.createElement('div');
                    editGroupContent.id = 'edit-group-dialog';
                    editGroupContent.style.cssText = `
                        background: white;
                        border-radius: 20px;
                        padding: 24px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    `;

                    setSafeHtml(editGroupContent, `
                        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: #1F2937;">ç¼–è¾‘åˆ†ç»„</h3>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">åˆ†ç»„åç§°:</label>
                            <input type="text" id="edit-group-name" value="${groupName}" class="nc-input" style="width: -webkit-fill-available; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 20px; background: #FFFFFF; color: #111827; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">Notionå±æ€§å:</label>
                            <input type="text" id="edit-group-property" value="${groupData.notionProperty}" class="nc-input" style="width: -webkit-fill-available; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 20px; background: #FFFFFF; color: #111827; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; color: #374151;">é»˜è®¤æ ‡ç­¾é¢œè‰²:</label>
                            <select id="edit-group-default-color" class="nc-input" style="width: -webkit-fill-available; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 20px; background: #FFFFFF; color: #111827; font-size: 14px;">
                                ${AVAILABLE_COLORS.map(color => `<option value="${color.name}" ${color.name === (groupData.defaultColor || 'pink') ? 'selected' : ''}>${color.label}</option>`).join('')}
                            </select>
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                            <button id="cancel-edit-group" class="dialog-btn-secondary" style="padding: 10px 20px; border-radius: 20px; font-weight: 500;">å–æ¶ˆ</button>
                            <button id="confirm-edit-group" class="dialog-btn-primarycolor" style="padding: 10px 20px; border-radius: 20px; font-weight: 500;">ä¿å­˜</button>
                        </div>
                    `);

                    editGroupDialog.appendChild(editGroupContent);
                    document.body.appendChild(editGroupDialog);

                    // äº‹ä»¶ç›‘å¬
                    const cancelEditBtn = editGroupContent.querySelector('#cancel-edit-group');
                    const confirmEditBtn = editGroupContent.querySelector('#confirm-edit-group');
                    const nameInput = editGroupContent.querySelector('#edit-group-name');
                    const propertyInput = editGroupContent.querySelector('#edit-group-property');

                    // è‡ªåŠ¨å¡«å……å±æ€§å
                    nameInput.addEventListener('input', () => {
                        if (!propertyInput.value) {
                            propertyInput.value = nameInput.value;
                        }
                    });

                    cancelEditBtn.addEventListener('click', () => {
                        document.body.removeChild(editGroupDialog);
                    });

                    confirmEditBtn.addEventListener('click', () => {
                        const newGroupName = nameInput.value.trim();
                        const newPropertyName = propertyInput.value.trim();
                        const newDefaultColor = editGroupContent.querySelector('#edit-group-default-color').value;

                        if (!newGroupName) {
                            alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                            return;
                        }

                        if (!newPropertyName) {
                            alert('è¯·è¾“å…¥Notionå±æ€§å');
                            return;
                        }

                        // å¦‚æœåˆ†ç»„åæ”¹å˜ï¼Œæ£€æŸ¥æ–°åç§°æ˜¯å¦å·²å­˜åœ¨
                        if (newGroupName !== groupName && tagGroups[newGroupName]) {
                            alert('åˆ†ç»„åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°');
                            return;
                        }

                        // æ›´æ–°åˆ†ç»„ä¿¡æ¯
                        const updatedGroupData = {
                            notionProperty: newPropertyName,
                            tags: groupData.tags,
                            collapsed: groupData.collapsed,
                            defaultColor: newDefaultColor
                        };

                        // å¦‚æœåˆ†ç»„åæ”¹å˜ï¼Œåˆ é™¤æ—§åˆ†ç»„
                        if (newGroupName !== groupName) {
                            delete tagGroups[groupName];
                            tagGroups[newGroupName] = updatedGroupData;
                        } else {
                            // åªæ›´æ–°æ•°æ®
                            tagGroups[groupName] = updatedGroupData;
                        }

                        document.body.removeChild(editGroupDialog);

                        // æ›´æ–°å½“å‰ä¸»åˆ†ç»„çš„å­åˆ†ç»„
                        if (mainGroups[currentMainGroup]) {
                            mainGroups[currentMainGroup].subGroups = { ...tagGroups };
                            GM_setValue(savedMainGroupsKey, mainGroups);
                        }

                        GM_setValue(savedGroupsKey, tagGroups);
                        renderGroups();
                    });
                });

                // æ¸…ç©ºæ ‡ç­¾åŠŸèƒ½
                clearTagsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`ç¡®å®šè¦æ¸…ç©ºåˆ†ç»„"${groupName}"ä¸‹çš„æ‰€æœ‰æ ‡ç­¾å—ï¼Ÿ`)) {
                        tagGroups[groupName].tags = [];

                        // æ›´æ–°å½“å‰ä¸»åˆ†ç»„çš„å­åˆ†ç»„
                        if (mainGroups[currentMainGroup]) {
                            mainGroups[currentMainGroup].subGroups = { ...tagGroups };
                            GM_setValue(savedMainGroupsKey, mainGroups);
                        }

                        GM_setValue(savedGroupsKey, tagGroups);
                        renderGroups();
                    }
                });

                // åˆ é™¤åˆ†ç»„åŠŸèƒ½
                deleteGroupBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç»„"${groupName}"å—ï¼Ÿè¿™å°†åˆ é™¤è¯¥åˆ†ç»„ä¸‹çš„æ‰€æœ‰æ ‡ç­¾ã€‚`)) {
                        delete tagGroups[groupName];

                        // æ›´æ–°å½“å‰ä¸»åˆ†ç»„çš„å­åˆ†ç»„
                        if (mainGroups[currentMainGroup]) {
                            mainGroups[currentMainGroup].subGroups = { ...tagGroups };
                            GM_setValue(savedMainGroupsKey, mainGroups);
                        }

                        GM_setValue(savedGroupsKey, tagGroups);
                        renderGroups();
                    }
                });

                groupElement.appendChild(groupHeader);
                groupElement.appendChild(tagsContainer);

                // æ·»åŠ æ•°æ®å±æ€§ç”¨äºæ»šåŠ¨å®šä½
                groupElement.setAttribute('data-group', groupName);

                return { groupElement, tagsContainer };
            }

            // å·¥å…·å‡½æ•°ï¼šåˆ›å»ºç¾è§‚çš„æ ‡ç­¾æŒ‰é’®
            function createTagButton(tagObj, showDelete = false, groupName = '') {
                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';

                const tagName = typeof tagObj === 'string' ? tagObj : tagObj.name;
                const tagColor = typeof tagObj === 'string' ? 'pink' : (tagObj.color || 'pink');

                // ä¸»æŒ‰é’®å®¹å™¨ - é•¿æ¡å½¢æ ‡ç­¾è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    padding: 8px 12px;
                    border: 1px solid #E5E7EB;
                    border-radius: 20px;
                    background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    cursor: pointer;
                    position: relative;
                    overflow: hidden;
                    min-height: 36px;
                `;

                // ç§»åŠ¨ç«¯æ–°æ ‡ç­¾é€‚é…
                if (window.innerWidth <= 768) {
                    buttonContainer.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 4px;
                        padding: 6px 10px;
                        border: 1px solid #E5E7EB;
                        border-radius: 20px;
                        background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        cursor: pointer;
                        position: relative;
                        overflow: hidden;
                        min-height: 32px;
                    `;
                }

                // æ·»åŠ æ¸å˜èƒŒæ™¯æ•ˆæœ
                const gradientOverlay = document.createElement('div');
                gradientOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(249,250,251,0.8) 100%);
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    pointer-events: none;
                `;
                buttonContainer.appendChild(gradientOverlay);

                // æ ‡ç­¾åç§°å’Œä½¿ç”¨ç»Ÿè®¡
                const tagTextContainer = document.createElement('div');
                tagTextContainer.style.cssText = `
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                `;

                const tagText = document.createElement('span');
                tagText.textContent = tagName;
                tagText.style.cssText = `
                    font-size: 14px;
                    font-weight: 500;
                    color: #374151;
                    text-align: left;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                `;

                // ä½¿ç”¨ç»Ÿè®¡
                const usageCount = tagUsageStats[`${groupName}:${tagName}`] || 0;
                const usageText = document.createElement('span');
                usageText.textContent = usageCount > 0 ? `ä½¿ç”¨ ${usageCount} æ¬¡` : 'æœªä½¿ç”¨';
                usageText.style.cssText = `
                    font-size: 11px;
                    color: #9CA3AF;
                    text-align: left;
                `;

                tagTextContainer.appendChild(tagText);
                tagTextContainer.appendChild(usageText);

                // ç§»åŠ¨ç«¯æ ‡ç­¾æ–‡å­—é€‚é…
                if (window.innerWidth <= 768) {
                    tagText.style.fontSize = '13px';
                }

                buttonContainer.appendChild(tagTextContainer);

                // é¢œè‰²é€‰æ‹©å™¨ï¼ˆç¼–è¾‘æ¨¡å¼å¯è°ƒæ•´é¢œè‰²ï¼‰
                const colorPicker = document.createElement('select');
                colorPicker.style.cssText = `
                    width: 20px;
                    height: 20px;
                    border: none;
                    border-radius: 50%;
                    cursor: pointer;
                    background: ${AVAILABLE_COLORS.find(c => c.name === tagColor)?.color || '#FCE7F3'};
                    appearance: none;
                    -webkit-appearance: none;
                    -moz-appearance: none;
                    outline: none;
                    position: relative;
                    flex-shrink: 0;
                `;

                // ç§»åŠ¨ç«¯é¢œè‰²é€‰æ‹©å™¨é€‚é…
                if (window.innerWidth <= 768) {
                    colorPicker.style.cssText = `
                        width: 18px;
                        height: 18px;
                        border: none;
                        border-radius: 50%;
                        cursor: pointer;
                        background: ${AVAILABLE_COLORS.find(c => c.name === tagColor)?.color || '#FCE7F3'};
                        appearance: none;
                        -webkit-appearance: none;
                        -moz-appearance: none;
                        outline: none;
                        position: relative;
                        flex-shrink: 0;
                    `;
                }

                // æ·»åŠ é¢œè‰²é€‰é¡¹ï¼ˆä¸æ˜¾ç¤ºæ–‡å­—ï¼Œåªæ˜¾ç¤ºé¢œè‰²ï¼‰
                AVAILABLE_COLORS.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color.name;
                    option.textContent = ''; // ä¸æ˜¾ç¤ºæ–‡å­—
                    option.style.backgroundColor = color.color;
                    colorPicker.appendChild(option);
                });

                colorPicker.value = tagColor;
                colorPicker.style.display = 'inline-block'; // å§‹ç»ˆæ˜¾ç¤ºé¢œè‰²é€‰æ‹©å™¨
                buttonContainer.appendChild(colorPicker);

                // åˆ é™¤æŒ‰é’®ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
                if (showDelete || isDeleteMode) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Ã—';
                    deleteBtn.style.cssText = `
                        width: 20px;
                        height: 20px;
                        border: none;
                        border-radius: 50%;
                        background: #FEE2E2;
                        color: #DC2626;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin-left: 4px;
                        flex-shrink: 0;
                        transition: all 0.2s ease;
                    `;

                    // ç§»åŠ¨ç«¯åˆ é™¤æŒ‰é’®é€‚é…
                    if (window.innerWidth <= 768) {
                        deleteBtn.style.cssText = `
                            width: 18px;
                            height: 18px;
                            border: none;
                            border-radius: 50%;
                            background: #FEE2E2;
                            color: #DC2626;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-left: 4px;
                            flex-shrink: 0;
                            transition: all 0.2s ease;
                        `;
                    }

                    deleteBtn.addEventListener('mouseenter', () => {
                        deleteBtn.style.background = '#FECACA';
                        deleteBtn.style.transform = 'scale(1.1)';
                    });

                    deleteBtn.addEventListener('mouseleave', () => {
                        deleteBtn.style.background = '#FEE2E2';
                        deleteBtn.style.transform = 'scale(1)';
                    });

                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (groupName && tagGroups[groupName]) {
                            const index = tagGroups[groupName].tags.findIndex(t =>
                                                                              (typeof t === 'string' ? t : t.name) === tagName
                                                                             );
                            if (index > -1) {
                                tagGroups[groupName].tags.splice(index, 1);
                                GM_setValue(savedGroupsKey, tagGroups);
                                renderGroups();
                            }
                        }
                    });

                    buttonContainer.appendChild(deleteBtn);
                }

                // é‡å‘½åæŒ‰é’®ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
                if (isDeleteMode) {
                    const renameBtn = document.createElement('button');
                    renameBtn.textContent = 'æ”¹å';
                    renameBtn.style.cssText = `
                        padding: 4px 8px;
                        border: 1px solid rgb(86 147 247);
                        background: white;
                        border-radius: 30px;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 450;
                        color: rgb(86 147 247);
                        margin-left: 8px;
                        transition: all 0.2s ease;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        min-width: 20px;
                    `;
                    // æ·»åŠ æ‚¬åœæ•ˆæœ
                    renameBtn.addEventListener('mouseenter', () => {
                        renameBtn.style.background = 'white';
                        renameBtn.style.borderColor = 'rgb(86 147 255)';
                        renameBtn.style.transform = 'translateY(-1px)';
                        renameBtn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
                    });

                    renameBtn.addEventListener('mouseleave', () => {
                        renameBtn.style.background = 'linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%)';
                        renameBtn.style.borderColor = 'rgb(86 147 247)';
                        renameBtn.style.transform = 'translateY(0)';
                        renameBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    });

                    renameBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const newName = prompt('é‡å‘½åæ ‡ç­¾ï¼š', tagName);
                        if (!newName || !newName.trim() || newName.trim() === tagName) return;
                        const exists = tagGroups[groupName].tags.find(t => (typeof t === 'string' ? t : t.name) === newName.trim());
                        if (exists) { alert('åŒåæ ‡ç­¾å·²å­˜åœ¨'); return; }
                        const idx = tagGroups[groupName].tags.findIndex(t => (typeof t === 'string' ? t : t.name) === tagName);
                        if (idx > -1) {
                            const existing = tagGroups[groupName].tags[idx];
                            const color = typeof existing === 'string' ? 'pink' : (existing.color || 'pink');
                            tagGroups[groupName].tags[idx] = { name: newName.trim(), color };
                            GM_setValue(savedGroupsKey, tagGroups);
                            renderGroups();
                        }
                    });
                    buttonContainer.appendChild(renameBtn);
                }

                // æ‚¬åœæ•ˆæœ
                buttonContainer.addEventListener('mouseenter', () => {
                    gradientOverlay.style.opacity = '1';
                    buttonContainer.style.transform = 'translateY(-1px)';
                    buttonContainer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                });

                buttonContainer.addEventListener('mouseleave', () => {
                    gradientOverlay.style.opacity = '0';
                    buttonContainer.style.transform = 'translateY(0)';
                    buttonContainer.style.boxShadow = 'none';
                });

                // ç‚¹å‡»äº‹ä»¶ - å¤šé€‰åˆ‡æ¢
                buttonContainer.addEventListener('click', (e) => {
                    if (e.target === colorPicker) return; // é¢œè‰²é€‰æ‹©å™¨ç‚¹å‡»ä¸è§¦å‘é€‰æ‹©

                    const selected = buttonContainer.dataset.selected === '1';
                    buttonContainer.dataset.selected = selected ? '0' : '1';

                    if (selected) {
                        buttonContainer.style.background = 'linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%)';
                        buttonContainer.style.borderColor = '#E5E7EB';
                        buttonContainer.style.color = '#374151';
                        buttonContainer.style.boxShadow = 'none';
                    } else {
                        buttonContainer.style.background = 'linear-gradient(135deg, #EBF8FF 0%, #DBEAFE 100%)';
                        buttonContainer.style.borderColor = '#3B82F6';
                        buttonContainer.style.color = '#1E40AF';
                        buttonContainer.style.boxShadow = '0 2px 8px rgba(59, 130, 246, 0.15)';
                    }

                    // æ›´æ–°å·²é€‰é›†åˆ - æ”¯æŒåˆ†ç»„
                    const selectedTypes = JSON.parse(dialog.dataset.selectedTypes || '[]');
                    console.log('æ ‡ç­¾é€‰æ‹© - tagObj:', tagObj, 'groupName:', groupName);
                    // ç¡®ä¿åŒ…å«å®Œæ•´çš„æ ‡ç­¾ä¿¡æ¯ï¼ŒåŒ…æ‹¬é¢œè‰²
                    const tagWithGroup = {
                        ...tagObj,
                        groupName: groupName,
                        color: tagObj.color || 'pink' // ç¡®ä¿é¢œè‰²ä¿¡æ¯å­˜åœ¨
                    };
                    console.log('æ ‡ç­¾é€‰æ‹© - tagWithGroup:', tagWithGroup);

                    if (selected) {
                        const index = selectedTypes.findIndex(t =>
                                                              (typeof t === 'string' ? t : t.name) === tagName && t.groupName === groupName
                                                             );
                        if (index > -1) selectedTypes.splice(index, 1);
                    } else {
                        selectedTypes.push(tagWithGroup);
                    }
                    dialog.dataset.selectedTypes = JSON.stringify(selectedTypes);

                    // è‡ªåŠ¨å±•å¼€åˆ†ç»„å¹¶æ»šåŠ¨åˆ°å¯è§†åŒºåŸŸ
                    if (groupName && tagGroups[groupName] && tagGroups[groupName].collapsed) {
                        tagGroups[groupName].collapsed = false;
                        GM_setValue(savedGroupsKey, tagGroups);
                        renderGroups();
                    }

                    setTimeout(() => {
                        wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                });

                // é¢œè‰²é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
                colorPicker.addEventListener('change', (e) => {
                    const newColor = e.target.value;
                    if (groupName && tagGroups[groupName]) {
                        const index = tagGroups[groupName].tags.findIndex(t =>
                                                                          (typeof t === 'string' ? t : t.name) === tagName
                                                                         );
                        if (index > -1) {
                            if (typeof tagGroups[groupName].tags[index] === 'string') {
                                tagGroups[groupName].tags[index] = { name: tagGroups[groupName].tags[index], color: newColor };
                            } else {
                                tagGroups[groupName].tags[index].color = newColor;
                            }
                            GM_setValue(savedGroupsKey, tagGroups);
                            colorPicker.style.background = AVAILABLE_COLORS.find(c => c.name === newColor)?.color || '#FCE7F3';
                        }
                    }
                });

                wrapper.appendChild(buttonContainer);

                // æ·»åŠ æ•°æ®å±æ€§ç”¨äºæ»šåŠ¨å®šä½
                wrapper.setAttribute('data-tag', tagName);

                return wrapper;
            }

            // æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
            function filterTags() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const selectedColors = Array.from(colorFilterButtons)
                .filter(btn => btn.style.borderColor === 'rgb(107, 114, 128)')
                .map(btn => btn.dataset.color);

                let totalVisibleTags = 0;
                let totalTags = 0;

                Object.keys(tagGroups).forEach(groupName => {
                    const groupData = tagGroups[groupName];
                    const groupElement = groupsContainer.querySelector(`[data-group="${groupName}"]`);
                    const tagsContainer = groupElement?.querySelector('.tags-container');

                    if (!tagsContainer) return;

                    let visibleInGroup = 0;
                    const allTags = Array.from(tagsContainer.children);

                    allTags.forEach(tagElement => {
                        const tagName = tagElement.dataset.tag?.toLowerCase() || '';
                        const tagColor = tagElement.querySelector('select')?.value || 'default';

                        totalTags++;

                        const matchesSearch = !searchTerm || tagName.includes(searchTerm);
                        const matchesColor = selectedColors.length === 0 || selectedColors.includes(tagColor);

                        if (matchesSearch && matchesColor) {
                            tagElement.style.display = 'block';
                            visibleInGroup++;
                            totalVisibleTags++;
                        } else {
                            tagElement.style.display = 'none';
                        }
                    });

                    // å¦‚æœåˆ†ç»„ä¸­æ²¡æœ‰å¯è§æ ‡ç­¾ï¼Œéšè—åˆ†ç»„
                    if (visibleInGroup === 0) {
                        groupElement.style.display = 'none';
                    } else {
                        groupElement.style.display = 'block';
                    }
                });

                // æ›´æ–°æœç´¢ç»“æœç»Ÿè®¡
                searchStats.textContent = `æ˜¾ç¤º ${totalVisibleTags} / ${totalTags} ä¸ªæ ‡ç­¾`;
            }

            // æœç´¢æ¡†äº‹ä»¶
            searchInput.addEventListener('input', filterTags);
            searchInput.addEventListener('focus', () => {
                searchInput.style.borderColor = '#3B82F6';
                searchInput.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
            });
            searchInput.addEventListener('blur', () => {
                searchInput.style.borderColor = '#E2E8F0';
                searchInput.style.boxShadow = 'none';
            });

            // æ¸²æŸ“åˆ†ç»„å‡½æ•°
            function renderGroups() {
                groupsContainer.textContent = '';
                const persistedSelected = JSON.parse(dialog.dataset.selectedTypes || '[]');

                Object.keys(tagGroups).forEach(groupName => {
                    const groupData = tagGroups[groupName];
                    const { groupElement, tagsContainer } = createGroupElement(groupName, groupData);

                    // æ¸²æŸ“è¯¥åˆ†ç»„ä¸‹çš„æ ‡ç­¾
                    groupData.tags.forEach(tagObj => {
                        const buttonElement = createTagButton(tagObj, isDeleteMode, groupName);
                        const tagName = typeof tagObj === 'string' ? tagObj : tagObj.name;

                        // æ¢å¤é€‰ä¸­æ ·å¼ - ä½¿ç”¨æ›´ç¾è§‚çš„è“è‰²ä¸»é¢˜
                        const found = persistedSelected.find(x =>
                                                             (typeof x === 'string' ? x : x.name) === tagName && x.groupName === groupName
                                                            );
                        if (found) {
                            const btn = buttonElement.firstChild;
                            if (btn) {
                                btn.dataset.selected = '1';
                                btn.style.background = 'linear-gradient(135deg, #EBF8FF 0%, #DBEAFE 100%)';
                                btn.style.borderColor = '#3B82F6';
                                btn.style.color = '#1E40AF';
                                btn.style.boxShadow = '0 2px 8px rgba(59, 130, 246, 0.15)';
                            }
                        }

                        tagsContainer.appendChild(buttonElement);
                    });

                    groupsContainer.appendChild(groupElement);
                });

                // åº”ç”¨å½“å‰è¿‡æ»¤æ¡ä»¶
                filterTags();
            }

            // æ¸²æŸ“åˆå§‹åˆ†ç»„
            let isDeleteMode = false; // å…¼å®¹å˜é‡åï¼Œè¯­ä¹‰ä¸ºç¼–è¾‘æ¨¡å¼
            renderGroups();

            // è‡ªå®šä¹‰è¾“å…¥æ¡† - æ›´ç¾è§‚çš„è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const customInputContainer = document.createElement('div');
            customInputContainer.style.cssText = `
                margin-bottom: 16px;
                padding: 12px;
                background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                border-radius: 20px;
                border: 1px solid #E2E8F0;
            `;

            // ç§»åŠ¨ç«¯è‡ªå®šä¹‰è¾“å…¥å®¹å™¨é€‚é…
            if (window.innerWidth <= 768) {
                customInputContainer.style.cssText = `
                    margin-bottom: 16px;
                    padding: 16px;
                    background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                    border-radius: 20px;
                    border: 1px solid #E2E8F0;
                `;
            }

            const customLabel = document.createElement('label');
            customLabel.textContent = 'æ·»åŠ æ–°æ ‡ç­¾åˆ°åˆ†ç»„';
            customLabel.style.cssText = `
                display: block;
                margin-bottom: 12px;
                font-size: 16px;
                font-weight: 600;
                color: #1F2937;
            `;

            // ç§»åŠ¨ç«¯è‡ªå®šä¹‰æ ‡ç­¾é€‚é…
            if (window.innerWidth <= 768) {
                customLabel.style.fontSize = '14px';
                customLabel.style.marginBottom = '8px';
            }

            // åˆ†ç»„é€‰æ‹©å™¨
            const groupSelect = document.createElement('select');
            groupSelect.style.cssText = `
                width: -webkit-fill-available;
                padding: 12px 16px;
                border: 2px solid #E2E8F0;
                border-radius: 20px;
                font-size: 15px;
                background: white;
                cursor: pointer;
                transition: all 0.2s ease;
                margin-bottom: 12px;
            `;

            // æ›´æ–°åˆ†ç»„é€‰æ‹©å™¨é€‰é¡¹
            function updateGroupSelect() {
                groupSelect.textContent = '';
                Object.keys(tagGroups).forEach(groupName => {
                    const option = document.createElement('option');
                    option.value = groupName;
                    option.textContent = `${tagGroups[groupName].notionProperty}`;
                    groupSelect.appendChild(option);
                });
            }
            updateGroupSelect();

            // ç›‘å¬åˆ†ç»„é€‰æ‹©å˜åŒ–ï¼Œæ›´æ–°é¢œè‰²é€‰æ‹©å™¨ä¸ºåˆ†ç»„çš„é»˜è®¤é¢œè‰²
            groupSelect.addEventListener('change', () => {
                const selectedGroup = groupSelect.value;
                if (selectedGroup && tagGroups[selectedGroup] && tagGroups[selectedGroup].defaultColor) {
                    colorSelect.value = tagGroups[selectedGroup].defaultColor;
                }
            });

            // è¾“å…¥æ¡†å’Œé¢œè‰²é€‰æ‹©å™¨å®¹å™¨ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const inputRow = document.createElement('div');
            inputRow.style.cssText = `
                display: flex;
                gap: 12px;
                margin-bottom: 12px;
            `;

            // ç§»åŠ¨ç«¯è¾“å…¥è¡Œé€‚é…
            if (window.innerWidth <= 768) {
                inputRow.style.cssText = `
                    display: flex;
                    gap: 8px;
                    margin-bottom: 8px;
                `;
            }

            const customInput = document.createElement('input');
            customInput.type = 'text';
            customInput.placeholder = 'è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾åç§°';
            customInput.style.cssText = `
                flex: 1;
                padding: 12px 16px;
                border: 2px solid #E2E8F0;
                border-radius: 20px;
                font-size: 15px;
                box-sizing: border-box;
                background: white;
                transition: all 0.2s ease;
                font-weight: 500;
            `;

            // ç§»åŠ¨ç«¯è‡ªå®šä¹‰è¾“å…¥æ¡†é€‚é…
            if (window.innerWidth <= 768) {
                customInput.style.cssText = `
                    flex: 1;
                    padding: 10px 12px;
                    border: 2px solid #E2E8F0;
                    border-radius: 20px;
                    font-size: 14px;
                    box-sizing: border-box;
                    background: white;
                    transition: all 0.2s ease;
                    font-weight: 500;
                `;
            }

            // è¾“å…¥æ¡†èšç„¦æ•ˆæœ
            customInput.addEventListener('focus', () => {
                customInput.style.borderColor = '#FF6B9D';
                customInput.style.boxShadow = '0 0 0 3px var(--primarycolor-lighter)';
            });

            customInput.addEventListener('blur', () => {
                customInput.style.borderColor = '#E2E8F0';
                customInput.style.boxShadow = 'none';
            });

            // é¢œè‰²é€‰æ‹©å™¨
            const colorSelect = document.createElement('select');
            colorSelect.style.cssText = `
                padding: 12px 16px;
                border: 2px solid #E2E8F0;
                border-radius: 20px;
                font-size: 15px;
                background: white;
                cursor: pointer;
                transition: all 0.2s ease;
                min-width: 120px;
            `;

            // ç§»åŠ¨ç«¯é¢œè‰²é€‰æ‹©å™¨é€‚é…
            if (window.innerWidth <= 768) {
                colorSelect.style.cssText = `
                    padding: 10px 12px;
                    border: 2px solid #E2E8F0;
                    border-radius: 20px;
                    font-size: 14px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    min-width: 100px;
                `;
            }

            // æ·»åŠ é¢œè‰²é€‰é¡¹
            AVAILABLE_COLORS.forEach(color => {
                const option = document.createElement('option');
                option.value = color.name;
                option.textContent = color.label;
                option.style.backgroundColor = color.color;
                colorSelect.appendChild(option);
            });

            colorSelect.value = 'pink';

            // é¢œè‰²é€‰æ‹©å™¨èšç„¦æ•ˆæœ
            colorSelect.addEventListener('focus', () => {
                colorSelect.style.borderColor = '#FF6B9D';
                colorSelect.style.boxShadow = '0 0 0 3px var(--primarycolor-lighter)';
            });

            colorSelect.addEventListener('blur', () => {
                colorSelect.style.borderColor = '#E2E8F0';
                colorSelect.style.boxShadow = 'none';
            });

            inputRow.appendChild(customInput);
            inputRow.appendChild(colorSelect);

            // æ·»åŠ æŒ‰é’®
            const addButton = document.createElement('button');
            addButton.textContent = 'æ·»åŠ ';
            addButton.style.cssText = `
                width: -webkit-fill-available;
                padding: 12px 16px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                border: none;
                border-radius: 20px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px var(--primarycolor-lighter);
            `;

            // ç§»åŠ¨ç«¯æ·»åŠ æŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                addButton.style.cssText = `
                    width: -webkit-fill-available;
                    padding: 10px 12px;
                    background: linear-gradient(135deg, #FF6B9D 0%, #FF8FAB 100%);
                    color: white;
                    border: none;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px var(--primarycolor-lighter);
                `;
            }

            // æ·»åŠ æŒ‰é’®æ‚¬åœæ•ˆæœ
            addButton.addEventListener('mouseenter', () => {
                addButton.style.transform = 'translateY(-2px)';
                addButton.style.boxShadow = '0 6px 16px var(--primarycolor-lighter)';
            });

            addButton.addEventListener('mouseleave', () => {
                addButton.style.transform = 'translateY(0)';
                addButton.style.boxShadow = '0 4px 12px var(--primarycolor-lighter)';
            });

            addButton.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const tagName = customInput.value.trim();
                if (!tagName) return;

                const selectedGroup = groupSelect.value;
                if (!selectedGroup || !tagGroups[selectedGroup]) return;

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existsIndex = tagGroups[selectedGroup].tags.findIndex(t =>
                                                                            (typeof t === 'string' ? t : t.name) === tagName
                                                                           );

                if (existsIndex > -1) {
                    // å·²å­˜åœ¨ï¼šè‡ªåŠ¨é€‰ä¸­å¹¶æ»šåŠ¨åˆ°è¯¥æ ‡ç­¾
                    const persistedSelected = JSON.parse(dialog.dataset.selectedTypes || '[]');
                    const tagWithGroup = {
                        name: tagName,
                        color: tagGroups[selectedGroup].tags[existsIndex].color || 'pink',
                        groupName: selectedGroup
                    };

                    // å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™é€‰ä¸­
                    const alreadySelected = persistedSelected.find(x =>
                                                                   (typeof x === 'string' ? x : x.name) === tagName && x.groupName === selectedGroup
                                                                  );

                    if (!alreadySelected) {
                        persistedSelected.push(tagWithGroup);
                        dialog.dataset.selectedTypes = JSON.stringify(persistedSelected);
                    }

                    // å±•å¼€åˆ†ç»„å¹¶é‡æ–°æ¸²æŸ“
                    tagGroups[selectedGroup].collapsed = false;

                    // æ›´æ–°å½“å‰ä¸»åˆ†ç»„çš„å­åˆ†ç»„
                    if (mainGroups[currentMainGroup]) {
                        mainGroups[currentMainGroup].subGroups = { ...tagGroups };
                        GM_setValue(savedMainGroupsKey, mainGroups);
                    }

                    GM_setValue(savedGroupsKey, tagGroups);
                    renderGroups();

                    // æ»šåŠ¨åˆ°è¯¥æ ‡ç­¾
                    setTimeout(() => {
                        const groupElement = groupsContainer.querySelector(`[data-group="${selectedGroup}"]`);
                        if (groupElement) {
                            const tagButton = groupElement.querySelector(`[data-tag="${tagName}"]`);
                            if (tagButton) {
                                tagButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        }
                    }, 100);
                } else {
                    // ä¸å­˜åœ¨ï¼šæ·»åŠ æ–°æ ‡ç­¾
                    // ä½¿ç”¨åˆ†ç»„çš„é»˜è®¤é¢œè‰²ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é€‰æ‹©çš„é¢œè‰²
                    const defaultColor = tagGroups[selectedGroup].defaultColor || colorSelect.value;
                    const newTag = { name: tagName, color: defaultColor };
                    tagGroups[selectedGroup].tags.push(newTag);
                    GM_setValue(savedGroupsKey, tagGroups);

                    customInput.value = '';
                    colorSelect.value = 'pink';

                    // å±•å¼€åˆ†ç»„å¹¶é‡æ–°æ¸²æŸ“
                    tagGroups[selectedGroup].collapsed = false;

                    // æ›´æ–°å½“å‰ä¸»åˆ†ç»„çš„å­åˆ†ç»„
                    if (mainGroups[currentMainGroup]) {
                        mainGroups[currentMainGroup].subGroups = { ...tagGroups };
                        GM_setValue(savedMainGroupsKey, mainGroups);
                    }

                    GM_setValue(savedGroupsKey, tagGroups);
                    renderGroups();

                    // è‡ªåŠ¨é€‰ä¸­æ–°æ·»åŠ çš„æ ‡ç­¾
                    setTimeout(() => {
                        const persistedSelected = JSON.parse(dialog.dataset.selectedTypes || '[]');
                        const tagWithGroup = { ...newTag, groupName: selectedGroup };
                        persistedSelected.push(tagWithGroup);
                        dialog.dataset.selectedTypes = JSON.stringify(persistedSelected);

                        // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
                        renderGroups();

                        // æ»šåŠ¨åˆ°æ–°æ ‡ç­¾
                        const groupElement = groupsContainer.querySelector(`[data-group="${selectedGroup}"]`);
                        if (groupElement) {
                            const tagButton = groupElement.querySelector(`[data-tag="${tagName}"]`);
                            if (tagButton) {
                                tagButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        }
                    }, 100);
                }
            });

            // å›è½¦é”®æ·»åŠ 
            customInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addButton.click();
                }
            });

            customInputContainer.appendChild(customLabel);
            customInputContainer.appendChild(groupSelect);
            customInputContainer.appendChild(inputRow);
            customInputContainer.appendChild(addButton);

            // åˆ›å»ºå†…å®¹å®¹å™¨ï¼ˆå¯æ»šåŠ¨åŒºåŸŸï¼‰
            const contentContainer = document.createElement('div');
            contentContainer.style.cssText = `
                flex: 1;
                overflow-y: auto;
                padding: 24px;
                padding-bottom: 16px;
            `;

            // ç§»åŠ¨ç«¯å†…å®¹å®¹å™¨é€‚é…
            if (window.innerWidth <= 768) {
                contentContainer.style.cssText = `
                    flex: 1;
                    overflow-y: auto;
                    padding: 16px;
                    padding-bottom: 12px;
                `;
            }

            // æŒ‰é’®å®¹å™¨ - å›ºå®šåœ¨åº•éƒ¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 12px;
                justify-content: center;
                padding: 16px 24px;
                background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                border-top: 1px solid #E2E8F0;
                border-radius: 0 0 20px 20px;
                flex-shrink: 0;
            `;

            // ç§»åŠ¨ç«¯æŒ‰é’®å®¹å™¨é€‚é…
            if (window.innerWidth <= 768) {
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 8px;
                    justify-content: center;
                    padding: 12px 16px;
                    background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                    border-top: 1px solid #E2E8F0;
                    border-radius: 0 0 16px 16px;
                    flex-shrink: 0;
                `;
            }

            // ç¼–è¾‘æ¨¡å¼åˆ‡æ¢æŒ‰é’®ï¼ˆç»Ÿä¸€ç¼–è¾‘/åˆ é™¤/é‡å‘½åå…¥å£ï¼‰
            const deleteModeBtn = document.createElement('button');
            deleteModeBtn.textContent = 'ç¼–è¾‘æ¨¡å¼';
            deleteModeBtn.style.cssText = `
                padding: 12px 24px;
                background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                color: #4B5563;
                border: 1px solid #E5E7EB;
                border-radius: 20px;
                font-size: 16px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                min-width: 120px;
                position: relative;
                overflow: hidden;
            `;

            // ç§»åŠ¨ç«¯ç¼–è¾‘æ¨¡å¼æŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                deleteModeBtn.style.cssText = `
                    padding: 10px 20px;
                    background: white;
                    color: #6B7280;
                    border: 1px solid #d1d5db;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    min-width: 100px;
                `;
            }

            deleteModeBtn.addEventListener('click', () => {
                isDeleteMode = !isDeleteMode;
                deleteModeBtn.textContent = isDeleteMode ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘æ¨¡å¼';

                // æ›´åè°ƒçš„ç¼–è¾‘æ¨¡å¼æŒ‰é’®æ ·å¼
                if (isDeleteMode) {
                    deleteModeBtn.style.background = 'linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%)';
                    deleteModeBtn.style.color = '#1E40AF';
                    deleteModeBtn.style.borderColor = '#93C5FD';
                    deleteModeBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
                    deleteModeBtn.style.transform = 'translateY(-2px)';
                } else {
                    deleteModeBtn.style.background = 'linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%)';
                    deleteModeBtn.style.color = '#4B5563';
                    deleteModeBtn.style.borderColor = '#E5E7EB';
                    deleteModeBtn.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.1)';
                    deleteModeBtn.style.transform = 'translateY(0)';
                }

                renderMainGroups(); // æ›´æ–°ä¸»åˆ†ç»„æ˜¾ç¤ºçŠ¶æ€
                renderGroups();
            });

            // ç¡®è®¤æŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'ç¡®è®¤';
            confirmBtn.style.cssText = `
                padding: 12px 24px;
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px var(--primarycolor-lighter);
                min-width: 100px;
            `;
            // ç§»åŠ¨ç«¯ç¡®è®¤æŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                confirmBtn.style.cssText = `
                    padding: 8px 16px;
                    border: none;
                    border-radius: 6px;
                    linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D))
                    color: white;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s ease;
                `;
            }

            confirmBtn.addEventListener('click', () => {
                const selectedTypes = JSON.parse(dialog.dataset.selectedTypes || '[]');

                // æŒ‰åˆ†ç»„æ•´ç†é€‰ä¸­çš„æ ‡ç­¾å¹¶æ›´æ–°ä½¿ç”¨ç»Ÿè®¡
                const groupedResult = {};
                selectedTypes.forEach(tag => {
                    const groupName = tag.groupName || 'é»˜è®¤åˆ†ç»„';
                    const notionProperty = tagGroups[groupName]?.notionProperty || 'è‡ªå®šä¹‰æ ‡ç­¾';
                    const tagName = typeof tag === 'string' ? tag : tag.name;

                    console.log('å¤„ç†æ ‡ç­¾:', { tag, tagName, groupName });

                    // è·å–æ ‡ç­¾é¢œè‰²ï¼šä¼˜å…ˆä½¿ç”¨tag.colorï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»tagGroupsä¸­æŸ¥æ‰¾
                    let tagColor = 'pink'; // é»˜è®¤é¢œè‰²
                    if (typeof tag === 'object' && tag.color) {
                        tagColor = tag.color;
                        console.log(`æ ‡ç­¾ "${tagName}" ä½¿ç”¨tag.color: ${tagColor}`);
                    } else if (typeof tag === 'string') {
                        // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œä»tagGroupsä¸­æŸ¥æ‰¾é¢œè‰²
                        const groupData = tagGroups[groupName];
                        console.log(`æ ‡ç­¾ "${tagName}" ä»tagGroupsæŸ¥æ‰¾é¢œè‰²:`, groupData);
                        if (groupData && groupData.tags) {
                            const foundTag = groupData.tags.find(t =>
                                                                 (typeof t === 'string' ? t : t.name) === tagName
                                                                );
                            console.log(`æ ‡ç­¾ "${tagName}" åœ¨tagGroupsä¸­æ‰¾åˆ°:`, foundTag);
                            if (foundTag && typeof foundTag === 'object' && foundTag.color) {
                                tagColor = foundTag.color;
                                console.log(`æ ‡ç­¾ "${tagName}" ä½¿ç”¨tagGroupsä¸­çš„é¢œè‰²: ${tagColor}`);
                            }
                        }
                    }

                    // ç¡®ä¿é¢œè‰²å€¼æœ‰æ•ˆï¼Œå¦‚æœæ— æ•ˆåˆ™ä½¿ç”¨é»˜è®¤é¢œè‰²
                    if (!tagColor || tagColor === 'default') {
                        tagColor = 'pink';
                    }

                    console.log(`æ ‡ç­¾ "${tagName}" æœ€ç»ˆé¢œè‰²: ${tagColor}`);

                    if (!groupedResult[notionProperty]) {
                        groupedResult[notionProperty] = [];
                    }

                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåç§°çš„æ ‡ç­¾
                    const existingTagIndex = groupedResult[notionProperty].findIndex(t =>
                                                                                     (typeof t === 'string' ? t : t.name) === tagName
                                                                                    );

                    if (existingTagIndex === -1) {
                        // ä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°æ ‡ç­¾ï¼ˆåŒ…å«é¢œè‰²ä¿¡æ¯ï¼‰
                        groupedResult[notionProperty].push({
                            name: tagName,
                            color: tagColor
                        });
                        // æ›´æ–°ä½¿ç”¨ç»Ÿè®¡
                        updateTagUsage(tagName, groupName);
                    }
                });

                overlay.remove();
                resolve(groupedResult);
            });

            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = `
                padding: 12px 24px;
                border: 1px solid #d1d5db;
                border-radius: 20px;
                background: white;
                color: #374151;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                transition: all 0.2s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                min-width: 100px;
            `;

            // ç§»åŠ¨ç«¯å–æ¶ˆæŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                cancelBtn.style.cssText = `
                    padding: 8px 16px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    background: white;
                    color: #374151;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s ease;
                `;
            }

            cancelBtn.addEventListener('click', () => {
                overlay.remove();
                resolve(null);
            });

            // æ‚¬åœæ•ˆæœ
            confirmBtn.addEventListener('mouseenter', () => {
                confirmBtn.style.transform = 'translateY(-1px)';
                confirmBtn.style.boxShadow = '0 4px 12px var(--primarycolor-lighter)';
            });

            confirmBtn.addEventListener('mouseleave', () => {
                confirmBtn.style.transform = 'translateY(0)';
                confirmBtn.style.boxShadow = 'none';
            });

            buttonContainer.appendChild(deleteModeBtn);
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(confirmBtn);

            // ç»„è£…å¼¹çª—
            dialog.appendChild(title);
            contentContainer.appendChild(mainGroupContainer);
            contentContainer.appendChild(searchFilterContainer);
            contentContainer.appendChild(groupManagementContainer);
            contentContainer.appendChild(groupsContainer);
            contentContainer.appendChild(customInputContainer);
            dialog.appendChild(contentContainer);
            dialog.appendChild(buttonContainer);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    resolve(null);
                }
            });

            // åˆå§‹åŒ–å·²é€‰é›†åˆ
            dialog.dataset.selectedTypes = JSON.stringify([]);

            // åˆå§‹åŒ–ä¸»åˆ†ç»„
            renderMainGroups();
        });
    }

    // æ˜¾ç¤ºç±»å‹é€‰æ‹©å¼¹çª—
    function showTypeSelectionDialog() {
        return new Promise((resolve) => {
            // åˆ›å»ºå¼¹çª—èƒŒæ™¯
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: -webkit-fill-available;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // åˆ›å»ºå¼¹çª—å†…å®¹ - æ›´ç¾è§‚çš„è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                border-radius: 20px;
                padding: 24px;
                max-width: 600px;
                width: 85%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.2);
                position: relative;
            `;
            dialog.className = 'notion-TypeSelection-dialog';

            // ç§»åŠ¨ç«¯é€‚é…
            if (window.innerWidth <= 768) {
                dialog.style.cssText = `
                    background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                    border-radius: 20px;
                    padding: 16px;
                    max-width: 95%;
                    width: 95%;
                    max-height: 85vh;
                    overflow-y: auto;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    position: relative;
                `;
            }

            // æ·»åŠ è£…é¥°æ€§èƒŒæ™¯
            const decorationBg = document.createElement('div');
            decorationBg.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                border-radius: 20px 20px 0 0;
            `;
            dialog.appendChild(decorationBg);

            // æ ‡é¢˜ - æ›´ç¾è§‚çš„è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const title = document.createElement('h3');
            title.textContent = 'é€‰æ‹©ç±»å‹å’Œé¢œè‰²';
            title.style.cssText = `
                margin: 0 0 20px 0;
                font-size: 20px;
                font-weight: 700;
                color: #1F2937;
                text-align: center;
                position: relative;
                background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            `;

            // ç§»åŠ¨ç«¯æ ‡é¢˜é€‚é…
            if (window.innerWidth <= 768) {
                title.style.fontSize = '18px';
                title.style.marginBottom = '12px';
            }

            // å®šä¹‰å¯ç”¨çš„é¢œè‰²é€‰é¡¹ - é©¬å¡é¾™æµ…è‰²å¯çˆ±ç³»
            const AVAILABLE_COLORS = [
                { name: 'default', label: 'é»˜è®¤', color: '#E5E7EB' },
                { name: 'gray', label: 'ç°', color: '#F3F4F6' },
                { name: 'brown', label: 'æ£•è‰²', color: '#F3E8D3' },
                { name: 'orange', label: 'ç²‰è‰²', color: '#FED7AA' },
                { name: 'yellow', label: 'é»„è‰²', color: '#FEF08A' },
                { name: 'green', label: 'ç»¿è‰²', color: '#D1FAE5' },
                { name: 'blue', label: 'è“è‰²', color: '#DBEAFE' },
                { name: 'purple', label: 'ç´«è‰²', color: '#E9D5FF' },
                { name: 'pink', label: 'ç²‰è‰²', color: '#FCE7F3' },
                { name: 'red', label: 'çº¢è‰²', color: '#FEE2E2' }
            ];

            // è½½å…¥ç”¨æˆ·ä¿å­˜çš„ç±»å‹å’Œé¢œè‰²ï¼ˆæ— åˆ™ä½¿ç”¨ä¸‰ä¸ªé»˜è®¤ï¼‰
            const DEFAULT_CLIP_TYPES = [
                { name: 'æ•™ç¨‹', color: 'pink' },
                { name: 'è½¯ä»¶', color: 'pink' },
                { name: 'è®°å½•', color: 'pink' }
            ];

            let types = [];
            const savedTypes = GM_getValue('clip_types_with_colors');
            if (savedTypes && Array.isArray(savedTypes) && savedTypes.length > 0) {
                types = [...savedTypes];
            } else {
                types = [...DEFAULT_CLIP_TYPES];
            }

            // åˆ›å»ºé€‰é¡¹å®¹å™¨ - ç½‘æ ¼å¸ƒå±€ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const optionsContainer = document.createElement('div');
            optionsContainer.style.cssText = `
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-bottom: 20px;
                padding: 1px;
            `;

            // ç§»åŠ¨ç«¯ç½‘æ ¼é€‚é…
            if (window.innerWidth <= 768) {
                optionsContainer.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 6px;
                    margin-bottom: 12px;
                    padding: 2px;
                `;
            }

            // åˆ›å»ºæŠ˜å æ§åˆ¶å®¹å™¨
            const collapseContainer = document.createElement('div');
            collapseContainer.style.cssText = `
                margin-bottom: 20px;
            `;

            // åˆ›å»ºå±•å¼€/æŠ˜å æŒ‰é’® - ç®€çº¦å’Œè°ç²‰è‰²è®¾è®¡
            const expandCollapseBtn = document.createElement('button');
            expandCollapseBtn.style.cssText = `
                display: none;
                width: -webkit-fill-available;
                padding: 8px 16px;
                border: 1px solid #FFCDD8;
                border-radius: 20px;
                background: #FEF9FA;
                color: #FF6B9D;
                cursor: pointer;
                font-size: 14px;
                font-weight: 400;
                transition: all 0.2s ease;
                margin: 12px 0 16px 0;
                position: relative;
                box-shadow: none;
            `;

            // æ·»åŠ ç®€çº¦çš„å°ä¸‰è§’å›¾æ ‡
            const triangleIcon = document.createElement('span');
            triangleIcon.textContent = 'â–¼';
            triangleIcon.style.cssText = `
                margin-right: 8px;
                transition: transform 0.2s ease;
                display: inline-block;
                font-size: 12px;
                opacity: 0.7;
            `;
            expandCollapseBtn.appendChild(triangleIcon);
            expandCollapseBtn.appendChild(document.createTextNode('å±•å¼€æ›´å¤šæ ‡ç­¾'));

            // å±•å¼€/æŠ˜å æŒ‰é’®æ‚¬åœæ•ˆæœ - ç®€çº¦å’Œè°äº¤äº’
            expandCollapseBtn.addEventListener('mouseenter', () => {
                expandCollapseBtn.style.background = '#FFE4EA';
                expandCollapseBtn.style.borderColor = '#FFB3C1';
                expandCollapseBtn.style.color = '#FF5184';
            });

            expandCollapseBtn.addEventListener('mouseleave', () => {
                expandCollapseBtn.style.background = '#FEF9FA';
                expandCollapseBtn.style.borderColor = '#FFCDD8';
                expandCollapseBtn.style.color = '#FF6B9D';
            });

            let isExpanded = false;
            expandCollapseBtn.addEventListener('click', () => {
                isExpanded = !isExpanded;
                triangleIcon.style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
                expandCollapseBtn.textContent = '';
                expandCollapseBtn.appendChild(triangleIcon);
                expandCollapseBtn.appendChild(document.createTextNode(isExpanded ? 'æ”¶èµ·æ ‡ç­¾' : 'å±•å¼€æ›´å¤šæ ‡ç­¾'));

                // é‡æ–°æ¸²æŸ“é€‰é¡¹ä»¥åº”ç”¨æŠ˜å çŠ¶æ€
                renderOptions();
            });

            // å·¥å…·å‡½æ•°ï¼šåˆ›å»ºç¾è§‚çš„ç±»å‹æŒ‰é’®
            function createTypeButton(typeObj, showDelete = false, isExisting = false) {
                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';

                const typeName = typeof typeObj === 'string' ? typeObj : typeObj.name;
                const typeColor = typeof typeObj === 'string' ? 'pink' : (typeObj.color || 'pink');

                // åˆ¤æ–­æ˜¯å¦ä¸ºé»˜è®¤çš„ä¸‰ä¸ªç±»å‹ï¼ˆæ•™ç¨‹ã€è½¯ä»¶ã€è®°å½•ï¼‰
                const isDefaultType = typeName === 'æ•™ç¨‹' || typeName === 'è½¯ä»¶' || typeName === 'è®°å½•';
                // é»˜è®¤ç±»å‹ä¹Ÿä½¿ç”¨å·²å­˜åœ¨æ ‡ç­¾çš„æ ·å¼ï¼ˆä¸æ˜¾ç¤ºé¢œè‰²é€‰æ‹©å™¨ï¼‰
                const shouldUseExistingStyle = isExisting || isDefaultType;

                // ä¸»æŒ‰é’®å®¹å™¨ - é’ˆå¯¹å·²å­˜åœ¨æ ‡ç­¾çš„ç®€åŒ–è®¾è®¡
                const buttonContainer = document.createElement('div');
                if (shouldUseExistingStyle) {
                    // å·²å­˜åœ¨æ ‡ç­¾æˆ–é»˜è®¤ç±»å‹ï¼šé•¿æ¡å½¢æ ‡ç­¾è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
                    buttonContainer.style.cssText = `
                        display: flex;
                        align-items: center;
                        justify-content: flex-start;
                        padding: 8px 12px;
                        border: 1px solid #E5E7EB;
                        border-radius: 20px;
                        background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        cursor: pointer;
                        position: relative;
                        overflow: hidden;
                        min-height: 36px;
                        text-align: left;
                    `;

                    // ç§»åŠ¨ç«¯å·²å­˜åœ¨æ ‡ç­¾é€‚é…
                    if (window.innerWidth <= 768) {
                        buttonContainer.style.cssText = `
                            display: flex;
                            align-items: center;
                            justify-content: flex-start;
                            padding: 6px 10px;
                            border: 1px solid #E5E7EB;
                            border-radius: 20px;
                            background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            cursor: pointer;
                            position: relative;
                            overflow: hidden;
                            min-height: 32px;
                            text-align: left;
                        `;
                    }
                } else {
                    // æ–°æ ‡ç­¾ï¼šå¸¦é¢œè‰²é€‰æ‹©å™¨çš„é•¿æ¡å½¢è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
                    buttonContainer.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        padding: 8px 12px;
                        border: 1px solid #E5E7EB;
                        border-radius: 20px;
                        background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        cursor: pointer;
                        position: relative;
                        overflow: hidden;
                        min-height: 36px;
                    `;

                    // ç§»åŠ¨ç«¯æ–°æ ‡ç­¾é€‚é…
                    if (window.innerWidth <= 768) {
                        buttonContainer.style.cssText = `
                            display: flex;
                            align-items: center;
                            gap: 4px;
                            padding: 6px 10px;
                            border: 1px solid #E5E7EB;
                            border-radius: 20px;
                            background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
                            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                            cursor: pointer;
                            position: relative;
                            overflow: hidden;
                            min-height: 32px;
                        `;
                    }
                }

                // æ·»åŠ æ¸å˜èƒŒæ™¯æ•ˆæœ
                const gradientOverlay = document.createElement('div');
                gradientOverlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(249,250,251,0.8) 100%);
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    pointer-events: none;
                `;
                buttonContainer.appendChild(gradientOverlay);

                const button = document.createElement('button');
                button.dataset.typeName = typeName;
                button.dataset.typeColor = typeColor;

                if (shouldUseExistingStyle) {
                    // å·²å­˜åœ¨æ ‡ç­¾æˆ–é»˜è®¤ç±»å‹ï¼šå·¦å¯¹é½æ˜¾ç¤ºï¼Œæ·»åŠ ç©ºå¿ƒåœ†å›¾æ ‡
                    const icon = document.createElement('span');
                    icon.textContent = 'â—‹';
                    icon.style.cssText = `
                        font-size: 14px;
                        margin-right: 6px;
                        display: inline-block;
                        color: #9CA3AF;
                        font-weight: bold;
                    `;

                    button.style.cssText = `
                        padding: 0;
                        border: none;
                        background: transparent;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        color: #374151;
                        transition: all 0.3s ease;
                        flex: 1;
                        text-align: left;
                        position: relative;
                        z-index: 2;
                        display: flex;
                        align-items: center;
                        justify-content: flex-start;
                    `;

                    // ç§»åŠ¨ç«¯å·²å­˜åœ¨æ ‡ç­¾æŒ‰é’®æ–‡å­—é€‚é…
                    if (window.innerWidth <= 768) {
                        button.style.fontSize = '13px';
                        icon.style.fontSize = '12px';
                        icon.style.marginRight = '4px';
                    }

                    button.appendChild(icon);
                    button.appendChild(document.createTextNode(typeName));
                } else {
                    // æ–°æ ‡ç­¾ï¼šå·¦å¯¹é½æ˜¾ç¤ºï¼Œæ·»åŠ ç©ºå¿ƒåœ†å›¾æ ‡
                    const icon = document.createElement('span');
                    icon.textContent = 'â—‹';
                    icon.style.cssText = `
                        font-size: 14px;
                        margin-right: 6px;
                        display: inline-block;
                        color: #9CA3AF;
                        font-weight: bold;
                    `;

                    button.style.cssText = `
                        padding: 0;
                        border: none;
                        background: transparent;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        color: #374151;
                        transition: all 0.3s ease;
                        flex: 1;
                        text-align: left;
                        position: relative;
                        z-index: 2;
                        display: flex;
                        align-items: center;
                        justify-content: flex-start;
                    `;

                    // ç§»åŠ¨ç«¯æ–°æ ‡ç­¾æŒ‰é’®æ–‡å­—é€‚é…
                    if (window.innerWidth <= 768) {
                        button.style.fontSize = '13px';
                        icon.style.fontSize = '12px';
                        icon.style.marginRight = '4px';
                    }

                    button.appendChild(icon);
                    button.appendChild(document.createTextNode(typeName));
                }

                // é¢œè‰²é€‰æ‹©å™¨ - åªå¯¹æ–°æ ‡ç­¾æ˜¾ç¤ºï¼ˆä¸åŒ…æ‹¬é»˜è®¤ç±»å‹ï¼‰ï¼Œæ”¹ä¸ºå°åœ†ç‚¹æ ·å¼
                let colorSelect = null;
                if (!shouldUseExistingStyle) {
                    colorSelect = document.createElement('select');
                    colorSelect.style.cssText = `
                        width: 20px;
                        height: 20px;
                        border: none;
                        border-radius: 50%;
                        cursor: pointer;
                        background: ${AVAILABLE_COLORS.find(c => c.name === typeColor)?.color || '#FCE7F3'};
                        appearance: none;
                        -webkit-appearance: none;
                        -moz-appearance: none;
                        outline: none;
                        position: relative;
                        flex-shrink: 0;
                    `;

                    // ç§»åŠ¨ç«¯é¢œè‰²é€‰æ‹©å™¨é€‚é…
                    if (window.innerWidth <= 768) {
                        colorSelect.style.cssText = `
                            width: 18px;
                            height: 18px;
                            border: none;
                            border-radius: 50%;
                            cursor: pointer;
                            background: ${AVAILABLE_COLORS.find(c => c.name === typeColor)?.color || '#FCE7F3'};
                            appearance: none;
                            -webkit-appearance: none;
                            -moz-appearance: none;
                            outline: none;
                            position: relative;
                            flex-shrink: 0;
                        `;
                    }

                    // æ·»åŠ é¢œè‰²é€‰é¡¹ï¼ˆæ˜¾ç¤ºé¢œè‰²åç§°ï¼‰
                    AVAILABLE_COLORS.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color.name;
                        option.style.backgroundColor = color.color;
                        option.style.color = '#374151'; // ä½¿ç”¨æ·±è‰²æ–‡å­—ç¡®ä¿å¯è¯»æ€§
                        if (color.name === typeColor) {
                            option.selected = true;
                        }
                        colorSelect.appendChild(option);
                    });

                    // é¢œè‰²é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
                    colorSelect.addEventListener('change', () => {
                        const newColor = colorSelect.value;
                        button.dataset.typeColor = newColor;

                        // æ›´æ–°å°åœ†ç‚¹çš„èƒŒæ™¯è‰²
                        colorSelect.style.background = AVAILABLE_COLORS.find(c => c.name === newColor)?.color || '#FCE7F3';

                        // æ›´æ–°typesæ•°ç»„ä¸­çš„é¢œè‰²
                        const typeIndex = types.findIndex(t =>
                                                          (typeof t === 'string' ? t : t.name) === typeName
                                                         );
                        if (typeIndex !== -1) {
                            types[typeIndex] = { name: typeName, color: newColor };
                        }
                    });

                    // é¢œè‰²é€‰æ‹©å™¨æ‚¬åœæ•ˆæœ
                    colorSelect.addEventListener('mouseenter', () => {
                        colorSelect.style.borderColor = '#9CA3AF';
                        colorSelect.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    });

                    colorSelect.addEventListener('mouseleave', () => {
                        colorSelect.style.borderColor = '#D1D5DB';
                        colorSelect.style.boxShadow = 'none';
                    });
                }

                // æ‚¬åœæ•ˆæœ
                buttonContainer.addEventListener('mouseenter', () => {
                    if (button.dataset.selected !== '1') {
                        buttonContainer.style.borderColor = '#9CA3AF';
                        buttonContainer.style.transform = 'translateY(-2px)';
                        buttonContainer.style.boxShadow = 'none';
                        gradientOverlay.style.opacity = '1';
                    }
                });

                buttonContainer.addEventListener('mouseleave', () => {
                    if (button.dataset.selected !== '1') {
                        buttonContainer.style.borderColor = '#E5E7EB';
                        buttonContainer.style.transform = 'translateY(0)';
                        buttonContainer.style.boxShadow = 'none';
                        gradientOverlay.style.opacity = '0';
                    }
                });

                button.addEventListener('click', () => {
                    // å¤šé€‰åˆ‡æ¢
                    const selected = button.dataset.selected === '1';
                    button.dataset.selected = selected ? '0' : '1';

                    if (selected) {
                        buttonContainer.style.background = 'linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%)';
                        buttonContainer.style.borderColor = '#E5E7EB';
                        button.style.color = '#374151';
                        buttonContainer.style.transform = 'translateY(0)';
                        buttonContainer.style.boxShadow = 'none';
                        gradientOverlay.style.opacity = '0';
                    } else {
                        if (shouldUseExistingStyle) {
                            // å·²å­˜åœ¨æ ‡ç­¾æˆ–é»˜è®¤ç±»å‹çš„é€‰ä¸­çŠ¶æ€ï¼šä½¿ç”¨ç‰¹æ®Šçš„æ¸å˜æ•ˆæœ
                            buttonContainer.style.background = 'linear-gradient(135deg, #FF8FAB 0%, #FF6B9D 100%)';
                            buttonContainer.style.borderColor = 'transparent';
                            button.style.color = 'white';
                            buttonContainer.style.transform = 'translateY(-3px)';
                            buttonContainer.style.boxShadow = '0 12px 30px var(--primarycolor-lighter)';
                            gradientOverlay.style.opacity = '0';
                        } else {
                            // æ–°æ ‡ç­¾çš„é€‰ä¸­çŠ¶æ€ï¼šä½¿ç”¨é€‰æ‹©çš„é¢œè‰²
                            const selectedColor = AVAILABLE_COLORS.find(c => c.name === button.dataset.typeColor);
                            const bgColor = selectedColor ? selectedColor.color : '#DB2777';
                            buttonContainer.style.background = `linear-gradient(135deg, ${bgColor} 0%, ${bgColor}dd 100%)`;
                            buttonContainer.style.borderColor = 'transparent';
                            button.style.color = 'white';
                            buttonContainer.style.transform = 'translateY(-3px)';
                            buttonContainer.style.boxShadow = '0 12px 30px rgba(0,0,0,0.2)';
                            gradientOverlay.style.opacity = '0';
                        }
                    }

                    // æ›´æ–°é€‰ä¸­é›†åˆ
                    const selectedTypes = Array.from(optionsContainer.querySelectorAll('button[data-selected="1"]'))
                    .map(btn => ({
                        name: btn.dataset.typeName,
                        color: btn.dataset.typeColor
                    }));
                    dialog.dataset.selectedTypes = JSON.stringify(selectedTypes);
                });

                // åˆ é™¤æŒ‰é’® - æ›´ç¾è§‚çš„è®¾è®¡
                const del = document.createElement('span');
                del.textContent = 'Ã—';
                del.title = 'åˆ é™¤æ­¤ç±»å‹';
                del.style.cssText = `
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    width: 24px;
                    height: 24px;
                    line-height: 24px;
                    text-align: center;
                    border-radius: 50%;
                    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
                    color: #fff;
                    font-size: 14px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(239,68,68,0.4);
                    display: ${showDelete ? 'block' : 'none'};
                    transition: all 0.2s ease;
                    z-index: 3;
                `;

                del.addEventListener('mouseenter', () => {
                    del.style.transform = 'scale(1.1)';
                    del.style.boxShadow = '0 6px 16px rgba(239,68,68,0.5)';
                });

                del.addEventListener('mouseleave', () => {
                    del.style.transform = 'scale(1)';
                    del.style.boxShadow = '0 4px 12px rgba(239,68,68,0.4)';
                });

                del.addEventListener('click', (e) => {
                    e.stopPropagation();
                    wrapper.remove();
                    types = types.filter(t =>
                                         (typeof t === 'string' ? t : t.name) !== typeName
                                        );
                    const selectedTypes = JSON.parse(dialog.dataset.selectedTypes || '[]')
                    .filter(t => t.name !== typeName);
                    dialog.dataset.selectedTypes = JSON.stringify(selectedTypes);
                });

                buttonContainer.appendChild(button);
                if (colorSelect) {
                    buttonContainer.appendChild(colorSelect);
                }
                wrapper.appendChild(buttonContainer);
                wrapper.appendChild(del);
                return wrapper;
            }

            // æ¸²æŸ“å‡½æ•°
            function renderOptions() {
                optionsContainer.textContent = '';
                types.forEach((t, index) => {
                    // åˆ¤æ–­æ˜¯å¦ä¸ºå·²å­˜åœ¨çš„æ ‡ç­¾ï¼ˆä»Notionæ•°æ®åº“è·å–çš„ï¼‰
                    const isExisting = typeof t === 'object' && t.isExisting;
                    // åˆ¤æ–­æ˜¯å¦ä¸ºé»˜è®¤çš„ä¸‰ä¸ªç±»å‹ï¼ˆæ•™ç¨‹ã€è½¯ä»¶ã€è®°å½•ï¼‰
                    const isDefaultType = typeof t === 'object' &&
                          (t.name === 'æ•™ç¨‹' || t.name === 'è½¯ä»¶' || t.name === 'è®°å½•');
                    // é»˜è®¤ç±»å‹ä¹Ÿä¸æ˜¾ç¤ºé¢œè‰²é€‰æ‹©å™¨
                    const shouldHideColorPicker = isExisting || isDefaultType;
                    const buttonElement = createTypeButton(t, isDeleteMode, shouldHideColorPicker);

                    // å¦‚æœæ ‡ç­¾è¶…è¿‡6ä¸ªä¸”æœªå±•å¼€ï¼Œéšè—è¶…å‡ºéƒ¨åˆ†
                    if (index >= 6 && !isExpanded) {
                        buttonElement.style.display = 'none';
                    }

                    optionsContainer.appendChild(buttonElement);
                });

                // å¦‚æœæ ‡ç­¾è¶…è¿‡6ä¸ªï¼Œæ˜¾ç¤ºå±•å¼€/æŠ˜å æŒ‰é’®
                if (types.length > 6) {
                    expandCollapseBtn.style.display = 'block';
                } else {
                    expandCollapseBtn.style.display = 'none';
                }

                // é‡ç½®å·²é€‰é›†åˆ
                dialog.dataset.selectedTypes = JSON.stringify([]);
            }

            // æ¸²æŸ“åˆå§‹æŒ‰é’®
            let isDeleteMode = false;
            renderOptions();

            // è‡ªå®šä¹‰è¾“å…¥æ¡† - æ›´ç¾è§‚çš„è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const customInputContainer = document.createElement('div');
            customInputContainer.style.cssText = `
                margin-bottom: 24px;
                padding: 20px;
                background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                border-radius: 20px;
                border: 1px solid #E2E8F0;
            `;

            // ç§»åŠ¨ç«¯è‡ªå®šä¹‰è¾“å…¥å®¹å™¨é€‚é…
            if (window.innerWidth <= 768) {
                customInputContainer.style.cssText = `
                    margin-bottom: 16px;
                    padding: 16px;
                    background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
                    border-radius: 20px;
                    border: 1px solid #E2E8F0;
                `;
            }

            const customLabel = document.createElement('label');
            customLabel.textContent = 'æ·»åŠ æ–°ç±»å‹';
            customLabel.style.cssText = `
                display: block;
                margin-bottom: 12px;
                font-size: 16px;
                font-weight: 600;
                color: #1F2937;
            `;

            // ç§»åŠ¨ç«¯è‡ªå®šä¹‰æ ‡ç­¾é€‚é…
            if (window.innerWidth <= 768) {
                customLabel.style.fontSize = '14px';
                customLabel.style.marginBottom = '8px';
            }

            // è¾“å…¥æ¡†å’Œé¢œè‰²é€‰æ‹©å™¨å®¹å™¨ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const inputRow = document.createElement('div');
            inputRow.style.cssText = `
                display: flex;
                gap: 12px;
                margin-bottom: 12px;
            `;

            // ç§»åŠ¨ç«¯è¾“å…¥è¡Œé€‚é…
            if (window.innerWidth <= 768) {
                inputRow.style.cssText = `
                    display: flex;
                    gap: 8px;
                    margin-bottom: 8px;
                `;
            }

            const customInput = document.createElement('input');
            customInput.type = 'text';
            customInput.placeholder = 'è¾“å…¥è‡ªå®šä¹‰ç±»å‹åç§°';
            customInput.style.cssText = `
                flex: 1;
                padding: 12px 16px;
                border: 2px solid #E2E8F0;
                border-radius: 20px;
                font-size: 15px;
                box-sizing: border-box;
                background: white;
                transition: all 0.2s ease;
                font-weight: 500;
            `;

            // ç§»åŠ¨ç«¯è‡ªå®šä¹‰è¾“å…¥æ¡†é€‚é…
            if (window.innerWidth <= 768) {
                customInput.style.cssText = `
                    flex: 1;
                    padding: 10px 12px;
                    border: 2px solid #E2E8F0;
                    border-radius: 20px;
                    font-size: 14px;
                    box-sizing: border-box;
                    background: white;
                    transition: all 0.2s ease;
                    font-weight: 500;
                `;
            }

            // è¾“å…¥æ¡†æ‚¬åœæ•ˆæœ
            customInput.addEventListener('focus', () => {
                customInput.style.borderColor = '#FF8FAB';
                customInput.style.boxShadow = '0 0 0 3px rgba(255, 143, 171, 0.1)';
            });

            customInput.addEventListener('blur', () => {
                customInput.style.borderColor = '#E2E8F0';
                customInput.style.boxShadow = 'none';
            });
            const defaultColorSelect = document.createElement('select');
            defaultColorSelect.style.cssText = `
                padding: 12px 16px;
                border: 2px solid #E2E8F0;
                border-radius: 20px;
                background: white;
                font-size: 15px;
                cursor: pointer;
                min-width: 120px;
                font-weight: 500;
                transition: all 0.2s ease;
            `;

            // ç§»åŠ¨ç«¯é»˜è®¤é¢œè‰²é€‰æ‹©å™¨é€‚é…
            if (window.innerWidth <= 768) {
                defaultColorSelect.style.cssText = `
                    padding: 10px 12px;
                    border: 2px solid #E2E8F0;
                    border-radius: 20px;
                    background: white;
                    font-size: 14px;
                    cursor: pointer;
                    min-width: 100px;
                    font-weight: 500;
                    transition: all 0.2s ease;
                `;
            }

            // é¢œè‰²é€‰æ‹©å™¨æ‚¬åœæ•ˆæœ
            defaultColorSelect.addEventListener('focus', () => {
                defaultColorSelect.style.borderColor = '#FF8FAB';
                defaultColorSelect.style.boxShadow = '0 0 0 3px rgba(255, 143, 171, 0.1)';
            });

            defaultColorSelect.addEventListener('blur', () => {
                defaultColorSelect.style.borderColor = '#E2E8F0';
                defaultColorSelect.style.boxShadow = 'none';
            });

            // æ·»åŠ é»˜è®¤é¢œè‰²é€‰é¡¹
            AVAILABLE_COLORS.forEach(color => {
                const option = document.createElement('option');
                option.value = color.name;
                option.textContent = color.label;
                option.style.color = color.color;
                if (color.name === 'pink') {
                    option.selected = true;
                }
                defaultColorSelect.appendChild(option);
            });

            inputRow.appendChild(customInput);
            inputRow.appendChild(defaultColorSelect);

            // æ·»åŠ æŒ‰é’® - å‚è€ƒé…ç½®ç•Œé¢æ ·å¼
            const addTypeBtn = document.createElement('button');
            addTypeBtn.textContent = 'âœ¨ æ·»åŠ ç±»å‹';
            addTypeBtn.style.cssText = `
                margin-top: 8px;
                padding: 10px 20px;
                border: none;
                border-radius: 20px;
                background:linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s ease;
                flex: 1;
            `;

            // ç§»åŠ¨ç«¯æ·»åŠ æŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                addTypeBtn.style.cssText = `
                    margin-top: 6px;
                    padding: 8px 12px;
                    border: none;
                    border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor-light, #FF8FAB) 0%, var(--primarycolor, #FF6B9D) 100%);
                    color: white;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px var(--primarycolor-lighter);
                    flex: 1;
                `;
            }

            // æ·»åŠ æŒ‰é’®æ‚¬åœæ•ˆæœ
            addTypeBtn.addEventListener('mouseenter', () => {
                addTypeBtn.style.transform = 'translateY(-1px)';
                addTypeBtn.style.boxShadow = '0 4px 12px var(--primarycolor-lighter)';
            });

            addTypeBtn.addEventListener('mouseleave', () => {
                addTypeBtn.style.transform = 'translateY(0)';
                addTypeBtn.style.boxShadow = 'none';
            });
            addTypeBtn.addEventListener('click', () => {
                const val = customInput.value.trim();
                const selectedColor = defaultColorSelect.value;
                if (!val) return;

                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const existingType = types.find(t =>
                                                (typeof t === 'string' ? t : t.name) === val
                                               );

                if (existingType) {
                    // åˆ‡æ¢ä¸ºé€‰ä¸­
                    optionsContainer.querySelectorAll('button').forEach(btn => {
                        if (btn.dataset.typeName === val) btn.click();
                    });
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    customInput.value = '';
                    return;
                }

                // æ·»åŠ æ–°ç±»å‹
                const newType = { name: val, color: selectedColor };
                types.push(newType);
                const node = createTypeButton(newType, isDeleteMode);
                optionsContainer.appendChild(node);
                // é€‰ä¸­æ–°æ·»åŠ çš„ç±»å‹
                node.querySelector('button').click();
                // æ¸…ç©ºè¾“å…¥æ¡†
                customInput.value = '';
            });

            // åˆ é™¤æ¨¡å¼æŒ‰é’® - æ›´ç¾è§‚çš„è®¾è®¡
            const deleteModeBtn = document.createElement('button');
            deleteModeBtn.textContent = 'ğŸ—‘ï¸ åˆ é™¤ç±»å‹';
            deleteModeBtn.style.cssText = `
                margin-top: 8px;
                padding: 10px 20px;
                border: 1px solid var(--primarycolor);
                border-radius: 20px;
                background: white;
                color: var(--primarycolor);
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s ease;
                flex: 1;
            `;

            // ç§»åŠ¨ç«¯åˆ é™¤æŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                deleteModeBtn.style.cssText = `
                    margin-top: 6px;
                    padding: 8px 16px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    background: white;
                    color: #374151;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s ease;
                    flex: 1;
                `;
            }

            // åˆ é™¤æ¨¡å¼çŠ¶æ€ç”±ä¸Šæ–¹renderOptionsåˆå§‹åŒ–

            // æ·»åŠ æ‚¬åœæ•ˆæœ
            deleteModeBtn.addEventListener('mouseenter', () => {
                if (!isDeleteMode) {
                    deleteModeBtn.style.background = 'var(--primarycolor-lighter)';
                    deleteModeBtn.style.borderColor = 'var(--primarycolor)';
                    deleteModeBtn.style.transform = 'translateY(-1px)';
                    deleteModeBtn.style.boxShadow = '0 4px 8px var(--primarycolor-lighter)';
                }
            });

            deleteModeBtn.addEventListener('mouseleave', () => {
                if (!isDeleteMode) {
                    deleteModeBtn.style.background = 'white';
                    deleteModeBtn.style.borderColor = 'var(--primarycolor)';
                    deleteModeBtn.style.transform = 'translateY(0)';
                    deleteModeBtn.style.boxShadow = '0 2px 4px rgba(255, 143, 171, 0.1)';
                }
            });

            deleteModeBtn.addEventListener('click', () => {
                isDeleteMode = !isDeleteMode;
                const deleteButtons = optionsContainer.querySelectorAll('span[title="åˆ é™¤æ­¤ç±»å‹"]');

                if (isDeleteMode) {
                    // è¿›å…¥åˆ é™¤æ¨¡å¼
                    deleteModeBtn.textContent = 'Ã— å–æ¶ˆåˆ é™¤';
                    deleteModeBtn.style.background = 'linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D))';
                    deleteModeBtn.style.borderColor = 'var(--primarycolor)';
                    deleteModeBtn.style.color = 'white';
                    deleteModeBtn.style.boxShadow = '0 4px 12px var(--primarycolor-lighter)';
                    deleteModeBtn.style.transform = 'translateY(-2px)';
                    deleteButtons.forEach(del => del.style.display = 'block');
                } else {
                    // é€€å‡ºåˆ é™¤æ¨¡å¼
                    deleteModeBtn.textContent = 'Ã— åˆ é™¤ç±»å‹';
                    deleteModeBtn.style.background = 'linear-gradient(135deg, #fef7f7, #fdf2f8)';
                    deleteModeBtn.style.borderColor = 'var(--primarycolor)';
                    deleteModeBtn.style.color = 'var(--primarycolor)';
                    deleteModeBtn.style.boxShadow = '0 2px 4px var(--primarycolor-lighter)';
                    deleteModeBtn.style.transform = 'translateY(0)';
                    deleteButtons.forEach(del => del.style.display = 'none');
                }
            });

            // æ¢å¤é»˜è®¤ç±»å‹æŒ‰é’® - æ›´ç¾è§‚çš„è®¾è®¡
            const restoreBtn = document.createElement('button');
            restoreBtn.textContent = 'ğŸ”„ æ¢å¤é»˜è®¤';
            restoreBtn.style.cssText = `
                margin-top: 8px;
                padding: 10px 20px;
                border: 1px solid #d1d5db;
                border-radius: 20px;
                background: white;
                color: #374151;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s ease;
                flex: 1;
            `;

            // ç§»åŠ¨ç«¯æ¢å¤æŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                restoreBtn.style.cssText = `
                    margin-top: 6px;
                    padding: 8px 16px;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    background: white;
                    color: #374151;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s ease;
                    flex: 1;
                `;
            }

            // æ¢å¤æŒ‰é’®æ‚¬åœæ•ˆæœ
            restoreBtn.addEventListener('mouseenter', () => {
                restoreBtn.style.borderColor = '#9CA3AF';
                restoreBtn.style.transform = 'translateY(-1px)';
            });

            restoreBtn.addEventListener('mouseleave', () => {
                restoreBtn.style.borderColor = '#d1d5db';
                restoreBtn.style.transform = 'translateY(0)';
            });
            restoreBtn.addEventListener('click', () => {
                types = [...DEFAULT_CLIP_TYPES];
                isDeleteMode = false;
                deleteModeBtn.textContent = 'Ã— åˆ é™¤ç±»å‹';
                renderOptions();
                showNotification('å·²æ¢å¤é»˜è®¤ç±»å‹ï¼ˆæœªä¿å­˜ï¼Œéœ€ç‚¹å‡»ç¡®å®šä¿å­˜ï¼‰', 'info');
            });

            // åˆ›å»ºæŒ‰é’®å®¹å™¨ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const buttonRow = document.createElement('div');
            buttonRow.style.cssText = `
                display: flex;
                align-items: center;
                margin-top: 8px;
                width: -webkit-fill-available;
                gap: 8px;
            `;

            // ç§»åŠ¨ç«¯æŒ‰é’®è¡Œé€‚é…
            if (window.innerWidth <= 768) {
                buttonRow.style.cssText = `
                    display: flex;
                    align-items: center;
                    margin-top: 6px;
                    flex-wrap: nowrap;
                    gap: 4px;
                    justify-content: space-between;
                    width: -webkit-fill-available;
                `;
            }

            buttonRow.appendChild(addTypeBtn);
            buttonRow.appendChild(deleteModeBtn);
            buttonRow.appendChild(restoreBtn);

            customInputContainer.appendChild(customLabel);
            customInputContainer.appendChild(inputRow);
            customInputContainer.appendChild(buttonRow);

            // æŒ‰é’®å®¹å™¨ - æ›´ç¾è§‚çš„è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 16px;
                justify-content: center;
                margin-top: 24px;
                padding-top: 24px;
                border-top: 1px solid #E5E7EB;
            `;

            // ç§»åŠ¨ç«¯åº•éƒ¨æŒ‰é’®å®¹å™¨é€‚é…
            if (window.innerWidth <= 768) {
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                    margin-top: 16px;
                    padding-top: 16px;
                    border-top: 1px solid #E5E7EB;
                `;
            }

            // å–æ¶ˆæŒ‰é’® - æ›´ç¾è§‚çš„è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = `
                padding: 14px 28px;
                border: 2px solid #E5E7EB;
                border-radius: 20px;
                background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
                color: #6B7280;
                cursor: pointer;
                font-size: 15px;
                font-weight: 600;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px rgba(107, 114, 128, 0.1);
                min-width: 100px;
            `;

            // ç§»åŠ¨ç«¯å–æ¶ˆæŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                cancelBtn.style.cssText = `
                    padding: 12px 20px;
                    border: 2px solid #E5E7EB;
                    border-radius: 20px;
                    background: linear-gradient(135deg, #FFFFFF 0%, #F9FAFB 100%);
                    color: #6B7280;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.1);
                    min-width: 80px;
                `;
            }

            // å–æ¶ˆæŒ‰é’®æ‚¬åœæ•ˆæœ
            cancelBtn.addEventListener('mouseenter', () => {
                cancelBtn.style.borderColor = '#9CA3AF';
                cancelBtn.style.color = '#374151';
                cancelBtn.style.transform = 'translateY(-2px)';
                cancelBtn.style.boxShadow = '0 8px 20px rgba(107, 114, 128, 0.15)';
            });

            cancelBtn.addEventListener('mouseleave', () => {
                cancelBtn.style.borderColor = '#E5E7EB';
                cancelBtn.style.color = '#6B7280';
                cancelBtn.style.transform = 'translateY(0)';
                cancelBtn.style.boxShadow = '0 4px 12px rgba(107, 114, 128, 0.1)';
            });

            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                resolve(null);
            });

            // ç¡®å®šæŒ‰é’® - æ›´ç¾è§‚çš„è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'ç¡®å®š';
            confirmBtn.style.cssText = `
                padding: 14px 28px;
                border: none;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--primarycolor-light, #FF8FAB) 0%, var(--primarycolor, #FF6B9D) 100%);
                color: white;
                cursor: pointer;
                font-size: 15px;
                font-weight: 600;
                transition: all 0.3s ease;
                box-shadow: 0 4px 12px var(--primarycolor-lighter);
                min-width: 100px;
            `;

            // ç§»åŠ¨ç«¯ç¡®å®šæŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                confirmBtn.style.cssText = `
                    padding: 12px 20px;
                    border: none;
                    border-radius: 20px;
                    background: linear-gradient(135deg, #FF8FAB 0%, #FF6B9D 100%);
                    color: white;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px var(--primarycolor-lighter);
                    min-width: 80px;
                `;
            }

            // æ·»åŠ æ‚¬åœæ•ˆæœ
            confirmBtn.addEventListener('mouseenter', () => {
                confirmBtn.style.background = 'linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D))';
                confirmBtn.style.transform = 'translateY(-2px)';
                confirmBtn.style.boxShadow = '0 4px 10px rgba(255,107,157,0.25)';
            });

            confirmBtn.addEventListener('mouseleave', () => {
                confirmBtn.style.background = 'linear-gradient(135deg, var(--primarycolor-dark, #FF8FAB), var(--primarycolor, #FF6B9D))';
                confirmBtn.style.transform = 'translateY(0)';
                confirmBtn.style.boxShadow = 'none';
            });

            confirmBtn.addEventListener('click', () => {
                const customVal = customInput.value.trim();
                const customColor = defaultColorSelect.value;
                let selected = [];
                try { selected = JSON.parse(dialog.dataset.selectedTypes || '[]'); } catch(e) { selected = []; }

                // å¦‚æœæœ‰è‡ªå®šä¹‰è¾“å…¥ï¼Œæ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
                if (customVal) {
                    selected.push({ name: customVal, color: customColor });
                }

                // å»é‡ï¼ˆåŸºäºåç§°ï¼‰
                const uniqueSelected = [];
                const seenNames = new Set();
                selected.forEach(item => {
                    if (!seenNames.has(item.name)) {
                        seenNames.add(item.name);
                        uniqueSelected.push(item);
                    }
                });

                if (uniqueSelected.length > 0) {
                    // ä¿å­˜ç”¨æˆ·å½“å‰ç¼–è¾‘åçš„ç±»å‹é›†åˆï¼ˆåŒ…å«é¢œè‰²ï¼‰
                    try {
                        GM_setValue('clip_types_with_colors', types);
                        // ä¸ºäº†å…¼å®¹æ€§ï¼Œä¹Ÿä¿å­˜æ—§æ ¼å¼
                        const oldFormatTypes = types.map(t => typeof t === 'string' ? t : t.name);
                        GM_setValue('clip_types', oldFormatTypes);
                    } catch(e) { /* ignore */ }
                    document.body.removeChild(overlay);
                    resolve(uniqueSelected);
                } else {
                    alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç±»å‹æˆ–è¾“å…¥è‡ªå®šä¹‰ç±»å‹');
                }
            });

            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(confirmBtn);

            // ç»„è£…å¼¹çª—
            dialog.appendChild(title);
            dialog.appendChild(optionsContainer);
            dialog.appendChild(expandCollapseBtn);
            dialog.appendChild(customInputContainer);
            dialog.appendChild(buttonContainer);
            overlay.appendChild(dialog);

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(overlay);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    resolve(null);
                }
            });
        });
    }


    // è‡ªåŠ¨æ›´æ–°æ£€æŸ¥å‡½æ•°
    // æ·»åŠ ä¸€ä¸ªå˜é‡æ¥è·Ÿè¸ªæ­¤æ¬¡é¡µé¢åŠ è½½æœŸé—´æ˜¯å¦å·²ç»æ˜¾ç¤ºäº†è‡ªåŠ¨æ›´æ–°æç¤º
    let hasShownAutoUpdateNotification = false;
    let lastAutoUpdateNotificationTime = 0; // æ·»åŠ æ—¶é—´æˆ³ç”¨äºé˜²æŠ–

    // å¢å¼ºçš„è‡ªåŠ¨æ›´æ–°é…ç½®
    const ENHANCED_AUTO_UPDATE_CONFIG = {
        enabled: GM_getValue('enhanced_auto_update_enabled', true),
        checkInterval: GM_getValue('auto_update_check_interval', 5), // æ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
        smartDetection: GM_getValue('smart_update_detection', true), // æ™ºèƒ½æ£€æµ‹
        updateNotification: GM_getValue('update_notification_enabled', true), // æ›´æ–°é€šçŸ¥
        rapidRetryEnabled: GM_getValue('auto_update_rapid_retry_enabled', true),
        rapidRetryCount: GM_getValue('auto_update_rapid_retry_count', 6),
        rapidRetryInterval: GM_getValue('auto_update_rapid_retry_interval', 30), // ç§’
        observerEnabled: GM_getValue('auto_update_dom_observer_enabled', true),
        visibilityTrigger: GM_getValue('auto_update_visibility_trigger', true),
        domDebounceMs: GM_getValue('auto_update_dom_debounce_ms', 2000),
        cacheTtlMs: GM_getValue('existing_page_cache_ttl_ms', 10000), // é¡µé¢ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆæ¯«ç§’ï¼‰
        initCheckDelayMs: GM_getValue('auto_update_init_check_delay_ms', 100) // åˆå§‹æ£€æŸ¥å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
    };

    let currentPeriodicIntervalMinutes = ENHANCED_AUTO_UPDATE_CONFIG.checkInterval;
    let autoUpdateNoChangeStreak = 0;

    // è‡ªå®šä¹‰æ ·å¼é…ç½®
    const CUSTOM_STYLE_CONFIG = {
        enabled: GM_getValue('custom_style_enabled', false),
        primarycolor: GM_getValue('custom_primarycolor_color', '#FF8FAB'),
        secondaryColor: GM_getValue('custom_secondary_color', '#FF6B9D'),
        backgroundColor: GM_getValue('custom_background_color', '#ffffff'),
        textColor: GM_getValue('custom_text_color', '#374151'),
        borderRadius: GM_getValue('custom_border_radius', '12px'),
        fontSize: GM_getValue('custom_font_size', '14px'),
        fontFamily: GM_getValue('custom_font_family', 'system-ui, -apple-system, sans-serif'),
    };

    // æ™ºèƒ½æå–ä¼˜åŒ–é…ç½®
    const SMART_EXTRACTION_CONFIG = {
        enabled: GM_getValue('smart_extraction_enabled', true),
        fallbackSelectors: GM_getValue('fallback_selectors_enabled', true),
        contentAnalysis: GM_getValue('content_analysis_enabled', true),
        autoCleanup: GM_getValue('auto_cleanup_enabled', true),
        confidenceThreshold: GM_getValue('confidence_threshold', 0.7)
    };

    // ç»Ÿä¸€å¤„ç†æ›´æ–°é€»è¾‘
    async function processUpdate(pageId, comicData, sourceURL, contentType, isAuto = false, existingData = null) {
        // æ‰§è¡Œæ›´æ–°
        const result = await updateNotionPage(pageId, comicData, sourceURL, contentType);

        // æ›´æ–°ç¼“å­˜
        if (typeof updateCache !== 'undefined') {
            if (existingData) {
                updateCache.data = {...existingData, ...comicData};
                updateCache.timestamp = Date.now();
                updateCache.pageId = pageId;
            } else {
                // å¦‚æœæ²¡æœ‰ç°æœ‰æ•°æ®ï¼ˆæ‰‹åŠ¨æ›´æ–°é€šå¸¸æ²¡æœ‰ï¼‰ï¼Œåˆ™æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°é‡æ–°è·å–
                updateCache.pageId = null;
                updateCache.data = null;
                updateCache.timestamp = 0;
            }
        }
        try {
            const urlKey = `lastUpdateTs_${sourceURL}`;
            const host = (() => { try { return new URL(sourceURL).hostname; } catch(_) { return location.hostname; } })();
            const domainKey = `lastDomainUpdateTs_${host}`;
            GM_setValue(urlKey, Date.now());
            GM_setValue(domainKey, Date.now());
            // ç¼“å­˜é¡µé¢ID
            if (pageId) {
                GM_setValue(`lastPageId_${sourceURL}`, pageId);
            }
        } catch(_) {}

        // æ˜¾ç¤ºæç¤º
        const title = result.title || comicData.ä¹¦å || comicData.æ ‡é¢˜ || 'é¡µé¢';
        if (isAuto) {
            if (typeof ENHANCED_AUTO_UPDATE_CONFIG !== 'undefined' && ENHANCED_AUTO_UPDATE_CONFIG.updateNotification) {
                showNotification(`"${title}" å·²è‡ªåŠ¨æ›´æ–°`, 'success');
            }
        } else {
            showNotification(`"${title}" å·²æ›´æ–°`, 'success');
        }

        return result;
    }

    // æ·»åŠ ä¸€ä¸ªå˜é‡æ¥ç¼“å­˜æœ€è¿‘ä¸€æ¬¡æ›´æ–°çš„æ•°æ®ï¼Œé¿å…é‡å¤è¯·æ±‚
    const updateCache = {
        pageId: null,
        data: null,
        timestamp: 0
    };

    // è®¾ç½®å¹¶è¡Œè¯·æ±‚é€‰é¡¹ï¼ˆé»˜è®¤ä¸ºtrueï¼Œå¯ä»¥é€šè¿‡è®¾ç½®GM_getValue('parallelRequests', false)æ¥ç¦ç”¨ï¼‰
    const enableParallelRequests = GM_getValue('parallelRequests', true);

    let autoUpdateIntervalTimer = null;
    let autoUpdateDebounceTimer = null;
    let isAutoUpdateRunning = false;
    let pendingAutoUpdateReason = null;
    let autoUpdateMutationObserver = null;
    let autoUpdateObserverSelectors = [];
    let rapidRetryTimers = [];
    let visibilityListenerRegistered = false;

    function requestAutoUpdate(reason = 'manual', debounceMs = 0) {
        if (typeof autoUpdateSuspendedDueToCover !== 'undefined' && autoUpdateSuspendedDueToCover && reason !== 'cover-upload') {
            console.log(`è‡ªåŠ¨æ›´æ–°: å› å°é¢æ›¿æ¢å·²æš‚åœï¼Œè·³è¿‡è§¦å‘ (${reason})`);
            return;
        }
        if (reason !== 'cover-upload' && coverUploadTriggeredAutoUpdate) {
            console.log(`è‡ªåŠ¨æ›´æ–°: å·²æœ‰å°é¢ä¸Šä¼ è§¦å‘çš„æ›´æ–°åœ¨é˜Ÿåˆ—ä¸­ï¼Œè·³è¿‡é‡å¤è§¦å‘ (${reason})`);
            return;
        }
        if (reason !== 'cover-upload') {
            autoUpdateTriggeredByDataChange = true;
        }
        if (autoUpdateDebounceTimer) {
            clearTimeout(autoUpdateDebounceTimer);
            autoUpdateDebounceTimer = null;
        }
        const delay = Math.max(0, debounceMs);
        autoUpdateDebounceTimer = setTimeout(() => {
            autoUpdateDebounceTimer = null;
            checkAndAutoUpdate(reason);
        }, delay);
    }

    function clearRapidRetryTimers() {
        if (!rapidRetryTimers.length) return;
        rapidRetryTimers.forEach(timerId => clearTimeout(timerId));
        rapidRetryTimers = [];
    }

    function nodeMatchesAutoUpdateSelectors(node) {
        if (!node || !autoUpdateObserverSelectors.length) return false;
        let element = node.nodeType === Node.TEXT_NODE ? node.parentElement : node;
        if (!(element instanceof Element)) return false;

        return autoUpdateObserverSelectors.some(selector => {
            try {
                return element.matches(selector) || element.querySelector(selector);
            } catch (error) {
                console.warn('è‡ªåŠ¨æ›´æ–°: é€‰æ‹©å™¨åŒ¹é…å¤±è´¥', selector, error);
                return false;
            }
        });
    }

    function setupAutoUpdateObservers(siteConfig, forceRestart = false) {
        if (!siteConfig || siteConfig.contentType === 'clip') {
            autoUpdateObserverSelectors = [];
            if (autoUpdateMutationObserver) {
                autoUpdateMutationObserver.disconnect();
                autoUpdateMutationObserver = null;
            }
            return;
        }

        if (!ENHANCED_AUTO_UPDATE_CONFIG.observerEnabled) {
            autoUpdateObserverSelectors = [];
            if (autoUpdateMutationObserver) {
                autoUpdateMutationObserver.disconnect();
                autoUpdateMutationObserver = null;
            }
            return;
        }

        if (!document.body) return;

        const selectors = new Set();
        const selectorKeys = ['æœ€æ–°ç« èŠ‚', 'è¿½æ›´', 'æ›´æ–°çŠ¶æ€', 'ä¹¦å', 'æ ‡é¢˜'];
        selectorKeys.forEach(key => {
            const selector = siteConfig.selectors && siteConfig.selectors[key];
            if (selector) selectors.add(selector);
        });

        if (!selectors.size) {
            autoUpdateObserverSelectors = [];
            if (autoUpdateMutationObserver) {
                autoUpdateMutationObserver.disconnect();
                autoUpdateMutationObserver = null;
            }
            return;
        }

        if (autoUpdateMutationObserver && !forceRestart) {
            return;
        }

        if (autoUpdateMutationObserver) {
            autoUpdateMutationObserver.disconnect();
            autoUpdateMutationObserver = null;
        }

        autoUpdateObserverSelectors = Array.from(selectors);
        autoUpdateMutationObserver = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (mutation.type === 'characterData') {
                    requestAutoUpdate('dom-text', ENHANCED_AUTO_UPDATE_CONFIG.domDebounceMs);
                    return;
                }
                if (mutation.type === 'childList') {
                    if ([...mutation.addedNodes].some(node => nodeMatchesAutoUpdateSelectors(node))) {
                        requestAutoUpdate('dom-childlist', ENHANCED_AUTO_UPDATE_CONFIG.domDebounceMs);
                        return;
                    }
                    if ([...mutation.removedNodes].some(node => nodeMatchesAutoUpdateSelectors(node))) {
                        requestAutoUpdate('dom-removal', ENHANCED_AUTO_UPDATE_CONFIG.domDebounceMs);
                        return;
                    }
                }
            }
        });

        autoUpdateMutationObserver.observe(document.body, {
            childList: true,
            characterData: true,
            subtree: true
        });

        console.log('è‡ªåŠ¨æ›´æ–°: å·²å¯åŠ¨DOMå˜åŒ–ç›‘å¬', autoUpdateObserverSelectors);
    }

    function setupVisibilityTrigger() {
        if (visibilityListenerRegistered) return;

        document.addEventListener('visibilitychange', () => {
            if (!ENHANCED_AUTO_UPDATE_CONFIG.visibilityTrigger) return;
            if (document.visibilityState === 'visible') {
                console.log('è‡ªåŠ¨æ›´æ–°: é¡µé¢é‡æ–°å¯è§ï¼Œè§¦å‘æ£€æµ‹');
                try { checkAndAutoUpdate('visibility'); } catch (_) {}
            }
        });
        visibilityListenerRegistered = true;
    }

    let urlChangeWatcherInitialized = false;
    let lastObservedUrl = window.location.href;
    function updateFloatingButtonsVisibility() {
        const enabled = isCurrentPageEnabled();
        const container = document.getElementById('notion-import-btn-container');
        const tagBtn = document.querySelector('.notion-tag-btn');
        if (enabled) {
            if (!container) {
                addButtons();
            }
            if (!tagBtn) {
                createTagButton();
            }
        } else {
            if (container) container.remove();
            if (tagBtn) tagBtn.remove();
        }
    }
    function setupUrlChangeWatcher() {
        if (urlChangeWatcherInitialized) return;
        const fire = () => {
            const href = window.location.href;
            if (href !== lastObservedUrl) {
                lastObservedUrl = href;
                updateFloatingButtonsVisibility();
                try { updateTagButtonStatus(true); } catch(_) {}
                existingPageIdCache = null;
                hasExistingTag = false;
                __lastUpdateTagStatus = 0;
                hasPerformedAutoUpdateCheck = false;
                if (typeof autoUpdateSuspendedDueToCover !== 'undefined') {
                    autoUpdateSuspendedDueToCover = false;
                    coverUploadTriggeredAutoUpdate = false;
                    autoUpdateTriggeredByDataChange = false;
                }
                try {
                    if (isCurrentPageEnabled()) {
                        const siteConfig = getSiteConfig();
                        if (siteConfig && siteConfig.contentType !== 'clip') {
                            setupAutoUpdateObservers(siteConfig, true);
                        }
                        try { checkAndAutoUpdate('url-change'); } catch (_) {}
                    }
                } catch (_) {}
            }
        };
        const origPush = history.pushState;
        history.pushState = function() { const r = origPush.apply(this, arguments); fire(); return r; };
        const origReplace = history.replaceState;
        history.replaceState = function() { const r = origReplace.apply(this, arguments); fire(); return r; };
        window.addEventListener('popstate', fire);
        window.addEventListener('hashchange', fire);
        setInterval(fire, 500);
        urlChangeWatcherInitialized = true;
    }

    async function checkAndAutoUpdate(triggerReason = 'manual') {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è‡ªåŠ¨æ›´æ–°
        const autoUpdateDisabled = GM_getValue('autoUpdateDisabled', false);
        if (autoUpdateDisabled) {
            console.log('è‡ªåŠ¨æ›´æ–°: å·²ç¦ç”¨');
            return;
        }

        if (isAutoUpdateRunning) {
            pendingAutoUpdateReason = triggerReason;
            console.log('è‡ªåŠ¨æ›´æ–°: ä»»åŠ¡è¿›è¡Œä¸­ï¼Œæ’é˜Ÿè§¦å‘', triggerReason);
            return;
        }

        isAutoUpdateRunning = true;

        const now = Date.now();

        try {
            console.log('è‡ªåŠ¨æ›´æ–°: å¼€å§‹æ£€æŸ¥', triggerReason);
            const siteConfig = getSiteConfig();

            // æ£€æŸ¥ç«™ç‚¹æ˜¯å¦å·²ç»é…ç½®
            if (siteConfig.requireConfiguration && !siteConfig.isDefaultConfig) {
                console.log('è‡ªåŠ¨æ›´æ–°: éœ€è¦å…ˆé…ç½®ç½‘ç«™è§„åˆ™');
                return;
            }

            // å‰ªè—æ¨¡å¼ä¸è¿›è¡Œè‡ªåŠ¨æ›´æ–°ï¼Œåªæ”¯æŒæ‰‹åŠ¨æ›´æ–°
            if (siteConfig.contentType === 'clip') {
                console.log('è‡ªåŠ¨æ›´æ–°: å‰ªè—æ¨¡å¼ä¸æ”¯æŒè‡ªåŠ¨æ›´æ–°ï¼Œéœ€è¦æ‰‹åŠ¨ç‚¹å‡»æ·»åŠ ');
                return;
            }

            // ä¸å†è·³è¿‡é¡µé¢åˆ·æ–°è§¦å‘ï¼Œå…è®¸ä»»ä½•æ—¶æœºæ‰§è¡Œè‡ªåŠ¨æ›´æ–°

            // æ£€æŸ¥APIé…ç½®æ˜¯å¦æœ‰æ•ˆ
            if (!NOTION_CONFIG.apiKey || !NOTION_CONFIG.databaseIds[siteConfig.contentType || 'comic']) {
                console.log('è‡ªåŠ¨æ›´æ–°: Notion APIé…ç½®æ— æ•ˆï¼Œè¯·å…ˆé…ç½®');
                return;
            }

            // æå–é¡µé¢æ•°æ®å’ŒæŸ¥è¯¢ç°æœ‰é¡µé¢å¯ä»¥å¹¶è¡Œå¤„ç†
            const sourceURL = window.location.href;
            window._existingNotionCoverUrl = '';

            const existingPageId = await checkExistingPage(sourceURL, siteConfig.contentType);

            if (!existingPageId) {
                console.log('è‡ªåŠ¨æ›´æ–°: Notionä¸­æ²¡æœ‰æ‰¾åˆ°å¯¹åº”é¡µé¢ï¼Œè·³è¿‡æ›´æ–°');
                return;
            }

            let existingData;
            if (updateCache.pageId === existingPageId && updateCache.data) {
                console.log('è‡ªåŠ¨æ›´æ–°: ä½¿ç”¨ç¼“å­˜çš„é¡µé¢æ•°æ®');
                existingData = updateCache.data;
            } else {
                existingData = await getNotionPageProperties(existingPageId);
                if (!existingData) {
                    console.log('è‡ªåŠ¨æ›´æ–°: æ— æ³•è·å–Notioné¡µé¢æ•°æ®');
                    return;
                }
                updateCache.pageId = existingPageId;
                updateCache.data = existingData;
            }

            window._existingNotionCoverUrl = existingData.coverUrl || '';

            const comicData = await extractComicData(siteConfig, true); // æ›´æ–°æ¨¡å¼


            // æ ¹æ®å†…å®¹ç±»å‹æ£€æŸ¥æ ‡é¢˜å­—æ®µ
            if (siteConfig.contentType === 'clip') {
                // å‰ªè—æ¨¡å¼æ£€æŸ¥æ ‡é¢˜å­—æ®µ
                if (!comicData.æ ‡é¢˜) {
                    console.log('è‡ªåŠ¨æ›´æ–°: æœªè·å–åˆ°æ ‡é¢˜ï¼Œè·³è¿‡æ›´æ–°');
                    return;
                }
            } else {
                // æ¼«ç”»/å°è¯´æ¨¡å¼æ£€æŸ¥ä¹¦åå­—æ®µ
                if (!comicData.ä¹¦å) {
                    console.log('è‡ªåŠ¨æ›´æ–°: æœªè·å–åˆ°ä¹¦åï¼Œè·³è¿‡æ›´æ–°');
                    return;
                }
            }

            // ä»…åœ¨æ ‡é¢˜/ä¹¦åæœªå˜åŒ–æ—¶å…è®¸æ›´æ–°ï¼Œé˜²æ­¢è¯¯æ›´æ–°ä¸¢å¤±æ•°æ®
            try {
                const existingTitle = cleanText(existingData.ä¹¦å || existingData.æ ‡é¢˜ || '');
                const newTitle = cleanText(comicData.ä¹¦å || comicData.æ ‡é¢˜ || '');
                if (existingTitle && newTitle && existingTitle !== newTitle) {
                    console.log(`è‡ªåŠ¨æ›´æ–°: è·³è¿‡ï¼Œæ ‡é¢˜/ä¹¦åä¸ä¸€è‡´ -> "${existingTitle}" vs "${newTitle}"`);
                    if (ENHANCED_AUTO_UPDATE_CONFIG.updateNotification) {
                        try { showNotification('è‡ªåŠ¨æ›´æ–°å·²è·³è¿‡ï¼šæ ‡é¢˜å˜åŒ–å¯èƒ½ä¸ºé¡µé¢åˆ é™¤æˆ–é‡å®šå‘', 'info'); } catch(_) {}
                    }
                    updateCache.timestamp = now;
                    return;
                }
            } catch (_) {}

            // æ¯”è¾ƒæ•°æ®æ˜¯å¦æœ‰å˜åŒ–ï¼ˆä¼ å…¥siteConfigä»¥æ£€æŸ¥é€‰æ‹©å™¨é…ç½®ï¼‰
            const hasChanges = compareDataForChanges(existingData, comicData, siteConfig);
            if (!hasChanges) {
                console.log('è‡ªåŠ¨æ›´æ–°: æ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œä»…æ›´æ–°æ£€æŸ¥æ—¶é—´æˆ³');
                updateCache.timestamp = now;
                try {
                    autoUpdateNoChangeStreak = Math.max(0, autoUpdateNoChangeStreak) + 1;
                    if (autoUpdateNoChangeStreak >= 3) {
                        const base = ENHANCED_AUTO_UPDATE_CONFIG.checkInterval;
                        const next = Math.min(base * 2, 30);
                        if (next !== currentPeriodicIntervalMinutes) {
                            currentPeriodicIntervalMinutes = next;
                            startPeriodicUpdateCheck(true);
                            console.log(`è‡ªåŠ¨æ›´æ–°: è¿ç»­æ— å˜åŒ–ï¼Œæš‚æ—¶å°†æ£€æµ‹é—´éš”è°ƒæ•´ä¸º ${next} åˆ†é’Ÿ`);
                        }
                    }
                } catch(_) {}
                return;
            }

            // æ£€æŸ¥æ–°æ•°æ®çš„å„ä¸ªå­—æ®µæ˜¯å¦ä¸ºç©ºï¼Œä¸æ›´æ–°ä¸ºç©ºçš„å­—æ®µ
            for (const field of ['ç®€ä»‹', 'ä½œè€…', 'åˆ«å', 'æœ€æ–°ç« èŠ‚', 'åœ°åŒº', 'ç±»å‹', 'æ›´æ–°çŠ¶æ€', 'è¿½æ›´', 'è‡ªå®šä¹‰æ ‡ç­¾']) {
                if (comicData[field] === '' && existingData[field] && existingData[field].trim() !== '') {
                    console.log(`è‡ªåŠ¨æ›´æ–°: æ–°æ•°æ®çš„ ${field} ä¸ºç©ºï¼Œä½†ç°æœ‰æ•°æ®ä¸ä¸ºç©ºï¼Œä¿ç•™ç°æœ‰æ•°æ®`);
                    comicData[field] = existingData[field];
                }
            }

            // æ›´æ–°é¡µé¢
            const result = await processUpdate(existingPageId, comicData, sourceURL, siteConfig.contentType, true, existingData);
            GM_setValue(`lastData_${window.location.href}`, JSON.stringify(comicData));

            console.log('è‡ªåŠ¨æ›´æ–°: æˆåŠŸæ›´æ–°é¡µé¢', result);
            try {
                autoUpdateNoChangeStreak = 0;
                const base = ENHANCED_AUTO_UPDATE_CONFIG.checkInterval;
                if (currentPeriodicIntervalMinutes !== base) {
                    currentPeriodicIntervalMinutes = base;
                    startPeriodicUpdateCheck(true);
                    console.log(`è‡ªåŠ¨æ›´æ–°: æ£€æµ‹åˆ°å˜åŒ–ï¼Œæ¢å¤æ£€æµ‹é—´éš”ä¸º ${base} åˆ†é’Ÿ`);
                }
            } catch(_) {}
        } catch (error) {
            console.error('è‡ªåŠ¨æ›´æ–°å¤±è´¥:', error);
        } finally {
            window._existingNotionCoverUrl = '';
            coverUploadTriggeredAutoUpdate = false;
            autoUpdateTriggeredByDataChange = false;
            isAutoUpdateRunning = false;
            try {
                await updateTagButtonStatus(true);
            } catch (_) {}
            if (pendingAutoUpdateReason) {
                const queuedReason = pendingAutoUpdateReason;
                pendingAutoUpdateReason = null;
                setTimeout(() => {
                    checkAndAutoUpdate(`pending-${queuedReason}`);
                }, 500);
            }
        }
    }

    // å¢å¼ºçš„å®šæœŸæ£€æŸ¥åŠŸèƒ½
    function startPeriodicUpdateCheck(forceRestart = false) {
        if (!ENHANCED_AUTO_UPDATE_CONFIG.enabled) {
            console.log('å¢å¼ºè‡ªåŠ¨æ›´æ–°: å·²ç¦ç”¨');
            if (autoUpdateIntervalTimer) {
                clearInterval(autoUpdateIntervalTimer);
                autoUpdateIntervalTimer = null;
            }
            return;
        }

        const intervalMinutes = currentPeriodicIntervalMinutes;
        const intervalMs = intervalMinutes * 60 * 1000;

        if (autoUpdateIntervalTimer && !forceRestart) {
            return;
        }

        if (autoUpdateIntervalTimer) {
            clearInterval(autoUpdateIntervalTimer);
            autoUpdateIntervalTimer = null;
        }

        console.log(`å¢å¼ºè‡ªåŠ¨æ›´æ–°: å¯åŠ¨å®šæœŸæ£€æŸ¥ï¼Œé—´éš” ${intervalMinutes} åˆ†é’Ÿ`);

        // è®¾ç½®å®šæœŸæ£€æŸ¥
        autoUpdateIntervalTimer = setInterval(async () => {
            try {
                console.log('å¢å¼ºè‡ªåŠ¨æ›´æ–°: æ‰§è¡Œå®šæœŸæ£€æŸ¥');
                await checkAndAutoUpdate('periodic');
            } catch (error) {
                console.error('å¢å¼ºè‡ªåŠ¨æ›´æ–°: å®šæœŸæ£€æŸ¥å¤±è´¥', error);
            }
        }, intervalMs);
    }

    // åˆå¹¶åçš„æ ‡ç­¾æŒ‰é’®åŠŸèƒ½
    let tagButton = null;
    let isPageExistsInNotion = false;
    let existingPageIdCache = null;
    let hasExistingTag = false; // é¡µé¢æ˜¯å¦å­˜åœ¨è¦æ·»åŠ çš„æ ‡ç­¾
    let __lastUpdateTagStatus = 0;
    let __updateTagStatusTimer = null;

    // é•¿æŒ‰ç›¸å…³å˜é‡
    let longPressTimer = null;
    let importLongPressTimer = null;
    let importLongPressCompletedAt = 0;
    let isImportLongPressing = false;
    let suppressImportClick = false;
    let isLongPressing = false;
    let tagTouchStartTime = 0;
    const LONG_PRESS_DURATION = 500; // é•¿æŒ‰æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

    // é˜²é‡å¤ç‚¹å‡»ç›¸å…³å˜é‡
    let isProcessingClick = false; // æ˜¯å¦æ­£åœ¨å¤„ç†ç‚¹å‡»
    let lastClickTime = 0; // ä¸Šæ¬¡ç‚¹å‡»æ—¶é—´
    const CLICK_DEBOUNCE_TIME = 200; // ç‚¹å‡»é˜²æŠ–æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰- å‡å°‘åˆ°200ms

    // é•¿æŒ‰äº‹ä»¶å¤„ç†å‡½æ•°
    function handleTagButtonMouseDown(e) {
        if (!isPageExistsInNotion) return;
        e.preventDefault();
        e.stopPropagation();

        longPressTimer = setTimeout(() => {
            isLongPressing = true; // è®¾ç½®é•¿æŒ‰æ ‡å¿—
            tagButton.classList.add('longpress-active');
            // é•¿æŒ‰æ—¶åˆ é™¤å¯¹åº”æ ‡ç­¾ï¼Œä¸åˆ é™¤é¡µé¢
            deleteTagFromNotionPage();
        }, LONG_PRESS_DURATION);
    }

    function handleTagButtonMouseUp(e) {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
            // å¦‚æœé•¿æŒ‰è¢«å–æ¶ˆï¼Œä»…é˜»æ­¢äº‹ä»¶å†’æ³¡ä»¥é¿å…æ‹–åŠ¨è¡Œä¸º
            e.stopPropagation();
        }
        tagButton.classList.remove('longpress-active');
        // å»¶è¿Ÿé‡ç½®é•¿æŒ‰æ ‡å¿—ï¼Œé˜²æ­¢ç‚¹å‡»äº‹ä»¶è§¦å‘
        setTimeout(() => {
            isLongPressing = false;
        }, 100);
    }

    function handleTagButtonTouchStart(e) {
        tagTouchStartTime = Date.now();
        e.preventDefault();
        e.stopPropagation();

        // ç«‹å³æ˜¾ç¤ºè§¦æ‘¸åé¦ˆ
        tagButton.style.transform = 'scale(0.95)';
        tagButton.style.opacity = '0.8';

        // åªæœ‰åœ¨é¡µé¢å­˜åœ¨æ—¶æ‰å¤„ç†é•¿æŒ‰
        if (isPageExistsInNotion) {
            longPressTimer = setTimeout(() => {
                isLongPressing = true;
                tagButton.classList.add('longpress-active');
                deleteTagFromNotionPage();
            }, LONG_PRESS_DURATION);
        }
    }

    async function handleTagButtonTouchEnd(e) {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }

        tagButton.classList.remove('longpress-active');

        // æ¢å¤æŒ‰é’®æ ·å¼
        tagButton.style.transform = '';
        tagButton.style.opacity = '';

        tagTouchStartTime = 0;

        e.preventDefault();
        try { e.stopPropagation(); } catch(_) {}

        // åªè¦æœªè§¦å‘é•¿æŒ‰ï¼Œå°±è§†ä¸ºå•æ¬¡è§¦æ‘¸ç‚¹å‡»ï¼Œäº¤ç»™ç‚¹å‡»é€»è¾‘ç»Ÿä¸€å¤„ç†
        if (!isLongPressing) {
            try {
                await handleTagButtonClick();
            } catch(_) {}
        }

        isLongPressing = false;
    }
    let customTagSettings = {
        title: GM_getValue('tag_dot_title', 'è‡ªå®šä¹‰æ ‡ç­¾'),
        tags: GM_getValue('tag_dot_tags', ''),
        propertyName: GM_getValue('tag_dot_property_name', 'è‡ªå®šä¹‰æ ‡ç­¾'),
        tagText: GM_getValue('tag_dot_tag_text', '')
    };

    // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦å­˜åœ¨äºNotionæ•°æ®åº“
    async function checkCurrentPageExists() {
        try {
            const sourceURL = window.location.href;
            const siteConfig = getSiteConfig();
            if (!NOTION_CONFIG.apiKey) {
                console.log('æ ‡ç­¾ç‚¹: Notion APIé…ç½®æ— æ•ˆï¼Œè¯·å…ˆé…ç½®');
                return false;
            }

            const ct = siteConfig.contentType || 'clip';
            let pageExists = false;

            if (ct === 'comic' || ct === 'novel') {
                if (NOTION_CONFIG.databaseIds[ct]) {
                    existingPageIdCache = await checkExistingPage(sourceURL, ct);
                    pageExists = !!existingPageIdCache;
                }
                hasExistingTag = false;
                if (pageExists) await checkExistingTag();
            } else if (ct === 'clip') {
                if (NOTION_CONFIG.databaseIds.clip) {
                    existingPageIdCache = await checkExistingPage(sourceURL, 'clip');
                    pageExists = !!existingPageIdCache;
                }
                if (!pageExists) {
                    const verifyHit = await checkInVerifyDatabase(sourceURL);
                    pageExists = !!verifyHit;
                    hasExistingTag = false;
                } else {
                    await checkExistingTag();
                }
            } else {
                const verifyHit = await checkInVerifyDatabase(sourceURL);
                pageExists = !!verifyHit;
                hasExistingTag = false;
            }

            return pageExists;
        } catch (error) {
            console.error('æ£€æŸ¥é¡µé¢æ˜¯å¦å­˜åœ¨å¤±è´¥:', error);
            existingPageIdCache = null;
            hasExistingTag = false;
            return false;
        }
    }

    // æ£€æŸ¥é¡µé¢æ˜¯å¦å·²æœ‰è¦æ·»åŠ çš„æ ‡ç­¾ï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½ä»Notionè·å–æœ€æ–°æ•°æ®ï¼‰
    async function checkExistingTag() {
        try {
            if (!existingPageIdCache) {
                hasExistingTag = false;
                return;
            }

            const savedPropertyName = GM_getValue('tagPropertyName', GM_getValue('tag_dot_property_name', null));
            const savedTagText = GM_getValue('tagContent', GM_getValue('tag_dot_tag_text', null));

            if (!savedPropertyName || !savedTagText) {
                hasExistingTag = false;
                return;
            }

            const pageInfo = await sendNotionRequest("GET", `https://api.notion.com/v1/pages/${existingPageIdCache}`);

            if (pageInfo && pageInfo.properties && pageInfo.properties[savedPropertyName]) {
                const property = pageInfo.properties[savedPropertyName];

                if (property.type === 'multi_select' && property.multi_select) {
                    hasExistingTag = property.multi_select.some(option => option.name === savedTagText);
                } else if (property.type === 'select' && property.select) {
                    hasExistingTag = property.select.name === savedTagText;
                } else if (property.type === 'rich_text' && property.rich_text) {
                    const textContent = property.rich_text.map(rt => rt.plain_text).join('');
                    hasExistingTag = textContent.includes(savedTagText);
                } else {
                    hasExistingTag = false;
                }
            } else {
                hasExistingTag = false;
            }
        } catch (error) {
            console.error('æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨å¤±è´¥:', error);
            hasExistingTag = false;
        }
    }

    // ä»Notionæ•°æ®åº“ä¸­åˆ é™¤å½“å‰é¡µé¢
    async function deletePageFromNotion() {
        try {
            const sourceURL = window.location.href;
            const verifyId = GM_getValue('notion_verify_database_id', '');
            let verifyHit = null;
            let mappedPageId = null;

            if (verifyId) {
                verifyHit = await checkInVerifyDatabase(sourceURL);
                if (verifyHit) {
                    const verifyPage = await sendNotionRequest("GET", `https://api.notion.com/v1/pages/${verifyHit}`);
                    const props = (verifyPage && verifyPage.properties) || {};
                    const mapProp = props['æ˜ å°„'];
                    const mapKey = mapProp && mapProp.select && mapProp.select.name ? String(mapProp.select.name) : '';
                    if (mapKey) {
                        const mappedDbId = resolveDatabaseId(mapKey);
                        if (mappedDbId) {
                            mappedPageId = await queryPageInDatabaseByLink(mappedDbId, sourceURL);
                        }
                    }
                    if (!mappedPageId && existingPageIdCache) {
                        mappedPageId = existingPageIdCache;
                    }
                    const confirmCombined = await Swal.fire({
                        title: 'ç¡®è®¤åˆ é™¤',
                        html: '<div style="font-size: 15px; margin: 10px 0; color: #4B5563;">å°†ä»éªŒè¯æ•°æ®åº“ä¸æ˜ å°„æ•°æ®åº“åŒæ—¶åˆ é™¤å¯¹åº”è®°å½•</div>',
                        icon: 'warning',
                        iconColor: 'var(--primarycolor)',
                        showCancelButton: true,
                        confirmButtonColor: 'var(--primarycolor)',
                        cancelButtonColor: '#6B7280',
                        confirmButtonText: '<span style="font-weight: 500; padding: 0 5px;">åˆ é™¤</span>',
                        cancelButtonText: '<span style="font-weight: 500; padding: 0 5px;">å–æ¶ˆ</span>',
                        buttonsStyling: true,
                        customClass: { popup: 'swal-custom-popup', title: 'swal-custom-title', confirmButton: 'swal-custom-confirm', cancelButton: 'swal-custom-cancel' },
                        backdrop: `rgba(15, 23, 42, 0.4)`,
                        showClass: { popup: 'animate__animated animate__fadeIn animate__faster' },
                        hideClass: { popup: 'animate__animated animate__fadeOut animate__faster' }
                    });
                    if (!confirmCombined.isConfirmed) {
                        return false;
                    }
                    try {
                        await sendNotionRequest("PATCH", `https://api.notion.com/v1/pages/${verifyHit}`, { archived: true });
                        if (mappedPageId) {
                            await sendNotionRequest("PATCH", `https://api.notion.com/v1/pages/${mappedPageId}`, { archived: true });
                        }
                        showNotification('å·²åˆ é™¤éªŒè¯åº“ä¸æ˜ å°„åº“è®°å½•', 'success');
                        existingPageIdCache = null;
                        isPageExistsInNotion = false;
                        hasExistingTag = false;
                        updateButtonIcon();
                        try { invalidateExistingPageCache(sourceURL); } catch (_) {}
                        return true;
                    } catch (err) {
                        console.error('åˆ é™¤éªŒè¯/æ˜ å°„è®°å½•å¤±è´¥:', err);
                        showNotification('åˆ é™¤éªŒè¯/æ˜ å°„è®°å½•å¤±è´¥', 'error');
                        return false;
                    }
                }
            }

            if (!existingPageIdCache) {
                await updateTagButtonStatus();
                if (!existingPageIdCache) {
                    if (!verifyId) {
                        showNotification('æ­¤é¡µé¢ä¸å­˜åœ¨äºé»˜è®¤æ•°æ®åº“', 'warning');
                    } else {
                        showNotification('éªŒè¯æ•°æ®åº“æœªæ‰¾åˆ°è¯¥é¡µé¢', 'warning');
                    }
                    return false;
                }
            }

            const result = await Swal.fire({
                title: 'ç¡®è®¤åˆ é™¤',
                html: '<div style="font-size: 15px; margin: 10px 0; color: #4B5563;">ç¡®å®šè¦ä»Notionæ•°æ®åº“ä¸­åˆ é™¤æ­¤é¡µé¢å—ï¼Ÿ</div><div style="font-size: 13px; color: #9CA3AF; margin-top: 5px;">æ­¤æ“ä½œå°†ä¼šå°†é¡µé¢å­˜æ¡£ï¼Œæ— æ³•ç›´æ¥æ¢å¤ã€‚</div>',
                icon: 'warning',
                iconColor: 'var(--primarycolor)',
                showCancelButton: true,
                confirmButtonColor: 'var(--primarycolor)',
                cancelButtonColor: '#6B7280',
                confirmButtonText: '<span style="font-weight: 500; padding: 0 5px;">åˆ é™¤</span>',
                cancelButtonText: '<span style="font-weight: 500; padding: 0 5px;">å–æ¶ˆ</span>',
                buttonsStyling: true,
                customClass: {
                    popup: 'swal-custom-popup',
                    title: 'swal-custom-title',
                    confirmButton: 'swal-custom-confirm',
                    cancelButton: 'swal-custom-cancel'
                },
                backdrop: `rgba(15, 23, 42, 0.4)`,
                showClass: {
                    popup: 'animate__animated animate__fadeIn animate__faster'
                },
                hideClass: {
                    popup: 'animate__animated animate__fadeOut animate__faster'
                }
            });

            if (!result.isConfirmed) {
                return false;
            }

            console.log('åˆ é™¤é¡µé¢:', existingPageIdCache);

            try {
                const pageInfo = await sendNotionRequest("GET", `https://api.notion.com/v1/pages/${existingPageIdCache}`);

                await sendNotionRequest("PATCH", `https://api.notion.com/v1/pages/${existingPageIdCache}`, {
                    archived: true
                });

                showNotification('é¡µé¢å·²ä»Notionæ•°æ®åº“ä¸­åˆ é™¤', 'success');

                existingPageIdCache = null;
                isPageExistsInNotion = false;
                hasExistingTag = false;
                updateButtonIcon();
                try { invalidateExistingPageCache(sourceURL); } catch (_) {}

                return true;
            } catch (error) {
                console.error('åˆ é™¤é¡µé¢å¤±è´¥:', error);
                if (error.status === 403) {
                    showNotification('åˆ é™¤é¡µé¢å¤±è´¥ï¼šæƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥Notion APIæƒé™è®¾ç½®', 'error');
                } else {
                    showNotification('åˆ é™¤é¡µé¢å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
                return false;
            }
        } catch (error) {
            console.error('åˆ é™¤æ“ä½œå¤±è´¥:', error);
            showNotification('åˆ é™¤æ“ä½œå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            return false;
        }
    }

    async function queryPageInDatabaseByLink(databaseId, url) {
        try {
            const dbInfo = await getDatabaseInfo(databaseId);
            let propName = null;
            let filterType = 'rich_text';
            if (dbInfo && dbInfo.properties) {
                for (const [name, def] of Object.entries(dbInfo.properties)) {
                    if (def && def.type === 'url') { propName = name; filterType = 'url'; break; }
                }
                if (!propName) {
                    for (const [name, def] of Object.entries(dbInfo.properties)) {
                        if (def && def.type === 'rich_text') { propName = name; filterType = 'rich_text'; break; }
                    }
                }
            }
            const candidates = [propName, 'é“¾æ¥', 'URL', 'Link', 'é“¾æ¥åœ°å€'].filter(Boolean);
            for (const p of candidates) {
                const query = { filter: { property: p, [filterType]: { equals: url } } };
                const res = await new Promise((resolve) => {
                    GM_xmlhttpRequest({
                        method: "POST",
                        url: `https://api.notion.com/v1/databases/${databaseId}/query`,
                        headers: { "Authorization": `Bearer ${NOTION_CONFIG.apiKey}`, "Content-Type": "application/json", "Notion-Version": "2022-06-28" },
                        data: JSON.stringify(query),
                        onload: function(response) {
                            if (response.status >= 200 && response.status < 300) {
                                try { resolve(JSON.parse(response.responseText)); } catch(_) { resolve({ results: [] }); }
                            } else { resolve({ results: [] }); }
                        },
                        onerror: function() { resolve({ results: [] }); }
                    });
                });
                const first = res && Array.isArray(res.results) && res.results[0];
                if (first && first.id) return first.id;
            }
            return null;
        } catch (_) { return null; }
    }

    async function deleteTagFromNotionPage() {
        try {
            if (!existingPageIdCache) {
                const sourceURL = window.location.href;
                const verifyId = GM_getValue('notion_verify_database_id', '');
                if (verifyId) {
                    const verifyHit = await checkInVerifyDatabase(sourceURL);
                    if (verifyHit) { showNotification('è¯¥æ¨¡å¼ä¸æ”¯æŒæ·»åŠ æ ‡ç­¾', 'info'); return false; }
                }
                showNotification('æ­¤é¡µé¢ä¸å­˜åœ¨äºNotionæ•°æ®åº“ä¸­', 'warning');
                return false;
            }
            const savedPropertyName = GM_getValue('tagPropertyName', GM_getValue('tag_dot_property_name', null));
            const savedTagText = GM_getValue('tagContent', GM_getValue('tag_dot_tag_text', null));
            const propName = savedPropertyName || 'è‡ªå®šä¹‰æ ‡ç­¾';
            const tagText = savedTagText || '';
            if (!tagText) { showNotification('æœªé…ç½®æ ‡ç­¾æ–‡æœ¬', 'warning'); return false; }
            const props = await getNotionPageRawProperties(existingPageIdCache);
            const currentProp = props && props[propName];
            if (!currentProp) { showNotification('é¡µé¢æ— è¯¥æ ‡ç­¾å±æ€§', 'warning'); return false; }
            let update = null;
            if (currentProp.type === 'multi_select') {
                const items = Array.isArray(currentProp.multi_select) ? currentProp.multi_select : [];
                const filtered = items.filter(it => it && it.name !== tagText);
                update = { [propName]: { multi_select: filtered } };
            } else if (currentProp.type === 'select') {
                const isSame = currentProp.select && currentProp.select.name === tagText;
                update = { [propName]: { select: isSame ? null : currentProp.select } };
            } else if (currentProp.type === 'rich_text') {
                const text = (currentProp.rich_text && currentProp.rich_text.map(x => x.plain_text).join('')) || '';
                const newText = text.replace(new RegExp(tagText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), '').trim();
                update = { [propName]: { rich_text: newText ? [{ type: 'text', text: { content: newText } }] : [] } };
            } else {
                showNotification('ä¸æ”¯æŒçš„æ ‡ç­¾å±æ€§ç±»å‹', 'error');
                return false;
            }
            await sendNotionRequest('PATCH', `https://api.notion.com/v1/pages/${existingPageIdCache}`, { properties: update });
            showNotification('å·²åˆ é™¤æ ‡ç­¾', 'success');
            hasExistingTag = false;
            updateButtonIcon();
            return true;
        } catch (e) {
            console.error('åˆ é™¤æ ‡ç­¾å¤±è´¥', e);
            showNotification('åˆ é™¤æ ‡ç­¾å¤±è´¥', 'error');
            return false;
        }
    }

    // åº”ç”¨è‡ªå®šä¹‰æ ·å¼
    function applyCustomStyles() {
        // åŠ¨æ€è¯»å–æœ€æ–°é…ç½®
        const enabled = GM_getValue('custom_style_enabled', false);
        const borderRadius = GM_getValue('custom_border_radius', '12px');
        const fontSize = GM_getValue('custom_font_size', '14px');
        const fontFamily = GM_getValue('custom_font_family', 'system-ui, -apple-system, sans-serif');

        if (!enabled) {
            return;
        }

        const styleId = 'notion-clipper-custom-styles';
        let styleElement = document.getElementById(styleId);

        if (!styleElement) {
            styleElement = document.createElement('style');
            styleElement.id = styleId;
            styleElement.className = 'notion-clipper-custom-styles';
            document.head.appendChild(styleElement);
        }


        // ä¸ºæ™®é€šè‡ªå®šä¹‰æ ·å¼æ·»åŠ æ ‡è®°
        if (enabled) {
            document.documentElement.setAttribute('data-custom-style', '1');
        } else {
            document.documentElement.removeAttribute('data-custom-style');
        }

        const customCSS = `
            /* è‡ªå®šä¹‰æ ·å¼å˜é‡ */
            :root {
                /* å…¼å®¹æ—§å­—æ®µï¼Œä¿ç•™ç»™å…¶å®ƒåœ°æ–¹ä½¿ç”¨ */
                --notion-primarycolor-color: ${CUSTOM_STYLE_CONFIG.primarycolor};
                --notion-secondary-color: ${CUSTOM_STYLE_CONFIG.secondaryColor};
                --notion-background-color: ${CUSTOM_STYLE_CONFIG.backgroundColor};
                --notion-text-color: ${CUSTOM_STYLE_CONFIG.textColor};
                /* ç”¨ä¸»é¢˜å››å˜é‡é©±åŠ¨æ¸å˜ä¸UIè‰² */
                --primarycolor: ${GM_getValue('custom_primarycolor', getComputedStyle(document.documentElement).getPropertyValue('--primarycolor') || '#FF6B9D')};
                --primarycolor-dark: ${GM_getValue('custom_primarycolor_dark', getComputedStyle(document.documentElement).getPropertyValue('--primarycolor-dark') || '#FF8FAB')};
                --primarycolor-light: ${GM_getValue('custom_primarycolor_light', getComputedStyle(document.documentElement).getPropertyValue('--primarycolor-light') || lightenColor(GM_getValue('custom_primarycolor', getComputedStyle(document.documentElement).getPropertyValue('--primarycolor') || '#FF6B9D'), 25))};
                --primarycolor-lighter: ${GM_getValue('custom_primarycolor_lighter', getComputedStyle(document.documentElement).getPropertyValue('--primarycolor-lighter') || lightenColor(GM_getValue('custom_primarycolor', getComputedStyle(document.documentElement).getPropertyValue('--primarycolor') || '#FF6B9D'), 80))};
                --notion-border-radius: ${borderRadius};
                --notion-font-size: ${fontSize};
                --notion-font-family: ${fontFamily};
            }


            }

            /* å¼ºåˆ¶åº”ç”¨åœ†è§’å’Œå­—ä½“æ ·å¼åˆ°æ‰€æœ‰ç›¸å…³å…ƒç´  - ä½¿ç”¨æ›´é«˜ä¼˜å…ˆçº§ */
            [data-custom-style="1"] #import-to-notion-btn,
            [data-custom-style="1"] #config-site-btn,
            [data-custom-style="1"] #append-content-btn,
            [data-custom-style="1"] #config-dialog,
            [data-custom-style="1"] #config-dialog input,
            [data-custom-style="1"] #config-dialog select,
            [data-custom-style="1"] #config-dialog textarea,
            [data-custom-style="1"] #config-dialog button,

            [data-custom-style="1"] .dialog-btn,
            [data-custom-style="1"] .dialog-btn-primarycolor,
            [data-custom-style="1"] .selector-picker-btn,
            [data-custom-style="1"] .selector-test-btn,
            [data-custom-style="1"] .filter-btn
            {
                border-radius: var(--notion-border-radius) !important;
                font-family: var(--notion-font-family) !important;
                font-size: var(--notion-font-size) !important;
            }

            /* é…ç½®å¯¹è¯æ¡†æ ·å¼ */
            [data-custom-style="1"] #config-dialog {
                background: rgba(255,255,255,0.6);
                color: var(--notion-text-color) !important;
                border-radius: var(--notion-border-radius) !important;
                font-family: var(--notion-font-family) !important;
                font-size: var(--notion-font-size) !important;
            }

            /* è¾“å…¥æ¡†æ ·å¼ */
            [data-custom-style="1"] #config-dialog input,
            [data-custom-style="1"] #config-dialog select,
            [data-custom-style="1"] #config-dialog textarea {
                background: rgba(255,255,255,0.4) !important;
                color: var(--notion-text-color) !important;
                border-radius: var(--notion-border-radius) !important;
                font-family: var(--notion-font-family) !important;
                font-size: var(--notion-font-size) !important;
            }



            /* ç»Ÿä¸€æŒ‰é’®ç±»ï¼ˆå¯¹è¯æ¡†å¤–ï¼‰ */
            [data-custom-style="1"] .dialog-btn,
            [data-custom-style="1"] .dialog-btn-primarycolor,
            [data-custom-style="1"] .selector-picker-btn,
            [data-custom-style="1"] .selector-test-btn,
            [data-custom-style="1"] .filter-btn,
            [data-custom-style="1"] .buttons-row button {
                box-shadow: 0 6px 14px var(--box-shadow-color, rgba(0,0,0,.15)) !important;
                font-family: var(--notion-font-family) !important;
                font-size: var(--notion-font-size) !important;
            }

            [data-custom-style="1"] .dialog-btn-primarycolor,
            [data-custom-style="1"] .selector-picker-btn,
            {color: var(--theme-text-color)}

            /* é€šçŸ¥æ ·å¼ */
            [data-custom-style="1"] .custom-notification {
                background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)) !important;
                color: white !important;
                border-radius: var(--notion-border-radius) !important;
                font-family: var(--notion-font-family) !important;
                font-size: var(--notion-font-size) !important;
                box-shadow: 0 6px 10px var(--box-shadow-color, rgba(0,0,0,.02));
            }

            /* è¯„åˆ†ç»„ä»¶æ ·å¼ */
            [data-custom-style="1"] .rating-component {
                font-family: var(--notion-font-family) !important;
                font-size: var(--notion-font-size) !important;
            }

            [data-custom-style="1"] .rating-component .star {
                color: var(--notion-primarycolor-color) !important;
            }



        `;

        styleElement.textContent = customCSS;
    }
    // åˆ›å»ºè‡ªå®šä¹‰æ ·å¼é…ç½®å¯¹è¯æ¡†
    function showCustomStyleDialog() {
        try {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
            position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 10000;
            display:flex; align-items:center; justify-content:center;`;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
            background: #fff; border-radius: 20px; width: 92%; max-width: 640px;
            padding: 22px; max-height: 82vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.08);`;
            dialog.className = 'notion-style-dialog';

            const title = document.createElement('h3');
            title.textContent = 'ğŸ’– è‡ªå®šä¹‰æ ·å¼';
            title.style.cssText = 'margin: 0 0 14px 0; font-size: 20px; font-weight:800; text-align: center; letter-spacing:.3px; background:linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;';

            // å¯ç”¨å¼€å…³
            const enableContainer = createCustomCheckbox(
                'custom-style-enabled',
                CUSTOM_STYLE_CONFIG.enabled,
                'å¯ç”¨è‡ªå®šä¹‰æ ·å¼'
            );

            // è°ƒæ•´å¼€å…³é—´è·
            enableContainer.style.marginBottom = '8px';

            // é¢œè‰²é€‰æ‹©å™¨
            // å°†é¢œè‰²è®¾ç½®è°ƒæ•´ä¸ºå››ä¸ªä¸»é¢˜å˜é‡ï¼š--primarycolor / --primarycolor-dark / --primarycolor-light / --primarycolor-lighter
            const colorInputs = [
                { key: 'primarycolor', label: 'ä¸»è‰²', value: GM_getValue('custom_primarycolor', GM_getValue('theme_preset')?.primarycolor || '#FF6B9D') },
                { key: 'primarycolor-dark', label: 'æ¬¡è‰²', value: GM_getValue('custom_primarycolor_dark', GM_getValue('theme_preset')?.dark || '#FF8FAB') },
                { key: 'primarycolor-light', label: 'æµ…è‰²', value: GM_getValue('custom_primarycolor_light', GM_getValue('theme_preset')?.light || GM_getValue('theme_preset')?.primarycolor || '#FFD1E1') },
                { key: 'primarycolor-lighter', label: 'æ›´æµ…', value: GM_getValue('custom_primarycolor_lighter', GM_getValue('theme_preset')?.lighter || GM_getValue('theme_preset')?.primarycolor || '#FFE6EF') }
            ];

            const colorContainer = document.createElement('div');
            colorContainer.style.cssText = 'margin: 12px 0 14px 0; padding: 14px; border: 1px solid var(--primarycolor-light, #ffe0ea); border-radius: 14px; background: linear-gradient(135deg, var(--primarycolor-lighter, #FFF5F8), var(--primarycolor-light, #FFE8F0)); box-shadow: 0 6px 16px rgba(255,107,157,.15)';

            // æ¨ªå‘æ’ç‰ˆï¼ˆå››åˆ—ï¼‰ï¼Œå¸¦å¯çˆ±é£æ ¼æŒ‰é’®ä¸å–è‰²æ¡†
            const colorGrid = document.createElement('div');
            colorGrid.style.cssText = 'display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; align-items:start;';
            // ç§»åŠ¨ç«¯ä¸¤åˆ—
            if (window.innerWidth <= 768) {
                colorGrid.style.gridTemplateColumns = 'repeat(2, minmax(0,1fr))';
            }
            window.addEventListener('resize', () => {
                if (window.innerWidth <= 768) {
                    colorGrid.style.gridTemplateColumns = 'repeat(2, minmax(0,1fr))';
                } else {
                    colorGrid.style.gridTemplateColumns = 'repeat(4, minmax(0,1fr))';
                }
            });
            colorContainer.appendChild(colorGrid);

            colorInputs.forEach(({ key, label, value }) => {
                const card = document.createElement('div');
                card.style.cssText = 'display:flex; flex-direction:column; gap:8px; padding:10px; border-radius: 20px; background:#fff; border:1px solid var(--primarycolor-light, #ffd6e5); box-shadow: 0 2px 8px rgba(255,143,171,.18)';

                const labelRow = document.createElement('div');
                labelRow.style.cssText = 'display:flex; align-items:center; justify-content:space-between; gap:8px;';
                const labelEl = document.createElement('label');
                labelEl.textContent = label;
                labelEl.style.cssText = 'font-size: 13px; font-weight:600; color: var(--primarycolor-dark, #FF6B9D);';
                const swatch = document.createElement('div');
                swatch.style.cssText = `width:24px; height:24px; border-radius:6px; border:1px solid var(--primarycolor-light, #ffd6e5); background:${value}; box-shadow: inset 0 0 0 2px rgba(255,255,255,.6)`;
                labelRow.appendChild(labelEl);
                labelRow.appendChild(swatch);

                const pickRow = document.createElement('div');
                pickRow.style.cssText = 'display:flex; align-items:center; gap:8px; width:100%; box-sizing:border-box; overflow:hidden;';
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = value;
                colorInput.id = `custom-${key}`;
                colorInput.style.cssText = 'width:46px; height:34px; border:none; border-radius: 20px; background:transparent; box-shadow: 0 1px 3px rgba(0,0,0,.06)';
                const alphaInput = document.createElement('input');
                alphaInput.type = 'range';
                alphaInput.min = '0';
                alphaInput.max = '100';
                alphaInput.value = String(GM_getValue(`custom_${key.replace(/-/g,'_')}_alpha`, 100));
                alphaInput.id = `custom-${key}-alpha`;
                alphaInput.className = 'alpha-range';
                alphaInput.style.cssText = 'flex:1 1 auto; min-width:0; height:14px; accent-color:#FF6B9D; -webkit-appearance:none; appearance:none; background:transparent; outline:none; border:none;';
                const alphaText = document.createElement('span');
                alphaText.style.cssText = 'width:40px; text-align:right; font-size:12px; color:#9CA3AF;';
                alphaText.textContent = alphaInput.value + '%';
                alphaInput.oninput = () => { alphaText.textContent = alphaInput.value + '%'; updateSwatch(); };
                colorInput.oninput = () => updateSwatch();

                function updateSwatch(){ swatch.style.background = colorInput.value; swatch.style.opacity = (parseInt(alphaInput.value)||100)/100; }
                updateSwatch();

                pickRow.appendChild(colorInput);
                pickRow.appendChild(alphaInput);
                pickRow.appendChild(alphaText);

                card.appendChild(labelRow);
                card.appendChild(pickRow);
                colorGrid.appendChild(card);
            });

            // å®æ—¶è”åŠ¨ï¼šå½“è°ƒæ•´ä¸»è‰²/æ¬¡è‰²/æµ…è‰²/æ›´æµ…æˆ–å…¶é€æ˜åº¦æ—¶ï¼ŒåŒæ­¥å…¨å±€å˜é‡ä¸ç›¸å…³UI
            (function setupLiveCustomColorBinding(){
                function hexToRgba(hex, alpha) {
                    if (!hex || typeof hex !== 'string') return hex;
                    const m = hex.trim().match(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/);
                    if (!m) return hex;
                    let r, g, b;
                    if (m[1].length === 3) {
                        r = parseInt(m[1][0] + m[1][0], 16);
                        g = parseInt(m[1][1] + m[1][1], 16);
                        b = parseInt(m[1][2] + m[1][2], 16);
                    } else {
                        r = parseInt(m[1].slice(0,2), 16);
                        g = parseInt(m[1].slice(2,4), 16);
                        b = parseInt(m[1].slice(4,6), 16);
                    }
                    const a = Math.max(0, Math.min(1, (typeof alpha === 'number' ? alpha : 1)));
                    return `rgba(${r}, ${g}, ${b}, ${a})`;
                }
                function getVal(id){ const el = document.getElementById(id); return el ? el.value : ''; }
                function getAlpha(id){ const el = document.getElementById(id); const v = el ? parseInt(el.value)||100 : 100; return v/100; }
                function applyLive(){
                    const p = getVal('custom-primarycolor');
                    const pd = getVal('custom-primarycolor-dark');
                    const pl = getVal('custom-primarycolor-light');
                    const pll = getVal('custom-primarycolor-lighter');
                    const ap = getAlpha('custom-primarycolor-alpha');
                    const apd = getAlpha('custom-primarycolor-dark-alpha');
                    const apl = getAlpha('custom-primarycolor-light-alpha');
                    const apll = getAlpha('custom-primarycolor-lighter-alpha');
                    // å†™å…¥CSSå˜é‡ï¼ˆåŒ…å«é€æ˜åº¦ï¼‰
                    try { document.documentElement.style.setProperty('--primarycolor', hexToRgba(p, ap)); } catch(_) {}
                    try { document.documentElement.style.setProperty('--primarycolor-dark', hexToRgba(pd, apd)); } catch(_) {}
                    try { document.documentElement.style.setProperty('--primarycolor-light', hexToRgba(pl, apl)); } catch(_) {}
                    try { document.documentElement.style.setProperty('--primarycolor-lighter', hexToRgba(pll, apll)); } catch(_) {}
                    try { GM_setValue('custom_colors_override_theme', true); } catch(_) {}
                    try { GM_setValue('custom_style_enabled', true); } catch(_) {}
                    // åŒæ­¥ä¸»è¦æŒ‰é’®ç­‰
                    const customOverride = true;
                    if (customOverride) {
                        const bg = `linear-gradient(135deg, ${hexToRgba(p, ap)}, ${hexToRgba(pd, apd)})`;
                        document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn, #config-dialog .dialog-btn, #config-dialog .selector-test-btn, #config-dialog .filter-btn, .dialog-btn, .selector-test-btn, .filter-btn, .buttons-row button').forEach(el => {
                            try { el.style.setProperty('background', bg, 'important'); } catch(_) { el.style.background = bg; }
                        });
                    } else {
                        // ç»ç’ƒæ¨¡å¼ä¸‹ç»´æŒç»ç’ƒå¤–è§‚ï¼Œä»…åŒæ­¥æ–‡å­—è‰²ç”±å…¶å®ƒåŠŸèƒ½æ§åˆ¶
                    }
                    // åŒæ­¥æ‰¹é‡æ“ä½œå‹¾é€‰æ¡†é£æ ¼ï¼ˆé˜´å½±ç”¨ä¸»è‰²çš„åŠé€æ˜ï¼‰
                    const shadow = (function(){
                        const m = (p||'').match(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/);
                        if (!m) return 'rgba(0,0,0,0.18)';
                        let r, g, b;
                        if (m[1].length === 3) { r = parseInt(m[1][0]+m[1][0],16); g = parseInt(m[1][1]+m[1][1],16); b = parseInt(m[1][2]+m[1][2],16);} else { r = parseInt(m[1].slice(0,2),16); g = parseInt(m[1].slice(2,4),16); b = parseInt(m[1].slice(4,6),16); }
                        return `rgba(${r}, ${g}, ${b}, 0.35)`;
                    })();
                    document.querySelectorAll('#config-dialog input[type="checkbox"], #batch-ops-dialog input[type="checkbox"]').forEach(chk => {
                        try { chk.style.setProperty('background', `linear-gradient(135deg, ${hexToRgba(pl||p, apl)}, ${hexToRgba(p, ap)})`); } catch(_) {}
                        try { chk.style.setProperty('border-color', p); } catch(_) {}
                        try { chk.style.setProperty('box-shadow', `inset 0 0 0 2px rgba(255,255,255,.9), 0 4px 10px ${shadow}`); } catch(_) {}
                    });
                    // åˆ·æ–°å³ä¸Šè§’å°é¢„è§ˆæ–¹å—
                    if (window.__refreshCustomColorSwatches) window.__refreshCustomColorSwatches();
                }
                window.__applyCustomColorsLive = applyLive;
                // ç»‘å®šå››ä¸ªé¢œè‰²ä¸é€æ˜åº¦è¾“å…¥
                ['primarycolor','primarycolor-dark','primarycolor-light','primarycolor-lighter'].forEach(k => {
                    const cid = `custom-${k}`; const aid = `custom-${k}-alpha`;
                    const ci = document.getElementById(cid); const ai = document.getElementById(aid);
                    if (ci) ci.addEventListener('input', applyLive);
                    if (ai) ai.addEventListener('input', applyLive);
                });
            })();

            // ä¸€é”®æ¢å¤é»˜è®¤é…è‰²ï¼ˆå«æ–‡å­—è‰²/é˜´å½±è‰²ï¼‰
            const colorsResetRow = document.createElement('div');
            colorsResetRow.style.cssText = 'display:flex; justify-content:flex-end; margin-top:8px;';
            const colorsResetBtn = document.createElement('button');
            colorsResetBtn.textContent = 'æ¢å¤é»˜è®¤é…è‰²ï¼ˆå«æ–‡å­—/é˜´å½±ï¼‰';
            colorsResetBtn.style.cssText = 'padding:6px 12px; border-radius:9999px; border:1px solid var(--primarycolor); background:#fff; color: var(--primarycolor); cursor:pointer; font-size:12px;';
            colorsResetBtn.onclick = () => {
                const defaults = { primarycolor: '#FF6B9D', dark: '#FF8FAB', light: '#FFD1E1', lighter: '#FFE6EF', text: '#FFFFFF', shadow: '#FFFFFF' };
                const ids = [
                    { id: 'custom-primarycolor', val: defaults.primarycolor, alpha: 'custom-primarycolor-alpha' },
                    { id: 'custom-primarycolor-dark', val: defaults.dark, alpha: 'custom-primarycolor-dark-alpha' },
                    { id: 'custom-primarycolor-light', val: defaults.light, alpha: 'custom-primarycolor-light-alpha' },
                    { id: 'custom-primarycolor-lighter', val: defaults.lighter, alpha: 'custom-primarycolor-lighter-alpha' }
                ];
                ids.forEach(({id, val, alpha}) => {
                    const el = document.getElementById(id);
                    const a = document.getElementById(alpha);
                    if (el) el.value = val;
                    if (a) a.value = '100';
                });
                const t = document.getElementById('custom-text-color2');
                const s = document.getElementById('custom-shadow-color');
                if (t) t.value = defaults.text;
                if (s) s.value = defaults.shadow;
                document.documentElement.style.setProperty('--primarycolor', defaults.primarycolor);
                document.documentElement.style.setProperty('--primarycolor-dark', defaults.dark);
                document.documentElement.style.setProperty('--primarycolor-light', defaults.light);
                document.documentElement.style.setProperty('--primarycolor-lighter', defaults.lighter);
                document.documentElement.style.setProperty('--theme-text-color', defaults.text);
                document.documentElement.style.setProperty('--box-shadow-color', defaults.shadow);
                try { GM_setValue('custom_colors_override_theme', true); } catch(_) {}
                // åˆ·æ–°é¢„è§ˆå°æ–¹å—ï¼Œå¹¶è§¦å‘å®æ—¶è”åŠ¨
                try { if (window.__refreshCustomColorSwatches) window.__refreshCustomColorSwatches(); } catch(_) {}
                try { if (window.__applyCustomColorsLive) window.__applyCustomColorsLive(); } catch(_) {}
                showNotification('å·²æ¢å¤é»˜è®¤é…è‰²ä¸æ–‡å­—/é˜´å½±', 'success');
            };
            colorsResetRow.appendChild(colorsResetBtn);
            colorContainer.appendChild(colorsResetRow);

            const gradientRow = document.createElement('div');
            gradientRow.style.cssText = 'display:flex; align-items:center; gap:8px; margin-top:8px;';
            const gradientLabel = document.createElement('span');
            gradientLabel.textContent = 'å½“å‰æ¸å˜';
            gradientLabel.style.cssText = 'font-size:12px; color:#6B7280;';
            const gradientValue = document.createElement('span');
            gradientValue.style.cssText = 'flex:1; min-width:0; font-size:11px; color:#9CA3AF; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;';
            const copyGradientBtn = document.createElement('button');
            copyGradientBtn.textContent = 'å¤åˆ¶å½“å‰æ¸å˜å€¼';
            copyGradientBtn.style.cssText = 'padding:6px 10px; border-radius:9999px; border:none; background:linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); color:#fff; cursor:pointer; font-size:11px; box-shadow:0 2px 8px rgba(0,0,0,0.12); flex-shrink:0;';
            const buildGradient = () => {
                function hexToRgbaLocal(hex, alpha) {
                    if (!hex || typeof hex !== 'string') return hex;
                    const m = hex.trim().match(/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/);
                    if (!m) return hex;
                    let r, g, b;
                    if (m[1].length === 3) {
                        r = parseInt(m[1][0] + m[1][0], 16);
                        g = parseInt(m[1][1] + m[1][1], 16);
                        b = parseInt(m[1][2] + m[1][2], 16);
                    } else {
                        r = parseInt(m[1].slice(0,2), 16);
                        g = parseInt(m[1].slice(2,4), 16);
                        b = parseInt(m[1].slice(4,6), 16);
                    }
                    const a = Math.max(0, Math.min(1, typeof alpha === 'number' ? alpha : 1));
                    return `rgba(${r}, ${g}, ${b}, ${a})`;
                }
                const pInput = document.getElementById('custom-primarycolor');
                const dInput = document.getElementById('custom-primarycolor-dark');
                const paInput = document.getElementById('custom-primarycolor-alpha');
                const daInput = document.getElementById('custom-primarycolor-dark-alpha');
                const p = pInput ? pInput.value : '#FF6B9D';
                const d = dInput ? dInput.value : p;
                const pa = paInput ? (parseInt(paInput.value || '100', 10) || 100) / 100 : 1;
                const da = daInput ? (parseInt(daInput.value || '100', 10) || 100) / 100 : 1;
                const c1 = hexToRgbaLocal(p, pa);
                const c2 = hexToRgbaLocal(d, da);
                return `linear-gradient(135deg, ${c1}, ${c2})`;
            };
            const updateGradientPreview = () => {
                const g = buildGradient();
                gradientValue.textContent = g;
            };
            copyGradientBtn.onclick = async () => {
                const g = buildGradient();
                try {
                    if (typeof GM_setClipboard === 'function') {
                        GM_setClipboard(g);
                    } else if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(g);
                    }
                    showNotification('å·²å¤åˆ¶æ¸å˜å€¼', 'success');
                } catch (e) {
                    try { showNotification('å¤åˆ¶å¤±è´¥: ' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯'), 'error'); } catch (_) {}
                }
            };
            ['primarycolor','primarycolor-dark'].forEach(k => {
                const cid = 'custom-' + k;
                const aid = 'custom-' + k + '-alpha';
                const ci = document.getElementById(cid);
                const ai = document.getElementById(aid);
                if (ci) ci.addEventListener('input', updateGradientPreview);
                if (ai) ai.addEventListener('input', updateGradientPreview);
            });
            updateGradientPreview();
            gradientRow.appendChild(gradientLabel);
            gradientRow.appendChild(gradientValue);
            gradientRow.appendChild(copyGradientBtn);
            colorContainer.appendChild(gradientRow);

            // æ³¨å…¥èŒƒå›´æ»‘å—çš„ç»Ÿä¸€ç²‰è‰²æ ·å¼ï¼Œé¿å…æµè§ˆå™¨é»˜è®¤é»‘è‰²æ¡
            (function ensureAlphaRangeStyles(){
                const id = 'alpha-range-pink-styles';
                if (document.getElementById(id)) return;
                const st = document.createElement('style');
                st.id = id;
                st.textContent = `
                .alpha-range{ height:14px; border-radius:9999px; background: linear-gradient(90deg,var(--primarycolor-lighter, #FFE4F1), var(--primarycolor, #FF8FAB)); }
                .alpha-range::-webkit-slider-runnable-track{ height:8px; border-radius:9999px; background: linear-gradient(90deg,var(--primarycolor-lighter, #FFE4F1), var(--primarycolor, #FF8FAB)); }
                .alpha-range::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:18px; height:18px; margin-top:-5px; border-radius:50%; background:var(--primarycolor-dark, #FF6B9D); border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.15); }
                .alpha-range::-moz-range-track{ height:8px; border-radius:9999px; background: linear-gradient(90deg,var(--primarycolor-lighter, #FFE4F1), var(--primarycolor, #FF8FAB)); }
                .alpha-range::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background:var(--primarycolor-dark, #FF6B9D); border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.15); }
            `;
                document.head.appendChild(st);
            })();

            // æä¾›ä¸€ä¸ªå…¨å±€çš„é¢„è§ˆåˆ·æ–°å‡½æ•°ï¼Œä¾›â€œä¸»é¢˜ä¸é…è‰²â€é€‰æ‹©æ¸å˜ååŒæ­¥å³ä¸Šè§’é¢„è§ˆå°æ–¹å—
            try {
                window.__refreshCustomColorSwatches = function () {
                    const map = [
                        { id: 'custom-primarycolor' },
                        { id: 'custom-primarycolor-dark' },
                        { id: 'custom-primarycolor-light' },
                        { id: 'custom-primarycolor-lighter' }
                    ];
                    map.forEach(({ id }) => {
                        const input = document.getElementById(id);
                        if (!input) return;
                        const alpha = document.getElementById(id + '-alpha');
                        // å°æ–¹å—åœ¨ card çš„ labelRow é‡Œï¼Œæ˜¯ pickRow çš„å‰ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹çš„æœ€åä¸€ä¸ªå­å…ƒç´ 
                        const pickRow = input.parentElement;
                        const labelRow = pickRow && pickRow.previousSibling;
                        const swatch = labelRow && labelRow.lastChild;
                        if (swatch && swatch.style) {
                            swatch.style.background = input.value;
                            const op = alpha ? (parseInt(alpha.value) || 100) / 100 : 1;
                            swatch.style.opacity = String(op);
                        }
                    });
                };
            } catch(_) {}

            // å…¶ä»–æ ·å¼è®¾ç½®å®¹å™¨
            const otherContainer = document.createElement('div');
            otherContainer.style.cssText = 'margin: 12px 0 14px 0;';

            // è¡¥å……ï¼šæ–‡å­—è‰²ä¸é˜´å½±è‰²ï¼ˆtext-color / box-shadowï¼‰
            const textShadowGroup = document.createElement('div');
            textShadowGroup.style.cssText = 'display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; margin: 10px 0;';
            const txtWrap = document.createElement('div');
            txtWrap.style.cssText = 'display:flex; flex-direction:column; gap:8px; padding:10px; border-radius: 20px; background:#fff; border:1px solid var(--primarycolor-light, #ffd6e5); box-shadow: 0 2px 8px rgba(255,143,171,.18)';
            const txtLabel = document.createElement('label'); txtLabel.textContent = 'æ–‡å­—è‰²ï¼ˆtext-colorï¼‰'; txtLabel.style.cssText = 'display:block; font-size: 13px; font-weight:600; margin-bottom:2px; color: var(--primarycolor, #FF6B9D);';
            const txtInput = document.createElement('input'); txtInput.type='color'; txtInput.value = GM_getValue('custom_text_color2', '#ffffff'); txtInput.id='custom-text-color2'; txtInput.style.cssText='width:54px; height:40px; border:none; border-radius: 20px; background:transparent; box-shadow: 0 1px 3px rgba(0,0,0,.06)';
            const txtHex = document.createElement('span'); txtHex.textContent = txtInput.value.toUpperCase(); txtHex.style.cssText='margin-left:8px; font-size:12px; color:#6B7280;';
            txtWrap.appendChild(txtLabel); txtWrap.appendChild(txtInput);
            const shadowWrap = document.createElement('div');
            shadowWrap.style.cssText = 'display:flex; flex-direction:column; gap:8px; padding:10px; border-radius: 20px; background:#fff; border:1px solid var(--primarycolor-light, #ffd6e5); box-shadow: 0 2px 8px rgba(255,143,171,.18)';
            const shLabel = document.createElement('label'); shLabel.textContent = 'é˜´å½±è‰²ï¼ˆbox-shadowï¼‰'; shLabel.style.cssText = 'display:block; font-size: 13px; font-weight:600; margin-bottom:2px; color: var(--primarycolor, #FF6B9D);';
            // è¯»å–å·²ä¿å­˜çš„é˜´å½±è‰²ï¼Œè¿ç§»æ—§é”™è¯¯é»˜è®¤å€¼ #290000 -> #ffffff
            let savedShadow = GM_getValue('custom_shadow_color', '#ffffff');
            if (typeof savedShadow === 'string' && savedShadow.toLowerCase() === '#290000') {
                savedShadow = '#ffffff';
                try { GM_setValue('custom_shadow_color', savedShadow); } catch(_) {}
            }
            const shInput = document.createElement('input'); shInput.type='color'; shInput.value = savedShadow; shInput.id='custom-shadow-color'; shInput.style.cssText='width:54px; height:40px; border:none; border-radius: 20px; background:transparent; box-shadow: 0 1px 3px rgba(0,0,0,.06)';
            const shHex = document.createElement('span'); shHex.textContent = shInput.value.toUpperCase(); shHex.style.cssText='margin-left:8px; font-size:12px; color:#6B7280;';
            shadowWrap.appendChild(shLabel); shadowWrap.appendChild(shInput);
            textShadowGroup.appendChild(txtWrap); textShadowGroup.appendChild(shadowWrap);
            // å³ä¾§åŠ ä¸€ä¸ªå°é¢„è§ˆå¾½ç« 
            const previewWrap = document.createElement('div');
            previewWrap.style.cssText = 'grid-column: 1 / -1; display:flex; justify-content:flex-start;';
            const textBadge = document.createElement('div');
            const star = document.createElement('span');
            star.textContent = 'âœ¦';
            star.style.cssText = 'font-size:16px;margin-right:6px;';
            const label = document.createTextNode('Aa å­—é¢„è§ˆ');
            textBadge.appendChild(star);
            textBadge.appendChild(label);
            textBadge.style.cssText = 'margin-top:8px; display:inline-flex; align-items:center; justify-content:center; padding:10px 16px; border-radius:9999px; font-weight:800; letter-spacing:.3px; background: linear-gradient(135deg, var(--primarycolor-lighter, #FFE4F1), var(--primarycolor, #FF6B9D)); border: 1px solid var(--primarycolor-light, #ffd6e5); color: var(--theme-text-color, #fff); box-shadow: 0 12px 26px var(--box-shadow-color, rgba(0,0,0,.18));';
            previewWrap.appendChild(textBadge);
            textShadowGroup.appendChild(previewWrap);

            // ä¿è¯å…¨å±€ä¸»é¢˜æ–‡å­—è‰²æ ·å¼å­˜åœ¨
            function ensureGlobalThemeTextStyle() {
                const id = 'theme-text-color-style';
                let tag = document.getElementById(id);
                if (!tag) { tag = document.createElement('style'); tag.id = id; document.head.appendChild(tag); }
                tag.textContent = `
                #config-dialog .dialog-btn-primarycolor,
                #config-dialog .selector-picker-btn,
                #config-dialog .selector-test-btn,
                .selector-picker-btn,
                .dialog-btn-primarycolor,
                .selector-test-btn,
                .buttons-row button,
                #batch-ops-dialog .btn-primarycolor { color: var(--theme-text-color, #ffffff); }
                #config-dialog .dialog-btn-primarycolor *,
                #config-dialog .selector-picker-btn *,
                #config-dialog .selector-test-btn *,
                .selector-picker-btn *,
                .dialog-btn-primarycolor *,
                .selector-test-btn *,
                .buttons-row button *,
                #batch-ops-dialog .btn-primarycolor * { color: var(--theme-text-color, #ffffff); }
            `;
            }

            // è¾“å…¥è”åŠ¨é¢„è§ˆä¸å˜é‡
            const applyPreviewVars = () => {
                const tc = txtInput.value || '#ffffff';
                const bs = shInput.value || '#000000';
                try { document.documentElement.style.setProperty('--theme-text-color', tc); } catch(_) {}
                try { document.documentElement.style.setProperty('--box-shadow-color', bs); } catch(_) {}
                textBadge.style.color = tc;
                textBadge.style.boxShadow = `0 8px 18px ${bs}`;
                txtHex.textContent = tc.toUpperCase();
                shHex.textContent = bs.toUpperCase();
                // å³æ—¶åº”ç”¨åˆ°ç•Œé¢ä¸»è¦æŒ‰é’®ç­‰ï¼ˆé¿å…è¢«å†å²å†…è”æ ·å¼è¦†ç›–ï¼‰
                ensureGlobalThemeTextStyle();
                document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn, #config-dialog .dialog-btn, #config-dialog .selector-test-btn, #config-dialog, .dialog-btn, .selector-test-btn, .filter-btn, .buttons-row button').forEach(el => {
                    try { el.style.setProperty('color', tc, 'important'); } catch(_) { el.style.color = tc; }
                });
            };
            txtInput.addEventListener('input', applyPreviewVars);
            shInput.addEventListener('input', applyPreviewVars);
            applyPreviewVars();

            // é™„åŠ HEXæ˜¾ç¤º
            const txtRow = document.createElement('div'); txtRow.style.cssText='display:flex; align-items:center; gap:8px; margin-top:4px;'; txtRow.appendChild(txtInput); txtRow.appendChild(txtHex);
            const shRow = document.createElement('div'); shRow.style.cssText='display:flex; align-items:center; gap:8px; margin-top:4px;'; shRow.appendChild(shInput); shRow.appendChild(shHex);
            txtWrap.appendChild(txtRow);
            shadowWrap.appendChild(shRow);

            // æ–‡å­—/é˜´å½±å•ç‹¬é‡ç½®å·²ç”±â€œæ¢å¤é»˜è®¤é…è‰²ï¼ˆå«æ–‡å­—/é˜´å½±ï¼‰â€è¦†ç›–

            otherContainer.appendChild(textShadowGroup);

            // åœ†è§’/å­—ä½“è®¾ç½®ï¼ˆå¯çˆ±é£ï¼‰
            const styleGroup = document.createElement('div');
            styleGroup.className = 'group-card';
            styleGroup.style.cssText = 'background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%); border: 1px solid #E5E7EB; border-radius: 20px; padding: 14px; margin-bottom: 14px;';
            const styleTitle = document.createElement('h4'); styleTitle.textContent = 'åœ†è§’ä¸å­—ä½“'; styleTitle.style.cssText = 'margin:0 0 8px 0; font-size:14px; color:#111827;';
            const brRow = document.createElement('div'); brRow.style.cssText = 'display:flex; align-items:center; gap:10px; margin-top:6px;';
            const brLabel = document.createElement('label'); brLabel.textContent = 'åœ†è§’å¤§å°'; brLabel.style.cssText = 'min-width:80px; font-size:13px;';
            const brInput = document.createElement('input'); brInput.type='text'; brInput.value = GM_getValue('custom_border_radius', CUSTOM_STYLE_CONFIG.borderRadius); brInput.id='custom-border-radius'; brInput.placeholder='å¦‚ 12px / 14px'; brInput.style.cssText = 'flex:1; padding:8px 10px; border:1px solid #e5e7eb; border-radius: 20px; background:#fff;';
            brRow.appendChild(brLabel); brRow.appendChild(brInput);
            const fsRow = document.createElement('div'); fsRow.style.cssText = 'display:flex; align-items:center; gap:10px; margin-top:6px;';
            const fsLabel = document.createElement('label'); fsLabel.textContent = 'å­—ä½“å¤§å°'; fsLabel.style.cssText = 'min-width:80px; font-size:13px;';
            const fsInput = document.createElement('input'); fsInput.type='text'; fsInput.value = GM_getValue('custom_font_size', CUSTOM_STYLE_CONFIG.fontSize); fsInput.id='custom-font-size'; fsInput.placeholder='å¦‚ 14px / 15px'; fsInput.style.cssText = 'flex:1; padding:8px 10px; border:1px solid #e5e7eb; border-radius: 20px; background:#fff;';
            fsRow.appendChild(fsLabel); fsRow.appendChild(fsInput);
            const ffRow = document.createElement('div'); ffRow.style.cssText = 'display:flex; align-items:center; gap:10px; margin-top:6px;';
            const ffLabel = document.createElement('label'); ffLabel.textContent = 'å­—ä½“'; ffLabel.style.cssText = 'min-width:80px; font-size:13px;';
            const ffInput = document.createElement('input'); ffInput.type='text'; ffInput.value = GM_getValue('custom_font_family', CUSTOM_STYLE_CONFIG.fontFamily); ffInput.id='custom-font-family'; ffInput.placeholder='å¦‚ system-ui, -apple-system, sans-serif'; ffInput.style.cssText = 'flex:1; padding:8px 10px; border:1px solid #e5e7eb; border-radius: 20px; background:#fff;';
            ffRow.appendChild(ffLabel); ffRow.appendChild(ffInput);
            styleGroup.appendChild(styleTitle); styleGroup.appendChild(brRow); styleGroup.appendChild(fsRow); styleGroup.appendChild(ffRow);
            otherContainer.appendChild(styleGroup);

            // å®æ—¶é¢„è§ˆï¼šæ”¹å˜åœ†è§’/å­—ä½“ç«‹å³åº”ç”¨
            function applyTypoPreview() {
                const br = document.getElementById('custom-border-radius')?.value || CUSTOM_STYLE_CONFIG.borderRadius;
                const fs = document.getElementById('custom-font-size')?.value || CUSTOM_STYLE_CONFIG.fontSize;
                const ff = document.getElementById('custom-font-family')?.value || CUSTOM_STYLE_CONFIG.fontFamily;
                document.documentElement.style.setProperty('--notion-border-radius', br);
                document.documentElement.style.setProperty('--notion-font-size', fs);
                document.documentElement.style.setProperty('--notion-font-family', ff);
            }
            brInput.addEventListener('input', applyTypoPreview);
            fsInput.addEventListener('input', applyTypoPreview);
            ffInput.addEventListener('input', applyTypoPreview);
            applyTypoPreview();

            // å¯çˆ±æ–‡å­—é¢„è§ˆ
            const previewCard = document.createElement('div');
            previewCard.style.cssText = `
            margin: 8px 0 6px 0; padding: 14px; border-radius: 14px; background: #ffffff; border: 1px solid #e5e7eb; box-shadow: 0 4px 10px rgba(0,0,0,0.04);`;
            const pvTitle = document.createElement('div');
            pvTitle.textContent = 'ğŸŒˆ è¿™æ˜¯ä¸€æ®µæ ‡é¢˜ ABC 123';
            pvTitle.style.cssText = 'font-size: 18px; font-weight: 700; color:#111827; letter-spacing:.2px; margin-bottom: 6px;';
            const pvSubtitle = document.createElement('div');
            pvSubtitle.textContent = 'å¯çˆ±å‰¯æ ‡é¢˜ Â· Cute subtitle';
            pvSubtitle.style.cssText = 'font-size: 14px; color:#6b7280; margin-bottom: 8px;';
            const pvPara = document.createElement('div');
            pvPara.textContent = 'åœ¨è¿™é‡Œé¢„è§ˆæ–‡å­—çš„å¯è¯»æ€§ã€é€æ˜åº¦ä¸å±‚æ¬¡ã€‚Hello, ä½ å¥½ ~';
            pvPara.style.cssText = 'font-size: 14px; color:#334155; line-height:1.6;';
            const pvChips = document.createElement('div');
            pvChips.style.cssText = 'display:flex; gap:6px; flex-wrap: wrap; margin-top:10px;';
            const chipTexts = ['âœ¨ ç²¾è‡´', 'ğŸ“ å¯çˆ±', 'ğŸ’– ç»†è…»'];
            chipTexts.forEach(t => {
                const chip = document.createElement('span');
                chip.textContent = t;
                chip.style.cssText = `
                padding:4px 8px; border-radius:9999px; font-size:12px; color:#374151; background:#F3F4F6; border:1px solid #E5E7EB;`;
                pvChips.appendChild(chip);
            });
            previewCard.appendChild(pvTitle);
            previewCard.appendChild(pvSubtitle);
            previewCard.appendChild(pvPara);
            previewCard.appendChild(pvChips);

            // é¡¶éƒ¨å·¥å…·è¡Œï¼šæ‰“å¼€ä¸»é¢˜ä¸é…è‰²
            const toolsRow = document.createElement('div');
            toolsRow.style.cssText = 'display:flex; justify-content:flex-end; gap:8px; margin: 4px 0 8px 0;';
            const openPaletteBtn = document.createElement('button');
            openPaletteBtn.textContent = 'ä¸»é¢˜ä¸é…è‰²';
            openPaletteBtn.style.cssText = `
            padding: 10px 14px; border-radius: 9999px; cursor: pointer; background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
            border: 1px solid var(--primarycolor-dark); color:#fff; text-shadow: 0 0px 0px var(--primarycolor-lighter); box-shadow: 0 4px 10px var(--primarycolor-lighter); transition: transform .15s ease;`;
            openPaletteBtn.onclick = () => {
                try { showThemePaletteDialog(); } catch (_) {}
            };
            openPaletteBtn.onmouseenter = () => { openPaletteBtn.style.transform = 'translateY(-1px)'; };
            openPaletteBtn.onmouseleave = () => { openPaletteBtn.style.transform = 'translateY(0)'; };
            toolsRow.appendChild(openPaletteBtn);

            // æŒ‰é’® - å›ºå®šåœ¨åº•éƒ¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            position: sticky;
            bottom: -25px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: 20px 0;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
            margin-left: -22px;
            margin-right: -22px;
            margin-bottom: -22px;
            width: calc(100% + 44px);
        `;

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = 'padding: 10px 20px; border: 1px solid  var(--primarycolor-lighter); background: #fff; border-radius: 9999px; cursor: pointer; color: var(--primarycolor);';
            cancelBtn.onclick = () => document.body.removeChild(overlay);

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'ä¿å­˜';
            saveBtn.style.cssText = 'padding: 10px 20px; border: 0; background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); color: #fff; border-radius: 9999px; cursor: pointer; box-shadow: 0 6px 14px var(--primarycolor-lighter)';
            saveBtn.onclick = () => {
                try {
                    // ä¿å­˜è®¾ç½®
                    const enabled = document.getElementById('custom-style-enabled').checked;
                    const primarycolor = document.getElementById('custom-primarycolor').value;
                    const primarycolorDark = document.getElementById('custom-primarycolor-dark').value;
                    const primarycolorLight = document.getElementById('custom-primarycolor-light').value;
                    const primarycolorLighter = document.getElementById('custom-primarycolor-lighter').value;
                    const primarycolorAlpha = parseInt(document.getElementById('custom-primarycolor-alpha')?.value || '100');
                    const primarycolorDarkAlpha = parseInt(document.getElementById('custom-primarycolor-dark-alpha')?.value || '100');
                    const primarycolorLightAlpha = parseInt(document.getElementById('custom-primarycolor-light-alpha')?.value || '100');
                    const primarycolorLighterAlpha = parseInt(document.getElementById('custom-primarycolor-lighter-alpha')?.value || '100');
                    // åœ†è§’/å­—ä½“ç›¸å…³è¾“å…¥
                    const borderRadius = document.getElementById('custom-border-radius')?.value || CUSTOM_STYLE_CONFIG.borderRadius;
                    const fontSize = document.getElementById('custom-font-size')?.value || CUSTOM_STYLE_CONFIG.fontSize;
                    const fontFamily = document.getElementById('custom-font-family')?.value || CUSTOM_STYLE_CONFIG.fontFamily;
                    const textColor2 = document.getElementById('custom-text-color2')?.value || '#ffffff';
                    const shadowColor = document.getElementById('custom-shadow-color')?.value || '#000000';

                    // æ›´æ–°é…ç½®
                    CUSTOM_STYLE_CONFIG.enabled = enabled;
                    CUSTOM_STYLE_CONFIG.borderRadius = borderRadius;
                    CUSTOM_STYLE_CONFIG.fontSize = fontSize;
                    CUSTOM_STYLE_CONFIG.fontFamily = fontFamily;
                    // å°†å››ä¸ªå˜é‡ç›´æ¥å†™å…¥åˆ° :rootï¼Œä¸”ä¼˜å…ˆçº§é«˜äºä¸»é¢˜/æ¸å˜
                    // æ”¯æŒç”¨æˆ·åœ¨è¾“å…¥æ¡†ä¸­å¡«å…¥æ¸å˜å­—ç¬¦ä¸²ï¼Œè‡ªåŠ¨æ‹†è§£ä¸ºä¸¤ç«¯é¢œè‰²
                    const gradientRegex = /(linear|radial|conic)-gradient\(/i;
                    const extractStops = (str) => {
                        try {
                            const s = String(str || '');
                            // æå–åå…­è¿›åˆ¶ã€rgb/rgbaã€hsl/hsla é¢œè‰²
                            const colorPattern = /#(?:[0-9a-fA-F]{3}){1,2}\b|rgba?\([^\)]*\)|hsla?\([^\)]*\)/g;
                            const matches = s.match(colorPattern) || [];
                            return matches.slice(0, 4); // å–å‰å‡ ä¸ªè‰²æ ‡ï¼Œè‡³å°‘ä¿è¯å‰ä¸¤é¡¹
                        } catch (_) {
                            return [];
                        }
                    };
                    // è®¡ç®—æœ‰æ•ˆé¢œè‰²ï¼šå¦‚æœæ˜¯æ¸å˜ï¼Œç”¨ç¬¬ä¸€ã€ç¬¬äºŒä¸ªåœé è‰²ï¼›å¦åˆ™æŒ‰é€æ˜åº¦è½¬æ¢
                    const resolvePair = (value, alphaPercent) => {
                        const v = String(value || '').trim();
                        if (gradientRegex.test(v)) {
                            const stops = extractStops(v);
                            const c1 = stops[0] || '#ffffff';
                            const c2 = stops[1] || stops[0] || '#ffffff';
                            return { c1, c2 };
                        }
                        const c = hexToRgba(v, alphaPercent);
                        return { c1: c, c2: c };
                    };

                    const p = resolvePair(primarycolor, primarycolorAlpha);
                    const d = resolvePair(primarycolorDark, primarycolorDarkAlpha);
                    const l = resolvePair(primarycolorLight, primarycolorLightAlpha);
                    const ll = resolvePair(primarycolorLighter, primarycolorLighterAlpha);

                    // primarycolor / primarycolor-dark ä¼˜å…ˆæ¥è‡ªå„è‡ªè¾“å…¥ï¼›è‹¥ primarycolor ä¸ºæ¸å˜ä¸” dark æœªæä¾›æœ‰æ•ˆç¬¬äºŒè‰²ï¼Œåˆ™ä½¿ç”¨ primarycolor çš„ç¬¬äºŒè‰²
                    const effectivePrimary = p.c1;
                    const effectivePrimaryDark = gradientRegex.test(primarycolorDark) || (!primarycolorDark && gradientRegex.test(primarycolor)) ? (d.c1 !== d.c2 ? d.c2 : p.c2) : (primarycolorDark ? d.c1 : p.c2);
                    // è‹¥ç”¨æˆ·æœªæä¾› light/lighterï¼Œåˆ™ä» primarycolor æ¨å¯¼æ›´æµ…çš„ä¸¤ä¸ªè‰²
                    const effectivePrimaryLight = primarycolorLight ? l.c1 : lightenColor(p.c1, 70);
                    const effectivePrimaryLighter = primarycolorLighter ? ll.c1 : lightenColor(p.c1, 80);

                    document.documentElement.style.setProperty('--primarycolor', effectivePrimary);
                    document.documentElement.style.setProperty('--primarycolor-dark', effectivePrimaryDark);
                    document.documentElement.style.setProperty('--primarycolor-light', effectivePrimaryLight);
                    document.documentElement.style.setProperty('--primarycolor-lighter', effectivePrimaryLighter);
                    // æ–‡å­—è‰²/é˜´å½±è‰²å†™å…¥å˜é‡
                    document.documentElement.style.setProperty('--theme-text-color', textColor2);
                    document.documentElement.style.setProperty('--box-shadow-color', shadowColor);

                    // è§„èŒƒåŒ–æµ…è‰²è¾“å…¥ï¼šè‹¥ä¸ºç©ºæˆ–ä¸ä¸»è‰²ç›¸åŒï¼Œåˆ™ä½¿ç”¨æ¨å¯¼å€¼ï¼Œç¡®ä¿æ›´æµ…
                    const normalizedPrimary = effectivePrimary;
                    const sameAsPrimary = (v) => String(v || '').trim().toLowerCase() === String(normalizedPrimary).trim().toLowerCase();
                    const normLight = (!primarycolorLight || sameAsPrimary(primarycolorLight)) ? effectivePrimaryLight : primarycolorLight;
                    const normLighter = (!primarycolorLighter || sameAsPrimary(primarycolorLighter)) ? effectivePrimaryLighter : primarycolorLighter;

                    // ä¿å­˜åˆ°å­˜å‚¨ï¼ˆè‹¥æµ…è‰²æœªå¡«å†™æˆ–ä¸ä¸»è‰²ç›¸åŒï¼Œåˆ™ä¿å­˜æ¨å¯¼åçš„å€¼ï¼Œé¿å…åç»­è¢«ç©ºå€¼è¦†ç›–ï¼‰
                    GM_setValue('custom_style_enabled', enabled);
                    GM_setValue('custom_primarycolor', primarycolor);
                    GM_setValue('custom_primarycolor_dark', primarycolorDark);
                    GM_setValue('custom_primarycolor_light', normLight);
                    GM_setValue('custom_primarycolor_lighter', normLighter);
                    GM_setValue('custom_primarycolor_alpha', primarycolorAlpha);
                    GM_setValue('custom_primarycolor_dark_alpha', primarycolorDarkAlpha);
                    GM_setValue('custom_primarycolor_light_alpha', (primarycolorLight && !sameAsPrimary(primarycolorLight)) ? primarycolorLightAlpha : 80);
                    GM_setValue('custom_primarycolor_lighter_alpha', (primarycolorLighter && !sameAsPrimary(primarycolorLighter)) ? primarycolorLighterAlpha : 60);
                    GM_setValue('custom_text_color2', textColor2);
                    GM_setValue('custom_shadow_color', shadowColor);
                    GM_setValue('custom_border_radius', borderRadius);
                    GM_setValue('custom_font_size', fontSize);
                    GM_setValue('custom_font_family', fontFamily);

                    // åº”ç”¨æ ·å¼å¹¶ç¡®ä¿è‡ªå®šä¹‰æ ·å¼ä¼˜å…ˆäºä¸»é¢˜æ¸å˜
                    applyCustomStyles();
                    enforceLighterShades();
                    try { GM_setValue('custom_colors_override_theme', true); } catch(_) {}

                    document.body.removeChild(overlay);
                    showNotification('è‡ªå®šä¹‰æ ·å¼å·²ä¿å­˜', 'success');
                } catch (err) {
                    console.error('ä¿å­˜è‡ªå®šä¹‰æ ·å¼å¤±è´¥:', err);
                    try { showNotification('ä¿å­˜å¤±è´¥: ' + (err?.message || err), 'error'); } catch (_) {}
                }
            };

            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(saveBtn);

            // ç»„è£…å¯¹è¯æ¡†
            dialog.appendChild(title);
            dialog.appendChild(enableContainer);
            dialog.appendChild(toolsRow);
            dialog.appendChild(colorContainer);
            dialog.appendChild(otherContainer);
            dialog.appendChild(previewCard);
            dialog.appendChild(buttonContainer);
            overlay.appendChild(dialog);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });

            document.body.appendChild(overlay);
        } catch (err) {
            console.error('showCustomStyleDialog æ„å»ºå¤±è´¥:', err);
            try { showNotification('æ‰“å¼€è‡ªå®šä¹‰æ ·å¼å¤±è´¥: ' + (err?.message || err), 'error'); } catch (_) {}
        }
    }

    function showAutoTagRoutingDialog() {
        const isMobile = window.innerWidth <= 768;
        const overlay = document.createElement('div');
        overlay.style.cssText = `position: fixed; inset: 0; background: transparent; z-index: 10001; display:flex; align-items:center; justify-content:center; ${isMobile ? 'padding: 0;' : ''}`;
        const dialog = document.createElement('div');
        dialog.style.cssText = `background: #fff; border-radius: ${isMobile ? '16px 16px 0 0' : '16px'}; padding: ${isMobile ? '16px' : '22px'}; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.08); ${isMobile ? 'position: fixed; bottom: 0; left: 0; right: 0; top: auto; width: -webkit-fill-available; max-width: -webkit-fill-available; max-height: 100vh;' : 'max-width: 900px; width: 90%; max-height: 90vh;'}`;
        dialog.className = 'auto-tag';
        const title = document.createElement('h3');
        title.textContent = 'è‡ªåŠ¨æ ‡ç­¾ä¸åˆ†æµ';
        title.style.cssText = `margin: 0 0 ${isMobile ? '10px' : '14px'} 0; font-size: ${isMobile ? '18px' : '20px'}; font-weight:800; text-align: center; letter-spacing:.3px; background:linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;`;
        const rules = Array.isArray(GM_getValue('auto_tag_routing_rules', [])) ? GM_getValue('auto_tag_routing_rules', []) : [];
        const dbMap = GM_getValue('notion_database_custom_map', {});
        const container = document.createElement('div');
        container.style.cssText = `display:grid; grid-template-columns: 1fr; gap:${isMobile ? '10px' : '14px'};`;

        const nav = document.createElement('div');
        nav.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; justify-content:center; margin:${isMobile ? '6px' : '8px'} 0 ${isMobile ? '10px' : '14px'} 0; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
        function mkNav(text){ const b=document.createElement('button'); b.textContent=text; b.style.cssText=`padding:${isMobile ? '6px 10px' : '8px 14px'}; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:white; cursor:pointer; font-size: ${isMobile ? '12px' : '14px'};`; b.addEventListener('mouseenter',()=>{b.style.transform='translateY(-2px)'; b.style.boxShadow='0 2px 3px var(--primarycolor-lighter)';}); b.addEventListener('mouseleave',()=>{b.style.transform='translateY(0)'; b.style.boxShadow='none';}); return b; }
        const navMap = mkNav('æ•°æ®åº“æ˜ å°„');
        const navRules = mkNav('è§„åˆ™');
        const navPreview = mkNav('é¢„è§ˆ');
        nav.appendChild(navMap); nav.appendChild(navRules); nav.appendChild(navPreview);

        const mappingCard = document.createElement('div');
        mappingCard.style.cssText = ` border: 1px solid var(--primarycolor-light);border-radius: 20px; padding:${isMobile ? '10px' : '12px'}; background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)), #FFFFFF); box-shadow: 0 6px 16px rgba(0,0,0,.06);color:white`;
        const mappingTitle = document.createElement('div');
        mappingTitle.textContent = 'æ•°æ®åº“æ˜ å°„';
        mappingTitle.style.cssText = 'font-weight:700; margin-bottom:8px; color: var(--primarycolor-dark);';
        const mappingList = document.createElement('div');
        mappingList.style.cssText = `display:grid; grid-template-columns: ${isMobile ? '1fr' : 'repeat(2, minmax(0,1fr))'}; gap:${isMobile ? '6px' : '8px'};`;
        const mappingRows = [];

        function addMappingRow(key, val) {
            const row = document.createElement('div');
            row.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
            const typeInput = document.createElement('input');
            typeInput.placeholder = 'ç±»å‹é”®å';
            typeInput.value = key || '';
            typeInput.style.cssText = `flex:1; padding:${isMobile ? '8px' : '8px'}; border:1px solid var(--primarycolor-light); border-radius: 20px; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'min-width: 0;' : ''}`;
            const idInput = document.createElement('input');
            idInput.placeholder = 'æ•°æ®åº“ID';
            idInput.value = val || '';
            idInput.style.cssText = `flex:2; padding:${isMobile ? '8px' : '8px'}; border:1px solid var(--primarycolor-light); border-radius: 20px; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'min-width: 0; width: -webkit-fill-available;' : ''}`;
            const del = document.createElement('button');
            del.textContent = 'åˆ é™¤';
            del.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border:none; border-radius: 20px; background: linear-gradient(135deg, var(--primarycolor-dark), var(--primarycolor)); color:#fff; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'width: -webkit-fill-available;' : ''}`;
            del.onclick = () => { mappingList.removeChild(row); };
            row.appendChild(typeInput);
            row.appendChild(idInput);
            row.appendChild(del);
            mappingList.appendChild(row);
            mappingRows.push({ typeInput, idInput });
        }

        Object.keys(dbMap || {}).forEach(k => addMappingRow(k, dbMap[k]));
        const addMappingBtn = document.createElement('button');
        addMappingBtn.textContent = 'æ–°å¢æ˜ å°„';
        addMappingBtn.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; margin-top:8px; font-size: ${isMobile ? '12px' : '14px'};`;
        addMappingBtn.onclick = () => addMappingRow('', '');
        const verifyRow = document.createElement('div');
        verifyRow.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; align-items:center; margin:${isMobile ? '6px' : '8px'} 0; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
        const verifyLabel = document.createElement('div'); verifyLabel.textContent = 'éªŒè¯æ•°æ®åº“ID'; verifyLabel.style.cssText = 'min-width:100px; color:#111827;';
        const verifyInput = document.createElement('input');
        verifyInput.id = '__verify_db_id_input__';
        verifyInput.placeholder = 'éªŒè¯æ•°æ®åº“ID';
        verifyInput.value = GM_getValue('notion_verify_database_id', '');
        verifyInput.style.cssText = `flex:1; padding:${isMobile ? '8px' : '8px'}; border:1px solid var(--primarycolor-light); border-radius: 20px; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'min-width: 0;' : ''}`;
        verifyRow.appendChild(verifyLabel);
        verifyRow.appendChild(verifyInput);
        mappingCard.appendChild(mappingTitle);
        mappingCard.appendChild(verifyRow);
        mappingCard.appendChild(mappingList);
        mappingCard.appendChild(addMappingBtn);

        const rulesCard = document.createElement('div');
        rulesCard.style.cssText = `border:1px solid var(--primarycolor-light); border-radius: 20px; padding:${isMobile ? '10px' : '12px'}; background: linear-gradient(135deg, #FFFFFF, var(--primarycolor-lighter)); box-shadow: 0 6px 16px rgba(0,0,0,.06);`;
        const rulesTitle = document.createElement('div');
        rulesTitle.textContent = 'è§„åˆ™åˆ—è¡¨';
        rulesTitle.style.cssText = 'font-weight:700; margin-bottom:8px; color: var(--primarycolor-dark);';
        const topRow = document.createElement('div');
        topRow.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; align-items:center; margin-bottom:8px; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
        const searchInput = document.createElement('input');
        searchInput.placeholder = 'æœç´¢è§„åˆ™...';
        searchInput.style.cssText = `flex:1; padding:${isMobile ? '8px' : '8px'}; border:1px solid var(--primarycolor-light); border-radius: 20px; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'min-width: 0; width: -webkit-fill-available;' : ''}`;
        const importBtn = document.createElement('button');
        importBtn.textContent = 'å¯¼å…¥';
        importBtn.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor-light), var(--primarycolor)); color:#fff; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`;
        const exportBtn = document.createElement('button');
        exportBtn.textContent = 'å¯¼å‡º';
        exportBtn.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`;
        topRow.appendChild(searchInput);
        topRow.appendChild(importBtn);
        topRow.appendChild(exportBtn);
        const rulesList = document.createElement('div');
        rulesList.style.cssText = `display:flex; flex-direction:column; gap:${isMobile ? '8px' : '10px'};`;
        const ruleRows = [];

        function createChipInput(ph, items) {
            const wrap = document.createElement('div');
            wrap.style.cssText = 'display:flex; flex-wrap:wrap; gap:6px; align-items:center; padding:6px; border:1px solid var(--primarycolor-light); border-radius: 20px; background: rgba(255,255,255,.8);';
            const chips = document.createElement('div');
            chips.style.cssText = 'display:flex; flex-wrap:wrap; gap:6px;';
            const input = document.createElement('input');
            input.placeholder = ph;
            input.style.cssText = 'flex:1; min-width:120px; border:none; outline:none; padding:6px;';
            function addChip(text) {
                const t = String(text || '').trim();
                if (!t) return;
                const chip = document.createElement('span');
                chip.textContent = t;
                chip.style.cssText = 'display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:linear-gradient(135deg, var(--primarycolor-light, #FF8FAB), var(--primarycolor, #FF6B9D)); color:#fff; font-size:12px;';
                const rm = document.createElement('button');
                rm.textContent = 'Ã—';
                rm.style.cssText = 'border:none; background:transparent; color:#fff; cursor:pointer; font-weight:700;';
                rm.onclick = () => chips.removeChild(chip);
                chip.appendChild(rm);
                chips.appendChild(chip);
            }
            function addFromInput() {
                const val = input.value || '';
                val.split(',').map(s=>s.trim()).filter(Boolean).forEach(addChip);
                input.value = '';
            }
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addFromInput(); } if (e.key === 'Backspace' && !input.value) { const last = chips.lastElementChild; if (last) chips.removeChild(last); } });
            input.addEventListener('blur', addFromInput);
            (Array.isArray(items) ? items : []).forEach(addChip);
            wrap.appendChild(chips);
            wrap.appendChild(input);
            return { container: wrap, getItems: () => Array.from(chips.children).map(c => c.firstChild ? c.firstChild.nodeValue || c.childNodes[0].nodeValue : (c.textContent.split('Ã—')[0] || '').trim()).map(s=>String(s).trim()).filter(Boolean) };
        }

        function addRuleRow(r) {
            const row = document.createElement('div');
            row.style.cssText = `display:grid; grid-template-columns: ${isMobile ? '1fr 1fr' : 'repeat(2, minmax(0,1fr))'}; gap:${isMobile ? '8px' : '8px'}; border:1px solid var(--primarycolor-light); border-radius: 20px; padding:${isMobile ? '10px' : '10px'}; background:#fff;`;
            const head = document.createElement('div');
            head.style.cssText = `grid-column: 1 / -1; display:flex; align-items:center; gap:${isMobile ? '6px' : '10px'}; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
            const ruleName = document.createElement('input');
            ruleName.placeholder = 'è§„åˆ™åç§°';
            ruleName.value = (r && r.name) || '';
            ruleName.style.cssText = `flex:1; padding:8px; border:1px solid var(--primarycolor-light); border-radius: 20px; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'min-width: 0; width: -webkit-fill-available;' : ''}`;
            const enableSwitch = document.createElement('label');
            enableSwitch.style.cssText = 'display:inline-flex; align-items:center; gap:6px;';
            const enableInput = document.createElement('input');
            enableInput.type = 'checkbox';
            enableInput.checked = !(r && r.enabled===false);
            const enText = document.createElement('span'); enText.textContent = 'å¯ç”¨'; enText.style.cssText='color:#374151;';
            enableSwitch.appendChild(enableInput); enableSwitch.appendChild(enText);
            const duplicateBtn = document.createElement('button');
            duplicateBtn.textContent = 'å¤åˆ¶';
            duplicateBtn.style.cssText = `padding:${isMobile ? '6px 8px' : '6px 10px'}; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor-lighter), var(--primarycolor-light)); color:#111827; font-size: ${isMobile ? '12px' : '14px'};`;
            head.appendChild(ruleName); head.appendChild(enableSwitch); head.appendChild(duplicateBtn);
            const domCI = createChipInput('åŸŸå', (r && r.domains) || []);
            const pathCI = createChipInput('è·¯å¾„å…³é”®è¯', (r && r.paths) || []);
            const kwCI = createChipInput('æ ‡é¢˜/æ­£æ–‡å…³é”®è¯', (r && r.keywords) || []);
            const tagCI = createChipInput('æ‰“æ ‡ç­¾', (r && r.tags) || []);
            const tagPropInput = document.createElement('input');
            tagPropInput.placeholder = 'æ ‡ç­¾å±æ€§å(å¤šé€‰)';
            tagPropInput.value = (r && r.tagProperty) || 'ç±»å‹';
            tagPropInput.style.cssText = `padding:8px; border:1px solid var(--primarycolor-light); border-radius: 20px; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'grid-column: 1 / -1;' : ''}`;
            const routeWrap = document.createElement('div');
            routeWrap.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; align-items:center; ${isMobile ? 'grid-column: 1 / -1; flex-wrap: wrap;' : ''}`;
            const seg = document.createElement('div');
            seg.style.cssText = 'display:inline-flex; border:1px solid var(--primarycolor-light); border-radius:999px; overflow:hidden; background:#fff;';
            function mkSeg(text, val) { const b = document.createElement('button'); b.textContent = text; b.dataset.val = val; b.style.cssText = 'padding:6px 10px; border:none; background:#fff; cursor:pointer; color:#374151;'; b.onclick = () => { Array.from(seg.children).forEach(x=>{ x.style.background='#fff'; x.style.color='#374151'; }); b.style.background='linear-gradient(135deg, var(--primarycolor-lighter), var(--primarycolor-light))'; b.style.color='#111827'; customInput.style.display = val==='custom' ? 'inline-block' : 'none'; customInput.value = val==='custom' ? (customInput.value||'') : val; }; return b; }
            const b1 = mkSeg('clip','clip'); const b2 = mkSeg('comic','comic'); const b3 = mkSeg('novel','novel'); const b4 = mkSeg('è‡ªå®šä¹‰','custom');
            seg.appendChild(b1); seg.appendChild(b2); seg.appendChild(b3); seg.appendChild(b4);
            const customInput = document.createElement('input');
            customInput.placeholder = 'ç±»å‹é”®å';
            customInput.style.cssText = 'padding:6px 10px; border:1px solid #E5E7EB; border-radius: 20px; display:none;';
            if (r && r.routeType && !['clip','comic','novel'].includes(r.routeType)) { b4.click(); customInput.value = r.routeType; } else { (r && r.routeType==='comic' ? b2 : r && r.routeType==='novel' ? b3 : b1).click(); }
            const ops = document.createElement('div');
            ops.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; ${isMobile ? 'grid-column: 1 / -1; flex-wrap: wrap;' : ''}`;
            const del = document.createElement('button');
            del.textContent = 'åˆ é™¤';
            del.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border:none; border-radius: 20px; background: linear-gradient(135deg, var(--primarycolor-dark), var(--primarycolor)); color:#fff; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`;
            del.onclick = () => { rulesList.removeChild(row); const idx = ruleRows.indexOf(item); if (idx>=0) ruleRows.splice(idx,1); };
            const up = document.createElement('button');
            up.textContent = 'ä¸Šç§»';
            up.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border-radius: 20px; border: 1px solid var(--primarycolor-light);background:white; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`;
            up.onclick = () => { const idx = Array.from(rulesList.children).indexOf(row); if (idx>0) { rulesList.insertBefore(row, rulesList.children[idx-1]); const t = ruleRows[idx]; ruleRows[idx]=ruleRows[idx-1]; ruleRows[idx-1]=t; } };
            const down = document.createElement('button');
            down.textContent = 'ä¸‹ç§»';
            down.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border-radius: 20px; border: 1px solid var(--primarycolor-light);background:white; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`;
            down.onclick = () => { const idx = Array.from(rulesList.children).indexOf(row); if (idx<rulesList.children.length-1) { rulesList.insertBefore(rulesList.children[idx+1], row); const t = ruleRows[idx]; ruleRows[idx]=ruleRows[idx+1]; ruleRows[idx+1]=t; } };
            ops.appendChild(del); ops.appendChild(up); ops.appendChild(down);
            const item = { domCI, pathCI, kwCI, tagCI, tagPropInput, seg, customInput, enableInput, ruleName, row };
            row.appendChild(head);
            row.appendChild(domCI.container);
            row.appendChild(pathCI.container);
            row.appendChild(kwCI.container);
            row.appendChild(tagCI.container);
            row.appendChild(tagPropInput);
            routeWrap.appendChild(seg);
            routeWrap.appendChild(customInput);
            row.appendChild(routeWrap);
            row.appendChild(ops);
            rulesList.appendChild(row);
            ruleRows.push(item);
            duplicateBtn.onclick = () => {
                addRuleRow({ name: ruleName.value, enabled: enableInput.checked, domains: domCI.getItems(), paths: pathCI.getItems(), keywords: kwCI.getItems(), tags: tagCI.getItems(), tagProperty: tagPropInput.value, routeType: customInput.style.display==='none' ? Array.from(seg.children).find(x=>x.style.background.includes('primarycolor-lighter'))?.dataset.val || 'clip' : String(customInput.value||'').trim() });
            };
        }

        rules.forEach(r => addRuleRow(r));
        searchInput.addEventListener('input', () => {
            const q = String(searchInput.value||'').toLowerCase();
            ruleRows.forEach(it => {
                const text = [it.ruleName.value, it.tagPropInput.value, ...it.domCI.getItems(), ...it.pathCI.getItems(), ...it.kwCI.getItems(), ...it.tagCI.getItems()].join(' ').toLowerCase();
                it.row.style.display = text.includes(q) ? '' : 'none';
            });
        });
        importBtn.onclick = () => {
            const overlay2 = document.createElement('div'); overlay2.style.cssText='position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:10002; display:flex; align-items:center; justify-content:center;';
            const box = document.createElement('div'); box.style.cssText='background:#fff; border-radius: 20px; padding:12px; width:80%; max-width:720px;';
            const title = document.createElement('div'); title.textContent='å¯¼å…¥è§„åˆ™'; title.style.cssText='font-weight:700; margin-bottom:8px; color: var(--primarycolor-dark); font-size:16px;';
            const ta = document.createElement('textarea'); ta.style.cssText='width:100%; min-height:200px; border:1px solid var(--primarycolor-light); border-radius: 20px; padding:8px; font-family:monospace; font-size:13px;';
            ta.placeholder = 'è¯·ç²˜è´´è§„åˆ™JSONæ•°æ®...';
            const hint = document.createElement('div'); hint.textContent='æç¤ºï¼šæ”¯æŒå¯¼å…¥è§„åˆ™æ•°ç»„ï¼Œä¼šè‡ªåŠ¨å…¼å®¹æ—§æ ¼å¼ï¼ˆç¼ºå°‘nameæˆ–enabledå­—æ®µçš„è§„åˆ™ï¼‰'; hint.style.cssText='font-size:12px; color:#6b7280; margin-top:4px; margin-bottom:8px;';
            const rowx=document.createElement('div'); rowx.style.cssText='display:flex; gap:8px; justify-content:flex-end; margin-top:8px;';
            const cancel=document.createElement('button'); cancel.textContent='å–æ¶ˆ'; cancel.style.cssText='padding:8px 12px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:#fff; cursor:pointer;';
            const ok=document.createElement('button'); ok.textContent='å¯¼å…¥'; ok.style.cssText='padding:8px 12px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; cursor:pointer;';
            cancel.onclick=()=>document.body.removeChild(overlay2);
            ok.onclick=()=>{
                try {
                    const inputValue = ta.value.trim();
                    if (!inputValue) {
                        showNotification('è¯·è¾“å…¥è¦å¯¼å…¥çš„è§„åˆ™æ•°æ®', 'warning');
                        return;
                    }
                    const parsed = JSON.parse(inputValue);

                    // æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
                    // 1. æ–°æ ¼å¼ï¼š{ meta: {...}, rules: [...] }
                    // 2. æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯è§„åˆ™æ•°ç»„ [...]
                    let rulesArray = null;
                    if (parsed && typeof parsed === 'object') {
                        if (parsed.meta && Array.isArray(parsed.rules)) {
                            // æ–°æ ¼å¼ï¼šå¸¦metaä¿¡æ¯
                            rulesArray = parsed.rules;
                            console.log('æ£€æµ‹åˆ°æ–°æ ¼å¼è§„åˆ™æ–‡ä»¶ï¼Œç‰ˆæœ¬:', parsed.meta.version);
                        } else if (Array.isArray(parsed)) {
                            // æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯æ•°ç»„
                            rulesArray = parsed;
                        } else {
                            showNotification('æ ¼å¼é”™è¯¯ï¼šæ— æ³•è¯†åˆ«çš„æ ¼å¼', 'error');
                            return;
                        }
                    } else {
                        showNotification('æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯è§„åˆ™æ•°ç»„æˆ–è§„åˆ™å¯¹è±¡', 'error');
                        return;
                    }

                    if (!Array.isArray(rulesArray) || rulesArray.length === 0) {
                        showNotification('æ²¡æœ‰æœ‰æ•ˆçš„è§„åˆ™æ•°æ®', 'warning');
                        return;
                    }

                    // éªŒè¯å¹¶è§„èŒƒåŒ–è§„åˆ™æ•°æ®ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
                    const normalizedRules = rulesArray.map((rule, index) => {
                        if (!rule || typeof rule !== 'object') {
                            console.warn(`è§„åˆ™ ${index + 1} æ ¼å¼æ— æ•ˆï¼Œå·²è·³è¿‡`);
                            return null;
                        }
                        // å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ²¡æœ‰nameå­—æ®µï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²æˆ–é»˜è®¤åç§°
                        const normalizedRule = {
                            name: String(rule.name || '').trim() || `è§„åˆ™ ${index + 1}`,
                            enabled: rule.enabled !== false, // é»˜è®¤å¯ç”¨
                            domains: Array.isArray(rule.domains) ? rule.domains : [],
                            paths: Array.isArray(rule.paths) ? rule.paths : [],
                            keywords: Array.isArray(rule.keywords) ? rule.keywords : [],
                            tags: Array.isArray(rule.tags) ? rule.tags : [],
                            tagProperty: String(rule.tagProperty || 'ç±»å‹').trim(),
                            routeType: String(rule.routeType || 'clip').trim()
                        };
                        return normalizedRule;
                    }).filter(rule => rule !== null);

                    if (normalizedRules.length === 0) {
                        showNotification('æ²¡æœ‰æœ‰æ•ˆçš„è§„åˆ™æ•°æ®', 'warning');
                        return;
                    }

                    // æ¸…ç©ºç°æœ‰è§„åˆ™å¹¶å¯¼å…¥æ–°è§„åˆ™
                    rulesList.textContent='';
                    ruleRows.splice(0, ruleRows.length);
                    normalizedRules.forEach(addRuleRow);
                    document.body.removeChild(overlay2);
                    showNotification(`æˆåŠŸå¯¼å…¥ ${normalizedRules.length} æ¡è§„åˆ™`, 'success');
                } catch(e) {
                    console.error('å¯¼å…¥è§„åˆ™å¤±è´¥:', e);
                    showNotification('æ ¼å¼é”™è¯¯ï¼š' + (e.message || 'JSONè§£æå¤±è´¥'), 'error');
                }
            };
            rowx.appendChild(cancel); rowx.appendChild(ok);
            box.appendChild(title);
            box.appendChild(hint);
            box.appendChild(ta);
            box.appendChild(rowx);
            overlay2.appendChild(box);
            document.body.appendChild(overlay2);
            // è‡ªåŠ¨èšç„¦åˆ°æ–‡æœ¬æ¡†
            setTimeout(() => ta.focus(), 100);
        };
        exportBtn.onclick = () => {
            const newRules = ruleRows.map(r => ({
                name: String(r.ruleName.value || '').trim() || 'æœªå‘½åè§„åˆ™',
                enabled: r.enableInput.checked !== false,
                domains: r.domCI.getItems(),
                paths: r.pathCI.getItems(),
                keywords: r.kwCI.getItems(),
                tags: r.tagCI.getItems(),
                tagProperty: r.tagPropInput.value || 'ç±»å‹',
                routeType: r.customInput.style.display==='none' ? Array.from(r.seg.children).find(x=>x.style.background.includes('primarycolor-lighter'))?.dataset.val || 'clip' : String(r.customInput.value||'').trim()
            })).filter(x => x.domains.length || x.paths.length || x.keywords.length || x.tags.length);

            if (newRules.length === 0) {
                showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„è§„åˆ™', 'warning');
                return;
            }

            const exportData = {
                meta: {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    description: 'è‡ªåŠ¨åˆ†æµä¸æ ‡ç­¾è§„åˆ™',
                    ruleCount: newRules.length
                },
                rules: newRules
            };

            const overlay2 = document.createElement('div'); overlay2.style.cssText='position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:10002; display:flex; align-items:center; justify-content:center;';
            const box = document.createElement('div'); box.style.cssText='background:#fff; border-radius: 20px; padding:12px; width:80%; max-width:720px;';
            const title = document.createElement('div'); title.textContent='å¯¼å‡ºè§„åˆ™'; title.style.cssText='font-weight:700; margin-bottom:8px; color: var(--primarycolor-dark); font-size:16px;';
            const info = document.createElement('div'); info.textContent=`å…± ${newRules.length} æ¡è§„åˆ™`; info.style.cssText='font-size:12px; color:#6b7280; margin-bottom:8px;';
            const ta = document.createElement('textarea'); ta.style.cssText='width:100%; min-height:200px; border:1px solid var(--primarycolor-light); border-radius: 20px; padding:8px; font-family:monospace; font-size:13px;';
            ta.value = JSON.stringify(exportData, null, 2);
            ta.readOnly = true;
            const rowx=document.createElement('div'); rowx.style.cssText='display:flex; gap:8px; justify-content:flex-end; margin-top:8px;';
            const close=document.createElement('button'); close.textContent='å…³é—­'; close.style.cssText='padding:8px 12px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:#fff; cursor:pointer;';
            const copy=document.createElement('button'); copy.textContent='å¤åˆ¶'; copy.style.cssText='padding:8px 12px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; cursor:pointer;';
            const download=document.createElement('button'); download.textContent='ä¸‹è½½'; download.style.cssText='padding:8px 12px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor-light), var(--primarycolor)); color:#fff; cursor:pointer;';
            close.onclick=()=>document.body.removeChild(overlay2);
            copy.onclick=()=>{
                try {
                    GM_setClipboard(ta.value||'');
                    showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿','success');
                } catch(e) {
                    console.error('å¤åˆ¶å¤±è´¥:', e);
                    showNotification('å¤åˆ¶å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            };
            download.onclick=()=>{
                try {
                    const blob = new Blob([ta.value], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `auto_tag_routing_rules_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotification('å·²ä¸‹è½½è§„åˆ™æ–‡ä»¶', 'success');
                } catch(e) {
                    console.error('ä¸‹è½½å¤±è´¥:', e);
                    showNotification('ä¸‹è½½å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            };
            rowx.appendChild(close); rowx.appendChild(copy); rowx.appendChild(download);
            box.appendChild(title);
            box.appendChild(info);
            box.appendChild(ta);
            box.appendChild(rowx);
            overlay2.appendChild(box);
            document.body.appendChild(overlay2);
            // è‡ªåŠ¨é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
            setTimeout(() => { ta.select(); ta.focus(); }, 100);
        };
        const addRuleBtn = document.createElement('button');
        addRuleBtn.textContent = 'æ–°å¢è§„åˆ™';
        addRuleBtn.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; margin-top:8px; font-size: ${isMobile ? '12px' : '14px'};`;
        addRuleBtn.onclick = () => addRuleRow({ domains: [], paths: [], keywords: [], tags: [], routeType: '' });

        const quickRow = document.createElement('div');
        quickRow.style.cssText = `display:grid;grid-template-columns: ${isMobile ? '1fr 1fr 1fr' : 'repeat(3, 1fr)'}; gap:${isMobile ? '6px' : '8px'}; margin-top:8px;`;
        const fromPageBtn = document.createElement('button');
        fromPageBtn.textContent = 'åŸºäºå½“å‰é¡µç”Ÿæˆ';
        fromPageBtn.style.cssText = 'padding:8px 10px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff;';
        fromPageBtn.onclick = () => {
            try {
                const u = new URL(window.location.href);
                const d = u.hostname.toLowerCase();
                const p = u.pathname.toLowerCase().split('/').filter(Boolean).slice(0,2).map(s => '/' + s);
                const kw = (document.title || '').split(/\s+|\||-|_/).filter(Boolean).slice(0,5);
                addRuleRow({ domains: [d], paths: p, keywords: kw, tags: [], tagProperty: 'ç±»å‹', routeType: 'clip' });
            } catch(_) { addRuleRow({ domains: [], paths: [], keywords: [], tags: [], tagProperty: 'ç±»å‹', routeType: 'clip' }); }
        };
        const presetsBtn = document.createElement('button');
        presetsBtn.textContent = 'å¸¸ç”¨é¢„è®¾';
        presetsBtn.style.cssText = 'padding:8px 10px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor-light), var(--primarycolor)); color:#fff;';
        presetsBtn.onclick = () => {
            [
                { domains:['dev.to','medium.com','css-tricks.com'], keywords:['tech','æ•™ç¨‹','å‰ç«¯','è®¾è®¡'], tags:['tech','æ•™ç¨‹','å‰ç«¯'], tagProperty:'ç±»å‹', routeType:'clip' },
                { domains:['github.com'], paths:['/docs','/wiki'], keywords:['readme','doc'], tags:['æ–‡æ¡£'], tagProperty:'ç±»å‹', routeType:'clip' },
                { domains:['notion.so','notion.site'], keywords:['æ¨¡æ¿','æ–¹æ³•è®º'], tags:['æ¨¡æ¿','æ–¹æ³•è®º'], tagProperty:'ç±»å‹', routeType:'clip' }
            ].forEach(addRuleRow);
        };
        const testBtn = document.createElement('button');
        testBtn.textContent = 'æµ‹è¯•å½“å‰é¡µ';
        testBtn.style.cssText = 'padding:8px 10px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff;';
        testBtn.onclick = () => {
            const res = evaluateAutoTagRouting(window.location.href, document.title || '', (document.body && document.body.innerText) || '', getSiteConfig());
            showNotification(`æ ‡ç­¾: ${(res.tags||[]).join(', ')} | åˆ†æµ: ${res.routeType||''}`, 'info');
        };
        quickRow.appendChild(fromPageBtn);
        quickRow.appendChild(presetsBtn);
        quickRow.appendChild(testBtn);

        rulesCard.appendChild(rulesTitle);
        rulesCard.appendChild(topRow);
        rulesCard.appendChild(rulesList);
        rulesCard.appendChild(addRuleBtn);
        rulesCard.appendChild(quickRow);

        const opsRow = document.createElement('div');
        opsRow.style.cssText = `margin-top:8px;display:flex; gap:${isMobile ? '6px' : '8px'}; justify-content:flex-end; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'å…³é—­';
        closeBtn.style.cssText = `padding: ${isMobile ? '10px' : '10px 14px'}; border: 1px solid var(--primarycolor-light); border-radius: 20px; background: #fff; cursor: pointer; color:#111827; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`;
        closeBtn.onclick = () => document.body.removeChild(overlay);
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `padding: ${isMobile ? '10px' : '10px 16px'}; border: none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; cursor:pointer; box-shadow: 0 6px 14px var(--primarycolor-lighter); font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`;

        function applyHover(btn) { btn.addEventListener('mouseenter', () => { btn.style.transform = 'translateY(-2px)'; btn.style.boxShadow = '0 5px 15px var(--primarycolor-lighter)'; }); btn.addEventListener('mouseleave', () => { btn.style.transform = 'translateY(0)'; btn.style.boxShadow = 'none'; }); }
        [addMappingBtn, addRuleBtn, fromPageBtn, presetsBtn, testBtn, closeBtn, saveBtn].forEach(b => applyHover(b));
        saveBtn.onclick = () => {
            try {
                const newRules = ruleRows.map(r => ({
                    name: String(r.ruleName.value || '').trim(),
                    enabled: r.enableInput.checked !== false,
                    domains: r.domCI.getItems(),
                    paths: r.pathCI.getItems(),
                    keywords: r.kwCI.getItems(),
                    tags: r.tagCI.getItems(),
                    tagProperty: r.tagPropInput.value,
                    routeType: r.customInput.style.display==='none' ? Array.from(r.seg.children).find(x=>x.style.background.includes('primarycolor-lighter'))?.dataset.val || 'clip' : String(r.customInput.value||'').trim()
                })).filter(x => x.domains.length || x.paths.length || x.keywords.length || x.tags.length);
                const newMap = {};
                mappingRows.forEach(m => { const k = String(m.typeInput.value||'').trim(); const v = String(m.idInput.value||'').trim(); if (k && v) newMap[k] = v; });
                GM_setValue('auto_tag_routing_rules', newRules);
                GM_setValue('notion_database_custom_map', newMap);
                try {
                    const verifyId = document.querySelector('#__verify_db_id_input__') ? document.querySelector('#__verify_db_id_input__').value.trim() : '';
                    GM_setValue('notion_verify_database_id', verifyId);
                } catch(_) {}
                showNotification('å·²ä¿å­˜è‡ªåŠ¨åˆ†æµä¸æ ‡ç­¾è§„åˆ™', 'success');
                document.body.removeChild(overlay);
            } catch (e) {
                showNotification('ä¿å­˜å¤±è´¥', 'error');
            }
        };
        opsRow.appendChild(closeBtn);
        opsRow.appendChild(saveBtn);

        const previewCard = document.createElement('div');
        previewCard.style.cssText = `border:1px solid var(--primarycolor-light); border-radius: 20px; padding:${isMobile ? '10px' : '12px'}; background: linear-gradient(135deg, #FFFFFF, var(--primarycolor-lighter)); box-shadow: 0 6px 16px rgba(0,0,0,.06);`;
        const pvTitle = document.createElement('div'); pvTitle.textContent='é¢„è§ˆ'; pvTitle.style.cssText='font-weight:700; margin-bottom:8px; color: var(--primarycolor-dark);';
        const pvRow = document.createElement('div'); pvRow.style.cssText=`display:flex; gap:${isMobile ? '6px' : '8px'}; align-items:center; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
        const urlInput = document.createElement('input'); urlInput.placeholder='è¾“å…¥è¦æµ‹è¯•çš„URL'; urlInput.style.cssText=`flex:1; padding:8px; border:1px solid var(--primarycolor-light); border-radius: 20px; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'min-width: 0; width: -webkit-fill-available;' : ''}`; urlInput.value = window.location.href;
        const runBtn = document.createElement('button'); runBtn.textContent='è®¡ç®—'; runBtn.style.cssText=`padding:${isMobile ? '8px' : '8px 10px'}; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'width: -webkit-fill-available;' : ''}`;
        const resultBox = document.createElement('div'); resultBox.style.cssText='margin-top:8px; padding:10px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:#fff; color:#374151;';
        pvRow.appendChild(urlInput); pvRow.appendChild(runBtn);
        previewCard.appendChild(pvTitle); previewCard.appendChild(pvRow); previewCard.appendChild(resultBox);
        runBtn.onclick = () => {
            const newRules = ruleRows.map(r => ({
                name: r.ruleName.value,
                enabled: r.enableInput.checked,
                domains: r.domCI.getItems(),
                paths: r.pathCI.getItems(),
                keywords: r.kwCI.getItems(),
                tags: r.tagCI.getItems(),
                tagProperty: r.tagPropInput.value,
                routeType: r.customInput.style.display==='none' ? Array.from(r.seg.children).find(x=>x.style.background.includes('primarycolor-lighter'))?.dataset.val || 'clip' : String(r.customInput.value||'').trim()
            }));
            GM_setValue('auto_tag_routing_rules', newRules);
            const res = evaluateAutoTagRouting(urlInput.value, document.title || '', (document.body && document.body.innerText) || '', getSiteConfig());
            resultBox.textContent = `æ ‡ç­¾: ${(res.tags||[]).join(', ')} | åˆ†æµ: ${res.routeType||''}`;
        };

        container.appendChild(nav);
        container.appendChild(mappingCard);
        container.appendChild(rulesCard);
        container.appendChild(previewCard);

        function activate(section){ [mappingCard, rulesCard, previewCard].forEach(s=>s.style.display='none'); section.style.display='block'; }
        navMap.onclick = () => activate(mappingCard);
        navRules.onclick = () => activate(rulesCard);
        navPreview.onclick = () => activate(previewCard);
        activate(rulesCard);
        dialog.appendChild(title);
        dialog.appendChild(container);
        dialog.appendChild(opsRow);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
    }

    function showMarkdownTransformDialog() {
        const isMobile = window.innerWidth <= 768;
        const overlay = document.createElement('div');
        overlay.style.cssText = `position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 10001; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(2px); ${isMobile ? 'padding: 0;' : ''}`;
        const dialog = document.createElement('div');
        dialog.className = 'markdown-convertion';
        dialog.style.cssText = `background: linear-gradient(180deg, #FFFFFF 0%, rgba(255,255,255,0.96) 100%); border: 1px solid var(--primarycolor-light); border-radius: ${isMobile ? '16px 16px 0 0' : '20px'}; max-width: ${isMobile ? '100%' : '1080px'}; width: ${isMobile ? '-webkit-fill-available' : 'auto'}; padding: ${isMobile ? '16px' : '24px'}; max-height: ${isMobile ? '100vh' : '86vh'}; overflow-y: auto; box-shadow: 0 24px 48px rgba(0,0,0,0.10); ${isMobile ? 'position: fixed; bottom: 0; left: 0; right: 0; top: auto; border-radius: 16px 16px 0 0;' : ''}`;
        const title = document.createElement('h3');
        title.textContent = 'âœ¦ é€‰æ‹©å™¨â†’Markdownè½¬æ¢';
        title.style.cssText = `margin: 0; font-size: ${isMobile ? '18px' : '22px'}; font-weight:800; text-align: center; letter-spacing:.4px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;`;
        const subtitle = document.createElement('div');
        subtitle.textContent = 'ä»é€‰æ‹©å™¨æŠ“å–â†’è½¬Markdownâ†’åº”ç”¨æ¸…æ´—è§„åˆ™';
        subtitle.style.cssText = `text-align:center; margin: 6px 0 14px 0; font-size: ${isMobile ? '11px' : '12px'}; color:#6B7280;`;
        const topBar = document.createElement('div');
        topBar.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; align-items:center; justify-content:space-between; margin-bottom:12px; padding:${isMobile ? '10px' : '12px'}; border:1px solid #e5e7eb; border-radius: 20px; background:#FFFFFF; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
        const domainToggleRow = document.createElement('div');
        domainToggleRow.style.cssText = `display:flex; gap:${isMobile ? '8px' : '16px'}; align-items:center; ${isMobile ? 'flex-wrap: wrap; width: -webkit-fill-available;' : ''}`;
        const useDomainControl = createCustomCheckbox('markdown-use-domain', !!GM_getValue('markdown_transform_use_domain', false), 'æŒ‰åŸŸååˆ†ç»„è§„åˆ™(' + (location.hostname || '') + ')');
        const cfg0 = getMarkdownTransformConfig();
        const enabledControl = createCustomCheckbox('markdown-enabled', !!cfg0.enabled, 'å¯ç”¨è½¬æ¢ç®¡é“');
        const useDomainHidden = useDomainControl.querySelector('input[type="checkbox"]');
        const enabledHidden = enabledControl.querySelector('input[type="checkbox"]');
        domainToggleRow.appendChild(useDomainControl);
        domainToggleRow.appendChild(enabledControl);
        const ioRow = document.createElement('div');
        ioRow.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`;
        const exportBtn = document.createElement('button');
        exportBtn.textContent = 'å¯¼å‡ºè§„åˆ™';
        exportBtn.style.cssText = `padding:${isMobile ? '6px 8px' : '8px 10px'}; border:1px solid var(--primarycolor-light); border-radius: 20px; background:white; color:var(--primarycolor); font-size: ${isMobile ? '12px' : '14px'};`;
        const importBtn = document.createElement('button');
        importBtn.textContent = 'å¯¼å…¥è§„åˆ™';
        importBtn.style.cssText = `padding:${isMobile ? '6px 8px' : '8px 10px'}; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; font-size: ${isMobile ? '12px' : '14px'};`;
        ioRow.appendChild(exportBtn);
        ioRow.appendChild(importBtn);
        topBar.appendChild(domainToggleRow);
        topBar.appendChild(ioRow);

        const ruleList = document.createElement('div');
        ruleList.style.cssText = `display:flex; flex-direction:column; gap:${isMobile ? '8px' : '10px'};`;
        const rows = [];
        let lastMdData = null;
        const cfgInit = getMarkdownTransformConfig();
        const rules = Array.isArray(cfgInit.allRules) ? cfgInit.allRules : (Array.isArray(cfgInit.rules) ? cfgInit.rules : []);
        const PRESET_STORAGE_KEY = 'markdown_transform_presets_v2';

        const templateOptions = [
            {
                id: 'strip-link-query',
                name: 'å»æ‰é“¾æ¥æŸ¥è¯¢å‚æ•°',
                description: 'ç§»é™¤ Markdown é“¾æ¥ä¸­ ?xxx çš„æŸ¥è¯¢éƒ¨åˆ†',
                rule: {
                    name: 'å»æ‰é“¾æ¥æŸ¥è¯¢å‚æ•°',
                    pattern: '/\\[(.*?)\\]\\(([^)#\\s]+)(?:\\?[^)#\\s]*)\\)/g',
                    flags: 'g',
                    replacement: '[$1]($2)',
                    enabled: true,
                    target: 'markdown'
                }
            },
            {
                id: 'collapse-blank-lines',
                name: 'å‹ç¼©å¤šä½™ç©ºè¡Œ',
                description: '3 è¡Œä»¥ä¸Šçš„è¿ç»­ç©ºè¡Œå‹ç¼©æˆ 2 è¡Œ',
                rule: {
                    name: 'å‹ç¼©å¤šä½™ç©ºè¡Œ',
                    pattern: '/\\n{3,}/g',
                    flags: 'g',
                    replacement: '\n\n',
                    enabled: true,
                    target: 'markdown'
                }
            },
            {
                id: 'trim-line-spaces',
                name: 'å»æ‰è¡Œé¦–å°¾ç©ºç™½',
                description: 'æ¸…ç†æ¯è¡Œå¼€å¤´å’Œç»“å°¾çš„ç©ºæ ¼/åˆ¶è¡¨ç¬¦',
                rule: {
                    name: 'å»æ‰è¡Œé¦–å°¾ç©ºç™½',
                    pattern: '/(^[ \\t]+)|([ \\t]+$)/gm',
                    flags: 'gm',
                    replacement: '',
                    enabled: true,
                    target: 'markdown'
                }
            },
            {
                id: 'remove-zwsp',
                name: 'å»æ‰é›¶å®½å­—ç¬¦',
                description: 'ç§»é™¤é›¶å®½ç©ºæ ¼ç­‰ä¸å¯è§å­—ç¬¦',
                rule: {
                    name: 'å»æ‰é›¶å®½å­—ç¬¦',
                    pattern: '/[\\u200B-\\u200D\\uFEFF]/g',
                    flags: 'g',
                    replacement: '',
                    enabled: true,
                    target: 'markdown'
                }
            },
            {
                id: 'normalize-space',
                name: 'æŠ˜å å¤šä½™ç©ºæ ¼',
                description: 'å°†è¿ç»­å¤šä¸ªç©ºæ ¼æŠ˜å ä¸ºä¸€ä¸ªç©ºæ ¼',
                rule: {
                    name: 'æŠ˜å å¤šä½™ç©ºæ ¼',
                    pattern: '/ {2,}/g',
                    flags: 'g',
                    replacement: ' ',
                    enabled: true,
                    target: 'markdown'
                }
            }
        ];

        const builtinRulePresets = [
            {
                id: 'builtin-basic-clean',
                name: 'åŸºç¡€æ¸…æ´—ç¤ºä¾‹',
                builtin: true,
                rules: ['strip-link-query', 'collapse-blank-lines', 'remove-zwsp'].map(id => cloneRuleDefinition(getTemplateRule(id)))
            },
            {
                id: 'builtin-spacing-fix',
                name: 'ç©ºç™½ä¼˜åŒ–ç¤ºä¾‹',
                builtin: true,
                rules: ['trim-line-spaces', 'normalize-space'].map(id => cloneRuleDefinition(getTemplateRule(id)))
            }
        ];

        function getTemplateRule(id) {
            const tpl = templateOptions.find(t => t.id === id);
            return tpl ? tpl.rule : null;
        }

        function cloneRuleDefinition(rule) {
            if (!rule) return null;
            return {
                name: rule.name || '',
                pattern: rule.pattern || '',
                flags: rule.flags || '',
                replacement: rule.replacement || '',
                enabled: rule.enabled !== false,
                target: rule.target || 'markdown'
            };
        }

        const selectorInput = document.createElement('input');
        selectorInput.placeholder = 'è¾“å…¥CSSé€‰æ‹©å™¨';
        selectorInput.style.cssText = 'width:-webkit-fill-available; padding:10px; border:1px solid var(--primarycolor-light); border-radius: 20px;';
        selectorInput.id = 'markdown-content-selector-input';
        selectorInput.dataset.field = 'markdownContentSelector';
        const fetchBtn = document.createElement('button');
        fetchBtn.textContent = 'ç”ŸæˆMarkdown';
        fetchBtn.style.cssText = 'padding:8px 10px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff;';
        const pickIndex = document.createElement('input');
        pickIndex.placeholder = 'ç´¢å¼•(é»˜è®¤å…¨éƒ¨)';
        pickIndex.style.cssText = 'width:-webkit-fill-available; padding:10px; border:1px solid var(--primarycolor-light); border-radius: 20px;';
        const textOnlyControl = createCustomCheckbox('markdown-text-only', false, 'ä»…æ–‡æœ¬');
        const textOnlyHidden = textOnlyControl.querySelector('input[type="checkbox"]');
        const sepInput = document.createElement('input');
        sepInput.placeholder = 'åˆå¹¶åˆ†éš”ç¬¦';
        sepInput.value = '\n\n---\n\n';
        sepInput.style.cssText = 'flex:1; padding:10px; border:1px solid var(--primarycolor-light); border-radius: 20px;';

        const htmlArea = document.createElement('textarea');
        htmlArea.placeholder = 'HTMLé¢„è§ˆ';
        htmlArea.style.cssText = 'width:-webkit-fill-available; min-height:140px; padding:10px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:#F9FAFB; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;';
        const htmlHeaderText = document.createElement('div');
        htmlHeaderText.textContent = 'HTMLé¢„è§ˆ';
        htmlHeaderText.style.cssText = 'font-weight:700; font-size:14px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;';
        const htmlHeaderBadge = document.createElement('span');
        htmlHeaderBadge.style.cssText = 'font-size:11px; color:#6B7280; background:var(--primarycolor-lighter); border:1px solid var(--primarycolor-light); border-radius:999px; padding:2px 8px;';
        const htmlHeader = document.createElement('div');
        htmlHeader.style.cssText = 'margin-bottom:6px; display:flex; align-items:center; justify-content:space-between;';
        htmlHeader.appendChild(htmlHeaderText);

        const cleanedHtmlArea = document.createElement('textarea');
        cleanedHtmlArea.placeholder = 'æ¸…æ´—åHTMLé¢„è§ˆ';
        cleanedHtmlArea.style.cssText = 'width:-webkit-fill-available; min-height:140px; padding:10px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:#F9FAFB; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;';
        const cleanedHtmlHeaderText = document.createElement('div');
        cleanedHtmlHeaderText.textContent = 'æ¸…æ´—åHTMLé¢„è§ˆ';
        cleanedHtmlHeaderText.style.cssText = 'font-weight:700; font-size:14px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;';
        const cleanedHtmlHeader = document.createElement('div');
        cleanedHtmlHeader.style.cssText = 'margin-bottom:6px; display:flex; align-items:center; justify-content:space-between;';
        cleanedHtmlHeader.appendChild(cleanedHtmlHeaderText);

        htmlHeader.appendChild(htmlHeaderBadge);
        const htmlCard = document.createElement('div');
        htmlCard.style.cssText = 'border:1px solid var(--primarycolor-light); border-radius: 20px; padding:12px; background:#FFFFFF; box-shadow: 0 6px 16px rgba(0,0,0,.06);';
        htmlCard.appendChild(htmlHeader);
        htmlCard.appendChild(htmlArea);
        htmlCard.appendChild(cleanedHtmlHeader);
        htmlCard.appendChild(cleanedHtmlArea);
        const mdArea = document.createElement('textarea');
        mdArea.placeholder = 'åŸå§‹Markdown';
        mdArea.style.cssText = 'width:-webkit-fill-available; min-height:180px; padding:10px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:#F9FAFB; margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;';
        const previewWrap = document.createElement('div');
        previewWrap.style.cssText = `display:grid; grid-template-columns: ${isMobile ? '1fr' : '1fr 1fr'}; gap:${isMobile ? '8px' : '10px'}; margin-top:10px;`;
        const mdTransformed = document.createElement('textarea');
        mdTransformed.placeholder = 'æ¸…æ´—åMarkdown';
        mdTransformed.style.cssText = 'width:-webkit-fill-available; min-height:180px;margin-top: 8px; padding:10px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:#F9FAFB; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;';
        const mdLeftHeaderText = document.createElement('div');
        mdLeftHeaderText.textContent = 'åŸå§‹Markdown';
        mdLeftHeaderText.style.cssText = 'font-weight:700; font-size:14px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;';
        const mdLeftHeaderBadge = document.createElement('span');
        mdLeftHeaderBadge.style.cssText = 'font-size:11px; color:#6B7280; background:var(--primarycolor-lighter); border:1px solid var(--primarycolor-light); border-radius:999px; padding:2px 8px;';
        const mdLeftTools = document.createElement('div');
        const mdLeftCopy = document.createElement('button'); mdLeftCopy.textContent = 'å¤åˆ¶'; mdLeftCopy.style.cssText = 'padding:4px 8px; border:none; border-radius: 20px;border: 1px solid var(--primarycolor-light);color:var(--primarycolor);background:white;';
        const mdLeftDownload = document.createElement('button'); mdLeftDownload.textContent = 'ä¸‹è½½'; mdLeftDownload.style.cssText = 'padding:4px 8px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff;';
        mdLeftTools.style.cssText = 'display:flex; gap:6px;';
        mdLeftTools.appendChild(mdLeftCopy);
        mdLeftTools.appendChild(mdLeftDownload);
        const mdLeftHeader = document.createElement('div');
        mdLeftHeader.style.cssText = 'margin-bottom:6px; display:flex; align-items:center; justify-content:space-between;';
        const mdLeftHeaderLeft = document.createElement('div'); mdLeftHeaderLeft.style.cssText = 'display:flex; gap:8px; align-items:center;';
        mdLeftHeaderLeft.appendChild(mdLeftHeaderText);
        mdLeftHeaderLeft.appendChild(mdLeftHeaderBadge);
        mdLeftHeader.appendChild(mdLeftHeaderLeft);
        mdLeftHeader.appendChild(mdLeftTools);

        const mdRightHeaderText = document.createElement('div');
        mdRightHeaderText.textContent = 'æ¸…æ´—åMarkdown';
        mdRightHeaderText.style.cssText = 'font-weight:700; font-size:14px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;';
        const mdRightHeaderBadge = document.createElement('span');
        mdRightHeaderBadge.style.cssText = 'font-size:11px; color:#6B7280; background:var(--primarycolor-lighter); border:1px solid var(--primarycolor-light); border-radius:999px; padding:2px 8px;';
        const mdRightTools = document.createElement('div');
        const mdRightCopy = document.createElement('button'); mdRightCopy.textContent = 'å¤åˆ¶'; mdRightCopy.style.cssText = 'padding:4px 8px; border:none; border-radius: 20px;border: 1px solid var(--primarycolor-light);color:var(--primarycolor);background:white;';
        const mdRightDownload = document.createElement('button'); mdRightDownload.textContent = 'ä¸‹è½½'; mdRightDownload.style.cssText = 'padding:4px 8px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff;';
        mdRightTools.style.cssText = 'display:flex; gap:6px;';
        mdRightTools.appendChild(mdRightCopy);
        mdRightTools.appendChild(mdRightDownload);
        const mdRightHeader = document.createElement('div');
        mdRightHeader.style.cssText = 'margin-bottom:6px; display:flex; align-items:center; justify-content:space-between;';
        const mdRightHeaderLeft = document.createElement('div'); mdRightHeaderLeft.style.cssText = 'display:flex; gap:8px; align-items:center;';
        mdRightHeaderLeft.appendChild(mdRightHeaderText);
        mdRightHeaderLeft.appendChild(mdRightHeaderBadge);
        mdRightHeader.appendChild(mdRightHeaderLeft);
        mdRightHeader.appendChild(mdRightTools);
        const mdLeftCard = document.createElement('div');
        mdLeftCard.style.cssText = 'border:1px solid var(--primarycolor-light); border-radius: 20px; padding:12px; background:#FFFFFF; box-shadow: 0 6px 16px rgba(0,0,0,.06);';
        mdLeftCard.appendChild(mdLeftHeader);
        mdLeftCard.appendChild(mdArea);
        const mdRightCard = document.createElement('div');
        mdRightCard.style.cssText = 'border:1px solid var(--primarycolor-light); border-radius: 20px; padding:12px; background:#FFFFFF; box-shadow: 0 6px 16px rgba(0,0,0,.06);';
        mdRightCard.appendChild(mdRightHeader);
        mdRightCard.appendChild(mdTransformed);
        previewWrap.appendChild(mdLeftCard);
        previewWrap.appendChild(mdRightCard);
        mdLeftCopy.onclick = async () => {
            try {
                const text = mdArea.value || '';
                if (typeof GM_setClipboard === 'function') { GM_setClipboard(text); }
                else if (navigator.clipboard && navigator.clipboard.writeText) { await navigator.clipboard.writeText(text); }
                showNotification('å·²å¤åˆ¶åŸå§‹Markdown', 'success');
            } catch (e) {
                showNotification('å¤åˆ¶å¤±è´¥', 'error');
            }
        };
        mdLeftDownload.onclick = () => {
            try {
                const text = mdArea.value || '';
                const blob = new Blob([text], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const title = (document.title || 'markdown').replace(/[\\/:*?"<>|]/g, '_');
                a.href = url;
                a.download = `${title}-original.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('å·²ä¸‹è½½åŸå§‹Markdown', 'success');
            } catch (e) {
                showNotification('ä¸‹è½½å¤±è´¥', 'error');
            }
        };
        mdRightCopy.onclick = async () => {
            try {
                const text = mdTransformed.value || '';
                if (typeof GM_setClipboard === 'function') { GM_setClipboard(text); }
                else if (navigator.clipboard && navigator.clipboard.writeText) { await navigator.clipboard.writeText(text); }
                showNotification('å·²å¤åˆ¶æ¸…æ´—åMarkdown', 'success');
            } catch (e) {
                showNotification('å¤åˆ¶å¤±è´¥', 'error');
            }
        };
        mdRightDownload.onclick = () => {
            try {
                const text = mdTransformed.value || '';
                const blob = new Blob([text], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const title = (document.title || 'markdown').replace(/[\\/:*?"<>|]/g, '_');
                a.href = url;
                a.download = `${title}-clean.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('å·²ä¸‹è½½æ¸…æ´—åMarkdown', 'success');
            } catch (e) {
                showNotification('ä¸‹è½½å¤±è´¥', 'error');
            }
        };

        function addRow(r) {
            const row = document.createElement('div');
            row.style.cssText = `border:1px solid var(--primarycolor-light); border-radius: 20px; padding:${isMobile ? '10px' : '12px'}; background:#FFFFFF; box-shadow: 0 6px 16px rgba(0,0,0,.06); display:grid; grid-template-columns: ${isMobile ? '1fr' : '1fr 1fr'}; gap:${isMobile ? '8px' : '8px'};`;
            const name = document.createElement('input');
            name.placeholder = 'è§„åˆ™åç§°';
            name.value = (r && r.name) || '';
            name.style.cssText = `padding:${isMobile ? '8px' : '8px'}; border:1px solid var(--primarycolor-light); border-radius: 20px; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'grid-column: 1 / -1;' : ''}`;
            const enabledControlRow = document.createElement('div');
            enabledControlRow.style.cssText = `display:flex; align-items:center; ${isMobile ? 'grid-column: 1 / -1;' : ''}`;
            const enabledControl = createCustomCheckbox('rule-enabled-' + rows.length, !(r && r.enabled === false), 'å¯ç”¨');
            const enabledHidden = enabledControl.querySelector('input[type="checkbox"]');
            enabledControlRow.appendChild(enabledControl);
            const selectorForRule = document.createElement('input');
            selectorForRule.placeholder = 'è§„åˆ™é€‚ç”¨é€‰æ‹©å™¨(ç•™ç©ºé€šç”¨)';
            selectorForRule.value = (r && r.selector) || (selectorInput.value || '');
            selectorForRule.style.cssText = `padding:8px; border:1px solid var(--primarycolor-light); border-radius: 20px; height: 36px; box-sizing: border-box; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'grid-column: 1 / -1;' : ''}`;
            const globalControl = createCustomCheckbox('rule-global-' + rows.length, !!(r && r.global), 'å…¨å±€');
            const globalHidden = globalControl.querySelector('input[type="checkbox"]');
            const metaRow = document.createElement('div');
            metaRow.style.cssText = `display:flex; gap:${isMobile ? '8px' : '10px'}; align-items:center; ${isMobile ? 'grid-column: 1 / -1;' : ''}`;
            metaRow.appendChild(selectorForRule);
            metaRow.appendChild(globalControl);
            const pattern = document.createElement('input');
            pattern.placeholder = 'æ­£åˆ™ /pattern/flags æˆ– çº¯æ–‡æœ¬';
            pattern.value = (r && r.pattern) || '';
            pattern.style.cssText = `padding:8px; border:1px solid var(--primarycolor-light); border-radius: 20px; height: 36px; box-sizing: border-box; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'grid-column: 1 / -1;' : ''}`;
            const matchBadge = document.createElement('div');
            matchBadge.style.cssText = 'font-size:11px; color:#6B7280;';
            const targetSelect = document.createElement('select');
            targetSelect.style.cssText = `padding:8px; border:1px solid var(--primarycolor-light); border-radius: 20px; height:36px; box-sizing:border-box; font-size:${isMobile ? '13px' : '14px'}; ${isMobile ? 'grid-column: 1 / -1;' : ''}`;
            const targetOptions = [
                { value: 'markdown', label: 'Markdown æ­£åˆ™' },
                { value: 'html', label: 'HTML æ­£åˆ™' }
            ];
            targetOptions.forEach(opt => {
                const optionEl = document.createElement('option');
                optionEl.value = opt.value;
                optionEl.textContent = opt.label;
                targetSelect.appendChild(optionEl);
            });
            targetSelect.value = (r && r.target === 'html') ? 'html' : 'markdown';
            const flags = document.createElement('input');
            flags.placeholder = 'æ ‡å¿— gimsuy';
            flags.value = (r && r.flags) || 'g';
            flags.style.cssText = `padding:8px; border:1px solid var(--primarycolor-light); border-radius: 20px; height: 36px; box-sizing: border-box; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'grid-column: 1 / -1;' : ''}`;
            const replacement = document.createElement('textarea');
            replacement.placeholder = 'æ›¿æ¢æ–‡æœ¬';
            replacement.value = (r && r.replacement) || '';
            replacement.style.cssText = `grid-column: 1 / -1; min-height: ${isMobile ? '80px' : '100px'}; padding:10px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:#F9FAFB; font-size: ${isMobile ? '13px' : '14px'};`;
            const ops = document.createElement('div'); ops.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; ${isMobile ? 'grid-column: 1 / -1; flex-wrap: wrap;' : ''}`;
            const del = document.createElement('button'); del.textContent = 'åˆ é™¤'; del.style.cssText = `padding:${isMobile ? '6px 8px' : '8px 10px'}; border:none; border-radius: 20px; background: linear-gradient(135deg, var(--primarycolor-dark), var(--primarycolor)); color:#fff; font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`; del.onclick = () => { const idx = Array.from(ruleList.children).indexOf(row); if (idx >= 0) { rows.splice(idx, 1); } if (row.parentNode === ruleList) { ruleList.removeChild(row); } try { updateAllPreviews(); } catch(_) {} };
            const up = document.createElement('button'); up.textContent = 'ä¸Šç§»'; up.style.cssText = `padding:${isMobile ? '6px 8px' : '8px 10px'}; border:none; border-radius: 20px; border: 1px solid var(--primarycolor-light);background:white;color:var(--primarycolor); font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`; up.onclick = () => { const idx = Array.from(ruleList.children).indexOf(row); if (idx>0) { ruleList.insertBefore(row, ruleList.children[idx-1]); const t = rows[idx]; rows[idx]=rows[idx-1]; rows[idx-1]=t; } };
            const down = document.createElement('button'); down.textContent = 'ä¸‹ç§»'; down.style.cssText = `padding:${isMobile ? '6px 8px' : '8px 10px'}; border:none; border-radius: 20px; border: 1px solid var(--primarycolor-light);background:white;color:var(--primarycolor); font-size: ${isMobile ? '12px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`; down.onclick = () => { const idx = Array.from(ruleList.children).indexOf(row); if (idx<ruleList.children.length-1) { ruleList.insertBefore(ruleList.children[idx+1], row); const t = rows[idx]; rows[idx]=rows[idx+1]; rows[idx+1]=t; } };
            ops.appendChild(del); ops.appendChild(up); ops.appendChild(down);
            const patternWrap = document.createElement('div'); patternWrap.style.cssText = 'display:flex; flex-direction:column; gap:6px;'; patternWrap.appendChild(pattern); patternWrap.appendChild(matchBadge);
            row.appendChild(name); row.appendChild(enabledControlRow); row.appendChild(metaRow); row.appendChild(patternWrap); row.appendChild(targetSelect); row.appendChild(flags); row.appendChild(replacement); row.appendChild(ops);
            ruleList.appendChild(row);
            rows.push({ name, enabled: enabledHidden, pattern, flags, replacement, target: targetSelect, selector: selectorForRule, global: globalHidden });
            function computeMatches() { try { const p = (pattern.value || '').trim(); const f = (flags.value || 'g').trim(); let re = null; if (p.startsWith('/') && p.lastIndexOf('/') > 0) { const body = p.slice(1, p.lastIndexOf('/')); const flg = p.slice(p.lastIndexOf('/') + 1) || f; re = new RegExp(body, flg); } else if (p) { try { re = new RegExp(p, f); } catch(e) { re = new RegExp(p.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), f); } } else { matchBadge.textContent = 'è¯·è¾“å…¥æ¨¡å¼'; return; } const target = targetSelect.value; const text = String((target === 'html' ? htmlArea.value : mdArea.value) || ''); const m = text.match(re); const count = m ? m.length : 0; matchBadge.textContent = 'åŒ¹é… ' + count + ' å¤„'; } catch(_) { matchBadge.textContent = 'æ­£åˆ™æ— æ•ˆ'; } }
            pattern.addEventListener('input', computeMatches);
            flags.addEventListener('input', computeMatches);
            mdArea.addEventListener('input', computeMatches);
            setTimeout(computeMatches, 0);

            [name, pattern, flags, replacement, targetSelect].forEach(el => {
                el.addEventListener('input', () => {
                    updateAllPreviews();
                    computeMatches(); // Also update match count
                });
            });
            enabledHidden.addEventListener('change', () => {
                updateAllPreviews();
                computeMatches();
            });

        }

        function collectRulesFromRows() {
            return rows.map(r => {
                if (!r || !r.pattern) return null;
                const patternValue = (r.pattern.value || '').trim();
                if (!patternValue) return null;
                const sel = r.selector && r.selector.value ? r.selector.value.trim() : '';
                const glob = !!(r.global && r.global.checked);
                const obj = {
                    name: r.name.value || '',
                    pattern: patternValue,
                    flags: (r.flags.value || '').trim() || 'g',
                    replacement: r.replacement.value || '',
                    enabled: !!(r.enabled && r.enabled.checked),
                    target: (r.target && r.target.value === 'html') ? 'html' : 'markdown',
                    global: glob
                };
                if (sel) obj.selector = sel;
                return obj;
            }).filter(Boolean);
        }

        function reloadRuleRows(ruleDefs) {
            while (ruleList.firstChild) ruleList.removeChild(ruleList.firstChild);
            rows.length = 0;
            (ruleDefs || []).forEach(def => addRow(def));
        }

        rules.forEach(addRow);
        const addBtn = document.createElement('button');
        addBtn.textContent = 'æ–°å¢è§„åˆ™';
        addBtn.style.cssText = 'padding:8px 10px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff;';
        addBtn.onclick = () => addRow({ name:'', pattern:'', flags:'g', replacement:'', selector: selectorInput.value || '' });
        const tplBtn = document.createElement('button');
        tplBtn.textContent = 'å¸¸ç”¨æ¨¡æ¿';
        tplBtn.style.cssText = 'padding:8px 10px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff;';
        tplBtn.onclick = () => showTemplatePicker();

        function showTemplatePicker() {
            const pickerOverlay = document.createElement('div');
            pickerOverlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:10002; display:flex; align-items:center; justify-content:center; padding:16px;';
            const pickerCard = document.createElement('div');
            pickerCard.style.cssText = `width:${isMobile ? '100%' : '420px'}; max-width:100%; background:#fff; border-radius:16px; border:1px solid var(--primarycolor-light); box-shadow:0 18px 36px rgba(0,0,0,.12); padding:18px; display:flex; flex-direction:column; gap:12px;`;
            const pickerTitle = document.createElement('div');
            pickerTitle.textContent = 'é€‰æ‹©éœ€è¦æ·»åŠ çš„æ¨¡æ¿';
            pickerTitle.style.cssText = 'font-weight:700; font-size:16px; color:#111827;';
            const pickerDesc = document.createElement('div');
            pickerDesc.textContent = 'å‹¾é€‰åç‚¹å‡»â€œæ·»åŠ æ‰€é€‰â€å³å¯æ’å…¥å¯¹åº”è§„åˆ™';
            pickerDesc.style.cssText = 'font-size:12px; color:#6B7280;';
            const list = document.createElement('div');
            list.style.cssText = 'display:flex; flex-direction:column; gap:10px; max-height:45vh; overflow-y:auto; padding-right:4px;';

            templateOptions.forEach(option => {
                const item = document.createElement('label');
                item.style.cssText = 'display:flex; gap:10px; border:1px solid var(--primarycolor-light); border-radius: 20px; padding:10px; background:#F9FAFB; cursor:pointer;';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = option.id;
                checkbox.style.cssText = 'margin-top:3px;';
                const textWrap = document.createElement('div');
                const name = document.createElement('div');
                name.textContent = option.name;
                name.style.cssText = 'font-weight:600; font-size:14px; color:#111827;';
                const desc = document.createElement('div');
                desc.textContent = option.description || '';
                desc.style.cssText = 'font-size:12px; color:#6B7280;';
                textWrap.appendChild(name);
                textWrap.appendChild(desc);
                item.appendChild(checkbox);
                item.appendChild(textWrap);
                list.appendChild(item);
            });

            const actionRow = document.createElement('div');
            actionRow.style.cssText = 'display:flex; gap:10px; justify-content:flex-end;';
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.style.cssText = 'padding:8px 10px; border-radius: 20px; border:1px solid var(--primarycolor-light); background:#fff;';
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'æ·»åŠ æ‰€é€‰';
            confirmBtn.style.cssText = 'padding:8px 10px; border-radius: 20px; border:none; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff;';

            const closePicker = () => {
                if (pickerOverlay.parentNode) {
                    pickerOverlay.parentNode.removeChild(pickerOverlay);
                }
            };

            cancelBtn.onclick = closePicker;
            confirmBtn.onclick = () => {
                const checked = Array.from(list.querySelectorAll('input[type="checkbox"]:checked'));
                if (!checked.length) {
                    showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿', 'warning');
                    return;
                }
                checked.forEach(input => {
                    const tpl = getTemplateRule(input.value);
                    const def = cloneRuleDefinition(tpl);
                    if (def) addRow(def);
                });
                showNotification('å·²æ·»åŠ æ‰€é€‰æ¨¡æ¿', 'success');
                closePicker();
            };

            actionRow.appendChild(cancelBtn);
            actionRow.appendChild(confirmBtn);
            pickerCard.appendChild(pickerTitle);
            pickerCard.appendChild(pickerDesc);
            pickerCard.appendChild(list);
            pickerCard.appendChild(actionRow);
            pickerOverlay.appendChild(pickerCard);
            document.body.appendChild(pickerOverlay);
        }

        fetchBtn.onclick = () => {
            const sel = selectorInput.value.trim();
            if (!sel) {
                showNotification('è¯·å…ˆè¾“å…¥é€‰æ‹©å™¨', 'error');
                return;
            }

            let els;
            try {
                els = Array.from(document.querySelectorAll(sel));
            } catch (selectorError) {
                console.error('é€‰æ‹©å™¨æ— æ•ˆ:', selectorError);
                showNotification(`é€‰æ‹©å™¨æ— æ•ˆ: ${selectorError.message || selectorError}`, 'error');
                return;
            }

            if (!els.length) {
                showNotification('æœªæ‰¾åˆ°åŒ¹é…å†…å®¹', 'error');
                return;
            }

            let contentHtml = '';
            const idxRaw = pickIndex.value.trim();
            const idxStr = idxRaw.toLowerCase();
            const useAll = !idxRaw || idxStr === 'all';
            const sep = sepInput.value || '\n\n';

            if (useAll) {
                els.forEach((el, i) => {
                    const clone = el.cloneNode(true);
                    const h = textOnlyHidden.checked ? (clone.textContent || '') : clone.outerHTML;
                    contentHtml += (i > 0 ? sep : '') + h;
                });
            } else if (idxStr === 'last') {
                const clone = els[els.length - 1].cloneNode(true);
                contentHtml = textOnlyHidden.checked ? (clone.textContent || '') : clone.outerHTML;
            } else {
                const i = parseInt(idxStr, 10);
                if (!isNaN(i) && i >= 0 && i < els.length) {
                    const clone = els[i].cloneNode(true);
                    contentHtml = textOnlyHidden.checked ? (clone.textContent || '') : clone.outerHTML;
                } else {
                    showNotification('ç´¢å¼•è¶…å‡ºèŒƒå›´', 'error');
                    return;
                }
            }

            if (!contentHtml.trim()) {
                showNotification('åŒ¹é…å…ƒç´ æ²¡æœ‰å¯ç”¨å†…å®¹', 'error');
                return;
            }

            try {
                htmlArea.value = contentHtml;
                const cfgX = getMarkdownTransformConfig();
                const selectorSpecific = (cfgX.selectorRules && sel) ? cfgX.selectorRules[sel] : null;
                const rulesForSel = Array.isArray(selectorSpecific) ? selectorSpecific : (cfgX.rules || []);
                const processedHtml = (cfgX.enabled && rulesForSel.length) ? applyHtmlTransformRules(contentHtml, rulesForSel) : contentHtml;
                cleanedHtmlArea.value = processedHtml;
                function toNativeMarkdown(mdObj) {
                    try {
                        let md = String((mdObj && mdObj.markdown) || '');
                        const imgs = Array.isArray(mdObj && mdObj.images) ? mdObj.images : [];
                        const vids = Array.isArray(mdObj && mdObj.videos) ? mdObj.videos : [];
                        const bms = Array.isArray(mdObj && mdObj.bookmarks) ? mdObj.bookmarks : [];
                        imgs.forEach(img => {
                            if (!img || !img.id || !img.url) return;
                            const alt = (img.alt || 'å›¾ç‰‡').trim();
                            const rep = `![${alt}](${img.url})`;
                            md = md.replace(new RegExp(img.id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), rep);
                        });
                        vids.forEach(v => {
                            if (!v || !v.id || !v.url) return;
                            const title = (v.title || 'è§†é¢‘').trim();
                            const rep = `[${title}](${v.url})`;
                            md = md.replace(new RegExp(v.id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), rep);
                        });
                        bms.forEach(b => {
                            if (!b || !b.id || !b.url) return;
                            const rep = `[é“¾æ¥](${b.url})`;
                            md = md.replace(new RegExp(b.id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), rep);
                        });
                        return md;
                    } catch (_) { return (mdObj && mdObj.markdown) || ''; }
                }
                const mdData = convertHtmlToMarkdown(processedHtml);
                lastMdData = mdData;
                const nativeMd = toNativeMarkdown(mdData);
                mdArea.value = nativeMd;
                const out = (cfgX.enabled && rulesForSel.length) ? applyMarkdownTransformRules(nativeMd, rulesForSel) : { markdown: nativeMd, images: mdData.images || [], videos: mdData.videos || [], bookmarks: mdData.bookmarks || [] };
                mdTransformed.value = out.markdown || nativeMd;
                // updateBadges();
            } catch (convertError) {
                console.error('ç”Ÿæˆ Markdown å¤±è´¥:', convertError);
                showNotification(`ç”Ÿæˆå¤±è´¥: ${convertError.message || convertError}`, 'error');
            }
        };

        function updateAllPreviews() {
            try {
                const sel = (selectorInput.value || '').trim();
                const currentRules = collectRulesFromRows().filter(r => r.enabled);
                const effective = currentRules.filter(r => !r.selector || (sel && r.selector === sel));

                const htmlRules = effective.filter(r => r.target === 'html');
                const markdownRules = effective.filter(r => r.target === 'markdown');

                const processedHtml = applyHtmlTransformRules(htmlArea.value, htmlRules);
                cleanedHtmlArea.value = processedHtml;

                const mdData = convertHtmlToMarkdown(processedHtml);
                lastMdData = mdData;
                const nativeMd = (function(mdObj){
                    try {
                        let md = String((mdObj && mdObj.markdown) || '');
                        const imgs = Array.isArray(mdObj && mdObj.images) ? mdObj.images : [];
                        const vids = Array.isArray(mdObj && mdObj.videos) ? mdObj.videos : [];
                        const bms = Array.isArray(mdObj && mdObj.bookmarks) ? mdObj.bookmarks : [];
                        imgs.forEach(img => {
                            if (!img || !img.id || !img.url) return;
                            const alt = (img.alt || 'å›¾ç‰‡').trim();
                            const rep = `![${alt}](${img.url})`;
                            md = md.replace(new RegExp(img.id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), rep);
                        });
                        vids.forEach(v => {
                            if (!v || !v.id || !v.url) return;
                            const title = (v.title || 'è§†é¢‘').trim();
                            const rep = `[${title}](${v.url})`;
                            md = md.replace(new RegExp(v.id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), rep);
                        });
                        bms.forEach(b => {
                            if (!b || !b.id || !b.url) return;
                            const rep = `[é“¾æ¥](${b.url})`;
                            md = md.replace(new RegExp(b.id.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), rep);
                        });
                        return md;
                    } catch (_) { return (mdObj && mdObj.markdown) || ''; }
                })(mdData);
                mdArea.value = nativeMd;

                const finalObj = applyMarkdownTransformRules(nativeMd, markdownRules);
                mdTransformed.value = finalObj.markdown || nativeMd;

            } catch (e) {
                console.error("Preview update failed", e);
                showNotification('é¢„è§ˆæ›´æ–°å¤±è´¥: ' + e.message, 'error');
            }
        }

        const testBtn = document.createElement('button');
        testBtn.textContent = 'åº”ç”¨è§„åˆ™é¢„è§ˆ';
        testBtn.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; font-size: ${isMobile ? '12px' : '14px'};`;
        testBtn.onclick = updateAllPreviews;

        const opsRow = document.createElement('div'); opsRow.style.cssText = `display:flex; gap:${isMobile ? '6px' : '8px'}; justify-content:flex-end; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
        const closeBtn = document.createElement('button'); closeBtn.textContent = 'å…³é—­'; closeBtn.style.cssText = `padding: ${isMobile ? '8px' : '8px 10px'}; border: 1px solid var(--primarycolor-light); border-radius: 20px; background: #fff; cursor: pointer; color:#111827; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`; closeBtn.onclick = () => document.body.removeChild(overlay);
        const saveBtn = document.createElement('button'); saveBtn.textContent = 'ä¿å­˜è§„åˆ™'; saveBtn.style.cssText = `padding: ${isMobile ? '8px' : '8px 10px'}; border: none; border-radius: 20px; cursor:pointer;  border: 1px solid var(--primarycolor-light);background:white;color:#111827; font-size: ${isMobile ? '13px' : '14px'}; ${isMobile ? 'flex: 1; min-width: 0;' : ''}`;
        saveBtn.onclick = () => {
            try {
                const allRules = collectRulesFromRows();
                const host = (location && location.hostname) ? location.hostname : '';
                const domainKey = 'markdown_transform_rules_' + host;
                const globalKey = 'markdown_transform_rules';

                const domainRules = allRules.filter(r => !r.global);
                const globalRules = allRules.filter(r => r.global);

                GM_setValue(domainKey, domainRules);
                GM_setValue(globalKey, globalRules);

                const useDomain = !!useDomainHidden.checked;
                GM_setValue('markdown_transform_use_domain', useDomain);
                const enabledKey = useDomain ? ('markdown_transform_enabled_' + host) : 'markdown_transform_enabled';
                GM_setValue(enabledKey, !!enabledHidden.checked);

                showNotification('å·²ä¿å­˜ Markdown è½¬æ¢è§„åˆ™', 'success');
                document.body.removeChild(overlay);
            } catch(_) { showNotification('ä¿å­˜å¤±è´¥', 'error'); }
        };

        const controls = document.createElement('div');
        controls.style.cssText = `display:flex; flex-direction:column; gap:${isMobile ? '8px' : '10px'}; margin-bottom:12px; padding:${isMobile ? '12px' : '16px'}; border:1px solid var(--primarycolor-light); border-radius:14px; background:#FFFFFF; box-shadow: 0 8px 20px rgba(0,0,0,.06);`;
        const controlsTitle = document.createElement('div');
        controlsTitle.textContent = 'æŠ“å–è®¾ç½®';
        controlsTitle.style.cssText = 'font-weight:700; font-size:14px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;';
        const selectorRow = document.createElement('div');
        selectorRow.style.cssText = `display:flex; gap:${isMobile ? '6px' : '10px'}; align-items:flex-end; ${isMobile ? 'flex-wrap: wrap;' : ''}`;
        const selectorCol = document.createElement('div');
        selectorCol.style.cssText = 'flex:1; display:flex; flex-direction:column; gap:6px;';
        const selectorLabel = document.createElement('div');
        selectorLabel.textContent = 'å†…å®¹é€‰æ‹©å™¨';
        selectorLabel.style.cssText = 'font-size:12px; color:#6B7280;';
        selectorCol.appendChild(selectorLabel);
        selectorCol.appendChild(selectorInput);
        const pickBtn = document.createElement('button');
        pickBtn.textContent = 'æ‹¾å–é¡µé¢å…ƒç´ ';
        pickBtn.style.cssText = 'background:white;padding:10px 12px; border:none; border-radius: 20px; border: 1px solid var(--primarycolor-light);color:var(--primarycolor)';
        pickBtn.onclick = (e) => {
            try {
                const selectorTool = new SelectorTool();
                const originalDisplay = overlay.style.display;

                // æ”¶é›†æ‰€æœ‰éœ€è¦éšè—çš„å¯¹è¯æ¡†å’Œoverlay
                const configDialog = document.getElementById('config-dialog');
                const stepOverlay = document.querySelector('div[style*="backdrop-filter"]');
                const allOverlays = document.querySelectorAll('div[style*="z-index"]');
                const pickerOverlays = document.querySelectorAll('div[style*="position:fixed"][style*="inset:0"]');

                // ä¿å­˜åŸå§‹æ˜¾ç¤ºçŠ¶æ€
                const originalConfigDisplay = configDialog ? configDialog.style.display : '';
                const originalStepDisplay = stepOverlay ? stepOverlay.style.display : '';
                const originalOverlayDisplays = new Map();
                const originalPickerDisplays = new Map();

                allOverlays.forEach((el, idx) => {
                    if (el !== overlay && el !== stepOverlay) {
                        originalOverlayDisplays.set(el, el.style.display);
                        el.style.display = 'none';
                    }
                });

                pickerOverlays.forEach((el, idx) => {
                    if (el !== overlay && el !== stepOverlay) {
                        originalPickerDisplays.set(el, el.style.display);
                        el.style.display = 'none';
                    }
                });

                // éšè—ä¸»å¯¹è¯æ¡†å’Œoverlay
                overlay.style.display = 'none';
                if (configDialog) configDialog.style.display = 'none';
                if (stepOverlay) stepOverlay.style.display = 'none';

                selectorTool.showConfigDialog = () => {
                    overlay.style.display = originalDisplay || 'flex';
                    if (configDialog) {
                        configDialog.style.display = originalConfigDisplay || 'flex';
                    }
                    if (stepOverlay) {
                        stepOverlay.style.display = originalStepDisplay || 'flex';
                        if (window.innerWidth <= 768) {
                            stepOverlay.style.position = 'fixed';
                            stepOverlay.style.top = '0';
                            stepOverlay.style.left = '0';
                            stepOverlay.style.width = '100%';
                            stepOverlay.style.height = '100%';
                            stepOverlay.style.zIndex = '10000';
                            stepOverlay.style.display = 'flex';
                            stepOverlay.style.justifyContent = 'center';
                            stepOverlay.style.alignItems = 'center';
                        }
                    }

                };

                selectorTool.toggleSelectionMode(e, 'markdownContentSelector');
            } catch(_) {
                overlay.style.display = 'flex';
            }
        };
        selectorRow.appendChild(selectorCol);
        selectorRow.appendChild(pickBtn);
        fetchBtn.style.cssText = 'padding:10px 12px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; box-shadow: 0 6px 14px var(--primarycolor-lighter);';
        selectorRow.appendChild(fetchBtn);
        const optionsRow = document.createElement('div');
        optionsRow.style.cssText = `display:grid; grid-template-columns: ${isMobile ? '1fr' : '140px auto 1fr'}; gap:${isMobile ? '8px' : '10px'}; align-items:center;`;
        const indexField = document.createElement('div');
        indexField.style.cssText = 'display:flex; flex-direction:column; gap:6px;';
        const indexLabel = document.createElement('div');
        indexLabel.textContent = 'ç´¢å¼•(é»˜è®¤å…¨éƒ¨)';
        indexLabel.style.cssText = 'font-size:12px; color:#6B7280;';
        indexField.appendChild(indexLabel);
        indexField.appendChild(pickIndex);
        const textOnlyField = document.createElement('div');
        textOnlyField.style.cssText = 'display:flex; align-items:center; height:100%;';
        textOnlyField.appendChild(textOnlyControl);
        const sepField = document.createElement('div');
        sepField.style.cssText = 'display:flex; flex-direction:column; gap:6px;';
        const sepLabel = document.createElement('div');
        sepLabel.textContent = 'åˆå¹¶åˆ†éš”ç¬¦';
        sepLabel.style.cssText = 'font-size:12px; color:#6B7280;';
        sepField.appendChild(sepLabel);
        sepField.appendChild(sepInput);
        optionsRow.appendChild(indexField);
        optionsRow.appendChild(textOnlyField);
        optionsRow.appendChild(sepField);
        controls.appendChild(controlsTitle);
        controls.appendChild(selectorRow);
        controls.appendChild(optionsRow);

        exportBtn.onclick = () => {
            try {
                const cfg = getMarkdownTransformConfig();
                const txt = JSON.stringify(cfg.allRules || [], null, 2);
                if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(txt); showNotification('å·²å¤åˆ¶è§„åˆ™åˆ°å‰ªè´´æ¿', 'success'); }
                else { alert(txt); }
            } catch(_) { showNotification('å¯¼å‡ºå¤±è´¥', 'error'); }
        };
        importBtn.onclick = () => {
            try {
                const txt = prompt('ç²˜è´´è§„åˆ™JSON');
                if (!txt) return;
                const arr = JSON.parse(txt);
                if (Array.isArray(arr)) {
                    reloadRuleRows(arr);
                    showNotification('å·²è½½å…¥è§„åˆ™', 'success');
                }
            } catch(_) { showNotification('å¯¼å…¥å¤±è´¥', 'error'); }
        };

        dialog.appendChild(title);
        dialog.appendChild(subtitle);
        dialog.appendChild(topBar);
        dialog.appendChild(controls);
        dialog.appendChild(htmlCard);
        dialog.appendChild(previewWrap);
        const ruleHeader = document.createElement('div'); ruleHeader.style.cssText = `display:flex; align-items:center; justify-content:space-between; margin:12px 0; ${isMobile ? 'flex-direction:column; align-items:stretch; gap:8px;' : ''}`;
        const ruleHeaderTitle = document.createElement('div'); ruleHeaderTitle.textContent = 'Markdown æ­£åˆ™è§„åˆ™'; ruleHeaderTitle.style.cssText = `font-weight:700; font-size:14px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; ${isMobile ? 'text-align:left;' : ''}`;
        const presetRow = document.createElement('div'); presetRow.style.cssText = `${isMobile ? 'display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; align-items:center;' : 'display:flex; gap:8px; align-items:center;'}`;
        const presetSelect = document.createElement('select'); presetSelect.style.cssText = `padding:8px 10px; border:1px solid var(--primarycolor-light); border-radius: 20px; background:#fff; ${isMobile ? 'grid-column:1 / -1; height:36px; width:-webkit-fill-available;' : ''}`;
        const presetLoadBtn = document.createElement('button'); presetLoadBtn.textContent = 'è½½å…¥é¢„è®¾'; presetLoadBtn.style.cssText = `padding:8px 10px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; ${isMobile ? 'height:36px; min-width:0;' : ''}`;
        const presetSaveBtn = document.createElement('button'); presetSaveBtn.textContent = 'å¦å­˜ä¸ºé¢„è®¾'; presetSaveBtn.style.cssText = `padding:8px 10px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; ${isMobile ? 'height:36px; min-width:0;' : ''}`;
        const presetDeleteBtn = document.createElement('button'); presetDeleteBtn.textContent = 'åˆ é™¤é¢„è®¾'; presetDeleteBtn.style.cssText = `padding:8px 10px; border:none; border-radius: 20px; background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark)); color:#fff; ${isMobile ? 'height:36px; min-width:0;' : ''}`;
        presetRow.appendChild(presetSelect);
        presetRow.appendChild(presetLoadBtn);
        presetRow.appendChild(presetSaveBtn);
        presetRow.appendChild(presetDeleteBtn);
        ruleHeader.appendChild(ruleHeaderTitle);
        ruleHeader.appendChild(presetRow);

        function getUserRulePresets() {
            try {
                const stored = GM_getValue(PRESET_STORAGE_KEY, []);
                if (!Array.isArray(stored)) return [];
                return stored.map(item => ({
                    id: item && item.id ? item.id : `user-${Date.now()}-${Math.random()}`,
                    name: item && item.name ? String(item.name) : 'æœªå‘½åé¢„è®¾',
                    rules: Array.isArray(item && item.rules) ? item.rules : []
                }));
            } catch (_) {
                return [];
            }
        }

        function persistUserRulePresets(list) {
            try {
                GM_setValue(PRESET_STORAGE_KEY, list);
            } catch (_) {}
        }

        function getAllRulePresets() {
            const customs = getUserRulePresets();
            return [...builtinRulePresets, ...customs].filter(Boolean);
        }

        function refreshPresetSelect(selectedValue) {
            while (presetSelect.firstChild) presetSelect.removeChild(presetSelect.firstChild);
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'é€‰æ‹©é¢„è®¾';
            presetSelect.appendChild(placeholder);
            getAllRulePresets().forEach(preset => {
                if (!preset) return;
                const opt = document.createElement('option');
                opt.value = preset.id;
                opt.textContent = preset.name + (preset.builtin ? 'ï¼ˆå†…ç½®ï¼‰' : '');
                opt.dataset.source = preset.builtin ? 'builtin' : 'user';
                presetSelect.appendChild(opt);
            });
            if (selectedValue) presetSelect.value = selectedValue;
        }

        refreshPresetSelect();

        presetLoadBtn.onclick = () => {
            const presetId = presetSelect.value;
            if (!presetId) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦è½½å…¥çš„é¢„è®¾', 'warning');
                return;
            }
            const preset = getAllRulePresets().find(p => p && p.id === presetId);
            if (!preset || !Array.isArray(preset.rules) || !preset.rules.length) {
                showNotification('è¯¥é¢„è®¾æ²¡æœ‰è§„åˆ™', 'warning');
                return;
            }
            if (!confirm('è½½å…¥é¢„è®¾å°†è¦†ç›–å½“å‰è§„åˆ™ï¼Œç¡®å®šç»§ç»­ï¼Ÿ')) return;
            const clonedRules = preset.rules.map(cloneRuleDefinition).filter(Boolean);
            reloadRuleRows(clonedRules);
            showNotification('å·²è½½å…¥é¢„è®¾', 'success');
        };

        presetSaveBtn.onclick = () => {
            const currentRules = collectRulesFromRows();
            if (!currentRules.length) {
                showNotification('å½“å‰æ²¡æœ‰å¯ä¿å­˜çš„è§„åˆ™', 'warning');
                return;
            }
            const suggestedName = presetSelect.value ? presetSelect.options[presetSelect.selectedIndex].textContent.replace('ï¼ˆå†…ç½®ï¼‰', '') : '';
            const name = prompt('è¾“å…¥é¢„è®¾åç§°', suggestedName || '');
            if (!name) return;
            const userPresets = getUserRulePresets();
            const existingIdx = userPresets.findIndex(p => p.name === name);
            const newPreset = {
                id: existingIdx >= 0 ? userPresets[existingIdx].id : `user-${Date.now()}`,
                name,
                rules: currentRules.map(cloneRuleDefinition)
            };
            if (existingIdx >= 0) {
                userPresets[existingIdx] = newPreset;
            } else {
                userPresets.push(newPreset);
            }
            persistUserRulePresets(userPresets);
            refreshPresetSelect(newPreset.id);
            showNotification('é¢„è®¾å·²ä¿å­˜', 'success');
        };

        presetDeleteBtn.onclick = () => {
            const presetId = presetSelect.value;
            if (!presetId) {
                showNotification('è¯·é€‰æ‹©è¦åˆ é™¤çš„é¢„è®¾', 'warning');
                return;
            }
            const selectedOption = presetSelect.options[presetSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.source === 'builtin') {
                showNotification('å†…ç½®é¢„è®¾ä¸å¯åˆ é™¤', 'warning');
                return;
            }
            const userPresets = getUserRulePresets();
            const idx = userPresets.findIndex(p => p.id === presetId);
            if (idx === -1) {
                showNotification('ä»…èƒ½åˆ é™¤è‡ªå®šä¹‰é¢„è®¾', 'warning');
                return;
            }
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥é¢„è®¾ï¼Ÿ')) return;
            userPresets.splice(idx, 1);
            persistUserRulePresets(userPresets);
            refreshPresetSelect('');
            showNotification('å·²åˆ é™¤é¢„è®¾', 'success');
        };
        dialog.appendChild(ruleHeader);
        dialog.appendChild(ruleList);
        const btns = document.createElement('div'); btns.style.cssText = `display:grid;grid-template-columns: ${isMobile ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)'}; gap:${isMobile ? '6px' : '8px'}; justify-content:flex-end; margin-top:8px;`;
        btns.appendChild(addBtn);
        btns.appendChild(tplBtn);
        const copyBlocksBtn = document.createElement('button'); copyBlocksBtn.textContent = 'å¤åˆ¶ä¸ºNotionå—'; copyBlocksBtn.style.cssText = `padding:${isMobile ? '8px' : '8px 10px'}; border-radius: 20px; border: 1px solid var(--primarycolor-light);background:white; font-size: ${isMobile ? '12px' : '14px'};color:#111827;`;
        copyBlocksBtn.onclick = async () => { try { const data = { markdown: mdTransformed.value || '', images: [], videos: [], bookmarks: [] }; const blocks = await convertToNotionBlocks(data); const json = JSON.stringify(blocks); if (navigator.clipboard) { await navigator.clipboard.writeText(json); showNotification('å·²å¤åˆ¶Notionå—JSON', 'success'); } } catch(_) { showNotification('å¤åˆ¶å¤±è´¥', 'error'); } };
        btns.appendChild(testBtn);
        btns.appendChild(copyBlocksBtn);
        btns.appendChild(closeBtn);
        btns.appendChild(saveBtn);
        dialog.appendChild(btns);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
    }


    // åœ¨åº”ç”¨è‡ªå®šä¹‰æ ·å¼åï¼Œè‹¥æµ…è‰²ç­‰äºä¸»è‰²ï¼Œåˆ™å¼ºåˆ¶æ¨å¯¼æ›´æµ…è‰²ï¼Œé¿å…è¢«è¦†ç›–ä¸ºåŒè‰²
    function enforceLighterShades() {
        try {
            const cs = getComputedStyle(document.documentElement);
            const p = (cs.getPropertyValue('--primarycolor') || '').trim();
            const pl = (cs.getPropertyValue('--primarycolor-light') || '').trim();
            const pll = (cs.getPropertyValue('--primarycolor-lighter') || '').trim();
            const equal = (a, b) => String(a || '').trim().toLowerCase() === String(b || '').trim().toLowerCase();
            if (p) {
                if (!pl || equal(pl, p)) {
                    document.documentElement.style.setProperty('--primarycolor-light', lightenColor(p, 25));
                }
                if (!pll || equal(pll, p)) {
                    document.documentElement.style.setProperty('--primarycolor-lighter', lightenColor(p, 80));
                }
            }
        } catch (_) {}
    }

    // å…¨å±€ç‚¹å‡»åï¼Œå¯èƒ½ä¼šè§¦å‘UIé‡ç»˜ï¼Œå¼ºåˆ¶ç»´æŒæµ…è‰²å…³ç³»ï¼ˆä½¿ç”¨å»¶è¿Ÿä¸å¸§å›è°ƒç¡®ä¿åœ¨æ›´æ–°ä¹‹åæ‰§è¡Œï¼‰
    document.addEventListener('click', () => {
        const run = () => enforceLighterShades();
        try {
            setTimeout(run, 0);
        } catch(_) {}
        try {
            requestAnimationFrame(run);
            requestAnimationFrame(() => requestAnimationFrame(run));
        } catch(_) {}
    }, true);

    // ç›‘æ§æ ·å¼æ³¨å…¥æˆ–æ ¹èŠ‚ç‚¹æ ·å¼å˜åŒ–ï¼Œè‡ªåŠ¨æ ¡æ­£æµ…è‰²å˜é‡
    (function initLightColorObserver(){
        try {
            if (window.__clipperLightObserverInited) return;
            window.__clipperLightObserverInited = true;
            const observer = new MutationObserver(() => {
                enforceLighterShades();
            });
            observer.observe(document.documentElement, { attributes: true, attributeFilter: ['style'] });
            observer.observe(document.head, { childList: true, subtree: true });
        } catch(_) {}
    })();

    // å·¥å…·ï¼šHEX è½¬ RGBAï¼Œå¸¦é€æ˜åº¦ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
    function hexToRgba(hex, alphaPercent) {
        try {
            const a = Math.max(0, Math.min(100, parseInt(alphaPercent || 100))) / 100;
            const cleaned = (hex || '').replace('#','');
            const bigint = parseInt(cleaned.length === 3 ? cleaned.split('').map(c=>c+c).join('') : cleaned, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            if (isNaN(r) || isNaN(g) || isNaN(b)) return hex || '#ffffff';
            return `rgba(${r}, ${g}, ${b}, ${a})`;
        } catch (_) {
            return hex || '#ffffff';
        }
    }

    // å°†é¢œè‰²å‘ç™½è‰²æäº®ï¼Œpercent: 0-100
    function lightenColor(color, percent) {
        try {
            const p = Math.max(0, Math.min(100, parseFloat(percent || 0))) / 100;
            const str = String(color || '').trim();
            const hexMatch = /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/;
            const rgbMatch = /^rgba?\(([^\)]*)\)$/i;
            const hslMatch = /^hsla?\(([^\)]*)\)$/i;

            const clamp = (v) => Math.max(0, Math.min(255, Math.round(v)));

            if (hexMatch.test(str)) {
                const cleaned = str.replace('#', '');
                const full = cleaned.length === 3 ? cleaned.split('').map(c=>c+c).join('') : cleaned;
                const bigint = parseInt(full, 16);
                const r = (bigint >> 16) & 255;
                const g = (bigint >> 8) & 255;
                const b = bigint & 255;
                const nr = clamp(r + (255 - r) * p);
                const ng = clamp(g + (255 - g) * p);
                const nb = clamp(b + (255 - b) * p);
                return `rgba(${nr}, ${ng}, ${nb}, 1)`;
            }
            if (rgbMatch.test(str)) {
                const parts = str.match(rgbMatch)[1].split(',').map(s=>s.trim());
                const r = parseFloat(parts[0]);
                const g = parseFloat(parts[1]);
                const b = parseFloat(parts[2]);
                const a = parts.length > 3 ? parseFloat(parts[3]) : 1;
                const nr = clamp(r + (255 - r) * p);
                const ng = clamp(g + (255 - g) * p);
                const nb = clamp(b + (255 - b) * p);
                const na = isNaN(a) ? 1 : a;
                return `rgba(${nr}, ${ng}, ${nb}, ${na})`;
            }
            if (hslMatch.test(str)) {
                const inner = str.match(hslMatch)[1].trim();
                const normalized = inner.replace(/\s*\/\s*/g, ',');
                const tokens = normalized.split(/\s*,\s*|\s+/).filter(Boolean);
                const hRaw = tokens[0] || '0';
                const sRaw = tokens[1] || '0%';
                const lRaw = tokens[2] || '0%';
                const aRaw = tokens[3];
                const h = parseFloat(String(hRaw).replace(/deg|rad|grad|turn/g, ''));
                const s = Math.max(0, Math.min(100, parseFloat(String(sRaw).replace('%',''))));
                const l = Math.max(0, Math.min(100, parseFloat(String(lRaw).replace('%',''))));
                const newL = Math.max(0, Math.min(100, l + (100 - l) * p));
                if (aRaw != null && aRaw !== '') {
                    const a = Math.max(0, Math.min(1, parseFloat(aRaw)));
                    return `hsla(${isNaN(h)?0:h}, ${s}%, ${newL}%, ${isNaN(a)?1:a})`;
                }
                return `hsl(${isNaN(h)?0:h}, ${s}%, ${newL}%)`;
            }
            return str;
        } catch (_) {
            return color;
        }
    }

    // æ™ºèƒ½æå–ä¼˜åŒ–å‡½æ•°
    function enhanceExtractionAccuracy(siteConfig, extractedData) {
        if (!SMART_EXTRACTION_CONFIG.enabled) {
            return extractedData;
        }

        const enhancedData = { ...extractedData };

        // 1. æ™ºèƒ½ä¹¦åæå–ä¼˜åŒ– - åªæœ‰åœ¨é…ç½®çš„é€‰æ‹©å™¨å®Œå…¨æ— æ³•æå–æ—¶æ‰ä½¿ç”¨
        if (!enhancedData.ä¹¦å || enhancedData.ä¹¦å.trim() === '') {
            console.log('é…ç½®çš„é€‰æ‹©å™¨æ— æ³•æå–ä¹¦åï¼Œå°è¯•æ™ºèƒ½æå–');
            enhancedData.ä¹¦å = smartExtractTitle();
        } else {
            console.log('ä½¿ç”¨é…ç½®çš„é€‰æ‹©å™¨æå–çš„ä¹¦å:', enhancedData.ä¹¦å);
        }

        // 2. æ™ºèƒ½ä½œè€…æå–ä¼˜åŒ– (å‰ªè—æ¨¡å¼è·³è¿‡ï¼Œé¿å…è¯¯æå–"ä½œè€…"å­—æ ·)
        if (!enhancedData.ä½œè€… || enhancedData.ä½œè€….trim() === '') {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå‰ªè—æ¨¡å¼ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡æ™ºèƒ½æå–
            if (siteConfig.contentType !== 'clip') {
                enhancedData.ä½œè€… = smartExtractAuthor();
            }
        }

        // 3. æ™ºèƒ½ç®€ä»‹æå–ä¼˜åŒ–
        if (!enhancedData.ç®€ä»‹ || enhancedData.ç®€ä»‹.trim() === '') {
            enhancedData.ç®€ä»‹ = smartExtractDescription();
        }

        // 4. æ™ºèƒ½ç« èŠ‚æå–ä¼˜åŒ–
        if (!enhancedData.æœ€æ–°ç« èŠ‚ || enhancedData.æœ€æ–°ç« èŠ‚.trim() === '') {
            enhancedData.æœ€æ–°ç« èŠ‚ = smartExtractLatestChapter();
        }

        // 5. å†…å®¹åˆ†æå’Œæ¸…ç†ï¼ˆç®€ä»‹å­—æ®µä¿ç•™æ¢è¡Œç¬¦ï¼‰
        if (SMART_EXTRACTION_CONFIG.contentAnalysis) {
            enhancedData.ç®€ä»‹ = analyzeAndCleanContent(enhancedData.ç®€ä»‹, true); // ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºä¿ç•™æ¢è¡Œç¬¦
        }

        return enhancedData;
    }

    // æ™ºèƒ½æå–æ ‡é¢˜
    function smartExtractTitle() {
        const titleSelectors = [
            'h1',
            '.title',
            '.book-title',
            '.comic-title',
            '.novel-title',
            '[class*="title"]',
            'meta[property="og:title"]'
        ];

        // ä¼˜å…ˆå°è¯•é¡µé¢ä¸­çš„æ ‡é¢˜å…ƒç´ 
        for (const selector of titleSelectors) {
            const element = document.querySelector(selector);
            if (element) {
                let title = element.textContent || element.content || '';
                title = cleanTitle(title);
                if (title && title.length > 1 && title.length < 100) {
                    console.log(`æ™ºèƒ½æå–æ ‡é¢˜: ${title} (é€‰æ‹©å™¨: ${selector})`);
                    return title;
                }
            }
        }

        // æœ€åæ‰å°è¯•document.titleï¼Œä½†è¦è¿›è¡Œæ›´ä¸¥æ ¼çš„è¿‡æ»¤
        const pageTitle = document.title.trim();
        if (pageTitle) {
            // è¿‡æ»¤æ‰å¸¸è§çš„ç½‘ç«™åç¼€å’Œåˆ†éš”ç¬¦
            let cleanPageTitle = pageTitle
            .split('|')[0]  // å»æ‰ | åé¢çš„å†…å®¹
            .split('-')[0]  // å»æ‰ - åé¢çš„å†…å®¹
            .split('_')[0]  // å»æ‰ _ åé¢çš„å†…å®¹
            .split('|')[0]  // å†æ¬¡å¤„ç† | åˆ†éš”ç¬¦
            .trim();

            // è¿‡æ»¤æ‰å¸¸è§çš„ç½‘ç«™åç§°åç¼€
            const siteSuffixes = [
                ' - åœ¨çº¿è§‚çœ‹', ' - å…è´¹é˜…è¯»', ' - æœ€æ–°ç« èŠ‚', ' - æ¼«ç”»', ' - å°è¯´',
                ' | åœ¨çº¿è§‚çœ‹', ' | å…è´¹é˜…è¯»', ' | æœ€æ–°ç« èŠ‚', ' | æ¼«ç”»', ' | å°è¯´',
                ' - åŠ¨æ¼«', ' - åŠ¨ç”»', ' - æ¼«ç”»ç½‘', ' - å°è¯´ç½‘',
                ' | åŠ¨æ¼«', ' | åŠ¨ç”»', ' | æ¼«ç”»ç½‘', ' | å°è¯´ç½‘'
            ];

            for (const suffix of siteSuffixes) {
                if (cleanPageTitle.endsWith(suffix)) {
                    cleanPageTitle = cleanPageTitle.slice(0, -suffix.length).trim();
                }
            }

            cleanPageTitle = cleanTitle(cleanPageTitle);

            // ç¡®ä¿æ ‡é¢˜é•¿åº¦åˆç†ä¸”ä¸æ˜¯çº¯æ•°å­—
            if (cleanPageTitle && cleanPageTitle.length > 1 && cleanPageTitle.length < 100 && !/^\d+$/.test(cleanPageTitle)) {
                console.log(`æ™ºèƒ½æå–æ ‡é¢˜(é¡µé¢æ ‡é¢˜): ${cleanPageTitle} (åŸå§‹: ${pageTitle})`);
                return cleanPageTitle;
            }
        }

        return '';
    }

    // å¿«é€Ÿæ”¶è—å½“å‰ç½‘é¡µï¼ˆä»…æ ‡é¢˜ä¸é“¾æ¥ï¼Œå‰ªè—åº“ï¼Œé»˜è®¤è‡ªå®šä¹‰æ ‡ç­¾"æœªå¤„ç†"ï¼‰
    async function quickClipCurrentPage() {
        try {
            const siteConfig = getSiteConfig();
            if (!NOTION_CONFIG.apiKey || !NOTION_CONFIG.databaseIds.clip) {
                showNotification('è¯·å…ˆåœ¨"å…¶ä»–åŠŸèƒ½ â†’ é…ç½®Notion"ä¸­è®¾ç½® Notion API å’Œå‰ªè—æ•°æ®åº“ID', 'warning');
                return;
            }

            const sourceURL = window.location.href;
            let title = smartExtractTitle() || document.title || 'æœªå‘½åå‰ªè—';
            title = cleanTitle(title);

            const minimalData = { æ ‡é¢˜: title };
            const evalRes = evaluateAutoTagRouting(sourceURL, title, getPageTextSnippet(), siteConfig);
            if (evalRes.tags && evalRes.tags.length) minimalData[evalRes.tagProperty || 'ç±»å‹'] = evalRes.tags;
            // quick clipï¼šå¿«é€Ÿæ”¶è—å§‹ç»ˆä¿å­˜åˆ°å‰ªè—æ•°æ®åº“ï¼Œä¸å—è·¯ç”±è§„åˆ™å½±å“
            const finalRouteType = 'clip';
            const result = await createNotionPage(minimalData, sourceURL, finalRouteType);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œè®©dotæŒ‰é’®æ˜¾ç¤ºæ­¤é¡µé¢å·²ç»è¢«æ”¶è—
            if (result && result.success) {
                isPageExistsInNotion = true;
                updateTagButtonStatus(true);

                // ä¿å­˜å‰ªè—æ¨¡å¼é…ç½®ï¼Œè®©dotæŒ‰é’®æ˜¾ç¤ºæ­¤é¡µé¢å·²ç»è¢«æ”¶è—
                const hostname = window.location.hostname;
                const clipConfig = {
                    contentType: 'clip',
                    selectors: {
                        ç®€ä»‹: "", ä¹¦å: "", ä½œè€…: "", æœ€æ–°ç« èŠ‚: "", æ›´æ–°çŠ¶æ€: "",
                        å°é¢: "", è¿½æ›´: "", åˆ«å: "", åœ°åŒº: "", ç±»å‹: ""
                    },
                    selectorIndices: {},
                    enableTypeSelector: false,
                    enableCustomTags: false,
                    requireConfiguration: false,
                    isDefaultConfig: false
                };

                // ä¿å­˜é…ç½®
                if (saveCustomConfig(hostname, clipConfig)) {
                    console.log('å·²ä¿å­˜å‰ªè—æ¨¡å¼é…ç½®ï¼ŒdotæŒ‰é’®å°†æ˜¾ç¤ºé¡µé¢å·²è¢«æ”¶è—');
                }
            }

            showNotification('å·²å¿«é€Ÿæ”¶è—åˆ°å‰ªè—æ•°æ®åº“', 'success');
            console.log('Quick clip result:', result);
        } catch (e) {
            console.error('å¿«é€Ÿæ”¶è—å¤±è´¥:', e);
            showNotification('å¿«é€Ÿæ”¶è—å¤±è´¥: ' + (e.message || e.toString()), 'error');
        }
    }

    // æ™ºèƒ½æå–ä½œè€…ï¼ˆåŒæ­¥ï¼Œé€‚ç”¨äºæ–‡ä»¶å‘½åï¼‰
    function smartExtractAuthor() {
        try {
            const siteConfig = getSiteConfig();
            if (siteConfig && siteConfig.selectors && siteConfig.selectors['ä½œè€…']) {
                const nodes = document.querySelectorAll(siteConfig.selectors['ä½œè€…']);
                if (nodes && nodes.length > 0) {
                    const selection = resolveElementSelection(nodes, siteConfig.selectorIndices && siteConfig.selectorIndices['ä½œè€…'] !== undefined ? siteConfig.selectorIndices['ä½œè€…'] : '0');
                    const applyFilter = (text) => {
                        let t = cleanText(text || '');
                        if (siteConfig.selectors['ä½œè€…_filter']) {
                            try { t = t.replace(new RegExp(siteConfig.selectors['ä½œè€…_filter'], 'g'), ''); } catch (_) {}
                        }
                        return t;
                    };

                    if (!selection.elements.length) return '';

                    if (selection.mode === 'all' || selection.mode === 'multiple') {
                        const arr = selection.elements.map(n => applyFilter(n.textContent)).filter(Boolean);
                        if (arr.length > 0) return joinTextsWithSeparator('ä½œè€…', arr);
                    } else {
                        const txt = applyFilter(selection.elements[0] && selection.elements[0].textContent);
                        if (txt) return txt;
                    }
                }
            }
        } catch (_) {}

        // å…œåº•ï¼šä½¿ç”¨æœ€è¿‘ä¸€æ¬¡æå–çš„æ•°æ®
        const pageData = getLastPageData();
        if (pageData && pageData.ä½œè€…) return pageData.ä½œè€…;
        return '';
    }

    // æ™ºèƒ½æå–ä½œè€…ï¼ˆé€šç”¨é€‰æ‹©å™¨å…œåº•ç‰ˆæœ¬ï¼‰
    function smartExtractAuthorGeneric() {
        const authorSelectors = [
            '.author',
            '.writer',
            '.creator',
            '[class*="author"]',
            '[class*="writer"]',
            'meta[name="author"]',
            'meta[property="book:author"]'
        ];

        for (const selector of authorSelectors) {
            const element = document.querySelector(selector);
            if (element) {
                let author = element.textContent || element.content || '';
                author = cleanText(author);
                if (author && author.length > 1 && author.length < 50) {
                    console.log(`æ™ºèƒ½æå–ä½œè€…: ${author} (é€‰æ‹©å™¨: ${selector})`);
                    return author;
                }
            }
        }

        return '';
    }

    // æ™ºèƒ½æå–ç®€ä»‹
    function smartExtractDescription() {
        const descSelectors = [
            '.description',
            '.summary',
            '.intro',
            '.content',
            '[class*="desc"]',
            '[class*="summary"]',
            'meta[name="description"]',
            'meta[property="og:description"]'
        ];

        for (const selector of descSelectors) {
            const element = document.querySelector(selector);
            if (element) {
                let desc = element.textContent || element.content || '';
                desc = cleanText(desc);
                if (desc && desc.length > 10 && desc.length < 1000) {
                    console.log(`æ™ºèƒ½æå–ç®€ä»‹: ${desc.substring(0, 50)}... (é€‰æ‹©å™¨: ${selector})`);
                    return desc;
                }
            }
        }

        return '';
    }

    // æ™ºèƒ½æå–æœ€æ–°ç« èŠ‚
    function smartExtractLatestChapter() {
        const chapterSelectors = [
            '.latest-chapter',
            '.new-chapter',
            '.chapter-list a:first-child',
            '.chapter-item:first-child',
            '[class*="chapter"]:first-child',
            '[class*="latest"]'
        ];

        for (const selector of chapterSelectors) {
            const element = document.querySelector(selector);
            if (element) {
                let chapter = element.textContent || '';
                chapter = cleanText(chapter);
                if (chapter && chapter.length > 1 && chapter.length < 100) {
                    console.log(`æ™ºèƒ½æå–æœ€æ–°ç« èŠ‚: ${chapter} (é€‰æ‹©å™¨: ${selector})`);
                    return chapter;
                }
            }
        }

        return '';
    }

    // å†…å®¹åˆ†æå’Œæ¸…ç†
    function analyzeAndCleanContent(content, preserveNewlines = false) {
        if (!content || typeof content !== 'string') {
            return content;
        }

        // ç§»é™¤å¸¸è§çš„æ— ç”¨å†…å®¹
        const unwantedPatterns = [
            /å¹¿å‘Š|æ¨å¹¿|èµåŠ©|ç‚¹å‡»|å…³æ³¨|è®¢é˜…|æ”¶è—|ç‚¹èµ/g,
            /æ›´å¤šç²¾å½©|æ•¬è¯·æœŸå¾…|æœªå®Œå¾…ç»­/g,
            /ä½œè€…ï¼š.*?æ›´æ–°æ—¶é—´ï¼š/g,
            /æ›´æ–°æ—¶é—´ï¼š.*?ä½œè€…ï¼š/g,
            /ç¬¬.*?ç« .*?æ›´æ–°æ—¶é—´ï¼š/g
        ];

        let cleanedContent = content;
        unwantedPatterns.forEach(pattern => {
            cleanedContent = cleanedContent.replace(pattern, '');
        });

        // æ¸…ç†å¤šä½™çš„ç©ºç™½å­—ç¬¦
        if (preserveNewlines) {
            // ä¿ç•™æ¢è¡Œç¬¦ï¼šåªå°†è¿ç»­çš„ç©ºç™½å­—ç¬¦ï¼ˆä¸åŒ…æ‹¬æ¢è¡Œç¬¦ï¼‰æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼
            // å°†å¤šä¸ªè¿ç»­ç©ºæ ¼/tabæ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼ï¼Œä½†ä¿ç•™æ¢è¡Œç¬¦
            cleanedContent = cleanedContent.replace(/[ \t]+/g, ' '); // åªæ›¿æ¢ç©ºæ ¼å’Œtab
            // æ¸…ç†å¤šä½™çš„è¿ç»­æ¢è¡Œç¬¦ï¼ˆè¶…è¿‡2ä¸ªçš„æ¢è¡Œç¬¦æ›¿æ¢ä¸º2ä¸ªï¼‰
            cleanedContent = cleanedContent.replace(/\n{3,}/g, '\n\n');
            // å»é™¤é¦–å°¾ç©ºç™½ï¼Œä½†ä¿ç•™å†…éƒ¨çš„æ¢è¡Œç¬¦
            cleanedContent = cleanedContent.replace(/^\s+|\s+$/g, '');
        } else {
            // ä¸ä¿ç•™æ¢è¡Œç¬¦ï¼šå°†æ‰€æœ‰ç©ºç™½å­—ç¬¦æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼
            cleanedContent = cleanedContent.replace(/\s+/g, ' ').trim();
        }

        // å¦‚æœæ¸…ç†åå†…å®¹å¤ªçŸ­ï¼Œè¿”å›åŸå†…å®¹
        if (cleanedContent.length < content.length * 0.3) {
            return content;
        }

        return cleanedContent;
    }

    // æ·»åŠ ä¸€ä¸ªå˜é‡æ¥è·Ÿè¸ªæ˜¯å¦å·²ç»æ‰§è¡Œè¿‡è‡ªåŠ¨æ›´æ–°
    let hasPerformedAutoUpdateCheck = false;


    // ä¸»å‡½æ•°
    async function main() {
        try {

            // åº”ç”¨è‡ªå®šä¹‰æ ·å¼
            applyCustomStyles();
            enforceLighterShades();
            setupUrlChangeWatcher();

            if (isCurrentPageEnabled()) {
                const siteConfig = getSiteConfig();
                setupVisibilityTrigger();

                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    if (siteConfig.contentType !== 'clip') {
                        setupAutoUpdateObservers(siteConfig);
                    }
                    await addButtons();
                    try { applyButtonVisibilitySettings(); } catch(_) {}
                    // åˆ›å»ºå°åœ†ç‚¹æŒ‰é’®
                    createTagButton();
                    // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦å­˜åœ¨äºNotionæ•°æ®åº“ä¸­
                    checkCurrentPageExists();
                    if (!hasPerformedAutoUpdateCheck) {
                        await checkAndAutoUpdate('initial-load');
                        hasPerformedAutoUpdateCheck = true;
                    }
                    // å¯åŠ¨å¢å¼ºçš„å®šæœŸæ£€æŸ¥
                    startPeriodicUpdateCheck();
                } else {
                    document.addEventListener('DOMContentLoaded', async () => {
                        if (siteConfig.contentType !== 'clip') {
                            setupAutoUpdateObservers(siteConfig, true);
                        }
                        await addButtons();
                        // åˆ›å»ºå°åœ†ç‚¹æŒ‰é’®
                        createTagButton();
                        // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦å­˜åœ¨äºNotionæ•°æ®åº“ä¸­
                        checkCurrentPageExists();
                        if (!hasPerformedAutoUpdateCheck) {
                            await checkAndAutoUpdate('dom-ready');
                            hasPerformedAutoUpdateCheck = true;
                        }
                        // å¯åŠ¨å¢å¼ºçš„å®šæœŸæ£€æŸ¥
                        startPeriodicUpdateCheck();
                    });
                    setTimeout(async () => {
                        if (!document.getElementById('notion-import-btn-container')) {
                            if (siteConfig.contentType !== 'clip') {
                                setupAutoUpdateObservers(siteConfig, true);
                            }
                            await addButtons();
                            // åˆ›å»ºå°åœ†ç‚¹æŒ‰é’®
                            createTagButton();
                            // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦å­˜åœ¨äºNotionæ•°æ®åº“ä¸­
                            checkCurrentPageExists();
                            if (!hasPerformedAutoUpdateCheck) {
                                await checkAndAutoUpdate('delayed-init');
                                hasPerformedAutoUpdateCheck = true;
                            }
                            // å¯åŠ¨å¢å¼ºçš„å®šæœŸæ£€æŸ¥
                            startPeriodicUpdateCheck();
                        }
                    }, 2000);
                }
            }
        } catch (error) {
            console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            showError('è„šæœ¬åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        }
    }


    // é”šç‚¹å¯¼èˆªï¼šé…ç½®ç•Œé¢å¤–çš„å¿«é€Ÿå®šä½æŒ‰é’®
    function createConfigAnchorNav(dialogRef) {
        try {
            try { if (!GM_getValue('show_config_anchor_nav', true)) return; } catch(_) {}
            if (document.getElementById('config-anchor-nav')) return;
            const dialog = dialogRef || document.getElementById('config-dialog');
            const nav = document.createElement('div');
            nav.id = 'config-anchor-nav';
            (function ensureConfigAnchorStyles() {
                const anchorStylesId = 'config-anchor-nav-styles';
                let st = document.getElementById(anchorStylesId);
                if (!st) {
                    st = document.createElement('style');
                    st.id = anchorStylesId;
                    document.head.appendChild(st);
                }
                st.textContent = `
                    #config-anchor-nav{ position:fixed; left:24px; top:24px; z-index:10001; display:flex; flex-direction:column; gap:6px; padding:12px; margin:0; border-radius:20px; border:1px solid rgba(255,255,255,0.8); background:rgba(255,255,255,0.9); backdrop-filter:saturate(180%) blur(20px); box-shadow:0 20px 40px -10px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.02); max-height:85vh; overflow-y:auto; scrollbar-width:none; -ms-overflow-style:none; transition:all 0.3s cubic-bezier(0.4,0,0.2,1); }
                    #config-anchor-nav::-webkit-scrollbar { display: none; }
                    #config-anchor-nav .anchor-btn{ display:flex; align-items:center; gap:10px; padding:9px 14px; border:none; border-radius:10px; cursor:pointer; font-size:13px; font-weight:500; color:#6B7280; background:transparent; transition:all 0.2s ease; text-align:left; width:130px; position: relative; flex-shrink:0; }
                    #config-anchor-nav .anchor-btn .em{ font-size:15px; color:#9CA3AF; width:20px; display:flex; justify-content:center; }
                    #config-anchor-nav .anchor-btn:hover{ background:rgba(0,0,0,0.04); color:#111827; transform:translateX(2px); }
                    #config-anchor-nav .anchor-btn.active{ background:var(--primarycolor-lighter, #FFF0F5); color:var(--primarycolor, #FF6B9D); }
                    #config-anchor-nav .anchor-btn.active .em{ color:var(--primarycolor, #FF6B9D); }
                    #config-anchor-nav .anchor-btn.active::before { content: ''; position: absolute; left: 6px; top: 50%; transform: translateY(-50%); width: 3px; height: 3px; background: var(--primarycolor, #FF6B9D); border-radius: 50%; }
                    @media (max-width:768px){ #config-anchor-nav{ display:none; } }
                    `;
            })();



            const list = document.createElement('div');
            list.style.cssText = 'display:flex; flex-direction:column; gap:8px;';

            // Scroll Spy State
            let isManualScroll = false;
            let manualScrollTimeout = null;

            const openAndScroll = (selector) => {
                let dialog = document.getElementById('config-dialog');
                if (!dialog) {
                    try { showConfigDialog(); } catch(_) {}
                }
                setTimeout(() => {
                    dialog = document.getElementById('config-dialog');
                    if (!dialog) return;
                    const content = document.getElementById('config-dialog-content') || dialog;
                    const target = document.querySelector(selector);
                    if (!target) { try { showNotification('æœªæ‰¾åˆ°é…ç½®é¡¹', 'warning'); } catch(_) {} return; }

                    // Set manual scroll flag to prevent observer from flickering active state during scroll
                    isManualScroll = true;
                    if (manualScrollTimeout) clearTimeout(manualScrollTimeout);

                    const crect = content.getBoundingClientRect();
                    const rect = target.getBoundingClientRect();
                    const offset = rect.top - crect.top - 40; // 40px buffer

                    content.scrollTo({ top: content.scrollTop + offset, behavior: 'smooth' });

                    // Update active state immediately
                    document.querySelectorAll('#config-anchor-nav .anchor-btn').forEach(b => b.classList.remove('active'));
                    const activeBtn = Array.from(list.children).find(b => b._targetSelector === selector);
                    if (activeBtn) activeBtn.classList.add('active');

                    try {
                        target.classList.add('config-anchor-highlight');
                        setTimeout(() => { target.classList.remove('config-anchor-highlight'); }, 1600);
                    } catch(_) {}

                    // Reset manual scroll flag after animation
                    manualScrollTimeout = setTimeout(() => { isManualScroll = false; }, 800);
                }, 60);
            };

            const buildAnchors = () => {
                list.textContent = '';
                const content = document.getElementById('config-dialog-content');
                if (!content) return;
                const type = document.getElementById('content-type-select')?.value || 'comic';
                const candidates = [
                    { label: 'å†…å®¹ç±»å‹', icon: 'ğŸ—‚ï¸', selector: '#anchor-content-type', show: () => true },
                    { label: 'å°é¢é¢„è§ˆ', icon: 'ğŸ–¼ï¸', selector: '#config-cover-preview', show: () => true },
                    { label: 'å°é¢é€‰æ‹©å™¨', icon: 'ğŸ¯', selector: '#anchor-cover-selector', show: () => true },
                    { label: 'ä¹¦å', icon: 'ğŸ“–', selector: 'div[data-field="ä¹¦å"]', show: () => true },
                    { label: 'ä½œè€…', icon: 'ğŸ‘¤', selector: 'div[data-field="ä½œè€…"]', show: () => true },
                    { label: 'ç®€ä»‹', icon: 'ğŸ“', selector: 'div[data-field="ç®€ä»‹"]', show: () => type !== 'clip' },
                    { label: 'æœ€æ–°ç« èŠ‚', icon: 'ğŸ“Œ', selector: 'div[data-field="æœ€æ–°ç« èŠ‚"]', show: () => type !== 'clip' },
                    { label: 'æ›´æ–°çŠ¶æ€', icon: 'â±ï¸', selector: 'div[data-field="æ›´æ–°çŠ¶æ€"]', show: () => type !== 'clip' },
                    { label: 'è¿½æ›´', icon: 'ğŸ“…', selector: 'div[data-field="è¿½æ›´"]', show: () => type !== 'clip' },
                    { label: 'åˆ«å', icon: 'ğŸ”–', selector: 'div[data-field="åˆ«å"]', show: () => type !== 'clip' },
                    { label: 'åœ°åŒº', icon: 'ğŸ“', selector: 'div[data-field="åœ°åŒº"]', show: () => type === 'comic' },
                    { label: 'ç±»å‹', icon: 'ğŸ·ï¸', selector: 'div[data-field="ç±»å‹"]', show: () => type !== 'clip' },
                    { label: 'ç®€ä»‹å±•å¼€', icon: 'â¤´ï¸', selector: '#anchor-expand-btn', show: () => type !== 'clip' },
                    { label: 'å†…å®¹é€‰æ‹©å™¨', icon: 'ğŸ“¦', selector: '#content-selector-container', show: () => true },
                    { label: 'æ’é™¤é€‰æ‹©å™¨', icon: 'ğŸš«', selector: '#exclude-selectors-container', show: () => true },
                    { label: 'å‰ªè—ç±»å‹', icon: 'ğŸ·ï¸', selector: '#clip-type-selector-container', show: () => type === 'clip' },
                    { label: 'è‡ªå®šä¹‰æ ‡ç­¾', icon: 'ğŸ·ï¸', selector: '#custom-tags-container', show: () => true },
                    { label: 'è·¯å¾„æ¨¡å¼', icon: 'ğŸ›£ï¸', selector: '#path-pattern-container', show: () => true },
                    { label: 'ç±»å‹æ˜ å°„', icon: 'ğŸ§­', selector: '#type-mapping-container', show: () => true },
                    { label: 'åŸŸåå›¾æ ‡', icon: 'ğŸŒ', selector: '#domain-icon-url-input', show: () => true }
                ];
                const items = [];
                const children = Array.from(content.children);
                for (const c of candidates) {
                    if (!c.show()) continue;
                    const el = document.querySelector(c.selector);
                    if (!el) continue;
                    const topChild = (function(){ let p = el; while (p && p.parentElement && p.parentElement !== content) p = p.parentElement; return p; })();
                    const idx = children.indexOf(topChild);
                    if (idx < 0) continue;
                    const visible = window.getComputedStyle(topChild || el).display !== 'none';
                    if (!visible) continue;
                    items.push({ ...c, index: idx });
                }
                items.sort((a,b) => a.index - b.index);
                for (const a of items) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.title = a.label;
                    btn.className = 'anchor-btn';
                    btn._targetSelector = a.selector; // Store for spy
                    const icon = document.createElement('span');
                    icon.className = 'em';
                    icon.textContent = a.icon;
                    const label = document.createElement('span');
                    label.textContent = a.label;
                    btn.appendChild(icon);
                    btn.appendChild(label);
                    btn.onclick = (e) => { e.stopPropagation(); openAndScroll(a.selector); };
                    list.appendChild(btn);
                }

                // Initialize Spy
                initScrollSpy(content);
            };

            // Scroll Spy Implementation
            const initScrollSpy = (container) => {
                if (!container) return;

                const onScroll = () => {
                    if (isManualScroll) return;

                    const buttons = Array.from(list.children);
                    if (buttons.length === 0) return;

                    const containerRect = container.getBoundingClientRect();
                    const triggerLine = containerRect.top + 100; // 100px from top

                    let activeBtn = null;

                    // Iterate backwards to find the last element that passed the trigger line
                    for (let i = buttons.length - 1; i >= 0; i--) {
                        const btn = buttons[i];
                        const selector = btn._targetSelector;
                        const el = document.querySelector(selector);
                        if (!el) continue;

                        const rect = el.getBoundingClientRect();
                        if (rect.top <= triggerLine + 50) { // +50 buffer
                            activeBtn = btn;
                            break;
                        }
                    }

                    // If none found (at top), use first
                    if (!activeBtn && buttons.length > 0 && container.scrollTop < 50) {
                        activeBtn = buttons[0];
                    }

                    buttons.forEach(b => b.classList.remove('active'));
                    if (activeBtn) {
                        activeBtn.classList.add('active');
                        // Ensure the active button is visible in the anchor nav itself
                        const nav = document.getElementById('config-anchor-nav');
                        if (nav) {
                            const btnRect = activeBtn.getBoundingClientRect();
                            const navRect = nav.getBoundingClientRect();
                            if (btnRect.top < navRect.top || btnRect.bottom > navRect.bottom) {
                                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        }
                    }
                };

                container.onscroll = () => {
                    if(window.requestAnimationFrame) requestAnimationFrame(onScroll);
                    else setTimeout(onScroll, 16);
                };

                // Initial check
                onScroll();
            };
            buildAnchors();

            nav.appendChild(list);
            document.body.appendChild(nav);

            try {
                const savedLeft = GM_getValue('config_anchor_left');
                const savedTop = GM_getValue('config_anchor_top');
                if (typeof savedLeft === 'number' && typeof savedTop === 'number') {
                    nav.style.left = Math.max(0, savedLeft) + 'px';
                    nav.style.top = Math.max(0, savedTop) + 'px';
                } else {
                    const rect = dialog ? dialog.getBoundingClientRect() : null;
                    const defaultLeft = rect ? Math.min(window.innerWidth - 180, Math.max(8, Math.round(rect.right + 12))) : Math.max(8, window.innerWidth - 180);
                    const defaultTop = rect ? Math.max(8, Math.round(rect.top)) : Math.round(window.innerHeight * 0.5);
                    nav.style.left = defaultLeft + 'px';
                    nav.style.top = defaultTop + 'px';
                }
            } catch(_) {}

            (function makeNavDraggable(container){
                if (!container) return;
                let isDragging = false;
                let didDrag = false;
                let offsetX = 0, offsetY = 0, startX = 0, startY = 0;
                let rafId = null;
                let originalTransition = '';

                const onPointerDown = (clientX, clientY, originalEvent) => {
                    isDragging = true;
                    didDrag = false;
                    startX = clientX;
                    startY = clientY;
                    const rect = container.getBoundingClientRect();
                    offsetX = clientX - rect.left;
                    offsetY = clientY - rect.top;
                    if (originalEvent && originalEvent.type === 'touchstart') originalEvent.preventDefault();
                    document.documentElement.style.userSelect = 'none';
                    originalTransition = container.style.transition;
                    container.style.transition = 'none';
                };

                const updatePosition = (clientX, clientY) => {
                    if (!isDragging) return;
                    container.style.left = (clientX - offsetX) + 'px';
                    container.style.top = (clientY - offsetY) + 'px';
                    container.style.right = 'auto';
                    container.style.bottom = 'auto';
                    rafId = null;
                };

                const onPointerMove = (clientX, clientY) => {
                    if (!isDragging) return;
                    if (!didDrag) {
                        const dx = Math.abs(clientX - startX);
                        const dy = Math.abs(clientY - startY);
                        if (dx < 2 && dy < 2) return;
                        didDrag = true;
                    }
                    if (!rafId) {
                        rafId = requestAnimationFrame(() => updatePosition(clientX, clientY));
                    }
                };

                const onPointerUp = () => {
                    if (!isDragging) return;
                    isDragging = false;
                    if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
                    try {
                        const rect = container.getBoundingClientRect();
                        GM_setValue('config_anchor_left', Math.max(0, Math.round(rect.left)));
                        GM_setValue('config_anchor_top', Math.max(0, Math.round(rect.top)));
                    } catch(_) {}
                    document.documentElement.style.userSelect = '';
                    container.style.transition = originalTransition;
                };

                container.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return;
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                    onPointerDown(e.clientX, e.clientY, e);
                });
                document.addEventListener('mousemove', (e) => onPointerMove(e.clientX, e.clientY));
                document.addEventListener('mouseup', onPointerUp);

                container.addEventListener('touchstart', (e) => {
                    const t = e.touches && e.touches[0];
                    if (!t) return;
                    const target = document.elementFromPoint(t.clientX, t.clientY);
                    if (target && (target.tagName === 'BUTTON' || target.closest('button'))) return;
                    onPointerDown(t.clientX, t.clientY, e);
                }, { passive: false });

                document.addEventListener('touchmove', (e) => {
                    const t = e.touches && e.touches[0];
                    if (t) onPointerMove(t.clientX, t.clientY);
                }, { passive: false });

                document.addEventListener('touchend', onPointerUp);
            })(nav);

            (function syncWithDialog(){
                const dlg = dialog || document.getElementById('config-dialog');
                const update = () => {
                    const want = !!GM_getValue('show_config_anchor_nav', true);
                    nav.style.display = want ? 'flex' : 'none';
                };
                update();
                try {
                    const typeSelect = document.getElementById('content-type-select');
                    if (typeSelect) typeSelect.addEventListener('change', buildAnchors);
                    const bodyObs = new MutationObserver(() => {
                        if (!document.getElementById('config-dialog')) {
                            document.getElementById('config-anchor-nav')?.remove();
                            bodyObs.disconnect();
                        }
                    });
                    bodyObs.observe(document.body, { childList: true, subtree: true });
                } catch(_) {}
            })();

            // ç§»åŠ¨ç«¯æ ·å¼ä¼˜åŒ–
            try {
                GM_addStyle(`
                    @media (max-width: 768px) {
                        #config-anchor-nav { display: none !important; }
                    }
                    .config-anchor-highlight {padding:14px; outline: 2px solid var(--primarycolor-light, #FF6B9D); border-radius: 12px !important; box-shadow: 0 0 0 5px rgba(255,107,157,0.18); animation: anchorPulse .9s ease-out 2; }
                    @keyframes anchorPulse { from { box-shadow: 0 0 0 2px rgba(255,107,157,0.25); } to { box-shadow: 0 0 0 6px rgba(255,107,157,0.0); } }
                    `);
            } catch(_) {}
        } catch(e) { console.error('åˆ›å»ºé…ç½®é”šç‚¹å¤±è´¥:', e); }
    }


    // æ˜¾ç¤ºæ•°æ®åº“ç»Ÿè®¡å¯¹è¯æ¡†
    async function showDatabaseStatsDialog() {
        try {
            if (!NOTION_CONFIG.apiKey) {
                showNotification('è¯·å…ˆåœ¨é…ç½®ä¸­å¡«å†™ Notion API Key', 'warning');
                return;
            }

            // ç»„å»ºè¦ç»Ÿè®¡çš„æ•°æ®åº“æ¸…å•
            const dbList = [
                { key: 'comic', name: 'æ¼«ç”»åº“', id: NOTION_CONFIG.databaseIds.comic },
                { key: 'novel', name: 'å°è¯´åº“', id: NOTION_CONFIG.databaseIds.novel },
                { key: 'clip', name: 'å‰ªè—åº“', id: NOTION_CONFIG.databaseIds.clip }
            ].filter(db => db.id);

            if (dbList.length === 0) {
                showNotification('æœªé…ç½®ä»»ä½•æ•°æ®åº“ID', 'warning');
                return;
            }

            // UI: åŠé€æ˜é®ç½©
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 2147483646;
                display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);
            `;

            // UI: å¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                width: min(720px, 92vw); max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;
                background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                border-radius: 20px; border: 1px solid rgba(0,0,0,0.06);
                box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.05);
            `;
            dialog.className = 'notion-DatabaseStats-dialog';

            // å¤´éƒ¨
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;
                background: linear-gradient(135deg, var(--primarycolor, #FF6B9D), var(--primarycolor-dark, #FF8FAB)); color: #fff;
            `;
            const title = document.createElement('div');
            title.textContent = 'æ•°æ®åº“ç»Ÿè®¡';
            title.style.cssText = 'font-weight: 700; letter-spacing: .5px;';
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Ã—';
            closeBtn.style.cssText = `
                width: 32px; height: 32px; border-radius: 20px; border: none; cursor: pointer; color: #fff;
                background: rgba(255,255,255,0.18); font-size: 18px; display: inline-flex; align-items: center; justify-content: center;
            `;
            closeBtn.onclick = () => overlay.remove();
            header.appendChild(title);
            header.appendChild(closeBtn);

            // å†…å®¹åŒº
            const content = document.createElement('div');
            content.style.cssText = 'padding: 16px 20px; overflow: auto;';

            const tip = document.createElement('div');
            tip.textContent = 'æ‰“å¼€æ—¶æ˜¾ç¤ºä¸Šæ¬¡ç»Ÿè®¡ç»“æœï¼Œç‚¹å‡»â€œå¼€å§‹ç»Ÿè®¡â€æ›´æ–°';
            tip.style.cssText = 'margin-bottom: 12px; color: #6B7280; font-size: 13px;';
            content.appendChild(tip);

            const apiSummaryCard = document.createElement('div');
            apiSummaryCard.style.cssText = 'display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; margin-bottom:12px; border:1px solid rgba(0,0,0,0.06); border-radius: 20px; background:#fff;';
            const apiSummaryText = document.createElement('div');
            try { apiSummaryText.textContent = __getApiSummary(); } catch(_) { apiSummaryText.textContent = 'API è®¿é—®ç»Ÿè®¡ä¸å¯ç”¨'; }
            apiSummaryText.style.cssText = 'font-size:13px; color:#374151;';
            const apiActions = document.createElement('div');
            apiActions.style.cssText = 'display:flex; gap:8px;';
            const apiViewBtn = document.createElement('button');
            apiViewBtn.textContent = 'æŸ¥çœ‹APIè¯¦æƒ…';
            apiViewBtn.style.cssText = 'padding:8px 10px; border:none; border-radius:20px; background: linear-gradient(135deg, var(--primarycolor, #FF6B9D), var(--primarycolor-dark, #FF8FAB)); color:white; cursor:pointer;';
            const apiResetBtn = document.createElement('button');
            apiResetBtn.textContent = 'é‡ç½®APIè®¡æ•°';
            apiResetBtn.style.cssText = 'padding:8px 10px; border:2px solid var(--primarycolor); border-radius:20px; background: white; color:var(--primarycolor); cursor:pointer;';
            apiResetBtn.onclick = () => { try { __resetApiCounters(); apiSummaryText.textContent = __getApiSummary(); showNotification('APIè®¿é—®è®¡æ•°å·²é‡ç½®', 'success'); } catch(_){} };
            apiSummaryCard.appendChild(apiSummaryText);
            apiActions.appendChild(apiViewBtn);
            apiActions.appendChild(apiResetBtn);
            apiSummaryCard.appendChild(apiActions);
            content.appendChild(apiSummaryCard);

            const apiDetailBox = document.createElement('div');
            apiDetailBox.style.cssText = 'display:none; padding:10px 12px; border:1px solid rgba(0,0,0,0.06); border-radius: 20px; background:#fff; color:#374151; font-size:12px; white-space:pre-wrap;margin-bottom:10px';
            try {
                const lastApi = GM_getValue('last_api_stats', null) || null;
                if (lastApi) {
                    const toLine = (obj) => Object.entries(obj || {}).map(([k,v]) => `${k}:${v}`).join(' ');
                    const nTop = (lastApi.notionTopPaths || []).map(([p,c]) => `${p} (${c})`).join(' | ');
                    const gTop = (lastApi.githubTopPaths || []).map(([p,c]) => `${p} (${c})`).join(' | ');
                    apiDetailBox.textContent = `ä¸Šæ¬¡ç»Ÿè®¡æ—¶é—´: ${new Date(lastApi.ts || Date.now()).toLocaleString()}\nNotion æ–¹æ³•: ${toLine(lastApi.notionMethods || {})}\nNotion Top Path: ${nTop || 'æ— '}\nGitHub æ–¹æ³•: ${toLine(lastApi.githubMethods || {})}\nGitHub Top Path: ${gTop || 'æ— '}`;
                    apiDetailBox.style.display = 'block';
                }
            } catch(_) {}
            content.appendChild(apiDetailBox);

            apiViewBtn.onclick = () => {
                try {
                    const dbg = window.__API_DEBUG__ || {};
                    const topN = (paths) => Object.entries(paths || {}).sort((a,b) => b[1] - a[1]).slice(0, 8);
                    const toLine = (obj) => Object.entries(obj || {}).map(([k,v]) => `${k}:${v}`).join(' ');
                    const nTop = topN((dbg.notion && dbg.notion.paths) || {});
                    const gTop = topN((dbg.github && dbg.github.paths) || {});
                    const ex = (dbg.extraction && dbg.extraction.last) || {};
                    const up = (dbg.upload && dbg.upload.last) || {};
                    const nr = (dbg.notion && Array.isArray(dbg.notion.requests) && dbg.notion.requests.length) ? dbg.notion.requests[dbg.notion.requests.length - 1] : null;
                    const gr = (dbg.github && Array.isArray(dbg.github.requests) && dbg.github.requests.length) ? dbg.github.requests[dbg.github.requests.length - 1] : null;
                    const lines = [];
                    lines.push(`å½“å‰ç»Ÿè®¡æ—¶é—´: ${new Date().toLocaleString()}`);
                    lines.push(`Notion æ€»:${(dbg.notion && dbg.notion.total) || 0} æ–¹æ³•: ${toLine((dbg.notion && dbg.notion.methods) || {})}`);
                    lines.push(`Notion Top Path: ${nTop.map(([p,c]) => `${p} (${c})`).join(' | ') || 'æ— '}`);
                    lines.push(`GitHub æ€»:${(dbg.github && dbg.github.total) || 0} æ–¹æ³•: ${toLine((dbg.github && dbg.github.methods) || {})}`);
                    lines.push(`GitHub Top Path: ${gTop.map(([p,c]) => `${p} (${c})`).join(' | ') || 'æ— '}`);
                    lines.push('');
                    lines.push('æœ€è¿‘ä¸€æ¬¡æå–');
                    lines.push(`ç±»å‹: ${ex.contentType || ''}`);
                    lines.push(`é“¾æ¥: ${ex.url || ''}`);
                    lines.push(`æ ‡é¢˜: ${ex.æ ‡é¢˜ || ex.ä¹¦å || ''}`);
                    lines.push(`ä½œè€…: ${ex.ä½œè€… || ''}`);
                    lines.push(`ç±»å‹æ ‡ç­¾: ${Array.isArray(ex.ç±»å‹) ? ex.ç±»å‹.join(', ') : (ex.ç±»å‹ || '')}`);
                    lines.push(`å°é¢: ${ex.å°é¢ || ''}`);
                    lines.push(`ç®€ä»‹: ${(ex.ç®€ä»‹ || '')}`);
                    if (ex.å¤‡æ³¨) lines.push(`å¤‡æ³¨: ${ex.å¤‡æ³¨}`);
                    if (ex.è¿½æ›´) lines.push(`è¿½æ›´: ${ex.è¿½æ›´}`);
                    lines.push('');
                    lines.push('æœ€è¿‘ä¸€æ¬¡ä¸Šä¼ æ„é€ ');
                    lines.push(`ç±»å‹: ${up.contentType || ''}`);
                    lines.push(`æ ‡é¢˜: ${up.title || ''}`);
                    lines.push(`é“¾æ¥: ${up.link || ''}`);
                    lines.push(`å°é¢: ${up.cover || ''}`);
                    lines.push(`å±æ€§: ${Array.isArray(up.properties) ? up.properties.join(', ') : ''}`);
                    if (up.text) {
                        const jl = typeof up.text.ç®€ä»‹ === 'string' ? up.text.ç®€ä»‹.length : 0;
                        const bl = typeof up.text.å¤‡æ³¨ === 'string' ? up.text.å¤‡æ³¨.length : 0;
                        const zl = typeof up.text.è¿½æ›´ === 'string' ? up.text.è¿½æ›´.length : 0;
                        lines.push(`æ–‡æœ¬é•¿åº¦: ç®€ä»‹(${jl}) å¤‡æ³¨(${bl}) è¿½æ›´(${zl})`);
                    }
                    lines.push(`å—æ•°é‡: ${up.childrenCount || 0} å›¾ç‰‡å—: ${up.imageBlocks || 0}`);
                    lines.push('');
                    lines.push('æœ€è¿‘ä¸€æ¬¡ Notion è¯·æ±‚');
                    if (nr) {
                        lines.push(`æ–¹æ³•: ${nr.method} è·¯å¾„: ${nr.path}`);
                        lines.push(`æ ‡é¢˜: ${nr.title} ç±»å‹: ${nr.contentType}`);
                        lines.push(`å±æ€§: ${(nr.properties || []).join(', ')}`);
                        lines.push(`æ–‡æœ¬é•¿åº¦: ç®€ä»‹(${(nr.text && nr.text.ç®€ä»‹) || 0}) å¤‡æ³¨(${(nr.text && nr.text.å¤‡æ³¨) || 0}) è¿½æ›´(${(nr.text && nr.text.è¿½æ›´) || 0})`);
                        lines.push(`å—: ${nr.childrenCount || 0} çŠ¶æ€: ${nr.status}`);
                        lines.push(`é¡µé¢ID: ${nr.pageId || ''}`);
                        lines.push(`é¡µé¢é“¾æ¥: ${nr.responseUrl || ''}`);
                    } else {
                        lines.push('æ— ');
                    }
                    lines.push('');
                    lines.push('æœ€è¿‘ä¸€æ¬¡ GitHub ä¸Šä¼ ');
                    if (gr) {
                        lines.push(`æ–¹æ³•: ${gr.method} è·¯å¾„: ${gr.path || ''}`);
                        lines.push(`ç±»å‹: ${gr.imageType || ''} æ–‡ä»¶: ${gr.fileName || ''} å¤§å°: ${gr.sizeKB || 0}KB`);
                        lines.push(`æˆåŠŸ: ${gr.success ? 'æ˜¯' : 'å¦'} é“¾æ¥: ${gr.url || ''}`);
                    } else {
                        lines.push('æ— ');
                    }
                    apiDetailBox.textContent = lines.join('\n');
                    apiDetailBox.style.display = 'block';
                    try {
                        GM_setValue('last_api_stats', {
                            ts: Date.now(),
                            notionTotal: (dbg.notion && dbg.notion.total) || 0,
                            notionMethods: (dbg.notion && dbg.notion.methods) || {},
                            notionTopPaths: nTop,
                            githubTotal: (dbg.github && dbg.github.total) || 0,
                            githubMethods: (dbg.github && dbg.github.methods) || {},
                            githubTopPaths: gTop
                        });
                    } catch(_) {}
                } catch(_) {}
            };

            const list = document.createElement('div');
            list.style.cssText = 'display: flex; flex-direction: column; gap: 12px;';
            content.appendChild(list);

            try {
                const lastStats = GM_getValue('last_database_stats', {}) || {};
                list.textContent = '';
                for (const db of dbList) {
                    const card = document.createElement('div');
                    card.style.cssText = `
                        border: 1px solid rgba(0,0,0,0.06); border-radius: 20px; background: #fff;
                        padding: 14px 16px; box-shadow: var(--shadow-sm, 0 2px 8px rgba(0,0,0,0.06));
                    `;
                    const head = document.createElement('div');
                    head.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';
                    const nameEl = document.createElement('div');
                    nameEl.textContent = `${db.name}`;
                    nameEl.style.cssText = 'font-weight: 600;';
                    const idEl = document.createElement('div');
                    idEl.textContent = db.id;
                    idEl.style.cssText = 'font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; color: #6B7280;';
                    head.appendChild(nameEl);
                    head.appendChild(idEl);
                    const meta = document.createElement('div');
                    meta.style.cssText = 'font-size: 13px; color: #374151; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;';
                    const s = lastStats[db.id] || {};
                    const total = document.createElement('div');
                    total.textContent = `æ€»æ¡ç›®ï¼š${typeof s.count === 'number' ? s.count : 'æœªçŸ¥'}`;
                    const tagInfo = document.createElement('div');
                    tagInfo.textContent = `æ ‡ç­¾å±æ€§ï¼š${typeof s.tagCount === 'number' ? s.tagCount : 'æœªçŸ¥'} ä¸ª`;
                    const summary = document.createElement('div');
                    summary.style.cssText = 'grid-column: 1 / -1; color: #6B7280;';
                    summary.textContent = s.tagSummary || 'æš‚æ— æ‘˜è¦';
                    card.appendChild(head);
                    meta.appendChild(total);
                    meta.appendChild(tagInfo);
                    meta.appendChild(summary);
                    card.appendChild(meta);
                    list.appendChild(card);
                }
            } catch(_) {}

            // åº•éƒ¨
            const footer = document.createElement('div');
            footer.style.cssText = 'padding: 12px 20px; display: flex; justify-content: flex-end; gap: 8px;';
            const startBtn = document.createElement('button');
            startBtn.textContent = 'å¼€å§‹ç»Ÿè®¡';
            startBtn.style.cssText = `
                padding: 8px 14px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.08);
                background: #fff; cursor: pointer; color: #111827;
            `;
            const okBtn = document.createElement('button');
            okBtn.textContent = 'å…³é—­';
            okBtn.style.cssText = `
                padding: 8px 14px; border-radius: 20px; border: none; cursor: pointer; color: #fff;
                background: linear-gradient(135deg, var(--primarycolor, #FF6B9D), var(--primarycolor-dark, #FF8FAB));
            `;
            okBtn.onclick = () => overlay.remove();
            footer.appendChild(startBtn);
            footer.appendChild(okBtn);

            dialog.appendChild(header);
            dialog.appendChild(content);
            dialog.appendChild(footer);
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            let controller = null;
            const render = async () => {
                list.textContent = '';
                const snapshot = {};
                for (const db of dbList) {
                    const card = document.createElement('div');
                    card.style.cssText = `
                        border: 1px solid rgba(0,0,0,0.06); border-radius: 20px; background: #fff;
                        padding: 14px 16px; box-shadow: var(--shadow-sm, 0 2px 8px rgba(0,0,0,0.06));
                    `;

                    const head = document.createElement('div');
                    head.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';
                    const nameEl = document.createElement('div');
                    nameEl.textContent = `${db.name}`;
                    nameEl.style.cssText = 'font-weight: 600;';
                    const idEl = document.createElement('div');
                    idEl.textContent = db.id;
                    idEl.style.cssText = 'font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; color: #6B7280;';
                    head.appendChild(nameEl);
                    head.appendChild(idEl);

                    const meta = document.createElement('div');
                    meta.style.cssText = 'font-size: 13px; color: #374151; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;';

                    // å ä½
                    while (meta.firstChild) meta.removeChild(meta.firstChild);
                    const ph1 = document.createElement('div');
                    ph1.textContent = 'æ€»æ¡ç›®ï¼šç»Ÿè®¡ä¸­â€¦';
                    const ph2 = document.createElement('div');
                    ph2.textContent = 'æ ‡ç­¾å±æ€§ï¼šåŠ è½½ä¸­â€¦';
                    meta.appendChild(ph1);
                    meta.appendChild(ph2);

                    card.appendChild(head);
                    card.appendChild(meta);
                    list.appendChild(card);

                    try {
                        const [info, count] = await Promise.all([
                            getNotionDatabaseInfo(db.id),
                            countNotionDatabasePages(db.id, controller.signal)
                        ]);
                        const tags = summarizeTagProperties(info);
                        const tagSummary = tags.length === 0 ? 'æ— ' : tags.map(t => `${t.name}ï¼ˆ${t.type}ï¼Œ${t.optionCount} é¡¹ï¼‰`).join('ï¼Œ');
                        while (meta.firstChild) meta.removeChild(meta.firstChild);
                        const total = document.createElement('div');
                        total.textContent = `æ€»æ¡ç›®ï¼š${count}`;
                        const tagInfo = document.createElement('div');
                        tagInfo.textContent = `æ ‡ç­¾å±æ€§ï¼š${tags.length} ä¸ª`;
                        const summary = document.createElement('div');
                        summary.style.cssText = 'grid-column: 1 / -1; color: #6B7280;';
                        summary.textContent = tagSummary;
                        meta.appendChild(total);
                        meta.appendChild(tagInfo);
                        meta.appendChild(summary);
                        snapshot[db.id] = { count, tagCount: tags.length, tagSummary };
                    } catch (e) {
                        while (meta.firstChild) meta.removeChild(meta.firstChild);
                        const err = document.createElement('div');
                        if ((e && e.message) === 'ç»Ÿè®¡å·²å–æ¶ˆ') {
                            err.style.cssText = 'grid-column: 1 / -1; color: #6B7280;';
                            err.textContent = 'å·²å–æ¶ˆç»Ÿè®¡';
                        } else {
                            err.style.cssText = 'grid-column: 1 / -1; color: #EF4444;';
                            err.textContent = `ç»Ÿè®¡å¤±è´¥ï¼š${e.message}`;
                        }
                        meta.appendChild(err);
                    }
                }
                try { GM_setValue('last_database_stats', snapshot); } catch(_) {}
            };

            startBtn.onclick = () => {
                try { if (controller) controller.abort(); } catch(_) {}
                controller = new AbortController();
                render();
            };

            // åˆå§‹ä¸è¿›è¡Œå®æ—¶ç»Ÿè®¡ï¼Œæ˜¾ç¤ºå†å²ç»“æœ
        } catch (error) {
            console.error('æ˜¾ç¤ºæ•°æ®åº“ç»Ÿè®¡å¤±è´¥:', error);
            showNotification('æ˜¾ç¤ºæ•°æ®åº“ç»Ÿè®¡å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    }

    // åˆ‡æ¢è¿½åŠ å†…å®¹æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
    function toggleAppendButton() {
        const appendButton = document.getElementById('append-content-btn');
        if (appendButton) {
            const isVisible = appendButton.style.display !== 'none';
            appendButton.style.display = isVisible ? 'none' : 'flex';
            showNotification(isVisible ? 'è¿½åŠ å†…å®¹æŒ‰é’®å·²éšè—' : 'è¿½åŠ å†…å®¹æŒ‰é’®å·²æ˜¾ç¤º', 'info');
            // åˆ‡æ¢æ˜¾ç¤ºåé‡æ–°å®šä½å°åœ†ç‚¹ï¼Œé¿å…é‡å 
            setTimeout(() => { try { positionTagDot(); } catch (_) {} }, 0);
        }
    }

    // æ–°å¢ï¼šæ˜¾ç¤º/éšè—æ‰€æœ‰æŒ‰é’®ï¼ˆä¸»å…¥å£ã€é…ç½®ã€è¿½åŠ ï¼‰
    function toggleAllButtons() {
        let container = document.getElementById('notion-import-btn-container');
        if (!container) {
            try { addButtons(); } catch(_) {}
            container = document.getElementById('notion-import-btn-container');
            if (!container) return;
            container.dataset.hidden = '0';
            container.style.display = 'flex';
            container.style.flexDirection = 'row';
            container.style.flexWrap = 'nowrap';
            container.style.alignItems = 'center';
            showNotification('æ‰€æœ‰æŒ‰é’®å·²æ˜¾ç¤º', 'info');
            return;
        }
        const computedDisplay = getComputedStyle(container).display || '';
        const isHidden = container.dataset.hidden === '1' || computedDisplay === 'none' || container.style.display === 'none';
        if (isHidden) {
            container.dataset.hidden = '0';
            const prev = container.dataset.prevDisplay;
            container.style.display = (prev && prev !== 'none') ? prev : 'flex';
            container.style.flexDirection = 'row';
            container.style.flexWrap = 'nowrap';
            container.style.alignItems = 'center';
            showNotification('æ‰€æœ‰æŒ‰é’®å·²æ˜¾ç¤º', 'info');
        } else {
            container.dataset.prevDisplay = computedDisplay || '';
            container.dataset.hidden = '1';
            container.style.display = 'none';
            showNotification('æ‰€æœ‰æŒ‰é’®å·²éšè—', 'info');
        }
    }

    // æ³¨å†Œèœå•å‘½ä»¤ - åœ¨æ­¤è·¯å¾„æ˜¾ç¤º/éšè—æŒ‰é’®
    function toggleButtonsForCurrentPath() {
        let smartPattern = extractSmartPattern(window.location.href);
        if (!smartPattern) {
            try {
                const url = new URL(window.location.href);
                smartPattern = { domain: url.hostname, pattern: '/*', fullPattern: `${url.hostname}/*`, parentPattern: null };
            } catch(_) {
                showNotification('æ— æ³•è§£æå½“å‰URL', 'error');
                return;
            }
        }
        const enabledPatterns = GM_getValue(ENABLED_PATTERNS_KEY, []);
        const currentPattern = smartPattern.fullPattern;
        const existingPattern = enabledPatterns.find(p => p.fullPattern === currentPattern);
        if (existingPattern) {
            const newPatterns = enabledPatterns.filter(p => p.fullPattern !== currentPattern);
            GM_setValue(ENABLED_PATTERNS_KEY, newPatterns);
            showNotification('å·²éšè—æŒ‰é’®ï¼ˆä»…å½“å‰è·¯å¾„ï¼Œä¸å½±å“å…¨å±€ï¼‰', 'success');
            if (!isCurrentPageEnabled()) {
                const btnContainer = document.getElementById('notion-import-btn-container');
                if (btnContainer) btnContainer.remove();
            }
        } else {
            enabledPatterns.push(smartPattern);
            GM_setValue(ENABLED_PATTERNS_KEY, enabledPatterns);
            showNotification('å·²æ˜¾ç¤ºæŒ‰é’®ï¼ˆä»…å½“å‰è·¯å¾„ï¼Œä¸å½±å“å…¨å±€ï¼‰', 'success');
            // å¯ç”¨è·¯å¾„åï¼Œç«‹å³åˆ›å»ºå¹¶æ˜¾ç¤ºæ‚¬æµ®æŒ‰é’®ç»„
            try { addButtons(); } catch(_) {}
            try { setTimeout(() => { if (!document.getElementById('notion-import-btn-container')) { try { addButtons(); } catch(_) {} } }, 0); } catch(_) {}
            try { setTimeout(() => { if (!document.getElementById('notion-import-btn-container')) { try { addButtons(); } catch(_) {} } }, 220); } catch(_) {}
            const container = document.getElementById('notion-import-btn-container');
            if (container) {
                container.dataset.hidden = '0';
                const prev = container.dataset.prevDisplay;
                container.style.display = (prev && prev !== 'none') ? prev : 'flex';
                container.style.flexDirection = 'row';
                container.style.flexWrap = 'nowrap';
                container.style.alignItems = 'center';
            }
        }
    }

    function toggleGlobalShowButtons() {
        const current = GM_getValue(GLOBAL_SHOW_BUTTONS_KEY, false);
        const next = !current;
        GM_setValue(GLOBAL_SHOW_BUTTONS_KEY, next);
        try { GM_setValue('globalShowButtons', next); } catch(_) {}
        try { GM_setValue('global_show_buttons', next); } catch(_) {}
        showNotification(next ? 'æŒ‰é’®å·²è®¾ç½®ä¸ºå…¨å±€æ˜¾ç¤º' : 'æŒ‰é’®å…¨å±€æ˜¾ç¤ºå·²å…³é—­', 'success');
        try {
            updateFloatingButtonsVisibility();
        } catch(_) {
            if (next) {
                try { addButtons(); } catch(_) {}
            } else {
                const container = document.getElementById('notion-import-btn-container');
                if (container) container.remove();
            }
        }
    }

    GM_registerMenuCommand("åœ¨æ­¤è·¯å¾„æ˜¾ç¤º/éšè—æŒ‰é’®", function() {
        toggleButtonsForCurrentPath();
    });

    GM_registerMenuCommand(
        GM_getValue(GLOBAL_SHOW_BUTTONS_KEY, false)
        ? "æŒ‰é’®å…¨å±€æ˜¾ç¤ºï¼šå¼€ï¼ˆç‚¹å‡»å…³é—­ï¼‰"
        : "æŒ‰é’®å…¨å±€æ˜¾ç¤ºï¼šå…³ï¼ˆç‚¹å‡»å¼€å¯ï¼‰",
        function() {
            toggleGlobalShowButtons();
        }
    );

    // å…¥å£ç§»è‡³â€œå…¶ä»–åŠŸèƒ½â€å¯¹è¯æ¡†æŒ‰é’®ï¼Œä¸åœ¨è„šæœ¬èœå•ä¸­å‡ºç°

    // å¿«æ·é”®é»˜è®¤é…ç½®ä¸å­˜å–
    const HOTKEYS_KEY = 'hotkeys_config_v1';
    const DEFAULT_HOTKEYS = {
        toggle_all_buttons: { label: 'æ˜¾ç¤º/éšè—æ‰€æœ‰æŒ‰é’®', combo: { ctrl: true, shift: true, alt: false, meta: false, key: 'A' } },
        toggle_append_button: { label: 'æ˜¾ç¤º/éšè—è¿½åŠ æŒ‰é’®', combo: { ctrl: true, shift: true, alt: false, meta: false, key: 'S' } },
        toggle_global_show_buttons: { label: 'åˆ‡æ¢æŒ‰é’®å…¨å±€æ˜¾ç¤º', combo: { ctrl: true, shift: true, alt: false, meta: false, key: 'G' } },
        toggle_path_rule: { label: 'åœ¨æ­¤è·¯å¾„æ˜¾ç¤º/éšè—æŒ‰é’®', combo: { ctrl: true, shift: false, alt: true, meta: false, key: 'A' } },
        open_other_functions: { label: 'æ‰“å¼€å…¶ä»–åŠŸèƒ½', combo: { ctrl: false, shift: true, alt: false, meta: false, key: 'Z' } },
        open_import_export: { label: 'æ‰“å¼€å¯¼å…¥/å¯¼å‡ºé…ç½®', combo: null },
        open_selector_panel: { label: 'æ‰“å¼€é€‰æ‹©å™¨é¢æ¿', combo: null },
        quick_clip: { label: 'å¿«é€Ÿæ”¶è—å½“å‰ç½‘é¡µ', combo: { ctrl: true, shift: true, alt: false, meta: false, key: 'Q' } },
        record_to_notion: { label: 'è®°å½•åˆ°Notion', combo: null },
        toggle_anchor_nav: { label: 'æ˜¾ç¤º/éšè—å¿«æ·å®šä½é¢æ¿', combo: { ctrl: true, shift: true, alt: false, meta: false, key: 'L' } },
        open_other_settings: { label: 'æ‰“å¼€å…¶ä»–è®¾ç½®', combo: { ctrl: false, shift: true, alt: false, meta: false, key: 'O' } },
        open_theme_palette: { label: 'æ‰“å¼€ä¸»é¢˜ä¸é…è‰²', combo: { ctrl: false, shift: true, alt: false, meta: false, key: 'T' } },
        open_database_stats: { label: 'æ‰“å¼€æ•°æ®åº“ç»Ÿè®¡', combo: null }
    };

    function getHotkeys() {
        const saved = GM_getValue(HOTKEYS_KEY);
        if (!saved) return DEFAULT_HOTKEYS;
        // åˆå¹¶é»˜è®¤é¡¹ï¼ˆé˜²æ­¢åç»­æ–°å¢åŠ¨ä½œæ—¶æ—§é…ç½®ç¼ºé¡¹ï¼‰
        const merged = { ...DEFAULT_HOTKEYS };
        Object.keys(saved).forEach(k => merged[k] = { ...merged[k], ...saved[k] });
        return merged;
    }

    function saveHotkeys(hk) {
        GM_setValue(HOTKEYS_KEY, hk);
    }

    // ç»Ÿä¸€çš„ç»„åˆé”®è½¬æ–‡å­—
    function comboToLabel(c) {
        if (!c) return 'æœªè®¾ç½®';
        const parts = [];
        if (c.ctrl) parts.push('Ctrl');
        if (c.shift) parts.push('Shift');
        if (c.alt) parts.push('Alt');
        if (c.meta) parts.push('Meta');
        parts.push((c.key || '').toString().toUpperCase());
        return parts.filter(Boolean).join('+');
    }

    // æ˜¾ç¤ºå¿«æ·é”®è®¾ç½®å¯¹è¯æ¡†
    function showHotkeySettingsDialog() {
        const current = getHotkeys();

        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
        `;

        const dialog = document.createElement('div');
        dialog.style.cssText = `
            background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
            border-radius: 20px;
            padding: 24px;
            max-width: 720px;
            width: 92%;
            max-height: 85vh;
            overflow: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.05);
            border: 1px solid rgba(255,255,255,.2);
            position: relative;
            animation: slideIn .35s cubic-bezier(0.34, 1.56, 0.64, 1);
        `;
        dialog.className = 'notion-HotkeySettings-dialog';

        // é¡¶éƒ¨æ¸å˜æ¡
        const decorationBg = document.createElement('div');
        decorationBg.style.cssText = `
            position: absolute;left:0;right:0;top:0;height:4px;border-radius:20px 20px 0 0;
            background: linear-gradient(90deg, var(--primarycolor-light, #FF8FAB) 0%, var(--primarycolor, #FF6B9D) 50%, var(--primarycolor-light, #FF8FAB) 100%);
        `;
        dialog.appendChild(decorationBg);

        const title = document.createElement('h3');
        title.textContent = 'âŒ¨ï¸ å¿«æ·é”®è®¾ç½®';
        title.style.cssText = `
            margin: 0 0 16px 0; font-size: 24px; font-weight: 700; text-align: center; color: #1F2937;
            background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        `;

        const desc = document.createElement('div');
        desc.textContent = 'ç‚¹å‡»æŸé¡¹è¾“å…¥æ¡†åï¼Œç›´æ¥æŒ‰ç»„åˆé”®è¿›è¡Œè®¾ç½®ï¼ˆEsc æ¸…é™¤ï¼‰ã€‚';
        desc.style.cssText = 'font-size:12px;color:#6b7280;margin-bottom:12px;text-align:center;';

        const list = document.createElement('div');
        list.style.cssText = `
            display: grid; gap: 10px 12px; align-items: center; margin-bottom: 16px;
            grid-template-columns: 1fr 220px;
        `;

        // ç§»åŠ¨ç«¯é€‚é…
        if (window.innerWidth <= 768) {
            list.style.cssText = `
                display: grid; gap: 8px 10px; align-items: center; margin-bottom: 12px;
                grid-template-columns: 1fr; /* å•åˆ— */
            `;
        }

        const items = Object.entries(current);
        const inputRefs = {};
        let captureKey = null;

        items.forEach(([key, def]) => {
            const label = document.createElement('div');
            label.textContent = def.label;
            label.style.cssText = 'font-size:14px;color:#111827;';

            const input = document.createElement('input');
            input.type = 'text';
            input.readOnly = true;
            input.placeholder = 'æœªè®¾ç½®';
            input.value = comboToLabel(def.combo);
            input.style.cssText = `
                width: -webkit-fill-available; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 20px; background: #FFFFFF;
                box-sizing: border-box; color: #111827; font-size: 14px; transition: all .2s ease;
            `;
            input.addEventListener('focus', () => {
                input.style.borderColor = '#FF6B9D';
                input.style.boxShadow = '0 0 0 3px rgba(255,107,157,.12)';
            });
            input.addEventListener('blur', () => {
                input.style.borderColor = '#E5E7EB';
                input.style.boxShadow = 'none';
            });

            input.addEventListener('focus', () => {
                captureKey = key;
                input.value = '';
                input.placeholder = 'æŒ‰ä¸‹ç»„åˆé”®...';
            });
            input.addEventListener('blur', () => {
                if (captureKey === key) captureKey = null;
                const hk = getHotkeys();
                input.value = comboToLabel(hk[key].combo);
                input.placeholder = hk[key].combo ? comboToLabel(hk[key].combo) : 'æœªè®¾ç½®';
            });

            inputRefs[key] = input;
            list.appendChild(label);
            list.appendChild(input);
        });

        const hint = document.createElement('div');
        hint.textContent = 'æç¤ºï¼šæŒ‰ Esc æ¸…é™¤å½“å‰é¡¹ï¼›è¾“å…¥æ¡†èšç„¦æ—¶æ‰ä¼šè®°å½•ï¼Œä¸ä¼šè¯¯è§¦å‘æ“ä½œã€‚';
        hint.style.cssText = 'font-size:12px;color:#9ca3af;margin:6px 0 12px 0;grid-column:1/-1;text-align:center;';

        const btnRow = document.createElement('div');
        btnRow.style.cssText = 'display:flex;gap:8px;justify-content:flex-end;position:sticky;bottom:0;padding-top:8px;background:linear-gradient(180deg, rgba(248,250,252,0), #F8FAFC 60%);';

        const restoreBtn = document.createElement('button');
        restoreBtn.textContent = 'æ¢å¤é»˜è®¤';
        restoreBtn.style.cssText = `
            padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 20px; background: #fff; cursor: pointer;
            transition: all .2s ease; color:#111827;
        `;
        restoreBtn.onmouseenter = () => { restoreBtn.style.background = '#F3F4F6'; };
        restoreBtn.onmouseleave = () => { restoreBtn.style.background = '#FFFFFF'; };
        restoreBtn.onclick = () => {
            saveHotkeys(DEFAULT_HOTKEYS);
            Object.entries(DEFAULT_HOTKEYS).forEach(([k, v]) => {
                if (inputRefs[k]) inputRefs[k].value = comboToLabel(v.combo);
            });
            showNotification('å·²æ¢å¤é»˜è®¤å¿«æ·é”®', 'success');
        };

        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'å…³é—­';
        closeBtn.style.cssText = `
            padding: 10px 18px; border: none; border-radius: 20px; background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
            color: #fff; cursor: pointer; transition: transform .15s ease, box-shadow .15s ease; box-shadow: 0 6px 14px var(--primarycolor-lighter);
        `;
        closeBtn.onmouseenter = () => { closeBtn.style.transform = 'translateY(-1px)'; };
        closeBtn.onmouseleave = () => { closeBtn.style.transform = 'translateY(0)'; };
        closeBtn.onclick = () => {
            document.removeEventListener('keydown', handleCapture, { capture: true });
            document.body.removeChild(overlay);
        };

        btnRow.appendChild(restoreBtn);
        btnRow.appendChild(closeBtn);

        dialog.appendChild(title);
        dialog.appendChild(desc);
        dialog.appendChild(list);
        dialog.appendChild(hint);
        dialog.appendChild(btnRow);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        function handleCapture(e) {
            if (!captureKey) return;
            e.preventDefault();
            e.stopPropagation();
            const hk = getHotkeys();
            if (e.key === 'Escape') {
                hk[captureKey].combo = null;
            } else if (!['Control','Shift','Alt','Meta'].includes(e.key)) {
                hk[captureKey].combo = {
                    ctrl: e.ctrlKey,
                    shift: e.shiftKey,
                    alt: e.altKey,
                    meta: e.metaKey,
                    key: e.key.length === 1 ? e.key.toUpperCase() : e.key
                };
            } else {
                return; // ä»…ä¿®é¥°é”®ä¸è®°å½•
            }
            saveHotkeys(hk);
            if (inputRefs[captureKey]) inputRefs[captureKey].value = comboToLabel(hk[captureKey].combo);
            captureKey = null;
            (document.activeElement)?.blur?.();
        }

        document.addEventListener('keydown', handleCapture, { capture: true, once: false });
        overlay.addEventListener('remove', () => document.removeEventListener('keydown', handleCapture, { capture: true }));
    }

    // å…¨å±€å¿«æ·é”®ç›‘å¬ä¸åˆ†å‘ï¼ˆé¿å…è¾“å…¥æ¡†/æ–‡æœ¬åŸŸ/å¯ç¼–è¾‘åŒºè§¦å‘ï¼‰
    (function installGlobalHotkeys() {
        if (window.__notionClipperHotkeysInstalled__) return;
        window.__notionClipperHotkeysInstalled__ = true;
        document.addEventListener('keydown', (e) => {
            // è·³è¿‡è¾“å…¥ç±»å…ƒç´ 
            const target = e.target;
            const isEditable = (target && ((target.tagName && ['INPUT','TEXTAREA','SELECT'].includes(target.tagName)) || target.isContentEditable));
            if (isEditable) return;

            const hk = getHotkeys();
            function match(combo) {
                if (!combo) return false;
                const keyMatch = ((combo.key || '').length === 1 ? e.key.toUpperCase() : e.key) === combo.key;
                return e.ctrlKey === !!combo.ctrl && e.shiftKey === !!combo.shift && e.altKey === !!combo.alt && e.metaKey === !!combo.meta && keyMatch;
            }

            if (match(hk.toggle_all_buttons.combo)) {
                e.preventDefault();
                toggleAllButtons();
                return;
            }
            if (match(hk.toggle_append_button.combo)) {
                e.preventDefault();
                toggleAppendButton();
                return;
            }
            if (match(hk.toggle_global_show_buttons.combo)) {
                e.preventDefault();
                toggleGlobalShowButtons();
                return;
            }
            if (match(hk.toggle_path_rule.combo)) {
                e.preventDefault();
                toggleButtonsForCurrentPath();
                return;
            }
            if (match(hk.open_other_functions.combo)) {
                e.preventDefault();
                showOtherFunctionsDialog();
                return;
            }
            if (match(hk.open_import_export.combo)) {
                e.preventDefault();
                showImportExportDialog();
                return;
            }
            if (match(hk.open_selector_panel.combo)) {
                e.preventDefault();
                showSelectorsDialog();
                return;
            }
            if (match(hk.quick_clip.combo)) {
                e.preventDefault();
                quickClipCurrentPage();
                return;
            }
            if (match(hk.record_to_notion?.combo)) {
                e.preventDefault();
                openRecordToNotionDialog();
                return;
            }
            if (match(hk.toggle_anchor_nav?.combo)) {
                e.preventDefault();
                toggleConfigAnchorNav();
                return;
            }
            if (match(hk.open_other_settings?.combo)) {
                e.preventDefault();
                try {
                    const anchor = document.getElementById('config-anchor-nav');
                    if (anchor) anchor.remove();
                    GM_setValue('show_config_anchor_nav', false);
                } catch(_) {}
                showOtherSettingsDialog();
                return;
            }
            if (match(hk.open_theme_palette?.combo)) {
                e.preventDefault();
                showThemePaletteDialog();
                return;
            }
            if (match(hk.open_database_stats?.combo)) {
                e.preventDefault();
                try { showDatabaseStatsDialog(); } catch(_) {}
                return;
            }
        });
    })();
    try { applySelectorVisualStyle(); } catch(_) {}

    // æ³¨å†Œèœå•å‘½ä»¤ - å…¶ä»–åŠŸèƒ½
    GM_registerMenuCommand("å…¶ä»–åŠŸèƒ½", function() {
        showOtherFunctionsDialog();
    });



    // åˆ‡æ¢é€æ­¥é…ç½®æ¨¡å¼
    function toggleStepConfig() {
        const currentValue = GM_getValue('useStepConfig', false);
        const newValue = !currentValue;
        GM_setValue('useStepConfig', newValue);

        const status = newValue ? 'å¯ç”¨' : 'ç¦ç”¨';
        const emoji = newValue ? 'âœ“' : 'Ã—';
        showNotification(`å·²${status}é€æ­¥é…ç½®æ¨¡å¼`, 'success');

        console.log(`é€æ­¥é…ç½®æ¨¡å¼å·²${status}:`, newValue);
    }
    // æ˜¾ç¤ºå…¶ä»–åŠŸèƒ½å¯¹è¯æ¡†
    function showOtherFunctionsDialog() {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.50);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        `;

        const dialog = document.createElement('div');
        dialog.id = 'other-functions-dialog';
        dialog.style.cssText = `
            max-width: 720px;
            width: min(92vw, 650px);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            outline: none;
            background: white;
            padding: 20px;s

        `;

        const style = document.createElement('style');
        style.textContent = `
            @keyframes otherFunctionsPop {
                from { opacity: 0; transform: translateY(12px) scale(.96); }
                to { opacity: 1; transform: translateY(0) scale(1); }
            }
            @media (prefers-reduced-motion: reduce) {
                #other-functions-dialog { animation: none !important; }
            }
        `;
        document.head.appendChild(style);

        const header = document.createElement('div');
        header.style.cssText = `
            padding: 16px 22px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--primarycolor, #FF6B9D), var(--primarycolor-dark, #FF8FAB));
            color: #fff;
            border-radius:20px;
        `;

        const headerLeft = document.createElement('div');
        headerLeft.style.cssText = 'display:flex; align-items:center; gap:10px;';

        const headerIcon = document.createElement('div');
        headerIcon.textContent = 'âœ¨';
        headerIcon.style.cssText = 'width:32px; height:32px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.18); font-size:18px;';

        const headerTextWrap = document.createElement('div');
        const headerTitle = document.createElement('div');
        headerTitle.textContent = 'å…¶ä»–åŠŸèƒ½ä¸­å¿ƒ';
        headerTitle.style.cssText = 'font-weight:600; letter-spacing:.4px; font-size:16px;';
        const headerDesc = document.createElement('div');
        headerDesc.textContent = 'å¸¸ç”¨å·¥å…·ã€ä¸€é”®é…ç½®å’Œé«˜çº§åŠŸèƒ½';
        headerDesc.style.cssText = 'font-size:12px; opacity:.9;';
        headerTextWrap.appendChild(headerTitle);
        headerTextWrap.appendChild(headerDesc);

        headerLeft.appendChild(headerIcon);
        headerLeft.appendChild(headerTextWrap);

        const closeBtn = document.createElement('button');
        closeBtn.type = 'button';
        closeBtn.setAttribute('aria-label', 'å…³é—­å…¶ä»–åŠŸèƒ½');
        closeBtn.textContent = 'Ã—';
        closeBtn.style.cssText = `
            width: 30px;
            height: 30px;
            border-radius: 999px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(15,23,42,0.16);
            color: #fff;
            cursor: pointer;
            font-size: 18px;
            transition: all .18s ease;
            `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(15,23,42,0.32)';
            closeBtn.style.transform = 'translateY(-1px)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'rgba(15,23,42,0.16)';
            closeBtn.style.transform = 'translateY(0)';
        });

        const dispose = () => {
            try { document.body.removeChild(overlay); } catch (_) {}
            try { document.head.removeChild(style); } catch (_) {}
            document.removeEventListener('keydown', onKeyDown);
        };

        closeBtn.addEventListener('click', dispose);
        header.appendChild(headerLeft);
        header.appendChild(closeBtn);

        const body = document.createElement('div');
        body.style.cssText = `
            padding: 20px 0;
            overflow-y: auto;
            animation: otherFunctionsPop .28s ease-out;
        `;

        const intro = document.createElement('div');
        intro.style.cssText = 'margin-bottom: 18px; display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start;';
        const introTitle = document.createElement('div');
        introTitle.textContent = 'ä¸€ç«™å¼å·¥å…·å°';
        introTitle.style.cssText = 'font-size:15px; font-weight:600; color:#111827;';
        const introDesc = document.createElement('div');
        introDesc.textContent = 'é…ç½® Notionã€è‡ªåŠ¨æ›´æ–°ã€æ ·å¼å’Œæ‰¹é‡å·¥å…·ç­‰ã€‚';
        introDesc.style.cssText = 'font-size:13px; color:#6B7280;';
        intro.appendChild(introTitle);
        intro.appendChild(introDesc);

        const sectionsWrap = document.createElement('div');
        sectionsWrap.style.cssText = 'display:flex; flex-direction:column; gap:14px;';

        const makeSection = (titleText, subtitleText) => {
            const section = document.createElement('section');
            section.style.cssText = 'border-radius:18px; padding:14px 14px 12px 14px; box-shadow:0 10px 25px rgba(15,23,42,0.05); border:1px solid rgba(226,232,240,0.9);';
            const headerRow = document.createElement('div');
            headerRow.style.cssText = 'display:flex; align-items:baseline; justify-content:space-between; gap:8px; margin-bottom:8px;';
            const title = document.createElement('div');
            title.textContent = titleText;
            title.style.cssText = 'font-size:13px; font-weight:500; color:#111827;';
            const subtitle = document.createElement('div');
            subtitle.textContent = subtitleText;
            subtitle.id = 'otherfunctons-subtitle-text';
            subtitle.style.cssText = 'font-size:11px; color:#9CA3AF;';
            headerRow.appendChild(title);
            headerRow.appendChild(subtitle);
            const grid = document.createElement('div');
            grid.style.cssText = 'display:grid; grid-template-columns:1fr 1fr; gap:10px;';
            section.appendChild(headerRow);
            section.appendChild(grid);
            return { section, grid };
        };

        const primary = makeSection('æ ¸å¿ƒé…ç½®', 'æ¨èä¼˜å…ˆå®Œæˆçš„å¿…å¤‡è®¾ç½®');
        const record = makeSection('å¿«é€Ÿè®°å½•', 'å¿«é€Ÿè®°å½•æ•°æ®åˆ°notion');
        const tools = makeSection('è¾…åŠ©ä¸å·¥å…·', 'æå‡å‰ªè—ä½“éªŒçš„å°å·¥å…·å’Œæ‰¹é‡æ“ä½œ');
        const danger = makeSection('ç»´æŠ¤ä¸å±é™©æ“ä½œ', 'è¯·è°¨æ…ä½¿ç”¨è¿™äº›é«˜çº§åŠŸèƒ½');

        const makeTile = (icon, label, description, onClick) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.style.cssText = `
                border: 1px solid rgba(148, 163, 184, 0.2);
                padding: 10px 9px;
                border-radius: 20px;
                display: flex;
                align-items: flex-start;
                gap: 9px;
                cursor: pointer;
                background: rgb(255, 255, 255,0.4);
                text-align: left;
                transition: transform .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease;
            `;
            const iconWrap = document.createElement('div');
            iconWrap.textContent = icon;
            iconWrap.style.cssText = 'width:26px; height:26px; border-radius:999px; background:#EEF2FF; display:flex; align-items:center; justify-content:center; font-size:15px; flex-shrink:0; color:#111827;';
            const textWrap = document.createElement('div');
            const title = document.createElement('div');
            title.textContent = label;
            title.style.cssText = 'font-size:13px; font-weight:400; color:#111827; margin-bottom:2px;';
            const desc = document.createElement('div');
            desc.textContent = description;
            desc.style.cssText = 'font-size:11px ; color:#6B7280; line-height:1.45;margin-top:4px;';
            desc.id = 'other-functions-desc';
            desc.setAttribute('data-role', 'other-functions-desc');
            textWrap.appendChild(title);
            textWrap.appendChild(desc);
            btn.appendChild(iconWrap);
            btn.appendChild(textWrap);
            btn.addEventListener('mouseenter', () => {
                btn.style.transform = 'translateY(-1px)';
                btn.style.boxShadow = '0 8px 14px rgba(148,163,184,0.02)';
                btn.style.borderColor = 'var(--primarycolor)';
                btn.style.background = 'linear-gradient(135deg,rgb(from var(--primarycolor) r g b / 0.15),rgb(from var(--primarycolor-dark) r g b / 0.1)) !important';
                iconWrap.style.background = 'rgba(255,255,255,0.16)';
                iconWrap.style.color = '#FFFFFF';
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.transform = 'translateY(0)';
                btn.style.border = '1px solid rgba(148, 163, 184, 0.2)';
                btn.style.background = 'rgb(255, 255, 255,0.4)';
                title.style.color = '#111827';
                desc.style.color = '#6B7280';
                iconWrap.style.background = '#EEF2FF';
                iconWrap.style.color = '#111827';
                btn.style.boxShadow = 'none';
            });
            btn.addEventListener('click', onClick);
            return btn;
        };

        const useStepConfig = GM_getValue('useStepConfig', false);

        const stepConfigTile = makeTile(
            'ğŸªœ',
            'é€æ­¥é…ç½®',
            useStepConfig ? 'å·²å¯ç”¨ï¼šæŒ‰æ­¥éª¤å¼•å¯¼å®Œæˆç«™ç‚¹é…ç½®' : 'æœªå¯ç”¨ï¼šå¯ç”¨åæŒ‰å‘å¯¼æ–¹å¼é…ç½®',
            () => {
                toggleStepConfig();
                const now = GM_getValue('useStepConfig', false);
                const descEl = stepConfigTile.querySelector('[data-role="other-functions-desc"]');
                if (descEl) {
                    descEl.textContent = now ? 'å·²å¯ç”¨ï¼šæŒ‰æ­¥éª¤å¼•å¯¼å®Œæˆç«™ç‚¹é…ç½®' : 'æœªå¯ç”¨ï¼šå¯ç”¨åæŒ‰å‘å¯¼æ–¹å¼é…ç½®';
                }
            }
        );
        primary.grid.appendChild(stepConfigTile);
        primary.grid.appendChild(makeTile('ğŸ¨', 'è‡ªå®šä¹‰æ ·å¼', 'è°ƒæ•´ä¸»é¢˜é¢œè‰²ã€åœ†è§’ã€å­—ä½“ç­‰ç•Œé¢é£æ ¼', () => {
            try { showCustomStyleDialog(); } catch (err) {
                console.error('æ‰“å¼€è‡ªå®šä¹‰æ ·å¼é¢æ¿å¤±è´¥:', err);
                try { showNotification('è‡ªå®šä¹‰æ ·å¼æ‰“å¼€å¤±è´¥: ' + (err?.message || err), 'error'); } catch (_) {}
            }
        }));
        primary.grid.appendChild(makeTile('ğŸ–¼ï¸', 'GitHub å›¾åºŠ', 'é…ç½®å›¾ç‰‡ä¸Šä¼ åˆ°GitHubä»“åº“', () => showGitHubConfigDialog()));
        primary.grid.appendChild(makeTile('ğŸ“˜', 'é…ç½® Notion', 'è®¾ç½® API Keyå’Œæ•°æ®åº“ ID', () => showNotionConfigDialog()));
        primary.grid.appendChild(makeTile('ğŸŒ€', 'è‡ªåŠ¨æ›´æ–°é…ç½®', 'æ§åˆ¶è‡ªåŠ¨æ£€æµ‹è‡ªåŠ¨æ›´æ–°', () => showAutoUpdateConfigDialog()));
        primary.grid.appendChild(makeTile('ğŸ“¤', 'å¯¼å…¥ / å¯¼å‡ºé…ç½®', 'å¤‡ä»½æˆ–è¿ç§»å½“å‰è„šæœ¬çš„æ‰€æœ‰è®¾ç½®', () => showImportExportDialog()));

        record.grid.appendChild(makeTile('ğŸ“', 'è®°å½•åˆ° Notion', 'å°†å½“å‰é¡µé¢è®°å½•åˆ°å‰ªè—åº“', () => openRecordToNotionDialog()));
        record.grid.appendChild(makeTile('âš¡', 'å¿«é€Ÿæ”¶è—å½“å‰é¡µ', 'ä¸€é”®å°†å½“å‰é¡µå¿«é€Ÿæ”¶è—åˆ°å‰ªè—åº“', async () => { await quickClipCurrentPage(); }));

        tools.grid.appendChild(makeTile('ğŸ§±', 'Markdown è½¬æ¢', 'æŠŠç½‘é¡µç‰‡æ®µè½¬æ¢Markdown', () => showMarkdownTransformDialog()));
        tools.grid.appendChild(makeTile('ğŸ·ï¸', 'è‡ªåŠ¨æ ‡ç­¾ä¸åˆ†æµ', 'æ ¹æ®è§„åˆ™æ‰“æ ‡ç­¾å¹¶åˆ†æµåˆ°ä¸åŒæ•°æ®åº“', () => showAutoTagRoutingDialog()));
        tools.grid.appendChild(makeTile('ğŸ”', 'æ˜¾ç¤ºé€‰æ‹©å™¨è°ƒè¯•', 'é«˜äº®é¡µé¢å…ƒç´ ï¼Œè¾…åŠ©é…ç½® CSS é€‰æ‹©å™¨', () => showSelectorsDialog()));
        tools.grid.appendChild(makeTile('âŒ¨ï¸', 'å¿«æ·é”®è®¾ç½®', 'è‡ªå®šä¹‰å¿«æ·é”®ä»¥æ›´å¿«æ‰“å¼€åŠŸèƒ½å’Œé¢æ¿', () => showHotkeySettingsDialog()));
        tools.grid.appendChild(makeTile('ğŸ“Š', 'æ•°æ®åº“ç»Ÿè®¡', 'æŸ¥çœ‹æ•°æ®åº“çš„æ¡ç›®æ•°é‡/APIè®¿é—®æ¬¡æ•°', () => {
            try { showDatabaseStatsDialog(); } catch (e) { console.error('æ‰“å¼€æ•°æ®åº“ç»Ÿè®¡å¤±è´¥:', e); }
        }));
        tools.grid.appendChild(makeTile('âš™ï¸', 'å…¶ä»–è®¾ç½®', 'å¼€å…³ä¸€äº›é«˜çº§è¡Œä¸ºå’Œäº¤äº’åå¥½', () => {
            try {
                const anchor = document.getElementById('config-anchor-nav');
                if (anchor) anchor.remove();
                GM_setValue('show_config_anchor_nav', false);
            } catch(_) {}
            showOtherSettingsDialog();
        }));

        danger.grid.appendChild(makeTile('ğŸ§º', 'æ‰¹é‡å¯¼å…¥åˆ° Notion', 'æ‰¹é‡å†™å…¥å¤šä¸ªæ•°æ®/ä¿®æ”¹å°é¢', () => showBatchImportDialog()));
        danger.grid.appendChild(makeTile('ğŸ§¨', 'é‡ç½®æ‰€æœ‰è®¾ç½®', 'æ¸…ç©ºæœ¬è„šæœ¬çš„æ‰€æœ‰æœ¬åœ°é…ç½®å¹¶åˆ·æ–°é¡µé¢', () => showResetAllSettingsConfirm()));

        sectionsWrap.appendChild(primary.section);
        sectionsWrap.appendChild(record.section);
        sectionsWrap.appendChild(tools.section);
        sectionsWrap.appendChild(danger.section);

        body.appendChild(intro);
        body.appendChild(sectionsWrap);

        dialog.appendChild(header);
        dialog.appendChild(body);

        const onKeyDown = (e) => {
            if (e.key === 'Escape') {
                dispose();
            }
        };

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) dispose();
        });
        document.addEventListener('keydown', onKeyDown);

        dialog.tabIndex = -1;
        setTimeout(() => { try { dialog.focus(); } catch (_) {} }, 0);

        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
    }

    // æ˜¾ç¤ºé‡ç½®æ‰€æœ‰è®¾ç½®ç¡®è®¤å¯¹è¯æ¡†
    function showResetAllSettingsConfirm() {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 10001; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(4px)';

        const dialog = document.createElement('div');
        dialog.className = 'notion-reset-dialog';
        dialog.style.cssText = 'background: #fff; border-radius: 20px; padding: 18px; width: 520px; max-width: 92vw; box-shadow: 0 25px 50px -12px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.05); border: 1px solid rgba(0,0,0,.06)';

        const title = document.createElement('h3');
        title.textContent = 'âš  é‡ç½®æ‰€æœ‰è®¾ç½®';
        title.style.cssText = 'margin: 6px 0 12px 0; font-size: 18px; font-weight: 700; color:#B91C1C;';

        const desc = document.createElement('div');
        setSafeHtml(desc, 'æ­¤æ“ä½œå°†æ¸…é™¤æœ¬è„šæœ¬çš„æ‰€æœ‰æœ¬åœ°è®¾ç½®ï¼ˆAPI Keyã€æ•°æ®åº“IDã€ç«™ç‚¹è§„åˆ™ã€æ ‡ç­¾åˆ†ç»„ã€æ ·å¼ã€å¿«æ·é”®ç­‰ï¼‰ï¼Œå¹¶åˆ·æ–°é¡µé¢ã€‚<br>å¦‚éœ€ç»§ç»­ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥ <b>RESET</b>ã€‚');
        desc.style.cssText = 'font-size: 14px; color:#374151; line-height: 1.6; margin-bottom: 10px;';

        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'è¾“å…¥ RESET ä»¥ç¡®è®¤';
        input.style.cssText = 'width:100%; padding: 10px 12px; border: 2px solid #FCA5A5; border-radius: 20px; background: #FFF7F7; font-size: 14px; color:#111827; margin: 8px 0 12px 0;box-sizing: border-box; ';

        const row = document.createElement('div');
        row.style.cssText = 'display:flex; gap:8px; justify-content:flex-end;';

        const cancel = document.createElement('button');
        cancel.textContent = 'å–æ¶ˆ';
        cancel.style.cssText = 'padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 20px; background: #fff; cursor: pointer; color:#111827;';
        cancel.onclick = () => document.body.removeChild(overlay);

        const confirm = document.createElement('button');
        confirm.textContent = 'ç¡®è®¤é‡ç½®';
        confirm.style.cssText = 'padding: 10px 16px; border: none; border-radius: 20px;background:linear-gradient(135deg, #EF4444, #DC2626); color:#fff; cursor:pointer; box-shadow: 0 6px 14px rgba(239,68,68,0.35);';
        confirm.onclick = () => {
            if ((input.value || '').trim().toUpperCase() !== 'RESET') {
                showNotification('è¯·è¾“å…¥ RESET ä»¥ç¡®è®¤', 'warning');
                return;
            }
            try {
                const keys = GM_listValues();
                keys.forEach(k => { try { GM_deleteValue(k); } catch (_) {} });
                showNotification('å·²æ¸…é™¤æ‰€æœ‰è®¾ç½®ï¼Œæ­£åœ¨åˆ·æ–°â€¦', 'info');
                setTimeout(() => { window.location.reload(); }, 600);
            } catch (e) {
                console.error('é‡ç½®è®¾ç½®å¤±è´¥:', e);
                showNotification('é‡ç½®å¤±è´¥: ' + (e.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        };

        row.appendChild(cancel);
        row.appendChild(confirm);

        dialog.appendChild(title);
        dialog.appendChild(desc);
        dialog.appendChild(input);
        dialog.appendChild(row);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        input.focus();
    }

    // è®°å½•åˆ° Notionï¼šå¼¹çª—ä¸ä¿å­˜é€»è¾‘ï¼ˆä¿å­˜åˆ°å‰ªè—åº“ï¼‰
    function openRecordToNotionDialog() {
        if (!NOTION_CONFIG.apiKey || !NOTION_CONFIG.databaseIds?.clip) {
            showNotification('è¯·å…ˆåœ¨â€œå…¶ä»–åŠŸèƒ½ â†’ é…ç½®Notionâ€ä¸­è®¾ç½® Notion API å’Œå‰ªè—æ•°æ®åº“ID', 'warning');
            return;
        }

        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 10002; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(6px)';
        const dialog = document.createElement('div');
        dialog.style.cssText = 'background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%); border-radius: 20px; padding: 18px; width: 560px; max-width: 92vw; box-shadow: 0 25px 50px -12px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.2); position: relative;';
        dialog.className = 'notion-Recordwebpage-dialog';
        const deco = document.createElement('div');
        deco.style.cssText = 'position:absolute;left:0;right:0;top:0;height:4px;border-radius:16px 16px 0 0;background: linear-gradient(90deg, var(--primarycolor-light, #FF8FAB) 0%, var(--primarycolor, #FF6B9D) 50%, var(--primarycolor-light, #FF8FAB) 100%)';
        dialog.appendChild(deco);

        const title = document.createElement('h3');
        title.textContent = 'âœ è®°å½•åˆ°Notionï¼ˆå‰ªè—ï¼‰';
        title.style.cssText = 'margin: 6px 0 12px 0; font-size: 20px; font-weight: 700; text-align:center; color:#1F2937; background:linear-gradient(135deg, var(--primarycolor-dark, #FF8FAB), var(--primarycolor, #FF6B9D)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;';

        const form = document.createElement('div');
        form.style.cssText = 'display:flex; flex-direction:column; gap:10px;';

        const inputTitle = document.createElement('input');
        inputTitle.type = 'text';
        inputTitle.placeholder = 'æ ‡é¢˜â€¦';
        inputTitle.style.cssText = 'padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 20px; background: #FFFFFF; font-size: 14px; color:#111827;';

        const textarea = document.createElement('textarea');
        textarea.placeholder = 'é¡µé¢å†…å®¹â€¦ï¼ˆæ”¯æŒå¤šè¡Œï¼‰';
        textarea.rows = 8;
        textarea.style.cssText = 'padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 20px; background: #FFFFFF; font-size: 14px; color:#111827; resize: vertical;';

        const btnRow = document.createElement('div');
        btnRow.style.cssText = 'display:flex; gap:8px; justify-content:flex-end; margin-top:8px;';

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'ä¿å­˜åˆ°å‰ªè—';
        saveBtn.style.cssText = 'padding: 10px 16px; border: none; border-radius: 20px;background:linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); color:#fff; cursor:pointer; box-shadow: 0 6px 14px var(--primarycolor-lighter);';

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = 'padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 20px; background: #fff; cursor: pointer; color:#111827;';

        cancelBtn.onclick = () => {
            try { document.body.removeChild(overlay); } catch(_) {}
        };
        saveBtn.onclick = async () => {
            const titleVal = (inputTitle.value || '').trim() || 'æœªå‘½åå‰ªè—';
            const contentVal = (textarea.value || '').trim();
            try {
                // è®°å½•åˆ° Notionï¼šä»…æ ‡é¢˜ä¸å†…å®¹ï¼Œä¸åŠ æ ‡ç­¾å’Œé“¾æ¥
                const minimalData = { æ ‡é¢˜: titleVal };
                if (contentVal) minimalData.content = contentVal;
                await createNotionPage(minimalData, null, 'record');
                showNotification('å·²ä¿å­˜åˆ°å‰ªè—æ•°æ®åº“', 'success');
                document.body.removeChild(overlay);
            } catch (e) {
                console.error('è®°å½•ä¿å­˜å¤±è´¥:', e);
                showNotification('ä¿å­˜å¤±è´¥: ' + (e.message || e.toString()), 'error');
            }
        };

        btnRow.appendChild(cancelBtn);
        btnRow.appendChild(saveBtn);

        form.appendChild(inputTitle);
        form.appendChild(textarea);
        form.appendChild(btnRow);

        dialog.appendChild(title);
        dialog.appendChild(form);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        inputTitle.focus();
    }

    // å…¶ä»–è®¾ç½®å¯¹è¯æ¡†ï¼šæ•´åˆä¸‰ä¸ªå‹¾é€‰é¡¹
    function applyButtonVisibilitySettings() {
        try {
            const showFilter = GM_getValue('show-filter-btn', true);
            const showTest = GM_getValue('show-test-btn', true);
            const showHighlight = GM_getValue('show-highlight-btn', true);
            const showLocate = GM_getValue('show-locate-btn', true);
            const showSelect = GM_getValue('show-select-btn', true);
            document.querySelectorAll('[data-btn-type="filter"], #config-dialog [data-btn-type="filter"]').forEach(el => { el.style.display = showFilter ? '' : 'none'; });
            document.querySelectorAll('[data-btn-type="test"], #config-dialog [data-btn-type="test"]').forEach(el => { el.style.display = showTest ? '' : 'none'; });
            document.querySelectorAll('[data-btn-type="highlight"], #config-dialog [data-btn-type="highlight"]').forEach(el => { el.style.display = showHighlight ? '' : 'none'; });
            document.querySelectorAll('[data-btn-type="locate"], #config-dialog [data-btn-type="locate"]').forEach(el => { el.style.display = showLocate ? '' : 'none'; });
            document.querySelectorAll('[data-btn-type="select"], #config-dialog [data-btn-type="select"]').forEach(el => { el.style.display = showSelect ? '' : 'none'; });

            try {
                let st = document.getElementById('button-visibility-styles');
                if (!st) { st = document.createElement('style'); st.id = 'button-visibility-styles'; document.head.appendChild(st); }
                const rules = [];
                if (!showFilter) {
                    rules.push(
                        '#config-dialog [data-btn-type="filter"]{ display:none !important; }',
                        '[data-btn-type="filter"]{ display:none !important; }',
                        'html body #config-dialog .filter-btn[data-btn-type="filter"]{ display:none !important; }',
                        'html body .filter-btn[data-btn-type="filter"]{ display:none !important; }'
                    );
                }
                if (!showTest) {
                    rules.push(
                        '#config-dialog [data-btn-type="test"]{ display:none !important; }',
                        '[data-btn-type="test"]{ display:none !important; }',
                        'html body #config-dialog .selector-test-btn[data-btn-type="test"]{ display:none !important; }',
                        'html body .selector-test-btn[data-btn-type="test"]{ display:none !important; }'
                    );
                }
                if (!showHighlight) {
                    rules.push(
                        '#config-dialog [data-btn-type="highlight"]{ display:none !important; }',
                        '[data-btn-type="highlight"]{ display:none !important; }',
                        'html body #config-dialog .selector-test-btn[data-btn-type="highlight"]{ display:none !important; }',
                        'html body .selector-test-btn[data-btn-type="highlight"]{ display:none !important; }'
                    );
                }
                if (!showLocate) {
                    rules.push(
                        '#config-dialog [data-btn-type="locate"]{ display:none !important; }',
                        '[data-btn-type="locate"]{ display:none !important; }',
                        'html body #config-dialog .selector-test-btn[data-btn-type="locate"]{ display:none !important; }',
                        'html body .selector-test-btn[data-btn-type="locate"]{ display:none !important; }'
                    );
                }
                if (!showSelect) {
                    rules.push(
                        '#config-dialog [data-btn-type="select"]{ display:none !important; }',
                        '[data-btn-type="select"]{ display:none !important; }',
                        'html body #config-dialog .selector-picker-btn[data-btn-type="select"]{ display:none !important; }',
                        'html body .selector-picker-btn[data-btn-type="select"]{ display:none !important; }'
                    );
                }
                st.textContent = rules.join('\n');
            } catch(_) {}
        } catch(_) {}
    }

    // é€‰æ‹©å™¨å¯è§†åŒ–æ ·å¼åº”ç”¨ï¼ˆfancy/minimalï¼‰
    function applySelectorVisualStyle() {
        try {
            const val = GM_getValue('selector_visual_style', 'minimal');
            if (document.body) {
                document.body.dataset.selectorVisual = val;
            }
            let st = document.getElementById('selector-visual-styles');
            if (!st) { st = document.createElement('style'); st.id = 'selector-visual-styles'; document.head.appendChild(st); }
            st.textContent = `
                    body[data-selector-visual="fancy"] .selector-highlight {
                        outline-offset: 4px !important;
                        box-shadow: 0 0 12px var(--primarycolor-lighter) !important;
                        animation: selector-pulse 1.5s infinite !important;
                        border-radius: 8px !important;
                        transition: all 0.3s ease !important;
                    }
                    body[data-selector-visual="fancy"] .selector-hover-highlight {
                        outline-offset: 4px !important;
                        box-shadow: 0 0 10px var(--primarycolor-lighter) !important;
                        animation: selector-hover-pulse 1.5s infinite !important;
                        border-radius: 6px !important;
                        transition: all 0.3s ease !important;
                    }
                    body[data-selector-visual="minimal"] .selector-highlight {
                        outline-offset: 0 !important;
                        box-shadow: none !important;
                        animation: none !important;
                        transition: none !important;
                    }
                    body[data-selector-visual="minimal"] .selector-hover-highlight {
                        outline-offset: 0 !important;
                        box-shadow: none !important;
                        animation: none !important;
                        transition: none !important;
                    }
                `;
        } catch(_) {}
    }


    // ä¸»é¢˜ä¸é…è‰²è°ƒè‰²æ¿ï¼ˆä¸è‡ªå®šä¹‰æ ·å¼è®¾ç½®åŒºåˆ†ï¼‰
    function showThemePaletteDialog() {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 10001; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(6px);';
        const dialog = document.createElement('div');
        dialog.id = 'theme-palette-dialog';
        dialog.style.cssText = 'background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%); padding: 22px; border-radius: 20px; width: 520px; max-width: 92vw; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,.25), 0 0 0 1px rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.2);';
        // ç¡®ä¿ä¸»é¢˜è‰²çƒåœ¨ä»»ä½•è¦†ç›–æ ·å¼ä¸‹éƒ½å¯è§
        (function ensureThemePaletteStyles(){
            const id = 'theme-palette-protective-styles';
            if (document.getElementById(id)) return;
            const st = document.createElement('style');
            st.id = id;
            st.textContent = `
                #theme-palette-dialog button.theme-swatch{ display:inline-block !important; width:56px !important; height:56px !important; border-radius:9999px !important; background-clip: padding-box !important; }
                #theme-palette-dialog button[aria-label="add-gradient"]{ display:inline-flex !important; align-items:center; justify-content:center; }
            `;
            document.head.appendChild(st);
        })();
        const deco = document.createElement('div');
        deco.style.cssText = 'position:absolute;left:0;right:0;top:0;height:4px;border-radius:16px 16px 0 0;background: linear-gradient(90deg, var(--primarycolor-light, #FF8FAB) 0%, var(--primarycolor, #FF6B9D) 50%, var(--primarycolor-light, #FF8FAB) 100%);';
        dialog.appendChild(deco);
        const title = document.createElement('h3');
        title.textContent = 'ä¸»é¢˜ä¸é…è‰²';
        title.style.cssText = 'margin: 8px 0 14px 0; font-size: 20px; font-weight: 700; text-align:center; color:#1F2937; background: linear-gradient(135deg, var(--primarycolor-light, #1F2937) 0%, var(--primarycolor, #374151) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;';

        // æ§åˆ¶åŒºï¼šå­—ä½“é¢œè‰²é€‰æ‹©ã€æ ·å¼åˆ‡æ¢ï¼ˆå»é™¤å¤åˆ¶æ¨¡å¼ï¼‰
        const controlsRow = document.createElement('div');
        controlsRow.style.cssText = 'display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 6px 0 10px 0; flex-wrap: nowrap;';
        // å­—ä½“é¢œè‰²
        // å­—ä½“é¢œè‰²å¡ç‰‡ï¼ˆä¸è‡ªå®šä¹‰æ ·å¼ä¸€è‡´é£æ ¼ï¼‰
        const textColorWrap = document.createElement('div');
        textColorWrap.style.cssText = 'display:flex; align-items:stretch; gap:8px;';
        const textCard = document.createElement('div');
        textCard.style.cssText = 'display:flex; flex-direction:column; gap:8px; padding:10px; border-radius: 20px; background:#fff; border:1px solid var(--primarycolor-light, #ffd6e5); box-shadow: 0 2px 8px rgba(255,143,171,.18); min-width:240px;';
        const textHeader = document.createElement('div');
        textHeader.style.cssText = 'display:flex; align-items:center; justify-content:space-between; gap:8px;';
        const textColorLabel = document.createElement('label');
        textColorLabel.textContent = 'å­—ä½“é¢œè‰²';
        textColorLabel.style.cssText = 'font-size: 13px; font-weight:600; color: var(--primarycolor-dark, #FF6B9D);';
        const textSwatch = document.createElement('div');
        const initTextColor = (()=>{ try { return GM_getValue('theme_text_color', '#ffffff') || '#ffffff'; } catch(_) { return '#ffffff'; } })();
        textSwatch.style.cssText = `width:24px; height:24px; border-radius:6px; border:1px solid #ffd6e5; background:${initTextColor}; box-shadow: inset 0 0 0 2px rgba(255,255,255,.6)`;
        textHeader.appendChild(textColorLabel);
        textHeader.appendChild(textSwatch);
        const textRow = document.createElement('div');
        textRow.style.cssText = 'display:flex; align-items:center; gap:8px; width:100%; box-sizing:border-box; overflow:hidden;';
        if (window.innerWidth <= 768) {
            // ç§»åŠ¨ç«¯ï¼šå­—ä½“é¢œè‰²å¡ç‰‡æ‹‰ä¼¸å æ»¡ä¸€è¡Œï¼Œé¿å…æŒ¤å‹æ—è¾¹é€‰é¡¹
            textCard.style.minWidth = '0px';
            textCard.style.width = '100%';
            controlsRow.style.flexWrap = 'wrap';
            controlsRow.style.justifyContent = 'flex-start';
            controlsRow.style.alignItems = 'stretch';
            controlsRow.style.gap = '10px';
        }
        const textColorInput = document.createElement('input');
        textColorInput.type = 'color';
        textColorInput.value = initTextColor;
        textColorInput.style.cssText = 'width:46px; height:34px; border:none; border-radius: 20px; background:transparent; box-shadow: 0 1px 3px rgba(0,0,0,.06)';
        const textAlpha = document.createElement('input');
        textAlpha.type = 'range'; textAlpha.min='0'; textAlpha.max='100';
        textAlpha.value = String(GM_getValue('theme_text_color_alpha', 100));
        textAlpha.className = 'alpha-range';
        textAlpha.style.cssText = 'flex:1 1 auto; min-width:0; height:14px; -webkit-appearance:none; appearance:none; background:transparent; outline:none; border:none;';
        const textAlphaLabel = document.createElement('span');
        textAlphaLabel.style.cssText = 'width:40px; text-align:right; font-size:12px; color:#9CA3AF;';
        textAlphaLabel.textContent = textAlpha.value + '%';
        const updateTextSwatch = () => { textSwatch.style.background = textColorInput.value; textSwatch.style.opacity = (parseInt(textAlpha.value)||100)/100; };
        textColorInput.oninput = updateTextSwatch; textAlpha.oninput = () => { textAlphaLabel.textContent = textAlpha.value + '%'; updateTextSwatch(); };
        textRow.appendChild(textColorInput); textRow.appendChild(textAlpha); textRow.appendChild(textAlphaLabel);
        textCard.appendChild(textHeader);
        textCard.appendChild(textRow);
        textColorWrap.appendChild(textCard);
        // åˆå§‹åŒ–ï¼šç¡®ä¿å˜é‡å’Œæ ·å¼ç«‹å³ç”Ÿæ•ˆ
        try { document.documentElement.style.setProperty('--theme-text-color', textColorInput.value); } catch(_){ }
        ensureThemeTextStyleTag();
        document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn, #config-dialog .dialog-btn, #config-dialog .selector-test-btn, #config-dialog .filter-btn, .dialog-btn, .selector-test-btn, .filter-btn, .buttons-row button').forEach(el => {
            try { el.style.setProperty('color', textColorInput.value, 'important'); } catch(_){ el.style.color = textColorInput.value; }
        });
        // å·²ç§»é™¤å¤åˆ¶æ¨¡å¼

        // é¢„è§ˆæ ·å¼æ¨¡å¼é€‰æ‹©ï¼ˆæ›¿ä»£å‹¾é€‰ï¼‰ï¼šæ–°å¢å¤šç§é«˜ç«¯é¢„è§ˆ
        const styleModeWrap = document.createElement('div');
        styleModeWrap.style.cssText = 'display:flex; align-items:center; gap:8px; font-size:13px; color:#6B7280; user-select:none;';
        const styleModeLabel = document.createElement('span');
        styleModeLabel.textContent = 'é¢„è§ˆæ ·å¼';
        const styleModeSelect = document.createElement('select');
        styleModeSelect.style.cssText = 'height:30px; border-radius:9999px; padding:4px 10px; border:1px solid var(--primarycolor-light, #ffd6e5); background:#fff; color:#374151;';
        const swatchModes = [
            { value: 'modern', label: 'ç°ä»£' },
            { value: 'classic', label: 'ç»å…¸' },
            { value: 'drop', label: 'æ°´ç ' },
            { value: 'ring', label: 'å…‰ç¯' },
            { value: 'neumorphic', label: 'æŸ”å’Œæ‹Ÿç‰©' },
            { value: 'bevel', label: 'æµ®é›•' },
            { value: 'tilt', label: 'å€¾æ–œ' },
            { value: 'mesh', label: 'ç½‘æ ¼æ¸å˜' },
            { value: 'aqua', label: 'æ°´æ»´å…‰æ³½' }
        ];
        let swatchMode = 'modern';
        try { swatchMode = GM_getValue('theme_palette_mode', 'modern') || 'modern'; } catch(_) {}
        swatchModes.forEach(m => { const o = document.createElement('option'); o.value = m.value; o.textContent = m.label; if (m.value === swatchMode) o.selected = true; styleModeSelect.appendChild(o); });
        styleModeWrap.appendChild(styleModeLabel);
        styleModeWrap.appendChild(styleModeSelect);

        controlsRow.appendChild(textColorWrap);
        controlsRow.appendChild(styleModeWrap);

        // ç§»åŠ¨ç«¯å°†ä¸¤ä¸ªé€‰é¡¹å¹¶æ’å æ»¡ä¸€è¡Œ
        if (window.innerWidth <= 768) {
            const optsRow = document.createElement('div');
            optsRow.style.cssText = 'display:grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap:8px; width:100%';
            controlsRow.removeChild(styleModeWrap);
            optsRow.appendChild(styleModeWrap);
            controlsRow.appendChild(optsRow);
        }

        function getCurrentTextColor() {
            return textColorInput.value || '#ffffff';
        }
        function ensureThemeTextStyleTag() {
            const id = 'theme-text-color-style';
            let tag = document.getElementById(id);
            if (!tag) { tag = document.createElement('style'); tag.id = id; document.head.appendChild(tag); }
            tag.textContent = `
                #config-dialog .dialog-btn-primarycolor,
                #config-dialog .selector-picker-btn,
                #config-dialog .dialog-btn,
                #config-dialog .selector-test-btn,
                .selector-picker-btn,
                .dialog-btn-primarycolor,
                .selector-test-btn,
                .buttons-row button,
                #batch-ops-dialog .btn-primarycolor { color: var(--theme-text-color, #ffffff); }

                /* è¦†ç›–å­å…ƒç´ ï¼Œé˜²æ­¢å†…éƒ¨å…ƒç´ å•ç‹¬è¢«è®¾ç½®ç™½è‰² */
                #config-dialog .dialog-btn-primarycolor *,
                #config-dialog .selector-picker-btn *,
                #config-dialog .dialog-btn *,
                #config-dialog .selector-test-btn *,
                .selector-picker-btn *,
                .dialog-btn-primarycolor *,
                .selector-test-btn *,
                .buttons-row button *,
                #batch-ops-dialog .btn-primarycolor * { color: var(--theme-text-color, #ffffff); }
            `;
        }
        textColorInput.addEventListener('input', () => {
            const c = getCurrentTextColor();
            try { GM_setValue('theme_text_color', c); } catch(_) {}
            document.documentElement.style.setProperty('--theme-text-color', c);
            ensureThemeTextStyleTag();
            // å³æ—¶åº”ç”¨åˆ°ä¸»è¦æŒ‰é’®æ–‡å­—é¢œè‰²
            document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn, #config-dialog .dialog-btn, #config-dialog .selector-test-btn, .dialog-btn, .selector-test-btn, .filter-btn, .buttons-row button').forEach(el => {
                try { el.style.setProperty('color', c, 'important'); } catch(_){ el.style.color = c; }
            });
            updateTextSwatch();
        });

        // å¤åˆ¶æ¨¡å¼ä¸‹ç‚¹å‡»å­—ä½“é¢œè‰²å°æ–¹å—ä¹Ÿå¤åˆ¶
        // å»é™¤å¤åˆ¶æ¨¡å¼ç›¸å…³é€»è¾‘

        // å³é”®å­—ä½“é¢œè‰²æ–¹å—ï¼Œè¾“å…¥ä»»æ„CSSé¢œè‰²ï¼ˆæ”¯æŒé€æ˜åº¦ï¼‰
        textColorInput.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const current = getCurrentTextColor();
            const val = prompt('è¾“å…¥å­—ä½“é¢œè‰²ï¼ˆæ”¯æŒ rgba/hsla/#hex ç­‰ï¼Œå«é€æ˜åº¦ï¼‰ï¼š', current);
            if (!val) return;
            // éªŒè¯é¢œè‰²æœ‰æ•ˆæ€§
            const probe = document.createElement('div');
            probe.style.color = '';
            probe.style.color = val;
            const isValid = !!probe.style.color;
            if (!isValid) { showNotification('é¢œè‰²æ ¼å¼æ— æ•ˆ', 'error'); return; }
            textColorInput.value = val.startsWith('#') && val.length === 4 ? val : (val);
            try { GM_setValue('theme_text_color', val); } catch(_) {}
            document.documentElement.style.setProperty('--theme-text-color', val);
            ensureThemeTextStyleTag();
            document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn, #config-dialog .dialog-btn, #config-dialog .selector-test-btn, .dialog-btn, .selector-test-btn,.buttons-row button').forEach(el => {
                try { el.style.setProperty('color', val, 'important'); } catch(_){ el.style.color = val; }
            });
            showNotification('å­—ä½“é¢œè‰²å·²æ›´æ–°', 'success');
            updateTextSwatch();
        });

        // ä»â€œå…¶ä»–åŠŸèƒ½â€ä¸­çš„æŒ‰é’®é£æ ¼æŠ½å–çš„æ¸å˜é…è‰²ï¼ˆå«é€æ­¥é…ç½®çš„ä¸¤ç§çŠ¶æ€ï¼‰
        let currentGradientStr = '';
        const gradients = [
            { name: 'step-on', primarycolor: '#FF6B9D', dark: '#FF8FAB', light: '#FF8FAB', lighter: '#FFD1E1', bg: 'linear-gradient(135deg, #FF8FAB 0%, #FF6B9D 100%)' },
            { name: 'step-off', primarycolor: '#E5E7EB', dark: '#F3F4F6', light: '#E5E7EB', lighter: '#F9FAFB', bg: 'linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%)' },
            { name: 'import', primarycolor: '#B5EAD7', dark: '#E2F0CB', light: '#D7F3D1', lighter: '#F1FBEB', bg: 'linear-gradient(135deg, #B5EAD7, #E2F0CB)' },
            { name: 'auto', primarycolor: '#B8E2F2', dark: '#D4F1F9', light: '#DDF5FB', lighter: '#F0FBFF', bg: 'linear-gradient(135deg, #B8E2F2, #D4F1F9)' },
            { name: 'style', primarycolor: '#FF6B9E', dark: '#FFB3D1', light: '#FFC6DD', lighter: '#FFE3EF', bg: 'linear-gradient(135deg, #FF6B9E, #FFB3D1)' },
            { name: 'notion', primarycolor: '#D6A3DC', dark: '#C7CEEA', light: '#E0D7F5', lighter: '#F1EDFA', bg: 'linear-gradient(135deg, #D6A3DC, #C7CEEA)' },
            { name: 'github', primarycolor: '#8BA888', dark: '#C4D7B2', light: '#D8E6C8', lighter: '#EEF6E6', bg: 'linear-gradient(135deg, #8BA888, #C4D7B2)' },
            { name: 'selector', primarycolor: '#E2C2FF', dark: '#F8BBD0', light: '#F2D3FF', lighter: '#FAE9FF', bg: 'linear-gradient(135deg, #E2C2FF, #F8BBD0)' },
            { name: 'quick', primarycolor: '#FFD6A5', dark: '#FFADAD', light: '#FFE0B9', lighter: '#FFF2DF', bg: 'linear-gradient(135deg, #FFD6A5, #FFADAD)' },
            { name: 'hotkeys', primarycolor: '#FFEAA7', dark: '#FFD3B6', light: '#FFF1C2', lighter: '#FFF8E3', bg: 'linear-gradient(135deg, #FFEAA7, #FFD3B6)' }
        ];

        // è‡ªå®šä¹‰æ¸å˜å­˜å–ä¸è§£æ
        const CUSTOM_GRADIENTS_KEY = 'custom_gradients_v1';
        function getCustomGradients() {
            try { return GM_getValue(CUSTOM_GRADIENTS_KEY, []); } catch(_) { return []; }
        }
        function saveCustomGradients(list) {
            try { GM_setValue(CUSTOM_GRADIENTS_KEY, list || []); } catch(_) {}
        }
        function extractColorsFromGradient(gradientString) {
            if (!gradientString || typeof gradientString !== 'string') return null;
            let s = gradientString.trim();
            // 1) å…è®¸ä»å¤šè¡Œæ–‡æœ¬ä¸­æå– linear-gradient(...) è¡Œ
            const lg = s.match(/(?:linear|radial|conic)-gradient\([^\)]+\)/i);
            if (lg && lg[0]) {
                s = lg[0];
            }
            // 2) å»é™¤å‰ç¼€æ ‡ç­¾ å¦‚ "gradient:"ã€"textColor:" ç­‰éé¢œè‰²å­—æ®µ
            s = s
                .replace(/(?:^|\n)\s*gradient\s*:\s*/ig, '')
                .replace(/(?:^|\n)\s*textColor\s*:[^\n]*/ig, '')
                .replace(/"|\'|`/g, '')
                .trim();
            // 3) åŒ¹é…é¢œè‰²ï¼ˆè¿‡æ»¤æ‰éé¢œè‰²çš„è‹±æ–‡å­—ï¼‰
            const colorPattern = /(lab\([^\)]+\)|lch\([^\)]+\)|rgb[a]?\([^\)]+\)|hsl[a]?\([^\)]+\)|#[0-9a-fA-F]{3,8}|\b(?:aliceblue|antiquewhite|aqua|aquamarine|azure|beige|bisque|black|blanchedalmond|blue|blueviolet|brown|burlywood|cadetblue|chartreuse|chocolate|coral|cornflowerblue|cornsilk|crimson|cyan|darkblue|darkcyan|darkgoldenrod|darkgray|darkgreen|darkgrey|darkkhaki|darkmagenta|darkolivegreen|darkorange|darkorchid|darkred|darksalmon|darkseagreen|darkslateblue|darkslategray|darkslategrey|darkturquoise|darkviolet|deeppink|deepskyblue|dimgray|dimgrey|dodgerblue|firebrick|floralwhite|forestgreen|fuchsia|gainsboro|ghostwhite|gold|goldenrod|gray|green|greenyellow|grey|honeydew|hotpink|indianred|indigo|ivory|khaki|lavender|lavenderblush|lawngreen|lemonchiffon|lightblue|lightcoral|lightcyan|lightgoldenrodyellow|lightgray|lightgreen|lightgrey|lightpink|lightsalmon|lightseagreen|lightskyblue|lightslategray|lightslategrey|lightsteelblue|lightyellow|lime|limegreen|linen|magenta|maroon|mediumaquamarine|mediumblue|mediumorchid|mediumpurple|mediumseagreen|mediumslateblue|mediumspringgreen|mediumturquoise|mediumvioletred|midnightblue|mintcream|mistyrose|moccasin|navajowhite|navy|oldlace|olive|olivedrab|orange|orangered|orchid|palegoldenrod|palegreen|paleturquoise|palevioletred|papayawhip|peachpuff|peru|pink|plum|powderblue|purple|rebeccapurple|red|rosybrown|royalblue|saddlebrown|salmon|sandybrown|seagreen|seashell|sienna|silver|skyblue|slateblue|slategray|slategrey|snow|springgreen|steelblue|tan|teal|thistle|tomato|turquoise|violet|wheat|white|whitesmoke|yellow|yellowgreen)\b)/ig;
            const matches = s.match(colorPattern);
            if (!/(?:linear|radial|conic)-gradient\(/i.test(s)) {
                if (!matches || matches.length === 0) return null;
                const first = matches[0];
                const last = matches[matches.length - 1] || first;
                return { gradient: `linear-gradient(135deg, ${first} 0%, ${last} 100%)`, first, last };
            }
            if (!matches || matches.length === 0) return null;
            const first = matches[0];
            const last = matches[matches.length - 1];
            return { gradient: s, first, last };
        }
        function createPresetFromGradient(name, gradientString) {
            const info = extractColorsFromGradient(gradientString);
            if (!info) return null;
            return { name: name || 'custom', primarycolor: info.first, dark: info.last, light: info.first, lighter: info.first, bg: info.gradient };
        }

        // åœ†çƒé€‰æ‹©å™¨
        const sphereWrap = document.createElement('div');
        const isMobile = window.innerWidth <= 768;
        sphereWrap.style.cssText = isMobile ? 'display:grid;grid-template-columns: repeat(4, minmax(0,1fr));gap:10px; padding: 6px 2px;' : 'display:grid;grid-template-columns: repeat(6, minmax(0,1fr));gap:14px; padding: 6px 4px;';
        // ç»Ÿä¸€ç¾åŒ–åœ†å½¢æŒ‰é’®ï¼ˆæ”¯æŒæ–°æ—§æ ·å¼åˆ‡æ¢ï¼Œå¹¶å¼ºåˆ¶èƒŒæ™¯é¿å…é€æ˜ï¼‰
        function styleSwatch(btn, bg) {
            btn.className = 'theme-swatch';
            // ç§»é™¤å·²æœ‰é«˜å…‰å±‚
            Array.from(btn.querySelectorAll('.swatch-shine')).forEach(n => n.remove());
            // å¼ºåˆ¶èƒŒæ™¯
            try {
                btn.style.setProperty('background', bg, 'important');
                btn.style.setProperty('background-image', bg, 'important');
                btn.style.setProperty('background-clip', 'padding-box', 'important');
                btn.style.setProperty('backdrop-filter', 'none', 'important');
                btn.style.setProperty('-webkit-backdrop-filter', 'none', 'important');
            } catch(_) { btn.style.background = bg; }
            const size = (window.innerWidth <= 768) ? 44 : 56;
            const commonBase = `height:${size}px;width:${size}px;border-radius:9999px;cursor:pointer;position:relative;transition: transform .15s ease, box-shadow .2s ease, opacity .2s ease;`;
            const mode = typeof swatchMode === 'string' ? swatchMode : 'modern';
            if (mode === 'modern') {
                btn.style.cssText = CUSTOM_STYLE_CONFIG.glassEnabled
                    ? commonBase + 'border:1px solid rgba(255,255,255,0.45); box-shadow: 0 6px 18px rgba(2,6,23,0.08), inset 0 0 0 1px rgba(255,255,255,0.25);'
                : commonBase + 'border:1px solid rgba(0,0,0,0.06); box-shadow: 0 6px 18px rgba(0,0,0,0), inset 0 0 0 1px rgba(255,255,255,0.35);';
                try { btn.style.setProperty('background', bg, 'important'); btn.style.setProperty('background-image', bg, 'important'); } catch(_) {}
                const shine = document.createElement('div');
                shine.className = 'swatch-shine';
                shine.style.cssText = 'position:absolute;left:6px;right:6px;top:6px;height:38%;border-radius:9999px;background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.15)); pointer-events:none; filter: blur(0.2px);';
                btn.appendChild(shine);
                btn.onmouseenter = () => { btn.style.transform = 'translateY(-2px)'; };
                btn.onmouseleave = () => { btn.style.transform = 'translateY(0)'; };
            } else if (mode === 'classic') {
                btn.style.cssText = commonBase + 'border:1px solid rgba(0,0,0,0.08);';
                try { btn.style.setProperty('background', bg, 'important'); btn.style.setProperty('background-image', bg, 'important'); } catch(_) {}
            } else if (mode === 'drop') {
                btn.style.cssText = commonBase + 'border:1px solid rgba(0,0,0,0.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,0), 0 12px 24px rgba(0,0,0,0);';
                try { btn.style.setProperty('background', bg, 'important'); btn.style.setProperty('background-image', bg, 'important'); } catch(_) {}
                const hl = document.createElement('div');
                hl.className = 'swatch-shine';
                hl.style.cssText = 'position:absolute;left:10px;right:10px;top:10px;height:34%;border-radius:9999px;background: radial-gradient( circle at 30% 20%, rgba(255,255,255,.9), rgba(255,255,255,.04) ); pointer-events:none;';
                btn.appendChild(hl);
                const overlay = document.createElement('div');
                overlay.className = 'swatch-shine';
                overlay.style.cssText = 'position:absolute;inset:0;border-radius:inherit;background: linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.08)); pointer-events:none;';
                btn.appendChild(overlay);

            } else if (mode === 'ring') {
                btn.style.cssText = commonBase + 'border:2px solid rgba(255,255,255,0.9); box-shadow: 0 0 0 6px rgba(255,255,255,0.25), inset 0 0 0 1px rgba(0,0,0,0.06);';
                try { btn.style.setProperty('background', bg, 'important'); btn.style.setProperty('background-image', bg, 'important'); } catch(_) {}
                const ringHL = document.createElement('div');
                ringHL.className = 'swatch-shine';
                ringHL.style.cssText = 'position:absolute;inset:4px;border-radius:inherit;box-shadow: inset 0 0 0 6px rgba(255,255,255,0.35); pointer-events:none;';
                btn.appendChild(ringHL);
            } else if (mode === 'neumorphic') {
                btn.style.cssText = commonBase + 'border:1px solid rgba(255,255,255,0.4); box-shadow: 8px 8px 20px rgba(0,0,0,0), -8px -8px 20px rgba(255,255,255,0.35), inset 0 0 0 1px rgba(255,255,255,.35);';
                try { btn.style.setProperty('background', bg, 'important'); } catch(_) {}
            } else if (mode === 'bevel') {
                btn.style.cssText = commonBase + 'border:1px solid rgba(255,255,255,0.6); box-shadow: inset 3px 3px 8px rgba(0,0,0,.08), inset -3px -3px 8px rgba(255,255,255,0), 0 10px 18px rgba(2,6,23,0);';
                try { btn.style.setProperty('background', bg, 'important'); } catch(_) {}
            } else if (mode === 'tilt') {
                btn.style.cssText = commonBase + 'transform: perspective(280px) rotateX(8deg) rotateY(-6deg); border:1px solid rgba(0,0,0,0.06); box-shadow: 0 18px 28px rgba(2,6,23,0);';
                try { btn.style.setProperty('background', bg, 'important'); } catch(_) {}
                btn.onmouseenter = () => { btn.style.transform = 'perspective(280px) rotateX(6deg) rotateY(-4deg) translateY(-2px)'; };
                btn.onmouseleave = () => { btn.style.transform = 'perspective(280px) rotateX(8deg) rotateY(-6deg)'; };
            } else if (mode === 'mesh') {
                btn.style.cssText = commonBase + 'border:1px solid rgba(0,0,0,0.06); overflow:hidden; box-shadow: 0 12px 24px rgba(2,6,23,0);';
                try { btn.style.setProperty('background', bg, 'important'); } catch(_) {}
                const mesh = document.createElement('div');
                mesh.className = 'swatch-shine';
                mesh.style.cssText = 'position:absolute;inset:-10%;border-radius:inherit;background: radial-gradient(120px 120px at 20% 30%, rgba(255,255,255,.4), transparent 60%), radial-gradient(140px 140px at 80% 70%, rgba(255,255,255,.25), transparent 60%); filter: blur(2px); opacity:.85; pointer-events:none;';
                btn.appendChild(mesh);
            } else if (mode === 'aqua') {
                btn.style.cssText = commonBase + 'border:1px solid rgba(255,255,255,0.55); box-shadow: 0 16px 26px rgba(2,6,23,0), inset 0 0 0 1px rgba(255,255,255,.28);';
                try { btn.style.setProperty('background', bg, 'important'); } catch(_) {}
                const gloss = document.createElement('div');
                gloss.className = 'swatch-shine';
                gloss.style.cssText = 'position:absolute;left:30%;right:30%;top:8%;height:36%;border-radius:9999px;background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.05)); mix-blend-mode: screen; pointer-events:none;';
                btn.appendChild(gloss);
            }
        }

        // æ ·å¼åˆ‡æ¢ -> å³æ—¶é‡ç»˜æ‰€æœ‰è‰²çƒ
        styleModeSelect.addEventListener('change', () => {
            swatchMode = styleModeSelect.value;
            try { GM_setValue('theme_palette_mode', swatchMode); } catch(_) {}
            Array.from(sphereWrap.querySelectorAll('button.theme-swatch')).forEach(btn => {
                const cs = getComputedStyle(btn);
                const bg = cs.backgroundImage && cs.backgroundImage !== 'none' ? cs.backgroundImage : cs.background;
                styleSwatch(btn, bg);
            });
        });
        // ç§»é™¤å¤åˆ¶å·¥å…·æ–¹æ³•

        gradients.forEach(g => {
            const btn = document.createElement('button');
            btn.setAttribute('aria-label', g.name);
            styleSwatch(btn, g.bg);
            btn.onclick = () => {
                const textColor = getCurrentTextColor();
                const gradientStr = g.bg;
                currentGradientStr = gradientStr;
                // å»é™¤å¤åˆ¶æ¨¡å¼é€»è¾‘
                const p = { name: g.name, primarycolor: g.primarycolor, dark: g.dark, light: g.light, lighter: g.lighter };
                document.documentElement.style.setProperty('--primarycolor', p.primarycolor);
                document.documentElement.style.setProperty('--primarycolor-dark', p.dark);
                document.documentElement.style.setProperty('--primarycolor-light', p.light);
                document.documentElement.style.setProperty('--primarycolor-lighter', p.lighter);
                document.documentElement.style.setProperty('--theme-name', p.name);
                try { GM_setValue('theme_text_color', textColor); } catch(_) {}
                document.documentElement.style.setProperty('--theme-text-color', textColor);
                ensureThemeTextStyleTag();
                GM_setValue('theme_preset', p);
                showNotification('ä¸»é¢˜å·²åº”ç”¨', 'success');
                // åŒæ­¥è‡ªå®šä¹‰æ ·å¼é¢æ¿çš„å–è‰²å™¨æ•°å€¼ï¼ˆè‹¥å­˜åœ¨ï¼‰
                try {
                    const cp = document.getElementById('custom-primarycolor'); if (cp) cp.value = p.primarycolor;
                    const cpd = document.getElementById('custom-primarycolor-dark'); if (cpd) cpd.value = p.dark;
                    const cpl = document.getElementById('custom-primarycolor-light'); if (cpl) cpl.value = p.light;
                    const cpll = document.getElementById('custom-primarycolor-lighter'); if (cpll) cpll.value = p.lighter;
                    if (window.__refreshCustomColorSwatches) window.__refreshCustomColorSwatches();
                } catch(_) {}
                // åŒæ­¥æ›´æ–°å…¨å±€ä¾èµ–ä¸»é¢˜çš„æŒ‰é’®/å‹¾é€‰åœ†ç­‰
                // å½“å¯ç”¨è‡ªå®šä¹‰æ ·å¼é¢œè‰²ä¼˜å…ˆæ—¶ï¼Œè·³è¿‡ä¸»é¢˜æ¸å˜å†…è”åº”ç”¨
                const customOverride = GM_getValue('custom_style_enabled', false) && GM_getValue('custom_colors_override_theme', false);
                if (!customOverride) {
                    document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn, #config-dialog .dialog-btn, #config-dialog .selector-test-btn, .dialog-btn, .selector-test-btn,  .buttons-row button').forEach(el => {
                        try { el.style.setProperty('background', `linear-gradient(135deg, ${p.primarycolor}, ${p.dark})`, 'important'); } catch(_){ el.style.background = `linear-gradient(135deg, ${p.primarycolor}, ${p.dark})`; }
                        try { el.style.setProperty('color', textColor, 'important'); } catch(_){ el.style.color = textColor; }
                    });
                } else if (!customOverride) {
                    document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn').forEach(el => {
                        try { el.style.setProperty('background', 'rgba(255,255,255,0.32)', 'important'); } catch(_){ el.style.background = 'rgba(255,255,255,0.32)'; }
                        try { el.style.setProperty('border', '1px solid rgba(255,255,255,0.45)', 'important'); } catch(_){ el.style.border = '1px solid rgba(255,255,255,0.45)'; }
                        try { el.style.setProperty('backdrop-filter', 'blur(14px)', 'important'); } catch(_){ el.style.backdropFilter = 'blur(14px)'; }
                        try { el.style.setProperty('-webkit-backdrop-filter', 'blur(14px)', 'important'); } catch(_){ el.style.webkitBackdropFilter = 'blur(14px)'; }
                        try { el.style.setProperty('box-shadow', '0 10px 30px rgba(0,0,0,0.06)', 'important'); } catch(_){ el.style.boxShadow = '0 10px 30px rgba(0,0,0,0.06)'; }
                        try { el.style.setProperty('color', textColor, 'important'); } catch(_){ el.style.color = textColor; }
                    });
                }
                // åŒæ­¥æ‰¹é‡æ“ä½œå‹¾é€‰æ¡†çš„æŠ•å½±ä¸é¢œè‰²
                const alphaFromHex = (hex) => {
                    if (typeof hex !== 'string') return 'rgba(0,0,0,0.18)';
                    const m = hex.trim().match(/^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$/);
                    if (!m) return 'rgba(0,0,0,0.18)';
                    let r, g, b;
                    if (m[1].length === 3) {
                        r = parseInt(m[1][0] + m[1][0], 16);
                        g = parseInt(m[1][1] + m[1][1], 16);
                        b = parseInt(m[1][2] + m[1][2], 16);
                    } else {
                        r = parseInt(m[1].slice(0,2), 16);
                        g = parseInt(m[1].slice(2,4), 16);
                        b = parseInt(m[1].slice(4,6), 16);
                    }
                    return `rgba(${r}, ${g}, ${b}, 0.35)`;
                };
                const shadowColor = alphaFromHex(p.primarycolor);
                document.querySelectorAll('#config-dialog input[type="checkbox"], #batch-ops-dialog input[type="checkbox"]').forEach(chk => {
                    chk.style.background = `linear-gradient(135deg, ${p.light || p.primarycolor}, ${p.primarycolor})`;
                    chk.style.borderColor = p.primarycolor;
                    chk.style.boxShadow = `inset 0 0 0 2px rgba(255,255,255,.9), 0 4px 10px ${shadowColor}`;
                });
            };
            sphereWrap.appendChild(btn);
        });

        // æ¸²æŸ“è‡ªå®šä¹‰æ¸å˜
        getCustomGradients().forEach((cg, idx) => {
            const btn = document.createElement('button');
            btn.setAttribute('aria-label', cg.name || `custom-${idx+1}`);
            const bgStr = cg.bg || cg.gradient || 'linear-gradient(135deg, #F3F4F6, #E5E7EB)';
            styleSwatch(btn, bgStr);
            btn.title = cg.gradient || cg.bg;
            btn.onclick = () => {
                const textColor = getCurrentTextColor();
                const gradientStr = cg.bg || cg.gradient || '';
                currentGradientStr = gradientStr;
                // å»é™¤å¤åˆ¶æ¨¡å¼é€»è¾‘
                const p = { name: cg.name || 'custom', primarycolor: cg.primarycolor, dark: cg.dark, light: cg.light || cg.primarycolor, lighter: cg.lighter || cg.primarycolor };
                document.documentElement.style.setProperty('--primarycolor', p.primarycolor);
                document.documentElement.style.setProperty('--primarycolor-dark', p.dark);
                if (p.light) document.documentElement.style.setProperty('--primarycolor-light', p.light);
                if (p.lighter) document.documentElement.style.setProperty('--primarycolor-lighter', p.lighter);
                document.documentElement.style.setProperty('--theme-name', p.name);
                try { GM_setValue('theme_text_color', textColor); } catch(_) {}
                document.documentElement.style.setProperty('--theme-text-color', textColor);
                ensureThemeTextStyleTag();
                GM_setValue('theme_preset', p);
                showNotification('ä¸»é¢˜å·²åº”ç”¨', 'success');
                // åŒæ­¥è‡ªå®šä¹‰æ ·å¼é¢æ¿çš„å–è‰²å™¨æ•°å€¼ï¼ˆè‹¥å­˜åœ¨ï¼‰
                try {
                    const cp = document.getElementById('custom-primarycolor'); if (cp) cp.value = p.primarycolor;
                    const cpd = document.getElementById('custom-primarycolor-dark'); if (cpd) cpd.value = p.dark;
                    const cpl = document.getElementById('custom-primarycolor-light'); if (cpl) cpl.value = p.light;
                    const cpll = document.getElementById('custom-primarycolor-lighter'); if (cpll) cpll.value = p.lighter;
                    if (window.__refreshCustomColorSwatches) window.__refreshCustomColorSwatches();
                } catch(_) {}
                // æ›´æ–°æŒ‰é’®æ ·å¼ï¼ˆå« !importantï¼‰
                document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn, #config-dialog .dialog-btn, #config-dialog .selector-test-btn, #config-dialog .filter-btn, .dialog-btn, .selector-test-btn, .filter-btn, .buttons-row button').forEach(el => {
                    try { el.style.setProperty('color', textColor, 'important'); } catch(_){ el.style.color = textColor; }
                    try { el.style.setProperty('background', `linear-gradient(135deg, ${p.primarycolor}, ${p.dark})`, 'important'); } catch(_){ el.style.background = `linear-gradient(135deg, ${p.primarycolor}, ${p.dark})`; }
                });
            };
            // åˆ é™¤æŒ‰é’®ï¼ˆä»…è‡ªå®šä¹‰é¡¹ï¼‰
            const del = document.createElement('span');
            del.textContent = 'Ã—';
            del.title = 'åˆ é™¤æ­¤æ¸å˜';
            del.style.cssText = 'position:absolute; top:-6px; right:-6px; height:18px; width:18px; line-height:18px; text-align:center; border-radius:9999px; background: rgba(0,0,0,0.6); color:#fff; font-size:12px; cursor:pointer; display:none;';
            btn.appendChild(del);
            btn.addEventListener('mouseenter', () => { del.style.display = 'block'; });
            btn.addEventListener('mouseleave', () => { del.style.display = 'none'; });
            del.onclick = (e) => {
                e.stopPropagation();
                if (!confirm('ç¡®å®šåˆ é™¤è¯¥è‡ªå®šä¹‰æ¸å˜å—ï¼Ÿ')) return;
                const list = getCustomGradients();
                const next = list.filter(item => (item.id && cg.id) ? item.id !== cg.id : (item.gradient || item.bg) !== (cg.gradient || cg.bg));
                saveCustomGradients(next);
                btn.remove();
                showNotification('å·²åˆ é™¤è‡ªå®šä¹‰æ¸å˜', 'success');
            };
            sphereWrap.appendChild(btn);
        });

        // ç»ç’ƒè´¨æ„Ÿ "+" æŒ‰é’®ï¼šæ·»åŠ è‡ªå®šä¹‰æ¸å˜
        const addBtn = document.createElement('button');
        addBtn.setAttribute('aria-label', 'add-gradient');
        addBtn.textContent = '+';
        styleSwatch(addBtn, 'linear-gradient(135deg, #F3F4F6, #E5E7EB)');
        addBtn.style.color = '#374151';
        addBtn.style.fontSize = '28px';
        addBtn.style.fontWeight = '700';
        addBtn.onmouseenter = () => { addBtn.style.transform = 'translateY(-2px)'; };
        addBtn.onmouseleave = () => { addBtn.style.transform = 'translateY(0)'; };
        addBtn.onclick = () => {
            const example = 'linear-gradient(135deg, rgb(255, 143, 171) 0%, rgb(255, 107, 157) 100%)';
            const val = prompt('è¾“å…¥æ¸å˜æˆ–é¢œè‰²ï¼ˆæ”¯æŒ linear-gradient / rgb / lab / #hex ç­‰ï¼‰ï¼š', example);
            if (!val) return;
            const id = Date.now();
            const preset = createPresetFromGradient(`custom-${id}`, val);
            if (!preset) { showNotification('æ ¼å¼æ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•', 'error'); return; }
            const list = getCustomGradients();
            list.push({ id, ...preset, gradient: preset.bg });
            saveCustomGradients(list);
            showNotification('å·²æ·»åŠ è‡ªå®šä¹‰æ¸å˜', 'success');
            // å³æ—¶æ¸²æŸ“æ–°æŒ‰é’®
            const nb = document.createElement('button');
            nb.setAttribute('aria-label', preset.name);
            styleSwatch(nb, preset.bg);
            nb.onclick = () => {
                const textColor = getCurrentTextColor();
                const gradientStr = preset.bg;
                currentGradientStr = gradientStr;
                // å»é™¤å¤åˆ¶æ¨¡å¼é€»è¾‘
                const p = { name: preset.name, primarycolor: preset.primarycolor, dark: preset.dark, light: preset.light, lighter: preset.lighter };
                document.documentElement.style.setProperty('--primarycolor', p.primarycolor);
                document.documentElement.style.setProperty('--primarycolor-dark', p.dark);
                document.documentElement.style.setProperty('--primarycolor-light', p.light);
                document.documentElement.style.setProperty('--primarycolor-lighter', p.lighter);
                document.documentElement.style.setProperty('--theme-name', p.name);
                try { GM_setValue('theme_text_color', textColor); } catch(_) {}
                document.documentElement.style.setProperty('--theme-text-color', textColor);
                ensureThemeTextStyleTag();
                GM_setValue('theme_preset', p);
                showNotification('ä¸»é¢˜å·²åº”ç”¨', 'success');
                // åŒæ­¥è‡ªå®šä¹‰æ ·å¼é¢æ¿çš„å–è‰²å™¨æ•°å€¼ï¼ˆè‹¥å­˜åœ¨ï¼‰
                try {
                    const cp = document.getElementById('custom-primarycolor'); if (cp) cp.value = p.primarycolor;
                    const cpd = document.getElementById('custom-primarycolor-dark'); if (cpd) cpd.value = p.dark;
                    const cpl = document.getElementById('custom-primarycolor-light'); if (cpl) cpl.value = p.light;
                    const cpll = document.getElementById('custom-primarycolor-lighter'); if (cpll) cpll.value = p.lighter;
                    if (window.__refreshCustomColorSwatches) window.__refreshCustomColorSwatches();
                } catch(_) {}
                document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn, .buttons-row button').forEach(el => {
                    el.style.color = textColor;
                    el.style.background = `linear-gradient(135deg, ${p.primarycolor}, ${p.dark})`;
                });
            };
            // åˆ é™¤æŒ‰é’®
            const del = document.createElement('span');
            del.textContent = 'Ã—';
            del.title = 'åˆ é™¤æ­¤æ¸å˜';
            del.style.cssText = 'position:absolute; top:-6px; right:-6px; height:18px; width:18px; line-height:18px; text-align:center; border-radius:9999px; background: rgba(0,0,0,0.6); color:#fff; font-size:12px; cursor:pointer; display:none;';
            nb.appendChild(del);
            nb.addEventListener('mouseenter', () => { del.style.display = 'block'; });
            nb.addEventListener('mouseleave', () => { del.style.display = 'none'; });
            del.onclick = (e) => {
                e.stopPropagation();
                if (!confirm('ç¡®å®šåˆ é™¤è¯¥è‡ªå®šä¹‰æ¸å˜å—ï¼Ÿ')) return;
                const list = getCustomGradients();
                const next = list.filter(item => item.id !== id);
                saveCustomGradients(next);
                nb.remove();
                showNotification('å·²åˆ é™¤è‡ªå®šä¹‰æ¸å˜', 'success');
            };
            sphereWrap.appendChild(nb);
        };

        // åº•éƒ¨æŒ‰é’®
        const footer = document.createElement('div');
        footer.style.cssText = 'display:flex;justify-content:flex-end;gap:10px;margin-top:14px;';
        // æ¢å¤é»˜è®¤
        const reset = document.createElement('button');
        reset.textContent = 'æ¢å¤é»˜è®¤';
        reset.style.cssText = 'padding:10px 18px;border:none;border-radius:9999px;background: linear-gradient(135deg, #E5E7EB, #F3F4F6); color:#374151;cursor:pointer; box-shadow: 0 8px 20px rgba(17,24,39,0.08); transition: transform .15s ease, box-shadow .2s ease;';
        reset.onmouseenter = () => { reset.style.transform = 'translateY(-1px)'; reset.style.boxShadow = '0 12px 24px rgba(17,24,39,0.14)'; };
        reset.onmouseleave = () => { reset.style.transform = 'translateY(0)'; reset.style.boxShadow = '0 8px 20px rgba(17,24,39,0.08)'; };
        reset.onclick = () => {
            try {
                GM_deleteValue('theme_preset');
                document.documentElement.style.removeProperty('--primarycolor');
                document.documentElement.style.removeProperty('--primarycolor-dark');
                document.documentElement.style.removeProperty('--primarycolor-light');
                document.documentElement.style.removeProperty('--primarycolor-lighter');
                document.documentElement.style.removeProperty('--theme-name');
                // æ¢å¤å­—ä½“é¢œè‰²åˆ°é»˜è®¤
                GM_deleteValue('theme_text_color');
                document.documentElement.style.setProperty('--theme-text-color', '#ffffff');
                const tag = document.getElementById('theme-text-color-style');
                if (tag) tag.textContent = tag.textContent; // è§¦å‘é‡ç®—
                // æ¸…é™¤å·²åº”ç”¨åˆ°æŒ‰é’®çš„å†…è”é¢œè‰²ï¼Œä½¿ç”¨å˜é‡å€¼
                document.querySelectorAll('#config-dialog .dialog-btn-primarycolor, #config-dialog .selector-picker-btn, #config-dialog .dialog-btn, #config-dialog .selector-test-btn, .dialog-btn, .selector-test-btn,  .buttons-row button').forEach(el => {
                    el.style.removeProperty('color');
                    el.style.removeProperty('background');
                    el.style.removeProperty('border');
                    el.style.removeProperty('box-shadow');
                });
                showNotification('å·²æ¢å¤é»˜è®¤ä¸»é¢˜', 'success');
            } catch(_) {}
        };
        // åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰æ¸å˜
        const clearCustom = document.createElement('button');
        clearCustom.textContent = 'åˆ é™¤å…¨éƒ¨è‡ªå®šä¹‰æ¸å˜';
        clearCustom.style.cssText = 'padding:10px 18px;border:1px solid #E5E7EB;border-radius:9999px;background: #FFFFFF; color:#374151;cursor:pointer; box-shadow: 0 8px 20px rgba(17,24,39,0.06); transition: transform .15s ease, box-shadow .2s ease;';
        clearCustom.onmouseenter = () => { clearCustom.style.transform = 'translateY(-1px)'; clearCustom.style.boxShadow = '0 12px 24px rgba(17,24,39,0.12)'; };
        clearCustom.onmouseleave = () => { clearCustom.style.transform = 'translateY(0)'; clearCustom.style.boxShadow = '0 8px 20px rgba(17,24,39,0.06)'; };
        clearCustom.onclick = () => {
            if (!confirm('ç¡®å®šåˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰æ¸å˜å—ï¼Ÿ')) return;
            try {
                GM_setValue('custom_gradients_v1', []);
                // ç§»é™¤ç•Œé¢ä¸­è‡ªå®šä¹‰æ¸å˜æŒ‰é’®ï¼ˆä¿ç•™å†…ç½®ä¸ +ï¼‰
                const nodes = Array.from(sphereWrap.querySelectorAll('button[aria-label^="custom-"]'));
                nodes.forEach(n => n.remove());
                showNotification('å·²æ¸…ç©ºè‡ªå®šä¹‰æ¸å˜', 'success');
            } catch(_) {}
        };

        // å»æ‰â€œä¿å­˜ä¸ºä¸»é¢˜â€æŒ‰é’®ä¸åŠŸèƒ½ï¼ˆä»…ä¿ç•™æ¢å¤ä¸å…³é—­ï¼‰
        const close = document.createElement('button');
        close.textContent = 'å…³é—­';
        close.style.cssText = 'padding:10px 20px;border:none;border-radius:9999px;background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); color:#fff;cursor:pointer;box-shadow:0 10px 22px var(--primarycolor-lighter); transition: transform .15s ease, box-shadow .2s ease;';
        close.onmouseenter = () => { close.style.transform = 'translateY(-1px)'; close.style.boxShadow = '0 14px 28px var(--primarycolor-lighter)'; };
        close.onmouseleave = () => { close.style.transform = 'translateY(0)'; close.style.boxShadow = '0 10px 22px var(--primarycolor-lighter)'; };
        close.onclick = () => document.body.removeChild(overlay);
        footer.appendChild(reset);
        footer.appendChild(clearCustom);
        footer.appendChild(close);

        dialog.appendChild(title);
        dialog.appendChild(controlsRow);
        dialog.appendChild(sphereWrap);
        sphereWrap.appendChild(addBtn);
        dialog.appendChild(footer);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
    }

    // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜é¢„è®¾
    (function applySavedTheme() {
        try {
            const p = GM_getValue('theme_preset');
            if (p && p.primarycolor && p.dark) {
                // å¦‚æœä¸»é¢˜é¢„è®¾é‡Œ primarycolor/dark æ˜¯æ¸å˜å­—ç¬¦ä¸²ï¼Œæå–å‰ä¸¤è‰²
                const gradientRegex = /(linear|radial|conic)-gradient\(/i;
                const extractStops = (str) => {
                    try {
                        const s = String(str || '');
                        const colorPattern = /#(?:[0-9a-fA-F]{3}){1,2}\b|rgba?\([^\)]*\)|hsla?\([^\)]*\)/g;
                        const matches = s.match(colorPattern) || [];
                        return matches.slice(0, 4);
                    } catch (_) {
                        return [];
                    }
                };
                const pick = (val, fallback) => {
                    const v = String(val || '').trim();
                    if (gradientRegex.test(v)) {
                        const [c1, c2] = extractStops(v);
                        return { c1: c1 || fallback, c2: c2 || c1 || fallback };
                    }
                    return { c1: v || fallback, c2: v || fallback };
                };
                const pp = pick(p.primarycolor, '#FF6B9D');
                const dd = pick(p.dark, pp.c2 || pp.c1);
                document.documentElement.style.setProperty('--primarycolor', pp.c1);
                document.documentElement.style.setProperty('--primarycolor-dark', dd.c1 !== dd.c2 ? dd.c2 : dd.c1);
                if (p.light) document.documentElement.style.setProperty('--primarycolor-light', p.light);
                if (p.lighter) document.documentElement.style.setProperty('--primarycolor-lighter', p.lighter);
                if (p.name) document.documentElement.style.setProperty('--theme-name', p.name);
            }
            // è‡ªå®šä¹‰æ ·å¼ä¼˜å…ˆäºä¸»é¢˜ï¼šå¦‚æœå¼€å¯äº†è‡ªå®šä¹‰å¹¶è®¾ç½®äº†å››å˜é‡ï¼Œåˆ™è¦†ç›–
            const customEnabled = GM_getValue('custom_style_enabled', false);
            if (customEnabled) {
                const cp = GM_getValue('custom_primarycolor', '') || null;
                const cpd = GM_getValue('custom_primarycolor_dark', '') || null;
                const cpl = GM_getValue('custom_primarycolor_light', '') || null;
                const cpll = GM_getValue('custom_primarycolor_lighter', '') || null;
                // æ”¯æŒè‡ªå®šä¹‰é‡Œè¾“å…¥æ¸å˜å­—ç¬¦ä¸²çš„æƒ…å†µ
                const gradientRegex = /(linear|radial|conic)-gradient\(/i;
                const extractStops = (str) => {
                    try {
                        const s = String(str || '');
                        const colorPattern = /#(?:[0-9a-fA-F]{3}){1,2}\b|rgba?\([^\)]*\)|hsla?\([^\)]*\)/g;
                        const matches = s.match(colorPattern) || [];
                        return matches.slice(0, 4);
                    } catch (_) {
                        return [];
                    }
                };
                const applyPrimaryPair = (val, targetVar, fallbackSecond) => {
                    const v = String(val || '').trim();
                    if (v && gradientRegex.test(v)) {
                        const [c1, c2] = extractStops(v);
                        if (c1) document.documentElement.style.setProperty('--primarycolor', c1);
                        document.documentElement.style.setProperty('--primarycolor-dark', c2 || fallbackSecond || c1 || '#ffffff');
                        return true;
                    }
                    if (v) document.documentElement.style.setProperty(targetVar, v);
                    return false;
                };

                let pairApplied = false;
                if (cp) {
                    pairApplied = applyPrimaryPair(cp, '--primarycolor', null);
                }
                if (!pairApplied && cpd) {
                    // å¦‚æœåªåœ¨ dark é‡Œå†™äº†æ¸å˜ï¼Œä¹Ÿåšæ‹†è§£
                    pairApplied = applyPrimaryPair(cpd, '--primarycolor-dark', null);
                }
                if (!pairApplied) {
                    if (cp) document.documentElement.style.setProperty('--primarycolor', cp);
                    if (cpd) document.documentElement.style.setProperty('--primarycolor-dark', cpd);
                }
                // å¦‚æœæœªæä¾› light/lighterï¼Œåˆ™æ ¹æ® primarycolor è‡ªåŠ¨æ¨å¯¼æ›´æµ…é¢œè‰²
                if (cpl) {
                    document.documentElement.style.setProperty('--primarycolor-light', cpl);
                } else if (cp) {
                    document.documentElement.style.setProperty('--primarycolor-light', lightenColor(cp, 30));
                }
                if (cpll) {
                    document.documentElement.style.setProperty('--primarycolor-lighter', cpll);
                } else if (cp) {
                    document.documentElement.style.setProperty('--primarycolor-lighter', lightenColor(cp, 15));
                }
                // åˆå§‹åŒ–æ–‡å­—è‰²/é˜´å½±è‰²å˜é‡ï¼ˆå…¼å®¹æ—§å€¼ï¼‰
                let tc = GM_getValue('custom_text_color2', GM_getValue('custom_text_color', '#ffffff'));
                let bs = GM_getValue('custom_shadow_color', '#ffffff');
                if (typeof bs === 'string' && bs.toLowerCase() === '#290000') { bs = '#ffffff'; GM_setValue('custom_shadow_color', bs); }
                document.documentElement.style.setProperty('--theme-text-color', tc);
                document.documentElement.style.setProperty('--box-shadow-color', bs);
            }
            // æ¢å¤å­—ä½“é¢œè‰²
            const savedTextColor = GM_getValue('theme_text_color', '#ffffff');
            document.documentElement.style.setProperty('--theme-text-color', savedTextColor);
            // æ³¨å…¥æ ·å¼ï¼Œç¡®ä¿åˆ·æ–°åæŒ‰é’®æ–‡å­—é¢œè‰²ä¸ä¸¢å¤±
            (function ensureThemeTextColorAfterLoad(){
                const id = 'theme-text-color-style';
                let tag = document.getElementById(id);
                if (!tag) { tag = document.createElement('style'); tag.id = id; document.head.appendChild(tag); }
                tag.textContent = `
                    #config-dialog .dialog-btn-primarycolor,
                    #config-dialog .selector-picker-btn,
                    #config-dialog .selector-test-btn,
                    .selector-picker-btn,
                    .dialog-btn-primarycolor,
                    .selector-test-btn,
                    .buttons-row button,
                    #batch-ops-dialog .btn-primarycolor { color: var(--theme-text-color, #ffffff); }
                    #config-dialog .dialog-btn-primarycolor *,
                    #config-dialog .selector-picker-btn *,
                    #config-dialog .selector-test-btn *,
                    #config-dialog .filter-btn *,
                    .selector-picker-btn *,
                    .dialog-btn-primarycolor *,
                    .selector-test-btn *,

                    .buttons-row button *,
                    #batch-ops-dialog .btn-primarycolor * { color: var(--theme-text-color, #ffffff); }
                `;
            })();
        } catch (_) {}
    })();

    // å…¨å±€UIæ ·å¼ï¼šæ»šåŠ¨æ¡ & é€šç”¨æ§ä»¶ç¾åŒ–ï¼ˆç§»é™¤æ·±è‰²æ¨¡å¼ï¼‰
    (function ensureGlobalUIStyles() {
        const styleId = 'notion-clipper-global-ui-styles';
        if (document.getElementById(styleId)) return;
        const s = document.createElement('style');
        s.id = styleId;
        s.textContent = `
            /* æ»šåŠ¨æ¡ï¼ˆWebKitï¼‰ */
            ::-webkit-scrollbar { width: 10px; height: 10px; }
            ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 9999px; }
            ::-webkit-scrollbar-thumb {
                border-radius: 9999px;
                background: linear-gradient(180deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                border: 2px solid rgba(255,255,255,0.6);
            }
            ::-webkit-scrollbar-thumb:hover { filter: brightness(0.95); }

            /* æ·±è‰²æ¨¡å¼å·²ç§»é™¤ï¼ˆæŒ‰éœ€å¯å†å¼€å¯ï¼‰ */

            /* é…ç½®ç•Œé¢æ•´ä½“åˆ†ç»„é£æ ¼ï¼ˆå¯¹ #config-dialog æ·»åŠ æ¸©å’Œåˆ†ç»„å¡ç‰‡ï¼‰ */
            #config-dialog .group-card { background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%); border: 1px solid #E5E7EB; border-radius: 20px; padding: 14px; margin-bottom: 14px; box-shadow: 0 6px 16px var(--box-shadow-color, rgba(0,0,0,.06)); }
            #config-dialog .group-card h4 { margin: 0 0 8px 0; font-size: 14px; color: #111827; }
            #config-dialog .nc-input { padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 20px; background: #FFFFFF; color:#111827; }

            /* æ‰¹é‡æ“ä½œï¼šåœ†å½¢ç²‰è‰²æ¸å˜å‹¾é€‰æ¡†ä¸ä¸»è¦æ‰§è¡ŒæŒ‰é’®ï¼ˆéšä¸»é¢˜å˜æ¢ï¼‰ */
            #batch-ops-dialog input[type="checkbox"] {
                appearance: none; -webkit-appearance: none; width: 18px; height: 18px; border-radius: 9999px; margin: 0; display: inline-block; vertical-align: middle;
                border: 2px solid var(--primarycolor, #FF8FAB); background: white; box-shadow: inset 0 0 0 2px white, 0 2px 6px rgba(255, 107, 157, 0.25);
                cursor: pointer; transition: all .15s ease;
            }
            #batch-ops-dialog input[type="checkbox"]:checked {
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                border-color: var(--primarycolor-dark, #FF6B9D); box-shadow: inset 0 0 0 2px rgba(255,255,255,.9), 0 4px 10px rgba(255,107,157,.35);
            }
            #batch-ops-dialog .btn-primarycolor {
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); color:#fff; border:none; box-shadow: 0 6px 14px var(--box-shadow-color, rgba(255,107,157,.35));
                border-radius: 20px; padding: 10px 20px;
            }
            #batch-ops-dialog .btn-secondary { background: #fff; color:#6B7280; border:1px solid #D1D5DB; border-radius: 20px; padding: 10px 20px; }

        `;
        document.head.appendChild(s);
    })();

    // æ˜¾ç¤ºè‡ªåŠ¨æ›´æ–°é…ç½®å¯¹è¯æ¡†
    function showAutoUpdateConfigDialog() {
        const autoUpdateEnabled = !GM_getValue('autoUpdateDisabled', false);

        // åˆ›å»ºé®ç½©å±‚
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: -webkit-fill-available;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        // åˆ›å»ºå¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.style.cssText = `
            background: white;
            border-radius: 20px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        `;
        dialog.className = 'notion-AutoUpdate-dialog';

        // æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'è‡ªåŠ¨æ›´æ–°é…ç½®';
        title.style.cssText = `
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            text-align: center;
        `;

        const sectionStyle = `
            margin: 16px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            `;

        // è‡ªåŠ¨æ›´æ–°é€‰é¡¹
        const autoUpdateContainer = document.createElement('div');
        autoUpdateContainer.style.cssText = sectionStyle;

        const autoUpdateCheckboxContainer = createCustomCheckbox(
            'auto-update-config-checkbox',
            autoUpdateEnabled,
            'å¯ç”¨è‡ªåŠ¨æ›´æ–°'
        );
        autoUpdateContainer.appendChild(autoUpdateCheckboxContainer);

        // å®šæœŸé—´éš”è®¾ç½®
        const intervalContainer = document.createElement('div');
        intervalContainer.style.cssText = sectionStyle;

        const intervalLabel = document.createElement('label');
        intervalLabel.textContent = 'å®šæœŸæ£€æŸ¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰';
        intervalLabel.style.cssText = 'font-size: 13px; color: #6B7280;';

        const intervalInput = document.createElement('input');
        intervalInput.type = 'number';
        intervalInput.min = '1';
        intervalInput.max = '120';
        intervalInput.value = ENHANCED_AUTO_UPDATE_CONFIG.checkInterval || 5;
        intervalInput.id = 'auto-update-interval-input';
        intervalInput.style.cssText = `
            width: -webkit-fill-available;
            padding: 10px 12px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            `;

        intervalContainer.appendChild(intervalLabel);
        intervalContainer.appendChild(intervalInput);

        // DOMç›‘å¬é…ç½®
        const observerCheckboxContainer = createCustomCheckbox(
            'auto-update-observer-checkbox',
            ENHANCED_AUTO_UPDATE_CONFIG.observerEnabled,
            'ç›‘å¬ç« èŠ‚/è¿½æ›´å…ƒç´ å˜åŒ–ç«‹å³æ›´æ–°'
        );

        const domDebounceContainer = document.createElement('div');
        domDebounceContainer.style.cssText = sectionStyle;

        const domDebounceLabel = document.createElement('label');
        domDebounceLabel.textContent = 'ç›‘å¬é˜²æŠ–æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰';
        domDebounceLabel.style.cssText = 'font-size: 13px; color: #6B7280;';

        const domDebounceInput = document.createElement('input');
        domDebounceInput.type = 'number';
        domDebounceInput.min = '200';
        domDebounceInput.max = '10000';
        domDebounceInput.value = ENHANCED_AUTO_UPDATE_CONFIG.domDebounceMs || 2000;
        domDebounceInput.id = 'auto-update-dom-debounce';
        domDebounceInput.style.cssText = `
            width: -webkit-fill-available;
            padding: 10px 12px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            `;

        domDebounceContainer.appendChild(domDebounceLabel);
        domDebounceContainer.appendChild(domDebounceInput);

        // é¡µé¢ç¼“å­˜TTLè®¾ç½®
        const cacheTtlContainer = document.createElement('div');
        cacheTtlContainer.style.cssText = sectionStyle;

        const cacheTtlLabel = document.createElement('label');
        cacheTtlLabel.textContent = 'é¡µé¢å­˜åœ¨æ€§ç¼“å­˜æ—¶é•¿ï¼ˆç§’ï¼‰';
        cacheTtlLabel.style.cssText = 'font-size: 13px; color: #6B7280;';

        const cacheTtlInput = document.createElement('input');
        cacheTtlInput.type = 'number';
        cacheTtlInput.min = '1';
        cacheTtlInput.max = '300';
        cacheTtlInput.value = Math.round((ENHANCED_AUTO_UPDATE_CONFIG.cacheTtlMs || 10000) / 1000);
        cacheTtlInput.id = 'auto-update-cache-ttl';
        cacheTtlInput.style.cssText = `
            width: -webkit-fill-available;
            padding: 10px 12px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            `;

        cacheTtlContainer.appendChild(cacheTtlLabel);
        cacheTtlContainer.appendChild(cacheTtlInput);

        // åˆå§‹æ£€æŸ¥å»¶è¿Ÿè®¾ç½®
        const initDelayContainer = document.createElement('div');
        initDelayContainer.style.cssText = sectionStyle;

        const initDelayLabel = document.createElement('label');
        initDelayLabel.textContent = 'é¡µé¢åŠ è½½åˆå§‹æ£€æŸ¥å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰';
        initDelayLabel.style.cssText = 'font-size: 13px; color: #6B7280;';

        const initDelayInput = document.createElement('input');
        initDelayInput.type = 'number';
        initDelayInput.min = '50';
        initDelayInput.max = '2000';
        initDelayInput.value = ENHANCED_AUTO_UPDATE_CONFIG.initCheckDelayMs || 100;
        initDelayInput.id = 'auto-update-init-delay';
        initDelayInput.style.cssText = `
            width: -webkit-fill-available;
            padding: 10px 12px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            `;

        initDelayContainer.appendChild(initDelayLabel);
        initDelayContainer.appendChild(initDelayInput);

        const visibilityCheckboxContainer = createCustomCheckbox(
            'auto-update-visibility-checkbox',
            ENHANCED_AUTO_UPDATE_CONFIG.visibilityTrigger,
            'åˆ‡æ¢å›å½“å‰æ ‡ç­¾é¡µæ—¶ç«‹å³æ£€æŸ¥'
        );

        // æŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        `;

        // å–æ¶ˆæŒ‰é’®
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'å–æ¶ˆ';
        cancelBtn.style.cssText = `
            padding: 10px 20px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            background: white;
            color: #374151;
            cursor: pointer;
            font-size: 14px;
        `;

        // ä¿å­˜æŒ‰é’®
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.style.cssText = `
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        `;

        // æ·»åŠ æ‚¬åœæ•ˆæœ
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.background = 'linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D))';
            saveBtn.style.transform = 'translateY(-1px)';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.background = 'linear-gradient(135deg, var(--primarycolor-dark, #FF8FAB), var(--primarycolor, #FF6B9D))';
            saveBtn.style.transform = 'translateY(0)';
        });

        // äº‹ä»¶å¤„ç†
        cancelBtn.addEventListener('click', () => {
            document.body.removeChild(overlay);
        });

        saveBtn.addEventListener('click', () => {
            const newAutoUpdateEnabled = document.getElementById('auto-update-config-checkbox').checked;
            GM_setValue('autoUpdateDisabled', !newAutoUpdateEnabled);

            const newInterval = Math.max(1, parseInt(intervalInput.value, 10) || ENHANCED_AUTO_UPDATE_CONFIG.checkInterval || 5);
            GM_setValue('auto_update_check_interval', newInterval);
            ENHANCED_AUTO_UPDATE_CONFIG.checkInterval = newInterval;

            const observerEnabled = document.getElementById('auto-update-observer-checkbox').checked;
            GM_setValue('auto_update_dom_observer_enabled', observerEnabled);
            ENHANCED_AUTO_UPDATE_CONFIG.observerEnabled = observerEnabled;

            const domDebounce = Math.max(200, parseInt(domDebounceInput.value, 10) || ENHANCED_AUTO_UPDATE_CONFIG.domDebounceMs || 2000);
            GM_setValue('auto_update_dom_debounce_ms', domDebounce);
            ENHANCED_AUTO_UPDATE_CONFIG.domDebounceMs = domDebounce;

            const visibilityEnabled = document.getElementById('auto-update-visibility-checkbox').checked;
            GM_setValue('auto_update_visibility_trigger', visibilityEnabled);
            ENHANCED_AUTO_UPDATE_CONFIG.visibilityTrigger = visibilityEnabled;

            const cacheTtl = Math.max(1, parseInt(document.getElementById('auto-update-cache-ttl').value, 10) || 10) * 1000;
            GM_setValue('existing_page_cache_ttl_ms', cacheTtl);
            ENHANCED_AUTO_UPDATE_CONFIG.cacheTtlMs = cacheTtl;

            const initDelay = Math.max(50, parseInt(document.getElementById('auto-update-init-delay').value, 10) || 100);
            GM_setValue('auto_update_init_check_delay_ms', initDelay);
            ENHANCED_AUTO_UPDATE_CONFIG.initCheckDelayMs = initDelay;

            setupVisibilityTrigger();

            const currentSiteConfig = getSiteConfig();
            if (currentSiteConfig.contentType !== 'clip') {
                setupAutoUpdateObservers(currentSiteConfig, true);
            } else if (autoUpdateMutationObserver) {
                autoUpdateMutationObserver.disconnect();
                autoUpdateMutationObserver = null;
            }

            startPeriodicUpdateCheck(true);

            if (newAutoUpdateEnabled) {
                requestAutoUpdate('config-change', 0);
            }

            showNotification('è‡ªåŠ¨æ›´æ–°é…ç½®å·²ä¿å­˜', 'success');
            document.body.removeChild(overlay);
        });

        // ç»„è£…å¯¹è¯æ¡†
        buttonContainer.appendChild(cancelBtn);
        buttonContainer.appendChild(saveBtn);
        dialog.appendChild(title);
        dialog.appendChild(autoUpdateContainer);
        dialog.appendChild(intervalContainer);
        dialog.appendChild(observerCheckboxContainer);
        dialog.appendChild(domDebounceContainer);
        dialog.appendChild(cacheTtlContainer);
        dialog.appendChild(initDelayContainer);
        dialog.appendChild(visibilityCheckboxContainer);
        dialog.appendChild(buttonContainer);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                document.body.removeChild(overlay);
            }
        });
    }
    // å¤„ç†å¯¼å…¥
    async function handleImport() {
        showNotification('æ­£åœ¨å¤„ç†...', 'info');
        try {
            window._existingNotionCoverUrl = '';
            const siteConfig = getSiteConfig();
            const markdownTransformCfg = getMarkdownTransformConfig();
            const markdownTransformEnabled = !!(markdownTransformCfg && markdownTransformCfg.enabled);

            if (siteConfig.requireConfiguration && !siteConfig.isDefaultConfig) {
                showNotification('è¯·å…ˆé…ç½®ç½‘ç«™è§„åˆ™', 'info');
                // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†é€æ­¥é…ç½®
                const useStepConfig = GM_getValue('useStepConfig', false);
                if (useStepConfig) {
                    showStepConfigDialog();
                } else {
                    showConfigDialog();
                }
                return;
            }

            // æ£€æŸ¥å‰ªè—ç±»å‹ç‰¹æ®Šå¤„ç†
            if (siteConfig.contentType === 'clip') {
                // å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç°æœ‰é¡µé¢ï¼Œå†³å®šä½¿ç”¨æ·»åŠ æ¨¡å¼è¿˜æ˜¯æ›´æ–°æ¨¡å¼
                const sourceURL = window.location.href;
                const existingPageId = await checkExistingPage(sourceURL, siteConfig.contentType);
                // å‰ªè—æ¨¡å¼ï¼šå³ä½¿å­˜åœ¨æ—§é¡µé¢ï¼Œç¬¬äºŒæ¬¡ç‚¹å‡»ä¹Ÿè¦é‡æ–°ä¸Šä¼ å›¾ç‰‡
                // å› ä¸ºé¡µé¢ä¼šè¢«åˆ æ‰ï¼Œä¸èƒ½ä¾èµ–æ—§å†…å®¹ï¼Œå¼ºåˆ¶èµ°æ·»åŠ æ¨¡å¼é€»è¾‘ï¼ˆä¸è®¾ç½®å…¨å±€æ›´æ–°æ¨¡å¼ï¼‰
                const isUpdateMode = false;

                console.log('å‰ªè—æ¨¡å¼é¡µé¢æ£€æŸ¥ç»“æœ:', { existingPageId, isUpdateMode });

                // è·å–åŸºæœ¬ä¿¡æ¯
                const comicData = await extractComicData(siteConfig, isUpdateMode); // æ ¹æ®æ˜¯å¦å­˜åœ¨ç°æœ‰é¡µé¢å†³å®šæ¨¡å¼
                if (siteConfig.domainIconUrl) {
                    comicData._domainIconUrl = siteConfig.domainIconUrl;
                }

                // å‰ªè—æ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨é€‰æ‹©å™¨è·å–çš„æ ‡é¢˜
                // å¦‚æœè®¾ç½®äº†ä¹¦åé€‰æ‹©å™¨ï¼ˆåœ¨å‰ªè—æ¨¡å¼ä¸‹æ˜¾ç¤ºä¸ºæ ‡é¢˜ï¼‰ï¼Œä¼˜å…ˆä»é€‰æ‹©å™¨è·å–æ ‡é¢˜
                if (siteConfig.selectors && siteConfig.selectors['ä¹¦å']) {
                    try {
                        const titleElements = document.querySelectorAll(siteConfig.selectors['ä¹¦å']);
                        if (titleElements && titleElements.length > 0) {
                            const selection = resolveElementSelection(titleElements, siteConfig.selectorIndices['ä¹¦å'] ?? '1');
                            if (!selection.elements.length) {
                                comicData.æ ‡é¢˜ = '';
                            } else if (selection.mode === 'all' || selection.mode === 'multiple') {
                                let titleText = joinTextsWithSeparator('ä¹¦å', selection.elements
                                                                       .map(el => el.textContent.trim())
                                                                       .filter(Boolean));
                                try {
                                    const filterPattern = (siteConfig.selectors && siteConfig.selectors['ä¹¦å_filter']) ? siteConfig.selectors['ä¹¦å_filter'] : '';
                                    const filterMode = (siteConfig.selectors && siteConfig.selectors['ä¹¦å_filter_mode']) ? siteConfig.selectors['ä¹¦å_filter_mode'] : 'remove';
                                    titleText = applyFilter(titleText, filterPattern, filterMode, 'ä¹¦å');
                                } catch (_) {}
                                comicData.æ ‡é¢˜ = cleanTitle(titleText);
                            } else {
                                let rawTitle = selection.elements[0].textContent.trim();
                                try {
                                    const filterPattern = (siteConfig.selectors && siteConfig.selectors['ä¹¦å_filter']) ? siteConfig.selectors['ä¹¦å_filter'] : '';
                                    const filterMode = (siteConfig.selectors && siteConfig.selectors['ä¹¦å_filter_mode']) ? siteConfig.selectors['ä¹¦å_filter_mode'] : 'remove';
                                    rawTitle = applyFilter(rawTitle, filterPattern, filterMode, 'ä¹¦å');
                                } catch (_) {}
                                comicData.æ ‡é¢˜ = cleanTitle(rawTitle);
                            }
                            console.log('å‰ªè—æ¨¡å¼ï¼šä»æ ‡é¢˜é€‰æ‹©å™¨è·å–æ ‡é¢˜:', comicData.æ ‡é¢˜);
                        }
                    } catch (error) {
                        console.error('ä»æ ‡é¢˜é€‰æ‹©å™¨è·å–æ ‡é¢˜å¤±è´¥:', error);
                    }
                }

                // å¦‚æœé€‰æ‹©å™¨æ²¡æœ‰è·å–åˆ°æ ‡é¢˜ï¼Œåˆ™ä½¿ç”¨extractComicDataçš„ç»“æœæˆ–é¡µé¢æ ‡é¢˜
                if (!comicData.æ ‡é¢˜) {
                    // ä¼˜å…ˆä½¿ç”¨extractComicDataæå–çš„æ ‡é¢˜
                    if (comicData.æ ‡é¢˜) {
                        comicData.æ ‡é¢˜ = cleanTitle(comicData.æ ‡é¢˜);
                        console.log('å‰ªè—æ¨¡å¼ï¼šä½¿ç”¨extractComicDataæå–çš„æ ‡é¢˜:', comicData.æ ‡é¢˜);
                    } else {
                        // æœ€åæ‰ä½¿ç”¨é¡µé¢æ ‡é¢˜
                        const pageTitle = document.title.trim();
                        if (pageTitle) {
                            // åº”ç”¨ç”¨æˆ·é…ç½®çš„æ ‡é¢˜è¿‡æ»¤è§„åˆ™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            try {
                                const filterPattern = (siteConfig.selectors && siteConfig.selectors['ä¹¦å_filter']) ? siteConfig.selectors['ä¹¦å_filter'] : '';
                                const filterMode = (siteConfig.selectors && siteConfig.selectors['ä¹¦å_filter_mode']) ? siteConfig.selectors['ä¹¦å_filter_mode'] : 'remove';
                                const preClean = applyFilter(pageTitle.split('|')[0].split('-')[0].trim(), filterPattern, filterMode, 'ä¹¦å');
                                comicData.æ ‡é¢˜ = cleanTitle(preClean);
                            } catch (_) {
                                comicData.æ ‡é¢˜ = cleanTitle(pageTitle.split('|')[0].split('-')[0].trim());
                            }
                            console.log('å‰ªè—æ¨¡å¼ï¼šä»é¡µé¢æ ‡é¢˜è·å–æ ‡é¢˜:', comicData.æ ‡é¢˜);
                        } else {
                            comicData.æ ‡é¢˜ = "æœªå‘½åå‰ªè— - " + new Date().toLocaleString();
                        }
                    }
                }

                // å¤„ç†å‰ªè—å†…å®¹
                const selectorsToUse = Array.isArray(siteConfig.contentSelectors) && siteConfig.contentSelectors.length > 0
                ? siteConfig.contentSelectors
                : (siteConfig.contentSelector ? [siteConfig.contentSelector] : []);

                if (selectorsToUse.length > 0) {
                    try {
                        // å¦‚æœæœ‰å¤šä¸ªé€‰æ‹©å™¨ï¼Œåªä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨åˆ›å»ºé¡µé¢ï¼Œå…¶ä»–é€‰æ‹©å™¨çš„å†…å®¹å°†åœ¨é¡µé¢åˆ›å»ºåè¿½åŠ 
                        const firstSelector = selectorsToUse[0];
                        const additionalSelectors = selectorsToUse.slice(1);

                        console.log(`ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨åˆ›å»ºé¡µé¢: ${firstSelector}`);
                        if (additionalSelectors.length > 0) {
                            console.log(`å°†åœ¨é¡µé¢åˆ›å»ºåè¿½åŠ  ${additionalSelectors.length} ä¸ªé€‰æ‹©å™¨çš„å†…å®¹`);
                        }

                        // å¤„ç†ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨çš„å†…å®¹
                        let contentHtml = '';
                        const contentElements = document.querySelectorAll(firstSelector);
                        console.log(`ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨æ‰¾åˆ° ${contentElements.length} ä¸ªåŒ¹é…å…ƒç´ `);

                        contentElements.forEach((el, elIndex) => {
                            const clone = el.cloneNode(true);
                            const excludes = Array.isArray(siteConfig.clipExcludeSelectors) ? siteConfig.clipExcludeSelectors : [];
                            excludes.forEach(sel => {
                                try { clone.querySelectorAll(sel).forEach(n => n.remove()); } catch (e) {}
                            });

                            const elementHtml = clone.outerHTML.trim();
                            console.log(`å…ƒç´  ${elIndex + 1} HTMLé•¿åº¦: ${elementHtml.length}`);
                            console.log(`å…ƒç´  ${elIndex + 1} åŒ…å«è§†é¢‘:`, elementHtml.includes('<video'));
                            console.log(`å…ƒç´  ${elIndex + 1} åŒ…å«å›¾ç‰‡:`, elementHtml.includes('<img'));

                            if (elementHtml) {
                                contentHtml += elementHtml;
                            }
                        });

                        if (contentHtml) {
                            console.log('ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨HTMLå†…å®¹é•¿åº¦:', contentHtml.length);
                            console.log('ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨:', firstSelector);

                            const selectorSpecific = (markdownTransformCfg.selectorRules && firstSelector) ? markdownTransformCfg.selectorRules[firstSelector] : null;
                            const rulesForSel = Array.isArray(selectorSpecific) ? selectorSpecific : (markdownTransformCfg.rules || []);
                            const htmlForConversion = (markdownTransformEnabled && rulesForSel.length) ? applyHtmlTransformRules(contentHtml, rulesForSel) : contentHtml;
                            const contentData = convertHtmlToMarkdown(htmlForConversion);
                            if (markdownTransformEnabled && rulesForSel.length) {
                                try { comicData.content = applyMarkdownTransformRules(contentData, rulesForSel); } catch(_) { comicData.content = contentData; }
                                comicData._mdTransformApplied = true;
                            } else {
                                comicData.content = contentData;
                            }

                            console.log('å·²æå–ç¬¬ä¸€ä¸ªé€‰æ‹©å™¨å†…å®¹ï¼Œæ–‡æœ¬é•¿åº¦:', contentData.markdown.length, 'å›¾ç‰‡æ•°é‡:', contentData.images.length, 'è§†é¢‘æ•°é‡:', contentData.videos ? contentData.videos.length : 0);
                            console.log('Markdownå†…å®¹é¢„è§ˆ:', contentData.markdown.substring(0, 500));

                            // å­˜å‚¨é¢å¤–çš„é€‰æ‹©å™¨ä¿¡æ¯ï¼Œç”¨äºåç»­è¿½åŠ 
                            if (additionalSelectors.length > 0) {
                                // å°†é¢å¤–é€‰æ‹©å™¨ä¿¡æ¯å­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼Œé¿å…ä¼ é€’ç»™Notion API
                                window._additionalSelectors = additionalSelectors;
                                window._siteConfig = siteConfig;
                            }
                        } else {
                            showNotification('æœªæ‰¾åˆ°åŒ¹é…ç¬¬ä¸€ä¸ªå†…å®¹é€‰æ‹©å™¨çš„å…ƒç´ ', 'warning');
                            console.warn('ç¬¬ä¸€ä¸ªå‰ªè—å†…å®¹é€‰æ‹©å™¨æœªåŒ¹é…åˆ°å…ƒç´ :', firstSelector);
                        }
                    } catch (error) {
                        console.error('æå–å‰ªè—å†…å®¹å¤±è´¥:', error);
                        showNotification('æå–å‰ªè—å†…å®¹å¤±è´¥: ' + error.message, 'error');
                    }
                }

                // æŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨é¡µé¢ï¼ˆå·²åœ¨ä¸Šé¢æ£€æŸ¥è¿‡ï¼‰
                let result;

                if (existingPageId) {
                    // å‰ªè—æ¨¡å¼ï¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦åˆ é™¤ç°æœ‰é¡µé¢å¹¶é‡æ–°åˆ›å»º
                    console.log('å‰ªè—æ¨¡å¼ï¼šå‘ç°å·²å­˜åœ¨é¡µé¢ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦é‡æ–°åˆ›å»º');

                    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                    const shouldReplace = await showConfirmDialog(
                        'é¡µé¢å·²å­˜åœ¨',
                        'æ£€æµ‹åˆ°Notionä¸­å·²å­˜åœ¨æ­¤å‰ªè—é¡µé¢ã€‚æ˜¯å¦è¦åˆ é™¤ç°æœ‰é¡µé¢å¹¶é‡æ–°åˆ›å»ºï¼Ÿ',
                        'åˆ é™¤å¹¶é‡æ–°åˆ›å»º',
                        'å–æ¶ˆ'
                    );

                    if (shouldReplace) {
                        try {
                            // åˆ é™¤ç°æœ‰é¡µé¢ - ä½¿ç”¨æ›´å®‰å…¨çš„åˆ é™¤æ–¹å¼
                            console.log('å°è¯•åˆ é™¤ç°æœ‰é¡µé¢:', existingPageId);

                            // å…ˆå°è¯•è·å–é¡µé¢ä¿¡æ¯ï¼Œç¡®è®¤é¡µé¢å­˜åœ¨
                            const pageInfo = await sendNotionRequest("GET", `https://api.notion.com/v1/pages/${existingPageId}`);
                            console.log('é¡µé¢ä¿¡æ¯è·å–æˆåŠŸ:', pageInfo);

                            // åˆ é™¤é¡µé¢ï¼ˆå½’æ¡£ï¼‰
                            await sendNotionRequest("PATCH", `https://api.notion.com/v1/pages/${existingPageId}`, {
                                archived: true
                            });
                            console.log('æˆåŠŸåˆ é™¤ç°æœ‰é¡µé¢');

                            // ç­‰å¾…åˆ é™¤å®Œæˆ
                            await new Promise(resolve => setTimeout(resolve, 2000));

                            const evalRes = evaluateAutoTagRouting(sourceURL, comicData.æ ‡é¢˜ || comicData.ä¹¦å || document.title || '', getPageTextSnippet(), siteConfig);
                            if (evalRes.tags && evalRes.tags.length) {
                                const prop = evalRes.tagProperty || 'ç±»å‹';
                                const existingRaw = comicData[prop];
                                const existing = Array.isArray(existingRaw) ? existingRaw : (existingRaw ? [existingRaw] : []);
                                const names = new Set(existing.map(v => typeof v === 'object' ? v.name : String(v)));
                                for (const name of evalRes.tags) {
                                    if (!names.has(name)) {
                                        if (!Array.isArray(comicData[prop])) comicData[prop] = [];
                                        comicData[prop].push({ name, color: "pink" });
                                    }
                                }
                            }
                            // åˆ›å»ºæ–°é¡µé¢ï¼šå¦‚æœåŒ¹é…äº†åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™ï¼Œä½¿ç”¨æ˜ å°„æ•°æ®åº“ï¼›å¦åˆ™ä½¿ç”¨æ™®é€šè§„åˆ™çš„routeType
                            const finalRouteType = (comicData['_useMappingDatabase'] && comicData['_autoRouteType'])
                            ? comicData['_autoRouteType']
                            : (evalRes.routeType || 'clip');
                            result = await createNotionPage(comicData, sourceURL, finalRouteType);
                            showResult(result);
                            try {
                                isPageExistsInNotion = true;
                                if (result && result.id) existingPageIdCache = result.id;
                                hasExistingTag = false;
                                updateTagDotStatus();
                            } catch (_) {}
                        } catch (deleteError) {
                            console.error('åˆ é™¤ç°æœ‰é¡µé¢å¤±è´¥:', deleteError);

                            // æ£€æŸ¥æ˜¯å¦æ˜¯æƒé™é—®é¢˜
                            if (deleteError.message && deleteError.message.includes('permission')) {
                                showNotification('åˆ é™¤é¡µé¢å¤±è´¥ï¼šæƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥Notion APIæƒé™è®¾ç½®', 'error');
                            } else if (deleteError.message && deleteError.message.includes('not_found')) {
                                showNotification('é¡µé¢ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ›å»ºæ–°é¡µé¢', 'info');
                                // é¡µé¢ä¸å­˜åœ¨ï¼Œç›´æ¥åˆ›å»ºæ–°é¡µé¢
                                const evalRes2 = evaluateAutoTagRouting(sourceURL, comicData.æ ‡é¢˜ || comicData.ä¹¦å || document.title || '', getPageTextSnippet(), siteConfig);
                                if (evalRes2.tags && evalRes2.tags.length) {
                                    const prop2 = evalRes2.tagProperty || 'ç±»å‹';
                                    const existingRaw2 = comicData[prop2];
                                    const existing2 = Array.isArray(existingRaw2) ? existingRaw2 : (existingRaw2 ? [existingRaw2] : []);
                                    const names2 = new Set(existing2.map(v => typeof v === 'object' ? v.name : String(v)));
                                    for (const name of evalRes2.tags) {
                                        if (!names2.has(name)) {
                                            if (!Array.isArray(comicData[prop2])) comicData[prop2] = [];
                                            comicData[prop2].push({ name, color: "pink" });
                                        }
                                    }
                                }
                                // å¦‚æœåŒ¹é…äº†åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™ï¼Œä½¿ç”¨æ˜ å°„æ•°æ®åº“ï¼›å¦åˆ™ä½¿ç”¨æ™®é€šè§„åˆ™çš„routeType
                                const finalRouteType2 = (comicData['_useMappingDatabase'] && comicData['_autoRouteType'])
                                ? comicData['_autoRouteType']
                                : (evalRes2.routeType || 'clip');
                                result = await createNotionPage(comicData, sourceURL, finalRouteType2);
                                showResult(result);
                                try {
                                    isPageExistsInNotion = true;
                                    if (result && result.id) existingPageIdCache = result.id;
                                    hasExistingTag = false;
                                    updateTagDotStatus();
                                } catch (_) {}
                            } else {
                                showNotification('åˆ é™¤ç°æœ‰é¡µé¢å¤±è´¥ï¼Œå°è¯•æ›´æ–°ç°æœ‰é¡µé¢', 'warning');
                                // å¦‚æœåˆ é™¤å¤±è´¥ï¼Œå›é€€åˆ°æ›´æ–°æ¨¡å¼
                                result = await processUpdate(existingPageId, comicData, sourceURL, 'clip', false);
                                try {
                                    isPageExistsInNotion = true;
                                    if (result && result.id) existingPageIdCache = result.id;
                                    hasExistingTag = false;
                                    updateTagDotStatus();
                                } catch (_) {}
                            }
                        }
                    } else {
                        showNotification('æ“ä½œå·²å–æ¶ˆ', 'info');
                        return;
                    }
                } else {
                    // æ–°é¡µé¢ï¼šæ ¹æ®ç±»å‹é€‰æ‹©å™¨å¼€å…³å†³å®šæ˜¯å¦å¼¹å‡ºç±»å‹é€‰æ‹©çª—å£
                    if (siteConfig.enableTypeSelector && comicData['ç±»å‹'] !== null && (!comicData['ç±»å‹'] || (Array.isArray(comicData['ç±»å‹']) && comicData['ç±»å‹'].length === 0))) {
                        try {
                            const selectedType = await showTypeSelectionDialog();
                            if (selectedType && selectedType.length) {
                                comicData['ç±»å‹'] = selectedType;
                                // æ£€æŸ¥æ˜¯å¦æœ‰åªå¡«å†™äº†æ‰“æ ‡ç­¾çš„è§„åˆ™åŒ¹é…
                                const tagOnlyRule = checkTagOnlyRule(selectedType, 'ç±»å‹');
                                if (tagOnlyRule) {
                                    // å°†åŒ¹é…çš„routeTypeå­˜å‚¨åˆ°comicDataä¸­ï¼Œä¾›åç»­å¯¼å…¥ä½¿ç”¨
                                    comicData['_autoRouteType'] = tagOnlyRule.routeType;
                                    console.log('æ£€æµ‹åˆ°åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™åŒ¹é…ï¼Œå°†ä½¿ç”¨routeType:', tagOnlyRule.routeType);
                                }
                            } else if (selectedType === null) {
                                // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œè®¾ç½®ç‰¹æ®Šæ ‡è®°é¿å…é‡å¤å¼¹å‡º
                                console.log('ç”¨æˆ·å–æ¶ˆäº†ç±»å‹é€‰æ‹©');
                                comicData['ç±»å‹'] = null; // ä½¿ç”¨nullæ ‡è®°ç”¨æˆ·å·²å–æ¶ˆ
                            } else {
                                // å…¶ä»–æƒ…å†µï¼Œè®¾ç½®é»˜è®¤ç±»å‹
                                comicData['ç±»å‹'] = ['å…¶ä»–'];
                            }
                        } catch (e) {
                            console.warn('ç±»å‹é€‰æ‹©å¤±è´¥æˆ–å·²è·³è¿‡', e);
                            comicData['ç±»å‹'] = ['å…¶ä»–'];
                        }
                    }

                    const evalRes3 = evaluateAutoTagRouting(sourceURL, comicData.æ ‡é¢˜ || comicData.ä¹¦å || document.title || '', getPageTextSnippet(), siteConfig);
                    if (evalRes3.tags && evalRes3.tags.length) {
                        const prop3 = evalRes3.tagProperty || 'ç±»å‹';
                        const existingRaw3 = comicData[prop3];
                        const existing3 = Array.isArray(existingRaw3) ? existingRaw3 : (existingRaw3 ? [existingRaw3] : []);
                        const names3 = new Set(existing3.map(v => typeof v === 'object' ? v.name : String(v)));
                        for (const name of evalRes3.tags) {
                            if (!names3.has(name)) {
                                if (!Array.isArray(comicData[prop3])) comicData[prop3] = [];
                                comicData[prop3].push({ name, color: "pink" });
                            }
                        }
                    }
                    // åˆ›å»ºæ–°é¡µé¢ï¼šå¦‚æœåŒ¹é…äº†åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™ï¼Œä½¿ç”¨æ˜ å°„æ•°æ®åº“ï¼›å¦åˆ™ä½¿ç”¨æ™®é€šè§„åˆ™çš„routeType
                    const finalRouteType = (comicData['_useMappingDatabase'] && comicData['_autoRouteType'])
                    ? comicData['_autoRouteType']
                    : (evalRes3.routeType || 'clip');
                    result = await createNotionPage(comicData, sourceURL, finalRouteType);
                    if (window._additionalSelectors && window._additionalSelectors.length > 0 && result && result.success) {
                        try { await processAdditionalSelectors(window._additionalSelectors, result.id, window._siteConfig); } catch(_) {}
                        delete window._additionalSelectors;
                        delete window._siteConfig;
                    }
                    showResult(result);
                    try {
                        isPageExistsInNotion = true;
                        if (result && result.id) existingPageIdCache = result.id;
                        hasExistingTag = false;
                        updateTagDotStatus();
                    } catch (_) {}

                    // å¤„ç†é¢å¤–çš„å†…å®¹é€‰æ‹©å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    if (window._additionalSelectors && window._additionalSelectors.length > 0 && result.success) {
                        console.log('å¼€å§‹å¤„ç†é¢å¤–çš„å†…å®¹é€‰æ‹©å™¨:', window._additionalSelectors);
                        await processAdditionalSelectors(window._additionalSelectors, result.id, window._siteConfig);
                        // æ¸…ç†å…¨å±€å˜é‡
                        delete window._additionalSelectors;
                        delete window._siteConfig;
                    }
                }

                return;
            }

            // åœ¨æå–æ•°æ®å‰å…ˆç‚¹å‡»å±•å¼€æŒ‰é’®ï¼Œä½¿ç”¨æ›´æ™ºèƒ½çš„æ–¹å¼å¤„ç†
            if (siteConfig.contentType !== 'clip') {
                const expandSelectorsToTry = getConfiguredExpandSelectors(siteConfig);
                // æœªé…ç½®æ—¶ä¸è¿›è¡Œå±•å¼€
                if (expandSelectorsToTry.length) {
                    const clickedElements = new Set();
                    let clickCount = 0;
                    let delayMs = 150;
                    try {
                        const globalDelay = parseInt(GM_getValue('expand_click_interval_ms', 150), 10);
                        delayMs = (!isNaN(globalDelay) && globalDelay >= 0) ? globalDelay : 150;
                    } catch(_) { delayMs = 150; }
                    if (typeof siteConfig.expandClickIntervalMs === 'number' && siteConfig.expandClickIntervalMs >= 0) {
                        delayMs = siteConfig.expandClickIntervalMs;
                    }

                    for (const selector of expandSelectorsToTry) {
                        try {
                            const candidates = Array.from(document.querySelectorAll(selector));
                            for (const expandButton of candidates) {
                                if (clickedElements.has(expandButton)) continue;
                                if (expandButton.classList && (expandButton.classList.contains('hide') || expandButton.classList.contains('expanded'))) continue;
                                if (expandButton.disabled) continue;
                                if (clickCount > 0 && delayMs > 0) {
                                    await new Promise(resolve => setTimeout(resolve, delayMs));
                                }
                                const expandBtnText = (expandButton.textContent || '').trim();
                                expandButton.click();
                                clickedElements.add(expandButton);
                                clickCount++;

                                if (clickCount === 1 && expandBtnText && !siteConfig.selectors['ç®€ä»‹_filter']) {
                                    siteConfig.selectors['ç®€ä»‹_filter'] = escapeRegExp(expandBtnText);
                                    siteConfig.selectors['ç®€ä»‹_filter_mode'] = 'remove';
                                    if (!siteConfig.isDefaultConfig) {
                                        try {
                                            const host = window.location.hostname;
                                            const customConfigs = loadCustomConfigs();
                                            customConfigs[host] = siteConfig;
                                            saveCustomConfig(host, siteConfig);
                                        } catch (_) {}
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('å±•å¼€æŒ‰é’®ç‚¹å‡»å¤±è´¥:', selector, error);
                        }
                    }

                    if (clickCount > 0) {
                        try { window.__expand_handled_pre = true; } catch(_) {}
                        showNotification(`å·²è‡ªåŠ¨å±•å¼€è¯¦ç»†ä¿¡æ¯ï¼ˆ${clickCount}ï¼‰`, 'success');
                    }
                }
            }

            // å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç°æœ‰é¡µé¢ï¼Œå†³å®šä½¿ç”¨æ·»åŠ æ¨¡å¼è¿˜æ˜¯æ›´æ–°æ¨¡å¼
            const sourceURL = window.location.href;
            const existingPageId = await checkExistingPage(sourceURL, siteConfig.contentType);
            const isUpdateMode = siteConfig.contentType === 'clip' ? false : !!existingPageId;

            if (isUpdateMode) {
                try {
                    const existingPageData = await getNotionPageProperties(existingPageId);
                    window._existingNotionCoverUrl = existingPageData?.coverUrl || '';
                } catch (error) {
                    console.error('è·å–ç°æœ‰Notioné¡µé¢å°é¢å¤±è´¥:', error);
                    window._existingNotionCoverUrl = '';
                }
            } else {
                window._existingNotionCoverUrl = '';
            }

            console.log('é¡µé¢æ£€æŸ¥ç»“æœ:', { existingPageId, isUpdateMode });

            const comicData = await extractComicData(siteConfig, isUpdateMode); // æ ¹æ®æ˜¯å¦å­˜åœ¨ç°æœ‰é¡µé¢å†³å®šæ¨¡å¼
            if (siteConfig.domainIconUrl) {
                comicData._domainIconUrl = siteConfig.domainIconUrl;
            }

            const selectorsToUseNonClip = Array.isArray(siteConfig.contentSelectors) && siteConfig.contentSelectors.length > 0
            ? siteConfig.contentSelectors
            : (siteConfig.contentSelector ? [siteConfig.contentSelector] : []);
            if (selectorsToUseNonClip.length > 0) {
                try {
                    const firstSelector = selectorsToUseNonClip[0];
                    const additionalSelectors = selectorsToUseNonClip.slice(1);
                    let contentHtml = '';
                    const contentElements = document.querySelectorAll(firstSelector);
                    contentElements.forEach((el) => {
                        const clone = el.cloneNode(true);
                        const excludes = Array.isArray(siteConfig.clipExcludeSelectors) ? siteConfig.clipExcludeSelectors : [];
                        excludes.forEach(sel => { try { clone.querySelectorAll(sel).forEach(n => n.remove()); } catch (e) {} });
                        const elementHtml = clone.outerHTML.trim();
                        if (elementHtml) { contentHtml += elementHtml; }
                    });
                    if (contentHtml) {
                        const selectorSpecific = (markdownTransformCfg.selectorRules && firstSelector) ? markdownTransformCfg.selectorRules[firstSelector] : null;
                        const rulesForSel = Array.isArray(selectorSpecific) ? selectorSpecific : (markdownTransformCfg.rules || []);
                        const htmlForConversion = (markdownTransformEnabled && rulesForSel.length) ? applyHtmlTransformRules(contentHtml, rulesForSel) : contentHtml;
                        const contentData = convertHtmlToMarkdown(htmlForConversion);
                        if (markdownTransformEnabled && rulesForSel.length) {
                            try { comicData.content = applyMarkdownTransformRules(contentData, rulesForSel); } catch(_) { comicData.content = contentData; }
                            comicData._mdTransformApplied = true;
                        } else {
                            comicData.content = contentData;
                        }
                        if (additionalSelectors.length > 0) {
                            window._additionalSelectors = additionalSelectors;
                            window._siteConfig = siteConfig;
                        }
                    }
                } catch (e) {}
            }

            console.log('æå–çš„æ•°æ®:', comicData);

            // æ ¹æ®å†…å®¹ç±»å‹æ£€æŸ¥æ ‡é¢˜å­—æ®µ
            if (siteConfig.contentType === 'clip') {
                // å‰ªè—æ¨¡å¼æ£€æŸ¥æ ‡é¢˜å­—æ®µ
                if (!comicData.æ ‡é¢˜) {
                    // å°è¯•ä»é¡µé¢æ ‡é¢˜è·å–æ ‡é¢˜
                    const pageTitle = document.title.trim();
                    if (pageTitle) {
                        comicData.æ ‡é¢˜ = cleanTitle(pageTitle.split('|')[0].split('-')[0].trim());
                        console.log('ä»é¡µé¢æ ‡é¢˜è·å–æ ‡é¢˜:', comicData.æ ‡é¢˜);
                    }

                    // å¦‚æœä»ç„¶æ²¡æœ‰æ ‡é¢˜ï¼Œæ˜¾ç¤ºé€šçŸ¥å¹¶è¿”å›
                    if (!comicData.æ ‡é¢˜) {
                        showNotification('æœªè·å–åˆ°æ ‡é¢˜ï¼Œè¯·æ£€æŸ¥é…ç½®', 'error');
                        console.error('æ ‡é¢˜æœªè·å–åˆ°ï¼Œæå–çš„æ•°æ®:', comicData);
                        return;
                    }
                }
            } else {
                // æ¼«ç”»/å°è¯´æ¨¡å¼æ£€æŸ¥ä¹¦åå­—æ®µ
                if (!comicData.ä¹¦å) {
                    // å°è¯•ä»é¡µé¢æ ‡é¢˜è·å–ä¹¦å
                    const pageTitle = document.title.trim();
                    if (pageTitle) {
                        comicData.ä¹¦å = cleanTitle(pageTitle.split('|')[0].split('-')[0].trim());
                        console.log('ä»é¡µé¢æ ‡é¢˜è·å–ä¹¦å:', comicData.ä¹¦å);
                    }

                    // å¦‚æœä»ç„¶æ²¡æœ‰ä¹¦åï¼Œæ˜¾ç¤ºé€šçŸ¥å¹¶è¿”å›
                    if (!comicData.ä¹¦å) {
                        showNotification('æœªè·å–åˆ°ä¹¦åï¼Œè¯·æ£€æŸ¥é…ç½®', 'error');
                        console.error('ä¹¦åæœªè·å–åˆ°ï¼Œæå–çš„æ•°æ®:', comicData);
                        return;
                    }
                }
            }

            let result;
            if (existingPageId) {
                // æ›´æ–°æ¨¡å¼ï¼šä½¿ç”¨å·²æå–çš„æ•°æ®
                result = await processUpdate(existingPageId, comicData, sourceURL, siteConfig.contentType, false);
                if (window._additionalSelectors && window._additionalSelectors.length > 0 && result && result.id) {
                    try { await processAdditionalSelectors(window._additionalSelectors, result.id, window._siteConfig); } catch(_) {}
                    delete window._additionalSelectors;
                    delete window._siteConfig;
                }
            } else {
                // å¤‡æ³¨è¾“å…¥ï¼šä»…åœ¨"æ·»åŠ "æ—¶ã€ä¸”é…ç½®å¯ç”¨æ—¶æ‰å¼¹å‡ºï¼ˆæ¼«ç”»/å°è¯´ï¼‰
                if ((siteConfig.contentType === 'comic' || siteConfig.contentType === 'novel') && (GM_getValue('global_enable_remark_on_add', false) || siteConfig.enableRemarkOnAdd)) {
                    try {
                        const remark = await new Promise((resolve) => {
                            const overlay = document.createElement('div');
                            overlay.style.cssText = `
                                position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 10000;
                                display:flex; align-items:center; justify-content:center;`;
                            const dialog = document.createElement('div');
                            dialog.style.cssText = `background:#fff; border-radius: 20px; width:90%; max-width:520px; padding:20px;`;
                            const title = document.createElement('h3');
                            title.textContent = 'å¡«å†™å¤‡æ³¨ï¼ˆè§‚åæ„Ÿï¼‰';
                            title.style.cssText = 'margin:0 0 10px 0; font-size:16px';
                            const textarea = document.createElement('textarea');
                            textarea.placeholder = 'å¯é€‰ï¼Œå†™ä¸‹ä½ çš„è§‚åæ„Ÿ...';
                            textarea.style.cssText = 'width:100%; min-height:120px; padding:10px; box-sizing:border-box; border:1px solid #e5e7eb; border-radius: 20px;';
                            const buttons = document.createElement('div');
                            buttons.style.cssText = 'display:flex; gap:8px; justify-content:center; margin-top:12px;';
                            const cancel = document.createElement('button');
                            cancel.textContent = 'è·³è¿‡';
                            cancel.style.cssText = 'padding:8px 14px; border:1px solid #d1d5db; background:#fff; border-radius: 20px; cursor:pointer;';
                            const ok = document.createElement('button');
                            ok.textContent = 'ç¡®å®š';
                            ok.style.cssText = 'padding:8px 14px; border:0; background:linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)) color:#fff; border-radius: 20px; cursor:pointer;';
                            cancel.onclick = () => { document.body.removeChild(overlay); resolve(''); };
                            ok.onclick = () => { const v = textarea.value.trim(); document.body.removeChild(overlay); resolve(v); };
                            buttons.appendChild(cancel); buttons.appendChild(ok);
                            dialog.appendChild(title); dialog.appendChild(textarea); dialog.appendChild(buttons);
                            overlay.appendChild(dialog);
                            overlay.addEventListener('click', (e) => { if (e.target === overlay) { document.body.removeChild(overlay); resolve(''); } });
                            document.body.appendChild(overlay);
                            textarea.focus();
                        });
                        if (remark) comicData.å¤‡æ³¨ = remark;
                    } catch (e) { console.warn('å¤‡æ³¨è¾“å…¥å¤±è´¥æˆ–å·²è·³è¿‡', e); }
                }

                // è¯„åˆ†è¾“å…¥ï¼šä»…åœ¨"æ·»åŠ "æ—¶ã€ä¸”è¯„åˆ†ç³»ç»Ÿå¯ç”¨æ—¶æ‰å¼¹å‡ºï¼ˆæ¼«ç”»/å°è¯´ï¼‰
                if (RATING_CONFIG.enabled && (siteConfig.contentType === 'comic' || siteConfig.contentType === 'novel')) {
                    try {
                        const rating = await new Promise((resolve) => {
                            const overlay = document.createElement('div');
                            overlay.style.cssText = `
                                position: fixed; inset: 0; background: rgba(0,0,0,.45); z-index: 10000;
                                display:flex; align-items:center; justify-content:center;`;
                            const dialog = document.createElement('div');
                            dialog.style.cssText = `background:#fff; border-radius: 20px; width:90%; max-width:400px; padding:20px;`;
                            dialog.className = 'notion-rating-dialog';
                            const title = document.createElement('h3');
                            title.textContent = 'ä¸ºä½œå“è¯„åˆ†';
                            title.style.cssText = 'margin:0 0 15px 0; font-size:16px; text-align:center;';

                            // åˆ›å»ºè¯„åˆ†ç»„ä»¶
                            const ratingComponent = createRatingComponent('import-rating', RATING_CONFIG.defaultRating, 'è¯„åˆ†');

                            const buttons = document.createElement('div');
                            buttons.style.cssText = 'display:flex; gap:8px; justify-content:center; margin-top:20px;';
                            const cancel = document.createElement('button');
                            cancel.textContent = 'è·³è¿‡';
                            cancel.style.cssText = 'padding:8px 14px; border:1px solid #d1d5db; background:#fff; border-radius: 20px; cursor:pointer;';
                            const ok = document.createElement('button');
                            ok.textContent = 'ç¡®å®š';
                            ok.style.cssText = 'padding:8px 14px; border:0; background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); color:#fff; border-radius: 20px; cursor:pointer;';

                            cancel.onclick = () => { document.body.removeChild(overlay); resolve(0); };
                            ok.onclick = () => {
                                const ratingInput = document.getElementById('import-rating');
                                const ratingValue = parseInt(ratingInput.value) || 0;
                                document.body.removeChild(overlay);
                                resolve(ratingValue);
                            };

                            buttons.appendChild(cancel);
                            buttons.appendChild(ok);
                            dialog.appendChild(title);
                            dialog.appendChild(ratingComponent);
                            dialog.appendChild(buttons);
                            overlay.appendChild(dialog);
                            overlay.addEventListener('click', (e) => { if (e.target === overlay) { document.body.removeChild(overlay); resolve(0); } });
                            document.body.appendChild(overlay);
                        });
                        if (rating > 0) comicData.è¯„åˆ† = rating;
                    } catch (e) { console.warn('è¯„åˆ†è¾“å…¥å¤±è´¥æˆ–å·²è·³è¿‡', e); }
                }

                {
                    const evalRes = evaluateAutoTagRouting(sourceURL, comicData.æ ‡é¢˜ || comicData.ä¹¦å || document.title || '', getPageTextSnippet(), siteConfig);
                    if (evalRes.tags && evalRes.tags.length) {
                        const prop = evalRes.tagProperty || 'ç±»å‹';
                        const existingRaw = comicData[prop];
                        const existing = Array.isArray(existingRaw) ? existingRaw : (existingRaw ? [existingRaw] : []);
                        const names = new Set(existing.map(v => typeof v === 'object' ? v.name : String(v)));
                        for (const name of evalRes.tags) {
                            if (!names.has(name)) {
                                if (!Array.isArray(comicData[prop])) comicData[prop] = [];
                                comicData[prop].push({ name, color: "pink" });
                            }
                        }
                    }
                    // å¦‚æœåŒ¹é…äº†åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™ï¼Œä½¿ç”¨æ˜ å°„æ•°æ®åº“ï¼›å¦åˆ™ä½¿ç”¨æ™®é€šè§„åˆ™çš„routeType
                    const finalRouteType = (comicData['_useMappingDatabase'] && comicData['_autoRouteType'])
                    ? comicData['_autoRouteType']
                    : (evalRes.routeType || siteConfig.contentType);
                    result = await createNotionPage(comicData, sourceURL, finalRouteType);
                }
            }

            showResult(result);
            try {
                isPageExistsInNotion = true;
                if (result && result.id) existingPageIdCache = result.id;
                hasExistingTag = false;
                updateTagDotStatus();
            } catch (_) {}
        } catch (error) {
            console.error('å¯¼å…¥å¤±è´¥:', error);
            showError(error.message);
        } finally {
            window._existingNotionCoverUrl = '';
        }
    }

    // å¯åŠ¨è„šæœ¬
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', main);
    } else {
        main();
    }


    // æ³¨å†Œèœå•å‘½ä»¤ - é…ç½®Notion (å·²ç§»åŠ¨åˆ°å…¶ä»–åŠŸèƒ½èœå•ä¸­)
    // GM_registerMenuCommand("æ‰¹é‡å¯¼å…¥åˆ°Notion", showBatchImportDialog); // éšè—ï¼Œå› ä¸ºé…ç½®ç•Œé¢æœ‰ç›¸åŒåŠŸèƒ½
    // GM_registerMenuCommand("é…ç½®Notion", showNotionConfigDialog); // å·²ç§»åŠ¨åˆ°å…¶ä»–åŠŸèƒ½èœå•

    // æ‰¹é‡å¯¼å…¥åŠŸèƒ½
    function showBatchImportDialog() {
        // ä¿å­˜æ ‡è®°çŠ¶æ€ï¼Œå¦‚æœæœªè®¾ç½®åˆ™é»˜è®¤ä¸ºfalseï¼ˆç›´æ¥è°ƒç”¨è€Œéä»é…ç½®ç•Œé¢ï¼‰
        const isFromConfig = window._fromConfigDialog || false;

        // ç§»é™¤å·²æœ‰çš„å¯¹è¯æ¡†
        document.getElementById('batch-import-dialog')?.remove();

        // åˆ›å»ºæ‰¹é‡å¯¼å…¥å¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.id = 'batch-import-dialog';
        // è®¾ç½®å¯¹è¯æ¡†æ ·å¼ï¼Œä½¿å…¶å±…ä¸­æ˜¾ç¤º
        dialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 600px;
                max-height: 90vh;
                background: white;
                border-radius: 20px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            `;

        // ç§»åŠ¨ç«¯é€‚é…æ ·å¼
        const mobileStyle = document.createElement('style');
        mobileStyle.textContent = `
                @media (max-width: 768px) {
                    #batch-import-dialog {
                        width: 95% !important;
                        max-width: 95% !important;
                        max-height: 85vh !important;
                        top: 50% !important;
                        left: 50% !important;
                        transform: translate(-50%, -50%) !important;
                        margin: 0 !important;
                        border-radius: 12px !important;
                    }
                    #batch-import-dialog-content {
                        padding: 16px !important;
                        overflow-y: auto !important;
                    }

                    #batch-import-dialog-actions button {
                        width: 100% !important;
                        margin: 0 !important;
                    }
                }
            `;
        document.head.appendChild(mobileStyle);

        const titleBar = document.createElement('div');
        titleBar.id = 'batch-import-dialog-header';
        titleBar.textContent = 'æ‰¹é‡å¯¼å…¥åˆ°Notion';
        titleBar.className = 'draggable';

        const closeButton = document.createElement('button');
        closeButton.id = 'batch-import-dialog-close';
        closeButton.textContent = 'Ã—';
        closeButton.addEventListener('click', () => {
            dialog.remove();
            // ä»…å½“æ ‡è®°å­˜åœ¨æ—¶è§¦å‘æ‰¹é‡å¯¼å…¥å¯¹è¯æ¡†å…³é—­äº‹ä»¶
            if (window._fromConfigDialog) {
                document.dispatchEvent(new CustomEvent('batch-import-dialog-closed'));
            }
        });

        titleBar.appendChild(closeButton);

        const content = document.createElement('div');
        content.id = 'batch-import-dialog-content';

        // è¯´æ˜æ–‡æœ¬
        const description = document.createElement('p');
        description.textContent = 'åœ¨ä¸‹æ–¹è¾“å…¥è¦æ‰¹é‡å¯¼å…¥çš„URLï¼Œæ¯è¡Œä¸€ä¸ªã€‚ç¨‹åºä¼šè‡ªåŠ¨è·å–æ¯ä¸ªURLçš„å†…å®¹å¹¶å¯¼å…¥åˆ°Notionã€‚';
        description.style.marginBottom = '16px';
        description.style.width = '100%';
        description.style.boxSizing = 'border-box';

        // URLè¾“å…¥æ¡†
        const urlsLabel = document.createElement('label');
        urlsLabel.textContent = 'URLåˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰:';
        urlsLabel.style.display = 'block';
        urlsLabel.style.marginBottom = '8px';
        urlsLabel.style.width = '100%';
        urlsLabel.style.boxSizing = 'border-box';

        const urlsTextarea = document.createElement('textarea');
        urlsTextarea.id = 'batch-import-urls';
        urlsTextarea.placeholder = 'https://example.com/book/123\nhttps://example.com/book/456';
        urlsTextarea.style.width = '100%';
        urlsTextarea.style.minHeight = '120px';
        urlsTextarea.style.marginBottom = '16px';
        urlsTextarea.style.padding = '12px';
        urlsTextarea.style.borderRadius = '20px';
        urlsTextarea.style.border = '1px solid var(--input-border)';
        urlsTextarea.style.boxSizing = 'border-box';
        urlsTextarea.className = 'multiline';

        // é—´éš”è®¾ç½®
        const intervalContainer = document.createElement('div');
        intervalContainer.style.marginBottom = '16px';
        intervalContainer.style.display = 'flex';
        intervalContainer.style.alignItems = 'center';
        intervalContainer.style.gap = '8px';
        intervalContainer.style.width = '100%';
        intervalContainer.style.boxSizing = 'border-box';

        const intervalLabel = document.createElement('label');
        intervalLabel.textContent = 'è¯·æ±‚é—´éš” (ç§’):';

        const intervalInput = document.createElement('input');
        intervalInput.type = 'number';
        intervalInput.id = 'batch-import-interval';
        intervalInput.min = '1';
        intervalInput.max = '60';
        intervalInput.value = '3';
        intervalInput.style.width = '60px';
        intervalInput.style.padding = '8px';
        intervalInput.style.textAlign = 'center';
        intervalInput.style.borderRadius = '20px';
        intervalInput.style.border = '1px solid var(--input-border)';

        intervalContainer.appendChild(intervalLabel);
        intervalContainer.appendChild(intervalInput);

        // å†…å®¹ç±»å‹é€‰æ‹©
        const typeContainer = document.createElement('div');
        typeContainer.style.marginBottom = '16px';
        typeContainer.style.width = '100%';
        typeContainer.style.boxSizing = 'border-box';

        const typeLabel = document.createElement('label');
        typeLabel.textContent = 'å†…å®¹ç±»å‹:';
        typeLabel.style.marginRight = '8px';

        const typeSelect = document.createElement('select');
        typeSelect.id = 'batch-import-type';
        typeSelect.style.padding = '8px';
        typeSelect.style.borderRadius = '20px';
        typeSelect.style.border = '1px solid var(--input-border)';
        typeSelect.style.boxSizing = 'border-box';

        const comicOption = document.createElement('option');
        comicOption.value = 'comic';
        comicOption.textContent = 'æ¼«ç”»';
        typeSelect.appendChild(comicOption);

        const novelOption = document.createElement('option');
        novelOption.value = 'novel';
        novelOption.textContent = 'å°è¯´';
        typeSelect.appendChild(novelOption);

        typeContainer.appendChild(typeLabel);
        typeContainer.appendChild(typeSelect);

        // çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
        const statusContainer = document.createElement('div');
        statusContainer.id = 'batch-import-status';
        statusContainer.style.marginTop = '16px';
        statusContainer.style.marginBottom = '16px';
        statusContainer.style.padding = '12px';
        statusContainer.style.borderRadius = '20px';
        statusContainer.style.border = '1px solid var(--input-border)';
        statusContainer.style.background = '#f5f5f5';
        statusContainer.style.maxHeight = '150px';
        statusContainer.style.overflowY = 'auto';
        statusContainer.style.display = 'none';
        statusContainer.style.width = '100%';
        statusContainer.style.boxSizing = 'border-box';

        // æŒ‰é’®åŒºåŸŸ
        const actions = document.createElement('div');
        actions.id = 'batch-import-dialog-actions';
        actions.style.width = '100%';
        actions.style.boxSizing = 'border-box';

        const startButton = document.createElement('button');
        startButton.className = 'dialog-btn dialog-btn-primarycolor';
        startButton.textContent = 'â–¶ å¼€å§‹å¯¼å…¥';
        startButton.style.display = 'flex';
        startButton.style.alignItems = 'center';
        startButton.style.justifyContent = 'center';

        startButton.addEventListener('click', async () => {
            const urls = urlsTextarea.value.trim().split('\n').filter(url => url.trim());

            if (urls.length === 0) {
                showNotification('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªURL', 'error');
                return;
            }

            const interval = parseInt(intervalInput.value) || 3;
            const contentType = typeSelect.value;

            // æ˜¾ç¤ºçŠ¶æ€åŒºåŸŸ
            statusContainer.style.display = 'block';
            statusContainer.textContent = 'å‡†å¤‡å¼€å§‹æ‰¹é‡å¯¼å…¥...';

            // ç¦ç”¨å¼€å§‹æŒ‰é’®
            startButton.disabled = true;
            startButton.textContent = 'å¯¼å…¥ä¸­...';

            // å¼€å§‹æ‰¹é‡å¯¼å…¥
            await batchImport(urls, interval, contentType, statusContainer);

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            startButton.disabled = false;
            startButton.textContent = 'â–¶ å¼€å§‹å¯¼å…¥';

            // å¯¼å…¥å®Œæˆåï¼Œå¦‚æœæ˜¯ä»é…ç½®ç•Œé¢æ‰“å¼€çš„ï¼Œè‡ªåŠ¨å…³é—­å¹¶è¿”å›
            if (window._fromConfigDialog) {
                setTimeout(() => {
                    dialog.remove();
                    document.dispatchEvent(new CustomEvent('batch-import-dialog-closed'));
                }, 1500); // å»¶è¿Ÿ1.5ç§’åå…³é—­ï¼Œè®©ç”¨æˆ·æœ‰æ—¶é—´çœ‹åˆ°å®Œæˆæ¶ˆæ¯
            }
        });

        // æ‰¹é‡ä¿®æ”¹å°é¢æŒ‰é’®
        const coverButton = document.createElement('button');
        coverButton.className = 'dialog-btn dialog-btn-secondary';
        coverButton.textContent = 'æ‰¹é‡ä¿®æ”¹å°é¢';
        coverButton.style.display = 'flex';
        coverButton.style.alignItems = 'center';
        coverButton.style.justifyContent = 'center';

        // æ‰¹é‡ä¿®æ”¹å°é¢æŒ‰é’®äº‹ä»¶
        coverButton.addEventListener('click', async () => {
            const urls = urlsTextarea.value.trim().split('\n').filter(url => url.trim());

            if (urls.length === 0) {
                showNotification('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªURL', 'error');
                return;
            }

            // æ£€æŸ¥GitHubé…ç½®
            if (!validateGitHubConfig(GITHUB_CONFIG)) {
                console.error('GitHubé…ç½®æ£€æŸ¥å¤±è´¥:', {
                    token: GITHUB_CONFIG.token ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®',
                    username: GITHUB_CONFIG.username || 'æœªè®¾ç½®',
                    repo: GITHUB_CONFIG.repo || 'æœªè®¾ç½®',
                    branch: GITHUB_CONFIG.branch || 'æœªè®¾ç½®',
                    coverPath: GITHUB_CONFIG.coverPath || 'æœªè®¾ç½®'
                });
                showNotification('è¯·å…ˆé…ç½®GitHubå›¾åºŠ', 'error');
                return;
            }

            console.log('GitHubé…ç½®æ£€æŸ¥é€šè¿‡:', {
                username: GITHUB_CONFIG.username,
                repo: GITHUB_CONFIG.repo,
                branch: GITHUB_CONFIG.branch,
                coverPath: GITHUB_CONFIG.coverPath
            });

            // æ˜¾ç¤ºçŠ¶æ€åŒºåŸŸ
            statusContainer.style.display = 'block';
            statusContainer.textContent = 'å‡†å¤‡å¼€å§‹æ‰¹é‡ä¿®æ”¹å°é¢...';

            // ç¦ç”¨æŒ‰é’®
            coverButton.disabled = true;
            coverButton.textContent = 'ä¿®æ”¹ä¸­...';

            // å¼€å§‹æ‰¹é‡ä¿®æ”¹å°é¢
            await batchModifyCovers(urls, statusContainer);

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            coverButton.disabled = false;
            coverButton.textContent = 'æ‰¹é‡ä¿®æ”¹å°é¢';
        });

        const cancelButton = document.createElement('button');
        cancelButton.className = 'dialog-btn dialog-btn-secondary';
        cancelButton.textContent = 'â¨‰ å–æ¶ˆ';
        cancelButton.style.display = 'flex';
        cancelButton.style.alignItems = 'center';
        cancelButton.style.justifyContent = 'center';

        cancelButton.addEventListener('click', () => {
            dialog.remove();
            // ä»…å½“æ ‡è®°å­˜åœ¨æ—¶è§¦å‘æ‰¹é‡å¯¼å…¥å¯¹è¯æ¡†å…³é—­äº‹ä»¶
            if (window._fromConfigDialog) {
                document.dispatchEvent(new CustomEvent('batch-import-dialog-closed'));
            }
        });

        actions.appendChild(cancelButton);
        actions.appendChild(coverButton);
        actions.appendChild(startButton);

        // ç»„è£…å¯¹è¯æ¡†
        content.appendChild(description);
        content.appendChild(urlsLabel);
        content.appendChild(urlsTextarea);
        content.appendChild(intervalContainer);
        content.appendChild(typeContainer);
        content.appendChild(statusContainer);

        dialog.appendChild(titleBar);
        dialog.appendChild(content);
        dialog.appendChild(actions);

        document.body.appendChild(dialog);

        // æ·»åŠ CSSåŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.5; transform: scale(1.1); }
                100% { opacity: 1; transform: scale(1); }
            }
            .batch-cover-processing {
                animation: pulse 1.5s infinite;
            }
        `;
        document.head.appendChild(style);

        // ä½¿å¯¹è¯æ¡†å¯æ‹–åŠ¨
        makeDialogDraggable(dialog, titleBar);


    }

    // è·å–é¡µé¢HTMLæ–‡æ¡£
    async function fetchPageHtml(url) {
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                method: 'GET',
                url: url,
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                },
                onload: function(response) {
                    if (response.status === 200) {
                        const parser = new DOMParser();
                        const htmlDoc = parser.parseFromString(response.responseText, "text/html");
                        resolve(htmlDoc);
                    } else {
                        reject(new Error(`HTTP ${response.status}: ${response.statusText}`));
                    }
                },
                onerror: function(error) {
                    reject(new Error(`ç½‘ç»œé”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`));
                }
            });
        });
    }

    // æ‰¹é‡ä¿®æ”¹å°é¢æ‰§è¡Œå‡½æ•°
    async function batchModifyCovers(urls, statusContainer) {
        const results = [];
        let successCount = 0;
        let skipCount = 0;
        let errorCount = 0;

        for (let i = 0; i < urls.length; i++) {
            const url = urls[i].trim();
            if (!url) continue;

            // æ·»åŠ çŠ¶æ€æ˜¾ç¤º
            const urlStatus = document.createElement('div');
            urlStatus.className = 'batch-import-url-status pending';
            urlStatus.style.cssText = `
                margin: 16px 0;
                padding: 20px 24px;
                border-radius: 20px;
                background: linear-gradient(135deg, var(--panel-bg), rgba(255, 255, 255, 0.9));
                border: 1px solid var(--primarycolor);
                color: var(--text-color);
                font-size: 14px;
                line-height: 1.5;
                word-break: break-all;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px var(--primarycolor-lighter);
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                backdrop-filter: blur(10px);
                font-weight: 500;
            `;
            urlStatus.textContent = `[${i+1}/${urls.length}] å¤„ç†ä¸­: ${url}`;
            statusContainer.appendChild(urlStatus);
            statusContainer.scrollTop = statusContainer.scrollHeight;

            try {
                // è·å–é¡µé¢HTMLæ–‡æ¡£
                const htmlDoc = await fetchPageHtml(url);
                if (!htmlDoc) {
                    urlStatus.className = 'batch-import-url-status error';
                    urlStatus.style.cssText = `
                        margin: 8px 0;
                        padding: 12px 16px;
                        border-radius: 20px;
                        background: linear-gradient(135deg, var(--panel-bg), rgba(255, 255, 255, 0.8));
                        border: 1px solid #ef4444;
                        color: #dc2626;
                        font-size: 14px;
                        line-height: 1.5;
                        word-break: break-all;
                        box-shadow: 0 8px 32px rgba(239, 68, 68, 0.15), 0 0 0 1px rgba(239, 68, 68, 0.2);
                        position: relative;
                        overflow: hidden;
                        backdrop-filter: blur(10px);
                        font-weight: 500;
                    `;
                    urlStatus.textContent = `[${i+1}/${urls.length}] é”™è¯¯: ${url} - æ— æ³•è·å–é¡µé¢`;
                    errorCount++;
                    continue;
                }

                // è·å–ç«™ç‚¹é…ç½®
                const pageUrl = new URL(url);
                const hostname = pageUrl.hostname;
                const customConfigs = loadCustomConfigs();
                let siteConfig = null;

                // ä»å·²ä¿å­˜çš„é…ç½®ä¸­æŸ¥æ‰¾
                for (const host in customConfigs) {
                    if (hostname.includes(host)) {
                        siteConfig = customConfigs[host];
                        break;
                    }
                }

                // å¦‚æœæ˜¯manwa.meï¼Œä½¿ç”¨é»˜è®¤é…ç½®
                if (!siteConfig && hostname.includes('manwa.me')) {
                    siteConfig = DEFAULT_SITE_CONFIGS['manwa.me'];
                }

                if (!siteConfig) {
                    urlStatus.className = 'batch-import-url-status error';
                    urlStatus.style.cssText = `
                        margin: 8px 0;
                        padding: 12px 16px;
                        border-radius: 20px;
                        background: linear-gradient(135deg, var(--panel-bg), rgba(255, 255, 255, 0.8));
                        border: 1px solid #ef4444;
                        color: #dc2626;
                        font-size: 14px;
                        line-height: 1.5;
                        word-break: break-all;
                        box-shadow: 0 8px 32px rgba(239, 68, 68, 0.15), 0 0 0 1px rgba(239, 68, 68, 0.2);
                        position: relative;
                        overflow: hidden;
                        backdrop-filter: blur(10px);
                        font-weight: 500;
                    `;
                    urlStatus.textContent = `[${i+1}/${urls.length}] é”™è¯¯: ${url} - æ— ç«™ç‚¹é…ç½®`;
                    errorCount++;
                    continue;
                }

                // è·å–é¡µé¢æ•°æ®
                console.log('å¼€å§‹æå–é¡µé¢æ•°æ®:', url);
                console.log('ç«™ç‚¹é…ç½®:', siteConfig);

                const pageData = await extractDataFromHtml(htmlDoc, siteConfig, url, false);
                console.log('æå–åˆ°çš„é¡µé¢æ•°æ®:', pageData);

                // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥å°é¢æ•°æ®
                if (pageData && pageData.å°é¢) {
                    console.log('æ‰¾åˆ°å°é¢:', pageData.å°é¢);
                } else {
                    console.log('æœªæ‰¾åˆ°å°é¢æ•°æ®');
                }

                if (!pageData || !pageData.å°é¢) {
                    urlStatus.className = 'batch-import-url-status error';
                    urlStatus.style.cssText = `
                        margin: 8px 0;
                        padding: 12px 16px;
                        border-radius: 20px;
                        background: linear-gradient(135deg, var(--panel-bg), rgba(255, 255, 255, 0.9));
                        border: 1px solid var(--primarycolor);
                        color: var(--text-color);
                        font-size: 14px;
                        line-height: 1.5;
                        word-break: break-all;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px var(--primarycolor-lighter);
                        position: relative;
                        overflow: hidden;
                        backdrop-filter: blur(10px);
                        font-weight: 500;
                    `;
                    urlStatus.textContent = `[${i+1}/${urls.length}] è·³è¿‡: ${url} - æ— å°é¢å›¾ç‰‡`;
                    skipCount++;
                    continue;
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯GitHubå›¾åºŠé“¾æ¥
                if (isGitHubImageUrl(pageData.å°é¢)) {
                    urlStatus.className = 'batch-import-url-status success';
                    urlStatus.style.cssText = `
                        margin: 8px 0;
                        padding: 12px 16px;
                        border-radius: 20px;
                        background: linear-gradient(135deg, var(--panel-bg), rgba(255, 255, 255, 0.8));
                        border: 1px solid var(--primarycolor);
                        color: var(--text-color);
                        font-size: 14px;
                        line-height: 1.5;
                        word-break: break-all;
                        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px var(--primarycolor-lighter);
                        position: relative;
                        overflow: hidden;
                        backdrop-filter: blur(10px);
                        font-weight: 500;
                    `;
                    urlStatus.textContent = `[${i+1}/${urls.length}] è·³è¿‡: ${url} - å·²æ˜¯GitHubå›¾åºŠ`;
                    skipCount++;
                    continue;
                }

                // è®¾ç½®æ‰¹é‡å¯¼å…¥æ•°æ®ï¼Œä¾›generateSmartFileNameä½¿ç”¨
                window._currentBatchImportData = pageData;

                // ä¸Šä¼ å°é¢åˆ°GitHubå›¾åºŠ
                const uploadResult = await uploadToGitHub(pageData.å°é¢, true, 'cover', contentType);

                if (uploadResult.success) {
                    // æ›´æ–°Notionä¸­çš„å°é¢
                    const updateResult = await updateNotionCover(url, uploadResult.url);

                    if (updateResult.success) {
                        urlStatus.className = 'batch-import-url-status success';
                        urlStatus.style.cssText = `
                            margin: 8px 0;
                            padding: 12px 16px;
                            border-radius: 20px;
                            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
                            border-left: 4px solid #4caf50;
                            color: #388e3c;
                            font-size: 13px;
                            line-height: 1.4;
                            word-break: break-all;
                            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
                        `;
                        urlStatus.textContent = `[${i+1}/${urls.length}] æˆåŠŸ: ${url} - å°é¢å·²æ›´æ–°`;
                        successCount++;
                    } else {
                        urlStatus.className = 'batch-import-url-status error';
                        urlStatus.style.cssText = `
                            margin: 8px 0;
                            padding: 12px 16px;
                            border-radius: 20px;
                            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
                            border-left: 4px solid #f44336;
                            color: #d32f2f;
                            font-size: 13px;
                            line-height: 1.4;
                            word-break: break-all;
                            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.1);
                        `;
                        urlStatus.textContent = `[${i+1}/${urls.length}] å¤±è´¥: ${url} - æ›´æ–°Notionå¤±è´¥`;
                        errorCount++;
                    }
                } else {
                    console.error('å°é¢ä¸Šä¼ å¤±è´¥:', uploadResult.error);
                    urlStatus.className = 'batch-import-url-status error';
                    urlStatus.style.cssText = `
                        margin: 8px 0;
                        padding: 12px 16px;
                        border-radius: 20px;
                        background: linear-gradient(135deg, var(--panel-bg), rgba(255, 255, 255, 0.8));
                        border: 1px solid #ef4444;
                        color: #dc2626;
                        font-size: 14px;
                        line-height: 1.5;
                        word-break: break-all;
                        box-shadow: 0 8px 32px rgba(239, 68, 68, 0.15), 0 0 0 1px rgba(239, 68, 68, 0.2);
                        position: relative;
                        overflow: hidden;
                        backdrop-filter: blur(10px);
                        font-weight: 500;
                    `;
                    urlStatus.textContent = `[${i+1}/${urls.length}] å¤±è´¥: ${url} - ä¸Šä¼ å¤±è´¥: ${uploadResult.error || 'æœªçŸ¥é”™è¯¯'}`;
                    errorCount++;
                }

            } catch (error) {
                console.error(`å¤„ç†URLå¤±è´¥: ${url}`, error);
                urlStatus.className = 'batch-import-url-status error';
                urlStatus.style.cssText = `
                    margin: 8px 0;
                    padding: 12px 16px;
                    border-radius: 20px;
                    background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
                    border-left: 4px solid #f44336;
                    color: #d32f2f;
                    font-size: 13px;
                    line-height: 1.4;
                    word-break: break-all;
                    box-shadow: 0 2px 8px rgba(244, 67, 54, 0.1);
                `;
                urlStatus.textContent = `[${i+1}/${urls.length}] é”™è¯¯: ${url} - ${error.message}`;
                errorCount++;
            }

            // æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
            if (i < urls.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }

        // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        const summary = document.createElement('div');
        summary.style.cssText = `
            margin-top: 20px;
            padding: 16px 20px;
            border-radius: 20px;
            background: ${successCount > 0 ? 'linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%)' : 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)'};
            border: ${successCount > 0 ? '1px solid #4caf50' : '1px solid #ff9800'};
            box-shadow: 0 4px 12px ${successCount > 0 ? 'rgba(76, 175, 80, 0.2)' : 'rgba(255, 152, 0, 0.2)'};
            text-align: center;
        `;
        summary.textContent = `æ‰¹é‡ä¿®æ”¹å°é¢å®Œæˆ: æˆåŠŸ ${successCount} Â· è·³è¿‡ ${skipCount} Â· å¤±è´¥ ${errorCount}`;
        statusContainer.appendChild(summary);

        showNotification(`æ‰¹é‡ä¿®æ”¹å°é¢å®Œæˆï¼š${successCount} æˆåŠŸï¼Œ${skipCount} è·³è¿‡ï¼Œ${errorCount} å¤±è´¥`,
                         successCount > 0 ? 'success' : 'info');

        // æ¸…ç†æ‰¹é‡å¯¼å…¥æ•°æ®
        window._currentBatchImportData = null;

        return results;
    }

    // æ›´æ–°Notionä¸­çš„å°é¢
    async function updateNotionCover(originalUrl, newCoverUrl) {
        try {
            console.log(`æ›´æ–°Notionå°é¢: ${originalUrl} -> ${newCoverUrl}`);

            // æ£€æŸ¥Notioné…ç½®
            if (!NOTION_CONFIG.apiKey) {
                throw new Error('Notion APIå¯†é’¥æœªé…ç½®');
            }

            // æ ¹æ®URLæŸ¥æ‰¾å¯¹åº”çš„Notioné¡µé¢
            const pageId = await findNotionPageByUrl(originalUrl);
            if (!pageId) {
                throw new Error('æœªæ‰¾åˆ°å¯¹åº”çš„Notioné¡µé¢');
            }

            // æ›´æ–°é¡µé¢å°é¢
            const updateData = {
                cover: {
                    type: "external",
                    external: {
                        url: newCoverUrl
                    }
                }
            };

            await sendNotionRequest("PATCH", `https://api.notion.com/v1/pages/${pageId}`, updateData);

            console.log('Notionå°é¢æ›´æ–°æˆåŠŸ');
            return {
                success: true,
                message: 'å°é¢æ›´æ–°æˆåŠŸ'
            };
        } catch (error) {
            console.error('æ›´æ–°Notionå°é¢å¤±è´¥:', error);
            return {
                success: false,
                message: error.message
            };
        }
    }

    // æ ¹æ®URLæŸ¥æ‰¾Notioné¡µé¢ID
    async function findNotionPageByUrl(url) {
        try {
            // è·å–æ‰€æœ‰æ•°æ®åº“
            const databases = Object.values(NOTION_CONFIG.databaseIds).filter(id => id);

            for (const databaseId of databases) {
                try {
                    // æŸ¥è¯¢æ•°æ®åº“ä¸­çš„é¡µé¢
                    const response = await sendNotionRequest("POST", `https://api.notion.com/v1/databases/${databaseId}/query`, {
                        filter: {
                            property: "é“¾æ¥",
                            url: {
                                equals: url
                            }
                        }
                    });

                    if (response.results && response.results.length > 0) {
                        return response.results[0].id;
                    }
                } catch (error) {
                    console.warn(`æŸ¥è¯¢æ•°æ®åº“ ${databaseId} å¤±è´¥:`, error);
                    continue;
                }
            }

            return null;
        } catch (error) {
            console.error('æŸ¥æ‰¾Notioné¡µé¢å¤±è´¥:', error);
            return null;
        }
    }

    // æ‰¹é‡å¯¼å…¥æ‰§è¡Œå‡½æ•°
    async function batchImport(urls, interval, contentType, statusContainer) {
        const results = [];

        for (let i = 0; i < urls.length; i++) {
            const url = urls[i].trim();
            if (!url) continue;

            // æ·»åŠ çŠ¶æ€æ˜¾ç¤º
            const urlStatus = document.createElement('div');
            urlStatus.className = 'batch-import-url-status pending';
            urlStatus.textContent = `[${i+1}/${urls.length}] å¤„ç†ä¸­: ${url}`;
            statusContainer.appendChild(urlStatus);
            statusContainer.scrollTop = statusContainer.scrollHeight;

            try {
                // åˆ›å»ºiframeåŠ è½½é¡µé¢
                const result = await loadPageAndExtractData(url, contentType, urlStatus);
                results.push(result);

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                urlStatus.className = 'batch-import-url-status success';
                urlStatus.textContent = `[${i+1}/${urls.length}] æˆåŠŸ: ${url} - "${result.title}"`;
            } catch (error) {
                console.error(`å¯¼å…¥å¤±è´¥ ${url}:`, error);

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                urlStatus.className = 'batch-import-url-status error';
                urlStatus.textContent = `[${i+1}/${urls.length}] å¤±è´¥: ${url} - ${error.message}`;

                results.push({ url, error: error.message });
            }

            // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªURLï¼Œç­‰å¾…æŒ‡å®šçš„é—´éš”
            if (i < urls.length - 1) {
                await new Promise(resolve => setTimeout(resolve, interval * 1000));
            }
        }

        // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        const successCount = results.filter(r => !r.error).length;
        showNotification(`æ‰¹é‡å¯¼å…¥å®Œæˆï¼š${successCount}/${urls.length} æˆåŠŸ`, successCount === urls.length ? 'success' : 'info');

        // æ¸…ç†æ‰¹é‡å¯¼å…¥æ•°æ®
        window._currentBatchImportData = null;

        return results;
    }

    // é€šè¿‡iframeåŠ è½½é¡µé¢å¹¶æå–æ•°æ®
    function loadPageAndExtractData(url, contentType, statusElement) {
        return new Promise((resolve, reject) => {
            // ä½¿ç”¨GM_xmlhttpRequestè·å–é¡µé¢å†…å®¹
            GM_xmlhttpRequest({
                method: "GET",
                url: url,
                onload: async function(response) {
                    if (response.status >= 200 && response.status < 300) {
                        try {
                            // åˆ›å»ºä¸´æ—¶è§£æå™¨
                            const parser = new DOMParser();
                            const htmlDoc = parser.parseFromString(response.responseText, "text/html");

                            // å°è¯•ä»é¡µé¢çš„hostnameæ¨æ–­ç«™ç‚¹é…ç½®
                            const pageUrl = new URL(url);
                            const hostname = pageUrl.hostname;

                            // è·å–siteConfig
                            let siteConfig = null;

                            // å…ˆä»å·²ä¿å­˜çš„é…ç½®ä¸­æŸ¥æ‰¾
                            const customConfigs = loadCustomConfigs();
                            for (const host in customConfigs) {
                                if (hostname.includes(host)) {
                                    siteConfig = customConfigs[host];
                                    break;
                                }
                            }

                            // å¦‚æœæ˜¯manwa.meï¼Œä½¿ç”¨é»˜è®¤é…ç½®
                            if (!siteConfig && hostname.includes('manwa.me')) {
                                siteConfig = JSON.parse(JSON.stringify(DEFAULT_SITE_CONFIGS['manwa.me']));
                                adjustManwaSelectors(siteConfig);
                            }

                            if (!siteConfig) {
                                throw new Error(`æœªæ‰¾åˆ°ç½‘ç«™ ${hostname} çš„é…ç½®`);
                            }

                            // ä»htmlDocä¸­æå–æ•°æ®
                            statusElement.innerHTML += '<br>æ­£åœ¨æå–æ•°æ®...';

                            const data = await extractDataFromHtml(htmlDoc, siteConfig, url, false); // æ·»åŠ æ¨¡å¼

                            // ä¿å­˜æå–çš„æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›generateSmartFileNameä½¿ç”¨
                            window._currentBatchImportData = data;

                            // è‡ªåŠ¨åˆ†æµä¸æ ‡ç­¾
                            const evalRes = evaluateAutoTagRouting(url, (data.æ ‡é¢˜ || data.ä¹¦å || ''), (htmlDoc.body && htmlDoc.body.innerText) || '', siteConfig);
                            if (evalRes.tags && evalRes.tags.length) {
                                const prop = evalRes.tagProperty || 'ç±»å‹';
                                const existingRaw = data[prop];
                                const existing = Array.isArray(existingRaw) ? existingRaw : (existingRaw ? [existingRaw] : []);
                                const names = new Set(existing.map(v => typeof v === 'object' ? v.name : String(v)));
                                for (const name of evalRes.tags) {
                                    if (!names.has(name)) {
                                        if (!Array.isArray(data[prop])) data[prop] = [];
                                        data[prop].push({ name, color: "pink" });
                                    }
                                }
                            }

                            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç›¸åŒé“¾æ¥çš„æ¡ç›®ï¼ˆä½¿ç”¨è‡ªåŠ¨åˆ†æµåçš„ç±»å‹ï¼‰
                            statusElement.innerHTML += '<br>æ£€æŸ¥Notionä¸­æ˜¯å¦å·²å­˜åœ¨...';

                            // å¦‚æœåŒ¹é…äº†åªå¡«å†™æ‰“æ ‡ç­¾çš„è§„åˆ™ï¼Œä½¿ç”¨æ˜ å°„æ•°æ®åº“ï¼›å¦åˆ™ä½¿ç”¨æ™®é€šè§„åˆ™çš„routeType
                            const finalRouteType = (data['_useMappingDatabase'] && data['_autoRouteType'])
                            ? data['_autoRouteType']
                            : (evalRes.routeType || contentType);
                            const existingPageId = await checkExistingPage(url, finalRouteType);

                            statusElement.innerHTML += '<br>å¯¼å…¥åˆ°Notionä¸­...';

                            let result;
                            if (existingPageId) {
                                result = await updateNotionPage(existingPageId, data, url, finalRouteType);
                            } else {
                                result = await createNotionPage(data, url, finalRouteType);
                            }

                            resolve({
                                url,
                                title: data.ä¹¦å || data.æ ‡é¢˜ || "æœªå‘½å",
                                isUpdate: !!existingPageId,
                                success: true
                            });
                        } catch (error) {
                            reject(error);
                        }
                    } else {
                        reject(new Error(`è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`));
                    }
                },
                onerror: function(error) {
                    reject(new Error(`è¯·æ±‚é”™è¯¯: ${error.message || "æœªçŸ¥é”™è¯¯"}`));
                },
                ontimeout: function() {
                    reject(new Error("è¯·æ±‚è¶…æ—¶"));
                }
            });
        });
    }
    // ä»HTMLæ–‡æ¡£æå–æ•°æ®
    async function extractDataFromHtml(htmlDoc, siteConfig, sourceURL, isUpdateMode = false) {
        // è®¾ç½®å…¨å±€æ›´æ–°æ¨¡å¼æ ‡è®°
        window.isUpdateMode = isUpdateMode;

        const result = {};
        const typeMappings = loadTypeMappings();

        // ç¡®ä¿selectorIndiceså­˜åœ¨
        if (!siteConfig.selectorIndices) {
            siteConfig.selectorIndices = {};
        }

        // å¤„ç†å°é¢
        if (siteConfig.selectors['å°é¢']) {
            const coverElements = htmlDoc.querySelectorAll(siteConfig.selectors['å°é¢']);
            let coverEl = null;
            if (coverElements.length > 0) {
                const selection = resolveElementSelection(coverElements, siteConfig.selectorIndices['å°é¢'] ?? '0');
                if (selection.elements.length) {
                    coverEl = selection.elements[0];
                }
            }
            if (coverEl) {
                let coverUrl = "";

                // æ£€æŸ¥å„ç§å¯èƒ½çš„å›¾ç‰‡å±æ€§
                const attrs = ['data-original', 'data-src', 'src', 'data-url', 'data-srcset'];
                for (const attr of attrs) {
                    const url = coverEl.getAttribute(attr);
                    if (url) {
                        coverUrl = url;
                        break;
                    }
                }

                // æ£€æŸ¥èƒŒæ™¯å›¾ç‰‡
                if (!coverUrl && coverEl.style && coverEl.style.backgroundImage) {
                    const match = coverEl.style.backgroundImage.match(/url\(["']?(.*?)["']?\)/);
                    if (match && match[1]) {
                        coverUrl = match[1];
                    }
                }

                // å¤„ç†ç›¸å¯¹è·¯å¾„
                if (coverUrl && !coverUrl.startsWith('http')) {
                    coverUrl = new URL(coverUrl, sourceURL).href;
                }

                // å¤„ç†å°é¢å›¾ç‰‡URL
                if (coverUrl) {
                    console.log('åŸå§‹å°é¢URL (extractDataFromHtml):', coverUrl);

                    if (window.isUpdateMode) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯base64çº¯ç™½è‰²å°é¢
                        let isWhiteBase64 = false;
                        if (isBase64ImageUrl(coverUrl)) {
                            isWhiteBase64 = await isWhiteImage(coverUrl);
                            if (isWhiteBase64) {
                                console.log('æ›´æ–°æ¨¡å¼ (extractDataFromHtml)ï¼šæ£€æµ‹åˆ°å°é¢æ˜¯base64çº¯ç™½è‰²ï¼Œéœ€è¦æ›¿æ¢');
                            }
                        }

                        if (!COVER_BED_CONFIG.enabled && !isWhiteBase64) {
                            try {
                                result['å°é¢'] = await processImageUrl(coverUrl, {
                                    isCover: true,
                                    skipGithubUpload: true,
                                    contentType: siteConfig.contentType
                                });
                                console.log('æ›´æ–°æ¨¡å¼ (extractDataFromHtml)ï¼šå°é¢å›¾åºŠæœªå¯ç”¨ï¼Œä½¿ç”¨ä»£ç†é“¾æ¥');
                            } catch (error) {
                                console.error('æ›´æ–°æ¨¡å¼ (extractDataFromHtml)ï¼šå¤„ç†å°é¢ä»£ç†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é“¾æ¥', error);
                                result['å°é¢'] = coverUrl;
                            }
                        } else if (isGitHubImageUrl(coverUrl) && !isWhiteBase64) {
                            try {
                                result['å°é¢'] = await processImageUrl(coverUrl, {
                                    isCover: true,
                                    skipGithubUpload: true,
                                    contentType: siteConfig.contentType
                                });
                                console.log('æ›´æ–°æ¨¡å¼ (extractDataFromHtml)ï¼šå°é¢ä¸ºGitHubé“¾æ¥ï¼Œå·²æŒ‰é«˜çº§è·¯å¾„é‡å†™');
                            } catch (_) { result['å°é¢'] = coverUrl; }
                        } else {
                            console.log('æ›´æ–°æ¨¡å¼ (extractDataFromHtml)ï¼šå°é¢å›¾åºŠå¯ç”¨æˆ–æ£€æµ‹åˆ°base64çº¯ç™½è‰²å°é¢ï¼Œä¸Šä¼ å°é¢åˆ°GitHub');
                            try {
                                result['å°é¢'] = await processImageUrl(coverUrl, {
                                    isCover: true,
                                    skipGithubUpload: false,
                                    contentType: siteConfig.contentType
                                });
                                console.log('æ›´æ–°æ¨¡å¼ (extractDataFromHtml)ï¼šå¤„ç†åçš„å°é¢URL:', result['å°é¢']);
                            } catch (error) {
                                console.error('æ›´æ–°æ¨¡å¼ (extractDataFromHtml)ï¼šå°é¢ä¸Šä¼ å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é“¾æ¥', error);
                                result['å°é¢'] = coverUrl;
                            }
                        }
                    } else {
                        // æ·»åŠ æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»åœ¨å¤„ç†å°é¢ï¼Œé¿å…é‡å¤å¤„ç†
                        if (COVER_PROCESSING_STATE.isProcessingCover) {
                            console.log('æ·»åŠ æ¨¡å¼ (extractDataFromHtml)ï¼šå°é¢æ­£åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡é‡å¤å¤„ç†');
                            result['å°é¢'] = coverUrl; // ä¿æŒåŸæ ·ï¼Œä¸é‡å¤å¤„ç†
                        } else {
                            // æ ‡è®°æ­£åœ¨å¤„ç†å°é¢
                            COVER_PROCESSING_STATE.isProcessingCover = true;

                            try {
                                // æ£€æŸ¥æ˜¯å¦ä¸æ˜¯GitHubé“¾æ¥ï¼Œå¦‚æœä¸æ˜¯ä¸”å¯ç”¨äº†æ›¿æ¢é€‰é¡¹ï¼Œåˆ™ä¸Šä¼ åˆ°GitHub
                                if (!isGitHubImageUrl(coverUrl) && COVER_BED_CONFIG.replaceNotionGithub) {
                                    console.log('æ£€æµ‹åˆ°éGitHubé“¾æ¥ (extractDataFromHtml)ï¼Œä¸Šä¼ å°é¢åˆ°GitHub');
                                    // ä¸Šä¼ åˆ°GitHub
                                    result['å°é¢'] = await processImageUrl(coverUrl, {
                                        isCover: true,
                                        skipGithubUpload: false,
                                        contentType: siteConfig.contentType
                                    });
                                } else {
                                    // æ­£å¸¸å¤„ç†å°é¢
                                    result['å°é¢'] = await processImageUrl(coverUrl, {
                                        isCover: true,
                                        skipGithubUpload: false,
                                        contentType: siteConfig.contentType
                                    });
                                }
                                console.log('å¤„ç†åçš„å°é¢URL (extractDataFromHtml):', result['å°é¢']);
                            } finally {
                                // å¤„ç†å®Œæˆåé‡ç½®çŠ¶æ€
                                COVER_PROCESSING_STATE.isProcessingCover = false;
                            }
                        }
                    }
                }
            }
        }

        // æå–åŸºæœ¬å­—æ®µ
        const fields = [
            'ä¹¦å', 'ç®€ä»‹', 'æœ€æ–°ç« èŠ‚', 'æ›´æ–°çŠ¶æ€', 'è¿½æ›´', 'åˆ«å', 'åœ°åŒº', 'ç±»å‹'
        ];

        for (const field of fields) {
            if (siteConfig.selectors[field]) {
                const elements = htmlDoc.querySelectorAll(siteConfig.selectors[field]);
                if (elements.length > 0) {
                    const selection = resolveElementSelection(elements, siteConfig.selectorIndices[field] ?? '0');
                    if (!selection.elements.length) {
                        result[field] = "";
                        continue;
                    }

                    const processText = (el) => {
                        let text = field === 'ç®€ä»‹' ? el.innerHTML : el.textContent;
                        if (siteConfig.selectors[`${field}_filter`]) {
                            const filterMode = siteConfig.selectors[`${field}_filter_mode`] || 'remove';
                            text = applyFilter(text, siteConfig.selectors[`${field}_filter`], filterMode, field);
                        }
                        if (field === 'ç®€ä»‹') {
                            text = convertHtmlToNewlines(text);
                            text = decodeHtmlEntities(text);
                        }
                        return field === 'ç®€ä»‹' ? cleanTextWithNewlines(text) : cleanText(text);
                    };

                    if (selection.mode === 'all' || selection.mode === 'multiple') {
                        const processedTexts = selection.elements.map(processText).filter(Boolean);
                        if (!processedTexts.length) {
                            result[field] = "";
                        } else if (field === 'ç®€ä»‹') {
                            result[field] = processedTexts.join('\n');
                        } else {
                            result[field] = joinTextsWithSeparator(field, processedTexts);
                        }
                    } else {
                        const element = selection.elements[0];
                        const text = processText(element);
                        if (field === 'ä¹¦å') {
                            result[field] = cleanTitle(text);
                        } else if (field === 'åœ°åŒº') {
                            let regionText = normalizeField('åœ°åŒº', text, typeMappings);
                            result[field] = convertRegion(regionText);
                        } else if (field === 'ç±»å‹') {
                            result[field] = normalizeField('ç±»å‹', text, typeMappings);
                        } else if (field === 'æ›´æ–°çŠ¶æ€') {
                            result[field] = normalizeField('æ›´æ–°çŠ¶æ€', text, typeMappings);
                        } else {
                            result[field] = text;
                        }
                    }

                    if (result[field]) {
                        if (field === 'åœ°åŒº') {
                            let regionText = normalizeField('åœ°åŒº', result[field], typeMappings);
                            result[field] = convertRegion(regionText);
                        } else if (field === 'ç±»å‹') {
                            result[field] = normalizeField('ç±»å‹', result[field], typeMappings);
                        } else if (field === 'æ›´æ–°çŠ¶æ€') {
                            result[field] = normalizeField('æ›´æ–°çŠ¶æ€', result[field], typeMappings);
                        } else if (field === 'ä¹¦å') {
                            result[field] = cleanTitle(result[field]);
                        }
                    }
                }
            }
        }

        // å¤„ç†ä½œè€…å­—æ®µ
        if (siteConfig.selectors['ä½œè€…']) {
            const elements = htmlDoc.querySelectorAll(siteConfig.selectors['ä½œè€…']);
            const selection = resolveElementSelection(elements, siteConfig.selectorIndices['ä½œè€…'] ?? '0');

            if (!selection.elements.length) {
                result['ä½œè€…'] = "";
            } else if (selection.mode === 'all' || selection.mode === 'multiple') {
                result['ä½œè€…'] = joinTextsWithSeparator('ä½œè€…',
                                                      selection.elements
                                                      .map(el => (el.textContent || '').trim())
                                                      .filter(Boolean)
                                                     );
            } else {
                result['ä½œè€…'] = (selection.elements[0].textContent || '').trim();
            }
        }

        // æ ‡å‡†åŒ–å­—æ®µ
        if (result['ä¹¦å']) result['ä¹¦å'] = cleanTitle(result['ä¹¦å']);
        if (result['åœ°åŒº']) result['åœ°åŒº'] = normalizeField('åœ°åŒº', result['åœ°åŒº'], typeMappings);
        if (result['ç±»å‹']) result['ç±»å‹'] = normalizeField('ç±»å‹', result['ç±»å‹'], typeMappings);
        if (result['æ›´æ–°çŠ¶æ€']) result['æ›´æ–°çŠ¶æ€'] = normalizeField('æ›´æ–°çŠ¶æ€', result['æ›´æ–°çŠ¶æ€'], typeMappings);

        // æ ¹æ®å†…å®¹ç±»å‹è¿›è¡Œå­—æ®µæ˜ å°„
        if (siteConfig.contentType === 'clip' && result['ä¹¦å']) {
            // å‰ªè—æ¨¡å¼ä¸‹ï¼Œå°†"ä¹¦å"å­—æ®µæ˜ å°„ä¸º"æ ‡é¢˜"å­—æ®µ
            result['æ ‡é¢˜'] = result['ä¹¦å'];
            delete result['ä¹¦å'];
        }

        return result;
    }

    // å¤„ç†å±•å¼€æŒ‰é’®å†…å®¹ï¼Œæä¾›ç®€å•çš„è¿‡æ»¤åŠŸèƒ½
    function applyFilter(text, filterPattern, mode, fieldName = '') {
        if (!filterPattern || !text) return text;

        try {
            if (mode === 'extract') {
                // æå–æ¨¡å¼ - æå–æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„å†…å®¹
                const regex = new RegExp(filterPattern, 'g');
                const matches = [];
                let match;

                // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…é¡¹
                while ((match = regex.exec(text)) !== null) {
                    // å¦‚æœæœ‰æ•è·ç»„ï¼Œæå–ç¬¬ä¸€ä¸ªæ•è·ç»„çš„å†…å®¹
                    if (match.length > 1 && match[1]) {
                        matches.push(match[1].trim());
                    } else {
                        // å¦‚æœæ²¡æœ‰æ•è·ç»„ï¼Œæå–æ•´ä¸ªåŒ¹é…çš„å†…å®¹
                        matches.push(match[0].trim());
                    }
                }

                // è¿”å›æ‰€æœ‰åŒ¹é…çš„å†…å®¹
                return matches.length > 0 ? joinTextsWithSeparator(fieldName || 'è¿‡æ»¤ç»“æœ', matches) : text;
            } else if (mode === 'remove') {
                // ç®€å•æ›¿æ¢æ¨¡å¼
                return text.replace(new RegExp(filterPattern, 'g'), '');
            } else if (mode === 'regex') {
                // æ­£åˆ™è¡¨è¾¾å¼åˆ é™¤æ¨¡å¼
                return text.replace(new RegExp(filterPattern, 'g'), '');
            } else {
                return text;
            }
        } catch (error) {
            console.error('åº”ç”¨è¿‡æ»¤å¤±è´¥:', error);
            return text;
        }
    }



    // Notion APIé…ç½®å¯¹è¯æ¡†
    function showNotionConfigDialog() {
        // è·å–å½“å‰é…ç½®
        const apiKey = NOTION_CONFIG.apiKey;
        const comicDatabaseId = NOTION_CONFIG.databaseIds.comic;
        const novelDatabaseId = NOTION_CONFIG.databaseIds.novel;
        const clipDatabaseId = NOTION_CONFIG.databaseIds.clip;
        const autoUpdateEnabled = !GM_getValue('autoUpdateDisabled', false);

        // åˆ›å»ºé…ç½®å¯¹è¯æ¡†
        const dialogWrapper = document.createElement('div');
        dialogWrapper.className = 'notion-config-dialog-wrapper';
        dialogWrapper.style.position = 'fixed';
        dialogWrapper.style.top = '0';
        dialogWrapper.style.left = '0';
        dialogWrapper.style.width = '100%';
        dialogWrapper.style.height = '100%';
        dialogWrapper.style.backgroundColor = 'rgba(0,0,0,0.5)';
        dialogWrapper.style.zIndex = '2147483647';
        dialogWrapper.style.display = 'flex';
        dialogWrapper.style.justifyContent = 'center';
        dialogWrapper.style.alignItems = 'center';

        const dialog = document.createElement('div');
        dialog.className = 'notion-config-dialog';
        dialog.style.backgroundColor = 'white';
        dialog.style.borderRadius = '16px';
        dialog.style.padding = '40px';
        dialog.style.width = '500px';
        dialog.style.maxWidth = '90%';
        dialog.style.maxHeight = '90%';
        dialog.style.overflowY = 'auto';
        dialog.style.boxShadow = '0 4px 20px rgba(0,0,0,0.15)';

        const title = document.createElement('h2');
        title.textContent = 'Notioné…ç½®';
        title.style.margin = '0 0 20px 0';
        title.style.padding = '0 0 10px 0';
        title.style.borderBottom = '1px solid #eee';
        title.style.fontSize = '18px';
        title.style.fontWeight = '600';
        title.style.color = 'var(--primarycolor-dark, #D94D7B)';
        dialog.appendChild(title);

        // APIå¯†é’¥
        const apiKeyLabel = document.createElement('label');
        apiKeyLabel.textContent = 'API å¯†é’¥';
        apiKeyLabel.style.display = 'block';
        apiKeyLabel.style.marginBottom = '8px';
        apiKeyLabel.style.fontWeight = '500';
        dialog.appendChild(apiKeyLabel);

        const apiKeyInput = document.createElement('input');
        apiKeyInput.type = 'text';
        apiKeyInput.value = apiKey || '';
        apiKeyInput.placeholder = 'è¾“å…¥ä½ çš„ Notion API å¯†é’¥';
        apiKeyInput.style.width = '100%';
        apiKeyInput.style.padding = '10px';
        apiKeyInput.style.marginBottom = '20px';
        apiKeyInput.style.border = '1px solid #ddd';
        apiKeyInput.style.borderRadius = '50px';
        apiKeyInput.style.boxSizing = 'border-box';
        dialog.appendChild(apiKeyInput);

        // æ¼«ç”»æ•°æ®åº“ID
        const comicDbLabel = document.createElement('label');
        comicDbLabel.textContent = 'æ¼«ç”»æ•°æ®åº“ ID';
        comicDbLabel.style.display = 'block';
        comicDbLabel.style.marginBottom = '8px';
        comicDbLabel.style.fontWeight = '500';
        dialog.appendChild(comicDbLabel);

        const comicDbInput = document.createElement('input');
        comicDbInput.type = 'text';
        comicDbInput.value = comicDatabaseId || '';
        comicDbInput.placeholder = 'è¾“å…¥æ¼«ç”»æ•°æ®åº“ ID';
        comicDbInput.style.width = '100%';
        comicDbInput.style.padding = '10px';
        comicDbInput.style.marginBottom = '20px';
        comicDbInput.style.border = '1px solid #ddd';
        comicDbInput.style.borderRadius = '50px';
        comicDbInput.style.boxSizing = 'border-box';
        dialog.appendChild(comicDbInput);

        // å°è¯´æ•°æ®åº“ID
        const novelDbLabel = document.createElement('label');
        novelDbLabel.textContent = 'å°è¯´æ•°æ®åº“ ID';
        novelDbLabel.style.display = 'block';
        novelDbLabel.style.marginBottom = '8px';
        novelDbLabel.style.fontWeight = '500';
        dialog.appendChild(novelDbLabel);

        const novelDbInput = document.createElement('input');
        novelDbInput.type = 'text';
        novelDbInput.value = novelDatabaseId || '';
        novelDbInput.placeholder = 'è¾“å…¥å°è¯´æ•°æ®åº“ ID';
        novelDbInput.style.width = '100%';
        novelDbInput.style.padding = '10px';
        novelDbInput.style.marginBottom = '20px';
        novelDbInput.style.border = '1px solid #ddd';
        novelDbInput.style.borderRadius = '50px';
        novelDbInput.style.boxSizing = 'border-box';
        dialog.appendChild(novelDbInput);

        // å‰ªè—æ•°æ®åº“ID
        const clipDbLabel = document.createElement('label');
        clipDbLabel.textContent = 'å‰ªè—æ•°æ®åº“ ID';
        clipDbLabel.style.display = 'block';
        clipDbLabel.style.marginBottom = '8px';
        clipDbLabel.style.fontWeight = '500';
        dialog.appendChild(clipDbLabel);

        const clipDbInput = document.createElement('input');
        clipDbInput.type = 'text';
        clipDbInput.value = clipDatabaseId || '';
        clipDbInput.placeholder = 'è¾“å…¥å‰ªè—æ•°æ®åº“ ID';
        clipDbInput.style.width = '100%';
        clipDbInput.style.padding = '10px';
        clipDbInput.style.marginBottom = '20px';
        clipDbInput.style.border = '1px solid #ddd';
        clipDbInput.style.borderRadius = '50px';
        clipDbInput.style.boxSizing = 'border-box';
        dialog.appendChild(clipDbInput);

        // è‡ªåŠ¨æ›´æ–°é€‰é¡¹
        const autoUpdateContainer = document.createElement('div');
        autoUpdateContainer.style.margin = '20px 0';
        autoUpdateContainer.style.display = 'flex';
        autoUpdateContainer.style.alignItems = 'center';

        const autoUpdateCheckboxContainer = createCustomCheckbox(
            'auto-update-checkbox',
            autoUpdateEnabled,
            'å¯ç”¨è‡ªåŠ¨æ›´æ–°'
        );
        autoUpdateContainer.appendChild(autoUpdateCheckboxContainer);

        dialog.appendChild(autoUpdateContainer);


        // å¸®åŠ©è¯´æ˜
        const helpText = document.createElement('div');
        setSafeHtml(helpText, `
            <p style="margin-top: 20px; font-size: 14px; color: #777;">
                <strong>å¦‚ä½•è·å– Notion API å¯†é’¥ï¼š</strong><br>
                1. è®¿é—® <a href="https://www.notion.so/my-integrations" target="_blank" rel="noopener noreferrer">Notion Integrations</a><br>
                2. ç‚¹å‡» "New integration" åˆ›å»ºæ–°é›†æˆ<br>
                3. å¤åˆ¶ç”Ÿæˆçš„ "Internal Integration Token"<br>
                4. åœ¨ Notion ä¸­å°†æ•°æ®åº“ä¸è¯¥é›†æˆå…±äº«
            </p>
            <p style="font-size: 14px; color: #777;">
                <strong>å¦‚ä½•è·å–æ•°æ®åº“ IDï¼š</strong><br>
                æ•°æ®åº“ ID æ˜¯æ•°æ®åº“ URL ä¸­çš„è¿™ä¸€éƒ¨åˆ†ï¼š<br>
                https://www.notion.so/xxx/<mark style="background-color: #ffeaa7; padding: 0 2px;">databaseID</mark>?v=...
            </p>
        `);
        dialog.appendChild(helpText);

        // æŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.justifyContent = 'center';
        buttonContainer.style.gap = '10px';
        buttonContainer.style.marginTop = '20px';


        // å–æ¶ˆæŒ‰é’®
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.style.padding = '10px 20px';
        cancelButton.style.border = '1px solid #ddd';
        cancelButton.style.borderRadius = '20px';
        cancelButton.style.backgroundColor = '#f5f5f5';
        cancelButton.style.cursor = 'pointer';
        cancelButton.style.display = 'flex';
        cancelButton.style.alignItems = 'center';
        cancelButton.style.justifyContent = 'center';
        cancelButton.onclick = () => {
            document.body.removeChild(dialogWrapper);
        };
        buttonContainer.appendChild(cancelButton);

        // ä¿å­˜æŒ‰é’®
        const saveButton = document.createElement('button');
        saveButton.textContent = 'ä¿å­˜';
        saveButton.style.padding = '10px 20px';
        saveButton.style.border = 'none';
        saveButton.style.borderRadius = '20px';
        saveButton.style.background = 'linear-gradient(135deg, var(--primarycolor-dark, #FF8FAB), var(--primarycolor, #FF6B9D))';
        saveButton.style.color = 'white';
        saveButton.style.cursor = 'pointer';
        saveButton.style.boxShadow = '0 2px 8px var(--primarycolor-lighter)';
        saveButton.style.display = 'flex';
        saveButton.style.alignItems = 'center';
        saveButton.style.justifyContent = 'center';
        saveButton.onclick = () => {
            // ä¿å­˜é…ç½®
            const newApiKey = apiKeyInput.value.trim();
            const newComicDbId = comicDbInput.value.trim();
            const newNovelDbId = novelDbInput.value.trim();
            const newClipDbId = clipDbInput.value.trim();
            const newAutoUpdateEnabled = document.getElementById('auto-update-checkbox').checked;

            // éªŒè¯è¾“å…¥
            if (!newApiKey) {
                showNotification('API å¯†é’¥ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            if (!newComicDbId && !newNovelDbId && !newClipDbId) {
                showNotification('è‡³å°‘éœ€è¦é…ç½®ä¸€ä¸ªæ•°æ®åº“ ID', 'error');
                return;
            }

            // ä¿å­˜é…ç½®
            if (saveNotionConfig(newApiKey, newComicDbId, newNovelDbId, newClipDbId)) {
                // ä¿å­˜è‡ªåŠ¨æ›´æ–°è®¾ç½®
                GM_setValue('autoUpdateDisabled', !newAutoUpdateEnabled);

                showNotification('Notion é…ç½®å·²ä¿å­˜', 'success');
                document.body.removeChild(dialogWrapper);
            } else {
                showNotification('ä¿å­˜é…ç½®å¤±è´¥', 'error');
            }
        };
        buttonContainer.appendChild(saveButton);

        dialog.appendChild(buttonContainer);
        dialogWrapper.appendChild(dialog);
        document.body.appendChild(dialogWrapper);

        // ä½¿å¯¹è¯æ¡†å¯æ‹–åŠ¨
        makeDialogDraggable(dialog, title);
    }
    // å°†HTMLè½¬æ¢ä¸ºMarkdownæ ¼å¼
    function convertHtmlToMarkdown(html) {
        if (!html) return "";

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // å»é™¤è„šæœ¬å’Œæ ·å¼æ ‡ç­¾
        const scripts = doc.querySelectorAll('script, style');
        scripts.forEach(script => script.remove());

        // ç”¨äºå­˜å‚¨æ–‡æ¡£ä¸­çš„å›¾ç‰‡å’Œå®ƒä»¬çš„ä½ç½®ä¿¡æ¯
        const imageData = [];
        let imageIndex = 0;

        // ç”¨äºå­˜å‚¨æ–‡æ¡£ä¸­çš„è§†é¢‘å’Œå®ƒä»¬çš„ä½ç½®ä¿¡æ¯
        const videoData = [];
        let videoIndex = 0;

        // ç”¨äºå­˜å‚¨ç½‘é¡µä¹¦ç­¾ï¼ˆå¦‚çŸ¥ä¹ LinkCardï¼‰
        const bookmarkData = [];
        let bookmarkIndex = 0;

        // å›¾ç‰‡å¤„ç†å‡½æ•° - æ”¶é›†å›¾ç‰‡ä¿¡æ¯è€Œä¸æ˜¯è½¬æ¢ä¸ºMarkdownæ ¼å¼
        function processImage(img) {
            let src = img.getAttribute('src') || '';
            if (!src) return '';

            // ä¼˜å…ˆä½¿ç”¨ data-canonical-src å±æ€§ï¼ˆåŸå§‹å›¾ç‰‡URLï¼‰
            const canonicalSrc = img.getAttribute('data-canonical-src');
            if (canonicalSrc && canonicalSrc.trim()) {
                src = canonicalSrc.trim();
            }

            // è¿‡æ»¤æ‰æ•°æ®URLã€ç©ºURLå’Œæ— æ•ˆæ ¼å¼
            if (src.startsWith('data:') || src.length < 5) {
                console.log('è·³è¿‡æ— æ•ˆå›¾ç‰‡é“¾æ¥:', src.substring(0, 30) + '...');
                return '';
            }

            // è¡¥å…¨ç›¸å¯¹è·¯å¾„
            if (src.startsWith('//')) {
                src = 'https:' + src;
            } else if (src.startsWith('/')) {
                src = window.location.origin + src;
            } else if (!src.startsWith('http')) {
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                src = baseUrl + src;
            }

            // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
            try {
                // å°è¯•åˆ›å»ºURLå¯¹è±¡ä»¥éªŒè¯æ ¼å¼
                new URL(src);
            } catch (e) {
                console.log('è·³è¿‡æ ¼å¼é”™è¯¯çš„å›¾ç‰‡URL:', src);
                return '';
            }

            // ä¸ä½¿ç”¨ä»£ç†å‰ç¼€ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹URL
            // Notion APIéœ€è¦ç›´æ¥çš„å›¾ç‰‡URL
            const imageUrl = src;

            // è·å–altæ–‡æœ¬å’Œfigcaptionæ ‡é¢˜
            const alt = img.getAttribute('alt') || 'å›¾ç‰‡';
            const figcaption = img.getAttribute('data-figcaption') || '';

            // ä»…å½“å›¾ç‰‡URLé€šè¿‡æ ¡éªŒæ—¶ï¼Œæ‰ç”Ÿæˆå ä½ç¬¦ä¸å›¾ç‰‡å—
            if (isValidImageUrl(imageUrl)) {
                const imageId = `IMAGE_PLACEHOLDER_${imageIndex++}`;
                imageData.push({
                    id: imageId,
                    url: imageUrl,
                    alt: alt,
                    caption: figcaption
                });
                // å›¾ç‰‡å ä½ç¬¦åæ·»åŠ æ¢è¡Œï¼Œç¡®ä¿ä¸åç»­å†…å®¹åˆ†éš”
                return imageId + '\n';
            }

            // å¯¹äºæ— æ•ˆå›¾ç‰‡ï¼ˆå¦‚ SVG å¾½ç«  / camo ä»£ç†ï¼‰ï¼Œä¸æ·»åŠ å›¾ç‰‡å ä½ç¬¦
            return '';
        }

        // å¤„ç†lightbox-wrapperæ ¼å¼çš„å›¾ç‰‡
        function processLightboxImage(lightboxWrapper) {
            const lightbox = lightboxWrapper.querySelector('a.lightbox');
            if (!lightbox) return '';

            // è·å–åŸå§‹å›¾ç‰‡URLï¼ˆhrefå±æ€§ï¼‰
            const originalSrc = lightbox.getAttribute('href') || '';
            if (!originalSrc) return '';

            // è·å–ä¸‹è½½é“¾æ¥ï¼ˆdata-download-hrefå±æ€§ï¼‰
            const downloadHref = lightbox.getAttribute('data-download-href') || '';

            // è·å–å›¾ç‰‡ä¿¡æ¯ï¼ˆå°ºå¯¸å’Œæ–‡ä»¶å¤§å°ï¼‰
            const metaDiv = lightbox.querySelector('.meta');
            let imageInfo = '';
            if (metaDiv) {
                const infoSpan = metaDiv.querySelector('.informations');
                if (infoSpan) {
                    imageInfo = infoSpan.textContent.trim();
                }
            }

            // è¡¥å…¨ç›¸å¯¹è·¯å¾„
            let imageUrl = originalSrc;
            if (imageUrl.startsWith('//')) {
                imageUrl = 'https:' + imageUrl;
            } else if (imageUrl.startsWith('/')) {
                imageUrl = window.location.origin + imageUrl;
            } else if (!imageUrl.startsWith('http')) {
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                imageUrl = baseUrl + imageUrl;
            }

            // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
            try {
                new URL(imageUrl);
            } catch (e) {
                console.log('è·³è¿‡æ ¼å¼é”™è¯¯çš„lightboxå›¾ç‰‡URL:', imageUrl);
                return '';
            }

            // ä¿å­˜å›¾ç‰‡ä¿¡æ¯
            const imageId = `IMAGE_PLACEHOLDER_${imageIndex++}`;
            imageData.push({
                id: imageId,
                url: imageUrl,
                alt: 'å›¾ç‰‡',
                caption: imageInfo // ä½¿ç”¨å›¾ç‰‡ä¿¡æ¯ä½œä¸ºæ ‡é¢˜
            });

            // å¦‚æœæœ‰ä¸‹è½½é“¾æ¥å’Œå›¾ç‰‡ä¿¡æ¯ï¼Œåˆ›å»ºé¢å¤–çš„é“¾æ¥
            let additionalContent = '';
            if (downloadHref && imageInfo) {
                // è¡¥å…¨ä¸‹è½½é“¾æ¥çš„ç›¸å¯¹è·¯å¾„
                let downloadUrl = downloadHref;
                if (downloadUrl.startsWith('//')) {
                    downloadUrl = 'https:' + downloadUrl;
                } else if (downloadUrl.startsWith('/')) {
                    downloadUrl = window.location.origin + downloadUrl;
                } else if (!downloadUrl.startsWith('http')) {
                    const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                    downloadUrl = baseUrl + downloadUrl;
                }

                // åˆ›å»ºMarkdowné“¾æ¥æ ¼å¼
                additionalContent = `\n\n[${imageInfo}](${downloadUrl})`;
            }

            // å›¾ç‰‡å ä½ç¬¦åæ·»åŠ æ¢è¡Œï¼Œç¡®ä¿ä¸åç»­å†…å®¹åˆ†éš”
            return imageId + '\n' + additionalContent;
        }

        // è§†é¢‘å¤„ç†å‡½æ•° - æ”¶é›†è§†é¢‘ä¿¡æ¯è€Œä¸æ˜¯è½¬æ¢ä¸ºMarkdownæ ¼å¼
        function processVideo(video) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡è¿™ä¸ªè§†é¢‘å…ƒç´ 
            if (video.hasAttribute('data-processed')) {
                return '';
            }

            // æ ‡è®°ä¸ºå·²å¤„ç†
            video.setAttribute('data-processed', 'true');

            let src = video.getAttribute('src') || '';
            if (!src) {
                // æ£€æŸ¥æ˜¯å¦æœ‰sourceå­å…ƒç´ 
                const source = video.querySelector('source');
                if (source) {
                    src = source.getAttribute('src') || '';
                }
            }

            // å¦‚æœæ²¡æœ‰srcï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯iframeåµŒå…¥çš„è§†é¢‘
            if (!src && video.tagName.toLowerCase() === 'iframe') {
                src = video.getAttribute('src') || '';
            }

            if (!src) return '';

            // è¿‡æ»¤æ‰æ•°æ®URLã€ç©ºURLå’Œæ— æ•ˆæ ¼å¼
            if (src.startsWith('data:') || src.length < 5) {
                console.log('è·³è¿‡æ— æ•ˆè§†é¢‘é“¾æ¥:', src.substring(0, 30) + '...');
                return '';
            }

            // è¡¥å…¨ç›¸å¯¹è·¯å¾„
            if (src.startsWith('//')) {
                src = 'https:' + src;
            } else if (src.startsWith('/')) {
                src = window.location.origin + src;
            } else if (!src.startsWith('http')) {
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                src = baseUrl + src;
            }

            // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
            try {
                // å°è¯•åˆ›å»ºURLå¯¹è±¡ä»¥éªŒè¯æ ¼å¼
                new URL(src);
            } catch (e) {
                console.log('è·³è¿‡æ ¼å¼é”™è¯¯çš„è§†é¢‘URL:', src);
                return '';
            }

            // è·å–æ ‡é¢˜æ–‡æœ¬
            const title = video.getAttribute('title') || 'è§†é¢‘';

            // ä¿å­˜è§†é¢‘ä¿¡æ¯å’Œå½“å‰ç´¢å¼•
            const videoId = `VIDEO_PLACEHOLDER_${videoIndex++}`;
            videoData.push({
                id: videoId,
                url: src,
                title: title
            });

            // è¿”å›ä¸€ä¸ªç‰¹æ®Šçš„å ä½ç¬¦ï¼Œç¨åå°†è¢«æ›¿æ¢
            return videoId;
        }

        // å¤„ç†çŸ¥ä¹å¤æ‚divç»“æ„çš„è§†é¢‘
        function processZhihuVideo(container) {
            const video = container.querySelector('video');
            if (!video) return '';

            // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡è¿™ä¸ªè§†é¢‘å…ƒç´ 
            if (video.hasAttribute('data-processed')) {
                return '';
            }

            const src = video.getAttribute('src') || '';
            if (!src) return '';

            // è¿‡æ»¤æ‰æ•°æ®URLã€ç©ºURLå’Œæ— æ•ˆæ ¼å¼
            if (src.startsWith('data:') || src.length < 5) {
                console.log('è·³è¿‡æ— æ•ˆçŸ¥ä¹è§†é¢‘é“¾æ¥:', src.substring(0, 30) + '...');
                return '';
            }

            // è¡¥å…¨ç›¸å¯¹è·¯å¾„
            let videoUrl = src;
            if (videoUrl.startsWith('//')) {
                videoUrl = 'https:' + videoUrl;
            } else if (videoUrl.startsWith('/')) {
                videoUrl = window.location.origin + videoUrl;
            } else if (!videoUrl.startsWith('http')) {
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                videoUrl = baseUrl + videoUrl;
            }

            // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
            try {
                new URL(videoUrl);
            } catch (e) {
                console.log('è·³è¿‡æ ¼å¼é”™è¯¯çš„çŸ¥ä¹è§†é¢‘URL:', videoUrl);
                return '';
            }

            // æ ‡è®°ä¸ºå·²å¤„ç†
            video.setAttribute('data-processed', 'true');

            // ä¿å­˜è§†é¢‘ä¿¡æ¯
            const videoId = `VIDEO_PLACEHOLDER_${videoIndex++}`;
            videoData.push({
                id: videoId,
                url: videoUrl,
                title: 'è§†é¢‘'
            });

            return videoId;
        }
        // é€’å½’å¤„ç†èŠ‚ç‚¹
        function processNode(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                let text = node.textContent;

                // ç®€å•ç­–ç•¥ï¼šåªè½¬ä¹‰é‚£äº›æ˜æ˜¾ä¸æ˜¯æ ¼å¼æ ‡è®°çš„æ˜Ÿå·
                // 1. è½¬ä¹‰3ä¸ªæˆ–æ›´å¤šè¿ç»­çš„æ˜Ÿå·ï¼ˆè£…é¥°æ€§ç¬¦å·ï¼‰
                text = text.replace(/\*{3,}/g, (match) => {
                    // ä½¿ç”¨Unicodeæ˜Ÿå·å­—ç¬¦æ›¿ä»£ï¼Œé¿å…è¢«è¯†åˆ«ä¸ºæ ¼å¼æ ‡è®°
                    return match.replace(/\*/g, 'âˆ—');
                });

                // 2. è½¬ä¹‰å•ä¸ªæ˜Ÿå·ï¼Œä½†åªåœ¨ç‰¹å®šæƒ…å†µä¸‹
                text = text.replace(/(?<!\*)\*(?!\*)/g, (match, offset, string) => {
                    // æ£€æŸ¥å‰åå­—ç¬¦
                    const before = string[offset - 1] || ' ';
                    const after = string[offset + 1] || ' ';

                    // å¦‚æœå‰åéƒ½æ˜¯å­—æ¯æ•°å­—ï¼Œå¯èƒ½æ˜¯æ ¼å¼æ ‡è®°ï¼Œä¸å¤„ç†
                    if (/[a-zA-Z0-9\u4e00-\u9fff]/.test(before) && /[a-zA-Z0-9\u4e00-\u9fff]/.test(after)) {
                        return match;
                    }

                    // å¦‚æœå‰åæ˜¯ç©ºæ ¼ã€æ ‡ç‚¹æˆ–è¾¹ç•Œï¼Œä½¿ç”¨Unicodeæ˜Ÿå·
                    if (/[\s\p{P}]/.test(before) || /[\s\p{P}]/.test(after) || offset === 0 || offset === string.length - 1) {
                        return 'âˆ—';
                    }

                    return match;
                });

                return text;
            }

            if (node.nodeType !== Node.ELEMENT_NODE) {
                return '';
            }

            const tagName = node.tagName.toLowerCase();

            if (tagName === 'br') {
                return '\n';
            }

            // å¤„ç†ç‰¹æ®Šhtmlå…ƒç´ 
            if (tagName === 'div') {
                const className = node.getAttribute('class') || '';

                // å¤„ç†lightbox-wrapperæ ¼å¼çš„å›¾ç‰‡
                if (className.includes('lightbox-wrapper')) {
                    return processLightboxImage(node);
                }

                // å¤„ç†çŸ¥ä¹å¤æ‚divç»“æ„çš„è§†é¢‘
                if (className.includes('css-bp306l') || className.includes('_1fog6rx')) {
                    const video = node.querySelector('video');
                    if (video && !video.hasAttribute('data-processed') && video.getAttribute('src') && video.getAttribute('src').includes('vdn6.vzuu.com')) {
                        return processZhihuVideo(node);
                    }
                }

                // é€‚é…"é•¿æ¡å½¢å¼•ç”¨"æ ·å¼çš„å®¹å™¨ï¼šå¸¦æœ‰ quote/blockquote å…³é”®è¯æˆ–å·¦è¾¹æ¡†æ ·å¼çš„å—
                const styleAttr = (node.getAttribute('style') || '').toLowerCase();
                const isLongBarQuote = /\bquote\b|\bblockquote\b|richtext-quote|long-?quote|quote-?block/i.test(className)
                || styleAttr.includes('border-left');
                if (isLongBarQuote) {
                    // ç›´æ¥å¤„ç†å­å…ƒç´ ï¼Œé¿å…æ®µè½å¤„ç†äº§ç”Ÿçš„å¤šä½™æ¢è¡Œ
                    const paragraphs = Array.from(node.children)
                    .filter(child => child.tagName.toLowerCase() === 'p')
                    .map(p => processChildren(p).trim())
                    .filter(content => content); // åªè¿‡æ»¤å®Œå…¨ç©ºçš„å†…å®¹

                    if (paragraphs.length > 0) {
                        const content = paragraphs
                        .map(line => '> ' + line)
                        .join('\n');
                        return content + '\n';
                    }
                }

                if (className.includes('RichText-LinkCardContainer')) {
                    const linkEl = node.querySelector('a[data-draft-type="link-card"], a.LinkCard');
                    if (linkEl) {
                        const href = linkEl.getAttribute('href');
                        if (href) {
                            const bookmarkId = `BOOKMARK_PLACEHOLDER_${bookmarkIndex++}`;
                            bookmarkData.push({ id: bookmarkId, url: href });
                            return bookmarkId + '\n\n';
                        }
                    }
                }
            }

            // å¤„ç†figureæ ‡ç­¾ - åŒ…å«å›¾ç‰‡å’Œfigcaption
            if (tagName === 'figure') {
                const img = node.querySelector('img');
                const figcaption = node.querySelector('figcaption');

                if (img) {
                    // å¦‚æœæœ‰figcaptionï¼Œå°†å…¶å†…å®¹ä½œä¸ºå›¾ç‰‡æ ‡é¢˜
                    if (figcaption) {
                        const captionText = processChildren(figcaption).trim();
                        // ä¸´æ—¶å­˜å‚¨figcaptionå†…å®¹ï¼Œä¾›processImageä½¿ç”¨
                        img.setAttribute('data-figcaption', captionText);
                    }
                    return processImage(img);
                }
                return '';
            }

            // å¤„ç†å›¾ç‰‡ - è¿”å›å ä½ç¬¦
            if (tagName === 'img') {
                return processImage(node);
            }

            // å¤„ç†è§†é¢‘ - è¿”å›å ä½ç¬¦
            if (tagName === 'video' || (tagName === 'iframe' && node.getAttribute('src') && (
                node.getAttribute('src').includes('youtube.com') ||
                node.getAttribute('src').includes('youtu.be') ||
                node.getAttribute('src').includes('vimeo.com') ||
                node.getAttribute('src').includes('bilibili.com') ||
                node.getAttribute('src').includes('dailymotion.com') ||
                node.getAttribute('src').includes('vdn6.vzuu.com') ||
                node.getAttribute('src').includes('vzuu.com')
            ))) {
                return processVideo(node);
            }

            // å¤„ç†åµŒå¥—çš„è§†é¢‘å…ƒç´ ï¼ˆå¦‚çŸ¥ä¹çš„å¤æ‚ç»“æ„ï¼‰
            if (tagName === 'div') {
                const video = node.querySelector('video');
                if (video && !video.hasAttribute('data-processed')) {
                    // å¤„ç†è§†é¢‘
                    const videoPlaceholder = processVideo(video);

                    // å¤„ç†divä¸­é™¤è§†é¢‘å¤–çš„å…¶ä»–å†…å®¹
                    let otherContent = '';
                    node.childNodes.forEach(child => {
                        if (child !== video) {
                            otherContent += processNode(child);
                        }
                    });

                    // å°†è§†é¢‘å ä½ç¬¦å’Œå…¶ä»–å†…å®¹ç»„åˆ
                    return videoPlaceholder + (otherContent.trim() ? '\n\n' + otherContent.trim() : '');
                }

                // æ£€æŸ¥æ˜¯å¦æ˜¯iframeè§†é¢‘å®¹å™¨
                const iframe = node.querySelector('iframe');
                if (iframe && !iframe.hasAttribute('data-processed') && iframe.getAttribute('src') && (
                    iframe.getAttribute('src').includes('youtube.com') ||
                    iframe.getAttribute('src').includes('youtu.be') ||
                    iframe.getAttribute('src').includes('vimeo.com') ||
                    iframe.getAttribute('src').includes('bilibili.com') ||
                    iframe.getAttribute('src').includes('dailymotion.com') ||
                    iframe.getAttribute('src').includes('vdn6.vzuu.com') ||
                    iframe.getAttribute('src').includes('vzuu.com')
                )) {
                    // å¤„ç†iframeè§†é¢‘
                    const videoPlaceholder = processVideo(iframe);

                    // å¤„ç†divä¸­é™¤iframeå¤–çš„å…¶ä»–å†…å®¹
                    let otherContent = '';
                    node.childNodes.forEach(child => {
                        if (child !== iframe) {
                            otherContent += processNode(child);
                        }
                    });

                    // å°†è§†é¢‘å ä½ç¬¦å’Œå…¶ä»–å†…å®¹ç»„åˆ
                    return videoPlaceholder + (otherContent.trim() ? '\n\n' + otherContent.trim() : '');
                }
            }

            // å¤„ç†æ ‡é¢˜
            if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) {
                const level = parseInt(tagName.charAt(1));
                let content = processChildren(node);
                return '#'.repeat(level) + ' ' + content + '\n\n';
            }

            // å¤„ç†æ®µè½
            if (tagName === 'p') {
                const content = processChildren(node);
                // ç¡®ä¿æ®µè½å†…å®¹ä»¥æ¢è¡Œç»“æŸ
                return content + '\n\n';
            }

            // å¤„ç†åˆ—è¡¨
            if (tagName === 'ul' || tagName === 'ol') {
                const listItems = Array.from(node.children)
                .filter(child => child.tagName.toLowerCase() === 'li')
                .map((li, index) => {
                    const marker = tagName === 'ul' ? '* ' : `${index + 1}. `;
                    return marker + processChildren(li);
                })
                .join('\n');
                return listItems + '\n\n';
            }

            // å¤„ç†åˆ†éš”çº¿
            if (tagName === 'hr') {
                return '---\n\n';
            }

            // å¤„ç†é“¾æ¥ - ä½¿ç”¨Markdown
            if (tagName === 'a') {
                const href = node.getAttribute('href');

                // ç‰¹æ®Šå¤„ç†ï¼šæ”¯æŒ [![alt](img)](link) æ ¼å¼ï¼ˆå³ <a><img alt=... src=...></a>ï¼‰
                // è½¬æ¢ä¸ºï¼šIMAGE_PLACEHOLDER + ç©ºè¡Œ + [alt](link)
                const imgInLink = node.querySelector('img');
                const hasOnlyImage = imgInLink && node.textContent.trim() === '';
                if (imgInLink && hasOnlyImage) {
                    const placeholder = processImage(imgInLink);
                    const alt = (imgInLink.getAttribute('alt') || '').trim();
                    if (href && alt) {
                        // å°†æ–‡æœ¬è¶…é“¾æ¥æ”¾åœ¨å›¾ç‰‡ä¸‹æ–¹
                        return placeholder + '\n\n' + `[${alt}](${href})`;
                    }
                    return placeholder;
                }

                const text = processChildren(node);

                // æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦ä¸ºç²—ä½“æ ‡ç­¾
                const hasStrongParent = node.parentNode &&
                      (node.parentNode.tagName.toLowerCase() === 'strong' ||
                       node.parentNode.tagName.toLowerCase() === 'b');
                // æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦ä¸ºæ–œä½“æ ‡ç­¾
                const hasItalicParent = node.parentNode &&
                      (node.parentNode.tagName.toLowerCase() === 'em' ||
                       node.parentNode.tagName.toLowerCase() === 'i');

                // é“¾æ¥å¡ç‰‡ç›´æ¥è½¬ä¹¦ç­¾å ä½ç¬¦
                const isLinkCard = (node.getAttribute('data-draft-type') === 'link-card') || ((node.getAttribute('class') || '').includes('LinkCard'));
                if (isLinkCard && href) {
                    const bookmarkId = `BOOKMARK_PLACEHOLDER_${bookmarkIndex++}`;
                    bookmarkData.push({ id: bookmarkId, url: href });
                    return bookmarkId;
                }

                // æ£€æŸ¥æ˜¯å¦ä¸ºé¡µé¢å†…è·³è½¬é“¾æ¥ï¼ˆé”šç‚¹é“¾æ¥ï¼‰
                const isAnchorLink = href && (
                    href.startsWith('#') ||  // ä»¥#å¼€å¤´çš„é”šç‚¹é“¾æ¥
                    href.startsWith('javascript:') ||  // JavaScripté“¾æ¥
                    href.startsWith('void(0)') ||  // void(0)é“¾æ¥
                    href === '#' ||  // ç©ºé”šç‚¹
                    href === 'javascript:void(0)'  // ç©ºJavaScripté“¾æ¥
                );

                if (isAnchorLink) {
                    // å¯¹äºé¡µé¢å†…è·³è½¬é“¾æ¥ï¼Œåªè¿”å›æ–‡å­—å†…å®¹ï¼Œä¸æå–é“¾æ¥
                    return text || '';
                }

                if (href && text) {
                    // ä½¿ç”¨Markdownæ ¼å¼çš„é“¾æ¥è¡¨ç¤ºæ³•ï¼ŒNotionå¯ä»¥æ­£ç¡®è¯†åˆ«
                    // å¦‚æœé“¾æ¥åœ¨ç²—ä½“æ ‡ç­¾å†…ï¼Œå°†ç²—ä½“æ ‡è®°æ”¾åœ¨é“¾æ¥æ–‡æœ¬å†…éƒ¨
                    if (hasStrongParent) {
                        return `[**${text}**](${href})`;
                    }
                    if (hasItalicParent) {
                        return `[*${text}*](${href})`;
                    }
                    return `[${text}](${href})`;
                }
                return text || '';
            }

            // å¤„ç†å¼ºè°ƒæ–‡æœ¬
            if (tagName === 'strong' || tagName === 'b') {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«é“¾æ¥å­å…ƒç´ 
                const hasLinkChild = node.querySelector('a');
                if (hasLinkChild) {
                    // å¦‚æœåŒ…å«é“¾æ¥ï¼Œåœ¨é“¾æ¥å¤„ç†æ—¶ä¼šå¤„ç†ç²—ä½“ï¼Œè¿™é‡Œç›´æ¥è¿”å›å­å…ƒç´ 
                    const childrenContent = processChildren(node);
                    // å¦‚æœå­å†…å®¹å·²ç»æ˜¯é“¾æ¥æ ¼å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
                    if (childrenContent.match(/\[.*?\]\(.*?\)/)) {
                        return childrenContent;
                    }
                    // å¦åˆ™æ·»åŠ ç²—ä½“æ ‡è®°
                    return '**' + childrenContent + '**';
                }
                return '**' + processChildren(node) + '**';
            }

            if (tagName === 'em' || tagName === 'i') {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«é“¾æ¥å­å…ƒç´ 
                const hasLinkChild = node.querySelector('a');
                if (hasLinkChild) {
                    // å¦‚æœåŒ…å«é“¾æ¥ï¼Œåœ¨é“¾æ¥å¤„ç†æ—¶ä¼šå¤„ç†æ–œä½“ï¼Œè¿™é‡Œç›´æ¥è¿”å›å­å…ƒç´ 
                    const childrenContent = processChildren(node);
                    // å¦‚æœå­å†…å®¹å·²ç»æ˜¯é“¾æ¥æ ¼å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
                    if (childrenContent.match(/\[.*?\]\(.*?\)/)) {
                        return childrenContent;
                    }
                    // å¦åˆ™æ·»åŠ æ–œä½“æ ‡è®°
                    return '*' + childrenContent + '*';
                }
                return '*' + processChildren(node) + '*';
            }

            // å¤„ç†å¼•ç”¨
            if (tagName === 'blockquote') {
                // ç›´æ¥å¤„ç†å­å…ƒç´ ï¼Œé¿å…æ®µè½å¤„ç†äº§ç”Ÿçš„å¤šä½™æ¢è¡Œ
                const paragraphs = Array.from(node.children)
                .filter(child => child.tagName.toLowerCase() === 'p')
                .map(p => processChildren(p).trim())
                .filter(content => content); // åªè¿‡æ»¤å®Œå…¨ç©ºçš„å†…å®¹

                const content = paragraphs
                .map(line => '> ' + line)
                .join('\n');
                return content + '\n';
            }

            // å¤„ç†figcaptionæ ‡ç­¾ - ç”¨ä½œå›¾ç‰‡æ ‡é¢˜
            if (tagName === 'figcaption') {
                const content = processChildren(node).trim();
                if (content) {
                    // å°†figcaptionå†…å®¹å­˜å‚¨ä¸ºå›¾ç‰‡æ ‡é¢˜ï¼Œä¸è¾“å‡ºåˆ°markdown
                    return '';
                }
                return '';
            }

            // å¤„ç†ä»£ç å—
            if (tagName === 'pre') {
                const codeElement = node.querySelector('code');
                const code = codeElement ? codeElement.textContent : node.textContent;
                return '```\n' + code + '\n```\n\n';
            }

            if (tagName === 'code') {
                return '`' + node.textContent + '`';
            }

            // å¤„ç†è¡¨æ ¼ (ç®€å•å¤„ç†ï¼Œä¸æ”¯æŒå®Œæ•´çš„è¡¨æ ¼æ ¼å¼)
            if (tagName === 'table') {
                // åˆ›å»ºç‰¹æ®Šæ ‡è®°ä»¥ä¾¿åç»­è½¬æ¢ä¸ºNotionè¡¨æ ¼å—
                let tableData = {
                    type: 'TABLE',
                    header: [],
                    rows: []
                };

                // å¤„ç†è¡¨å¤´
                const ths = node.querySelectorAll('th');
                if (ths.length > 0) {
                    tableData.header = Array.from(ths).map(th => processChildren(th));
                }

                // å¤„ç†è¡¨æ ¼å†…å®¹
                const rows = node.querySelectorAll('tr');
                rows.forEach((row, rowIndex) => {
                    // è·³è¿‡è¡¨å¤´è¡Œ
                    if (rowIndex === 0 && ths.length > 0) return;

                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0) {
                        const rowData = Array.from(cells).map(td => processChildren(td));
                        tableData.rows.push(rowData);
                    }
                });

                // ä»¥ç‰¹æ®Šæ ¼å¼ä¿å­˜è¡¨æ ¼æ•°æ®ï¼Œä¾›åç»­å¤„ç†
                return `TABLE_DATA_START${JSON.stringify(tableData)}TABLE_DATA_END\n\n`;
            }

            // å…¶ä»–æ ‡ç­¾ï¼Œé€’å½’å¤„ç†å­å…ƒç´ 
            return processChildren(node);
        }

        function processChildren(node) {
            let result = '';
            let lastWasImage = false;

            node.childNodes.forEach((child, index) => {
                const childResult = processNode(child);

                // æ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯å›¾ç‰‡å ä½ç¬¦
                const isImagePlaceholder = childResult.includes('IMAGE_PLACEHOLDER_');

                // å¦‚æœä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯å›¾ç‰‡ï¼Œå½“å‰èŠ‚ç‚¹æ˜¯æ–‡æœ¬ï¼Œæ·»åŠ æ¢è¡Œåˆ†éš”
                if (lastWasImage && child.nodeType === Node.TEXT_NODE && child.textContent.trim()) {
                    result += '\n\n';
                }

                // å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å›¾ç‰‡ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
                if (isImagePlaceholder && index < node.childNodes.length - 1) {
                    const nextChild = node.childNodes[index + 1];
                    // å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ä¸”æœ‰å†…å®¹ï¼Œåœ¨å›¾ç‰‡åæ·»åŠ é¢å¤–æ¢è¡Œ
                    if (nextChild && nextChild.nodeType === Node.TEXT_NODE && nextChild.textContent.trim()) {
                        result += childResult + '\n\n';
                        lastWasImage = false;
                        return;
                    }
                    // å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å…ƒç´ èŠ‚ç‚¹ï¼Œä¹Ÿæ·»åŠ æ¢è¡Œåˆ†éš”
                    else if (nextChild && nextChild.nodeType === Node.ELEMENT_NODE) {
                        result += childResult + '\n\n';
                        lastWasImage = false;
                        return;
                    }
                }

                result += childResult;
                lastWasImage = isImagePlaceholder;
            });
            return result;
        }

        // å¤„ç†ä¸»ä½“å†…å®¹
        const markdown = processChildren(doc.body);

        // ä¿®å¤è¿ç»­å¤šä¸ªæ¢è¡Œ
        const cleanedMarkdown = markdown
        .replace(/\n{3,}/g, '\n\n')
        .trim();

        // è¿”å›å¤„ç†åçš„Markdownã€å›¾ç‰‡æ•°æ®ã€è§†é¢‘æ•°æ®ä¸ä¹¦ç­¾æ•°æ®
        return {
            markdown: cleanedMarkdown,
            images: imageData,
            videos: videoData,
            bookmarks: bookmarkData
        };
    }
    // å°†å¤„ç†åçš„Markdownå’Œå›¾ç‰‡æ•°æ®è½¬æ¢ä¸ºNotionå—
    async function convertToNotionBlocks(markdownData) {
        if (!markdownData) return [];

        // è¾“å…¥å½’ä¸€åŒ–ï¼šå…è®¸ä¼ å…¥å­—ç¬¦ä¸²æˆ–ä¸å®Œæ•´å¯¹è±¡
        let normalized = markdownData;
        if (typeof markdownData === 'string') {
            normalized = { markdown: markdownData, images: [], videos: [], bookmarks: [] };
        } else if (typeof markdownData === 'object') {
            normalized = {
                markdown: markdownData.markdown || '',
                images: Array.isArray(markdownData.images) ? markdownData.images : [],
                videos: Array.isArray(markdownData.videos) ? markdownData.videos : [],
                bookmarks: Array.isArray(markdownData.bookmarks) ? markdownData.bookmarks : []
            };
        }

        const { markdown, images, videos, bookmarks } = normalized;
        const blocks = [];

        try {
            // é¢„å…ˆç»Ÿè®¡å°†è¦ä¸Šä¼ çš„å›¾ç‰‡æ€»æ•°ï¼Œç”¨äºç»Ÿä¸€è¿›åº¦æ¡åˆ†æ¯
            if (Array.isArray(images)) {
                window.__PENDING_IMAGE_COUNT__ = images.length;
            }
        } catch (e) { /* ignore */ }

        // æ™ºèƒ½å¤„ç†æ–‡å­—å†…å®¹ï¼Œæ£€æŸ¥æ ¼å¼ç±»å‹
        function processTextContent(text, lineIndex = -1) {
            if (!text || !text.trim()) return null;

            // è¿‡æ»¤æ‰å ä½ç¬¦æ–‡å­—ï¼Œé¿å…åœ¨ Notion ä¸­æ˜¾ç¤º
            let filteredText = text.trim();
            filteredText = filteredText.replace(/IMAGE_PLACEHOLDER_\d+/g, '');
            filteredText = filteredText.replace(/VIDEO_PLACEHOLDER_\d+/g, '');
            filteredText = filteredText.replace(/BOOKMARK_PLACEHOLDER_\d+/g, '');
            filteredText = filteredText.replace(/TABLE_PLACEHOLDER_\d+/g, '');

            // å¦‚æœè¿‡æ»¤åæ–‡æœ¬ä¸ºç©ºï¼Œåˆ™ä¸åˆ›å»ºå—
            if (!filteredText.trim()) return null;

            const trimmedText = filteredText.trim();

            // åˆ›å»ºå—å¯¹è±¡
            let block = null;

            // æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡é¢˜
            const headingMatch = trimmedText.match(/^(#{1,6})\s+(.+)$/);
            if (headingMatch) {
                const level = headingMatch[1].length;
                const text = headingMatch[2];
                const richTextItems = parseRichText(text);
                const headingType = level <= 3 ? `heading_${level}` : "heading_3";

                block = {
                    object: "block",
                    type: headingType,
                    [headingType]: {
                        rich_text: richTextItems
                    }
                };
            }
            // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ—è¡¨é¡¹
            else if (trimmedText.match(/^\*\s+(.+)$/)) {
                const bulletListMatch = trimmedText.match(/^\*\s+(.+)$/);
                const itemText = bulletListMatch[1];
                const richTextItems = parseRichText(itemText);

                block = {
                    object: "block",
                    type: "bulleted_list_item",
                    bulleted_list_item: {
                        rich_text: richTextItems
                    }
                };
            }
            else if (trimmedText.match(/^(\d+)\.\s+(.+)$/)) {
                const orderedListMatch = trimmedText.match(/^(\d+)\.\s+(.+)$/);
                const itemText = orderedListMatch[2];
                const richTextItems = parseRichText(itemText);

                block = {
                    object: "block",
                    type: "numbered_list_item",
                    numbered_list_item: {
                        rich_text: richTextItems
                    }
                };
            }
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¼•ç”¨
            else if (trimmedText.startsWith('> ')) {
                const quoteText = trimmedText.substring(2);
                const richTextItems = parseRichText(quoteText);

                block = {
                    object: "block",
                    type: "quote",
                    quote: {
                        rich_text: richTextItems
                    }
                };
            }
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»£ç å—
            else if (trimmedText.startsWith('```')) {
                const codeContent = trimmedText.substring(3).trim();

                // æ£€æŸ¥ä»£ç å†…å®¹é•¿åº¦ï¼ŒNotion APIé™åˆ¶ä¸º2000å­—ç¬¦
                if (codeContent.length > 2000) {
                    console.warn(`ä»£ç å—å†…å®¹è¿‡é•¿ (${codeContent.length}å­—ç¬¦)ï¼Œå°†åˆ†å‰²ä¸ºå¤šä¸ªä»£ç å—`);
                    // åˆ†å‰²é•¿ä»£ç å—
                    const chunks = splitLongText(codeContent, 2000);
                    // è¿”å›ç¬¬ä¸€ä¸ªå—ï¼Œå…¶ä½™å—å°†åœ¨å¤–å±‚å¤„ç†
                    block = {
                        object: "block",
                        type: "code",
                        code: {
                            rich_text: [{
                                type: "text",
                                text: {
                                    content: chunks[0]
                                }
                            }]
                        },
                        _remainingChunks: chunks.slice(1) // æ ‡è®°å‰©ä½™å—
                    };
                } else {
                    block = {
                        object: "block",
                        type: "code",
                        code: {
                            rich_text: [{
                                type: "text",
                                text: {
                                    content: codeContent
                                }
                            }]
                        }
                    };
                }
            }
            // é»˜è®¤ä½œä¸ºæ®µè½å¤„ç†
            else {
                const richTextItems = parseRichText(trimmedText);
                block = {
                    object: "block",
                    type: "paragraph",
                    paragraph: {
                        rich_text: richTextItems
                    }
                };
            }

            return block;
        }

        // ä½¿ç”¨ä½ç½®æ ‡è®°ä»¥ä¿æŒè¡¨æ ¼åœ¨åŸæ¥çš„ä½ç½®
        const tableDataPattern = /TABLE_DATA_START(.*?)TABLE_DATA_END/gs;
        let processedMarkdown = markdown;
        const tablePlaceholders = [];

        // å…ˆæ”¶é›†æ‰€æœ‰è¡¨æ ¼æ•°æ®å¹¶æ›¿æ¢ä¸ºå ä½ç¬¦
        let match;
        let index = 0;
        while ((match = tableDataPattern.exec(markdown)) !== null) {
            try {
                const tableDataStr = match[1];
                const tableData = JSON.parse(tableDataStr);
                if (tableData && tableData.type === 'TABLE') {
                    const placeholder = `TABLE_PLACEHOLDER_${index}`;
                    tablePlaceholders.push({
                        placeholder,
                        tableData
                    });
                    processedMarkdown = processedMarkdown.replace(match[0], placeholder);
                    index++;
                }
            } catch (e) {
                console.error('è§£æè¡¨æ ¼æ•°æ®å¤±è´¥:', e);
            }
        }

        // å¤„ç†æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬è¡¨æ ¼å ä½ç¬¦
        const lines = processedMarkdown.split('\n');

        // è§£æå¯Œæ–‡æœ¬ - å°†æ–‡æœ¬ä¸­çš„é“¾æ¥è½¬æ¢ä¸ºNotionå¯Œæ–‡æœ¬æ ¼å¼
        function parseRichText(text) {
            const richTextItems = [];
            let remainingText = text;

            // å½’ä¸€åŒ–ä¿®å¤ï¼šå°†è¢«é€—å·/ç©ºç™½æ‰“æ–­çš„æ–œç²—ä½“æ ‡è®°ä» "***æ–‡æœ¬*,**" çº æ­£ä¸º "***æ–‡æœ¬***,"
            // ç¤ºä¾‹ï¼š***æ–‡å­—*,** â†’ ***æ–‡å­—***,
            // è¿™æ ·åç»­çš„æ­£åˆ™å¯ä»¥æ­£ç¡®è¯†åˆ«ä¸ºæ–œç²—ä½“ï¼ŒåŒæ—¶ä¿ç•™æ ‡ç‚¹ä¸ºæ™®é€šæ ·å¼
            remainingText = remainingText.replace(/\*\*\*([^*]+?)\*([,ï¼Œã€‚\.ï¼!ï¼Ÿ\?ï¼š:ï¼›;\s]*)\*\*/g, '***$1***$2');

            // å¤„ç†é“¾æ¥ - Markdownæ ¼å¼ - æ”¹è¿›ç‰ˆæœ¬æ”¯æŒé•¿é“¾æ¥å’Œç‰¹æ®Šå­—ç¬¦
            // ä¿®æ”¹æ­£åˆ™è¡¨è¾¾å¼ä»¥æ›´å¥½åœ°æ”¯æŒåŒ…å«ç‰¹æ®Šå­—ç¬¦çš„é•¿é“¾æ¥ï¼Œå¦‚çŸ¥ä¹åˆ†äº«é“¾æ¥
            const linkPattern = /\[(.*?)\]\(([^\s][^)]*?)\)/g;
            // å¤„ç†æ–œç²—ä½“ (éœ€ä¼˜å…ˆäºåŠ ç²—/æ–œä½“åŒ¹é…)
            const boldItalicPattern = /(?<![\\&#\u200Bâˆ—])\*\*\*(.*?)\*\*\*/g;
            // å¤„ç†åŠ ç²—
            const boldPattern = /(?<![\\&#\u200Bâˆ—])\*\*(.*?)\*\*/g;
            // å¤„ç†æ–œä½“
            const italicPattern = /(?<![\\&#\u200Bâˆ—])\*(.*?)\*/g;
            // å¤„ç†è¡Œå†…ä»£ç 
            const codePattern = /`(.*?)`/g;

            let lastIndex = 0;

            // å…ˆæŒ‰ä½ç½®æ’åºæ‰€æœ‰åŒ¹é…é¡¹
            const allMatches = [];
            let match;

            // æ”¶é›†é“¾æ¥åŒ¹é… - Markdownæ ¼å¼ [text](url)
            while ((match = linkPattern.exec(remainingText)) !== null) {
                allMatches.push({
                    type: 'link',
                    index: match.index,
                    length: match[0].length,
                    content: match[1],
                    url: match[2]
                });
            }

            // æ”¶é›†æ–œç²—ä½“åŒ¹é…ï¼ˆä¼˜å…ˆï¼‰
            while ((match = boldItalicPattern.exec(remainingText)) !== null) {
                allMatches.push({
                    type: 'boldItalic',
                    index: match.index,
                    length: match[0].length,
                    content: match[1]
                });
            }

            // æ”¶é›†åŠ ç²—åŒ¹é…
            while ((match = boldPattern.exec(remainingText)) !== null) {
                allMatches.push({
                    type: 'bold',
                    index: match.index,
                    length: match[0].length,
                    content: match[1]
                });
            }

            // æ”¶é›†æ–œä½“åŒ¹é…
            while ((match = italicPattern.exec(remainingText)) !== null) {
                // ç¡®ä¿è¿™ä¸æ˜¯åŠ ç²—åŒ¹é…çš„ä¸€éƒ¨åˆ†
                const isBoldPart = allMatches.some(m =>
                                                   m.type === 'bold' &&
                                                   match.index >= m.index &&
                                                   match.index < m.index + m.length
                                                  );

                if (!isBoldPart) {
                    allMatches.push({
                        type: 'italic',
                        index: match.index,
                        length: match[0].length,
                        content: match[1]
                    });
                }
            }

            // æ”¶é›†è¡Œå†…ä»£ç åŒ¹é…
            while ((match = codePattern.exec(remainingText)) !== null) {
                allMatches.push({
                    type: 'code',
                    index: match.index,
                    length: match[0].length,
                    content: match[1]
                });
            }

            // æŒ‰èµ·å§‹ä½ç½®æ’åºåŒ¹é…é¡¹
            allMatches.sort((a, b) => a.index - b.index);

            // ç‰¹æ®Šå¤„ç†ç²—ä½“é“¾æ¥çš„æƒ…å†µ
            // ä¸å†ç®€å•å»é™¤æ‰€æœ‰åµŒå¥—åŒ¹é…ï¼Œè€Œæ˜¯ä¿ç•™ç²—ä½“é“¾æ¥
            for (let i = allMatches.length - 1; i >= 0; i--) {
                const current = allMatches[i];
                for (let j = 0; j < i; j++) {
                    const previous = allMatches[j];
                    // å¦‚æœæ˜¯ç²—ä½“åœ¨é“¾æ¥å†…éƒ¨ï¼Œæˆ–é“¾æ¥åœ¨ç²—ä½“å†…éƒ¨ï¼Œåˆ™ä¿ç•™ä¸¤è€…
                    const isBoldInLink = (current.type === 'bold' && previous.type === 'link');
                    const isLinkInBold = (current.type === 'link' && previous.type === 'bold');

                    if (current.index >= previous.index &&
                        current.index + current.length <= previous.index + previous.length) {
                        // å½“å‰åŒ¹é…åœ¨ä¹‹å‰åŒ¹é…çš„èŒƒå›´å†…
                        if (!isBoldInLink && !isLinkInBold) {
                            // å¦‚æœä¸æ˜¯ç²—ä½“é“¾æ¥çš„ç‰¹æ®Šæƒ…å†µï¼Œåˆ™ç§»é™¤åµŒå¥—åŒ¹é…
                            allMatches.splice(i, 1);
                            break;
                        }
                    }
                }
            }

            // æ£€æŸ¥åŒ¹é…é¡¹æ˜¯å¦é‡å 
            for (let i = allMatches.length - 1; i > 0; i--) {
                const current = allMatches[i];
                const previous = allMatches[i - 1];
                if (previous.index + previous.length > current.index) {
                    // å‘ç°é‡å ï¼Œç§»é™¤å½“å‰åŒ¹é…é¡¹
                    allMatches.splice(i, 1);
                }
            }

            // æ²¡æœ‰ä»»ä½•æ ·å¼æ ‡è®°
            if (allMatches.length === 0) {
                richTextItems.push({
                    type: "text",
                    text: {
                        content: remainingText
                    }
                });
                return richTextItems;
            }

            // å¤„ç†æ‰€æœ‰åŒ¹é…é¡¹
            lastIndex = 0;

            for (const match of allMatches) {
                // å¤„ç†åŒ¹é…å‰çš„æ™®é€šæ–‡æœ¬
                if (match.index > lastIndex) {
                    const normalText = remainingText.substring(lastIndex, match.index);
                    if (normalText) {
                        richTextItems.push({
                            type: "text",
                            text: {
                                content: normalText
                            }
                        });
                    }
                }

                // æ ¹æ®åŒ¹é…ç±»å‹å¤„ç†
                switch (match.type) {
                    case 'link':
                        try {
                            const url = match.url.trim();
                            let linkText = match.content;
                            // å¯¹é“¾æ¥æ–‡æœ¬ä¹Ÿåšä¸€æ¬¡ç›¸åŒçš„æ–œç²—ä½“æ‹†åˆ†ä¿®å¤
                            linkText = linkText.replace(/\*\*\*([^*]+?)\*([,ï¼Œã€‚\.ï¼!ï¼Ÿ\?ï¼š:ï¼›;\s]*)\*\*/g, '***$1***$2');
                            // éªŒè¯URL - ä½¿ç”¨æ›´å®½æ¾çš„éªŒè¯æ–¹å¼å¤„ç†é•¿é“¾æ¥å’Œç‰¹æ®Šå­—ç¬¦
                            // ä¸å†ä¸¥æ ¼éªŒè¯URLï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ï¼Œä»¥æ”¯æŒçŸ¥ä¹åˆ†äº«é“¾æ¥ç­‰ç‰¹æ®Šæ ¼å¼
                            // åªåšåŸºæœ¬å¤„ç†ç¡®ä¿URLæ ¼å¼åˆç†
                            let processedUrl = url;
                            if (!url.startsWith('http')) {
                                processedUrl = 'https://' + url;
                            }

                            // å³ä½¿URLåŒ…å«ç‰¹æ®Šå­—ç¬¦ä¹Ÿç»§ç»­å¤„ç†
                            try {
                                new URL(processedUrl);
                            } catch (urlError) {
                                // URLéªŒè¯å¤±è´¥ä½†ä»ç»§ç»­å¤„ç†
                                console.log('URLéªŒè¯è­¦å‘Šï¼Œä½†ä»ç»§ç»­å¤„ç†:', urlError.message);
                            }

                            // æ£€æŸ¥é“¾æ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ç²—ä½“/æ–œä½“/æ–œç²—ä½“æ ‡è®°ï¼ˆå·²å½’ä¸€åŒ–ååˆ¤æ–­ï¼‰
                            const hasBoldItalic = linkText.startsWith('***') && linkText.endsWith('***');
                            const hasBold = !hasBoldItalic && linkText.startsWith('**') && linkText.endsWith('**');
                            const hasItalic = !hasBoldItalic && linkText.startsWith('*') && linkText.endsWith('*') && !hasBold;

                            // å¦‚æœæ˜¯æ–œç²—ä½“ï¼ŒåŒæ—¶å¯èƒ½å¸¦æœ‰å°¾éšæ ‡ç‚¹ï¼š***æ–‡æœ¬***, éœ€è¦å°†æ ‡ç‚¹æ‹†åˆ†ä¸ºç‹¬ç«‹span
                            let trailingPunct = '';
                            if (hasBoldItalic) {
                                const m = linkText.match(/^\*\*\*([^*]+?)\*\*\*([,ï¼Œã€‚\.ï¼!ï¼Ÿ\?ï¼š:ï¼›;\s]*)$/);
                                if (m) {
                                    linkText = `***${m[1]}***`;
                                    trailingPunct = m[2] || '';
                                }
                            }

                            let actualText = linkText;
                            if (hasBoldItalic) {
                                actualText = actualText.substring(3, actualText.length - 3);
                            } else if (hasBold) {
                                actualText = actualText.substring(2, actualText.length - 2);
                            } else if (hasItalic) {
                                actualText = actualText.substring(1, actualText.length - 1);
                            }

                            const annotations = {};
                            if (hasBoldItalic) { annotations.bold = true; annotations.italic = true; }
                            if (hasBold) annotations.bold = true;
                            if (hasItalic) annotations.italic = true;

                            // ä¸»è¦æ–‡æœ¬ï¼ˆå¯èƒ½å¸¦æ ·å¼ï¼‰
                            richTextItems.push({
                                type: "text",
                                text: {
                                    content: actualText,
                                    link: { url: url.startsWith('http') ? url : 'https://' + url }
                                },
                                annotations: (hasBoldItalic || hasBold || hasItalic) ? annotations : undefined
                            });

                            // å¦‚æœæœ‰å°¾éšæ ‡ç‚¹ï¼Œåˆ™ä½œä¸ºæ— æ ·å¼çš„åŒä¸€é“¾æ¥è¿½åŠ 
                            if (trailingPunct) {
                                richTextItems.push({
                                    type: "text",
                                    text: {
                                        content: trailingPunct,
                                        link: { url: url.startsWith('http') ? url : 'https://' + url }
                                    }
                                });
                            }
                        } catch (e) {
                            // URLæ ¼å¼ä¸æ­£ç¡®ï¼Œä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†
                            richTextItems.push({
                                type: "text",
                                text: {
                                    content: match.content
                                }
                            });
                            console.log('è·³è¿‡æ ¼å¼é”™è¯¯çš„URL:', match.url);
                        }
                        break;

                    case 'boldItalic':
                        richTextItems.push({
                            type: "text",
                            text: {
                                content: match.content
                            },
                            annotations: {
                                bold: true,
                                italic: true
                            }
                        });
                        break;

                    case 'bold':
                        richTextItems.push({
                            type: "text",
                            text: {
                                content: match.content
                            },
                            annotations: {
                                bold: true
                            }
                        });
                        break;

                    case 'italic':
                        richTextItems.push({
                            type: "text",
                            text: {
                                content: match.content
                            },
                            annotations: {
                                italic: true
                            }
                        });
                        break;

                    case 'code':
                        richTextItems.push({
                            type: "text",
                            text: {
                                content: match.content
                            },
                            annotations: {
                                code: true
                            }
                        });
                        break;
                }

                lastIndex = match.index + match.length;
            }

            // å¤„ç†æœ€åä¸€æ®µæ™®é€šæ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
            if (lastIndex < remainingText.length) {
                richTextItems.push({
                    type: "text",
                    text: {
                        content: remainingText.substring(lastIndex)
                    }
                });
            }

            return richTextItems;
        }
        let i = 0;
        while (i < lines.length) {
            const line = lines[i].trim();

            // è·³è¿‡ç©ºè¡Œ
            if (!line) {
                i++;
                continue;
            }

            // å¤„ç†ä¹¦ç­¾å ä½ç¬¦ï¼ˆæ•´è¡Œï¼‰
            const bookmarkPlaceholder = line.match(/^BOOKMARK_PLACEHOLDER_(\d+)$/);
            if (bookmarkPlaceholder) {
                const bIndex = parseInt(bookmarkPlaceholder[1]);
                const bInfo = bookmarks && bookmarks[bIndex];
                if (bInfo && bInfo.url) {
                    // åˆ›å»ºæ–°çš„ä¹¦ç­¾å—
                    const bookmarkBlock = { object: "block", type: "bookmark", bookmark: { url: bInfo.url } };
                    blocks.push(bookmarkBlock);
                }
                i++;
                continue;
            }


            // å¤„ç†å›¾ç‰‡å ä½ç¬¦
            const imagePlaceholder = line.match(/^IMAGE_PLACEHOLDER_(\d+)$/);
            if (imagePlaceholder) {
                const imageIndex = parseInt(imagePlaceholder[1]);
                const imageInfo = images[imageIndex];

                if (imageInfo) {
                    // éªŒè¯å¹¶å¤„ç†å›¾ç‰‡URL
                    let finalImageUrl = null;
                    let shouldSkipImage = false;

                    // é¦–å…ˆéªŒè¯åŸå§‹URL
                    if (!isValidImageUrl(imageInfo.url)) {
                        console.warn('åŸå§‹å›¾ç‰‡URLæ— æ•ˆï¼Œè·³è¿‡æ­¤å›¾ç‰‡:', imageInfo.url);
                        shouldSkipImage = true;
                    } else {
                        try {
                            if (window.isUpdateMode) {
                                const processedUrl = await processImageUrl(imageInfo.url, {
                                    contentType: window.__CURRENT_CONTENT_TYPE__,
                                    skipGithubUpload: true
                                });
                                if (isValidImageUrl(processedUrl)) {
                                    finalImageUrl = processedUrl;
                                } else {
                                    finalImageUrl = imageInfo.url;
                                }
                            } else {
                                const processedUrl = await processImageUrl(imageInfo.url, {
                                    contentType: window.__CURRENT_CONTENT_TYPE__
                                });
                                // éªŒè¯å¤„ç†åçš„URL
                                if (isValidImageUrl(processedUrl)) {
                                    finalImageUrl = processedUrl;
                                } else {
                                    console.warn('å¤„ç†åçš„å›¾ç‰‡URLæ— æ•ˆï¼Œå°è¯•ä½¿ç”¨åŸå§‹URL:', processedUrl);
                                    // å†æ¬¡éªŒè¯åŸå§‹URL
                                    if (isValidImageUrl(imageInfo.url)) {
                                        finalImageUrl = imageInfo.url;
                                    } else {
                                        console.warn('åŸå§‹å›¾ç‰‡URLä¹Ÿæ— æ•ˆï¼Œè·³è¿‡æ­¤å›¾ç‰‡:', imageInfo.url);
                                        shouldSkipImage = true;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('å¤„ç†å›¾ç‰‡URLå¤±è´¥:', error, imageInfo.url);
                            // å°è¯•ä½¿ç”¨åŸå§‹URL
                            if (isValidImageUrl(imageInfo.url)) {
                                finalImageUrl = imageInfo.url;
                            } else {
                                console.warn('åŸå§‹å›¾ç‰‡URLä¹Ÿæ— æ•ˆï¼Œè·³è¿‡æ­¤å›¾ç‰‡:', imageInfo.url);
                                shouldSkipImage = true;
                            }
                        }
                    }

                    // å¦‚æœå›¾ç‰‡åº”è¯¥è¢«è·³è¿‡ï¼Œåˆ™è·³è¿‡åˆ›å»ºå›¾ç‰‡å—
                    if (shouldSkipImage) {
                        console.log('è·³è¿‡æ— æ•ˆå›¾ç‰‡ï¼Œä¸åˆ›å»ºå›¾ç‰‡å—');
                        continue;
                    }

                    // åˆ›å»ºæ–°çš„å›¾ç‰‡å—
                    const imageBlock = {
                        object: "block",
                        type: "image",
                        image: {
                            type: "external",
                            external: {
                                url: finalImageUrl
                            },
                            caption: (() => {
                                // ä¼˜å…ˆä½¿ç”¨figcaptionï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨alt
                                const captionText = imageInfo.caption || (imageInfo.alt && imageInfo.alt !== 'å›¾ç‰‡' ? imageInfo.alt : '');
                                return captionText ? [
                                    {
                                        type: "text",
                                        text: {
                                            content: captionText
                                        }
                                    }
                                ] : [];
                            })()
                        }
                    };

                    blocks.push(imageBlock);
                }

                i++;
                continue;
            }

            // å¤„ç†è§†é¢‘å ä½ç¬¦
            const videoPlaceholder = line.match(/^VIDEO_PLACEHOLDER_(\d+)$/);
            if (videoPlaceholder) {
                const videoIndex = parseInt(videoPlaceholder[1]);
                const videoInfo = videos && videos[videoIndex];

                if (videoInfo && videoInfo.url) {
                    // å¤„ç†è§†é¢‘URLï¼Œè·å–åµŒå…¥é“¾æ¥æˆ–ç›´æ¥é“¾æ¥
                    const processedVideo = processVideoUrl(videoInfo.url);
                    let videoBlock = null;

                    if (processedVideo.isEmbed) {
                        // åˆ›å»ºåµŒå…¥å—
                        videoBlock = {
                            object: "block",
                            type: "embed",
                            embed: {
                                url: processedVideo.url
                            }
                        };
                    } else {
                        // åˆ›å»ºä¹¦ç­¾å—ï¼ˆé“¾æ¥ï¼‰
                        videoBlock = {
                            object: "block",
                            type: "bookmark",
                            bookmark: {
                                url: processedVideo.url,
                                caption: videoInfo.alt ? [
                                    {
                                        type: "text",
                                        text: {
                                            content: videoInfo.alt
                                        }
                                    }
                                ] : []
                            }
                        };
                    }

                    blocks.push(videoBlock);
                }

                i++;
                continue;
            }

            // æ£€æŸ¥è¡Œå†…æ˜¯å¦åŒ…å«å›¾ç‰‡ã€è§†é¢‘æˆ–ä¹¦ç­¾å ä½ç¬¦
            if (line.includes('IMAGE_PLACEHOLDER_') || line.includes('VIDEO_PLACEHOLDER_') || line.includes('BOOKMARK_PLACEHOLDER_')) {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡å ä½ç¬¦
                if (line.includes('IMAGE_PLACEHOLDER_')) {
                    // å°†å…·æœ‰å›¾ç‰‡å ä½ç¬¦çš„è¡Œæ‹†åˆ†ä¸ºå¤šä¸ªå—
                    const segments = line.split(/IMAGE_PLACEHOLDER_\d+/);
                    const placeholders = line.match(/IMAGE_PLACEHOLDER_\d+/g) || [];

                    // ç¬¬ä¸€æ®µæ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (segments[0].trim()) {
                        const textBlock = processTextContent(segments[0]);
                        if (textBlock) {
                            blocks.push(textBlock);
                        }
                    }

                    // å¤„ç†æ¯ä¸ªå›¾ç‰‡å ä½ç¬¦
                    for (let j = 0; j < placeholders.length; j++) {
                        const placeholder = placeholders[j];
                        const imageIndex = parseInt(placeholder.replace('IMAGE_PLACEHOLDER_', ''));
                        const imageInfo = images[imageIndex];

                        if (imageInfo) {
                            // éªŒè¯å›¾ç‰‡URL
                            let finalImageUrl = null;

                            if (isValidImageUrl(imageInfo.url)) {
                                try {
                                    if (window.isUpdateMode) {
                                        const processedUrl = await processImageUrl(imageInfo.url, {
                                            contentType: window.__CURRENT_CONTENT_TYPE__,
                                            skipGithubUpload: true
                                        });
                                        finalImageUrl = isValidImageUrl(processedUrl) ? processedUrl : imageInfo.url;
                                    } else {
                                        const processedUrl = await processImageUrl(imageInfo.url, {
                                            contentType: window.__CURRENT_CONTENT_TYPE__
                                        });
                                        if (isValidImageUrl(processedUrl)) {
                                            finalImageUrl = processedUrl;
                                        } else {
                                            console.warn('å¤„ç†åçš„å›¾ç‰‡URLæ— æ•ˆï¼Œä½¿ç”¨åŸå§‹URL:', processedUrl);
                                            finalImageUrl = imageInfo.url;
                                        }
                                    }
                                } catch (error) {
                                    console.error('å¤„ç†å›¾ç‰‡URLå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹URL:', error, imageInfo.url);
                                    finalImageUrl = imageInfo.url;
                                }
                            } else {
                                console.warn('å›¾ç‰‡URLæ— æ•ˆï¼Œè·³è¿‡æ­¤å›¾ç‰‡:', imageInfo.url);
                                continue; // è·³è¿‡æ— æ•ˆå›¾ç‰‡
                            }

                            // åˆ›å»ºæ–°çš„å›¾ç‰‡å—
                            const imageBlock = {
                                object: "block",
                                type: "image",
                                image: {
                                    type: "external",
                                    external: {
                                        url: finalImageUrl
                                    },
                                    caption: (() => {
                                        // ä¼˜å…ˆä½¿ç”¨figcaptionï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨alt
                                        const captionText = imageInfo.caption || (imageInfo.alt && imageInfo.alt !== 'å›¾ç‰‡' ? imageInfo.alt : '');
                                        return captionText ? [
                                            {
                                                type: "text",
                                                text: {
                                                    content: captionText
                                                }
                                            }
                                        ] : [];
                                    })()
                                }
                            };

                            blocks.push(imageBlock);
                        }
                    }

                    // å¤„ç†å›¾ç‰‡åçš„å‰©ä½™æ–‡æœ¬ï¼Œç›´æ¥åœ¨å½“å‰å¾ªç¯ä¸­å¤„ç†ï¼Œé¿å…é‡å¤
                    const restAfterImages = segments[placeholders.length] && segments[placeholders.length].trim();
                    if (restAfterImages) {
                        const textBlock = processTextContent(restAfterImages);
                        if (textBlock) {
                            blocks.push(textBlock);
                        }
                    }
                }

                // å¤„ç†ä¹¦ç­¾å ä½ç¬¦ï¼ˆè¡Œå†…ï¼‰
                if (line.includes('BOOKMARK_PLACEHOLDER_')) {
                    const segments = line.split(/BOOKMARK_PLACEHOLDER_\d+/);
                    const placeholders = line.match(/BOOKMARK_PLACEHOLDER_\d+/g) || [];

                    if (segments[0].trim()) {
                        // è¿‡æ»¤æ‰ IMAGE_PLACEHOLDER æ–‡æœ¬
                        const cleanText = segments[0].trim().replace(/IMAGE_PLACEHOLDER_\d+/g, '').trim();
                        if (cleanText) {
                            const textBlock = processTextContent(cleanText);
                            if (textBlock) {
                                blocks.push(textBlock);
                            }
                        }
                    }

                    for (let j = 0; j < placeholders.length; j++) {
                        const bIdx = parseInt(placeholders[j].replace('BOOKMARK_PLACEHOLDER_', ''));
                        const bInfo = bookmarks && bookmarks[bIdx];
                        if (bInfo && bInfo.url) {
                            // åˆ›å»ºæ–°çš„ä¹¦ç­¾å—
                            const bookmarkBlock = { object: "block", type: "bookmark", bookmark: { url: bInfo.url } };
                            blocks.push(bookmarkBlock);
                        }
                    }

                    // å¤„ç†ä¹¦ç­¾åçš„å‰©ä½™æ–‡æœ¬ï¼Œç›´æ¥åœ¨å½“å‰å¾ªç¯ä¸­å¤„ç†ï¼Œé¿å…é‡å¤
                    const restAfterBookmarks = segments[placeholders.length] && segments[placeholders.length].trim();
                    if (restAfterBookmarks) {
                        // è¿‡æ»¤æ‰ IMAGE_PLACEHOLDER æ–‡æœ¬
                        const cleanText = restAfterBookmarks.replace(/IMAGE_PLACEHOLDER_\d+/g, '').trim();
                        if (cleanText) {
                            const textBlock = processTextContent(cleanText);
                            if (textBlock) {
                                blocks.push(textBlock);
                            }
                        }
                    }
                }

                i++;
                continue;
            }
            // æ£€æŸ¥æ˜¯å¦åŒ…å«è§†é¢‘å ä½ç¬¦
            else if (line.includes('VIDEO_PLACEHOLDER_')) {
                // å°†å…·æœ‰è§†é¢‘å ä½ç¬¦çš„è¡Œæ‹†åˆ†ä¸ºå¤šä¸ªå—
                const segments = line.split(/VIDEO_PLACEHOLDER_\d+/);
                const placeholders = line.match(/VIDEO_PLACEHOLDER_\d+/g) || [];

                // ç¬¬ä¸€æ®µæ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
                if (segments[0].trim()) {
                    const textBlock = processTextContent(segments[0]);
                    if (textBlock) {
                        blocks.push(textBlock);
                    }
                }

                // å¤„ç†æ¯ä¸ªè§†é¢‘å ä½ç¬¦å’Œåç»­æ–‡æœ¬
                for (let j = 0; j < placeholders.length; j++) {
                    const placeholder = placeholders[j];
                    const videoIndex = parseInt(placeholder.replace('VIDEO_PLACEHOLDER_', ''));
                    const videoInfo = videos && videos[videoIndex];

                    if (videoInfo && videoInfo.url) {
                        // å¤„ç†è§†é¢‘URLï¼Œè·å–åµŒå…¥é“¾æ¥æˆ–ç›´æ¥é“¾æ¥
                        const processedVideo = processVideoUrl(videoInfo.url);
                        let videoBlock = null;

                        if (processedVideo.isEmbed) {
                            // åˆ›å»ºåµŒå…¥å—
                            videoBlock = {
                                object: "block",
                                type: "embed",
                                embed: {
                                    url: processedVideo.url
                                }
                            };
                        } else {
                            // åˆ›å»ºä¹¦ç­¾å—ï¼ˆé“¾æ¥ï¼‰
                            videoBlock = {
                                object: "block",
                                type: "bookmark",
                                bookmark: {
                                    url: processedVideo.url,
                                    caption: videoInfo.alt ? [
                                        {
                                            type: "text",
                                            text: {
                                                content: videoInfo.alt
                                            }
                                        }
                                    ] : []
                                }
                            };
                        }

                        blocks.push(videoBlock);
                    }

                    // å¤„ç†è§†é¢‘åçš„æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç›´æ¥åœ¨å½“å‰å¾ªç¯ä¸­å¤„ç†ï¼Œé¿å…é‡å¤
                    if (segments[j + 1] && segments[j + 1].trim()) {
                        const textBlock = processTextContent(segments[j + 1]);
                        if (textBlock) {
                            blocks.push(textBlock);
                        }
                    }
                }

                i++;
                continue;
            }

            // å¤„ç†æ ‡é¢˜ # Heading
            const headingMatch = line.match(/^(#{1,6})\s+(.+)$/);
            if (headingMatch) {
                const textBlock = processTextContent(line);
                if (textBlock) {
                    blocks.push(textBlock);
                }
                i++;
                continue;
            }

            // å¤„ç†ä»£ç å—
            if (line.startsWith('```')) {
                let codeContent = '';
                let codeLanguage = line.slice(3).trim() || 'plain text';
                i++;

                // æ”¶é›†ä»£ç å—å†…å®¹ç›´åˆ°é‡åˆ°ç»“æŸæ ‡è®°
                while (i < lines.length && !lines[i].trim().startsWith('```')) {
                    codeContent += lines[i] + '\n';
                    i++;
                }

                if (i < lines.length) i++; // è·³è¿‡ç»“æŸæ ‡è®°

                // ç§»é™¤æœ«å°¾çš„æ¢è¡Œç¬¦
                codeContent = codeContent.trimEnd();

                // æ£€æŸ¥ä»£ç å†…å®¹é•¿åº¦ï¼ŒNotion APIé™åˆ¶ä¸º2000å­—ç¬¦
                if (codeContent.length > 2000) {
                    console.warn(`ä»£ç å—å†…å®¹è¿‡é•¿ (${codeContent.length}å­—ç¬¦)ï¼Œå°†åˆ†å‰²ä¸ºå¤šä¸ªä»£ç å—`);
                    const chunks = splitLongText(codeContent, 2000);

                    // ä¸ºæ¯ä¸ªå—åˆ›å»ºä»£ç å—
                    chunks.forEach((chunk, index) => {
                        blocks.push({
                            object: "block",
                            type: "code",
                            code: {
                                rich_text: [{
                                    type: "text",
                                    text: {
                                        content: chunk
                                    }
                                }],
                                language: codeLanguage
                            }
                        });
                    });
                } else {
                    blocks.push({
                        object: "block",
                        type: "code",
                        code: {
                            rich_text: [{
                                type: "text",
                                text: {
                                    content: codeContent
                                }
                            }],
                            language: codeLanguage
                        }
                    });
                }

                continue;
            }

            // å¤„ç†æ— åºåˆ—è¡¨
            if (line.startsWith('* ')) {
                const textBlock = processTextContent(line);
                if (textBlock) {
                    blocks.push(textBlock);
                }
                i++;
                continue;
            }

            // å¤„ç†æœ‰åºåˆ—è¡¨
            const orderedListMatch = line.match(/^(\d+)\.\s+(.+)$/);
            if (orderedListMatch) {
                const textBlock = processTextContent(line);
                if (textBlock) {
                    blocks.push(textBlock);
                }
                i++;
                continue;
            }

            // æ£€æŸ¥æ˜¯å¦ä¸ºè¡¨æ ¼å ä½ç¬¦
            if (line.match(/^TABLE_PLACEHOLDER_\d+$/)) {
                const placeholderIndex = parseInt(line.replace('TABLE_PLACEHOLDER_', ''));
                const tableInfo = tablePlaceholders.find(t => t.placeholder === line);

                if (tableInfo) {
                    // åˆ›å»ºè¡¨æ ¼å—å¹¶æ·»åŠ åˆ°blocksæ•°ç»„
                    const tableBlock = createNotionTableBlock(tableInfo.tableData);
                    if (tableBlock) {
                        blocks.push(tableBlock);
                    }
                }

                i++;
                continue;
            }

            // å¤„ç†å¼•ç”¨å—ï¼ˆè¿ç»­å¤šè¡Œä»¥ > å¼€å¤´ï¼Œ> åç©ºæ ¼å¯é€‰ï¼Œåˆå¹¶ä¸ºä¸€ä¸ª Notion å¼•ç”¨å—ï¼‰
            if (line.startsWith('>')) {
                const quoteLines = [];
                while (i < lines.length && lines[i].trim().startsWith('>')) {
                    // å»æ‰å‰ç¼€ '>'+å¯é€‰ç©ºç™½
                    const cleaned = lines[i].trim().replace(/^>\s*/, '');
                    quoteLines.push(cleaned);
                    i++;
                }
                const quoteText = quoteLines.join('\n');
                blocks.push({
                    object: "block",
                    type: "quote",
                    quote: {
                        rich_text: parseRichText(quoteText)
                    }
                });
                continue;
            }

            // å¤„ç†æ™®é€šæ®µè½
            let paragraphText = line;
            i++;
            while (i < lines.length && lines[i].trim() !== '' &&
                   !lines[i].match(/^(#{1,6}|IMAGE_PLACEHOLDER_|VIDEO_PLACEHOLDER_|```|\*\s+|\d+\.\s+|TABLE_PLACEHOLDER_)/)) {
                paragraphText += '\n' + lines[i].trim();
                i++;
            }

            // ä½¿ç”¨æ™ºèƒ½å¤„ç†å‡½æ•°å¤„ç†æ®µè½
            const textBlock = processTextContent(paragraphText);
            if (textBlock) {
                blocks.push(textBlock);
            }
        }

        return blocks;
    }

    // åˆ›å»ºNotionè¡¨æ ¼å—
    function createNotionTableBlock(tableData) {
        if (!tableData || !tableData.rows || tableData.rows.length === 0) {
            return null;
        }

        // å‡†å¤‡è¡¨æ ¼æ•°æ®
        const tableBlock = {
            object: "block",
            type: "table",
            table: {
                table_width: Math.max(
                    tableData.header ? tableData.header.length : 0,
                    tableData.rows && tableData.rows.length > 0 ? tableData.rows[0].length : 0
                ),
                has_column_header: tableData.header && tableData.header.length > 0,
                has_row_header: false,
                children: []
            }
        };

        // å¤„ç†è¡¨æ ¼å•å…ƒæ ¼å†…å®¹ï¼Œè§£æé“¾æ¥
        function processTableCell(content) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«é“¾æ¥ - Markdownæ ¼å¼
            const linkPattern = /\[(.*?)\]\(([^\s][^)]*?)\)/g;
            if (content.match(linkPattern)) {
                // æœ‰é“¾æ¥ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                const richTextItems = [];
                let lastIndex = 0;
                let match;

                while ((match = linkPattern.exec(content)) !== null) {
                    // æ·»åŠ é“¾æ¥å‰çš„æ–‡æœ¬
                    if (match.index > lastIndex) {
                        const beforeText = content.substring(lastIndex, match.index);
                        if (beforeText) {
                            richTextItems.push({
                                type: "text",
                                text: { content: beforeText }
                            });
                        }
                    }

                    // æ·»åŠ é“¾æ¥
                    // æ£€æŸ¥é“¾æ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ç²—ä½“æ ‡è®°
                    const linkText = match[1];
                    const hasBold = linkText.startsWith('**') && linkText.endsWith('**');
                    const actualText = hasBold ? linkText.substring(2, linkText.length - 2) : linkText;

                    // å¤„ç†URL - ä½¿ç”¨æ›´å®½æ¾çš„éªŒè¯æ–¹å¼ï¼Œä¸å¯Œæ–‡æœ¬å¤„ç†ä¿æŒä¸€è‡´
                    // æå–URLå¹¶å¤„ç†å‰ç¼€ï¼Œå³ä½¿åŒ…å«ç‰¹æ®Šå­—ç¬¦ä¹Ÿç»§ç»­å¤„ç†
                    let url = match[2].trim();
                    let processedUrl = url.startsWith('http') ? url : 'https://' + url;

                    // å³ä½¿URLå¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ä¹Ÿç»§ç»­å¤„ç†
                    richTextItems.push({
                        type: "text",
                        text: {
                            content: actualText,
                            link: { url: processedUrl }
                        },
                        annotations: hasBold ? { bold: true } : undefined
                    });

                    lastIndex = match.index + match[0].length;
                }

                // æ·»åŠ å‰©ä½™æ–‡æœ¬
                if (lastIndex < content.length) {
                    const afterText = content.substring(lastIndex);
                    if (afterText) {
                        richTextItems.push({
                            type: "text",
                            text: { content: afterText }
                        });
                    }
                }

                return richTextItems;
            } else {
                // æ²¡æœ‰é“¾æ¥ï¼Œç›´æ¥è¿”å›æ–‡æœ¬
                return [{ type: "text", text: { content: content } }];
            }
        }

        // æ·»åŠ è¡¨å¤´è¡Œ
        if (tableData.header && tableData.header.length > 0) {
            const headerRow = {
                type: "table_row",
                table_row: {
                    cells: tableData.header.map(header => {
                        return processTableCell(header);
                    })
                }
            };
            tableBlock.table.children.push(headerRow);
        }

        // æ·»åŠ æ•°æ®è¡Œ
        tableData.rows.forEach(rowData => {
            const row = {
                type: "table_row",
                table_row: {
                    cells: rowData.map(cell => {
                        return processTableCell(cell);
                    })
                }
            };
            tableBlock.table.children.push(row);
        });

        return tableBlock;
    }

    // éªŒè¯å›¾ç‰‡URLæ˜¯å¦æœ‰æ•ˆ
    function isValidImageUrl(url) {
        if (!url || typeof url !== 'string') return false;

        try {
            // éªŒè¯URLæ ¼å¼
            const parsedUrl = new URL(url);

            // ç¡®ä¿åè®®æ˜¯httpæˆ–https
            if (parsedUrl.protocol !== 'http:' && parsedUrl.protocol !== 'https:') {
                return false;
            }

            // æ£€æŸ¥URLé•¿åº¦ï¼Œé¿å…è¿‡é•¿çš„URL
            if (url.length > 2048) {
                console.warn('å›¾ç‰‡URLè¿‡é•¿:', url.length);
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯ç–‘å­—ç¬¦
            if (url.includes('<') || url.includes('>') || url.includes('"') || url.includes("'")) {
                console.warn('å›¾ç‰‡URLåŒ…å«å¯ç–‘å­—ç¬¦:', url);
                return false;
            }

            // æ˜ç¡®ç¦æ­¢çš„åŸŸåï¼ˆGitHub camo ä»£ç†ã€shields å¾½ç« ç­‰ï¼Œæ˜“ä¸º SVG/ä¸å¯ç›´é“¾ï¼‰
            const disallowedHosts = [
                'camo.githubusercontent.com',
                'img.shields.io',
                'shields.io',
                'codebeat.co'
            ];
            if (disallowedHosts.some(h => parsedUrl.hostname === h || parsedUrl.hostname.endsWith('.' + h))) {
                return false;
            }

            // ç‰¹å®šç½‘ç«™ç™½åå•ï¼Œè¿™äº›ç½‘ç«™çš„URLå¯èƒ½æ²¡æœ‰æ ‡å‡†å›¾ç‰‡æ‰©å±•åä½†ä»ç„¶æ˜¯æœ‰æ•ˆçš„å›¾ç‰‡
            const trustedDomains = [
                'github', 'githubusercontent', 'alicdn', 'aliyuncs',
                'qpic', 'qq.com', 'baidu.com', 'bdstatic', 'sinaimg',
                'weibo', 'doubanio', 'douban', 'qlogo', 'cloudfront',
                'amazonaws', 'googleusercontent', 'gravatar', 'gstatic',
                'bing', 'pixiv', 'pximg', 'imgur', 'wikimedia', 'wordpress',
                'wp.com', 'fbcdn', 'twimg', 'pinimg', 'naver', 'daumcdn',
                'kakaocdn', 'blogspot', 'tumblr', 'cdninstagram', 'zhimg',
                'hdslb', 'bilibili', 'bilivideo', 'acgn', 'acgnx', 'dmzj',
                'dmzjimg', 'manhuagui', 'mhgui', '36mh', 'qimiaomh', 'mhcdn',
                // æ·»åŠ æ›´å¤šå¸¸è§å›¾ç‰‡CDNå’Œç½‘ç«™
                'imgix', 'cloudinary', 'imagekit', 'fastly', 'akamaized',
                'staticflickr', 'ytimg', 'sstatic', 'unsplash', 'pexels',
                'pixabay', '500px', 'deviantart', 'artstation', 'giphy',
                'tenor', 'media.tenor', 'discordapp', 'discord', 'discordcdn',
                'telegraph', 'telegra.ph', 't.me', 'postimg', 'postimages',
                'imgbb', 'ibb.co', 'imgurl', 'imgbox', 'imageshack',
                'photobucket', 'flickr', 'staticflickr', 'smugmug',
                'i.redd.it', 'redditmedia', 'redditstatic', 'reddituploads',
                'i.imgur', 'i.stack.imgur', 'media-amazon', 'images-amazon',
                'alipayobjects', 'aliapp', 'aliyuncs', 'taobaocdn', 'tmall',
                'jd.com', 'jd.hk', '360buyimg', 'joybuy', 'suning', 'kaola'
            ];

            // æ£€æŸ¥æ˜¯å¦æ˜¯å¯ä¿¡åŸŸå
            const isTrustedDomain = trustedDomains.some(domain =>
                                                        parsedUrl.hostname.includes(domain)
                                                       );

            if (isTrustedDomain) {
                return true;
            }

            // æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ˜¯å¦æ˜¯å¸¸è§å›¾ç‰‡æ ¼å¼ï¼ˆåŒ…æ‹¬Notionæ”¯æŒå’Œä¸æ”¯æŒçš„æ ¼å¼ï¼‰
            const imageExtensions = [
                // Notionæ”¯æŒçš„æ ¼å¼
                '.jpg', '.jpeg', '.png', '.gif', '.webp',
                // Notionå¯èƒ½ä¸æ”¯æŒä½†å¸¸è§çš„æ ¼å¼
                '.bmp', '.avif', '.tiff', '.tif', '.heic', '.heif', '.jfif',
                // å…¶ä»–å¯èƒ½çš„å›¾ç‰‡æ ¼å¼
                '.ico', '.apng', '.jpe', '.jif', '.jfi', '.jp2', '.j2k', '.jpf', '.jpx', '.jpm'
            ];

            const hasImageExtension = imageExtensions.some(ext =>
                                                           parsedUrl.pathname.toLowerCase().endsWith(ext)
                                                          );

            // å¦‚æœURLæœ‰å›¾ç‰‡æ‰©å±•åï¼Œåˆ™è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„
            if (hasImageExtension) {
                return true;
            }

            // æ˜¾å¼æ‹’ç» .svgï¼ˆNotion å¤–é“¾å›¾ç‰‡ä¸å¯é /å¸¸å¤±è´¥ï¼‰
            if (parsedUrl.pathname.toLowerCase().endsWith('.svg')) {
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æŸ¥è¯¢å‚æ•°ï¼Œå¾ˆå¤šå›¾ç‰‡å¤„ç†æœåŠ¡ä½¿ç”¨æŸ¥è¯¢å‚æ•°
            if (parsedUrl.search) {
                // å¦‚æœURLåŒ…å«å¸¸è§çš„å›¾ç‰‡æŸ¥è¯¢å‚æ•°ï¼Œå¯èƒ½æ˜¯åŠ¨æ€å›¾ç‰‡
                const imageQueryParams = [
                    'image', 'img', 'pic', 'photo', 'avatar', 'thumb', 'thumbnail',
                    'width', 'height', 'w', 'h', 'size', 'resize', 'crop',
                    'quality', 'q', 'format', 'fmt', 'auto', 'fit', 'bg', 'background',
                    'cover', 'icon', 'logo', 'banner', 'header', 'preview'
                ];

                const hasImageParam = imageQueryParams.some(param =>
                                                            parsedUrl.search.toLowerCase().includes(param)
                                                           );

                if (hasImageParam) {
                    return true;
                }

                // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡æ ¼å¼è½¬æ¢å‚æ•°
                const formatParams = ['format', 'fmt', 'type', 'output', 'ext'];
                const formatValues = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'avif', 'svg', 'bmp'];

                // æ£€æŸ¥URLæ˜¯å¦åŒ…å«æ ¼å¼å‚æ•°å’Œå€¼
                for (const param of formatParams) {
                    if (parsedUrl.search.toLowerCase().includes(param)) {
                        for (const format of formatValues) {
                            if (parsedUrl.search.toLowerCase().includes(format)) {
                                return true;
                            }
                        }
                    }
                }

                // å¯¹äºæœ‰æŸ¥è¯¢å‚æ•°çš„URLï¼Œæˆ‘ä»¬æ›´å®½æ¾åœ°å¤„ç†
                return true;
            }

            // æ£€æŸ¥è·¯å¾„ä¸­æ˜¯å¦åŒ…å«å›¾ç‰‡ç›¸å…³å…³é”®è¯
            const imagePathKeywords = ['image', 'img', 'picture', 'pic', 'photo', 'avatar', 'thumb', 'thumbnail', 'cover'];
            const hasImageKeyword = imagePathKeywords.some(keyword =>
                                                           parsedUrl.pathname.toLowerCase().includes(keyword)
                                                          );

            if (hasImageKeyword) {
                return true;
            }

            // å¯¹äºå…¶ä»–æƒ…å†µï¼Œæ›´ä¸¥æ ¼åœ°éªŒè¯
            // æ£€æŸ¥URLæ˜¯å¦åŒ…å«æ˜æ˜¾çš„éå›¾ç‰‡å†…å®¹æ ‡è¯†
            const nonImageKeywords = ['text', 'html', 'css', 'js', 'json', 'xml', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'];
            const hasNonImageKeyword = nonImageKeywords.some(keyword =>
                                                             parsedUrl.pathname.toLowerCase().includes(keyword)
                                                            );

            if (hasNonImageKeyword) {
                return false;
            }

            // æ£€æŸ¥URLæ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦æˆ–ç¼–ç 
            if (url.includes('%') && url.length > 200) {
                console.warn('å›¾ç‰‡URLåŒ…å«ç¼–ç å­—ç¬¦ä¸”è¿‡é•¿ï¼Œå¯èƒ½æ— æ•ˆ:', url);
                return false;
            }

            // å¯¹äºæ²¡æœ‰æ˜ç¡®å›¾ç‰‡æ ‡è¯†çš„URLï¼Œé»˜è®¤æ‹’ç»
            return false;
        } catch (e) {
            console.error('å›¾ç‰‡URLéªŒè¯å¤±è´¥:', e);
            return false;
        }
    }

    // æµ‹è¯•å›¾ç‰‡URLæ˜¯å¦çœŸçš„å¯ä»¥è®¿é—®
    async function testImageUrl(url) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = url;
            // è®¾ç½®è¶…æ—¶
            setTimeout(() => resolve(false), 5000);
        });
    }
    // éªŒè¯è§†é¢‘URLæ˜¯å¦æœ‰æ•ˆ
    function isValidVideoUrl(url) {
        if (!url) return false;

        try {
            // éªŒè¯URLæ ¼å¼
            const parsedUrl = new URL(url);

            // ç¡®ä¿åè®®æ˜¯httpæˆ–https
            if (parsedUrl.protocol !== 'http:' && parsedUrl.protocol !== 'https:') {
                return false;
            }

            // è§†é¢‘ç½‘ç«™åŸŸååˆ—è¡¨
            const videoDomains = [
                'youtube.com', 'youtu.be', 'youtube-nocookie.com',
                'bilibili.com', 'b23.tv', 'bilivideo.com',
                'vimeo.com', 'dailymotion.com', 'twitch.tv',
                'facebook.com', 'fb.watch', 'fb.com',
                'twitter.com', 'x.com', 't.co',
                'tiktok.com', 'douyin.com',
                'instagram.com', 'instagr.am',
                'nicovideo.jp', 'nico.ms',
                'youku.com', 'iqiyi.com', 'qq.com', 'v.qq.com',
                'tudou.com', 'mgtv.com', 'sohu.com', 'pptv.com',
                'acfun.cn', 'kuaishou.com', 'huya.com', 'douyu.com',
                'vdn6.vzuu.com', 'vzuu.com', 'zhihu.com'  // çŸ¥ä¹è§†é¢‘åŸŸå
            ];

            const hostname = parsedUrl.hostname;
            const isVideoDomain = videoDomains.some(domain =>
                                                    hostname === domain || hostname.endsWith('.' + domain)
                                                   );

            if (isVideoDomain) {
                return true;
            }

            // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
            const pathname = parsedUrl.pathname.toLowerCase();
            const videoExtensions = ['.mp4', '.webm', '.ogg', '.mov', '.avi', '.wmv', '.flv', '.mkv', '.m3u8'];
            const hasValidExtension = videoExtensions.some(ext => pathname.endsWith(ext));

            if (hasValidExtension) {
                return true;
            }

            // æ£€æŸ¥è·¯å¾„ä¸­æ˜¯å¦åŒ…å«è§†é¢‘ç›¸å…³å…³é”®è¯
            const videoPathKeywords = ['video', 'watch', 'player', 'embed', 'movie', 'play', 'stream', 'v', 'vid'];
            const hasVideoKeyword = videoPathKeywords.some(keyword => pathname.includes(keyword));

            if (hasVideoKeyword) {
                return true;
            }

            // æ£€æŸ¥æŸ¥è¯¢å‚æ•°ä¸­æ˜¯å¦åŒ…å«è§†é¢‘ç›¸å…³å…³é”®è¯
            const queryParams = parsedUrl.search.toLowerCase();
            const hasVideoQueryParam = videoPathKeywords.some(keyword => queryParams.includes(keyword));
            const hasVideoIdParam = queryParams.includes('v=') || queryParams.includes('vid=') || queryParams.includes('video_id=');

            return hasVideoQueryParam || hasVideoIdParam;

        } catch (e) {
            console.error('éªŒè¯è§†é¢‘URLå¤±è´¥:', e);
            return false;
        }
    }
    // å¤„ç†è§†é¢‘URLï¼Œç”ŸæˆåµŒå…¥é“¾æ¥æˆ–ç›´æ¥é“¾æ¥
    function processVideoUrl(videoUrl) {
        if (!videoUrl || !isValidVideoUrl(videoUrl)) {
            return { url: videoUrl, isEmbed: false };
        }

        try {
            const parsedUrl = new URL(videoUrl);
            const hostname = parsedUrl.hostname;

            // YouTubeè§†é¢‘å¤„ç†
            if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) {
                let videoId = '';

                if (hostname.includes('youtube.com')) {
                    // ä»youtube.com/watch?v=VIDEO_IDè·å–è§†é¢‘ID
                    const params = new URLSearchParams(parsedUrl.search);
                    videoId = params.get('v');
                } else if (hostname.includes('youtu.be')) {
                    // ä»youtu.be/VIDEO_IDè·å–è§†é¢‘ID
                    videoId = parsedUrl.pathname.substring(1);
                }

                if (videoId) {
                    const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    return { url: embedUrl, isEmbed: true, originalUrl: videoUrl };
                }
            }

            // Bilibiliè§†é¢‘å¤„ç†
            else if (hostname.includes('bilibili.com') || hostname.includes('b23.tv')) {
                let videoId = '';
                let page = '1';

                if (parsedUrl.pathname.includes('/video/')) {
                    // ä»bilibili.com/video/BV1xx411c7mDè·å–è§†é¢‘ID
                    videoId = parsedUrl.pathname.split('/video/')[1].split('/')[0];

                    // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†P
                    const params = new URLSearchParams(parsedUrl.search);
                    if (params.has('p')) {
                        page = params.get('p');
                    }
                }

                if (videoId) {
                    const embedUrl = `https://player.bilibili.com/player.html?bvid=${videoId}&page=${page}`;
                    return { url: embedUrl, isEmbed: true, originalUrl: videoUrl };
                }
            }

            // Vimeoè§†é¢‘å¤„ç†
            else if (hostname.includes('vimeo.com')) {
                const videoId = parsedUrl.pathname.substring(1);
                if (videoId && !isNaN(videoId)) {
                    const embedUrl = `https://player.vimeo.com/video/${videoId}`;
                    return { url: embedUrl, isEmbed: true, originalUrl: videoUrl };
                }
            }

            // çŸ¥ä¹è§†é¢‘å¤„ç†
            else if (hostname.includes('vdn6.vzuu.com') || hostname.includes('vzuu.com')) {
                // çŸ¥ä¹è§†é¢‘ç›´æ¥ä½¿ç”¨åŸå§‹URLï¼ŒNotionå¯ä»¥åµŒå…¥
                return { url: videoUrl, isEmbed: true, originalUrl: videoUrl };
            }

            // å…¶ä»–è§†é¢‘ç½‘ç«™å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ å¤„ç†é€»è¾‘

            // é»˜è®¤è¿”å›åŸå§‹URLï¼Œä¸åµŒå…¥
            return { url: videoUrl, isEmbed: false, originalUrl: videoUrl };

        } catch (e) {
            console.error('å¤„ç†è§†é¢‘URLå¤±è´¥:', e);
            return { url: videoUrl, isEmbed: false };
        }
    }

    // å¤„ç†å›¾ç‰‡é“¾æ¥ï¼Œæ ¹æ®é…ç½®é€‰æ‹©ä½¿ç”¨åŸå§‹é“¾æ¥è¿˜æ˜¯ä¸Šä¼ åˆ°GitHubå›¾åºŠ
    async function processImageUrl(imageUrl, options = {}) {
        // é»˜è®¤é€‰é¡¹
        const defaultOptions = {
            isCover: false,         // æ˜¯å¦æ˜¯å°é¢å›¾ç‰‡
            forceUseGithub: false,  // å¼ºåˆ¶ä½¿ç”¨GitHubå›¾åºŠ
            forceUseOriginal: false, // å¼ºåˆ¶ä½¿ç”¨åŸå§‹é“¾æ¥
            skipGithubUpload: false, // è·³è¿‡GitHubä¸Šä¼ ï¼ˆç”¨äºæ›´æ–°æ¨¡å¼ï¼‰
            contentType: null       // å†…å®¹ç±»å‹ï¼ˆcomicã€novelã€clipï¼‰
        };

        // åˆå¹¶é€‰é¡¹
        const finalOptions = { ...defaultOptions, ...options };

        // è°ƒè¯•æ—¥å¿—
        console.log('processImageUrl è¢«è°ƒç”¨:', {
            imageUrl: imageUrl.substring(0, 100) + '...',
            options: finalOptions,
            isUpdateMode: window.isUpdateMode,
            timestamp: new Date().toISOString()
        });

        // æ£€æŸ¥æ˜¯å¦æ˜¯å°é¢å›¾ç‰‡ï¼Œå¦‚æœæ˜¯å°é¢å›¾ç‰‡ä¸”å·²ç»å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
        if (finalOptions.isCover) {
            // å°é¢å›¾ç‰‡å¤„ç†é€»è¾‘
            return await processCoverImage(imageUrl, finalOptions);
        }

        // å†…å®¹å›¾ç‰‡å¤„ç†é€»è¾‘
        return await processContentImage(imageUrl, finalOptions);
    }

    // æ£€æµ‹æ˜¯å¦ä¸ºNotion GitHubé“¾æ¥
    function isNotionGithubUrl(url) {
        if (!url) return false;

        // æ£€æŸ¥æ˜¯å¦æ˜¯Notionå›¾ç‰‡é“¾æ¥ä¸”åŒ…å«GitHubé“¾æ¥
        if (url.includes('notion.so/image/') && url.includes('raw.githubusercontent.com')) {
            return true;
        }

        return false;
    }

    // ä»Notion GitHubé“¾æ¥ä¸­æå–åŸå§‹GitHubé“¾æ¥
    function extractGithubUrlFromNotion(notionUrl) {
        try {
            // è§£ç URL
            const decodedUrl = decodeURIComponent(notionUrl);

            // æŸ¥æ‰¾GitHubé“¾æ¥
            const githubMatch = decodedUrl.match(/https%3A%2F%2Fraw\.githubusercontent\.com[^&]+/);
            if (githubMatch) {
                // å†æ¬¡è§£ç 
                return decodeURIComponent(githubMatch[0]);
            }
        } catch (e) {
            console.error('æå–GitHubé“¾æ¥å¤±è´¥:', e);
        }

        return null;
    }

    // æ£€æµ‹æ˜¯å¦ä¸ºGitHubå›¾åºŠé“¾æ¥ï¼ˆåŒ…æ‹¬Notionå¤„ç†åçš„é“¾æ¥ï¼‰
    function isGitHubImageUrl(url) {
        if (!url) return false;

        // è§£ç URL
        let decodedUrl = url;
        try {
            decodedUrl = decodeURIComponent(url);
        } catch (e) {
            decodedUrl = url;
        }

        // æ£€æŸ¥å„ç§GitHubå›¾åºŠé“¾æ¥æ ¼å¼
        const githubPatterns = [
            'raw.githubusercontent.com',
            'githubusercontent.com',
            'github.com/.*?/raw/',
            '%2Fraw.githubusercontent.com',
            '%2Fgithubusercontent.com'
        ];

        // æ£€æŸ¥åŸå§‹URLå’Œè§£ç åçš„URL
        for (const pattern of githubPatterns) {
            const regex = new RegExp(pattern, 'i');
            if (regex.test(url) || regex.test(decodedUrl)) {
                return true;
            }
        }

        // ç‰¹åˆ«æ£€æŸ¥Notionå¤„ç†åçš„GitHubé“¾æ¥
        if (url.includes('notion.so/image/')) {
            // æ£€æŸ¥URLä¸­æ˜¯å¦åŒ…å«GitHubå›¾åºŠé“¾æ¥
            const notionGithubPatterns = [
                'raw.githubusercontent.com',
                'githubusercontent.com',
                '%2Fraw.githubusercontent.com',
                '%2Fgithubusercontent.com'
            ];

            for (const pattern of notionGithubPatterns) {
                if (url.includes(pattern)) {
                    return true;
                }
            }
        }

        return false;
    }

    function isJsDelivrImageUrl(url) {
        if (!url) return false;
        let u = url;
        try { u = decodeURIComponent(url); } catch (_) {}
        return /cdn\.jsdelivr\.net\/gh\//i.test(u);
    }

    function convertGitHubUrlToJsDelivr(url) {
        if (!url) return url;
        let u = url;
        try { u = decodeURIComponent(url); } catch (_) {}
        if (/cdn\.jsdelivr\.net\/gh\//i.test(u)) return u;
        if (/raw\.githubusercontent\.com\//i.test(u)) {
            const m = u.match(/raw\.githubusercontent\.com\/([^\/]+)\/([^\/]+)\/([^\/]+)\/(.+)/i);
            if (m) {
                const user = m[1];
                const repo = m[2];
                const branch = m[3];
                const path = m[4];
                return `https://cdn.jsdelivr.net/gh/${user}/${repo}@${branch}/${path}`;
            }
        }
        if (/github\.io\//i.test(u)) {
            const m = u.match(/https?:\/\/([^\.]+)\.github\.io\/([^\/]+)\/(.+)/i);
            if (m) {
                const user = m[1];
                const repo = m[2];
                const path = m[3];
                const branch = typeof GITHUB_CONFIG !== 'undefined' && GITHUB_CONFIG.branch ? GITHUB_CONFIG.branch : 'main';
                return `https://cdn.jsdelivr.net/gh/${user}/${repo}@${branch}/${path}`;
            }
        }
        if (/notion\.so\/image\//i.test(u)) {
            const inner = extractGithubUrlFromNotion(u);
            if (inner) {
                return convertGitHubUrlToJsDelivr(inner);
            }
        }
        return url;
    }

    function rewriteGithubImagePath(url, contentType, imageType) {
        if (!url || !isGitHubImageUrl(url)) return url;
        let inner = url;
        try {
            if (/notion\.so\/image\//i.test(inner)) {
                const gh = extractGithubUrlFromNotion(inner);
                if (gh) inner = gh;
            }
        } catch (_) {}
        let fileName = '';
        try {
            const u = new URL(inner);
            const name = (u.pathname.split('/').pop() || '').split('?')[0];
            fileName = decodeURIComponent(name);
        } catch (_) {
            const m = String(inner).match(/[^\/]+$/);
            fileName = m ? m[0].split('?')[0] : '';
        }
        if (!fileName) return url;
        const basePath = (getContentModePath(contentType || 'clip', imageType || 'content') || '').replace(/^\/+|\/+$/g, '');
        const encodedPath = encodeURIComponent(basePath).replace(/%2F/g, '/');
        const encodedFileName = encodeURIComponent(fileName);
        let next = '';
        const t = DOMAIN_GITHUB_CONFIG.type;
        if (t === 'pages') {
            next = `https://${GITHUB_CONFIG.username}.github.io/${GITHUB_CONFIG.repo}/${encodedPath}/${encodedFileName}`;
        } else if (t === 'custom' && DOMAIN_GITHUB_CONFIG.customDomain) {
            next = `https://${DOMAIN_GITHUB_CONFIG.customDomain}/${encodedPath}/${encodedFileName}`;
        } else {
            next = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${encodedPath}/${encodedFileName}`;
        }
        if (GM_getValue('use_jsdelivr_acceleration', false)) {
            next = convertGitHubUrlToJsDelivr(next);
        }
        return next;
    }

    async function imageUrlLoads(url) {
        return await new Promise((resolve) => {
            try {
                const img = new Image();
                const timer = setTimeout(() => { resolve(false); }, 6000);
                img.onload = function() { clearTimeout(timer); resolve(true); };
                img.onerror = function() { clearTimeout(timer); resolve(false); };
                img.src = url + (url.includes('?') ? '&' : '?') + '_nc=' + Date.now();
            } catch (_) { resolve(false); }
        });
    }

    // æ£€æµ‹æ˜¯å¦ä¸ºbase64æ ¼å¼çš„å›¾ç‰‡URL
    function isBase64ImageUrl(url) {
        if (!url || typeof url !== 'string') return false;
        // æ£€æŸ¥æ˜¯å¦æ˜¯data:imageå¼€å¤´çš„base64æ ¼å¼
        return url.trim().startsWith('data:image/');
    }

    // æ£€æµ‹base64å›¾ç‰‡æ˜¯å¦æ˜¯çº¯ç™½è‰²ï¼ˆé€šè¿‡æ£€æŸ¥base64æ•°æ®ï¼‰
    async function isWhiteBase64Image(url) {
        if (!isBase64ImageUrl(url)) return false;

        try {
            // æå–base64æ•°æ®éƒ¨åˆ†
            const base64Data = url.split(',')[1];
            if (!base64Data) return false;

            // è§£ç base64æ•°æ®
            const binaryString = atob(base64Data);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯çº¯ç™½è‰²å›¾ç‰‡
            // çº¯ç™½è‰²å›¾ç‰‡çš„base64æ•°æ®é€šå¸¸å¾ˆçŸ­ï¼Œæˆ–è€…æ‰€æœ‰åƒç´ éƒ½æ˜¯ç™½è‰²(255,255,255)
            // å¯¹äºå°å°ºå¯¸çš„çº¯ç™½è‰²å›¾ç‰‡ï¼Œbase64æ•°æ®å¯èƒ½å¾ˆçŸ­
            // å¯¹äºå¤§å°ºå¯¸çš„çº¯ç™½è‰²å›¾ç‰‡ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥å‰å‡ ä¸ªåƒç´ 

            // ç®€å•æ£€æŸ¥ï¼šå¦‚æœbase64æ•°æ®å¾ˆçŸ­ï¼Œå¯èƒ½æ˜¯çº¯ç™½è‰²å ä½å›¾
            if (base64Data.length < 200) {
                // å°è¯•æ£€æŸ¥å‰å‡ ä¸ªåƒç´ æ˜¯å¦éƒ½æ˜¯ç™½è‰²
                // å¯¹äºPNG/JPEGï¼Œå‰å‡ ä¸ªå­—èŠ‚æ˜¯æ–‡ä»¶å¤´ï¼Œæˆ‘ä»¬éœ€è¦è·³è¿‡
                // è¿™é‡Œé‡‡ç”¨æ›´ç®€å•çš„æ–¹æ³•ï¼šæ£€æŸ¥base64æ•°æ®æ˜¯å¦åŒ…å«å¤§é‡é‡å¤çš„ç™½è‰²åƒç´ ç¼–ç 
                // çº¯ç™½è‰²å›¾ç‰‡çš„base64é€šå¸¸åŒ…å«å¤§é‡é‡å¤çš„å­—ç¬¦ï¼ˆå¦‚Aã€Qç­‰è¡¨ç¤ºç™½è‰²ï¼‰
                const whitePatterns = ['A', 'Q', 'I', 'g', 'w'];
                let whiteCharCount = 0;
                for (let i = 0; i < Math.min(100, base64Data.length); i++) {
                    if (whitePatterns.includes(base64Data[i])) {
                        whiteCharCount++;
                    }
                }
                // å¦‚æœè¶…è¿‡80%çš„å­—ç¬¦æ˜¯ç™½è‰²ç›¸å…³å­—ç¬¦ï¼Œå¯èƒ½æ˜¯çº¯ç™½è‰²å›¾ç‰‡
                if (whiteCharCount / Math.min(100, base64Data.length) > 0.8) {
                    return true;
                }
            }

            // æ›´å‡†ç¡®çš„æ–¹æ³•ï¼šåŠ è½½å›¾ç‰‡å¹¶æ£€æŸ¥åƒç´ 
            return await checkImageIsWhiteByPixels(url);
        } catch (e) {
            console.error('æ£€æµ‹base64çº¯ç™½è‰²å›¾ç‰‡å¤±è´¥:', e);
            // å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œå°è¯•é€šè¿‡åŠ è½½å›¾ç‰‡æ£€æŸ¥
            return await checkImageIsWhiteByPixels(url);
        }
    }

    // é€šè¿‡åŠ è½½å›¾ç‰‡æ£€æŸ¥æ˜¯å¦æ˜¯çº¯ç™½è‰²ï¼ˆé€‚ç”¨äºbase64å’ŒURLï¼‰
    async function checkImageIsWhiteByPixels(imageUrl) {
        return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';

            const timeout = setTimeout(() => {
                resolve(false); // è¶…æ—¶è¿”å›false
            }, 5000);

            img.onload = function() {
                clearTimeout(timeout);
                try {
                    // åˆ›å»ºcanvasæ¥æ£€æŸ¥åƒç´ 
                    const canvas = document.createElement('canvas');
                    canvas.width = Math.min(img.width, 100); // é™åˆ¶æ£€æŸ¥å°ºå¯¸ä»¥æé«˜æ€§èƒ½
                    canvas.height = Math.min(img.height, 100);
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // è·å–å›¾åƒæ•°æ®
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // æ£€æŸ¥æ‰€æœ‰åƒç´ æ˜¯å¦éƒ½æ˜¯ç™½è‰²æˆ–æ¥è¿‘ç™½è‰²
                    let whitePixelCount = 0;
                    const totalPixels = canvas.width * canvas.height;

                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç™½è‰²æˆ–æ¥è¿‘ç™½è‰²ï¼ˆå…è®¸å¾ˆå°çš„åå·®ï¼‰
                        if (r >= 250 && g >= 250 && b >= 250) {
                            whitePixelCount++;
                        }
                    }

                    // å¦‚æœè¶…è¿‡95%çš„åƒç´ æ˜¯ç™½è‰²ï¼Œè®¤ä¸ºæ˜¯çº¯ç™½è‰²å›¾ç‰‡
                    const whiteRatio = whitePixelCount / totalPixels;
                    resolve(whiteRatio > 0.95);
                } catch (e) {
                    console.error('æ£€æŸ¥å›¾ç‰‡åƒç´ å¤±è´¥:', e);
                    resolve(false);
                }
            };

            img.onerror = function() {
                clearTimeout(timeout);
                resolve(false);
            };

            img.src = imageUrl;
        });
    }

    // æ£€æµ‹å›¾ç‰‡æ˜¯å¦æ˜¯çº¯ç™½è‰²ï¼ˆç»Ÿä¸€å…¥å£å‡½æ•°ï¼‰
    async function isWhiteImage(url) {
        if (!url) return false;

        // å¦‚æœæ˜¯base64æ ¼å¼ï¼Œä½¿ç”¨ä¸“é—¨çš„æ£€æµ‹æ–¹æ³•
        if (isBase64ImageUrl(url)) {
            return await isWhiteBase64Image(url);
        }

        // å¦‚æœæ˜¯æ™®é€šURLï¼Œé€šè¿‡åŠ è½½å›¾ç‰‡æ£€æŸ¥
        return await checkImageIsWhiteByPixels(url);
    }

    // æµ‹è¯•GitHubé“¾æ¥æ£€æµ‹å‡½æ•°ï¼ˆè°ƒè¯•ç”¨ï¼‰
    function testGitHubDetection() {
        const testUrls = [
            'https://raw.githubusercontent.com/user/repo/main/image.jpg',
            'https://github.com/user/repo/raw/main/image.jpg',
            'https://www.notion.so/image/https%3A%2F%2Fraw.githubusercontent.com%2Fpipiorange030%2Fphotoroom-public%2Fmain%2Fimages%2F%2F1758366962032_5o4dux.jpg?id=264a720b-00a6-81fd-9003-c09f3e8d8d51&table=block&spaceId=0b200f9c-d086-402c-8eff-c7a34ebf0bdb&width=2000&userId=d5321573-2738-4c83-9ecf-94445796e28d&cache=v2',
            'https://example.com/image.jpg',
            'https://githubusercontent.com/user/repo/image.jpg'
        ];

        console.log('GitHubé“¾æ¥æ£€æµ‹æµ‹è¯•:');
        testUrls.forEach(url => {
            const result = isGitHubImageUrl(url);
            console.log(`${result ? 'âœ“' : 'Ã—'} ${url.substring(0, 80)}...`);
        });
    }

    function cacheCoverResult(coverKey, finalUrl) {
        if (!coverKey) return finalUrl;
        if (finalUrl) {
            COVER_PROCESSING_STATE.processedCovers.add(coverKey);
            COVER_PROCESSING_STATE.processedCoverResults.set(coverKey, finalUrl);
        }
        return finalUrl;
    }
    function maybeRequestAutoUpdateAfterCoverUpload() {
        const knownNotionPage = window.isUpdateMode
        || (typeof isPageExistsInNotion !== 'undefined' && isPageExistsInNotion)
        || (typeof existingPageIdCache !== 'undefined' && !!existingPageIdCache)
        || (typeof window._existingNotionCoverUrl !== 'undefined' && !!window._existingNotionCoverUrl);
        if (!knownNotionPage) {
            console.log('å°é¢ä¸Šä¼ æˆåŠŸï¼Œä½†å°šæœªç¡®è®¤Notioné¡µé¢å­˜åœ¨ï¼Œæš‚ä¸è§¦å‘è‡ªåŠ¨æ›´æ–°');
            return;
        }
        if (coverUploadTriggeredAutoUpdate) return;
        if (autoUpdateTriggeredByDataChange) {
            console.log('å°é¢ä¸Šä¼ æˆåŠŸï¼Œä½†å·²æœ‰å…¶ä»–æ•°æ®å˜åŒ–è§¦å‘çš„è‡ªåŠ¨æ›´æ–°ï¼Œè·³è¿‡é‡å¤è§¦å‘');
            return;
        }
        coverUploadTriggeredAutoUpdate = true;
        autoUpdateTriggeredByDataChange = true;
        autoUpdateSuspendedDueToCover = true;
        if (typeof autoUpdateDebounceTimer !== 'undefined' && autoUpdateDebounceTimer) {
            clearTimeout(autoUpdateDebounceTimer);
            autoUpdateDebounceTimer = null;
        }
        pendingAutoUpdateReason = null;
        console.log('å°é¢ä¸Šä¼ æˆåŠŸï¼Œè§¦å‘è‡ªåŠ¨æ›´æ–°ä»¥åŒæ­¥Notionå°é¢');
        requestAutoUpdate('cover-upload', 500);
    }

    // å¤„ç†å°é¢å›¾ç‰‡
    async function processCoverImage(imageUrl, options) {
        const existingCoverUrl = window.isUpdateMode ? (window._existingNotionCoverUrl || '') : '';
        const coverKey = `${window.location.href}_${imageUrl || 'invalid-cover'}`;

        const cachedResult = COVER_PROCESSING_STATE.processedCoverResults.get(coverKey);
        if (cachedResult) {
            console.log('å°é¢å·²å¤„ç†è¿‡ï¼Œå¤ç”¨ç¼“å­˜ç»“æœ:', cachedResult);
            return cachedResult;
        }

        // æ£€æŸ¥ç°æœ‰å°é¢æ˜¯å¦æ˜¯base64çº¯ç™½è‰²ï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦æ›¿æ¢
        if (window.isUpdateMode && existingCoverUrl) {
            if (isGitHubImageUrl(existingCoverUrl)) {
                let rewritten = rewriteGithubImagePath(existingCoverUrl, options.contentType, 'cover');
                const useJsdelivr = GM_getValue('use_jsdelivr_acceleration', false);
                if (useJsdelivr && !isJsDelivrImageUrl(rewritten)) {
                    rewritten = convertGitHubUrlToJsDelivr(rewritten);
                }
                if (await imageUrlLoads(rewritten)) {
                    return cacheCoverResult(coverKey, rewritten);
                }
            } else if (isJsDelivrImageUrl(existingCoverUrl)) {
                if (await imageUrlLoads(existingCoverUrl)) {
                    return cacheCoverResult(coverKey, existingCoverUrl);
                }
            }

            // å¦‚æœç°æœ‰å°é¢æ˜¯base64çº¯ç™½è‰²ï¼Œéœ€è¦æ›¿æ¢
            if (isBase64ImageUrl(existingCoverUrl)) {
                const isWhite = await isWhiteImage(existingCoverUrl);
                if (isWhite) {
                    console.log('æ›´æ–°æ¨¡å¼ï¼šæ£€æµ‹åˆ°ç°æœ‰å°é¢æ˜¯base64çº¯ç™½è‰²ï¼Œéœ€è¦æ›¿æ¢');
                    if (isValidImageUrl(imageUrl)) {
                        imageUrl = imageUrl;
                    } else {
                        try {
                            const fallback = extractImageUrl(document.body);
                            if (fallback && isValidImageUrl(fallback)) {
                                imageUrl = fallback;
                            } else {
                                return cacheCoverResult(coverKey, existingCoverUrl);
                            }
                        } catch (_) {
                            return cacheCoverResult(coverKey, existingCoverUrl);
                        }
                    }
                }
            }
        }

        // å¦‚æœå›¾ç‰‡URLæ— æ•ˆï¼Œä¼˜å…ˆå›é€€åˆ°Notionä¸­å·²æœ‰çš„å°é¢
        if (!isValidImageUrl(imageUrl)) {
            if (existingCoverUrl) {
                if (COVER_BED_CONFIG.enabled && isBase64ImageUrl(existingCoverUrl)) {
                    const isWhite = await isWhiteImage(existingCoverUrl);
                    if (isWhite) {
                        console.log('æ›´æ–°æ¨¡å¼ï¼šæœªæå–åˆ°æœ‰æ•ˆå°é¢ï¼Œä½†ç°æœ‰å°é¢æ˜¯base64çº¯ç™½è‰²ï¼Œä¸æ²¿ç”¨');
                        return cacheCoverResult(coverKey, imageUrl);
                    }
                }
                console.log('æ›´æ–°æ¨¡å¼ï¼šæœªæå–åˆ°æœ‰æ•ˆå°é¢ï¼Œæ²¿ç”¨Notionå°é¢');
                const out = (!COVER_BED_CONFIG.enabled && isValidImageUrl(existingCoverUrl)) ? getProxyUrl(existingCoverUrl) : existingCoverUrl;
                return cacheCoverResult(coverKey, out);
            }
            return cacheCoverResult(coverKey, imageUrl);
        }

        // æ£€æŸ¥æ˜¯å¦æ¥è‡ªå…¶ä»–æ ‡ç­¾é¡µï¼ˆåªå¤„ç†å½“å‰æ ‡ç­¾é¡µçš„å°é¢ï¼‰
        if (COVER_PROCESSING_STATE.currentPageUrl !== window.location.href) {
            console.log('æ£€æµ‹åˆ°é¡µé¢URLå˜åŒ–ï¼Œé‡ç½®å°é¢å¤„ç†çŠ¶æ€');
            COVER_PROCESSING_STATE.processedCovers.clear();
            COVER_PROCESSING_STATE.processedCoverResults.clear();
            COVER_PROCESSING_STATE.currentPageUrl = window.location.href;
        }

        // å¦‚æœå°é¢å·²æ˜¯GitHubå›¾åºŠé“¾æ¥ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…é‡å¤ä¸Šä¼ 
        if (isGitHubImageUrl(imageUrl)) {
            let rewritten = rewriteGithubImagePath(imageUrl, options.contentType, 'cover');
            const useJsdelivr2 = GM_getValue('use_jsdelivr_acceleration', false);
            if (useJsdelivr2 && !isJsDelivrImageUrl(rewritten)) {
                rewritten = convertGitHubUrlToJsDelivr(rewritten);
            }
            if (await imageUrlLoads(rewritten)) {
                return cacheCoverResult(coverKey, rewritten);
            }
            let fallbackFinal = null;
            try {
                const fallback = extractImageUrl(document.body);
                if (fallback && isValidImageUrl(fallback)) {
                    const currentHost = window.location.hostname;
                    let useGithub = false;
                    if (GITHUB_DOMAIN_CONFIG[currentHost] && typeof GITHUB_DOMAIN_CONFIG[currentHost].enabled !== 'undefined') {
                        useGithub = GITHUB_DOMAIN_CONFIG[currentHost].enabled;
                    } else {
                        useGithub = DOMAIN_GITHUB_CONFIG.useGithub;
                    }
                    if (COVER_BED_CONFIG.enabled || useGithub) {
                        const up = await uploadToGitHub(fallback, false, 'cover', options.contentType);
                        fallbackFinal = up && up.success ? up.url : getProxyUrl(fallback);
                    } else {
                        fallbackFinal = getProxyUrl(fallback);
                    }
                }
            } catch (_) {}
            if (fallbackFinal && await imageUrlLoads(fallbackFinal)) {
                return cacheCoverResult(coverKey, fallbackFinal);
            }
            const proxied = !COVER_BED_CONFIG.enabled ? getProxyUrl(imageUrl) : imageUrl;
            return cacheCoverResult(coverKey, proxied);
        }

        // æ£€æŸ¥æ–°æå–çš„å°é¢æ˜¯å¦æ˜¯base64çº¯ç™½è‰²ï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦æ›¿æ¢
        let shouldReplaceWhiteCover = false;
        if (isBase64ImageUrl(imageUrl)) {
            const isWhite = await isWhiteImage(imageUrl);
            if (isWhite) {
                console.log('æ£€æµ‹åˆ°å°é¢æ˜¯base64çº¯ç™½è‰²ï¼Œéœ€è¦æ›¿æ¢');
                shouldReplaceWhiteCover = true;
                try {
                    const fallback = extractImageUrl(document.body);
                    if (fallback && isValidImageUrl(fallback)) {
                        imageUrl = fallback;
                    }
                } catch (_) {}
            }
        }

        console.log('å¤„ç†å°é¢å›¾ç‰‡:', {
            imageUrl,
            isUpdateMode: options.skipGithubUpload,
            coverBedEnabled: COVER_BED_CONFIG.enabled,
            isBase64White: shouldReplaceWhiteCover,
            currentPage: window.location.href,
            timestamp: new Date().toISOString()
        });

        const currentHost = window.location.hostname;
        const websiteConfig = WEBSITE_GITHUB_CONFIG[currentHost];
        let useGithub = false;
        if (GITHUB_DOMAIN_CONFIG[currentHost] && typeof GITHUB_DOMAIN_CONFIG[currentHost].enabled !== 'undefined') {
            useGithub = GITHUB_DOMAIN_CONFIG[currentHost].enabled;
        } else {
            useGithub = DOMAIN_GITHUB_CONFIG.useGithub;
        }

        if (options.skipGithubUpload) {
            if (shouldReplaceWhiteCover) {
                if (COVER_BED_CONFIG.enabled || useGithub) {
                    console.log('æ›´æ–°æ¨¡å¼ï¼šå°é¢æ˜¯base64çº¯ç™½è‰²ï¼Œå¯ç”¨å›¾åºŠï¼Œä¸Šä¼ æ›¿æ¢');
                    // ç»§ç»­æ‰§è¡Œä¸Šä¼ é€»è¾‘
                } else {
                    console.log('æ›´æ–°æ¨¡å¼ï¼šå°é¢æ˜¯base64çº¯ç™½è‰²ï¼Œæœªå¯ç”¨å›¾åºŠï¼Œä½¿ç”¨ä»£ç†æ›¿æ¢');
                    const proxied = getProxyUrl(imageUrl);
                    return cacheCoverResult(coverKey, proxied);
                }
            } else {
                console.log('æ›´æ–°æ¨¡å¼ï¼šè·³è¿‡å°é¢ä¸Šä¼ ï¼Œä¿æŒåŸæ ·');
                const proxied = !COVER_BED_CONFIG.enabled ? getProxyUrl(imageUrl) : imageUrl;
                return cacheCoverResult(coverKey, proxied);
            }
        }

        // æ·»åŠ æ¨¡å¼æˆ–æ›´æ–°æ¨¡å¼ï¼šä»…åœ¨å¯ç”¨å›¾åºŠ/åŸŸåCDNæ—¶ä¸Šä¼ 
        if (COVER_BED_CONFIG.enabled || useGithub) {
            // å¯ç”¨å°é¢å›¾åºŠï¼šå°†å½“å‰é¡µé¢çš„å°é¢å›¾ç‰‡ä¸Šä¼ åˆ°GitHubï¼ˆåªä¸Šä¼ ä¸€å¼ ï¼‰ï¼Œè·å–GitHubå›¾ç‰‡é“¾æ¥å½“ä½œnotionçš„å°é¢é“¾æ¥
            if (shouldReplaceWhiteCover) {
                console.log('æ£€æµ‹åˆ°base64çº¯ç™½è‰²å°é¢ï¼Œä¸Šä¼ åˆ°GitHubå›¾åºŠæ›¿æ¢');
            } else {
                console.log('æ·»åŠ æ¨¡å¼ï¼šå°é¢ä¸Šä¼ åˆ°GitHub');
            }

            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æç¤º - ä½¿ç”¨ç¾åŒ–çš„æ ·å¼
            const progressMsg = document.createElement('div');
            progressMsg.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10001;
                    background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                    color: #374151; padding: 20px 28px; border-radius: 20px;
                    font-size: 14px; font-weight: 600;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
                    max-width: 360px; word-wrap: break-word;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    animation: slideInRight 0.3s ease-out;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                `;

            // æ·»åŠ åŠ è½½åŠ¨ç”»å›¾æ ‡
            const loadingIcon = document.createElement('div');
            loadingIcon.style.cssText = `
                    width: 20px;
                    height: 20px;
                    border: 2px solid #E5E7EB;
                    border-top: 2px solid #FF8FAB;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                `;

            const textSpan = document.createElement('span');
            textSpan.textContent = 'æ­£åœ¨ä¸Šä¼ å°é¢å›¾ç‰‡åˆ°GitHubå›¾åºŠ...';

            progressMsg.appendChild(loadingIcon);
            progressMsg.appendChild(textSpan);

            // æ·»åŠ æ—‹è½¬åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    @keyframes slideInRight {
                        from {
                            opacity: 0;
                            transform: translateX(100%);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                `;
            document.head.appendChild(style);

            document.body.appendChild(progressMsg);

            try {
                const result = await uploadToGitHub(imageUrl, false, 'cover', options.contentType);
                if (result.success) {
                    console.log('æ·»åŠ æ¨¡å¼ï¼šå°é¢ä¸Šä¼ æˆåŠŸ:', result.url);
                    // æ›´æ–°æˆåŠŸçŠ¶æ€
                    loadingIcon.style.display = 'none';
                    const successIcon = document.createElement('div');
                    successIcon.style.cssText = `
                            width: 20px;
                            height: 20px;
                            background: #10B981;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 12px;
                            font-weight: bold;
                        `;
                    successIcon.textContent = 'âœ“';
                    progressMsg.replaceChild(successIcon, loadingIcon);
                    textSpan.textContent = 'å°é¢å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼';
                    progressMsg.style.background = 'linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%)';
                    progressMsg.style.color = '#065F46';
                    progressMsg.style.boxShadow = '0 25px 50px -12px rgba(16, 185, 129, 0.25)';
                    setTimeout(() => {
                        progressMsg.remove();
                        style.remove();
                    }, 2000);
                    const finalCoverUrl = cacheCoverResult(coverKey, result.url);
                    maybeRequestAutoUpdateAfterCoverUpload();
                    return finalCoverUrl;
                } else {
                    console.error('æ·»åŠ æ¨¡å¼ï¼šå°é¢ä¸Šä¼ å¤±è´¥:', result.error);
                    // æ›´æ–°å¤±è´¥çŠ¶æ€
                    loadingIcon.style.display = 'none';
                    const errorIcon = document.createElement('div');
                    errorIcon.style.cssText = `
                            width: 20px;
                            height: 20px;
                            background: #EF4444;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 12px;
                            font-weight: bold;
                        `;
                    errorIcon.textContent = '!';
                    progressMsg.replaceChild(errorIcon, loadingIcon);
                    textSpan.textContent = 'å°é¢ä¸Šä¼ å¤±è´¥ï¼Œä½¿ç”¨ä»£ç†é“¾æ¥';
                    progressMsg.style.background = 'linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%)';
                    progressMsg.style.color = '#991B1B';
                    progressMsg.style.boxShadow = '0 25px 50px -12px rgba(239, 68, 68, 0.25)';
                    setTimeout(() => {
                        progressMsg.remove();
                        style.remove();
                    }, 3000);
                    return cacheCoverResult(coverKey, getProxyUrl(imageUrl));
                }
            } catch (error) {
                console.error('æ·»åŠ æ¨¡å¼ï¼šå°é¢ä¸Šä¼ å‡ºé”™:', error);
                // æ›´æ–°é”™è¯¯çŠ¶æ€
                loadingIcon.style.display = 'none';
                const errorIcon = document.createElement('div');
                errorIcon.style.cssText = `
                        width: 20px;
                        height: 20px;
                        background: #EF4444;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 12px;
                        font-weight: bold;
                    `;
                errorIcon.textContent = '!';
                progressMsg.replaceChild(errorIcon, loadingIcon);
                textSpan.textContent = 'å°é¢ä¸Šä¼ å‡ºé”™ï¼Œä½¿ç”¨ä»£ç†é“¾æ¥';
                progressMsg.style.background = 'linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%)';
                progressMsg.style.color = '#991B1B';
                progressMsg.style.boxShadow = '0 25px 50px -12px rgba(239, 68, 68, 0.25)';
                setTimeout(() => {
                    progressMsg.remove();
                    style.remove();
                }, 3000);
                return cacheCoverResult(coverKey, getProxyUrl(imageUrl));
            }
        } else {
            console.log('æ·»åŠ æ¨¡å¼ï¼šå°é¢å›¾åºŠæœªå¯ç”¨ï¼Œä½¿ç”¨ä»£ç†é“¾æ¥ï¼ˆå¦‚æœå·²é…ç½®ï¼‰');
            return cacheCoverResult(coverKey, getProxyUrl(imageUrl));
        }
    }

    // å¤„ç†å†…å®¹å›¾ç‰‡
    async function processContentImage(imageUrl, options) {
        // å¦‚æœå›¾ç‰‡URLæ— æ•ˆï¼Œç›´æ¥è¿”å›åŸå§‹URL
        if (!isValidImageUrl(imageUrl)) {
            return imageUrl;
        }

        if (GM_getValue('use_jsdelivr_acceleration', false) && isJsDelivrImageUrl(imageUrl)) {
            return imageUrl;
        }

        if (options && options.skipGithubUpload) {
            if (isGitHubImageUrl(imageUrl)) {
                return rewriteGithubImagePath(imageUrl, options.contentType, 'content');
            }
            return imageUrl;
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯å°é¢å›¾ç‰‡ï¼Œå¦‚æœæ˜¯å°é¢å›¾ç‰‡åˆ™è·³è¿‡å¤„ç†ï¼ˆé¿å…é‡å¤ä¸Šä¼ ï¼‰
        // è¿™é‡Œå¯ä»¥é€šè¿‡æ£€æŸ¥å›¾ç‰‡URLæ˜¯å¦ä¸å½“å‰é¡µé¢çš„å°é¢å›¾ç‰‡ç›¸åŒæ¥åˆ¤æ–­
        // ç”±äºå°é¢å›¾ç‰‡å·²ç»åœ¨ä¸Šæ¸¸å¤„ç†è¿‡ï¼Œè¿™é‡Œç›´æ¥è¿”å›åŸå§‹URL
        console.log('å¤„ç†å†…å®¹å›¾ç‰‡:', imageUrl);

        // è·å–å½“å‰ç½‘ç«™çš„åŸŸå
        const currentHost = window.location.hostname;

        // æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç«™ç‰¹å®šçš„é…ç½®
        const websiteConfig = WEBSITE_GITHUB_CONFIG[currentHost];

        // ğŸŒ æ£€æŸ¥å½“å‰åŸŸåçš„CDNé…ç½®ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
        let useGithub = false;
        if (GITHUB_DOMAIN_CONFIG[currentHost] && typeof GITHUB_DOMAIN_CONFIG[currentHost].enabled !== 'undefined') {
            useGithub = GITHUB_DOMAIN_CONFIG[currentHost].enabled;
            console.log(`ğŸŒ ä½¿ç”¨åŸŸåCDNé…ç½®: ${currentHost} = ${useGithub}`);
        } else {
            // å¦‚æœæ²¡æœ‰åŸŸåç‰¹å®šé…ç½®ï¼Œä½¿ç”¨å…¨å±€é…ç½®
            useGithub = DOMAIN_GITHUB_CONFIG.useGithub;
            console.log(`ğŸŒ ä½¿ç”¨å…¨å±€CDNé…ç½®: ${useGithub}`);
        }

        // å¦‚æœæœ‰ç½‘ç«™ç‰¹å®šé…ç½®ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰ï¼Œä¼˜å…ˆçº§æ¬¡ä¹‹
        if (websiteConfig && typeof websiteConfig.useGithub !== 'undefined') {
            console.log('âš ï¸ æ£€æµ‹åˆ°ä¼ ç»Ÿç½‘ç«™é…ç½®ï¼Œå»ºè®®å‡çº§åˆ°æ–°çš„åŸŸåCDNé…ç½®æ–¹å¼');
            // ä¼ ç»Ÿæ–¹å¼ä»ç„¶æœ‰æ•ˆï¼Œä½†ä¸å»ºè®®ä½¿ç”¨
            // useGithub = websiteConfig.useGithub;
        }

        // å¤„ç†å¼ºåˆ¶é€‰é¡¹
        if (options.forceUseGithub) {
            useGithub = true;
        } else if (options.forceUseOriginal) {
            useGithub = false;
        }

        // å…¨å±€ç»Ÿä¸€å†…å®¹å›¾ç‰‡ä¸Šä¼ è¿›åº¦æ¡ï¼ˆå•ä¾‹ï¼‰
        const CONTENT_UPLOAD_UI = (function() {
            const ui = window.__NOTION_CLIPPER_CONTENT_UPLOAD_UI__ || {
                container: null,
                bar: null,
                textEl: null,
                total: 0, // æ€»ä»»åŠ¡æ•°ï¼ˆåœ¨è¿›å…¥ä¸Šä¼ å‰å¯è¢«é¢„å…ˆè®¾ç½®ï¼‰
                done: 0,
                failed: 0,
                lastTimer: null,
                ensure() {
                    if (this.container) return;
                    const box = document.createElement('div');
                    box.style.cssText = `
                        position: fixed; top: 20px; right: 20px; z-index: 10001;
                        background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                        color: #374151; padding: 14px 16px; border-radius: 20px;
                        font-size: 13px; font-weight: 600; width: 280px;
                        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
                        border: 1px solid rgba(0,0,0,0.05);
                    `;
                    const text = document.createElement('div');
                    text.textContent = 'å‡†å¤‡ä¸Šä¼ å›¾ç‰‡...';
                    text.style.cssText = 'margin-bottom: 8px; color:#111827;';
                    const progressWrap = document.createElement('div');
                    progressWrap.style.cssText = 'height: 8px; background:#e5e7eb; border-radius: 9999px; overflow:hidden; position:relative;';
                    const bar = document.createElement('div');
                    bar.style.cssText = 'height:100%; width:0%; background: linear-gradient(90deg,#60a5fa,#a78bfa,#f472b6,#60a5fa); background-size: 300% 100%; animation: ncProgress 2s linear infinite; transition: width .2s ease;';
                    progressWrap.appendChild(bar);
                    box.appendChild(text);
                    box.appendChild(progressWrap);
                    document.body.appendChild(box);
                    this.container = box;
                    this.textEl = text;
                    this.bar = bar;
                },
                setTotal(n) { this.ensure(); this.total = Math.max(0, Number(n)||0); this.update(); },
                startOne() {
                    this.ensure();
                    if (!this.total) this.total = 1; // é˜²æ­¢ä¸º0å¯¼è‡´NaN
                    this.update();
                },
                succeedOne() {
                    this.done += 1;
                    this.update();
                    this.maybeHideSoon();
                },
                failOne() {
                    this.done += 1;
                    this.failed += 1;
                    this.update();
                    this.maybeHideSoon();
                },
                update() {
                    if (!this.container) return;
                    const total = Math.max(this.total, 1);
                    const ratio = Math.min(1, this.done / total);
                    this.bar.style.width = (ratio * 100).toFixed(0) + '%';
                    const failText = this.failed ? `ï¼ˆå¤±è´¥ ${this.failed}ï¼‰` : '';
                    this.textEl.textContent = `æ­£åœ¨ä¸Šä¼ å›¾ç‰‡ ${this.done}/${this.total}${failText}`;
                },
                maybeHideSoon() {
                    if (this.lastTimer) clearTimeout(this.lastTimer);
                    if (this.done >= this.total && this.total > 0) {
                        this.lastTimer = setTimeout(() => {
                            if (this.container && this.container.parentNode) {
                                this.container.parentNode.removeChild(this.container);
                            }
                            this.container = null; this.bar = null; this.textEl = null;
                            this.total = 0; this.done = 0; this.failed = 0; this.lastTimer = null;
                        }, 1500);
                    }
                }
            };
            window.__NOTION_CLIPPER_CONTENT_UPLOAD_UI__ = ui;
            return ui;
        })();

        // æ¸å˜è¿›åº¦åŠ¨ç”» keyframesï¼ˆä¸€æ¬¡æ³¨å…¥ï¼‰
        (function ensureNcProgressKeyframes(){
            if (document.getElementById('nc-progress-keyframes')) return;
            const st = document.createElement('style');
            st.id = 'nc-progress-keyframes';
            st.textContent = '@keyframes ncProgress { 0% { background-position: 0% 0; } 100% { background-position: 300% 0; } }';
            document.head.appendChild(st);
        })();

        // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†GitHubå›¾åºŠ
        if (useGithub) {
            console.log('ä½¿ç”¨GitHubå›¾åºŠå¤„ç†å†…å®¹å›¾ç‰‡:', imageUrl);
            try {
                // åœ¨é¦–æ¬¡è¿›å…¥å†…å®¹å›¾ç‰‡ä¸Šä¼ å‰ï¼Œé¢„ä¼°æ€»æ•°ï¼šä»…åœ¨å€¼ä¸º0æ—¶è®¡ç®—
                const ui = window.__NOTION_CLIPPER_CONTENT_UPLOAD_UI__;
                if (ui && ui.total === 0 && window.__CURRENT_CONTENT_TYPE__ === 'clip') {
                    const totalImages = Array.isArray(options && options._allImages)
                    ? options._allImages.length
                    : (typeof window.__PENDING_IMAGE_COUNT__ === 'number' ? window.__PENDING_IMAGE_COUNT__ : 0);
                    if (totalImages > 0) ui.setTotal(totalImages);
                }
            } catch (e) { /* å¿½ç•¥ç»Ÿè®¡å¼‚å¸¸ */ }
            // ç»Ÿä¸€è¿›åº¦æ¡ï¼šå¼€å§‹ä¸€ä¸ªä»»åŠ¡
            CONTENT_UPLOAD_UI.startOne();

            try {
                // ä¸Šä¼ å›¾ç‰‡åˆ°GitHub
                const result = await uploadToGitHub(imageUrl, false, 'content', options.contentType);

                // å¦‚æœä¸Šä¼ æˆåŠŸï¼Œè¿”å›GitHubå›¾åºŠé“¾æ¥
                if (result.success) {
                    console.log('GitHubå›¾åºŠä¸Šä¼ æˆåŠŸ:', result.url);
                    CONTENT_UPLOAD_UI.succeedOne();
                    return result.url;
                } else {
                    console.error('ä¸Šä¼ å›¾ç‰‡åˆ°GitHubå¤±è´¥:', result.error);
                    CONTENT_UPLOAD_UI.failOne();
                    return imageUrl; // ä¸Šä¼ å¤±è´¥æ—¶è¿”å›åŸå§‹é“¾æ¥
                }
            } catch (error) {
                console.error('å¤„ç†å›¾ç‰‡é“¾æ¥æ—¶å‡ºé”™:', error);
                CONTENT_UPLOAD_UI.failOne();
                return imageUrl; // å‡ºé”™æ—¶è¿”å›åŸå§‹é“¾æ¥
            }
        } else {
            console.log('æœªå¯ç”¨GitHubå›¾åºŠï¼Œè¿”å›åŸå§‹é“¾æ¥:', imageUrl);
            // æœªå¯ç”¨GitHubå›¾åºŠï¼Œè¿”å›åŸå§‹é“¾æ¥
            return imageUrl;
        }
    }

    // åŠ è½½å›¾ç‰‡æ•°æ®ï¼šä¼˜å…ˆä¿ç•™åŸå›¾ï¼Œä»…åœ¨Notionä¸æ”¯æŒçš„æ ¼å¼æ—¶è½¬æ¢ä¸ºPNG
    async function loadImageData(imageUrl, fastMode = false) {
        // æå–æ–‡ä»¶ååŠæ‰©å±•å
        let fileName = '';
        let originalExt = '';
        try {
            const url = new URL(imageUrl);
            fileName = (url.pathname.split('/').pop() || '').split('?')[0];
            const extMatch = fileName.match(/\.([^.]+)$/);
            originalExt = extMatch ? extMatch[1].toLowerCase() : '';
        } catch (e) {
            fileName = `image_${Date.now()}`;
        }
        if (!originalExt) {
            originalExt = 'png';
        }

        const notionSupportedFormats = ['jpg', 'jpeg', 'png', 'gif', 'webp'];

        // å¦‚æœæ˜¯Notionæ”¯æŒçš„æ ¼å¼ï¼Œç›´æ¥ä¸‹è½½åŸå›¾å¹¶ä¸Šä¼ ï¼Œä¸åšå‹ç¼©/é‡é‡‡æ ·
        if (notionSupportedFormats.includes(originalExt)) {
            const base64Data = await (async () => {
                try {
                    const resp = await fetch(imageUrl);
                    if (!resp.ok) throw new Error('fetch åŸå›¾å¤±è´¥');
                    const blob = await resp.blob();
                    return await new Promise((res, rej) => {
                        const reader = new FileReader();
                        reader.onload = () => res(String(reader.result).split(',')[1]);
                        reader.onerror = (err) => rej(err);
                        reader.readAsDataURL(blob);
                    });
                } catch (_) {
                    // å¤±è´¥åˆ™èµ°ä»£ç†ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
                    const proxyUrl = getProxyUrl(imageUrl);
                    if (proxyUrl === imageUrl) {
                        throw new Error('ä»£ç†æœªé…ç½®ä¸”ç›´æ¥è·å–å¤±è´¥');
                    }
                    const resp = await fetch(proxyUrl);
                    if (!resp.ok) throw new Error('ä»£ç†è·å–åŸå›¾å¤±è´¥');
                    const blob = await resp.blob();
                    return await new Promise((res, rej) => {
                        const reader = new FileReader();
                        reader.onload = () => res(String(reader.result).split(',')[1]);
                        reader.onerror = (err) => rej(err);
                        reader.readAsDataURL(blob);
                    });
                }
            })();

            // ç¡®ä¿æ–‡ä»¶åæœ‰åç¼€
            if (!/\.[^.]+$/.test(fileName)) fileName = `${fileName}.${originalExt}`;

            return {
                base64Data,
                fileName,
                width: undefined,
                height: undefined,
                originalFormat: originalExt,
                convertedFormat: originalExt
            };
        }

        // Notionä¸æ”¯æŒçš„æ ¼å¼ï¼šç”¨canvasè½¬ä¸ºPNGï¼Œä½†ä¸é™è´¨ä¸ç¼©æ”¾ï¼Œä¿ç•™åŸå§‹å°ºå¯¸
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            const timeout = setTimeout(() => reject(new Error('å›¾ç‰‡åŠ è½½è¶…æ—¶')), 10000);

            img.onload = function() {
                clearTimeout(timeout);
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const width = img.naturalWidth || img.width;
                    const height = img.naturalHeight || img.height;
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // è¾“å‡ºPNGï¼Œä¸ä¼ qualityä»¥é¿å…ä»»ä½•è´¨é‡é™ä½
                    const dataUrl = canvas.toDataURL('image/png');
                    const base64Data = dataUrl.split(',')[1];

                    // ç»Ÿä¸€æ”¹ä¸ºpngåç¼€
                    const nameNoQuery = (fileName || `image_${Date.now()}`).replace(/\?.*$/, '');
                    const normalized = /\.[^.]+$/.test(nameNoQuery) ? nameNoQuery.replace(/\.[^.]+$/, '.png') : `${nameNoQuery}.png`;

                    resolve({
                        base64Data,
                        fileName: normalized,
                        width: width,
                        height: height,
                        originalFormat: originalExt,
                        convertedFormat: 'png'
                    });
                } catch (e) {
                    reject(e);
                }
            };

            img.onerror = function(error) {
                clearTimeout(timeout);
                // å°è¯•ä»£ç†å†è½¬ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
                const proxyUrl = getProxyUrl(imageUrl);
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const width = img.naturalWidth || img.width;
                        const height = img.naturalHeight || img.height;
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/png');
                        const base64Data = dataUrl.split(',')[1];
                        const nameNoQuery = (fileName || `image_${Date.now()}`).replace(/\?.*$/, '');
                        const normalized = /\.[^.]+$/.test(nameNoQuery) ? nameNoQuery.replace(/\.[^.]+$/, '.png') : `${nameNoQuery}.png`;
                        resolve({
                            base64Data,
                            fileName: normalized,
                            width: width,
                            height: height,
                            originalFormat: originalExt,
                            convertedFormat: 'png'
                        });
                    } catch (e) {
                        reject(e);
                    }
                };
                img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                img.src = proxyUrl;
            };

            img.src = imageUrl;
        });
    }

    // æ™ºèƒ½æ–‡ä»¶åç”Ÿæˆ - åŸºäºé¡µé¢æ•°æ®ä¸ç±»å‹
    function sanitizeFileNamePart(text) {
        if (!text) return '';
        return String(text)
            .replace(/[\\/:*?"<>|\n\r\t]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim()
            .slice(0, 80);
    }

    function getLastPageData() {
        try {
            const raw = GM_getValue(`lastData_${window.location.href}`);
            if (raw) return JSON.parse(raw);
        } catch (_) {}
        return {};
    }

    // ç»´æŠ¤æ¯é¡µçš„å†…å®¹å›¾ç‰‡åºå·
    function nextImageSequence() {
        const key = `img_seq_${window.location.href}`;
        const current = GM_getValue(key, 0) || 0;
        const next = current + 1;
        GM_setValue(key, next);
        return next;
    }

    function getTitleFromSelectorsForNaming() {
        try {
            const siteConfig = getSiteConfig();
            if (siteConfig && siteConfig.selectors) {
                const indices = siteConfig.selectorIndices || {};
                const tryField = (field) => {
                    if (!siteConfig.selectors[field]) return '';
                    const nodes = document.querySelectorAll(siteConfig.selectors[field]);
                    if (!nodes || nodes.length === 0) return '';
                    const selection = resolveElementSelection(nodes, indices[field] ?? '0');
                    if (!selection.elements.length) return '';
                    const el = selection.elements[0];
                    const raw = el.textContent || '';
                    const cleaned = field === 'ä¹¦å' ? cleanTitle(raw) : cleanText(raw);
                    return cleaned || '';
                };
                const t1 = tryField('ä¹¦å');
                if (t1) return t1;
                const t2 = tryField('æ ‡é¢˜');
                if (t2) return t2;
            }
        } catch (_) {}
        return '';
    }

    function generateSmartFileName(imageType, fileExtension) {
        const pageData = getLastPageData();
        const ext = fileExtension ? fileExtension.toLowerCase() : 'png';

        // æ£€æŸ¥æ˜¯å¦åœ¨æ‰¹é‡å¯¼å…¥æ¨¡å¼ä¸‹ï¼Œå¦‚æœæ˜¯åˆ™ä½¿ç”¨ä»é“¾æ¥æå–çš„æ•°æ®
        let title, author;
        if (window._currentBatchImportData) {
            // æ‰¹é‡å¯¼å…¥æ¨¡å¼ï¼šä½¿ç”¨ä»é“¾æ¥æå–çš„æ•°æ®
            console.log('æ‰¹é‡å¯¼å…¥æ¨¡å¼ï¼šä½¿ç”¨æå–çš„æ•°æ®', {
                data: window._currentBatchImportData,
                imageType: imageType,
                timestamp: new Date().toISOString()
            });
            title = sanitizeFileNamePart(window._currentBatchImportData.ä¹¦å || window._currentBatchImportData.æ ‡é¢˜ || 'æœªå‘½å');
            author = sanitizeFileNamePart(window._currentBatchImportData.ä½œè€… || 'æœªçŸ¥ä½œè€…');
        } else {
            // æ­£å¸¸æ¨¡å¼ï¼šä½¿ç”¨å½“å‰é¡µé¢æ•°æ®
            console.log('æ­£å¸¸æ¨¡å¼ï¼šä½¿ç”¨å½“å‰é¡µé¢æ•°æ®', {
                pageData: pageData,
                documentTitle: document.title,
                imageType: imageType,
                timestamp: new Date().toISOString()
            });
            const selectorTitle = getTitleFromSelectorsForNaming();
            const extractedTitle = (typeof smartExtractTitle === 'function' ? smartExtractTitle() : '') || '';
            title = sanitizeFileNamePart(selectorTitle || extractedTitle || pageData.ä¹¦å || pageData.æ ‡é¢˜ || document.title || 'æœªå‘½å');
            author = sanitizeFileNamePart((typeof smartExtractAuthor === 'function' ? smartExtractAuthor() : '') || pageData.ä½œè€… || 'æœªçŸ¥ä½œè€…');
        }

        if (imageType === 'cover') {
            const base = title && author ? `${title}-${author}-å°é¢` : `${title}-å°é¢`;
            return `${base}.${ext}`;
        }

        // å†…å®¹å›¾ç‰‡ï¼Œæ ‡é¢˜(åºå·)
        const seq = nextImageSequence();
        // åœ¨å†…å®¹å›¾ç‰‡æ–‡ä»¶åä¸­ä¹ŸåŠ å…¥ä½œè€…ï¼ˆè‹¥å¯ç”¨ï¼‰ï¼Œå¢å¼ºåŒºåˆ†åº¦
        const authorPart = author || '';
        const titleWithAuthor = authorPart ? `${title}-${authorPart}` : title;
        return `${titleWithAuthor}(${seq}).${ext}`;
    }

    // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²å­˜åœ¨äºGitHub
    async function checkImageExistsInGitHub(imageUrl, imageType = 'content') {
        try {
            // ç”Ÿæˆæ–‡ä»¶å
            const fileExtension = imageUrl.split('.').pop()?.toLowerCase() || 'png';
            const fileName = generateSmartFileName(imageType, fileExtension);

            // æ„å»ºAPI URL
            let uploadPath;
            if (imageType === 'cover') {
                uploadPath = GITHUB_CONFIG.coverPath;
            } else if (imageType === 'content') {
                uploadPath = GITHUB_CONFIG.contentPath;
            } else {
                uploadPath = GITHUB_CONFIG.contentPath;
            }

            const cleanPath = uploadPath.replace(/^\/+/, '').replace(/\/+$/, '');
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${cleanPath}/${fileName}`;

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            __incApi('github', 'GET', apiUrl);
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'Notion-Clipper'
                }
            });

            if (response.ok) {
                const fileData = await response.json();
                // ç”ŸæˆGitHubå›¾ç‰‡é“¾æ¥
                const encodedPath = encodeURIComponent(cleanPath).replace(/%2F/g, '/');
                const encodedFileName = encodeURIComponent(fileName);

                let imageLink = '';
                switch (DOMAIN_GITHUB_CONFIG.type) {
                    case 'raw':
                        imageLink = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${encodedPath}/${encodedFileName}`;
                        break;
                    case 'pages':
                        imageLink = `https://${GITHUB_CONFIG.username}.github.io/${GITHUB_CONFIG.repo}/${encodedPath}/${encodedFileName}`;
                        break;
                    case 'custom':
                        if (DOMAIN_GITHUB_CONFIG.customDomain) {
                            imageLink = `https://${DOMAIN_GITHUB_CONFIG.customDomain}/${encodedPath}/${encodedFileName}`;
                        } else {
                            imageLink = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${encodedPath}/${encodedFileName}`;
                        }
                        break;
                    default:
                        imageLink = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${encodedPath}/${encodedFileName}`;
                }

                console.log('å›¾ç‰‡å·²å­˜åœ¨äºGitHubï¼Œç›´æ¥ä½¿ç”¨ç°æœ‰é“¾æ¥:', imageLink);
                return {
                    exists: true,
                    url: imageLink,
                    fileName: fileName
                };
            } else if (response.status === 404) {
                console.log('å›¾ç‰‡ä¸å­˜åœ¨äºGitHubï¼Œéœ€è¦ä¸Šä¼ ');
                return { exists: false };
            } else {
                console.log('æ£€æŸ¥å›¾ç‰‡å­˜åœ¨æ€§å¤±è´¥ï¼Œç»§ç»­ä¸Šä¼ æµç¨‹');
                return { exists: false };
            }
        } catch (error) {
            console.log('æ£€æŸ¥å›¾ç‰‡å­˜åœ¨æ€§æ—¶å‡ºé”™ï¼Œç»§ç»­ä¸Šä¼ æµç¨‹:', error);
            return { exists: false };
        }
    }

    // ä¸Šä¼ å›¾ç‰‡åˆ°GitHub
    async function uploadToGitHub(imageUrl, fastMode = false, imageType = 'content', contentType = null) {
        const startTime = Date.now();

        // è°ƒè¯•æ—¥å¿—
        console.log('uploadToGitHub è¢«è°ƒç”¨:', {
            imageUrl: imageUrl.substring(0, 100) + '...',
            isUpdateMode: window.isUpdateMode,
            fastMode: fastMode,
            imageType: imageType,
            contentType: contentType,
            timestamp: new Date().toISOString()
        });

        try {
            // éªŒè¯GitHubé…ç½®
            if (!validateGitHubConfig(GITHUB_CONFIG)) {
                throw new Error('GitHubé…ç½®æ— æ•ˆï¼Œè¯·å…ˆé…ç½®GitHubå›¾åºŠ');
            }

            console.log('å¼€å§‹ä¸Šä¼ å›¾ç‰‡åˆ°GitHub:', imageUrl);

            // åŠ è½½å›¾ç‰‡æ•°æ®
            const loadStartTime = Date.now();
            const imageData = await loadImageData(imageUrl, fastMode);
            const loadTime = Date.now() - loadStartTime;
            console.log(`å›¾ç‰‡åŠ è½½å’Œå‹ç¼©å®Œæˆï¼Œè€—æ—¶: ${loadTime}msï¼Œå‹ç¼©åå°ºå¯¸: ${imageData.width}x${imageData.height}ï¼Œå¿«é€Ÿæ¨¡å¼: ${fastMode}`);

            // æ™ºèƒ½ç”Ÿæˆæ–‡ä»¶å
            const fileExtension = imageData.fileName.split('.').pop();
            const fileName = generateSmartFileName(imageType, fileExtension);

            // æ„å»ºAPI URL
            // æ ¹æ®å†…å®¹ç±»å‹å’Œå›¾ç‰‡ç±»å‹é€‰æ‹©è·¯å¾„
            let uploadPath;
            if (contentType) {
                // ä½¿ç”¨é«˜çº§è·¯å¾„é…ç½®
                uploadPath = getContentModePath(contentType, imageType);
                console.log(`ä½¿ç”¨é«˜çº§è·¯å¾„é…ç½®: contentType=${contentType}, imageType=${imageType}, path=${uploadPath}`);
            } else {
                // å›é€€åˆ°åŸæœ‰é€»è¾‘
                if (imageType === 'cover') {
                    uploadPath = GITHUB_CONFIG.coverPath;
                } else if (imageType === 'content') {
                    uploadPath = GITHUB_CONFIG.contentPath;
                } else {
                    // å¦‚æœæ²¡æœ‰æŒ‡å®šç±»å‹ï¼Œé»˜è®¤ä½¿ç”¨å†…å®¹è·¯å¾„
                    uploadPath = GITHUB_CONFIG.contentPath;
                }
                console.log(`ä½¿ç”¨ä¼ ç»Ÿè·¯å¾„é…ç½®: imageType=${imageType}, path=${uploadPath}`);
            }

            // ç¡®ä¿è·¯å¾„ä¸åŒ…å«å‰å¯¼æ–œæ ï¼Œå¹¶å¤„ç†å¯èƒ½çš„è·¯å¾„åˆ†éš”ç¬¦é—®é¢˜
            const cleanPath = uploadPath.replace(/^\/+/, '').replace(/\/+$/, '');
            const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${cleanPath}/${fileName}`;

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œè·å–SHAå€¼
            let fileSha = null;
            try {
                __incApi('github', 'GET', apiUrl);
                const checkResponse = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'Notion-Clipper'
                    }
                });

                if (checkResponse.ok) {
                    const fileData = await checkResponse.json();
                    fileSha = fileData.sha;
                    console.log('æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·å–åˆ°SHA:', fileSha);
                } else if (checkResponse.status === 404) {
                    console.log('æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
                } else {
                    console.log('æ£€æŸ¥æ–‡ä»¶çŠ¶æ€å¤±è´¥ï¼Œç»§ç»­å°è¯•ä¸Šä¼ ');
                }
            } catch (error) {
                console.log('æ£€æŸ¥æ–‡ä»¶çŠ¶æ€æ—¶å‡ºé”™ï¼Œç»§ç»­å°è¯•ä¸Šä¼ :', error);
            }

            // æ„å»ºè¯·æ±‚ä½“
            const requestBody = {
                message: `Upload image: ${fileName}`,
                content: imageData.base64Data,
                branch: GITHUB_CONFIG.branch
            };

            // å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œæ·»åŠ SHAå€¼
            if (fileSha) {
                requestBody.sha = fileSha;
            }

            // å‘é€PUTè¯·æ±‚
            const uploadStartTime = Date.now();
            console.log(`å¼€å§‹ä¸Šä¼ åˆ°GitHub APIï¼Œæ–‡ä»¶å¤§å°: ${Math.round(imageData.base64Data.length / 1024)}KB`);

            __incApi('github', 'PUT', apiUrl);
            const response = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                    'User-Agent': 'Notion-Clipper'
                },
                body: JSON.stringify(requestBody)
            });

            const uploadTime = Date.now() - uploadStartTime;
            console.log(`GitHub APIè¯·æ±‚å®Œæˆï¼Œè€—æ—¶: ${uploadTime}ms`);

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`ä¸Šä¼ å¤±è´¥: ${errorData.message || 'æœªçŸ¥é”™è¯¯'}`);
            }

            const responseData = await response.json();
            const totalTime = Date.now() - startTime;
            console.log(`GitHubä¸Šä¼ æ€»è€—æ—¶: ${totalTime}ms`);

            // æ ¹æ®åŸŸåé…ç½®ç”Ÿæˆå›¾ç‰‡URL
            let imageLink = '';

            // ç¡®ä¿è·¯å¾„å’Œæ–‡ä»¶åéƒ½ç»è¿‡URLç¼–ç å¤„ç†
            const encodedPath = encodeURIComponent(cleanPath).replace(/%2F/g, '/');
            const encodedFileName = encodeURIComponent(fileName);

            switch (DOMAIN_GITHUB_CONFIG.type) {
                case 'raw':
                    imageLink = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${encodedPath}/${encodedFileName}`;
                    break;
                case 'pages':
                    imageLink = `https://${GITHUB_CONFIG.username}.github.io/${GITHUB_CONFIG.repo}/${encodedPath}/${encodedFileName}`;
                    break;
                case 'custom':
                    if (DOMAIN_GITHUB_CONFIG.customDomain) {
                        imageLink = `https://${DOMAIN_GITHUB_CONFIG.customDomain}/${encodedPath}/${encodedFileName}`;
                    } else {
                        imageLink = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${encodedPath}/${encodedFileName}`;
                    }
                    break;
                default:
                    imageLink = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${encodedPath}/${encodedFileName}`;
            }

            if (GM_getValue('use_jsdelivr_acceleration', false)) {
                imageLink = convertGitHubUrlToJsDelivr(imageLink);
            }

            // éªŒè¯ç”Ÿæˆçš„URLæ˜¯å¦æœ‰æ•ˆ
            console.log('ç”Ÿæˆçš„å›¾ç‰‡URL:', imageLink);
            if (!isValidImageUrl(imageLink)) {
                console.error('ç”Ÿæˆçš„URLæ— æ•ˆ:', imageLink);
                throw new Error('ç”Ÿæˆçš„å›¾ç‰‡URLæ— æ•ˆ');
            }

            try {
                __pushApiEvent('github', {
                    ts: Date.now(),
                    method: 'PUT',
                    path: String(apiUrl).replace(/^https?:\/\/[^/]+/i,''),
                    imageType,
                    fileName,
                    sizeKB: Math.round(((imageData && imageData.base64Data ? imageData.base64Data.length : 0)) / 1024),
                    success: true,
                    url: imageLink
                });
            } catch(_) {}

            return {
                success: true,
                url: imageLink,
                fileName: fileName
            };
        } catch (error) {
            console.error('ä¸Šä¼ åˆ°GitHubå¤±è´¥:', error);
            try {
                __pushApiEvent('github', {
                    ts: Date.now(),
                    method: 'PUT',
                    path: String(typeof apiUrl !== 'undefined' ? apiUrl : '').replace(/^https?:\/\/[^/]+/i,''),
                    imageType,
                    fileName: typeof fileName !== 'undefined' ? fileName : '',
                    sizeKB: 0,
                    success: false,
                    url: ''
                });
            } catch(_) {}
            return {
                success: false,
                error: error.message || 'ä¸Šä¼ å¤±è´¥'
            };
        }
    }
    // æ˜¾ç¤ºGitHubå›¾åºŠé…ç½®å¯¹è¯æ¡†
    function showGitHubConfigDialog() {
        // åˆ›å»ºå¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.id = 'github-config-dialog';
        dialog.style.position = 'fixed';
        dialog.style.top = '50%';
        dialog.style.left = '50%';
        dialog.style.transform = 'translate(-50%, -50%)';
        dialog.style.backgroundColor = '#FFFFFF';
        dialog.style.padding = '24px 22px';
        dialog.style.borderRadius = '16px';
        dialog.style.boxShadow = '0 18px 40px rgba(15, 23, 42, 0.18)';
        dialog.style.zIndex = '10000';
        dialog.style.width = '440px';
        dialog.style.maxWidth = '94%';
        dialog.style.maxHeight = '90vh';
        dialog.style.overflowY = 'auto';
        dialog.style.display = 'flex';
        dialog.style.flexDirection = 'column';
        dialog.style.gap = '20px';

        // æ ‡é¢˜
        const title = document.createElement('h2');
        title.textContent = 'GitHubå›¾åºŠé…ç½®';
        title.style.margin = '0 0 4px 0';
        title.style.color = '#111827';
        title.style.borderBottom = '1px solid #E5E7EB';
        title.style.paddingBottom = '10px';
        title.style.fontSize = '18px';
        dialog.appendChild(title);

        // åˆ›å»ºè¡¨å•
        const form = document.createElement('form');
        form.style.display = 'flex';
        form.style.flexDirection = 'column';
        form.style.gap = '20px';
        dialog.appendChild(form);

        const tabsStyle2 = document.createElement('style');
        tabsStyle2.textContent = `
            .gh-tabs { display:flex; gap:10px; border-radius: 20px; background:rgba(255,255,255,.8); padding:6px; border:1px solid rgba(229,231,235,.9); }
            .gh-tab { padding:8px 14px; border:none; border-radius: 20px; background:transparent; color:#374151; font-weight:600; cursor:pointer; transition:all .2s ease; font-size:13px; }
            .gh-tab.active { background:linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); color:#fff; box-shadow:0 6px 14px var(--primarycolor-lighter); }
            .gh-tab:not(.active):hover { background:rgba(248,250,252,0.9); }
            @media (max-width: 768px) {
                #github-config-dialog { width: 94% !important; max-width: 420px !important; padding: 18px 14px; border-radius: 16px !important; }
                #github-config-dialog h2 { font-size: 16px !important; }
                #github-config-dialog label { font-size: 13px !important; }
            }
            `;
        document.head.appendChild(tabsStyle2);

        const tabs2 = document.createElement('div');
        tabs2.className = 'gh-tabs';
        const tabRepo = document.createElement('button');
        tabRepo.type = 'button';
        tabRepo.className = 'gh-tab active';
        tabRepo.textContent = 'ä»“åº“è®¾ç½®';
        const tabAuth = document.createElement('button');
        tabAuth.type = 'button';
        tabAuth.className = 'gh-tab';
        tabAuth.textContent = 'è®¤è¯';
        const tabTest = document.createElement('button');
        tabTest.type = 'button';
        tabTest.className = 'gh-tab';
        tabTest.textContent = 'æµ‹è¯•';
        tabs2.appendChild(tabRepo);
        tabs2.appendChild(tabAuth);
        tabs2.appendChild(tabTest);
        form.appendChild(tabs2);

        const repoSection = document.createElement('div');
        const authSection = document.createElement('div');
        const testSection = document.createElement('div');
        repoSection.style.display = 'flex';
        repoSection.style.flexDirection = 'column';
        repoSection.style.gap = '14px';
        repoSection.style.marginTop = '4px';
        authSection.style.display = 'none';
        authSection.style.flexDirection = 'column';
        authSection.style.gap = '16px';
        testSection.style.display = 'none';
        testSection.style.flexDirection = 'column';
        testSection.style.gap = '12px';
        form.appendChild(repoSection);
        form.appendChild(authSection);
        form.appendChild(testSection);

        // å¯ç”¨GitHubå›¾åºŠé€‰é¡¹
        const enableGithubCheckboxContainer = createCustomCheckbox(
            'enable-github',
            DOMAIN_GITHUB_CONFIG.useGithub || false,
            'å¯ç”¨GitHubå›¾åºŠï¼ˆå…¨å±€ï¼šè‡ªåŠ¨ä¸Šä¼ å›¾ç‰‡ï¼‰'
        );
        enableGithubCheckboxContainer.style.marginBottom = '4px';
        repoSection.appendChild(enableGithubCheckboxContainer);

        // è·å–å¯ç”¨GitHubå›¾åºŠå¤é€‰æ¡†çš„å¼•ç”¨
        const enableGithubCheckbox = enableGithubCheckboxContainer.querySelector('#enable-github');

        // å°é¢å›¾åºŠé€‰é¡¹
        const coverBedCheckboxContainer = createCustomCheckbox(
            'cover-bed-enabled',
            COVER_BED_CONFIG.enabled || false,
            'å¯ç”¨å°é¢å›¾åºŠ'
        );
        coverBedCheckboxContainer.style.marginBottom = '4px';
        repoSection.appendChild(coverBedCheckboxContainer);

        // è·å–å°é¢å›¾åºŠå¤é€‰æ¡†çš„å¼•ç”¨
        const coverBedCheckbox = coverBedCheckboxContainer.querySelector('#cover-bed-enabled');

        // Notion GitHubé“¾æ¥æ›¿æ¢é€‰é¡¹
        const replaceNotionGithubCheckboxContainer = createCustomCheckbox(
            'replace-notion-github',
            COVER_BED_CONFIG.replaceNotionGithub || false,
            'æ›¿æ¢éGitHubé“¾æ¥'
        );
        replaceNotionGithubCheckboxContainer.style.marginBottom = '8px';
        repoSection.appendChild(replaceNotionGithubCheckboxContainer);

        // è·å–Notion GitHubé“¾æ¥æ›¿æ¢å¤é€‰æ¡†çš„å¼•ç”¨
        const replaceNotionGithubCheckbox = replaceNotionGithubCheckboxContainer.querySelector('#replace-notion-github');

        // ç”¨æˆ·åè¾“å…¥
        const usernameGroup = document.createElement('div');
        usernameGroup.style.display = 'flex';
        usernameGroup.style.flexDirection = 'column';
        usernameGroup.style.gap = '6px';
        usernameGroup.style.marginTop = '4px';

        const usernameLabel = document.createElement('label');
        usernameLabel.textContent = 'GitHubç”¨æˆ·å:';
        usernameLabel.style.fontWeight = 'bold';
        usernameLabel.style.fontSize = '14px';
        usernameGroup.appendChild(usernameLabel);

        const usernameInput = document.createElement('input');
        usernameInput.type = 'text';
        usernameInput.value = GITHUB_CONFIG.username || '';
        usernameInput.style.padding = '8px';
        usernameInput.style.borderRadius = '20px';
        usernameInput.style.border = '1px solid #ddd';
        usernameInput.style.fontSize = '14px';
        usernameGroup.appendChild(usernameInput);
        repoSection.appendChild(usernameGroup);

        // ä»“åº“åè¾“å…¥
        const repoGroup = document.createElement('div');
        repoGroup.style.display = 'flex';
        repoGroup.style.flexDirection = 'column';
        repoGroup.style.gap = '6px';

        const repoLabel = document.createElement('label');
        repoLabel.textContent = 'ä»“åº“åç§°:';
        repoLabel.style.fontWeight = 'bold';
        repoLabel.style.fontSize = '14px';
        repoGroup.appendChild(repoLabel);

        const repoInput = document.createElement('input');
        repoInput.type = 'text';
        repoInput.value = GITHUB_CONFIG.repo || '';
        repoInput.style.padding = '8px';
        repoInput.style.borderRadius = '20px';
        repoInput.style.border = '1px solid #ddd';
        repoInput.style.fontSize = '14px';
        repoGroup.appendChild(repoInput);
        repoSection.appendChild(repoGroup);

        // åˆ†æ”¯åè¾“å…¥
        const branchGroup = document.createElement('div');
        branchGroup.style.display = 'flex';
        branchGroup.style.flexDirection = 'column';
        branchGroup.style.gap = '6px';
        branchGroup.style.marginBottom = '4px';

        const branchLabel = document.createElement('label');
        branchLabel.textContent = 'åˆ†æ”¯åç§°:';
        branchLabel.style.fontWeight = 'bold';
        branchLabel.style.fontSize = '14px';
        branchGroup.appendChild(branchLabel);

        const branchInput = document.createElement('input');
        branchInput.type = 'text';
        branchInput.value = GITHUB_CONFIG.branch || 'main';
        branchInput.style.padding = '8px';
        branchInput.style.borderRadius = '20px';
        branchInput.style.border = '1px solid #ddd';
        branchInput.style.fontSize = '14px';
        branchGroup.appendChild(branchInput);
        repoSection.appendChild(branchGroup);


        // è·¯å¾„é…ç½®æŒ‰é’®å®¹å™¨
        const pathConfigContainer = document.createElement('div');
        pathConfigContainer.style.cssText = `
            margin-top: 8px;
            padding: 16px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-radius: 20px;
            border: 1px solid #e8f0ff;
            position: relative;
            overflow: hidden;
        `;

        // æ·»åŠ è£…é¥°æ€§èƒŒæ™¯
        const decorationBg = document.createElement('div');
        decorationBg.style.cssText = `
            position: absolute;
            top: -20px;
            right: -20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primarycolor-lighter), var(--primarycolor-light));
            border-radius: 50%;
            opacity: 0.3;
        `;
        pathConfigContainer.appendChild(decorationBg);

        const pathConfigContent = document.createElement('div');
        pathConfigContent.style.cssText = `
            position: relative;
            z-index: 1;
        `;

        const pathConfigTitle = document.createElement('div');
        pathConfigTitle.style.cssText = `
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        `;
        const cfgIcon = document.createElement('span');
        cfgIcon.style.fontSize = '16px';
        cfgIcon.textContent = 'âš™';
        const cfgLabel = document.createElement('span');
        cfgLabel.style.fontWeight = '600';
        cfgLabel.style.color = '#333';
        cfgLabel.style.fontSize = '14px';
        cfgLabel.textContent = 'é«˜çº§è·¯å¾„é…ç½®';
        pathConfigTitle.appendChild(cfgIcon);
        pathConfigTitle.appendChild(cfgLabel);
        pathConfigContent.appendChild(pathConfigTitle);

        const pathConfigDesc = document.createElement('div');
        pathConfigDesc.style.cssText = `
            color: #666;
            font-size: 12px;
            margin-bottom: 12px;
            line-height: 1.4;
        `;
        pathConfigDesc.textContent = 'ä¸ºä¸åŒç±»å‹çš„å†…å®¹è®¾ç½®ä¸“é—¨çš„å›¾ç‰‡å­˜å‚¨è·¯å¾„';
        pathConfigContent.appendChild(pathConfigDesc);

        const pathConfigButton = document.createElement('button');
        const btnIcon = document.createElement('span');
        btnIcon.style.marginRight = '8px';
        btnIcon.textContent = 'âš™';
        const btnText = document.createElement('span');
        btnText.textContent = 'é…ç½®è·¯å¾„';
        const btnArrow = document.createElement('span');
        btnArrow.style.marginLeft = '8px';
        btnArrow.style.fontSize = '12px';
        btnArrow.textContent = 'â†’';
        pathConfigButton.appendChild(btnIcon);
        pathConfigButton.appendChild(btnText);
        pathConfigButton.appendChild(btnArrow);
        pathConfigButton.type = 'button';
        pathConfigButton.style.cssText = `
            width: -webkit-fill-available;
            padding: 12px 16px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 143, 171, 0.2);
        `;
        pathConfigButton.addEventListener('mouseenter', () => {
            pathConfigButton.style.transform = 'translateY(-2px)';
            pathConfigButton.style.boxShadow = '0 4px 16px rgba(255, 143, 171, 0.3)';
        });
        pathConfigButton.addEventListener('mouseleave', () => {
            pathConfigButton.style.transform = 'translateY(0)';
            pathConfigButton.style.boxShadow = '0 2px 8px rgba(255, 143, 171, 0.2)';
        });
        pathConfigButton.addEventListener('click', () => {
            // å…³é—­å½“å‰å¯¹è¯æ¡†
            dialog.style.display = 'none';
            // æ‰“å¼€è·¯å¾„é…ç½®å¯¹è¯æ¡†
            showPathConfigDialog();
        });
        pathConfigContent.appendChild(pathConfigButton);

        pathConfigContainer.appendChild(pathConfigContent);
        repoSection.appendChild(pathConfigContainer);

        // Tokenè¾“å…¥
        const tokenGroup = document.createElement('div');
        tokenGroup.style.display = 'flex';
        tokenGroup.style.flexDirection = 'column';
        tokenGroup.style.gap = '6px';
        tokenGroup.style.marginTop = '8px';

        const tokenLabel = document.createElement('label');
        tokenLabel.textContent = 'GitHub Token:';
        tokenLabel.style.fontWeight = 'bold';
        tokenLabel.style.fontSize = '14px';
        tokenGroup.appendChild(tokenLabel);

        const tokenInput = document.createElement('input');
        tokenInput.type = 'password';
        tokenInput.value = GITHUB_CONFIG.token || '';
        tokenInput.style.padding = '8px';
        tokenInput.style.borderRadius = '20px';
        tokenInput.style.border = '1px solid #ddd';
        tokenInput.style.fontSize = '14px';
        tokenGroup.appendChild(tokenInput);

        // æ·»åŠ æç¤ºä¿¡æ¯
        const tokenHint = document.createElement('small');
        tokenHint.textContent = 'éœ€è¦æœ‰repoæƒé™çš„Personal Access Token';
        tokenHint.style.color = '#666';
        tokenHint.style.fontSize = '12px';
        tokenGroup.appendChild(tokenHint);
        form.appendChild(tokenGroup);

        // åŸŸåé…ç½®éƒ¨åˆ†
        const domainSection = document.createElement('div');
        domainSection.style.borderTop = '1px solid #eee';
        domainSection.style.paddingTop = '14px';
        domainSection.style.marginTop = '6px';
        domainSection.style.display = 'flex';
        domainSection.style.flexDirection = 'column';
        domainSection.style.gap = '10px';
        repoSection.appendChild(domainSection);

        const domainTitle = document.createElement('h3');
        domainTitle.textContent = 'åŸŸåé…ç½®';
        domainTitle.style.margin = '0 0 10px 0';
        domainTitle.style.fontSize = '16px';
        domainTitle.style.color = '#333';
        domainSection.appendChild(domainTitle);

        // å½“å‰åŸŸåCDNé…ç½®
        const currentHost = window.location.hostname;
        const domainCdnGroup = document.createElement('div');
        domainCdnGroup.style.display = 'flex';
        domainCdnGroup.style.flexDirection = 'column';
        domainCdnGroup.style.gap = '6px';
        domainCdnGroup.style.marginBottom = '6px';
        domainCdnGroup.style.backgroundColor = '#f8f9fa';
        domainCdnGroup.style.padding = '12px';
        domainCdnGroup.style.borderRadius = '6px';
        domainCdnGroup.style.border = '1px solid #e9ecef';
        domainSection.appendChild(domainCdnGroup);

        const domainCdnTitle = document.createElement('h4');
        domainCdnTitle.textContent = `ğŸŒ å½“å‰åŸŸå: ${currentHost}`;
        domainCdnTitle.style.margin = '0 0 8px 0';
        domainCdnTitle.style.fontSize = '14px';
        domainCdnTitle.style.color = '#495057';
        domainCdnTitle.style.fontWeight = '600';
        domainCdnGroup.appendChild(domainCdnTitle);

        // å½“å‰åŸŸåCDNå¯ç”¨å¼€å…³
        const domainCdnCheckboxContainer = createCustomCheckbox(
            'domain-cdn-enabled',
            GITHUB_DOMAIN_CONFIG[currentHost]?.enabled || false,
            'åœ¨æ­¤åŸŸåä½¿ç”¨å›¾åºŠï¼ˆæœ¬åŸŸåå°é¢ä¸å†…å®¹å‡ä¸Šä¼ å¹¶ä½¿ç”¨å›¾åºŠè·¯å¾„ï¼Œå³ä½¿ä¸Šæ–¹å…¨å±€æœªå¯ç”¨ï¼›ä¸å½±å“å…¶ä»–ç½‘ç«™ï¼‰'
        );
        domainCdnGroup.appendChild(domainCdnCheckboxContainer);

        // è·å–å½“å‰åŸŸåCDNå¤é€‰æ¡†çš„å¼•ç”¨
        const domainCdnCheckbox = domainCdnCheckboxContainer.querySelector('#domain-cdn-enabled');

        // å½“å‰åŸŸåé…ç½®çš„è¯´æ˜æ–‡æœ¬
        const domainCdnHint = document.createElement('small');
        domainCdnHint.textContent = `å¯ç”¨åï¼Œè®¿é—® ${currentHost} æ—¶ä¼šå°†å›¾ç‰‡ä¸Šä¼ åˆ°GitHubå›¾åºŠï¼Œå…¶ä»–ç½‘ç«™çš„å›¾ç‰‡å¤„ç†æ–¹å¼ä¸å—å½±å“`;
        domainCdnHint.style.color = '#6c757d';
        domainCdnHint.style.fontSize = '11px';
        domainCdnHint.style.lineHeight = '1.4';
        domainCdnHint.style.marginTop = '4px';
        domainCdnGroup.appendChild(domainCdnHint);

        // åŸŸåç±»å‹é€‰æ‹©
        const domainTypeGroup = document.createElement('div');
        domainTypeGroup.style.display = 'flex';
        domainTypeGroup.style.flexDirection = 'column';
        domainTypeGroup.style.gap = '6px';
        domainTypeGroup.style.marginBottom = '4px';
        domainSection.appendChild(domainTypeGroup);

        const domainTypeLabel = document.createElement('label');
        domainTypeLabel.textContent = 'å›¾ç‰‡é“¾æ¥ç±»å‹:';
        domainTypeLabel.style.fontWeight = 'bold';
        domainTypeLabel.style.fontSize = '14px';
        domainTypeGroup.appendChild(domainTypeLabel);

        const domainTypeSelect = document.createElement('select');
        domainTypeSelect.style.padding = '8px';
        domainTypeSelect.style.borderRadius = '20px';
        domainTypeSelect.style.border = '1px solid #ddd';
        domainTypeSelect.style.fontSize = '14px';

        // æ·»åŠ é€‰é¡¹
        const options = [
            { value: 'raw', text: 'Raw GitHub (raw.githubusercontent.com)' },
            { value: 'pages', text: 'GitHub Pages (username.github.io)' },
            { value: 'custom', text: 'è‡ªå®šä¹‰åŸŸå' }
        ];

        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            if (DOMAIN_GITHUB_CONFIG.type === option.value) {
                optionElement.selected = true;
            }
            domainTypeSelect.appendChild(optionElement);
        });

        domainTypeGroup.appendChild(domainTypeSelect);

        // è‡ªå®šä¹‰åŸŸåè¾“å…¥ï¼ˆä»…å½“é€‰æ‹©è‡ªå®šä¹‰åŸŸåæ—¶æ˜¾ç¤ºï¼‰
        const customDomainGroup = document.createElement('div');
        customDomainGroup.style.display = DOMAIN_GITHUB_CONFIG.type === 'custom' ? 'flex' : 'none';
        customDomainGroup.style.flexDirection = 'column';
        customDomainGroup.style.gap = '6px';
        customDomainGroup.style.marginTop = '4px';
        domainSection.appendChild(customDomainGroup);

        const customDomainLabel = document.createElement('label');
        customDomainLabel.textContent = 'è‡ªå®šä¹‰åŸŸå:';
        customDomainLabel.style.fontWeight = 'bold';
        customDomainLabel.style.fontSize = '14px';
        customDomainGroup.appendChild(customDomainLabel);

        const customDomainInput = document.createElement('input');
        customDomainInput.type = 'text';
        customDomainInput.value = DOMAIN_GITHUB_CONFIG.customDomain || '';
        customDomainInput.placeholder = 'ä¾‹å¦‚: cdn.yourdomain.com';
        customDomainInput.style.padding = '8px';
        customDomainInput.style.borderRadius = '20px';
        customDomainInput.style.border = '1px solid #ddd';
        customDomainInput.style.fontSize = '14px';
        customDomainGroup.appendChild(customDomainInput);

        // å½“åŸŸåç±»å‹æ”¹å˜æ—¶æ˜¾ç¤º/éšè—è‡ªå®šä¹‰åŸŸåè¾“å…¥
        domainTypeSelect.addEventListener('change', function() {
            customDomainGroup.style.display = this.value === 'custom' ? 'flex' : 'none';
        });

        const tokenHelp = document.createElement('small');
        tokenHelp.textContent = 'éœ€è¦æœ‰repoæƒé™çš„ä¸ªäººè®¿é—®ä»¤ç‰Œ';
        tokenHelp.style.color = '#666';
        tokenHelp.style.fontSize = '12px';
        tokenGroup.appendChild(tokenHelp);
        authSection.appendChild(tokenGroup);

        // æŒ‰é’®å®¹å™¨
        const buttonsContainer = document.createElement('div');
        buttonsContainer.style.display = 'flex';
        buttonsContainer.style.justifyContent = 'flex-start';
        buttonsContainer.style.gap = '10px';
        buttonsContainer.style.marginTop = '4px';
        testSection.appendChild(buttonsContainer);

        // æµ‹è¯•æŒ‰é’®
        const testButton = document.createElement('button');
        testButton.type = 'button';
        testButton.textContent = 'æµ‹è¯•é…ç½®';
        testButton.style.padding = '8px 16px';
        testButton.style.border = 'none';
        testButton.style.borderRadius = '20px';
        testButton.style.color = 'white';
        testButton.style.cursor = 'pointer';
        testButton.style.fontSize = '14px';
        testButton.style.background = 'linear-gradient(135deg, var(--primarycolor-dark, #FF8FAB), var(--primarycolor, #FF6B9D))';
        testButton.style.flex = '1';
        testButton.addEventListener('click', async () => {
            console.log('GitHubæµ‹è¯•æŒ‰é’®è¢«ç‚¹å‡»');

            // è·å–å½“å‰è¾“å…¥çš„é…ç½®
            const config = {
                username: usernameInput.value.trim(),
                repo: repoInput.value.trim(),
                branch: branchInput.value.trim() || 'main',
                path: 'test', // ä½¿ç”¨ä¸“é—¨çš„æµ‹è¯•è·¯å¾„
                token: tokenInput.value.trim()
            };

            console.log('æµ‹è¯•é…ç½®:', {
                username: config.username,
                repo: config.repo,
                branch: config.branch,
                path: config.path,
                hasToken: !!config.token
            });

            // éªŒè¯é…ç½®
            if (!validateGitHubConfig(config)) {
                console.error('é…ç½®éªŒè¯å¤±è´¥');
                alert('è¯·å¡«å†™å®Œæ•´çš„GitHubé…ç½®ä¿¡æ¯ï¼ˆç”¨æˆ·åã€ä»“åº“åã€Tokenï¼‰');
                return;
            }

            // æ˜¾ç¤ºæµ‹è¯•ä¸­æç¤º
            testButton.textContent = 'æµ‹è¯•ä¸­...';
            testButton.disabled = true;

            try {
                // æ„å»ºæµ‹è¯•API URL
                // ç¡®ä¿è·¯å¾„ä¸åŒ…å«å‰å¯¼æ–œæ ï¼Œå¹¶å¤„ç†å¯èƒ½çš„è·¯å¾„åˆ†éš”ç¬¦é—®é¢˜
                const cleanPath = config.path.replace(/^\/+/, '').replace(/\/+$/, '');
                const apiUrl = `https://api.github.com/repos/${config.username}/${config.repo}/contents/${cleanPath}/test-${Date.now()}.txt`;

                console.log('æµ‹è¯•API URL:', apiUrl);

                // å‡†å¤‡æµ‹è¯•å†…å®¹
                // ä½¿ç”¨encodeURIComponentå¤„ç†éLatin1å­—ç¬¦
                const testContent = 'æµ‹è¯•å†…å®¹ - ' + new Date().toISOString();
                const content = btoa(encodeURIComponent(testContent).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                    return String.fromCharCode('0x' + p1);
                }));

                console.log('å‘é€æµ‹è¯•è¯·æ±‚...');

                // å‘é€æµ‹è¯•è¯·æ±‚ - ä½¿ç”¨æ–°çš„è®¤è¯æ–¹å¼
                __incApi('github', 'PUT', apiUrl);
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                        'User-Agent': 'Notion-Clipper-Test'
                    },
                    body: JSON.stringify({
                        message: 'æµ‹è¯•GitHubå›¾åºŠé…ç½®',
                        content: content,
                        branch: config.branch
                    })
                });

                console.log('å“åº”çŠ¶æ€:', response.status);
                console.log('å“åº”å¤´:', Object.fromEntries(response.headers.entries()));

                if (response.ok) {
                    const responseData = await response.json();
                    console.log('æµ‹è¯•æˆåŠŸ:', responseData);
                    alert('GitHubé…ç½®æµ‹è¯•æˆåŠŸï¼');
                } else {
                    const errorData = await response.json();
                    console.error('æµ‹è¯•å¤±è´¥:', errorData);
                    alert(`æµ‹è¯•å¤±è´¥: ${errorData.message || 'æœªçŸ¥é”™è¯¯'} (çŠ¶æ€ç : ${response.status})`);
                }
            } catch (error) {
                console.error('æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                alert(`æµ‹è¯•å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                testButton.textContent = 'æµ‹è¯•é…ç½®';
                testButton.disabled = false;
            }
        });
        buttonsContainer.appendChild(testButton);

        // ä¿å­˜æŒ‰é’®
        const saveButton = document.createElement('button');
        saveButton.type = 'button';
        saveButton.textContent = 'ä¿å­˜é…ç½®';
        saveButton.style.padding = '8px 16px';
        saveButton.style.border = 'none';
        saveButton.style.borderRadius = '20px';
        saveButton.style.color = 'white';
        saveButton.style.cursor = 'pointer';
        saveButton.style.fontSize = '14px';
        saveButton.style.background = 'linear-gradient(135deg, var(--primarycolor-dark, #FF8FAB), var(--primarycolor, #FF6B9D))';
        saveButton.style.flex = '1';
        saveButton.style.display = 'flex';
        saveButton.style.alignItems = 'center';
        saveButton.style.justifyContent = 'center';
        saveButton.addEventListener('click', () => {
            // è·å–å½“å‰è¾“å…¥çš„é…ç½®
            const config = {
                username: usernameInput.value.trim(),
                repo: repoInput.value.trim(),
                branch: branchInput.value.trim() || 'main',
                coverPath: GITHUB_CONFIG.coverPath || 'images/covers',
                contentPath: GITHUB_CONFIG.contentPath || 'images/content',
                token: tokenInput.value.trim()
            };

            // è·å–åŸŸåé…ç½®
            const useGithub = enableGithubCheckbox.checked;
            const domainType = domainTypeSelect.value;
            const customDomain = customDomainInput.value.trim();

            // è·å–å½“å‰åŸŸåCDNé…ç½®
            const domainCdnEnabled = domainCdnCheckbox.checked;

            // è·å–å°é¢å›¾åºŠé…ç½®
            const coverBedEnabled = coverBedCheckbox.checked;
            const replaceNotionGithub = replaceNotionGithubCheckbox.checked;

            // éªŒè¯é…ç½®
            if (useGithub) {
                // åªæœ‰åœ¨å¯ç”¨GitHubå›¾åºŠæ—¶æ‰éªŒè¯é…ç½®
                if (!config.token || !config.username || !config.repo) {
                    alert('å¯ç”¨GitHubå›¾åºŠæ—¶ï¼Œè¯·å¡«å†™å®Œæ•´çš„GitHubé…ç½®ä¿¡æ¯');
                    return;
                }
            }

            if (domainType === 'custom' && !customDomain) {
                alert('é€‰æ‹©è‡ªå®šä¹‰åŸŸåæ—¶ï¼Œå¿…é¡»å¡«å†™åŸŸå');
                return;
            }

            // ä¿å­˜é…ç½®
            saveGitHubConfig(config.token, config.username, config.repo, config.branch, config.coverPath, config.contentPath, null);
            saveDomainGitHubConfig(useGithub, domainType, customDomain);
            saveCoverBedConfig(coverBedEnabled, replaceNotionGithub);

            // ä¿å­˜å½“å‰åŸŸåCDNé…ç½®
            saveDomainCdnConfig(currentHost, domainCdnEnabled);

            // å…³é—­å¯¹è¯æ¡†
            document.body.removeChild(dialog);

            // è§¦å‘ä¿å­˜äº‹ä»¶
            const event = new Event('github-config-saved');
            document.dispatchEvent(event);
            githubConfigButton.dispatchEvent(event);
        });
        const actionsContainer = document.createElement('div');
        actionsContainer.style.display = 'flex';
        actionsContainer.style.justifyContent = 'space-between';
        actionsContainer.style.gap = '10px';
        actionsContainer.style.marginTop = '12px';
        form.appendChild(actionsContainer);
        actionsContainer.appendChild(saveButton);

        // å–æ¶ˆæŒ‰é’®
        const cancelButton = document.createElement('button');
        cancelButton.type = 'button';
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.style.padding = '8px 16px';
        cancelButton.style.border = '1px solid #ddd';
        cancelButton.style.borderRadius = '20px';
        cancelButton.style.backgroundColor = '#f5f5f5';
        cancelButton.style.cursor = 'pointer';
        cancelButton.style.flex = '1';
        cancelButton.style.display = 'flex';
        cancelButton.style.alignItems = 'center';
        cancelButton.style.justifyContent = 'center';
        cancelButton.onclick = () => {
            document.body.removeChild(dialog);
        };
        actionsContainer.appendChild(cancelButton);

        // ä½¿å¯¹è¯æ¡†å¯æ‹–åŠ¨
        makeDialogDraggable(dialog, title);
        tabRepo.addEventListener('click', () => {
            tabRepo.classList.add('active'); tabAuth.classList.remove('active'); tabTest.classList.remove('active');
            repoSection.style.display = 'block'; authSection.style.display = 'none'; testSection.style.display = 'none';
        });
        tabAuth.addEventListener('click', () => {
            tabAuth.classList.add('active'); tabRepo.classList.remove('active'); tabTest.classList.remove('active');
            repoSection.style.display = 'none'; authSection.style.display = 'block'; testSection.style.display = 'none';
        });
        tabTest.addEventListener('click', () => {
            tabTest.classList.add('active'); tabRepo.classList.remove('active'); tabAuth.classList.remove('active');
            repoSection.style.display = 'none'; authSection.style.display = 'none'; testSection.style.display = 'block';
        });

        // æ·»åŠ å¯¹è¯æ¡†åˆ°é¡µé¢
        document.body.appendChild(dialog);
    }

    // æ˜¾ç¤ºè·¯å¾„é…ç½®å¯¹è¯æ¡†
    function showPathConfigDialog() {
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
        const isMobile = window.innerWidth <= 768;

        // åˆ›å»ºå¯¹è¯æ¡†
        const dialog = document.createElement('div');
        dialog.id = 'path-config-dialog';
        dialog.style.position = 'fixed';
        dialog.style.top = '50%';
        dialog.style.left = '50%';
        dialog.style.transform = 'translate(-50%, -50%)';
        dialog.style.backgroundColor = 'white';
        dialog.style.borderRadius = '20px';
        dialog.style.boxShadow = '0 25px 80px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.1)';
        dialog.style.zIndex = '10001';
        dialog.style.width = '800px';
        dialog.style.maxWidth = '95%';
        dialog.style.maxHeight = '90vh';
        dialog.style.overflow = 'hidden';
        dialog.style.display = 'flex';
        dialog.style.flexDirection = 'column';
        dialog.style.backdropFilter = 'blur(10px)';

        // ç§»åŠ¨ç«¯é€‚é…
        if (isMobile) {
            dialog.style.width = '95%';
            dialog.style.maxWidth = '95%';
            dialog.style.maxHeight = '95vh';
            dialog.style.borderRadius = '16px';
            dialog.style.boxShadow = '0 20px 60px rgba(0, 0, 0, 0.2)';
            dialog.style.top = '2.5%';
            dialog.style.left = '2.5%';
            dialog.style.transform = 'none';
            dialog.style.height = '95vh';
        }

        // æ ‡é¢˜æ 
        const header = document.createElement('div');
        header.style.cssText = `
            background: linear-gradient(135deg, var(--primarycolor) 0%, var(--primarycolor-dark) 100%);
            color: white;
            padding: ${isMobile ? '16px 20px' : '24px 28px'};
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: ${isMobile ? '16px 16px 0 0' : '20px 20px 0 0'};
            position: relative;
            overflow: hidden;
        `;

        // æ·»åŠ è£…é¥°æ€§èƒŒæ™¯
        const headerDecoration = document.createElement('div');
        headerDecoration.style.cssText = `
            position: absolute;
            top: -50px;
            right: -50px;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        `;
        header.appendChild(headerDecoration);

        const titleContainer = document.createElement('div');
        titleContainer.style.cssText = `
            display: flex;
            align-items: center;
            gap: ${isMobile ? '8px' : '12px'};
            position: relative;
            z-index: 1;
        `;
        const headerIcon = document.createElement('div');
        headerIcon.style.width = isMobile ? '32px' : '40px';
        headerIcon.style.height = isMobile ? '32px' : '40px';
        headerIcon.style.background = 'rgba(255, 255, 255, 0.2)';
        headerIcon.style.borderRadius = '20px';
        headerIcon.style.display = 'flex';
        headerIcon.style.alignItems = 'center';
        headerIcon.style.justifyContent = 'center';
        headerIcon.style.fontSize = isMobile ? '16px' : '18px';
        headerIcon.textContent = 'âš™';
        const headerTextWrap = document.createElement('div');
        const headerTitle = document.createElement('h2');
        headerTitle.style.margin = '0';
        headerTitle.style.fontSize = isMobile ? '18px' : '20px';
        headerTitle.style.fontWeight = '700';
        headerTitle.textContent = 'é«˜çº§è·¯å¾„é…ç½®';
        const headerSub = document.createElement('p');
        headerSub.style.margin = '0';
        headerSub.style.fontSize = isMobile ? '12px' : '13px';
        headerSub.style.opacity = '0.9';
        headerSub.style.fontWeight = '400';
        headerSub.textContent = 'ä¸ºä¸åŒç±»å‹çš„å†…å®¹è®¾ç½®ä¸“é—¨çš„å›¾ç‰‡å­˜å‚¨è·¯å¾„';
        headerTextWrap.appendChild(headerTitle);
        headerTextWrap.appendChild(headerSub);
        titleContainer.appendChild(headerIcon);
        titleContainer.appendChild(headerTextWrap);
        header.appendChild(titleContainer);

        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Ã—';
        closeBtn.style.cssText = `
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: ${isMobile ? '18px' : '20px'};
            cursor: pointer;
            padding: 0;
            width: ${isMobile ? '32px' : '36px'};
            height: ${isMobile ? '32px' : '36px'};
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
            closeBtn.style.transform = 'scale(1.05)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            closeBtn.style.transform = 'scale(1)';
        });
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(dialog);
            showGitHubConfigDialog();
        });
        header.appendChild(closeBtn);
        dialog.appendChild(header);

        // å†…å®¹åŒºåŸŸ
        const content = document.createElement('div');
        content.style.cssText = `
            padding: ${isMobile ? '16px' : '28px'};
            overflow-y: auto;
            flex: 1;
            background: linear-gradient(135deg, #fafbff 0%, #f5f7ff 100%);
        `;

        // è·å–å½“å‰è·¯å¾„æ¨¡å¼é…ç½®
        const currentPathModes = GITHUB_CONFIG.pathModes || {};

        // å†…å®¹æ¨¡å¼é…ç½®
        const contentModes = [
            { key: 'comic_cover', label: 'æ¼«ç”»å°é¢', icon: 'ğŸ–¼', color: '#FF8E9B', defaultPath: 'images/comic/cover/' },
            { key: 'novel_cover', label: 'å°è¯´å°é¢', icon: 'ğŸ¨', color: '#45B7D1', defaultPath: 'images/novel/cover/' },
            { key: 'clip_content', label: 'å‰ªè—å†…å®¹', icon: 'ğŸ“‹', color: '#96CEB4', defaultPath: 'images/clip/content/' },
            { key: 'clip_cover', label: 'å‰ªè—å°é¢', icon: 'ğŸ–¼', color: '#FFEAA7', defaultPath: 'images/clip/cover/' }
        ];

        // åˆ›å»ºç½‘æ ¼å¸ƒå±€
        const gridContainer = document.createElement('div');
        gridContainer.style.cssText = `
            display: grid;
            grid-template-columns: ${isMobile ? 'repeat(auto-fit, minmax(280px, 1fr))' : 'repeat(auto-fit, minmax(350px, 1fr))'};
            gap: ${isMobile ? '12px' : '20px'};
            margin-bottom: ${isMobile ? '20px' : '28px'};
        `;

        contentModes.forEach(mode => {
            const card = document.createElement('div');
            card.style.cssText = `
                background: white;
                border: 1px solid #e8f0ff;
                border-radius: ${isMobile ? '12px' : '16px'};
                padding: ${isMobile ? '16px' : '20px'};
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            `;
            card.addEventListener('mouseenter', () => {
                card.style.borderColor = mode.color;
                card.style.boxShadow = `0 8px 25px rgba(0, 0, 0, 0.08), 0 0 0 1px ${mode.color}20`;
                card.style.transform = 'translateY(-2px)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.borderColor = '#e8f0ff';
                card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.04)';
                card.style.transform = 'translateY(0)';
            });

            // å¡ç‰‡è£…é¥°
            const cardDecoration = document.createElement('div');
            cardDecoration.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(90deg, ${mode.color}, ${mode.color}80);
            `;
            card.appendChild(cardDecoration);

            // å¡ç‰‡æ ‡é¢˜
            const cardHeader = document.createElement('div');
            cardHeader.style.cssText = `
                display: flex;
                align-items: center;
                gap: ${isMobile ? '8px' : '12px'};
                margin-bottom: ${isMobile ? '12px' : '16px'};
                position: relative;
                z-index: 1;
            `;
            const iconBox = document.createElement('div');
            iconBox.style.width = isMobile ? '36px' : '44px';
            iconBox.style.height = isMobile ? '36px' : '44px';
            iconBox.style.background = `linear-gradient(135deg, ${mode.color}20, ${mode.color}10)`;
            iconBox.style.borderRadius = '20px';
            iconBox.style.display = 'flex';
            iconBox.style.alignItems = 'center';
            iconBox.style.justifyContent = 'center';
            iconBox.style.fontSize = isMobile ? '16px' : '20px';
            iconBox.style.border = `1px solid ${mode.color}30`;
            iconBox.textContent = mode.icon;
            const textWrap = document.createElement('div');
            const titleText = document.createElement('div');
            titleText.style.fontWeight = '600';
            titleText.style.color = '#333';
            titleText.style.fontSize = isMobile ? '14px' : '15px';
            titleText.style.marginBottom = '2px';
            titleText.textContent = mode.label;
            const subText = document.createElement('div');
            subText.style.color = '#888';
            subText.style.fontSize = isMobile ? '11px' : '12px';
            subText.textContent = 'å›¾ç‰‡å­˜å‚¨è·¯å¾„';
            textWrap.appendChild(titleText);
            textWrap.appendChild(subText);
            cardHeader.appendChild(iconBox);
            cardHeader.appendChild(textWrap);
            card.appendChild(cardHeader);

            // è¾“å…¥æ¡†
            const pathInput = document.createElement('input');
            pathInput.type = 'text';
            pathInput.value = currentPathModes[mode.key] || '';
            pathInput.style.cssText = `
                width: -webkit-fill-available;
                padding: ${isMobile ? '10px 12px' : '12px 16px'};
                border: 1px solid #e0e0e0;
                border-radius: 20px;
                font-size: ${isMobile ? '13px' : '14px'};
                box-sizing: border-box;
                transition: all 0.2s ease;
                background: #ffffff3d;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            `;
            pathInput.placeholder = mode.defaultPath;
            pathInput.addEventListener('focus', () => {
                pathInput.style.borderColor = mode.color;
                pathInput.style.boxShadow = `0 0 0 3px ${mode.color}20`;
                pathInput.style.background = 'white';
            });
            pathInput.addEventListener('blur', () => {
                pathInput.style.borderColor = '#e0e0e0';
                pathInput.style.boxShadow = 'none';
                pathInput.style.background = '#ffffff3d';
            });
            card.appendChild(pathInput);

            gridContainer.appendChild(card);
        });

        content.appendChild(gridContainer);

        // æ–‡ä»¶å¤¹æ¨¡å¼é…ç½®åŒºåŸŸï¼ˆä»…é€‚ç”¨äºå‰ªè—æ¨¡å¼ï¼‰
        const folderModeSection = document.createElement('div');
        folderModeSection.style.cssText = `
            background: white;
            border-radius: ${isMobile ? '12px' : '16px'};
            padding: ${isMobile ? '16px' : '24px'};
            margin-bottom: ${isMobile ? '20px' : '28px'};
            border: 1px solid #e8f0ff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        `;

        const folderModeTitle = document.createElement('div');
        folderModeTitle.style.cssText = `
            display: flex;
            align-items: center;
            gap: ${isMobile ? '8px' : '12px'};
            margin-bottom: ${isMobile ? '16px' : '20px'};
        `;
        const folderIcon = document.createElement('div');
        folderIcon.style.width = isMobile ? '32px' : '36px';
        folderIcon.style.height = isMobile ? '32px' : '36px';
        folderIcon.style.background = 'linear-gradient(135deg, #96CEB4, #FFEAA7)';
        folderIcon.style.borderRadius = '20px';
        folderIcon.style.display = 'flex';
        folderIcon.style.alignItems = 'center';
        folderIcon.style.justifyContent = 'center';
        folderIcon.style.fontSize = isMobile ? '14px' : '16px';
        folderIcon.textContent = 'ğŸ“';
        const folderTextWrap = document.createElement('div');
        const folderTitle = document.createElement('div');
        folderTitle.style.fontWeight = '600';
        folderTitle.style.color = '#333';
        folderTitle.style.fontSize = isMobile ? '15px' : '16px';
        folderTitle.textContent = 'æ–‡ä»¶å¤¹æ¨¡å¼ï¼ˆå‰ªè—ä¸“ç”¨ï¼‰';
        const folderSub = document.createElement('div');
        folderSub.style.color = '#888';
        folderSub.style.fontSize = isMobile ? '11px' : '12px';
        folderSub.textContent = 'ä¸ºæ¯ä¸ªå‰ªè—é¡µé¢åˆ›å»ºç‹¬ç«‹çš„æ–‡ä»¶å¤¹å­˜å‚¨å›¾ç‰‡';
        folderTextWrap.appendChild(folderTitle);
        folderTextWrap.appendChild(folderSub);
        folderModeTitle.appendChild(folderIcon);
        folderModeTitle.appendChild(folderTextWrap);
        folderModeSection.appendChild(folderModeTitle);

        // æ–‡ä»¶å¤¹æ¨¡å¼é€‰é¡¹
        const folderModeCheckboxContainer = createCustomCheckbox(
            'folder-mode-enabled',
            GITHUB_CONFIG.folderMode || false,
            'å¯ç”¨æ–‡ä»¶å¤¹æ¨¡å¼ï¼ˆæ¯ä¸ªç½‘é¡µçš„å›¾ç‰‡æ”¾åœ¨ä»¥é¡µé¢æ ‡é¢˜å‘½åçš„æ–‡ä»¶å¤¹ä¸­ï¼‰'
        );
        folderModeSection.appendChild(folderModeCheckboxContainer);

        // è·å–æ–‡ä»¶å¤¹æ¨¡å¼å¤é€‰æ¡†çš„å¼•ç”¨
        const folderModeCheckbox = folderModeCheckboxContainer.querySelector('#folder-mode-enabled');

        // æ–‡ä»¶å¤¹åŒ…å«å°é¢é€‰é¡¹
        const folderIncludeCoverCheckboxContainer = createCustomCheckbox(
            'folder-include-cover',
            GITHUB_CONFIG.folderIncludeCover || false,
            'æ–‡ä»¶å¤¹æ¨¡å¼ä¸‹åŒ…å«å°é¢ï¼ˆå°é¢ä¹Ÿä¿å­˜åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­ï¼‰'
        );
        folderModeSection.appendChild(folderIncludeCoverCheckboxContainer);

        // è·å–æ–‡ä»¶å¤¹åŒ…å«å°é¢å¤é€‰æ¡†çš„å¼•ç”¨
        const folderIncludeCoverCheckbox = folderIncludeCoverCheckboxContainer.querySelector('#folder-include-cover');

        content.appendChild(folderModeSection);

        // å¿«é€Ÿæ¨¡æ¿åŒºåŸŸ
        const templateSection = document.createElement('div');
        templateSection.style.cssText = `
            background: white;
            border-radius: ${isMobile ? '12px' : '16px'};
            padding: ${isMobile ? '16px' : '24px'};
            margin-bottom: ${isMobile ? '20px' : '28px'};
            border: 1px solid #e8f0ff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        `;

        const templateTitle = document.createElement('div');
        templateTitle.style.cssText = `
            display: flex;
            align-items: center;
            gap: ${isMobile ? '8px' : '12px'};
            margin-bottom: ${isMobile ? '16px' : '20px'};
        `;
        const tmplIcon = document.createElement('div');
        tmplIcon.style.width = isMobile ? '32px' : '36px';
        tmplIcon.style.height = isMobile ? '32px' : '36px';
        tmplIcon.style.background = 'linear-gradient(135deg, #FFD93D, #FF6B6B)';
        tmplIcon.style.borderRadius = '20px';
        tmplIcon.style.display = 'flex';
        tmplIcon.style.alignItems = 'center';
        tmplIcon.style.justifyContent = 'center';
        tmplIcon.style.fontSize = isMobile ? '14px' : '16px';
        tmplIcon.textContent = 'âš¡';
        const tmplTextWrap = document.createElement('div');
        const tmplTitle = document.createElement('div');
        tmplTitle.style.fontWeight = '600';
        tmplTitle.style.color = '#333';
        tmplTitle.style.fontSize = isMobile ? '15px' : '16px';
        tmplTitle.textContent = 'å¿«é€Ÿæ¨¡æ¿';
        const tmplSub = document.createElement('div');
        tmplSub.style.color = '#888';
        tmplSub.style.fontSize = isMobile ? '11px' : '12px';
        tmplSub.textContent = 'ä¸€é”®åº”ç”¨é¢„è®¾çš„è·¯å¾„æ ¼å¼';
        tmplTextWrap.appendChild(tmplTitle);
        tmplTextWrap.appendChild(tmplSub);
        templateTitle.appendChild(tmplIcon);
        templateTitle.appendChild(tmplTextWrap);
        templateSection.appendChild(templateTitle);

        const templateButtons = document.createElement('div');
        templateButtons.style.cssText = `
            display: flex;
            gap: ${isMobile ? '12px' : '16px'};
            flex-wrap: wrap;
        `;

        const templates = [
            {
                name: 'æ ‡å‡†æ ¼å¼',
                icon: 'ğŸ“',
                desc: 'images/ç±»å‹/ç”¨é€”/',
                color: '#667eea',
                paths: {
                    comic_cover: 'images/comic/cover/',
                    novel_cover: 'images/novel/cover/',
                    clip_content: 'images/clip/content/',
                    clip_cover: 'images/clip/cover/'
                }
            },
            {
                name: 'ç®€åŒ–æ ¼å¼',
                icon: 'ğŸ“‚',
                desc: 'ç±»å‹/ç”¨é€”/',
                color: '#f093fb',
                paths: {
                    comic_cover: 'comic/cover/',
                    novel_cover: 'novel/cover/',
                    clip_content: 'clip/content/',
                    clip_cover: 'clip/cover/'
                }
            },
            {
                name: 'åˆ†ç±»æ ¼å¼',
                icon: 'ğŸ—‚',
                desc: 'images/ç”¨é€”/ç±»å‹/',
                color: '#4facfe',
                paths: {
                    comic_cover: 'images/cover/comic/',
                    novel_cover: 'images/cover/novel/',
                    clip_content: 'images/content/clip/',
                    clip_cover: 'images/cover/clip/'
                }
            }
        ];

        templates.forEach(template => {
            const templateCard = document.createElement('div');
            templateCard.style.cssText = `
                flex: 1;
                min-width: ${isMobile ? '150px' : '200px'};
                background: linear-gradient(135deg, ${template.color}10, ${template.color}05);
                border: 1px solid ${template.color}20;
                border-radius: 20px;
                padding: ${isMobile ? '12px' : '16px'};
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            `;
            templateCard.addEventListener('mouseenter', () => {
                templateCard.style.borderColor = template.color;
                templateCard.style.boxShadow = `0 4px 15px ${template.color}20`;
                templateCard.style.transform = 'translateY(-2px)';
            });
            templateCard.addEventListener('mouseleave', () => {
                templateCard.style.borderColor = `${template.color}20`;
                templateCard.style.boxShadow = 'none';
                templateCard.style.transform = 'translateY(0)';
            });
            templateCard.addEventListener('click', () => {
                // åº”ç”¨æ¨¡æ¿
                const inputs = gridContainer.querySelectorAll('input[type="text"]');
                Object.keys(template.paths).forEach((key, index) => {
                    if (inputs[index]) {
                        inputs[index].value = template.paths[key];
                    }
                });
                showNotification(`å·²åº”ç”¨æ¨¡æ¿ï¼š${template.name}`, 'success');
            });

            const cardTop = document.createElement('div');
            cardTop.style.display = 'flex';
            cardTop.style.alignItems = 'center';
            cardTop.style.gap = isMobile ? '8px' : '10px';
            cardTop.style.marginBottom = isMobile ? '6px' : '8px';
            const topIcon = document.createElement('span');
            topIcon.style.fontSize = isMobile ? '16px' : '18px';
            topIcon.textContent = template.icon;
            const topName = document.createElement('span');
            topName.style.fontWeight = '600';
            topName.style.color = '#333';
            topName.style.fontSize = isMobile ? '13px' : '14px';
            topName.textContent = template.name;
            cardTop.appendChild(topIcon);
            cardTop.appendChild(topName);
            const cardDesc = document.createElement('div');
            cardDesc.style.color = '#666';
            cardDesc.style.fontSize = isMobile ? '11px' : '12px';
            cardDesc.style.fontFamily = 'monospace';
            cardDesc.style.background = 'rgba(0,0,0,0.05)';
            cardDesc.style.padding = isMobile ? '3px 6px' : '4px 8px';
            cardDesc.style.borderRadius = '20px';
            cardDesc.textContent = template.desc;
            templateCard.appendChild(cardTop);
            templateCard.appendChild(cardDesc);
            templateButtons.appendChild(templateCard);
        });

        templateSection.appendChild(templateButtons);
        content.appendChild(templateSection);

        dialog.appendChild(content);

        // åº•éƒ¨æŒ‰é’®åŒºåŸŸ
        const footer = document.createElement('div');
        footer.style.cssText = `
            padding: ${isMobile ? '16px 20px' : '24px 28px'};
            border-top: 1px solid #e8f0ff;
            display: flex;
            gap: ${isMobile ? '12px' : '16px'};
            justify-content: flex-end;
            background: white;
            border-radius: ${isMobile ? '0 0 16px 16px' : '0 0 20px 20px'};
        `;

        // å–æ¶ˆæŒ‰é’®
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'å–æ¶ˆ';
        cancelButton.type = 'button';
        cancelButton.style.cssText = `
            padding: ${isMobile ? '10px 20px' : '12px 24px'};
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            color: #666;
            cursor: pointer;
            font-size: ${isMobile ? '13px' : '14px'};
            font-weight: 500;
            transition: all 0.2s ease;
        `;
        cancelButton.addEventListener('mouseenter', () => {
            cancelButton.style.backgroundColor = '#f8f9fa';
            cancelButton.style.borderColor = '#d0d0d0';
        });
        cancelButton.addEventListener('mouseleave', () => {
            cancelButton.style.backgroundColor = 'white';
            cancelButton.style.borderColor = '#e0e0e0';
        });
        cancelButton.addEventListener('click', () => {
            document.body.removeChild(dialog);
            showGitHubConfigDialog();
        });
        footer.appendChild(cancelButton);

        // ä¿å­˜æŒ‰é’®
        const saveButton = document.createElement('button');
        const saveIcon2 = document.createElement('span');
        saveIcon2.style.marginRight = '8px';
        saveIcon2.textContent = 'ğŸ’¾';
        const saveText2 = document.createElement('span');
        saveText2.textContent = 'ä¿å­˜é…ç½®';
        saveButton.appendChild(saveIcon2);
        saveButton.appendChild(saveText2);
        saveButton.type = 'button';
        saveButton.style.cssText = `
            padding: ${isMobile ? '10px 20px' : '12px 24px'};
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));
            color: white;
            cursor: pointer;
            font-size: ${isMobile ? '13px' : '14px'};
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 143, 171, 0.3);
        `;
        saveButton.addEventListener('mouseenter', () => {
            saveButton.style.transform = 'translateY(-2px)';
            saveButton.style.boxShadow = '0 4px 16px rgba(255, 143, 171, 0.4)';
        });
        saveButton.addEventListener('mouseleave', () => {
            saveButton.style.transform = 'translateY(0)';
            saveButton.style.boxShadow = '0 2px 8px rgba(255, 143, 171, 0.3)';
        });
        saveButton.addEventListener('click', () => {
            // æ”¶é›†æ‰€æœ‰è·¯å¾„é…ç½®
            const pathModes = {};
            const inputs = gridContainer.querySelectorAll('input[type="text"]');
            contentModes.forEach((mode, index) => {
                if (inputs[index] && inputs[index].value.trim()) {
                    pathModes[mode.key] = inputs[index].value.trim();
                }
            });

            // è·å–æ–‡ä»¶å¤¹æ¨¡å¼é…ç½®
            const folderModeEnabled = folderModeCheckbox.checked;
            const folderIncludeCoverEnabled = folderIncludeCoverCheckbox.checked;

            // ä¿å­˜é…ç½®
            savePathModesConfig(pathModes);

            // ä¿å­˜æ–‡ä»¶å¤¹æ¨¡å¼é…ç½®
            GM_setValue('github_folder_mode', folderModeEnabled);
            GM_setValue('github_folder_include_cover', folderIncludeCoverEnabled);
            GITHUB_CONFIG.folderMode = folderModeEnabled;
            GITHUB_CONFIG.folderIncludeCover = folderIncludeCoverEnabled;

            showNotification('è·¯å¾„é…ç½®å·²ä¿å­˜', 'success');

            // å…³é—­å¯¹è¯æ¡†
            document.body.removeChild(dialog);

            // é‡æ–°æ‰“å¼€GitHubé…ç½®å¯¹è¯æ¡†
            showGitHubConfigDialog();
        });
        footer.appendChild(saveButton);

        dialog.appendChild(footer);

        // ä½¿å¯¹è¯æ¡†å¯æ‹–åŠ¨
        makeDialogDraggable(dialog, header);

        // æ·»åŠ å¯¹è¯æ¡†åˆ°é¡µé¢
        document.body.appendChild(dialog);
    }


    // æµ‹è¯•çŸ¥ä¹å¤æ‚divç»“æ„çš„è§†é¢‘å¤„ç†
    async function testZhihuVideo() {
        const testHtml = `
            <div><div class="css-bp306l"><div class="css-1h1xzpn"><div class="css-1ld0bim"><div class="css-122y91a"><div class="css-10klw3m"><div class="_1fog6rx"><div class="_1n8yr2n" tabindex="-1"><div class="_190hxbq"><video class="_1k7bcr7" preload="metadata" playsinline="" webkit-playsinline="" x-webkit-airplay="deny" src="https://vdn6.vzuu.com/HD/15b58524-58b2-11ed-b2d6-ba52c9c02448-v8_t21-wkFt3ZybJd.mp4?pkey=AAVXXiMcLUqaLgOmsKUAOGU1xST_uRD3skqZcyAx92hY2LRhvxkeL1coh0UlQBBk-YO1X9Szp_953v1vbrlGronW&bu=1513c7c2&c=avc.8.0&expiration=1757879136&f=mp4&pu=e59e796c&v=ks6&pp=ChMxNDAxNjIzODY1NzM5NTc5MzkyGGMiC2ZlZWRfY2hvaWNlMhMxMzY5MDA1NjA4NTk5OTA0MjU3PXu830Q%3D&pf=Web&pt=zhihu" style="object-fit: contain;"></video></div><div class="_1ie0kc2q"><img class="_1sezuny" src="https://picx.zhimg.com/v2-f84ad4552b91e0e72c8ab41646fdd375.jpg?source=25ab7b06" style="object-fit: contain;"><div class="_18j7m46">00:13</div><div class="_165vphy"><div class="_qrp4qg"><span class="_s54qq0f"><svg viewBox="0 0 72 72" class="_11u3rwe"><g fill="none" fill-rule="evenodd"><circle cx="36" cy="36" r="36" fill="#FFF" fill-opacity=".95"></circle><path fill="#444" fill-rule="nonzero" d="M50.8350169,37.0602664 L29.4767217,49.9693832 C28.900608,50.3175908 28.1558807,50.1251285 27.8133266,49.5395068 C27.701749,49.3487566 27.6428571,49.1309436 27.6428571,48.9090213 L27.6428571,23.0907876 C27.6428571,22.4094644 28.1862113,21.8571429 28.8564727,21.8571429 C29.0747919,21.8571429 29.2890685,21.9170066 29.4767217,22.0304257 L50.8350169,34.9395425 C51.4111306,35.28775 51.6004681,36.0447682 51.257914,36.6303899 C51.154433,36.8072984 51.0090531,36.9550776 50.8350169,37.0602664 Z"></path></g></svg></span></div></div></div><div class="_zynl7m9"><div class="_1smmk5k"></div></div><div class="_mx4dzl"></div><div><div class="css-7xjln5"><div class="css-1umsh5i"></div></div></div></div></div></div></div></div></div></div></div></div></div>
        `;

        console.log('æµ‹è¯•çŸ¥ä¹å¤æ‚divç»“æ„è§†é¢‘å¤„ç†:');
        const result = await extractContent(testHtml);
        console.log('æå–ç»“æœ:', result);
        console.log('è§†é¢‘æ•°æ®:', videoData);
        console.log('---');
    }

    function getVisibleSelectorDefaultConfig(contentType) {
        if (contentType === 'clip') {
            return {
                æ ‡é¢˜: true, ä½œè€…: true, ç®€ä»‹: true, å°é¢: true
            };
        }
        return {
            æ ‡é¢˜: true, ä½œè€…: true, ç®€ä»‹: true, æœ€æ–°ç« èŠ‚: true, æ›´æ–°çŠ¶æ€: true,
            å°é¢: true, è¿½æ›´: true, åˆ«å: true, åœ°åŒº: true, ç±»å‹: true
        };
    }

    function getVisibleSelectorsConfig(contentType) {
        const defaultConfig = getVisibleSelectorDefaultConfig(contentType);
        try {
            const stored = GM_getValue(`visibleSelectors_${contentType}`, defaultConfig);
            return stored || defaultConfig;
        } catch (_) {
            return defaultConfig;
        }
    }

    // é€æ­¥é…ç½®å¯¹è¯æ¡† - é‡å†™ç‰ˆæœ¬
    function showStepConfigDialog() {
        const currentHost = window.location.hostname;
        const customConfigs = loadCustomConfigs();
        const existingConfig = customConfigs[currentHost] || DEFAULT_SITE_CONFIGS[currentHost] || {
            selectors: {
                ç®€ä»‹: "", ä¹¦å: "", ä½œè€…: "", æœ€æ–°ç« èŠ‚: "", æ›´æ–°çŠ¶æ€: "",
                å°é¢: "", è¿½æ›´: "", åˆ«å: "", åœ°åŒº: "", ç±»å‹: ""
            },
            selectorIndices: {
                ç®€ä»‹: 0, ä¹¦å: 0, ä½œè€…: 0, æœ€æ–°ç« èŠ‚: 0, æ›´æ–°çŠ¶æ€: 0,
                å°é¢: 0, è¿½æ›´: 0, åˆ«å: 0, åœ°åŒº: 0, ç±»å‹: 0
            },
            contentType: "comic",
            enableCustomTags: true // é»˜è®¤å¼€å¯è‡ªå®šä¹‰æ ‡ç­¾
        };

        // ç¡®ä¿selectorIndiceså­˜åœ¨
        if (!existingConfig.selectorIndices) {
            existingConfig.selectorIndices = {
                ç®€ä»‹: 0, ä¹¦å: 0, ä½œè€…: 0, æœ€æ–°ç« èŠ‚: 0, æ›´æ–°çŠ¶æ€: 0,
                å°é¢: 0, è¿½æ›´: 0, åˆ«å: 0, åœ°åŒº: 0, ç±»å‹: 0
            };
        }

        const selectorTool = new SelectorTool();
        let config = { ...existingConfig };
        let currentIndex = 0;
        let currentOverlay = null;
        let currentStyle = null;

        function getStepVisibleSelectors(contentType) {
            return getVisibleSelectorsConfig(contentType);
        }

        function mapStepSelectorKey(contentType, key) {
            if (contentType === 'clip' && key === 'ä¹¦å') return 'æ ‡é¢˜';
            return key;
        }

        function getConfigItems(contentType) {
            const baseConfigItems = [
                { key: 'contentType', label: 'å†…å®¹ç±»å‹', type: 'select', options: [
                    { value: 'comic', text: 'æ¼«ç”»' },
                    { value: 'novel', text: 'å°è¯´' },
                    { value: 'clip', text: 'å‰ªè—' }
                ]}
            ];

            const allSelectors = [
                { key: 'ä¹¦å', label: 'ä¹¦å', type: 'selector' },
                { key: 'ä½œè€…', label: 'ä½œè€…', type: 'selector' },
                { key: 'ç®€ä»‹', label: 'ç®€ä»‹', type: 'selector' },
                { key: 'æœ€æ–°ç« èŠ‚', label: 'æœ€æ–°ç« èŠ‚', type: 'selector' },
                { key: 'æ›´æ–°çŠ¶æ€', label: 'æ›´æ–°çŠ¶æ€', type: 'selector' },
                { key: 'å°é¢', label: 'å°é¢', type: 'selector' },
                { key: 'è¿½æ›´', label: 'è¿½æ›´', type: 'selector' },
                { key: 'åˆ«å', label: 'åˆ«å', type: 'selector' },
                { key: 'åœ°åŒº', label: 'åœ°åŒº', type: 'selector' },
                { key: 'ç±»å‹', label: 'ç±»å‹', type: 'selector' }
            ];

            const visibleSelectors = getStepVisibleSelectors(contentType);

            let selectorItems;
            if (contentType === 'clip') {
                selectorItems = [
                    { key: 'contentSelector', label: 'å†…å®¹é€‰æ‹©å™¨', type: 'content' },
                    { key: 'ä¹¦å', label: 'æ ‡é¢˜é€‰æ‹©å™¨', type: 'selector' },
                    { key: 'ä½œè€…', label: 'ä½œè€…é€‰æ‹©å™¨', type: 'selector' },
                    { key: 'å°é¢', label: 'å›¾ç‰‡é€‰æ‹©å™¨', type: 'selector' }
                ];
            } else {
                selectorItems = allSelectors.slice();
            }

            selectorItems = selectorItems.filter(item => {
                if (item.type !== 'selector') return true;
                const visibleKey = mapStepSelectorKey(contentType, item.key);
                return visibleSelectors[visibleKey] !== false;
            });

            return [...baseConfigItems, ...selectorItems];
        }

        // æ˜¾ç¤ºé…ç½®é¡¹
        function showConfigItem(index) {
            if (currentOverlay) {
                document.body.removeChild(currentOverlay);
            }
            if (currentStyle) {
                document.head.removeChild(currentStyle);
            }

            const configItems = getConfigItems(config.contentType || 'comic');

            if (index >= configItems.length) {
                saveConfig();
                return;
            }

            const item = configItems[index];

            // åˆ›å»ºé®ç½©å±‚
            currentOverlay = document.createElement('div');
            currentOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: -webkit-fill-available;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // åˆ›å»ºå¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                border-radius: 20px;
                padding: 20px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                position: relative;
                animation: slideIn 0.3s ease-out;
            `;
            dialog.className = 'notion-index-dialog';

            // ç§»åŠ¨ç«¯é€‚é…
            if (window.innerWidth <= 768) {
                dialog.style.cssText = `
                    background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
                    border-radius: 15px;
                    padding: 20px;
                    max-width: 95%;
                    width: 95%;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    position: relative;
                    animation: slideIn 0.3s ease-out;
                    margin: 10px;
                `;
            }

            // æ·»åŠ æ ·å¼
            currentStyle = document.createElement('style');
            currentStyle.textContent = `
                @keyframes slideIn {
                    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
                    to { opacity: 1; transform: translateY(0) scale(1); }
                }
            `;
            document.head.appendChild(currentStyle);

            // æ ‡é¢˜
            const title = document.createElement('h3');
            const displayLabel = (item.key === 'ä¹¦å' && config.contentType === 'clip') ? 'æ ‡é¢˜' : item.label;
            title.textContent = `âœ¨ ${displayLabel} é…ç½®`;
            title.style.cssText = `
                margin: 0 0 20px 0;
                font-size: 20px;
                font-weight: 700;
                color: #1F2937;
                text-align: center;
            `;

            // ç§»åŠ¨ç«¯æ ‡é¢˜é€‚é…
            if (window.innerWidth <= 768) {
                title.style.fontSize = '18px';
                title.style.marginBottom = '15px';
            }

            // è¿›åº¦æŒ‡ç¤ºå™¨
            const progress = document.createElement('div');
            progress.style.cssText = `
                width: -webkit-fill-available;
                height: 8px;
                background: #E5E7EB;
                border-radius: 20px;
                margin-bottom: 8px;
                overflow: hidden;
            `;
            const progressBar = document.createElement('div');
            progressBar.style.cssText = `
                height: 100%;
                background: linear-gradient(90deg, var(--primarycolor-light, #FF8FAB) 0%, var(--primarycolor, #FF6B9D) 50%, var(--primarycolor-light, #FF8FAB) 100%);
                width: ${((index + 1) / configItems.length) * 100}%;
                border-radius: 20px;
                transition: width 0.3s ease;
            `;
            progress.appendChild(progressBar);

            // è¿›åº¦æ–‡æœ¬
            const progressText = document.createElement('div');
            progressText.textContent = `${index + 1} / ${configItems.length}`;
            progressText.style.cssText = `
                text-align: center;
                color: #6B7280;
                font-size: 13px;
                margin-bottom: 12px;
                font-weight: 500;
            `;

            // æ–‡å­—å®æ—¶é¢„è§ˆï¼ˆé€æ­¥é…ç½®ï¼‰
            const textPreview = document.createElement('div');
            textPreview.className = 'selector-live-preview';
            textPreview.style.cssText = `margin: 8px 0 14px 0;`;
            const updateTextPreview = () => {
                try {
                    if (item.type === 'selector') {
                        const sel = config.selectors[item.key] || '';
                        if (!sel) { textPreview.textContent = 'é¢„è§ˆï¼šæš‚æ— é€‰æ‹©å™¨'; return; }
                        const elements = document.querySelectorAll(sel);
                        if (!elements || elements.length === 0) {
                            textPreview.textContent = 'é¢„è§ˆï¼šæœªåŒ¹é…åˆ°å…ƒç´ ';
                            return;
                        }
                        const idxExp = normalizeIndexValue(
                            config.selectorIndices && config.selectorIndices[item.key] !== undefined
                            ? config.selectorIndices[item.key]
                            : '0'
                        );
                        const selection = resolveElementSelection(elements, idxExp);
                        if (!selection.elements.length) {
                            textPreview.textContent = 'é¢„è§ˆï¼šç´¢å¼•æœªåŒ¹é…åˆ°å…ƒç´ ';
                            return;
                        }
                        if (selection.mode === 'all' || selection.mode === 'multiple') {
                            const texts = selection.elements
                            .map(el => (item.key === 'ç®€ä»‹') ? convertHtmlToNewlines(el.innerHTML) : (el.innerText || el.textContent || '').trim())
                            .filter(Boolean);
                            const merged = joinTextsWithSeparator(item.key, texts);
                            const snippet = merged.substring(0, 80) + (merged.length > 80 ? 'â€¦' : '');
                            textPreview.textContent = `é¢„è§ˆï¼š${snippet}`;
                        } else {
                            const element = selection.elements[0];
                            const txt = (item.key === 'ç®€ä»‹') ? convertHtmlToNewlines(element.innerHTML) : (element.innerText || element.textContent || '').trim();
                            textPreview.textContent = txt ? `é¢„è§ˆï¼š${txt.substring(0, 80)}${txt.length > 80 ? 'â€¦' : ''}` : 'é¢„è§ˆï¼šæœªåŒ¹é…åˆ°å…ƒç´ ';
                        }
                    } else if (item.type === 'content') {
                        const sel = config.contentSelector || '';
                        if (!sel) { textPreview.textContent = 'é¢„è§ˆï¼šæš‚æ— é€‰æ‹©å™¨'; return; }
                        const el = document.querySelector(sel);
                        const txt = el ? (el.innerText || el.textContent || '').trim() : '';
                        textPreview.textContent = txt ? `é¢„è§ˆï¼š${txt.substring(0, 80)}${txt.length > 80 ? 'â€¦' : ''}` : 'é¢„è§ˆï¼šæœªåŒ¹é…åˆ°å…ƒç´ ';
                    } else {
                        textPreview.textContent = '';
                    }
                } catch(_) { textPreview.textContent = 'é¢„è§ˆï¼šé€‰æ‹©å™¨æ— æ•ˆ'; }
            };

            // å†…å®¹åŒºåŸŸ
            const content = document.createElement('div');
            content.style.cssText = `margin-bottom: 25px;`;

            if (item.type === 'select') {
                if (item.key === 'contentType') {
                    const tabs = document.createElement('div');
                    tabs.style.cssText = `
                    display: flex;
                    gap: 10px;
                    border-radius: 20px;
                    background: rgba(255,255,255,0.8);
                    padding: 6px;
                    border: 1px solid rgba(229,231,235,0.9);
                    justify-content: space-evenly;
                `;

                    const createTab = (value, text) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.textContent = text;
                        btn.style.cssText = `
                        padding: 8px 14px;
                        border: none;
                        border-radius: 20px;
                        background: transparent;
                        color: #374151;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        font-size: 13px;
                        width: 30%;
                    `;
                        const applyActive = (active) => {
                            if (active) {
                                btn.style.background = 'linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D))';
                                btn.style.color = '#ffffff';
                                btn.style.boxShadow = '0 6px 14px var(--primarycolor-lighter)';
                            } else {
                                btn.style.background = 'transparent';
                                btn.style.color = '#374151';
                                btn.style.boxShadow = 'none';
                            }
                        };
                        const currentType = config[item.key] || 'comic';
                        applyActive(currentType === value);
                        btn.addEventListener('click', () => {
                            if (config[item.key] === value) return;
                            config[item.key] = value;
                            currentIndex = 0;
                            showConfigItem(0);
                        });
                        return { btn, applyActive };
                    };

                    const tabComic = createTab('comic', 'æ¼«ç”»');
                    const tabNovel = createTab('novel', 'å°è¯´');
                    const tabClip = createTab('clip', 'å‰ªè—');

                    const updateActiveTabs = () => {
                        const currentType = config[item.key] || 'comic';
                        tabComic.applyActive(currentType === 'comic');
                        tabNovel.applyActive(currentType === 'novel');
                        tabClip.applyActive(currentType === 'clip');
                    };

                    tabs.appendChild(tabComic.btn);
                    tabs.appendChild(tabNovel.btn);
                    tabs.appendChild(tabClip.btn);
                    content.appendChild(tabs);
                    updateActiveTabs();
                } else {
                    const select = document.createElement('select');
                    select.style.cssText = `
                    width: -webkit-fill-available;
                    padding: 15px;
                    border: 2px solid transparent;
                    border-radius: 20px;
                    background: #FFFFFF;
                    font-size: 16px;
                    color: #374151;
                    outline: none;
                    transition: all 0.3s ease;
                    box-sizing: border-box;
                `;

                    item.options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        if (config[item.key] === option.value) {
                            optionElement.selected = true;
                        }
                        select.appendChild(optionElement);
                    });

                    select.addEventListener('change', (e) => {
                        config[item.key] = e.target.value;
                        updateTextPreview();
                    });

                    content.appendChild(select);
                }
            } else if (item.type === 'selector') {
                const row = document.createElement('div');
                row.style.cssText = 'display:flex;gap:8px;align-items:center;';
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `è¯·è¾“å…¥${displayLabel}çš„CSSé€‰æ‹©å™¨`;
                input.value = config.selectors[item.key] || '';
                input.dataset.field = item.key;
                input.style.cssText = 'flex:1;padding:15px;height:40px;border:2px solid #E5E7EB;border-radius:30px;background:white;font-size:16px;color:#374151;outline:none;transition:all 0.3s ease;box-sizing:border-box;';
                if (window.innerWidth <= 768) { input.style.padding = '12px'; input.style.fontSize = '14px'; }
                input.addEventListener('input', (e) => { config.selectors[item.key] = e.target.value; updateTextPreview(); });
                const indexInput = document.createElement('input');
                indexInput.type = 'text';
                indexInput.placeholder = 'ç´¢å¼•';
                indexInput.title = 'ç´¢å¼•è¯­æ³•: 1=ç¬¬1ä¸ª, 0/last=æœ€åä¸€ä¸ª, -2=å€’æ•°ç¬¬äºŒ, 2,3,5=å¤šé€‰, 2-5=èŒƒå›´, all=å…¨éƒ¨';
                const presetIndex = (config.selectorIndices && config.selectorIndices[item.key] !== undefined) ? normalizeIndexValue(config.selectorIndices[item.key]) : '0';
                indexInput.value = presetIndex;
                indexInput.style.cssText = 'width:120px;height:40px;padding:0 10px;border:2px solid #E5E7EB;border-radius:30px;font-size:14px;color:#374151;outline:none;transition:all 0.3s ease;box-sizing:border-box;background:white;';
                if (window.innerWidth <= 768) { indexInput.style.width = '100px'; indexInput.style.height = '38px'; }
                indexInput.addEventListener('input', (e) => { config.selectorIndices[item.key] = normalizeIndexExpressionForStorage(e.target.value); updateTextPreview(); });
                row.appendChild(input);
                row.appendChild(indexInput);
                const selectorBtn = document.createElement('button');
                selectorBtn.textContent = 'âœ¦é€‰æ‹©å…ƒç´ ';
                selectorBtn.style.cssText = 'margin-top:10px;padding:12px 20px;background:linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));color:white;border:none;border-radius: 20px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s ease;width:-webkit-fill-available;';
                if (window.innerWidth <= 768) { selectorBtn.style.padding = '10px 16px'; selectorBtn.style.fontSize = '13px'; selectorBtn.style.marginTop = '8px'; }
                selectorBtn.addEventListener('click', (e) => { e.stopPropagation(); currentOverlay.style.display = 'none'; selectorTool.toggleSelectionMode(e, item.key); });
                const imagePreview = document.createElement('img');
                imagePreview.style.cssText = 'display:none;max-width:100%;border-radius: 20px;margin-top:8px;';
                content.appendChild(row);
                content.appendChild(imagePreview);
                content.appendChild(selectorBtn);
            } else if (item.type === 'content') {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `è¯·è¾“å…¥${item.label}çš„CSSé€‰æ‹©å™¨`;
                input.value = config.contentSelector || '';
                input.dataset.field = 'contentSelector';
                input.id = 'step-config-content-selector';
                input.style.cssText = `
                    width: -webkit-fill-available;
                    padding: 15px;
                    border: 2px solid transparent;
                    border-radius: 20px;
                    background: #FFFFFF;
                    font-size: 16px;
                    color: #374151;
                    outline: none;
                    transition: all 0.3s ease;
                    box-sizing: border-box;
                `;
                if (window.innerWidth <= 768) {
                    input.style.padding = '12px';
                    input.style.fontSize = '14px';
                }
                input.addEventListener('input', (e) => {
                    config.contentSelector = e.target.value;
                    updateTextPreview();
                });

                const selectorBtn = document.createElement('button');
                selectorBtn.textContent = 'é€‰æ‹©å…ƒç´ ';
                selectorBtn.style.cssText = `
                    margin-top: 10px;
                    padding: 12px 20px;
                    background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                    color: white;
                    border: none;
                    border-radius: 20px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    width: -webkit-fill-available;
                `;
                if (window.innerWidth <= 768) {
                    selectorBtn.style.padding = '10px 16px';
                    selectorBtn.style.fontSize = '13px';
                    selectorBtn.style.marginTop = '8px';
                }
                selectorBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentOverlay.style.display = 'none';
                    // ä½¿ç”¨å·²æœ‰çš„é€‰æ‹©æ¨¡å¼é”® 'contentSelector'
                    selectorTool.toggleSelectionMode(e, 'contentSelector');
                });

                content.appendChild(input);
                content.appendChild(selectorBtn);
            }

            // åŠ å…¥æ–‡å­—é¢„è§ˆ
            content.appendChild(textPreview);
            updateTextPreview();

            // æŒ‰é’®å®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
            display: flex;
            gap: 12px;
            justify-content: center;
            `;

            // ç§»åŠ¨ç«¯æŒ‰é’®å®¹å™¨é€‚é…
            if (window.innerWidth <= 768) {
                buttonContainer.style.gap = '8px';
                buttonContainer.style.flexDirection = 'column';
            }

            // ä¸Šä¸€æ­¥æŒ‰é’®
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'â—€ï¸ ä¸Šä¸€æ­¥';
            prevBtn.style.cssText = `
            padding: 12px 24px;
            background: var(--primarycolor-lighter);
            color: var(--primarycolor);
            border: 2px solid var(--primarycolor);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            `;

            if (window.innerWidth <= 768) {
                prevBtn.style.padding = '10px 20px';
                prevBtn.style.fontSize = '13px';
            }

            prevBtn.addEventListener('click', () => {
                currentIndex = Math.max(0, index - 1);
                showConfigItem(currentIndex);
            });

            // ä¸‹ä¸€æ­¥æŒ‰é’®
            const nextBtn = document.createElement('button');
            nextBtn.textContent = index === configItems.length - 1 ? 'âœ¨ å®Œæˆé…ç½®' : 'â–¶ï¸ ä¸‹ä¸€æ­¥';
            nextBtn.style.cssText = `
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: white;
                border: none;
                border-radius: 20px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
            `;

            // ç§»åŠ¨ç«¯ä¸‹ä¸€æ­¥æŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                nextBtn.style.padding = '10px 20px';
                nextBtn.style.fontSize = '13px';
            }

            nextBtn.addEventListener('click', () => {
                if (index === configItems.length - 1) {
                    saveConfig();
                    try { showNotification('é€æ­¥é…ç½®å·²ä¿å­˜', 'success'); } catch(_) {}
                    if (currentOverlay) { try { document.body.removeChild(currentOverlay); } catch(_) {} currentOverlay = null; }
                    if (currentStyle) { try { document.head.removeChild(currentStyle); } catch(_) {} currentStyle = null; }
                    return;
                }
                currentIndex = index + 1;
                showConfigItem(currentIndex);
            });

            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'âœ– å–æ¶ˆ';
            cancelBtn.style.cssText = `
                padding: 12px 24px;
                background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
                color: #FFFFFF;
                border: none;
                border-radius: 20px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
            `;

            // ç§»åŠ¨ç«¯å–æ¶ˆæŒ‰é’®é€‚é…
            if (window.innerWidth <= 768) {
                cancelBtn.style.padding = '10px 20px';
                cancelBtn.style.fontSize = '13px';
            }

            cancelBtn.addEventListener('click', () => {
                if (currentOverlay) {
                    document.body.removeChild(currentOverlay);
                }
                if (currentStyle) {
                    document.head.removeChild(currentStyle);
                }
            });

            buttonContainer.appendChild(prevBtn);
            buttonContainer.appendChild(nextBtn);
            buttonContainer.appendChild(cancelBtn);

            dialog.appendChild(title);
            dialog.appendChild(progress);
            dialog.appendChild(progressText);
            dialog.appendChild(content);
            dialog.appendChild(buttonContainer);
            currentOverlay.appendChild(dialog);
            document.body.appendChild(currentOverlay);
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            try {
                config.requireConfiguration = false;
                config.isDefaultConfig = false;

                if (!config.selectors) {
                    config.selectors = {};
                }
                if (!config.selectorIndices) {
                    config.selectorIndices = {};
                }
                if (!config.adjustSelectors) {
                    config.adjustSelectors = function() { return false; };
                }
                if (!config.contentType) {
                    config.contentType = 'comic';
                }

                // ä¿å­˜è‡³ç«™ç‚¹çº§
                GM_setValue(`site_config_${currentHost}`, config);

                // ç»Ÿä¸€ç«™ç‚¹çº§é…ç½®ï¼šæ¸…ç†å½“å‰åŸŸä¸‹çš„æ‰€æœ‰å­è·¯å¾„çº§é…ç½®ï¼Œé¿å…ä¼˜å…ˆçº§è¦†ç›–
                try {
                    const allKeys = GM_listValues();
                    const prefix = `site_config_${currentHost}/`;
                    const subScopeKeys = allKeys.filter(k => k.startsWith(prefix));
                    subScopeKeys.forEach(k => {
                        const hostKey = k.replace('site_config_', '');
                        deleteCustomConfig(hostKey);
                    });
                } catch (_) {}

                try {
                    const currentSiteConfig = getSiteConfig();
                    if (currentSiteConfig.contentType !== 'clip') {
                        setupAutoUpdateObservers(currentSiteConfig, true);
                    } else if (autoUpdateMutationObserver) {
                        autoUpdateMutationObserver.disconnect();
                        autoUpdateMutationObserver = null;
                    }
                    startPeriodicUpdateCheck(true);
                    requestAutoUpdate('site-config-change', 0);
                } catch(_) {}

                showNotification('é…ç½®ä¿å­˜æˆåŠŸï¼Œå¹¶å·²ç»Ÿä¸€ä¸ºç«™ç‚¹çº§ï¼', 'success');
                console.log('é€æ­¥é…ç½®ä¿å­˜æˆåŠŸï¼ˆç«™ç‚¹çº§ä¼˜å…ˆï¼‰:', config);
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                showNotification('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é‡å†™é€‰æ‹©å™¨å·¥å…·çš„showConfigDialogæ–¹æ³•
        const originalShowConfigDialog = selectorTool.showConfigDialog;
        selectorTool.showConfigDialog = function() {
            // æ¢å¤é€æ­¥é…ç½®ç•Œé¢
            if (currentOverlay) {
                currentOverlay.style.display = 'flex';
                // ç¡®ä¿åœ¨ç§»åŠ¨ç«¯ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º
                if (window.innerWidth <= 768) {
                    currentOverlay.style.position = 'fixed';
                    currentOverlay.style.top = '0';
                    currentOverlay.style.left = '0';
                    currentOverlay.style.width = '100%';
                    currentOverlay.style.height = '100%';
                    currentOverlay.style.zIndex = '10000';
                    currentOverlay.style.display = 'flex';
                    currentOverlay.style.justifyContent = 'center';
                    currentOverlay.style.alignItems = 'center';
                }
            } else {
                // å¦‚æœæ²¡æœ‰å½“å‰å¯¹è¯æ¡†ï¼Œé‡æ–°å¼€å§‹é…ç½®
                showConfigItem(currentIndex);
            }
        };

        // å¼€å§‹é€æ­¥é…ç½®
        showConfigItem(0);
    }
    // æ˜¾ç¤ºé€‰æ‹©å™¨é…ç½®å¯¹è¯æ¡†
    function showSelectorsDialog() {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: -webkit-fill-available;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        `;

        const dialog = document.createElement('div');
        dialog.style.cssText = `
            background: linear-gradient(135deg, #FFFFFF 0%, #F8FAFC 100%);
            border-radius: 20px;
            padding: 30px;
            width: 60%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        `;

        // æ·»åŠ è£…é¥°æ€§èƒŒæ™¯
        const decorationBg = document.createElement('div');
        decorationBg.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primarycolor-light, #FF8FAB) 0%, var(--primarycolor, #FF6B9D) 50%, var(--primarycolor-light, #FF8FAB) 100%);
            border-radius: 20px 20px 0 0;
        `;
        dialog.appendChild(decorationBg);

        // æ·»åŠ åŠ¨ç”»æ ·å¼å’Œç§»åŠ¨ç«¯é€‚é…
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px) scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            /* ç§»åŠ¨ç«¯é€‚é… */
            @media (max-width: 768px) {
                .selector-dialog {
                    width: 95% !important;
                    max-width: 95% !important;
                    padding: 20px !important;
                    margin: 10px !important;
                    max-height: 90vh !important;
                    overflow-y: auto !important;
                }

                .selector-dialog h3 {
                    font-size: 24px !important;
                    margin-bottom: 20px !important;
                }

                .selector-dialog .description {
                    font-size: 13px;
                    margin-bottom: 20px !important;
                }

                .selector-dialog .type-container {
                    margin-bottom: 20px !important;
                }

                .selector-dialog .type-select {
                    width: 100% !important;
                    padding: 12px !important;
                    font-size: 16px !important;
                }



                .selector-dialog .selector-item {
                    padding: 16px !important;
                }

                .selector-dialog .selector-label {
                    font-size: 16px !important;
                }

                .selector-dialog .button-container {
                    gap: 10px !important;
                    margin-top: 20px !important;
                }

                .selector-dialog .button-container button {
                    padding: 12px !important;
                    font-size: 15px;
                    border-radius: 12px !important;
                }
            }
        `;
        document.head.appendChild(style);
        dialog.className = 'selector-dialog';

        // æ ‡é¢˜
        const title = document.createElement('h3');
        title.textContent = 'âœ¨ æ˜¾ç¤ºé€‰æ‹©å™¨é…ç½®';
        title.style.cssText = `
            margin: 0 0 30px 0;
            font-size: 28px;
            font-weight: 700;
            color: #1F2937;
            text-align: center;
            position: relative;
            background: linear-gradient(135deg, #1F2937 0%, #374151 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
        `;

        // è¯´æ˜æ–‡å­—
        const description = document.createElement('div');
        description.className = 'description';
        description.textContent = 'å‹¾é€‰è¦åœ¨é…ç½®ç•Œé¢ä¸­æ˜¾ç¤ºçš„é€‰æ‹©å™¨ï¼Œä¸å‹¾é€‰çš„é€‰æ‹©å™¨å°†åœ¨é…ç½®ç•Œé¢ä¸­éšè—';
        description.style.cssText = `
            text-align: center;
            color: #6B7280;
            margin-bottom: 25px;
            font-size: 14px;
            line-height: 1.5;
        `;

        // å†…å®¹ç±»å‹é€‰æ‹©
        const typeContainer = document.createElement('div');
        typeContainer.className = 'type-container';
        typeContainer.style.cssText = `
            margin-bottom: 25px;
            text-align: center;
        `;

        const tabsStyle = document.createElement('style');
        tabsStyle.textContent = `
            .type-tabs { display:inline-flex; gap:10px; border-radius: 20px; background:rgba(255,255,255,.6); padding:6px; border:1px solid rgba(229,231,235,.8); }
            .type-tab { padding:8px 14px; border:none; border-radius: 20px; background:transparent; color:#374151; font-weight:600; cursor:pointer; transition:all .2s ease; }
            .type-tab.active { background:linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D)); color:#fff; box-shadow:0 6px 14px var(--primarycolor-lighter); }
            `;
        document.head.appendChild(tabsStyle);

        const tabs = document.createElement('div');
        tabs.className = 'type-tabs';
        const tabComic = document.createElement('button');
        tabComic.className = 'type-tab active';
        tabComic.textContent = 'æ¼«ç”»';
        const tabNovel = document.createElement('button');
        tabNovel.className = 'type-tab';
        tabNovel.textContent = 'å°è¯´';
        tabs.appendChild(tabComic);
        tabs.appendChild(tabNovel);

        const typeLabel = document.createElement('label');
        typeLabel.textContent = 'é€‰æ‹©å†…å®¹ç±»å‹ï¼š';
        typeLabel.style.cssText = `
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
            color: #374151;
        `;

        const typeSelect = document.createElement('select');
        typeSelect.id = 'selector-type-select';
        typeSelect.className = 'type-select';
        typeSelect.style.cssText = `
            padding: 12px 20px;
            border: 2px solid #E5E7EB;
            border-radius: 20px;
            background: white;
            font-size: 16px;
            color: #374151;
            outline: none;
            transition: all 0.3s ease;
            min-width: 200px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        `;

        const comicOption = document.createElement('option');
        comicOption.value = 'comic';
        comicOption.textContent = 'æ¼«ç”»';
        typeSelect.appendChild(comicOption);

        const novelOption = document.createElement('option');
        novelOption.value = 'novel';
        novelOption.textContent = 'å°è¯´';
        typeSelect.appendChild(novelOption);

        // å‰ªè—æ¨¡å¼ä¸æ”¯æŒæ˜¾ç¤ºé€‰æ‹©å™¨ï¼Œç§»é™¤è¯¥é€‰é¡¹

        typeContainer.appendChild(typeLabel);
        typeContainer.appendChild(tabs);

        // é€‰æ‹©å™¨é…ç½®åŒºåŸŸ
        const selectorsContainer = document.createElement('div');
        selectorsContainer.id = 'selectors-config';
        selectorsContainer.style.cssText = `
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        `;

        // æŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'button-container';
        buttonContainer.style.cssText = `
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 25px;
        `;

        // å…¨é€‰/å…¨ä¸é€‰æŒ‰é’®
        const selectAllBtn = document.createElement('button');
        selectAllBtn.textContent = 'å…¨é€‰';
        selectAllBtn.style.cssText = `
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--primarycolor, #FF8FAB), var(--primarycolor-dark, #FF6B9D));
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 6px 18px var(--primarycolor-lighter);
        `;
        selectAllBtn.addEventListener('mouseenter', () => {
            selectAllBtn.style.transform = 'translateY(-2px)';
            selectAllBtn.style.boxShadow = '0 10px 22px var(--primarycolor-lighter)';
        });
        selectAllBtn.addEventListener('mouseleave', () => {
            selectAllBtn.style.transform = 'translateY(0)';
            selectAllBtn.style.boxShadow = 'none';
        });

        const deselectAllBtn = document.createElement('button');
        deselectAllBtn.textContent = 'å…¨ä¸é€‰';
        deselectAllBtn.style.cssText = `
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 6px 18px var(--primarycolor-lighter);
        `;
        deselectAllBtn.addEventListener('mouseenter', () => {
            deselectAllBtn.style.transform = 'translateY(-2px)';
            deselectAllBtn.style.boxShadow = '0 10px 22px var(--primarycolor-lighter)';
        });
        deselectAllBtn.addEventListener('mouseleave', () => {
            deselectAllBtn.style.transform = 'translateY(0)';
            deselectAllBtn.style.boxShadow = 'none';
        });

        // ä¿å­˜æŒ‰é’®
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'âœ“ ä¿å­˜é…ç½®';
        saveBtn.style.cssText = `
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--primarycolor), var(--primarycolor-dark));
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 6px 18px var(--primarycolor-lighter);
        `;
        saveBtn.addEventListener('mouseenter', () => {
            saveBtn.style.transform = 'translateY(-2px)';
            saveBtn.style.boxShadow = '0 10px 22px var(--primarycolor-lighter)';
        });
        saveBtn.addEventListener('mouseleave', () => {
            saveBtn.style.transform = 'translateY(0)';
            saveBtn.style.boxShadow = 'none';
        });

        // å…³é—­æŒ‰é’®
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ¨ å…³é—­';
        closeBtn.style.cssText = `
            padding: 10px 16px;
            background: white;
            color: #374151;
            border: 1px solid var(--input-border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: none;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'white';
            closeBtn.style.transform = 'translateY(-2px)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'white';
            closeBtn.style.transform = 'translateY(0)';
        });

        // æ˜¾ç¤ºé€‰æ‹©å™¨é…ç½®å‡½æ•°
        function displaySelectorConfig(type) {
            while (selectorsContainer.firstChild) {
                selectorsContainer.removeChild(selectorsContainer.firstChild);
            }

            const visibleSelectors = getVisibleSelectorsConfig(type);

            const selectorsToShow = getSelectorsForType(type);

            // åˆ›å»ºé€‰æ‹©å™¨é…ç½®åˆ—è¡¨
            const selectorsList = document.createElement('div');
            selectorsList.className = 'selectors-list';
            selectorsList.style.cssText = `
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            `;

            selectorsToShow.forEach(selector => {
                const selectorItem = document.createElement('div');
                selectorItem.className = 'selector-item';
                selectorItem.style.cssText = `
                    background: white;
                    border-radius: 20px;
                    padding: 15px;
                    border: 2px solid #E5E7EB;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                `;

                const checkboxContainer = createCustomCheckbox(
                    `selector_${selector.key}`,
                    visibleSelectors[selector.key] !== false,
                    selector.label
                );

                selectorItem.appendChild(checkboxContainer);
                selectorsList.appendChild(selectorItem);
            });

            selectorsContainer.appendChild(selectorsList);

            // æŒ‰é’®äº‹ä»¶å°†åœ¨å¤–éƒ¨ç»Ÿä¸€å¤„ç†

            saveBtn.onclick = () => {
                const newConfig = {};
                selectorsToShow.forEach(selector => {
                    const checkbox = document.getElementById(`selector_${selector.key}`);
                    if (checkbox) {
                        newConfig[selector.key] = checkbox.checked;
                    }
                });
                GM_setValue(`visibleSelectors_${type}`, newConfig);
                showNotification(`${type === 'comic' ? 'æ¼«ç”»' : type === 'novel' ? 'å°è¯´' : 'å‰ªè—'}é€‰æ‹©å™¨æ˜¾ç¤ºé…ç½®å·²ä¿å­˜`, 'success');
            };
        }

        // äº‹ä»¶å¤„ç†
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(overlay);
            document.head.removeChild(style);
        });

        typeSelect.addEventListener('change', (e) => {
            displaySelectorConfig(e.target.value);
            tabComic.classList.toggle('active', e.target.value === 'comic');
            tabNovel.classList.toggle('active', e.target.value === 'novel');
        });

        tabComic.addEventListener('click', () => {
            if (typeSelect.value !== 'comic') {
                typeSelect.value = 'comic';
                typeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
        tabNovel.addEventListener('click', () => {
            if (typeSelect.value !== 'novel') {
                typeSelect.value = 'novel';
                typeSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });

        // å…¨é€‰æŒ‰é’®äº‹ä»¶å¤„ç†
        selectAllBtn.addEventListener('click', () => {
            const currentType = typeSelect.value;
            const selectorsToShow = getSelectorsForType(currentType);
            selectorsToShow.forEach(selector => {
                const checkbox = document.getElementById(`selector_${selector.key}`);
                if (checkbox) {
                    checkbox.checked = true;
                    // æ‰‹åŠ¨æ›´æ–°è§†è§‰çŠ¶æ€
                    updateCheckboxVisualState(checkbox, true);
                }
            });
        });

        // å…¨ä¸é€‰æŒ‰é’®äº‹ä»¶å¤„ç†
        deselectAllBtn.addEventListener('click', () => {
            const currentType = typeSelect.value;
            const selectorsToShow = getSelectorsForType(currentType);
            selectorsToShow.forEach(selector => {
                const checkbox = document.getElementById(`selector_${selector.key}`);
                if (checkbox) {
                    checkbox.checked = false;
                    // æ‰‹åŠ¨æ›´æ–°è§†è§‰çŠ¶æ€
                    updateCheckboxVisualState(checkbox, false);
                }
            });
        });

        // æ›´æ–°å¤é€‰æ¡†è§†è§‰çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
        function updateCheckboxVisualState(checkbox, isChecked) {
            const container = checkbox.parentElement;
            if (container) {
                const customCheckbox = container.querySelector('div[style*="border-radius: 50%"]');
                const innerCircle = customCheckbox ? customCheckbox.querySelector('div') : null;

                if (customCheckbox && innerCircle) {
                    if (isChecked) {
                        customCheckbox.style.borderColor = '#FF8FAB';
                        customCheckbox.style.boxShadow = '0 0 0 2px rgba(255, 143, 171, 0.2)';
                        innerCircle.style.opacity = '1';
                        innerCircle.style.transform = 'scale(1)';
                    } else {
                        customCheckbox.style.borderColor = '#e5e7eb';
                        customCheckbox.style.boxShadow = 'none';
                        innerCircle.style.opacity = '0';
                        innerCircle.style.transform = 'scale(0)';
                    }
                }
            }
        }

        // è·å–å½“å‰ç±»å‹çš„é€‰æ‹©å™¨åˆ—è¡¨çš„è¾…åŠ©å‡½æ•°
        function getSelectorsForType(type) {
            if (type === 'comic' || type === 'novel') {
                return [
                    { key: 'ä¹¦å', label: 'ä¹¦å' },
                    { key: 'ä½œè€…', label: 'ä½œè€…' },
                    { key: 'ç®€ä»‹', label: 'ç®€ä»‹' },
                    { key: 'æœ€æ–°ç« èŠ‚', label: 'æœ€æ–°ç« èŠ‚' },
                    { key: 'æ›´æ–°çŠ¶æ€', label: 'æ›´æ–°çŠ¶æ€' },
                    { key: 'å°é¢', label: 'å°é¢' },
                    { key: 'è¿½æ›´', label: 'è¿½æ›´' },
                    { key: 'åˆ«å', label: 'åˆ«å' },
                    { key: 'åœ°åŒº', label: 'åœ°åŒº' },
                    { key: 'ç±»å‹', label: 'ç±»å‹' }
                ];
            }
            return [];
        }

        // åˆå§‹æ˜¾ç¤ºï¼ˆä¸åŒ…å«å‰ªè—ï¼‰
        displaySelectorConfig('comic');

        buttonContainer.appendChild(selectAllBtn);
        buttonContainer.appendChild(deselectAllBtn);
        buttonContainer.appendChild(saveBtn);
        buttonContainer.appendChild(closeBtn);

        dialog.appendChild(title);
        dialog.appendChild(description);
        dialog.appendChild(typeContainer);
        dialog.appendChild(selectorsContainer);
        dialog.appendChild(buttonContainer);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
    }
})();

// ===== ä»£ç å—ä¿®å¤è¡¥ä¸ =====
// è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š
// 1. "Bash" æ˜ å°„ä¸º "bash"
// 2. Prismé«˜äº®æ ¼å¼æ”¯æŒ
// 3. "undefined" è¯­è¨€å¤„ç†

(function() {
    'use strict';

    // ä¿®å¤normalizeLanguageå‡½æ•°
    if (typeof normalizeLanguage === 'function') {
        const originalNormalizeLanguage = normalizeLanguage;
        window.normalizeLanguage = function(language) {
            // ç‰¹æ®Šå¤„ç†Bashç­‰å¤§å†™è¯­è¨€
            if (language === 'Bash') {
                console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šBash -> bash');
                return 'bash';
            }

            // å¤„ç†undefined/nullæƒ…å†µ
            if (language === 'undefined' || language === 'null') {
                console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šundefined -> plain text');
                return 'plain text';
            }

            // è°ƒç”¨åŸå§‹å‡½æ•°
            return originalNormalizeLanguage.call(this, language);
        };
    }

    // ä¿®å¤parseHtmlCodeBlockså‡½æ•°
    if (typeof parseHtmlCodeBlocks === 'function') {
        const originalParseHtmlCodeBlocks = parseHtmlCodeBlocks;
        window.parseHtmlCodeBlocks = function(html) {
            if (!html) return '';

            let result = html;

            // å¤„ç†è…¾è®¯äº‘å¼€å‘è€…å¹³å°æ ¼å¼æˆ–å…¶ä»–å¤æ‚ä»£ç å—æ ¼å¼
            console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šæ£€æŸ¥å„ç§ä»£ç å—æ ¼å¼...');

            // è°ƒè¯•ï¼šæ£€æµ‹åŒ…å«JavaScriptå¯¹è±¡çš„æ‰€æœ‰å…ƒç´ 
            const allJsElements = result.match(/<(?:[^>']*[^>]*>).*?[{].*?[}].*?<\/(?:[^>]*)>/gis);
            if (allJsElements) {
                console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå‘ç°åŒ…å«JSå¯¹è±¡çš„å…ƒç´ :', allJsElements.length, 'ä¸ª');
                allJsElements.forEach((el, index) => {
                    console.log(`ğŸ”§ å…ƒç´ ${index + 1}:`, el.substring(0, 100) + '...');
                });
            }

            // ä¸“é—¨é’ˆå¯¹GitHubé…ç½®ä»£ç å—çš„å¤„ç† - æ›´ç²¾ç¡®çš„åŒ¹é…
            // åŒ¹é…åŒ…å«"ä»£ç è¯­è¨€ï¼šjavascript"å’Œå®é™…ä»£ç çš„å†…å®¹
            const tencentCodeBlockRegex = /<(?:div|pre|span)[^>]*>.*?(?:ä»£ç è¯­è¨€ï¼š|ä»£ç è¿è¡Œæ¬¡æ•°ï¼š|è¿è¡Œ.*?å¤åˆ¶).*?([{][^}]*[}]).*?<\/(?:div|pre|span)>/gis;
            const tencentMatches = result.match(tencentCodeBlockRegex);
            if (tencentMatches) {
                console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå‘ç°è…¾è®¯äº‘ä»£ç å—:', tencentMatches.length, 'ä¸ª');
                tencentMatches.forEach((match, index) => {
                    console.log(`ğŸ”§ è…¾è®¯äº‘ä»£ç å—${index + 1}:`, match.substring(0, 200) + '...');

                    // æå–çº¯ä»£ç å†…å®¹ï¼Œè·³è¿‡å·¥å…·æ æ–‡å­—
                    console.log('ğŸ”§ æ­£åœ¨åˆ†æå®Œæ•´çš„ä»£ç å—ç»“æ„...');
                    const parsed = new DOMParser().parseFromString(match.replace(/<(?:div|pre|span)[^>]*>/, '').replace(/<\/(?:div|pre|span)>$/, ''), 'text/html');
                    const allText = (parsed.body && parsed.body.textContent) ? parsed.body.textContent : (parsed.documentElement && parsed.documentElement.textContent) ? parsed.documentElement.textContent : '';
                    const jsObjectMatch = allText.match(/[{][^}]*[}]/g);
                    if (jsObjectMatch && jsObjectMatch.length > 0) {
                        const codeObject = jsObjectMatch[jsObjectMatch.length - 1]; // å–æœ€åä¸€ä¸ªå¯¹è±¡
                        console.log('ğŸ”§ æå–åˆ°ä»£ç å¯¹è±¡:', codeObject);

                        // æ›¿æ¢æ•´ä¸ªåŒ¹é…ä¸ºä»£ç å—
                        result = result.replace(match, `\`\`\`javascript\n${codeObject}\n\`\`\``);
                    }
                });
            }

            // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥åŒ¹é…JavaScriptå¯¹è±¡ï¼Œä¸ç®¡HTMLç»“æ„
            result = result.replace(/(?:[^{]*\n)*[{][^}]*['"]name['"][^}]*\n[^}]*['"]repo['"][^}]*[}][^}]*(?:\n[^{]*)*/gis, (match) => {
                if (match.includes('{') && match.includes("'name'") && match.includes("'repo'")) {
                    console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå¤‡ç”¨æ–¹æ¡ˆåŒ¹é…åˆ°GitHubé…ç½®');

                    // æ¸…ç†HTMLæ ‡ç­¾å’Œå¤šä½™æ–‡å­—
                    const cleanCode = match
                    .replace(/<[^>]+>/g, '')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .replace(/(?:ä»£ç è¯­è¨€|ä»£ç è¿è¡Œæ¬¡æ•°|è¿è¡Œ|å¤åˆ¶)[^}]*/gi, '') // ç§»é™¤å·¥å…·æ æ–‡å­—
                    .trim();

                    // æ‰¾å‡ºJavaScriptå¯¹è±¡
                    const jsMatch = cleanCode.match(/[{][^}]*[}]/);
                    if (jsMatch) {
                        console.log('ğŸ”§ å¤‡ç”¨æ–¹æ¡ˆæå–çš„ä»£ç :', jsMatch[0]);
                        return `\`\`\`javascript\n${jsMatch[0]}\n\`\`\``;
                    }
                }
                return match;
            });

            // 1. å¤„ç†Prismé«˜äº®æ ¼å¼
            result = result.replace(/<pre[^>]*class="[^"]*prism-token[^"]*language-([^"\s]+)[^"]*"[^>]*>.*?<code[^>]*class="[^"]*language-([^"\s]+)[^"]*"[^>]*>(.*?)<\/code><\/pre>/gis, (match, lang1, lang2, code) => {
                console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå¤„ç†Prismä»£ç å—:', { lang1, lang2 });
                const codeContent = code
                .replace(/<br\s*\/?>/gi, '\n')
                .replace(/<span[^>]*>([^<]*)<\/span>/g, '$1')
                .replace(/<[^>]+>/g, '')
                .trim();
                const normalizedLang = normalizeLanguage(lang2 || lang1);
                console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šè½¬æ¢ç»“æœ:', normalizedLang);
                return `\`\`\`${normalizedLang}\n${codeContent}\n\`\`\``;
            });

            // 2. å¤„ç†è…¾è®¯äº‘å¼€å‘è€…å¹³å°ä»£ç å—æ ¼å¼ - æ›´å‡†ç¡®çš„åŒ¹é…
            // é¦–å…ˆå°è¯•åŒ¹é…å®Œæ•´çš„JavaScriptå¯¹è±¡
            result = result.replace(/<(?:div|pre|span)[^>]*>(?:.*?|\s*)([{].*?[}]\s*(?:<[^>]*>)*.*?(?:<\/(?:div|pre|span)>)?<\/(?:div|pre|span)>)/gis, (match, potentialCode) => {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«JavaScriptå¯¹è±¡ç»“æ„
                if (potentialCode && potentialCode.includes('{') && potentialCode.includes('\'')) {
                    console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šæ£€æµ‹åˆ°JavaScriptå¯¹è±¡ç»“æ„');

                    // æå–çº¯å‡€çš„ä»£ç å†…å®¹ï¼Œè·³è¿‡æ³¨é‡Šæ–‡å­—
                    const codeMatch = potentialCode.match(/[{][^}]*[}]/g);
                    if (codeMatch) {
                        const codeContent = codeMatch[0] // å–ç¬¬ä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡
                        .replace(/<[^>]+>/g, '')  // ç§»é™¤HTMLæ ‡ç­¾
                        .replace(/&lt;/g, '<')
                        .replace(/&gt;/g, '>')
                        .replace(/&amp;/g, '&')
                        .replace(/&quot;/g, '"')
                        .replace(/&#39;/g, "'")
                        .trim();

                        console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šæå–åˆ°JavaScriptä»£ç :', codeContent.substring(0, 50) + '...');
                        return `\`\`\`javascript\n${codeContent}\n\`\`\``;
                    }
                }
                return match;
            });

            // 3. å¤‡ç”¨æ–¹æ¡ˆï¼šæ›´å®½æ¾çš„åŒ¹é…ï¼Œä¸“é—¨å¤„ç†å¯èƒ½çš„æ–‡å­—ç¯ç»•ä»£ç çš„æƒ…å†µ
            result = result.replace(/<(?:div|pre|span)[^>]*>.*?([{][^}]*[}]).*?<\/(?:div|pre|span)>/gis, (match, jsObject) => {
                if (jsObject && jsObject.includes('\'') && (jsObject.includes('\'name\'') || jsObject.includes('\'repo\''))) {
                    console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå®½æ¾åŒ¹é…æ£€æµ‹åˆ°GitHubé…ç½®å¯¹è±¡');
                    const codeContent = jsObject
                    .replace(/<[^>]+>/g, '')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .trim();

                    console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šæ¸…ç†åçš„ä»£ç :', codeContent);
                    return `\`\`\`javascript\n${codeContent}\n\`\`\``;
                }
                return match;
            });

            // 3. å¤„ç†æ›´å®½æ³›çš„ä»£ç å—æ¨¡å¼
            result = result.replace(/<(?:pre|div|span)[^>]*class="[^"]*(?:code|Code|javascript|lang)[^"]*"[^>]*>(.*?)<\/(?:pre|div|span)>/gis, (match, code) => {
                if (code && code.length > 20 && (code.includes('{') || code.includes('function') || code.includes("'"))) {
                    console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå®½æ³›åŒ¹é…æ£€æµ‹åˆ°ä»£ç å—');
                    const codeContent = code
                    .replace(/<[^>]+>/g, '')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .trim();

                    if (codeContent.includes("'name'") && codeContent.includes("'repo'")) {
                        console.log('ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šè¯†åˆ«ä¸ºGitHubé…ç½®ä»£ç å—');
                        return `\`\`\`javascript\n${codeContent}\n\`\`\``;
                    }
                }
                return match;
            });

            // 4. å¤„ç† hljs language-undefined æ ¼å¼
            // <pre><code data-highlights="yes" class="hljs language-undefined">æ³¨é‡Š</code></pre>
            result = result.replace(/<pre[^>]*>.*?<code[^>]*data-highlighted[^>]*class="[^"]*hljs[^"]*language-undefined[^"]*"[^>]*>(.*?)<\/code>.*?<\/pre>/gis, (match, code) => {
                if (code && code.trim()) {
                    console.log('ğŸ¨ ä¿®å¤è¡¥ä¸ï¼šæ£€æµ‹åˆ° hljs language-undefined ä»£ç å—ï¼Œä¸ºæºä»£ç æ·»åŠ è“è‰²èƒŒæ™¯æ ·å¼æç¤º');

                    // æå–çº¯å‡€çš„ä»£ç å†…å®¹
                    const codeContent = code
                    .replace(/<[^>]+>/g, '')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .replace(/&nbsp;/g, ' ')
                    .trim();

                    // ä¸ºäº†æ ‡è®°è¿™æ˜¯ undefined è¯­è¨€ç±»å‹ï¼Œæˆ‘ä»¬åœ¨æ³¨é‡Šä¸­æ·»åŠ æ ·å¼æç¤º
                    const styledCodeBlock = `\`\`\`plain text
    /* ğŸ¨ language-undefined æ ¼å¼ - å¤šè¡Œæ³¨é‡Šä»£ç  */
    ${codeContent}
    \`\`\``;

                    console.log('ğŸ¨ ä¿®å¤è¡¥ä¸ï¼šæ·»åŠ è“è‰²èƒŒæ™¯æ ·å¼æç¤ºï¼Œæ¸…ç†åçš„ä»£ç :', codeContent.substring(0, 50) + '...');
                    return styledCodeBlock;
                }
                return match;
            });

            // 5. å¤„ç†æ›´å®½æ³›çš„ hljs æ ¼å¼ï¼ˆæ”¯æŒå…¶ä»–è¯­è¨€ï¼‰
            result = result.replace(/<pre[^>]*>.*?<code[^>]*class="[^"]*hljs[^"]*language-([^"\s]+)[^"]*"[^>]*>(.*?)<\/code>.*?<\/pre>/gis, (match, language, code) => {
                if (code && code.trim()) {
                    console.log('ğŸ¨ ä¿®å¤è¡¥ä¸ï¼šæ£€æµ‹åˆ° hljs ä»£ç å—ï¼Œè¯­è¨€:', language);

                    // æå–çº¯å‡€çš„ä»£ç å†…å®¹
                    const codeContent = code
                    .replace(/<[^>]+>/g, '')
                    .replace(/<span[^>]*>([^<]*)<\/span>/g, '$1')  // ç§»é™¤spanæ ‡ç­¾ä½†ä¿ç•™æ–‡æœ¬
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')

                    .replace(/&amp;/g, '&')
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'")
                    .replace(/&nbsp;/g, ' ')
                    .trim();

                    // ä½¿ç”¨ normalizeLanguage å¤„ç†è¯­è¨€
                    const normalizedLang = typeof normalizeLanguage === 'function' ? normalizeLanguage(language) : 'plain text';

                    console.log('ğŸ¨ ä¿®å¤è¡¥ä¸ï¼šè½¬æ¢ç»“æœ:', { original: language, normalized: normalizedLang });
                    return `\`\`\`${normalizedLang}\n${codeContent}\n\`\`\``;
                }
                return match;
            });

            // è°ƒç”¨åŸå§‹å‡½æ•°
            return originalParseHtmlCodeBlocks.call(this, result);
        };
    }

    console.log('ğŸš€ Notion Clipper ä»£ç å—ä¿®å¤è¡¥ä¸å·²åº”ç”¨');

    // è°ƒè¯•å·¥å…·ï¼šæ·»åŠ ä¸´æ—¶æµ‹è¯•åŠŸèƒ½
    window.debugTencentCode = function() {
        console.log('ğŸ” å¼€å§‹è°ƒè¯•è…¾è®¯äº‘ä»£ç å—...');

        // æŸ¥æ‰¾é¡µé¢ä¸­æ‰€æœ‰åŒ…å«JavaScriptä»£ç çš„åŒºåŸŸ
        const allElements = document.querySelectorAll('*');
        let foundElements = [];

        allElements.forEach(el => {
            const text = el.textContent || '';
            if (text.includes('{') && text.includes('name') && text.includes('repo')) {
                foundElements.push({
                    element: el,
                    text: text.substring(0, 500), // æ˜¾ç¤ºæ›´å¤šå†…å®¹
                    outerHTML: el.outerHTML.substring(0, 800), // æ˜¾ç¤ºæ›´å¤šHTML
                    tagName: el.tagName,
                    className: el.className
                });
            }
        });

        console.log('ğŸ” æ‰¾åˆ°', foundElements.length, 'ä¸ªå¯èƒ½åŒ…å«GitHubé…ç½®çš„å…ƒç´ :');
        foundElements.forEach((item, index) => {
            console.log(`ğŸ” å…ƒç´ ${index + 1}:`, {
                tag: item.tagName,
                class: item.className,
                text: item.text,
                html: item.outerHTML.substring(0, 400) + '...'
            });
        });

        // ç‰¹åˆ«æµ‹è¯•ï¼šæ£€æŸ¥å·¥å…·æ å’Œä»£ç æ˜¯å¦åœ¨åŒä¸€å…ƒç´ ä¸­
        console.log('ğŸ” ç‰¹åˆ«æµ‹è¯•ï¼šæ£€æŸ¥å·¥å…·æ å’Œä»£ç çš„åˆ†ç¦»æƒ…å†µ');
        const fullPageHTML = document.documentElement.innerHTML;
        const toolbarWithCodeMatches = fullPageHTML.match(/ä»£ç è¯­è¨€ï¼š.*?javascript.*?(?:è¿è¡Œ|å¤åˆ¶).*?[{][^}]*name[^}]*repo[^}]*[}]/gis);
        if (toolbarWithCodeMatches) {
            console.log('ğŸ” å‘ç°å·¥å…·æ å’Œä»£ç åœ¨åŒä¸€å…ƒç´ ä¸­çš„æƒ…å†µ:', toolbarWithCodeMatches.length, 'ä¸ª');
            toolbarWithCodeMatches.forEach((match, index) => {
                console.log(`ğŸ” æ··åˆå†…å®¹${index + 1}:`, match.substring(0, 300) + '...');
            });
        }

        return foundElements;
    };

    // æ–°çš„è°ƒè¯•å·¥å…·ï¼šä¸“é—¨æµ‹è¯•ä»£ç æå–
    window.testCodeExtraction = function() {
        console.log('ğŸ§ª æµ‹è¯•ä»£ç æå–åŠŸèƒ½...');

        // æ¨¡æ‹ŸparseHtmlCodeBlockså¤„ç†æ–¹å¼
        let html = document.documentElement.innerHTML;

        // æµ‹è¯•è…¾è®¯äº‘ç‰¹å®šçš„æ¨¡å¼
        const testPatterns = [
            /<(?:div|pre|span)[^>]*>.*?(?:ä»£ç è¯­è¨€ï¼š|ä»£ç è¿è¡Œæ¬¡æ•°ï¼š|è¿è¡Œ.*?å¤åˆ¶).*?([{][^}]*[}]).*?<\/(?:div|pre|span)>/gis,
            /[{][^}]*['"]name['"][^}]*['"]repo['"][^}]*[}]/g
        ];

        testPatterns.forEach((pattern, index) => {
            const matches = html.match(pattern);
            if (matches) {
                console.log(`ğŸ§ª æ¨¡å¼${index + 1}åŒ¹é…åˆ°`, matches.length, 'ä¸ªç»“æœ:');
                matches.forEach((match, matchIndex) => {
                    console.log(`ğŸ§ª åŒ¹é…${matchIndex + 1}:`, match.substring(0, 200) + '...');
                });
            }
        });
    };

    console.log('ğŸ’¡ è°ƒè¯•æç¤ºï¼šåœ¨æ§åˆ¶å°è¾“å…¥ debugTencentCode() æ¥åˆ†æé¡µé¢ç»“æ„');
})();
function toggleConfigAnchorNav() {
    try {
        const current = !!GM_getValue('show_config_anchor_nav', true);
        const next = !current;
        GM_setValue('show_config_anchor_nav', next);
        const nav = document.getElementById('config-anchor-nav');
        if (next) {
            if (!nav) { try { createConfigAnchorNav(); } catch(_) {} }
            else { nav.style.display = 'flex'; }
            showNotification('å·²æ˜¾ç¤ºå¿«æ·å®šä½é¢æ¿', 'success');
        } else {
            if (nav) { nav.style.display = 'none'; }
            showNotification('å·²éšè—å¿«æ·å®šä½é¢æ¿', 'success');
        }
    } catch(e) { console.error('åˆ‡æ¢å¿«æ·å®šä½é¢æ¿å¤±è´¥:', e); }
}
