// ==UserScript==
// @name         Room#
// @namespace    http://tampermonkey.net/
// @version      0.2.0
// @description  Find the numbers of available hotel rooms while booking.
// @author       Your Nitan Friends
// @match        *://www.hyatt.com/*
// @match        *://www.hilton.com/*
// @match        *://www.ihg.com/*
// @icon         https://asset-cdn.uscardforum.com/original/2X/2/28fd89e729c992317b56a381e0a863a7f25b8e6d.png?v=12
// @grant        none
// @license      CC BY-NC-ND 4.0
// @downloadURL https://update.greasyfork.org/scripts/498041/Room.user.js
// @updateURL https://update.greasyfork.org/scripts/498041/Room.meta.js
// ==/UserScript==

(function(){"use strict";function r(a,o,r,i){return new Promise(function(e,t){let n=new XMLHttpRequest;n.open(a,o);n.setRequestHeader("Content-Type","application/json;charset=UTF-8");if(i!=null){Object.keys(i).forEach(e=>{n.setRequestHeader(e,i[e])})}n.onload=function(){if(n.status>=200&&n.status<300){e(n.response)}else{t({status:n.status,statusText:n.statusText})}};n.onerror=function(){t({status:n.status,statusText:n.statusText})};n.send(r)})}async function y(e,t,n,a){const o=await r(e,t,n,a);if(o){return JSON.parse(o)}}async function o(e){return await y("GET",`https://www.hyatt.com/shop/service/rooms/roomrates/${e}`)}function i(a,e){e.forEach(t=>{if(t.querySelector(".room-quantity")!=null){return}let n=t.getAttribute("data-room-type-code");if(a[n]){let e=a[n].roomQuantity;t.querySelector(".select-button").innerHTML+=`: <b class="room-quantity">${e}</b> left`}})}var l=0;function t(){let t=document.querySelectorAll(".room-rate-card-wrapper ");if(document.querySelector(".select-button")==null){return}if(Array.from(t).every(e=>e.querySelector(".room-quantity")!=null)){return}if(Date.now()-l<=1e3){return}l=Date.now();let e=window.location.pathname.split("/");let n=e[e.length-1];let a=`${n}${window.location.search}`;o(a).then(function(e){i(e.roomRates,t)}).catch(function(e){})}async function e(){var e=JSON.parse(document.getElementById("__NEXT_DATA__").innerHTML)["runtimeConfig"]["DX_AUTH_APP_CUSTOMER_ID"];const t="https://www.hilton.com/dx-customer/auth/applications/token?appName=dx-res-ui";var n=await y("POST",t,JSON.stringify({app_id:e}));var a=`${n.token_type} ${n.access_token}`;return a}async function n(e){var t=new URLSearchParams(location.search);var n={query:'query hotel_shopAvailOptions_shopPropAvail($arrivalDate: String!, $ctyhocn: String!, $departureDate: String!, $language: String!, $guestLocationCountry: String, $numAdults: Int!, $numChildren: Int!, $numRooms: Int!, $displayCurrency: String, $guestId: BigInt, $specialRates: ShopSpecialRateInput, $rateCategoryTokens: [String], $selectedRoomRateCodes: [ShopRoomRateCodeInput!], $ratePlanCodes: [String], $pnd: String, $offerId: BigInt, $cacheId: String!, $knownGuest: Boolean, $modifyingReservation: Boolean, $currentlySelectedRoomTypeCode: String, $currentlySelectedRatePlanCode: String, $childAges: [Int], $adjoiningRoomStay: Boolean, $programAccountId: BigInt) {\n  hotel(ctyhocn: $ctyhocn, language: $language) {\n    ctyhocn\n    shopAvailOptions(input: {offerId: $offerId, pnd: $pnd}) {\n      maxNumChildren\n      altCorporateAccount {\n        corporateId\n        name\n      }\n      contentOffer {\n        name\n      }\n    }\n    shopAvail(\n      cacheId: $cacheId\n      input: {guestLocationCountry: $guestLocationCountry, arrivalDate: $arrivalDate, departureDate: $departureDate, displayCurrency: $displayCurrency, numAdults: $numAdults, numChildren: $numChildren, numRooms: $numRooms, guestId: $guestId, specialRates: $specialRates, rateCategoryTokens: $rateCategoryTokens, selectedRoomRateCodes: $selectedRoomRateCodes, ratePlanCodes: $ratePlanCodes, knownGuest: $knownGuest, modifyingReservation: $modifyingReservation, childAges: $childAges, adjoiningRoomStay: $adjoiningRoomStay, programAccountId: $programAccountId}\n    ) {\n      currentlySelectedRoom: roomTypes(\n        filter: {roomTypeCode: $currentlySelectedRoomTypeCode}\n      ) {\n        adaAccessibleRoom\n        roomTypeCode\n        roomRates(filter: {ratePlanCode: $currentlySelectedRatePlanCode}) {\n          ratePlanCode\n          rateAmount\n          numRoomsAvail\n          rateAmountFmt(decimal: 0, strategy: trunc)\n          rateAmountUSD: rateAmount(currencyCode: "USD")\n          amountAfterTaxFmt(decimal: 0, strategy: trunc)\n          fullAmountAfterTax: amountAfterTaxFmt\n          rateChangeIndicator\n          ratePlan {\n            ratePlanName\n            commissionable\n            confidentialRates\n            specialRateType\n            hhonorsMembershipRequired\n            redemptionType\n          }\n          pointDetails {\n            pointsRateFmt\n          }\n        }\n      }\n      statusCode\n      summary {\n        specialRates {\n          specialRateType\n          roomCount\n        }\n        requestedRates {\n          ratePlanCode\n          ratePlanName\n          roomCount\n        }\n      }\n      notifications {\n        subText\n        subType\n        title\n        text\n      }\n      addOnsAvailable\n      currencyCode\n      roomTypes {\n        roomTypeCode\n        adaAccessibleRoom\n        numBeds\n        roomTypeName\n        roomTypeDesc\n        roomOccupancy\n        executive\n        suite\n        code: roomTypeCode\n        name: roomTypeName\n        adjoiningRoom\n        thumbnail: carousel(first: 1) {\n          _id\n          altText\n          variants {\n            size\n            url\n          }\n        }\n        quickBookRate {\n          cashRatePlan\n          roomTypeCode\n          rateAmount\n          rateAmountUSD: rateAmount(currencyCode: "USD")\n          rateChangeIndicator\n          feeTransparencyIndicator\n          cmaTotalPriceIndicator\n          ratePlanCode\n          numRoomsAvail\n          rateAmountFmt(decimal: 0, strategy: trunc)\n          roomTypeCode\n          amountAfterTaxFmt(decimal: 0, strategy: trunc)\n          fullAmountAfterTax: amountAfterTaxFmt\n          ratePlan {\n            commissionable\n            confidentialRates\n            ratePlanName\n            specialRateType\n            hhonorsMembershipRequired\n            redemptionType\n            serviceChargesAndTaxesIncluded\n          }\n          serviceChargeDetails\n          pointDetails(perNight: true) {\n            pointsRate\n            pointsRateFmt\n          }\n        }\n        moreRatesFromRate {\n          rateChangeIndicator\n          feeTransparencyIndicator\n          cmaTotalPriceIndicator\n          roomTypeCode\n          rateAmount\n          numRoomsAvail\n          rateAmountFmt(decimal: 0, strategy: trunc)\n          rateAmountUSD: rateAmount(currencyCode: "USD")\n          amountAfterTaxFmt(decimal: 0, strategy: trunc)\n          fullAmountAfterTax: amountAfterTaxFmt\n          serviceChargeDetails\n          ratePlanCode\n          ratePlan {\n            confidentialRates\n            serviceChargesAndTaxesIncluded\n          }\n        }\n        bookNowRate {\n          roomTypeCode\n          rateAmount\n          rateChangeIndicator\n          feeTransparencyIndicator\n          cmaTotalPriceIndicator\n          ratePlanCode\n          numRoomsAvail\n          rateAmountFmt(decimal: 0, strategy: trunc)\n          amountAfterTaxFmt(decimal: 0, strategy: trunc)\n          fullAmountAfterTax: amountAfterTaxFmt\n          roomTypeCode\n          ratePlan {\n            commissionable\n            confidentialRates\n            ratePlanName\n            specialRateType\n            hhonorsMembershipRequired\n            disclaimer {\n              diamond48\n            }\n            serviceChargesAndTaxesIncluded\n          }\n          serviceChargeDetails\n        }\n        redemptionRoomRates(first: 1) {\n          rateChangeIndicator\n          pointDetails(perNight: true) {\n            pointsRate\n            pointsRateFmt\n          }\n          sufficientPoints\n          pamEligibleRoomRate {\n            ratePlan {\n              ratePlanCode\n              rateCategoryToken\n              redemptionType\n            }\n            roomTypeCode\n            sufficientPoints\n          }\n        }\n      }\n      lowestPointsInc\n    }\n  }\n}',operationName:"hotel_shopAvailOptions_shopPropAvail",variables:{guestLocationCountry:"US",arrivalDate:t.get("arrivalDate"),departureDate:t.get("departureDate"),numAdults:parseInt(t.get("room1NumAdults")),numChildren:t.has("room1NumChildren")?parseInt(t.get("room1NumChildren")):0,numRooms:1,displayCurrency:null,ctyhocn:t.get("ctyhocn"),language:"en",guestId:null,specialRates:{aaa:false,aarp:false,governmentMilitary:false,hhonors:false,pnd:"",senior:false,teamMember:false,owner:false,ownerHGV:false,familyAndFriends:false,travelAgent:false,smb:false,specialOffer:false,specialOfferName:null},pnd:null,cacheId:"",offerId:null,knownGuest:false,modifyingReservation:false,currentlySelectedRoomTypeCode:null,currentlySelectedRatePlanCode:null,childAges:null,adjoiningRoomStay:false}};var a=`https://www.hilton.com/graphql/customer?appName=dx-res-ui&operationName=hotel_shopAvailOptions_shopPropAvail&originalOpName=getShopAvail&bl=en&ctyhocn=${t.get("ctyhocn")}`;var o=await y("POST",a,JSON.stringify(n),{Authorization:e});return o}function a(e,t){var n=new Map;e["data"]["hotel"]["shopAvail"]["roomTypes"].map(e=>{n[e["roomTypeCode"]]=e["moreRatesFromRate"]["numRoomsAvail"]});t.forEach(e=>{if(e.querySelector(".room-quantity")!=null){return}var t=n[e.getAttribute("data-roomtypecode")];e.querySelector('[data-testid="moreRatesButton"], [data-testid="accessibleMoreRatesButton"]').innerHTML+=`<b class="room-quantity">: ${t} Left</b>`})}function s(){let t=document.querySelectorAll('[data-testid="roomCardTile"], [data-testid="accessibleRoomCard"]');if(document.querySelector('[data-testid="moreRatesButton"], [data-testid="accessibleMoreRatesButton"]')==null){return}if(Array.from(t).every(e=>e.querySelector(".room-quantity")!=null)){return}if(Date.now()-l<=1e3){return}l=Date.now();e().then(function(e){n(e).then(function(e){a(e,t)})}).catch(function(e){})}const u=new Map;async function c(e){let t=(await e.clone().json()).data.hotel.shopCalendarAvail.calendars;t.forEach(e=>{u[e.arrivalDate]=e.roomRate});m()}function m(){document.querySelectorAll('[data-testid="flexDatesCalendarDay"]').forEach(e=>{let t=e.querySelector('[data-testid="flexDatesRoomRate"]');if(t==null||t.querySelector(".leading-none")!=null){return}let n=e.querySelector('[data-testid^="arrival-"]').getAttribute("data-testid").split("arrival-")[1];if(u[n]==null){return}let a=e.querySelector(".room-quantity");if(a!=null){if(a.innerText==""+u[n].numRoomsAvail){}else{a.innerText=""+u[n].numRoomsAvail}return}t.innerHTML+=`<br/><b class="room-quantity">${u[n].numRoomsAvail}</b> left`})}var d=false;function p(){if(!d){const{fetch:o}=window;window.fetch=async(...e)=>{let[t,n]=e;let a=await o(t,n);if(a.url.includes("hotel_shopAvailOptions_shopCalendarPropAvail")){c(a.clone())}return a};d=true}if(document.querySelector('[data-testid="flexDatesRoomRate"]')==null){return}m()}function f(){if(location.pathname.endsWith("book/reservation/flexibledates/")){p()}else if(location.pathname.endsWith("book/reservation/rooms/")){s()}}function h(){if(AppConfig==null){return null}return AppConfig.hotelRatePreferencesDAO.apiKey}async function g(e){var t=new URLSearchParams(location.search);var n=t.get("qCiMy").padStart(6,"0");var a=t.get("qCiD").padStart(2,"0");var o=t.get("qCoMy").padStart(6,"0");var r=t.get("qCoD").padStart(2,"0");var i=(parseInt(n.substring(0,2))+1).toString().padStart(2,"0");var l=n.substring(2);var s=(parseInt(o.substring(0,2))+1).toString().padStart(2,"0");var u=o.substring(2);var c=`${l}-${i}-${a}`;var m=`${u}-${s}-${r}`;var d={products:[{productCode:"SR",guestCounts:[{otaCode:"AQC10",count:1}],startDate:c,endDate:m,quantity:1}],startDate:c,endDate:m,hotelMnemonics:[t.get("qSlH")],rates:{ratePlanCodes:[]},options:{disabilityMode:"ACCESSIBLE_AND_NON_ACCESSIBLE",returnAdditionalRatePlanDescriptions:true,includePackageDetails:true}};var p="https://apis.ihg.com/availability/v3/hotels/offers?fieldset=rateDetails";var f=await y("POST",p,JSON.stringify(d),{"x-ihg-api-key":e});return f}function A(e,t){var o=new Map;var r=new Map;e.hotels[0].rateDetails.offers.forEach(e=>{e.productUses.forEach(e=>{o[e.inventoryTypeCode]=e.numberOfAvailableProducts})});e.hotels[0].productDefinitions.forEach(e=>{if(e.inventoryTypeName!=null){r[e.inventoryTypeName.trim()]=e.inventoryTypeCode}});t.forEach(e=>{if(e.querySelector(".room-quantity")!=null){return}let t=e.querySelector(".roomName");let n=t.innerText.trim();let a=o[r[n]];t.innerHTML+=`<b class="room-quantity">: ${a} Left</b>`;e.querySelector('[data-testid="hotelTitleSID"]').innerHTML+=`<b class="room-quantity-m">: ${a} Left</b>`})}var C;function R(){if(C==null){let e=h();if(e==null){return}C=e}var t=document.querySelectorAll([".room-rate-card"]);if(document.querySelector(".roomPrice")==null){return}if(Array.from(t).every(e=>e.querySelector(".room-quantity")!=null)){return}if(Date.now()-l<=1e3){return}l=Date.now();g(C).then(function(e){A(e,t)}).catch(function(e){})}function v(){let e=location.hostname;if(e==="www.hyatt.com"){t()}else if(e==="www.hilton.com"){f()}else if(e==="www.ihg.com"){R()}else{console.warn("Not supported site.")}}const T=new MutationObserver(v);T.observe(document.body,{childList:true,subtree:true})})();