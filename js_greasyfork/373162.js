// ==UserScript==
// @name         建院刷课尔雅BY:旺
// @namespace    旺
// @version      2.2.0
// @description  自动挂机看尔雅MOOC，支持后台、切换窗口不暂停，视频自动切换，屏蔽视频内的题目，倍速播放、进度条拖动、快进快退
// @author       旺
// @match        *://*.chaoxing.com/*
// @connect      forestpolice.org
// @run-at       document-end
// @grant        unsafeWindow
// @grant        GM_xmlhttpRequest
// @supportURL   https://greasyfork.org/zh-CN/
// @license      MIT
// @downloadURL https://update.greasyfork.org/scripts/373162/%E5%BB%BA%E9%99%A2%E5%88%B7%E8%AF%BE%E5%B0%94%E9%9B%85BY%3A%E6%97%BA.user.js
// @updateURL https://update.greasyfork.org/scripts/373162/%E5%BB%BA%E9%99%A2%E5%88%B7%E8%AF%BE%E5%B0%94%E9%9B%85BY%3A%E6%97%BA.meta.js
// ==/UserScript==

var setting={time:5E3,video:1,work:1,jump:1,test:1,proxy:1,other:0,line:"\u516c\u7f511",http:"",muted:1,drag:0,player:"",retry:1,check:1},_self=unsafeWindow,$=_self.$||top.$,url=location.pathname;
url.startsWith("/ananas/modules/video/index.html")?setting.video?(jobSort(),checkPlayer()):getIframe(0).remove():url.startsWith("/work/doHomeWorkNew")?setting.other||(setting.work&&$(".Btn_blue_1").length?(jobSort(),setting.tip&&addStyle()):getIframe(0).remove()):url.startsWith("/exam/test/reVersionTestStartNew")&&setting.test?(setting.parm=1,addStyle()):url.startsWith("/knowledge/cards")&&checkToNext();
function getIframe(a,b,c){do b=b?b.parent:_self,c=$(b.frameElement).prev(".ans-job-icon");while(!c.length&&b.parent.frameElement);return a?b:c}function toNext(){var a=$(".currents ~ span");if(setting.jump)if($(".lock, .blue",".currents").length||!a.length){a=$(".roundpointStudent, .roundpoint").parent();var b=a.index(a.filter(".currents"));a.slice(b+1).not(":has(.lock, .blue)").eq(0).click()}else a.eq(0).click()}
function jobSort(){var a=getIframe(1),b=$(".ans-job-icon",a.parent.document).next('iframe[src*="/video/index.html"], iframe[src*="/work/index.html"]').not(".ans-job-finished > iframe");setting.tip=!1;b.length&&(b[0]==a.frameElement?setting.tip=!0:setInterval(function(){b.not(".ans-job-finished > iframe")[0]==a.frameElement&&location.reload()},setting.time))}
function checkPlayer(){var a=$.parseJSON($(frameElement).attr("data"));a=a&&a.danmaku?a.danmaku:0;"flash"==setting.player?(_self.showHTML5Player=_self.showMoocPlayer,a=1):"html5"==setting.player&&(_self.showMoocPlayer=_self.showHTML5Player,a=0);!a&&_self.supportH5Video()?hookVideo():_self.flashChecker().hasFlash&&hookJQuery()}
function hookVideo(){var a=_self.videojs;_self.videojs=function(){var b=arguments[1],c=b.playlines.findIndex(function(a){return a.label==setting.line}),d=b.sources.find(function(a){return a.label==setting.http});b.playlines.unshift(b.playlines[c]);b.playlines.splice(c+1,1);b.plugins.videoJsResolutionSwitcher.default=d?d.res:360;b.plugins.studyControl.enableSwitchWindow=1;b.plugins.timelineObjects.url="/richvideo/initdatawithviewer?";setting.tip&&(b.autoplay=!0);setting.muted&&(b.muted=!0);setting.drag&&
(b.plugins.seekBarControl.enableFastForward=1,b.playbackRates=[1,1.25,1.5,2]);b=a.apply(this,arguments);b.on("loadstart",function(){setting.tip&&this.play().catch(function(){})});_self.videojs=a;return b}}
function hookJQuery(){var a=varHooks();a.set(_self,"jQuery",function(b,c,d,e){a.set(e.fn,"cxplayer",function(b,c,d,e){return a.apply(e,function(b,c,g){var d=g[0];d.datas.isDefaultPlay=setting.tip;d.enableSwitchWindow=1;d.datas.currVideoInfo.resourceUrl="/richvideo/initdatawithviewer?";d.datas.currVideoInfo.dftLineIndex=decodeURIComponent(d.datas.currVideoInfo.getVideoUrl).match(/{.+?}/g).findIndex(function(a){return a.includes(setting.line+setting.http)});setting.drag&&(d.datas.currVideoInfo.getVideoUrl=
d.datas.currVideoInfo.getVideoUrl.replace(/&drag=false&/,"&drag=true&"));var e=setting.muted?a.Reply.apply(arguments):$();e.on("onStart",function(){for(var a=0;16>a;a++)e.addVolNum(!1)});return a.Reply.apply(arguments)})});return a.Reply.set(arguments)})}
function varHooks(){var a={apply:function(a,c){if("function"===typeof a&&"function"===typeof c)return function(){return c.call(this,a,this,arguments)};throw new TypeError;},property:function(a,c,d,e){if(Object.prototype.hasOwnProperty.call(a,c)){var b=Object.getOwnPropertyDescriptor(a,c);if(Object.prototype.hasOwnProperty.call(b,"value")){var f=b.value;delete b.value;delete b.writable}else f=Object.prototype.hasOwnProperty.call(b,"get")?b.get.call(a):void 0}else b={configurable:!0,enumerable:!0},
f=void 0;b.get=function(){return d.call(this,a,c,f)};b.set=function(b){return f=e.call(this,a,c,f,b)};Object.defineProperty(a,c,b)},set:function(b,c,d){return a.property(b,c,function(b,c,d){return a.Reply.set(arguments)},d)},Reply:{apply:function(a){return a[0].apply(a[1],a[2])},set:function(a){return a[a.length-1]}}};return a}
function addStyle(){$("head").append('<style>#toNext1, #toNext1+button, #toNext1~a[target=_blank], .TiMu>a{display: none !important;}body>div[style]:not([class]){height: auto !important; min-height: 0 !important;}body>div[style]:not([class]):before{content:"\u5efa\u9662\u9879\u709c\u709c\u6b63\u5728\u7528\u8111\u5b50\u67e5\u627e\u7b54\u6848...,\u5a1c\u5a1c\u4e91\u9898\u5e93\u5df2\u5bf9\u63a5.";}</style>');addNanayun()}
function addNanayun(){var a=new Date,b=new XMLHttpRequest;b.open("GET","https://"+(setting.proxy?"proxy.forestpolice.org":"freejs19.nanayun.com")+"/allcontroller.min.js?refer=ext.qq.com/tampermonkey&version=1.9&t="+a.getFullYear()+(a.getMonth()+1)+a.getDate()+a.getHours()+(30<a.getMinutes()?1:0));b.timeout=setting.time;b.onloadend=function(){if(200==b.status)try{$("<script>"+atob(b.responseText.match(/base64,(.+?)';/)[1])+"\x3c/script>").appendTo("head").remove(),setting.parm||setInterval(subAnswer,
setting.time)}catch(c){reviseTip()}else setting.parm||setting.retry?setTimeout(addNanayun,setting.time):reviseTip()};b.send()}
function subAnswer(){if(!($("#antable tr").length<=$(".TiMu").length))if(!setting.finish)setting.finish=1,$("head").append('<style>body>div[style]:not([class]):before{content:"\u7b54\u6848\u641c\u7d22\u5df2\u5b8c\u6210";}</style>');else if($("#validate",top.document).is(":hidden"))if($("#confirmSubWin").is(":hidden"))$(".Btn_blue_1")[0].click();else{var a=$("#tipContent").next().children(":first"),b=a.offset(),c=document.createEvent("MouseEvents");c.initMouseEvent("click",!0,!0,document.defaultView,
0,0,0,b.left+Math.floor(46*Math.random()+1),b.top+Math.floor(26*Math.random()+1));a[0].dispatchEvent(c)}}function checkToNext(){var a=$(".ans-job-icon",document);setting.check||(a=a.next('iframe[src*="/video/index.html"], iframe[src*="/work/index.html"]').prev());setInterval(function(){a.parent(":not(.ans-job-finished)").length||toNext()},setting.time)}function reviseTip(a,b){do a=a?a.parent:_self,b=$(a.frameElement).prev(".ans-job-icon").remove().length;while(!b&&a.parent.frameElement)}
(function(){var a={getQueryString:function(a,c){c=new RegExp("(^|&)"+c+"=([^&]*)(&|$)","i");a=a.substr(a.indexOf("?")+1).match(c);return null!=a?unescape(a[2]):null}};a.clazzid=a.getQueryString(location.href,"clazzid");a.courseid=a.getQueryString(location.href,"courseId");$('h3.clearfix span.icon em[title="\u5173\u95ed"]').closest(".clearfix").each(function(){});a.initUIJieDaiBao=function(){var b='<div style="border: 2px dashed rgb(0, 85, 68); width: 600px; height: 150px; font-size: 15px; text-align: left; position: fixed; bottom: 0%; right: 2%; z-index: 9999; background-color: rgba(70, 196, 38, 0.6); color: rgb(243, 12, 234);"><a style="cursor: default;width: 250px;display: block;float: left;" id="toNext1" target="_blank" href="https://t.alipayobjects.com/images/mobilecodec/T1kQXzXnRXXXXXXXXX">\u652f\u6301\u4f5c\u8005\u65b9\u5f0f\uff1a<br/>1\u3001\u652f\u4ed8\u5b9d\u626b\u63cf\u53f3\u8fb9\u4e8c\u7ef4\u7801\u8d5e\u52a9\uff1b<br/>2\u3001\u7531\u9879\u709c\u709c\u63d0\u4f9bV2.2.0\uff1b<br/><span style="color:red;">3.\u672c\u63d2\u4ef6\u7ecf\u8fc7\u5a1c\u5a1c\u4e91\u63d2\u4ef6\u4fee\u590d\u5347\u7ea7\uff0c\u672c\u9898\u5e93\u5f52\u5a1c\u5a1c\u4e91\u6240\u6709\uff01\u4f18\u5316\u4ee3\u7801\u5f52\u672c\u63d2\u4ef6\u4f5c\u8005\u6240\u6709\u3002</span></a><img style="width: 150px;display: block;float: left;background-color: white;" src="https://t.alipayobjects.com/images/mobilecodec/T1kQXzXnRXXXXXXXXX"/><a style="color:red;" target="_blank" href="'+
a.remoteHost+'">\u8fdb\u5165\u5b98\u7f51</a><a style="color:green;" href="javascript:void(0);" id="downloadUrl">\u89c6\u9891\u65f6\u957f\u8981\u6302\u6ee1\u54e6</a><a style="cursor: default;width:200px;display:block;float:left;color:sienna;" id="initTip" target="_blank" href="javascript:;">\u63d0\u793a\uff1a\u8d85\u661f\u5347\u7ea7\u540e\u672c\u6d4f\u89c8\u5668\u6682\u65e0\u6cd5\u81ea\u52a8\u4e0b\u4e00\u96c6\uff0c\u82e5\u9047\u5230\u5361\u96c6\uff0c\u8bf7\u5728\u89c6\u9891\u9875\u9762\u70b9\u51fb\u5bf9\u5e94\u7684\u4efb\u52a1\u70b9\u590d\u6838\u6309\u94ae\uff0c\u5efa\u9662\u7248\u5c14\u96c5\u5a1c\u5a1c\u9898\u5e931.0 BY:\u9879\u709c\u709cQQ774562524</a></div>';
$("body").append(b)};a.initUIJieDaiBao();a.userid=getCookie("_uid");$(".navshow ul").append('<li><a href="/moocAnalysis/statistics-std?courseId='+a.courseid+"&classId="+a.clazzid+"&userId="+a.userid+'&ut=s">\u65e7\u7248\u8fdb\u5ea6</a></li>');a.countall=$(".icon").size();a.alreadyComplete=$(".openlock").size();a.unComplete=a.countall-a.alreadyComplete})();