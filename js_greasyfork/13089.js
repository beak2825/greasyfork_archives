// ==UserScript==
// @name        Throne Champ Organizer
// @namespace   tco
// @description All In One Throne Room & Champion Hall Script
// @version     0.4.3
// @delay       2000
// @priority    -10
// @include     *.kingdomsofcamelot.com/*main_src.php*
// @resource    jqcss http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css
// @resource champion_uniques http://www.nicodebelder.eu/koc/PowerBotPlus/champion_uniques.js
// @icon        https://rycamelot1-a.akamaihd.net/fb/e2/src/img/items/70/845.jpg
// @require     https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js
// @require     https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js
// @grant       unsafeWindow
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_addStyle
// @grant       GM_xmlhttpRequest
// @grant       GM_log
// @grant       GM_registerMenuCommand
// @grant       GM_getResourceText
// @grant       GM_getResourceURL
// @contributionURL https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=TJ9YQ8S75HFEL
// @downloadURL https://update.greasyfork.org/scripts/13089/Throne%20Champ%20Organizer.user.js
// @updateURL https://update.greasyfork.org/scripts/13089/Throne%20Champ%20Organizer.meta.js
// ==/UserScript==

var tcoVersion = '0.4.3';

String.prototype.capitalizeFirstLetter = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
};
String.prototype.startsWith = function(starter) {
    return this.substring(0,starter.length) == starter;
};
String.prototype.endsWith = function(ender) {
    return this.substring(this.length-ender.length) == ender;
};

var ResetAll = false;
var DEBUG_TRACE = false;

var JSON;if(!JSON){JSON={};}(function(){"use strict";function f(n){return n<10?'0'+n:n;}if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+f(this.getUTCMonth()+1)+'-'+f(this.getUTCDate())+'T'+f(this.getUTCHours())+':'+f(this.getUTCMinutes())+':'+f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}if(typeof rep==='function'){value=rep.call(holder,key,value);}switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}v=partial.length===0?'[]':gap?'[\n'+gap+partial.join(',\n'+gap)+'\n'+mind+']':'['+partial.join(',')+']';gap=mind;return v;}if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==='string'){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}if(typeof JSON.stringify!=='function'){JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('JSON.stringify');}return str('',{'':value});};}if(typeof JSON.parse!=='function'){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}return reviver.call(holder,key,value);}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}throw new SyntaxError('JSON.parse');};}}());
var JSON2 = JSON; 

var uW = unsafeWindow;
var Seed = uW.seed;
var CM = uW.cm;
var ThroneTemplates = CM.FETemplates.Throne;
var ajfx = uW.g_ajaxparams;

var IMGURL = uW.stimgUrl + "img/";
var tcoRightArrow = IMGURL + "autoAttack/across_arrow.png";
var tcoDownArrow = IMGURL + "autoAttack/down_arrow.png";
var tcoPlus = IMGURL + "throne/modal/set_buy.png";  //https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/modal/set_buy.png
 
var tcoBreakBuffer = 50000;

var Cities = {};
var Tabs = {};
var mainPop;

var dlgHeight = 600;
var dlgHeightOffset = 30;
var dlgWidth = 735;
var dlgWidthOffset = 12;
var dlgWidthMenu = 75;

var http =  window.location.protocol+"\/\/";

var URL_CASTLE_BUTTON = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAXCAYAAADk3wSdAAAACXBIWXMAAAsSAAALEgHS3X78AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAA+NJREFUeNqclc9uFEcQxn9d3TuzeG3DLiaIOAcT2wdjgeESKeIQ5ZIokXmPXCLlTSLllEeBByCEIBMrlyzkAFxZC7P2zt/+Uznseo0NkZKUNFOlUvXXX898VW2++uaeLvR6ZFkHKxZjDP/VVJWYIm3rKYsC9/G1a/zw/XdYew5QlaSzkGlgZm9jeG9zVSWlyI8//Yzb2Fin9R6J6UyhqqKq8xjOAhljPlAf2dhYx93Y2iLGSErKgwcPMMagquzu7s7yifv3788Bdnd3SSmdyZ/Up6Tc2NrCbW6u09QlqrC4uIiIAZRLl5aoqgrvPRcvLiEipJTo95epqooQAktLixhjiDGxtLRE01Rsbq7jrly5wsHoNQCDwQDnLKqRXq+HCHjvWFkZYK0lxtN8CIHLlweIOEIILCwsAMryxT6uKAoWFhYQEfr9PnneIaVAnneAnCyzrKxMNwshzvJdYowMBgOsdbStJ89zVCNFUeB+3/+Du59/hjGG5eVlut0MSOzv7xFjwFphMFjGuSmj/f0nhKBY26Hf72OMpWkasmy67vGTX3EPf3nEl1/cxRjhwoUL9Hrd2bEzYmzpdIQ8z+ag3W6O94q1GVmWE6MiIlhrca7Dw18e4YbDZ3N5iAhZluGcpdvNUPVYq2SZxVohhA6dTk6MBmM6GCN4H6nrBmMM1sJw+Az34uUrYowYo6SUAHDO4ZwDHNYmrAVjmDGClASwhKB4H+cSC0F58fIV7vDwDW3rMcYQQiDGBCjGCCJ21j1p5hVjLCKGlGbtGSMhBEIIeN9yePgGZ8VSliUiQtM01HVDltnZ4oRIQlVnJxFSOvEJ7yNN09I0DW3bUlU1VixudXWVsixQhaqq6HY7OAcpOUQUa6eA01Y0pGSIceqbJlCWBVVV0TQNZVmwurqK297eYjweI2IpioIsc4hAShnWKnDynI6UlIQQlKYJFEVBURTUdc1kMmF7ewt35/YOR0dHiFjK8hQ0xhYRUD0dGO8OkBihrj2TyRS0qiqOjyfcub2D27l1k7+e/4mIZTR6TdPUlGWPTse9w/C8TcHrumUyKRiPj3n79i2j0YidWzdxa9fX+O3xIwDG4zGqibZtEJH5yHsPcqZr7wNFUXJ8PKEsCyaTY9aur+G6eT7XZwhhJi/5V6AxRrwPM51Odd7Nc9zo4ICUprLxPlDXDarM5+SHhvQJaEqJtm3x3qM6bYDRwQFuOHyOs1NWG59e56OrV+n1FqeXiCrnyZ78K2PkTL4oS1KMDIfPcXt7T/nk2mVSShgRjo6OKMvilKHqWUGdu0ZOLISIiGFv7ynm62/v/dOn+19mDPw9AD29Ua4OIbBVAAAAAElFTkSuQmCC";
var URL_CASTLE_BUTTON_SELECT = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAXCAYAAADk3wSdAAAACXBIWXMAAAsSAAALEgHS3X78AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAABABJREFUeNqklT1vHGUQx3/Py+7e3tpOYmOBOSQc2S4cK3HSIKEUiIYAUj4GiAaJGiihBlFBPkC+AqGiIYl4cUA0XEKRpEmRWDn77nb39nn2eYbiLmc7QIEYaVajnZn/zOyO/qPeeueqdIuCNE0w2qCU4r+KiBBiwDlPVZbYl9fW+OjDDzDmOUARosxMpoaaPZXib8VFhBgDX3z1NXZzcwPnPTrEE4EigojMbTgJpJT6h/jA5uYG9tz2NiEEYhQ+uXZjHvT5+2/PwT699h3PWv3svStzwI+/+fZEPETObW9jt7Y2aCYVIs/GmyZnmT3W1dGYnU5y1Omx8Y0xGGPZ2trArq6usv/k8cnxFBRFPk84vdTFak0b4/z90fgKEPI8Rylh5YVVbFmWdLtdtNYopQHIMztLno7/6toy1mjaECmKzgxIkXdSJk0LKIqiACJlWWJ//e13Lr/+2rxy3kl4cXmRL69/z0I3o9tJONtbJrEG3wau3/iFsvaMK8dLK6d4PBhRTzx5ngORH279jL156zZvvnEZpTRKwZmlguXTC6yc6rJUZCwWKd08mYOWtWdUeobjhiRJ8CEyaQ5I0xSRwM1bt7H9/t15l9YaFrsdloqc04tdzix1WFpIKXJLmmgaF+lmgTRxGG1ogzCuGqyd7rjWin7/Lvb+g4eEEFBKyBJLllryLKHIUxa6GUtFSpEbkkSTpWB0SxSF95Fx5aY5iSWEAETuP3iIHQye4pyfV9JaYY0iMYrUKhKrSBNNYhWI4OzUZ/VUzSzHOQdEBoOnWKMNVVVN/z6AxGMaUBJREtEolIDiyC8SAUEBVVUBEaMNttfrUVUlIhBCxHtP0zica3BO4xw0JhBajW+FpmlpGkfjGpxr8M4TQmQ8HgORXq+H3dnZ5vDwEK0Nznvq2lHWNaNSk1pBgmdSW6zVtG2kblpGVctoXFNWE6pJg/Oe0WiESGBnZxt76eIuw+EQrQ114xnXNYcjTaIjsXWUnZQsNRilCCI0LlBOHINRw8GwZlzV1I1jNBoSY+DSxV3s7oXz/HnvD7Q2eO85GFZoCbhJzcGhJU8NidVYrWij4NtI7QLVpOWgdByMG7xvefToESDsXjiPXT+7zk8/3gYgxsioakACk4kmSzTZDFBriBHaKLg2MvFC2QTGk5YYhcFggDGa9bPr2E6WEWOckTGEKAyrFudnK2Vma6MgytTfBmhmwGFGj1MMoZNl2Cf7+8QYp9wpM2ARyiZSOYXVoNVUp0WhjTDDmst0+TVP9vex/f49rNGICFfPLyInzskR+59gfEBpzTH6BaXRCvr9e9i9vTu8srYy/wTP3x1E5oXUjLH/7Tgao9nbu4O68u7V55v5X6IU/DUA3uQnItzRr3oAAAAASUVORK5CYII=";
var success_image = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AgNBDgX+Hd0CAAACkZJREFUWMOtl3uMHdV9x7+/c2buzJ373rvvtb3exYuNDfYaMIkgkNYCFIdScB+CVm4UIWiTIKs0FVSplAqaBiUWbYXSh1CcREkr2lRKrZgoJThYLQWMIY6pjV+7fqx37fU+7t7nPO48zvn1j12btYG0fzDSkWbmjH6f3/m9h/AxXjw+DhoZAY+PL39NH/U5jYx85ObHAadfoQBfUeLjtcAYALosUyzBFxczL4EZRFfujQ8VNLsb1PMoeHb3tVv0oYdhE/BvAhQDDAJIgBYVYGYiIkK+JA6ceF0MWKVwVfcKtaQQyf8HnABIAMayZQIwwWyASIINAdEWICawKcFSAjBYJVInWoh1a2/Y33jl4ef/+e9uOHb4xKltD+wI4baAJWFXH/F9+GXwZXhqCWyAWQIgEBgsEpBOIEIF2VJgAVCOEBNTYTAj+3IPf3f+G1/6p3/44UzhTPHJnV98tI25SwKA+oACy059GZwCsw0gDSANIhuABZIGQEtCOAFTBOKIKYohg4RYKO4e7mnmW3/2l6e+8Dt7/uLlX95Tu/eJF/Z+7zguXGDWimnJm8Zysy8LGhOADWaHOcqQsIts9g6w6ByE2bGCjOwACAYnURXaryCuXxJxZZJUWIMwYwwMrflP77++/Df//c2b3/nH9974HO94Ytcru0/i9GliZk2LQbho8Wt8LpfgaWbOEUd5ZEc3atF/H6ziraTP9qE97iCuSbACkwWkVkZk3+hqlT4l3LP/EWbY+uvJ3Y98/+1/7fP2qEOfLz385Ne/9tWjcKOIQTERxwAxAH0lDZfgYgnuAJwHRCdnNm/V5urHBU+sUtMvQM2OEderoMAHtAIMA7CyEB0DMIYegp/7dPup9x5RP9y/L2O/lr30lY2P/cnjO3e8jbZosbICYjMGQV2Bj4wsxQCDmFgSk8VAhoiLiRzcAhJfRvXF3uDk9+GPTeL0RIDDFxOMuYQIAj22wK19FawfrqARuPyNeJe958dH0HPeCf/8tkde+KM/3T6FWtVkYYIow0hyGiw16EohgqFndoOJiSBMgNJEXIyVU2pWjj6WSTd64+M/wuShi/y374Z0yFYIugF7kJAyJURi4hXXwrrAxOFjh+n4wTrK1RR23f+78lPXdwlEbo6p3SJDSmaficFQhcUEWqqaBhETWMgk4VQcJ7l0Pp8be+2lB4dvHrnZO/Yyzr0zx398XFG8iZHrIHQ6EqmUgZRhwmQLuayDt+bmMLm/jlQd+IM1a/me0aIRq/rO6dNnj3f3FWogmIZhCKYAlHQxrb7rSuk2AIJmLWfnG+lm0y/H/rmhjrL5W62Jw7ww1aRdk4rkbUCulIKdk7DTApZpwDIspMnGa+dmMfGzOrgFdIQONgyVCe1ZTtmZ4vmTr25Plz77Aqswk8vYrmkFIczqYvSPjCylIYHaYSLn5pvZpuuWUZ28rTige4TU+EUtxsJaRld/CrYjIC1C2rFgWyk4lMKrv5zG+L4auAlYvsTarR3Y17iAmysOFTMBEFa2jB058VLvYFeDhDZLliOWesWyGFAartc2kiSxDSnSbb+15uhpP7WfGfb6TbjRIJRzOQz2F9BdBCbrb6MR+jjwbgWn9tXANYB94IZPlJFeyXhvrIKTF4vYPNiDsNXq8uKplUFPfsK2zJRWaRLi6nZiRLGiSqVlhlFkmwIpt97q6x7Iov/wDJ79zpsIshoJAUoA/Wvy+Pz2h3DLiINnf/I8kspiQvV2OejfYqHuBWgjwuGLC9jQ3wnfi7NNv97ZFSe2F0RmSWmZEle3HyNRilpeIJJESdMUorHg5YbXFLD11k68qAowmDBzJsB8JcD8/zTx9SPfhkwDZrRYM2VMWPepAiinEDZiKJ1guhEgijQ8P6F6HGS11jIMI8la07X9TxhSIopiUlozEalarQ3PjRDGhDiMYQ8DN95fwvobOyAjgsWAEQCsAB0C/QNZdG1OwQ1DhGGMOFIQzGi3GW5ToR0xhCAthODF5nV18xOCiP0gUk3XB6QIqy1uNioe2LBQikw0FiKEMsLqbRnctKUMERKQAEgA8oCN9xXg6jZarQhtTyH2NQYyeXhujHo9VjDthmEYkWkaioj0td1XaGaO4kS5XhhL0wgi2JOXLjSRsIFNHR1waxG8Zgg3bGPwM2msHS2CPSDxgOs25iAGFKqVNrxqjHZdId2WuK5cRr3iYqGauFZH57QhRdswRGRIyR9QgDVzqZiNAPKI2LN6uo9NnmuGrZrHd16/Dk5LoDUfoTEfoO75WHWvhcG1GZhtQtctJiqVAM25GMGCQljTGM33omxnMDvR4LmWMX395pEJaRieachIpIwPWiDtWOjrKSaWlXJdL/Juv3v08PiMnpw6MUu92Sz/9rrNaC9oNC/FWLgQoFb3Ud4iMXCTjdCIUb8Ywp+NES5olBIHf3jHJ7k24+L8WI3D3hVv3H7r6mkhhJ9x7BBgDYCXj3oCkjiftZN83vFct+3eccvgVGH0hj0HDs4kp35xhn7/rl/nZx5+EiVagYUJH3NnfXjtCM4GRmM2RO18gGge+OR1n8a/PfU0ty62cPTAJE4E6bOPPr7tpTCIXCmFl8+lYyitL09dVyafp7+yHZlcGm0/RLXuk5WS4p5fWz/z04PnCxPvXVyfNOdpw8AK3n73Q3Td0B2oVpuYn51H24tRTHVj6033Y+dnv4DPdPXiyMuv0pv7jtHxKi9s27H1mw/8xuiR6kKrkcukXcs2I9bQRMAzz+29espl/nfUxqbkkRMXHGIurBnuzi9UWqueeXbvl8Tcpfs2rusRfUNl7h8eoKGNd6J71TqwFvCac7h44iDGDr2D6Ykanxmfo/GWWrj3wdufe+KLd/88jpNKorhRLmU9IoqZmUXvYx8cs9XMtyE683TwlXfNS7N1Z6CvlO3rKRTqzaDv6V0/2VE9PbVtZdHs6u3OUqlkIZNLIYk1Aj9GoxZiZs7HdM2PgnT25P0PfuK7Tz1+92uNZlCPE9Uo5h3fNI0YgLo8eS13wfsjWeMHmJmap5/tP2r5fphZv7Y/vWao2wFzx4t7Do2+9dbYXa1KY1RFcb9g7TBDxppjlrKWLWTHhq8feOOh7Vtev/Outefr861WnGg3n7N9y05F0Kw/DP6+C5Y23HN/j3/Zc1CMnZmxchk7fcumVamucs4xDMqFYVLw/Cg/N98qzle8YhTFZqHguEODXZU1w90LpYLTJEIrUdozDcN30qlQSpEwL0b+tab/yD+dd/Z+FT/6+SExuKJDpm3TZGbbsmTasc10PmunOss52dmRg22nWEqhACRac6SZQ9OQQS6TjiApgWbFzPqjwFea0fKH5//q97DlN7+GqXef0xk7pf0wSl5/ayy6MF1tt7zA15qtXNaW/b1FvXpllyrk0yqbsVQuk45LRScRpqGhtGKlmYhY9D72oWb/lRb48Q924oHPfWtxVuW9OPDTN1EqZumNg2N08vSMUEqLVSs6sGnDKu4qZzmfc/RAbxFSCmZmEBFfBv5fcAD4X6XxV1xnuaXKAAAAAElFTkSuQmCC";
var up_img ="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAaCAYAAACkVDyJAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AgRBjoxAQevPgAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAEWUlEQVRIx+2Vb2iVZRTAf+d53/tv2929m3d3a9NN55AMFG0RKhUF9aEEoX0I0rCS0HS0UkEpMJAUSxti/sn6VH0QpI/Wl0CyIhkhzbJ/rsScOXX/t7vt/nvf5/ThbrNlxjKDgg6c5zwHnvf83nOew3ng3y7xTd9M9Vu+++dgZVu/ntxHVny7puHLDgEo3/b9tGOYm8py65nW7KAe6H/f2wZAKDjtb2VagI3tDO5dDEBsy1ePusYceTAQCx9ntDtvWDm0ff7xW5rhJGxze4P1dXdtIhx+bFVc68rdJCqvlG8/Ww0wY2fHrStp2abTRb6vr5VFgw0mXsS+tkGZnXA0UeIstSo7AETM3weWtpwCwPP956IRpymSLKUrrdqdsgyM5plf6RIJytMzdv64qfelBhK7zt08sLT5C4bfuIvSllNLAg6vxqpipEMh9RUZyihXBjxxjdX6hIuItCZ2nVvW++JcKnaf/+vA6LNtDB+8m+iGtkqsfhSbUYxUxjXrqQjg+Up/yuNCb17qywzJYgcfjib3nK/s2TKHRGvn9IHRdSdJHV5CfF1bkbUcjZeGorHbq7U/h8h4X6sqmZzSl/Lp6M7RONPVsogzM+9zINnaGendXDt9YOqtZQDkle3RkLkv0VinPeqKg045p1YZSVv6hj0uDuTkzmqHSNA0+aprq/d0SsXezumXtHjtyRWO+s11S+ulN1gkonbqAVVQxVplcMzSM+wzmvV1QaVjRHg977KoZ2MtFfsu3hhY8tRnBbvm81rx7L76hdWRnni5qur1f6SFDLHg+4XSXh7yJeKq1sUdF5Fjyf2/FPc8P4vkwUvXA4tXf8LIO/dS8uSnAdQeSlaXzs7NrVbPyB9OI51Y1KJWyXlKX8rj6rAnc2Ki0ZDUoBy97d2r0t1cQ/LQld9nqBPrnnA4sDzWOEfHgkFBb1Bz1UkYqqhV0lnL1SGf/jFfFle6qshyO2p3AHRvqKLq8JUCsPiJE4y+dz9Fq08843t2/bx75tIfLcHaPxm2EyXV394njKQtXYMeIxmPpTUuGV+bKw9fbipMbnMtXnjlx4sckQ8al8yq6byjHuspiCAKNptHszlsOo/N5NFMDm8oTa5rABNywTWI62BcB1xDKOSSLAswOxHQtBeQH4b0zKjVpr71lT8ZgKLHj5fHI+6rax+oqnnk4XpFIRwQwi6EXAgHDCF3QmXShh0IOxBxhIgz7ruCAcaylpGMlRcWFuu8EXdBIuW8/NCRgSLZf+xn4yMtCnv7UnnO5gK0pwTHCGIERFBrwSr443dmFc37+GMZTMBBnEKGGAOOQZyCLYk4LCoP037Skhs2DI7qKrezNysVsWDu9IWRSx+e7k97KmCkEMQx1/auAWOuBXcM4rpgDSCFl0IFUQEVUOgfhYvpLDrT4PXYIhzjuF39WT+Tt292dKXfTuctgYAD45lhxlVMwR9XnXi5dWrXCjKlycw424mAJMBT9flf/vPyKztX7pN6V2XmAAAAAElFTkSuQmCC";  
var up_glow="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAaCAYAAACkVDyJAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AgRBwMPzyBVGAAABfBJREFUSMe1lNtvnMUZxn/PzPftrk9ZO7HBtkzWSYhjp9RxfABKoZQLKspNpV70phf9F/q3cNmL/gNVL1ArVJFW6YGqUEqECjQnh9QHkpBkE68Pa+96v3l6YWOSEipA6ivNjGakeZ553mfeVzwiXl5d5dzYGGFphVdjEWNW6rN9TPas4RjSrvAm0GOrhPxvoQuWPpbZuNCoFyuT334UNNmjDs+NjQHwaiCErNQFHgHPWLyImRCkkGs77VIBImbRGEktYGmy61Cz/s7b6ZnhEc7Xag9hh/8me2zjBgAvrC4Ts5gLHyF5CvQ0ZgZxkuDJpT+0Zo2nJCaAGcTT2KcRQ93lvPTs8IjO12rMXrv2vwlv940ytv4Jh7OYQxqwdRI0jz0DeiIrh0OLf2xWP/hFs7r8TqsacvokjcmaQZ7HPmno7y3l+fjFy1w4cYInr138IuEzly4dHM7thEx2H+io7LNJnpN0LGT03vpwJ7v9z1b48XOH+PSj3VC/3omIHqBG0qzts7LHReqdOdIbBy6+z+KJKX6wtPQ54eiVK7wzOQnAK6srQUWqGA0D08YLQqcQA1t3O3HxT1uMDVT8k5/2a6QSff3dtlqbKQJV8IRgHpjGjKTk7u9XBwXwZq3Gd68vogNZ713gpcP9qnZVysmMCM8Zv4x5XmK82KXy0W8b6txCQ0f76c0KhmKHCysdl49nOvVi2ba3gWXEW0LnbL0r+War3Wn9rlYzQHhh39TTzunrKmdJ9AufSPYc5gwwikJl9b2tsL3UUfdw1Te3ze2NxP2tXb41mmvtWsEnH3aIpVAGRmzO2J4DT2AGyqUsn75yWbz7D+Lya68x88FFxh6rxiyGvmCfsP2s4HnglIKqjdVWdun1BoO1w97u7tJuu6DdKiiaLYb6I+U8+tpiR9XhoK5DIZP3ykVBO0hrBG0ciqF9vLDj+M3LHO3pDWWpW/CEzRzoe8B0iBpsbRb5hV/W1T/YS350UJvbBSoKinZBa2OHQuLU4yWtt8TKUtLQsaBYUi5TtmXwlkwjxLi1U650wmjK1QVlwRBmCvtp8FMKGuq0XPrwV3X1lHNXp0a51wbtu26bnbapbxRcud1mbiyjO4nFvxekXXKkQeGnZBaA09hDvcHl8FisZFj9wJPAgtAZSSOYyrXzDXVu7TI0X9MdZ0T8UM06mc3tRH29w8r9NrOj0c0b6NbVJJuK9/0E5sETQH9wcp9NDZi1PWs8DvTeudTUzbcb1L5z3HdL3cjp4Q5hg01KZq2ZuLNesNUq9NTj0dffN837DpK60R42cBZUCwSGJaZtLwATkqo7jU688pu6xidHfKf/sGx/seF6TyEJimIvtTcbBV2ZVTsUuPiWKQpHSVXbJ23mbU8H7CmbBaTTko6kjvNLr99Vb97l9slRdYIe2fX92eSEk2l3TH2jw6frHY71i1JHvvq2ZJNJOgKcBhYCaF74DPZoLKty9Y162Lja8sCzx9UslcA8OuwDMmyczHYr8Wmj4F6zYHYkU/0TWPmXggIVpFHEmbDnG+NZJfYs/7kRlv+65smXTupeXy8pgfgywv2U+kE/YXM7cWOtw+ZOh+fGMi9fhburUgjuAdWCpAkFVe9/3Iwfv3lX8wtj3BgexMWXSXsgEgfq9vw0nSLR2ErcWi+QC80N5L59Jaq5oSC7GgyDu5tFfuP39/Wzs0N+9YfHhaGSi0oG5QwqeaCcfTZ0sFYiVCJ0RdEV9/eZCECzldjcSfx8ukdHl3KvvZ/JSXkmOz+2IV6ZGuL2xi7v/WWJbCOgoL0ql8CJmEws0oGSEonU30XII8oCxAgxQAxof6y1Ar++vEO9ntS6mHOv28qAnQ6Of7u1mZ2/3FBhmSARhEJAUQcgKEAUIdsHHihB2H9cDBAEQXt3gtgOcG69ZU9J7SOBvuikH91YXQaGbEr7jevhf6KHlq8Z+vxLG1u0MqNN4V5JhbHM/6i7rx0P3JIt1MokLwL3wNmePH8zMV+J3Z3M0huYbsT/i+hBypTJPidClr553r6ynQL/B2jU9jxyr6MUAAAAAElFTkSuQmCC";
var down_img = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAaCAYAAACkVDyJAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AgRBwUywRK+jwAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAEi0lEQVRIx+1WXWwUVRT+zrl3drfbdne73e2Wv1WQYDQxwd9UjIiJ0ScfJDEENGp8ofwIgcpviGI0Gk2AaFIEYvwBwyMPRsJTI1FDkYithRCUtkChS7vd0t1u9292Zo4P0xYLrVQTEk38kpk7dyZzvnO+79yZC/yP/zropV0dCFcb1Hohqzp6czAMBSgGMYM0A0wgViBNADNIsftc3bgG0/icePSeIrBSECawwXDyBGuAbD0z7FXRoGflYM7afiFZKFgCwBGAxB0BgBxAGBABREDj6f45dYLcVM1YGLsAWCn4MURbdTziFRvkeXR+YNa8WAV+Mw20ZQmKCcTkBnIc923bgThuIlK2YeeLYFaj1bkKQAlICaAIVRXAwrAXbSccmMOMdE5sAgD/8pZwwO85vPzx6HOxJffKvksgD4+mKYCYNpyiCadQhlM0IcUyrEwe5d7rYK8GaTV6MGAokFLw+xXitQaaHgrL7mNFumI7h+KzVeO4KL4V3y1URN8+3DBnVs/98+BYAhC5ypbKkNIYYRlSNGFlCjATQ2CvBjSDtAJrBWiG16tRV2Pg7oghBcug8xk5k3Nk6eCqWCcDQOXLx1E8/HS7KOw8dfKKObMvBVIkt205dr2jMfmZoBUjWMmoDygRUvTTQDlTEnvn4KpYZ/3+JBgAcl8vQeUrx5E/uOQzpfnT33/sQjg7AmZgSlbCqMcuKYjADFRVMGaGNKp8Gq29FnyKmvsbZxxx7XHAEyK4503FYvlo5vRF8pumTOhETOxKEI83FjGhwsuIBRXCfiVt/RYR5ChX8g4AqNvbh77G+huEuYNPoeq1HzDy1eIyiFcnE8OXPF0J0o7IFAWOVueSejShtlojFtByMSOULUkvCMuuvRqTuuZeJFfXj7swjpEvn3THz5/oEc3ruzsShWj6OhHR1JIyoBShtlphRlBJwSK6nLYtiDyffGN2LvrxFSTXzJpg+6TIHVj0jU2q+XJrt0TMvAjxJJISmAkhPyMaUKj0KjrTbzsieNOw0B7d04OB9XNu6bNbUL3yBADAILydLTnfp05fpihZYt9kKDGhqoJRG9CYU+ORXxI2CqZzRBEdSGyKy8CG+KSNfQuy+xehuvEk0vsb8sxYlh4uZTPnExT2QMYcJSL4PK6UC+o8OH3VoqGCfdVQWJtsihciu3qmXEmTIruvAYE1p5Dd29APpmczgzlIf5q8mkQAaEUIV2vcFTGke8hBMmdDAcuSm+b2Rz+6iFRT/O8RAsBw82MIrPsZw588crJsY2umL4OKUokUQYI+Qn2NFsth6k5ZEJGm1LZ7TkQ+6MLA5rn4i+U7PdRsbPeXHedQOORbGp0dRKW2EVWWtF+zaTAvX6R3Lng98n4nUtvn3/bjNC0M7V6YV4q2DGXNTiedx/qGkFxK2ZQasVuZZAcAiDi3/wFPhyy0oQ3pPQ8CAIKbf31BMx9+xgj6WpBLlhkrMu/c13JHtgc1WzrcBLac2cWLz+bD2869BQDh97qmHYP/CXH6wweavCFaG35RvwsAKJl3bhMU2nh24nzduX/3ru0PInfZcM1Vy/MAAAAASUVORK5CYII=";
var down_glow = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAaCAYAAACkVDyJAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3AgRBwUJcBlXqwAABehJREFUSMe1lklvXNcRhb9z3+uBzeasgZpFkaIkRxEUO7EUOIktwPZCSOBFkI13+QX5K/kFAbLIJousjSSADASWE5OiLEbWQJkSW2JIiaRMtjh193vvnixI04jhYRGogAIuChf31KlTVbh6b3F+VIQ0CjAvzwQyTi29Y7sGCPFSzRBT2VeBQUz6VS4vC488tTUmPAwqG8svD89C7VS4DnTZLoOkrzPU/0Nbe2BYtggp0Dv8LKYvPlkP1+43KSwTJIJQCCgRJAElARQgESENEHZjIaCwc4cgCPrfeJBdBHWWgk7+qCinQDVFyU+H64x2V3w/S3VzPZAEgXbcjhANRcTREI2znPiiTSglKA2QJDugSUCJUWLqXXCxv6Kp65H2UqB0IYbUUvaoJ5b/fneZq0N1XrsyysQchPCV1O4UxFaHuJ0RWx3cysibW2Rr24RKitJk1wOUEpQk1GoJ/RXx6zNVGvdbfnEp0+CFwqlgpVRPyoffHij98Q8LOt8qmVdOqZUZJGSIWcR5JOaRmBvnkTw3nQJCAchIJmjnXEmgVgnUq4HfT2/68YmokxdzKzgLtmcc3Rw4VStOvbvPkxPzHH66sqPd91lgJ6mgL/UiTQJ93YHh3gQr8Y3VTAfGC9d6HC01g6QpwVzeKjaP/6IvHn+jX/euPfDg+gYhfMfyETsgYk/rEKDeFTjcn1Kvplyfz3X8NOw7aseoTXAjgCeNbiEtFG23Tl8dij2nK1r950PXOp1vnwcJtNuJuyy7KoGDfQmDtYSpxdxDR+DYK46OtLAXMLcC0l2JCew7tp+HVNnZ9/Z5I9tW+cGC0+hvnzCxB1pOxVBPysHelEdrppNapy/bErnt58AdYCIQeWozLWkCmLHdrPalxfivhjx3b1H7176wpG8vaYAkEUM9CYf6ErZzufEicu5nIklU2G5KeiAxKWk6KGhdogFM7eipOWBj/9maD13uo/HxQ+3rbGGFbyipCEH01wL7exO6K4lvPys0clHUBhRtb+Gdt4Gb4EZYKlo58hrwOTBhfMv2IqI1eqXP6XCJ5cmG9yun+PrWC6LeFRjqTTk2UGZqoVDtMB4+HSzREixK3AImQTPAWlgImbehbVhG3EX6BHTb0ctpRZ3zvxnyZjtT8+4Cg2WwvyQoquWdUo4fKHNjPmcrmLHXE0KJDHvF6LbFBHAHaXkjqh3mDp1haXk9ZtHbSAtB/Bs8AczEwmuVepJfeH+A1aUN/GzNlVQYSBMx2JNyYl+Jh19EL20WnHszdaVbBdFNwwMFbkhhmqD/FHm2VVpdi8nPZ2f55Ow45fd/68HersJSRzubsyoYwPRW+0plpWjl7qbq9bIzo77UHOo2SZLy2bNcx18v++B4GmPuTcOs4DrWdZn7QLOxuVV8tLFJ+o/RUQDuKOPgdjvv66quRTQbRL/xIKYHx/LR17qrzcVcW0+bOnS8n3oaGEhKTD3J3D+a6sj5lKIT2+zqJnTD1gzyaruTZ9PjZ/zlcuLwzAy89irXRk65lRedgJeBO0ITwGdGy0lZ+dhbddqliNe2/LvL/TxaKpz3Syd/XDKmI1gR3BaawP6MEFeC3f7gxAkDvPHo8x3AhfFxLt27B8AHR49FJ6El/BSYFpowvo9Z7d6XFmNvdjO/2tKf/7TmxVahkZ+UXamHAmiCZgyTwDRiMQRtfdhcMcC7jQYfjYyxN1z/Ont2r91vVGNuaR382NLNYN2w/SjmbAyfr+YHLlTiX66/4OAPSnFoJC0wm0CD4ClJNy3NmbDx6fONYvXcRcZm7/LXEycA9j5Oe3ZgfYH5nsOMzD/OBpN0VfID7F6kAezuvO0jY2/VVCHV0UtlxwxsLyA+lTWJ9ECwtt7JsrlzZ3h1dpap3T753q/KL588CaGU1ISP2b4MXMGMS4qhxHbMqNok4M+BDxXCx5jGVifb+ujpYrw0fIhru8y+E/Cd+Xn+dvQoofGEq0mRJGm5x/aI7FcNI0iZ8AbQbauMPCc0ZemhzPpU83nx5OwPv5HEfwESfwMmXNBW3wAAAABJRU5ErkJggg==";
var gbtn_img = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAKOWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAEjHnZZ3VFTXFofPvXd6oc0wAlKG3rvAANJ7k15FYZgZYCgDDjM0sSGiAhFFRJoiSFDEgNFQJFZEsRAUVLAHJAgoMRhFVCxvRtaLrqy89/Ly++Osb+2z97n77L3PWhcAkqcvl5cGSwGQyhPwgzyc6RGRUXTsAIABHmCAKQBMVka6X7B7CBDJy82FniFyAl8EAfB6WLwCcNPQM4BOB/+fpFnpfIHomAARm7M5GSwRF4g4JUuQLrbPipgalyxmGCVmvihBEcuJOWGRDT77LLKjmNmpPLaIxTmns1PZYu4V8bZMIUfEiK+ICzO5nCwR3xKxRoowlSviN+LYVA4zAwAUSWwXcFiJIjYRMYkfEuQi4uUA4EgJX3HcVyzgZAvEl3JJS8/hcxMSBXQdli7d1NqaQffkZKVwBALDACYrmcln013SUtOZvBwAFu/8WTLi2tJFRbY0tba0NDQzMv2qUP91829K3NtFehn4uWcQrf+L7a/80hoAYMyJarPziy2uCoDOLQDI3fti0zgAgKSobx3Xv7oPTTwviQJBuo2xcVZWlhGXwzISF/QP/U+Hv6GvvmckPu6P8tBdOfFMYYqALq4bKy0lTcinZ6QzWRy64Z+H+B8H/nUeBkGceA6fwxNFhImmjMtLELWbx+YKuGk8Opf3n5r4D8P+pMW5FonS+BFQY4yA1HUqQH7tBygKESDR+8Vd/6NvvvgwIH554SqTi3P/7zf9Z8Gl4iWDm/A5ziUohM4S8jMX98TPEqABAUgCKpAHykAd6ABDYAasgC1wBG7AG/iDEBAJVgMWSASpgA+yQB7YBApBMdgJ9oBqUAcaQTNoBcdBJzgFzoNL4Bq4AW6D+2AUTIBnYBa8BgsQBGEhMkSB5CEVSBPSh8wgBmQPuUG+UBAUCcVCCRAPEkJ50GaoGCqDqqF6qBn6HjoJnYeuQIPQXWgMmoZ+h97BCEyCqbASrAUbwwzYCfaBQ+BVcAK8Bs6FC+AdcCXcAB+FO+Dz8DX4NjwKP4PnEIAQERqiihgiDMQF8UeikHiEj6xHipAKpAFpRbqRPuQmMorMIG9RGBQFRUcZomxRnqhQFAu1BrUeVYKqRh1GdaB6UTdRY6hZ1Ec0Ga2I1kfboL3QEegEdBa6EF2BbkK3oy+ib6Mn0K8xGAwNo42xwnhiIjFJmLWYEsw+TBvmHGYQM46Zw2Kx8lh9rB3WH8vECrCF2CrsUexZ7BB2AvsGR8Sp4Mxw7rgoHA+Xj6vAHcGdwQ3hJnELeCm8Jt4G749n43PwpfhGfDf+On4Cv0CQJmgT7AghhCTCJkIloZVwkfCA8JJIJKoRrYmBRC5xI7GSeIx4mThGfEuSIemRXEjRJCFpB+kQ6RzpLuklmUzWIjuSo8gC8g5yM/kC+RH5jQRFwkjCS4ItsUGiRqJDYkjiuSReUlPSSXK1ZK5kheQJyeuSM1J4KS0pFymm1HqpGqmTUiNSc9IUaVNpf+lU6RLpI9JXpKdksDJaMm4ybJkCmYMyF2TGKQhFneJCYVE2UxopFykTVAxVm+pFTaIWU7+jDlBnZWVkl8mGyWbL1sielh2lITQtmhcthVZKO04bpr1borTEaQlnyfYlrUuGlszLLZVzlOPIFcm1yd2WeydPl3eTT5bfJd8p/1ABpaCnEKiQpbBf4aLCzFLqUtulrKVFS48vvacIK+opBimuVTyo2K84p6Ss5KGUrlSldEFpRpmm7KicpFyufEZ5WoWiYq/CVSlXOavylC5Ld6Kn0CvpvfRZVUVVT1Whar3qgOqCmrZaqFq+WpvaQ3WCOkM9Xr1cvUd9VkNFw08jT6NF454mXpOhmai5V7NPc15LWytca6tWp9aUtpy2l3audov2Ax2yjoPOGp0GnVu6GF2GbrLuPt0berCehV6iXo3edX1Y31Kfq79Pf9AAbWBtwDNoMBgxJBk6GWYathiOGdGMfI3yjTqNnhtrGEcZ7zLuM/5oYmGSYtJoct9UxtTbNN+02/R3Mz0zllmN2S1zsrm7+QbzLvMXy/SXcZbtX3bHgmLhZ7HVosfig6WVJd+y1XLaSsMq1qrWaoRBZQQwShiXrdHWztYbrE9Zv7WxtBHYHLf5zdbQNtn2iO3Ucu3lnOWNy8ft1OyYdvV2o/Z0+1j7A/ajDqoOTIcGh8eO6o5sxybHSSddpySno07PnU2c+c7tzvMuNi7rXM65Iq4erkWuA24ybqFu1W6P3NXcE9xb3Gc9LDzWepzzRHv6eO7yHPFS8mJ5NXvNelt5r/Pu9SH5BPtU+zz21fPl+3b7wX7efrv9HqzQXMFb0ekP/L38d/s/DNAOWBPwYyAmMCCwJvBJkGlQXlBfMCU4JvhI8OsQ55DSkPuhOqHC0J4wybDosOaw+XDX8LLw0QjjiHUR1yIVIrmRXVHYqLCopqi5lW4r96yciLaILoweXqW9KnvVldUKq1NWn46RjGHGnIhFx4bHHol9z/RnNjDn4rziauNmWS6svaxnbEd2OXuaY8cp40zG28WXxU8l2CXsTphOdEisSJzhunCruS+SPJPqkuaT/ZMPJX9KCU9pS8Wlxqae5Mnwknm9acpp2WmD6frphemja2zW7Fkzy/fhN2VAGasyugRU0c9Uv1BHuEU4lmmfWZP5Jiss60S2dDYvuz9HL2d7zmSue+63a1FrWWt78lTzNuWNrXNaV78eWh+3vmeD+oaCDRMbPTYe3kTYlLzpp3yT/LL8V5vDN3cXKBVsLBjf4rGlpVCikF84stV2a9021DbutoHt5turtn8sYhddLTYprih+X8IqufqN6TeV33zaEb9joNSydP9OzE7ezuFdDrsOl0mX5ZaN7/bb3VFOLy8qf7UnZs+VimUVdXsJe4V7Ryt9K7uqNKp2Vr2vTqy+XeNc01arWLu9dn4fe9/Qfsf9rXVKdcV17w5wD9yp96jvaNBqqDiIOZh58EljWGPft4xvm5sUmoqbPhziHRo9HHS4t9mqufmI4pHSFrhF2DJ9NProje9cv+tqNWytb6O1FR8Dx4THnn4f+/3wcZ/jPScYJ1p/0Pyhtp3SXtQBdeR0zHYmdo52RXYNnvQ+2dNt293+o9GPh06pnqo5LXu69AzhTMGZT2dzz86dSz83cz7h/HhPTM/9CxEXbvUG9g5c9Ll4+ZL7pQt9Tn1nL9tdPnXF5srJq4yrndcsr3X0W/S3/2TxU/uA5UDHdavrXTesb3QPLh88M+QwdP6m681Lt7xuXbu94vbgcOjwnZHokdE77DtTd1PuvriXeW/h/sYH6AdFD6UeVjxSfNTws+7PbaOWo6fHXMf6Hwc/vj/OGn/2S8Yv7ycKnpCfVEyqTDZPmU2dmnafvvF05dOJZ+nPFmYKf5X+tfa5zvMffnP8rX82YnbiBf/Fp99LXsq/PPRq2aueuYC5R69TXy/MF72Rf3P4LeNt37vwd5MLWe+x7ys/6H7o/ujz8cGn1E+f/gUDmPP8usTo0wAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wIEQMpM4gtTWsAAAd9SURBVFjDnZddbBzVFcd/987Mzn7Mrje7trNxHD5CI0ETRMqOqVpDBRJp+xIeKKKoERIIISRK6AO8IpEHVImHClEJtUE8IKoS9QGRlgKlrRSRFBppEAKcREhAPhw7NsHr9X7N7Hzs7cPO1JMlhrQr/XV1Z+45//85e+aeewVX+HMcRwNuNU3zzkwmU9c0bbsQoiqE0JRS7SiKzgdB8Innee8qpd6ybXv1SvyKKyAuG4axv1AoPJLP57cahoEQG5tFUUSv1/Nd132t1+s9a9v2h/+XAMdxhKZpDxeLxV8Xi8WKlBKlIAwDTp8+zfz8PGtrLQAsq0CtVuPaa6/FsiyEECilcF1XtVqtV/r9/hO2bX91xQIcxxkzTfOVcrm8N5PJMBgMOHnyFIfffJ13PniHZX+ZMBtSKBaQUuJ5HnhQlVVmb5hl7x17mZmZwTRNBoMBrVbrQqfTubderx/7VgGO49Sy2ezfy+XyLikl58+f57cv/pY3TryBMZXhezt3s3VqK0bOwI1cBgwwpYmMJM1Gk7lP51g6s8Ts1CyP/vxRbrrpJoQQdLvdfqvV+kW9Xn9tQwFx5MfGxsq7hIAjR47w9ItPs1xaZvsN1zGwIs54Z+iIDmQAPTYcAAHogc7WzDTjjHPh9CLyouTxnzzOz+66B9PM0O32gk6nfVe9Xn/7awIcxxG6rh8eGxvbK4Tg8F8Oc+DVA3hTHuYWk1VzFUpAAcgBxtcF0Ad6QBty3RxmK0u0GPLY7GM8eN+DmKZJp9NZc123btv256RcIIR4OJfL7VVKceTIEQ68eoDVyVUYh95YDzYxFJAHsrEALQ4hEeDHAgrgrrm4wkX6kuf/9Twlq8Q9e+8hm82O+b7/suM4P7Jte6Aln5qu6382zWxufn6eJ3/zJIvVRdgCTAITQJWhiLFYSDHORj7OSBYwY2GJOAlKKIIw4MSnJ7h5y81MTm5GSnFVEASfHzx48GMJoJTabxhGJQh8fv/y7/gi+wWMs45KjE0xyt+ASgrV2H4ClowlXvrbSzSbTaSUCCGechxHao7jaEKIP+i6Xjp58iTP/fU53JoLtZHI01HnUlFnUvWgr0eOTNVHBIRwbv4cM1tm2LJ5CqVUVSn1bwncqpTaGgQBb//zbZpWcz3NCakVI0l5PpX63MizfGp9MeWnBL7l8+YHb9LrdeNNLbxXj6LoToBer8fRk0dR42pjsmwq6iTSpAj11Jw4ah9wY1+xKOe8Q7PZpFKpoJTaI8MwrEdRxNmzZ7kYXlwnShOaMWkmlXIjlfpkTL/PpOyz69k61znHSnOFIAgYDAbTMoqi7UEQsLCwgKu7lycxRqo7/T8n0FJI14RxqSiVUcxfnMf3fYIgQA/DsNrv+7TbbUI9XDccLajLkab30dF12gj09XHNXcPzPJRS6FEUaZ7nEkURCvX1TiFGiMQGLU2l3onLIGU7UANc10VKiYwPE2QyGXSlDwtqI6jUmICRubqMXXTpPG/mhwErhQTOh2FIsVikQGG4paYRjiDtUI2QJGuiy9gF69v1ZGmSMAwRQiB1Xf8kDEPK5TIVWQGPIfrxZ5Qg5eASx1GKMBHsp5pTP+XPg03GJiqFCmEYomlaV1qW9a5SCk3TuHHqRujEDSUNL4VRUaPzZJ0bI/HRHeKWq26h3+8TRRG6rr8npZRv5fN5PwxDdn9nN2P+GLSGLZU2Q0Gd2EHaaUKSHnsjhJ0UWkPccf0d+L7PYDCgVCq9Lm3bXrUs67UwDJmcnGSmOgNNhlhLIS2omxq7I/NOvC4mZI3/+qtP1KkVa4RhiGVZvUwmc0gCVKvVZ3O5nBoMBtx+4+1MB9PwFbACNIDVGImw1gZI3ifrGzFWwFwzuf8H99PtdomiiGq1etC27YYEsG37w1qt9koURRSLRe7edTdW04IvgYsMxSSCVlLCLofkfWKzPMQjP3wEPdQJw5BqtdoolUrPkGqaVCqVJzZv3nwhiiKu3nI1+767j8JKAW1Zg6V1R3zJurAEybPlFJZALknEBcEDux/g+ur1+L6PaZpMT0/vT47pl+xrx48fv3Vubu4fKysrplKKC40LHDpxiFahhTFh0M60GRQG33wm7ELOy5HpZAiWAx76/kPsKO/A8zwMw2DXrl0v7Nmz55cbbqzHjh27e25u7lCj0TAAwijk6OmjHL94nMnpSaxxi67o0lEdfOUzQGEInbzIU5QlonbE8vwS1+Su4T77PpSrCMMwIf/TxMTEPtu2w2+8mLz//vs/PXXq1KGFhYWx+MBKKEI+WvyIj7/8GF8PGB8fp1goIqXA9Twaqyu4bZedm3cyu32Wklai3W4DUCgU2Llz5wvVavVXafJvu5pdd+bMmZc/++yzWc/zhg1PSnK5HEIXNNwGvaAHArJGlkq+gmVYrK2t0e/3k5M227Zta+zYsWP/bbfd9sf/+XLqOI70PG/f2bNnn1pYWNjR6/Wu6CataRq1Wq23bdu2g+Pj489sdC+8ottxIkQp9ePFxcV7m83mnl6vN93tdvF9f9jTdZ1cLodlWd1CofDe1NTU67lc7pBt241v8/0fLROqDglVp4YAAAAASUVORK5CYII=";
var remove_img = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAABo6AAAaOgG4MgkwAAAAB3RJTUUH3AgSBikNXTI9xQAABK5JREFUaN7t2F2IXHcZx/HPMzM7m81usktC1JJELSSNWEEvOilSbNGLBuldfaFe9KZUrBdKLwIKCiJK9UpBqGClvQoFi60v6I2geOGF3dHYqqmGtKWGqmvK7izZNd3dmTmPF+fM7pZEyE52t6XMDw7nzGH+L9/ze57/GyONNNJII4000khvX7WHKDO7je3HdsLMlhU2kzuT+4I7cDMauJScxc9qPI1Oi3xLgLTRwlmix7HkU8GXY8y+xiRjB6hNlY0UK3QX6C2Xz8mTwWNBu8WVWZx8M0AGDbcZTx4oeLgx7pbpD7H/I3LiVpqHRH0vkfT/S/c1ufoSy7Ni8SyvL1gKztT4bosLNwITNwIxy2TwaMF9kzcZP/IFOdmisU+ooSv1hD76UiH0KJblystcekbMtWWD55OHTvLssDBxA2E1jh8U3D99WBz/HrWZsqNZyOgJBXpUILJPbNwzCzH/tLzwK8Z4AZ9ulffdAaly4vPJd6bfqXnihyIDqzL6pQPZIwYgxdUw68B7xMJP5Yu/FXiqxudaLA7y73rVGCa5exwveHhqxvjxr8pcwirRF4OOvgFikyvxRqDIvjxwmzj8H/75N59InsGPdtyRWSRfqdd889j9cvqkyF7pRG7qqGKTE90NkM3X5v+vdeSLvxbLS87X+ECrxN8ZRyryJr40fZTJI1gkeiJ75eikVpJaxEoF06xa6mOtcqhXxqeiBBqriYOH5ZXzTkin8MsdBUnujJp9+98jG12RndKN6Fedfx4vlaG2Pt1F1dIkprCngovKlRVcZmqxnE1XOL0bIJ8ZazCxH0tEV+Qq8fc6f66zltSvLqSLDhY2vUNkd/CYE0STXOWurfZrmNC6Y2ycZgqL0oqIPzX4+EN8+166a9dXUb3OxYucPi06HYiojMohcncYR95bq1FfQV/4IzrB+27hYx/dWmXnztFsrhsUZKMC2g1HGlEQS/gXXsPYpljZiorimqPoroDgUtF1U//f1OcGHxKXLzM3x9oWQmt+/iqYPjlMaA0zj/xivOaeYw25d60ccSOCo0c5dOhaX/n/tBwl9Pnzsttd78wFskPcvsW+DZMjP+8W7llZY2/VeGaKixfL5B1euUKsloj/2Grh2hAFflxguVyFZG7P7ixjUlyZkqvl70d3HASd5MnBxB1Vlg+z1ctBPL1b9G6TnaYo6AWP7yhItWjM4LHXWbpUrkoiy3dbgknV7PdhGXez1KezQPJIi4X2ToK0NkaIdnBmjpwvIdZhrted2Et+UsbdoluTr/xOFDwXPLGrW902x/FUlw+ewIGqrkHOXCt31gFvlh4Q8S66L8tz3xKrLNT5bKtcxu+OZjfut7f567Pkq+UaqagGgCwoqnt57ZHFMVk8qMifyO4ZxcKDirM1+Xvm23zxTTlF2XT48P6Cr+HeKRoHySlMTIraQRyWjgi3lgdDK3Wu/EF2fiM6f6FIz9X4xsCJre4Mt+U4aBPMTHIq+XqNE000J2RzhsY7hJlyxu4tsfqqWO1QdPWSR4InTlbzxrAQ235A1y4n2FMFp4O7sloADnKmypFXgu8Hj7c2FvVvnePS2SEdbRtppJFGGmmkkUZ62+p/v5QIkkqA6+0AAAAASUVORK5CYII=";
var remove_glow = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAABo6AAAaOgG4MgkwAAAAB3RJTUUH3AgSBioED8PWogAAElBJREFUaN6lmsuvbdl51X/jm3Ot/Tjn3Lq3Xn5QcdmSBZGCQhqmQSMOAYSUEBEgFo8GIpFA4g9IxxItKxLQoUGDSETQiwwNpPQSaKTc4KFYMgiwQ6TEclSSTbmqbt1b995zzt5rzfkNGnOdW9d5SBQsaWvvs7R19hzze40x5lJ+E/EdxIz0Orp56X6026P2Tx0Tq57slpKqZUKlqpdMaqcUp0tV1qgK96juFOHIcCkZshwWkgVAJiCQSCVGaULNqLsprdbC9KB2UO9k044ueve59ay1S3M6lJpufeRJCpJP4adXuPIdpBm1V6TrfhHl0TEuIhX1FOfeSyhqgRKpapca9AquiaqtSqeQTLaL5QIKSwUjmbCMAAKEHCgTDCS4Y5pEN2pI3Xi13WwXVrqDlqW0rtBFWfu0r2I6dK4z3EN+55RXLFmZUX9Fuq5X8fR8GfW8hmqPOlOWUC1LTMIF9aqISdJUUU0zpTVlj0lklVwtFaEiXIxlCBkZQFiywSaUhh6mA82ihWiG1bja2UxZyb6GUZQaciizR1vXlkvA9WWW/T5jvQ7eeezK6+hZv4in58uYjmvUeYmWtZp5Kmol1j710JTSVGjTpDKlNRvPCs+ZnpCr0SRUZRfbYbmgEEhOhHFiC6dEl5U2DdxsGvIisUIsklYHxURpSSFZa+9qc6yLTe+rMumXJygXF2nXqLx0P/ToGPU8QFT3GqJGuIpeA812zAm7bs1ePQvvJGYFU8hzOmZBFZ6MCxFFOGxHGkWMkKRxoixWN25CTVLLkmv2WEFLhM/qZTGuFmdQ2BHdqdK6SpeSSXGxEhU/66J9WKnL9VFHpUrt0XKqIabqqJFMBHOGdqR21Z6N9sg78A6xs7WTPGHmRHOIiijY1RA4YiQVDCgYOxNaSJ0tnUCL0Cq8YCaTZ1uTrSIoUpYklYkEzAER1evSfTqd0HqksjpKnKLOFFOniKjumrJrJ8dYPOxC3hvvLfbgPWhntJc9I3bCE9IkUZyuoAKEAI96N8KCBBrQDc14CWsBLzKL8WQxgc4yBVxMRoSVKkJQZMoarCvsbIiz67xfdc5ellW10Esoa4c5Hbvo2iH2KhyM9rYPlg6CPfYes0caINAOPAHVqCJCWEKyLYSRLZSgjt0QTdJie5V8RjqBJplJuCgUNsqUooiQEHKS7j2ZavV+7nk6r1GfrMtosZ6m6DFJOYfYtdCum/1U4wAc0hxNOQoOgh3iCOwT70PMhhkPICgKcsEEstDAYZOItN1BTdBsr7YX4CSYkCbbI0WhICJi1Jmx0p1myKg40otXryWp6VpKUkSWHkw4ZmAu4R3oAD7YPmIuBEeZg+EAHA172XujGTEbTSQ1lMVWjEL1KA2wRnAS3C2nzSJYJS3ANKLhCbYaSwshSTif11naJCXTPZKcskbPOqESVkW9ptpkYlfMLmBvsbc5Go62LySOiCPmaOsA7EF7wwyaxmI8easPjIxDwChTpfBYiNwQM7CKWEZauppRF5h4zgWQbTtEStERiZ0FdSI61aVW9WKXimIK9SmzzxZ7E3tbhwgdsC8QR6MLjUgckQ+2Dkiz8Iw9b7taNFE0I02IKBKj4t3lPGMWEpPgFVgsKqaCK1CMijSanMC2LcmMiZSyUqnu0puKe7d6zWTQDmmKjNn2DN5Z3ps8JDHqQhyFjxCXkvc2hwgOozaYjSc6k1fmZ28t9x7/+/OD299ux/auZzoq92i7z5fT1RfnD1/6qd2j6UGcCVXjGjAZJo26kFAgY2MGRXDKKamTak530Vvi3nt0HKkn//WVHyp4X6x9oiP4AvnC9hXiUnBh6wp0Zbb0MkfQwXgX8s6d3enbefn418+vfPDV0+teiHoJ82sQVyAgb2F9H9bHo+/e+/H6+OUv7d47/tj0tLwUJzpn8Bk4GW4F18ANcC301OaZ5WfAU5lnFtckN4luKdxU42KrGibbswozsMfajfaaR9DR5oA42D4IDpiDKnO/9uHhV8+fePhvzq/nB7m7/wW490V8+BE0vwblCDL0a1jfg/O34dnX4dFvtftv/5d276W/ND969RcO7xx/tD7Oa4cHbrzNHUQnWUGN9IpYHFptrSGvdaRnqWEXm9rMBJ5lZm3DDvuumMcQNAdCB5udqub+uF989yvXn3361vrg+Dp645fg4s/ieoUIYL0bfVAOML8BF5+E+38GXv2L+N1/R3z/N5ZXTv+rHT/15Yu3r35ifthv7uqCFINUItZBaVgMy9btJoWr7CJHraZW5ApMgaewZ9uT8Cxply8AGoXNjNjltQ/f/cr1Z5+8tT546dPo8/8cl/uIhvwI1Hhhho+XO2h7HV9Fb/4DfPky+r3/kPvv/dKzN3/o6qof/vT0iO4ZaNhN1oq0olwczKQm2bPkmdSUVkWqNXAlXSUqyopi0miLO6Mp8DYjmMEzZibZPfzq7SeevrU+eOl19Kd+GawNwLZQN9AdkBxA9AKY7b5e/WmIBf3u17z//r+4+fQbX7k6l/uRiFlSA0YDsub4aF0noaLIYlNt1xqRMQieq9A0SBvbTGBneQbNg6Z7tjydvp2XD//t+fXjFfr8P8J+yuCpL+76iyBeiIr+QHTc4eUv4DfeQd/9T+2lJ795fvnBX98vSH0kp2ebGWkmGS1eTCnmUExh14SotiNFBdVNT0zGk7SB+UFgEzB9+OvnV/K93L3x96AE8vt/YLf7BmCLBOtHQF4E9ML39doP4w/fRu/9q9tP3v+Z3cOY1cZwpUqabCZro0CogouggCJEqdldLG0EzUW4SBRJZQwoVVJ17ISKF+YPvnp6/f5n4OINzGOktqWSh6TFwGPgtIGZx8/TgWWLUPuojtxhCvTKZ+Dt3/HuydfWB/f/yv7kRsVMtmsExXa1VSRX2SFULEqCalHIRAQuDocdRXZ1+o7FlhDFUFQpz7623PNC3PssrusP1gWPgf8OfBs4b4A2gkQFLoDLQWyYN4HSQSfgCVw+Hrff/9XT6w9+bv+un3kjjmNThzZxRSqZGqMDR6KoKEK2bMt4KLthFRREIBejsInYKT78jeVBDTjcQzwFrWOM6XcK/I8yGmThBy9v6fUI+OCFe4C8Psd7AHbAk2+2Y0xW4rEOO4yLrEDEUMxRwGENhlwta8hSAoUGN4sNjEMoMCNsFd18a72YDzC/kD76bxV+6h/CP/kbsC78X12lwNtvwy/+Inr06Hng5gFRw4VRGLb1SVviBiiGRhsMTEZV/mhzsCShTdFJljQSQNZQCO1dT/sjlNOW898AHgl++E/CX/hJPtb1rW/BPD8P0JaBGnKSeC4sdbccS8OLGfQeCRsYE10y2mpUdzuzLZ8cqIfwtqAz/n4KfA94b+tlzxPkY1yZf+RtvZiT8h0H3u4bNLgxucVIVi3GElbgnowYDPfJm4zYNmbYU+UerZ+Y+v+G8s4Lv/7kCbzzDiwfI7UePvxDYPpH0fGdjvFYiT0+INka/ti4YbmO3Ln7ku0h57z9v5TJ0VhtN3n3+Xrq32hT+z7MbfvR1uBXfgV+7df+2F3+w9uuAfrx4x+IZQNve25kj6zesJi0xkLDsu/yyqIOySmnSQ35OTxVkUhpO7ESlLnaVz8+f/juN9rVaYHjlga20dtvj+L9/7hOo2urvqrFqfT2u8N5cWp87tgJSpKt35Kx2Wbbl9QDukJNoSbcEV2igdNn8qWf3j3qwLMtRf0DOf3/fukCbi7xCXjw13Yf9JMNGotzpp4THXUp0qJbpKRepAz7TkK6S0qhJtMxHauRammn5Yad0wPO935ievxo7KD1g2PhY12+q+zPQPsCfjQhB371b+3f89mdQd03DqAOTkzadJwZUg+i23YkdEItcMduCT2tZqsZNYmGWJBW0EqJ9eWf2723HMh374rnLsU+JgjN4D8H+svwtMMHj+Dlv717t7yiM6bbNNsN7t61IK/glklP3K00kIGiY3VQs92MV8vNsCAW41ViFRpGgVmPPzY9fenPz4++Dzz8qO/zcaKjI/hLA8QS+Pf/I5o/G6eXv7R/aLN6RGIFrZIXxCoxIiSvZjA8kw05Q12d3IAMGtckFolF9urhxy4yC/IS8lruxenVn9+/c3hTt78H/uDO130BkP+YKBjw58BfBv0kLGf82/8S9Uv1135+/87uzXgWikVoCbxKXiytIyu8WFpwrBFeAzUoDUcLq7ckm8kV5SJpwVpIL+CzdNdMfMZDZtJ9Pv7o9PhTX758+/CGzr8LfBe0/BHrf774PfB54O+D/hn0z+FHv4W/9Y9Ru1R/7e/u37n/V/fvjyxg9WBtZ8wZc3JyTmvBXiSvltaGuqxepFbD7qHoNi1FC2kRXowXpNPQJZqwK7hKFIzymrj3xflh+adX/fu/fPPp7/7n9tKHiV7ZCO7hAvQK6E8AbwA/AnwOTgVuvoYf/Sb64H/C/GacPvEL+3fu/+z+PWBxakGcBGdvHVn22ehsc5a8AOMsRSzgJtN18/VX3wx5n/Khw0WRLwQXia6QroBL2VfeSLjko80Rc0Daq6q29/P45K3zy+/969tPrt/zbgZ2B5jv4/o64v7mIjzF57fR6X2w8Mt/Z/fuy1/aP9x9Jp4RnLEWrJPlW8GNhyX0TPiZracWT4WfCT8FXQPXCt0GvtHt1197I8mdox9UdPDqC6SjIi7BVzaXwpfgS6OLULlI8oB9kLTXnedrz149PXlrffD+r96+fvvNfnxulL6QYtNrWu7/7O6DV//m/r3yapxtr+FYLFaLE/ZpKBRfG18LPQvpmTOvLT11+Jms6950HeKmhG8UOtVONtmlUNYQdRHnTQadY7jhZWj6564+MrlRmfRoDjtLPSa1+z+zOz340u7dqNtBwqB1gzJJpjnzbPu8zapxhrgYFpnTMOh8q2HM3Qhu3Dm5cCt8G8kJ+czEucDSe7a20Kt2dFa6s6/NMXRwqERsQgYK6buNxba582KhC6+2OmKY0GdVLy6poWHSEGiwWKVt5TgjcTNumFXBSnI2nCVuQ77FurF1jbhR8Xi3TzJnm3ONXJrKmoqm6K2K3jNogJwUycMNR2U7oAk0XPE7Q3kzArukhrWzaYLJwxSYgIIpRpL8XB7gwZsMg3JYDVhtlk0cn4FboduEG8QN6MbiVnAr6zQagZdMVhdWKVoRvfrcei+lTaVGpNZGD5lwR7YVMc4n7qz9zSLv29BatQ0syZPN7OHGlOenAJJSg3VvH9N2erMgJC3GK+Ik6ww62dxmcorCteXbTG6q4tZwq+CMfFpbrjVypatFV69Za09CGVKUVN6GqqRSoEcnBM4RihBJ0JxsA9QN5Rmzw5qQZ0QRrgy9HXeaTM/tdXJMaN+dIa4Si/N5ez0RvpU4WboVvpV8a5dbo3PPPIPXKXzONdpUepuuslVpyotoPdWjqawlumyx3m0gUm5CTaG0lCa77VWwOjUrPM44thMnQ8EKyyOe+XxSvuB2KTcDbhVaLC3jOJqTrfNWD7cQJ/DtqJ88kzo3xxKRPV27a+8KenXMOR1Sbe1tcacgOYBiiXCOZEqJ9J3ZOZys1dZiNj/YnoxqiGKzHYZup1b6SPXdWXS+O+gRzdaypeeSOaa5xEkeB6SKOLf0mcyzHMtescq5Bn2tqbbe7lxVqpl2PZfTeKKASXMdSjTXcHNAZFqZlnpYDbkjrbYWmdlWFUzbYxxVUIbkIWxE2RSfseyUlEn2QQC1Aqs0aEngszOWqF5sn0UuKE7Q12Yve+W6U670tiI3ec7rLFmPsSTXu+A6M5MeFysR1WUNeu9kAOGh0JLuVHPQDPM4Rs4ZqdpMpAqpsjlb4/hMiITQXcvenkNBOTQPzeSa0iqxRow0y2ApeM30srZcp+AcUbp8B2Lq1Joc9ul6yoreT/f7lMMFl7cQFa/n7nWFqVZ7TVvKUmp3GXqFVAtYBRVpSruiqBEU2SVHRAKQ4iNTBuwckclA3XK33CKiOdUNS+IVaw3n2hSrC2uNXL1G6+49yFWqzXcg4sbHmw+zfmddOT577E9cnbNcJDftwO1JzO7sJ+eiMKFkyi6y9x5d0AKvhiKP2SFcxtkf46Ga5xHZytzDUMpxhJOWurWd7qJWGM+npGhNrNGiOdQkN/fSeultqu6Z0a495cUGwqfHOb3XXc8Nc7XCtNqGx/0SsWPWrU/qscZEnTOpWXrTEP7Fq9WLrOosNQalCZtiUA5AsblPjMfM7hCRFiY2g8NKcsyUgG65Ee69lR60FnJXj66rbHPU/ux29pOM7PWUx5sPsz7s9gn/H47+ChCYwenhAAAAAElFTkSuQmCC";

var tcoTokenText = { 20033: 'XXV', 20032: 'XXIV', 20031: 'XXIII', 20030: 'XXII', 20029: 'XXI', 20028: 'XX', 20027: 'XIX', 
                     20026: 'XVIII', 20025: 'XVII', 20024: 'XVI', 20023: 'XV', 20021: 'XIV', 20020: 'XIII', 20018: 'XII', 
                     20017: 'XI', 20016: 'X', 20015: 'IX', 20014: 'VII', 20013: 'V', 20012: 'III' }

var logValues = { SUCCESS: 0, ACTION: 1, SALVAGE: 2, MAXLOGS: 3 };

var tcoFactions = ['briton', 'fey', 'druid'];

var tcoJewelQualities = ['cracked', 'flawed', 'cloudy', 'subdued', 'bright'];

var throneCardTypes = ['chair', 'advisor', 'window', 'banner', 'table', 'trophy', 'candelabrum', 'hero', 'statue', 'pet', 'tapestry', 'pillar'];

var throneCardQualities = ['simple', 'common', 'uncommon', 'rare', 'epic', 'wondrous', 'miraculous'];
var champCardQualities = ['simple', 'common', 'uncommon', 'rare', 'epic', 'wondrous', 'unique'];

var champItemTypes = {'weapon': 1, 'chest': 2, 'helm':3, 'boots':4, 'shield': 5, 'ring': 6, 'pendant': 8, 'cloak': 9};
var champItemNames = {1: 'weapon', 2: 'chest', 3: 'helm', 4: 'boots', 5: 'shield', 6: 'ring', 8: 'pendant', 9: 'cloak'};

var tcoRing1 = 6;
var tcoRing2 = 7;

var champTiers = CM.WorldSettings.getSettingAsObject("CE_EFFECTS_TIERS")

var champItemEffects = [201,202,203,204,205,206,207,208,209,1,2,3,4,5,6,7,17,18,19,20,21,22,23,24,26,27,29,31,32,34,35,36,37,39,40,41,44,45,46,47,50,51,52,53,56,57,58,61,62,125,126,127,128,129,130,131,132,133,134,113,114,115,116,117,118,119];

var champEffects = [];
for (var efx = 0; efx < champItemEffects.length; efx++ ) {
    var champEffectName = uW.g_js_strings.effects["name_" + champItemEffects[efx]];
    champEffectName = champEffectName.split(" Debuff")[0];
    if  (champEffects.indexOf(champEffectName) < 0) champEffects.push(champEffectName);
}

var tcoQualityCount = 6;
var tcoThroneDisplayTimer = null;
var tcoMaxThroneQuality = 0;
var tcoMaxThroneLevel = 0;
var tcoMaxChampLevel = 0;
var tcoMaxChampQuality = 0;
var tcoMaxChampions = 0;
var tcoMaxPresets = 24;
var tcoMaxInventoryRows = 0;
var tcoMaxThroneCards = 0;

var tcoChampStatsGrid =  {
    "weapon" :     {1: {201:1,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:0,3:0,4:1,5:1,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {201:0,202:1,203:0,204:1,205:1,206:1,207:1,208:1,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:0,3:0,4:1,5:1,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {201:0,202:1,203:0,204:1,205:1,206:1,207:1,208:1,209:0,1:1,2:0,3:0,4:1,5:1,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "chest" :      {1: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:1,20:1,21:0,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {201:0,202:0,203:1,204:1,205:1,206:1,207:1,208:1,209:1,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:1,20:1,21:0,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {201:0,202:0,203:1,204:1,205:1,206:1,207:1,208:1,209:1,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {201:0,202:0,203:1,204:1,205:1,206:1,207:1,208:1,209:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:1,20:1,21:0,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "helm" :       {1: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:1,3:1,4:0,5:0,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:0,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {201:0,202:1,203:1,204:1,205:1,206:1,207:1,208:1,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {201:0,202:0,203:1,204:1,205:1,206:1,207:1,208:1,209:1,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {201:0,202:1,203:1,204:0,205:1,206:1,207:1,208:1,209:1,1:1,2:1,3:1,4:1,5:0,6:0,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "boots" :      {1: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:1,3:1,4:1,5:0,6:1,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {201:0,202:1,203:1,204:1,205:1,206:0,207:1,208:1,209:1,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:1,3:1,4:1,5:0,6:1,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {201:0,202:1,203:1,204:1,205:1,206:1,207:1,208:1,209:1,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {201:0,202:1,203:1,204:1,205:0,206:1,207:1,208:1,209:1,1:1,2:1,3:1,4:1,5:0,6:1,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:0,22:1,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "shield" :     {1: {201:0,202:1,203:1,204:1,205:1,206:1,207:1,208:1,209:1,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {201:0,202:1,203:1,204:1,205:1,206:1,207:1,208:1,209:1,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {201:0,202:1,203:1,204:1,205:1,206:1,207:1,208:1,209:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "ring"  :      {1: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "pendant" :    {1: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "cloak" :      {1: {201:0,202:1,203:0,204:0,205:1,206:1,207:1,208:1,209:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:1,4:0,5:0,6:0,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:0,26:1,27:1,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:1,45:0,46:1,47:1,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {201:0,202:0,203:0,204:0,205:0,206:0,207:0,208:0,209:0,1:0,2:0,3:1,4:1,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:1,35:0,36:1,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:1,57:0,58:0,59:0,60:0,61:0,62:1,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:1,127:0,128:0,129:0,130:1,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {201:0,202:1,203:1,204:1,205:1,206:1,207:1,208:1,209:1,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {201:0,202:1,203:1,204:1,205:1,206:1,207:1,208:0,209:1,1:0,2:0,3:0,4:0,5:0,6:0,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:1,35:1,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:1,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:1,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:1,126:0,127:0,128:0,129:0,130:0,131:1,132:0,133:1,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}}}


var tcoThroneStatsGrid = {
    "chair" :      {1: {1:1,2:1,3:1,4:1,5:0,6:1,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:1,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:1,2:1,3:1,4:1,5:0,6:1,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:1,114:1,115:1,116:1,117:0,118:1,119:1,120:1,121:1,122:1,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:1,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:1,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:1,94:0,95:1,96:0,97:0,98:0,99:1,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:1,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:1,79:1,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:1,114:1,115:1,116:1,117:1,118:0,119:1,120:1,121:0,122:1,123:1,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:1,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:1,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "table" :      {1: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:0,22:1,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:1,83:1,84:1,85:1,86:1,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:1,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:1,9:1,10:1,11:1,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:0,22:1,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:1,82:0,83:0,84:0,85:1,86:0,87:0,88:0,89:1,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:1,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:0,2:0,3:0,4:0,5:1,6:0,7:1,8:1,9:1,10:1,11:1,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:1,82:0,83:0,84:0,85:0,86:0,87:1,88:1,89:0,90:1,91:1,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:1,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:1,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:1,22:0,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:1,82:0,83:0,84:0,85:0,86:0,87:0,88:1,89:0,90:1,91:1,92:1,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:1,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:1,2:1,3:1,4:1,5:0,6:1,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:1,22:0,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:1,80:0,81:1,82:0,83:0,84:0,85:0,86:0,87:0,88:1,89:0,90:1,91:1,92:1,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:1,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "window" :     {1: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:1,17:1,18:1,19:1,20:1,21:0,22:1,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:1,83:1,84:1,85:1,86:1,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:1,102:1,103:1,104:1,105:1,106:1,107:1,108:1,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:1,11:0,12:0,13:0,14:1,15:0,16:1,17:1,18:1,19:1,20:1,21:0,22:1,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:1,83:1,84:1,85:1,86:1,87:0,88:0,89:1,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:1,102:1,103:1,104:1,105:1,106:1,107:1,108:1,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:1,11:0,12:0,13:1,14:1,15:1,16:1,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:1,83:1,84:1,85:1,86:1,87:1,88:1,89:1,90:1,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:1,102:1,103:1,104:1,105:1,106:1,107:1,108:1,109:0,110:0,111:0,112:0,113:1,114:0,115:1,116:0,117:0,118:0,119:0,120:1,121:0,122:1,123:1,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:0,2:0,3:0,4:0,5:0,6:0,7:1,8:0,9:0,10:1,11:0,12:0,13:1,14:1,15:1,16:1,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:1,83:1,84:1,85:1,86:1,87:1,88:1,89:1,90:1,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:1,102:1,103:1,104:1,105:1,106:1,107:1,108:1,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:1,11:0,12:0,13:1,14:1,15:1,16:1,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:1,83:0,84:0,85:1,86:1,87:1,88:1,89:1,90:1,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:1,102:1,103:1,104:1,105:1,106:1,107:1,108:1,109:0,110:0,111:0,112:0,113:0,114:1,115:0,116:1,117:1,118:0,119:1,120:0,121:1,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "banner" :     {1: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:1,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:1,26:1,27:1,28:0,29:1,30:1,31:1,32:1,33:0,34:1,35:1,36:1,37:0,38:0,39:1,40:1,41:1,42:0,43:0,44:1,45:1,46:1,47:1,48:1,49:0,50:1,51:1,52:1,53:1,54:1,55:0,56:1,57:1,58:0,59:1,60:0,61:1,62:1,63:0,64:1,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:1,12:1,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:1,26:1,27:1,28:0,29:1,30:1,31:1,32:1,33:0,34:1,35:1,36:1,37:0,38:0,39:1,40:1,41:1,42:0,43:0,44:1,45:1,46:1,47:1,48:1,49:0,50:1,51:1,52:1,53:1,54:1,55:0,56:1,57:1,58:0,59:1,60:0,61:1,62:1,63:0,64:1,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:1,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:1,26:1,27:1,28:1,29:1,30:1,31:1,32:1,33:1,34:1,35:1,36:1,37:1,38:0,39:1,40:1,41:1,42:1,43:1,44:1,45:1,46:1,47:1,48:1,49:1,50:1,51:1,52:1,53:1,54:1,55:1,56:1,57:1,58:0,59:1,60:1,61:1,62:1,63:0,64:1,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:1,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:1,26:1,27:1,28:1,29:1,30:1,31:1,32:1,33:1,34:1,35:1,36:1,37:0,38:1,39:1,40:1,41:1,42:1,43:0,44:1,45:1,46:1,47:1,48:1,49:1,50:1,51:1,52:1,53:1,54:1,55:1,56:1,57:1,58:1,59:1,60:1,61:1,62:1,63:1,64:1,65:1,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:1,12:1,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:1,26:1,27:1,28:1,29:1,30:1,31:1,32:1,33:1,34:1,35:1,36:1,37:0,38:1,39:1,40:1,41:1,42:1,43:0,44:1,45:1,46:1,47:1,48:1,49:1,50:1,51:1,52:1,53:1,54:1,55:1,56:1,57:1,58:1,59:1,60:1,61:1,62:1,63:1,64:1,65:1,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "trophy" :     {1: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:1,17:1,18:1,19:1,20:1,21:0,22:1,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:1,77:0,78:0,79:0,80:0,81:0,82:1,83:1,84:1,85:1,86:1,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:1,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:1,26:1,27:1,28:0,29:1,30:1,31:1,32:1,33:0,34:1,35:1,36:1,37:0,38:0,39:1,40:1,41:1,42:0,43:0,44:1,45:1,46:1,47:1,48:1,49:0,50:1,51:1,52:1,53:0,54:1,55:0,56:1,57:1,58:0,59:1,60:0,61:0,62:1,63:0,64:1,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:1,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:1,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:1,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:1,22:0,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:1,80:0,81:1,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:1,91:1,92:0,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:1,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:1,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "candelabrum" :{1: {1:1,2:1,3:0,4:0,5:0,6:1,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:1,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:1,79:1,80:0,81:0,82:1,83:1,84:1,85:1,86:1,87:0,88:1,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:1,26:1,27:1,28:0,29:0,30:0,31:0,32:0,33:0,34:1,35:1,36:1,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:1,45:0,46:1,47:1,48:1,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:1,57:1,58:0,59:1,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:0,2:0,3:1,4:1,5:1,6:1,7:0,8:0,9:0,10:1,11:1,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:1,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:1,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:1,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:1,92:1,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:0,2:0,3:0,4:1,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:1,26:1,27:1,28:0,29:0,30:0,31:0,32:0,33:0,34:1,35:1,36:1,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:1,45:1,46:1,47:1,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:1,57:1,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:1,70:1,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:1,92:1,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:1,2:1,3:1,4:1,5:1,6:1,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:1,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:1,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:1,92:1,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "advisor" :    {1: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:1,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:1,83:1,84:1,85:1,86:1,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:1,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:1,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:1,71:1,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:0,80:0,81:0,82:1,83:1,84:1,85:1,86:1,87:0,88:0,89:1,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:1,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:1,70:1,71:1,72:0,73:0,74:0,75:0,76:0,77:1,78:1,79:0,80:1,81:0,82:1,83:1,84:1,85:1,86:1,87:1,88:0,89:1,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:1,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:1,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:1,70:1,71:1,72:0,73:0,74:0,75:0,76:0,77:1,78:1,79:0,80:1,81:0,82:1,83:1,84:1,85:1,86:1,87:1,88:0,89:1,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:1,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:1,70:1,71:1,72:0,73:0,74:0,75:0,76:0,77:1,78:1,79:0,80:1,81:0,82:1,83:0,84:0,85:1,86:1,87:1,88:0,89:1,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:1,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "hero" :       {1: {1:0,2:1,3:1,4:1,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:1,17:1,18:1,19:0,20:0,21:0,22:0,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:1,33:0,34:0,35:0,36:0,37:0,38:0,39:1,40:0,41:0,42:1,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:1,62:0,63:1,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:1,2:0,3:0,4:0,5:1,6:1,7:0,8:1,9:1,10:0,11:0,12:0,13:0,14:0,15:0,16:1,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:1,73:0,74:0,75:0,76:0,77:1,78:0,79:1,80:1,81:0,82:1,83:1,84:1,85:1,86:1,87:0,88:0,89:1,90:1,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:0,2:1,3:0,4:1,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:1,16:1,17:1,18:1,19:0,20:0,21:1,22:0,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:1,33:0,34:0,35:0,36:0,37:0,38:0,39:1,40:0,41:0,42:1,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:1,62:0,63:1,64:0,65:0,66:0,67:0,68:1,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:1,2:0,3:0,4:0,5:0,6:1,7:0,8:1,9:1,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:1,73:0,74:0,75:0,76:0,77:1,78:0,79:1,80:1,81:0,82:1,83:1,84:1,85:1,86:1,87:0,88:0,89:1,90:1,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:0,2:1,3:1,4:1,5:1,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:1,17:1,18:1,19:0,20:0,21:1,22:0,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:1,33:0,34:0,35:0,36:0,37:0,38:0,39:1,40:1,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:1,62:0,63:0,64:0,65:1,66:0,67:0,68:1,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "statue" :     {1: {1:0,2:1,3:0,4:1,5:0,6:0,7:0,8:1,9:0,10:1,11:1,12:0,13:0,14:0,15:0,16:0,17:1,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:1,39:0,40:1,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:1,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:1,84:0,85:0,86:0,87:0,88:0,89:1,90:0,91:0,92:0,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:1,2:0,3:0,4:1,5:0,6:0,7:1,8:0,9:0,10:0,11:1,12:1,13:0,14:0,15:0,16:1,17:1,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:1,35:0,36:0,37:0,38:1,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:1,68:0,69:0,70:1,71:0,72:1,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:1,84:0,85:0,86:0,87:0,88:0,89:1,90:0,91:0,92:0,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:0,2:1,3:0,4:1,5:0,6:0,7:1,8:1,9:1,10:1,11:1,12:1,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:1,35:0,36:0,37:1,38:0,39:0,40:1,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:1,82:1,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:0,2:0,3:0,4:0,5:0,6:0,7:1,8:1,9:1,10:1,11:1,12:0,13:0,14:0,15:0,16:1,17:1,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:1,35:0,36:0,37:0,38:0,39:0,40:1,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:1,71:0,72:1,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:1,83:1,84:0,85:0,86:0,87:0,88:1,89:0,90:0,91:1,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:1,2:1,3:0,4:0,5:1,6:0,7:0,8:0,9:1,10:0,11:0,12:1,13:0,14:0,15:0,16:1,17:1,18:1,19:0,20:0,21:1,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:1,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:1,82:1,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:1,92:0,93:1,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "pet" :        {1: {1:1,2:0,3:0,4:0,5:1,6:0,7:1,8:0,9:1,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:1,19:1,20:0,21:0,22:0,23:0,24:1,25:0,26:0,27:0,28:0,29:0,30:1,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:1,45:0,46:1,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:1,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:1,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:0,2:1,3:1,4:1,5:0,6:0,7:0,8:1,9:0,10:0,11:0,12:0,13:1,14:1,15:1,16:0,17:1,18:0,19:0,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:1,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:1,2:0,3:0,4:0,5:1,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:1,19:0,20:0,21:0,22:0,23:0,24:1,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:1,35:0,36:0,37:0,38:0,39:0,40:1,41:0,42:0,43:0,44:1,45:0,46:0,47:1,48:0,49:0,50:0,51:1,52:0,53:0,54:0,55:0,56:1,57:0,58:1,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:1,78:0,79:1,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:0,2:1,3:1,4:1,5:0,6:0,7:0,8:1,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:1,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:1,36:1,37:0,38:0,39:1,40:0,41:0,42:1,43:0,44:0,45:1,46:1,47:0,48:0,49:0,50:1,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:1,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:1,89:1,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:0,21:1,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:1,36:0,37:1,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "tapestry" :   {1: {1:1,2:1,3:1,4:0,5:1,6:0,7:0,8:1,9:0,10:1,11:0,12:0,13:0,14:0,15:0,16:1,17:1,18:1,19:1,20:0,21:0,22:1,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:1,46:0,47:0,48:0,49:0,50:0,51:0,52:1,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:0,68:0,69:1,70:0,71:0,72:1,73:0,74:0,75:0,76:0,77:0,78:1,79:0,80:1,81:1,82:0,83:0,84:0,85:0,86:0,87:0,88:1,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:1,114:1,115:1,116:1,117:0,118:1,119:1,120:1,121:1,122:1,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:1,2:1,3:1,4:0,5:0,6:1,7:0,8:1,9:0,10:0,11:1,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:0,21:0,22:1,23:0,24:0,25:0,26:0,27:0,28:1,29:0,30:0,31:0,32:1,33:1,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:1,46:0,47:0,48:0,49:0,50:0,51:0,52:1,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:0,68:0,69:1,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:1,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:1,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:1,2:1,3:1,4:1,5:0,6:0,7:0,8:1,9:0,10:1,11:0,12:0,13:0,14:0,15:0,16:1,17:1,18:1,19:1,20:0,21:1,22:1,23:0,24:0,25:0,26:0,27:1,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:1,52:0,53:1,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:1,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:1,79:0,80:0,81:1,82:0,83:0,84:0,85:0,86:0,87:0,88:1,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:1,114:1,115:1,116:1,117:0,118:1,119:1,120:1,121:1,122:1,123:1,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:1,2:1,3:1,4:0,5:0,6:0,7:0,8:1,9:0,10:0,11:1,12:0,13:0,14:0,15:0,16:1,17:1,18:1,19:1,20:0,21:0,22:1,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:1,51:0,52:1,53:1,54:1,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:1,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:1,79:0,80:0,81:1,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:1,2:1,3:0,4:1,5:0,6:0,7:0,8:1,9:0,10:0,11:0,12:1,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:0,21:0,22:1,23:0,24:0,25:0,26:0,27:1,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:1,51:1,52:0,53:0,54:1,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:1,73:0,74:0,75:0,76:0,77:0,78:0,79:1,80:1,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:1,89:1,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:1,114:1,115:1,116:1,117:1,118:0,119:1,120:1,121:1,122:1,123:1,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}},
    "pillar" :     {1: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:1,114:1,115:1,116:1,117:0,118:0,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    2: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:1,25:1,26:1,27:1,28:1,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:1,57:1,58:1,59:1,60:1,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:1,120:1,121:1,122:1,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    3: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:1,114:1,115:1,116:1,117:0,118:1,119:0,120:0,121:0,122:0,123:0,124:0,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    4: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:0,18:0,19:0,20:0,21:0,22:0,23:0,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:1,35:1,36:1,37:1,38:1,39:0,40:0,41:0,42:0,43:0,44:1,45:1,46:1,47:1,48:1,49:1,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:0,114:0,115:0,116:0,117:0,118:0,119:1,120:1,121:1,122:1,123:0,124:1,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0},
                    5: {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0,16:0,17:1,18:1,19:1,20:1,21:1,22:1,23:1,24:0,25:0,26:0,27:0,28:0,29:0,30:0,31:0,32:0,33:0,34:0,35:0,36:0,37:0,38:0,39:0,40:0,41:0,42:0,43:0,44:0,45:0,46:0,47:0,48:0,49:0,50:0,51:0,52:0,53:0,54:0,55:0,56:0,57:0,58:0,59:0,60:0,61:0,62:0,63:0,64:0,65:0,66:0,67:0,68:0,69:0,70:0,71:0,72:0,73:0,74:0,75:0,76:0,77:0,78:0,79:0,80:0,81:0,82:0,83:0,84:0,85:0,86:0,87:0,88:0,89:0,90:0,91:0,92:0,93:0,94:0,95:0,96:0,97:0,98:0,99:0,100:0,101:0,102:0,103:0,104:0,105:0,106:0,107:0,108:0,109:0,110:0,111:0,112:0,113:1,114:1,115:1,116:1,117:0,118:1,119:0,120:0,121:0,122:0,123:0,124:1,125:0,126:0,127:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:0,136:0,137:0,138:0,139:0,140:0,141:0,142:0,143:0,144:0}}}

var tcoThroneUpgradeStats = {
    upgradeSuccess: {
        0: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        1: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        2: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        3: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        4: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        5: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        6: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 }
    },

    upgradeFailure: { 
        0: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        1: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        2: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        3: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        4: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        5: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        6: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 }
    },

    enhanceSuccess: { 
        0: { 0: 1, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        1: { 0: 1, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        2: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        3: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        4: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        5: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        6: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 }
    },

    enhanceFailure: { 
        0: { 0: 1, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        1: { 0: 1, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        2: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        3: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        4: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        5: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 },
        6: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0, 18: 0, 19: 0, 20: 0, 21: 0, 22: 0, 23: 0, 24: 0 }
    }
};

var tcoChampUpgradeStats = {
    upgradeSuccess: {
        0: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        1: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        2: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        3: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        4: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        5: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 }
    },
    upgradeFailure: {
        0: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        1: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        2: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        3: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        4: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        5: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 }
    },
    enhanceSuccess: {
        0: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        1: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        2: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        3: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        4: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        5: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 }
    },
    enhanceFailure: {
        0: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        1: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        2: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        3: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        4: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 },
        5: { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0, 13: 0, 14: 0, 15: 0, 16: 0, 17: 0 }
    }
};

//add the new functions to the main window
contentEval(addWatchFunctions);

//add the new functions to this script
addWatchFunctions();


var tcoThroneSorter = [];
var tcoSwapTile = null;

var tcoGlobalOptions = {
    update: true,
    updateSite: "www.markbranscombe.com",
    firstrun: true
};

var tcoGeneralOptions = {
    xPos : 0,
    yPos : 30,
    hidden: true,
    disableAnim : true,
    draggableThroneItems: false,
    throneSorter: false,
    showJewels: true,
    whisperToMe: false,
    sendToInbox: false,
    retryInterval : 30,
    currentTab : null,
    usedAnyCity : true,
    usedCityNum : 0,
    salvageAnyCity : true,
    salvageCityNum : 0,
    safetyOn: false,
    safetyLimit: 100000,
    buffsOff: false,
    removeMastersTokens: false,
    removeOtherTokens: false,
    useMastersTokens: false,
    multiUpgrade: false,
    noEquippedSalvage: false,
    noMassSalvage: false,
    noForcedSalvage: false,
    throneSalvageSafety: false,
    champSalvageSafety: false,
    throneSalvageSafetyNum: 40,
    champSalvageSafetyNum: 40,
    minStones: 100000,
    overflow : "order",
    maxStones : 1980000
};

var tcoLogData = {
    maxEntries: 100,
    successLog: [],
    actionLog: [],
    salvageLog: []
};

var tcoThroneQueueData = {
    list : [],
    oneItem : true,
    doingRepairs : false,
    index : 0,
    dataConverted : false
};

var tcoChampQueueData = {
    list: [],
    oneItem: true,
    doingRepairs: false,
    index: 0,
    dataConverted: false
};

var tcoThroneUpgradeData = {
    active : false,
    useLORB : false,
    useORB : false,
    useLPS : false,
    usePS : false,
    useLT : false,
    useLLT : false,
    useSH : false,
    useKH : false,
    useGH : false,
    useMH : false,
    useAH : false,
    useWH: false,
    useDH: false,
    useEH: false,
    useQuality : 5,
    useLevel : 6,
    item: 0,
    overrideSpeedUp: false,
    hourglassLevelSpecific: false,
    hourglassLevel: 0,
    hourglassQualitySpecific: false,
    hourglassQuality: 0,
    useSpeedUp: 0,
    enhanceAction: false,
    enhanceItem: 0,
    enhanceMax  : tcoMaxThroneQuality,
    repairAll : false,
    effectSelected: "none",
    buffSelected: "both",
    sortInactive: true,
    ignoreBroken: false,
    newUpgradeState: 0
};

var tcoChampUpgradeData = {
    active : false,
    useLOM : false, 
    useGOM : false, 
    useJT : false, 
    useST : false, 
    useET : false,
    useSH : false,
    useKH : false,
    useGH : false,
    useMH : false,
    useAH : false,
    useWH: false,
    useDH: false,
    useEH: false,
    useQuality : 1,
    useLevel : 1,
    item: 0,
    overrideSpeedUp: false,
    hourglassLevelSpecific: false,
    hourglassLevel: 0,
    hourglassQualitySpecific: false,
    hourglassQuality: 0,
    useSpeedUp: 0,
    enhanceAction: false,
    enhanceItem: 0,
    enhanceMax  : tcoMaxChampQuality,
    repairAll : false,
    effectSelected: "none",
    buffSelected: "both",
    sortInactive: true,
    ignoreBroken: false,
    newUpgradeState: 0
};

var tcoThroneSalvageData = {
    active : false,
    throneSaveNum : 40,
    minQuality    : 3,
    ruleSet       : [{"type":"any","faction":"any","conditions":[{"mustHave":"true","number":"2","effect":"Range","buffType":"e","slots":[true,true,true,true,true]}]},{"type":"any","faction":"any","conditions":[{"mustHave":"true","number":"2","effect":"Troop Training Speed","buffType":"e","slots":[true,true,true,true,true]}]},{"type":"banner","faction":"any","conditions":[{"mustHave":"true","number":"2","effect":"Siege Range","buffType":"e","slots":[true,true,true,true,true]}]}],
    numSalvagedItems : 0,
    numSalvagedItems2 : 0,
    numSalvaged   : {0: 0, 1: 0, 2:0, 3:0, 4:0, 5:0, 6:0},
    upgradeFirst  : false,
    upgradeFirstQual : 2,
    upgradedToDelete : [],
    upgradeManual : false
};

var tcoChampSalvageData = {
    active : false,
    champSaveNum : 40,
    minQuality    : 3,
    ruleSet       : [],
    numSalvagedItems : 0,
    numSalvagedItems2 : 0,
    numSalvaged   : {0: 0, 1: 0, 2:0, 3:0, 4:0, 5:0, 6:0}
};

var tcoThroneRepairData = {
    active: false,
    useSH: false,
    useKH: false,
    useGH: false,
    useMH: false,
    useAH: false,
    useWH: false,
    useDH: false,
    useEH: false,
    overrideSpeedUp: false,
    hourglassLevelSpecific: false,
    hourglassLevel: 0,
    hourglassQualitySpecific: false,
    hourglassQuality: 0,
    useSpeedUp: 0,
    index: 0,
    items: []
};

var tcoChampRepairData = {
    active: false,
    useSH: false,
    useKH: false,
    useGH: false,
    useMH: false,
    useAH: false,
    useWH: false,
    useDH: false,
    useEH: false,
    overrideSpeedUp: false,
    hourglassLevelSpecific: false,
    hourglassLevel: 0,
    hourglassQualitySpecific: false,
    hourglassQuality: 0,
    useSpeedUp: 0,
    index: 0,
    items: []
};

var tcoThronePresetData = {
    items: [],
    presetNames: ["undefined", "undefined", "undefined", "undefined", "undefined", "undefined", "undefined", "undefined",
                  "undefined", "undefined", "undefined", "undefined", "undefined", "undefined", "undefined", "undefined",
                  "undefined", "undefined", "undefined", "undefined", "undefined", "undefined", "undefined", "undefined"],
    showThroneMight: true,
    showThroneName: true,
    presetColor: "#0000FF",
    tagColor: "#FFFFFF",
    activeColor: "#FFFF00",
    taggedItems: {},
    taggedItems01: {},
    taggedItems02: {},
    taggedItems03: {},
    taggedItems04: {},
    taggedItems05: {},
    taggedItems06: {},
    taggedItems07: {},
    taggedItems08: {},
    taggedItems09: {},
    taggedItems10: {},
    taggedItems11: {},
    taggedItems12: {},
    taggedItems13: {},
    taggedItems14: {},
    taggedItems15: {},
    taggedItems16: {},
    taggedItems17: {},
    taggedItems18: {},
    taggedItems19: {},
    taggedItems20: {},
    taggedItems21: {},
    taggedItems22: {},
    taggedItems23: {},
    taggedItems24: {},
    previewThrone: {}
};

var tcoChampPresetData = {
    items: [],
    presetNames: ["undefined", "undefined", "undefined", "undefined"],
    showChampMight: true,
    showChampName: true,
    presetColor: "#0000FF",
    tagColor: "#FFFFFF",
    activeColor: "#FFFF00",
    taggedItems: {},
    taggedItems01: {},
    taggedItems02: {},
    taggedItems03: {},
    taggedItems04: {},
    previewChamp: [ 0, 0, 0, 0, 0, 0, 0, 0, 0 ] //had to do array like this because of double ring
};

var tcoJewelImages = {
                1: "http://i.imgur.com/SecBRT5.png",
                2: "http://i.imgur.com/dnrId1I.png",
                3: "http://i.imgur.com/fjgZUh9.png",
                4: "http://i.imgur.com/h7tMQaB.png",
                5: "http://i.imgur.com/BZSuCiN.png"

};

var HOURGLASSES_TIME = {
    minute1 : 60,
    minute15 : 900,
    hour1 : 3600,
    hour25 : 9000,
    hour8 : 28800,
    hour15: 54000,
    hour24: 86400,
    day25: 216000
};

var HOURGLASSES_TIME_MIN_THRESHOLD = {
    minute1 : 30, //30 seconds and up will use 1m speedup
    minute15 : 301, //5 minute 1 second and up will use 15m speedup
    hour1 : 2701, // 45 minutes 1 second and up will use 1hr speedup
    hour25 : 7201, // 2 hour 1 second and up will use 2.5hr speedup
    hour8 : 26101, // 7 hours 30 minutes 1 second and up will use 8hr speedup
    hour15: 50431, // 14 hours 30 minutes 1 second and up will use 15hr speedup
    hour24: 82831, // 23 hours 30 minutes 1 second and up will use 24hr speedup
    day25: 172800 //48 hours and up will use 2.5 day speedup
};

var tcoHourGlassTDLabel = {
                    1: 'Time: 1 Min | Conditions: 30s+',
                    2: 'Time: 15 Min | Conditions: 5m & 1s+',
                    3: 'Time: 1 Hour | Conditions: 45m & 1s+',
                    4: 'Time: 2.5 Hours | Conditions: 2h & 1s+',
                    5: 'Time: 8 Hours | Conditions: 7h & 30m & 1s+',
                    6: 'Time: 15 Hours | Conditions: 14h & 30m & 1s+',
                    7: 'Time: 24 Hours | Conditions: 23h & 30m & 1s+',
                    8: 'Time: 2.5 Days | Conditions: 48h+'
};

var tcoHourGlassName = {
                    1: "Squire's Hourglass",
                    2: "Knight's Hourglass",
                    3: "Guinevere's Hourglass",
                    4: "Morgana's Hourglass",
                    5: "Arthur's Hourglass",
                    6: "Merlin's Hourglass",
                    7: "Divine Hourglass",
                    8: "Epic Hourglass"
};

// initialise 
LOADallData();

var tcoWinManager = {
	wins : {},    // prefix : CPopup obj

	get : function (prefix){
		var t = tcoWinManager;
		return t.wins[prefix];
	},
  
	add : function (prefix, pop){
		var t = tcoWinManager;
		t.wins[prefix] = pop;
		if (uW.cpopupWins == null)
			uW.cpopupWins = {};
		uW.cpopupWins[prefix] = pop;
	},
  
	delete : function (prefix){
		var t = tcoWinManager;
		delete t.wins[prefix];
		delete uW.cpopupWins[prefix];
	}    
}

// creates a 'popup' div
// prefix must be a unique (short) name for the popup window
function tcoPopup(prefix, x, y, enableDrag, onClose) {
	var pop = tcoWinManager.get(prefix);
	if (pop) {
		pop.show(false);
		return pop;
	}
	this.BASE_ZINDEX = 111111;
	// protos ...
	this.show = show;
	this.toggleHide = toggleHide;
	this.getTopDiv = getTopDiv;
	this.getMainDiv = getMainDiv;
	this.getLayer = getLayer;
	this.setLayer = setLayer;
	this.setEnableDrag = setEnableDrag;
	this.getLocation = getLocation;
	this.setLocation = setLocation;
	this.focusMe = focusMe;
	this.unfocusMe = unfocusMe;
	this.centerMe = centerMe;
	this.destroy = destroy;
	// object vars ...
	this.div = document.createElement('div');
	this.prefix = prefix;
	this.onClose = onClose;
	var t = this;
	this.div.className = 'tcoPopup ' + prefix + '_tcoPopup';
	this.div.id = prefix + '_outer';
	this.div.style.background = "#fff";
	this.div.style.zIndex = this.BASE_ZINDEX // KOC modal is 100210 ?
	this.div.style.display = 'none';
	this.div.style.width = dlgWidth + 'px';
	this.div.style.height = dlgHeight + 'px';
	this.div.style.position = "absolute";
	this.div.style.top = y + 'px';
	this.div.style.left = x + 'px';
	topClass = 'tcoPopupTop ' + prefix + '_tcoPopupTop';
	var m = '';
    m += '<TABLE cellspacing=0 width=100% height=100%>';
    m += '<TR id="' + prefix + '_bar" class="' + topClass + '">';
    m += '<TD width=99% align=center><b>TCO (Version ' + tcoVersion + ')</b>';
    m += '<input type=file id=tcoSettingsFile style="visibility:hidden; width: 0px; height: 0px;">';
    m += '</td>';
    m += '<TD id=' + prefix + '_X align=right valign=middle onmouseover="this.style.cursor=\'pointer\'" style="color:#fff; background:#333; font-weight:bold; font-size:14px; padding:0px 5px;">X';
    m += '</td>';
    m += '</tr>';
    m += '<tr><td valign=top colspan=2><table cellspacing=0 cellpadding=0>';
    m += '<TR><TD valign=top colspan=2 id="'+ prefix +'_top"></td>';
    m += '<TD valign=top class="tcoCPopMain ' + prefix + '_tcoCPopMain" colspan=2 id="' + prefix + '_main"></td></tr>';

    m += '</table></td></tr>';

    m += '</table>';
	document.body.appendChild(this.div);
	this.div.innerHTML = m;
	document.getElementById(prefix + '_X').addEventListener('click', e_XClose, false);
	this.dragger = new CWinDrag(document.getElementById(prefix + '_bar'), this.div, enableDrag);
	this.div.addEventListener('mousedown', e_divClicked, false);
	tcoWinManager.add(prefix, this);

	function e_divClicked() {
		t.focusMe();
	}

	function e_XClose() {
		t.show(false);
		if (t.onClose != null)
			t.onClose();
	}

	function focusMe() {
		t.setLayer(5);
		for (k in uW.cpopupWins) {
			if (k != t.prefix)
				uW.cpopupWins[k].unfocusMe();
		}
	}

	function unfocusMe() {
		t.setLayer(-5);
	}

	function getLocation() {
		return {
			x: parseInt(this.div.style.left),
			y: parseInt(this.div.style.top)
		};
	}

	function setLocation(loc) {
		t.div.style.left = loc.x + 'px';
		t.div.style.top = loc.y + 'px';
	}

	function destroy() {
		document.body.removeChild(t.div);
		tcoWinManager.delete(t.prefix);
	}

	function centerMe(parent) {
		if (parent == null) {
			var coords = getClientCoords(document.body);
		} else
			var coords = getClientCoords(parent);
		var x = ((coords.width - parseInt(t.div.style.width)) / 2) + coords.x;
		var y = ((coords.height - parseInt(t.div.style.height)) / 2) + coords.y;
		if (x < 0)
			x = 0;
		if (y < 0)
			y = 0;
		t.div.style.left = x + 'px';
		t.div.style.top = y + 'px';
	}

	function setEnableDrag(tf) {
		t.dragger.setEnable(tf);
	}

	function setLayer(zi) {
		t.div.style.zIndex = '' + (this.BASE_ZINDEX + zi);
	}

	function getLayer() {
		return parseInt(t.div.style.zIndex) - this.BASE_ZINDEX;
	}

	function getTopDiv() {
		return document.getElementById(this.prefix + '_top');
	}

	function getMainDiv() {
		return document.getElementById(this.prefix + '_main');
	}

	function show(tf) {
		if (tf) {
			t.div.style.display = 'block';
			t.focusMe();
		} else {
			t.div.style.display = 'none';
		}
		return tf;
	}

	function toggleHide(t) {
		if (t.div.style.display == 'block') {
			return t.show(false);
		} else {
			return t.show(true);
		}
	}
}

function CWinDrag (clickableElement, movingDiv, enabled) {
	var t=this;
	this.setEnable = setEnable;
	this.setBoundRect = setBoundRect;
	this.lastX = null;
	this.lastY = null;
	this.enabled = true;
	this.moving = false;
	this.theDiv = movingDiv;
	this.body = document.body;
	this.ce = clickableElement;
	this.moveHandler = new CeventMove(this).handler;
	this.outHandler = new CeventOut(this).handler;
	this.upHandler = new CeventUp(this).handler;
	this.downHandler = new CeventDown(this).handler;
	this.clickableRect = null;
	this.boundRect = null;
	this.bounds = null;
	this.enabled = false;
	if (enabled == null)
		enabled = true;
	this.setEnable (enabled);

	function setBoundRect (b){    // this rect (client coords) will not go outside of current body
		this.boundRect = boundRect;
		this.bounds = null;
	}

	function setEnable (enable){
		if (enable == t.enabled)
			return;
		if (enable){
			clickableElement.addEventListener('mousedown',  t.downHandler, false);
			t.body.addEventListener('mouseup', t.upHandler, false);
		} else {
			clickableElement.removeEventListener('mousedown', t.downHandler, false);
			t.body.removeEventListener('mouseup', t.upHandler, false);
		}
		t.enabled = enable;
	}

	function CeventDown (that){
		this.handler = handler;
		var t = that;
		
		function handler (me){
			if (t.bounds == null){
				t.clickableRect = getClientCoords(clickableElement);
				t.bodyRect = getClientCoords(document.body);
				if (t.boundRect == null)
					t.boundRect = t.clickableRect;
				t.bounds = {top:10-t.clickableRect.height, bot:t.bodyRect.height-25, left:40-t.clickableRect.width, right:t.bodyRect.width-25};
			}
			if (me.button==0 && t.enabled){
				t.body.addEventListener('mousemove', t.moveHandler, true);
				t.body.addEventListener('mouseout', t.outHandler, true);
				t.lastX = me.clientX;
				t.lastY = me.clientY;
				t.moving = true;
			}
		}
	}

	function CeventUp  (that){
		this.handler = handler;
		var t = that;
		function handler (me){
			if (me.button==0 && t.moving) {
				_doneMoving(t);
            }
		}
	}

	function _doneMoving (t){
		t.body.removeEventListener('mousemove', t.moveHandler, true);
		t.body.removeEventListener('mouseout', t.outHandler, true);
		t.moving = false;
	}

	function CeventOut  (that){
		this.handler = handler;
		var t = that;
		
		function handler (me){
			if (me.button==0){
				t.moveHandler (me);
			}
		}
	}

	function CeventMove (that){
		this.handler = handler;
		var t = that;
		
		function handler (me){
			if (t.enabled && !t.wentOut){
				var newTop = parseInt(t.theDiv.style.top) + me.clientY - t.lastY;
				var newLeft = parseInt(t.theDiv.style.left) + me.clientX - t.lastX;
				if (newTop < t.bounds.top){     // if out-of-bounds...
					newTop = t.bounds.top;
					_doneMoving(t);
				} else if (newLeft < t.bounds.left){
					newLeft = t.bounds.left;
					_doneMoving(t);
				} else if (newLeft > t.bounds.right){
					newLeft = t.bounds.right;
					_doneMoving(t);
				} else if (newTop > t.bounds.bot){
					newTop = t.bounds.bot;
					_doneMoving(t);
				}
				t.theDiv.style.top = newTop + 'px';
				t.theDiv.style.left = newLeft + 'px';
				t.lastX = me.clientX;
				t.lastY = me.clientY;
			}
		}
	}
}

function getClientCoords(e) {
	if (e == null)
		return {
			x: null,
			y: null,
			width: null,
			height: null
		};
	var x = 0,
		y = 0;
	ret = {
		x: 0,
		y: 0,
		width: e.clientWidth,
		height: e.clientHeight
	};
	while (e.offsetParent != null) {
		ret.x += e.offsetLeft;
		ret.y += e.offsetTop;
		e = e.offsetParent;
	}
	return ret;
}

var tabManager = {
	tabList : {},           // {name, obj, div}
	currentTab : null,
  
	init : function (mainDiv){
		var t = tabManager;
		var sorter = [];
		for (k in Tabs){
			if (!Tabs[k].tabDisabled){  
				t.tabList[k] = {};
				t.tabList[k].name = k;
				t.tabList[k].tabColor = Tabs[k].tabColor?Tabs[k].tabColor:'blue';
				t.tabList[k].obj = Tabs[k];
				if (Tabs[k].tabLabel != null)
					t.tabList[k].label = Tabs[k].tabLabel;
				else
					t.tabList[k].label = k;
				if (Tabs[k].tabOrder != null)
					sorter.push([Tabs[k].tabOrder, t.tabList[k]]);
				else
					sorter.push([1000, t.tabList[k]]);
				t.tabList[k].div = document.createElement('div');
			}
		}

		sorter.sort (function (a,b){return a[0]-b[0]});
		var m = '';
		
		m += '<ul class=tcoULMenu>';
		for (var i=0; i<sorter.length; i++) {
			var color = sorter[i][1].tabColor;
            m += '<li><input type=button id=nttc'+ sorter[i][1].name +' class="tcoMenuButton h20 '+color+'" style="width:'+dlgWidthMenu+'px;" value="' + sorter[i][1].label + '"></LI>';
		}
		m+='</UL>';  

		mainPop.getTopDiv().innerHTML = m;
    
		var contentDiv = document.createElement('div');
		contentDiv.id = 'tcoMain_content';
		mainDiv.appendChild(contentDiv);
		
		for (k in t.tabList) {
            if (t.tabList[k].name == tcoGeneralOptions.currentTab) t.currentTab =t.tabList[k];
			document.getElementById('nttc'+ k).addEventListener('click', this.e_clickedTab, false);
			var div = t.tabList[k].div;
			div.style.display = 'none';
			div.style.height = '100%';
			contentDiv.appendChild(div);
			try {
				t.tabList[k].obj.init(div);
			} catch (e){
				div.innerHTML = "INIT ERROR: "+ e;
			}
		}
    
		if (t.currentTab == null) t.currentTab = sorter[0][1];    
		t.currentTab.div.style.display = 'block';
        t.setTabStyle(t.currentTab, true);
	},
  
	hideTab : function (){
		var t = tabManager;
		t.currentTab.obj.hide();
        tcoGeneralOptions.hidden = true;
        //tcoGeneralOptions.currentTab = null;
        SAVEtcoGeneralOptions();
	},
  
	showTab : function (){
		var t = tabManager;
		t.currentTab.obj.show();
        tcoGeneralOptions.hidden = false;
        //tcoGeneralOptions.currentTab = t.currentTab.name;
        SAVEtcoGeneralOptions();
	},
    
	setTabStyle : function (Tab, selected){
		var e = document.getElementById ('nttc'+ Tab.name)
		var c = Tab.tabColor?Tab.tabColor:"blue";
		if (selected){
			e.className = 'tcoMenuButton h20 green';
		} else {
			e.className = 'tcoMenuButton h20 '+c;
		}
	},
  
	e_clickedTab : function (e){
		var t = tabManager;
		mainPop.show (true);
		if (e.target.id)
			var newTab = t.tabList[e.target.id.substring(4)];
		else
			var newTab = t.tabList[e.target.parentNode.id.substring(4)];
		if (t.currentTab.name != newTab.name){
			t.setTabStyle (t.currentTab, false);
			t.setTabStyle (newTab, true);
			t.currentTab.obj.hide ();
			t.currentTab.div.style.display = 'none';
			t.currentTab = newTab;
            tcoGeneralOptions.currentTab = newTab.name;
			newTab.div.style.display = 'block';
		}
		newTab.obj.show();
	},

}

//TODO
function mouseEventTab (me){   // right-click on main button resets window
    if (me.button == 2){
        var c = getClientCoords(document.getElementById('main_engagement_tabs'));
        mainPop.setLocation ({x: c.x+4, y: c.y+c.height});
    }
}

function eventHideShow() {
	if (mainPop.toggleHide(mainPop)) {
		tabManager.showTab();
	} else {
		tabManager.hideTab();
	}
}

function createButton(label) {
	var a = document.createElement('a');
	a.className = 'button20';
	a.innerHTML = '<span style="color: #ff6">' + label + '</span>';
	return a;
}

function AddMainTabLink(text, eventListener, mouseListener) {
	var a = createButton(text);
	a.className = 'tab';
	var tabs = document.getElementById('main_engagement_tabs');
	if (!tabs) {
		tabs = document.getElementById('topnav_msg');
		if (tabs)
			tabs = tabs.parentNode;
	}
	if (tabs) {
		var e = tabs.parentNode;
		var gmTabs = null;
		for (var i = 0; i < e.childNodes.length; i++) {
			var ee = e.childNodes[i];
			if (ee.tagName && ee.tagName == 'DIV' && ee.className == 'tabs_engagement' && ee.id != 'main_engagement_tabs') {
				gmTabs = ee;
				break;
			}
		}
		if (gmTabs == null) {
			gmTabs = document.createElement('div');
			gmTabs.className = 'tabs_engagement';
			tabs.parentNode.insertBefore(gmTabs, tabs);
			gmTabs.style.whiteSpace = 'normal';
			gmTabs.style.width = dlgWidth+'px';
		}
		gmTabs.style.height = '0%';
		gmTabs.style.overflow = 'auto';
		if (gmTabs.firstChild)
			gmTabs.insertBefore(a, gmTabs.firstChild);
		else
			gmTabs.appendChild(a);
		a.addEventListener('click', eventListener, false);
		if (mouseListener != null)
			a.addEventListener('mousedown', mouseListener, true);
		return a;
	}
	return null;
}

function ScriptStartup () {
    if (uW.tcoLoaded) return;
	var metc = getClientCoords(document.getElementById('main_engagement_tabs'));
	if (metc.width==null || metc.width==0) {
		setTimeout (ScriptStartup, 1000);
		return;
	}

    tcoMaxThroneQuality = CM.ThronePanelController.MAX_QUALITY;
    tcoMaxThroneLevel = CM.MAX_MASTERS_TOKEN_LEVEL;
    tcoMaxChampLevel = CM.CHAMPION.MAX_LEVELS;
    tcoMaxChampQuality = CM.CHAMPION.MAX_EFFECTS;
    tcoMaxChampions = Seed.champion.champions.size();
    tcoMaxInventoryRows = Seed.throne.rowNum;
    tcoMaxThroneCards = tcoMaxInventoryRows * 5;
	
	// initialise 
//    LOADallData(); //done earlier in the script

    var styles = '';
    styles += '#itemInventory {min-height: 420px; background-color:#884422;}'; //this expands the height of the champion hall inventory space
    styles += '#itemFilter {min-height: 150px;  background-color:#884422;}';

    styles += 'tr.tcoPopupTop td {background-color:#003399; border:1px solid #000000; height: 21px;  padding:0px; color:#FFFFFF;}';
    styles += 'td {border: 0px;}';
    styles += '.tcoCPopMain {width:'+dlgWidth+'px; height:'+(dlgHeight-dlgHeightOffset)+'px; background-color:#F7F3E6; border:1px solid #000000; -moz-box-shadow:inset 0px 0px 10px #6a6a6a; font-size:12px; color:#000000;}';
    styles += '.tcoPopup {border:5px ridge #666; opacity:1; -moz-box-shadow: 1px 1px 5px #000000;}';
    styles += '.tcoHeader {width:100%; border:0px solid; border-color:#000000; background: -moz-linear-gradient(top, #E9D9AE, #8C7D5D); height: 22px; border-bottom:0px solid #000000;font-weight:bold;font-size:12px;opacity:0.75;margin-left:0px;margin-right:0px;margin-top:1px;margin-bottom:0px;padding-top:6px;padding-right:0px; vertical-align:middle;align:center; color:#000000; text-align:center;}';
    styles += '.tcoThroneOrganizer {position: static; overflow-x: auto; overflow-y: auto; width:100%; border:0px solid; border-color:#000000; background: -moz-linear-gradient(top, #E9D9AE, #8C7D5D); height: 16px;border-bottom:0px solid #000000;font-weight:bold;font-size:12px;opacity:0.75;margin-left:0px;margin-right:0px;margin-top:1px;margin-bottom:0px;padding-top:0px;padding-right:0px; vertical-align:middle;align:center; color:#000000; text-align:center;}';
    styles += '.tcoChampOrganizer {position: static; overflow-x: auto; overflow-y: auto; width:100%; border:0px solid; border-color:#000000; background: -moz-linear-gradient(top, #E9D9AE, #8C7D5D); height: 16px;border-bottom:0px solid #000000;font-weight:bold;font-size:12px;opacity:0.75;margin-left:0px;margin-right:0px;margin-top:1px;margin-bottom:0px;padding-top:0px;padding-right:0px; vertical-align:middle;align:center; color:#000000; text-align:center;}';
    styles += '.tcoThroneOrganizerSection {display:none; position:static; overflow-x:auto; overflow-y:hidden; }';
    styles += '.tcoChampOrganizerSection {display:none; position:static; overflow-x:auto; overflow-y:hidden; }';
    styles += '.divNoWrap {white-space: nowrap; display:inline-block;}';
    styles += '.indent5 {padding-left:5px}';
    styles += '.tcoButton {background-color:#00003D; color:#ffffff;font-weight:bold;font-size:11px;-webkit-box-shadow: 0px 1px 3px rgba(0,0,0,0.5); -moz-box-shadow: 0px 1px 3px rgba(0,0,0,0.5); box-shadow: 0px 1px 3px rgba(0,0,0,0.5);}';
    styles += '.tcoSelect {background-color:#ffffff; color:#000000;font-weight:normal;font-size:11px;-webkit-box-shadow: 0px 1px 3px rgba(0,0,0,0.5); -moz-box-shadow: 0px 1px 3px rgba(0,0,0,0.5); box-shadow: 0px 1px 3px rgba(0,0,0,0.5);}';
    styles += '.tcoTextbox {background-color:#ffffff; color:#000000;font-weight:normal;font-size:11px;-webkit-box-shadow: 0px 1px 3px rgba(0,0,0,0.5); -moz-box-shadow: 0px 1px 3px rgba(0,0,0,0.5); box-shadow: 0px 1px 3px rgba(0,0,0,0.5);}';
    styles += '.tcoCheckbox {-webkit-box-shadow: 0px 1px 3px rgba(0,0,0,0.5); -moz-box-shadow: 0px 1px 3px rgba(0,0,0,0.5); box-shadow: 0px 1px 3px rgba(0,0,0,0.5);}';
    styles += '.tcoLinks {font-family: tahoma,verdana,arial,sans-serif; font-size: 12px; font-variant: normal; font-style: normal; font-weight: normal; color: #000000; text-decoration: none;}';
    styles += 'td.tcoTDLinks {background-color:#FFFFCC;}';
    styles += 'hr.tcoHRCenter {width: 80%; align:center;}';
    styles += '.tcoLinksHeader {font-family: tahoma,verdana,arial,sans-serif; font-size: 12px; font-variant: normal; font-style: normal; font-weight: bold; color: #000000; text-decoration: none;}';
    styles += '.tcoLinksDesc {font-family: tahoma,verdana,arial,sans-serif; font-size: 12px; font-variant: normal; font-style: italic; font-weight: bold; color: #0000FF; text-decoration: none;}';
    styles += '.tcoULMenu {list-style-type: none;padding: 0;margin: 0;display: inline;}';
    styles += '.tcoSectionTable {padding:0px; border-spacing: 0px;width:100%;border:0px;}';
    styles += '.tcoReverseImage {-moz-transform: scaleX(-1); -o-transform: scaleX(-1); -webkit-transform: scaleX(-1); transform: scaleX(-1); filter: FlipH; -ms-filter: "FlipH";}';
    styles += '.tcoSection {display:none;}';
    styles += 'table.tcoStats tr td { background-color: #ffffff; white-space:nowrap; padding:5px; border-bottom:solid black 1px;}';
    styles += 'table.tcoStats tr td:last-child { border-right:solid black 1px; }';
    styles += 'table.tcoStats tr:first-child th { border-top:solid black 1px; }';
    styles += 'table.tcoStats tr td.td0 { background-color: white; }';
    styles += 'table.tcoStats tr td.td1 { background-color: #eeeeee; }';
    styles += 'table.tcoStats tr td.td2 { background-color: white; }';
    styles += 'table.tcoStats tr th {border:solid black 1px; border-top: none; background-color: #357; color: white; white-space:nowrap; padding:5px}';
    styles += 'table.tcoStats tr:last-child td:first-child, table.tcoStats tr:last-child th:first-child { -moz-border-radius-bottomleft:10px; -webkit-border-bottom-left-radius:10px; border-bottom-left-radius:10px} ';
    styles += 'table.tcoStats tr:last-child td:last-child, table.tcoStats tr:last-child th:last-child { -moz-border-radius-bottomright:10px; -webkit-border-bottom-right-radius:10px; border-bottom-right-radius:10px} ';
    styles += 'table.tcoStats tr:first-child th:first-child { -moz-border-radius-topleft:10px; -webkit-border-top-left-radius:10px; border-top-left-radius:10px} ';
    styles += 'table.tcoStats tr:first-child th:last-child { -moz-border-radius-topright:10px; -webkit-border-top-right-radius:10px; border-top-right-radius:10px} ';
    styles += '.tcoMenuButton { cursor: pointer; border-width: 2px; border-style: solid; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; border-color: #FDF4D2 #A69964 #A69964 #FDF4D2; color: #FFF; font: bold 10px Georgia; text-align: center; text-decoration: none; background-color: #9A804B !important; }';
    styles += '.tcoMenuButton.h20 { width: 123px; height: 20px; line-height: 20px; padding: 2px 7px; }';
    styles += '.tcoMenuButton.red { color: #FFF !important; background: -moz-linear-gradient(center top , #FF6E72, #320201 100%) repeat scroll 0% 0% transparent; }';
    styles += '.tcoMenuButton.green { background: -moz-linear-gradient(center top , #4AB900, #3F8803 100%) repeat scroll 0% 0% transparent; }';
    styles += '.tcoMenuButton.brown { background: -moz-linear-gradient(center top , #C58200, #976300 100%) repeat scroll 0% 0% transparent; }';
    styles += '.tcoMenuButton.blue { background: -moz-linear-gradient(center top , #014DAA, #00397E 100%) repeat scroll 0% 0% transparent; }';
    styles += '#tcoHammer { background-image: url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/modal/sm_hammer.png"); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 28px; height: 32px; margin: 2px; vertical-align: middle;}';
    styles += 'div.tcoHammer { background-image: url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/modal/sm_hammer.png"); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 28px; height: 32px; margin: 2px; vertical-align: middle;}';
    styles += 'div.tcoBroken { background-image: url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/modal/sm_fail_overlay.png"); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 28px; height: 32px; margin: 2px; vertical-align: middle;}';
    styles += 'div.tcoSuccess { background-image: url('+ success_image +'); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 28px; height: 32px; margin: 2px; vertical-align: middle;}';
    styles += 'div.tcoUpRow { display=inline;  background-image: url('+ up_img +'); background-repeat: no-repeat; background-color: transparent;  width: 28px; height: 24px; }';
    styles += 'div.tcoUpRow:hover { display=inline;  background-image: url('+ up_glow +'); background-repeat: no-repeat; background-color: transparent;  width: 28px; height: 24px; }';
    styles += 'div.tcoRemove { display=inline;  background-image: url('+ remove_img +'); background-repeat: no-repeat; background-color: transparent;  width: 50px; height: 50px; }';
    styles += 'div.tcoRemove:hover { display=inline;  background-image: url('+ remove_glow +'); background-repeat: no-repeat; background-color: transparent;  width: 50px; height: 50px; }';
    styles += 'div.tcoDownRow { display=inline;  background-image: url('+ down_img +'); background-repeat: no-repeat; background-color: transparent;  width: 28px; height: 24px; }';
    styles += 'div.tcoDownRow:hover { display=inline;  background-image: url('+ down_glow +'); background-repeat: no-repeat; background-color: transparent;  width: 28px; height: 24px; }';
    styles += 'div.tcoGoButton { display=inline;  background-image: url('+ gbtn_img +'); background-repeat: no-repeat; background-color: transparent;  width: 32px; height: 32px; margin: 0px; }';
    styles += 'div.tcoSaveSettings { display=inline; background-image: url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/bonus_prestige.png"); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 20px; height: 20px; margin-left: 20px; vertical-align: middle; float:left}';
    styles += 'div.tcoLoadSettings { display=inline; background-image: url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/bonus_att.png"); background-repeat: no-repeat; background-color: transparent; display: inline-block; width: 20px; height: 20px; margin-left: 2px; vertical-align: middle; float:left}';
    
    styles += 'div.tcoBlueBorder { border: 2px solid blue; }';
    styles += 'div.tcoYellowBorder { outline: 2px solid yellow; outline-offset:0px; }';

    styles += '.swapBorderThrone { margin-right: -100%; margin-bottom: -100%; height: 99%; width: 99%; padding: 4%; background-image: url('+ success_image +'); background-repeat: no-repeat; background-size: 28px; display: inline-block;}';
    styles += '.tagBorderThrone { margin-right: -100%; margin-bottom: -100%; height: 72%; width: 72%; padding: 4%; border: 3px solid ' + tcoThronePresetData.tagColor + '; background: transparent;}';
    styles += '.presetBorderThrone { margin-right: -100%; margin-bottom: -100%; height: 72%; width: 72%; padding: 4%; border: 3px solid ' + tcoThronePresetData.presetColor + '; background: transparent;}';
    styles += '.activeBorderThrone { margin-right: -100%; margin-bottom: -100%; height: 72%; width: 72%; padding: 4%; border: 3px solid ' + tcoThronePresetData.activeColor + '; background: transparent;}';
    styles += '.tagBorderChamp { margin-right: -100%; margin-bottom: -100%; height: 72%; width: 72%; padding: 4%; border: 3px solid ' + tcoChampPresetData.tagColor + '; background: transparent;}';
    styles += '.presetBorderChamp { margin-right: -100%; margin-bottom: -100%; height: 72%; width: 72%; padding: 4%; border: 3px solid ' + tcoChampPresetData.presetColor + '; background: transparent;}';
    styles += '.activeBorderChamp { margin-right: -100%; margin-bottom: -100%; height: 72%; width: 72%; padding: 4%; border: 3px solid ' + tcoChampPresetData.activeColor + '; background: transparent;}';


    styles += 'div.champ_item_section ul.effects { margin: 3px 0 0 0; padding: 0; list-style: none; }';
    styles += 'div.champ_item_section ul.effects li.effect { padding:0;font-weight:bold;font-size:10px; }';
    styles += 'div.champ_item_section ul.effects li.effect.statChamp { color: #3F2300; }';
    styles += 'div.champ_item_section ul.effects li.effect.statTroop { color: #1751A5; }';
    styles += 'div.champ_item_section ul.effects li.effect.statChamp.disabled { color: #B9A48B; }';
    styles += 'div.champ_item_section ul.effects li.effect.statTroop.disabled { color: #A5B1E5; }';

    styles += 'div.tcoCard {width: 180px; height: 200px; font:bold 8px Georiga; overflow: hidden;}';
    var icon_size = '50px 50px';
    styles += 'div.tcoCard div.description>div{width:50px;height:50px; }';
    styles += 'div.tcoCard div.description div.briton.advisor{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_advisor_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.banner{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_banner_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.chair{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_chair_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.table{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_table_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.window{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_window_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.trophy{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_trophy_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.hero{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_hero_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.statue{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_statue_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.candelabrum{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_candelabrum_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.pet{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_pet_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.tapestry{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_tapestry_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.pillar{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/briton_pillar_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.weapon{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_weapon_briton_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.chest{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_chestArmor_briton_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.helm{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_helmet_briton_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.boots{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_feet_briton_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.shield{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_shield_briton_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.ring{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_ring1_briton_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.pendant{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_pendant_briton_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.briton.cloak{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_cloak_briton_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.advisor{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_advisor_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.banner{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_banner_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.chair{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_chair_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.table{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_table_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.window{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_window_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.trophy{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_trophy_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.hero{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_hero_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.statue{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_statue_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.candelabrum{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_candelabrum_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.pet{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_pet_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.tapestry{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_tapestry_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.pillar{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/druid_pillar_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';  
    styles += 'div.tcoCard div.description div.druid.weapon{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_weapon_druid_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.chest{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_chestArmor_druid_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.helm{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_helmet_druid_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.boots{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_feet_druid_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.shield{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_shield_druid_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.ring{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_ring1_druid_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.pendant{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_pendant_druid_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.druid.cloak{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_cloak_druid_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.advisor{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_advisor_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.banner{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_banner_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.chair{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_chair_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.table{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_table_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.window{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_window_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.trophy{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_trophy_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.hero{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_hero_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.statue{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_statue_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.candelabrum{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_candelabrum_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.pet{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_pet_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.tapestry{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_tapestry_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.pillar{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/70/fey_pillar_normal_1_6.png") top left no-repeat; background-size: ' + icon_size + ';}';  
    styles += 'div.tcoCard div.description div.fey.weapon{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_weapon_fey_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.chest{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_chestArmor_fey_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.helm{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_helmet_fey_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.boots{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_feet_fey_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.shield{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_shield_fey_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.ring{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_ring1_fey_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.pendant{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_pendant_fey_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard div.description div.fey.cloak{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/champion_hall/wondrous_cloak_fey_30x30.png") top left no-repeat; background-size: ' + icon_size + ';}';
    styles += 'div.tcoCard .disabled{opacity:.5;}';
    styles += 'div.tcoCard ul{margin:0px;padding:0;list-style:none;}';
    styles += 'div.tcoCard li{padding:0px 0 0 0px;color:#3f2300;font-weight:bold;font-size:10px;}'; //tooltip
    styles += 'div.tcoCard>div{float:left;border:1px solid #a56631;margin:0px;padding:0px;width:200px; height:300px; background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/modal/modal_med_bg_4.png") -200px 0 no-repeat;}'; //tooltip
    styles += 'div.tcoTitle{font:bold 11px Georgia;border-bottom:1px solid #703200;padding:4px 3px 5px 8px;background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/panel/modal/item_bg.png") -20px -100px no-repeat;}'; //tooltip
    styles += 'div.tcoTitle span.icon{background:transparent url("https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/modal/equip.png") top right no-repeat;display:block;height:20px;width:20px;top:12px;right:12px;position:absolute;}';
    styles += 'div.description {overflow:hidden;border-bottom:1px solid #703200;}';
    styles += 'div.portrait {float:left; border:3px solid #deaf69;margin-right:8px;}';
    styles += 'div.description>ul{float:left;margin:3px 0 0 0;padding:0;}';
    styles += 'div.description>ul li{padding:0;font-weight:bold;font-size:10px;text-transform:capitalize;}'; //tooltip

    styles += '.tcoCastleButton {outline:0px; margin-left:0px; margin-right:0px; width:24px; height:26px; font-size:12px; font-weight:bold; }';
    styles += '.tcoCastleButton:hover {background-image:url("'+ URL_CASTLE_BUTTON_SELECT +'")}';
    styles += '.tcoCastleButtonNot {background-image:url("'+ URL_CASTLE_BUTTON +'")}';
    styles += '.tcoCastleButtonSelect {background-image:url("'+ URL_CASTLE_BUTTON_SELECT +'")}';

    styles += 'div.tcoContextMenu {background-color: #999966; z-index: 10000000; position: absolute; height: 400px; padding: 4px 4px 4px 4px; font: bold 11px Georgia; border-width: 2px; border-style: solid; text-align: center; margin: auto;}';// overflow-y: auto; overflow-x: hidden;}';

    styles += 'div.tcoContextMenuItem       {height: 20px; width: 140px; margin-bottom: 2px; cursor: pointer; text-decoration: none; font: bold 12px Georgia; text-align: center; border-style: solid; border-width: 2px; background-color: #9A804B !important; vertical-align: middle; color: #ffffff; border-color: transparent; padding-top: 4px;}';
    styles += 'div.tcoContextMenuSubItem    {height: 20px; width: 140px; margin-bottom: 2px; cursor: pointer; text-decoration: none; font: bold 12px Georgia; text-align: center; border-style: solid; border-width: 2px; background-color: #9A804B !important; vertical-align: middle; color: #ffffff; border-color: transparent; padding-top: 4px;}';

    styles += 'div.tcoRed         {background: -moz-linear-gradient(center top , #FF6E72, #320201 100%) repeat scroll 0% 0% transparent;}';
    styles += 'div.tcoRed:hover   {background: -moz-linear-gradient(center top , #320201, #FF6E72 100%) repeat scroll 0% 0% transparent;}';
    styles += 'div.tcoGreen          {background: -moz-linear-gradient(center top , #4AB900, #3F8803 100%) repeat scroll 0% 0% transparent; }';
    styles += 'div.tcoGreen:hover    {background: -moz-linear-gradient(center top , #3F8803, #4AB900 100%) repeat scroll 0% 0% transparent; }';
    styles += 'div.tcoBlue         {background: -moz-linear-gradient(center top , #014DAA, #00397E 100%) repeat scroll 0% 0% transparent; }';
    styles += 'div.tcoBlue:hover   {background: -moz-linear-gradient(center top , #00397E, #014DAA 100%) repeat scroll 0% 0% transparent; }';
    styles += 'div.tcoBrown         {background: -moz-linear-gradient(center top , #976300, #C58200 100%) repeat scroll 0% 0% transparent; }';
    styles += 'div.tcoBrown:hover   {background: -moz-linear-gradient(center top , #C58200, #976300 100%) repeat scroll 0% 0% transparent; }';

    styles += 'div.tcoDisabled         {background: -moz-linear-gradient(center top , #5D5D5D, #171717 100%) repeat scroll 0% 0% transparent; }';
    styles += 'div.tcoDisabled:hover   {background: -moz-linear-gradient(center top , #5D5D5D, #171717 100%) repeat scroll 0% 0% transparent; }';

    styles += 'div.tcoContextHidden  {display: none; }';
    styles += 'div.tcoContextVisible {display: block; }';

    if (tcoGeneralOptions.usedCityNum && tcoGeneralOptions.usedCityNum > Seed.cities.length -1 ) tcoGeneralOptions.usedCityNum = 0; 
    if (tcoGeneralOptions.salvageCityNum && tcoGeneralOptions.salvageCityNum > Seed.cities.length -1 ) tcoGeneralOptions.salvageCityNum = 0;

    installThroneHandlerFunctions();  //installHandlerFunctions

    setCities();

    //window.addEventListener('unload', onUnload, false);
    window.addEventListener('beforeunload', onUnload, false);

    CM.cheatDetector.detect = foo;

	AddMainTabLink('TCO', eventHideShow, mouseEventTab);

    ThroneAttachTab();

    alterChampHall();
    
	if (!tcoGeneralOptions.xPos) tcoGeneralOptions.xPos=0;
    if (!tcoGeneralOptions.yPos) tcoGeneralOptions.yPos=30;

    //mainPop = new tcoPopup('tcoMain', 0, 30, true, function (){ tabManager.hideTab(); });
	mainPop = new tcoPopup ('tcoMain', tcoGeneralOptions.xPos, tcoGeneralOptions.yPos, true, function (){ tabManager.hideTab(); });
	mainPop.getMainDiv().innerHTML = '<STYLE>'+ styles +'</style>';

	tabManager.init (mainPop.getMainDiv());

    if (!tcoGeneralOptions.hidden) eventHideShow();

    setUpgradeColor();

    tcoThroneDisplayTimer = setInterval(ThroneUpdateTimerDisplay, 1000);

    ReplaceToolTips();

    if (tcoGlobalOptions.update) setTimeout(function(){AutoUpdater.check();},15000); 

    uW.tcoLoaded = true;

    

}

var foo = function() { };

/*********************************** TABS ***********************************/

Tabs.throneUpgrader = {
	tabOrder: 100,
	tabLabel: 'UPGRADER',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM UPGRADER',
    myDiv: null,
    repairId: 0,
    repairEnd: 0,
    timerH: null,
    clearTimerH: null,
    speedup: 0,
    upgradePath: {
        0: { maxLev: 2, nextQual: 2 },
        1: { maxLev: 2, nextQual: 2 },
        2: { maxLev: 3, nextQual: 4 },
        3: { maxLev: 3, nextQual: 4 },
        4: { maxLev: 4, nextQual: 5 },
        5: { maxLev: 5, nextQual: 6 }
    },
    	
	init: function (div) {
		var t = Tabs.throneUpgrader;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '<div class=tcoSaveSettings id=tcoThroneUpgraderSaveSettings title="Save Upgrader Settings"></div><div class=tcoLoadSettings id=tcoThroneUpgraderLoadSettings title="Load Upgrader Settings"></div></div>';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
		m += '<div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        if (tcoThroneUpgradeData.active) {
            m += '<td width=33%><input id=tcoThroneUpgradePower type=button class=tcoButton value="Upgrader = ON"></td>';
        } else {
            m += '<td width=33%><input id=tcoThroneUpgradePower type=button class=tcoButton value="Upgrader = OFF"></td>';
        }        
        m += '<td width=33%><div class=divNoWrap><input class=tcoCheckbox id=tcoThroneOneItem type=checkbox ' + (tcoThroneQueueData.oneItem ? ' CHECKED' : '') + '/>Upgrade 1 At A Time</div></td>';
        m += '<td width=33%><div class=divNoWrap align=center id=tcoThroneAetherDisplay></div></td>';
        m += '</tr>';
        m += '<tr><td colspan=3><hr class=tcoHRCenter></td></tr>';
        m += '<tr><td colspan=3><div class=indent5 id=tcoThroneUpgradeStatus><br></div></td></tr>';
        m += '<tr><td colspan=3><div class=indent5 id=tcoThroneLastResult><br></div></td></tr>';
        m += '</table>';
        m += '</div>';
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;SPEED UPS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoThroneHourglassLevelSpecific ' + (tcoThroneUpgradeData.hourglassLevelSpecific ? "CHECKED" : "") + '>Only use hourglass for levels ';
        m += '<select class=tcoSelect  id=tcoThroneHourglassLevel>';
        for (i = 1; i < tcoMaxThroneLevel; i++) m += '<option value=' + i + ' ' + (tcoThroneUpgradeData.hourglassLevel == i ? 'SELECTED' : '') + '>' + i + '</option>';
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoThroneHourglassQualitySpecific ' + (tcoThroneUpgradeData.hourglassQualitySpecific ? "CHECKED" : "") + '>Only use hourglass for qualities ';
        m += '<select class=tcoSelect id=tcoThroneHourglassQuality>';
        for (i = 1; i <= tcoMaxThroneQuality-1; i++) m += '<option value=' + i + ' ' + (tcoThroneUpgradeData.hourglassQuality == i ? 'SELECTED' : '') + '>' + throneCardQualities[i].capitalizeFirstLetter() + '</option>';
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[1] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneUseSH ' + (tcoThroneUpgradeData.useSH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[1] + ' (<div class=divNoWrap id=tcoThroneUseSHLabel><font' + (uW.ksoItems[1].count < 100 ? ' color=red>' : '>') + uW.ksoItems[1].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[2] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneUseKH ' + (tcoThroneUpgradeData.useKH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[2] + ' (<div class=divNoWrap id=tcoThroneUseKHLabel><font' + (uW.ksoItems[2].count < 100 ? ' color=red>' : '>') + uW.ksoItems[2].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[3] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneUseGH ' + (tcoThroneUpgradeData.useGH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[3] + ' (<div class=divNoWrap id=tcoThroneUseGHLabel><font' + (uW.ksoItems[3].count < 100 ? ' color=red>' : '>') + uW.ksoItems[3].count + '</font></div>)</div></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[4] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneUseMH ' + (tcoThroneUpgradeData.useMH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[4] + ' (<div class=divNoWrap id=tcoThroneUseMHLabel><font' + (uW.ksoItems[4].count < 100 ? ' color=red>' : '>') + uW.ksoItems[4].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[5] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneUseAH ' + (tcoThroneUpgradeData.useAH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[5] + ' (<div class=divNoWrap id=tcoThroneUseAHLabel><font' + (uW.ksoItems[5].count < 100 ? ' color=red>' : '>') + uW.ksoItems[5].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[6] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneUseWH ' + (tcoThroneUpgradeData.useWH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[6] + ' (<div class=divNoWrap id=tcoThroneUseWHLabel><font' + (uW.ksoItems[6].count < 100 ? ' color=red>' : '>') + uW.ksoItems[6].count + '</font></div>)</div></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[7] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneUseDH ' + (tcoThroneUpgradeData.useDH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[7] + ' (<div class=divNoWrap id=tcoThroneUseDHLabel><font' + (uW.ksoItems[7].count < 100 ? ' color=red>' : '>') + uW.ksoItems[7].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[8] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneUseEH ' + (tcoThroneUpgradeData.useEH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[8] + ' (<div class=divNoWrap id=tcoThroneUseEHLabel><font' + (uW.ksoItems[8].count < 100 ? ' color=red>' : '>') + uW.ksoItems[8].count + '</font></div>)</div></td>';
        m += '<td/>';
        m += '</tr>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoThroneOverrideSpeedUps ' + (tcoThroneUpgradeData.overrideSpeedUp ? "CHECKED" : "") + '>Override hourglasses by using ';
        m += '<select class=tcoSelect  id=tcoThroneSpeedUp>';
        m += '<option value=0>None</option>';
        for (gls in tcoHourGlassName) m += '<option value=' + gls + ' ' + (tcoThroneUpgradeData.useSpeedUp == gls ? 'SELECTED' : '') + '>' + tcoHourGlassName[gls] + '</option>';
        m += '</select> every time</td>';
        m += '</tr>';
        m += '</table>';
        m += '</div>';
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;BOOST ITEMS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        m += '<td><input class=tcoCheckbox type=checkbox ' + (tcoThroneUpgradeData.useLPS ? "CHECKED" : "") + ' id=tcoThroneUseLPS><div class=divNoWrap>Lesser Protection Stones (<div class=divNoWrap id=tcoThroneUseLPSLabel>' + uW.ksoItems[20001].count + '</div>)</div></td>';
        m += '<td><input class=tcoCheckbox type=checkbox ' + (tcoThroneUpgradeData.usePS ? "CHECKED" : "") + ' id=tcoThroneUsePS><div class=divNoWrap>Protection Stones (<div class=divNoWrap id=tcoThroneUsePSLabel>' + uW.ksoItems[20002].count + '</div>)</div></td>';
        m += '<td/>';
        m += '</tr>';
        m += '<tr>';
        //m += '<td><input class=tcoCheckbox type=checkbox ' + (tcoThroneUpgradeData.useLORB ? "CHECKED" : "") + ' id=trUseLORB><div style="white-space:nowrap;display:inline-block;">Lesser Mystic Orb (<div style="white-space:nowrap;display:inline-block;" id=trUseLORBLabel>' + Seed.items['i20003'] + '</div>)</div></td>';
        m += '<td><input class=tcoCheckbox type=checkbox ' + (tcoThroneUpgradeData.useORB ? "CHECKED" : "") + ' id=tcoThroneUseORB><div class=divNoWrap>Mystic Orb (<div class=divNoWrap id=tcoThroneUseORBLabel>' + uW.ksoItems[20004].count + '</div>)</div></td>';
        m += '<td/>';
        m += '<td>Quality <select class=tcoSelect  id=tcoThroneUseQuality>';
        for (i = 0; i <= tcoMaxThroneQuality-1; i++) m += '<option value="' + i + '" ' + (tcoThroneUpgradeData.useQuality == i ? 'SELECTED' : '')  + '>' + throneCardQualities[i].capitalizeFirstLetter() + '</option>';
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td><input class=tcoCheckbox type=checkbox ' + (tcoThroneUpgradeData.useLLT ? "CHECKED" : "") + ' id=tcoThroneUseLLT><div class=divNoWrap>Lesser Tokens (<div class=divNoWrap id=tcoThroneUseLLTLabel>' + uW.ksoItems[20005].count + '</div>)</div></td>';
        m += '<td><input class=tcoCheckbox type=checkbox ' + (tcoThroneUpgradeData.useLT ? "CHECKED" : "") + ' id=tcoThroneUseLT><div class=divNoWrap>Lucky Tokens (<div class=divNoWrap id=tcoThroneUseLTLabel>' + uW.ksoItems[20006].count + '</div>)</div></td>';
        m += '<td>Level <select class=tcoSelect  id=tcoThroneUseLevel>';
        for (i = 1; i <= tcoMaxThroneLevel-1; i++) m += '<option value="' + i + '" ' + (tcoThroneUpgradeData.useLevel == i ? 'SELECTED' : '') + '>+' + i + '</option>';
        m += '</select> & Higher</td>';
        m += '</tr>';
        m += '</table>';
        m += '</div>';
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;UPGRADE ITEMS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        m += '<td colspan=4>Enhance All Quality <select class=tcoSelect id=tcoThroneEnhanceAllQuality>';
        for (i = 0; i <= tcoMaxThroneQuality-1; i++) m += '<option value="' + i + '">' + throneCardQualities[i].capitalizeFirstLetter() + '</option>';
        m += '</select> To Quality <select class=tcoSelect id=tcoThroneEnhanceAllQualityTo>';
        for (i = 1; i <= tcoMaxThroneQuality; i++) m += '<option value="' + i + '">' + throneCardQualities[i].capitalizeFirstLetter() + '</option>';
        m += '</select>&nbsp;&nbsp;<input class=tcoButton type=button value="Add" id=tcoThroneEnhanceAddAllQuality></td>';
        m += '</tr>';
        m += '<tr><td colspan=4>Upgrade All Cards Less To Level <select class=tcoSelect id=tcoThroneUpgradeAddAllLevelMaxTo>';
        for (i = 1; i <= tcoMaxThroneLevel; i++) m += '<option value="' + i + '"> +' + i + '</option>';
        m += '</select>&nbsp;&nbsp;<input class=tcoButton type=button value="Add" id=tcoThroneUpgradeAddAllLevelMax></td></tr>';
        m += '<tr>';
        m += '<td colspan=4>Upgrade All Level <select class=tcoSelect id=tcoThroneUpgradeAllLevel>';
        for (i = 0; i <= tcoMaxThroneLevel-1; i++) m += '<option value="' + i + '"> +' + i + '</option>';
        m += '</select> To Level <select class=tcoSelect id=tcoThroneUpgradeAllLevelTo>';
        for (i = 1; i <= tcoMaxThroneLevel; i++) m += '<option value="' + i + '"> +' + i + '</option>';
        m += '</select>&nbsp;&nbsp;<input class=tcoButton type=button value="Add" id=tcoThroneUpgradeAddAllLevel></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td class=divNoWrap>Item: <select class=tcoSelect style="white-space:nowrap;display:inline-block;max-width: 200px;" id=tcoThroneUpgradeList>';
        m += '<option value="0">--Items--</option>';
        for (ThroneID in uW.kocThroneItems) {
            var throne_item = uW.kocThroneItems[ThroneID];
            m += '<option value="' + ThroneID + '">' + throne_item.name + '</option>';
        }
        m += '</select>&nbsp;';
        m += 'Action: <select class=tcoSelect style="white-space:nowrap;display:inline-block;" id=tcoThroneAction>';
        m += '<option value="upgrade">Upgrade</option>';
        m += '<option value="enhance">Enhance</option>';
        m += '<option value="both">Both</option>';
        m += '</select>&nbsp;';
        m += '<div class=divNoWrap id=tcoThroneMaxDiv></div>&nbsp;';
        m += '<input class=tcoButton id=tcoThroneQueueAdd type=button value="Add"/>';
        m += '</td>';
        m += '</tr>';
        m += '</table>';
        m += '</div>';
        m += '<div class=tcoHeader>UPGRADE LIST</div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td colspan=4>';
        m += '<div id=tcoThroneQScroll style="position: static; width: 100%; height: 340px; overflow-x: auto; overflow-y: auto;">';
        m += '<div id=tcoThroneQDiv></div>';
        m += '</div>';
        m += '</td></tr>';
        m += '<tr><td colspan=4><input class=tcoButton style="float: left;" id=tcoThroneClearQ type=button value="Clear Queue"></tr>';
        m += '</table>';
        m += '</div>';
        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoThroneUpgraderSaveSettings').addEventListener('click', function () {
            SaveSettingsToFile(tcoThroneUpgradeData);
        }, false);
        document.getElementById('tcoThroneUpgraderLoadSettings').addEventListener('click', function () {
            var loader = document.getElementById('tcoSettingsFile');
            loader.addEventListener('change', function () {
                LoadSettingsFromFile(tcoThroneUpgradeData, Tabs.throneUpgrader);
            }, false);
            loader.click();
        }, false);

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        document.getElementById('tcoThroneUpgradePower').addEventListener('click', function () {
            t.togglePower(this);           
        }, false);

        document.getElementById('tcoThroneHourglassLevelSpecific').addEventListener('change', function () {
            tcoThroneUpgradeData.hourglassLevelSpecific = document.getElementById('tcoThroneHourglassLevelSpecific').checked;
            SAVEtcoThroneUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneHourglassQualitySpecific').addEventListener('change', function () {
            tcoThroneUpgradeData.hourglassQualitySpecific = document.getElementById('tcoThroneHourglassQualitySpecific').checked;
            SAVEtcoThroneUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneOverrideSpeedUps').addEventListener('change', function () {
            tcoThroneUpgradeData.overrideSpeedUp = document.getElementById('tcoThroneOverrideSpeedUps').checked;
            SAVEtcoThroneUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneUseWH').addEventListener('change', function () {
            tcoThroneUpgradeData.useWH = document.getElementById('tcoThroneUseWH').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useWH) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseDH').addEventListener('change', function () {
            tcoThroneUpgradeData.useDH = document.getElementById('tcoThroneUseDH').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useDH) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseEH').addEventListener('change', function () {
            tcoThroneUpgradeData.useEH = document.getElementById('tcoThroneUseEH').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useEH) t.doAction();
        }, false);
        
        document.getElementById('tcoThroneUseSH').addEventListener('change', function () {
            tcoThroneUpgradeData.useSH = document.getElementById('tcoThroneUseSH').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useSH) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseKH').addEventListener('change', function () {
            tcoThroneUpgradeData.useKH = document.getElementById('tcoThroneUseKH').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useKH) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseGH').addEventListener('change', function () {
            tcoThroneUpgradeData.useGH = document.getElementById('tcoThroneUseGH').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useGH) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseMH').addEventListener('change', function () {
            tcoThroneUpgradeData.useMH = document.getElementById('tcoThroneUseMH').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useMH) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseAH').addEventListener('change', function () {
            tcoThroneUpgradeData.useAH = document.getElementById('tcoThroneUseAH').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useAH) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseQuality').addEventListener('change', function () {
            tcoThroneUpgradeData.useQuality = document.getElementById('tcoThroneUseQuality').value;
            SAVEtcoThroneUpgradeData();
        }, false);

        document.getElementById('tcoThroneUseLevel').addEventListener('change', function () {
            tcoThroneUpgradeData.useLevel = document.getElementById('tcoThroneUseLevel').value;
            SAVEtcoThroneUpgradeData();
        }, false);

        document.getElementById('tcoThroneSpeedUp').addEventListener('change', function () {
            tcoThroneUpgradeData.useSpeedUp = document.getElementById('tcoThroneSpeedUp').value;
            SAVEtcoThroneUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneHourglassLevel').addEventListener('change', function () {
            tcoThroneUpgradeData.hourglassLevel = document.getElementById('tcoThroneHourglassLevel').value;
            SAVEtcoThroneUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneHourglassQuality').addEventListener('change', function () {
            tcoThroneUpgradeData.hourglassQuality = document.getElementById('tcoThroneHourglassQuality').value;
            SAVEtcoThroneUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneUseORB').addEventListener('change', function () {
            tcoThroneUpgradeData.useORB = document.getElementById('tcoThroneUseORB').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useORB) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseLPS').addEventListener('change', function () {
            tcoThroneUpgradeData.useLPS = document.getElementById('tcoThroneUseLPS').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useLPS) t.doAction();
        }, false);

        document.getElementById('tcoThroneUsePS').addEventListener('change', function () {
            tcoThroneUpgradeData.usePS = document.getElementById('tcoThroneUsePS').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.usePS) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseLT').addEventListener('change', function () {
            tcoThroneUpgradeData.useLT = document.getElementById('tcoThroneUseLT').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useLT) t.doAction();
        }, false);

        document.getElementById('tcoThroneUseLLT').addEventListener('change', function () {
            tcoThroneUpgradeData.useLLT = document.getElementById('tcoThroneUseLLT').checked;
            SAVEtcoThroneUpgradeData();
            if (tcoThroneUpgradeData.useLLT) t.doAction();
        }, false);

        document.getElementById('tcoThroneQueueAdd').addEventListener('click', function () {
            t.addThroneQueue();
        }, false);

        document.getElementById('tcoThroneOneItem').addEventListener('change', function () {
            tcoThroneQueueData.oneItem = document.getElementById('tcoThroneOneItem').checked;
            SAVEtcoThroneQueueData();
        });

        document.getElementById('tcoThroneClearQ').addEventListener('click', function () {
            tcoThroneQueueData.list = [];
            SAVEtcoThroneQueueData();
            t.buildThroneQueueDisplay();
        }, false);
        
        document.getElementById('tcoThroneEnhanceAddAllQuality').addEventListener('click', function () {
            var low_level = parseInt(document.getElementById('tcoThroneEnhanceAllQuality').value);
            var high_level = parseInt(document.getElementById('tcoThroneEnhanceAllQualityTo').value);
            if (low_level >= high_level) return;
            for (ThroneId in uW.kocThroneItems) {
                var ThroneItem = uW.kocThroneItems[ThroneId];
                if (ThroneItem.quality == low_level) {
                    var qItem = new QueueItem();
                    qItem.item = ThroneId;
                    qItem.action = "enhance"
                    qItem.level = high_level
                    tcoThroneQueueData.list.push(qItem);
                }
            }
            SAVEtcoThroneQueueData();
            t.buildThroneQueueDisplay();
        }, false);

        document.getElementById('tcoThroneUpgradeAddAllLevelMax').addEventListener('click', function () {
            var high_level = parseInt(document.getElementById('tcoThroneUpgradeAddAllLevelMaxTo').value);
            for (ThroneId in uW.kocThroneItems) {
                var ThroneItem = uW.kocThroneItems[ThroneId];
                if (ThroneItem.level < high_level) {
                    var qItem = new QueueItem();
                    qItem.item = ThroneId;
                    qItem.action = "upgrade"
                    qItem.level = high_level
                    tcoThroneQueueData.list.push(qItem);
                }
            }
            SAVEtcoThroneQueueData();
            t.buildThroneQueueDisplay();
        }, false);

        document.getElementById('tcoThroneUpgradeAddAllLevel').addEventListener('click', function () {
            var low_level = parseInt(document.getElementById('tcoThroneUpgradeAllLevel').value);
            var high_level = parseInt(document.getElementById('tcoThroneUpgradeAllLevelTo').value);

            if (low_level >= high_level) return;
            for (ThroneId in uW.kocThroneItems) {
                var ThroneItem = uW.kocThroneItems[ThroneId];
                if (ThroneItem.level == low_level) {
                    var qItem = new QueueItem();
                    qItem.item = ThroneId;
                    qItem.action = "upgrade"
                    qItem.level = high_level
                    tcoThroneQueueData.list.push(qItem);
                }
            }
            SAVEtcoThroneQueueData();
            t.buildThroneQueueDisplay();
        }, false);

        document.getElementById('tcoThroneAction').addEventListener('change', function () {
            t.buildThroneLevelWidget();
        }, false);

        // wait for the current repair to finish before starting
        if (tcoThroneUpgradeData.active)
            t.setStatus("Loading ....");
        else
            t.setStatus("Powered Off");

        t.startTimer();

        t.buildThroneLevelWidget();

        t.refreshAetherDisplay();

        t.buildThroneQueueDisplay();

	},

    startTimer: function () {
        var t = Tabs.throneUpgrader;
        var delay = 2 + Math.random() * 8;
        if (Seed.queue_throne != null && Seed.queue_throne.end != null) {
            var repairTimeLeft = Seed.queue_throne.end - unixTime();
            t.repairEnd = Seed.queue_throne.end;
            t.repairId = Seed.queue_throne.itemId;
            var n = new Date(t.repairEnd * 1000);

            var throne_item = uW.kocThroneItems[t.repairId];

            t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + throne_item.name);
            if (tcoThroneUpgradeData.useSH || tcoThroneUpgradeData.useKH || tcoThroneUpgradeData.useGH || tcoThroneUpgradeData.useMH || tcoThroneUpgradeData.useAH || tcoThroneUpgradeData.useWH || tcoThroneUpgradeData.useDH || tcoThroneUpgradeData.useEH || (tcoThroneUpgradeData.overrideSpeedUp && tcoThroneUpgradeData.useSpeedUp > 0)) {
                var throneQuality = throne_item.quality;
                var throneLevel = throne_item.level;
                var useThoseSpeedups = true;
                if (tcoThroneUpgradeData.hourglassQualitySpecific && throneQuality < tcoThroneUpgradeData.hourglassQuality) useThoseSpeedups = false;
                if (tcoThroneUpgradeData.hourglassLevelSpecific && throneLevel < tcoThroneUpgradeData.hourglassLevel) useThoseSpeedups = false;
                if (tcoThroneUpgradeData.overrideSpeedUp) useThoseSpeedups = true;
                if (useThoseSpeedups) {
                    setTimeout(function () { t.doSpeedup(); }, 2000);
                }
            }
            setTimeout(t.clearRepair, (repairTimeLeft + 1) * 1000);
            if (repairTimeLeft > 0) delay += repairTimeLeft;
        }

        if (t.timerH == null)
            t.timerH = setTimeout(t.doAction, delay * 1000);
    },
	
	hide: function () {},

    refreshAetherDisplay : function () {
        document.getElementById('tcoThroneAetherDisplay').innerHTML = displayCityAstone();
    },        
	
	show: function () {
		var t = Tabs.throneUpgrader;
        t.startTimer();
        t.refreshAetherDisplay();
        t.buildThroneQueueDisplay();
	},

    doAction: function () {
        var t = Tabs.throneUpgrader;
        if (tcoThroneRepairData.active) {
            t.setStatus('Waiting for repair tab to finish...');
            return;
        }
        var retryTime = tcoGeneralOptions.retryInterval;

        try { // check if repair is done
            var ti = t.clearRepair();
            if (ti <= 0) { // repair is done
                if (tcoThroneQueueData.oneItem || (tcoThroneQueueData.doingRepairs == true)) {
                    for (queueItems in tcoThroneQueueData.list) {
                        var qItem = tcoThroneQueueData.list[queueItems];
                        if (!qItem) continue;
                        var throneItem = uW.kocThroneItems[qItem.item];

                        if ((throneItem == null) || (tcoThroneQueueData.list[queueItems].status == "complete")) continue;

                        if (throneItem.isBroken) {
                            t.doRepair(throneItem.id);
                            clearTimeout(t.timerH);
                            t.timerH = setTimeout(t.doAction, retryTime * 1000);
                            return;
                        } else if (tcoThroneQueueData.oneItem) {
                            break;
                        }
                    }
                }
                tcoThroneQueueData.doingRepairs = false; // all repairs complete
                t.selectNext();  // set the index
                SAVEtcoThroneQueueData();
                // if we reach the end of the queue, start repair cycle
                if (tcoThroneQueueData.index < 0) {
                    t.setStatus("Reached end of queue.")
                    t.setResult("");
                    if (!tcoThroneUpgradeData.active) t.setStatus("Powered Off");
                    tcoThroneQueueData.doingRepairs = true;
                    SAVEtcoThroneQueueData();
                    clearTimeout(t.timerH);
                    t.timerH = setTimeout(t.doAction, retryTime * 1000);
                    return;
                }
                // upgrade/enhance next item
                var qItem = tcoThroneQueueData.list[tcoThroneQueueData.index];

                if (qItem) {
                    if (qItem.action == "enhance")
                        t.doEnhance(qItem.item);
                    else
                        t.doUpgrade(+qItem.item, false);
                }
            } else {
                // come back after repair is complete
                retryTime = ti + 5;
                var n = new Date(t.repairEnd * 1000);
                t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + uW.kocThroneItems[t.repairId].name);
                if (tcoThroneUpgradeData.useSH || tcoThroneUpgradeData.useKH || tcoThroneUpgradeData.useGH || tcoThroneUpgradeData.useMH || tcoThroneUpgradeData.useAH || tcoThroneUpgradeData.useWH || tcoThroneUpgradeData.useDH || tcoThroneUpgradeData.useEH || (tcoThroneUpgradeData.overrideSpeedUp && tcoThroneUpgradeData.useSpeedUp > 0)) {
                    var throneItem = uW.kocThroneItems[t.repairId];
                    var trQuality = throneItem.quality;
                    var trLevel = throneItem.level;
                    var useThoseSpeedups = true;
                    if (tcoThroneUpgradeData.hourglassQualitySpecific && trQuality < tcoThroneUpgradeData.hourglassQuality) useThoseSpeedups = false;
                    if (tcoThroneUpgradeData.hourglassLevelSpecific && trLevel < tcoThroneUpgradeData.hourglassLevel) useThoseSpeedups = false;
                    if (tcoThroneUpgradeData.overrideSpeedUp) useThoseSpeedups = true;
                    if (useThoseSpeedups) {
                        setTimeout(function () { t.doSpeedup(); }, 2000);
                    }
                    retryTime = 1;
                }
            }
            CM.ThroneView.renderInventory(uW.kocThroneItems);
        } catch (e) {
        }
        // recycle
        clearTimeout(t.timerH);
        t.timerH = setTimeout(t.doAction, retryTime * 1000);
    },

    doSpeedup: function () {
        var t = Tabs.throneUpgrader;

        var endTime = t.repairEnd;
        var startTime = unixTime();
        var secondsForRepair = endTime - startTime;
        var divId = "";

        t.speedup = 0;

        if (secondsForRepair > 0 && tcoThroneUpgradeData.overrideSpeedUp && tcoThroneUpgradeData.useSpeedUp > 0) {
            t.speedup = tcoThroneUpgradeData.useSpeedUp;
        } else {
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.day25 && tcoThroneUpgradeData.useEH && uW.ksoItems[8].count > 0) { t.speedup = 8; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour24 && tcoThroneUpgradeData.useDH && uW.ksoItems[7].count > 0) { t.speedup = 7; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour15 && tcoThroneUpgradeData.useWH && uW.ksoItems[6].count > 0) { t.speedup = 6; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour8 && tcoThroneUpgradeData.useAH && uW.ksoItems[5].count > 0) { t.speedup = 5; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour25 && tcoThroneUpgradeData.useMH && uW.ksoItems[4].count > 0) { t.speedup = 4; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour1 && tcoThroneUpgradeData.useGH && uW.ksoItems[3].count > 0) { t.speedup = 3; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.minute15 && tcoThroneUpgradeData.useKH && uW.ksoItems[2].count > 0) { t.speedup = 2; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.minute1 && tcoThroneUpgradeData.useSH && uW.ksoItems[1].count > 0) { t.speedup = 1; }
        }
        switch (t.speedup) {
            case "1":
            case 1:
                secondsForRepair -= HOURGLASSES_TIME.minute1;
                divId = 'tcoThroneUseSHLabel';
                break;
            case "2":
            case 2:
                secondsForRepair -= HOURGLASSES_TIME.minute15;
                divId = 'tcoThroneUseKHLabel';
                break;
            case "3":
            case 3:
                secondsForRepair -= HOURGLASSES_TIME.hour1;
                divId = 'tcoThroneUseGHLabel';
                break;
            case "4":
            case 4:
                secondsForRepair -= HOURGLASSES_TIME.hour25;
                divId = 'tcoThroneUseMHLabel';
                break;
            case "5":
            case 5:
                secondsForRepair -= HOURGLASSES_TIME.hour8;
                divId = 'tcoThroneUseAHLabel';
                break;
            case "6":
            case 6:
                secondsForRepair -= HOURGLASSES_TIME.hour15;
                divId = 'tcoThroneUseWHLabel';
                break;
            case "7":
            case 7:
                secondsForRepair -= HOURGLASSES_TIME.hour24;
                divId = 'tcoThroneUseDHLabel';
                break;
            case "8":
            case 8:
                secondsForRepair -= HOURGLASSES_TIME.day25;
                divId = 'tcoThroneUseEHLabel';
                break;
        }

        if (t.speedup != 0) {
            t.setResult('Used ' + uW.ksoItems[t.speedup].name);
            var divCount = uW.ksoItems[t.speedup].count - 1;
            var divSpeedups = document.getElementById(divId);
            divSpeedups.innerHTML = divCount;
            uW.modal_speedup_apply("throne", t.speedup, t.repairId);

            if (secondsForRepair <= 0) {
                secondsForRepair = 0;
                endTime = startTime;
                t.clearTimerH = setTimeout(t.clearRepair, 1000);
                t.buildThroneQueueDisplay();
            } else {
                endTime = unixTime() + secondsForRepair;
                t.repairEnd = endTime;
                var n = new Date(t.repairEnd * 1000);
                var item = uW.kocThroneItems[t.repairId];
                t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString() + ". Item: " + item.name);
                t.clearTimerH = setTimeout(t.clearRepair, secondsForRepair * 1000);
                t.buildThroneQueueDisplay();
            }
            t.repairEnd = endTime;
            setTimeout(function () { t.doSpeedup(); }, 1000);
        }
    },

    selectNext: function () {

        if (tcoThroneQueueData.index >= tcoThroneQueueData.list.length) tcoThroneQueueData.index = 0;
        if (tcoThroneQueueData.index < 0) tcoThroneQueueData.index = 0;
        // for single item mode, always start from the top
        if (tcoThroneQueueData.oneItem) tcoThroneQueueData.index = 0;
        var l = tcoThroneQueueData.list.length;
        for (i = tcoThroneQueueData.index; i < l; i++) {
            var item = tcoThroneQueueData.list[i];
            if (!item) continue;
            var throneItem = uW.kocThroneItems[item.item];
            if ((tcoThroneQueueData.list[i].status != "complete") && (throneItem != null) && (!throneItem.isBroken)) {
                if (((item.action == "enhance") && (item.level <= throneItem.quality)) || ((item.action == "upgrade") && (item.level <= throneItem.level))) {
                    item.status = "complete";
                } else {
                    tcoThroneQueueData.index = i;
                    return;
                }
            }
        }
        tcoThroneQueueData.index = -1; // if we get here, the queue is complete
    },

    doEnhance: function (eItem) {
        var t = Tabs.throneUpgrader;
        try {
            if (tcoThroneUpgradeData.active == false || eItem == 0) {
                t.setStatus("Powered Off");
                return;
            }
            var throne_item = uW.kocThroneItems[eItem];

            if (!throne_item) return;

            if (throne_item.isBroken) {
                // repair and then try again later
                t.doRepair(eItem);
                return;
            }

            var num_city = pickAetherUseCity();
            if (num_city < 0) {
                t.setStatus("Not enough aetherstones to enhance.  Minimum of " + tcoGeneralOptions.minStones + " needed.  Waiting for more ...");
                return;
            }

            var t_city = uW.currentcityid;
            uW.currentcityid = Seed.cities[num_city][0];
            var w = CM.ThronePanelController.calcCost("enhance", throne_item, null, "stones");
            uW.currentcityid = t_city;

            if ((w.gems.use > 0) || (w.stones.total > parseInt(Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0]))) {
                t.setStatus("Not enough aetherstones to enhance.");
                return;
            }

            var qI = tcoThroneQueueData.list[tcoThroneQueueData.index];
            if (qI) {
                qI.triesTotal++;
                qI.triesThis++;
            }

            var buffItemId = 0;

            var useDiv = '';

            if (tcoThroneUpgradeData.active && tcoThroneQueueData.index != -1 && tcoThroneUpgradeData.useQuality <= throne_item.quality) {
                if (tcoThroneUpgradeData.useORB) {
                    if (Seed.items['i20004'] > 0) {
                        buffItemId = 20004;
                        useDiv = 'tcoThroneUseORBLabel';
                    }
                }
                /*      if (TRupgradeData.useLORB) {
                if (Seed.items['i20003'] > 0) buffItemId = 20003;
                } */
                if (tcoThroneUpgradeData.usePS) {
                    if (Seed.items['i20002'] > 0) {
                        buffItemId = 20002;
                        useDiv = 'tcoThroneUsePSLabel';
                    }
                }
                if (tcoThroneUpgradeData.useLPS) {
                    if (Seed.items['i20001'] > 0) {
                        buffItemId = 20001;
                        useDiv = 'tcoThroneUseLPSLabel';
                    }
                }
                if (buffItemId) CM.InventoryView.removeItemFromInventory(buffItemId);
            }
            
            if (useDiv != '') document.getElementById(useDiv).innerHTML = uW.ksoItems[buffItemId].count;

            var params = uW.Object.clone(ajfx);
            params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';
            params.action = 'upgradeQuality';
            params.throneRoomItemId = eItem;

            params.payment = "aetherstone";
            params.buffItemId = buffItemId;
            params.cityId = Seed.cities[num_city][0];

            t.setStatus("Sending enhance request");
            new AjaxRequest(uW.g_ajaxpath + "ajax/_dispatch53.php" + uW.g_ajaxsuffix, {
                method: "post",
                parameters: params,
                loading: true,
                onSuccess: function (transport) {
                    try {
                        var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.updateSeed) uW.update_seed(rslt.updateSeed);
                        if (rslt.ok) {
                            Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] = Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] - rslt.aetherstones;
                            if (rslt.gems > 0) {
                                ActionLog('Upgrader accidentally spent gems!  Upgrader turned off');
                                t.setStatus("Error ... shutting down");
                                tcoThroneUpgradeData.active = false;
                                SAVEtcoThroneUpgradeData();
                            }

                            throne_item.level = rslt.item.level;
                            throne_item.quality = rslt.item.quality
                            throne_item.status = rslt.item.status;

                            if (rslt.success) {
                                throne_item.name = throne_item.createName();
                                tcoThroneUpgradeStats.enhanceSuccess[throne_item.quality - 1][throne_item.level]++;
                                SAVEtcoThroneUpgradeStats();
                                t.setResult("Enhance successful.  " + addCommas(rslt.aetherstones) + " aetherstones used.");
                                t.refreshAetherDisplay();
                                t.setStatus("Attempting next action");
                                CM.sounds.play("tr_success_build");
                                // update the cost line
                                var qItem = tcoThroneQueueData.list[tcoThroneQueueData.index];
                                if (qItem) {
                                    var now = new Date();
                                    qItem.lastUpgrade = "Enhanced to " + t.qualities[throne_item.quality] + " " + now.toDateString().substring(3, 10) + " " + now.toTimeString().substring(0, 8) + " in " + qItem.triesThis + " attempts";
                                    if (!qItem.upgrades) qItem.upgrades = [];
                                    qItem.upgrades.push(qItem.lastUpgrade);
                                    var msg = 'Enhanced ' + uW.kocThroneItems[eItem].name + ' [ ' + eItem + '] to quality ' + rslt.item.quality + " in " + qItem.triesThis + " attempts. " + qItem.triesTotal + " total attempts for this item.";
                                    if (tcoGeneralOptions.whisperToMe) sendChat("/" + Seed.player.name + ' ' + msg);
                                    if (tcoGeneralOptions.sendToInbox) sendComposedMail(Seed.player.name, 'THRONE: Enhance Success : ' + uW.kocThroneItems[eItem].name, msg);
                                    SuccessLog(msg);
                                    if (qItem.level <= throne_item.quality) {
                                        qItem.status = "complete";
                                        tcoThroneUpgradeData.newUpgradeState = 2;
                                    }
                                    else {
                                        var now = new Date();
                                        qItem.status = "Partially enhanced";
                                        qItem.triesLast = qItem.triesThis;
                                        qItem.triesThis = 0;
                                        if (tcoThroneUpgradeData.newUpgradeState != 2) tcoThroneUpgradeData.newUpgradeState = 1;
                                    }
                                    SAVEtcoThroneUpgradeData();
                                    setUpgradeColor();
                                }
                            }
                            else {
                                tcoThroneUpgradeStats.enhanceFailure[throne_item.quality][throne_item.level]++;
                                SAVEtcoThroneUpgradeStats();
                                ActionLog('Enhance failed.  Throne Room item ' + uW.kocThroneItems[eItem].name + (buffItemId > 0 ? ' - (' + Seed.items['i' + buffItemId] + ' ' + uW.itemlist['i' + buffItemId].name + ' remaining)' : ''));
                                if (rslt["break"]) {
                                    throne_item.isBroken = true;
                                    throne_item.brokenType = "quality";
                                    throne_item.name = throne_item.createName();
                                }
                                t.setResult("Enhance failed.  " + addCommas(rslt.aetherstones) + " aetherstones used");
                                t.refreshAetherDisplay();
                                var qItem = tcoThroneQueueData.list[tcoThroneQueueData.index];
                                if (qItem) if (qItem.status == "not started") qItem.status = "started";
                            }
                            CM.ThroneView.renderInventory(uW.kocThroneItems);
                            SAVEtcoThroneQueueData();
                            t.buildThroneQueueDisplay();
                            clearTimeout(t.timerH);
                            t.timerH = setTimeout(t.doAction, 10 * 1000);
                        }
                        else {
                            t.setStatus("Unable to enhance at this time ... waiting for next cycle");

                        }
                    } catch (e) {

                    }
                    return;
                },
                onFailure: function (rst) {
                    t.setStatus("Unable to send enhance request.  Waiting for next cycle");
                    return;
                }
            });
        } catch (e) {

        }
        return;
    },

    doUpgrade: function (uItemId, bypass) {
        var t = Tabs.throneUpgrader;

        var throne_item = uW.kocThroneItems[uItemId];

        if (uItemId == 0 || throne_item == null) {
            t.setStatus("Item not found.");
            return;
        }

        if ((tcoThroneUpgradeData.active == false) && (bypass != true)) {
            t.setStatus("Powered Off");
            return;
        }

        if (bypass == true && Tabs.throneSalvager.deleting != true) {
            // delete cycle has been canceled.  Don't upgrade this item
            return;
        }

        if (throne_item.isBroken) {
            // repair and then try again later
            t.doRepair(uItemId);
            return;
        }

        var num_city = pickAetherUseCity();
        if (num_city < 0) {
            t.setStatus("Not enough aetherstones to upgrade.  Minimum of " + tcoGeneralOptions.minStones + " needed.  Waiting for more ...");
            return;
        }

        var t_city = uW.currentcityid;
        uW.currentcityid = Seed.cities[num_city][0];
        var w = CM.ThronePanelController.calcCost("upgrade", throne_item, null, "stones");
        uW.currentcityid = t_city;

        if ((w.gems.use > 0) || (w.stones.total > parseInt(Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0]))) {
            t.setStatus("Not enough aetherstones to upgrade.");
            return;
        }

        if (bypass != true) {
            var qI = tcoThroneQueueData.list[tcoThroneQueueData.index];
            if (qI) {
                qI.triesTotal++;
                qI.triesThis++;
            }

            t.setStatus("Sending upgrade request ...");
        }

        var buffItemId = 0;

        var useDiv = '';

        if (tcoThroneUpgradeData.active && tcoThroneQueueData.index != -1 && tcoThroneUpgradeData.useLevel <= throne_item.level) {

            if (tcoThroneUpgradeData.useLT) {
                if (Seed.items['i20006'] > 0) {
                    buffItemId = 20006;
                    useDiv = 'tcoThroneUseLTLabel';
                }
            }

            if (tcoThroneUpgradeData.useLLT) {
                if (Seed.items['i20005'] > 0) {
                    buffItemId = 20005;
                    useDiv = 'tcoThroneUseLLTLabel';
                }
            }

            if (tcoThroneUpgradeData.usePS) {
                if (Seed.items['i20002'] > 0) {
                    buffItemId = 20002;
                    useDiv = 'tcoThroneUsePSLabel';
                }
            }

            if (tcoThroneUpgradeData.useLPS) {
                if (Seed.items['i20001'] > 0) {
                    buffItemId = 20001;
                    useDiv = 'tcoThroneUseLPSLabel';
                }
            }

            if (buffItemId) CM.InventoryView.removeItemFromInventory(buffItemId);

        }

        if (useDiv != '') document.getElementById(useDiv).innerHTML = uW.ksoItems[buffItemId].count;

        var params = uW.Object.clone(ajfx);
        params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';
        params.action = 'upgradeLevel';
        params.throneRoomItemId = uItemId;
        params.buffItemId = buffItemId;
        params.payment = "aetherstone";
        params.cityId = Seed.cities[num_city][0];


        new AjaxRequest(uW.g_ajaxpath + "ajax/_dispatch53.php" + uW.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            loading: true,
            onSuccess: function (transport) {
                try {

                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {

                        if (rslt.updateSeed) uW.update_seed(rslt.updateSeed);

                        Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] = Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] - rslt.aetherstones;

                        if (rslt.gems > 0) {
                            t.setStatus("Error .... Shutting down.");
                            ActionLog('Upgrader accidentally spent gems!  Upgrader turned off');
                            tcoThroneUpgradeData.active = false;
                            SAVEtcoThroneUpgradeData();
                        }

                        if (rslt.success) {
                            throne_item.level = rslt.item.level;
                            throne_item.quality = rslt.item.quality;
                            throne_item.name = throne_item.createName();

                            if (bypass != true) {
                                t.show();
                                tcoThroneUpgradeStats.upgradeSuccess[throne_item.quality][throne_item.level - 1]++;
                                SAVEtcoThroneUpgradeStats();
                                t.setResult("Upgrade successful.  " + addCommas(rslt.aetherstones) + " aetherstones used.");
                                t.refreshAetherDisplay();
                                t.setStatus("Attempting next upgrade");
                                CM.sounds.play("tr_success_build");

                                var qItem = tcoThroneQueueData.list[tcoThroneQueueData.index];
                                if (qItem) {
                                    var now = new Date();
                                    qItem.lastUpgrade = "Upgraded to +" + throne_item.level + " " + now.toDateString().substring(3, 10) + " " + now.toTimeString().substring(0, 8) + " in " + qItem.triesThis + " attempts";

                                    if (!qItem.upgrades) qItem.upgrades = [];
                                    qItem.upgrades.push(qItem.lastUpgrade);

                                    var msg = 'Upgraded ' + uW.kocThroneItems[uItemId].name + ' [' + uItemId + '] to level ' + rslt.item.level + " in " + qItem.triesThis + " attempts. " + qItem.triesTotal + " total attempts for this item.";
                                    if (tcoGeneralOptions.whisperToMe) sendChat("/" + Seed.player.name + ' ' + msg);
                                    if (tcoGeneralOptions.sendToInbox) sendComposedMail(Seed.player.name, 'THRONE: Upgrade Success : ' + uW.kocThroneItems[uItemId].name, msg);
                                    SuccessLog(msg);
                                    if (qItem.level <= throne_item.level) {
                                        qItem.status = "complete";
                                        tcoThroneUpgradeData.newUpgradeState = 2;
                                    }
                                    else {
                                        var now = new Date();
                                        qItem.status = "Partially upgraded";
                                        qItem.triesLast = qItem.triesThis;
                                        qItem.triesThis = 0;
                                        if (tcoThroneUpgradeData.newUpgradeState != 2) tcoThroneUpgradeData.newUpgradeState = 1;
                                    }
                                    SAVEtcoThroneUpgradeData();
                                    setUpgradeColor();
                                }
                            }
                        } else {
                            tcoThroneUpgradeStats.upgradeFailure[throne_item.quality][throne_item.level]++;
                            SAVEtcoThroneUpgradeStats();
                            ActionLog('Upgrade failed Throne Room item ' + uW.kocThroneItems[uItemId].name);
                            if (!params.buffItemId) {
                                throne_item.isBroken = true;
                                throne_item.brokenType = "level";
                                throne_item.name = throne_item.createName();
                                throne_item.status = rslt.item.status;
                            }
                            if (bypass != true) {
                                t.setResult("Upgrade failed.  " + addCommas(rslt.aetherstones) + " aetherstones used");
                                t.refreshAetherDisplay();
                                var qItem = tcoThroneQueueData.list[tcoThroneQueueData.index];
                                if (qItem.status == "not started") qItem.status = "started";
                            }
                        }
                        CM.ThroneView.renderInventory(uW.kocThroneItems);
                        SAVEtcoThroneQueueData();
                        t.buildThroneQueueDisplay();
                        clearTimeout(t.timerH);
                        t.timerH = setTimeout(t.doAction, 10 * 1000);
                        if (rslt.heatupModifier) CM.HeatUpModel.attemptCallback(+(rslt.heatupModifier));
                        return;
                    } else {
                        if (bypass != true) {
                            t.setStatus("Upgrade request not accepted.  Waiting for next cycle.");
                        } else {
                            if (rslt.msg && rslt.msg.indexOf("Has status 2") > -1) {
                                // the object is in the locked rows.  Shutdown deleting until the next pass
                                Tabs.throneSalvager.delItems = [];
                                Tabs.throneSalvager.deleting = false;
                            }
                        }
                    }
                } catch (e) {
                }
                return;
            },
            onFailure: function (rrr) {
                t.setStatus("Unable to transmitt upgrade request.  Waiting for next cycle.");
                CM.ThroneView.renderInventory(uW.kocThroneItems);
                return;
            }
        });

        return;
    },




    doRepair: function (rItem) {
        var t = Tabs.throneUpgrader;
        var params = uW.Object.clone(ajfx);

        if (tcoThroneUpgradeData.active == false || rItem == 0 || uW.kocThroneItems[rItem] == null) return; //repair is turned off

        var theItem = uW.kocThroneItems[rItem];

        params.action = 'timeRepair';
        params.throneRoomItemId = rItem;
        params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';

        new AjaxRequest(uW.g_ajaxpath + "ajax/_dispatch53.php" + uW.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            loading: true,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    var item = uW.kocThroneItems[rItem];
                    var startTime = unixTime();
                    var endTime = rslt.eta;
                    ActionLog('Starting repair for Throne Room item ' + item.name);
                    Seed.queue_throne.itemId = item.id;
                    Seed.queue_throne.start = startTime;
                    Seed.queue_throne.end = endTime;
                    t.repairId = item.id;
                    t.repairEnd = endTime;
                    var n = new Date(t.repairEnd * 1000);
                    t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString() + ". Item: " + item.name);
                    var secondsForRepair = t.repairEnd - startTime;
                    if (secondsForRepair < 0) secondsForRepair = 0;
                    CM.ThroneView.renderInventory(uW.kocThroneItems);
                    t.clearTimerH = setTimeout(t.clearRepair, (secondsForRepair + 1) * 1000);
                    t.buildThroneQueueDisplay();
                    if (tcoThroneUpgradeData.useSH || tcoThroneUpgradeData.useKH || tcoThroneUpgradeData.useGH || tcoThroneUpgradeData.useMH || tcoThroneUpgradeData.useAH || tcoThroneUpgradeData.useWH || tcoThroneUpgradeData.useDH || tcoThroneUpgradeData.useEH || (tcoThroneUpgradeData.overrideSpeedUp && tcoThroneUpgradeData.useSpeedUp > 0)) {
                        var throneItem = uW.kocThroneItems[t.repairId];
                        var trQuality = throneItem.quality;
                        var trLevel = throneItem.level;
                        var useThoseSpeedups = true;
                        if (tcoThroneUpgradeData.hourglassQualitySpecific && trQuality < tcoThroneUpgradeData.hourglassQuality) useThoseSpeedups = false;
                        if (tcoThroneUpgradeData.hourglassLevelSpecific && trLevel < tcoThroneUpgradeData.hourglassLevel) useThoseSpeedups = false;
                        if (tcoThroneUpgradeData.overrideSpeedUp) useThoseSpeedups = true;
                        if (useThoseSpeedups) {
                            setTimeout(function () { t.doSpeedup(); }, 2000);
                        }
                    }
                }
                else {
                    if (rslt.msg == "Item is not broken") {
                        uW.kocThroneItems[rItem].isBroken = false;
                        t.clearRepair();
                    }

                    // regrab the end times in case this is caused by a manual repair
                    if (Seed.queue_throne && Seed.queue_throne.end && Seed.queue_throne.itemId) {
                        t.repairEnd = Seed.queue_throne.end;
                        t.repairId = Seed.queue_throne.itemId;
                    }
                }
                return;
            },
            onFailure: function (ttt) {
                // this usually means a repair is in progress (such as a manual repair). Grab the seed data (if possible)
                if (Seed.queue_throne && Seed.queue_throne.end) {
                    t.repairEnd = Seed.queue_throne.end;
                    t.repairId = Seed.queue_throne.itemId;
                }
                return;
            }
        });
        return;
    },

    clearRepair: function () {
        var t = Tabs.throneUpgrader;
        var timeUntilDone = 0;

        if (t.repairEnd == 0) {
            return timeUntilDone;
        }
        timeUntilDone = t.repairEnd - unixTime();

        if (timeUntilDone <= 0) {
            if (t.repairId != 0 && uW.kocThroneItems[t.repairId] != null) {
                if (uW.kocThroneItems[t.repairId].isBroken == true) {
                    t.setStatus("Repair time complete.");
                }
                uW.kocThroneItems[t.repairId].isBroken = false;
                uW.kocThroneItems[t.repairId].brokenType = "";
                t.repairId = 0;
            }

        }
        CM.ThroneView.renderInventory(uW.kocThroneItems);
        return timeUntilDone;
    },

    addUpgradeItem: function (throneId) {
        var t = Tabs.throneUpgrader;
        var qItem = new QueueItem();
        qItem.item = throneId;
        qItem.action = "upgrade";
        qItem.level = tcoMaxThroneLevel;
        tcoThroneQueueData.list.push(qItem);
        SAVEtcoThroneQueueData();
        document.getElementById('throneInventoryItem' + throneId).className = 'tcoBlueBorder';
        t.buildThroneQueueDisplay();
    },

    addEnhanceItem: function (throneId) {
        var t = Tabs.throneUpgrader;
        var qItem = new QueueItem();
        qItem.item = throneId;
        qItem.action = "enhance";
        qItem.level = tcoMaxThroneQuality;
        tcoThroneQueueData.list.push(qItem);
        SAVEtcoThroneQueueData();
        document.getElementById('throneInventoryItem' + throneId).className = 'tcoYellowBorder';
        t.buildThroneQueueDisplay();
    },

    addBothThroneItem: function (throneId) {
        var t = Tabs.throneUpgrader;

        var throneItem = uW.kocThroneItems[throneId];

        if (throneItem == null || !throneItem) return;

        var qual = +throneItem.quality;
        var lev = +throneItem.level;

        if (qual >= tcoMaxThroneQuality) return;

        var maxLev = null;
        var nextQual = null;
        var qItem = null;

        while (qual < tcoMaxThroneQuality) {
            maxLev = t.upgradePath[qual].maxLev;
            nextQual = t.upgradePath[qual].nextQual;

            if (lev < maxLev) {
                qItem = new QueueItem();
                qItem.item = throneId;
                qItem.action = "upgrade";
                qItem.level = maxLev;
                tcoThroneQueueData.list.push(qItem);
                document.getElementById('throneInventoryItem' + throneId).className = 'tcoBlueBorder';
            }

            qItem = new QueueItem();
            qItem.item = throneId;
            qItem.action = "enhance";
            qItem.level = nextQual;
            tcoThroneQueueData.list.push(qItem);
            document.getElementById('throneInventoryItem' + throneId).className = 'tcoYellowBorder';
            lev = maxLev;
            qual = nextQual;
        }

        tcoThroneQueueData();
        t.buildThroneQueueDisplay();
    },

    addThroneQueue: function () {
        var t = Tabs.throneUpgrader;

        var action = document.getElementById('tcoThroneAction').value;

        if (action == "both") {
            t.addBothThroneItem(document.getElementById('tcoThroneUpgradeList').value);
            return;
        }

        var qItem = new QueueItem();
        qItem.item = document.getElementById('tcoThroneUpgradeList').value;
        qItem.action = document.getElementById('tcoThroneAction').value;
        qItem.level = document.getElementById('tcoThroneMaxLevel').value;

        if (qItem.item == 0) return;

        tcoThroneQueueData.list.push(qItem);
        SAVEtcoThroneQueueData();
        t.buildThroneQueueDisplay();
    },

    buildThroneLevelWidget: function () {
        var t = Tabs.throneUpgrader;
        var m;
        var tcoThroneAction = document.getElementById('tcoThroneAction');
        if (tcoThroneAction.value == "enhance") {
            m = ' Max: <select class=tcoSelect id=tcoThroneMaxLevel>';
            for (qual = 1; qual <= tcoMaxThroneQuality; qual++) {
                m += '<option value="' + qual + '">' + throneCardQualities[qual] + '</option>';
            }
            m += '</select>';
        } else if (tcoThroneAction.value == "upgrade") {
            m = ' Max: <select class=tcoSelect id=tcoThroneMaxLevel>';
            for (lvl = 1; lvl <= tcoMaxThroneLevel; lvl++) {
                m += '<option value="' + lvl + '"> +' + lvl + '</option>';
            }
            m += '</select>';
        } else {
            m = ' - <select class=tcoSelect id=tcoThroneMaxLevel></select>';
        }

        document.getElementById('tcoThroneMaxDiv').innerHTML = m;
        if (tcoThroneAction.value == "enhance") {
            document.getElementById('tcoThroneMaxLevel').value = tcoMaxThroneQuality;
        } else if (tcoThroneAction.value == "upgrade") {
            document.getElementById('tcoThroneMaxLevel').value = tcoMaxThroneLevel;
        }

    },

    buildThroneQueueDisplay: function () {
        var t = Tabs.throneUpgrader;

        var tcoThroneQDiv = document.getElementById('tcoThroneQDiv');

        var m = '<table id=tcoThroneQueue width=100%>';
        m += '<tr><th width=10%>Remove</th>';
        m += '<th width=5%>Order</th>';
        m += '<th width=8%>Status</th>';
        m += '<th width=25%>Item</th>';
        m += '<th width=5%>Action</th>';
        m += '<th width=5%>Max</th>';
        m += '<th width=40%>Status/Last Upgrade/Attempts</th></tr>';

        for (var queueIndex = 0; queueIndex < tcoThroneQueueData.list.length; queueIndex++) {
            var queueItem = tcoThroneQueueData.list[queueIndex];
            if (!queueItem) continue;
            var throneItem = uW.kocThroneItems[queueItem.item];

            var throneCardName = "Unknown / Item removed";
            var throneId = 0;

            if (throneItem) {
                throneCardName = throneItem.name;
                throneId = throneItem.id;
            }

            m += '<tr>';
            m += '<td align=center><div id=tcoThroneQueueRemove' + queueIndex + ' class=tcoRemove></div></td>';
            m += '<td align=center><div id=tcoThroneUpRow' + queueIndex + ' class=tcoUpRow></div><div class=tcoDownRow  id=tcoThroneDownRow' + queueIndex + '></div></td>';
            m += '<td align=center><div id=tcoThroneState' + queueIndex + '></div></td>';
            m += '<td align=center class=tcoThroneUpdaterItemName><div id=tcoThroneUpdaterItem' + throneId + ' >' + throneCardName + '</div></td>';
            m += '<td align=center>' + queueItem.action + '</td>';
            m += '<td>';
            if (queueItem.action == "enhance") {
                m += '<div style="text-align: center;"><select class=tcoSelect id=tcoThroneChangeLevel' + queueIndex + ' style="width:90px; text-align: center;">';
                for (qual = 1; qual <= tcoMaxThroneQuality; qual++) {
                    m += '<option value="' + qual + '" ' + (queueItem.level == qual ? 'selected' : '') + '>' + throneCardQualities[qual] + '</option>';
                }
                m += '</select></div>';
            } else {
                m += '<div style="text-align: center;"><select class=tcoSelect id=tcoThroneChangeLevel' + queueIndex + ' style="width:90px; text-align: center;">';
                for (lvl = 1; lvl <= tcoMaxThroneLevel; lvl++) {
                    m += '<option value="' + lvl + '"  ' + (queueItem.level == lvl ? 'selected' : '') + '> +' + lvl + '</option>';
                }
                m += '</select></div>';
            }
            m += '</td>';

            m += '<td style="text-align: center; white-space: pre-wrap;">' + queueItem.status + ' / ';
            if (queueItem.lastUpgrade) m += queueItem.lastUpgrade;
            m += ' / ' + queueItem.triesThis + ' tries this level, ' + queueItem.triesTotal + ' tries total';
            m += '</td>';

            m += '</tr>';
        }
        m += '</table>';

        tcoThroneQDiv.innerHTML = m;

        for (var queueIndex = 0; queueIndex < tcoThroneQueueData.list.length; queueIndex++) {
            var queueItem = tcoThroneQueueData.list[queueIndex];
            if (!queueItem) continue;
            var throneItem = uW.kocThroneItems[queueItem.item];

            if (throneItem) {
                var trId = throneItem.id;

                document.getElementById('tcoThroneUpdaterItem' + trId).addEventListener('mouseover', function(A) {
                    A.stopPropagation();
                    var throneId = this.id.split('tcoThroneUpdaterItem')[1];
                    var throneItem = uW.kocThroneItems[throneId];
                    var tcoCard = document.getElementById('tcoThroneUpdaterItem' + throneId);
                    CM.ThroneView.hoverItem(A, tcoCard, throneItem);
                }, false);
            }

            document.getElementById('tcoThroneQueueRemove' + queueIndex).setAttribute('v1', queueIndex);
            document.getElementById('tcoThroneQueueRemove' + queueIndex).addEventListener('click', function () {
                var qIndex = this.getAttribute('v1');
                t.deleteQueueItem(qIndex);
            }, false);

            document.getElementById('tcoThroneUpRow' + queueIndex).setAttribute('v1', queueIndex);
            document.getElementById('tcoThroneUpRow' + queueIndex).addEventListener('click', function () {
                var qIndex = this.getAttribute('v1');
                t.moveUpRow(qIndex);
            }, false);

            document.getElementById('tcoThroneDownRow' + queueIndex).setAttribute('v1', queueIndex);
            document.getElementById('tcoThroneDownRow' + queueIndex).addEventListener('click', function () {
                var qIndex = this.getAttribute('v1');
                t.moveDownRow(qIndex);
            }, false);

            document.getElementById('tcoThroneChangeLevel' + queueIndex).setAttribute('v1', queueIndex);
            document.getElementById('tcoThroneChangeLevel' + queueIndex).addEventListener('change', function () {
                var qIndex = this.getAttribute('v1');
                var itemLevel = this.value;
                t.changeLevel(qIndex, itemLevel);
            }, false);
            
            if (!throneItem || !(throneItem.id)) {
                document.getElementById('tcoThroneState' + queueIndex).innerHTML = '<div style="text-align:center"> ??</div>';
            } else if (queueItem.status == "complete") {
                document.getElementById('tcoThroneState' + queueIndex).className = 'tcoSuccess';
            } else if (throneItem.isBroken) {
                if (throneItem.id == t.repairId) {
                    document.getElementById('tcoThroneState' + queueIndex).className = 'tcoHammer';
                } else {
                    document.getElementById('tcoThroneState' + queueIndex).className = 'tcoBroken';
                }
            } else {
                document.getElementById('tcoThroneState' + queueIndex).innerHTML = '<div class=tcoGoButton></div>';
            }
        }
    },

    deleteQueueItem: function (index) {
        // delete an item from the queue
        var t = Tabs.throneUpgrader;
        tcoThroneQueueData.list.splice(index, 1);
        if (index > tcoThroneQueueData.index) tcoThroneQueueData.index--;
        SAVEtcoThroneQueueData();
        t.buildThroneQueueDisplay();
    },

    moveUpRow: function (index) {
        if (index < 1) return;
        var t = Tabs.throneUpgrader;
        var qItem = tcoThroneQueueData.list.splice(index, 1);
        tcoThroneQueueData.list.splice(index - 1, 0, qItem[0]);

        if (index == tcoThroneQueueData.index)
            tcoThroneQueueData.index--;
        else if (tcoThroneQueueData.index == index - 1)
            tcoThroneQueueData.index++;

        SAVEtcoThroneQueueData();
        t.buildThroneQueueDisplay();
    },

    moveDownRow: function (index) {
        if (index > (tcoThroneQueueData.list.length - 2)) return;

        var t = Tabs.throneUpgrader;
        var qItem = tcoThroneQueueData.list.splice(index, 1);
        tcoThroneQueueData.list.splice(index + 1, 0, qItem[0]);

        if (index == tcoThroneQueueData.index)
            tcoThroneQueueData.index++;
        else if (tcoThroneQueueData.index == index + 1)
            tcoThroneQueueData.index--;

        SAVEtcoThroneQueueData();
        t.buildThroneQueueDisplay();

    },

    changeLevel: function (index, level) {
        var t = Tabs.throneUpgrader;
        
        var queueItem = tcoThroneQueueData.list[index];
        if (!queueItem) return;

        queueItem.level = level;
        if (queueItem.status == "complete") queueItem.status = "started";
        SAVEtcoThroneQueueData();
        t.buildThroneQueueDisplay();
    },

    setStatus: function (s) {
        document.getElementById('tcoThroneUpgradeStatus').innerHTML = '<div>' + s + '</div>';
    },

    setResult: function (s) {
        document.getElementById('tcoThroneLastResult').innerHTML = '<div>' + s + '</div>';
    },

    togglePower: function (obj) {
        var t = Tabs.throneUpgrader;
        
        if (!tcoThroneUpgradeData.active && tcoThroneRepairData.active) {
            alert('You must disable repair tab first');
            return;
        }

        var btn = document.getElementById('tcoThroneUpgradePower');
        if (tcoThroneUpgradeData.active) {
            tcoThroneUpgradeData.active = false;
            btn.value = 'Upgrader = OFF';
            t.setStatus('Powered Off');
            t.setResult('');

        } else {
            tcoThroneUpgradeData.active = true;
            btn.value = "Upgrader = ON";
            t.setStatus("Powered On");
            t.setResult("");
        }

        if (!tcoThroneUpgradeData.active) {

        }

        t.updateThroneMenu();
        SAVEtcoThroneUpgradeData();
    },

    updateThroneMenu: function () {
        if (!document.getElementById('tcoExecuteUpgrader')) return;
        document.getElementById('tcoExecuteUpgrader').innerHTML = 'Upgrade ' + (tcoThroneUpgradeData.active ? 'ON' : 'OFF');
    },
}

Tabs.throneSalvager = {
	tabOrder: 100,
	tabLabel: 'SALVAGER',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM SALVAGER',
    delItems: [],
    deleting: false,
    rowNum: 0,
    timer: null,
    city: null,
    cityNum: 0,
    sTimer: null,
    delTimer: null,
    upgradeProfit: true,
	
	init: function (div) {
		var t = Tabs.throneSalvager;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        
		m += '<div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        if (tcoThroneSalvageData.active) {
            m += '<td width=33%><input id=tcoThroneSalvagePower type=button class=tcoButton value="Salvager = ON"></td>';
        } else {
            m += '<td width=33%><input id=tcoThroneSalvagePower type=button class=tcoButton value="Salvager = OFF"></td>';
        }        
        m += '<td width=33%><div class=divNoWrap align=center>';
        m += 'Keep All: <select id=tcoThroneSalvageQuality class=tcoSelect>';
        for (i = 1; i <= tcoMaxThroneQuality-1; i++) {
            m += '<option value="' + i + '">' + throneCardQualities[i].capitalizeFirstLetter() + '+</option>';
        }
        m += '</select>';
        m += '</div></td>';
        m += '<td width=33%><div class=divNoWrap>Keep First <input style="text-align: center;" id=tcoThroneSaveNum class=tcoTextbox type=text size=3 maxlength=3 value="' + tcoThroneSalvageData.throneSaveNum + '"/> Items</div></td>';
        m += '</tr>';
        m += '<tr><td colspan=3><hr class=tcoHRCenter></td></tr>';
        m += '<tr><td colspan=3><div class=indent5 id=tcoThroneSalvageStatus></div></td></tr>';
        m += '<tr><td colspan=3><div class=indent5 id=tcoThroneNumSalv><br></div></td></tr>';
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader id=tcoThroneSimpleRule onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;SIMPLE RULES&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="position: static; width: 100%; height: 200px; overflow-x: hidden; overflow-y: auto;">';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td>';
        m += '<table>';
        m += '<tr><td><b>Define Throne Items To Keep:</b></td>';
        m += '<td alight=left><div><span>Faction: <select id=tcoThroneFactionType class=tcoSelect>';
        m += '  <option value="any">Any</option>';
        for (var fact in tcoFactions) m += '<option value="' + tcoFactions[fact] + '">' + tcoFactions[fact].capitalizeFirstLetter() + '</option>';
        m += '</select></span></div></td>';
        m += '<td alight=left><div><span>Card Type: <select id=tcoThroneCardType class=tcoSelect>';
        m += '  <option value="any">Any</option>';
        for (tct = 0; tct < throneCardTypes.length; tct++) m += '  <option value="' + throneCardTypes[tct] + '">' + throneCardTypes[tct].capitalizeFirstLetter() + '</option>';
        m += '</select></span></div></td>';
        m += '<td align=right><input id=tcoThroneAddRule type=button class=tcoButton value="Create Rule"/></td>';
        m += '</tr>';
        m += '</table>';
        m += '</td></tr>';
        m += '<tr><td>';
        m += '<table id=tcoThroneConditionTable style="padding-left: 5px;">';
        m += '<tr><td align=left colspan=1><input id=tcoThroneAddRow type=button class=tcoButton value="Add Row"/></td>';
        m += '<td></td><td></td><td></td><td></td><td></td></tr>';
        m += '</table>';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>';   //end of tcoSection
        
        m += '<div class=tcoHeader id=tcoThroneAdvancedRule onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;ADVANCED RULES&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td>';
        m += '<table>';
        m += '<tr><td colspan=4><input class=tcoButton type=button id=tcoThroneAdvancedReset value="Reset"></tr>';
        m += '<tr>';
        m += '<td><b>Define Throne Items To Keep:</b></td>';
        m += '<td alight=left><div><span>Faction: <select id=tcoThroneFactionTypeAdvanced class=tcoSelect>';
        m += '  <option value="any">Any</option>';
        for (var fact in tcoFactions) m += '<option value="' + tcoFactions[fact] + '">' + tcoFactions[fact].capitalizeFirstLetter() + '</option>';
        m += '</select></span></div></td>';
        m += '<td alight=left><div><span>Card Type: <select id=tcoThroneCardTypeAdvanced class=tcoSelect>';
        m += '  <option value="any">Any</option>';
        for (tct = 0; tct < throneCardTypes.length; tct++) m += '  <option value="' + throneCardTypes[tct] + '">' + throneCardTypes[tct].capitalizeFirstLetter() + '</option>';
        m += '</select></span></div></td>';
        m += '<td align=right><input id=tcoThroneAddRuleAdvanced type=button class=tcoButton value="Create Rule"/></td>';
        m += '</tr>';
        m += '</table>';
        m += '</td></tr>';
        m += '<tr><td>';
        m += '<table width=100% id=tcoThroneConditionTableAdvanced>';
        m += '<tr>';
        m += '<td width=20%>ROW 1</td>';
        m += '<td width=20%>ROW 2</td>';
        m += '<td width=20%>ROW 3</td>';
        m += '<td width=20%>ROW 4</td>';
        m += '<td width=20%>ROW 5</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoThroneRow1Advanced class=tcoSelect></select></div></td>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoThroneRow2Advanced class=tcoSelect></select></div></td>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoThroneRow3Advanced class=tcoSelect></select></div></td>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoThroneRow4Advanced class=tcoSelect></select></div></td>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoThroneRow5Advanced class=tcoSelect></select></div></td>';
        m += '</tr>';
        m += '</table>';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>';   //end of tcoSection
        
        m += '<div class=tcoHeader id=tcoThroneAdvancedRule onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;AUTO LOAD RULES&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';

        m += '<tr><td><b>&nbsp;Define Effect:</b><select id=tcoThroneAutoLoadEffect class=tcoSelect>';
        m += '<option value="0">--Select--</option>';
        for (var efx in CM.thronestats.effects) m += '<option value="' + efx + '">' + CM.thronestats.effects[efx][1] + '</option>';
        m += '</select><input type=button class=tcoButton id=tcoThroneAutoLoad value="Auto Load">';
        m += '</td></tr>';

        m += '</table>';
        m += '</div>';

        m += '<div class=tcoHeader>&nbsp;RULES LIST&nbsp;</div>';
        
        m += '<div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td align=center>';
        m += 'Sort By Card Type: <select id=tcoThroneSalvageSortCard class=tcoSelect>';
        m += '<option value="0">--Select--</option>';
        for (tct = 0; tct < throneCardTypes.length; tct++) m += '  <option value="' + throneCardTypes[tct] + '">' + throneCardTypes[tct].capitalizeFirstLetter() + '</option>';
        m += '</select>';
        m += '</td></tr>';
        m += '<tr><td align=center>';
        m += '<b>Salvager Will Keep Items Matching These Rules <i><div class=divNoWrap id=tcoThroneRuleCount></div></i></b>';
        m += '</td></tr>';
        m += '<tr><td align=center>';
        m += '<div align=center>';
        m += '<table align=center width=100%>';
        m += '<tr>';
        m += '<td align=left><input id=tcoThroneButtonSaveItem type=button class=tcoButton value="Save Rules">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
        m += '<input id=tcoThroneClearAllRules type=button class=tcoButton value="Clear All Rules"></td>';
        m += '<td align=right>'
        m += '<input id=tcoThroneButtonLoadItem type=button class=tcoButton value="Load Rules">';
        m += '<input class=tcoButton type=button id=tcoThroneFileDrop onclick="document.getElementById(\'tcoThroneFileLoadItem\').click()" value="Browse...">';
        m += '<input id=tcoThroneFileLoadItem style="visibility: hidden; height:0px; width: 0px;" type=file>';
        m += '</td>';
        m += '</tr>';
        m += '</table>';
        m += '</div>';
        m += '</td></tr>';
        m += '<tr><td align=center>';
        m += '<div id=tcoThroneRuleScroll style="position: static; width: 100%; height: ' + dlgHeight + '; overflow-x: hidden; overflow-y: auto;" >';
        m += '<div id=tcoThroneRuleDisplay></div>';
        m += '</div>';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>'; //end of tcoSection
        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        t.displayNumberSalvaged();

        if (tcoThroneSalvageData.active)
            t.setStatus('Loading...');
        else
            t.setStatus('Powered Off');

        document.getElementById('tcoThroneClearAllRules').addEventListener('click', function() {
            tcoThroneSalvageData.ruleSet = [];
            SAVEtcoThroneSalvageData();
            t.buildThroneRuleDisplay();
        }, false);

        document.getElementById('tcoThroneAutoLoad').addEventListener('click', function () {
            var effectId = document.getElementById('tcoThroneAutoLoadEffect').value;
            if (effectId == 0) return;
            for (var category in tcoThroneStatsGrid) {
                var faction = 'any';
                var type = category;
                var conditions = [];
                for (var i = 1; i < 6; i++) {
                    if (tcoThroneStatsGrid[category][i][effectId] == 1) {
                        var slots = [];
                        for (var slotChecker = 1; slotChecker < 6; slotChecker++) slots.push(slotChecker==i);
                        var effectName = CM.thronestats.effects[effectId][1];
                        var buffDebuff = 'b';
                        if (effectName.indexOf(" Debuff") != -1) buffDebuff = "d";
                        var effectName = effectName.split(" Debuff")[0];
                        var c = new ThroneCondition(true, 1, effectName, buffDebuff, slots);
                        conditions.push(c);
                    }
                }
                if (conditions.length > 0) {
                    var rule = new ThroneRule(type, faction, conditions, true);
                    t.addRule(rule);
                }
            }
            SAVEtcoThroneSalvageData();
            t.buildThroneRuleDisplay();
        }, false);

        document.getElementById('tcoThroneSalvagePower').addEventListener('click', function () { 
            t.togglePower(this);
        }, false);

        t.createRow();

        t.buildThroneRuleDisplay();

        document.getElementById('tcoThroneSalvageSortCard').addEventListener('change', function() { 
            t.buildThroneRuleDisplay();
        }, false);

        document.getElementById('tcoThroneAddRow').addEventListener('click', function () {
            t.createRow();
        }, false);

        document.getElementById('tcoThroneSalvageQuality').addEventListener('click', function () {
            t.setSalvageQuality(this.value);
        }, false);

        document.getElementById('tcoThroneSalvageQuality').value = tcoThroneSalvageData.minQuality;

        document.getElementById('tcoThroneSaveNum').addEventListener('change', function () {
            tcoThroneSalvageData.throneSaveNum = parseInt(document.getElementById('tcoThroneSaveNum').value);
            if (tcoThroneSalvageData.throneSaveNum < 0) tcoThroneSalvageData.throneSaveNum = 0;
            SAVEtcoThroneSalvageData();
        }, false);
        
        document.getElementById('tcoThroneAdvancedReset').addEventListener('click', function() {
            var cardtype = document.getElementById('tcoThroneCardTypeAdvanced');
            cardtype.selectedIndex = 0;
            t.clearAdvancedStats();
            t.setAdvancedStatsToAny();
        }, false);

        t.setAdvancedStatsToAny();

        document.getElementById('tcoThroneAddRuleAdvanced').addEventListener('click', function() { 
            t.createAdvancedRule();
        }, false);

        document.getElementById('tcoThroneCardTypeAdvanced').addEventListener('change', function() {
            var selectedValue = document.getElementById('tcoThroneCardTypeAdvanced').value;
            t.clearAdvancedStats();
            if (selectedValue == 'any') { 
                t.setAdvancedStatsToAny();
            } else {
                t.filterAdvancedStats(selectedValue);
            }
        }, false);

        document.getElementById('tcoThroneAddRule').addEventListener('click', function () {
            t.createRule();
        }, false);


        document.getElementById('tcoThroneButtonSaveItem').addEventListener('click', function () {
            var uriContent = 'data:application/octet-stream,' + encodeURIComponent(JSON.stringify(tcoThroneSalvageData.ruleSet));
            var newWindow = window.open(uriContent, 'file.txt');
        }, false);


        document.getElementById('tcoThroneButtonLoadItem').addEventListener('click', function () {
            var fileInput = document.getElementById("tcoThroneFileLoadItem");
            var files = fileInput.files;
            if (files.length == 0) {
                alert('Please Select A File');
                return;
            }
            var file = files[0];

            var reader = new FileReader();

            reader.onload = function (e) {
                var output = e.target.result;
                tcoThroneSalvageData.ruleSet = JSON.parse(output);
                tcoThroneSalvageData.active = false;
                clearInterval(Tabs.throneSalvager.sTimer);
                clearInterval(Tabs.throneSalvager.delTimer);
                Tabs.throneSalvager.deleting = false;
                SAVEtcoThroneSalvageData();
                Tabs.throneSalvager.show();
                alert('Throne Salvage Settings Now Loaded From File');
            };
            reader.readAsText(file);

        }, false);


        if (tcoThroneSalvageData.upgradedToDelete.length > 0) {
            // some items were left over that need to be deleted 
            for (k = 0; k < tcoThroneSalvageData.upgradedToDelete.length; k++) {
                var id = tcoThroneSalvageData.upgradedToDelete[k];
                // if the item is not longer in the inventory, remove the id
                if (!uW.kocThroneItems[id]) {
                    tcoThroneSalvageData.upgradedToDelete.splice(k, 1); // Remove item from array
                    SAVEtcoThroneSalvageData();
                    k--;
                }
            }

            // resume deleting things
            if (tcoThroneSalvageData.active) {
                t.delItems = tcoThroneSalvageData.upgradedToDelete;
                t.deleting = true;
                t.upgradeAndDelete();
            }
            else {
                // if the salvager is Powered Off, clear the list
                tcoThroneSalvageData.upgradedToDelete = [];
                SAVEtcoThroneSalvageData();
            }
        }
        // this check makes sure upgrading before deleting is still profitable
        t.upgradeProfit = (5 * CM.WorldSettings.getSettingAsNumber("AETHERSTONE_SALVAGE_MULTIPLIER", 500) > CM.thronestats.upgrade[1]["Stones"]);
        t.start();

	},
	
    setAdvancedStatsToAny: function() {
        for (var i = 1; i < tcoQualityCount; i++) {
            var row = document.getElementById('tcoThroneRow' + i + 'Advanced');
            row.options.add(new Option("none","None"));
            for (eff in CM.thronestats.effects) {
                var effectName = CM.thronestats.effects[eff][1];
                row.options.add(new Option(effectName, effectName));
            }                
            row.options.add(new Option("Any Infantry", "Infantry"));
            row.options.add(new Option("Any Ranged", "Ranged"));
            row.options.add(new Option("Any Horsed", "Horsed"));
            row.options.add(new Option("Any Siege", "Siege"));
            row.options.add(new Option("Any Spellcaster", "Spellcaster"));
            row.options.add(new Option("Any Tower", "Tower"));
        }
    },

    clearAdvancedStats: function() {
        for (var i = 1; i < tcoQualityCount; i++) {
            var row = document.getElementById('tcoThroneRow' + i + 'Advanced');
            row.innerHTML = "";
        }
    },

    filterAdvancedStats: function(cardtype) {
        var t = Tabs.throneSalvager;
        cardtype = cardtype || 'any';

        if (cardtype == 'any') {
            t.setAdvancedStatsToAny();
            return;
        }

        document.getElementById("tcoThroneRow1Advanced").options.add(new Option("none", "none"));
        document.getElementById("tcoThroneRow2Advanced").options.add(new Option("none", "none"));
        document.getElementById("tcoThroneRow3Advanced").options.add(new Option("none", "none"));
        document.getElementById("tcoThroneRow4Advanced").options.add(new Option("none", "none"));
        document.getElementById("tcoThroneRow5Advanced").options.add(new Option("none", "none"));

        for (eff in CM.thronestats.effects) {
            var effectName = CM.thronestats.effects[eff][1];
            if (tcoThroneStatsGrid[cardtype][1][eff]) { document.getElementById("tcoThroneRow1Advanced").options.add(new Option(effectName, effectName)); }
            if (tcoThroneStatsGrid[cardtype][2][eff]) { document.getElementById("tcoThroneRow2Advanced").options.add(new Option(effectName, effectName)); }
            if (tcoThroneStatsGrid[cardtype][3][eff]) { document.getElementById("tcoThroneRow3Advanced").options.add(new Option(effectName, effectName)); }
            if (tcoThroneStatsGrid[cardtype][4][eff]) { document.getElementById("tcoThroneRow4Advanced").options.add(new Option(effectName, effectName)); }
            if (tcoThroneStatsGrid[cardtype][5][eff]) { document.getElementById("tcoThroneRow5Advanced").options.add(new Option(effectName, effectName)); }
        }
    },

	hide: function () {},
	
	show: function () {
		var t = Tabs.throneSalvager;
        t.displayNumberSalvaged();
        t.buildThroneRuleDisplay();
	},

    updateThroneMenu: function () {
        if (!document.getElementById('tcoExecuteSalvager')) return;
        document.getElementById('tcoExecuteSalvager').innerHTML = 'Salvager ' + (tcoThroneSalvageData.active ? 'ON' : 'OFF');
    },

    forceSalvage: function (throneId) {
        throneId = throneId || false;
        if (!throneId) return;
        var throneItem = uW.kocThroneItems[throneId];
        if (!throneItem) return;
        if (throneItem.jewel) {
            var city_num = pickAetherSalvageCity();
            var city_id = Seed.cities[city_num][0];
            Tabs.tcoJewels.removeJewel(city_id, throneId);
        }
        SalvageThroneItem(throneId);
        CM.ThroneView.renderInventory(uW.kocThroneItems);
    },

    doDelete: function (id) {

        var t = Tabs.throneSalvager;
        if (!tcoThroneSalvageData.active || !t.deleting) {
            t.deleting = false;
            return;
        }

        var item = uW.kocThroneItems[id];
        if (item == null || !item) return;

        if (item) t.setStatus('Salvaging ' + item.name);

        SalvageThroneItem(id);

    },

    removeItem: function (id, cityId, numStones) {

        var throne_item = uW.kocThroneItems[id];
        if (throne_item == null || !throne_item) return;

        var c = +(Seed.resources["city" + cityId]["rec5"][0]);
        var b = Seed.throne.slotEquip;

        Seed.resources["city" + cityId]["rec5"][0] = c + numStones;
        jQuery.each(b, function (g, h) {
            a = jQuery.inArray(id, h);
            if (a > -1) {
                h.splice(a, 1)
            }
        });

        delete uW.kocThroneItems[id];
        CM.ThroneView.renderInventory(uW.kocThroneItems);
    },

    // update items to +1 before deleting
    upgradeAndDelete: function () {
        var t = Tabs.throneSalvager;

        if (!tcoThroneSalvageData.active || t.delItems.length == 0) {
            t.deleting = false;
            return;
        }

        var id = +t.delItems[0];

        // since simple +0 can be upgrade w/ near 100% success for 1500 a-stone and then salvaged for 2150
        // upgrade all these items 1 level
        if (tcoThroneSalvageData.upgradeFirst && t.upgradeProfit) {

            var throne_item = uW.kocThroneItems[id];
            if (throne_item) {
                if (throne_item.quality <= tcoThroneSalvageData.upgradeFirstQual && throne_item.level == 0
                            && (tcoThroneSalvageData.upgradedToDelete.indexOf(id) < 0)) {
                    tcoThroneSalvageData.upgradedToDelete.push(id);
                    SAVEtcoThroneSalvageData();
                    Tabs.throneUpgrader.doUpgrade(+id, true);
                }
            }
            else {
                //item not found
            }
        }
        // delete the item
        t.delTimer = setTimeout(function () { t.doDelete(id) }, 4000);
    },

    // returns true if the item should be saved and not salvaged
    applyRules: function (id) {
        var t = Tabs.throneSalvager;
        for (r in tcoThroneSalvageData.ruleSet) {
            var rule = tcoThroneSalvageData.ruleSet[r];
            if (rule.ThroneApplyRule(id)) return true;
        }
        return false;
    },

    // Create the list of items to delete.
    // If 'test' is set to true, then broken/equipted items are included.
    buildList: function (test) {
        var t = Tabs.throneSalvager;

        var throneSaveNum = tcoThroneSalvageData.throneSaveNum;
        var countItem = 0;
        var retList = [];

        for (k in uW.kocThroneItems) {
            var throne_item = uW.kocThroneItems[k];

            if (throne_item == null || !throne_item) continue;

            countItem++;

            // ignore these things
            if (throne_item.level != 0) continue;

            // in test mode, include these items
            // These items are at risk if they are repaired or unequiped.
            if (test != true) {
                if (throne_item.isEquipped) continue;
                if (throne_item.isBroken) continue;
            }

            // keep the first X items
            if (countItem <= throneSaveNum) continue;

            // keep things w/ at least minQuality
            if (throne_item.quality >= tcoThroneSalvageData.minQuality) continue;

            // check the rules
            if (t.applyRules(throne_item.id)) continue;

            // passes all tests
            retList.push(throne_item.id);
        }
        return retList;
    },

    // do the actual discard of TR items
    doSalvage: function () {
        var t = Tabs.throneSalvager;

        if (!tcoThroneSalvageData.active) {
            t.deleting = false;
            return;
        }

        if (t.deleting == true) return;

        t.deleting = true;
        t.setStatus('Salvaging items');

        t.delItems = t.buildList(false);

        if (t.delItems.length > 0) {
            // upgrade items from +0 to +1 first
            t.upgradeAndDelete();
        } else {
            // give enough time for the last delete to finish
            setTimeout(function () {
                t.deleting = false;
                t.setStatus('No items to salvage.  Waiting for next cycle.');
            }, 3000);
        }
    },

    start: function () {
        var t = Tabs.throneSalvager;
        if (tcoThroneSalvageData.active) {
            t.sTimer = setInterval(t.doSalvage, 1 * 60 * 1000);
        }
    },

    addRule: function (rule) {
        tcoThroneSalvageData.ruleSet.unshift(rule);
        SAVEtcoThroneSalvageData();
    },

    readRows: function () {
        var t = Tabs.throneSalvager;
        var table = document.getElementById('tcoThroneConditionTable');
        var rowCount = table.rows.length;

        var cType = document.getElementById('tcoThroneCardType').value;
        var faction = document.getElementById('tcoThroneFactionType').value;

        var conditions = [];
        for (i = 0; i < table.rows.length; i++) {
            var row = table.rows[i];
            if (row.id) {
                var s1 = document.getElementById(row.id + "ThroneSel1");
                var s2 = document.getElementById(row.id + "ThroneSel2");
                var s3 = document.getElementById(row.id + "ThroneSel3");
                var s4 = document.getElementById(row.id + "ThroneSel4");

                var slots = [];
                for (j = 1; j <= 5; j++) {
                    var ch = document.getElementById(row.id + "ThroneSlot" + j);
                    slots.push(ch.checked);
                }

                var c = new ThroneCondition(s1.value, s2.value, s3.value, s4.value, slots);
                conditions.push(c);
            }
        }
        var rule1 = new ThroneRule(cType, faction, conditions, false);
        t.addRule(rule1);
    },

    readAdvancedRows: function () {
        var t = Tabs.throneSalvager;
        var cType = document.getElementById('tcoThroneCardTypeAdvanced').value;
        var faction = document.getElementById('tcoThroneFactionTypeAdvanced').value;
        var conditions = [];
        for (var i = 1; i < 6; i++) {
            var row = document.getElementById("tcoThroneRow" + i + "Advanced");
            if (row.selectedIndex == 0) continue;
            var slots = [];
            for (var slotChecker = 1; slotChecker < 6; slotChecker++) {
                slots.push(slotChecker==i);
            }
            var effectName = row.options[row.selectedIndex].value;
            var buffDebuff = "b";
            if (effectName.indexOf(" Debuff") != -1) buffDebuff = "d";
            var effectName = effectName.split(" Debuff")[0];
            var c = new ThroneCondition(true, 1, effectName, buffDebuff, slots);
            conditions.push(c);
        }
        if ( conditions.length > 0 ) {
            var rule1 = new ThroneRule(cType, faction, conditions, true);
            t.addRule(rule1);
        }
    },

    createRule: function () {
        var t = Tabs.throneSalvager;
        t.readRows();
        t.buildThroneRuleDisplay();
    },

    createAdvancedRule: function() {
        var t = Tabs.throneSalvager;
        t.readAdvancedRows();
        t.buildThroneRuleDisplay();  
    },

    setSalvageQuality: function (qual) {
        tcoThroneSalvageData.minQuality = qual;
        SAVEtcoThroneSalvageData();
    },

    buildThroneRuleDisplay: function () {
        var t = Tabs.throneSalvager;

        function innerThroneRuleDisplay(dataset) {
            var innerM = '';
            for (i = 0; i < dataset.length; i++) {
                var rule = dataset[i];

                innerM += '<tr>';
                innerM += '<td width=90%><div class=tcoThroneRule>';

                innerM += (rule.advancedrule ? 'Advanced Rule<br>' : 'Simple Rule<br>');

                innerM += ' Type: ' + rule.type;
                innerM += ' Faction: ' + rule.faction;

                for (ii = 0; ii < rule.conditions.length; ii++) {
                    var condition = rule.conditions[ii];

                    if (ii == 0)
                        innerM += '<br> Item';
                    else
                        innerM += '<br> <u>and</u>';

                    if (condition.mustHave != 'false')
                        innerM += ' must have ';
                    else
                        innerM += ' must NOT have ';

                    innerM += condition.number + 'x ';
                    innerM += condition.effect + ' ';

                    if (condition.buffType == 'b')
                        innerM += 'buff ';
                    else if (condition.buffType == 'd')
                        innerM += 'debuff ';
                    else
                        innerM += 'buff or debuff ';

                    innerM += ' in slot(s): ';

                    for (j = 0; j < condition.slots.length; j++) {
                        if (condition.slots[j]) innerM += (j + 1) + " ";
                    }

                }
                innerM += '</div></td>';
                innerM += '<td width=20% align=center>';
                innerM += '<input id=tcoThroneEditRule' + i + ' class=tcoButton type=button value="Edit">';
                innerM += '<input id=tcoThroneDelRule' + i + ' class=tcoButton type=button value="X">';
                innerM += '</td>';
                innerM += '</tr>';
            }
            return innerM;
        }

        var rd = document.getElementById('tcoThroneRuleDisplay');
        var sortType = document.getElementById('tcoThroneSalvageSortCard').value; 

        var ruleCounter = 0;

        if (sortType != "0") {
            var sortedDataSet = [];
            for (var k = 0; k < tcoThroneSalvageData.ruleSet.length; k++) {
                if (sortType == tcoThroneSalvageData.ruleSet[k].type) {
                    sortedDataSet.unshift(tcoThroneSalvageData.ruleSet[k]);
                }else {
                    sortedDataSet.push(tcoThroneSalvageData.ruleSet[k]);
                }
            }
            rd.innerHTML = '<table width=100%>' + innerThroneRuleDisplay(sortedDataSet);
            ruleCounter = sortedDataSet.length;
            for (var j = 0; j < sortedDataSet.length; j++) {
                document.getElementById('tcoThroneDelRule' + j).v1 = j;
                document.getElementById('tcoThroneEditRule' + j).v1 = j;
                document.getElementById('tcoThroneDelRule' + j).addEventListener('click', function () { t.deleteRule(this.v1, sortedDataSet); }, false);
                document.getElementById('tcoThroneEditRule' + j).addEventListener('click', function () { t.editRule(this.v1, sortedDataSet); }, false);
            }
        } else {
            ruleCounter = tcoThroneSalvageData.ruleSet.length;
            rd.innerHTML = '<table width=100%>' + innerThroneRuleDisplay(tcoThroneSalvageData.ruleSet);
            for (var j = 0; j < tcoThroneSalvageData.ruleSet.length; j++) {
                document.getElementById('tcoThroneDelRule' + j).v1 = j;
                document.getElementById('tcoThroneEditRule' + j).v1 = j;
                document.getElementById('tcoThroneDelRule' + j).addEventListener('click', function () { t.deleteRule(this.v1, tcoThroneSalvageData.ruleSet); }, false);
                document.getElementById('tcoThroneEditRule' + j).addEventListener('click', function () { t.editRule(this.v1, tcoThroneSalvageData.ruleSet); }, false);
            }
        }

        document.getElementById('tcoThroneRuleCount').innerHTML = '(Total Rules: ' + ruleCounter + ')';

    },

    editRule: function (ruleIndex, sortedData)
    {
        var t = Tabs.throneSalvager;
        var rule = sortedData[ruleIndex];

        var divExpander = null;

        if (rule.advancedrule)
            divExpander = document.getElementById('tcoThroneAdvancedRule');
        else 
            divExpander = document.getElementById('tcoThroneSimpleRule');

        divExpander.click();
        if (divExpander.childNodes[0].src == tcoRightArrow) divExpander.click();

        if (rule.advancedrule) {
            document.getElementById('tcoThroneFactionTypeAdvanced').value = rule.faction;
            document.getElementById('tcoThroneCardTypeAdvanced').value = rule.type;
            t.clearAdvancedStats();
            if (rule.type == 'any')
                t.setAdvancedStatsToAny();
            else
                t.filterAdvancedStats(rule.type);

            for (row = 0; row < rule.conditions.length; row++) {
                var condition = rule.conditions[row];
                var slotNumber = 0;
                for (s = 0; s < condition.slots.length; s++) {
                    if (condition.slots[s]) slotNumber = s+1;
                }
                var cell = document.getElementById('tcoThroneRow' + slotNumber + 'Advanced');
                var tcoEffect = condition.effect;
                if (condition.buffType == 'd') tcoEffect += ' Debuff';
                cell.value = tcoEffect;
            }

        } else {
            document.getElementById('tcoThroneFactionType').value = rule.faction;
            document.getElementById('tcoThroneCardType').value = rule.type;
            var tcoThroneConditionTable = document.getElementById('tcoThroneConditionTable');
            while (tcoThroneConditionTable.rows.length > 1) tcoThroneConditionTable.deleteRow(0);
            for (row = 0; row < rule.conditions.length; row++) {
                var condition = rule.conditions[row];
                t.createRow();
                tcoThroneConditionTable = document.getElementById('tcoThroneConditionTable');
                tcoThroneConditionTable.rows[row].cells[0].children[0].value = condition.mustHave;
                tcoThroneConditionTable.rows[row].cells[1].children[0].value = condition.number;
                tcoThroneConditionTable.rows[row].cells[2].children[0].value = condition.effect;
                tcoThroneConditionTable.rows[row].cells[3].children[0].value = condition.buffType;
                var slotCells = tcoThroneConditionTable.rows[row].cells[4];
                for (s = 0; s < condition.slots.length; s++) {
                    if (condition.slots[s])
                        slotCells.children[s].checked = true;
                    else
                        slotCells.children[s].checked = false;
                }
            }
        }
        t.deleteRule(ruleIndex, sortedData);
    },

    // delete a rule from the ruleset
    deleteRule: function (ruleIndex, sortedData) {
        var t = Tabs.throneSalvager;
        sortedData.splice(ruleIndex, 1);
        var newDataSet = [];
        for (var i = 0; i < tcoThroneSalvageData.ruleSet.length; i++) {
            for (var i2 = 0; i2 < sortedData.length; i2++) {
                if (tcoThroneSalvageData.ruleSet[i] == sortedData[i2]) {
                    newDataSet.push(tcoThroneSalvageData.ruleSet[i]);
                    break;
                }
            }
        }
        tcoThroneSalvageData.ruleSet = newDataSet;
        SAVEtcoThroneSalvageData();
        t.buildThroneRuleDisplay();
    },

    removeRow: function (row) {
        var t = Tabs.throneSalvager;
        var table = document.getElementById('tcoThroneConditionTable');

        for (i = 0; i < table.rows.length; i++) {
            if (table.rows[i] == row) {
                table.deleteRow(i);
                break;
            }
        }
    },

    createRow: function () {
        var t = Tabs.throneSalvager;
        var table = document.getElementById('tcoThroneConditionTable');
        var rowCount = table.rows.length;
        var row = table.insertRow(rowCount - 1);
        var rowId = "r" + t.rowNum;
        t.rowNum += 1;
        row.id = rowId;

        var h = '<td> <select class=tcoSelect id="' + rowId + 'ThroneSel1"> <option value="true"></option><option value="false">NOT</option></select></td>';
        h += '<td> <select class=tcoSelect id="' + rowId + 'ThroneSel2">';
        h += '  <option value="1">1x</option>';
        h += '  <option value="2">2x</option>';
        h += '  <option value="3">3x</option>';
        h += '  <option value="4">4x</option>';
        h += '  <option value="5">5x</option>';
        h += '</select></td>';
        h += '<td> <select class=tcoSelect id="' + rowId + 'ThroneSel3">';
        h += '</select></td>';
        h += '<td> <select class=tcoSelect id="' + rowId + 'ThroneSel4">';
        h += '  <option value="e">Either</option>';
        h += '  <option value="b">Buff</option>';
        h += '  <option value="d">Debuff</option>';
        h += '</select></td>';

        h += '<td>';
        h += '  <input class=tcoCheckbox type=checkbox value="1" checked=true id="' + rowId + 'ThroneSlot1"/>1';
        h += '  <input class=tcoCheckbox type=checkbox value="2" checked=true id="' + rowId + 'ThroneSlot2"/>2';
        h += '  <input class=tcoCheckbox type=checkbox value="3" checked=true id="' + rowId + 'ThroneSlot3"/>3';
        h += '  <input class=tcoCheckbox type=checkbox value="4" checked=true id="' + rowId + 'ThroneSlot4"/>4';
        h += '  <input class=tcoCheckbox type=checkbox value="5" checked=true id="' + rowId + 'ThroneSlot5"/>5';
        h += '</td>';

        row.innerHTML = h;

        var effects = [];

        for (e in CM.thronestats.effects) {
            var effectName = CM.thronestats.effects[e][1].split(" Debuff")[0];
            if (effects.indexOf(effectName) < 0) effects.push(effectName);
        }

        var select = document.getElementById(rowId + "ThroneSel3");
        for (index in effects) {
            select.options.add(new Option(effects[index], effects[index]));
        }

        // add in options for troops specific effects
        select.options.add(new Option("Any Infantry", "Infantry"));
        select.options.add(new Option("Any Ranged", "Ranged"));
        select.options.add(new Option("Any Horsed", "Horsed"));
        select.options.add(new Option("Any Siege", "Siege"));
        select.options.add(new Option("Any Spellcaster", "Spellcaster"));
        select.options.add(new Option("Any Tower", "Tower"));

        var c = row.insertCell(5);
        //TODO: change to javascript
        var btn = $('<input class=tcoButton type=button value="X" />');
        $(btn).click(function () { t.removeRow(row); });
        $(c).append(btn);
    },

    togglePower: function (obj) {
        var t = Tabs.throneSalvager;
        if (tcoThroneSalvageData.active) {
            var btn = document.getElementById('tcoThroneSalvagePower');
            tcoThroneSalvageData.active = false;
            btn.value = "Salvager = OFF";
            t.setStatus('Powered Off');
            clearInterval(t.sTimer);
            clearInterval(t.delTimer);
            t.delItems = [];
            tcoThroneSalvageData.upgradedToDelete = [];
            t.deleting = false;
        } else {
            tcoThroneSalvageData.active = true;
            var btn = document.getElementById('tcoThroneSalvagePower');
            btn.value = "Salvager = ON";
            t.setStatus('Loading...');
            t.doSalvage();
            t.start();
        }
        SAVEtcoThroneSalvageData();
        t.updateThroneMenu();
    },

    // put out a status message on the trSavlStatus div
    setStatus: function (msg) {
        document.getElementById('tcoThroneSalvageStatus').innerHTML = msg;
    },

    displayNumberSalvaged: function () {
        var since = "";
        var rate = "";
        var now = new Date();

        if (!tcoThroneSalvageData.since) tcoThroneSalvageData.since = now.valueOf();

        var sinceD = new Date(tcoThroneSalvageData.since);

        since = sinceD.toDateString().substring(3, 10) + " " + sinceD.toLocaleTimeString();
        var duration = now.valueOf() - tcoThroneSalvageData.since + 1;
        duration = duration / 1000.0;
        rate = ' (' + addCommas(Math.round(tcoThroneSalvageData.numSalvagedItems2 / duration * 86400)) + ' per day)';

        var m = "";
        m += '<div style="text-align: center;">';
        m += addCommas(tcoThroneSalvageData.numSalvagedItems);
        m += ' items salvaged, ';
        m += addCommas(tcoThroneSalvageData.numSalvagedItems2);
        m += ' items since ' + since + rate;
        m += '<input id=tcoThroneTripOdometer class=tcoButton type=button value="<-- Reset" /></div>';

        document.getElementById('tcoThroneNumSalv').innerHTML = m;

        document.getElementById('tcoThroneTripOdometer').addEventListener('click', function () {
            Tabs.throneSalvager.tripOdometer();
        }, false);

    },

    tripOdometer: function () {
        tcoThroneSalvageData.numSalvagedItems2 = 0;
        var now = new Date();
        tcoThroneSalvageData.since = now.valueOf();
        SAVEtcoThroneSalvageData();
        Tabs.throneSalvager.displayNumberSalvaged();       
    },

}

Tabs.throneRepair = {
	tabOrder: 100,
	tabLabel: 'REPAIR',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM REPAIR',
    repairId: 0,
    repairEnd: 0,
    timerH: null,
    clearTimerH: null,
	
	init: function (div) {
		var t = Tabs.throneRepair;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '<div class=tcoSaveSettings id=tcoThroneRepairSaveSettings title="Save Repair Settings"></div><div class=tcoLoadSettings id=tcoThroneRepairLoadSettings title="Load Repair Settings"></div></div>';

        
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
		m += '<div>';

        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        if (tcoThroneRepairData.active) {
            m += '<td width=50%><input id=tcoThroneRepairPower type=button class=tcoButton value="Repair = ON"></td>';
        } else {
            m += '<td width=50%><input id=tcoThroneRepairPower type=button class=tcoButton value="Repair = OFF"></td>';
        }        
        m += '<td width=50%><div class=divNoWrap align=center id=tcoThroneRepairAetherDisplay></div></td>';
        m += '</tr>';
        m += '<tr><td colspan=2><hr class=tcoHRCenter></td></tr>';
        m += '<tr><td colspan=2><div class=indent5 id=tcoThroneRepairStatus><br></div></td></tr>';
        m += '<tr><td colspan=2><div class=indent5 id=tcoThroneRepairLastResult><br></div></td></tr>';
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;SPEED UPS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoThroneRepairHourglassLevelSpecific ' + (tcoThroneRepairData.hourglassLevelSpecific ? "CHECKED" : "") + '>Only use hourglass for levels ';
        m += '<select class=tcoSelect  id=tcoThroneRepairHourglassLevel>';
        for (lvl = 1; lvl < tcoMaxThroneLevel; lvl++) m += '<option value="' + lvl + '" ' + (tcoThroneRepairData.hourglassLevel == lvl ? 'SELECTED' : '') + '>+' + lvl + '</option>';
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoThroneRepairHourglassQualitySpecific ' + (tcoThroneRepairData.hourglassQualitySpecific ? "CHECKED" : "") + '>Only use hourglass for qualities ';
        m += '<select class=tcoSelect id=tcoThroneRepairHourglassQuality>';
        for (qual = 1; qual <= tcoMaxThroneQuality-1; qual++) m += '<option value="' + qual + '" ' + (tcoThroneRepairData.hourglassQuality == qual ? 'SELECTED' : '') + '>' + throneCardQualities[qual].capitalizeFirstLetter() + '</option>';
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[1] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneRepairUseSH ' + (tcoThroneRepairData.useSH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[1] + ' (<div class=divNoWrap id=tcoThroneRepairUseSHLabel><font' + (uW.ksoItems[1].count < 100 ? ' color=red>' : '>') + uW.ksoItems[1].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[2] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneRepairUseKH ' + (tcoThroneRepairData.useKH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[2] + ' (<div class=divNoWrap id=tcoThroneRepairUseKHLabel><font' + (uW.ksoItems[2].count < 100 ? ' color=red>' : '>') + uW.ksoItems[2].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[3] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneRepairUseGH ' + (tcoThroneRepairData.useGH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[3] + ' (<div class=divNoWrap id=tcoThroneRepairUseGHLabel><font' + (uW.ksoItems[3].count < 100 ? ' color=red>' : '>') + uW.ksoItems[3].count + '</font></div>)</div></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[4] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneRepairUseMH ' + (tcoThroneRepairData.useMH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[4] + ' (<div class=divNoWrap id=tcoThroneRepairUseMHLabel><font' + (uW.ksoItems[4].count < 100 ? ' color=red>' : '>') + uW.ksoItems[4].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[5] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneRepairUseAH ' + (tcoThroneRepairData.useAH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[5] + ' (<div class=divNoWrap id=tcoThroneRepairUseAHLabel><font' + (uW.ksoItems[5].count < 100 ? ' color=red>' : '>') + uW.ksoItems[5].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[6] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneRepairUseWH ' + (tcoThroneRepairData.useWH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[6] + ' (<div class=divNoWrap id=tcoThroneRepairUseWHLabel><font' + (uW.ksoItems[6].count < 100 ? ' color=red>' : '>') + uW.ksoItems[6].count + '</font></div>)</div></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[7] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneRepairUseDH ' + (tcoThroneRepairData.useDH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[7] + ' (<div class=divNoWrap id=tcoThroneRepairUseDHLabel><font' + (uW.ksoItems[7].count < 100 ? ' color=red>' : '>') + uW.ksoItems[7].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[8] + '"><input class=tcoCheckbox type=checkbox id=tcoThroneRepairUseEH ' + (tcoThroneRepairData.useEH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[8] + ' (<div class=divNoWrap id=tcoThroneRepairUseEHLabel><font' + (uW.ksoItems[8].count < 100 ? ' color=red>' : '>') + uW.ksoItems[8].count + '</font></div>)</div></td>';
        m += '<td/>';
        m += '</tr>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoThroneRepairOverrideSpeedUps ' + (tcoThroneRepairData.overrideSpeedUp ? "CHECKED" : "") + '>Override hourglasses by using ';
        m += '<select class=tcoSelect  id=tcoThroneRepairSpeedUp>';
        m += '<option value=0>None</option>';
        for (gls in tcoHourGlassName) {
            m += '<option value=' + gls + ' ' + (tcoThroneRepairData.useSpeedUp == gls ? 'SELECTED' : '') + '>' + tcoHourGlassName[gls] + '</option>';
        }
        m += '</select> every time</td>';
        m += '</tr>';
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;REPAIR ITEMS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';

        m += '<tr><td>Queue By Level: <select class=tcoSelect id=tcoThroneRepairByLevel>';
        for (i = 1; i < tcoMaxThroneLevel; i++) m += '<option value=' + i + '>+' + i + '</option>';
        m += '</select>&nbsp;<input id=tcoThroneRepairByLevelAdd class=tcoButton type=button value="Add"/></td></tr>';

        m += '<tr><td>Queue By Preset Tag: <select class=tcoSelect id=tcoThroneRepairPresetTagList>';
        var presetSlots = getObjectCollectionCount(Seed.throne.slotEquip);
        var presetsList = "";
        for (i = 1; i < presetSlots + 1; i++) presetsList += '<option value="' + i + '">' + i + ' (' + tcoThronePresetData.presetNames[i] + ')</option>';
        m += presetsList;
        m += "</select>&nbsp;<input id=tcoThroneRepairPresetTag class=tcoButton type=button value='Add'/></td></tr>";

        m += '<tr><td><div style="max-width:90%;">Item: <select class=tcoSelect style="white-space:nowrap;display:inline-block;max-width: 200px;" id=tcoThroneRepairList>';
        m += '</select><input id=tcoThroneRepairAdd type=button class=tcoButton value="Add"/>&nbsp;<input id=tcoThroneRepairAddAll class=tcoButton type=button value="Add All">&nbsp;<input id=tcoThroneRepairRefresh class=tcoButton type=button value="Refresh List"></div></td></tr>';

        m += '</table>';
        m += '</div>';
       
        m += '<div class=tcoHeader>&nbsp;REPAIR LIST&nbsp;</div>';
        
        m += '<div>';
        m += '<table class=tcoSectionTable>';

        m += '<tr><td colspan=2>';
        m += '<div id=tcoThroneRepairQScroll style="position: static; width: 100%; height: 350px; overflow-x: auto; overflow-y: auto;">';
        m += '<div id=tcoThroneRepairQDiv></div>';
        m += '</div>';
        m += '</td></tr>';

        m += '<tr align=center><td><div><input style="float: left;" id=tcoThroneRepairClear class=tcoButton type=button value="Clear Queue"/></div></td><td><div><input style="float: right;" id=tcoThroneRepairClearF class=tcoButton type=button value="Clear Repaired"/></div></td></tr>';

        m += '</table>';
        m += '</div>';
        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoThroneRepairSaveSettings').addEventListener('click', function () {
            SaveSettingsToFile(tcoThroneRepairData);
        }, false);
        document.getElementById('tcoThroneRepairLoadSettings').addEventListener('click', function () {
            var loader = document.getElementById('tcoSettingsFile');
            loader.addEventListener('change', function () {
                LoadSettingsFromFile(tcoThroneRepairData, Tabs.throneRepair);
            }, false);
            loader.click();
        }, false);

        t.refreshAetherDisplay();

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        document.getElementById('tcoThroneRepairUseWH').addEventListener('change', function () {
            tcoThroneRepairData.useWH = document.getElementById('tcoThroneRepairUseWH').checked;
            SAVEtcoThroneRepairData();
            if (tcoThroneRepairData.useWH) t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairUseDH').addEventListener('change', function () {
            tcoThroneRepairData.useDH = document.getElementById('tcoThroneRepairUseDH').checked;
            SAVEtcoThroneRepairData();
            if (tcoThroneRepairUseDH.useDH) t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairUseEH').addEventListener('change', function () {
            tcoThroneRepairData.useEH = document.getElementById('tcoThroneRepairUseEH').checked;
            SAVEtcoThroneRepairData();
            if (tcoThroneRepairData.useEH) t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairUseSH').addEventListener('change', function () {
            tcoThroneRepairData.useSH = document.getElementById('tcoThroneRepairUseSH').checked;
            SAVEtcoThroneRepairData();
            if (tcoThroneRepairData.useSH) t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairUseKH').addEventListener('change', function () {
            tcoThroneRepairData.useKH = document.getElementById('tcoThroneRepairUseKH').checked;
            SAVEtcoThroneRepairData();
            if (tcoThroneRepairData.useKH) t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairUseGH').addEventListener('change', function () {
            tcoThroneRepairData.useGH = document.getElementById('tcoThroneRepairUseGH').checked;
            SAVEtcoThroneRepairData();
            if (tcoThroneRepairData.useGH) t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairUseMH').addEventListener('change', function () {
            tcoThroneRepairData.useMH = document.getElementById('tcoThroneRepairUseMH').checked;
            SAVEtcoThroneRepairData();
            if (tcoThroneRepairData.useMH) t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairUseAH').addEventListener('change', function () {
            tcoThroneRepairData.useAH = document.getElementById('tcoThroneRepairUseAH').checked;
            SAVEtcoThroneRepairData();
            if (tcoThroneRepairData.useAH) t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairHourglassLevelSpecific').addEventListener('change', function () {
            tcoThroneRepairData.hourglassLevelSpecific = document.getElementById('tcoThroneRepairHourglassLevelSpecific').checked;
            SAVEtcoThroneRepairData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairHourglassQualitySpecific').addEventListener('change', function () {
            tcoThroneRepairData.hourglassQualitySpecific = document.getElementById('tcoThroneRepairHourglassQualitySpecific').checked;
            SAVEtcoThroneRepairData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairOverrideSpeedUps').addEventListener('change', function () {
            tcoThroneRepairData.overrideSpeedUp = document.getElementById('tcoThroneRepairOverrideSpeedUps').checked;
            SAVEtcoThroneRepairData();
            if (tcoThroneRepairData.overrideSpeedUp) t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairSpeedUp').addEventListener('change', function () {
            tcoThroneRepairData.useSpeedUp = document.getElementById('tcoThroneRepairSpeedUp').value;
            SAVEtcoThroneRepairData();
        }, false);

        document.getElementById('tcoThroneRepairHourglassLevel').addEventListener('change', function () {
            tcoThroneRepairData.hourglassLevel = document.getElementById('tcoThroneRepairHourglassLevel').value;
            SAVEtcoThroneRepairData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairHourglassQuality').addEventListener('change', function () {
            tcoThroneRepairData.hourglassQuality = document.getElementById('tcoThroneRepairHourglassQuality').value;
            SAVEtcoThroneRepairData();
            t.doAction();
        }, false);

        document.getElementById('tcoThroneRepairPower').addEventListener('click', function () {
            t.togglePower(this);
        }, false);

        document.getElementById('tcoThroneRepairByLevelAdd').addEventListener('click', function () {
            var t = Tabs.throneRepair;
            var level = document.getElementById('tcoThroneRepairByLevel').value;
            for (trId in uW.kocThroneItems) {
                var throne_item = uW.kocThroneItems[trId];
                if (throne_item == null || !throne_item) continue;
                if (!throne_item.isBroken) continue;
                if (throne_item.level != level) continue;
                t.addQueue(trId);
            }
        }, false);

        document.getElementById('tcoThroneRepairPresetTag').addEventListener('click', function () {
            var t = Tabs.throneRepair;
            var presetTagNum = document.getElementById('tcoThroneRepairPresetTagList').value;
            var presetTag = getThronePresetObject(parseInt(presetTagNum));
            for (var ptId in presetTag) {
                var throne_item = uW.kocThroneItems[ptId];
                if (throne_item == null || !throne_item) continue;
                if (throne_item.isBroken) t.addQueue(ptId);
            }
        }, false);

        document.getElementById('tcoThroneRepairClear').addEventListener('click', function () {
            t.deleteQueue();
        }, false);

        document.getElementById('tcoThroneRepairClearF').addEventListener('click', function () {
            var temp = [];
            while (tcoThroneRepairData.items.length > 0) {
                var trId = tcoThroneRepairData.items.pop();
                var throne_item = uW.kocThroneItems[trId];
                if (throne_item == null || !throne_item) continue;
                if (throne_item.isBroken) temp.push(trId);
            }
            while (temp.length > 0) tcoThroneRepairData.items.push(temp.pop());
            tcoThroneRepairData.index = 0
            SAVEtcoThroneRepairData();
            t.populateThroneRepairListBox();
            t.buildThroneRepairDisplay();
        }, false);

        document.getElementById('tcoThroneRepairAdd').addEventListener('click', function () { 
            t.addQueue();
        }, false);

        document.getElementById('tcoThroneRepairAddAll').addEventListener('click', function () {
            t.addAllQueue();
        }, false);

        document.getElementById('tcoThroneRepairRefresh').addEventListener('click', function () {
            t.populateThroneRepairListBox();
        }, false); 

        if (tcoThroneRepairData.active)
            t.setStatus('Loading...');
        else
            t.setStatus('Powered Off');    

        t.refreshAetherDisplay();

        var d = 2 + Math.random() * 8;
        if (Seed.queue_throne != null && Seed.queue_throne.end != null) {
            var repairTimeLeft = Seed.queue_throne.end - unixTime();
            t.repairEnd = Seed.queue_throne.end;
            t.repairId = Seed.queue_throne.itemId;
            var n = new Date(t.repairEnd * 1000);

            t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + uW.kocThroneItems[t.repairId].name);
            if (tcoThroneRepairData.useSH || tcoThroneRepairData.useKH || tcoThroneRepairData.useGH || tcoThroneRepairData.useMH || tcoThroneRepairData.useAH || tcoThroneRepairData.useWH || tcoThroneRepairData.useDH || tcoThroneRepairData.useEH || (tcoThroneRepairData.overrideSpeedUp && tcoThroneRepairData.useSpeedUp > 0)) {
                var throneItem = uW.kocThroneItems[t.repairId];
                var trQuality = throneItem.quality;
                var trLevel = throneItem.level;
                var useThoseSpeedups = true;
                if (tcoThroneRepairData.hourglassQualitySpecific && trQuality < tcoThroneRepairData.hourglassQuality) useThoseSpeedups = false;
                if (tcoThroneRepairData.hourglassLevelSpecific && trLevel < tcoThroneRepairData.hourglassLevel) useThoseSpeedups = false;
                if (tcoThroneRepairData.overrideSpeedUp) useThoseSpeedups = true;
                if (useThoseSpeedups) {
                    setTimeout(function () { t.doSpeedup(); }, 2000);
                }
            }
            setTimeout(t.clearRepair, (repairTimeLeft + 1) * 1000);
            if (repairTimeLeft > 0) d += repairTimeLeft;
        }

        t.populateThroneRepairListBox();
        t.buildThroneRepairDisplay();


        if (!tcoThroneRepairData.active) t.setStatus("Powered Off");


        if (t.timerH == null) {
            t.timerH = setTimeout(t.doAction, d * 1000);
        }
	},
	
    refreshAetherDisplay : function () {
        document.getElementById('tcoThroneRepairAetherDisplay').innerHTML = displayCityAstone();
    },

	hide: function () {},
	
	show: function () {
		var t = Tabs.throneRepair;
        t.refreshAetherDisplay();
        t.populateThroneRepairListBox();
        t.buildThroneRepairDisplay();
	},

    doRepair: function (rItem) {
        var t = Tabs.throneRepair;
        var params = uW.Object.clone(ajfx);

        if (tcoThroneRepairData.active == false || rItem == 0 || uW.kocThroneItems[rItem] == null) return;

        var theItem = uW.kocThroneItems[rItem];

        params.action = 'timeRepair';
        params.throneRoomItemId = rItem;
        params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';

        new AjaxRequest(uW.g_ajaxpath + "ajax/_dispatch53.php" + uW.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            loading: true,
            onSuccess: function (transport) {

                var rslt = eval("(" + transport.responseText + ")");

                if (rslt.ok) {
                    var item = uW.kocThroneItems[rItem];
                    var startTime = unixTime();
                    var endTime = rslt.eta;
                    ActionLog('Starting repair for Throne Room item ' + item.name);
                    Seed.queue_throne.itemId = item.id;
                    Seed.queue_throne.start = startTime;
                    Seed.queue_throne.end = endTime;
                    t.repairId = item.id;
                    t.repairEnd = endTime;
                    var n = new Date(t.repairEnd * 1000);
                    t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString() + ". Item: " + item.name);
                    var secondsForRepair = t.repairEnd - startTime;
                    if (secondsForRepair < 0) secondsForRepair = 0;
                    CM.ThroneView.renderInventory(uW.kocThroneItems);
                    t.clearTimerH = setTimeout(t.clearRepair, (secondsForRepair + 1) * 1000);
                    t.buildThroneRepairDisplay();
                    if (tcoThroneRepairData.useSH || tcoThroneRepairData.useKH || tcoThroneRepairData.useGH || tcoThroneRepairData.useMH || tcoThroneRepairData.useAH || tcoThroneRepairData.useWH || tcoThroneRepairData.useDH || tcoThroneRepairData.useEH || (tcoThroneRepairData.overrideSpeedUp && tcoThroneRepairData.useSpeedUp > 0)) {
                        var throneItem = uW.kocThroneItems[t.repairId];
                        var trQuality = throneItem.quality;
                        var trLevel = throneItem.level;
                        var useThoseSpeedups = true;
                        if (tcoThroneRepairData.hourglassQualitySpecific && trQuality < tcoThroneRepairData.hourglassQuality) useThoseSpeedups = false;
                        if (tcoThroneRepairData.hourglassLevelSpecific && trLevel < tcoThroneRepairData.hourglassLevel) useThoseSpeedups = false;
                        if (tcoThroneRepairData.overrideSpeedUp) useThoseSpeedups = true;
                        if (useThoseSpeedups) {
                            setTimeout(function () { t.doSpeedup(); }, 2000);
                        }
                    }
                }
                else {
                    if (rslt.msg == "Item is not broken") {
                        uW.kocThroneItems[rItem].isBroken = false;
                        t.clearRepair();
                    }

                    // regrab the end times in case this is caused by a manual repair
                    if (Seed.queue_throne && Seed.queue_throne.end && Seed.queue_throne.itemId) {
                        t.repairEnd = Seed.queue_throne.end;
                        t.repairId = Seed.queue_throne.itemId;
                    }

                }
                return;
            },
            onFailure: function (ttt) {
                // this usually means a repair is in progress (such as a manual repair). Grab the seed data (if possible)
                if (Seed.queue_throne && Seed.queue_throne.end) {
                    t.repairEnd = Seed.queue_throne.end;
                    t.repairId = Seed.queue_throne.itemId;
                }

                return;
            }
        });
        return;
    },


    togglePower: function (obj) {
        var t = Tabs.throneRepair;

        var tcoThroneRepairPower = document.getElementById('tcoThroneRepairPower');

        if (tcoThroneRepairData.active) {
            tcoThroneRepairData.active = false;
            tcoThroneRepairPower.value = "Repair = OFF";
            t.setStatus("Powered Off");
            t.setResult("");

        } else {
            tcoThroneRepairData.active = true;
            tcoThroneRepairPower.value = "Repair = ON";
            t.setStatus("Powered On");
            t.setResult("");
            tcoThroneUpgradeData.active = false; 
            SAVEtcoThroneUpgradeData();
            t.doAction();
        }

        if (!tcoThroneRepairData.active) {

        }

        SAVEtcoThroneRepairData();
        t.updateThroneMenu();

    },

    clearRepair: function () {
        var t = Tabs.throneRepair;
        var timeUntilDone = 0;

        if (t.repairEnd == 0) {
            return timeUntilDone;
        }
        timeUntilDone = t.repairEnd - unixTime();

        if (timeUntilDone <= 0) {
            // logit("clearing repair");
            if (t.repairId != 0 && uW.kocThroneItems[t.repairId] != null) {
                if (!uW.kocThroneItems[t.repairId].isBroken) {
                    t.setStatus("Repair time complete.");
                    document.getElementById('tcoThroneRepairState' + t.repairId).className = "tcoSuccess";
                } else {
                    uW.kocThroneItems[t.repairId].isBroken = false;
                    uW.kocThroneItems[t.repairId].brokenType = "";
                }
                t.repairId = 0;
            }

        }
        CM.ThroneView.renderInventory(uW.kocThroneItems);
        return timeUntilDone;
    },

    setStatus: function (s) {
        document.getElementById('tcoThroneRepairStatus').innerHTML = "<div>" + s + "</div>";
    },

    setResult: function (s) {
        document.getElementById('tcoThroneRepairLastResult').innerHTML = "<div>" + s + "</div>";
    },

    updateThroneMenu: function () {
        if (!document.getElementById('tcoExecuteRepair')) return;
        document.getElementById('tcoExecuteRepair').innerHTML = 'Repair ' + (tcoThroneRepairData.active ? 'ON' : 'OFF');
    },

    deleteRepairItem: function (index) {
        // delete an item from the queue
        var t = Tabs.throneRepair;
        tcoThroneRepairData.items.splice(index, 1);
        SAVEtcoThroneRepairData();
        t.populateThroneRepairListBox();
        t.buildThroneRepairDisplay();
    },

    moveRepairUpRow: function (index) {
        if (index < 1) return;
        var t = Tabs.throneRepair;
        var q = tcoThroneRepairData.items.splice(index, 1);
        tcoThroneRepairData.items.splice(index - 1, 0, q);

        if (index == tcoThroneRepairData.index)
            tcoThroneRepairData.index--;
        else if (tcoThroneRepairData.index == index - 1)
            tcoThroneRepairData.index++;

        SAVEtcoThroneRepairData();
        t.buildThroneRepairDisplay();
    },

    moveRepairDownRow: function (index) {
        if (index > (tcoThroneRepairData.items.length - 2)) return;

        var t = Tabs.throneRepair;
        var q = tcoThroneRepairData.items.splice(index, 1);
        tcoThroneRepairData.items.splice(index + 1, 0, q);

        if (i == tcoThroneRepairData.index)
            tcoThroneRepairData.index++;
        else if (tcoThroneRepairData.index == i + 1)
            tcoThroneRepairData.index--;

        SAVEtcoThroneRepairData();
        t.buildThroneRepairDisplay();

    },

    buildThroneRepairDisplay: function () {
        var t = Tabs.throneRepair;

        var tcoThroneRepairQDiv = document.getElementById('tcoThroneRepairQDiv');

        var totalRepairTime = t.calcRepairTime();

        var item_count = tcoThroneRepairData.items.length;

        var m = '<table>';

        if (totalRepairTime > 0) m += '<caption><b><i>Total Repair Time (' + item_count + ' items): ' + repairTimeToText(totalRepairTime) + '</i></b></caption>';

        m += '<tr>';
        m += '<th width=10%>Remove</th>';
        m += '<th width=5%>Order</th>';
        m += '<th width=8%>Status</th>';
        m += '<th width=25%>Item</th>';
        m += '</tr>';

        if (item_count > 0) {
            for (var item_index = 0; item_index < item_count; item_index++) {
                var trId = tcoThroneRepairData.items[item_index];

                if (trId == null) {
                    t.deleteRepairItem(item_index);
                    return;
                }
                var throne_item = uW.kocThroneItems[trId];
                if (throne_item == null || !throne_item) {
                    t.deleteRepairItem(item_index);
                    return;
                }

                m += '<tr>';
                m += '<td align=center><div id=tcoThroneRepairRemove' + trId + ' class=tcoRemove></div></td>';
                m += '<td align=center><div class=tcoUpRow id=tcoThroneRepairUpRow' + trId + '></div><div class=tcoDownRow  id=tcoThroneRepairDownRow' + trId + '></div></td>';
                m += '<td align=center><div id=tcoThroneRepairState' + trId + '></div></td>';
                m += '<td align=center class=tcoThroneRepairItemName><div id=tcoThroneRepairItem' + trId + ' >' + throne_item.name + '</div></td>';
                m += '</tr>';
            }

            m += '</table>';

            tcoThroneRepairQDiv.innerHTML = m;

            for (var item_index = 0; item_index < item_count; item_index++) {

                var trId = tcoThroneRepairData.items[item_index];

                var throne_item = uW.kocThroneItems[trId];

                if (throne_item == null || !throne_item) continue;

                document.getElementById('tcoThroneRepairItem' + trId).addEventListener('mouseover', function(A) {
                    A.stopPropagation();
                    var throneId = this.id.split('tcoThroneRepairItem')[1];
                    var throneItem = uW.kocThroneItems[throneId];
                    var tcoCard = document.getElementById('tcoThroneRepairItem' + throneId);
                    CM.ThroneView.hoverItem(A, tcoCard, throneItem);
                }, false);

                document.getElementById('tcoThroneRepairRemove' + trId).setAttribute('v1', item_index);
                document.getElementById('tcoThroneRepairRemove' + trId).addEventListener('click', function () {
                    var qIndex = this.getAttribute('v1');
                    t.deleteRepairItem(qIndex);
                }, false);

                document.getElementById('tcoThroneRepairUpRow' + trId).setAttribute('v1', item_index);
                document.getElementById('tcoThroneRepairUpRow' + trId).addEventListener('click', function () {
                    var qIndex = this.getAttribute('v1');
                    t.moveRepairUpRow(qIndex);
                }, false);

                document.getElementById('tcoThroneRepairDownRow' + trId).setAttribute('v1', item_index);
                document.getElementById('tcoThroneRepairDownRow' + trId).addEventListener('click', function () {
                    var qIndex = this.getAttribute('v1');
                    t.moveRepairDownRow(qIndex);
                }, false);

                var throne_item = uW.kocThroneItems[trId];
                if (!throne_item || !(throne_item.id)) {
                    document.getElementById('tcoThroneRepairState' + trId).innerHTML = '<div style="text-align:center"> ??</div>';
                } else if (!throne_item.isBroken) {
                    document.getElementById('tcoThroneRepairState' + trId).className = 'tcoSuccess';
                } else if (throne_item.isBroken) {
                    if (trId == t.repairId) {
                        document.getElementById('tcoThroneRepairState' + trId).className = 'tcoHammer';
                    } else {
                        document.getElementById('tcoThroneRepairState' + trId).className = 'tcoBroken';
                    }
                }

            }
        } else {
            m += '</table>';

            tcoThroneRepairQDiv.innerHTML = m;
        }
    },

    populateThroneRepairListBox: function () {
        var repairList = document.getElementById('tcoThroneRepairList');
        var m = '<option value=0>--Items--</option>';

        var item_count = tcoThroneRepairData.items.length;

        for (trId in uW.kocThroneItems) {
            var throne_item = uW.kocThroneItems[trId];
            if (throne_item == null || !throne_item) continue;
            if (!throne_item.isBroken) continue; //item not broken, move on

            var foundIt = false;
            for (var item_index = 0; item_index < item_count; item_index++) {
                if (trId == tcoThroneRepairData.items[item_index]) {
                    foundIt = true;
                    break;
                }
            }
            if (!foundIt) {
                var optionText = throne_item.name;
                m += '<option value="' + trId + '">' + optionText + '</option>';
            }
        }
        repairList.innerHTML = m;
    },

    deleteQueue: function () {
        var t = Tabs.throneRepair
        tcoThroneRepairData.items = [];
        SAVEtcoThroneRepairData();
        t.populateThroneRepairListBox();
        t.buildThroneRepairDisplay();
    },

    addAllQueue: function () {
        var t = Tabs.throneRepair;

        for (trId in uW.kocThroneItems) {
            var throne_item = uW.kocThroneItems[trId];
            if (throne_item == null || !throne_item) continue;
            if (throne_item.isBroken) {
                t.addQueue(trId);
            }
        }

    },

    selectNext: function () {

        var l = tcoThroneRepairData.items.length;
        for (i = 0; i < l; i++) {

            var throne_item = uW.kocThroneItems[tcoThroneRepairData.items[i]];
            if (throne_item == null || !throne_item) continue;
            if ((throne_item != null) && (throne_item.isBroken)) {
                tcoThroneRepairData.index = i;
                SAVEtcoThroneRepairData();
                return;
            }
        }

        // if we get here, the queue is complete
        tcoThroneRepairData.index = -1;

        SAVEtcoThroneRepairData();
    },

    calcRepairTime: function () {
        var t = Tabs.throneRepair
        var item_count = tcoThroneRepairData.items.length;
        var total_time = 0;
        for (var item_index = 0; item_index < item_count; item_index++) {
            var trId = tcoThroneRepairData.items[item_index];
            var throne_item = uW.kocThroneItems[trId];
            if (throne_item == null || !throne_item) continue;
            var item_time = CM.thronestats.repairCostUpgrade[throne_item.level].Time;
            total_time += item_time;
        }
        return total_time;
    },

    addQueue: function (iD) {
        var t = Tabs.throneRepair;

        if (iD == null) {
            var trId = document.getElementById('tcoThroneRepairList').value;
        } else {
            var trId = iD;
        }

        if (trId == 0 || trId == null) return;

        var item_count = tcoThroneRepairData.items.length;

        if (item_count > 0) {
            for (var item_index = 0; item_index < item_count; item_index++) {
                if (trId == tcoThroneRepairData.items[item_index]) return;
            }
        }

        tcoThroneRepairData.items.push(trId);
        SAVEtcoThroneRepairData();
        t.populateThroneRepairListBox();
        t.buildThroneRepairDisplay();
    },

    doSpeedup: function () {
        var t = Tabs.throneRepair;

        var endTime = t.repairEnd;
        var startTime = unixTime();
        var secondsForRepair = endTime - startTime;
        var divId = "";

        t.speedup = 0;

        if (secondsForRepair > 0 && tcoThroneRepairData.overrideSpeedUp && tcoThroneRepairData.useSpeedUp > 0) {
            t.speedup = tcoThroneRepairData.useSpeedUp;
        } else {
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.day25 && tcoThroneRepairData.useAH && uW.ksoItems[8].count > 0) { t.speedup = 8; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour24 && tcoThroneRepairData.useAH && uW.ksoItems[7].count > 0) { t.speedup = 7; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour15 && tcoThroneRepairData.useAH && uW.ksoItems[6].count > 0) { t.speedup = 6; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour8 && tcoThroneRepairData.useAH && uW.ksoItems[5].count > 0) { t.speedup = 5; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour25 && tcoThroneRepairData.useMH && uW.ksoItems[4].count > 0) { t.speedup = 4; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour1 && tcoThroneRepairData.useGH && uW.ksoItems[3].count > 0) { t.speedup = 3; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.minute15 && tcoThroneRepairData.useKH && uW.ksoItems[2].count > 0) { t.speedup = 2; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.minute1 && tcoThroneRepairData.useSH && uW.ksoItems[1].count > 0) { t.speedup = 1; }
        }

        switch (t.speedup) {
            case "1":
            case 1:
                secondsForRepair -= HOURGLASSES_TIME.minute1;
                divId = 'tcoThroneRepairUseSHLabel';
                break;
            case "2":
            case 2:
                secondsForRepair -= HOURGLASSES_TIME.minute15;
                divId = 'tcoThroneRepairUseKHLabel';
                break;
            case "3":
            case 3:
                secondsForRepair -= HOURGLASSES_TIME.hour1;
                divId = 'tcoThroneRepairUseGHLabel';
                break;
            case "4":
            case 4:
                secondsForRepair -= HOURGLASSES_TIME.hour25;
                divId = 'tcoThroneRepairUseMHLabel';
                break;
            case "5":
            case 5:
                secondsForRepair -= HOURGLASSES_TIME.hour8;
                divId = 'tcoThroneRepairUseAHLabel';
                break;
            case "6":
            case 6:
                secondsForRepair -= HOURGLASSES_TIME.hour15;
                divId = 'tcoThroneRepairUseWHLabel';
                break;
            case "7":
            case 7:
                secondsForRepair -= HOURGLASSES_TIME.hour24;
                divId = 'tcoThroneRepairUseDHLabel';
                break;
            case "8":
            case 8:
                secondsForRepair -= HOURGLASSES_TIME.day25;
                divId = 'tcoThroneRepairUseEHLabel';
                break;
        }

        if (t.speedup != 0) {
            t.setResult('Used ' + uW.ksoItems[t.speedup].name);
            var divCount = uW.ksoItems[t.speedup].count - 1;
            var divSpeedups = document.getElementById(divId);
            divSpeedups.innerHTML = divCount;
            uW.modal_speedup_apply("throne", t.speedup, t.repairId);

            if (secondsForRepair <= 0) {
                secondsForRepair = 0;
                endTime = startTime;
                t.clearTimerH = setTimeout(t.clearRepair, 1000);
            } else {
                endTime = unixTime() + secondsForRepair;
                t.repairEnd = endTime;
                var n = new Date(t.repairEnd * 1000);
                var item = uW.kocThroneItems[t.repairId];
                if (item) {
                    t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString() + ". Item: " + item.name);
                    t.clearTimerH = setTimeout(t.clearRepair, secondsForRepair * 1000);
                }
            }
            t.buildThroneRepairDisplay();
            t.repairEnd = endTime;
            setTimeout(function () { t.doSpeedup(); }, 1000);
        }
    },

    doAction: function () {
        var t = Tabs.throneRepair;
        t.populateThroneRepairListBox();

        if (tcoThroneUpgradeData.active) {
            t.setStatus('Waiting for upgrade tab to finish...');
            if (tcoThroneRepairData.active) t.togglePower();
            return;
        }

        if (!tcoThroneRepairData.active) {
            t.setStatus("Powered Off");
            return;
        } else {
            var retryTime = tcoGeneralOptions.retryInterval;

            try {
                // check if repair is done
                var ti = t.clearRepair();
                if (ti <= 0) {
                    // repair is done

                    // set the index
                    t.selectNext();

                    if (tcoThroneRepairData.index < 0) {
                        t.setStatus("Reached end of queue.")
                        t.setResult("");
                        SAVEtcoThroneRepairData();
                    } else {
                        var throne_item = uW.kocThroneItems[tcoThroneRepairData.items[tcoThroneRepairData.index]];
                        if (throne_item) {
                            t.repairId = throne_item.id;
                            t.doRepair(throne_item.id);
                        }
                    }

                } else {
                    // come back after repair is complete
                    retryTime = ti + 5;
                    var n = new Date(t.repairEnd * 1000);
                    t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + uW.kocThroneItems[t.repairId].name);
                    if (tcoThroneRepairData.useSH || tcoThroneRepairData.useKH || tcoThroneRepairData.useGH || tcoThroneRepairData.useMH || tcoThroneRepairData.useAH || tcoThroneRepairData.useWH || tcoThroneRepairData.useDH || tcoThroneRepairData.useEH || (tcoThroneRepairData.overrideSpeedUp && tcoThroneRepairData.useSpeedUp > 0)) {
                        var throneItem = uW.kocThroneItems[t.repairId];
                        var trQuality = throneItem.quality;
                        var trLevel = throneItem.level;
                        var useThoseSpeedups = true;
                        if (tcoThroneRepairData.hourglassQualitySpecific && trQuality < tcoThroneRepairData.hourglassQuality) useThoseSpeedups = false;
                        if (tcoThroneRepairData.hourglassLevelSpecific && trLevel < tcoThroneRepairData.hourglassLevel) useThoseSpeedups = false;
                        if (tcoThroneRepairData.overrideSpeedUp) useThoseSpeedups = true;
                        if (useThoseSpeedups) {
                            setTimeout(function () { t.doSpeedup(); }, 2000);
                        }
                        retryTime = 1;
                    }
                }
                CM.ThroneView.renderInventory(uW.kocThroneItems);
            } catch (e) {
            }
            // recycle
            clearTimeout(t.timerH);
            t.timerH = setTimeout(t.doAction, retryTime * 1000);
            t.buildThroneRepairDisplay();
        }
    },
}

Tabs.throneOrganizer = {
	tabOrder: 100,
	tabLabel: 'ORGANIZER',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM ORGANIZER',
    throneItemLists: [],
    sortEffect: "none",
    buffType: "both",
    panelId: -1,
    panelType: "upgrade",
    panelNextLevel: 2,
    switchingPresets: false,
    thronePanelOpen: false,
	
	init: function (div) {
		var t = Tabs.throneOrganizer;
		t.mydiv = div;

        t.sortEffect = tcoThroneUpgradeData.effectSelected;
        t.buffType = tcoThroneUpgradeData.buffSelected;

        var throneEffects = [];
        for (efx in CM.thronestats.effects) {
            var throneEffectName = CM.thronestats.effects[efx][1].split(" Debuff")[0];
            if (throneEffects.indexOf(throneEffectName) < 0) throneEffects.push(throneEffectName);
        }

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td>';

        m += 'Sort: <select class=tcoSelect id=tcoThroneSortEffects>';
        m += '<option value="none">--Effect--</option>';
        for (efx in throneEffects) m += '<option value="' + throneEffects[efx] + '">' + throneEffects[efx] + '</option>';
        m += '</select>';
        m += '<select class=tcoSelect id=tcoThroneBuffType>';
        m += '<option value="both">Either</option>';
        m += '<option value="buff">Buff</option>';
        m += '<option value="debuff">Debuff</option>';
        m += '</select>';

        m += '<input id=tcoThroneSortInactive class=tcoCheckbox type=checkbox ' + (tcoThroneUpgradeData.sortInactive ? ' CHECKED' : '') + '/> Include Inactive ';
        m += '<input id=tcoThroneIgnoreBroken class=tcoCheckbox type=checkbox ' + (tcoThroneUpgradeData.ignoreBroken ? ' CHECKED' : '') + '/> Ignore Broken';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>';

        m += '<div id=tcoThroneOrganizerScroll style="position: static; width: ' + (dlgWidth -  (dlgWidthOffset + dlgWidthMenu)) + 'px; height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; overflow-x: hidden; overflow-y: auto;">';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;CARD FILTER&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable cellspacing=0 cellpadding=0>';

        m += '<tr><td colspan=4>';
        m += 'Filter By Effects: <select class=tcoSelect id=tcoThroneFilterEffects>';
        m += '<option value="none">--Effect--</option>';
        for (efx in throneEffects) m += '<option value="' + throneEffects[efx] + '">' + throneEffects[efx] + '</option>';
        m += '</select>';
        m += '<select class=tcoSelect id=tcoThroneFilterBuffType>';
        m += '<option value="buff">Buff</option>';
        m += '<option value="debuff">Debuff</option>';
        m += '</select>';
        m += '</td></tr>';

        m += '<tr><td colspan=4><hr class=tcoHRCenter></td></tr>';

        m += '<tr><td>Faction</td><td>Quality</td><td>Level</td><td>Jewel</td></tr>';

        m += '<tr>';

        m += '<td><div id=tcoThroneFactionFilterRow style="float: left; width: 100px; border:2px solid #ccc; height: 105px; overflow-y: scroll; background-color: white;">';
        for (fact in tcoFactions) m += '<input id=tcoThroneFaction' + tcoFactions[fact] + ' class=tcoCheckbox type=checkbox  CHECKED />' + tcoFactions[fact].capitalizeFirstLetter() + '<br />';
        m += '</div></td>';

        m += '<td><div id=tcoThroneQualityFilterRow style="float: left; width: 120px; border:2px solid #ccc; height: 105px; overflow-y: scroll; background-color: white;">';
        for (var qual = 0; qual < throneCardQualities.length; qual++) m += '<input id=tcoThroneQuality' + qual + ' class=tcoCheckbox type=checkbox  CHECKED />' + throneCardQualities[qual].capitalizeFirstLetter() + '<br />';
        m += '<input id=tcoThroneQualityUnique class=tcoCheckbox type=checkbox CHECKED />Uniques<br />';
        m += '</div></td>';

        m += '<td><div id=tcoThroneLevelFilterRow style="float: left; width: 120px; border:2px solid #ccc; height: 105px; overflow-y: scroll; background-color: white;">';
        for (lvl = 0; lvl <= tcoMaxThroneLevel; lvl++) {
            m += '<input id=tcoThroneLevel' + lvl + ' class=tcoCheckbox type=checkbox CHECKED />' + lvl + '<br /> ';
        }
        m += '</div></td>';

        m += '<td><div id=tcoThroneJewelFilterRow style="float: left; width: 120px; border:2px solid #ccc; height: 105px; overflow-y: scroll; background-color: white;">';
        m += '<input id=tcoThroneJewelNone class=tcoCheckbox type=checkbox CHECKED />No Jewel<br />';

        for (var jwl = 0; jwl < tcoJewelQualities.length; jwl++) m += '<input id=tcoThroneJewel' + (jwl+1) + ' class=tcoCheckbox type=checkbox CHECKED />' + tcoJewelQualities[jwl].capitalizeFirstLetter() + '<br /> ';

        m += '</div></td>';

        m += '</tr>';

        m += '<tr>';
        m += '<td/>';
        m += '<td><input style="width:120px;" id=tcoThroneUnselectAllQualities class=tcoButton type=button value="Unselect All"></td>';
        m += '<td><input style="width:120px;" id=tcoThroneUnselectAllLevels class=tcoButton type=button value="Unselect All"></td>';
        m += '<td><input style="width:120px;" id=tcoThroneUnselectAllJewels class=tcoButton type=button value="Unselect All"></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td/>';
        m += '<td><input style="width:120px;" id=tcoThroneSelectAllQualities class=tcoButton type=button value="Select All"></td>';
        m += '<td><input style="width:120px;" id=tcoThroneSelectAllLevels class=tcoButton type=button value="Select All"></td>';
        m += '<td><input style="width:120px;" id=tcoThroneSelectAllJewels class=tcoButton type=button value="Select All"></td>';
        m += '</tr>';

        m += '</table>';
        m += '</div>';

        for (var tct = 0; tct < throneCardTypes.length; tct++) {
            m += '<div class=tcoThroneOrganizer onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;' + throneCardTypes[tct].toUpperCase() + '&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
            m += '<div class=tcoThroneOrganizerSection id=tcoThroneCardSection' + throneCardTypes[tct] + '></div>';
        }

        //m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        var throneOrganizers = document.getElementsByClassName('tcoThroneOrganizer');
        for (var throneOrg=0; throneOrg < throneOrganizers.length; throneOrg++) {
            throneOrganizers[throneOrg].addEventListener('click', function () {

                var imgs = this.childNodes;
                if (imgs[0].src == tcoDownArrow) {
                    imgs[0].src = tcoRightArrow
                    imgs[2].src = tcoRightArrow
                } else {
                    imgs[0].src = tcoDownArrow
                    imgs[2].src = tcoDownArrow
                }
                var section = this.nextSibling;
                if (section.className != 'tcoThroneOrganizerSection') return;
   
                if (section.style.display == 'block')
                    section.style.display = 'none';
                else
                    section.style.display = 'block';

            }, false);
        }

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        document.getElementById('tcoThroneSortEffects').value = tcoThroneUpgradeData.effectSelected;
        document.getElementById('tcoThroneBuffType').value = tcoThroneUpgradeData.buffSelected;
        document.getElementById('tcoThroneSortInactive').checked = tcoThroneUpgradeData.sortInactive;
        document.getElementById('tcoThroneIgnoreBroken').checked = tcoThroneUpgradeData.ignoreBroken;

        document.getElementById('tcoThroneFilterBuffType').addEventListener('change', function () {
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneFilterEffects').addEventListener('change', function () {
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneSortEffects').addEventListener('change', function () {
            t.sortEffect = this.value;
            tcoThroneUpgradeData.effectSelected = t.sortEffect;
            SAVEtcoThroneUpgradeData();
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneBuffType').addEventListener('change', function () {
            t.buffType = this.value;
            tcoThroneUpgradeData.buffSelected = t.buffType;
            SAVEtcoThroneUpgradeData();
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneSortInactive').addEventListener('click', function () {
            tcoThroneUpgradeData.sortInactive = document.getElementById('tcoThroneSortInactive').checked;
            SAVEtcoThroneUpgradeData();
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneIgnoreBroken').addEventListener('click', function () {
            tcoThroneUpgradeData.ignoreBroken = document.getElementById('tcoThroneIgnoreBroken').checked;
            SAVEtcoThroneUpgradeData();
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneUnselectAllQualities').addEventListener('click' , function () {
            for (var qual = 0; qual < throneCardQualities.length; qual++) document.getElementById('tcoThroneQuality' + qual).checked = false;
            document.getElementById('tcoThroneQualityUnique').checked = false;
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneSelectAllQualities').addEventListener('click', function () {
            for (var qual = 0; qual < throneCardQualities.length; qual++) document.getElementById('tcoThroneQuality' + qual).checked = true;
            document.getElementById('tcoThroneQualityUnique').checked = true;
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneQualityFilterRow').addEventListener('change', function () {
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);


        document.getElementById('tcoThroneUnselectAllJewels').addEventListener('click' , function () {
            for (var jwl = 0 ; jwl < tcoJewelQualities.length; jwl ++ ) document.getElementById('tcoThroneJewel' + (jwl+1)).checked = false;
            document.getElementById('tcoThroneJewelNone').checked = false;
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneSelectAllJewels').addEventListener('click', function () {
            for (var jwl = 0 ; jwl < tcoJewelQualities.length; jwl ++ ) document.getElementById('tcoThroneJewel' + (jwl+1)).checked = true;
            document.getElementById('tcoThroneJewelNone').checked = true;
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneJewelFilterRow').addEventListener('change', function () {
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneUnselectAllLevels').addEventListener('click' , function () {
            for (lvl = 0; lvl <= tcoMaxThroneLevel; lvl++) document.getElementById('tcoThroneLevel' + lvl).checked = false;
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneSelectAllLevels').addEventListener('click', function () {
            for (lvl = 0; lvl <= tcoMaxThroneLevel; lvl++) document.getElementById('tcoThroneLevel' + lvl).checked = true;
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        document.getElementById('tcoThroneLevelFilterRow').addEventListener('change', function () {
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);


        document.getElementById('tcoThroneFactionFilterRow').addEventListener('change', function () {
            t.createThroneItemList();
            t.paintThroneTables();
        }, false);

        t.createThroneItemList();
        t.paintThroneTables();

	},
	
	hide: function () {},

    showNextThroneLevel: function () {
        var t = Tabs.throneOrganizer;
        if (t.panelId < 0) return;
        var X = uW.kocThroneItems[t.panelId];
        if (X.level == tcoMaxThroneLevel) return;
        var V = 'next';
        var P = t.panelType;

        var level = X.level || 0;
        var quality = X.quality || 0;

        var bump = t.panelNextLevel;

        if (P == 'enhance') {
            if ((quality + bump) > 5) {
                bump = 5 - quality;
            }
        }
        else if ((level + bump) > tcoMaxThroneLevel) {
            bump = tcoMaxThroneLevel - level;
        }

        var R = [],
            Q, Y, S, U, N = {},
            T, W;
        if (V == 'next') {
            if (P == 'enhance') {
                quality += bump;
                document.getElementById('nextStatContainer').firstChild.innerHTML = X.createPrefix();
            } else {
                if (P == "upgrade") {
                    level += bump;
                    document.getElementById('nextStatContainer').firstChild.innerHTML = 'Level ' + level;
                }
            }
        }

        $.each(X.effects, function (Z, aa) {
            Q = +(Z.split('slot')[1]);
            Y = CM.thronestats.effects[aa.id];
            S = CM.thronestats.tiers[aa.id][aa.tier];
            if (!S) CM.thronestats.tiers[aa.id][aa.tier - 1]
            var base = S.base || 0;
            var growth = S.growth || 0;

            U = +(base) + ((level * level + level) * +(growth) / 2);

            var wholeNumber = false;
            if (Math.round(U) == U) wholeNumber = true;

            if (wholeNumber)
                U = U.toFixed(0);
            else
                U = U.toFixed(2);

            if (Q % 2 == 0) {
                T = 'even'
            } else {
                T = 'odd'
            }
            if (Q <= quality) {
                if (U > 1) {
                    R.push('<li class="' + T + '">' + Y[1] + ' +' + U + '%</li>')
                } else {
                    R.push('<li class="' + T + '">' + Y[1] + ' ' + U + '%</li>')
                }
            } else {
                R.push('<li class="disabled ' + T + '">' + Y[1] + ' + ' + U + '%</li>')
            }
        });
        if (V == 'next') {
            if (P == 'enhance') {
                quality -= bump
            } else {
                if (P == 'upgrade') {
                    level -= bump;
                }
            }
        }
        if (V === 'next') {
            if (CM.ThronePanelController.isLastLevel(X, P)) {
                var nextStatContainer = document.getElementById('nextStatContainer');
                if (nextStatContainer.children.length < 3) {
                    W = '<div id=lockedStatIcon class=lock></div>';
                    nextStatContainer.innerHTML += W;
                }
            } else {
                var elem = document.getElementById('lockedStatIcon');
                if (elem) elem.parentNode.removeChild(elem);
            }
        }
        t.panelNextLevel++;
        document.getElementById('thronePanelStat2').innerHTML = R.join('');

        var lis = document.getElementById('thronePanelStat2').getElementsByTagName('li');
        for (var i =0; i<lis.length; i++) {
            var li = lis[i];
            li.addEventListener('mouseenter', function (Z) {
                uW.Tooltip.show(Z, this.innerHTML, [-180, 5]);
            }, false);
        }
    },
	
    createThroneItemList: function () {
        var t = Tabs.throneOrganizer;

        for (tct = 0; tct < throneCardTypes.length; tct++) t.throneItemLists[throneCardTypes[tct]] = new Array;
        
        for (throneId in uW.kocThroneItems) {
            var throneItem = uW.kocThroneItems[throneId];

            // apply filters
            var faction = throneItem.faction;
            var level = throneItem.level;
            var thronetype = throneItem.type;
            var quality = throneItem.quality;
            var unique = throneItem.unique != 0;

            var jewelQuality = 0;
            var isBroken = throneItem.isBroken;

            var noJewel = document.getElementById('tcoThroneJewelNone').checked;
            var hasJewel = (throneItem.jewel == null ? false : true);
            if (hasJewel) jewelQuality = throneItem.jewel.quality;

            if (jewelQuality > 0) {
                if (!(document.getElementById('tcoThroneJewel' + jewelQuality).checked)) continue;
            } else {
                if (!noJewel) continue;
            }

            if (tcoThroneUpgradeData.ignoreBroken && isBroken) continue;
            if (!(document.getElementById('tcoThroneQualityUnique').checked) && unique) continue;
            if (!(document.getElementById('tcoThroneQuality' + quality).checked) && !unique) continue;
            if (!(document.getElementById('tcoThroneFaction' + faction).checked)) continue;
            if (!(document.getElementById('tcoThroneLevel' + level).checked)) continue;

            var filterEffect = document.getElementById('tcoThroneFilterEffects').value;
            if (filterEffect != 'none') {
                var filterBuff = document.getElementById('tcoThroneFilterBuffType').value;
                if (filterBuff == 'debuff') filterEffect += ' Debuff';
                var foundEffect = false;
                for (e in throneItem.effects) {
                    var N = throneItem.effects[e];
                    var effect = CM.thronestats.effects[N.id][1];
                    if (effect == filterEffect) {
                        foundEffect = true;
                        break;
                    }
                }

                if (!foundEffect) continue;
            }

            if (throneItem.isEquipped)
                t.throneItemLists[thronetype].unshift(throneItem);
            else
                t.throneItemLists[thronetype].push(throneItem);

        }

        t.sortThroneOrganizerLists();

    },

    paintThroneTables: function () {
        var t = Tabs.throneOrganizer;
        for (tct in t.throneItemLists) {
            var m = '<table><tr>';
            var divCards = document.getElementById('tcoThroneCardSection' + tct);
            divCards.innerHTML = "<div></div>";
            for (idx = 0; idx < t.throneItemLists[tct].length; idx++) {
                var throneItem = t.throneItemLists[tct][idx];
                m += '<td><div class=tcoThroneCard id=tcoThroneCard' + throneItem.id + '>';
                m += BuildThroneCard(throneItem);
                m += '</div></td>';
            }
            m += '</tr></table>';
            divCards.innerHTML = '<div>' + m + '</div>';
        }
        var tcoCards = document.getElementsByClassName('tcoThroneCard');
        for (idx = 0; idx < tcoCards.length; idx++) {
            tcoCards[idx].addEventListener('click', function (A) {
                A.stopPropagation();
                var throneId = this.id.split('tcoThroneCard')[1];
                var throneItem = uW.kocThroneItems[throneId];
                CardContextMenu(this, throneItem, true);
            }, false);
        }
        Tabs.thronePresets.paintTags();
    },

	show: function () {
		var t = Tabs.throneOrganizer;
        t.createThroneItemList();
        t.paintThroneTables();
	},

    sortThroneOrganizerLists: function () {
        var t = Tabs.throneOrganizer;
        tcoThroneUpgradeData.sortInactive = document.getElementById('tcoThroneSortInactive').checked;
        for (idx in t.throneItemLists) {
            t.throneItemLists[idx].sort(function (item1, item2) {
                return t.sortThroneOrganizerValue(item2) - t.sortThroneOrganizerValue(item1);
            });
        }
    },

    sortThroneOrganizerValue: function (item) {
        var t = Tabs.throneOrganizer;
        var retValue = 0.0;
        for (e in item.effects) {
            try {
                var N = item.effects[e];
                var effect = CM.thronestats.effects[N.id][1];

                var tier = CM.thronestats.tiers[N.id][N.tier];
                if (!tier) CM.thronestats.tiers[N.id][N.tier - 1]

                var B = +(e.split("slot")[1]);
                var base = tier.base || 0;
                var level = item.level || 0;
                var growth = tier.growth || 0;
                var quality = item.quality || 0;

                if (B > quality && !tcoThroneUpgradeData.sortInactive) {
                    return +retValue;
                }

                var percent = +(base + ((level * level + level) * growth * 0.5));
                if ((effect == (t.sortEffect + " Debuff")) && (t.buffType != "buff")) {
                    retValue -= percent;
                }
                else if (effect == t.sortEffect && t.buffType != "debuff") {
                    retValue += percent;
                }
            } catch (e) {

            }

        }
        return +retValue;
    },

    unequipItem: function (I, preset) {
        var t = Tabs.throneOrganizer;
        if (!I) return;
        uW.AjaxCall.gPostRequest("ajax/_dispatch53.php", {
            ctrl: "throneRoom\\ThroneRoomServiceAjax",
            action: "unequipItem",
            itemId: I.id,
            presetId: preset
        }, function (u) {
            if (u.ok === true) {
                CM.ThroneView.clickItemUnequip(I);
            } else {
                CM.ModalManager.alert({
                    button_text: uW.g_js_strings.commonstr.ok,
                    text: u.msg,
                    "class": "craftFailure",
                    exe: function () {
                        uW.Modal.hideModalAll();
                        CM.ModalManager.close()
                    }
                })
            }
        }, function (u) {
        });
    },

    equipItem: function (I, preset) {
        if (!I) return;
        uW.AjaxCall.gPostRequest("ajax/_dispatch53.php", {
            ctrl: "throneRoom\\ThroneRoomServiceAjax",
            action: "equipItem",
            itemId: I.id,
            presetId: preset
        }, function (u) {
            if (u.ok === true) {
                CM.ThroneView.clickItemEquip(I);
            } else {
                CM.ModalManager.alert({
                    button_text: uW.g_js_strings.commonstr.ok,
                    text: u.msg,
                    "class": "craftFailure",
                    exe: function () {
                        uW.Modal.hideModalAll();
                        CM.ModalManager.close()
                    }
                })
            }
        }, function (u) {
        })
    },

}

Tabs.throneSorter = {
	tabOrder: 100,
	tabLabel: 'SORTER',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM SORTER',
    tcoLocalSwapFile: null,
	
	init: function (div) {
		var t = Tabs.throneSorter;
		t.mydiv = div;
	},


	hide: function () {},

	show: function () {
		var t = Tabs.throneSorter;

        t.tcoLocalSwapFile = null;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div style="margin-top: 5px;">';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td colspan=3><b><center>Please note this tab and the throne inventory panel will not sync with each other until the other is redrawn by closing/reopening it.</center></b></td></tr>';
        m += '<tr><td class=indent5 colspan=3>&nbsp;';
        m += '<input id=tcoSorterDefaults type=button class=tcoButton value="Restore Default Order">';
        m += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
        m += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
        m += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
        m += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
        m += '<input id=tcoSorterExport type=button class=tcoButton value="Export">&nbsp;&nbsp;&nbsp;&nbsp;';
        m += '<input id=tcoSorterImport type=button class=tcoButton value="Import">&nbsp;';
        m += '<input id=tcoSorterImportTrigger type=button class=tcoButton value="Browse..."  onclick="document.getElementById(\'tcoSorterImportLoadItem\').click()">';
        m += '<input hidden id=tcoSorterImportLoadItem type=file>';
        m += '</td></tr>';
        m += '<tr><td colspan=3></td></tr>';
        m += '<tr>';

        m += '<td width=230px align=center style="vertical-align: top; text-align: middle;">';
        m += '<b>SELECTED CARD:</b><br><div id=tcoThroneSortCard></div>';
        m += '</td>';


        m += '<td width=180px>';
        m += '<div id=tcoThroneSorterInventoryList style="height: 450px; width: 180px; overflow-y: auto;">';

        if (tcoThroneSorter.length == 0) resetThroneSorter();
        var row = 0;

        for (var idx = 0; idx < tcoThroneSorter.length; idx++) {
            if (idx % 5 == 0) {
                row++;
                m += '<div id=tcoThroneSorterInventoryRow' + row + ' class="active">';
            }
            
            var throneId = tcoThroneSorter[idx];
            var throneItem = uW.kocThroneItems[throneId];
            if (!throneItem) continue;
            var className = '';
            className += throneItem.type + ' ';
            className += throneItem.faction + ' ';
            className += 'quality' + throneItem.quality;
            if (throneItem.unique > 0) className += ' unique' + throneItem.unique;
            
            img = getThroneImage(throneItem);
            
            if (t.tcoLocalSwapFile == throneId) img = success_image;

            m += '<img id=tcoThroneSorterInventoryIcon' + throneId + ' class=tcoThroneSorterItem src="' + img + '" style="height: 30px; width: 30px;">';
            
            if (idx == tcoThroneSorter.length-1 && idx % 5 != 4) m += '</div>';
            if (idx % 5 == 4) m += '</div>';
        }
        m += '</div>';
        m += '</td>';


        m += '<td width=230px align=center style="vertical-align: top; text-align: middle;">';
        m += '<b>HOVER CARD:</b><br><div id=tcoThroneSortCardHover></div>';
        m += '</td>';

        m += '</tr>';
        m += '</table>';
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        t.displaySelectCard();

        var tcoThroneSorterItems = document.getElementsByClassName('tcoThroneSorterItem');

        for (var idx = 0; idx < tcoThroneSorterItems.length; idx++) {
            var tcoThroneSorterItem = tcoThroneSorterItems[idx];
            tcoThroneSorterItem.addEventListener('mouseover', function(A) {
                A.stopPropagation();
                var throneId = this.id.split('tcoThroneSorterInventoryIcon')[1];
                var throneItem = uW.kocThroneItems[throneId];
                //CM.ThroneView.hoverItem(A, this, throneItem);
                document.getElementById('tcoThroneSortCardHover').innerHTML = BuildThroneCard(throneItem);
            }, false);

            tcoThroneSorterItem.addEventListener('mouseout', function(A) {
                A.stopPropagation();
                var throneId = this.id.split('tcoThroneSorterInventoryIcon')[1];
                var throneItem = uW.kocThroneItems[throneId];
                //CM.ThroneView.hoverItem(A, this, throneItem);
                document.getElementById('tcoThroneSortCardHover').innerHTML = '';
            }, false);


            tcoThroneSorterItem.addEventListener('contextmenu', function(A) {
                A.preventDefault();
                var throneId = this.id.split('tcoThroneSorterInventoryIcon')[1];
                var throneItem = uW.kocThroneItems[throneId];
                if (!throneItem || throneItem == null) {
                    if (t.tcoLocalSwapFile == throneId) this.remove();
                    t.tcoLocalSwapFile = null;
                    setThroneSorter(true);
                    SAVEtcoThroneSorter();
                    t.show();
                    return;
                }
                if (t.tcoLocalSwapFile == null) {
                    t.tcoLocalSwapFile = throneId;
                    this.src = success_image;
                    t.displaySelectCard();
                } else {
                    if (t.tcoLocalSwapFile == throneId) {
                        t.tcoLocalSwapFile = null;
                        this.src = getThroneImage(throneItem);
                        t.displaySelectCard();
                        return;
                    }

                    var img = document.getElementById('tcoThroneSorterInventoryIcon' + t.tcoLocalSwapFile);
                    img.src = getThroneImage(uW.kocThroneItems[t.tcoLocalSwapFile]);


                    var fromTile = document.getElementById('tcoThroneSorterInventoryIcon' + t.tcoLocalSwapFile);
                    var fromTilePosition = 0;
                    var child = fromTile;
                    while( (child = child.previousSibling) != null ) fromTilePosition++;

                    var toTile = document.getElementById('tcoThroneSorterInventoryIcon' + throneId);
                    var toTilePosition = 0;
                    child = this;
                    while( (child = child.previousSibling) != null ) toTilePosition++;

                    var fromParent = fromTile.parentElement;
                    var toParent = toTile.parentElement;

                    var fromDelete = fromParent.children[fromTilePosition];
                    var toDelete = toParent.children[toTilePosition];

                    if (fromParent != toParent) { //simple swap
                        fromDelete.remove();
                        toDelete.remove();
                        fromParent.insertBefore(toTile, fromParent.childNodes[fromTilePosition]);
                        toParent.insertBefore(fromTile, toParent.childNodes[toTilePosition]);
                    } else { //little more tricky
                        var newRow = [];
                        for (var idx = 0; idx < fromParent.children.length; idx++) {
                            if (idx == fromTilePosition) {
                                newRow.unshift(toTile);
                            } else if (idx == toTilePosition) {
                                newRow.unshift(fromTile);
                            } else {
                                newRow.unshift(fromParent.children[idx]);
                            }
                        }
                        while (fromParent.hasChildNodes()) fromParent.removeChild(fromParent.lastChild);
                        while (newRow.length > 0) fromParent.appendChild(newRow.pop());
                    }
                    t.tcoLocalSwapFile = null;
                    t.displaySelectCard();
                    setThroneSorter(true);
                    SAVEtcoThroneSorter();
                    t.show();
                }
            }, false);
        }

        document.getElementById('tcoSorterDefaults').addEventListener('click', function () {
            resetThroneSorter();
            t.tcoLocalSwapFile = null;
            var cmContainerOpen = (document.getElementsByClassName('cmModalContainer').length == 1 ? true : false);
            if (cmContainerOpen) {
                var titlebar = document.getElementsByClassName('primarytitlebar')[0];
                var closebutton = titlebar.children[2];
                closebutton.click();
                setTimeout(function () { CM.ThroneView.openThrone(); }, 100);
            }
            t.show();
        }, false);

        document.getElementById('tcoSorterExport').addEventListener('click', function () {
            if (tcoThroneSorter.length == 0) return;
            uriContent = 'data:application/octet-stream,' + encodeURIComponent(JSON.stringify(tcoThroneSorter));
            newWindow = window.open(uriContent, 'file.txt');
        }, false);

        document.getElementById('tcoSorterImport').addEventListener('click', function () {
            var fileInput = document.getElementById("tcoSorterImportLoadItem");
            var files = fileInput.files;
            if (files.length==0) {
                alert('Please Select A File');
                return;
            }
            var file = files[0];
                
            var reader = new FileReader();
                
            reader.onload = function (e) {  
				var output = e.target.result;
				tcoThroneSorter = JSON.parse(output);
                SAVEtcoThroneSorter();
                t.show();
                alert('Throne Sorted Order Now Loaded From File');
            };
            reader.readAsText(file);     
        }, false);
        

    },

    displaySelectCard: function () {
        var t = Tabs.throneSorter;
        if (t.tcoLocalSwapFile == null) {
            document.getElementById('tcoThroneSortCard').innerHTML = "No Card Selected";
        } else {
            var throneItem = uW.kocThroneItems[t.tcoLocalSwapFile];
            document.getElementById('tcoThroneSortCard').innerHTML = BuildThroneCard(throneItem);   
        }
    },

}

Tabs.throneEnhStats = {
	tabOrder: 100,
	tabLabel: 'ENH&nbsp;STATS',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM ENHANCEMENT STATS',
	
	init: function (div) {
		var t = Tabs.throneEnhStats;
		t.mydiv = div;
        t.buildThroneEnhStatsDisplay();
	},
	
	hide: function () {},

	buildThroneEnhStatsDisplay: function () {

        var t = Tabs.throneEnhStats;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

//        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - (dlgWidthOffset*2.5)) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';

        m += '<table class=tcoStats align=center cellspacing=0>';

        m += '<tr valign=top align=center><th colspan=' + (tcoMaxThroneQuality + 2) + '>Enhancing Numbers  (successes/failures)</th></tr>';

        m += '<tr valign=top align=center><th></th>';
        for (qual = 0; qual <= tcoMaxThroneQuality; qual++) m += '<td style="font-weight: bold;" class="td' + (qual % 2 + 1) + '"  >' + throneCardQualities[qual].capitalizeFirstLetter() + '&nbsp;</td>';
        m += '</tr>';

        var st = [0, 0, 0, 0, 0, 0, 0];
        var ft = [0, 0, 0, 0, 0, 0, 0];

        for (lvl = 0; lvl <= tcoMaxThroneLevel; lvl++) {
            m += '<tr valign=top align=center>';
            m += '<th>';
            if (lvl != 0) m += '+';
            m += lvl + '</th>';
            for (qual = 0; qual < (tcoMaxThroneQuality+1); qual++) {
                if (tcoThroneUpgradeStats.enhanceSuccess[qual][lvl] == null) tcoThroneUpgradeStats.enhanceSuccess[qual][lvl] = 0;
                if (tcoThroneUpgradeStats.enhanceFailure[qual][lvl] == null) tcoThroneUpgradeStats.enhanceFailure[qual][lvl] = 0;
                st[qual] += tcoThroneUpgradeStats.enhanceSuccess[qual][lvl];
                ft[qual] += tcoThroneUpgradeStats.enhanceFailure[qual][lvl];
                m += '<td class="td' + (qual % 2) + '"  >' + tcoThroneUpgradeStats.enhanceSuccess[qual][lvl] + ' / ' + tcoThroneUpgradeStats.enhanceFailure[qual][lvl] + '</td>';
            }
            m += '</tr>';
        }

        m += '<tr valign=top align=center><th> Totals: </th>';
        for (qual = 0; qual < (tcoMaxThroneQuality+1); qual++) m += '<td style="font-weight: bold;" class="td' + (qual % 2) + '" >' + st[qual] + ' / ' + ft[qual] + '</td>';
        m += '</tr>';

        m += '<TR valign=top align=center><th> Percents: </th>';
        for (qual = 0; qual < (tcoMaxThroneQuality+1); qual++) {
            m += '<td style="font-weight: bold;" class="td' + (qual % 2) + '" >';
            if ((st[qual] + ft[qual]) == 0)
                m += "--";
            else {
                var perc = (100 * st[qual] / (st[qual] + ft[qual]));
                m += perc.toFixed(2) + '%';
            }
            m += '</td>';
        }
        m += '</tr>';

        m += '</table>';
        m += '</div>';

        m += '<center><input type=button class=tcoButton value="Clear Stats" id=tcoThroneEnhStatsClear></center>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoThroneEnhStatsClear').addEventListener('click', function () {

            var t = Tabs.throneEnhStats;
            for (lvl = 0; lvl <= tcoMaxThroneLevel; lvl++) {
                for (qual = 0; qual < (tcoMaxThroneQuality+1); qual++) {
                    tcoThroneUpgradeStats.enhanceSuccess[qual][lvl] = null;
                    tcoThroneUpgradeStats.enhanceFailure[qual][lvl] = null;
                }
            }
            SAVEtcoThroneUpgradeStats();
            t.buildThroneEnhStatsDisplay();

        }, false);
    
    },

	show: function () {
		var t = Tabs.throneEnhStats;
        t.buildThroneEnhStatsDisplay();
	},
}

Tabs.throneUpgStats = {
	tabOrder: 100,
	tabLabel: 'UPG&nbsp;STATS',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM UPGRADE STATS',
	
	init: function (div) {
		var t = Tabs.throneUpgStats;
		t.mydiv = div;
        t.buildThroneUpgStatsDisplay();
	},
	
	hide: function () {},
	
	buildThroneUpgStatsDisplay: function () {

		var t = Tabs.throneUpgStats;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - (dlgWidthOffset*2.5)) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        m += '<table class=tcoStats align=center cellspacing=0>';

        m += '<tr valign=top align=center><th colspan=' + (tcoMaxThroneLevel+2) + '>Upgrading Numbers  (successes/failures)</TH></TR>';

        m += '<tr valign=top align=center><th></th>';
        for (lvl = 0; lvl < tcoMaxThroneLevel; lvl++) m += '<td style="font-weight: bold;" class="td' + (lvl % 2) + '"  >&nbsp;+' + (lvl + 1) + '&nbsp;</td>';
        m += '</tr>';

        var st = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];  //TODO: change when game changes max throne level (currently 25)
        var ft = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

        for (qual = 0; qual <= tcoMaxThroneQuality; qual++) {
            m += '<tr valign=top align=center><th>' + throneCardQualities[qual].capitalizeFirstLetter() + '</th>';
            for (lvl = 0; lvl < tcoMaxThroneLevel; lvl++) {
                if (tcoThroneUpgradeStats.upgradeSuccess[qual][lvl] == null || isNaN(tcoThroneUpgradeStats.upgradeSuccess[qual][lvl])) tcoThroneUpgradeStats.upgradeSuccess[qual][lvl] = 0;
                if (tcoThroneUpgradeStats.upgradeFailure[qual][lvl] == null || isNaN(tcoThroneUpgradeStats.upgradeFailure[qual][lvl])) tcoThroneUpgradeStats.upgradeFailure[qual][lvl] = 0;
                st[lvl] += tcoThroneUpgradeStats.upgradeSuccess[qual][lvl];
                ft[lvl] += tcoThroneUpgradeStats.upgradeFailure[qual][lvl];

                m += '<td class="td' + (lvl % 2) + '"  >';
                m += tcoThroneUpgradeStats.upgradeSuccess[qual][lvl] + ' / ' + tcoThroneUpgradeStats.upgradeFailure[qual][lvl];
                m += '</td>';
            }
            m += '</tr>';
        }

        m += '<tr valign=top align=center><th> Totals: </th>';
        for (lvl = 0; lvl < tcoMaxThroneLevel; lvl++) m += '<td style="font-weight: bold;" class="td' + (lvl % 2) + '"  >' + st[lvl] + " / " + ft[lvl] + '</td>';
        m += '</tr>';

        m += '<tr valign=top align=center><th> Percents: </th>';
        for (lvl = 0; lvl < tcoMaxThroneLevel; lvl++) {
            m += '<td style="font-weight: bold;" class="td' + (lvl % 2) + '"  >';
            if ((st[lvl] + ft[lvl]) == 0)
                m += '--';
            else {
                var perc = (100 * st[lvl] / (st[lvl] + ft[lvl]));
                m += perc.toFixed(2) + '%';
            }
            m += '</td>';
        }
        m += '</tr>';

        m += '</table>';
        m += '</div>';

        m += '<center><input type=button class=tcoButton value="Clear Stats" id=tcoThroneUpgStatsClear></center>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoThroneUpgStatsClear').addEventListener('click', function () {
            var t = Tabs.throneUpgStats;
            for (lvl = 0; lvl <= tcoMaxThroneLevel; lvl++) {
                for (qual = 0; qual < (tcoMaxThroneQuality+1); qual++) {
                    tcoThroneUpgradeStats.upgradeSuccess[qual][lvl] = null;
                    tcoThroneUpgradeStats.upgradeFailure[qual][lvl] = null;
                }
            }
            SAVEtcoThroneUpgradeStats();
            t.buildThroneUpgStatsDisplay()
        }, false);

    },

	show: function () {
        var t = Tabs.throneUpgStats;
        t.buildThroneUpgStatsDisplay();
	},
}

Tabs.thronePresets = {
	tabOrder: 100,
	tabLabel: 'PRESETS',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM PRESETS',
    broke_count: 0,
    broke_items: 0,
    delay: 1000,
	
	init: function (div) {
		var t = Tabs.thronePresets;
		t.mydiv = div;
        //t.show();
	},
	
	hide: function () {},
	
    refreshBrokeMightDisplay: function () {
        document.getElementById('tcoThroneMightBroke').innerHTML = getThroneBrokeMight();
    },

	show: function () {
		var t = Tabs.thronePresets;

		var m = '<div class=tcoHeader>' + t.tabHeader + '<div class=tcoSaveSettings id=tcoThronePresetsSaveSettings title="Save Presets Settings"></div><div class=tcoLoadSettings id=tcoThronePresetsLoadSettings title="Load Presets Settings"></div></div>';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        m += '<table>';
        m += '<tr><td width=100%>Preset Color: <select class=tcoSelect id=tcoThronePresetColor>';
        m += '<option ' + (tcoThronePresetData.presetColor == "#FFFFFF" ? 'SELECTED ' : '') + 'value="#FFFFFF">White</option>';
        m += '<option ' + (tcoThronePresetData.presetColor == "#808080" ? 'SELECTED ' : '') + 'value="#808080">Gray</option>';
        m += '<option ' + (tcoThronePresetData.presetColor == "#FF0000" ? 'SELECTED ' : '') + 'value="#FF0000">Red</option>';
        m += '<option ' + (tcoThronePresetData.presetColor == "#FFFF00" ? 'SELECTED ' : '') + 'value="#FFFF00">Yellow</option>';
        m += '<option ' + (tcoThronePresetData.presetColor == "#00FF00" ? 'SELECTED ' : '') + 'value="#00FF00">Lime</option>';
        m += '<option ' + (tcoThronePresetData.presetColor == "#00FFFF" ? 'SELECTED ' : '') + 'value="#00FFFF">Aqua</option>';
        m += '<option ' + (tcoThronePresetData.presetColor == "#0000FF" ? 'SELECTED ' : '') + 'value="#0000FF">Blue</option>';
        m += '<option ' + (tcoThronePresetData.presetColor == "#FF00FF" ? 'SELECTED ' : '') + 'value="#FF00FF">Fuchsia</option>';
        m += '</select>';
        m += '&nbsp;&nbsp;&nbsp;General Color: <select class=tcoSelect id=tcoThroneTagColor>';
        m += '<option ' + (tcoThronePresetData.tagColor == "#FFFFFF" ? 'SELECTED ' : '') + 'value="#FFFFFF">White</option>';
        m += '<option ' + (tcoThronePresetData.tagColor == "#808080" ? 'SELECTED ' : '') + 'value="#808080">Gray</option>';
        m += '<option ' + (tcoThronePresetData.tagColor == "#FF0000" ? 'SELECTED ' : '') + 'value="#FF0000">Red</option>';
        m += '<option ' + (tcoThronePresetData.tagColor == "#FFFF00" ? 'SELECTED ' : '') + 'value="#FFFF00">Yellow</option>';
        m += '<option ' + (tcoThronePresetData.tagColor == "#00FF00" ? 'SELECTED ' : '') + 'value="#00FF00">Lime</option>';
        m += '<option ' + (tcoThronePresetData.tagColor == "#00FFFF" ? 'SELECTED ' : '') + 'value="#00FFFF">Aqua</option>';
        m += '<option ' + (tcoThronePresetData.tagColor == "#0000FF" ? 'SELECTED ' : '') + 'value="#0000FF">Blue</option>';
        m += '<option ' + (tcoThronePresetData.tagColor == "#FF00FF" ? 'SELECTED ' : '') + 'value="#FF00FF">Fuchsia</option>';
        m += '</select>';
        m += '&nbsp;&nbsp;&nbsp;Active Color: <select class=tcoSelect id=tcoThroneActiveColor>';
        m += '<option ' + (tcoThronePresetData.activeColor == "#FFFFFF" ? 'SELECTED ' : '') + 'value="#FFFFFF">White</option>';
        m += '<option ' + (tcoThronePresetData.activeColor == "#808080" ? 'SELECTED ' : '') + 'value="#808080">Gray</option>';
        m += '<option ' + (tcoThronePresetData.activeColor == "#FF0000" ? 'SELECTED ' : '') + 'value="#FF0000">Red</option>';
        m += '<option ' + (tcoThronePresetData.activeColor == "#FFFF00" ? 'SELECTED ' : '') + 'value="#FFFF00">Yellow</option>';
        m += '<option ' + (tcoThronePresetData.activeColor == "#00FF00" ? 'SELECTED ' : '') + 'value="#00FF00">Lime</option>';
        m += '<option ' + (tcoThronePresetData.activeColor == "#00FFFF" ? 'SELECTED ' : '') + 'value="#00FFFF">Aqua</option>';
        m += '<option ' + (tcoThronePresetData.activeColor == "#0000FF" ? 'SELECTED ' : '') + 'value="#0000FF">Blue</option>';
        m += '<option ' + (tcoThronePresetData.activeColor == "#FF00FF" ? 'SELECTED ' : '') + 'value="#FF00FF">Fuchsia</option>';
        m += '</select>(Requires Refresh)</td></tr>';
        m += '<tr><td>';
        m += '<input type=button class=tcoButton id=tcoThroneClearTags value="Clear All Tags">&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton id=tcoThroneClearAllPresetTags value="Clear All Preset Tags">&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton id=tcoThroneSaveAllPresetTags value="Save All Preset Tags">&nbsp;&nbsp;';
        //m += '<input type=button id=trExportPresetTags value="Export Preset Tags">';
        m += '</td></tr>';
        m += '<tr><td>';
        m += '<input type=checkbox class=tcoCheckbox id=tcoThroneShowMight ' + (tcoThronePresetData.showThroneMight ? 'CHECKED' : '') + '/>Show Might on Posts';
        m += '&nbsp;&nbsp;&nbsp;<input type=checkbox class=tcoCheckbox id=tcoThroneShowName ' + (tcoThronePresetData.showThroneName ? 'CHECKED' : '') + '/>Show Preset Name on Posts';
        m += '</td></tr>';
        m += '</table>';
        
        
        m += '<div class=tcoHeader id=tcoThronePresetNaming onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;PRESET NAMING&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        var presetSlots = getObjectCollectionCount(Seed.throne.slotEquip);
        var presetsList = "";
        for (i = 1; i < presetSlots + 1; i++) {
            presetsList += '<option value="' + i + '">' + i + '</option>';
        }
        for (i = 1; i < presetSlots + 1; i++) {
            m += '<tr>';
            m += '<td><input class="tcoThronePresetSlotPost tcoButton" type=button id=tcoThronePreset' + i + ' value="Post Slot"></td>';
            m += '<td><input class="tcoThronePresetTagPost tcoButton" type=button id=tcoThronePreset' + i + ' value="Post Tag"></td>';
            m += '<td>&nbsp;<b>Preset ' + i + ': </b></td>';
            m += '<td><input class=tcoThronePresetNameEntry type=text size=15 id=tcoThronePresetName' + i + ' value="' + tcoThronePresetData.presetNames[i] + '"></td>';
            m += '<td><input class="tcoThronePresetCopyTo tcoButton" type=button id=tcoThronePreset' + i + ' value="Copy To"><select class=tcoSelect id=tcoThronePresetCopyToWhat' + i + '>' + presetsList + '</select></td>';
            m += '<td><input class="tcoThronePresetSave tcoButton" type=button id=tcoThronePreset' + i + ' value="Save"></td>';

            if (getThronePresetTagCount(i) != 0) {
                m += '<td><input class="tcoThronePresetClear tcoButton" type=button id=tcoThronePreset' + i + ' value="Clear"></td>';
                m += '<td><input class="tcoThronePresetExcel tcoButton" type=button id=tcoThronePreset' + i + ' value="Excel"></td>';
            } else {
                m += '<td/><td/>';
            }
            m += '</tr>';
        }
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;THRONE ROOM BREAKING&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td><div id=tcoThroneMightBroke>You have 0 throne room might broken</div></td></tr>';
        m += '<tr><td><input type=checkbox checked class=tcoCheckbox id=tcoThroneExcludePresets>Exclude Tagged Presets</td></tr>';
        m += '<tr><td><input type=checkbox checked class=tcoCheckbox id=tcoThroneExcludeTags>Exclude Regular Tagged</td></tr>';
        m += '<tr><td>Break Items Level <select class=tcoSelect id=tcoThroneBreakLevelLow>';
        for (lvl = 1; lvl < tcoMaxThroneLevel; lvl++) {
            m += '<option value=' + lvl + '>+' + lvl + '</option>';
        }
        m += '</select> or Higher</td></tr>';
        m += '<tr><td>Break Items Level <select class=tcoSelect id=tcoThroneBreakLevelHigh>';
        for (lvl = 1; lvl < tcoMaxThroneLevel; lvl++) {
            m += '<option value=' + lvl + (lvl == tcoMaxThroneLevel - 1 ? ' SELECTED' : '') + '>+' + lvl + '</option>';
        }
        m += '</select> or Lower</td></tr>';

        m += '<tr><td><input type=button class=tcoButton id=tcoThroneBreakAll value="Break Now"><font color=red><i>(all options above will reset after refresh)</i></font></td></tr>';
        m += '<tr><td><div id=tcoThroneBreakCounter></div></td></tr>';
        m += '<tr><td><hr></td></tr>';
        m += '<tr><td>Break Equiped Throne Room Only<select class=tcoSelect id=tcoThronePresetEquipBreak>' + presetsList + '</select><input type=button class=tcoButton id=tcoThronePresetEquipBreakNow value="Break Now"></td></tr>';
        m += '<tr><td>Break Tagged Preset Only<select class=tcoSelect id=tcoThronePresetTaggedBreak>' + presetsList + '</select><input type=button class=tcoButton id=tcoThronePresetTaggedBreakNow value="Break Now"></td></tr>';
        m += '<tr><td>Break <input type=number class=tcoText id=tcoThroneMightBreak oncontextmenu="return false;"> Throne Might <input type=button class=tcoButton id=tcoThroneMightBreakNow value="Break Now"></td></tr>';
        m += '</table>';
        m += '</div>';
        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoThronePresetsSaveSettings').addEventListener('click', function () {
            SaveSettingsToFile(tcoThronePresetData);
        }, false);
        document.getElementById('tcoThronePresetsLoadSettings').addEventListener('click', function () {
            var loader = document.getElementById('tcoSettingsFile');
            loader.addEventListener('change', function () {
                LoadSettingsFromFile(tcoThronePresetData, Tabs.thronePresets);
            }, false);
            loader.click();
        }, false);

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        t.refreshBrokeMightDisplay();

        document.getElementById('tcoThroneShowMight').addEventListener('change', function () {
            tcoThronePresetData.showThroneMight = document.getElementById('tcoThroneShowMight').checked;
            SAVEtcoThronePresetData();
        }, false);

        document.getElementById('tcoThroneShowName').addEventListener('change', function () {
            tcoThronePresetData.showThroneName = document.getElementById('tcoThroneShowName').checked;
            SAVEtcoThronePresetData();
        }, false);

        document.getElementById('tcoThroneSaveAllPresetTags').addEventListener('click', function () {
            for (i = 1; i < presetSlots + 1; i++) {
                t.addPresetTags(i);
            }
            t.show();
            document.getElementById('tcoThronePresetNaming').click();
        }, false);

        document.getElementById('tcoThroneClearTags').addEventListener('click', function () {
            t.clearAllTagItems();
        }, false);

        document.getElementById('tcoThroneClearAllPresetTags').addEventListener('click', function () {
            t.clearAllPresetTagItems();
            t.show();
            document.getElementById('tcoThronePresetNaming').click();
        }, false);

        document.getElementById('tcoThroneActiveColor').addEventListener('change', function () {
            tcoThronePresetData.activeColor = document.getElementById('tcoThroneActiveColor').value;
            SAVEtcoThronePresetData();
        }, false);

        document.getElementById('tcoThronePresetColor').addEventListener('change', function () {
            tcoThronePresetData.presetColor = document.getElementById('tcoThronePresetColor').value;
            SAVEtcoThronePresetData();
        }, false);

        document.getElementById('tcoThroneTagColor').addEventListener('change', function () {
            tcoThronePresetData.tagColor = document.getElementById('tcoThroneTagColor').value;
            SAVEtcoThronePresetData();
        }, false);

        document.getElementById('tcoThroneMightBreak').addEventListener('keydown', function (e) {
            // Allow: backspace, delete, tab, escape, enter and .
            if (e.keyCode == 46 || e.keyCode == 8 || e.keyCode == 9 || e.keyCode == 27 || e.keyCode == 13 || e.keyCode == 110 || e.keyCode == 190 || 
            // Allow: Ctrl+A
                (e.keyCode == 65 && e.ctrlKey === true) || 
            // Allow: home, end, left, right
                (e.keyCode >= 35 && e.keyCode <= 39) ||
            // Allow: F5
                (e.keyCode == 116))
            {
                // let it happen, don't do anything
                return;
            }

            // Ensure that it is a number and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105) || e.keyCode == 190 || e.keyCode == 110 ) 
            {
                e.preventDefault();
            }
        }, false);



        document.getElementById('tcoThroneMightBreak').addEventListener('keyup', function (e) {
            document.getElementById('tcoThroneMightBreak').value = document.getElementById('tcoThroneMightBreak').value.replace('.','');
            document.getElementById('tcoThroneMightBreak').value = document.getElementById('tcoThroneMightBreak').value.replace(',','');
        }, false);


        function BreakIt( cardsToBreak ) {
            var t = Tabs.thronePresets;

            if (!cardsToBreak || cardsToBreak == null) return;

            if (cardsToBreak.length == 0) {
                alert('No throne items to break');
                return;
            }

            t.broke_count = cardsToBreak.length;

            //t.setBreakStatus();

            t.broke_items = 0;

            //var items_broke = 0;  //this will be the counter for the # of throne items broke

            for (var i = 0; i < cardsToBreak.length; i++) {  //loop through all the throne items to be broke

                var citytobreakfrom = 0;  //start at the first city {the index is 0-based}

                var throne_item = uW.kocThroneItems[cardsToBreak[i]];  //get the next throne item in the collection

                var curr_level = throne_item.level;  //get the current level of the throne item

                var throne_id = throne_item.id;  //get the throne item id

                //var curr_might = throne_item

                if (curr_level == tcoMaxThroneLevel) continue;  //if for some reason a card at the max level makes it through the list then continue to the next in the list

                var cost_to_upgrade = CM.thronestats.upgrade[curr_level + 1].Stones;  //get the cost of stones to upgrade to the next level

                while (citytobreakfrom < 8) {  //loop through all the 8 cities checking for astone to upgrade for the break feature

                    stones_in_city = parseInt(Seed.resources["city" + Seed.cities[citytobreakfrom][0]]["rec5"][0]);  //get the astone count for the city

                    if (cost_to_upgrade + tcoBreakBuffer <= stones_in_city) break;  //if you have the astone in the city then stop searching cities and do the upgrade

                    citytobreakfrom = citytobreakfrom + 1;  //search to the next city in the loop

                }

                if (citytobreakfrom == 8) continue;  //if you make it to 8, then you've exhausted all the cities astone search for this throne item, move to the next one

                var params = uW.Object.clone(ajfx);
                params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';
                params.action = 'upgradeLevel';
                params.throneRoomItemId = throne_id;
                params.buffItemId = 0;
                params.payment = "aetherstone";
                params.cityId = Seed.cities[citytobreakfrom][0];

                //items_broke = items_broke + 1;
                t.broke_items += 1;

                Seed.resources["city" + Seed.cities[citytobreakfrom][0]]["rec5"][0] = Seed.resources["city" + Seed.cities[citytobreakfrom][0]]["rec5"][0] - cost_to_upgrade;

                new AjaxRequest(uW.g_ajaxpath + "ajax/_dispatch53.php" + uW.g_ajaxsuffix, {
                    method: "post",
                    parameters: params,
                    loading: true,
                    onSuccess: function (transport) {
                        try {
                            var rslt = eval("(" + transport.responseText + ")");
                            if (rslt.ok) {
                                if (rslt.updateSeed) uW.update_seed(rslt.updateSeed);
                            }

                            if (rslt.gems > 0) {
                                alert("UNEXPECTED ERROR: 'BREAK TR' accidentally spent gems.... Stopping now!");
                                ActionLog('BREAK TR accidentally spent gems!  Stopping now!');
                                return;
                            }

                            //if (rslt.success) i--;

                        } catch (e) {
                        }
                    },
                    onFailure: function (rrr) {
                        CM.ThroneView.renderInventory(uW.kocThroneItems);
                    }
                });

            }

            CM.ThroneView.renderInventory(uW.kocThroneItems);
            if (t.broke_items == 0) {
                alert('No Items broken. (NOTE: check astone levels if items should have been broke)');
            } else {
                alert('Breaking TR complete.  ' + t.broke_items + ' Throne items were broken.  Page will now refresh.');
                RefreshCamelot();
            }
        }

        document.getElementById('tcoThroneBreakAll').addEventListener('click', function () {
            if (!confirm('You cannot undo this action, are you sure you want to break your throne room?')) return;
            var excludePresets = document.getElementById('tcoThroneExcludePresets').checked;
            var excludeTags = document.getElementById('tcoThroneExcludeTags').checked;
            var breakLevelLow = document.getElementById('tcoThroneBreakLevelLow').value;
            var breakLevelHigh = document.getElementById('tcoThroneBreakLevelHigh').value;
            var allTaggedPresets = [];
            if (excludePresets) {
                for (i = 1; i < presetSlots + 1; i++) {
                    if (getThronePresetTagCount(i) != 0) {
                        var thisPreset = getThronePresetObject(i);
                        for (throneId in thisPreset) {
                            var throne_item = uW.kocThroneItems[throneId];
                            if (throne_item == null || !throne_item) continue;
                            if (throne_item.level == tcoMaxThroneLevel) continue;
                            if (throne_item.level < breakLevelLow || throne_item.level > breakLevelHigh) continue;
                            allTaggedPresets.push(throneId);
                        }
                    }
                }
            }
            var throneToBreak = [];
            for (trId in uW.kocThroneItems) {
                var throne_item = uW.kocThroneItems[trId];
                if (throne_item == null || !throne_item) continue;
                if (throne_item.isBroken) continue;
                if (excludeTags && tcoThronePresetData.taggedItems[trId]) continue;
                if (allTaggedPresets.indexOf(trId) != -1) continue;
                if (throne_item.level == tcoMaxThroneLevel) continue;
                if (throne_item.level < breakLevelLow || throne_item.level > breakLevelHigh) continue;

                throneToBreak.push(trId);
            }
            delete allTaggedPresets;

            BreakIt(throneToBreak);

        }, false);


        document.getElementById('tcoThroneMightBreakNow').addEventListener('click', function () {
            document.getElementById('tcoThroneMightBreak').value = document.getElementById('tcoThroneMightBreak').value.replace('.','');
            document.getElementById('tcoThroneMightBreak').value = document.getElementById('tcoThroneMightBreak').value.replace(',','');
            var mightReach = document.getElementById('tcoThroneMightBreak').value;
            if (!isNumeric(mightReach)) return;
            if (!confirm('You cannot undo this action, are you sure you want to break?')) return;
            var throneToBreak = [];
            var mightTally = 0;
            for (var throneId in uW.kocThroneItems) {
                if (mightTally >= mightReach) break;
                var throne_item = uW.kocThroneItems[throneId];
                var throne_might = CM.ThroneView.getMightBonus(throne_item);
                mightTally += throne_might;
                throneToBreak.push(throneId);
            };
            BreakIt(throneToBreak);
        }, false);

        document.getElementById('tcoThronePresetEquipBreakNow').addEventListener('click', function () {
            if (!confirm('You cannot undo this action, are you sure you want to break?')) return;
            var throneToBreak = [];
            var equipped_items = Seed.throne.slotEquip[Seed.throne.activeSlot];
            for (ei = 0; ei < equipped_items.length; ei++) { throneToBreak.push(equipped_items[ei]); }
            BreakIt(throneToBreak);
        }, false);

        document.getElementById('tcoThronePresetTaggedBreakNow').addEventListener('click', function () {
            if (!confirm('You cannot undo this action, are you sure you want to break?')) return;
            var throneToBreak = [];
            var tcoThronePresetTaggedBreak = document.getElementById('tcoThronePresetTaggedBreak').value;
            var thronePreset = getThronePresetObject(parseInt(tcoThronePresetTaggedBreak));
            for (var throneId in thronePreset) throneToBreak.push(throneId);
            BreakIt(throneToBreak);
        }, false);

        function isNumeric(n) { return !isNaN(parseFloat(n)) && isFinite(n); }


        // read the preset names and descriptions
        var tcoThronePresetNameEntry = document.getElementsByClassName('tcoThronePresetNameEntry');
        for (var elem=0; elem<tcoThronePresetNameEntry.length;elem++) {
            tcoThronePresetNameEntry[elem].addEventListener('change', function () {
                var id = this.id;
                var num = id.split('tcoThronePresetName')[1];
                var presetName = this.value;
                if (presetName == "") {
                    presetName = "undefined";
                    this.value = presetName;
                }
                tcoThronePresetData.presetNames[num] = presetName;
                SAVEtcoThronePresetData();
            }, false);
            tcoThronePresetNameEntry[elem].addEventListener('blur', function () {
                var id = this.id;
                var num = id.split('tcoThronePresetName')[1];
                var presetName = this.value;
                if (presetName == "") {
                    presetName = "undefined";
                    this.value = presetName;
                    tcoThronePresetData.presetNames[num] = presetName;
                    SAVEtcoThronePresetData();
                }
            }, false);
        }

        var tcoThronePresetTagPost = document.getElementsByClassName('tcoThronePresetTagPost');
        for (var elem=0; elem<tcoThronePresetTagPost.length;elem++) {
            tcoThronePresetTagPost[elem].addEventListener('click', function () {
                var id = this.id;
                var num = id.split('tcoThronePreset')[1];
                postThronePreset(num);
            }, false);
        }

        var tcoThronePresetSlotPost = document.getElementsByClassName('tcoThronePresetSlotPost');
        for (var elem=0; elem<tcoThronePresetSlotPost.length;elem++) {
            tcoThronePresetSlotPost[elem].addEventListener('click', function () {
                var id = this.id;
                var num = id.split('tcoThronePreset')[1];
                postThroneSlot(num);
            }, false);
        }

        var tcoThronePresetCopyTo = document.getElementsByClassName('tcoThronePresetCopyTo');
        for (var elem=0; elem<tcoThronePresetCopyTo.length;elem++) {
            tcoThronePresetCopyTo[elem].addEventListener('click', function () {
                var id = this.id;
                var sourceNum = id.split("tcoThronePreset")[1];
                var destNum = document.getElementById("tcoThronePresetCopyToWhat" + sourceNum).value;
                var copyName = document.getElementById("tcoThronePresetName" + sourceNum).value;
                t.copyPresetTags(sourceNum, destNum, copyName);
                t.show();
                document.getElementById('tcoThronePresetNaming').click();
            }, false);
        }

        var tcoThronePresetClear = document.getElementsByClassName('tcoThronePresetClear');
        for (var elem=0; elem<tcoThronePresetClear.length;elem++) {
            tcoThronePresetClear[elem].addEventListener('click', function () {
                var id = this.id;
                var num = id.split("tcoThronePreset")[1];
                t.clearPresetTags(num);
                t.show();
                document.getElementById('tcoThronePresetNaming').click();
            }, false);
        }

        var tcoThronePresetExcel = document.getElementsByClassName('tcoThronePresetExcel');
        for (var elem=0; elem<tcoThronePresetExcel.length;elem++) {
            tcoThronePresetExcel[elem].addEventListener('click', function () {
                var id = this.id;
                var num = id.split("tcoThronePreset")[1];
                ExportThronePresetToExcel(num);
            }, false);
        }

        var tcoThronePresetSave = document.getElementsByClassName('tcoThronePresetSave');
        for (var elem=0; elem<tcoThronePresetSave.length;elem++) {
            tcoThronePresetSave[elem].addEventListener('click', function () {
                var id = this.id;
                var num = id.split("tcoThronePreset")[1];
                t.addPresetTags(num);
                t.show();
                document.getElementById('tcoThronePresetNaming').click();
            }, false);
        }

  	},

    paintTags: function () {

        var equipped_items = Seed.throne.slotEquip[Seed.throne.activeSlot];

        for (ei = 0; ei < equipped_items.length; ei++) {
            var throneId = equipped_items[ei];
            $("#throneInventoryItem" + throneId).children(".activeBorderThrone").remove(); //remove any tag first before applying the tag to avoid doubling, trippling up on the borders, etc
            $("#throneInventoryItem" + throneId).prepend("<div class='activeBorderThrone'></div>");
        }

        for (p in tcoThronePresetData.taggedItems) {
            $("#throneInventoryItem" + p).children(".tagBorderThrone").remove(); //remove any tag first before applying the tag to avoid doubling, trippling up on the borders, etc
            $("div#throneInventoryItem" + p).prepend("<div class='tagBorderThrone'></div>");
        }

        for (idx = 1; idx < (tcoMaxPresets+1); idx++) {
            var preset = getThronePresetObject(idx);
            if (getObjectCollectionCount(preset) > 0) {
                for (p in preset) {
                    $("#throneInventoryItem" + p).children(".presetBorderThrone").remove(); //remove any tag first before applying the tag to avoid doubling, trippling up on the borders, etc
                    $("#throneInventoryItem" + p).prepend("<div class='presetBorderThrone'></div>");
                }
            }
        }

        if (tcoGeneralOptions.showJewels) {
            for (trId in uW.kocThroneItems) {
                var throne_item = uW.kocThroneItems[trId];
                if (throne_item.jewel && throne_item.jewel.valid && !throne_item.isBroken) {
                    $("#throneInventoryItem" + throne_item.id).children(".jewelIcon").remove();
                    $("div#throneInventoryItem" + throne_item.id).append("<div class='jewelIcon'><img style='float:right;' src='" + tcoJewelImages[throne_item.jewel.quality] + "'></div>");
                }
            }
        }

        $("#advisorContainer").click(function () { ThroneMenuPopup('advisorContainer'); });
        $("#heroContainer").click(function () { ThroneMenuPopup('heroContainer'); });
        $("#chairContainer").click(function () { ThroneMenuPopup('chairContainer'); });
        $("#candelabrumContainer").click(function () { ThroneMenuPopup('candelabrumContainer'); });
        $("#tableContainer").click(function () { ThroneMenuPopup('tableContainer'); });
        $("#windowContainer").click(function () { ThroneMenuPopup('windowContainer'); });
        $("#bannerContainer").click(function () { ThroneMenuPopup('bannerContainer'); });
        $("#trophyContainer").click(function () { ThroneMenuPopup('trophyContainer'); });
        $("#statueContainer").click(function () { ThroneMenuPopup('statueContainer'); });
        $("#petContainer").click(function () { ThroneMenuPopup('petContainer'); });
        $("#tapestryContainer").click(function () { ThroneMenuPopup('tapestryContainer'); });
        $("#pillarContainer").click(function () { ThroneMenuPopup('pillarContainer'); });  

        function ThroneMenuPopup(displayContainer) {
            var throneType = displayContainer.split('Container')[0];
            var equipped_items = Seed.throne.slotEquip[Seed.throne.activeSlot];
            for (ei = 0; ei < equipped_items.length; ei++) {
                var trId = equipped_items[ei]
                if (uW.kocThroneItems[trId].type == throneType) break;
                trId = ''
            }
            if (trId == '') return;
            var throne_item = uW.kocThroneItems[trId];
            if (throne_item == null || !throne_item) return;
            var thisDiv = document.getElementById(displayContainer);
            var trDiv = document.getElementById('throneInventoryItem' + trId);
            var oldDiv = trDiv.parentNode;
            thisDiv.appendChild(trDiv);
            CM.ContextualMenuThrone.renderMenu(trDiv, throne_item);
            oldDiv.appendChild(trDiv);
        };



    },

    unequipAllItems: function (presetIndex) {

        if (Seed.throne.activeSlot != presetIndex) {
            Seed.throne.activeSlot = presetIndex;
        }

        var t = Tabs.throneOrganizer;

        if (t.switchingPresets) {
            alert("still unequipping");
            return;
        }

        if (!confirm('Are you sure you want to unequip all items?')) return;

        var c = 0;
        t.switchingPresets = true;

        // grab the list of items equipped in the slot about to be switched to
        var delay = 7;

        var equipped_items = Seed.throne.slotEquip[presetIndex];

        var counter = equipped_items.length;

        var items = [];

        for (i = 0; i < counter; i++) items.push(equipped_items[i]);

        while (counter > 0) {
            var throne_item = uW.kocThroneItems[items.pop()];

            var goUnequip = function (I2, s) {
                return function () {
                    Tabs.throneOrganizer.unequipItem(I2, s);
                };
            }

            setTimeout(goUnequip(throne_item, presetIndex), c * delay * 1000); // have to wait at least 5 seconds between switches
            c++;
            counter--;
        }

        setTimeout(function () {
            t.switchingPresets = false;
            alert("all throne items unequipped")
        }, c * delay * 1000 + 1000);

    },

    equipPresetTags: function (presetIndex) {

        if (Seed.throne.activeSlot != presetIndex) {
            Seed.throne.activeSlot = presetIndex;
        }

        var t = Tabs.throneOrganizer;

        var preset = getThronePresetObject(presetIndex);

        if (t.switchingPresets) {
            alert("still equipping");
            return;
        }

        if (getObjectCollectionCount(preset) == 0) {
            alert("preset is empty");
            return;
        }

        var c = 0;
        t.switchingPresets = true;

        var delay = 7;

        var types_equiped = [];

        for (p in preset) {

            // only equip the items not already equipped
            var throne_item = uW.kocThroneItems[p];

            types_equiped.push(throne_item.type);

            if (!throne_item.isEquipped) {

                var goEquip = function (I2, s) {
                    return function () {
                        Tabs.throneOrganizer.equipItem(I2, s);
                    };
                }

                setTimeout(goEquip(throne_item, presetIndex), c * delay * 1000); // have to wait at least 5 seconds between switches
                c++;
            }

        }

        var equipped_items = Seed.throne.slotEquip[presetIndex];

        var counter = equipped_items.length;

        var items_to_unequip = [];

        for (i = 0; i < counter; i++) {
            var throne_item = uW.kocThroneItems[equipped_items[i]];
            var idx = types_equiped.indexOf(throne_item.type);
            if (idx == -1) { //item in equipped items is not found among the types that were equipped, so unequip it

                var goUnequip = function (I2, s) {
                    return function () {
                        Tabs.throneOrganizer.unequipItem(I2, s);
                    };
                }

                setTimeout(goUnequip(throne_item, presetIndex), c * delay * 1000); // have to wait at least 5 seconds between switches
                c++;

            }
        }

        setTimeout(function () {
            t.switchingPresets = false;
            alert("preset #" + presetIndex + " loaded from tagged preset")
        }, (c * (delay * 1000)) + 1000);

    },

    copyPresetTags: function (sourcePresetNumber, destinationPresetNumber, presetName) {
        var pSource = getThronePresetObject(parseInt(sourcePresetNumber));
        var pDestination = getThronePresetObject(parseInt(destinationPresetNumber));
        for (var p in pDestination) delete pDestination[p];
        for (var p in pSource) pDestination[p] = true;
        tcoThronePresetData.presetNames[destinationPresetNumber] = presetName + " (copy)";
        SAVEtcoThronePresetData();
    },


    addPresetTags: function (presetIndex) {  //presetIndex should be passed in as base 0 to index into the presetTaggedItems array
        var t = Tabs.thronePresets;

        var preset = getThronePresetObject(parseInt(presetIndex));

        var equipped_items = Seed.throne.slotEquip[parseInt(presetIndex)];

        for (var p in preset) delete preset[p];

        for (ei = 0; ei < equipped_items.length; ei++) {
            var throneId = equipped_items[ei];
            preset[throneId] = true;
            $("#throneInventoryItem" + throneId).prepend("<div class='presetBorderThrone'></div>");
            SAVEtcoThronePresetData();
        }

        t.paintTags();
        
    },

    clearPresetTags: function (presetIndex) {
        var preset = getThronePresetObject(parseInt(presetIndex));
        for (var p in preset) {
            delete preset[p];
            $("#throneInventoryItem" + p).children(".presetBorderThrone").remove();
            SAVEtcoThronePresetData();
        }
    },

    removeTagItem: function (itemId) {
        if (tcoThronePresetData.taggedItems[itemId]) {
            delete tcoThronePresetData.taggedItems[itemId];
            $("#throneInventoryItem" + itemId).children(".tagBorderThrone").remove();
            SAVEtcoThronePresetData();
        }
    },

    addTagItem: function (itemId) {
        tcoThronePresetData.taggedItems[itemId] = true;
        $("#throneInventoryItem" + itemId).prepend("<div class='tagBorderThrone'></div>");
        SAVEtcoThronePresetData();
    },

    addAllTagItems: function() {
        var t = Tabs.thronePresets;
        t.clearAllTagItems();
        for (trId in uW.kocThroneItems) {
            tcoThronePresetData.taggedItems[trId] = true;
            $("#throneInventoryItem" + trId).prepend("<div class='tagBorderThrone'></div>");
        }
        SAVEtcoThronePresetData();
    },

    clearAllTagItems: function () {
        var taggedReverse = [];
        for (k in tcoThronePresetData.taggedItems) taggedReverse.push(k);
        var len = taggedReverse.length;
        while (len--) {
            var trID = taggedReverse[len];
            delete tcoThronePresetData.taggedItems[trID];
            //$("#throneInventoryItem" + trID).children(".tagBorderThrone").remove();
            SAVEtcoThronePresetData();
        }
    },

    clearAllPresetTagItems: function () {
        if (!confirm('Are you sure you want to clear all preset tag items?')) return;
        var presetCount = getObjectCollectionCount(Seed.throne.slotEquip) + 1;
        for (i = 1; i < presetCount; i++) {
            document.getElementById('tcoThronePresetName' + i).value = "undefined";
            tcoThronePresetData.presetNames[i] = "undefined";
            var preset = getThronePresetObject(i);
            for (var p in preset) {
                delete preset[p];
                $("#throneInventoryItem" + p).children(".presetBorderThrone").remove();
                SAVEtcoThronePresetData();
            }
        }
    },

    setBreakStatus: function() {
        var t = Tabs.thronePresets;
        var remaining = t.broke_count - t.broke_items;
        var m =  "Items Remaining: " + remaining;
        m += "<br>Time Remaining: " + (remaining * (t.delay/1000)) + " Seconds";
        document.getElementById('tcoThroneBreakCounter').innerHTML = m;
    },


}

Tabs.thronePreview = {
	tabOrder: 100,
	tabLabel: 'PREVIEW',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM PREVIEW',
    equipingPreview: false,
	
	init: function (div) {
		var t = Tabs.thronePreview;
		t.mydiv = div;
	},
	
	hide: function () {},
	
	show: function () {
		var t = Tabs.thronePreview;

        var presetSlots = getObjectCollectionCount(Seed.throne.slotEquip);

        var presetsTagList = "";

        for (i = 1; i < presetSlots + 1; i++) {
            presetsTagList += '<option value="' + i + '">' + i + ' (' + tcoThronePresetData.presetNames[i] + ')</option>';
        }


		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';

        m += '<table>';
        m += '<tr>';
        m += '<td colspan=3>';
        m += '<input type=button class=tcoButton value="Reset" id=tcoThronePreviewReset>&nbsp;&nbsp;||&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton value="Equip Now" id=tcoThronePreviewEquip><font color=black><b>(5 sec per card to load)</b></font>&nbsp;&nbsp;||&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton value="Post Stats to Chat" id=tcoThronePreviewPost>&nbsp;';
        m += '<input type=button class=tcoButton value="Export to Excel" id=tcoThronePreviewExcel>&nbsp;';
        m += '<br>';
        m += '<input type=button class=tcoButton value="Export To Text" id=tcoThronePreviewExport>&nbsp;&nbsp;||&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton value="Load Text Export" id=tcoThronePreviewExportLoad>';
        m += '<input type=button class=tcoButton value="Browse..." id=tcoThronePreviewExportLoadItemTrigger onclick="document.getElementById(\'tcoThronePreviewExportLoadItem\').click()">';
        m += '<input hidden id=tcoThronePreviewExportLoadItem type=file>';
        m += '<br>';
        m += '<input type=button class=tcoButton value="Load ThronePreset" id=tcoThronePreviewLoadPreset>&nbsp;<select class=tcoSelect style="width:25%;" id=tcoThronePreviewLoadPresetValue>' + presetsTagList + '</select>&nbsp;&nbsp;';
        m += '<br>';
        m += '<input type=button class=tcoButton value="Copy To" id=tcoThronePreviewCopyTo><b>&nbsp;Preset Tag&nbsp;</b><select class=tcoSelect style="width:25%;" id=tcoThronePreviewCopyToValue>' + presetsTagList + '</select>&nbsp;&nbsp;';
        m += '<br>';
        m += '<input type=button class=tcoButton value="Load Throne From" id=tcoThronePreviewLoadPresetTag><b>&nbsp;Preset Tag&nbsp;</b><select class=tcoSelect style="width:25%;" id=tcoThronePreviewLoadPresetTagValue>' + presetsTagList + '</select>&nbsp;&nbsp;';
        m += '<br>';
        m += '<input type=button class=tcoButton value="Auto Build By Effect" id=tcoThronePreviewAutoBuild><b>&nbsp;Effect&nbsp;</b><select class=tcoSelect style="width:25%;" id=tcoThronePreviewAutoBuildEffect>';
        m += '<option value="0">--Effects--</option>';
        for (efx in CM.thronestats.effects) m += '<option value="' + efx + '">' + CM.thronestats.effects[efx][1] + '</option>';
        m += '</select>&nbsp;&nbsp;';
        m += '</td>';
        m += '</tr>';
        m += '</table>';


        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;PREVIEW STATS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="position: static; width: 100%; height: 380px; overflow-x: auto; overflow-y: auto;">';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td>';
        m += '<div id=tcoThronePreviewDetails></div>';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;PREVIEW CARDS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="position: static; width: 100%; height: 380px; overflow-x: auto; overflow-y: auto;">';
        m += '<table class=tcoSectionTable>';

        m += '<tr>';
        for (idx = 0; idx < throneCardTypes.length; idx++) {
            if (idx % 3 == 0) m += '</tr><tr>';
            m += '<td width=33% valign=top>';
            m += '<div id=tcoThroneHover' + throneCardTypes[idx] + '>';
            m += '<table>';
            m += '<tr><td><b>' + throneCardTypes[idx].toUpperCase() + '<b></td></tr>';
            m += '<tr><td><select class=tcoSelect id=tcoThronePreviewValue' + throneCardTypes[idx] + ' style="white-space:nowrap;display:inline-block;max-width: 150px;">';
            m += '<option value=0>--Items--</option>';
            m += '</select></td></tr>';
            m += '<tr><td><div id=tcoThronePreviewCard' + throneCardTypes[idx] + '></div></td></tr>';
            m += '</table>';
            m += '</div>';
            m += '</td>';
        }
        m += '</tr>';

        m += '</table>';
        m += '</div>';


        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        for (throneId in uW.kocThroneItems) {
            var throneItem = uW.kocThroneItems[throneId];
            var throneType = throneItem.type;
            var elemSelect = document.getElementById('tcoThronePreviewValue' + throneType);
            elemSelect.options.add(new Option(throneItem.name, throneId));
            if (tcoThronePresetData.previewThrone[throneId]) {
                elemSelect.value = throneId;
                var throneCard = BuildThroneCard(throneItem);
                document.getElementById('tcoThronePreviewCard' + throneType).innerHTML = throneCard;
            }
        }

        for (idx = 0; idx < throneCardTypes.length; idx++) {

            document.getElementById('tcoThronePreviewCard' + throneCardTypes[idx]).addEventListener('click', function(A) {
                A.stopPropagation();
                var throneType = this.id.split('tcoThronePreviewCard')[1];
                var tcoPreviewValue = document.getElementById('tcoThronePreviewValue' + throneType);
                var throneId = tcoPreviewValue.value;
                var throneItem = uW.kocThroneItems[throneId];
                if (!throneItem || throneItem ==0) return;
                CardContextMenu(this, throneItem, true);
            }, false);

            document.getElementById('tcoThronePreviewValue' + throneCardTypes[idx]).addEventListener('change', function() {
                var throne_Type = this.id.split('tcoThronePreviewValue')[1];
                var trId = this.value;
                t.loadThronePreviewCard(trId, throne_Type);
            }, false);

            document.getElementById('tcoThronePreviewValue' + throneCardTypes[idx]).addEventListener('keyup', function() {
                var throne_Type = this.id.split('tcoThronePreviewValue')[1];
                var trId = this.value;
                t.loadThronePreviewCard(trId, throne_Type);
            }, false);
           
        }
            
        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        document.getElementById('tcoThronePreviewDetails').innerHTML = t.getPreviewThroneDetails();

        document.getElementById('tcoThronePreviewExcel').addEventListener('click', function() {
            ExportThroneToExcel(true);
        }, false);

        document.getElementById('tcoThronePreviewPost').addEventListener('click', function () {
            t.postPreviewThroneDetails();
        }, false);

        document.getElementById('tcoThronePreviewReset').addEventListener('click', function () {
            t.resetPreview();
        }, false);

        document.getElementById('tcoThronePreviewExportLoad').addEventListener('click', function () {
            var fileInput = document.getElementById("tcoThronePreviewExportLoadItem");
            var files = fileInput.files;
            if (files.length==0) {
                alert('Please Select A File');
                return;
            }
            var file = files[0];
                
            var reader = new FileReader();
                
            reader.onload = function (e) {  
				var output = e.target.result;
				tcoThronePresetData.previewThrone = JSON.parse(output);
                SAVEtcoThronePresetData();
                t.show();
                alert('Preview Throne Now Loaded From File');
            };
            reader.readAsText(file);     
        }, false);

        document.getElementById('tcoThronePreviewExport').addEventListener('click', function() {
            uriContent = 'data:application/octet-stream,' + encodeURIComponent(JSON.stringify(tcoThronePresetData.previewThrone));
            newWindow = window.open(uriContent, 'file.txt');
        }, false);

        document.getElementById('tcoThronePreviewCopyTo').addEventListener('click', function () {
            var presetNum = document.getElementById('tcoThronePreviewCopyToValue').value;
            var presetTag = getThronePresetObject(parseInt(presetNum));
            for (var p in presetTag) delete presetTag[p];
            for (var p in tcoThronePresetData.previewThrone) presetTag[p] = true;
            tcoThronePresetData.presetNames[presetNum] = "PREVIEW";
            document.getElementById('tcoThronePresetName' + presetNum).value = "PREVIEW";
            SAVEtcoThronePresetData();
            t.show();
        }, false);

        document.getElementById('tcoThronePreviewLoadPreset').addEventListener('click', function () {
            var presetIndex = document.getElementById('tcoThronePreviewLoadPresetValue').value;
            var equipped_items = Seed.throne.slotEquip[presetIndex];
            var counter = equipped_items.length;
            t.resetPreview();
            for (var ei = 0; ei < counter; ei++) {
                var throne_item = uW.kocThroneItems[equipped_items[ei]];
                if (throne_item == null || !throne_item) continue;
                tcoThronePresetData.previewThrone[throne_item.id] = true;
            }
            SAVEtcoThronePresetData();
            t.show();

        }, false);

        document.getElementById('tcoThronePreviewAutoBuild').addEventListener('click', function () {
            var EffectId = document.getElementById('tcoThronePreviewAutoBuildEffect').value;

            if (EffectId == 0) return;

            var EffectName = CM.thronestats.effects[EffectId][1];
            var isBuff = true;
            if (EffectName.indexOf(" Debuff") != -1) isBuff = false;


            function eCard() {
                this.id = 0;
                this.type = '';
                this.total  = 0;
            }

            var EffectedCards = [];

            for (tct = 0; tct < throneCardTypes.length; tct++) EffectedCards[throneCardTypes[tct]] = new Array;

            for (var throneId in uW.kocThroneItems) {
                var throneItem = uW.kocThroneItems[throneId];
                var totalEffects = 0;
                for (var effect in throneItem.effects) {
                    var fx = throneItem.effects[effect];
                    if (fx.id == EffectId) {
                        var tier = CM.thronestats.tiers[fx.id][fx.tier];
                        if (!tier) CM.thronestats.tiers[fx.id][fx.tier - 1]
                        var base = tier.base || 0;
                        var level = throneItem.level || 0;
                        var growth = tier.growth || 0;
                        var percent = +(base + ((level * level + level) * growth * 0.5));
                        totalEffects += percent; 
                    }
                }
                if (totalEffects != 0) {
                    var thisCard = new eCard();
                    thisCard.id = throneId;
                    thisCard.total = totalEffects;
                    thisCard.type = throneItem.type;
                    if (EffectedCards[thisCard.type].length > 0) {
                        if (isBuff && EffectedCards[thisCard.type][0].total > thisCard.total) continue;
                        if (!isBuff && EffectedCards[thisCard.type][0].total < thisCard.total) continue;
                        EffectedCards[thisCard.type][0] = thisCard;
                    } else {
                        EffectedCards[thisCard.type].push(thisCard);    
                    }
                    
                }
            }
            t.resetPreview();
            for (tct = 0; tct < throneCardTypes.length; tct++) {
                if (EffectedCards[throneCardTypes[tct]].length > 0) {
                    var thisCard = EffectedCards[throneCardTypes[tct]][0];
                    t.loadThronePreviewCard(thisCard.id, thisCard.type);
                }
            }
            SAVEtcoThronePresetData();
        }, false);

        document.getElementById('tcoThronePreviewLoadPresetTag').addEventListener('click', function () {
            var presetNum = document.getElementById('tcoThronePreviewLoadPresetTagValue').value;
            var presetTag = getThronePresetObject(parseInt(presetNum));
            t.resetPreview();
            for (var p in presetTag) tcoThronePresetData.previewThrone[p] = true;
            SAVEtcoThronePresetData();
            t.show();

        }, false);

        document.getElementById('tcoThronePreviewEquip').addEventListener('click', function () {

            var presetIndex = Seed.throne.activeSlot;

            var t = Tabs.thronePreview;

            if (t.equipingPreview) {
                alert("still equipping");
                return;
            }

            if (getObjectCollectionCount(tcoThronePresetData.previewThrone) == 0) return;

            var c = 0;
            t.equipingPreview = true;

            var delay = 7;

            var types_equiped = [];

            for (var trId in tcoThronePresetData.previewThrone) {

                // only equip the items not already equipped
                var throne_item = uW.kocThroneItems[trId];

                if (throne_item == null || !throne_item) continue;

                types_equiped.push(throne_item.type);

                if (!throne_item.isEquipped) {

                    var goEquip = function (I2, s) {
                        return function () {
                            Tabs.throneOrganizer.equipItem(I2, s);
                        };
                    }

                    setTimeout(goEquip(throne_item, presetIndex), c * delay * 1000); // have to wait at least 5 seconds between switches
                    c++;
                }

            }

            var equipped_items = Seed.throne.slotEquip[presetIndex];

            var counter = equipped_items.length;

            var items_to_unequip = [];

            for (var i = 0; i < counter; i++) {
                var throne_item = uW.kocThroneItems[equipped_items[i]];
                if (throne_item == null || !throne_item) continue;
                var idx = types_equiped.indexOf(throne_item.type);
                if (idx == -1) { //item in equipped items is not found among the types that were equipped, so unequip it

                    var goUnequip = function (I2, s) {
                        return function () {
                            Tabs.throneOrganizer.unequipItem(I2, s);
                        };
                    }

                    setTimeout(goUnequip(throne_item, presetIndex), c * delay * 1000); // have to wait at least 5 seconds between switches
                    c++;

                }
            }

            setTimeout(function () {
                t.equipingPreview = false;
                alert("loading from PREVIEW complete")
            }, (c * (delay * 1000)) + 1000);

        }, false);
	},
    
    loadThronePreviewCard: function(throneId, throneType) {
        var t = Tabs.thronePreview;
        var throneCard = '';
        if (throneId != 0) {
            var throneItem = uW.kocThroneItems[throneId];
            if (!throneItem || throneItem ==0) {
                throneCard = '';
            } else {
                throneCard = BuildThroneCard(throneItem);
            }
        }
        document.getElementById('tcoThronePreviewCard' + throneType).innerHTML = throneCard;

        document.getElementById('tcoThronePreviewValue' + throneType).value = throneId;

        for (pId in tcoThronePresetData.previewThrone) {
            var throne_item = uW.kocThroneItems[pId];
            if (throne_item == null || !throne_item) continue;
            if (throne_item.type == throneType) {
                delete tcoThronePresetData.previewThrone[pId];
                break;
            }
        }

        if (throneId != 0) tcoThronePresetData.previewThrone[throneId] = true

        SAVEtcoThronePresetData();

        document.getElementById('tcoThronePreviewDetails').innerHTML = t.getPreviewThroneDetails();
    },

    getPreviewThroneDetails: function () {
        var t = Tabs.thronePreview;
        var previewPreset = [];
        for (var trId in tcoThronePresetData.previewThrone) previewPreset.push(trId);

        var stringPreviewThrone = GenerateThronePresetEffectsString(previewPreset, true);
        if (stringPreviewThrone == "") {
            stringPreviewThrone = "No Stats To Preview";
        } else {
            stringPreviewThrone = "<b>PREVIEW STATS:</b>\n" + stringPreviewThrone;
        }
        return stringPreviewThrone;
    },

    postPreviewThroneDetails: function () {
        var t = Tabs.thronePreview;
        var previewPreset = [];
        for (var trId in tcoThronePresetData.previewThrone) previewPreset.push(trId);

        var stringPreviewThrone = GenerateThronePresetEffectsString(previewPreset, true);
        if (stringPreviewThrone == "") {
            return;
        } else {
            var table = stringPreviewThrone.split("</div><div>");
            stringPreviewThrone = table.join("||");
            stringPreviewThrone = stringPreviewThrone.replace("<div>", ":::. |TR PREVIEW STATS:||");
            stringPreviewThrone = stringPreviewThrone.replace("</div>", "");
            sendChat(stringPreviewThrone);
        }
        return;

    },

    resetPreview: function () {
        var t = Tabs.thronePreview;

        for (trId in tcoThronePresetData.previewThrone) delete tcoThronePresetData.previewThrone[trId];
        SAVEtcoThronePresetData();

        for (idx = 0; idx < throneCardTypes.length; idx++) {
            document.getElementById('tcoThronePreviewCard' + throneCardTypes[idx]).innerHTML = "";
            document.getElementById('tcoThronePreviewValue' + throneCardTypes[idx]).value = 0;
        }

        document.getElementById('tcoThronePreviewDetails').innerHTML = t.getPreviewThroneDetails();
    },

}

Tabs.throneCompare = {
	tabOrder: 100,
	tabLabel: 'COMPARE',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM COMPARE',

	init: function (div) {
		var t = Tabs.throneCompare;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div>';
        m += '<center>';
        m += '<table>';

        m += '<tr>';
        m += '<td align=center><b>CARD 1</b></td>';
        m += '<td align=center><b>CARD 2</b></td>';
        m += '</tr>';

        m += '<tr>';
        m += '<td>';
        m += '<b>Item Type:</b><select class=tcoSelect id=tcoThroneCompareType1 style="width: 40%;">';
        m += '<option value="0">--ALL--</option>';
        for (var throneType in throneCardTypes) m += '<option value="' + throneCardTypes[throneType] + '">' + throneCardTypes[throneType].capitalizeFirstLetter() + '</option>';
        m += '</select>';
        m += '</td>';
        m += '<td>';
        m += '<b>Item Type:</b><select class=tcoSelect id=tcoThroneCompareType2 style="width: 40%;">';
        m += '<option value="0">--ALL--</option>';
        for (var throneType in throneCardTypes) m += '<option value="' + throneCardTypes[throneType] + '">' + throneCardTypes[throneType].capitalizeFirstLetter() + '</option>';
        m += '</select>';
        m += '</td>';
        m += '</tr>';

        m += '<tr>';
        m += '<td>';
        m += '<b>Throne Item:</b><br/><select class=tcoSelect id=tcoThroneCompareId1 style="width: 95%;">';
        m += '<option value="0">--Items--</option>';
        for (var throneId in uW.kocThroneItems) m += '<option value="' + throneId + '">' + uW.kocThroneItems[throneId].name + ' </option>';
        m += '</select>';
        m += '</td>';
        m += '<td>';
        m += '<b>Throne Item:</b><br/><select class=tcoSelect id=tcoThroneCompareId2 style="width: 95%;">';
        m += '<option value="0">--Items--</option>';
        for (var throneId in uW.kocThroneItems) m += '<option value="' + throneId + '">' + uW.kocThroneItems[throneId].name + ' </option>';
        m += '</select>';
        m += '</td>';
        m += '</tr>';

        m += '<tr>';
        m += '<td>';
        m += '<div id=tcoThroneCompareCard1></div>';
        m += '</td>';
        m += '<td>';
        m += '<div id=tcoThroneCompareCard2></div>';
        m += '</td>';
        m += '</tr>';

        m += '</table>';
        m += '</center>';
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoThroneCompareId1').addEventListener('change', function () { t.loadCard(this, 'tcoThroneCompareCard1'); }, false);

        document.getElementById('tcoThroneCompareId2').addEventListener('change', function () { t.loadCard(this, 'tcoThroneCompareCard2'); }, false);

        document.getElementById('tcoThroneCompareId1').addEventListener('keyup', function () { t.loadCard(this, 'tcoThroneCompareCard1'); }, false);

        document.getElementById('tcoThroneCompareId2').addEventListener('keyup', function () { t.loadCard(this, 'tcoThroneCompareCard2'); }, false);

        document.getElementById('tcoThroneCompareType1').addEventListener('change', function () { t.filterItems(this, 'tcoThroneCompareId1', 'tcoThroneCompareCard1'); }, false);

        document.getElementById('tcoThroneCompareType2').addEventListener('change', function () { t.filterItems(this, 'tcoThroneCompareId2', 'tcoThroneCompareCard2'); }, false);

        document.getElementById('tcoThroneCompareType1').addEventListener('keyup', function () { t.filterItems(this, 'tcoThroneCompareId1', 'tcoThroneCompareCard1'); }, false);

        document.getElementById('tcoThroneCompareType2').addEventListener('keyup', function () { t.filterItems(this, 'tcoThroneCompareId2', 'tcoThroneCompareCard2'); }, false);

    },

    sendToCompare: function (Id) {
        var t = Tabs.throneCompare;
        var throneItem = uW.kocThroneItems[Id];
        var card1 = document.getElementById('tcoThroneCompareId1');
        var card2 = document.getElementById('tcoThroneCompareId2');
        var obj = '';
        if (card1.value == 0)
            obj = '1';
        else if (card2.value == 0)
            obj = '2';
        else
            obj = '1';

        document.getElementById('tcoThroneCompareType' + obj).value = throneItem.type;
        t.filterItems(document.getElementById('tcoThroneCompareType' + obj), ('tcoThroneCompareId' + obj), ('tcoThroneCompareCard' + obj));
        document.getElementById('tcoThroneCompareId' + obj).value = Id;
        t.loadCard(document.getElementById('tcoThroneCompareId' + obj), ('tcoThroneCompareCard' + obj));
    },

    loadCard: function (objectItem, objectName) {
        var div = document.getElementById(objectName);
        if (objectItem.value == 0)
            div.innerHTML = '';
        else
            div.innerHTML = BuildThroneCard(uW.kocThroneItems[objectItem.value]);
    },

    filterItems: function (objectItem, objectIdName, objectName) {
        document.getElementById(objectName).innerHTML = '';
        var select = document.getElementById(objectIdName);
        select.value = 0;
        var m = '<option value="0">--Items--</option>';
        if (objectItem.value == 0) {
            for (var throneId in uW.kocThroneItems) {
                m += '<option value="' + throneId + '">' + uW.kocThroneItems[throneId].name + '</option>';
            }
        } else {
            for (var throneId in uW.kocThroneItems) {
                if (uW.kocThroneItems[throneId].type == objectItem.value)
                    m += '<option value="' + throneId + '">' + uW.kocThroneItems[throneId].name + '</option>';
            }
        }
        select.innerHTML = m;
    },


	hide: function () {},
	
	show: function () {},
}

Tabs.throneUniques = {
	tabOrder: 100,
	tabLabel: 'UNIQUES',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM UNIQUES',
    UniqueItems : null,
    selectedCard: 0,
    selectedType: 0,
    selectedLevel: 1,
	
	init: function (div) {
		var t = Tabs.throneUniques;
		t.mydiv = div;

        t.UniqueItems = CM.WorldSettings.getSettingAsObject("TR_UNIQUE_ITEMS");
        for (k in t.UniqueItems) {
            var throne_item = t.UniqueItems[k];
            if (parseInt(throne_item.Id) < 29000) delete t.UniqueItems[k];
            if (parseInt(throne_item.Id) == 30262 || parseInt(throne_item.Id) == 30264 || parseInt(throne_item.Id) == 30266) { throne_item.Name = throne_item.Name + ' ('+uW.g_js_strings.commonstr[CM.CHAMPION.getFactionClasses(throne_item.Faction)].toLowerCase()+')';};
            if (parseInt(throne_item.Id) == 30261 || parseInt(throne_item.Id) == 30263 || parseInt(throne_item.Id) == 30265) { throne_item.Name = throne_item.Name + ' ('+uW.g_js_strings.commonstr[CM.CHAMPION.getFactionClasses(throne_item.Faction)].toLowerCase()+')';};
            if (parseInt(throne_item.Id) == 30230 || parseInt(throne_item.Id) == 30240 || parseInt(throne_item.Id) == 30250) { throne_item.Name = throne_item.Name + ' ('+uW.g_js_strings.commonstr[CM.CHAMPION.getFactionClasses(throne_item.Faction)].toLowerCase()+')';};
            if (parseInt(throne_item.Id) == 30231 || parseInt(throne_item.Id) == 30241 || parseInt(throne_item.Id) == 30251) { throne_item.Name = throne_item.Name + ' ('+uW.g_js_strings.commonstr[CM.CHAMPION.getFactionClasses(throne_item.Faction)].toLowerCase()+')';};
        }

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';

        m += '<center><table>';
        m += '<tr><td><div style="max-width:100%;"><b>Item Type:</b><select class=tcoSelect id=tcoThroneUniqueType style="width: 40%;">';
        m += '<option value="0">--ALL--</option>';
        for (throneType in throneCardTypes) m += '<option value="' + throneCardTypes[throneType] + '">' + throneCardTypes[throneType].capitalizeFirstLetter() + '</option>';
        m += '</select></div></td></tr>';

        m += '<tr><td><div style="max-width:100%;"><b>Throne Item:</b><br/><select class=tcoSelect id=tcoThroneUnique style="width: 95%;">';
        m += '<option value="0">--Items--</option>';
        for (k in t.UniqueItems) {
            var throne_item = t.UniqueItems[k];
            if (throne_item == null || !throne_item) continue;
            m += '<option value="' + k + '">' + throne_item.Name + ' </option>';
        }
        m += '</select></div></td></tr>';

        m += '<tr><td><div style="max-width:100%;"><b>Level:</b><select class=tcoSelect id=tcoThroneUniqueLevel style="width: 40%;">';
        m += '<option value="1" selected>+1</option>';
        for (lvl = 2; lvl < tcoMaxThroneLevel + 1; lvl++) m += '<option value="' + lvl + '">+' + lvl + '</option>';
        m += '</select></div></td></tr>';

        m += '<tr><td><div id=tcoThroneUniqueCard></div></td></tr>';

        m += '</table>';

        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoThroneUniqueType').addEventListener('change', function () {
            t.selectedType = document.getElementById('tcoThroneUniqueType').value;
            t.selectedCard = 0;
            t.FilterUniques();
            document.getElementById('tcoThroneUniqueCard').innerHTML = '';
        }, false);

        document.getElementById('tcoThroneUnique').addEventListener('change', function () {
            t.selectedCard = document.getElementById('tcoThroneUnique').value;
            if (t.selectedCard != 0) t.SwitchUnique();
        }, false);

        document.getElementById('tcoThroneUniqueLevel').addEventListener('change', function () {
            t.selectedLevel = document.getElementById('tcoThroneUniqueLevel').value;
            if (t.selectedCard != 0) t.SwitchUnique();
        }, false);

	},
	
	hide: function () {},
	
	show: function () {},

    FilterUniques: function (cardType) {
        var t = Tabs.throneUniques;
        var throneList = document.getElementById('tcoThroneUnique');
        throneList.options.length = 0;
        var throneOption = document.createElement('option');
        throneOption.text = '--Items--';
        throneOption.value = 0;
        throneList.add(throneOption);
        for (k in t.UniqueItems) {
            var throne_item = t.UniqueItems[k];
            if (throne_item == null || !throne_item) continue;
            if (throneCardTypes[throne_item.Type-1] == t.selectedType || t.selectedType == 0) {
                var throneOption = document.createElement('option');
                throneOption.text = throne_item.Name;
                throneOption.value = k;
                throneList.add(throneOption);
            }
        }
    },

    SwitchUnique: function () {
        var t = Tabs.throneUniques;
        var div = document.getElementById('tcoThroneUniqueCard');
        var m = ConvertUniqueAndBuildThroneCard(t.selectedCard, t.selectedLevel);
        m += t.GetUniqueInventory(t.selectedCard);
        div.innerHTML = m;
    },


    GetUniqueInventory: function (uniqueId) {
        var m = '<br><b>Throne Room</b><br>';
        var throneitems = {};
        for (throneId in uW.kocThroneItems) {
            var throneItem = uW.kocThroneItems[throneId];
            if (throneItem.unique == uniqueId) {
                if (throneitems[throneItem.level]) {
                    throneitems[throneItem.level]++;
                } else {
                    throneitems[throneItem.level] = 1;
                }
            }
        }
        var gotitem = false;
        for (lvl in throneitems) {
            gotitem = true;
            m += 'You have ' + throneitems[lvl] + ' at level ' + lvl + '<br>';
        }
        if (!gotitem) m += 'You have none in your throne room.<br>';
       
        m += '<br><b>Inventory</b><br>';
        var inventory = Seed.items['i' + uniqueId];
        m += 'You have ' + (inventory ? inventory : 'none') + ' in your inventory.';
        return m;
    },

}

Tabs.throneCaps = {
	tabOrder: 100,
	tabLabel: 'CAPS',
	tabColor: 'red',
    tabHeader: 'THRONE ROOM CAPS',
	
	init: function (div) {
		var t = Tabs.throneCaps;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div class=indent5>';
        m += '<table cellpadding=0 cellspacing=0 width=100% align=center>';
        m += '<tr><td width=50% align=left><b>Boost</b></td><td width=25% align=left><b>Max</b></td><td width=25% align=left><b>Min</b></td></tr>';
        m += '</table>';
        m += '</div>';

        m += '<div class=indent5 style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';

        m += '<table cellpadding=0 cellspacing=0 width=100% align=center>';
        for (var boost in CM.thronestats.boosts) {
            var cap = CM.thronestats.boosts[boost];
            m += '<tr class=trTabLined>';
            m += '<td width=50%>' + cap.BoostName + '</td>';
            m += '<td width=25%>' + cap.Max + ((cap.CapType == "percent") ? '%' : '') + '</td>';
            m += '<td width=25%>' + ((cap.Min == "none") ? 'None' : cap.Min + '%') + '</td>';
            m += '</tr>';
        }
        m += '</table>';
        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

	},
	
	hide: function () {},
	
	show: function () {},
}

Tabs.champUpgrader = {
	tabOrder: 100,
	tabLabel: 'UPGRADER',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL UPGRADER',
    myDiv: null,
    repairId: 0,
    repairEnd: 0,
    timerH: null,
    clearTimerH: null,
    speedup: 0,
    upgradePath: {
        0: { maxLev: 2, nextQual: 2 },
        1: { maxLev: 2, nextQual: 2 },
        2: { maxLev: 3, nextQual: 4 },
        3: { maxLev: 3, nextQual: 4 },
        4: { maxLev: 4, nextQual: 5 }
    },
    
	init: function (div) {
		var t = Tabs.champUpgrader;
		t.mydiv = div;
		var m = '<div class=tcoHeader>' + t.tabHeader + '<div class=tcoSaveSettings id=tcoChampUpgraderSaveSettings title="Save Upgrader Settings"></div><div class=tcoLoadSettings id=tcoChampUpgraderLoadSettings title="Load Upgrader Settings"></div></div>';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        
		m += '<div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        
        if (tcoChampUpgradeData.active) {
            m += '<td width=33%><input id=tcoChampUpgradePower type=button class=tcoButton value="Upgrader = ON"></td>';
        } else {
            m += '<td width=33%><input id=tcoChampUpgradePower type=button class=tcoButton value="Upgrader = OFF"></td>';
        }        
        m += '<td width=33%><div class=divNoWrap><input class=tcoCheckbox id=tcoChampOneItem type=checkbox ' + (tcoChampQueueData.oneItem ? ' CHECKED' : '') + '/>Upgrade 1 At A Time</div></td>';
        m += '<td width=33%><div class=divNoWrap align=center id=tcoChampAetherDisplay></div></td>';
        m += '</tr>';
        m += '<tr><td colspan=3><hr class=tcoHRCenter></td></tr>';
        m += '<tr><td colspan=3><div class=indent5 id=tcoChampUpgradeStatus><br></div></td></tr>';
        m += '<tr><td colspan=3><div class=indent5 id=tcoChampLastResult><br></div></td></tr>';
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;SPEED UPS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoChampHourglassLevelSpecific ' + (tcoChampUpgradeData.hourglassLevelSpecific ? "CHECKED" : "") + '>Only use hourglass for levels ';
        m += '<select class=tcoSelect  id=tcoChampHourglassLevel>';
        for (i = 1; i < tcoMaxChampLevel; i++) m += '<option value=' + i + ' ' + (tcoChampUpgradeData.hourglassLevel == i ? 'SELECTED' : '') + '>' + i + '</option>';
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoChampHourglassQualitySpecific ' + (tcoChampUpgradeData.hourglassQualitySpecific ? "CHECKED" : "") + '>Only use hourglass for qualities ';
        m += '<select class=tcoSelect id=tcoChampHourglassQuality>';
        for (i = 1; i <= tcoMaxChampQuality-1; i++) {
            m += '<option value=' + i + ' ' + (tcoChampUpgradeData.hourglassQuality == i ? 'SELECTED' : '') + '>' + champCardQualities[i].capitalizeFirstLetter() + '</option>';
        }
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[1] + '"><input class=tcoCheckbox type=checkbox id=tcoChampUseSH ' + (tcoChampUpgradeData.useSH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[1] + ' (<div class=divNoWrap id=tcoChampUseSHLabel><font' + (uW.ksoItems[1].count < 100 ? ' color=red>' : '>') + uW.ksoItems[1].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[2] + '"><input class=tcoCheckbox type=checkbox id=tcoChampUseKH ' + (tcoChampUpgradeData.useKH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[2] + ' (<div class=divNoWrap id=tcoChampUseKHLabel><font' + (uW.ksoItems[2].count < 100 ? ' color=red>' : '>') + uW.ksoItems[2].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[3] + '"><input class=tcoCheckbox type=checkbox id=tcoChampUseGH ' + (tcoChampUpgradeData.useGH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[3] + ' (<div class=divNoWrap id=tcoChampUseGHLabel><font' + (uW.ksoItems[3].count < 100 ? ' color=red>' : '>') + uW.ksoItems[3].count + '</font></div>)</div></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[4] + '"><input class=tcoCheckbox type=checkbox id=tcoChampUseMH ' + (tcoChampUpgradeData.useMH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[4] + ' (<div class=divNoWrap id=tcoChampUseMHLabel><font' + (uW.ksoItems[4].count < 100 ? ' color=red>' : '>') + uW.ksoItems[4].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[5] + '"><input class=tcoCheckbox type=checkbox id=tcoChampUseAH ' + (tcoChampUpgradeData.useAH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[5] + ' (<div class=divNoWrap id=tcoChampUseAHLabel><font' + (uW.ksoItems[5].count < 100 ? ' color=red>' : '>') + uW.ksoItems[5].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[6] + '"><input class=tcoCheckbox type=checkbox id=tcoChampUseWH ' + (tcoChampUpgradeData.useWH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[6] + ' (<div class=divNoWrap id=tcoChampUseWHLabel><font' + (uW.ksoItems[6].count < 100 ? ' color=red>' : '>') + uW.ksoItems[6].count + '</font></div>)</div></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[7] + '"><input class=tcoCheckbox type=checkbox id=tcoChampUseDH ' + (tcoChampUpgradeData.useDH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[7] + ' (<div class=divNoWrap id=tcoChampUseDHLabel><font' + (uW.ksoItems[7].count < 100 ? ' color=red>' : '>') + uW.ksoItems[7].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[8] + '"><input class=tcoCheckbox type=checkbox id=tcoChampUseEH ' + (tcoChampUpgradeData.useEH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[8] + ' (<div class=divNoWrap id=tcoChampUseEHLabel><font' + (uW.ksoItems[8].count < 100 ? ' color=red>' : '>') + uW.ksoItems[8].count + '</font></div>)</div></td>';
        m += '<td/>';
        m += '</tr>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoChampOverrideSpeedUps ' + (tcoChampUpgradeData.overrideSpeedUp ? "CHECKED" : "") + '>Override hourglasses by using ';
        m += '<select class=tcoSelect  id=tcoChampSpeedUp>';
        m += '<option value=0>None</option>';
        for (gls in tcoHourGlassName) {
            m += '<option value=' + gls + ' ' + (tcoChampUpgradeData.useSpeedUp == gls ? 'SELECTED' : '') + '>' + tcoHourGlassName[gls] + '</option>';
        }
        m += '</select> every time</td>';
        m += '</tr>';
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;BOOST ITEMS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        m += '<td><input class=tcoCheckbox type=checkbox ' + (tcoChampUpgradeData.useLOM ? "CHECKED" : "") + ' id=tcoChampUseLOM><div class=divNoWrap>Lesser Orb of Metallurgy (<div class=divNoWrap id=tcoChampUseLOMLabel>' + uW.ksoItems[21001].count + '</div>)</div></td>';
        m += '<td><input class=tcoCheckbox type=checkbox ' + (tcoChampUpgradeData.useGOM ? "CHECKED" : "") + ' id=tcoChampUseGOM><div class=divNoWrap>Greater Orb of Metallurgy (<div class=divNoWrap id=tcoChampUseGOMLabel>' + uW.ksoItems[21002].count + '</div>)</div></td>';
        m += '<td>Quality <select class=tcoSelect  id=tcoChampUseQuality>';
        for (i = 0; i <= tcoMaxChampQuality-1; i++) {
            m += '<option value="' + i + '" ' + (tcoChampUpgradeData.useQuality == i ? 'SELECTED' : '')  + '>' + champCardQualities[i].capitalizeFirstLetter() + '</option>';
        }
        m += '</select> and higher</td>';
        m += '</tr>';

        m += '<tr>';
        m += "<td><input class=tcoCheckbox type=checkbox " + (tcoChampUpgradeData.useJT ? "CHECKED" : "") + " id=tcoChampUseJT><div style='white-space:nowrap;display:inline-block;'>Journeyman Smith's Token (<div style='white-space:nowrap;display:inline-block;' id=tcoChampUseJTLabel>" + uW.ksoItems[21051].count + "</div>)</div></td>";
        m += "<td><input class=tcoCheckbox type=checkbox " + (tcoChampUpgradeData.useST ? "CHECKED" : "") + " id=tcoChampUseST><div style='white-space:nowrap;display:inline-block;'>Smith's Token (<div style='white-space:nowrap;display:inline-block;' id=tcoChampUseSTLabel>" + uW.ksoItems[21052].count + "</div>)</div></td>";
        m += '<td>Level <select id="tcoChampUseLevel">';
        for (i = 1; i <= tcoMaxChampLevel-1; i++) {
            m += '<option value="' + i + '" ' + (tcoChampUpgradeData.useLevel == i ? 'SELECTED' : '') + '> +' + i + '</option>';
        }
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += "<td><input class=tcoCheckbox type=checkbox " + (tcoChampUpgradeData.useET ? "CHECKED" : "") + " id=tcoChampUseET><div style='white-space:nowrap;display:inline-block;'>Expert Smith's Token (<div style='white-space:nowrap;display:inline-block;' id=tcoChampUseETLabel>" + uW.ksoItems[21058].count + "</div>)</div></td>";
        m += "<td/>";
        m += "<td/>";
        m += "</tr>";

        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;UPGRADE ITEMS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        m += '<td colspan=4>Enhance All Quality <select class=tcoSelect id=tcoChampEnhanceAllQuality>';
        for (i = 0; i <= tcoMaxChampQuality-1; i++) {
            m += '<option value="' + i + '">' + champCardQualities[i].capitalizeFirstLetter() + '</option>';
        }
        m += '</select> To Quality <select class=tcoSelect id=tcoChampEnhanceAllQualityTo>';
        for (i = 1; i <= tcoMaxChampQuality; i++) {
            m += '<option value="' + i + '">' + champCardQualities[i].capitalizeFirstLetter() + '</option>';
        }
        m += '</select>&nbsp;&nbsp;<input class=tcoButton type=button value="Add" id=tcoChampEnhanceAddAllQuality></td>';
        m += '</tr>';

        m += '<tr><td colspan=4>Upgrade All Cards Less To Level <select class=tcoSelect id=tcoChampUpgradeAddAllLevelMaxTo>';
        for (i = 1; i <= tcoMaxChampLevel; i++) {
            m += '<option value="' + i + '"> +' + i + '</option>';
        }
        m += '</select>&nbsp;&nbsp;<input class=tcoButton type=button value="Add" id=tcoChampUpgradeAddAllLevelMax></td></tr>';

        m += '<tr>';
        m += '<td colspan=4>Upgrade All Level <select class=tcoSelect id=tcoChampUpgradeAllLevel>';
        for (i = 0; i <= tcoMaxChampLevel-1; i++) {
            m += '<option value="' + i + '"> +' + i + '</option>';
        }
        m += '</select> To Level <select class=tcoSelect id=tcoChampUpgradeAllLevelTo>';
        for (i = 1; i <= tcoMaxChampLevel; i++) {
            m += '<option value="' + i + '"> +' + i + '</option>';
        }
        m += '</select>&nbsp;&nbsp;<input class=tcoButton type=button value="Add" id=tcoChampUpgradeAddAllLevel></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td class=divNoWrap>Item: <select class=tcoSelect style="white-space:nowrap;display:inline-block;max-width: 200px;" id=tcoChampUpgradeList>';
        m += '<option value="0">--Items--</option>';
        for (ChampID in uW.kocChampionItems) {
            var champItem = uW.kocChampionItems[ChampID];
            m += '<option value="' + ChampID + '">' + champItem.name + '</option>';
        }
        m += '</select>&nbsp;';
        m += 'Action: <select class=tcoSelect style="white-space:nowrap;display:inline-block;" id=tcoChampAction>';
        m += '<option value="upgrade">Upgrade</option>';
        m += '<option value="enhance">Enhance</option>';
        m += '<option value="both">Both</option>';
        m += '</select>&nbsp;';
        m += '<div class=divNoWrap id=tcoChampMaxDiv></div>&nbsp;';
        m += '<input class=tcoButton id=tcoChampQueueAdd type=button value="Add"/>';
        m += '</td>';
        m += '</tr>';
        m += '</table>';
        m += '</div>';

        m += '<div class=tcoHeader>UPGRADE LIST</div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td colspan=4>';
        m += '<div id=tcoChampQScroll style="position: static; width: 100%; height: 340px; overflow-x: auto; overflow-y: auto;">';
        m += '<div id=tcoChampQDiv></div>';
        m += '</div>';
        m += '</td></tr>';
        m += '<tr><td colspan=4><input class=tcoButton style="float: left;" id=tcoChampClearQ type=button value="Clear Queue"></tr>';
        m += '</table>';
        m += '</div>';
        
        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';
        
        document.getElementById('tcoChampUpgraderSaveSettings').addEventListener('click', function () {
            SaveSettingsToFile(tcoChampUpgradeData);
        }, false);

        document.getElementById('tcoChampUpgraderLoadSettings').addEventListener('click', function () {
            var loader = document.getElementById('tcoSettingsFile');
            loader.addEventListener('change', function () {
                LoadSettingsFromFile(tcoChampUpgradeData, Tabs.champUpgrader);
            }, false);
            loader.click();
        }, false);

        t.refreshAetherDisplay();        

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        document.getElementById('tcoChampUpgradePower').addEventListener('click', function () {
            t.togglePower(this);
            t.show();
        }, false);


        document.getElementById('tcoChampHourglassLevelSpecific').addEventListener('change', function () {
            tcoChampUpgradeData.hourglassLevelSpecific = document.getElementById('tcoChampHourglassLevelSpecific').checked;
            SAVEtcoChampUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampHourglassQualitySpecific').addEventListener('change', function () {
            tcoChampUpgradeData.hourglassQualitySpecific = document.getElementById('tcoChampHourglassQualitySpecific').checked;
            SAVEtcoChampUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampOverrideSpeedUps').addEventListener('change', function () {
            tcoChampUpgradeData.overrideSpeedUp = document.getElementById('tcoChampOverrideSpeedUps').checked;
            SAVEtcoChampUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampUseWH').addEventListener('change', function () {
            tcoChampUpgradeData.useWH = document.getElementById('tcoChampUseWH').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useWH) t.doAction();
        }, false);

        document.getElementById('tcoChampUseDH').addEventListener('change', function () {
            tcoChampUpgradeData.useDH = document.getElementById('tcoChampUseDH').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useDH) t.doAction();
        }, false);

        document.getElementById('tcoChampUseEH').addEventListener('change', function () {
            tcoChampUpgradeData.useEH = document.getElementById('tcoChampUseEH').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useEH) t.doAction();
        }, false);
        
        document.getElementById('tcoChampUseSH').addEventListener('change', function () {
            tcoChampUpgradeData.useSH = document.getElementById('tcoChampUseSH').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useSH) t.doAction();
        }, false);

        document.getElementById('tcoChampUseKH').addEventListener('change', function () {
            tcoChampUpgradeData.useKH = document.getElementById('tcoChampUseKH').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useKH) t.doAction();
        }, false);

        document.getElementById('tcoChampUseGH').addEventListener('change', function () {
            tcoChampUpgradeData.useGH = document.getElementById('tcoChampUseGH').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useGH) t.doAction();
        }, false);

        document.getElementById('tcoChampUseMH').addEventListener('change', function () {
            tcoChampUpgradeData.useMH = document.getElementById('tcoChampUseMH').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useMH) t.doAction();
        }, false);

        document.getElementById('tcoChampUseAH').addEventListener('change', function () {
            tcoChampUpgradeData.useAH = document.getElementById('tcoChampUseAH').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useAH) t.doAction();
        }, false);

        document.getElementById('tcoChampUseQuality').addEventListener('change', function () {
            tcoChampUpgradeData.useQuality = document.getElementById('tcoChampUseQuality').value;
            SAVEtcoChampUpgradeData();
        }, false);

        document.getElementById('tcoChampUseLevel').addEventListener('change', function () {
            tcoChampUpgradeData.useLevel = document.getElementById('tcoChampUseLevel').value;
            SAVEtcoChampUpgradeData();
        }, false);

        document.getElementById('tcoChampSpeedUp').addEventListener('change', function () {
            tcoChampUpgradeData.useSpeedUp = document.getElementById('tcoChampSpeedUp').value;
            SAVEtcoChampUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampHourglassLevel').addEventListener('change', function () {
            tcoChampUpgradeData.hourglassLevel = document.getElementById('tcoChampHourglassLevel').value;
            SAVEtcoChampUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampHourglassQuality').addEventListener('change', function () {
            tcoChampUpgradeData.hourglassQuality = document.getElementById('tcoChampHourglassQuality').value;
            SAVEtcoChampUpgradeData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampUseLOM').addEventListener('change', function () {
            tcoChampUpgradeData.useLOM = document.getElementById('tcoChampUseLOM').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useLOM) t.doAction();
        }, false);

        document.getElementById('tcoChampUseGOM').addEventListener('change', function () {
            tcoChampUpgradeData.useGOM = document.getElementById('tcoChampUseGOM').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useGOM) t.doAction();
        }, false);

        document.getElementById('tcoChampUseET').addEventListener('change', function () {
            tcoChampUpgradeData.useET = document.getElementById('tcoChampUseET').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useET) t.doAction();
        }, false);

        document.getElementById('tcoChampUseJT').addEventListener('change', function () {
            tcoChampUpgradeData.useJT = document.getElementById('tcoChampUseJT').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useJT) t.doAction();
        }, false);

        document.getElementById('tcoChampUseST').addEventListener('change', function () {
            tcoChampUpgradeData.useST = document.getElementById('tcoChampUseST').checked;
            SAVEtcoChampUpgradeData();
            if (tcoChampUpgradeData.useST) t.doAction();
        }, false);

        document.getElementById('tcoChampQueueAdd').addEventListener('click', function () {
            t.addChampQueue();
        }, false);

        document.getElementById('tcoChampOneItem').addEventListener('change', function () {
            tcoChampQueueData.oneItem = document.getElementById('tcoChampOneItem').checked;
            SAVEtcoChampQueueData();
        });

        document.getElementById('tcoChampClearQ').addEventListener('click', function () {
            tcoChampQueueData.list = [];
            SAVEtcoChampQueueData();
            t.buildChampQueueDisplay();
        }, false);

        document.getElementById('tcoChampEnhanceAddAllQuality').addEventListener('click', function () {
            var low_level = parseInt(document.getElementById('tcoChampEnhanceAllQuality').value);
            var high_level = parseInt(document.getElementById('tcoChampEnhanceAllQualityTo').value);
            if (low_level >= high_level) return;
            for (ChampId in uW.kocChampionItems) {
                var ChampItem = uW.kocChampionItems[ChampId];
                if (ChampItem.rarity == low_level) {
                    var qItem = new QueueItem();
                    qItem.item = ChampId;
                    qItem.action = "enhance"
                    qItem.level = high_level
                    tcoChampQueueData.list.push(qItem);
                }
            }
            SAVEtcoChampQueueData();
            t.buildChampQueueDisplay();
        }, false);

        document.getElementById('tcoChampUpgradeAddAllLevelMax').addEventListener('click', function () {
            var high_level = parseInt(document.getElementById('tcoChampUpgradeAddAllLevelMaxTo').value);
            for (ChampId in uW.kocChampionItems) {
                var ChampItem = uW.kocChampionItems[ChampId];
                if (ChampItem.level < high_level) {
                    var qItem = new QueueItem();
                    qItem.item = ChampId;
                    qItem.action = "upgrade"
                    qItem.level = high_level
                    tcoChampQueueData.list.push(qItem);
                }
            }
            SAVEtcoChampQueueData();
            t.buildChampQueueDisplay();
        }, false);

        document.getElementById('tcoChampUpgradeAddAllLevel').addEventListener('click', function () {
            var low_level = parseInt(document.getElementById('tcoChampUpgradeAllLevel').value);
            var high_level = parseInt(document.getElementById('tcoChampUpgradeAllLevelTo').value);

            if (low_level >= high_level) return;
            for (ChampId in uW.kocChampionItems) {
                var ChampItem = uW.kocChampionItems[ChampId];
                if (ChampItem.level == low_level) {
                    var qItem = new QueueItem();
                    qItem.item = ChampId;
                    qItem.action = "upgrade"
                    qItem.level = high_level
                    tcoChampQueueData.list.push(qItem);
                }
            }
            SAVEtcoChampQueueData();
            t.buildChampQueueDisplay();
        }, false);

        if (tcoChampUpgradeData.active)
            t.setStatus("Loading ....");
        else 
            t.setStatus("Powered Off");

        t.startTimer();

        t.buildChampLevelWidget();
        t.buildChampQueueDisplay();


        document.getElementById('tcoChampAction').addEventListener('change', function () {
            t.buildChampLevelWidget();
        }, false);

        Tabs.champPresets.paintTags();


	},

    startTimer: function () {
        var t = Tabs.champUpgrader;
        var delay = 2 + Math.random() * 8;
        if (Seed.queue_champion == null) {
            for (champId in uW.kocChampionItems) {
                var champItem = uW.kocChampionItems[champId];
                if (champItem.status == CM.CHAMPION.STATUS_REPAIRING_ENHANCE || champItem.status == CM.CHAMPION.STATUS_REPAIRING_UPGRADE) {
                    Seed.queue_champion = {};
                    Seed.queue_champion.start = parseInt(champItem.start);
                    Seed.queue_champion.end = parseInt(champItem.eta);
                    Seed.queue_champion.itemId = champItem.equipmentId;
                    break;
                }
            }
        }

        if (Seed.queue_champion != null && Seed.queue_champion.end != null) {
            var repairTimeLeft = Seed.queue_champion.end - unixTime();
            t.repairEnd = Seed.queue_champion.end;
            t.repairId = Seed.queue_champion.itemId;
            var n = new Date(t.repairEnd * 1000);

            t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + uW.kocChampionItems[t.repairId].name);

            if (tcoChampUpgradeData.useAH || tcoChampUpgradeData.useGH || tcoChampUpgradeData.useKH || tcoChampUpgradeData.useMH || tcoChampUpgradeData.useSH || tcoChampUpgradeData.useWH || tcoChampUpgradeData.useDH || tcoChampUpgradeData.useEH || (tcoChampUpgradeData.overrideSpeedUp && tcoChampUpgradeData.useSpeedUp > 0)) {
                var champItem = uW.kocChampionItems[t.repairId];
                var tcoChampQuality = champItem.rarity;
                var tcoChampLevel = champItem.level;
                var useThoseSpeedups = true;
                if (tcoChampUpgradeData.hourglassQualitySpecific && tcoChampQuality < tcoChampUpgradeData.hourglassQuality) useThoseSpeedups = false;
                if (tcoChampUpgradeData.hourglassLevelSpecific && tcoChampLevel < tcoChampUpgradeData.hourglassLevel) useThoseSpeedups = false;
                if (tcoChampUpgradeData.overrideSpeedUp) useThoseSpeedups = true;
                if (useThoseSpeedups) {
                    t.doingSpeedup = true;
                    setTimeout(function () { t.doSpeedup(); }, 2000);
                }
            }

            setTimeout(t.clearRepair, (repairTimeLeft + 1) * 5000);
            if (repairTimeLeft > 0) delay += repairTimeLeft;
        }

        if (t.timerH == null)
            t.timerH = setTimeout(t.doAction, delay * 1000);


    },
	
	hide: function () {},
	
    refreshAetherDisplay : function () {
        document.getElementById('tcoChampAetherDisplay').innerHTML = displayCityAstone();
    },


	show: function () {
		var t = Tabs.champUpgrader;
        t.startTimer();
        t.refreshAetherDisplay();
        t.buildChampQueueDisplay();
	},

    doAction: function () {
        var t = Tabs.champUpgrader;
        if (tcoChampRepairData.active) {
            t.setStatus('Waiting for repair tab to finish...');
            return;
        }
        
        var retryTime = tcoGeneralOptions.retryInterval;

        try {
            // check if repair is done
            var ti = t.clearRepair();
            if (ti <= 0) {
                // repair is done
                if (tcoChampQueueData.oneItem || (tcoChampQueueData.doingRepairs == true)) {
                    for (queueItems in tcoChampQueueData.list) {
                        var qItem = tcoChampQueueData.list[queueItems];
                        if (!qItem) continue;

                        var champItem = uW.kocChampionItems[qItem.item];
                        
                        if ((champItem == null) || (tcoChampQueueData.list[queueItems].status == "complete")) continue;

                        if (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE) {
                            t.doRepair(champItem.equipmentId);
                            clearTimeout(t.timerH);
                            t.timerH = setTimeout(t.doAction, retryTime * 1000);
                            return;
                        } else if (tcoChampQueueData.oneItem) {
                            break;
                        }
                    }
                    //}
                }

                // all repairs complete
                tcoChampQueueData.doingRepairs = false;
                // set the index
                t.selectNext();
                SAVEtcoChampQueueData();

                // if we reach the end of the queue, start repair cycle
                if (tcoChampQueueData.index < 0) {
                    t.setStatus("Reached end of queue.")
                    t.setResult("");
                    if (!tcoChampUpgradeData.active) t.setStatus("Powered Off");
                    tcoChampQueueData.doingRepairs = true;
                    SAVEtcoChampQueueData();
                    clearTimeout(t.timerH);
                    t.timerH = setTimeout(t.doAction, retryTime * 1000);
                    return;
                }
                // upgrade/enhance next item
                var qItem = tcoChampQueueData.list[tcoChampQueueData.index];

                if (qItem) {
                    if (qItem.action == "enhance")
                        t.doEnhance(qItem.item);
                    else
                        t.doUpgrade(+qItem.item, false);
                }
            } else {
                // come back after repair is complete
                retryTime = ti + 5;
                var n = new Date(t.repairEnd * 1000);
                t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + uW.kocChampionItems[t.repairId].name);
                if (tcoChampUpgradeData.useSH || tcoChampUpgradeData.useKH || tcoChampUpgradeData.useGH || tcoChampUpgradeData.useMH || tcoChampUpgradeData.useAH || tcoChampUpgradeData.useWH || tcoChampUpgradeData.useDH || tcoChampUpgradeData.useEH || (tcoChampUpgradeData.overrideSpeedUp && tcoChampUpgradeData.useSpeedUp > 0)) {
                    var champItem = uW.kocChampionItems[t.repairId];
                    var tcoChampQuality = champItem.rarity;
                    var tcoChampLevel = champItem.level;
                    var useThoseSpeedups = true;
                    if (tcoChampUpgradeData.hourglassQualitySpecific && tcoChampQuality < tcoChampUpgradeData.hourglassQuality) useThoseSpeedups = false;
                    if (tcoChampUpgradeData.hourglassLevelSpecific && tcoChampLevel < tcoChampUpgradeData.hourglassLevel) useThoseSpeedups = false;
                    if (tcoChampUpgradeData.overrideSpeedUp) useThoseSpeedups = true;
                    if (useThoseSpeedups) {
                        t.doingSpeedup = true;
                        setTimeout(function () { t.doSpeedup(); }, 2000);
                    }
                    retryTime = 1;
                }
            }
            //CM.ChampView.renderInventory(uW.kocChampionItems);
        } catch (e) {
        }
        // recycle
        clearTimeout(t.timerH);
        t.timerH = setTimeout(t.doAction, retryTime * 1000);
    },

    doSpeedup: function () {
        var t = Tabs.champUpgrader;

        var endTime = t.repairEnd;
        var startTime = unixTime();
        var secondsForRepair = endTime - startTime;
        var divId = "";

        t.speedup = 0;

        if (secondsForRepair > 0 && tcoChampUpgradeData.overrideSpeedUp && tcoChampUpgradeData.useSpeedUp > 0) {

            t.speedup = tcoChampUpgradeData.useSpeedUp;

        } else {

            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.day25 && tcoChampUpgradeData.useEH && uW.ksoItems[8].count > 0) { t.speedup = 8; }

            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour24 && tcoChampUpgradeData.useDH && uW.ksoItems[7].count > 0) { t.speedup = 7; }

            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour15 && tcoChampUpgradeData.useWH && uW.ksoItems[6].count > 0) { t.speedup = 6; }

            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour8 && tcoChampUpgradeData.useAH && uW.ksoItems[5].count > 0) { t.speedup = 5; }

            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour25 && tcoChampUpgradeData.useMH && uW.ksoItems[4].count > 0) { t.speedup = 4; }

            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour1 && tcoChampUpgradeData.useGH && uW.ksoItems[3].count > 0) { t.speedup = 3; }

            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.minute15 && tcoChampUpgradeData.useKH && uW.ksoItems[2].count > 0) { t.speedup = 2; }

            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.minute1 && tcoChampUpgradeData.useSH && uW.ksoItems[1].count > 0) { t.speedup = 1; }

        }

        switch (t.speedup) {
            case "1":
            case 1:
                secondsForRepair -= HOURGLASSES_TIME.minute1;
                divId = 'tcoChampUseSHLabel';
                break;
            case "2":
            case 2:
                secondsForRepair -= HOURGLASSES_TIME.minute15;
                divId = 'tcoChampUseKHLabel';
                break;
            case "3":
            case 3:
                secondsForRepair -= HOURGLASSES_TIME.hour1;
                divId = 'tcoChampUseGHLabel';
                break;
            case "4":
            case 4:
                secondsForRepair -= HOURGLASSES_TIME.hour25;
                divId = 'tcoChampUseMHLabel';
                break;
            case "5":
            case 5:
                secondsForRepair -= HOURGLASSES_TIME.hour8;
                divId = 'tcoChampUseAHLabel';
                break;
            case "6":
            case 6:
                secondsForRepair -= HOURGLASSES_TIME.hour15;
                divId = 'tcoChampUseWHLabel';
                break;
            case "7":
            case 7:
                secondsForRepair -= HOURGLASSES_TIME.hour24;
                divId = 'tcoChampUseDHLabel';
                break;
            case "8":
            case 8:
                secondsForRepair -= HOURGLASSES_TIME.day25;
                divId = 'tcoChampUseEHLabel';
                break;
        }

        if (t.speedup != 0) {
            t.setResult('Used ' + uW.ksoItems[t.speedup].name);
            var divCount = uW.ksoItems[t.speedup].count - 1;
            var divSpeedups = document.getElementById(divId);
            divSpeedups.innerHTML = divCount;
            uW.modal_speedup_apply("champion", t.speedup, t.repairId);

            if (secondsForRepair <= 0) {
                secondsForRepair = 0;
                endTime = startTime;
                t.clearTimerH = setTimeout(t.clearRepair, 1000);
                t.buildChampQueueDisplay();
            } else {
                endTime = unixTime() + secondsForRepair;
                t.repairEnd = endTime;
                var n = new Date(t.repairEnd * 1000);
                var item = uW.kocChampionItems[t.repairId];
                t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString() + ". Item: " + item.name);
                t.clearTimerH = setTimeout(t.clearRepair, secondsForRepair * 1000);
                t.buildChampQueueDisplay();
            }
            t.repairEnd = endTime;
            setTimeout(function () { t.doSpeedup(); }, 1000);
        }
    },

    selectNext: function () {

        if (tcoChampQueueData.index >= tcoChampQueueData.list.length) tcoChampQueueData.index = 0;
        if (tcoChampQueueData.index < 0) tcoChampQueueData.index = 0;

        // for single item mode, always start from the top
        if (tcoChampQueueData.oneItem) tcoChampQueueData.index = 0;

        var l = tcoChampQueueData.list.length;
        for (i = tcoChampQueueData.index; i < l; i++) {
            var item = tcoChampQueueData.list[i];
            if (!item) continue;
            var champItem = uW.kocChampionItems[item.item];
            if ((tcoChampQueueData.list[i].status != "complete")
                        && (champItem != null) 
                        && !(champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE || champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE)) {
                if (((item.action == "enhance") && (item.level <= champItem.rarity)) 
                            || ((item.action == "upgrade") && (item.level <= champItem.level))) {
                    item.status = "complete";
                } else {
                    tcoChampQueueData.index = i;
                    return;
                }
            }
        }

        // if we get here, the queue is complete
        tcoChampQueueData.index = -1;
    },

    doEnhance: function (eItemId) {
        var t = Tabs.champUpgrader;
        try {
            if (tcoChampUpgradeData.active == false || eItemId == 0) {
                t.setStatus("Powered Off");
                return;
            }
            var champItem = uW.kocChampionItems[eItemId];

            if (!champItem) return;

            if (champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE || champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE) {
                // repair and then try again later
                t.doRepair(eItemId);
                return;
            }

            var num_city = pickAetherUseCity();
            if (num_city < 0) {
                t.setStatus("Not enough aetherstones to enhance.  Minimum of " + tcoGeneralOptions.minStones + " needed.  Waiting for more ...");
                return;
            }

            var z = CM.WorldSettings.getSettingAsObject("CE_ENHANCE_AETHERSTONE_MAP");
            var w = z[parseInt(champItem.rarity) + 1].Aetherstones;

            if (w > parseInt(Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0])) {
                t.setStatus("Not enough aetherstones to enhance.");
                return;
            }

            var qI = tcoChampQueueData.list[tcoChampQueueData.index];
            if (qI) {

                qI.triesTotal++;
                qI.triesThis++;
            }

            var chanceItem = 0;

            var useDiv = '';

            if (tcoChampUpgradeData.active && tcoChampQueueData.index != -1 && tcoChampUpgradeData.useQuality <= champItem.rarity) {

                if (tcoChampUpgradeData.useLOM) {
                    if (Seed.items['i21001'] > 0) {
                        chanceItem = 21001;
                        useDiv = 'tcoChampUseLOMLabel';
                    }
                }

                if (tcoChampUpgradeData.useGOM) {
                    if (Seed.items['i21002'] > 0) {
                        chanceItem = 21002;
                        useDiv = 'tcoChampUseGOMLabel';
                    }
                }
                //if (buffItemId) CM.InventoryView.removeItemFromInventory(buffItemId);

            }
            
            if (useDiv != '') document.getElementById(useDiv).innerHTML = uW.ksoItems[chanceItem].count;

            var params = uW.Object.clone(ajfx);
            params.action = '4';
            params.cityId = Seed.cities[num_city][0];
            params.eid = eItemId;
            params.chanceItem = chanceItem;
            params.aetherstones = w;
            params.gems = 0;

            t.setStatus("Sending enhance request");
            new AjaxRequest(uW.g_ajaxpath + 'ajax/ceEquipmentManagerAjax.php' + uW.g_ajaxsuffix, {
                method: "post",
                parameters: params,
                loading: true,
                onSuccess: function (transport) {
                    try {
                        var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
                            Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] = Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] - rslt.aetherstones;
                            if (rslt.gems > 0) {
                                ActionLog('Upgrader accidentally spent gems!  Upgrader turned off');
                                t.setStatus("Error ... shutting down");
                                tcoChampUpgradeData.active = false;
                                SAVEtcoChampUpgradeData();
                            }

                            if (rslt.itemConsumed.itemId != "0") uW.ksoItems[rslt.itemConsumed.itemId].subtract()

                            Seed.player.might += rslt.mightGain;
                            document.getElementById('topnav_might').innerHTML = Seed.player.might;

                            if (champItem.rarity != parseInt(rslt.rarity)) {
                                tcoChampUpgradeStats.enhanceSuccess[champItem.rarity][champItem.level]++;
                                SAVEtcoChampUpgradeStats();
                                champItem.rarity = rslt.rarity;
                                champItem.name = champItem.createName();
                                t.show();
                                t.setResult("Enhance successful.  " + addCommas(rslt.aetherstones) + " aetherstones used.");
                                t.refreshAetherDisplay();
                                t.setStatus("Attempting next action");
                                CM.sounds.play("ch_success_build");
                                // update the cost line
                                var qItem = tcoChampQueueData.list[tcoChampQueueData.index];
                                if (qItem) {
                                    var now = new Date();
                                    
                                    qItem.lastUpgrade = "Enhanced to " + champCardQualities[champItem.rarity] + " " + now.toDateString().substring(3, 10) + " " + now.toTimeString().substring(0, 8) + " in " + qItem.triesThis + " attempts";
                                    if (!qItem.upgrades) qItem.upgrades = [];
                                    qItem.upgrades.push(qItem.lastUpgrade);

                                    var msg = 'Enhanced ' + uW.kocChampionItems[eItemId].name + ' [ ' + eItemId + '] to quality ' + rslt.rarity + " in " + qItem.triesThis + " attempts. " + qItem.triesTotal + " total attempts for this item.";
                                    if (tcoGeneralOptions.whisperToMe) sendChat("/" + Seed.player.name + ' ' + msg);
                                    if (tcoGeneralOptions.sendToInbox) sendComposedMail(Seed.player.name, 'CHAMPION: Enhance Success: ' + uW.kocChampionItems[eItemId].name, msg);
                                    SuccessLog(msg);

                                    if (qItem.level <= champItem.rarity) {
                                        qItem.status = "complete";
                                        tcoChampUpgradeData.newUpgradeState = 2;
                                    }
                                    else {
                                        var now = new Date();
                                        qItem.status = "Partially enhanced";
                                        qItem.triesLast = qItem.triesThis;
                                        qItem.triesThis = 0;
                                        if (tcoChampUpgradeData.newUpgradeState != 2) tcoChampUpgradeData.newUpgradeState = 1;
                                    }
                                    SAVEtcoChampUpgradeData();
                                    setUpgradeColor();
                                }
                                SAVEtcoChampQueueData();
                                t.buildChampQueueDisplay();
                                clearTimeout(Tabs.champUpgrader.timerH);
                                t.timerH = setTimeout(t.doAction, 10 * 1000);
                            }
                            else {
                                tcoChampUpgradeStats.enhanceFailure[champItem.rarity][champItem.level]++;
                                SAVEtcoChampUpgradeStats();
                                ActionLog('Enhance failed Champion item ' + uW.kocChampionItems[eItemId].name);
                                if (rslt.broken == "yes") {
                                    champItem.status = CM.CHAMPION.STATUS_BROKEN_ENHANCE;
                                }

                                champItem.name = champItem.createName();
                                t.setResult("Enhance failed.  " + addCommas(rslt.aetherstones) + " aetherstones used");
                                t.refreshAetherDisplay();
                                var qItem = tcoChampQueueData.list[tcoChampQueueData.index];
                                if (qItem) if (qItem.status == "not started") qItem.status = "started";
                                SAVEtcoChampQueueData();
                                t.buildChampQueueDisplay();
                                clearTimeout(t.timerH);
                                t.timerH = setTimeout(t.doAction, 10 * 1000);
                            }
                        }
                        else {
                            if (rslt.feedback)
                                t.setStatus(rslt.feedback);
                            else
                                t.setStatus("Unable to enhance at this time ... waiting for next cycle");

                        }
                    } catch (e) {
                    }
                    return;
                },
                onFailure: function (rst) {
                    t.setStatus("Unable to send enhance request.  Waiting for next cycle");
                    return;
                }
            });
        } catch (e) {


        }
        return;
    },

    doUpgrade: function (uItemId, bypass) {

        var t = Tabs.champUpgrader;

        var champItem = uW.kocChampionItems[uItemId];

        if (uItemId == 0 || champItem == null) {
            t.setStatus("Item not found.");
            return;
        }

        if ((tcoChampUpgradeData.active == false) && (bypass != true)) {
            t.setStatus("Powered Off");
            return;
        }

        if (bypass == true && t.deleting != true) {
            // delete cycle has been canceled.  Don't upgrade this item
            return;
        }

        if (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE) {
            // repair and then try again later
            t.doRepair(uItemId);
            return;
        }

        if (champItem.status == CM.CHAMPION.STATUS_REPAIRING_ENHANCE || champItem.status == CM.CHAMPION.STATUS_REPAIRING_UPGRADE) {
            t.setStatus("Item is still being repaired");
            return;
        }

        var num_city = pickAetherUseCity();
        if (num_city < 0) {
            t.setStatus("Not enough aetherstones to upgrade.  Minimum of " + tcoGeneralOptions.minStones + " needed.  Waiting for more ...");
            return;
        }

        var z = CM.WorldSettings.getSettingAsObject("CE_UPGRADE_AETHERSTONE_MAP");
        var w = z[parseInt(champItem.level) + 1].Aetherstones;


        if (w > Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0]) {
            t.setStatus("Not enough aetherstones to upgrade.");
            return;
        }

        if (bypass != true) {
            var qI = tcoChampQueueData.list[tcoChampQueueData.index];
            if (qI) {
                qI.triesTotal++;
                qI.triesThis++;
            }

            t.setStatus("Sending upgrade request ...");
        }

        var chanceItem = 0;

        var useDiv = '';

        if (tcoChampUpgradeData.active && tcoChampQueueData.index != -1 && tcoChampUpgradeData.useLevel <= champItem.level) {

            if (tcoChampUpgradeData.useET) {
                if (Seed.items['i21058'] > 0) {
                    chanceItem = 21058;
                    useDiv = 'tcoChampUseETLabel';
                }
            }

            if (tcoChampUpgradeData.useST) {
                if (Seed.items['i21052'] > 0) {
                    chanceItem = 21052;
                    useDiv = 'tcoChampUseSTLabel';
                }
            }

            if (tcoChampUpgradeData.useJT) {
                if (Seed.items['i21051'] > 0) {
                    chanceItem = 21051;
                    useDiv = 'tcoChampUseJTLabel';
                }
            }
        }

        if (useDiv != '') document.getElementById(useDiv).innerHTML = uW.ksoItems[chanceItem].count;

        var params = uW.Object.clone(ajfx);

        params.action = '5';
        params.cityId = Seed.cities[num_city][0];
        params.eid = uItemId;
        params.chanceItem = chanceItem;
        params.aetherstones = w;
        params.gems = 0;


        new AjaxRequest(uW.g_ajaxpath + "ajax/ceEquipmentManagerAjax.php" + uW.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            loading: true,
            onSuccess: function (transport) {
                try {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {

                        Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] = Seed.resources["city" + Seed.cities[num_city][0]]["rec5"][0] - parseInt(rslt.aetherstones);
                        if (rslt.gems > 0) {
                            t.setStatus("Error .... Shutting down.");
                            ActionLog('Upgrader accidentally spent gems!  Upgrader turned off');
                            tcoChampUpgradeData.active = false;
                            SAVEtcoChampUpgradeData();
                        }

                        if (rslt.itemConsumed.itemId != "0") uW.ksoItems[rslt.itemConsumed.itemId].subtract()

                        Seed.player.might += rslt.mightGain;
                        document.getElementById('topnav_might').innerHTML = Seed.player.might;
                        
                        if (parseInt(rslt.level) != champItem.level) {
                            tcoChampUpgradeStats.upgradeSuccess[champItem.rarity][champItem.level]++;
                            SAVEtcoChampUpgradeStats();
                            champItem.level = rslt.level;
                            champItem.name = champItem.createName();

                            if (bypass != true) {
                                t.show();

                                t.setResult("Upgrade successful.  " + addCommas(rslt.aetherstones) + " aetherstones used.");
                                t.refreshAetherDisplay();
                                t.setStatus("Attempting next upgrade");
                                CM.sounds.play("ch_success_build");

                                var qItem = tcoChampQueueData.list[tcoChampQueueData.index];
                                if (qItem) {
                                    var now = new Date();
                                    qItem.lastUpgrade = "Upgraded to +" + champItem.level + " " + now.toDateString().substring(3, 10) + " " + now.toTimeString().substring(0, 8) + " in " + qItem.triesThis + " attempts";

                                    if (!qItem.upgrades) qItem.upgrades = [];
                                    qItem.upgrades.push(qItem.lastUpgrade);

                                    var msg = 'Upgraded ' + uW.kocChampionItems[uItemId].name + ' [' + uItemId + '] to level ' + rslt.level + " in " + qItem.triesThis + " attempts. " + qItem.triesTotal + " total attempts for this item.";
                                    if (tcoGeneralOptions.whisperToMe) sendChat("/" + Seed.player.name + ' ' + msg);
                                    if (tcoGeneralOptions.sendToInbox) sendComposedMail(Seed.player.name, 'CHAMPION: Upgrade Success : ' + uW.kocChampionItems[uItemId].name, msg);
                                    SuccessLog(msg);
                                    if (qItem.level <= champItem.level) {
                                        qItem.status = "complete";
                                        tcoChampUpgradeData.newUpgradeState = 2;
                                    }
                                    else {
                                        var now = new Date();
                                        qItem.status = "Partially upgraded";
                                        qItem.triesLast = qItem.triesThis;
                                        qItem.triesThis = 0;
                                        if (tcoChampUpgradeData.newUpgradeState != 2) tcoChampUpgradeData.newUpgradeState = 1;
                                    }
                                    SAVEtcoChampUpgradeData();
                                    setUpgradeColor();
                                }
                                SAVEtcoChampQueueData();
                                t.buildChampQueueDisplay();
                                clearTimeout(t.timerH);
                                t.timerH = setTimeout(t.doAction, 10 * 1000);

                            }
                        }
                        else {
                            tcoChampUpgradeStats.upgradeFailure[champItem.rarity][champItem.level]++;
                            SAVEtcoChampUpgradeStats();
                            ActionLog('Upgrade failed Champion item ' + uW.kocChampionItems[uItemId].name);
                            if (rslt.broken == "yes") champItem.status = CM.CHAMPION.STATUS_BROKEN_UPGRADE;
                            champItem.name = champItem.createName();
                            if (bypass != true) {
                                if (rslt.feedback) {
                                    t.setResult(rslt.feedback);
                                } else {
                                    t.setResult("Upgrade failed.  " + addCommas(rslt.aetherstones) + " aetherstones used");
                                    t.refreshAetherDisplay();
                                }
                                var qItem = tcoChampQueueData.list[tcoChampQueueData.index];
                                if (qItem.status == "not started") qItem.status = "started";
                                SAVEtcoChampQueueData();
                                t.buildChampQueueDisplay();
                                clearTimeout(t.timerH);
                                t.timerH = setTimeout(t.doAction, 10 * 1000);
                            }
                        }
                        return;
                    }
                    else {
                        if (bypass != true) {
                            t.setResult(rslt.feedback);
                        }
                    }
                } catch (e) {
                }
                return;
            },
            onFailure: function (rrr) {
                t.setStatus("Unable to transmitt upgrade request.  Waiting for next cycle.");
                return;
            }
        });

        return;
    },




    doRepair: function (rItemId) {
        var t = Tabs.champUpgrader;
        var params = uW.Object.clone(ajfx);

        if (!tcoChampUpgradeData.active || rItemId == 0 || uW.kocChampionItems[rItemId] == null) {
            t.setStatus("Powered Off");
            return; //repair is turned off
        }

        var theItem = uW.kocChampionItems[rItemId];

        params.action = "6";
        params.eid = rItemId;
        params.cityId = uW.currentcityid;
        params.gems = 0;

        new AjaxRequest(uW.g_ajaxpath + "ajax/ceEquipmentManagerAjax.php" + uW.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            loading: true,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    var item = uW.kocChampionItems[rslt.equipmentId];
                    ActionLog('Starting repair for Champion item ' + item.name);
                    if (!Seed.queue_champion) Seed.queue_champion = {};
                    Seed.queue_champion.itemId = rslt.equipmentId;
                    Seed.queue_champion.start = parseInt(rslt.start);
                    Seed.queue_champion.end = parseInt(rslt.eta);
                    t.repairId = parseInt(rslt.equipmentId);
                    t.repairEnd = rslt.eta;
                    var n = new Date(t.repairEnd * 1000);
                    t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString() + ". Item: " + item.name);
                    var x = rslt.eta - unixTime();
                    t.clearTimerH = setTimeout(t.clearRepair, (x + 1) * 1000);
                    if (item.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE)
                        item.status = CM.CHAMPION.STATUS_REPAIRING_ENHANCE;
                    else
                        item.status = CM.CHAMPION.STATUS_REPAIRING_UPGRADE;
                    t.buildChampQueueDisplay();
                }
                else {
                    // regrab the end times in case this is caused by a manual repair
                    if (Seed.queue_champion && Seed.queue_champion.end && Seed.queue_champion.itemId) {
                        t.repairEnd = Seed.queue_champion.end;
                        t.repairId = Seed.queue_champion.itemId;
                    }

                    if (feedback.index("There is one equipment in repairing queue") > 0) {
                        // item is still be repaired.    
                        return;
                    }


                    if (rslt.feedback) {
                        t.setStatus(rslt.feedback);
                        uW.kocChampionItems[rItemId].status = CM.CHAMPION.STATUS_INACTIVE;
                        t.clearRepair();
                    }

                }
                return;
            },
            onFailure: function (ttt) {
                // this usually means a repair is in progress (such as a manual repair). Grab the seed data (if possible)
                if (Seed.queue_champion && Seed.queue_champion.end) {
                    t.repairEnd = Seed.queue_champion.end;
                    t.repairId = Seed.queue_champion.itemId;
                }
                return;
            }
        });
        return;
    },

    clearRepair: function () {
        //logit("clear repair");
        var t = Tabs.champUpgrader;
        var timeUntilDone = 0;

        if (t.repairEnd == 0) {
            return timeUntilDone;
        }
        timeUntilDone = t.repairEnd - unixTime();

        if (timeUntilDone <= 0) {
            if (t.repairId != 0 && uW.kocChampionItems[t.repairId] != null) {
                if (uW.kocChampionItems[t.repairId].status != CM.CHAMPION.STATUS_INACTIVE
                               || uW.kocChampionItems[t.repairId].status != CM.CHAMPION.STATUS_ACTIVE) {
                    t.setStatus("Repair time complete.");
                }
                uW.kocChampionItems[t.repairId].status = CM.CHAMPION.STATUS_INACTIVE;
                t.repairId = 0;
                t.show();
            }

        }
        return timeUntilDone;
    },

    addUpgradeItem: function (champId) {
        var t = Tabs.champUpgrader;
        var qItem = new QueueItem();
        qItem.item = champId;
        qItem.action = "upgrade";
        qItem.level = tcoMaxChampLevel;
        tcoChampQueueData.list.push(qItem);
        SAVEtcoChampQueueData();
        //document.getElementById('champInventoryItem' + champId).className = 'tcoBlueBorder';
        t.buildChampQueueDisplay();
    },

    addEnhanceItem: function (champId) {
        var t = Tabs.champUpgrader;
        var qItem = new QueueItem();
        qItem.item = champId;
        qItem.action = "enhance";
        qItem.level = tcoMaxChampQuality;
        tcoChampQueueData.list.push(qItem);
        SAVEtcoChampQueueData();
        //document.getElementById('champInventoryItem' + champId).className = 'tcoYellowBorder';
        t.buildChampQueueDisplay();
    },

    addBothChampItem: function (champId) {
        var t = Tabs.champUpgrader;

        var champItem = uW.kocChampionItems[champId];

        if (champItem == null || !champItem) return;

        var qual = +champItem.rarity;
        var lev = +champItem.level;

        if (qual >= tcoMaxChampQuality) return;

        var maxLev = null;
        var nextQual = null;
        var qItem = null;

        while (qual < tcoMaxChampQuality) {
            maxLev = t.upgradePath[qual].maxLev;
            nextQual = t.upgradePath[qual].nextQual;

            if (lev < maxLev) {
                qItem = new QueueItem();
                qItem.item = champId;
                qItem.action = "upgrade";
                qItem.level = maxLev;
                tcoChampQueueData.list.push(qItem);
                //document.getElementById('champInventoryItem' + champId).className = 'tcoBlueBorder';
            }

            qItem = new QueueItem();
            qItem.item = champId;
            qItem.action = "enhance";
            qItem.level = nextQual;
            tcoChampQueueData.list.push(qItem);
            //document.getElementById('champInventoryItem' + champId).className = 'tcoYellowBorder';
            lev = maxLev;
            qual = nextQual;
        }

        SAVEtcoChampQueueData();
        t.buildChampQueueDisplay();
    },

    addChampQueue: function () {
        var t = Tabs.champUpgrader;
        var action = document.getElementById('tcoChampAction').value;
        if (action == "both") {
            t.addBothChampItem(document.getElementById('tcoChampUpgradeList').value);
            return;
        }
        var qItem = new QueueItem();
        qItem.item = document.getElementById('tcoChampUpgradeList').value;
        qItem.action = document.getElementById('tcoChampAction').value;
        qItem.level = document.getElementById('tcoChampMaxLevel').value;
        if (qItem.item == 0) return;
        tcoChampQueueData.list.push(qItem);
        SAVEtcoChampQueueData();
        t.buildChampQueueDisplay();
    },

    buildChampLevelWidget: function () {
        var t = Tabs.champUpgrader;
        var m;
        var tcoChampAction = document.getElementById('tcoChampAction');
        if (tcoChampAction.value == "enhance") {
            m = ' Max: <select class=tcoSelect id=tcoChampMaxLevel>';
            for (qual = 1; qual <= tcoMaxChampQuality; qual++) {
                m += '<option value="' + qual + '">' + champCardQualities[qual] + '</option>';
            }
            m += '</select>';
        } else if (tcoChampAction.value == "upgrade") {
            m = ' Max: <select class=tcoSelect id=tcoChampMaxLevel>';
            for (lvl = 1; lvl <= tcoMaxChampLevel; lvl++) {
                m += '<option value="' + lvl + '"> +' + lvl + '</option>';
            }
            m += '</select>';
        } else {
            m = ' - <select class=tcoSelect id=tcoChampMaxLevel></select>';
        }

        document.getElementById('tcoChampMaxDiv').innerHTML = m;
        if (tcoChampAction.value == "enhance") {
            document.getElementById('tcoChampMaxLevel').value = tcoMaxChampQuality;
        } else if (tcoChampAction.value == "upgrade") {
            document.getElementById('tcoChampMaxLevel').value = tcoMaxChampLevel;
        }

    },

    buildChampQueueDisplay: function () {
        var t = Tabs.champUpgrader;

        var tcoChampQDiv = document.getElementById('tcoChampQDiv');

        var m = '<table id=tcoChampQueue width=100%>';
        m += '<tr><th width=10%>Remove</th>';
        m += '<th width=5%>Order</th>';
        m += '<th width=8%>Status</th>';
        m += '<th width=25%>Item</th>';
        m += '<th width=5%>Action</th>';
        m += '<th width=5%>Max</th>';
        m += '<th width=40%>Status/Last Upgrade/Attempts</th></tr>';

        for (var queueIndex = 0; queueIndex < tcoChampQueueData.list.length; queueIndex++) {
            var queueItem = tcoChampQueueData.list[queueIndex];
            if (!queueItem) continue;
            var champItem = uW.kocChampionItems[queueItem.item];

            var champCardName = "Unknown / Item removed";
            var champId = 0;

            if (champItem) {
                champCardName = champItem.name;
                champId = champItem.id;
            }

            m += '<tr>';
            m += '<td align=center><div id=tcoChampQueueRemove' + queueIndex + ' class=tcoRemove></div></td>';
            m += '<td align=center><div id=tcoChampUpRow' + queueIndex + ' class=tcoUpRow></div><div class=tcoDownRow  id=tcoChampDownRow' + queueIndex + '></div></td>';
            m += '<td align=center><div id=tcoChampState' + queueIndex + '></div></td>';
            m += '<td align=center class=tcoChampUpdaterItemName><div id=tcoChampUpdaterItem' + champId + ' >' + champCardName + '</div></td>';
            m += '<td align=center>' + queueItem.action + '</td>';
            m += '<td>';
            if (queueItem.action == "enhance") {
                m += '<div style="text-align: center;"><select class=tcoSelect id=tcoChampChangeLevel' + queueIndex + ' style="width:90px; text-align: center;">';
                for (qual = 1; qual <= tcoMaxChampQuality; qual++) {
                    m += '<option value="' + qual + '" ' + (queueItem.level == qual ? 'selected' : '') + '>' + champCardQualities[qual] + '</option>';
                }
                m += '</select></div>';
            } else {
                m += '<div style="text-align: center;"><select class=tcoSelect id=tcoChampChangeLevel' + queueIndex + ' style="width:90px; text-align: center;">';
                for (lvl = 1; lvl <= tcoMaxChampLevel; lvl++) {
                    m += '<option value="' + lvl + '"  ' + (queueItem.level == lvl ? 'selected' : '') + '> +' + lvl + '</option>';
                }
                m += '</select></div>';
            }
            m += '</td>';

            m += '<td style="text-align: center; white-space: pre-wrap;">' + queueItem.status + ' / ';
            if (queueItem.lastUpgrade) m += queueItem.lastUpgrade;
            m += ' / ' + queueItem.triesThis + ' tries this level, ' + queueItem.triesTotal + ' tries total';
            m += '</td>';

            m += '</tr>';
        }
        m += '</table>';

        tcoChampQDiv.innerHTML = m;

        for (var queueIndex = 0; queueIndex < tcoChampQueueData.list.length; queueIndex++) {
            var queueItem = tcoChampQueueData.list[queueIndex];
            if (!queueItem) continue;
            var champItem = uW.kocChampionItems[queueItem.item];

//            if (champItem) {
//                var trId = champItem.id;

//                document.getElementById('tcoChampUpdaterItem' + trId).addEventListener('mouseover', function(A) {
//                    A.stopPropagation();
//                    var champId = this.id.split('tcoChampUpdaterItem')[1];
//                    var champItem = uW.kocChampionItems[champId];
//                    var tcoCard = document.getElementById('tcoChampUpdaterItem' + champId);
//                    CM.ChampView.hoverItem(A, tcoCard, champItem);
//                }, false);
//            }

            document.getElementById('tcoChampQueueRemove' + queueIndex).setAttribute('v1', queueIndex);
            document.getElementById('tcoChampQueueRemove' + queueIndex).addEventListener('click', function () {
                var qIndex = this.getAttribute('v1');
                t.deleteQueueItem(qIndex);
            }, false);

            document.getElementById('tcoChampUpRow' + queueIndex).setAttribute('v1', queueIndex);
            document.getElementById('tcoChampUpRow' + queueIndex).addEventListener('click', function () {
                var qIndex = this.getAttribute('v1');
                t.moveUpRow(qIndex);
            }, false);

            document.getElementById('tcoChampDownRow' + queueIndex).setAttribute('v1', queueIndex);
            document.getElementById('tcoChampDownRow' + queueIndex).addEventListener('click', function () {
                var qIndex = this.getAttribute('v1');
                t.moveDownRow(qIndex);
            }, false);

            document.getElementById('tcoChampChangeLevel' + queueIndex).setAttribute('v1', queueIndex);
            document.getElementById('tcoChampChangeLevel' + queueIndex).addEventListener('change', function () {
                var qIndex = this.getAttribute('v1');
                var itemLevel = this.value;
                t.changeLevel(qIndex, itemLevel);
            }, false);
            
            if (!champItem || !(champItem.equipmentId)) {
                document.getElementById('tcoChampState' + queueIndex).innerHTML = '<div style="text-align:center"> ??</div>';

            } else if (queueItem.status == "complete") {
                document.getElementById('tcoChampState' + queueIndex).className = 'tcoSuccess';

            } else if (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE) {
                document.getElementById('tcoChampState' + queueIndex).className = 'tcoBroken';

            } else if (champItem.status == CM.CHAMPION.STATUS_REPAIRING_UPGRADE || champItem.status == CM.CHAMPION.STATUS_REPAIRING_ENHANCE) {
                document.getElementById('tcoChampState' + queueIndex).className = 'tcoHammer';
            } else {
                document.getElementById('tcoChampState' + queueIndex).innerHTML = '<div class=tcoGoButton></div>';
            }

        }
    },

    deleteQueueItem: function (index) {
        // delete an item from the queue
        var t = Tabs.champUpgrader;
        tcoChampQueueData.list.splice(index, 1);
        if (index > tcoChampQueueData.index) tcoChampQueueData.index--;
        SAVEtcoChampQueueData();
        t.buildChampQueueDisplay();
    },

    moveUpRow: function (index) {
        if (index < 1) return;
        var t = Tabs.champUpgrader;
        var qItem = tcoChampQueueData.list.splice(index, 1);
        tcoChampQueueData.list.splice(index - 1, 0, qItem[0]);

        if (index == tcoChampQueueData.index)
            tcoChampQueueData.index--;
        else if (tcoChampQueueData.index == index - 1)
            tcoChampQueueData.index++;

        SAVEtcoChampQueueData();
        t.buildChampQueueDisplay();
    },

    moveDownRow: function (index) {
        if (index > (tcoChampQueueData.list.length - 2)) return;

        var t = Tabs.champUpgrader;
        var qItem = tcoChampQueueData.list.splice(index, 1);
        tcoChampQueueData.list.splice(index + 1, 0, qItem[0]);

        if (index == tcoChampQueueData.index)
            tcoChampQueueData.index++;
        else if (tcoChampQueueData.index == index + 1)
            tcoChampQueueData.index--;

        SAVEtcoChampQueueData();
        t.buildChampQueueDisplay();

    },

    changeLevel: function (index, level) {
        var t = Tabs.champUpgrader;
        
        var queueItem = tcoChampQueueData.list[index];
        if (!queueItem) return;

        queueItem.level = level;
        if (queueItem.status == "complete") queueItem.status = "started";
        SAVEtcoChampQueueData();
        t.buildChampQueueDisplay();
    },

    setStatus: function (s) {
        document.getElementById('tcoChampUpgradeStatus').innerHTML = '<div>' + s + '</div>';
    },

    setResult: function (s) {
        document.getElementById('tcoChampLastResult').innerHTML = '<div>' + s + '</div>';
    },

    togglePower: function (obj) {
        var t = Tabs.champUpgrader;
        
        if (!tcoChampUpgradeData.active && tcoChampRepairData.active) {
            alert('You must disable repair tab first');
            return;
        }

        var btn = document.getElementById('tcoChampUpgradePower');
        if (tcoChampUpgradeData.active) {
            tcoChampUpgradeData.active = false;
            btn.value = 'Upgrader = OFF';
            t.setStatus('Powered Off');
            t.setResult('');

        } else {
            tcoChampUpgradeData.active = true;
            btn.value = "Upgrader = ON";
            t.setStatus("Powered On");
            t.setResult("");
        }

        if (!tcoChampUpgradeData.active) {

        }

        SAVEtcoChampUpgradeData();
    },

}

Tabs.champSalvager = {
	tabOrder: 100,
	tabLabel: 'SALVAGER',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL SALVAGER',
    timer    : null,
    city     : null,
    cityNum  : 0,
    delItems        : [],
    rowNum   : 0,
    sTimer : null,
    delTimer : null,
    upgradeProfit: true,

	init: function (div) {
		var t = Tabs.champSalvager;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        
		m += '<div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        if (tcoChampSalvageData.active) {
            m += '<td width=33%><input id=tcoChampSalvagerPower type=button class=tcoButton value="Salvager = ON"></td>';
        } else {
            m += '<td width=33%><input id=tcoChampSalvagerPower type=button class=tcoButton value="Salvager = OFF"></td>';
        }        
        m += '<td width=33%><div class=divNoWrap align=center>';
        m += 'Keep All: <select id=tcoChampSalvageQuality class=tcoSelect>';
        for (i = 1; i <= tcoMaxChampQuality; i++) m += '<option value="' + i + '" ' + (tcoChampSalvageData.minQuality == i ? 'SELECTED' : '') + '>' + throneCardQualities[i].capitalizeFirstLetter() + '+</option>';
        m += '</select>';
        m += '</div></td>';
        m += '<td width=33%><div class=divNoWrap>Keep First <input style="text-align: center;" id=tcoChampSaveNum class=tcoTextbox type=text size=3 maxlength=3 value="' + tcoChampSalvageData.champSaveNum + '"/> Items</div></td>';
        m += '</tr>';
        m += '<tr><td colspan=3><hr class=tcoHRCenter></td></tr>';
        m += '<tr><td colspan=3><div class=indent5 id=tcoChampSalvageStatus></div></td></tr>';
        m += '<tr><td colspan=3><div class=indent5 id=tcoChampNumSalv><br></div></td></tr>';
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader id=tcoChampSimpleRule onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;SIMPLE RULES&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="position: static; width: 100%; height: 200px; overflow-x: hidden; overflow-y: auto;">';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td>';
        m += '<table>';
        m += '<tr><td><b>Define Champ Items To Keep:</b></td>';
        m += '<td alight=left><div><span>Faction: <select id=tcoChampFactionType class=tcoSelect>';
        m += '  <option value="any">Any</option>';
        for (var fact in tcoFactions) m += '<option value="' + tcoFactions[fact] + '">' + tcoFactions[fact].capitalizeFirstLetter() + '</option>';
        m += '</select></span></div></td>';
        m += '<td alight=left><div><span>Card Type: <select id=tcoChampCardType class=tcoSelect>';
        m += '  <option value="any">Any</option>';
        for (var ct in champItemNames) m += '  <option value="' + champItemNames[ct] + '">' + champItemNames[ct].capitalizeFirstLetter() + '</option>';
        m += '</select></span></div></td>';
        m += '<td align=right><input id=tcoChampAddRule type=button class=tcoButton value="Create Rule"/></td>';
        m += '</tr>';
        m += '</table>';
        m += '</td></tr>';
        m += '<tr><td>';
        m += '<table id=tcoChampConditionTable style="padding-left: 5px;">';
        m += '<tr><td align=left colspan=1><input id=tcoChampAddRow type=button class=tcoButton value="Add Row"/></td>';
        m += '<td></td><td></td><td></td><td></td><td></td></tr>';
        m += '</table>';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>';   //end of tcoSection
        
        m += '<div class=tcoHeader id=tcoChampAdvancedRule onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;ADVANCED RULES&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td>';
        m += '<table>';
        m += '<tr><td colspan=4><input class=tcoButton type=button id=tcoChampAdvancedReset value="Reset"></tr>';
        m += '<tr>';
        m += '<td><b>Define Champ Items To Keep:</b></td>';
        m += '<td alight=left><div><span>Faction: <select id=tcoChampFactionTypeAdvanced class=tcoSelect>';
        m += '  <option value="any">Any</option>';
        for (var fact in tcoFactions) m += '<option value="' + tcoFactions[fact] + '">' + tcoFactions[fact].capitalizeFirstLetter() + '</option>';
        m += '</select></span></div></td>';
        m += '<td alight=left><div><span>Card Type: <select id=tcoChampCardTypeAdvanced class=tcoSelect>';
        m += '  <option value="any">Any</option>';
        for (var ct in champItemNames) m += '  <option value="' + champItemNames[ct] + '">' + champItemNames[ct].capitalizeFirstLetter() + '</option>';
        m += '</select></span></div></td>';
        m += '<td align=right><input id=tcoChampAddRuleAdvanced type=button class=tcoButton value="Create Rule"/></td>';
        m += '</tr>';
        m += '</table>';
        m += '</td></tr>';
        m += '<tr><td>';
        m += '<table width=100% id=tcoChampConditionTableAdvanced>';
        m += '<tr>';
        m += '<td width=20%>ROW 1</td>';
        m += '<td width=20%>ROW 2</td>';
        m += '<td width=20%>ROW 3</td>';
        m += '<td width=20%>ROW 4</td>';
        m += '<td width=20%>ROW 5</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoChampRow1Advanced class=tcoSelect></select></div></td>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoChampRow2Advanced class=tcoSelect></select></div></td>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoChampRow3Advanced class=tcoSelect></select></div></td>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoChampRow4Advanced class=tcoSelect></select></div></td>';
        m += '<td width=20%><div><select style="max-width: 125px;" id=tcoChampRow5Advanced class=tcoSelect></select></div></td>';
        m += '</tr>';
        m += '</table>';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>';   //end of tcoSection
        
        m += '<div class=tcoHeader>&nbsp;RULES LIST&nbsp;</div>';
        
        m += '<div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td align=center>';
        m += 'Sort By Card Type: <select id=tcoChampSalvageSortCard class=tcoSelect>';
        m += '<option value="0">--Select--</option>';
        for (var ct in champItemNames) m += '  <option value="' + champItemNames[ct] + '">' + champItemNames[ct].capitalizeFirstLetter() + '</option>';
        m += '</select>';
        m += '</td></tr>';
        m += '<tr><td align=center>';
        m += '<b>Salvager Will Keep Items Matching These Rules</b>';
        m += '</td></tr>';
        m += '<tr><td align=center>';
        m += '<div align=center>';
        m += '<table align=center width=100%>';
        m += '<tr>';
        m += '<td align=left><input id=tcoChampButtonSaveItem type=button class=tcoButton value="Save Rules">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
        m += '<input id=tcoChampClearAllRules type=button class=tcoButton value="Clear All Rules"></td>';
        m += '<td align=right>'
        m += '<input id=tcoChampButtonLoadItem type=button class=tcoButton value="Load Rules">';
        m += '<input class=tcoButton type=button id=tcoChampFileDrop onclick="document.getElementById(\'tcoChampFileLoadItem\').click()" value="Browse...">';
        m += '<input id=tcoChampFileLoadItem style="visibility: hidden; height:0px; width: 0px;" type=file>';
        m += '</td>';
        m += '</tr>';
        m += '</table>';
        m += '</div>';
        m += '</td></tr>';
        m += '<tr><td align=center>';
        m += '<div id=tcoChampRuleScroll style="position: static; width: 100%; height: ' + dlgHeight + '; overflow-x: hidden; overflow-y: auto;" >';
        m += '<div id=tcoChampRuleDisplay></div>';
        m += '</div>';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>'; //end of tcoSection
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        if (tcoChampSalvageData.active)
            t.setStatus('Loading...');
        else
            t.setStatus('Powered Off');

        t.displayNumberSalvaged();

        document.getElementById('tcoChampClearAllRules').addEventListener('click', function() {
            tcoChampSalvageData.ruleSet = [];
            SAVEtcoChampSalvageData();
            t.buildChampRuleDisplay();
        }, false);


        document.getElementById('tcoChampAdvancedReset').addEventListener('click', function () {
            var cardtype = document.getElementById('tcoChampCardTypeAdvanced');
            cardtype.selectedIndex = 0;
            t.clearAdvancedStats();
            t.setAdvancedStatsToAny();
        }, false);

        t.setAdvancedStatsToAny();

        document.getElementById('tcoChampAddRuleAdvanced').addEventListener('click', function() { 
            t.createAdvancedRule();
        }, false);

        document.getElementById('tcoChampCardTypeAdvanced').addEventListener('change', function() {
            var selectedValue = document.getElementById('tcoChampCardTypeAdvanced').value;
            t.clearAdvancedStats();
            if (selectedValue == "any") { 
                t.setAdvancedStatsToAny();
            } else {
                t.filterAdvancedStats(selectedValue);
            }
        }, false);

        document.getElementById('tcoChampSalvagerPower').addEventListener('click', function() {
            t.togglePower(this);
        } , false);

        t.createRow();
        t.buildChampRuleDisplay();

        document.getElementById('tcoChampSalvageSortCard').addEventListener('change', function() {
            t.buildChampRuleDisplay();
        }, false);

        document.getElementById('tcoChampButtonSaveItem').addEventListener('click', function() {
            uriContent = 'data:application/octet-stream,' + encodeURIComponent(JSON.stringify(tcoChampSalvageData.ruleSet));
            newWindow = window.open(uriContent, 'file.txt');                
        }, false);

        document.getElementById('tcoChampButtonLoadItem').addEventListener('click', function() {
            var fileInput = document.getElementById("tcoChampFileLoadItem");
            var files = fileInput.files;
            if (files.length==0) {
                alert('Please Select A File');
                return;
            }
            var file = files[0];
                
            var reader = new FileReader();
                
            reader.onload = function (e) {  
				var output = e.target.result;
				tcoChampSalvageData.ruleSet = JSON.parse(output);
                tcoChampSalvageData.active = false;
                clearInterval(t.sTimer);
                clearInterval(t.delTimer);
                t.deleting = false;
                SAVEtcoChampSalvageData();
                t.show();
                alert('Champ Salvage Settings Now Loaded From File');
            };
            reader.readAsText(file);
        }, false);

        document.getElementById('tcoChampSaveNum').addEventListener('change', function () {
            tcoChampSalvageData.champSaveNum = parseInt(document.getElementById('tcoChampSaveNum').value);
            if (tcoChampSalvageData.champSaveNum < 0) tcoChampSalvageData.champSaveNum = 0;
            SAVEtcoChampSalvageData();
        }, false);

        document.getElementById('tcoChampSalvageQuality').addEventListener('click', function() {
            t.setSalvageLevel(this.value);
        }, false);

        document.getElementById('tcoChampAddRow').addEventListener('click', function() {
            t.createRow();
        }, false);

        document.getElementById('tcoChampAddRule').addEventListener('click', function() {
            t.createRule();
        }, false);

        t.upgradeProfit = (5*CM.WorldSettings.getSettingAsNumber("AETHERSTONE_SALVAGE_MULTIPLIER", 500) > CM.thronestats.upgrade[1]["Stones"]); 
        t.start();

	},

    setAdvancedStatsToAny: function() {
        for (var r = 1; r < tcoQualityCount; r++) {
            var row = document.getElementById('tcoChampRow' + r + 'Advanced');
            row.options.add(new Option("none","none"));
            for (i = 0; i < champItemEffects.length; i++) {
                var effectName = uW.g_js_strings.effects["name_" + champItemEffects[i]];
                row.options.add(new Option(effectName, effectName));
            }
        }
    },

    clearAdvancedStats: function() {
        for (var i = 1; i < tcoQualityCount; i++) {
            var row = document.getElementById('tcoChampRow' + i + 'Advanced');
            row.innerHTML = "";
        }
    },

    filterAdvancedStats: function(cardtype) {
        var t = Tabs.champSalvager;

        cardtype = cardtype || "any";

        if (cardtype == "any") {
            t.setAdvancedStatsToAny();
            return;
        }

        document.getElementById("tcoChampRow1Advanced").options.add(new Option("none", "none"));
        document.getElementById("tcoChampRow2Advanced").options.add(new Option("none", "none"));
        document.getElementById("tcoChampRow3Advanced").options.add(new Option("none", "none"));
        document.getElementById("tcoChampRow4Advanced").options.add(new Option("none", "none"));
        document.getElementById("tcoChampRow5Advanced").options.add(new Option("none", "none"));

        for (i = 0; i < champItemEffects.length; i++) {
            var effectName = uW.g_js_strings.effects["name_" + champItemEffects[i]];
            var eff = champItemEffects[i];
            if (tcoChampStatsGrid[cardtype][1][eff]) { document.getElementById("tcoChampRow1Advanced").options.add(new Option(effectName, effectName)); }
            if (tcoChampStatsGrid[cardtype][2][eff]) { document.getElementById("tcoChampRow2Advanced").options.add(new Option(effectName, effectName)); }
            if (tcoChampStatsGrid[cardtype][3][eff]) { document.getElementById("tcoChampRow3Advanced").options.add(new Option(effectName, effectName)); }
            if (tcoChampStatsGrid[cardtype][4][eff]) { document.getElementById("tcoChampRow4Advanced").options.add(new Option(effectName, effectName)); }
            if (tcoChampStatsGrid[cardtype][5][eff]) { document.getElementById("tcoChampRow5Advanced").options.add(new Option(effectName, effectName)); }
        }

    },
        	
	hide: function () {},
	
	show: function () {
		var t = Tabs.champSalvager;
        t.displayNumberSalvaged();
    },

    tripOdometer : function() {
        var t = Tabs.champSalvager;
        tcoChampSalvageData.numSalvagedItems2 = 0;
        var now = new Date();
        tcoChampSalvageData.since = now.valueOf();
        SAVEtcoChampSalvageData();
        t.show();
    },

    displayNumberSalvaged : function () {
        var t = Tabs.champSalvager;

        var since = "";
        var rate = "";
        var now = new Date();

        if (!tcoChampSalvageData.since) tcoChampSalvageData.since = now.valueOf();

        var sinceD = new Date(tcoChampSalvageData.since);

        since = sinceD.toDateString().substring(3,10) + " " + sinceD.toLocaleTimeString();
        var duration = now.valueOf() - tcoChampSalvageData.since +1;
        duration = duration / 1000.0;
        rate = " (" + addCommas(Math.round(tcoChampSalvageData.numSalvagedItems2 / duration * 86400)) + " per day)";

        var m = '<div style="text-align: center;">' + addCommas(tcoChampSalvageData.numSalvagedItems);
        m += ' items salvaged, ' + addCommas(tcoChampSalvageData.numSalvagedItems2);
        m += ' items since ' + since + rate + ' <input id=tcoChampTripOdometer class=tcoButton type=button value="Reset" /></div>';
        document.getElementById('tcoChampNumSalv').innerHTML = m;

        document.getElementById('tcoChampTripOdometer').addEventListener('click', function () {
            t.tripOdometer();  
        }, false);

    },


    createRow : function() {
        var t = Tabs.champSalvager;
        var table = document.getElementById('tcoChampConditionTable');
        var rowCount = table.rows.length;
        var row = table.insertRow(rowCount-1);
        var rowId = "r" + t.rowNum;
        t.rowNum++;
        row.id = rowId;

        var h  = "<td> <select class=tcoSelect id='" + rowId + "ChampsSel1'> <option value='true'> </option> <option value='false'>NOT</option></select></td>";
        h += "<td> <select class=tcoSelect id='" + rowId + "ChampsSel2'>";
        h += "  <option value='1'>1x</option>";
        h += "  <option value='2'>2x</option>";
        h += "  <option value='3'>3x</option>";
        h += "  <option value='4'>4x</option>";
        h += "  <option value='5'>5x</option>";
        h += "</select></td>";
        h += "<td> <select class=tcoSelect id='" + rowId + "ChampsSel3'>";
        h += "</select></td>";
        h += "<td> <select class=tcoSelect id='" + rowId + "ChampsSel4'>";
        h += "  <option value='e'>Either</option>";
        h += "  <option value='b'>Buff</option>";
        h += "  <option value='d'>Debuff</option>";
        h += "</select></td>";

        h += "<td> Slots: ";
        h += "  <input class=tcoCheckbox type=checkbox value='1' checked=true id='" + rowId + "ChampsSlot1'/>1";
        h += "  <input class=tcoCheckbox type=checkbox value='2' checked=true id='" + rowId + "ChampsSlot2'/>2";
        h += "  <input class=tcoCheckbox type=checkbox value='3' checked=true id='" + rowId + "ChampsSlot3'/>3";
        h += "  <input class=tcoCheckbox type=checkbox value='4' checked=true id='" + rowId + "ChampsSlot4'/>4";
        h += "  <input class=tcoCheckbox type=checkbox value='5' checked=true id='" + rowId + "ChampsSlot5'/>5";
        h += "</td>";

        row.innerHTML = h;

        var effects = [];
            
        for (i = 0; i < champItemEffects.length; i++) {
            var effectName = uW.g_js_strings.effects["name_" + champItemEffects[i]];
            effectName = effectName.split(" Debuff")[0];
            if  (effects.indexOf(effectName) < 0) effects.push(effectName);
        }

        var select = document.getElementById(rowId + "ChampsSel3");
        for (index in effects) {
            select.options.add(new Option(effects[index], effects[index]));
        }

        var c = row.insertCell(5);
        //TODO
//        var btn = document.createElement("BUTTON");
//        btn.className = 'tcoButton';
//        btn.value = 'X';
//        btn.addEventListener('click', function () { t.removeRow(row); }, false);
//        c.append(btn);
        var btn = $("<input class=tcoButton type=button value='X'/>");
        $(btn).click( function () { t.removeRow(row);});
        $(c).append( btn );

    },

    setSalvageLevel : function(level) {
        tcoChampSalvageData.minQuality = level;
        SAVEtcoChampSalvageData();
    },

    createAdvancedRule: function() {
        var t = Tabs.champSalvager;
        t.readAdvancedRows();
        t.buildChampRuleDisplay();  
    },

    createRule : function() {
        var t = Tabs.champSalvager;
        t.readRows();
        t.buildChampRuleDisplay();
    },

    buildChampRuleDisplay : function () {
        var t = Tabs.champSalvager;

        function innerRuleDisplay(dataset) {
            var innerM = "";
            for (i = 0; i < dataset.length; i++)
            {
                var rule = dataset[i];

                innerM += '<tr>';
                innerM += "<td width=90%><div class='tcoChampRule'>";
                
                innerM += (rule.advancedrule ? 'Advanced Rule:<br>' : 'Simple Rule:<br>');

                innerM += " Type: " + rule.type;
                innerM += " Faction: " + rule.faction;

                for (ii = 0; ii < rule.conditions.length; ii++)
                {
                    var condition = rule.conditions[ii];

                    if (ii ==0 )
                        innerM += "<br> Item";
                    else
                        innerM += "<br> <u>and</u>";

                    if (condition.mustHave != "false")
                        innerM += " must have ";
                    else
                        innerM += " must NOT have ";

                    innerM += condition.number + "x ";
                    innerM += condition.effect + " ";

                    if (condition.buffType == "b")
                        innerM += "buff ";
                    else if (condition.buffType == "d")
                        innerM += "debuff ";
                    else
                        innerM += "buff or debuff ";

                    innerM += " in slot(s): ";

                    for (j = 0; j < condition.slots.length; j++)
                    {
                        if (condition.slots[j] ) innerM += (j+1) + " ";
                    }

                }
                innerM += '</div></td>';
                innerM += '<td width=20% align=center>';
                innerM += '<input id=tcoChampEditRule' + i + ' type=button class=tcoButton value="Edit"><br>';
                innerM += '<input id=tcoChampDelRule' + i + ' type=button class=tcoButton value="X">';
                innerM += '</td>';
                innerM += '</tr>';
            }
            return innerM;
        }

        var rd = document.getElementById('tcoChampRuleDisplay');
        var sortType = document.getElementById('tcoChampSalvageSortCard').value;

        if (sortType != "0") {
            var sortedDataSet = [];
            for (var k = 0; k < tcoChampSalvageData.ruleSet.length; k++) {
                if (sortType == tcoChampSalvageData.ruleSet[k].type) {
                    sortedDataSet.unshift(tcoChampSalvageData.ruleSet[k]);
                }else {
                    sortedDataSet.push(tcoChampSalvageData.ruleSet[k]);
                }
            }
            rd.innerHTML = '<table width=100%>' + innerRuleDisplay(sortedDataSet);
            for (var j=0; j < sortedDataSet.length; j++)
            {
                document.getElementById('tcoChampDelRule' +j).v1 = j;
                document.getElementById('tcoChampEditRule' +j).v1 = j;
                document.getElementById('tcoChampDelRule' +j).addEventListener ('click', function() { t.deleteRule(this.v1, sortedDataSet);}, false);
                document.getElementById('tcoChampEditRule' +j).addEventListener ('click', function() { t.editRule(this.v1, sortedDataSet);}, false);
            }
        } else {
            rd.innerHTML = '<TABLE  width=100%>' + innerRuleDisplay(tcoChampSalvageData.ruleSet);
            for (var j=0; j < tcoChampSalvageData.ruleSet.length; j++)
            {
                document.getElementById('tcoChampDelRule' +j).v1 = j;
                document.getElementById('tcoChampEditRule' +j).v1 = j;
                document.getElementById('tcoChampDelRule' +j).addEventListener ('click', function() { t.deleteRule(this.v1, tcoChampSalvageData.ruleSet);}, false);
                document.getElementById('tcoChampEditRule' +j).addEventListener ('click', function() { t.editRule(this.v1, tcoChampSalvageData.ruleSet);}, false);
            }
        }


    },

    editRule : function(ruleIndex, sortedData)
    {
        var t = Tabs.champSalvager;
        var rule = sortedData[ruleIndex];

        var divExpander = null;

        if (rule.advancedrule)
            divExpander = document.getElementById('tcoChampAdvancedRule');
        else 
            divExpander = document.getElementById('tcoChampSimpleRule');

        divExpander.click();
        if (divExpander.childNodes[0].src == tcoRightArrow) divExpander.click();

        if (rule.advancedrule) {
            document.getElementById('tcoChampFactionTypeAdvanced').value = rule.faction;
            document.getElementById('tcoChampCardTypeAdvanced').value = rule.type;
            t.clearAdvancedStats();
            if (rule.type == 'any')
                t.setAdvancedStatsToAny();
            else
                t.filterAdvancedStats(rule.type);

            for (row = 0; row < rule.conditions.length; row++) {
                var condition = rule.conditions[row];
                var slotNumber = 0;
                for (s = 0; s < condition.slots.length; s++) {
                    if (condition.slots[s]) slotNumber = s+1;
                }
                var cell = document.getElementById('tcoChampRow' + slotNumber + 'Advanced');
                var tcoEffect = condition.effect;
                if (condition.buffType == 'd') tcoEffect += ' Debuff';
                cell.value = tcoEffect;
            }

        } else {
            document.getElementById('tcoChampFactionType').value = rule.faction;
            document.getElementById('tcoChampCardType').value = rule.type;
            var tcoChampConditionTable = document.getElementById('tcoChampConditionTable');
            while (tcoChampConditionTable.rows.length > 1) tcoChampConditionTable.deleteRow(0);
            for (row = 0; row < rule.conditions.length; row++) {
                var condition = rule.conditions[row];
                t.createRow();
                tcoChampConditionTable = document.getElementById('tcoChampConditionTable');
                tcoChampConditionTable.rows[row].cells[0].children[0].value = condition.mustHave;
                tcoChampConditionTable.rows[row].cells[1].children[0].value = condition.number;
                tcoChampConditionTable.rows[row].cells[2].children[0].value = condition.effect;
                tcoChampConditionTable.rows[row].cells[3].children[0].value = condition.buffType;
                var slotCells = tcoChampConditionTable.rows[row].cells[4];
                for (s = 0; s < condition.slots.length; s++) {
                    if (condition.slots[s])
                        slotCells.children[s].checked = true;
                    else
                        slotCells.children[s].checked = false;
                }
            }
        }
        t.deleteRule(ruleIndex, sortedData);
    },

    // delete a rule from the ruleset
    deleteRule : function(ruleIndex, sortedData) 
    {
        var t = Tabs.champSalvager;
        sortedData.splice(ruleIndex,1);
        var newDataSet = [];
        for (var i = 0; i < tcoChampSalvageData.ruleSet.length; i++) {
            for (var i2 = 0; i2 < sortedData.length; i2++) {
                if (tcoChampSalvageData.ruleSet[i] == sortedData[i2]) {
                    newDataSet.push(tcoChampSalvageData.ruleSet[i]);
                    break;
                }
            }
        }
        tcoChampSalvageData.ruleSet = newDataSet;
        SAVEtcoChampSalvageData();
        t.buildChampRuleDisplay();
    },

    togglePower: function(obj){
        var t = Tabs.champSalvager;
            
        if (tcoChampSalvageData.active) {
            var btn = document.getElementById('tcoChampSalvagerPower');
            tcoChampSalvageData.active = false;
            btn.value = "Salvager = OFF";
            clearInterval(t.sTimer);
            clearInterval(t.delTimer);
            t.delItems = [];
            t.deleting = false;
        } else {
            tcoChampSalvageData.active = true;
            var btn = document.getElementById('tcoChampSalvagerPower');
            btn.value = "Salvager = ON";
            t.doSalvage();
            t.start();
        }
        SAVEtcoChampSalvageData();
    },

    readAdvancedRows: function () {
        var t = Tabs.champSalvager;
        var cType = document.getElementById('tcoChampCardTypeAdvanced').value;
        var faction = document.getElementById('tcoChampFactionTypeAdvanced').value;
        var row1 = document.getElementById("tcoChampRow1Advanced");
        var row2 = document.getElementById("tcoChampRow2Advanced");
        var row3 = document.getElementById("tcoChampRow3Advanced");
        var row4 = document.getElementById("tcoChampRow4Advanced");
        var row5 = document.getElementById("tcoChampRow5Advanced");
        var conditions = [];
        for (var i = 1; i < tcoQualityCount; i++) {
            var row = document.getElementById("tcoChampRow" + i + "Advanced");
            if (row.selectedIndex == 0) continue;
            var slots = [];
            for (var slotChecker = 1; slotChecker < tcoQualityCount; slotChecker++) {
                slots.push(slotChecker==i);
            }
            var effectName = row.options[row.selectedIndex].value;
            var buffDebuff = "b";
            if (effectName.indexOf(" Debuff") != -1) buffDebuff = "d";
            var effectName = effectName.split(" Debuff")[0];
            var c = new ChampCondition(true, 1, effectName, buffDebuff, slots);
            conditions.push(c);
        }
        if ( conditions.length > 0 ) {
            var rule1 = new ChampRule(cType, faction, conditions, true);
            t.addRule(rule1);
        }
    },

    readRows : function()
    {
        var t = Tabs.champSalvager;
        var table = document.getElementById('tcoChampConditionTable');
        var rowCount = table.rows.length;

        var cType = document.getElementById('tcoChampCardType').value;
        var faction = document.getElementById('tcoChampFactionType').value;

        var conditions = [];
        for (i=0; i < table.rows.length; i++)
        {
            var row = table.rows[i];
            if (row.id)
            {
                var s1 = document.getElementById(row.id + "ChampsSel1");
                var s2 = document.getElementById(row.id + "ChampsSel2");
                var s3 = document.getElementById(row.id + "ChampsSel3");
                var s4 = document.getElementById(row.id + "ChampsSel4");

                var slots = [];
                for (j =1; j <= 5; j++)
                {
                    var ch = document.getElementById(row.id + "ChampsSlot" + j);
                    slots.push(ch.checked);
                }
                    
                var c = new ChampCondition(s1.value, s2.value, s3.value, s4.value, slots );
                conditions.push(c);
            }
        }
        var rule1 = new ChampRule(cType, faction, conditions, false);
        t.addRule(rule1);
    },

    removeRow : function(row)
    {
        var table = document.getElementById('tcoChampConditionTable');

        for (i=0; i < table.rows.length  ; i++ )
        {
            if (table.rows[i] == row)
            {
                table.deleteRow(i);
                break;
            }
        }
    },

    // add a new rule
    addRule : function(rule) {
        tcoChampSalvageData.ruleSet.unshift(rule);
        SAVEtcoChampSalvageData();
    },


    start : function() {
        var t = Tabs.champSalvager;
        if(tcoChampSalvageData.active) t.sTimer = setInterval(t.doSalvage, 1*60*1000);
    },

        // do the actual discard of champion items
    doSalvage : function() {
        var t = Tabs.champSalvager;

        if(!tcoChampSalvageData.active) {
            t.deleting = false;
            return;
        }

        if (t.deleting == true) return;

        t.deleting = true;
        t.setStatus('Salvaging items');        

        t.delItems = t.buildList(false);
            
          
        if (t.delItems.length > 0) {
            // upgrade items from +0 to +1 first
            t.upgradeAndDelete();
        } else {
            // give enough time for the last delete to finish
            setTimeout( function () { 
                t.deleting = false;
                t.setStatus('No items to salvage.  Waiting for next cycle.');
            }, 3000);
        }
    },

    // Create the list of items to delete.
    // If 'test' is set to true, then broken/equipted items are included.
    buildList : function(test){
        var t = Tabs.champSalvager;

        var champSaveNum = tcoChampSalvageData.champSaveNum;
        var countItem = 0;
        var retList = [];

        for (k in uW.kocChampionItems) {
            var champ_item = uW.kocChampionItems[k];
            countItem++;
            if (champ_item.level !=0) continue; // ignore these things
            // in test mode, include these items
            // These items are at risk if they are repaired or unequiped.
            if (test != true) 
                if (champ_item.equippedTo) continue;
            // keep the first X items
            if ( countItem <= champSaveNum) continue;
            // keep things w/ at least minQuality
            if (champ_item.rarity >= tcoChampSalvageData.minQuality) continue;
            // check the rules
            if (t.applyRules(champ_item.equipmentId)) continue;

            // passes all tests
            retList.push(champ_item.equipmentId);
        }
        return retList;
    },

    // put out a status message on the chSavlStatus div
    setStatus : function(msg) { document.getElementById('tcoChampSalvageStatus').innerHTML = msg; },

    // returns true if the item should be saved and not salvaged
    applyRules : function(id) {
        var t = Tabs.champSalvager;
        for (r in tcoChampSalvageData.ruleSet) {
            var rule = tcoChampSalvageData.ruleSet[r];
            if ( rule.ChampApplyRule(id)) return true;
        }
        return false;
    },

    upgradeAndDelete : function () {  // update items to +1 before deleting
        var t = Tabs.champSalvager;
        if(!tcoChampSalvageData.active || t.delItems.length == 0) {
            t.deleting = false;
            return;
        }
        var id = +t.delItems[0];
        t.delTimer = setTimeout( function () {t.doDelete(id)}, 4000);  // delete the item
    },

    removeItem : function (id, cityId, numStones) {
        var item = uW.kocChampionItems[id];
        if (!item) return;
        var c = +(Seed.resources["city" + cityId]["rec5"][0]);
        delete uW.kocChampionItems[id];
    },

    doDelete : function(id) {

        var t = Tabs.champSalvager;
        if(!tcoChampSalvageData.active || !t.deleting) {
            t.deleting = false;
            return;
        }

        var item = uW.kocChampionItems[id];
        if (item) t.setStatus('Salvaging ' + item.name);

        SalvageChampItem(id);
    },

}

Tabs.champRepair = {
	tabOrder: 100,
	tabLabel: 'REPAIR',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL REPAIR',
    repairId: 0,
    repairEnd: 0,
    timerH: null,
    clearTimerH: null,
	
	init: function (div) {
		var t = Tabs.champRepair;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '<div class=tcoSaveSettings id=tcoChampRepairSaveSettings title="Save Repair Settings"></div><div class=tcoLoadSettings id=tcoChampRepairLoadSettings title="Load Repair Settings"></div></div>';

        
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
		m += '<div>';

        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        if (tcoChampRepairData.active) {
            m += '<td width=50%><input id=tcoChampRepairPower type=button class=tcoButton value="Repair = ON"></td>';
        } else {
            m += '<td width=50%><input id=tcoChampRepairPower type=button class=tcoButton value="Repair = OFF"></td>';
        }        
        m += '<td width=50%><div class=divNoWrap align=center id=tcoChampRepairAetherDisplay></div></td>';
        m += '</tr>';
        m += '<tr><td colspan=2><hr class=tcoHRCenter></td></tr>';
        m += '<tr><td colspan=2><div class=indent5 id=tcoChampRepairStatus><br></div></td></tr>';
        m += '<tr><td colspan=2><div class=indent5 id=tcoChampRepairLastResult><br></div></td></tr>';
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;SPEED UPS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoChampRepairHourglassLevelSpecific ' + (tcoChampRepairData.hourglassLevelSpecific ? "CHECKED" : "") + '>Only use hourglass for levels ';
        m += '<select class=tcoSelect  id=tcoChampRepairHourglassLevel>';
        for (lvl = 1; lvl < tcoMaxChampLevel; lvl++) m += '<option value="' + lvl + '" ' + (tcoChampRepairData.hourglassLevel == lvl ? 'SELECTED' : '') + '>+' + lvl + '</option>';
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoChampRepairHourglassQualitySpecific ' + (tcoChampRepairData.hourglassQualitySpecific ? "CHECKED" : "") + '>Only use hourglass for qualities ';
        m += '<select class=tcoSelect id=tcoChampRepairHourglassQuality>';
        for (qual = 1; qual <= tcoMaxChampQuality-1; qual++) m += '<option value="' + qual + '" ' + (tcoChampRepairData.hourglassQuality == qual ? 'SELECTED' : '') + '>' + champCardQualities[qual].capitalizeFirstLetter() + '</option>';
        m += '</select> and higher</td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[1] + '"><input class=tcoCheckbox type=checkbox id=tcoChampRepairUseSH ' + (tcoChampRepairData.useSH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[1] + ' (<div class=divNoWrap id=tcoChampRepairUseSHLabel><font' + (uW.ksoItems[1].count < 100 ? ' color=red>' : '>') + uW.ksoItems[1].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[2] + '"><input class=tcoCheckbox type=checkbox id=tcoChampRepairUseKH ' + (tcoChampRepairData.useKH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[2] + ' (<div class=divNoWrap id=tcoChampRepairUseKHLabel><font' + (uW.ksoItems[2].count < 100 ? ' color=red>' : '>') + uW.ksoItems[2].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[3] + '"><input class=tcoCheckbox type=checkbox id=tcoChampRepairUseGH ' + (tcoChampRepairData.useGH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[3] + ' (<div class=divNoWrap id=tcoChampRepairUseGHLabel><font' + (uW.ksoItems[3].count < 100 ? ' color=red>' : '>') + uW.ksoItems[3].count + '</font></div>)</div></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[4] + '"><input class=tcoCheckbox type=checkbox id=tcoChampRepairUseMH ' + (tcoChampRepairData.useMH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[4] + ' (<div class=divNoWrap id=tcoChampRepairUseMHLabel><font' + (uW.ksoItems[4].count < 100 ? ' color=red>' : '>') + uW.ksoItems[4].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[5] + '"><input class=tcoCheckbox type=checkbox id=tcoChampRepairUseAH ' + (tcoChampRepairData.useAH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[5] + ' (<div class=divNoWrap id=tcoChampRepairUseAHLabel><font' + (uW.ksoItems[5].count < 100 ? ' color=red>' : '>') + uW.ksoItems[5].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[6] + '"><input class=tcoCheckbox type=checkbox id=tcoChampRepairUseWH ' + (tcoChampRepairData.useWH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[6] + ' (<div class=divNoWrap id=tcoChampRepairUseWHLabel><font' + (uW.ksoItems[6].count < 100 ? ' color=red>' : '>') + uW.ksoItems[6].count + '</font></div>)</div></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td title="' + tcoHourGlassTDLabel[7] + '"><input class=tcoCheckbox type=checkbox id=tcoChampRepairUseDH ' + (tcoChampRepairData.useDH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[7] + ' (<div class=divNoWrap id=tcoChampRepairUseDHLabel><font' + (uW.ksoItems[7].count < 100 ? ' color=red>' : '>') + uW.ksoItems[7].count + '</font></div>)</div></td>';
        m += '<td title="' + tcoHourGlassTDLabel[8] + '"><input class=tcoCheckbox type=checkbox id=tcoChampRepairUseEH ' + (tcoChampRepairData.useEH ? 'CHECKED' : '') + '><div class=divNoWrap>' + tcoHourGlassName[8] + ' (<div class=divNoWrap id=tcoChampRepairUseEHLabel><font' + (uW.ksoItems[8].count < 100 ? ' color=red>' : '>') + uW.ksoItems[8].count + '</font></div>)</div></td>';
        m += '<td/>';
        m += '</tr>';
        m += '<tr>';
        m += '<td colspan=3><input class=tcoCheckbox type=checkbox id=tcoChampRepairOverrideSpeedUps ' + (tcoChampRepairData.overrideSpeedUp ? "CHECKED" : "") + '>Override hourglasses by using ';
        m += '<select class=tcoSelect  id=tcoChampRepairSpeedUp>';
        m += '<option value=0>None</option>';
        for (gls in tcoHourGlassName) {
            m += '<option value=' + gls + ' ' + (tcoChampRepairData.useSpeedUp == gls ? 'SELECTED' : '') + '>' + tcoHourGlassName[gls] + '</option>';
        }
        m += '</select> every time</td>';
        m += '</tr>';
        m += '</table>';
        m += '</div>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;REPAIR ITEMS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';

        m += '<tr><td>Queue By Level: <select class=tcoSelect id=tcoChampRepairByLevel>';
        for (i = 1; i < tcoMaxChampLevel; i++) m += '<option value=' + i + '>+' + i + '</option>';
        m += '</select>&nbsp;<input id=tcoChampRepairByLevelAdd class=tcoButton type=button value="Add"/></td></tr>';


        m += '<tr><td>Queue By Preset Tag: <select class=tcoSelect id=tcoChampRepairPresetTagList>';
        var presetsList = "";
        if (tcoMaxChampions != 0)  {
            for (var i = 1; i < tcoMaxChampions + 1; i++) {
                presetsList += '<option value="' + i + '">' + i + ' (' + tcoChampPresetData.presetNames[i-1] + ')</option>';
            }
        }
        m += presetsList;
        m += "</select>&nbsp;<input id=tcoChampRepairPresetTag class=tcoButton type=button value='Add'/></td></tr>";

        m += '<tr><td><div style="max-width:90%;">Item: <select class=tcoSelect style="white-space:nowrap;display:inline-block;max-width: 200px;" id=tcoChampRepairList>';
        m += '</select><input id=tcoChampRepairAdd type=button class=tcoButton value="Add"/>&nbsp;<input id=tcoChampRepairAddAll class=tcoButton type=button value="Add All">&nbsp;<input id=tcoChampRepairRefresh class=tcoButton type=button value="Refresh List"></div></td></tr>';

        m += '</table>';
        m += '</div>';

        
        m += '<div class=tcoHeader>&nbsp;REPAIR LIST&nbsp;</div>';
        
        m += '<div>';
        m += '<table class=tcoSectionTable>';

        m += '<tr><td colspan=2>';
        m += '<div id=tcoChampRepairQScroll style="position: static; width: 100%; height: 350px; overflow-x: auto; overflow-y: auto;">';
        m += '<div id=tcoChampRepairQDiv></div>';
        m += '</div>';
        m += '</td></tr>';

        m += '<tr align=center><td><div><input style="float: left;" id=tcoChampRepairClear class=tcoButton type=button value="Clear Queue"/></div></td><td><div><input style="float: right;" id=tcoChampRepairClearF class=tcoButton type=button value="Clear Repaired"/></div></td></tr>';

        m += '</table>';
        m += '</div>';
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoChampRepairSaveSettings').addEventListener('click', function () {
            SaveSettingsToFile(tcoChampRepairData);
        }, false);
        document.getElementById('tcoChampRepairLoadSettings').addEventListener('click', function () {
            var loader = document.getElementById('tcoSettingsFile');
            loader.addEventListener('change', function () {
                LoadSettingsFromFile(tcoChampRepairData, Tabs.champRepair);
            }, false);
            loader.click();
        }, false);

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        t.refreshAetherDisplay();
        
        document.getElementById('tcoChampRepairUseWH').addEventListener('change', function () {
            tcoChampRepairData.useWH = document.getElementById('tcoChampRepairUseWH').checked;
            SAVEtcoChampRepairData();
            if (tcoChampRepairData.useWH) t.doAction();
        }, false);

        document.getElementById('tcoChampRepairUseDH').addEventListener('change', function () {
            tcoChampRepairData.useDH = document.getElementById('tcoChampRepairUseDH').checked;
            SAVEtcoChampRepairData();
            if (tcoChampRepairUseDH.useDH) t.doAction();
        }, false);

        document.getElementById('tcoChampRepairUseEH').addEventListener('change', function () {
            tcoChampRepairData.useEH = document.getElementById('tcoChampRepairUseEH').checked;
            SAVEtcoChampRepairData();
            if (tcoChampRepairData.useEH) t.doAction();
        }, false);

        document.getElementById('tcoChampRepairUseSH').addEventListener('change', function () {
            tcoChampRepairData.useSH = document.getElementById('tcoChampRepairUseSH').checked;
            SAVEtcoChampRepairData();
            if (tcoChampRepairData.useSH) t.doAction();
        }, false);

        document.getElementById('tcoChampRepairUseKH').addEventListener('change', function () {
            tcoChampRepairData.useKH = document.getElementById('tcoChampRepairUseKH').checked;
            SAVEtcoChampRepairData();
            if (tcoChampRepairData.useKH) t.doAction();
        }, false);

        document.getElementById('tcoChampRepairUseGH').addEventListener('change', function () {
            tcoChampRepairData.useGH = document.getElementById('tcoChampRepairUseGH').checked;
            SAVEtcoChampRepairData();
            if (tcoChampRepairData.useGH) t.doAction();
        }, false);

        document.getElementById('tcoChampRepairUseMH').addEventListener('change', function () {
            tcoChampRepairData.useMH = document.getElementById('tcoChampRepairUseMH').checked;
            SAVEtcoChampRepairData();
            if (tcoChampRepairData.useMH) t.doAction();
        }, false);

        document.getElementById('tcoChampRepairUseAH').addEventListener('change', function () {
            tcoChampRepairData.useAH = document.getElementById('tcoChampRepairUseAH').checked;
            SAVEtcoChampRepairData();
            if (tcoChampRepairData.useAH) t.doAction();
        }, false);

        document.getElementById('tcoChampRepairHourglassLevelSpecific').addEventListener('change', function () {
            tcoChampRepairData.hourglassLevelSpecific = document.getElementById('tcoChampRepairHourglassLevelSpecific').checked;
            SAVEtcoChampRepairData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampRepairHourglassQualitySpecific').addEventListener('change', function () {
            tcoChampRepairData.hourglassQualitySpecific = document.getElementById('tcoChampRepairHourglassQualitySpecific').checked;
            SAVEtcoChampRepairData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampRepairOverrideSpeedUps').addEventListener('change', function () {
            tcoChampRepairData.overrideSpeedUp = document.getElementById('tcoChampRepairOverrideSpeedUps').checked;
            SAVEtcoChampRepairData();
            if (tcoChampRepairData.overrideSpeedUp) t.doAction();
        }, false);

        document.getElementById('tcoChampRepairSpeedUp').addEventListener('change', function () {
            tcoChampRepairData.useSpeedUp = document.getElementById('tcoChampRepairSpeedUp').value;
            SAVEtcoChampRepairData();
        }, false);

        document.getElementById('tcoChampRepairHourglassLevel').addEventListener('change', function () {
            tcoChampRepairData.hourglassLevel = document.getElementById('tcoChampRepairHourglassLevel').value;
            SAVEtcoChampRepairData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampRepairHourglassQuality').addEventListener('change', function () {
            tcoChampRepairData.hourglassQuality = document.getElementById('tcoChampRepairHourglassQuality').value;
            SAVEtcoChampRepairData();
            t.doAction();
        }, false);

        document.getElementById('tcoChampRepairPower').addEventListener('click', function () {
            t.togglePower(this);
        }, false);

        document.getElementById('tcoChampRepairByLevelAdd').addEventListener('click', function () {
            var t = Tabs.champRepair;
            var level = document.getElementById('tcoChampRepairByLevel').value;
            for (chId in uW.kocChampionItems) {
                var champItem = uW.kocChampionItems[chId];
                if (champItem == null || !champItem) continue;
                if (!(champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE)) continue;
                if (champItem.level != level) continue;
                t.addQueue(chId);
            }
        }, false);

        document.getElementById('tcoChampRepairPresetTag').addEventListener('click', function () {
            var t = Tabs.champRepair;
            var presetTagNum = document.getElementById('tcoChampRepairPresetTagList').value;
            var presetTag = getChampPresetObject(parseInt(presetTagNum));
            for (var ptId in presetTag) {
                var champItem = uW.kocChampionItems[ptId];
                if (champItem == null || !champItem) continue;
                if (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE) t.addQueue(ptId);
            }
        }, false);

        document.getElementById('tcoChampRepairClear').addEventListener('click', function () {
            t.deleteQueue();
        }, false);

        document.getElementById('tcoChampRepairClearF').addEventListener('click', function () {
            var temp = [];
            while (tcoChampRepairData.items.length > 0) {
                var chId = tcoChampRepairData.items.pop();
                var champItem = uW.kocChampionItems[chId];
                if (champItem == null || !champItem) continue;
                if (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE) temp.push(chId);
            }
            while (temp.length > 0) tcoChampRepairData.items.push(temp.pop());
            tcoChampRepairData.index = 0
            SAVEtcoChampRepairData();
            t.populateChampRepairListBox();
            t.buildChampRepairDisplay();
        }, false);

        document.getElementById('tcoChampRepairAdd').addEventListener('click', function () { 
            t.addQueue();
        }, false);

        document.getElementById('tcoChampRepairAddAll').addEventListener('click', function () {
            t.addAllQueue();
        }, false);

        document.getElementById('tcoChampRepairRefresh').addEventListener('click', function () {
            t.populateChampRepairListBox();
        }, false); 
        
        if (tcoChampRepairData.active)
            t.setStatus('Loading...');
        else 
            t.setStatus('Powered Off');

        var d = 2 + Math.random() * 8;

        if (Seed.queue_champion == null) {
            for (chId in uW.kocChampionItems) {
                var champItem = uW.kocChampionItems[chId];
                if (champItem.status == CM.CHAMPION.STATUS_REPAIRING_ENHANCE || champItem.status == CM.CHAMPION.STATUS_REPAIRING_UPGRADE) {
                    Seed.queue_champion = {};
                    Seed.queue_champion.start = parseInt(champItem.start);
                    Seed.queue_champion.end = parseInt(champItem.eta);
                    Seed.queue_champion.itemId = champItem.equipmentId;
                    break;
                }
            }
        }

        if (Seed.queue_champion != null && Seed.queue_champion.end != null) {
            var repairTimeLeft = Seed.queue_champion.end - unixTime();
            t.repairEnd = Seed.queue_champion.end;
            t.repairId = Seed.queue_champion.itemId;
            var n = new Date(t.repairEnd * 1000);
            
            t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + uW.kocChampionItems[t.repairId].name);

            if (tcoChampRepairData.useAH || tcoChampRepairData.useGH || tcoChampRepairData.useKH || tcoChampRepairData.useMH || tcoChampRepairData.useSH || tcoChampRepairData.useWH || tcoChampRepairData.useDH || tcoChampRepairData.useEH || (tcoChampRepairData.overrideSpeedUp && tcoChampRepairData.useSpeedUp > 0)) {
                var champItem = uW.kocChampionItems[t.repairId];
                var chQuality = champItem.rarity;
                var chLevel = champItem.level;
                var useThoseSpeedups = true;
                if (tcoChampRepairData.hourglassQualitySpecific && chQuality < tcoChampRepairData.hourglassQuality) useThoseSpeedups = false;
                if (tcoChampRepairData.hourglassLevelSpecific && chLevel < tcoChampRepairData.hourglassLevel) useThoseSpeedups = false;
                if (tcoChampRepairData.overrideSpeedUp) useThoseSpeedups = true;
                if (useThoseSpeedups) {
                    t.doingSpeedup = true;
                    setTimeout(function () { t.doSpeedup(); }, 2000);
                }
            }

            setTimeout(t.clearRepair, (repairTimeLeft + 1) * 5000);
            if (repairTimeLeft > 0) d += repairTimeLeft;
        }

        t.populateChampRepairListBox();
        t.buildChampRepairDisplay();


        if (t.timerH == null) t.timerH = setTimeout(t.doAction, d * 1000);
                	
    },
	
	hide: function () {},

    refreshAetherDisplay : function () {
        document.getElementById('tcoChampRepairAetherDisplay').innerHTML = displayCityAstone();
    },        
	
	show: function () {
		var t = Tabs.champRepair;
        t.refreshAetherDisplay();
        t.populateChampRepairListBox();
        t.buildChampRepairDisplay();
	},

    deleteQueue: function () {
        var t = Tabs.champRepair
        tcoChampRepairData.items = [];
        SAVEtcoChampRepairData();
        t.populateChampRepairListBox();
        t.buildChampRepairDisplay();
    },

    doSpeedup: function () {
        var t = Tabs.champRepair;

        var endTime = t.repairEnd;
        var startTime = unixTime();
        var secondsForRepair = endTime - startTime;
        var divId = "";

        t.speedup = 0;

        if (secondsForRepair > 0 && tcoChampRepairData.overrideSpeedUp && tcoChampRepairData.useSpeedUp > 0) {
            t.speedup = tcoChampRepairData.useSpeedUp;
        } else {
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.day25 && tcoChampRepairData.useAH && uW.ksoItems[8].count > 0) { t.speedup = 8; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour24 && tcoChampRepairData.useAH && uW.ksoItems[7].count > 0) { t.speedup = 7; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour15 && tcoChampRepairData.useAH && uW.ksoItems[6].count > 0) { t.speedup = 6; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour8 && tcoChampRepairData.useAH && uW.ksoItems[5].count > 0) { t.speedup = 5; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour25 && tcoChampRepairData.useMH && uW.ksoItems[4].count > 0) { t.speedup = 4; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.hour1 && tcoChampRepairData.useGH && uW.ksoItems[3].count > 0) { t.speedup = 3; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.minute15 && tcoChampRepairData.useKH && uW.ksoItems[2].count > 0) { t.speedup = 2; }
            if (t.speedup == 0 && secondsForRepair >= HOURGLASSES_TIME_MIN_THRESHOLD.minute1 && tcoChampRepairData.useSH && uW.ksoItems[1].count > 0) { t.speedup = 1; }
        }

        switch (t.speedup) {
            case "1":
            case 1:
                secondsForRepair -= HOURGLASSES_TIME.minute1;
                divId = 'tcoChampRepairUseSHLabel';
                break;
            case "2":
            case 2:
                secondsForRepair -= HOURGLASSES_TIME.minute15;
                divId = 'tcoChampRepairUseKHLabel';
                break;
            case "3":
            case 3:
                secondsForRepair -= HOURGLASSES_TIME.hour1;
                divId = 'tcoChampRepairUseGHLabel';
                break;
            case "4":
            case 4:
                secondsForRepair -= HOURGLASSES_TIME.hour25;
                divId = 'tcoChampRepairUseMHLabel';
                break;
            case "5":
            case 5:
                secondsForRepair -= HOURGLASSES_TIME.hour8;
                divId = 'tcoChampRepairUseAHLabel';
                break;
            case "6":
            case 6:
                secondsForRepair -= HOURGLASSES_TIME.hour15;
                divId = 'tcoChampRepairUseWHLabel';
                break;
            case "7":
            case 7:
                secondsForRepair -= HOURGLASSES_TIME.hour24;
                divId = 'tcoChampRepairUseDHLabel';
                break;
            case "8":
            case 8:
                secondsForRepair -= HOURGLASSES_TIME.day25;
                divId = 'tcoChampRepairUseEHLabel';
                break;
        }

        if (t.speedup != 0) {
            t.setResult('Used ' + uW.ksoItems[t.speedup].name);
            var divCount = uW.ksoItems[t.speedup].count - 1;
            var divSpeedups = document.getElementById(divId);
            divSpeedups.innerHTML = divCount;
            uW.modal_speedup_apply("champion", t.speedup, t.repairId);

            if (secondsForRepair <= 0) {
                secondsForRepair = 0;
                endTime = startTime;
                t.clearTimerH = setTimeout(t.clearRepair, 1000);
            } else {
                endTime = unixTime() + secondsForRepair;
                t.repairEnd = endTime;
                var n = new Date(t.repairEnd * 1000);
                var champItem = uW.kocChampionItems[t.repairId];
                if (champItem) {
                    t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString() + ". Item: " + champItem.name);
                    t.clearTimerH = setTimeout(t.clearRepair, secondsForRepair * 1000);
                }
            }
            t.buildChampRepairDisplay();
            t.repairEnd = endTime;
            setTimeout(function () { t.doSpeedup(); }, 1000);
        }
    },

    selectNext: function () {

        var l = tcoChampRepairData.items.length;
        for (i = 0; i < l; i++) {

            var champItem = uW.kocChampionItems[tcoChampRepairData.items[i]];
            if (champItem == null || !champItem) continue;
            if ((champItem != null) && (champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE || champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE)) {
                tcoChampRepairData.index = i;
                SAVEtcoChampRepairData();
                return;
            }
        }

        // if we get here, the queue is complete
        tcoChampRepairData.index = -1;

        SAVEtcoChampRepairData();
    },

    doAction: function () {
        var t = Tabs.champRepair;
        t.populateChampRepairListBox();

        if (tcoChampUpgradeData.active) {
            t.setStatus('Waiting for upgrade tab to finish...');
            if (tcoChampRepairData.active) t.togglePower();
            return;
        }

        if (!tcoChampRepairData.active) {
            t.setStatus("Powered Off");
            return;
        } else {
            var retryTime = tcoGeneralOptions.retryInterval;

            try {  // check if repair is done
                var ti = t.clearRepair();
                if (ti <= 0) {  // repair is done

                    t.selectNext();

                    if (tcoChampRepairData.index < 0) {
                        t.setStatus("Reached end of queue.")
                        t.setResult("");
                        SAVEtcoChampRepairData();
                    } else {
                        var champItem = uW.kocChampionItems[tcoChampRepairData.items[tcoChampRepairData.index]];
                        if (champItem) {
                            t.repairId = champItem.equipmentId;
                            t.doRepair(champItem.equipmentId);
                        }
                    }

                } else {  // come back after repair is complete
                    retryTime = ti + 5;
                    var n = new Date(t.repairEnd * 1000);
                    t.setStatus("Waiting until " + n.toLocaleTimeString() + " for repair to complete.  Item: " + uW.kocChampionItems[t.repairId].name);
                    if (tcoChampRepairData.useSH || tcoChampRepairData.useKH || tcoChampRepairData.useGH || tcoChampRepairData.useMH || tcoChampRepairData.useAH || tcoChampRepairData.useWH || tcoChampRepairData.useDH || tcoChampRepairData.useEH || (tcoChampRepairData.overrideSpeedUp && tcoChampRepairData.useSpeedUp > 0)) {
                        var champItem = uW.kocChampionItems[t.repairId];
                        var tcoChampQuality = champItem.rarity;
                        var tcoChampLevel = champItem.level;
                        var useThoseSpeedups = true;
                        if (tcoChampRepairData.hourglassQualitySpecific && tcoChampQuality < tcoChampRepairData.hourglassQuality) useThoseSpeedups = false;
                        if (tcoChampRepairData.hourglassLevelSpecific && tcoChampLevel < tcoChampRepairData.hourglassLevel) useThoseSpeedups = false;
                        if (tcoChampRepairData.overrideSpeedUp) useThoseSpeedups = true;
                        if (useThoseSpeedups) {
                            t.doingSpeedup = true;
                            setTimeout(function () { t.doSpeedup(); }, 2000);
                        }
                        retryTime = 1;
                    }
                }
            } catch (e) {
            }
            // recycle
            clearTimeout(t.timerH);
            t.timerH = setTimeout(t.doAction, retryTime * 1000);
            t.buildChampRepairDisplay();
        }
    },

    addQueue: function (Id) {
        var t = Tabs.champRepair;

        if (Id == null) {
            var chId = document.getElementById('tcoChampRepairList').value;
        } else {
            var chId = Id;
        }

        if (chId == 0) return;

        var item_count = tcoChampRepairData.items.length;

        if (item_count > 0) {
            for (var item_index = 0; item_index < item_count; item_index++) {
                if (chId == tcoChampRepairData.items[item_index]) return;
            }
        }

        tcoChampRepairData.items.push(chId);
        SAVEtcoChampRepairData();
        t.populateChampRepairListBox();
        t.buildChampRepairDisplay();
    },

    addAllQueue: function () {
        var t = Tabs.champRepair;

        for (chId in uW.kocChampionItems) {
            var champItem = uW.kocChampionItems[chId];
            if (champItem == null || !champItem) continue;
            if (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE) {
                t.addQueue(chId);
            }
        }

    },

    populateChampRepairListBox: function () {
        var repairList = document.getElementById('tcoChampRepairList');
        var m = '<option value=0>--Items--</option>';

        var item_count = tcoChampRepairData.items.length;

        for (chId in uW.kocChampionItems) {
            var champItem = uW.kocChampionItems[chId];
            if (champItem == null || !champItem) continue;
            if (champItem.status != CM.CHAMPION.STATUS_BROKEN_ENHANCE && champItem.status != CM.CHAMPION.STATUS_BROKEN_UPGRADE) continue; //item not broken, move on

            var foundIt = false;
            for (var item_index = 0; item_index < item_count; item_index++) {
                if (chId == tcoChampRepairData.items[item_index]) {
                    foundIt = true;
                    break;
                }
            }
            if (!foundIt) {
                var optionText = champItem.name;
                m += '<option value="' + chId + '">' + optionText + '</option>';
            }
        }
        repairList.innerHTML = m;
    },

    deleteRepairItem: function (index) {  // delete an item from the queue
        var t = Tabs.champRepair;
        tcoChampRepairData.items.splice(index, 1);
        SAVEtcoChampRepairData();
        t.populateChampRepairListBox();
        t.buildChampRepairDisplay();
    },

    moveRepairUpRow: function (index) {
        if (index < 1) return;
        var t = Tabs.champRepair;
        var q = tcoChampRepairData.items.splice(index, 1);
        tcoChampRepairData.items.splice(index - 1, 0, q);

        if (index == tcoChampRepairData.index)
            tcoChampRepairData.index--;
        else if (tcoChampRepairData.index == index - 1)
            tcoChampRepairData.index++;

        SAVEtcoChampRepairData();
        t.buildChampRepairDisplay();
    },

    moveRepairDownRow: function (index) {
        if (index > (tcoChampRepairData.items.length - 2)) return;

        var t = Tabs.champRepair;
        var q = tcoChampRepairData.items.splice(index, 1);
        tcoChampRepairData.items.splice(index + 1, 0, q);

        if (i == tcoChampRepairData.index)
            tcoChampRepairData.index++;
        else if (tcoChampRepairData.index == i + 1)
            tcoChampRepairData.index--;

        SAVEtcoChampRepairData();
        t.buildChampRepairDisplay();

    },

    setStatus: function (s) { document.getElementById('tcoChampRepairStatus').innerHTML = "<div>" + s + "</div>"; },

    setResult: function (s) { document.getElementById('tcoChampRepairLastResult').innerHTML = "<div>" + s + "</div>"; },

    togglePower: function (obj) {
        var t = Tabs.champRepair;

        var tcoChampRepairPower = document.getElementById('tcoChampRepairPower');

        if (tcoChampRepairData.active) {
            tcoChampRepairData.active = false;
            tcoChampRepairPower.value = "Repair = OFF";
            t.setStatus("Powered Off");
            t.setResult("");
        } else {
            tcoChampRepairData.active = true;
            tcoChampRepairPower.value = "Repair = ON";
            t.setStatus("Power On");
            t.setResult("");
            tcoChampUpgradeData.active = false; 
            SAVEtcoChampUpgradeData();
            t.doAction();
        }
        if (!tcoChampRepairData.active) {

        }
        SAVEtcoChampRepairData();
    },

    clearRepair: function () {
        var t = Tabs.champRepair;
        var timeUntilDone = 0;

        if (t.repairEnd == 0) {
            return timeUntilDone;
        }
        timeUntilDone = t.repairEnd - unixTime();

        if (timeUntilDone <= 0) {
            if (t.repairId != 0 && uW.kocChampionItems[t.repairId] != null) {
                if (uW.kocChampionItems[t.repairId].status != CM.CHAMPION.STATUS_INACTIVE
                               || uW.kocChampionItems[t.repairId].status != CM.CHAMPION.STATUS_ACTIVE) {
                    t.setStatus("Repair time complete.");
                    document.getElementById('tcoChampRepairState' + t.repairId).className = 'tcoSuccess';
                } else {
                }
                t.repairId = 0;
            }

        }
        return timeUntilDone;
    },

    doRepair: function (rItemId) {
        var t = Tabs.champRepair;
        var params = uW.Object.clone(ajfx);

        if (tcoChampRepairData.active == false || rItemId == 0 || uW.kocChampionItems[rItemId] == null) return;

        var theItem = uW.kocChampionItems[rItemId];

        params.action = "6";
        params.eid = rItemId;
        params.cityId = uW.currentcityid;
        params.gems = 0;

        new AjaxRequest(uW.g_ajaxpath + "ajax/ceEquipmentManagerAjax.php" + uW.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            loading: true,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    var item = uW.kocChampionItems[rslt.equipmentId];
                    ActionLog('Starting repair for Champion item ' + item.name);
                    if (!Seed.queue_champion) Seed.queue_champion = {};
                    Seed.queue_champion.itemId = rslt.equipmentId;
                    Seed.queue_champion.start = parseInt(rslt.start);
                    Seed.queue_champion.end = parseInt(rslt.eta);
                    t.repairId = parseInt(rslt.equipmentId);
                    t.repairEnd = rslt.eta;
                    var n = new Date(t.repairEnd * 1000);
                    t.setStatus("Repair begun ... Repair will be complete at " + n.toLocaleTimeString() + ". Item: " + item.name);
                    var x = rslt.eta - unixTime();
                    t.clearTimerH = setTimeout(t.clearRepair, (x + 1) * 1000);
                    if (item.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE)
                        item.status = CM.CHAMPION.STATUS_REPAIRING_ENHANCE;
                    else
                        item.status = CM.CHAMPION.STATUS_REPAIRING_UPGRADE;

                    t.buildChampRepairDisplay();
                }
                else {
                    // regrab the end times in case this is caused by a manual repair
                    if (Seed.queue_champion && Seed.queue_champion.end && Seed.queue_champion.itemId) {
                        t.repairEnd = Seed.queue_champion.end;
                        t.repairId = Seed.queue_champion.itemId;
                    }

                    if (feedback.index("There is one equipment in repairing queue") > 0) return; // item is still be repaired

                    if (rslt.feedback) {
                        t.setStatus(rslt.feedback);
                        uW.kocChampionItems[rItemId].status = CM.CHAMPION.STATUS_INACTIVE;
                        t.clearRepair();
                    }

                }
                return;
            },
            onFailure: function (ttt) {  // this usually means a repair is in progress (such as a manualrepair). Grab the seed data (if possible)
                if (Seed.queue_champion && Seed.queue_champion.end) {
                    t.repairEnd = Seed.queue_champion.end;
                    t.repairId = Seed.queue_champion.itemId;
                }
                return;
            }
        });
        return;
    },

    buildChampRepairDisplay: function () {
        var t = Tabs.champRepair;

        tcoChampRepairQDiv = document.getElementById('tcoChampRepairQDiv');
        
        var m = '<table id=tcoChampRepair width=100% class=trTabPad>';

        var item_count = tcoChampRepairData.items.length;

        //TODO
        //var totalRepairTime = t.calcRepairTime();
        //if (totalRepairTime > 0) $("#trRepair").append("<caption><b><i>Total Repair Time (" + item_count + " items): " + repairTimeToText(totalRepairTime) + "</i></b></caption>");

        m += '<tr><th width=10%>Remove</th><th width=5%>Reorder</th><th width=8%>Status</th><th width=25%>Item</th></tr>';

        if (item_count > 0) {
            for (var item_index = 0; item_index < item_count; item_index++) {
                var chId = tcoChampRepairData.items[item_index];

                if (chId == null) {
                    t.deleteRepairItem(item_index);
                    return;
                }
                var champItem = uW.kocChampionItems[chId];
                if (champItem == null || !champItem) {
                    t.deleteRepairItem(item_index);
                    return;
                }
                
                m += '<tr>';
                m += '<td align=center><div class=tcoRemove id=tcoChampRepairRemove' + chId + '></div></td>';
                m += '<td align=center><div class=tcoUpRow id=tcoChampRepairUpRow' + chId + '></div><div class=tcoDownRow  id=tcoChampRepairDownRow' + chId + '></div></td>';
                m += '<td align=center><div id=tcoChampRepairState' + chId + '></div></td>';
                m += '<td align=center><div id=tcoChampRepairItem' + chId + '>' + champItem.name + '</div></td>';
                m += '</tr>';
            }
            m += '</table>';

            tcoChampRepairQDiv.innerHTML = m;

            for (var item_index = 0; item_index < item_count; item_index++) {

                var chId = tcoChampRepairData.items[item_index];

                var champItem = uW.kocChampionItems[chId];

                if (champItem == null || !champItem) continue;

                document.getElementById('tcoChampRepairRemove' + chId).setAttribute('v1', item_index);
                document.getElementById('tcoChampRepairRemove' + chId).addEventListener('click', function () {
                    var qIndex = this.getAttribute('v1');
                    t.deleteRepairItem(qIndex);
                }, false);

                document.getElementById('tcoChampRepairUpRow' + chId).setAttribute('v1', item_index);
                document.getElementById('tcoChampRepairUpRow' + chId).addEventListener('click', function () {
                    var qIndex = this.getAttribute('v1');
                    t.moveRepairUpRow(qIndex);
                }, false);

                document.getElementById('tcoChampRepairDownRow' + chId).setAttribute('v1', item_index);
                document.getElementById('tcoChampRepairDownRow' + chId).addEventListener('click', function () {
                    var qIndex = this.getAttribute('v1');
                    t.moveRepairDownRow(qIndex);
                }, false);

                var champItem = uW.kocChampionItems[chId];

                if (!champItem || !(champItem.equipmentId)) {
                    document.getElementById('tcoChampRepairState' + chId).innerHTML = '<div style="text-align:center"> ??</div>';

                } else if (champItem.status == CM.CHAMPION.STATUS_ACTIVE) {
                    document.getElementById('tcoChampRepairState' + chId).className = 'tcoSuccess';

                } else if (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE) {
                    document.getElementById('tcoChampRepairState' + chId).className = 'tcoBroken';

                } else if (champItem.status == CM.CHAMPION.STATUS_REPAIRING_UPGRADE || champItem.status == CM.CHAMPION.STATUS_REPAIRING_ENHANCE) {
                    document.getElementById('tcoChampRepairState' + chId).className = 'tcoHammer';
                } else {
                    document.getElementById('tcoChampRepairState' + chId).innerHTML = '<div class=tcoGoButton></div>';
                }
            }
        } else {
            m += '</table>';
            tcoChampRepairQDiv.innerHTML = m;
        }
    },

}

Tabs.champOrganizer = {
	tabOrder: 100,
	tabLabel: 'ORGANIZER',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL ORGANIZER',
    champItemLists: [],
    sortEffect: "none",
    buffType: "both",
    panelId: -1,
    panelType: "upgrade",
    panelNextLevel: 2,
    switchingPresets: false,
    	
	init: function (div) {
		var t = Tabs.champOrganizer;
		t.mydiv = div;

        t.sortEffect = tcoChampUpgradeData.effectSelected;
        t.buffType = tcoChampUpgradeData.buffSelected;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td>';

        m += 'Sort: <select class=tcoSelect id=tcoChampSortEffects>';
        m += '<option value="none">--Effect--</option>';
        for (efx in champEffects) m += '<option value="' + champEffects[efx] + '">' + champEffects[efx] + '</option>';
        m += '</select>';
        m += '<select class=tcoSelect id=tcoChampBuffType>';
        m += '<option value="both">Either</option>';
        m += '<option value="buff">Buff</option>';
        m += '<option value="debuff">Debuff</option>';
        m += '</select>';

        m += '<input id=tcoChampSortInactive class=tcoCheckbox type=checkbox ' + (tcoChampUpgradeData.sortInactive ? ' CHECKED' : '') + '/> Include Inactive ';
        m += '<input id=tcoChampIgnoreBroken class=tcoCheckbox type=checkbox ' + (tcoChampUpgradeData.ignoreBroken ? ' CHECKED' : '') + '/> Ignore Broken';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>';

        m += '<div id=tcoChampOrganizerScroll style="position: static; width: ' + (dlgWidth -  (dlgWidthOffset + dlgWidthMenu)) + 'px; height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; overflow-x: hidden; overflow-y: auto;">';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;CARD FILTER&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable cellspacing=0 cellpadding=0>';

        m += '<tr><td colspan=3>';
        m += 'Filter By Effects: <select class=tcoSelect id=tcoChampFilterEffects>';
        m += '<option value="none">--Effect--</option>';
        for (efx in champEffects) m += '<option value="' + champEffects[efx] + '">' + champEffects[efx] + '</option>';
        m += '</select>';
        m += '<select class=tcoSelect id=tcoChampFilterBuffType>';
        m += '<option value="buff">Buff</option>';
        m += '<option value="debuff">Debuff</option>';
        m += '</select>';
        m += '</td></tr>';

        m += '<tr><td colspan=3><hr class=tcoHRCenter></td></tr>';

        m += '<tr><td>Faction</td><td>Quality</td><td>Level</td></tr>';

        m += '<tr>';

        m += '<td><div id=tcoChampFactionFilterRow style="float: left; width: 100px; border:2px solid #ccc; height: 105px; overflow-y: scroll; background-color: white;">';
        for (fact in tcoFactions) m += '<input id=tcoChampFaction' + tcoFactions[fact] + ' class=tcoCheckbox type=checkbox  CHECKED />' + tcoFactions[fact].capitalizeFirstLetter() + '<br />';

        m += '</div></td>';

        m += '<td><div id=tcoChampQualityFilterRow style="float: left; width: 120px; border:2px solid #ccc; height: 105px; overflow-y: scroll; background-color: white;">';
        for (var qual = 0; qual < champCardQualities.length; qual++) m += '<input id=tcoChampQuality' + qual + ' class=tcoCheckbox type=checkbox  CHECKED />' + champCardQualities[qual].capitalizeFirstLetter() + '<br />';
        m += '</div></td>';

        m += '<td><div id=tcoChampLevelFilterRow style="float: left; width: 120px; border:2px solid #ccc; height: 105px; overflow-y: scroll; background-color: white;">';
        for (lvl = 0; lvl <= tcoMaxChampLevel; lvl++) {
            m += '<input id=tcoChampLevel' + lvl + ' class=tcoCheckbox type=checkbox CHECKED />' + lvl + '<br /> ';
        }
        m += '</div></td>';

        m += '</tr>';

        m += '<tr>';
        m += '<td/>';
        m += '<td><input style="width:120px;" id=tcoChampUnselectAllQualities class=tcoButton type=button value="Unselect All"></td>';
        m += '<td><input style="width:120px;" id=tcoChampUnselectAllLevels class=tcoButton type=button value="Unselect All"></td>';
        m += '</tr>';
        m += '<tr>';
        m += '<td/>';
        m += '<td><input style="width:120px;" id=tcoChampSelectAllQualities class=tcoButton type=button value="Select All"></td>';
        m += '<td><input style="width:120px;" id=tcoChampSelectAllLevels class=tcoButton type=button value="Select All"></td>';
        m += '</tr>';

        m += '</table>';
        m += '</div>';

        for (champItemCardType in champItemNames) {
            m += '<div class=tcoChampOrganizer onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;' + champItemNames[champItemCardType].toUpperCase() + '&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
            m += '<div class=tcoChampOrganizerSection id=tcoChampCardSection' + champItemNames[champItemCardType] + '></div>';
        }

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        var champOrganizers = document.getElementsByClassName('tcoChampOrganizer');
        for (var champOrg=0; champOrg < champOrganizers.length; champOrg++) {
            champOrganizers[champOrg].addEventListener('click', function () {

                var imgs = this.childNodes;
                if (imgs[0].src == tcoDownArrow) {
                    imgs[0].src = tcoRightArrow
                    imgs[2].src = tcoRightArrow
                } else {
                    imgs[0].src = tcoDownArrow
                    imgs[2].src = tcoDownArrow
                }
                var section = this.nextSibling;
                if (section.className != 'tcoChampOrganizerSection') return;
   
                if (section.style.display == 'block')
                    section.style.display = 'none';
                else
                    section.style.display = 'block';

            }, false);
        }

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        document.getElementById('tcoChampSortEffects').value = tcoChampUpgradeData.effectSelected;
        document.getElementById('tcoChampBuffType').value = tcoChampUpgradeData.buffSelected;
        document.getElementById('tcoChampSortInactive').checked = tcoChampUpgradeData.sortInactive;
        document.getElementById('tcoChampIgnoreBroken').checked = tcoChampUpgradeData.ignoreBroken;

        document.getElementById('tcoChampFilterBuffType').addEventListener('change', function () {
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampFilterEffects').addEventListener('change', function () {
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampSortEffects').addEventListener('change', function () {
            t.sortEffect = this.value;
            tcoChampUpgradeData.effectSelected = t.sortEffect;
            SAVEtcoChampUpgradeData();
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampBuffType').addEventListener('change', function () {
            t.buffType = this.value;
            tcoChampUpgradeData.buffSelected = t.buffType;
            SAVEtcoChampUpgradeData();
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampSortInactive').addEventListener('click', function () {
            tcoChampUpgradeData.sortInactive = document.getElementById('tcoChampSortInactive').checked;
            SAVEtcoChampUpgradeData();
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampIgnoreBroken').addEventListener('click', function () {
            tcoChampUpgradeData.ignoreBroken = document.getElementById('tcoChampIgnoreBroken').checked;
            SAVEtcoChampUpgradeData();
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampUnselectAllQualities').addEventListener('click' , function () {
            for (var qual = 0; qual < champCardQualities.length; qual++) document.getElementById('tcoChampQuality' + qual).checked = false;
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampSelectAllQualities').addEventListener('click', function () {
            for (var qual = 0; qual < champCardQualities.length; qual++) document.getElementById('tcoChampQuality' + qual).checked = true;
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampQualityFilterRow').addEventListener('change', function () {
            t.createChampItemList();
            t.paintChampTables();
        }, false);


        document.getElementById('tcoChampUnselectAllLevels').addEventListener('click' , function () {
            for (lvl = 0; lvl <= tcoMaxChampLevel; lvl++) document.getElementById('tcoChampLevel' + lvl).checked = false;
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampSelectAllLevels').addEventListener('click', function () {
            for (lvl = 0; lvl <= tcoMaxChampLevel; lvl++) document.getElementById('tcoChampLevel' + lvl).checked = true;
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        document.getElementById('tcoChampLevelFilterRow').addEventListener('change', function () {
            t.createChampItemList();
            t.paintChampTables();
        }, false);


        document.getElementById('tcoChampFactionFilterRow').addEventListener('change', function () {
            t.createChampItemList();
            t.paintChampTables();
        }, false);

        t.createChampItemList();
        t.paintChampTables();
	},
	
	hide: function () {
    },

    createChampItemList: function () {
        var t = Tabs.champOrganizer;
        
        for (var champItemTypeValue in champItemNames) t.champItemLists[champItemTypeValue] = new Array;

        for (champId in uW.kocChampionItems) {
            var champItem = uW.kocChampionItems[champId];

            // apply filters
            var faction = tcoFactions[champItem.faction -1];
            var level = champItem.level;
            var champtype = champItem.type;
            var quality = champItem.rarity;
            var isBroken = champItem.status;
            
            if (tcoChampUpgradeData.ignoreBroken && (isBroken == CM.CHAMPION.STATUS_BROKEN_UPGRADE || isBroken == CM.CHAMPION.STATUS_BROKEN_ENHANCE)) continue;
            if (!document.getElementById('tcoChampQuality' + quality).checked) continue;
            if (!document.getElementById('tcoChampFaction' + faction).checked) continue;
            if (!document.getElementById('tcoChampLevel' + level).checked) continue;

            var filterEffect = document.getElementById('tcoChampFilterEffects').value;
            if (filterEffect != 'none') {
                var filterBuff = document.getElementById('tcoChampFilterBuffType').value;
                if (filterBuff == 'debuff') filterEffect += ' Debuff';
                var foundEffect = false;
                for (e in champItem.effects) {
                    var N = champItem.effects[e];
                    var effect = uW.g_js_strings.effects["name_" + N.id];
                    if (effect == filterEffect) {
                        foundEffect = true;
                        break;
                    }
                }
                if (!foundEffect) continue;
            }

            if (champItem.equippedTo > 0)
                t.champItemLists[champtype].unshift(champItem);
            else
                t.champItemLists[champtype].push(champItem);
        }
        t.sortChampOrganizerLists();
    },

    sortChampOrganizerLists: function () {
        var t = Tabs.champOrganizer;
        tcoChampUpgradeData.sortInactive = document.getElementById('tcoChampSortInactive').checked;
        for (idx in t.champItemLists) {
            t.champItemLists[idx].sort(function (item1, item2) {
                return t.sortChampOrganizerValue(item2) - t.sortChampOrganizerValue(item1);
            });
        }
    },

    sortChampOrganizerValue: function (item) {
        var t = Tabs.champOrganizer;
        var retValue = 0.0;
        for (e in item.effects) {
            try {
                var N = item.effects[e];
                var id = item.effects[e].id;
                var effect = "";
                var quality = item.rarity;

                effect = uW.g_js_strings.effects["name_" + id];

                var S = champTiers;
                var P = id + "," + N.tier;
                var tier = S[P];

                var base = tier.Base || 0;
                var growth = tier.Growth || 0;
                var level = item.level || 0;

                // slot number
                var B = +e;

                if (B > quality && !tcoChampUpgradeData.sortInactive) {
                    return +retValue;
                }

                var percent = +(base + ((level * level + level) * growth * 0.5));
                if ((effect == (t.sortEffect + " Debuff")) && (t.sortType != "buff")) {
                    retValue -= percent;
                }
                else if (effect == t.sortEffect && t.sortType != "debuff") {
                    retValue += percent;
                }
            } catch (e) {
            }

        }
        return +retValue;
    },

    paintChampTables: function () {
        var t = Tabs.champOrganizer;
        for (champItemTypeValue in t.champItemLists) {
            var m = '<table><tr>';
            var divCards = document.getElementById('tcoChampCardSection' + champItemNames[champItemTypeValue]);
            divCards.innerHTML = "<div></div>";
            for (idx = 0; idx < t.champItemLists[champItemTypeValue].length; idx++) {
                var champItem = t.champItemLists[champItemTypeValue][idx];
                m += '<td><div class=tcoChampCard id=tcoChampCard' + champItem.equipmentId + '>';
                m += BuildChampCard(champItem);
                m += '</div></td>';
            }
            m += '</tr></table>';
            divCards.innerHTML = '<div>' + m + '</div>';
        }
        var tcoCards = document.getElementsByClassName('tcoChampCard');
        for (idx = 0; idx < tcoCards.length; idx++) {
            tcoCards[idx].addEventListener('click', function (A) {
                A.stopPropagation();
                var champId = this.id.split('tcoChampCard')[1];
                var champItem = uW.kocChampionItems[champId];
                var tcoCard = document.getElementById('tcoChampCard' + champId);
                CardContextMenu(this, champItem, true);
            },false);
        }
    },
	
	show: function () {
        var t= Tabs.champOrganizer;
        t.createChampItemList();
        t.paintChampTables();
	},



    showNextChampLevel: function () {
        var t = Tabs.champOrganizer;

        if (t.panelNextLevel + 1 > tcoMaxChampLevel) return;

        var elemStatTitle = document.getElementsByClassName('upgEnhStatsTitle')[1];
        t.panelNextLevel++;
        elemStatTitle.innerHTML = "Level " + t.panelNextLevel + (t.panelNextLevel == tcoMaxChampLevel ? "" : " (<i>Next</i>)");

        var elemStatBody = document.getElementById('upgEnhStatsBodyTarget');

        var elemStatItems = elemStatBody.getElementsByTagName("li");

        var champ_item = uW.kocChampionItems[t.panelId];

        for (var elemIndex = 0; elemIndex < elemStatItems.length; ++elemIndex) {
            var elemItem = elemStatItems[elemIndex];
            var slotNumber = elemIndex + 1;
            var effectLine = champ_item.effects[slotNumber];
            var effect = CM.ChampionManager.getEffect(effectLine, t.panelNextLevel);
            elemItem.innerHTML = effect.name + " " + effect.amount;
        }
    },


}

Tabs.champEnhStats = {
	tabOrder: 100,
	tabLabel: 'ENH&nbsp;STATS',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL ENHANCEMENT STATS',
	
	init: function (div) {
		var t = Tabs.champEnhStats;
		t.mydiv = div;
        t.buildChampEnhStatsDisplay();
	},
	
	hide: function () {},

	buildChampEnhStatsDisplay: function () {

        var t = Tabs.champEnhStats;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - (dlgWidthOffset*2.5)) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        m += '<table class=tcoStats align=center cellspacing=0>';

        m += '<tr valign=top align=center><th colspan=' + (tcoMaxChampQuality + 2) + '>Enhancing Numbers  (successes/failures)</th></tr>';

        m += '<tr valign=top align=center><th></th>';
        for (qual = 0; qual <= tcoMaxChampQuality; qual++) m += '<td style="font-weight: bold;" class="td' + (qual % 2 + 1) + '"  >' + champCardQualities[qual].capitalizeFirstLetter() + '&nbsp;</td>';
        m += '</tr>';

        var st = [0, 0, 0, 0, 0, 0];
        var ft = [0, 0, 0, 0, 0, 0];

        for (lvl = 0; lvl <= tcoMaxChampLevel; lvl++) {
            m += '<tr valign=top align=center>';
            m += '<th>';
            if (lvl != 0) m += '+';
            m += lvl + '</th>';
            for (qual = 0; qual < (tcoMaxChampQuality+1); qual++) {
                if (tcoChampUpgradeStats.enhanceSuccess[qual][lvl] == null) tcoChampUpgradeStats.enhanceSuccess[qual][lvl] = 0;
                if (tcoChampUpgradeStats.enhanceFailure[qual][lvl] == null) tcoChampUpgradeStats.enhanceFailure[qual][lvl] = 0;
                st[qual] += tcoChampUpgradeStats.enhanceSuccess[qual][lvl];
                ft[qual] += tcoChampUpgradeStats.enhanceFailure[qual][lvl];
                m += '<td class="td' + (qual % 2) + '"  >' + tcoChampUpgradeStats.enhanceSuccess[qual][lvl] + ' / ' + tcoChampUpgradeStats.enhanceFailure[qual][lvl] + '</td>';
            }
            m += '</tr>';
        }

        m += '<tr valign=top align=center><th> Totals: </th>';
        for (qual = 0; qual < (tcoMaxChampQuality+1); qual++) m += '<td style="font-weight: bold;" class="td' + (qual % 2) + '" >' + st[qual] + ' / ' + ft[qual] + '</td>';
        m += '</tr>';

        m += '<tr valign=top align=center><th> Percents: </th>';
        for (qual = 0; qual < (tcoMaxChampQuality+1); qual++) {
            m += '<td style="font-weight: bold;" class="td' + (qual % 2) + '" >';
            if ((st[qual] + ft[qual]) == 0)
                m += "--";
            else {
                var perc = (100 * st[qual] / (st[qual] + ft[qual]));
                m += perc.toFixed(2) + '%';
            }
            m += '</td>';
        }
        m += '</tr>';

        m += '</table>';
        m += '</div>';

        m += '<center><input type=button class=tcoButton value="Clear Stats" id=tcoChampEnhStatsClear></center>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoChampEnhStatsClear').addEventListener('click', function () {

            var t = Tabs.champEnhStats;
            for (lvl = 0; lvl <= tcoMaxChampLevel; lvl++) {
                for (qual = 0; qual < (tcoMaxChampQuality+1); qual++) {
                    tcoChampUpgradeStats.enhanceSuccess[qual][lvl] = null;
                    tcoChampUpgradeStats.enhanceFailure[qual][lvl] = null;
                }
            }
            SAVEtcoChampUpgradeStats();
            t.buildChampEnhStatsDisplay();

        }, false);
    
    },

	show: function () {
		var t = Tabs.champEnhStats;
        t.buildChampEnhStatsDisplay();
	},

}

Tabs.champUpgStats = {
	tabOrder: 100,
	tabLabel: 'UPG&nbsp;STATS',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL UPGRADE STATS',
	
	init: function (div) {
		var t = Tabs.champUpgStats;
		t.mydiv = div;
        t.buildChampUpgStatsDisplay();
	},
	
	hide: function () {},
	
	buildChampUpgStatsDisplay: function () {

		var t = Tabs.champUpgStats;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - (dlgWidthOffset*2.5)) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        m += '<table class=tcoStats align=center cellspacing=0>';

        m += '<tr valign=top align=center><th colspan=' + (tcoMaxChampLevel+2) + '>Upgrading Numbers  (successes/failures)</TH></TR>';

        m += '<tr valign=top align=center><th></th>';
        for (lvl = 0; lvl < tcoMaxChampLevel; lvl++) m += '<td style="font-weight: bold;" class="td' + (lvl % 2) + '"  >&nbsp;+' + (lvl + 1) + '&nbsp;</td>';
        m += '</tr>';

        var st = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];  //TODO: increase when game increases max champ levels (currently 18)
        var ft = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

        for (qual = 0; qual <= tcoMaxChampQuality; qual++) {
            m += '<tr valign=top align=center><th>' + champCardQualities[qual].capitalizeFirstLetter() + '</th>';
            for (lvl = 0; lvl < tcoMaxChampLevel; lvl++) {
                if (tcoChampUpgradeStats.upgradeSuccess[qual][lvl] == null || isNaN(tcoChampUpgradeStats.upgradeSuccess[qual][lvl])) tcoChampUpgradeStats.upgradeSuccess[qual][lvl] = 0;
                if (tcoChampUpgradeStats.upgradeFailure[qual][lvl] == null || isNaN(tcoChampUpgradeStats.upgradeFailure[qual][lvl])) tcoChampUpgradeStats.upgradeFailure[qual][lvl] = 0;
                st[lvl] += tcoChampUpgradeStats.upgradeSuccess[qual][lvl];
                ft[lvl] += tcoChampUpgradeStats.upgradeFailure[qual][lvl];

                m += '<td class="td' + (lvl % 2) + '"  >';
                m += tcoChampUpgradeStats.upgradeSuccess[qual][lvl] + ' / ' + tcoChampUpgradeStats.upgradeFailure[qual][lvl];
                m += '</td>';
            }
            m += '</tr>';
        }

        m += '<tr valign=top align=center><th> Totals: </th>';
        for (lvl = 0; lvl < tcoMaxChampLevel; lvl++) m += '<td style="font-weight: bold;" class="td' + (lvl % 2) + '"  >' + st[lvl] + " / " + ft[lvl] + '</td>';
        m += '</tr>';

        m += '<tr valign=top align=center><th> Percents: </th>';
        for (lvl = 0; lvl < tcoMaxChampLevel; lvl++) {
            m += '<td style="font-weight: bold;" class="td' + (lvl % 2) + '"  >';
            if ((st[lvl] + ft[lvl]) == 0)
                m += '--';
            else {
                var perc = (100 * st[lvl] / (st[lvl] + ft[lvl]));
                m += perc.toFixed(2) + '%';
            }
            m += '</td>';
        }
        m += '</tr>';

        m += '</table>';
        m += '</div>';

        m += '<center><input type=button class=tcoButton value="Clear Stats" id=tcoChampUpgStatsClear></center>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoChampUpgStatsClear').addEventListener('click', function () {
            var t = Tabs.champUpgStats;
            for (lvl = 0; lvl <= tcoMaxChampLevel; lvl++) {
                for (qual = 0; qual < (tcoMaxChampQuality+1); qual++) {
                    tcoChampUpgradeStats.upgradeSuccess[qual][lvl] = null;
                    tcoChampUpgradeStats.upgradeFailure[qual][lvl] = null;
                }
            }
            SAVEtcoChampUpgradeStats();
            t.buildChampUpgStatsDisplay()
        }, false);

    },

	show: function () {
        var t = Tabs.champUpgStats;
        t.buildChampUpgStatsDisplay();
	},
}

Tabs.champPresets = {
	tabOrder: 100,
	tabLabel: 'PRESETS',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL PRESETS',
    broke_items: 0,
    broke_count: 0,
    delay: 2000,
	
	init: function (div) {
		var t = Tabs.champPresets;
		t.mydiv = div;



	},
	
	hide: function () {},
	
    refreshBrokeMightDisplay: function () {
        document.getElementById('tcoChampMightBroke').innerHTML = getChampBrokeMight();
    },

	show: function () {
		var t = Tabs.champPresets;

		var m = '<div class=tcoHeader>' + t.tabHeader + '<div class=tcoSaveSettings id=tcoChampPresetsSaveSettings title="Save Presets Settings"></div><div class=tcoLoadSettings id=tcoChampPresetsLoadSettings title="Load Presets Settings"></div></div>';

        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        m += '<table>';
        m += '<tr><td width=100%>Preset Color: <select class=tcoSelect id=tcoChampPresetColor>';
        m += '<option ' + (tcoChampPresetData.presetColor == "#FFFFFF" ? 'SELECTED ' : '') + 'value="#FFFFFF">White</option>';
        m += '<option ' + (tcoChampPresetData.presetColor == "#808080" ? 'SELECTED ' : '') + 'value="#808080">Gray</option>';
        m += '<option ' + (tcoChampPresetData.presetColor == "#FF0000" ? 'SELECTED ' : '') + 'value="#FF0000">Red</option>';
        m += '<option ' + (tcoChampPresetData.presetColor == "#FFFF00" ? 'SELECTED ' : '') + 'value="#FFFF00">Yellow</option>';
        m += '<option ' + (tcoChampPresetData.presetColor == "#00FF00" ? 'SELECTED ' : '') + 'value="#00FF00">Lime</option>';
        m += '<option ' + (tcoChampPresetData.presetColor == "#00FFFF" ? 'SELECTED ' : '') + 'value="#00FFFF">Aqua</option>';
        m += '<option ' + (tcoChampPresetData.presetColor == "#0000FF" ? 'SELECTED ' : '') + 'value="#0000FF">Blue</option>';
        m += '<option ' + (tcoChampPresetData.presetColor == "#FF00FF" ? 'SELECTED ' : '') + 'value="#FF00FF">Fuchsia</option>';
        m += '</select>';
        m += '&nbsp;&nbsp;&nbsp;General Color: <select class=tcoSelect id=tcoChampTagColor>';
        m += '<option ' + (tcoChampPresetData.tagColor == "#FFFFFF" ? 'SELECTED ' : '') + 'value="#FFFFFF">White</option>';
        m += '<option ' + (tcoChampPresetData.tagColor == "#808080" ? 'SELECTED ' : '') + 'value="#808080">Gray</option>';
        m += '<option ' + (tcoChampPresetData.tagColor == "#FF0000" ? 'SELECTED ' : '') + 'value="#FF0000">Red</option>';
        m += '<option ' + (tcoChampPresetData.tagColor == "#FFFF00" ? 'SELECTED ' : '') + 'value="#FFFF00">Yellow</option>';
        m += '<option ' + (tcoChampPresetData.tagColor == "#00FF00" ? 'SELECTED ' : '') + 'value="#00FF00">Lime</option>';
        m += '<option ' + (tcoChampPresetData.tagColor == "#00FFFF" ? 'SELECTED ' : '') + 'value="#00FFFF">Aqua</option>';
        m += '<option ' + (tcoChampPresetData.tagColor == "#0000FF" ? 'SELECTED ' : '') + 'value="#0000FF">Blue</option>';
        m += '<option ' + (tcoChampPresetData.tagColor == "#FF00FF" ? 'SELECTED ' : '') + 'value="#FF00FF">Fuchsia</option>';
        m += '</select>';
        m += '&nbsp;&nbsp;&nbsp;Active Color: <select class=tcoSelect id=tcoChampActiveColor>';
        m += '<option ' + (tcoChampPresetData.activeColor == "#FFFFFF" ? 'SELECTED ' : '') + 'value="#FFFFFF">White</option>';
        m += '<option ' + (tcoChampPresetData.activeColor == "#808080" ? 'SELECTED ' : '') + 'value="#808080">Gray</option>';
        m += '<option ' + (tcoChampPresetData.activeColor == "#FF0000" ? 'SELECTED ' : '') + 'value="#FF0000">Red</option>';
        m += '<option ' + (tcoChampPresetData.activeColor == "#FFFF00" ? 'SELECTED ' : '') + 'value="#FFFF00">Yellow</option>';
        m += '<option ' + (tcoChampPresetData.activeColor == "#00FF00" ? 'SELECTED ' : '') + 'value="#00FF00">Lime</option>';
        m += '<option ' + (tcoChampPresetData.activeColor == "#00FFFF" ? 'SELECTED ' : '') + 'value="#00FFFF">Aqua</option>';
        m += '<option ' + (tcoChampPresetData.activeColor == "#0000FF" ? 'SELECTED ' : '') + 'value="#0000FF">Blue</option>';
        m += '<option ' + (tcoChampPresetData.activeColor == "#FF00FF" ? 'SELECTED ' : '') + 'value="#FF00FF">Fuchsia</option>';
        m += '</select>(Requires Refresh)</td></tr>';
        m += '<tr><td>';
        m += '<input type=button class=tcoButton id=tcoChampClearTags value="Clear All Tags">&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton id=tcoChampClearAllPresetTags value="Clear All Preset Tags">&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton id=tcoChampSaveAllPresetTags value="Save All Preset Tags">&nbsp;&nbsp;';
        //m += '<input type=button id=trExportPresetTags value="Export Preset Tags">';
        m += '</td></tr>';
        m += '<tr><td>';
        m += '<input type=checkbox class=tcoCheckbox id=tcoChampShowMight ' + (tcoChampPresetData.showChampMight ? 'CHECKED' : '') + '/>Show Might on Posts';
        m += '&nbsp;&nbsp;&nbsp;<input type=checkbox class=tcoCheckbox id=tcoChampShowName ' + (tcoChampPresetData.showChampName ? 'CHECKED' : '') + '/>Show Preset Name on Posts';
        m += '</td></tr>';
        m += '</table>';

        
        m += '<div class=tcoHeader id=tcoChampPresetNaming onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;PRESET NAMING&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        if (tcoMaxChampions == 0) {
            m += '<tr><td>No Champions</td></tr>';
        } else {
            var presetsList = "";
            for (var i = 1; i < tcoMaxChampions + 1; i++) {
                presetsList += '<option value="' + i + '">' + i + '</option>';
            }

            for (var i = 1; i < tcoMaxChampions+1; i++) {
                var thisChampion = Seed.champion.champions[i-1];
                m += '<tr>';
                m += '<td><input class="tcoChampPresetSlotPost tcoButton" type=button id=tcoChampPreset' + i + ' value="Post Slot"></td>';
                m += '<td><input class="tcoChampPresetTagPost tcoButton" type=button id=tcoChampPreset' + i + ' value="Post Tag"></td>';
                if (thisChampion.name == "") {
                    m += '<td><b>Champ ' + i + ':</b></td>';
                } else {
                    m += '<td><b>' + thisChampion.name + ':</b></td>';
                }
                
                m += '<td><input class="tcoChampPresetNameEntry tcoTextbox" type=text size=15 id=tcoChampPresetName' + i + ' value="' + tcoChampPresetData.presetNames[i-1] + '"></td>';
                m += '<td><input class="tcoChampPresetCopyTo tcoButton" type=button id=tcoChampPreset' + i + ' value="Copy To"><select class=tcoSelect id=tcoChampPresetCopyToWhat' + i + '>' + presetsList + '</select></td>';
                m += '<td><input class="tcoChampPresetSave tcoButton" type=button id=tcoChampPreset' + i + ' value="Save"></td>';
                
                if (getChampPresetTagCount(i) != 0) {
                    m += '<td><input class="tcoChampPresetClear tcoButton" type=button id=tcoChampPreset' + i + ' value="Clear"></td>';
                    m += '<td><input class="tcoChampPresetExcel tcoButton" type=button id=tcoChampPreset' + i + ' value="Excel"></td>';
                } else {
                    m += '<td/><td/>';
                }
                m += '</tr>';
            
            }
        }
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;CHAMP HALL BREAKING&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td><div id=tcoChampMightBroke>You have 0 champ hall might broken</div></td></tr>';
        m += '<tr><td><input type=checkbox checked class=tcoCheckbox id=tcoChampExcludePresets>Exclude Tagged Presets</td></tr>';
        m += '<tr><td><input type=checkbox checked class=tcoCheckbox id=tcoChampExcludeTags>Exclude Regular Tagged</td></tr>';
        m += '<tr><td>Break Items Level <select class=tcoSelect id=tcoChampBreakLevelLow>';
        for (lvl = 1; lvl < tcoMaxChampLevel; lvl++) {
            m += '<option value=' + lvl + '>+' + lvl + '</option>';
        }
        m += '</select> or Higher</td></tr>';
        m += '<tr><td>Break Items Level <select class=tcoSelect id=tcoChampBreakLevelHigh>';
        for (lvl = 1; lvl < tcoMaxChampLevel; lvl++) {
            m += '<option value=' + lvl + (lvl == tcoMaxChampLevel - 1 ? ' SELECTED' : '') + '>+' + lvl + '</option>';
        }
        m += '</select> or Lower</td></tr>';

        m += '<tr><td><input type=button class=tcoButton id=tcoChampBreakAll value="Break Now"><font color=red><i>(all options above will reset after refresh)</i></font></td></tr>';
        m += '<tr><td><div id=tcoChampBreakCounter></div></td></tr>';
//        m += '<tr><td><hr></td></tr>';
//        m += '<tr><td>Break Equiped Throne Room Only<select class=tcoSelect id=tcoThronePresetEquipBreak>' + presetsList + '</select><input type=button class=tcoButton id=tcoThronePresetEquipBreakNow value="Break Now"></td></tr>';
//        m += '<tr><td>Break Tagged Preset Only<select class=tcoSelect id=tcoThronePresetTaggedBreak>' + presetsList + '</select><input type=button class=tcoButton id=tcoThronePresetTaggedBreakNow value="Break Now"></td></tr>';
//        m += '<tr><td>Break <input type=number class=tcoText id=tcoThroneMightBreak oncontextmenu="return false;"> Throne Might <input type=button class=tcoButton id=tcoThroneMightBreakNow value="Break Now"></td></tr>';
        m += '</table>';
        m += '</div>';
        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoChampPresetsSaveSettings').addEventListener('click', function () {
            SaveSettingsToFile(tcoChampPresetData);
        }, false);
        document.getElementById('tcoChampPresetsLoadSettings').addEventListener('click', function () {
            var loader = document.getElementById('tcoSettingsFile');
            loader.addEventListener('change', function () {
                LoadSettingsFromFile(tcoChampPresetData, Tabs.champPresets);
            }, false);
            loader.click();
        }, false);

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        t.refreshBrokeMightDisplay();

        document.getElementById('tcoChampShowMight').addEventListener('change', function () {
            tcoChampPresetData.showChampMight = document.getElementById('tcoChampShowMight').checked;
            SAVEtcoChampPresetData();
        }, false);

        document.getElementById('tcoChampShowName').addEventListener('change', function () {
            tcoChampPresetData.showChampName = document.getElementById('tcoChampShowName').checked;
            SAVEtcoChampPresetData();
        }, false);

        document.getElementById('tcoChampBreakAll').addEventListener('click', function () {
            if (!confirm('You cannot undo this action, are you sure you want to break your champ hall?')) return;
            var excludePresets = document.getElementById('tcoChampExcludePresets').checked;
            var excludeTags = document.getElementById('tcoChampExcludeTags').checked;
            var breakLevelLow = document.getElementById('tcoChampBreakLevelLow').value;
            var breakLevelHigh = document.getElementById('tcoChampBreakLevelHigh').value;
            var allTaggedPresets = [];
            if (excludePresets) {
                for (i = 1; i < tcoMaxChampions + 1; i++) {
                    if (getChampPresetTagCount(i) != 0) {
                        var thisPreset = getChampPresetObject(i);
                        for (var champId in thisPreset) {
                            var champ_item = uW.kocChampionItems[champId];
                            if (champ_item == null || !champ_item) continue;
                            if (champ_item.level == tcoMaxChampLevel) continue;
                            if (champ_item.level < breakLevelLow || champ_item.level > breakLevelHigh) continue;
                            allTaggedPresets.push(champId);
                        }
                    }
                }
            }
            
            var champToBreak = [];
            for (chId in uW.kocChampionItems) {
                var champ_item = uW.kocChampionItems[chId];
                if (champ_item == null || !champ_item) continue;
                if (champ_item.status != 1) continue;//card broken?
                if (excludeTags && tcoChampPresetData.taggedItems[chId]) continue;
                if (allTaggedPresets.indexOf(chId) != -1) continue;
                if (champ_item.level == tcoMaxChampLevel) continue;
                if (champ_item.level < breakLevelLow || champ_item.level > breakLevelHigh) continue;

                champToBreak.push(chId);
            }
            delete allTaggedPresets;

            if (champToBreak.length == 0) {
                alert('No champ items to break');
                return;
            }
            
            t.broke_count = champToBreak.length;

            t.setBreakStatus();

            t.broke_items = 0;

            for (var i = 0; i < champToBreak.length; i++) {  //loop through all the champ items to be broke

                var citytobreakfrom = 0;  //start at the first city {the index is 0-based}

                var champ_item = uW.kocChampionItems[champToBreak[i]];  //get the next champ item in the collection

                var curr_level = champ_item.level;  //get the current level of the champ item

                var champ_id = champ_item.equipmentId;  //get the champ item id

                if (curr_level == tcoMaxChampLevel) continue;  //if for some reason a card at the max level makes it through the list then continue to the next in the list

                var z = CM.WorldSettings.getSettingAsObject("CE_UPGRADE_AETHERSTONE_MAP");

                var cost_to_upgrade = z[curr_level + 1].Aetherstones;  //get the cost of stones to upgrade to the next level

                while (citytobreakfrom < 8) {  //loop through all the 8 cities checking for astone to upgrade for the break feature

                    stones_in_city = parseInt(Seed.resources["city" + Seed.cities[citytobreakfrom][0]]["rec5"][0]);  //get the astone count for the city

                    if (cost_to_upgrade + tcoBreakBuffer <= stones_in_city) break;  //if you have the astone in the city then stop searching cities and do the upgrade

                    citytobreakfrom = citytobreakfrom + 1;  //search to the next city in the loop

                }

                if (citytobreakfrom == 8) continue;  //if you make it to 8, then you've exhausted all the cities astone search for this champ item, move to the next one

                var city = Seed.cities[citytobreakfrom][0];

                setTimeout(
                    (function(cy, id, uc) { 
                        return function () {
                            upgradeIt(cy, id, uc);
                        }
                    }) (city, champ_id, cost_to_upgrade), (i+1) * t.delay);

            }

            setTimeout(function() {
                var t = Tabs.champPresets;
                if (t.broke_items == 0) {
                    alert('No Items broken.');
                } else {
                    alert('Breaking CH complete.  ' + t.broke_items + ' Champ items were broken.  Page will now refresh.');
                    RefreshCamelot();
                }
            }, champToBreak.length * t.delay + t.delay);

        }, false);

        document.getElementById('tcoChampClearAllPresetTags').addEventListener('click', function () {
            t.clearAllPresetTagItems();
            t.show();
            document.getElementById('tcoChampPresetNaming').click();
        }, false);

        document.getElementById('tcoChampSaveAllPresetTags').addEventListener('click', function () {
            for (i = 1; i < tcoMaxChampions + 1; i++) {
                t.addPresetTags(i);
            }
            t.show();
            document.getElementById('tcoChampPresetNaming').click();
        }, false);

        document.getElementById('tcoChampClearTags').addEventListener('click', function () {
            t.removeAllTagItems();
        }, false);

        document.getElementById('tcoChampActiveColor').addEventListener('change', function () {
            tcoChampPresetData.activeColor = document.getElementById('tcoChampActiveColor').value;
            SAVEtcoChampPresetData();
        }, false);

        document.getElementById('tcoChampPresetColor').addEventListener('change', function () {
            tcoChampPresetData.presetColor = document.getElementById('tcoChampPresetColor').value;
            SAVEtcoChampPresetData();
        }, false);

        document.getElementById('tcoChampTagColor').addEventListener('change', function () {
            tcoChampPresetData.tagColor = document.getElementById('tcoChampTagColor').value;
            SAVEtcoChampPresetData();
        }, false);


        var tcoChampPresetSave = document.getElementsByClassName('tcoChampPresetSave');
        for (var idx=0;idx<tcoChampPresetSave.length;idx++) {
            tcoChampPresetSave[idx].addEventListener('click', function() {
                var id = this.id;
                var num = id.split("tcoChampPreset")[1];
                t.addPresetTags(num);
                t.show();
                document.getElementById('tcoChampPresetNaming').click();
            }, false);
        }

        var tcoChampPresetSlotPost = document.getElementsByClassName('tcoChampPresetSlotPost');
        for (var idx=0; idx<tcoChampPresetSlotPost.length; idx++) {
            tcoChampPresetSlotPost[idx].addEventListener('click', function() {
                var id = this.id;
                var num = id.split('tcoChampPreset')[1];
                postChampSlot(num);
            }, false);
        }

        var tcoChampPresetTagPost = document.getElementsByClassName('tcoChampPresetTagPost');
        for (var idx=0; idx<tcoChampPresetTagPost.length; idx++) {
            tcoChampPresetTagPost[idx].addEventListener('click', function () {
                var id = this.id;
                var num = id.split('tcoChampPreset')[1];
                postChampPreset(num);
            }, false);
        }

        var tcoChampPresetClear = document.getElementsByClassName('tcoChampPresetClear');
        for (var idx=0; idx<tcoChampPresetClear.length; idx++) {
            tcoChampPresetClear[idx].addEventListener('click', function () {
                var id = this.id;
                var num = id.split('tcoChampPreset')[1];
                t.clearPresetTags(num);
                t.show();
                document.getElementById('tcoChampPresetNaming').click();
            }, false);
        }

        var tcoChampPresetExcel = document.getElementsByClassName('tcoChampPresetExcel');
        for (var idx=0; idx<tcoChampPresetExcel.length; idx++) {
            tcoChampPresetExcel[idx].addEventListener('click', function () {
                var id = this.id;
                var num = id.split('tcoChampPreset')[1];
                ExportChampPresetToExcel(num);
            }, false);
        }

        var tcoChampPresetCopyTo = document.getElementsByClassName('tcoChampPresetCopyTo');
        for (var idx=0; idx<tcoChampPresetCopyTo.length; idx++) {
            tcoChampPresetCopyTo[idx].addEventListener('click', function () {
                var id = this.id;
                var sourceNum = id.split('tcoChampPreset')[1];
                var destNum = document.getElementById('tcoChampPresetCopyToWhat' + sourceNum).value;
                var copyName = document.getElementById('tcoChampPresetName' + sourceNum).value;
                t.copyPresetTags(sourceNum, destNum, copyName);
                t.show();
                document.getElementById('tcoChampPresetNaming').click();
            }, false);
        }

        var tcoChampPresetNameEntry = document.getElementsByClassName('tcoChampPresetNameEntry');
        for (var idx=0; idx<tcoChampPresetNameEntry.length; idx++) {
            tcoChampPresetNameEntry[idx].addEventListener('change', function () {
                var id = this.id;
                var num = id.split('tcoChampPresetName')[1];
                var presetName = this.value;
                if (presetName == "") {
                    presetName = "undefined";
                    document.getElementById(id).value = presetName;
                }
                tcoChampPresetData.presetNames[num-1] = presetName;
                SAVEtcoChampPresetData();
            }, false);

            tcoChampPresetNameEntry[idx].addEventListener('blur', function () {
                var id = this.id;
                var num = id.split('tcoChampPresetName')[1];
                var presetName = this.value;
                if (presetName == "") {
                    presetName = "undefined";
                    document.getElementById(id).value = presetName;
                    tcoChampPresetData.presetNames[num-1] = presetName;
                    SAVEtcoChampPresetData();
                }
            }, false);
        }
	},

    setBreakStatus: function() {
        var t = Tabs.champPresets;
        var remaining = t.broke_count - t.broke_items;
        var m =  "Items Remaining: " + remaining;
        m += "<br>Time Remaining: " + (remaining * (t.delay/1000)) + " Seconds";
        document.getElementById('tcoChampBreakCounter').innerHTML = m;
    },

    unequipAllItems: function (presetIndex) {
        var t = Tabs.champPresets;

        if (!confirm('Are you sure you want to unequip all items?')) return;

        var championID = uW.seed.champion.champions[presetIndex-1].championId;// = 11007

        var equipped_items = [];


        for (chId in uW.kocChampionItems) {
            if (uW.kocChampionItems[chId].equippedTo != championID) continue;
            equipped_items.push(chId);
        }

        var el = equipped_items.length;

        if ( el == 0 ) return;

        function unequipLoop(counter, id) {
            setTimeout(function() { t.unequipItem(id); }, (counter + 1) * 2000);
        }

        for (ei = 0; ei < el; ei++) {
            var chId = equipped_items[ei];
            unequipLoop(ei, chId);
        }

        setTimeout(function () { alert("all champ items unequipped") }, el * 2000 + 2000);
    },

    unequipItem: function(chId) {
        var t = Tabs.champPresets;
        CM.ChampionManager.unequipItem(chId);
        t.paintTags();
    },

    equipItem: function(chId) {
        CM.ChampionManager.equipItem(chId);
    },

    clearPresetTags: function (presetIndex) {
        var t = Tabs.champPresets;
        var preset = getChampPresetObject(parseInt(presetIndex));
        for (var p in preset) delete preset[p];
        SAVEtcoChampPresetData();
        t.paintTags();
    },

    clearAllPresetTagItems: function () {
        var t = Tabs.champPresets;
        if (!confirm('Are you sure you want to clear all preset tag items?')) return;
        for (i = 1; i < tcoMaxChampions + 1; i++) t.clearPresetTags(i);
    },

    equipPresetTags: function (presetIndex) {
        var t = Tabs.champPresets;

        var equipLoop = function (id) { return function() { t.equipItem(id); }; }
        var unequipLoop = function (id) { return function() { t.unequipItem(id) };  }
        
        var c = 1;
        
        var championID = Seed.champion.champions[presetIndex-1].championId;// = 11007
        var equipped_items = [];
        for (chId in uW.kocChampionItems) {
            if (uW.kocChampionItems[chId].equippedTo != championID) continue;
            equipped_items.push(chId);
        }
        var el = equipped_items.length;
        if (el > 0) {
            for (ei = 0; ei < el; ei++) {
                var chId = equipped_items[ei];
                setTimeout(unequipLoop(chId), c * 2000);
                c += 1;
            }
        }

        var preset = getChampPresetObject(parseInt(presetIndex));
        for (var p in preset) {
            setTimeout(equipLoop(p), c * 2000);
            c += 1;
        }

        setTimeout(function () { alert("all champ items equipped") }, c * 2000 + 2000);
    },

    copyPresetTags: function (sourcePresetNumber, destinationPresetNumber, presetName) {
        var pSource = getChampPresetObject(parseInt(sourcePresetNumber));
        var pDestination = getChampPresetObject(parseInt(destinationPresetNumber));
        for (var p in pDestination) delete pDestination[p];
        for (var p in pSource) pDestination[p] = true;
        tcoChampPresetData.presetNames[destinationPresetNumber-1] = presetName + " (copy)";
        SAVEtcoChampPresetData();
    },

    addPresetTags: function (presetIndex) {  //presetIndex should be passed in as base 1 to index into the presetTaggedItems array
        var t = Tabs.champPresets;
        
        var preset = getChampPresetObject(parseInt(presetIndex));

        var championID = Seed.champion.champions[presetIndex-1].championId;// = 11007

        var equipped_items = [];

        for (chId in uW.kocChampionItems) {
            if (uW.kocChampionItems[chId].equippedTo != championID) continue;
            equipped_items.push(chId);
        }

        if ( equipped_items.length == 0 ) return;

        for (var p in preset) delete preset[p];

        for (ei = 0; ei < equipped_items.length; ei++) {
            var chId = equipped_items[ei];
            preset[chId] = true;
            SAVEtcoChampPresetData();
        }

        t.paintTags();

    },

    paintTags: function () {
        for (ii in uW.kocChampionItems) {
            $("div#" + ii + ".champItem").children(".ioverlay").children(".tagBorderChamp").remove();
            $("div#" + ii + ".champItem").children(".ioverlay").children(".presetBorderChamp").remove();
            $("div#" + ii + ".champItem").children(".ioverlay").children(".activeBorderChamp").remove();
            if ( tcoChampPresetData.taggedItems[ii] ) {
                $("div#" + ii + ".champItem").children(".ioverlay").prepend("<div class='tagBorderChamp'></div>");
            }
            $("div#" + ii + ".equipSelected ").children(".ioverlay").prepend("<div class='activeBorderChamp'></div>");
            if ( tcoChampPresetData.taggedItems01[ii] || tcoChampPresetData.taggedItems02[ii] || tcoChampPresetData.taggedItems03[ii] || tcoChampPresetData.taggedItems04[ii] ) {
                $("div#" + ii + ".champItem").children(".ioverlay").prepend("<div class='presetBorderChamp'></div>");
            }
        }

        $("#itemInvetory div").removeClass('tcoBlueBorder');
        $("#itemInvetory div").removeClass('tcoYellowBorder');
        
        for (ii in tcoChampQueueData.list) {
            var list_item = tcoChampQueueData.list[ii];
            if (!list_item) continue;
            if (list_item.status != "complete") {
                var id = list_item.item;
                if (list_item.action == "upgrade") $("div#" + id + ".champItem").addClass('tcoBlueBorder');
                if (list_item.action == "enhance") $("div#" + id + ".champItem").addClass('tcoYellowBorder');
            }

        }

    },

    removeAllTagItems: function () {
        var t = Tabs.champPresets;
        var taggedReverse = [];
        for (k in tcoChampPresetData.taggedItems) taggedReverse.push(k);
        var len = taggedReverse.length;
        while (len--) {
            var chID = taggedReverse[len];
            delete tcoChampPresetData.taggedItems[chID];
        }
        SAVEtcoChampPresetData();
        t.paintTags();
    },

    removeTagItem: function (itemId) {
        var t = Tabs.champPresets;
        if (tcoChampPresetData.taggedItems[itemId]) {
            delete tcoChampPresetData.taggedItems[itemId];
            SAVEtcoChampPresetData();
        }
        t.paintTags();
    },

    addAllTagItems: function () {
        var t = Tabs.champPresets;
        t.removeAllTagItems();
        for (chId in uW.kocChampionItems) {
            tcoChampPresetData.taggedItems[chId] = true;
        }
        SAVEtcoChampPresetData();
        t.paintTags();
    },

    addTagItem: function (itemId) {
        var t = Tabs.champPresets;
        tcoChampPresetData.taggedItems[itemId] = true;
        SAVEtcoChampPresetData();
        t.paintTags();
    },


}

Tabs.champPreview = {
	tabOrder: 100,
	tabLabel: 'PREVIEW',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL PREVIEW',
    champItemNamesForPreview: {1: 'weapon', 2: 'chest', 3: 'helm', 4: 'boots', 5: 'shield', 6: 'ring1', 7: 'ring2', 8: 'pendant', 9: 'cloak'},
    champItemTypesForPreview: {'weapon': 1, 'chest': 2, 'helm':3, 'boots':4, 'shield': 5, 'ring1': 6, 'ring2': 7, 'pendant': 8, 'cloak': 9},
    lastRing1: 0,
    lastRing2: 0,
	
	init: function (div) {
		var t = Tabs.champPreview;
		t.mydiv = div;
	},
	
	hide: function () {},
	
	show: function () {
		var t = Tabs.champPreview;

        var presetsTagList = "";
        if (tcoMaxChampions != 0)  {
            for (var i = 1; i < tcoMaxChampions + 1; i++) {
                presetsTagList += '<option value="' + i + '">' + i + ' (' + tcoChampPresetData.presetNames[i-1] + ')</option>';
            }
        }

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';

        m += '<table>';
        m += '<tr>';
        m += '<td colspan=3>';
        m += '<input type=button class=tcoButton value="Reset" id=tcoChampPreviewReset>&nbsp;&nbsp;||&nbsp;&nbsp;';
//        m += '<input type=button value="Equip Now" id=chPreviewEquip><font color=black><b>(5 sec per card to load)</b></font>&nbsp;&nbsp;||&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton value="Post Stats to Chat" id=tcoChampPreviewPost>&nbsp;';
        m += '<input type=button class=tcoButton value="Export to Excel" id=tcoChampPreviewExcel>&nbsp;';
        m += '<br>';
        m += '<input type=button class=tcoButton value="Export To Text" id=tcoChampPreviewExport>&nbsp;&nbsp;||&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton value="Load Text Export" id=tcoChampPreviewExportLoad>';
        m += '<input type=button class=tcoButton value="Browse..." id=tcoChampPreviewExportLoadItemTrigger onclick="document.getElementById(\'tcoChampPreviewExportLoadItem\').click()">';
        m += '<input hidden id=tcoChampPreviewExportLoadItem type=file>';
        m += '<br>';
        m += '<input type=button class=tcoButton value="Load Champ Preset" id=tcoChampPreviewLoadPreset>&nbsp;<select class=tcoSelect style="width:25%;" id=tcoChampPreviewLoadPresetValue>' + presetsTagList + '</select>&nbsp;&nbsp;';
        m += '<br>';
        m += '<input type=button class=tcoButton value="Copy To" id=tcoChampPreviewCopyTo><b>&nbsp;Preset Tag&nbsp;</b><select class=tcoSelect style="width:25%;" id=tcoChampPreviewCopyToValue>' + presetsTagList + '</select>&nbsp;&nbsp;';
        m += '<br>';
        m += '<input type=button class=tcoButton value="Load Champ From" id=tcoChampPreviewLoadPresetTag><b>&nbsp;Preset Tag&nbsp;</b><select class=tcoSelect style="width:25%;" id=tcoChampPreviewLoadPresetTagValue>' + presetsTagList + '</select>&nbsp;&nbsp;';
        m += '</td>';
        m += '</tr>';
        m += '</tr>';
        m += '</table>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;PREVIEW STATS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="position: static; width: 100%; height: 380px; overflow-x: auto; overflow-y: auto;">';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td>';
        m += '<div id=tcoChampPreviewDetails></div>';
        m += '</td></tr>';
        m += '</table>';
        m += '</div>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;PREVIEW CARDS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="position: static; width: 100%; height: 380px; overflow-x: auto; overflow-y: auto;">';
        m += '<table class=tcoSectionTable>';

        m += '<tr>';

        var idx = 0;
        for (var itemIdx in t.champItemNamesForPreview) {
            if (idx % 3 == 0) m += '</tr><tr>';
            m += '<td width=33% valign=top>';
            m += '<table>';
            m += '<tr><td><b>' + t.champItemNamesForPreview[itemIdx].toUpperCase() + '<b></td></tr>';
            m += '<tr><td>';
            m += '<select class=tcoSelect id=tcoChampPreviewValue' + t.champItemNamesForPreview[itemIdx] + ' style="white-space:nowrap;display:inline-block;max-width: 150px;"></select>';
            m += '</td></tr>';
            m += '<tr><td><div id=tcoChampPreviewCard' + t.champItemNamesForPreview[itemIdx] + '></div></td></tr>';
            m += '</table>';
            m += '</td>';
            idx += 1;
        }
        m += '</tr>';


        m += '</table>';
        m += '</div>';

        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }
        t.buildChampPreviewValueDisplay();

        for (var idx in t.champItemNamesForPreview) {

            document.getElementById('tcoChampPreviewCard' + t.champItemNamesForPreview[idx]).addEventListener('click', function(A) {
                A.stopPropagation();
                var champType = this.id.split('tcoChampPreviewCard')[1];
                var tcoPreviewValue = document.getElementById('tcoChampPreviewValue' + champType);
                var champId = tcoPreviewValue.value;
                if (champId == 0) return;
                var champItem = uW.kocChampionItems[champId];
                if (!champItem || champItem ==0) return;
                CardContextMenu(this, champItem, true);
            }, false);

            document.getElementById('tcoChampPreviewValue' + t.champItemNamesForPreview[idx]).addEventListener('change', function(A) {
                var champ_Type = this.id.split('tcoChampPreviewValue')[1];
                var chId = this.value;
                t.loadChampPreviewCard(chId, champ_Type);
            }, false);

            document.getElementById('tcoChampPreviewValue' + t.champItemNamesForPreview[idx]).addEventListener('keyup', function(A) {
                var champ_Type = this.id.split('tcoChampPreviewValue')[1];
                var chId = this.value;
                t.loadChampPreviewCard(chId, champ_Type);
            }, false);
           
        }

        document.getElementById('tcoChampPreviewDetails').innerHTML = t.getPreviewChampDetails();

        document.getElementById('tcoChampPreviewReset').addEventListener('click', function () {
            t.resetPreview();
            t.buildChampPreviewValueDisplay();
        }, false);

        document.getElementById('tcoChampPreviewExcel').addEventListener('click', function() {
            if (tcoChampPresetData.previewChamp.length > 0 )
                ExportChampToExcel(true);
            else
                alert('Nothing To Export');
        }, false);

        document.getElementById('tcoChampPreviewPost').addEventListener('click', function () {
            if (tcoChampPresetData.previewChamp.length == 0) return;
            t.postPreviewChampDetails();
        }, false);

        document.getElementById('tcoChampPreviewExport').addEventListener('click', function() {
            uriContent = 'data:application/octet-stream,' + encodeURIComponent(JSON.stringify(tcoChampPresetData.previewChamp));
            newWindow = window.open(uriContent, 'file.txt');
        }, false);

        document.getElementById('tcoChampPreviewExportLoad').addEventListener('click', function () {
            var fileInput = document.getElementById("tcoChampPreviewExportLoadItem");
            var files = fileInput.files;
            if (files.length==0) {
                alert('Please Select A File');
                return;
            }
            var file = files[0];
                
            var reader = new FileReader();
                
            reader.onload = function (e) {  
				var output = e.target.result;
				tcoChampPresetData.previewChamp = JSON.parse(output);
                SAVEtcoChampPresetData();
                t.show();
                alert('Preview Champ Now Loaded From File');
            };
            reader.readAsText(file);     
        }, false);

        document.getElementById('tcoChampPreviewLoadPresetTag').addEventListener('click', function () {
            var presetNum = document.getElementById('tcoChampPreviewLoadPresetTagValue').value;
            var presetTag = getChampPresetObject(parseInt(presetNum));
            t.resetPreview();
            for (var p in presetTag) t.loadChampPreviewCard(p)//tcoChampPresetData.previewChamp[p] = true;
        }, false);

        document.getElementById('tcoChampPreviewCopyTo').addEventListener('click', function () {
            var presetNum = document.getElementById('tcoChampPreviewCopyToValue').value;
            var presetTag = getChampPresetObject(parseInt(presetNum));
            for (var p in presetTag) delete presetTag[p];
            for (var idx = 0; idx < tcoChampPresetData.previewChamp.length; idx++) {
                presetTag[tcoChampPresetData.previewChamp[idx]] = true;
            }
            tcoChampPresetData.presetNames[presetNum] = "PREVIEW";
            document.getElementById('tcoChampPresetName' + presetNum).value = "PREVIEW";
            SAVEtcoChampPresetData();
            t.show();
        }, false);

        document.getElementById('tcoChampPreviewLoadPreset').addEventListener('click', function () {
            var t = Tabs.champPreview;

            var presetIndex = document.getElementById('tcoChampPreviewLoadPresetValue').value;

            var championID = Seed.champion.champions[presetIndex-1].championId;// = 11007
            var equipped_items = [];
            for (chId in uW.kocChampionItems) {
                if (uW.kocChampionItems[chId].equippedTo != championID) continue;
                equipped_items.push(chId);
            }
            var el = equipped_items.length;

            if (el > 0) {
                for (ei = 0; ei < el; ei++) {
                    var chId = equipped_items[ei];
                    champItem = uW.kocChampionItems[chId];
                    t.loadChampPreviewCard(chId);
                }
            }
        }, false);

	},

    buildChampPreviewValueDisplay: function () {
        var t = Tabs.champPreview;
        var elemSelect = null;

        for (var champType in t.champItemNamesForPreview) { //fill the default selection "--Items--"
            elemSelect = document.getElementById('tcoChampPreviewValue' + t.champItemNamesForPreview[champType]);
            elemSelect.innerHTML = '';
            elemSelect.options.add(new Option('--Items--', '0'));
        }

        for (var champId in uW.kocChampionItems) { //fill with all the champ cards
            var champItem = uW.kocChampionItems[champId];
            if (champItem.type == 6) {
                elemSelect = document.getElementById('tcoChampPreviewValuering1');
                elemSelect.options.add(new Option(champItem.name, champId));
                elemSelect = document.getElementById('tcoChampPreviewValuering2');
                elemSelect.options.add(new Option(champItem.name, champId));
            } else {
                elemSelect = document.getElementById('tcoChampPreviewValue' + t.champItemNamesForPreview[champItem.type]);
                elemSelect.options.add(new Option(champItem.name, champId));
            }
        }

        for (var idx = 0; idx < tcoChampPresetData.previewChamp.length; idx++) {  //select and display the champion cards in the preview preset
            if (tcoChampPresetData.previewChamp[idx] != 0) {
                var champItem = uW.kocChampionItems[tcoChampPresetData.previewChamp[idx]];
                if (champItem == null || !champItem) {
                    tcoChampPresetData.previewChamp[idx] = 0;
                    SAVEtcoChampPresetData();
                    continue;
                }
                if (idx == tcoRing1) t.lastRing1 = tcoChampPresetData.previewChamp[idx];
                if (idx == tcoRing2) t.lastRing2 = tcoChampPresetData.previewChamp[idx];
                var champCard = BuildChampCard(champItem);
                document.getElementById('tcoChampPreviewValue' + t.champItemNamesForPreview[idx]).value = tcoChampPresetData.previewChamp[idx];
                document.getElementById('tcoChampPreviewCard' + t.champItemNamesForPreview[idx]).innerHTML = champCard;
            }
        }
    },

    postPreviewChampDetails: function () {
        var t = Tabs.champPreview;
        var previewPreset = [];
        for (var idx = 0; idx < tcoChampPresetData.previewChamp.length; idx++) {
            if (tcoChampPresetData.previewChamp[idx] != 0) previewPreset.push(tcoChampPresetData.previewChamp[idx]);
        }

        var stringPreviewChamp = GenerateChampPresetEffectsString(previewPreset, true);
        if (stringPreviewChamp == "") {
            return;
        } else {
            var table = stringPreviewChamp.split("</div><div>");
            stringPreviewChamp = table.join("||");
            stringPreviewChamp = stringPreviewChamp.replace("<div>", ":::. |CHAMP PREVIEW STATS:||");
            stringPreviewChamp = stringPreviewChamp.replace("</div>", "");
            stringPreviewChamp = stringPreviewChamp.replace("<b>","").replace("<i>","").replace("</i>","").replace("</b>","").replace("<b>","").replace("<i>","").replace("</i>","").replace("</b>","");
            sendChat(stringPreviewChamp);
        }
        return;

    },

    resetPreview: function () {
        var t = Tabs.champPreview;

        for (var idx = 0; idx < tcoChampPresetData.previewChamp.length; idx++) tcoChampPresetData.previewChamp[idx] = 0;
        SAVEtcoChampPresetData();

        for (var champType in t.champItemNamesForPreview) {
            document.getElementById('tcoChampPreviewValue' + t.champItemNamesForPreview[champType]).value = 0;
            document.getElementById('tcoChampPreviewCard' + t.champItemNamesForPreview[champType]).innerHTML = '';
        }

        document.getElementById('tcoChampPreviewDetails').innerHTML = t.getPreviewChampDetails();
    },

    clearChampPreviewCard: function(champId) {
        var t = Tabs.champPreview;
        for (var idx = 0; idx < tcoChampPresetData.previewChamp.length; idx++)
            if (tcoChampPresetData.previewChamp[idx] == champId) {
                tcoChampPresetData.previewChamp[idx] = 0;
                SAVEtcoChampPresetData();
                for (var item in t.champItemTypesForPreview) {
                    if (document.getElementById('tcoChampPreviewValue' + item).value == champId) {
                        document.getElementById('tcoChampPreviewValue' + item).value = 0;
                        document.getElementById('tcoChampPreviewCard' + item).innerHTML = '';
                        if (item == 'ring1') t.lastRing1 = 0;
                        if (item == 'ring2') t.lastRing2 = 0;

                        if (item == 'ring1' || item == 'ring2') {
                            var elemSelect = document.getElementById('tcoChampPreviewValuering1');
                            for (var i = 0; i < elemSelect.length; i++)
                                if (elemSelect.options[i].value == champId) elemSelect.remove(i);
                            elemSelect = document.getElementById('tcoChampPreviewValuering2');
                            for (var i = 0; i < elemSelect.length; i++)
                                if (elemSelect.options[i].value == champId) elemSelect.remove(i);
                        } else {
                            var elemSelect = document.getElementById('tcoChampPreviewValue' + item);
                            for (var i = 0; i < elemSelect.length; i++)
                                if (elemSelect.options[i].value == champId) elemSelect.remove(i);
                        }
                        return;
                    }
                }
                return;
            }
        
    },

    loadChampPreviewCard: function(champId, champTypeName) {
        var t = Tabs.champPreview;
        if (typeof(champTypeName) == 'undefined') champTypeName = '';
        if (champId == 0 && champTypeName == "") return;

        var t = Tabs.champPreview;
        var champCard = '';
        if (champId == 0) {
            document.getElementById('tcoChampPreviewCard' + champTypeName).innerHTML = champCard;
            document.getElementById('tcoChampPreviewValue' + champTypeName).value = champId;
            tcoChampPresetData.previewChamp[t.champItemTypesForPreview[champTypeName]] = champId;
        } else { //champ id is NOT 0, so load the champ
            var champItem = uW.kocChampionItems[champId];
            if (!champItem || champItem ==0) return;
            champCard = BuildChampCard(champItem);

            if (champTypeName != "") { //champ type name is known
                if (champTypeName == 'ring1') {
                    if (document.getElementById('tcoChampPreviewValuering2').value == champId) {
                        document.getElementById('tcoChampPreviewValuering1').value = t.lastRing1;
                    } else {
                        document.getElementById('tcoChampPreviewCardring1').innerHTML = champCard;
                        document.getElementById('tcoChampPreviewValuering1').value = champId;
                        tcoChampPresetData.previewChamp[t.champItemTypesForPreview[champTypeName]] = champId;
                        t.lastRing1 = champId;
                    }
                } else if (champTypeName == 'ring2') {
                    if (document.getElementById('tcoChampPreviewValuering1').value == champId) {
                        document.getElementById('tcoChampPreviewValuering2').value = t.lastRing2;
                    } else {
                        document.getElementById('tcoChampPreviewCardring2').innerHTML = champCard;
                        document.getElementById('tcoChampPreviewValuering2').value = champId;
                        tcoChampPresetData.previewChamp[t.champItemTypesForPreview[champTypeName]] = champId;
                        t.lastRing2 = champId;
                    }
                } else {
                    document.getElementById('tcoChampPreviewCard' + champTypeName).innerHTML = champCard;
                    document.getElementById('tcoChampPreviewValue' + champTypeName).value = champId;
                    tcoChampPresetData.previewChamp[t.champItemTypesForPreview[champTypeName]] = champId;
                }
            } else { //champ type name is not known so we get it from the champ.type
                if (champItem.type != 6) { //champ is not a ring
                    champTypeName = t.champItemNamesForPreview[champItem.type];
                    document.getElementById('tcoChampPreviewCard' + champTypeName).innerHTML = champCard;
                    document.getElementById('tcoChampPreviewValue' + champTypeName).value = champId;
                    tcoChampPresetData.previewChamp[t.champItemTypesForPreview[champTypeName]] = champId;
                } else { //most of the time this is coming from the "Send to Preview" option from the context menu
                    if (document.getElementById('tcoChampPreviewValuering1').value == champId) return;
                    if (document.getElementById('tcoChampPreviewValuering2').value == champId) return;

                    if (document.getElementById('tcoChampPreviewValuering1').value == 0) { //if ring1 is empty load it here
                        document.getElementById('tcoChampPreviewValuering1').value = champId;
                        document.getElementById('tcoChampPreviewCardring1').innerHTML = champCard;
                        tcoChampPresetData.previewChamp[t.champItemTypesForPreview['ring1']] = champId;
                        t.lastRing1 = champId;
                    } else if (document.getElementById('tcoChampPreviewValuering2').value == 0) { //if ring1 was full and ring2 is empty load it here
                        document.getElementById('tcoChampPreviewValuering2').value = champId;
                        document.getElementById('tcoChampPreviewCardring2').innerHTML = champCard;
                        tcoChampPresetData.previewChamp[t.champItemTypesForPreview['ring2']] = champId;
                        t.lastRing2 = champId;
                    } else {  //if both ring1 and ring2 are full, overwrite ring1
                        document.getElementById('tcoChampPreviewValuering1').value = champId;
                        document.getElementById('tcoChampPreviewCardring1').innerHTML = champCard;
                        tcoChampPresetData.previewChamp[t.champItemTypesForPreview['ring1']] = champId;
                        t.lastRing1 = champId;
                    }
                }
            }
        }
        SAVEtcoChampPresetData();
        document.getElementById('tcoChampPreviewDetails').innerHTML = t.getPreviewChampDetails();
    },

    getPreviewChampDetails: function () {
        var t = Tabs.champPreview;
        var previewPreset = [];
        for (var idx = 0; idx < tcoChampPresetData.previewChamp.length; idx++)
            if (tcoChampPresetData.previewChamp[idx] != 0) previewPreset.push(tcoChampPresetData.previewChamp[idx]);

        var stringPreviewChamp = GenerateChampPresetEffectsString(previewPreset, true);//GenerateThronePresetEffectsString(previewPreset);
        if (stringPreviewChamp == "") {
            stringPreviewChamp = "No Stats To Preview";
        } else {
            stringPreviewChamp = "<b>PREVIEW STATS:</b>\n" + stringPreviewChamp;
        }
        return stringPreviewChamp;
    },
}

Tabs.champCompare = {
	tabOrder: 100,
	tabLabel: 'COMPARE',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL COMPARE',

	init: function (div) {
		var t = Tabs.champCompare;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div>';
        m += '<center>';
        m += '<table>';

        m += '<tr>';
        m += '<td align=center><b>CARD 1</b></td>';
        m += '<td align=center><b>CARD 2</b></td>';
        m += '</tr>';

        m += '<tr>';
        m += '<td>';
        m += '<b>Item Type:</b><select class=tcoSelect id=tcoChampCompareType1 style="width: 40%;">';
        m += '<option value="0">--ALL--</option>';
        for (var champType in champItemNames) m += '<option value="' + champType + '">' + champItemNames[champType].capitalizeFirstLetter() + '</option>';
        m += '</select>';
        m += '</td>';
        m += '<td>';
        m += '<b>Item Type:</b><select class=tcoSelect id=tcoChampCompareType2 style="width: 40%;">';
        m += '<option value="0">--ALL--</option>';
        for (var champType in champItemNames) m += '<option value="' + champType + '">' + champItemNames[champType].capitalizeFirstLetter() + '</option>';
        m += '</select>';
        m += '</td>';
        m += '</tr>';

        m += '<tr>';
        m += '<td>';
        m += '<b>Champ Item:</b><br/><select class=tcoSelect id=tcoChampCompareId1 style="width: 95%;">';
        m += '<option value="0">--Items--</option>';
        for (var champId in uW.kocChampionItems) m += '<option value="' + champId + '">' + uW.kocChampionItems[champId].name + ' </option>';
        m += '</select>';
        m += '</td>';
        m += '<td>';
        m += '<b>Champ Item:</b><br/><select class=tcoSelect id=tcoChampCompareId2 style="width: 95%;">';
        m += '<option value="0">--Items--</option>';
        for (var champId in uW.kocChampionItems) m += '<option value="' + champId + '">' + uW.kocChampionItems[champId].name + ' </option>';
        m += '</select>';
        m += '</td>';
        m += '</tr>';

        m += '<tr>';
        m += '<td>';
        m += '<div id=tcoChampCompareCard1></div>';
        m += '</td>';
        m += '<td>';
        m += '<div id=tcoChampCompareCard2></div>';
        m += '</td>';
        m += '</tr>';

        m += '</table>';
        m += '</center>';
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoChampCompareId1').addEventListener('change', function () { t.loadCard(this, 'tcoChampCompareCard1'); }, false);

        document.getElementById('tcoChampCompareId2').addEventListener('change', function () { t.loadCard(this, 'tcoChampCompareCard2'); }, false);

        document.getElementById('tcoChampCompareId1').addEventListener('keyup', function () { t.loadCard(this, 'tcoChampCompareCard1'); }, false);

        document.getElementById('tcoChampCompareId2').addEventListener('keyup', function () { t.loadCard(this, 'tcoChampCompareCard2'); }, false);

        document.getElementById('tcoChampCompareType1').addEventListener('change', function () { t.filterItems(this, 'tcoChampCompareId1', 'tcoChampCompareCard1'); }, false);

        document.getElementById('tcoChampCompareType2').addEventListener('change', function () { t.filterItems(this, 'tcoChampCompareId2', 'tcoChampCompareCard2'); }, false);

        document.getElementById('tcoChampCompareType1').addEventListener('keyup', function () { t.filterItems(this, 'tcoChampCompareId1', 'tcoChampCompareCard1'); }, false);

        document.getElementById('tcoChampCompareType2').addEventListener('keyup', function () { t.filterItems(this, 'tcoChampCompareId2', 'tcoChampCompareCard2'); }, false);

    },

    sendToCompare: function (Id) {
        var t = Tabs.champCompare;
        var champItem = uW.kocChampionItems[Id];
        var card1 = document.getElementById('tcoChampCompareId1');
        var card2 = document.getElementById('tcoChampCompareId2');
        var obj = '';
        if (card1.value == 0)
            obj = '1';
        else if (card2.value == 0)
            obj = '2';
        else
            obj = '1';

        document.getElementById('tcoChampCompareType' + obj).value = champItem.type;
        t.filterItems(document.getElementById('tcoChampCompareType' + obj), ('tcoChampCompareId' + obj), ('tcoChampCompareCard' + obj));
        document.getElementById('tcoChampCompareId' + obj).value = Id;
        t.loadCard(document.getElementById('tcoChampCompareId' + obj), ('tcoChampCompareCard' + obj));
    },

    loadCard: function (objectItem, objectName) {
        var div = document.getElementById(objectName);
        if (objectItem.value == 0)
            div.innerHTML = '';
        else
            div.innerHTML = BuildChampCard(uW.kocChampionItems[objectItem.value]);
    },

    filterItems: function (objectItem, objectIdName, objectName) {
        document.getElementById(objectName).innerHTML = '';
        var select = document.getElementById(objectIdName);
        select.value = 0;
        var m = '<option value="0">--Items--</option>';
        if (objectItem.value == 0) {
            for (var champId in uW.kocChampionItems) {
                m += '<option value="' + champId + '">' + uW.kocChampionItems[champId].name + '</option>';
            }
        } else {
            for (var champId in uW.kocChampionItems) {
                if (uW.kocChampionItems[champId].type == objectItem.value)
                    m += '<option value="' + champId + '">' + uW.kocChampionItems[champId].name + '</option>';
            }
        }
        select.innerHTML = m;
    },


	hide: function () {},
	
	show: function () {},
}

Tabs.champUniques = {
	tabOrder: 100,
	tabLabel: 'UNIQUES',
	tabColor: 'brown',
    tabHeader: 'CHAMP HALL UNIQUES',
    UniqueItems : null,
    selectedCard: 0,
    selectedType: 0,
    selectedLevel: 1,
	
	init: function (div) {
		var t = Tabs.champUniques;
		t.mydiv = div;

        var UniqueItems = {};
        eval(GM_getResourceText("champion_uniques"));
        t.UniqueItems = UniqueItems;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*2.5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';

        m += '<center><table>';
        m += '<tr><td><div style="max-width:100%;"><b>Item Type:</b><select class=tcoSelect id=tcoChampUniqueType style="width: 40%;">';
        m += '<option value="0">--ALL--</option>';
        for (var champType in champItemNames) m += '<option value="' + champType + '">' + champItemNames[champType].capitalizeFirstLetter() + '</option>';
        m += '</select></div></td></tr>';

        m += '<tr><td><div style="max-width:100%;"><b>Champ Item:</b><br/><select class=tcoSelect id=tcoChampUnique style="width: 95%;">';
        m += '<option value="0">--Items--</option>';
        for (Id in t.UniqueItems) {
            var champItem = t.UniqueItems[Id];
            if (champItem == null || !champItem) continue;
            m += '<option value="' + Id + '">' + champItem.Name + ' </option>';
        }
        m += '</select></div></td></tr>';

        m += '<tr><td><div style="max-width:100%;"><b>Level:</b><select class=tcoSelect id=tcoChampUniqueLevel style="width: 40%;">';
        m += '<option value="1" selected>+1</option>';
        for (lvl = 2; lvl < tcoMaxChampLevel + 1; lvl++) m += '<option value="' + lvl + '">+' + lvl + '</option>';
        m += '</select></div></td></tr>';

        m += '<tr><td><div id=tcoChampUniqueCard></div></td></tr>';

        m += '</table>';

        m += '</div>';
		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoChampUniqueType').addEventListener('change', function () {
            t.selectedType = document.getElementById('tcoChampUniqueType').value;
            t.selectedCard = 0;
            t.FilterUniques();
            document.getElementById('tcoChampUniqueCard').innerHTML = '';
        }, false);

        document.getElementById('tcoChampUnique').addEventListener('change', function () {
            t.selectedCard = document.getElementById('tcoChampUnique').value;
            if (t.selectedCard != 0) t.SwitchUnique();
        }, false);

        document.getElementById('tcoChampUniqueLevel').addEventListener('change', function () {
            t.selectedLevel = document.getElementById('tcoChampUniqueLevel').value;
            if (t.selectedCard != 0) t.SwitchUnique();
        }, false);

	},
	
	hide: function () {},
	
	show: function () {},

    FilterUniques: function (cardType) {
        var t = Tabs.champUniques;
        var champList = document.getElementById('tcoChampUnique');
        champList.options.length = 0;
        var champOption = document.createElement('option');
        champOption.text = '--Items--';
        champOption.value = 0;
        champList.add(champOption);
        for (Id in t.UniqueItems) {
            var champItem = t.UniqueItems[Id];
            if (champItem == null || !champItem) continue;
            if (champItem.Type == t.selectedType || t.selectedType == 0) {
                var champOption = document.createElement('option');
                champOption.text = champItem.Name;
                champOption.value = Id;
                champList.add(champOption);
            }
        }
    },

    SwitchUnique: function () {
        var t = Tabs.champUniques;
        var div = document.getElementById('tcoChampUniqueCard');
        var m = ConvertUniqueAndBuildChampCard(t.selectedCard, t.selectedLevel);
        m += t.GetUniqueInventory(t.selectedCard);
        div.innerHTML = m;
    },


    GetUniqueInventory: function (uniqueId) {
        var m = '<br><b>Champ Hall</b><br>';
        var champitems = {};
        for (champId in uW.kocChampionItems) {
            var champItem = uW.kocChampionItems[champId];
            if (champItem.unique == uniqueId) {
                if (champitems[champItem.level]) {
                    champitems[champItem.level]++;
                } else {
                    champitems[champItem.level] = 1;
                }
            }
        }
        var gotitem = false;
        for (lvl in champitems) {
            gotitem = true;
            m += 'You have '+champitems[lvl]+' at level '+lvl+'<br>';
        }
        if (!gotitem) m += 'You have none in your throne room.<br>';
       
        m += '<br><b>Inventory</b><br>';
        var inventory = Seed.items['i'+uniqueId];
        m += 'You have '+(inventory?inventory:'none')+' in your inventory.';
        return m;
    },

}

Tabs.tcoLog = {
	tabOrder: 100,
	tabLabel: 'LOGS',
	tabColor: 'blue',
    tabHeader: 'LOGGING RECORDS',
	
	init: function (div) {
		var t = Tabs.tcoLog;
		t.mydiv = div;
       //t.buildLogDisplay();
	},
	
	hide: function () {},
	
    show: function () {
        var t = Tabs.tcoLog;
        t.buildLogDisplay();
    },

	buildLogDisplay: function () {
		var t = Tabs.tcoLog;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div style="margin-top: 5px; margin-bottom: 5px;">';
        m += '&nbsp;&nbsp;Max Log Entries Per Section <input type=textbox class=tcoTextbox id=tcoLogMaxEntries value="' + tcoLogData.maxEntries + '">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
        m += '<input type=button class=tcoButton id=tcoLogClear value="Clear Logs">';
        m += '</div>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;SUCCESS LOG&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="height: ' + (dlgHeight - 140) + 'px; width: ' + (dlgWidth - dlgWidthMenu - dlgWidthOffset) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        m += '<table class=tcoSectionTable id=tcoSuccessLog>';
        if (tcoLogData.successLog.length == 0) {
            m += '<tr><td>NO LOG DATA</td></tr>';
        } else {
            for (logIndex=0; logIndex < tcoLogData.successLog.length; logIndex++) {
                var logVar = tcoLogData.successLog[logIndex];
                //alert('success logVar = ' + logVar);

                var logDate = logVar.split(",")[0];
                var logMsg = logVar.split(",")[1];
                m += '<tr>';
                m += '<td width=20%>' + logDate + '</td>';
                m += '<td width=80%>' + logMsg + '</td>';
                m += '</tr>';
            }
        }
        m += '</table>';
        m += '</div>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;ACTION LOG&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="height: ' + (dlgHeight - 140) + 'px; width: ' + (dlgWidth - dlgWidthMenu - dlgWidthOffset) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        m += '<table class=tcoSectionTable id=tcoActionLog>';
        if (tcoLogData.actionLog.length == 0) {
            m += '<tr><td>NO LOG DATA</td></tr>';
        } else {
            for (logIndex=0; logIndex < tcoLogData.actionLog.length; logIndex++) {
                var logVar = tcoLogData.actionLog[logIndex];
                var logDate = logVar.split(",")[0];
                var logMsg = logVar.split(",")[1];
                m += '<tr>';
                m += '<td width=20%>' + logDate + '</td>';
                m += '<td width=80%>' + logMsg + '</td>';
                m += '</tr>';
            }
        }
        m += '</table>';
        m += '</div>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;SALVAGE LOG&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="height: ' + (dlgHeight - 140) + 'px; width: ' + (dlgWidth - dlgWidthMenu - dlgWidthOffset) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        m += '<table class=tcoSectionTable id=tcoSalvageLog>';
        if (tcoLogData.salvageLog.length == 0) {
            m += '<tr><td>NO LOG DATA</td></tr>';
        } else {
            for (logIndex=0; logIndex < tcoLogData.salvageLog.length; logIndex++) {
                var logVar = tcoLogData.salvageLog[logIndex];
                var logDate = logVar.split(",")[0];
                var logMsg = logVar.split(",")[1];
                m += '<tr>';
                m += '<td width=20%>' + logDate + '</td>';
                m += '<td width=80%>' + logMsg + '</td>';
                m += '</tr>';
            }
        }
        m += '</table>';
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }
        
        document.getElementById('tcoLogMaxEntries').addEventListener('change', function () {
            tcoLogData.maxEntries = parseInt(document.getElementById('tcoLogMaxEntries').value);
            SAVEtcoLogData();
            t.buildLogDisplay();
        }, false);

        document.getElementById('tcoLogClear').addEventListener('click', function () {
            tcoLogData.actionLog = [];
            tcoLogData.salvageLog = [];
            tcoLogData.successLog = [];
            SAVEtcoLogData();
            t.buildLogDisplay();
        }, false);

	},

    removeLogEntry: function (logValue) {
        if (logValue == logValues.SUCCESS) {
            while (tcoLogData.successLog.length >= tcoLogData.maxEntries) tcoLogData.successLog.pop();
        } else if (logValue == logValues.SALVAGE) {
            while (tcoLogData.salvageLog.length >= tcoLogData.maxEntries) tcoLogData.salvageLog.pop();
        } else if (logValue == logValues.ACTION) {
            while (tcoLogData.actionLog.length >= tcoLogData.maxEntries) tcoLogData.actionLog.pop();
        } else return;        
    },

    addLogEntry: function (logValue, msg) {
        var t = Tabs.tcoLog;
        if (logValue == logValues.SUCCESS) {
            if (tcoLogData.successLog.length >= tcoLogData.maxEntries) t.removeLogEntry(logValue);
            tcoLogData.successLog.unshift(t.createTimeStamp() + "," + msg);
        } else if (logValue == logValues.SALVAGE) {
            if (tcoLogData.salvageLog.length >= tcoLogData.maxEntries) t.removeLogEntry(logValue);
            tcoLogData.salvageLog.unshift(t.createTimeStamp() + "," + msg);
        } else if (logValue == logValues.ACTION) {
            if (tcoLogData.actionLog.length >= tcoLogData.maxEntries) t.removeLogEntry(logValue);
            tcoLogData.actionLog.unshift(t.createTimeStamp() + "," + msg);
        } else return;
        SAVEtcoLogData();
    },

    createTimeStamp: function () {
        var d = new Date();
        var ts = d.toDateString().substring(3,10) + " " + d.toTimeString().substring(0,8);
        return ts;
    },

}

Tabs.tcoOptions = {
	tabOrder: 100,
	tabLabel: 'OPTIONS',
	tabColor: 'blue',
    tabHeader: 'TCO OPTIONS',
	
	init: function (div) {
		var t = Tabs.tcoOptions;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '<div class=tcoSaveSettings id=tcoOptionsSaveSettings title="Save Options Settings"></div><div class=tcoLoadSettings id=tcoOptionsLoadSettings title="Load Options Settings"></div></div>';

       
        m += '<table class=tcoSectionTable>';
        m += '<tr><td width=100%><input class=tcoCheckbox id=tcoGlobalUpdate type=checkbox ' + (tcoGlobalOptions.update ? 'CHECKED ' : '') + '/>Check For Updates (All Domains) &nbsp; &nbsp; <input class=tcoButton id=tcoUpdateNow type=button value="Update Now" /></td></tr>';
        m += '<tr><td width=100%><input class=tcoCheckbox id=tcoDisableAnim type=checkbox ' + (tcoGeneralOptions.disableAnim ? 'CHECKED ' : '') + '/> Disable failure animation (Big red X) </td></tr>';
        m += '<tr><td><input class=tcoCheckbox id=tcoDraggableThroneItems type=checkbox ' + (tcoGeneralOptions.draggableThroneItems ? 'CHECKED ' : '') + '/> Enable draggable throne room items </td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoThroneSorter type=checkbox ' + (tcoGeneralOptions.throneSorter ? 'CHECKED ' : '') + '/> Enable throne sorter </td></tr>';
        m += '<tr><td><input class=tcoCheckbox id=tcoShowJewels type=checkbox ' + (tcoGeneralOptions.showJewels ? 'CHECKED ' : '') + '/> Show jewels icon in throne room inventory </td></tr> ';
        m += '</table>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;SALVAGER OPTIONS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';

        m += '<tr><td><b>Put Aetherstones: </b><div style="display: inline;" id=tcoSalvageCity></div></td></tr>';
        m += '<tr><td><div style="white-space: pre;" ><input class=tcoCheckbox id=tcoSalvageAnyCity type=checkbox ' + (tcoGeneralOptions.salvageAnyCity ? ' CHECKED' : '') + '> When Full, Put Aetherstones In Any City.</td></tr>';
        m += '<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maximum Number Of Aetherstones: <input class=tcoTextbox id=tcoMaxStones type=text size=7 maxlength=7 value="' + tcoGeneralOptions.maxStones + '"></div></td></tr>';
        m += '<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Overflow Method: <select class=tcoSelect id=tcoOverflow><option value="order" ' + (tcoGeneralOptions.overflow=='order' ? 'SELECTED' : '') + '>City Order</option><option value="lowest" ' + (tcoGeneralOptions.overflow=='lowest' ? 'SELECTED' : '') + '>Lowest City</option>  </select></td></tr>';
        m += '<tr><td><div>Load Throne Room Salvager Settings From Domain Number: <input class=tcoTextbox id=tcoThroneLoadDomain type=text size=3 maxlength=3 /><input class=tcoButton id=tcoThroneLoadDomainRules type=button value="Load"></div></td></tr>';
        m += '<tr><td><div>Load Champ Hall Salvager Settings From Domain Number: <input class=tcoTextbox id=tcoChampLoadDomain type=text size=3 maxlength=3 /><input class=tcoButton id=tcoChampLoadDomainRules type=button value="Load"></div></td></tr>';
        m += '<tr><td><div style="white-space: pre;" ><input class=tcoCheckbox id=tcoThroneSalvageUpgradeFirst type=checkbox ' + (tcoThroneSalvageData.upgradeFirst ? ' CHECKED' : '') + '> Upgrade Items To +1 Before Deleting.</td></tr>';
        m += '<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maximum Quality: <select class=tcoSelect id=tcoThroneUpgradeFirstQual>';
        for (qual = 0; qual < throneCardQualities.length; qual++) m += '<option value="' + qual + '" ' + (tcoThroneSalvageData.upgradeFirstQual == qual ? 'SELECTED' : '') + '>' + throneCardQualities[qual].capitalizeFirstLetter() + '</option>';
        m += '</select> (Throne Room Only)</td></tr>';
        m += '<tr><td><div style="white-space: pre;" ><input class=tcoCheckbox id=tcoThroneSalvageUpgradeManual type=checkbox ' + (tcoThroneSalvageData.upgradeManual ? ' CHECKED' : '') + '/> Upgrade Items To +1 On Manual Delete. (Throne Room Only)</td></tr>';

        m += '</table>';
        m += '</div>';


        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;ENHANCE/UPGRADE OPTIONS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';
        m += '<tr><td><b>Use Aetherstones: </b><div style="display: inline;" id=tcoUseCity></div></td></tr>';
        m += '<tr><td width=25%>Retry interval (seconds): <input class=tcoTextbox id=tcoRetryInterval type=text size=3 maxlength=3 value="' + tcoGeneralOptions.retryInterval + '"/></td></tr>';
        m += '<tr><td><div style="white-space: pre;"><input class=tcoCheckbox id=tcoUseAnyCity type=checkbox ' + (tcoGeneralOptions.useAnyCity ? ' CHECKED' : '') + '/> When Full, Use Aetherstones From Any City.</td></tr>';
        m += '<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Minimum Number Of Aetherstones: <input class=tcoTextbox id=tcoMinStones type=text size=7 maxlength=7 value="' + tcoGeneralOptions.minStones + '"/> </div></td></tr>';
        m += '<tr><td><input class=tcoCheckbox id=tcoWhisperCheck type=checkbox ' + (tcoGeneralOptions.whisperToMe ? 'CHECKED ' : '') + '/> Whisper Myself Successful Upgrades/Enhancements</td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoSendInbox type=checkbox ' + (tcoGeneralOptions.sendToInbox ? 'CHECKED ' : '') + '/> Send To Inbox Successful Upgrades/Enhancements</td></tr>';
        m += '<tr><td><input class=tcoCheckbox id=tcoSafetyCheck type=checkbox ' + (tcoGeneralOptions.safetyOn ? 'CHECKED ' : '') + '/> Disable Manual Upgrades If Less Than <input class=tcoTextbox type=text id=tcoSafetyLimit size=10 maxlength=10 value="' + tcoGeneralOptions.safetyLimit + '"> Aetherstone</td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoBuffsCheck type=checkbox ' + (tcoGeneralOptions.buffsOff ? 'CHECKED ' : '') + '/> Prevent Automatic Upgrade Token Selection (Throne Room Only)</td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoMastersTokenCheck type=checkbox ' + (tcoGeneralOptions.removeMastersTokens ? 'CHECKED ' : '') + '/> Remove Master & Lucky Tokens From Upgrade Panel (Throne Room Only)</td></tr>';
        m += '<tr><td><input class=tcoCheckbox id=tcoOtherTokenCheck type=checkbox ' + (tcoGeneralOptions.removeOtherTokens ? 'CHECKED ' : '') + '/> Remove All Other Tokens From Upgrade Panel (Not LLT Or Stones) (Throne Room Only)</td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoUseMastersToken type=checkbox ' + (tcoGeneralOptions.useMastersTokens ? 'CHECKED ' : '') + '/> Use Next Masters On Manual Upgrade (Overrides Above 2 Options If Checked, Throne Room Only) </td></tr> ';
        //m += '<tr><td><input class=tcoCheckbox id=tcoMultiUpgrade type=checkbox ' + (tcoGeneralOptions.multiUpgrade ? 'CHECKED ' : '') + '/> Add Button For Combined Upgrade/Enhancement (Throne Room Only)</td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoNoEquippedSalvage type=checkbox ' + (tcoGeneralOptions.noEquippedSalvage ? 'CHECKED ' : '') + '/> Remove Salvage Button When Item Is Equipped In Any Slot</td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoNoMassSalvage type=checkbox ' + (tcoGeneralOptions.noMassSalvage ? 'CHECKED ' : '') + '/> Remove Mass Salvage Button</td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoNoForcedSalvage type=checkbox ' + (tcoGeneralOptions.noForcedSalvage ? 'CHECKED ' : '') + '/> Remove Forced Salvage Button (Throne Room Only)</td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoThroneSalvageSafety type=checkbox ' + (tcoGeneralOptions.throneSalvageSafety ? 'CHECKED ' : '') + '/> Remove Salvage Button For 1st <input class=tcoTextbox id=tcoThroneSafetyNum type=text size=3 maxlength=3 value="' + tcoGeneralOptions.throneSalvageSafetyNum + '"> Throne Room Items</td></tr> ';
        m += '<tr><td><input class=tcoCheckbox id=tcoChampSalvageSafety type=checkbox ' + (tcoGeneralOptions.champSalvageSafety ? 'CHECKED ' : '') + '/> Remove Salvage Button For 1st <input class=tcoTextbox id=tcoChampSafetyNum type=text size=3 maxlength=3 value="' + tcoGeneralOptions.champSalvageSafetyNum + '"> Champion Items</td></tr> ';
        m += '</table>';
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoOptionsSaveSettings').addEventListener('click', function () {
            SaveSettingsToFile(tcoGeneralOptions);
        }, false);
        document.getElementById('tcoOptionsLoadSettings').addEventListener('click', function () {
            var loader = document.getElementById('tcoSettingsFile');
            loader.addEventListener('change', function () {
                LoadSettingsFromFile(tcoGeneralOptions, Tabs.tcoOptions);
            }, false);
            loader.click();
        }, false);

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }
        
        new CdispCityPicker('salcitysel', document.getElementById('tcoSalvageCity'), true, t.SalvageCityButton, tcoGeneralOptions.salvageCityNum);
        new CdispCityPicker('upcitysel', document.getElementById('tcoUseCity'), true, t.UsedCityButton, tcoGeneralOptions.usedCityNum);

        document.getElementById('tcoSendInbox').addEventListener('change', function () {
            tcoGeneralOptions.sendToInbox = document.getElementById('tcoSendInbox').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoShowJewels').addEventListener('change', function () {
            tcoGeneralOptions.showJewels = document.getElementById('tcoShowJewels').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoMinStones').addEventListener('change', function () {
            tcoGeneralOptions.minStones = document.getElementById('tcoMinStones').value;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoOverflow').addEventListener('change', function () {
            tcoGeneralOptions.overflow = document.getElementById('tcoOverflow').value;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoMaxStones').addEventListener('change', function () {
            tcoGeneralOptions.maxStones = document.getElementById('tcoMaxStones').value;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoUseAnyCity').addEventListener('change', function () {
            tcoGeneralOptions.useAnyCity = document.getElementById('tcoUseAnyCity').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoThroneSalvageUpgradeFirst').addEventListener('change', function () {
            tcoThroneSalvageData.upgradeFirst = document.getElementById('tcoThroneSalvageUpgradeFirst').checked;
            SAVEtcoThroneSalvageData();
        }, false);

        document.getElementById('tcoThroneUpgradeFirstQual').addEventListener('change', function () {
            tcoThroneSalvageData.upgradeFirstQual = document.getElementById('tcoThroneUpgradeFirstQual').value;
            SAVEtcoThroneSalvageData();
        }, false);

        document.getElementById('tcoThroneSalvageUpgradeManual').addEventListener('change', function () {
            tcoThroneSalvageData.upgradeManual = document.getElementById('tcoThroneSalvageUpgradeManual').checked;
            SAVEtcoThroneSalvageData();
        }, false);

        document.getElementById('tcoSalvageAnyCity').addEventListener('change', function () {
            tcoGeneralOptions.salvageAnyCity = document.getElementById('tcoSalvageAnyCity').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoRetryInterval').addEventListener('change', function () {
            tcoGeneralOptions.retryInterval = parseInt(document.getElementById('tcoRetryInterval').value);
            if (tcoGeneralOptions.retryInterval < 15) tcoGeneralOptions.retryInterval = 15;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoThroneSafetyNum').addEventListener('change', function () {
            tcoGeneralOptions.throneSalvageSafetyNum = parseInt(document.getElementById('tcoThroneSafetyNum').value);
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoChampSafetyNum').addEventListener('change', function () {
            tcoGeneralOptions.champSalvageSafetyNum = parseInt(document.getElementById('tcoChampSafetyNum').value);
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoBuffsCheck').addEventListener('change', function () {
            tcoGeneralOptions.buffsOff = document.getElementById('tcoBuffsCheck').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoSafetyLimit').addEventListener('change', function () {
            tcoGeneralOptions.safetyLimit = parseInt(document.getElementById('tcoSafetyLimit').value);
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoDisableAnim').addEventListener('change', function () {
            tcoGeneralOptions.disableAnim = document.getElementById('tcoDisableAnim').checked;
            disableAnimation(tcoGeneralOptions.disableAnim);
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoThroneSorter').addEventListener('change', function () {
            tcoGeneralOptions.throneSorter = document.getElementById('tcoThroneSorter').checked;
            SAVEtcoGeneralOptions();
            var cmContainerOpen = (document.getElementsByClassName('cmModalContainer').length == 1 ? true : false);
            if (cmContainerOpen) {
                var titlebar = document.getElementsByClassName('primarytitlebar')[0];
                var closebutton = titlebar.children[2];
                closebutton.click();
                setTimeout(function () { CM.ThroneView.openThrone(); }, 100);
            }
        }, false);

        document.getElementById('tcoDraggableThroneItems').addEventListener('change', function () {
            tcoGeneralOptions.draggableThroneItems = document.getElementById('tcoDraggableThroneItems').checked;
            SAVEtcoGeneralOptions();
        }, false);
       
        document.getElementById('tcoWhisperCheck').addEventListener('change', function () {
            tcoGeneralOptions.whisperToMe = document.getElementById('tcoWhisperCheck').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoSafetyCheck').addEventListener('change', function () {
            tcoGeneralOptions.safetyOn = document.getElementById('tcoSafetyCheck').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoMastersTokenCheck').addEventListener('change', function () {
            tcoGeneralOptions.removeMastersTokens = document.getElementById('tcoMastersTokenCheck').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoOtherTokenCheck').addEventListener('change', function () {
            tcoGeneralOptions.removeOtherTokens = document.getElementById('tcoOtherTokenCheck').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoUseMastersToken').addEventListener('change', function () {
            tcoGeneralOptions.useMastersTokens = document.getElementById('tcoUseMastersToken').checked;
            SAVEtcoGeneralOptions();
        }, false);

//        document.getElementById('tcoMultiUpgrade').addEventListener('change', function () {
//            tcoGeneralOptions.multiUpgrade = document.getElementById('tcoMultiUpgrade').checked;
//            SAVEtcoGeneralOptions();
//        }, false);

        document.getElementById('tcoNoForcedSalvage').addEventListener('change', function () {
            tcoGeneralOptions.noForcedSalvage = document.getElementById('tcoNoForcedSalvage').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoNoEquippedSalvage').addEventListener('change', function () {
            tcoGeneralOptions.noEquippedSalvage = document.getElementById('tcoNoEquippedSalvage').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoNoMassSalvage').addEventListener('change', function () {
            tcoGeneralOptions.noMassSalvage = document.getElementById('tcoNoMassSalvage').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoThroneSalvageSafety').addEventListener('change', function () {
            tcoGeneralOptions.throneSalvageSafety = document.getElementById('tcoThroneSalvageSafety').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoChampSalvageSafety').addEventListener('change', function () {
            tcoGeneralOptions.champSalvageSafety = document.getElementById('tcoChampSalvageSafety').checked;
            SAVEtcoGeneralOptions();
        }, false);

        document.getElementById('tcoThroneLoadDomainRules').addEventListener('click', function () {
            var d = document.getElementById('tcoThroneLoadDomain').value;
            if (d != null) ThroneLoadDomainSalvageData(d);
        }, false);

        document.getElementById('tcoChampLoadDomainRules').addEventListener('click', function () {
            var d = document.getElementById('tcoChampLoadDomain').value;
            if (d != null) ChampLoadDomainSalvageData(d);
        }, false);

        document.getElementById('tcoGlobalUpdate').addEventListener('change', function () {
            tcoGlobalOptions.update = document.getElementById('tcoGlobalUpdate').checked;
            SAVEtcoGlobalOptions();
        }, false);

        document.getElementById('tcoUpdateNow').addEventListener('click', function () { 
            AutoUpdater.call(true,true);
        }, false);

        disableAnimation(tcoGeneralOptions.disableAnim);
	},
	
	hide: function () {},
	
	show: function () {},

    SalvageCityButton: function (city, x, y) {
        tcoGeneralOptions.salvageCityNum = city.idx;
        SAVEtcoGeneralOptions();
    },

    UsedCityButton: function (city, x, y) {
        tcoGeneralOptions.usedCityNum = city.idx;
        SAVEtcoGeneralOptions();
    },
}

Tabs.tcoJewels = {
	tabOrder: 100,
	tabLabel: 'JEWELS',
	tabColor: 'blue',
    tabHeader: 'JEWEL ORGANIZER',
    jewelEffects: [],
    totalInventroy: 0,
    inventoryList: [],

	init: function (div) {
		var t = Tabs.tcoJewels;
		t.mydiv = div;
	},
	
	hide: function () {},
	
	show: function () {
		var t = Tabs.tcoJewels;

        t.buildJewelList();

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';
        
        m += '<table class=tcoSectionTable>';

        m += '<tr><td><b>Effects</b></td><td><b>Quality</b></td></tr>';

        m += '<tr>';
        m += '<td><div id=tcoJewelEffectFilterRow style="float: left; width: 250px; border:2px solid #ccc; height: 110px; overflow-y: scroll; background-color: white;">';
        for (fx in t.jewelEffects) {
            var effect = t.jewelEffects[fx];
            effect = effect.split(' ').join('');
            effect = effect.split('.').join('');
            m += '<input class=tcoCheckbox id=tcoJewelEffect' + effect + ' type=checkbox  CHECKED />' + t.jewelEffects[fx] + '<br />';

        }
        m += '</div></td>';

        m += '<td><div id=tcoJewelQualityFilterRow style="float: left; width: 120px; border:2px solid #ccc; height: 110px; overflow-y: scroll; background-color: white;">';
        for (jwl in tcoJewelQualities) {
            m += '<input class=tcoCheckbox id=tcoJewelQuality' + tcoJewelQualities[jwl].capitalizeFirstLetter() + ' type=checkbox  CHECKED />' + tcoJewelQualities[jwl].capitalizeFirstLetter() + '<br />';
        }
        m += '</div></td>';
        m += '</tr>';

        m += '<tr><td><input style="width:120px;" class=tcoButton type=button id=tcoJewelEffectsUnselectAll value="Unselect All"></td>';
        m += '<td><input style="width:120px;" class=tcoButton type=button id=tcoJewelQualitiesUnselectAll value="Unselect All"></td></tr>';
        m += '<tr><td><input style="width:120px;" class=tcoButton type=button id=tcoJewelEffectsSelectAll value="Select All"></td>';
        m += '<td><input style="width:120px;" class=tcoButton type=button id=tcoJewelQualitiesSelectAll value="Select All"></td></tr>';

        m += '<tr><td colspan=2 align=center><div class=divNoWrap id=tcoJewelBuffFilterRow><input id=tcoJewelBuff' + true + ' type=checkbox  CHECKED />Buff&nbsp;&nbsp;<input id=tcoJewelBuff' + false + ' type=checkbox  CHECKED />Debuff</div></td></tr>';


        m += '</table></div>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;JEWEL INVENTORY&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';

        m += '<table cellpadding=0 cellspacing=0 width=100%>';
        m += '<thead>';
        m += '<tr>';
        m += '<th align=left width=60%>Effect</th>';
        m += '<th align=left width=10%>Quality</th>';
        m += '<th align=left width=10%>Type</th>';
        m += '<th align=center width=10%>Amount</th>';
        m += '<th align=center width=10%>In Stock</th>';
        m += '</tr>';
        m += '</thead>';
        m += '</table>';

        m += '<div style="position: static; width: 100%; height: 225px; overflow-x: hidden; overflow-y: auto;">';

        m += '<table id=tcoJewelInventory cellpadding=0 cellspacing=0 width=100%>';

        m += '<tbody>';
        m += '</tbody>';
        m += '</table>';

        m += '</div>';
        m += '<hr/>';
        m += '<input class=tcoButton id=tcoJewelRefresh type=button value="Refresh"/>&nbsp;<i>(new jewels found may take a couple seconds to add to total)</i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Total:</b><div class=divNoWrap id=tcoJewelTotal></div>';
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

        t.buildInventory();

        document.getElementById('tcoJewelEffectFilterRow').addEventListener('change', function () {
            t.buildInventory();
        }, false);

        document.getElementById('tcoJewelQualityFilterRow').addEventListener('change', function () {
            t.buildInventory();
        }, false);

        document.getElementById('tcoJewelBuffFilterRow').addEventListener('change', function () {
            t.buildInventory();
        }, false);

        document.getElementById('tcoJewelRefresh').addEventListener('click', function () {
            t.buildJewelList();
            t.buildInventory();
        }, false);

        document.getElementById('tcoJewelQualitiesUnselectAll').addEventListener('click', function () {
            for (qly in tcoJewelQualities) {
                var quality = tcoJewelQualities[qly];
                var ch = document.getElementById("tcoJewelQuality" + quality.capitalizeFirstLetter());
                ch.checked = false;
            }
            t.buildInventory();
        }, false);

        document.getElementById('tcoJewelQualitiesSelectAll').addEventListener('click', function () {
            for (qly in tcoJewelQualities) {
                var quality = tcoJewelQualities[qly];
                var ch = document.getElementById("tcoJewelQuality" + quality.capitalizeFirstLetter());
                ch.checked = true;
            }
            t.buildInventory();
        }, false);

        document.getElementById('tcoJewelEffectsUnselectAll').addEventListener('click', function () {
            for (ef in t.jewelEffects) {
                var effect = t.jewelEffects[ef];
                effect = effect.split(' ').join('');
                effect = effect.split('.').join('');
                var ch = document.getElementById("tcoJewelEffect" + effect);
                ch.checked = false;
            }
            t.buildInventory();
        }, false);

        document.getElementById('tcoJewelEffectsSelectAll').addEventListener('click', function () {
            for (ef in t.jewelEffects) {
                var effect = t.jewelEffects[ef];
                effect = effect.split(' ').join('');
                effect = effect.split('.').join('');
                var ch = document.getElementById("tcoJewelEffect" + effect);
                ch.checked = true;
            }
            t.buildInventory();
        }, false);

	},

    addJewel: function (jewel_id, jewel_quality, throne_item_id) {
        var params = uW.Object.clone(ajfx);
        params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';
        params.action = 'addJewel';
        params.itemId = throne_item_id;
        params.quality = jewel_quality;
        params.effectId = jewel_id;

        new AjaxRequest(uW.g_ajaxpath + "ajax/_dispatch53.php" + uW.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            loading: true,
            onSuccess: function (transport) {
                try {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                    }
                    else {
                        return 'Error Adding Jewel';
                    }
                } catch (e) {
                }
                return;
            },
            onFailure: function (rst) {
                return;
            }
        });
        CM.ThronePanelView.removeSpinny();
    },

    removeJewel: function (city_id, throne_item_id) {
        var params = uW.Object.clone(ajfx);
        params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';
        params.action = 'removeJewel';
        params.cityId = city_id;
        params.itemId = throne_item_id;

        new AjaxRequest(uW.g_ajaxpath + "ajax/_dispatch53.php" + uW.g_ajaxsuffix, {
            method: "post",
            parameters: params,
            loading: true,
            onSuccess: function (transport) {
                try {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        var astone_gain = rslt.aetherstones * -1;
                        Seed.resources["city" + rslt.cityId]["rec5"][0] += astone_gain;
                    } else {
                        return 'Error Removing Jewel';
                    }
                } catch (e) {
                }
                return;
            },
            onFailure: function (rst) {
                return;
            }
        });
        CM.ThronePanelView.removeSpinny();
    },

    buildInventory: function () {
        var t = Tabs.tcoJewels;
        var inv = "";

        for (i = 0; i < t.inventoryList.length; i++) {

            var jewel_item = t.inventoryList[i];
            var qlty = CM.thronestats.jewelGrowthLimit[jewel_item.quality];
            var amt = CM.ThroneController.getEffectAmount(jewel_item, qlty);
            var name = CM.ThroneController.jewelName(jewel_item);
            var buffed = true;
            if (name.indexOf("Debuff") > 0) buffed = false;
            var effect = CM.ThroneController.getEffectName(jewel_item.id);
            var qty = CM.ThroneController.getJewelQuantity(jewel_item);
            var qualityName = CM.ThroneController.jewelQualityName(jewel_item.quality);
            var tmpEffect = CM.ThroneController.getEffectName(jewel_item.id);
            tmpEffect = tmpEffect.split(' ').join('');
            tmpEffect = tmpEffect.split('.').join('');
            if (!(document.getElementById('tcoJewelEffect' + tmpEffect).checked)) continue;
            if (!(document.getElementById('tcoJewelQuality' + qualityName).checked)) continue;
            if (!(document.getElementById('tcoJewelBuff' + buffed).checked)) continue;
            
            inv += '<tr><td width=62%>' + effect + '</td>';
            inv += '<td width=10%>' + qualityName + '</td>';
            inv += '<td width=10%>' + (buffed ? 'Buff ' : 'Debuff') + '</td>';
            inv += '<td align=center width=10%>' + amt + '%</td>';
            inv += '<td align=right width=8%>' + qty + '</td></tr>';

        }

        var jwl_inv = document.getElementById('tcoJewelInventory').tBodies[0];
        jwl_inv.innerHTML = inv;

        var jwl_total = document.getElementById('tcoJewelTotal');
        jwl_total.innerHTML = t.totalInventroy;

    },

    buildJewelList: function () {
        var t = Tabs.tcoJewels;
        t.inventoryList = [];
        t.totalInventroy = 0;
        for (var jwl in uW.kocJewelItems) {
            var jewel_item = uW.kocJewelItems[jwl];
            var qlty = CM.thronestats.jewelGrowthLimit[jewel_item.quality];
            var amt = CM.ThroneController.getEffectAmount(jewel_item, qlty);
            var effect = CM.ThroneController.getEffectName(jewel_item.id);
            if (amt == 0) break;
            if (t.jewelEffects.indexOf(effect) < 0) t.jewelEffects.push(effect);
            var jewel_quantity = CM.ThroneController.getJewelQuantity(jewel_item);
            t.totalInventroy += jewel_quantity;
            t.inventoryList.push(jewel_item);
        }
    },
}

Tabs.tcoNews = {
	tabOrder: 100,
	tabLabel: 'NEWS',
	tabColor: 'blue',
    tabHeader: 'BREAKING NEWS',
	
	init: function (div) {
		var t = Tabs.tcoNews;
		t.mydiv = div;
		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<table cellpadding=0 cellspacing=0 width=100% height=35px>';
        m += '<tr><td align=center>';
        m += '<a href="https://www.facebook.com/tco4koc" target="_BLANK" style="font-family: tahoma,verdana,arial,sans-serif; font-size: 11px; font-variant: normal; font-style: normal; font-weight: normal; color: #3B5998; text-decoration: none;" title="KoC Throne &amp; Champ Organizer by Ne0"><img src="https://www.facebookbrand.com/img/assets/asset.find.us.on.facebook.lg.png" style="border: 0px;" /></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
        m += '<iframe src="//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Ftco4koc&amp;width&amp;layout=standard&amp;action=like&amp;show_faces=false&amp;share=true&amp;height=15" scrolling="no" frameborder="0" style="border:none; overflow:hidden; height:15px;" allowTransparency="true"></iframe>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
        m += '</td></tr>';
        m += '<tr></tr><tr><td align=center><b>THANK YOU FOR ALL YOUR SUPPORT & DONATIONS!</b></td></tr>';
        m += '</table>';
        m += '<div style="height: ' + (dlgHeight - (dlgHeightOffset*5)) + 'px; width: ' + (dlgWidth - dlgWidthMenu) + 'px; margin-top:5px; margin-bottom:5px; overflow-x: auto; overflow-y: auto; position: static;">';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;WHATS NEW&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="position: static; width: 100%; overflow-x: auto; overflow-y: auto;">';
        m += '<table class=tcoSectionTable>';
        m += NewsItemRow('added clear all rules to salvager tabs');
        m += NewsItemRow('auto load advanced throne salvage rules by max 1 effect (request Karen Dent)');
        m += NewsItemRow('fixed the masters token image to set right on next upgrade token');
        m += NewsItemRow('added a TCO button in the champ area to pop up the TCO box (requested Toad Buxton)');
        m += NewsItemRow('repositioned the POST button in the champ area');
        m += NewsItemRow('added "sorter" feature that allows you to re-order your throne card tiles');
        m += NewsItemRow('added autobuild preview throne room by effect (requested Craig Bartlett)');
        m += NewsItemRow('added "send to compare" on context menu to put card into compare tab');
        m += NewsItemRow('added compare feature for champs');
        m += NewsItemRow('added new option to remove salvage button if a card is equipped in any slots');
        m += NewsItemRow('added a note on context menu for throne cards indicating preset attachment');
        m += NewsItemRow('added a note on context menu for champ cards indicating champ attachment');
        m += NewsItemRow('added champ uniques tabs (thanks Barbarossa for supplying the data)');
        m += NewsItemRow('added ability to edit existing champ and throne rules in salvager');
        m += NewsItemRow('redesigned context menus for card modification');
        m += NewsItemRow('added saving/loading settings for upgrader/repair/preset tabs; also general options');
        m += NewsItemRow('added a filter by effect option in the throne and champ organizer tabs');
        m += NewsItemRow('temporarily removed jewel salvaging');
        m += NewsItemRow('restructured logs so you can make them expandable');
        m += NewsItemRow('OVERHAULED THE OLD THRONE/CHAMP SCRIPT, and gave it a new name "TCO"');
        m += '</table>';
        m += '</div>';
        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;THE OLD SCRIPT&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection style="position: static; width: 100%; height: 400px; overflow-x: auto; overflow-y: auto;">';
        m += '<table class=tcoSectionTable>';
        m += NewsItemRow('MARCH 2014 - OCTOBER 2015');
        m += NewsItemRow('added some missing champ effects for rule making');
        m += NewsItemRow('opened context menu for champ rings');
        m += NewsItemRow('fixed champ organizer to read only ONE ring (to rule them all!!! lol) instead of 2');
        m += NewsItemRow('post to chat reads ring instead of ring 1');
        m += NewsItemRow('rules for champs will search for ring, not ring 1 or ring 2');
        m += NewsItemRow('removed greaseyfork as the main download for updates, it will now update straight from my website');
        m += NewsItemRow('fixed the enhancement/upgrading statistics pages, did not realize they were not pushed for higher levels');
        m += NewsItemRow('got rid of the useless bacon phrase, sorry everyone, trying to keep relavent for my future revamp');
        m += NewsItemRow('added an "upgrade all to level" option, for those events that are garunteed upgrade to a certain level');
        m += NewsItemRow('removed selectable site to update, updates only on greaseyfork at this time');
        m += NewsItemRow('added the ability to remove the new "chance" upgrade tokens from the dropdown');
        m += NewsItemRow('updated some links and added Aderiks slideshow links');
        m += NewsItemRow('fixed the disabling of upgrade button when below the safety threshold defined by user');
        m += NewsItemRow('made auto selecting next masters token on manual upgrade');
        m += NewsItemRow('added "tag all" to throne/champ inventory, this tags everything with a generic tag (requested by Sam Adams)');
        m += NewsItemRow('WARNING!!!: changes in game code have caused disabling the upgrade button when below threshold to not work');
        m += NewsItemRow('fixed preset tagging to include the new 8 rows');
        m += NewsItemRow('fixed the new 8 row preset glitch that causes the last card collection row to cut off (thanks Barbarossa Smith)');
        m += NewsItemRow('fixed so higher master tokens would show when disabling them');
        m += NewsItemRow('added the 8 new throne presets to the widget');
        m += NewsItemRow('removed the "Disable success animation" which i left in by mistake while testing a few releases ago');
        m += NewsItemRow('fixed the images due to kabam changing their image host');
        m += NewsItemRow('fixed the images links on the uniques throne pictures as well');
        m += NewsItemRow('fixed for missing throne uniques');
        m += NewsItemRow('added "clear stats" buttons to all 4 stats tabs so you can reset the stats (requested by Shadows)');
        m += NewsItemRow('made the popup menu for pendants available in champs');
        m += NewsItemRow('kabam changed code on side bar in throne panel, had to adjust code to fix it');
        m += NewsItemRow('fixed glitch when you click next on throne card it would only show in compact view');
        m += NewsItemRow('fixed glitch when deleting throne/champ rules when sorted (requested by Corinne Morris)');
        m += NewsItemRow('added break individual equipped throne room (requested by Ron Moe)');
        m += NewsItemRow('added break individual tagged presest throne room (requested by Ron Moe)');
        m += NewsItemRow('added break throne room to a certain might level');
        m += NewsItemRow('added throne/champ preview tab export to excel (thanks Barbarossa Smith)');
        m += NewsItemRow('added export tagged presets to file (requested by Jaddoo Emmanuel)');
        m += NewsItemRow('fixed some display issues where sometimes you can only see the first 3 lines of a card');
        m += NewsItemRow('fixed effects dropdown for champ organizer, where it was showing both buff and debuff for effect names');
        m += NewsItemRow('removed clearing of the name from throne presets when you click "clear" (request by  Wendy Taylor)');
        m += NewsItemRow('updated the change level when upgrading if you complete a level but want to go to another level on the same champ card (thanks Audrius Audriulaitis)');
        m += NewsItemRow('updated advanced throne rules for new findings (thanks again Gunvald Storheil)');
        m += NewsItemRow('updated link to Gunvalds spreadsheet on google');
        m += NewsItemRow('added "any tower" to the salvage rules');
        m += NewsItemRow('added damage back to the searchable champ stats even though it is only in weapon slot 1');
        m += NewsItemRow('added options to show/hide preset names and might when posting to chat [find under preset tabs]');
        m += NewsItemRow('added posting to chat, throne slots AND preset slots for throne rooms without room being active');
        m += NewsItemRow('added posting to chat, champ slots AND preset slots for champ halls without hall being active');
        m += NewsItemRow('added advanced rules for pillar');
        m += NewsItemRow('added advanced rules section for champs');
        m += NewsItemRow('added new throne item "pillar"');
        m += NewsItemRow('fixed outlining of champ upgrade/enhance');
        m += NewsItemRow('i believe i fixed the champ might display');
        m += NewsItemRow('fixed the salvage routine to make cloaks work properly');
        m += NewsItemRow('added champ preview tab');
        m += NewsItemRow('added a useless bacon phrase button as a joke for those bacon lovers who keep asking me for bacon stuff in the script');
        m += NewsItemRow('script will now update new levels and qualities as kabam adds more, without a physical update from me');
        m += NewsItemRow('added under the break throne/champ sections how much might is broken (requested by Antwyn Collins)');
        m += NewsItemRow('added total champ might to the champion hall (requested by Kenneth Tompkins)');
        m += NewsItemRow('added total champ might to the display when posting champ stats');
        m += NewsItemRow('fixed some issues with unequip all, equip from preset and the copy feature for preset tags');
        m += NewsItemRow('added a confirmation prompt to the break throne/champ buttons in case you hit them by accident');
        m += NewsItemRow('added a "below" criteria for breaking throne/champ rooms (requested by Barrie Morris)');
        m += NewsItemRow('added champ hall repair tab');
        m += NewsItemRow('extended champ to level 14');
        m += NewsItemRow('made throne/champ organizer display over all other bots (requested by Eric Wong)');
        m += NewsItemRow('fixed some issues with horizontal spacing at the item selection for upgraders (requested by Eric Wong)');
        m += NewsItemRow('added champ preset tagging');
        m += NewsItemRow('added break champion hall');
        m += NewsItemRow('added "unequip all" to champs');
        m += NewsItemRow('added sort order to throne/champ salvager rules by card type (requested by Audrius Audriulaitis)');
        m += NewsItemRow('added more hourglasses (requested by Henriette Paagh)');
        m += NewsItemRow('added "no forced salvage" option to hide that feature if you want (requested by Jeffrey Donati)');
        m += NewsItemRow('updated advanced salvager rules to include most recent updated info from spreadsheet');
        m += NewsItemRow('moved the delete button for upgrader queue to the left, hopefully clearing up scrolling issues');
        m += NewsItemRow('added an "advanced rule" creater to salvage tab (requested by Jaddoo Emmanuel)');
        m += NewsItemRow('added the ability to take all throne/champ items from one quality to another quality (requested by Gary Cummins)');
        m += NewsItemRow('added a tutorial tab for the throne/champ tutorials');
        m += NewsItemRow('added custom color choosing for the tabs');
        m += NewsItemRow('added export preview throne setup to file (requested by Kenneth Tompkins)');
        m += NewsItemRow('added a throne uniques tab (thanks to Barbarossa Smith)');
        m += NewsItemRow('changed tab colors (throne = green, champ = purple, bot = blue)');
        m += NewsItemRow('with the change in tabs, I relabeled them and added hover title tooltip');
        m += NewsItemRow('added "forced salvage" to the context menu, this will salvage an item even with a jewel');
        m += NewsItemRow('fixed custom champ salvage button');
        m += NewsItemRow('added back the column view in champ organizer, just like throne organizer you now have the compact option');
        m += NewsItemRow('added export to excel file for throne AND champ inventory (requested by Leslie Grilley)');
        m += NewsItemRow('added "Any Spellcaster" to the throne room rules (requested by Onebiggoxx Baker)');
        m += NewsItemRow('fixed (hopefully) the auto update');
        m += NewsItemRow('fixed the custom enhance/upgrade yellow buttons for champ context menu');
        m += NewsItemRow('added a salvage button to the custom context menu for champs');
        m += NewsItemRow('added the ability to take all champ items of one level to another level');
        m += NewsItemRow('fixed sizing issue with throne organizer when in 11 column view');
        m += NewsItemRow('added a repair throne item by level option to repair tab (requested by Peter Johnston)');
        m += NewsItemRow('added back the 11 column view of throne organizer, BUT with an option to switch to compact view');
        m += NewsItemRow('added the ability to take all throne items of one level to another level (requested by Ian Broadbent)');
        m += NewsItemRow('added contextmenu to the champ item images');
        m += NewsItemRow('added check to remove auto-enhance/upgrade if champ item is already at max rarity/level');
        m += NewsItemRow('added menu on champ organizer when you select a card, just like throne organizer (requested by Robert Jon)');
        m += NewsItemRow('fixed more bugs');
        m += NewsItemRow('fixed problem with the images in throne room where the context menu would not work after switching thrones');
        m += NewsItemRow('fixed the glitches that were causing the bot to crash while using the repair tab (lets cross our fingers!)');
        m += NewsItemRow('added horizontal scroll bar to upgrader and repair queue lists');
        m += NewsItemRow('fixed the champion card posting to chat and copying to clipboard');
        m += NewsItemRow('fixed the preview stats loading in preview tr tab, after breaking it on my last update');
        m += NewsItemRow('added back the "active" highlights to equipped cards in the organizer tab, but only while using the graphic view option');
        m += NewsItemRow('fixed the display of uniques name in the textual display of throne cards (in preview, compare and organizer tab)');
        m += NewsItemRow('added option to select the new textual display or the old graphical display for viewing cards');
        m += NewsItemRow('reduced the number of repaints to each card in preview tr, which i believe was causing so many crashes');
        m += NewsItemRow('added hover tooltip for champ card while in the champ upgrader and organizer tabs');
        m += NewsItemRow('added context menu for throne cards in both compare tr tabs');
        m += NewsItemRow('revamped throne room organizer tab to be more compact');
        m += NewsItemRow('revamped champ room organizer tab to be more compact');
        m += NewsItemRow('added more filters for champ in the organizer tab');
        m += NewsItemRow('revamped size of the tr/champ bot so it should now fit on a screen even if you do not use widescreen mode');
        m += NewsItemRow('revamped preview tr and compare tr visual display to make more compact and save space, also added card hover tooltip');
        m += NewsItemRow('added repair tab as optional for showing/hiding');
        m += NewsItemRow('added "post stats to chat" for the preview tr tab (requested by Rodney Lamontagne)');
        m += NewsItemRow('clearing tag items will also clear the name; also added prompt if you click "clear all preset tags"');
        m += NewsItemRow('fixed a repair glitch that had to do with starting at the wrong repair item, AND sometimes items appearing as if fixed but not');
        m += NewsItemRow('fixed links so that they will open in a new tab; also added a few more links');
        m += NewsItemRow('added the "repair preset tag", allowing you to select a preset that you want to repair, providing you have it tagged beforehand');
        m += NewsItemRow('added the name of the preset to the dropdowns wherever there is preset tagging involved, so you know the name of the preset instead of just the #');
        m += NewsItemRow('added the "add all" for broken items in repair tab');
        m += NewsItemRow('added an ETA for the total time to repair all queued items (requested by Patrick Bammens)');
        m += NewsItemRow('fixed a glitch with preview tr, that if you previewed a card that was recently salvaged, it would cause bot to disappear');
        m += NewsItemRow('added a repair tab to have enhanced functionality and more convenient options for repairing, like queing specific cards for repair (request by Rose Hodge)');
        m += NewsItemRow('fixed a glitch with preview tr, that sometimes it would not load a random card from your preset slot setup');
        m += NewsItemRow('fixed 6th row display on throne cards when posting to chat and on the display throughout the tr/champ bot (requested by PixieCinnamon)');
        m += NewsItemRow('add a "click next" to the champ items upgrade panel just like the throne room has (requested by Dieter Neely)');
        m += NewsItemRow('fixed might display on throne cards when choose "post stats to chat" or "copy stats"');
        m += NewsItemRow('added enhance/upgrade stats tabs for champs');
        m += NewsItemRow('added options to hide/show the new stats tabs for champs');
        m += NewsItemRow('fixed a glitch with the new aether display in upgrade tabs, now displays appropriate city to use from');
        m += NewsItemRow('added back the enhance/upgrade stats tab, as some users had really missed that feature, sorry i removed it, but added option to show/hide them');
        m += NewsItemRow('returned the aetherstone counter in the upgraders so people can know what cities they are reaping astone from and how much is left during upgrades/enhancements');
        m += NewsItemRow('changed the height of the champion hall inventory so you do not have to scroll through your champ items (thanks to Barbarossa Smith)');
        m += NewsItemRow('changed the links on the links tab to expand/contract when clicked');
        m += NewsItemRow('added yes/no prompt for unequip all feature (requested by Dieter Neely and many others)');
        m += NewsItemRow('added a save all presets button so you can save all your presets at once');
        m += NewsItemRow('added throne menu options when clicking on the throne image, much like the champ room (requested by George Anadiotis)');
        m += NewsItemRow('added the option to make hourglasses be restricted to specific levels or qualities');
        m += NewsItemRow('reformated speedups section for better use of space, and put the "conditions of use" in a tooltip instead');
        m += NewsItemRow('enhanced the card selection in preview tr to change the preview with up/down keyboard presses making for quicker viewing without the use of a mouse (request by Dean Mason)');
        m += NewsItemRow('added counts of stones and tokens so people can track their quantity used during enhance/upgrade');
        m += NewsItemRow('added a "load from preset tag" in the preview tr tab, that way people can view a broken tagged tr preset');
        m += NewsItemRow('fixed the looping spinney during jewel attachment/removal process in the throne inventory panel');
        m += NewsItemRow('added different colored jewels for the different jewel qualities (thanks Barbarossa Smith)');
        m += NewsItemRow('added ability to load a throne room item into the "preview TR" section from organizer or the throne inventory panel');
        m += NewsItemRow('added ability to load an actual throne preset into the "preview TR" section (requested by Pandora Box)');
        m += NewsItemRow('changed compare to allow 3 cards to be compared (requested by Mary Bowyer)');
        m += NewsItemRow('updated throne room max upgrade level to 19, which also allows 17s to be broke in the "break tr" function');
        m += NewsItemRow('added a jewel filter to the throne organizer tab');
        m += NewsItemRow('added "unique" to the filter list for throne qualities (thank you Barbarossa)');
        m += NewsItemRow('added a "minimum" for only breaking throne items higher than selected (requested by Audrius Audriulaitis)');
        m += NewsItemRow('enabled users to "show extra tabs", for those old schoolers who do not want bells n wistles');
        m += NewsItemRow('added throne organizer filter for ignoring broken tr items (request by Kees Raymond Vermeulen)');
        m += NewsItemRow('reversed the order that rules are added, newest rule will now display at the top');
        m += NewsItemRow('added the rest of the higher MT past +12 to the remove from tokens option when manually upgrading');
        m += NewsItemRow('added option to turn off "showing jewels" in the throne room inventory (requested by Jason DeLeone)');
        m += NewsItemRow('fixed speedups, turns out by fixing the override i messed up normal speedups');
        m += NewsItemRow('fixed the glitch with override hourglass feature');
        m += NewsItemRow('added an astone buffer to the break tr of 50k, so you will need (50k + cost to upgrade) in your city or wont break');
        m += NewsItemRow('fixed the "equipped to" feature for preset equipping when you copied from another preset, now it will unequip the types (i.e. chair, table, etc) that were not in the source preset');
        m += NewsItemRow('added "preview tr", for setting up a throne room before you use it so enemy cannot see it, like a preview before using (requested by John Barnett)');
        m += NewsItemRow('added "fail safe" protocol to stop the breaking feature if gems are used, after hearing of some people losing gems with the break TR feature somehow by mistake');
        m += NewsItemRow('reworked the "break tr" function and removed previous authors checks for gem usage and made my own, should now be 100% secure no gem usage');
        m += NewsItemRow('created an "override hourglass" function that allows you to use any 1 type of hourglass all the time no matter what (requested by Joe Stephens)');
        m += NewsItemRow('added functionality for new throne item "Tapestry"');
        m += NewsItemRow('fixed small glitch where throne cards can be broken when using lesser protection stones (thanks Audrius Audriulaitis)');
        m += NewsItemRow('added notation to action log about remaining "boost items" if boost items are used (thanks Audrius Audriulaitis)');
        m += NewsItemRow('updated the change level when upgrading if you complete a level but want to go to another level on the same card (thanks Audrius Audriulaitis)');
        m += NewsItemRow('removed selection dropdown for type of update, now only updates using googlecode site');
        m += NewsItemRow('added highlighting for active throne preset different color from rest (requested by John Barnett)');
        m += NewsItemRow('added "copy to" for throne room presets so you can copy from 1 preset to another, then you can equip it into the destination preset');
        m += NewsItemRow('fixed glitch when equiping from preset or unequiping all, jewel icon would start duplicating itself');
        m += NewsItemRow('removed refresh prompt for when salvaging jewels is finished, bot will just refresh once done without prompt');
        m += NewsItemRow('added descriptions to the links, giving the users more detail on what the links are for');
        m += NewsItemRow('enabled users to switch on/off the "draggable" throne items option, some people have never liked that draggable option');
        m += NewsItemRow('updated champion upgrade level to 12 ');
        m += NewsItemRow('added a links tab for bots and other useful links ');
        m += NewsItemRow('fixed break tr function so it will exclude level 17 cards that cannot be upgrade to 18 yet ');
        m += NewsItemRow('enhanced the look/feel of jewel salvager, and also removed the 5 jewel cap ');
        m += NewsItemRow('fixed early disabling of the dropdowns in jewel salvager if you do not select a jewel ');
        m += NewsItemRow('fixed prompting if you do not select a throne item to salvage with ');
        m += NewsItemRow('fixed upgrade +1 glitch where you had to have upgrader set to ON in order for it to work ');
        m += NewsItemRow('fixed messaging glitch when champ enhancements are successful ');
        m += NewsItemRow('fixed refresh after breaking TR so you are not prompted after the message to refresh ');
        m += NewsItemRow('added jewel salvager, to remove 5 jewels at a time (per click)... this feature will improve as i have more time to think of a better interface ');
        m += NewsItemRow('added tokens and speedups to champ upgrader ');
        m += NewsItemRow('removed the link to userscripts page until they get themselves sorted out ');
        m += NewsItemRow('added a check to make sure you have hourglass in your inventory before it attempts to use any ');
        m += NewsItemRow('added send to inbox upon success upgrade/enhancement (great for those who have refresh on & whisper log off) ');
        m += NewsItemRow('separated back out the salvage by minimum safety option into the 2 types, throne room and champ ');
        m += NewsItemRow('added a jewel indicator in the throne inventory screen so you know which items have jewels ');
        m += NewsItemRow('BREAK YOUR THRONE ROOM!!!!!  that is right, by popular demand, you can now break your entire throne in 1 click within seconds! You can find this new feature in the presets tab ');
        m += NewsItemRow('fixed the champ panel menu for removing of mass salvage and removing salvage from first ## ');
        m += NewsItemRow('improved equip preset so it only equips items not already equipped and thus saving time ');
        m += NewsItemRow('added more functionality to the presets section, now you can save preset tags without having the preset equipped ');
        m += NewsItemRow('added posting of champ stats to chat ');
        m += NewsItemRow('moved preset options from general organizer options to a new presets tab for more development ');
        m += NewsItemRow('switched speedups section on upgrader, so the user can select the speedups they want to use  ');
        m += NewsItemRow('fixed updater glitch, organizer will now auto update properly ');
        m += NewsItemRow('added using speedups for repair times on throne items ');
        m += NewsItemRow('added user defined upgrade/enhance levels for when using stones/tokens/orbs');
        m += NewsItemRow('updated userscripts links to include 8080 so people can access them again, but i still recommend google code');
        m += NewsItemRow('added using protection stones, orbs and tokens when enhancing/upgrading throne room items ');
        m += NewsItemRow('combined both champ log & throne log into 1 complete log ');
        m += NewsItemRow('added saving/loading of throne/champ salvage rules ');
        m += NewsItemRow('fixed glitch for upgrader scrolling through queued items ');
        m += NewsItemRow('additional option given to show or hide the local presets section in the options tab ');
        m += NewsItemRow('added throne preset naming (options section), so now you will be able to define your type of throne room preset <br/>(NOTE: this does not show up in the throne panel, only on the preset widget and throne map area)');
        m += NewsItemRow('post to chat will also post the name of your throne preset ');
        m += NewsItemRow('fixed glitch for enhance/upgrade button which stuck in endless loop and crashed browser (only since miraculous was released) ');
        m += NewsItemRow('enhanced and renamed the jewel inventory section to be like the other organizers with filtering (no sorting yet) ');
        m += NewsItemRow('fixed code for loading champ salvager settings from another domain (thought i already did that, oops!) ');
        m += NewsItemRow('fixed glitch where tagging would cause multiple borders around card, eventually hiding it, if it was tagged a lot ');
        m += NewsItemRow('changed filtering to checked list boxes in throne organizer to flow more aesthetically pleasing ');
        m += NewsItemRow('added quality filter to throne organizer ');
        m += NewsItemRow('option given to show or hide the local presets section in throne organizer, giving some people more viewing room if they choose ');
        m += NewsItemRow('added facebook link, facebook like/share, and userscripts link to news section ');
        m += NewsItemRow('added equipping a throne preset by tags ');
        m += NewsItemRow('added unequipping all throne items in an active preset ');
        m += NewsItemRow('added throne preset tagging ');
        m += NewsItemRow('added options for changing throne preset tag colors and general tag colors ');
        m += NewsItemRow('added level 6 (miraculous) auto-enhancing ');
        m += NewsItemRow('added a news section so users can see what is new in the latest update ');
        m += NewsItemRow('added a throne room caps section so users can see the caps coded from the game');
        m += NewsItemRow('added a jewel inventory section so users can view the jewels they have found');
        m += NewsItemRow('added "remove all tags" from throne and champ organizer context menu ');
        m += NewsItemRow('fixed minor glitch with the update dropdown selection');
        m += NewsItemRow('integrated champion organizer functions to give users 2 for 1 organizer tool  ');
        m += NewsItemRow('added donate button in the options tab, for those who care to donate');
        m += NewsItemRow('added "preset #" to the throne room post to chat display so you know which # of throne room item you are displaying ');
        m += NewsItemRow('removed most of the IDs for throne room items when posting and displaying (for now so it looks prettier, may add back later)');
        m += NewsItemRow('removed stats tabs to reduce memory');
        m += NewsItemRow('added a "compare" feature which allows the user to take 2 tr cards and pull them up side by side to compare the stats ');
        m += NewsItemRow('added update dropdown to choose updating by Userscripts or Google Code');
        m += NewsItemRow('temporarily removed the donate button');
        m += NewsItemRow('added pets');
        m += NewsItemRow('updated for level 17 upgrade');
        m += NewsItemRow('fixed the NEXT on the upgrade/enhance to see future card stats ');
        m += NewsItemRow('fixed the 6 slot display');
        m += NewsItemRow('filter by throne types in organize tab');
        m += NewsItemRow('added select all and unselect all to the throne and level filters (got tired of clicking 16 times to only show 1 level)');
        m += NewsItemRow('fixed the auto update to work with this new script');
        m += NewsItemRow('MARCH 2014: TOOK OVER THRONE/CHAMP SCRIPT');

        m += '</table>';
        m += '</div>';
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

	},
	
	hide: function () {},
	
	show: function () {
	},
}

Tabs.tcoLinks = {
	tabOrder: 100,
	tabLabel: 'LINKS',
	tabColor: 'blue',
    tabHeader: 'MY FAVORITE LINKS',
	
	init: function (div) {
		var t = Tabs.tcoLinks;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

		m += '<div>';

        m += '<table class=tcoSectionTable>';//cellpadding=0 cellspacing=0 width=100%>';

        m += '<tr><td align=center><div id=tcoLink1 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Throne Champ Organizer</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink1data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="https://greasyfork.org/en/scripts/13089-throne-champ-organizer"><font class=tcoLinks>https://greasyfork.org/en/scripts/13089-throne-champ-organizer</a><br>';
        m += '<font class=tcoLinksDesc>An advanced organizer that upgrades and salvages KOC throne room and champion items, with many extra features</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink2 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Power Bot Plus</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink2data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="https://greasyfork.org/en/scripts/11839-koc-power-bot-plus"><font class=tcoLinks>https://greasyfork.org/en/scripts/11839-koc-power-bot-plus</a><br>';
        m += '<font class=tcoLinksDesc>A powerful bot that automates features for KOC</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink3 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Firefox Version 29 (windows users)</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink3data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="http://filehippo.com/download_firefox/57506/"><font class=tcoLinks>http://filehippo.com/download_firefox/57506/</a><br>';
        m += '<font class=tcoLinksDesc>A fast, light and tidy open source web browser, and the best browser for running KOC</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink4 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Firefox Version 29 (mac users)</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink4data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="http://www.oldapps.com/mac/firefox.php?old_firefox=14820"><font class=tcoLinks>http://www.oldapps.com/mac/firefox.php?old_firefox=14820</a><br>';
        m += '<font class=tcoLinksDesc>A fast, light and tidy open source web browser, and the best browser for running KOC</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink5 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Greasemonkey ver1.15.1 signed (for Firefox 29)</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink5data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="https://addons.mozilla.org/en-us/firefox/addon/greasemonkey/versions/1.15.1-signed"><font class=tcoLinks>https://addons.mozilla.org/en-us/firefox/addon/greasemonkey/versions/1.15.1-signed</a><br>';
        m += '<font class=tcoLinksDesc>A Firefox extension that allows users to install scripts that make on-the-fly changes to web page content after or before the page is loaded in the browser</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink6 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Google Translator - Plugin for Firefox</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink6data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="https://addons.mozilla.org/en-US/firefox/addon/google-translator-for-firefox/"><font class=tcoLinks>https://addons.mozilla.org/en-US/firefox/addon/google-translator-for-firefox/</a><br>';
        m += '<font class=tcoLinksDesc>With this addon you can translate any text to your own language with one click or hot-key</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink7 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Reload Every - Plugin for Firefox</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink7data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="https://addons.mozilla.org/en-US/firefox/addon/reloadevery/"><font class=tcoLinks>https://addons.mozilla.org/en-US/firefox/addon/reloadevery/</a><br>';
        m += '<font class=tcoLinksDesc>Reloads web pages every so many seconds or minutes</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink8 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>F89 Unofficial KOC Guide</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink8data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="http://f89kocguide.weebly.com/"><font class=tcoLinks>http://f89kocguide.weebly.com/</a><br>';
        m += '<font class=tcoLinksDesc>KOC Guide</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink9 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Teamviewer</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink9data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="http://www.teamviewer.com/en/index.aspx"><font class=tcoLinks>http://www.teamviewer.com/en/index.aspx</a><br>';
        m += '<font class=tcoLinksDesc>Remote control any computer or Mac over the internet within seconds or use TeamViewer for online meetings</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink10 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Greasy Fork</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink10data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="https://greasyfork.org/"><font class=tcoLinks>https://greasyfork.org/</a><br>';
        m += '<font class=tcoLinksDesc>Greasy Fork is aiming to become the premier user script site after the collapse of userscripts.org, with the biggest audience for your scripts</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink11 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>Throne Room Spreadsheet</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink11data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="https://docs.google.com/spreadsheets/d/1gs02x8aURak1D4MGTBzrYc5_ZDAg6cB_Kq2xiRU6kfE/edit?pli=1#gid=0"><font class=tcoLinks>https://docs.google.com/spreadsheets/d/1gs02x8aURak1D4MGTBzrYc5_ZDAg6cB_Kq2xiRU6kfE/edit?pli=1#gid=0</a><br>';
        m += '<font class=tcoLinksDesc>Great spreadsheet to view what stats are available on throne cards, and some other throne/champ related items</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink12 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>AeroAdmin</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink12data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="http://www.aeroadmin.com"><font class=tcoLinks>http://www.aeroadmin.com</a><br>';
        m += '<font class=tcoLinksDesc>FREE and EASY remote desktop software! Set up remote desktop connection within a few seconds!  No installation, no configuration, works behind NAT.</font>';
        m += '</div></td></tr>';

        m += '<tr><td align=center><div id=tcoLink13 class=tcoLinksClass style="cursor:pointer;"><font class=tcoLinksHeader>No Copy Paste</td></tr>';
        m += '<tr><td align=center class=tcoTDLinks><div id=tcoLink13data class=tcoLinkData style="display:none;">';
        m += '<a target="_blank" href="https://addons.mozilla.org/en-US/firefox/addon/nocopypaste/"><font class=tcoLinks>https://addons.mozilla.org/en-US/firefox/addon/nocopypaste/</a><br>';
        m += '<font class=tcoLinksDesc>This extension prevents websites from interfering with your copy and paste actions.</font>';
        m += '</div></td></tr>';

        m += '</table>';

        m += '</div>';

        
        m += '<div class=tcoHeader onmouseover="this.style.cursor=\'pointer\'"><img src="'+tcoRightArrow+'"/>&nbsp;TUTORIAL LINKS&nbsp;<img class=tcoReverseImage src="'+tcoRightArrow+'"/></div>';
        
        m += '<div class=tcoSection>';
        m += '<table class=tcoSectionTable>';

        m += '<tr><td align=center>';
        m += '<a target="_blank" href="http://www.youtube.com/embed/fXlHAzszico?rel=0&autoplay=1"><font class=tcoLinks>Preview/Preset/Repair Tabs Tutorial</font></a>';
        m += '</td></tr>';

        m += '<tr><td align=center>';
        m += '<a target="_blank" href="http://www.youtube.com/embed/-maykvcbk4o?rel=0&autoplay=1"><font class=tcoLinks>Throne Organizer-Preview Tutorial</font></a>';
        m += '</td></tr>';

        m += '</table>';
        m += '</div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        var tcoLinkClick = function() {
            var id = this.getAttribute("id");
            var linkNumber = id.split("tcoLink")[1];
            var divLinkName = 'tcoLink' + linkNumber + 'data';
            var divLink = document.getElementById(divLinkName);
            var hidden = (divLink.style.display == "none");
            var links = document.getElementsByClassName("tcoLinkData");
            for (i = 1; i < links.length + 1; i++) {
                document.getElementById('tcoLink' + i + 'data').style.display = "none";
            }
            if (hidden) {
                divLink.style.display = "block";
            } else {
                divLink.style.display = "none";
            }            
        };

        var tcoLinksClass = document.getElementsByClassName("tcoLinksClass");

        for(var i = 0; i < tcoLinksClass.length; i++){
            tcoLinksClass[i].addEventListener('click', tcoLinkClick, false);
        };

        var header = document.getElementsByClassName('tcoHeader');
        for (var head=0;head<header.length;head++) {
            header[head].addEventListener('click', sectionOpener, false);
        }

	},
	
	hide: function () {},
	
	show: function () {},
}

Tabs.tcoDonate = {
	tabOrder: 100,
	tabLabel: 'DONATE',
	tabColor: 'blue',
    tabHeader: 'DONATIONS',
	
	init: function (div) {
		var t = Tabs.tcoDonate;
		t.mydiv = div;

		var m = '<div class=tcoHeader>' + t.tabHeader + '</div>';

        m += '<div class=indent5><b>';
        m += '  Hi there, thanks for taking the time to consider donating.  I never ask for handouts, although a thank you is nice, and sometimes a monetary thank you is nicer.';
        m += '  You likely spend $10.00 or more on gems every month in support of the game you love, why not support the scripters who make your life a bit easier by automating it?';
        m += '  If you would like to donate, please press the donate button below and I will be a very happy scripter!';
        m += '  I am also looking into creating my own online game as well.  So all money donated will likely go to the development of that.';
        m += '  All donations are processed through PayPal on my behalf.';
        m += '  Thanks again for your support, without people like you, I would lose interest in this game';
        m += '</b></div>';

        m += '<div align=center><table><tr><td width=100% align=center>';
        m += '<a id=tcoPayPalLink><img onmouseover="this.style.cursor=\'pointer\'" id=tcoPayPalImage /></a>';
        m += '</td></tr></table></div>';

		t.mydiv.innerHTML = '<div>' + m + '</div>';

        document.getElementById('tcoPayPalLink').setAttribute('href', 'https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=TJ9YQ8S75HFEL');
        document.getElementById('tcoPayPalLink').setAttribute('target', '_blank');
        document.getElementById('tcoPayPalImage').setAttribute('src', 'https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif');
        document.getElementById('tcoPayPalImage').setAttribute('alt', 'donate');

	},
	
	hide: function () {},
	
	show: function () {},
}

/***********************************************************************************************************************************************************************************/

function QueueItem() {  //class definition for upgrade queue items
    this.item   = 0;
    this.action = "upgrade";
    this.level  = 1;
    this.status = "not started";
    this.triesTotal = 0;
    this.triesThis = 0;
    this.triesLast = 0;
    this.lastUpgrade = "none";
    this.upgrades = [];
}

function ThroneRule(type, faction, conditions, advancedrule) { //class definition for rules and conditions
    this.type = type;
    this.faction = faction;
    this.advancedrule = advancedrule;
    if (conditions)
        this.conditions = conditions;
    else
        this.conditions = [];

    this.ThroneAddCondition = ThroneAddCondition;
    this.ThroneApplyRule    = ThroneApplyRule;
}

function ThroneCloneRule(rule) {
    this.type = rule.type;
    this.faction = rule.faction;
    this.advancedrule = rule.advancedrule;
    this.conditions = [];
    if (rule.conditions) this.conditions = rule.conditions;

    this.ThroneAddCondition = ThroneAddCondition;
    this.ThroneApplyRule    = ThroneApplyRule;
}

function ThroneAddCondition(c) {
    this.conditions.push(c);
}

function ThroneApplyRule(id) {
    var ThroneItem = uW.kocThroneItems[id];

    if (this.type != 'any' && (this.type != ThroneItem.type)) return false;
    if (this.faction != 'any' && (this.faction != ThroneItem.faction)) return false;
    for (r in this.conditions) {
        if (!this.conditions[r].ThroneCheckCondition(id)) return false;
    }
    return true;
}

function ThroneCondition(mustHave, number, effect, buffType, slots ) {
    this.mustHave = mustHave;
    this.number   = number;
    this.effect   = effect;
    this.buffType = buffType;
    this.slots    = slots;

    this.ThroneCheckCondition = ThroneCheckCondition;
}

function ThroneCheckCondition(id) {
    var numberFound  = 0;
    var effectsFound = false;
    // get card
    var ThroneItem = uW.kocThroneItems[id];

    if (!ThroneItem) return false;

    // for loop for stat
    // count up occurances
    for (i in ThroneItem.effects) {
        var CardEffect = CM.thronestats.effects[ThroneItem.effects[i].id][1];
        var slotid = i.split("slot")[1];

        if (!this.slots[slotid-1]) continue;

        var eff = this.effect + " ";

        if (CardEffect.indexOf(" Debuff") < 0) CardEffect += " ";

        if (!CardEffect.startsWith(eff)) continue;

        // special rule for Chance to Find Items 
        if ( (CardEffect == "Chance to Find Items ") && (CardEffect != eff ) ) continue;

        // If we do not care about buff/debuff then we are done
        if (this.buffType == "e") {
            numberFound++;
        } else {
            // Does the description end with a Debuff
            if (CardEffect.endsWith(" Debuff")) {
                // Are we looking for a debuff
                if (this.buffType == "d") numberFound++;
            } else {
                if (this.buffType == "b") numberFound++;
            }
        } 
    }

    if ( numberFound >= this.number) effectsFound = true;

    if (this.mustHave != "false")
        return effectsFound;
    else
        return (!effectsFound);
}

function ChampRule(type, faction, conditions, advancedrule) {  //class definition for rules and conditions
    this.type = type;
    this.faction = faction;
    this.advancedrule = advancedrule;
    if (conditions)
        this.conditions = conditions;
    else
        this.conditions = [];

    this.ChampAddCondition = ChampAddCondition;
    this.ChampApplyRule    = ChampApplyRule;
}

function ChampCloneRule(rule) {
    this.type = rule.type;
    this.faction = rule.faction;
    this.advancedrule = rule.advancedrule;
    this.conditions = [];
    if (rule.conditions) this.conditions = rule.conditions;

    this.ChampAddCondition = ChampAddCondition;
    this.ChampApplyRule    = ChampApplyRule;
}

function ChampAddCondition(c) {
    this.conditions.push(c);
}

function ChampApplyRule(id) {
    var champItem = uW.kocChampionItems[id];
    
    if (this.type != "any" && (champItemTypes[this.type] != champItem.type)) return false;
    if (this.faction != "any" && (this.faction != champItem.faction)) return false;
    for (r in this.conditions)
    {
        if (!this.conditions[r].ChampCheckCondition(id)) return false;
    }
    return true;
}

function ChampCondition(mustHave, number, effect, buffType, slots ) {
    this.mustHave = mustHave;
    this.number   = number;
    this.effect   = effect;
    this.buffType = buffType;
    this.slots    = slots;

    this.ChampCheckCondition = ChampCheckCondition;
}

function ChampCheckCondition(id) {
    var numberFound  = 0;
    var effectsFound = false;
    // get card
    var champItem = uW.kocChampionItems[id];

    if (!champItem) return false;

    // for loop for stat
    // count up occurances
    for (i in champItem.effects) {
        var id = champItem.effects[i].id;
        var card_effect = "";
        

        card_effect = uW.g_js_strings.effects["name_" + id];

        var slotid = +i;
        if (!this.slots[slotid-1]) continue;

        var eff = this.effect + " ";

        if (card_effect.indexOf(" Debuff") < 0) card_effect += " ";

        if (!card_effect.startsWith(eff)) continue;

        // If we do not care about buff/debuff then we are done
        if (this.buffType == "e") {
            numberFound++;
        } else {
            // Does the description end with a Debuff
            if (card_effect.endsWith(" Debuff")) {
                // Are we looking for a debuff
                if (this.buffType == "d")
                {
                    numberFound++;
                }
            } else {
                if (this.buffType == "b")
                {
                    numberFound++;
                }
            }
        } 
    }

    if ( numberFound >= this.number) {
        effectsFound = true;
    }

    if (this.mustHave != "false")
        return effectsFound;
    else
        return (!effectsFound);
}

function ReplaceToolTips() {

    var TToldF = CM.ThroneView.boostsTooltip;

    var ThroneToolTip = function (L, E, K) {
        var J = new Array();
        var slot = L.innerHTML;
        
        slot = slot.replace("<span>","").replace("</span>","").trim();

        if (L.id == "maparea_boosts_throneroom") slot = Seed.throne.activeSlot;

        J.push("<div id='boosts_tooltip'><b>Throne Room:</b><br/>");
        J.push("<b><i>(" + tcoThronePresetData.presetNames[slot] + ")</i></b>");
        J.push("<br/>");

        var equipped_items = Seed.throne.slotEquip[slot];

        if (equipped_items.length > 0) {
            J.push(GenerateThronePresetEffectsString(equipped_items, true));
        } else {
            J.push("<div>This Preset has no Items equipped</div>");
        }

        J.push("</div>");
        if (L.id == "maparea_boosts_throneroom") {
            uW.showTooltip(J.join(""), L, E, K)
        } else {
            uW.Tooltip.show(E, J.join(""), [10, 10], null)
        }
    }

    CM.ThroneView.boostsTooltip = ThroneToolTip;
}
function alterChampHall() {

    function addPostChamp() {
        var button_sizes = '38px';
        var assign_button = document.getElementsByClassName('assign_city')[0];
        assign_button.style.width = button_sizes;
        assign_button.className += ' divNoWrap';
        assign_button.parentElement.className += ' divNoWrap';

        if (!document.getElementById('tcoHideShow')) {
            var tco_button = document.createElement('div');
            tco_button.className = 'buttonv2 box brown divNoWrap';
            tco_button.innerHTML = 'TCO';
            tco_button.id = 'tcoHideShow';
            tco_button.style.width = button_sizes;
            assign_button.parentElement.appendChild(tco_button);
            tco_button.addEventListener('click', function () {
                eventHideShow();            
            }, false);
        }
        if (!document.getElementById('tcoPostChamp')) {
            var post_button = document.createElement('div');
            post_button.className = 'buttonv2 box red divNoWrap';
            post_button.innerHTML = 'POST';
            post_button.id = 'tcoPostChamp';
            post_button.style.width = button_sizes;
            assign_button.parentElement.appendChild(post_button);
            post_button.addEventListener('click', function () {
                var champDiv = document.getElementsByClassName('name active')[0];
                var champClass = champDiv.className;
                var champIndex = parseInt(champClass.replace(' name active', '').replace('name', ''));
                postChampSlot(champIndex+1);
            }, false);
        }
    }

    function addMenus() {

        $(".champItem").click(function (A) {
            CardContextMenu(this, uW.kocChampionItems[this.id], false);
        }); 
    }

    function addBorders() {

        Tabs.champPresets.paintTags();

        var dv = document.getElementById('tcoChampMight')

        if (!dv) {

            var modContainers = document.getElementsByClassName("cmModalContainer Champion");
            if (modContainers == null || !modContainers) return;

            var modContainer = modContainers[0];
            if (modContainer == null || !modContainer) return;

            var elem = modContainer.getElementsByClassName("primarytitlebar")[0];
            dv = document.createElement('div');
            dv.id = "tcoChampMight";
            dv.style.whiteSpace='nowrap';
            dv.style.position='absolute';
            dv.style.overflow='visible';
            dv.style.top = '15px';
            dv.style.left = '435px';
            dv.style.zIndex=2005;
            elem.insertBefore(dv, elem.childNodes[1].nextSibling);
        }

        dv.innerHTML = getChampMight();

    }

    var oldOpen = CM.ChampionModalController.open;
    CM.ChampionModalController.open = function (j) {
        oldOpen(j);
        addBorders();
        addPostChamp();
    }
    
    var rfi = CM.ChampionModalView.renderFilteredItems;
    CM.ChampionModalView.renderFilteredItems = function () {
        rfi();
        addMenus();
        addBorders();
    }

    var rdr = CM.ChampionModalView.render;
    CM.ChampionModalView.render = function (ab,aa) {
        rdr(ab,aa);
        addMenus();
        addBorders();
        addPostChamp();
    }

    var oldUpgEnh = CM.ChampionModalView.renderUpgEnh;
    CM.ChampionModalView.renderUpgEnh = function (ag, aa) {
        oldUpgEnh(ag, aa);
        var NextClick = document.getElementById('upgEnhStatsTarget');
        var t = Tabs.champOrganizer;
        t.panelId = ag;  //this is the champ item ID
        t.panelNextLevel = uW.kocChampionItems[ag].level + 1;
        NextClick.removeEventListener("click", t.showNextChampLevel);
        var Locked = document.getElementById('chLockedStatIcon');
        if (Locked != null) return;
        NextClick.addEventListener("click", t.showNextChampLevel);
    }

};

var ThroneOldRenderMenu = CM.ContextualMenuThrone.renderMenu;

function installThroneHandlerFunctions() {

    // add some new functionality here ...
    var oldThroneRenderPanel = CM.ThronePanelView.renderPanel;
    var newThroneRenderPanel = function (v1, v2) {
        oldThroneRenderPanel(v1, v2);

        // save off this data ...
        Tabs.throneOrganizer.panelId = v2.id;
        Tabs.throneOrganizer.panelType = v1;
        Tabs.throneOrganizer.panelNextLevel = 2;

        var clearMasterTokens = function () {
            // remove options for tokens
            var removeItems =  [uW.ksoItems[20012].name, // +3 master
                                uW.ksoItems[20013].name, // +5 master
                                uW.ksoItems[20014].name, // +7
                                uW.ksoItems[20015].name, // +9
                                uW.ksoItems[20016].name, // +10
                                uW.ksoItems[20017].name, // +11
                                uW.ksoItems[20018].name, // +12
                                uW.ksoItems[20020].name, // +13
                                uW.ksoItems[20021].name, // +14
                                uW.ksoItems[20023].name, // +15
                                uW.ksoItems[20024].name, // +16
                                uW.ksoItems[20025].name, // +17
                                uW.ksoItems[20026].name, // +18
                                uW.ksoItems[20027].name, // +19
                                uW.ksoItems[20028].name, // +20
                                uW.ksoItems[20029].name, // +21
                                uW.ksoItems[20030].name, // +22
                                uW.ksoItems[20031].name, // +23
                                uW.ksoItems[20032].name, // +24
                                uW.ksoItems[20033].name // +25
                                ];

            $(document.querySelector("#buffDropDown")).children("option").each(function () {
                if ($.inArray($(this).text(), removeItems) > -1) $(this).remove();
            });
            $(document.querySelector("#thronePanelBuffIcon")).removeClass().addClass('icon').addClass('i0');
            $(document.querySelector("#thronePanelBuffPrice")).children("span.items").html('');
        }
        var clearOtherTokens = function () { 
            // remove options for tokens
            var removeItems =  [uW.ksoItems[20006].name, // lucky token
                                uW.ksoItems[20007].name, // common master
                                uW.ksoItems[20008].name, // uncommon
                                uW.ksoItems[20009].name, // rare
                                uW.ksoItems[20010].name, // epic
                                uW.ksoItems[20011].name, // wondrous
                                uW.ksoItems[20019].name, // super lucky token
                                uW.ksoItems[20022].name, // apprentice token
                                uW.ksoItems[20101].name, //Fortune's Token +19
                                uW.ksoItems[20102].name, //Opportunity's Token +19
                                uW.ksoItems[20103].name, //Prospector's Token +19
                                uW.ksoItems[20104].name, //Fortune's Token +20
                                uW.ksoItems[20105].name, //Opportunity's Token +20
                                uW.ksoItems[20106].name, //Prospector's Token +20
                                uW.ksoItems[20107].name, //Fortune's Token +21
                                uW.ksoItems[20108].name, //Opportunity's Token +21
                                uW.ksoItems[20109].name, //Prospector's Token +21
                                uW.ksoItems[20110].name, //Fortune's Token +22
                                uW.ksoItems[20111].name, //Opportunity's Token +22
                                uW.ksoItems[20112].name, //Prospector's Token +22
                                uW.ksoItems[20113].name, //Fortune's Token +23
                                uW.ksoItems[20114].name, //Opportunity's Token +23
                                uW.ksoItems[20115].name, //Prospector's Token +23
                                uW.ksoItems[20116].name, //Fortune's Token +24
                                uW.ksoItems[20117].name, //Opportunity's Token +24
                                uW.ksoItems[20118].name //Prospector's Token +24
                                ];

            $(document.querySelector("#buffDropDown")).children("option").each(function () {
                if ($.inArray($(this).text(), removeItems) > -1) $(this).remove();
            });
            $(document.querySelector("#thronePanelBuffIcon")).removeClass().addClass('icon').addClass('i0');
            $(document.querySelector("#thronePanelBuffPrice")).children("span.items").html('');

        }

        var doUpdradeChecks = function () {
            if (tcoGeneralOptions.useMastersTokens) autoSelectMasters(); //v2.id is the throneItemID
            if (!tcoGeneralOptions.useMastersTokens && tcoGeneralOptions.removeMastersTokens) clearMasterTokens();
            if (!tcoGeneralOptions.useMastersTokens && tcoGeneralOptions.removeOtherTokens) clearOtherTokens();
            if (!tcoGeneralOptions.useMastersTokens && tcoGeneralOptions.buffsOff) unselectToken();
            if (tcoGeneralOptions.safetyOn) safetyCheck();
        }

        var doEnhanceChecks = function () {
            if (!tcoGeneralOptions.useMastersTokens && tcoGeneralOptions.buffsOff) unselectToken();
            if (tcoGeneralOptions.safetyOn) safetyCheck();
        }

        var addTabButtonChecks = function () {
            // register some callbacks when the buttons are pushed

            var pc = document.querySelector('#thronePanelContainer');
            $(pc).find("div.navigation ul").children("li.upgrade").click(function() {
                doUpdradeChecks();
                addTabButtonChecks();
            });

            $(pc).find("div.navigation ul").children("li.enhance").click(function() { 
                doEnhanceChecks();
                addTabButtonChecks();
            });

            $(pc).find("div.navigation ul").children("li.jewel").click(function() {
                addTabButtonChecks();
            });
        }

        if (v1 == "upgrade") doUpdradeChecks();
        if (v1 == "enhance") doEnhanceChecks();

        addTabButtonChecks();
    }
    // hook up to the new function
    CM.ThronePanelView.renderPanel = newThroneRenderPanel;


	var oldAddJewel = CM.ThroneController.addJewel; //fixes the issue with adding/removing jewels and having it get stuck with the spinney
	var newAddJewel = function (aj, ai) {
		oldAddJewel(aj, ai);
		CM.ThronePanelView.removeSpinny();
	}
	CM.ThroneController.addJewel = newAddJewel;


	var oldRemoveJewel = CM.ThroneController.removeJewel;
	var newRemoveJewel = function (ak, ai) {
		oldRemoveJewel(ak, ai);
		CM.ThronePanelView.removeSpinny();
	}
	CM.ThroneController.removeJewel = newRemoveJewel;
    
    // override the salvageItem function to allow upgrade to +1 first
    var oldSalvageItem = CM.ThroneController.salvageItem;    
    var newSalvageItem = function (item) {
        if ( tcoThroneSalvageData.upgradeManual )
        {
            if (item && item.quality <= tcoThroneSalvageData.upgradeFirstQual && item.level==0 )
            {
                var status = Tabs.throneSalvager.deleting;
                Tabs.throneSalvager.deleting = true;
                Tabs.throneUpgrader.doUpgrade(item.id,true);
                Tabs.throneSalvager.deleting = status;
            }  
        }
        oldSalvageItem(item);
    };
    CM.ThroneController.salvageItem = newSalvageItem;


    var oldRenderInventory = CM.ThroneView.renderInventory;
    var newRenderInventory = function(l) {
        oldRenderInventory(l);

        $("ul#throneInventoryList > li > div").removeClass('tcoBlueBorder');
        $("ul#throneInventoryList > li > div").removeClass('tcoYellowBorder');
        for (ii in tcoThroneQueueData.list) {
            var list_item = tcoThroneQueueData.list[ii];
            if (!list_item) continue;
            if (list_item.status != "complete") {
                var id = list_item.item;

                if (list_item.action == "upgrade") $("div#throneInventoryItem" + id).addClass('tcoBlueBorder');     
                if (list_item.action == "enhance") $("div#throneInventoryItem" + id).addClass('tcoYellowBorder');
            }
        }
        Tabs.thronePresets.paintTags();

    }
    CM.ThroneView.renderInventory = newRenderInventory;

    var oldOpenThrone = CM.ThroneView.openThrone;
    var newOpenThrone = function (F) {
        oldOpenThrone(F);

        tcoSwapTile = null;

        if (tcoGeneralOptions.draggableThroneItems) {
            $("#advisorContainer").draggable();
            $("#heroContainer").draggable();
            $("#chairContainer").draggable();
            $("#candelabrumContainer").draggable();
            $("#tableContainer").draggable();
            $("#windowContainer").draggable();
            $("#bannerContainer").draggable();
            $("#trophyContainer").draggable();
            $("#statueContainer").draggable();
            $("#petContainer").draggable();
            $("#tapestryContainer").draggable();
            $("#pillarContainer").draggable(); 
        }

        Tabs.throneSalvager.updateThroneMenu();
        Tabs.throneUpgrader.updateThroneMenu();
        Tabs.throneRepair.updateThroneMenu();

        $("ul#throneInventoryList > li > div").removeClass('tcoBlueBorder');
        $("ul#throneInventoryList > li > div").removeClass('tcoYellowBorder');

        for (ii in tcoThroneQueueData.list) {
            var list_item = tcoThroneQueueData.list[ii];
            if (!list_item) continue;
            if (list_item.status != "complete") {
                var id = list_item.item;
                if (list_item.action == "upgrade") $("div#throneInventoryItem" + id).addClass('tcoBlueBorder');
                if (list_item.action == "enhance") $("div#throneInventoryItem" + id).addClass('tcoYellowBorder');
            }
        }

        Tabs.thronePresets.paintTags();

        //these next few lines expands the throne inventory list
        var h = 564;
        var el1 = document.getElementById('throneStatList');
        if (el1) { h=h-el1.clientHeight; }
        $("ul#throneInventoryList").css('height', h+'px');
        $("div#throneInventoryContainer").css('height', h+'px');

        if (tcoGeneralOptions.throneSorter) {
            if (tcoThroneSorter.length == 0) resetThroneSorter();
            sortThroneSorter(false);
        }
    }
    CM.ThroneView.openThrone = newOpenThrone;

    CM.ContextualMenuThrone.renderMenu = CardContextMenu;
}

function tcoThroneSorterEventListener(obj) {
    var throneId = obj.id.split('throneInventoryItem')[1];
    var throneItem = uW.kocThroneItems[throneId];
    if (tcoSwapTile == null) { //this means i haven't clicked the first tile to swap yet, so set it and wait for the second to swap with
        tcoSwapTile = throneId
        $(obj).prepend("<div class='swapBorderThrone'></div>");
    } else {
        if (throneId == tcoSwapTile) {
            $('#throneInventoryItem' + tcoSwapTile).children(".swapBorderThrone").remove();
            tcoSwapTile = null;
            return;
        }
        $('#throneInventoryItem' + tcoSwapTile).children(".swapBorderThrone").remove();

        var fromTile = document.getElementById('throneInventoryItem' + tcoSwapTile);
        var fromTilePosition = 0;
        var child = fromTile;
        while( (child = child.previousSibling) != null ) fromTilePosition++;

        var toTile = document.getElementById('throneInventoryItem' + throneId);
        var toTilePosition = 0;
        child = obj;
        while( (child = child.previousSibling) != null ) toTilePosition++;

        var fromParent = fromTile.parentElement;
        var toParent = toTile.parentElement;

        var fromDelete = fromParent.children[fromTilePosition];
        var toDelete = toParent.children[toTilePosition];

        if (fromParent != toParent) { //simple swap
            fromDelete.remove();
            toDelete.remove();
            fromParent.insertBefore(toTile, fromParent.childNodes[fromTilePosition]);
            toParent.insertBefore(fromTile, toParent.childNodes[toTilePosition]);
        } else { //little more tricky
            var newRow = [];
            for (var idx = 0; idx < fromParent.children.length; idx++) {
                if (idx == fromTilePosition) {
                    newRow.unshift(toTile);
                } else if (idx == toTilePosition) {
                    newRow.unshift(fromTile);
                } else {
                    newRow.unshift(fromParent.children[idx]);
                }
            }
            while (fromParent.hasChildNodes()) fromParent.removeChild(fromParent.lastChild);
            while (newRow.length > 0) fromParent.appendChild(newRow.pop());
        }
        tcoSwapTile = null;
        setThroneSorter(false);
        SAVEtcoThroneSorter();
    }

}

function resetThroneSorter() {
    tcoThroneSorter = [];
    counter = 0;
    for (var throneId in uW.kocThroneItems) {
        tcoThroneSorter.push(throneId);
        counter++;
        if (counter == tcoMaxThroneCards) break;
    }
    SAVEtcoThroneSorter();
}

function sortThroneSorter(fromOrganizer) {  //you should never really call this function from the sorter tab because it won't do anything
    if (tcoThroneSorter.length == 0) resetThroneSorter();
    var reorder = [];
    if (!fromOrganizer) {
        //store all the TILES in the sorter array and remove them from inventory
        for (var idx = 0; idx < tcoThroneSorter.length; idx++) {
            var throneTile = document.getElementById('throneInventoryItem' + tcoThroneSorter[idx]);
            if (!throneTile) continue;
            reorder.unshift(throneTile);
            throneTile.remove();
        }
        //check for any remaining TILES and store them temp and remove from inventory
        var throneInventoryList = document.getElementById('throneInventoryList');
        var throneRows = throneInventoryList.getElementsByClassName('active');
        for (var row = 0; row < throneRows.length; row++) {
            var throneRow = throneRows[row];
            if (throneRow.children.length > 0) {
                for (var c = 0; c < throneRow.children.length; c++) {
                    var throneTile = throneRow.children[c];
                    if (!throneTile) continue;
                    reorder.unshift(throneTile);
                }
                while (throneRow.firstChild) throneRow.removeChild(throneRow.firstChild);
            }
        }
        //by now, ALL TILES should be in the reorder array, time to put them back up on the display
        var throneInventoryList = document.getElementById('throneInventoryList');
        var throneRows = throneInventoryList.getElementsByClassName('active');
        for (var row = 0; row < throneRows.length; row++) {
            var throneRow = throneRows[row];
            for (var c = 0; c < 5; c++) {
                var throneTile = reorder.pop();
                if (!throneTile) continue;
                throneTile.addEventListener('contextmenu', function(evt) {
                    evt.preventDefault();
                    tcoThroneSorterEventListener(this);
                }, false);
                throneRow.appendChild(throneTile);
            }
        }
        setThroneSorter(fromOrganizer);
    }
}

function setThroneSorter(fromOrganizer) {
    if (tcoThroneSorter.length == 0) resetThroneSorter();
    var reorder = [];
    var notIn = [];

    if (fromOrganizer) {
        var tcoThroneSorterInventoryList = document.getElementById('tcoThroneSorterInventoryList');
        var throneRows = tcoThroneSorterInventoryList.getElementsByClassName('active');
        for (var row = 0; row < throneRows.length; row++) {
            var throneRow = throneRows[row];
            if (throneRow.children.length > 0) {
                for (var col = 0; col < throneRow.children.length; col++) {
                    var throneDiv = throneRow.children[col];
                    if (!throneDiv) continue;
                    var cellId = throneDiv.id;
                    var throneId = cellId.split('tcoThroneSorterInventoryIcon')[1];
                    if (tcoThroneSorter.indexOf(throneId) == -1) {
                        notIn.unshift(throneId);
                    } else {
                        reorder.unshift(throneId);
                    }
                }
            }
        }
    } else {
        var throneInventoryList = document.getElementById('throneInventoryList');
        var throneRows = throneInventoryList.getElementsByClassName('active');
        for (var row = 0; row < throneRows.length; row++) {
            var throneRow = throneRows[row];
            if (throneRow.children.length > 0) {
                for (var col = 0; col < throneRow.children.length; col++) {
                    var cellId = throneRow.children[col].id;
                    var throneId = cellId.split('throneInventoryItem')[1];
                    if (tcoThroneSorter.indexOf(throneId) == -1) {
                        notIn.unshift(throneId);
                    } else {
                        reorder.unshift(throneId);
                    }
                }
            }
        }
    }
    tcoThroneSorter = [];
    while (reorder.length > 0) tcoThroneSorter.push(reorder.pop());
    while (notIn.length > 0) tcoThroneSorter.push(notIn.pop());
}

function isUndefined(obj) {
    if (typeof(obj) == 'undefined')
        return true;
    else 
        return false;
}

function indexOfChampCard(Id) {
    var counter = 0;
    for (var champId in uW.kocChampionItems) {
        counter += 1;
        if (champId == Id) return counter;
    }
    return counter;
}

function indexOfThroneCard(Id) {
    var counter = 0;
    for (var throneId in uW.kocThroneItems) {
        counter += 1;
        if (throneId == Id) return counter;
    }
    return counter;
}

function countHowManyThroneSlots(Id) {
    var presetSlots = getObjectCollectionCount(Seed.throne.slotEquip);
    var counter = 0;
    for (var slot = 1; slot < presetSlots + 1; slot++) {
        var throneItems = Seed.throne.slotEquip[slot];
        for (itemIdx = 0; itemIdx < throneItems.length; itemIdx++)
            if (Id == throneItems[itemIdx]) counter++;
    }
    return counter;
}

function howManyThroneSlots(Id) {
    var presetSlots = getObjectCollectionCount(Seed.throne.slotEquip);
    var presetSlotsFound = [];
    var presetSlotMsg = '';
    for (var slot = 1; slot < presetSlots + 1; slot++) {
        var throneItems = Seed.throne.slotEquip[slot];
        for (itemIdx = 0; itemIdx < throneItems.length; itemIdx++) {
            if (Id == throneItems[itemIdx]) {
                if (presetSlotsFound.length % 8 == 0) {
                    presetSlotsFound.push('<br>' + slot);
                } else {
                    presetSlotsFound.push(slot);
                }
            }
        }
    }
    if (presetSlotsFound.length > 0) {
        presetSlotMsg = 'Card Found In The<br>Following Preset Slots:' + presetSlotsFound.join(', ');
    } else {
        presetSlotMsg = 'Not In Any Presets';
    }
    return presetSlotMsg;
}

function whichChampSlot(Id) {
    var presetSlotMsg = '';
    var champItem = uW.kocChampionItems[Id];
    var championId = champItem.equippedTo;
    for (var i = 1; i < tcoMaxChampions+1; i++) {
        var thisChampion = Seed.champion.champions[i-1];
        if (thisChampion.championId == championId) {
            presetSlotMsg = 'Item Equipped To<br> Champ In Slot ' + i + '<br>Name: ' + thisChampion.name;
            break;
        }
    }
    return presetSlotMsg;
}

var CardContextMenu = function (tileDiv, theItem, fromOrganizer) {

    if (typeof(fromOrganizer) == 'undefined') fromOrganizer = false;

    if (theItem == null) {
        ThroneOldRenderMenu(tileDiv, theItem);
        return;
    }

    var lastMenuItem = null;

    var throneItem = theItem;
    var champItem = theItem;
    
    var isThrone = (typeof(champItem.equipmentId) == 'undefined');
    var hasJewel = false;
  
    var cmContainerOpen = (document.getElementsByClassName('cmModalContainer').length == 1 ? true : false);

    var itemIndex = 0;
    var isBroken = false;
    var isRepairAll = false;
    var itemId = null;
    var itemLevel = 0;

    var presetSlot = 1;
    var championId = Seed.champion.champions[presetSlot-1].championId;
    var presetTagCount = 0;
    var howManyMessage = '';
    var inPresets = false;

    if (isThrone) {
        if (!fromOrganizer) ThroneOldRenderMenu(tileDiv, theItem);
        hasJewel = (typeof(throneItem.jewel) != 'undefined')
        isBroken = throneItem.isBroken
        presetSlot = Seed.throne.activeSlot;
        isRepairAll = isAnyThroneBroke();
        presetTagCount = getThronePresetTagCount(presetSlot);
        itemId = throneItem.id;
        itemIndex = indexOfThroneCard(itemId);
        itemLevel = throneItem.level;
        howManyMessage = howManyThroneSlots(itemId);
        if (countHowManyThroneSlots(itemId) > 0) inPresets = true;
    } else {
        isBroken = (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE);
        if (!fromOrganizer) {
            for (i = 0; i < tcoMaxChampions; i++) {
                var champClass = $(".champion_states").children(".name" + i).attr('class');
                if ( champClass.indexOf("active") == -1) continue;
                presetSlot = i + 1;
                break;
            }
        }
        isRepairAll = isAnyChampBroke();
        presetTagCount = getChampPresetTagCount(presetSlot);
        itemId = champItem.equipmentId;
        itemIndex = indexOfChampCard(itemId);
        itemLevel = champItem.level;
        howManyMessage = whichChampSlot(itemId);
        if (howManyMessage != '') {
            inPresets = true;
        } else {
            howManyMessage = 'Not Equipped';
        }
    }

    if (!fromOrganizer) {
        uW.removeTooltip();
        uW.Tooltip.hide();
    }

    function ContextMenuExpandCollapse(menuItem, isExpanding) {
        var menuSubItemClass = menuItem.id + "_SubItem";
        var SubItems = document.getElementsByClassName(menuSubItemClass);
        for (var idx = 0; idx < SubItems.length; idx++) {
            var menuSubItem = SubItems[idx];
            if (isExpanding)
                menuSubItem.className = menuSubItem.className.replace('tcoContextHidden', 'tcoContextVisible');
            else
                menuSubItem.className = menuSubItem.className.replace('tcoContextVisible', 'tcoContextHidden');
        }
    }

    var tcoContextMenu = document.getElementById("contextMenu");
    if (tcoContextMenu) {
        while (tcoContextMenu.hasChildNodes()) tcoContextMenu.removeChild(tcoContextMenu.lastChild);
    } else {
        tcoContextMenu = document.createElement('div');
        tcoContextMenu.addEventListener('mouseleave', function () {
            this.remove();
        }, false);
    }

    if (isThrone)
        tcoContextMenu.innerHTML = throneItem.type.capitalizeFirstLetter() + '+' + itemLevel;
    else
        tcoContextMenu.innerHTML = champItemNames[champItem.type].capitalizeFirstLetter() + '+' + itemLevel;

    tcoContextMenu.className = 'tcoContextMenu';

    var tcoContextMenuUpgrading = document.createElement('div');
    tcoContextMenuUpgrading.className = 'tcoContextMenuItem tcoBrown';
    tcoContextMenuUpgrading.innerHTML = 'UPGRADING';
    tcoContextMenuUpgrading.id = 'tcoContextMenuUpgrading';
    tcoContextMenuUpgrading.addEventListener('click', function(A) {
        A.stopPropagation();
        if (lastMenuItem == this) {
            ContextMenuExpandCollapse(this, false);
            lastMenuItem = null;
            return;
        }
        if (lastMenuItem == null) lastMenuItem = this;
        if (lastMenuItem.id != this.id) ContextMenuExpandCollapse(lastMenuItem, false);
        ContextMenuExpandCollapse(this, true);
        lastMenuItem = this;
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuUpgrading);

    var tcoContextMenuUpgrading_AutoUpg = document.createElement('div');
    tcoContextMenuUpgrading_AutoUpg.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuUpgrading_SubItem';
    tcoContextMenuUpgrading_AutoUpg.innerHTML = 'Auto Upgrade';
    if ( (isThrone && throneItem.level < tcoMaxThroneLevel) || (!isThrone && champItem.level < tcoMaxChampLevel) ) {
        tcoContextMenuUpgrading_AutoUpg.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone)
                Tabs.throneUpgrader.addUpgradeItem(itemId);
            else
                Tabs.champUpgrader.addUpgradeItem(itemId);
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuUpgrading_AutoUpg.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuUpgrading_AutoUpg);

    var tcoContextMenuUpgrading_Upgrade = document.createElement('div');
    tcoContextMenuUpgrading_Upgrade.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuUpgrading_SubItem';
    tcoContextMenuUpgrading_Upgrade.innerHTML = 'Upgrade';
    if ( ( (isThrone && throneItem.level < tcoMaxThroneLevel) || (!isThrone && champItem.level < tcoMaxChampLevel) ) && !isBroken ) {
        tcoContextMenuUpgrading_Upgrade.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone) {
                if (!cmContainerOpen) CM.ThroneView.openThrone();
                CM.ThronePanelView.renderPanel("upgrade", throneItem)
            } else {
                if (!cmContainerOpen) CM.ChampionModalController.open();
                CM.ChampionModalView.upgEnhSlideIn(itemId, "upg");
            }
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuUpgrading_Upgrade.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuUpgrading_Upgrade);

    var tcoContextMenuEnhancing = document.createElement('div');
    tcoContextMenuEnhancing.className = 'tcoContextMenuItem tcoBrown';
    tcoContextMenuEnhancing.innerHTML = 'ENHANCING';
    tcoContextMenuEnhancing.id = 'tcoContextMenuEnhancing';
    tcoContextMenuEnhancing.addEventListener('click', function(A) {
        if (lastMenuItem == this) {
            ContextMenuExpandCollapse(this, false);
            lastMenuItem = null;
            return;
        }
        A.stopPropagation();
        if (lastMenuItem == null) lastMenuItem = this;
        if (lastMenuItem.id != this.id) ContextMenuExpandCollapse(lastMenuItem, false);
        ContextMenuExpandCollapse(this, true);
        lastMenuItem = this;
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuEnhancing);


    var tcoContextMenuEnhancing_AutoEnh = document.createElement('div');
    tcoContextMenuEnhancing_AutoEnh.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuEnhancing_SubItem';
    tcoContextMenuEnhancing_AutoEnh.innerHTML = 'Auto Enhance';
    if ( (isThrone && throneItem.quality < tcoMaxThroneQuality) || (!isThrone && champItem.rarity < tcoMaxChampQuality) ) {
        tcoContextMenuEnhancing_AutoEnh.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone)
                Tabs.throneUpgrader.addEnhanceItem(itemId);
            else
                Tabs.champUpgrader.addEnhanceItem(itemId);
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuEnhancing_AutoEnh.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuEnhancing_AutoEnh);

    var tcoContextMenuEnhancing_Enhance = document.createElement('div');
    tcoContextMenuEnhancing_Enhance.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuEnhancing_SubItem';
    tcoContextMenuEnhancing_Enhance.innerHTML = 'Enhance';
    if (!fromOrganizer) {
        if ( ( (isThrone && throneItem.quality < tcoMaxThroneQuality) || (!isThrone && champItem.rarity < tcoMaxChampQuality) ) && !isBroken ) {
            tcoContextMenuEnhancing_Enhance.addEventListener('click', function(A) {
                A.stopPropagation();
                if (isThrone) {
                    if (!cmContainerOpen) CM.ThroneView.openThrone();
                    CM.ThronePanelView.renderPanel("enhance", throneItem)
                } else {
                    if (!cmContainerOpen) CM.ChampionModalController.open();
                    CM.ChampionModalView.upgEnhSlideIn(itemId, "enh");
                }
                tcoContextMenu.remove();
            }, false);
        } else {
            tcoContextMenuEnhancing_Enhance.className += ' tcoDisabled';
        }
    } else {
        tcoContextMenuEnhancing_Enhance.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuEnhancing_Enhance);

    var tcoContextMenuEnhancing_Jewel = document.createElement('div');
    tcoContextMenuEnhancing_Jewel.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuEnhancing_SubItem';
    tcoContextMenuEnhancing_Jewel.innerHTML = 'Jewel';
    if (isThrone && !isBroken) {
        tcoContextMenuEnhancing_Jewel.addEventListener('click', function(A) {
            A.stopPropagation();
            if (!cmContainerOpen) CM.ThroneView.openThrone();
            CM.ThronePanelView.renderPanel("jewel", throneItem)
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuEnhancing_Jewel.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuEnhancing_Jewel);

    var tcoContextMenuEquipping = document.createElement('div');
    tcoContextMenuEquipping.className = 'tcoContextMenuItem tcoBrown';
    tcoContextMenuEquipping.innerHTML = 'EQUIPPING';
    tcoContextMenuEquipping.id = 'tcoContextMenuEquipping';
    tcoContextMenuEquipping.addEventListener('click', function(A) {
        if (lastMenuItem == this) {
            ContextMenuExpandCollapse(this, false);
            lastMenuItem = null;
            return;
        }
        A.stopPropagation();
        if (lastMenuItem == null) lastMenuItem = this;
        if (lastMenuItem.id != this.id) ContextMenuExpandCollapse(lastMenuItem, false);
        ContextMenuExpandCollapse(this, true);
        lastMenuItem = this;
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuEquipping);

    var tcoContextMenuEquipping_Equip = document.createElement('div');
    tcoContextMenuEquipping_Equip.className = 'tcoContextMenuSubItem tcoContextHidden tcoGreen tcoContextMenuEquipping_SubItem';
    tcoContextMenuEquipping_Equip.innerHTML = 'Equip';
    if (!isBroken) {
        if ( (!throneItem.isEquipped && isThrone) || (!isThrone && champItem.equippedTo != championId) ) {
            tcoContextMenuEquipping_Equip.addEventListener('click', function(A) {
                A.stopPropagation();
                if (isThrone)
                    CM.ThroneController.equipItem(throneItem);
                else
                    Tabs.champPresets.equipItem(itemId);
                tcoContextMenu.remove();
            }, false);
        } else {
            tcoContextMenuEquipping_Equip.className += ' tcoDisabled';
        }
    } else {
        tcoContextMenuEquipping_Equip.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuEquipping_Equip);

    var tcoContextMenuEquipping_Unequip = document.createElement('div');
    tcoContextMenuEquipping_Unequip.className = 'tcoContextMenuSubItem tcoContextHidden tcoGreen tcoContextMenuEquipping_SubItem';
    tcoContextMenuEquipping_Unequip.innerHTML = 'Unequip';
    if (!isBroken) {
        if ( (throneItem.isEquipped && isThrone) || (!isThrone && champItem.equippedTo == championId) ) {
            tcoContextMenuEquipping_Unequip.addEventListener('click', function(A) {
                A.stopPropagation();
                if (isThrone)
                    CM.ThroneController.unequipItem(throneItem);
                else
                    Tabs.champPresets.unequipItem(itemId);
                tcoContextMenu.remove();
            }, false);
        } else {
            tcoContextMenuEquipping_Unequip.className += ' tcoDisabled';
        }
    } else {
        tcoContextMenuEquipping_Unequip.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuEquipping_Unequip);


    var tcoContextMenuEquipping_UnequipAll = document.createElement('div');
    tcoContextMenuEquipping_UnequipAll.className = 'tcoContextMenuSubItem tcoContextHidden tcoGreen tcoContextMenuEquipping_SubItem';
    tcoContextMenuEquipping_UnequipAll.innerHTML = 'Unequip All';
    tcoContextMenuEquipping_UnequipAll.addEventListener('click', function(A) {
        A.stopPropagation();
        if (confirm('Are you sure you want to unequip all cards?')) {
            if (isThrone)
                Tabs.thronePresets.unequipAllItems(presetSlot);
            else
                Tabs.champPresets.unequipAllItems(presetSlot);
        }
        tcoContextMenu.remove();
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuEquipping_UnequipAll);


    var tcoContextMenuRepair = document.createElement('div');
    tcoContextMenuRepair.className = 'tcoContextMenuItem tcoBrown';
    tcoContextMenuRepair.innerHTML = 'REPAIR';
    tcoContextMenuRepair.id = 'tcoContextMenuRepair';
    tcoContextMenuRepair.addEventListener('click', function(A) {
        if (lastMenuItem == this) {
            ContextMenuExpandCollapse(this, false);
            lastMenuItem = null;
            return;
        }
        A.stopPropagation();
        if (lastMenuItem == null) lastMenuItem = this;
        if (lastMenuItem.id != this.id) ContextMenuExpandCollapse(lastMenuItem, false);
        ContextMenuExpandCollapse(this, true);
        lastMenuItem = this;
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuRepair);


    var tcoContextMenuRepair_Repair = document.createElement('div');
    tcoContextMenuRepair_Repair.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuRepair_SubItem';
    tcoContextMenuRepair_Repair.innerHTML = 'Repair Card';
    if (isBroken) {
        tcoContextMenuRepair_Repair.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone)
                CM.ThronePanelView.renderBroken(throneItem);
            else
                CM.ChampionPanelView.renderBroken(champItem);
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuRepair_Repair.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuRepair_Repair);


    var tcoContextMenuRepair_AutoRepair = document.createElement('div');
    tcoContextMenuRepair_AutoRepair.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuRepair_SubItem';
    tcoContextMenuRepair_AutoRepair.innerHTML = 'Auto Repair';
    if (isBroken) {
        tcoContextMenuRepair_AutoRepair.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone) {
                Tabs.throneRepair.addQueue(itemId);
                Tabs.throneRepair.buildThroneRepairDisplay();
            } else {
                Tabs.champRepair.addQueue(itemId);
                Tabs.champRepair.buildChampRepairDisplay();
            }
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuRepair_AutoRepair.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuRepair_AutoRepair);


    var tcoContextMenuRepair_AutoRepairAll = document.createElement('div');
    tcoContextMenuRepair_AutoRepairAll.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuRepair_SubItem';
    tcoContextMenuRepair_AutoRepairAll.innerHTML = 'Auto Repair All';
    if (isRepairAll) {
        tcoContextMenuRepair_AutoRepairAll.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone) {
                Tabs.throneRepair.addAllQueue();
                Tabs.throneRepair.buildThroneRepairDisplay();
            } else {
                Tabs.champRepair.addAllQueue();
                Tabs.champRepair.buildChampRepairDisplay();
            }
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuRepair_AutoRepairAll.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuRepair_AutoRepairAll);

    var tcoContextMenuSalvaging = document.createElement('div');
    tcoContextMenuSalvaging.className = 'tcoContextMenuItem tcoBrown';
    tcoContextMenuSalvaging.innerHTML = 'SALVAGING';
    tcoContextMenuSalvaging.id = 'tcoContextMenuSalvaging';
    tcoContextMenuSalvaging.addEventListener('click', function(A) {
        if (lastMenuItem == this) {
            ContextMenuExpandCollapse(this, false);
            lastMenuItem = null;
            return;
        }
        A.stopPropagation();
        if (lastMenuItem == null) lastMenuItem = this;
        if (lastMenuItem.id != this.id) ContextMenuExpandCollapse(lastMenuItem, false);
        ContextMenuExpandCollapse(this, true);
        lastMenuItem = this;
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuSalvaging);
    
    var tcoContextMenuSalvaging_Salvage = document.createElement('div');
    tcoContextMenuSalvaging_Salvage.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuSalvaging_SubItem';
    tcoContextMenuSalvaging_Salvage.innerHTML = 'Salvage';
    if (!isBroken) {
        if (!(inPresets && tcoGeneralOptions.noEquippedSalvage)) {
            if (((!tcoGeneralOptions.throneSalvageSafety) || (tcoGeneralOptions.throneSalvageSafety && itemIndex > tcoGeneralOptions.throneSalvageSafetyNum)) ||
            ((!tcoGeneralOptions.champSalvageSafety) || (tcoGeneralOptions.champSalvageSafety && itemIndex > tcoGeneralOptions.champSalvageSafetyNum))) {
                if (!(isThrone && hasJewel)) {
                    tcoContextMenuSalvaging_Salvage.addEventListener('click', function(A) {
                        A.stopPropagation();
                        if (confirm('Are you sure you want to salvage this item?')) {
                            if (isThrone) {
                                SalvageThroneItem(itemId);
                            } else {
                                SalvageChampItem(itemId);
                                if (cmContainerOpen) CM.ChampionModalController.open()
                                Tabs.champPreview.clearChampPreviewCard(itemId);
                                Tabs.champOrganizer.paintChampTables();
                            }
                        }
                        tcoContextMenu.remove();
                    }, false);
                } else {
                    tcoContextMenuSalvaging_Salvage.className += ' tcoDisabled';
                }
            } else {
                tcoContextMenuSalvaging_Salvage.className += ' tcoDisabled';
            }
        } else {
            tcoContextMenuSalvaging_Salvage.className += ' tcoDisabled';
        }
    } else {
        tcoContextMenuSalvaging_Salvage.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuSalvaging_Salvage);


    var tcoContextMenuSalvaging_Forced = document.createElement('div');
    tcoContextMenuSalvaging_Forced.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuSalvaging_SubItem';
    tcoContextMenuSalvaging_Forced.innerHTML = 'Forced Salvage';
    if (!isBroken && isThrone && hasJewel && !tcoGeneralOptions.noForcedSalvage) {
        if (!(inPresets && tcoGeneralOptions.noEquippedSalvage)) {
            tcoContextMenuSalvaging_Forced.addEventListener('click', function(A) {
                A.stopPropagation();
                if (confirm('Are you sure you want to forced salvage this item?'))
                    Tabs.throneSalvager.forceSalvage(itemId);
                else
                    return;
                tcoContextMenu.remove();
            }, false);
        } else {
            tcoContextMenuSalvaging_Forced.className += ' tcoDisabled';
        }
    } else {
        tcoContextMenuSalvaging_Forced.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuSalvaging_Forced);


    var tcoContextMenuSalvaging_Mass = document.createElement('div');
    tcoContextMenuSalvaging_Mass.className = 'tcoContextMenuSubItem tcoContextHidden tcoBlue tcoContextMenuSalvaging_SubItem';
    tcoContextMenuSalvaging_Mass.innerHTML = 'Mass Salvage';
    if (!tcoGeneralOptions.noMassSalvage) {
        tcoContextMenuSalvaging_Mass.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone)
                CM.ThroneView.renderMassSalvage();
            else
                CM.ChampionModalView.renderMassSalvage();
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuSalvaging_Mass.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuSalvaging_Mass);

    var tcoContextMenuStats = document.createElement('div');
    tcoContextMenuStats.className = 'tcoContextMenuItem tcoBrown';
    tcoContextMenuStats.innerHTML = 'STATS';
    tcoContextMenuStats.id = 'tcoContextMenuStats';
    tcoContextMenuStats.addEventListener('click', function(A) {
        if (lastMenuItem == this) {
            ContextMenuExpandCollapse(this, false);
            lastMenuItem = null;
            return;
        }
        A.stopPropagation();
        if (lastMenuItem == null) lastMenuItem = this;
        if (lastMenuItem.id != this.id) ContextMenuExpandCollapse(lastMenuItem, false);
        ContextMenuExpandCollapse(this, true);
        lastMenuItem = this;
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuStats);


    var tcoContextMenuStats_Copy = document.createElement('div');
    tcoContextMenuStats_Copy.className = 'tcoContextMenuSubItem tcoContextHidden tcoRed tcoContextMenuStats_SubItem';
    tcoContextMenuStats_Copy.innerHTML = 'Copy Stats';
    tcoContextMenuStats_Copy.addEventListener('click', function(A) {
        A.stopPropagation();
        if (isThrone) {
            var displayText = getThroneItemStats(itemId, "    ");
            if (displayText != "") window.prompt("Copy to clipboard: Ctrl+C", displayText);
        } else {
            var displayText = getChampItemStats(itemId, "    ");
            if (displayText != "") window.prompt("Copy to clipboard: Ctrl+C", displayText);
        }
        tcoContextMenu.remove();
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuStats_Copy);


    var tcoContextMenuStats_Post = document.createElement('div');
    tcoContextMenuStats_Post.className = 'tcoContextMenuSubItem tcoContextHidden tcoRed tcoContextMenuStats_SubItem';
    tcoContextMenuStats_Post.innerHTML = 'Post Stats';
    tcoContextMenuStats_Post.addEventListener('click', function(A) {
        A.stopPropagation();
        if (isThrone)
            sendChat(getThroneItemStats(itemId, '||'));
        else
            sendChat(getChampItemStats(itemId, '||'));
        tcoContextMenu.remove();
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuStats_Post);


    var tcoContextMenuStats_Export = document.createElement('div');
    tcoContextMenuStats_Export.className = 'tcoContextMenuSubItem tcoContextHidden tcoRed tcoContextMenuStats_SubItem';
    tcoContextMenuStats_Export.innerHTML = 'Export Cards';
    tcoContextMenuStats_Export.addEventListener('click', function(A) {
        A.stopPropagation();
        if (isThrone)
            ExportThroneToExcel(false);
        else
            ExportChampToExcel(false);
        tcoContextMenu.remove();
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuStats_Export);

    var tcoContextMenuStats_Compare = document.createElement('div');
    tcoContextMenuStats_Compare.className = 'tcoContextMenuSubItem tcoContextHidden tcoRed tcoContextMenuStats_SubItem';
    tcoContextMenuStats_Compare.innerHTML = 'Send To Compare';
    tcoContextMenuStats_Compare.addEventListener('click', function(A) {
        A.stopPropagation();
        if (isThrone)
            Tabs.throneCompare.sendToCompare(itemId);
        else
            Tabs.champCompare.sendToCompare(itemId);
        tcoContextMenu.remove();
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuStats_Compare);


    var tcoContextMenuPresets = document.createElement('div');
    tcoContextMenuPresets.className = 'tcoContextMenuItem tcoBrown';
    tcoContextMenuPresets.innerHTML = 'PRESETS';
    tcoContextMenuPresets.id = 'tcoContextMenuPresets';
    tcoContextMenuPresets.addEventListener('click', function(A) {
        if (lastMenuItem == this) {
            ContextMenuExpandCollapse(this, false);
            lastMenuItem = null;
            return;
        }
        A.stopPropagation();
        if (lastMenuItem == null) lastMenuItem = this;
        if (lastMenuItem.id != this.id) ContextMenuExpandCollapse(lastMenuItem, false);
        ContextMenuExpandCollapse(this, true);
        lastMenuItem = this;
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuPresets);


    var tcoContextMenuPresets_EquipPreset = document.createElement('div');
    tcoContextMenuPresets_EquipPreset.className = 'tcoContextMenuSubItem tcoContextHidden tcoRed tcoContextMenuPresets_SubItem';
    tcoContextMenuPresets_EquipPreset.innerHTML = 'Equip Tag #' + presetSlot;
    if (presetTagCount != 0) {
        tcoContextMenuPresets_EquipPreset.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone)
                Tabs.thronePresets.equipPresetTags(presetSlot);
            else
                Tabs.champPresets.equipPresetTags(presetSlot);
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuPresets_EquipPreset.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuPresets_EquipPreset);


    var tcoContextMenuPresets_ClearPreset = document.createElement('div');
    tcoContextMenuPresets_ClearPreset.className = 'tcoContextMenuSubItem tcoContextHidden tcoRed tcoContextMenuPresets_SubItem';
    tcoContextMenuPresets_ClearPreset.innerHTML = 'Clear Tag #' + presetSlot;
    if (presetTagCount != 0) {
        tcoContextMenuPresets_ClearPreset.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone) {
                Tabs.thronePresets.clearPresetTags(presetSlot);
                Tabs.thronePresets.paintTags();
            } else {
                Tabs.champPresets.clearPresetTags(presetSlot);
                Tabs.champPresets.paintTags();
            }
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuPresets_ClearPreset.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuPresets_ClearPreset);


    var tcoContextMenuPresets_SavePreset = document.createElement('div');
    tcoContextMenuPresets_SavePreset.className = 'tcoContextMenuSubItem tcoContextHidden tcoRed tcoContextMenuPresets_SubItem';
    tcoContextMenuPresets_SavePreset.innerHTML = 'Save Tag #' + presetSlot;
    tcoContextMenuPresets_SavePreset.addEventListener('click', function(A) {
        A.stopPropagation();
        if (isThrone) {
            Tabs.thronePresets.addPresetTags(presetSlot);
            Tabs.thronePresets.paintTags();
        } else {
            Tabs.champPresets.addPresetTags(presetSlot);
            Tabs.champPresets.paintTags();
        }
        tcoContextMenu.remove();
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuPresets_SavePreset);


    var tcoContextMenuPresets_LoadToPreview = document.createElement('div');
    tcoContextMenuPresets_LoadToPreview.className = 'tcoContextMenuSubItem tcoContextHidden tcoRed tcoContextMenuPresets_SubItem';
    tcoContextMenuPresets_LoadToPreview.innerHTML = 'Send To Preview';
    tcoContextMenuPresets_LoadToPreview.addEventListener('click', function(A) {
        A.stopPropagation();
        if (isThrone) {
            Tabs.thronePreview.loadThronePreviewCard(itemId, throneItem.type);
            Tabs.thronePreview.buildThronePreviewValueDisplay();
        } else {
            Tabs.champPreview.loadChampPreviewCard(itemId);
            Tabs.champPreview.buildChampPreviewValueDisplay();
        }
        tcoContextMenu.remove();
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuPresets_LoadToPreview);


    var tcoContextMenuTagging = document.createElement('div');
    tcoContextMenuTagging.className = 'tcoContextMenuItem tcoBrown';
    tcoContextMenuTagging.innerHTML = 'TAGGING';
    tcoContextMenuTagging.id = 'tcoContextMenuTagging';
    tcoContextMenuTagging.addEventListener('click', function(A) {
        if (lastMenuItem == this) {
            ContextMenuExpandCollapse(this, false);
            lastMenuItem = null;
            return;
        }
        A.stopPropagation();
        if (lastMenuItem == null) lastMenuItem = this;
        if (lastMenuItem.id != this.id) ContextMenuExpandCollapse(lastMenuItem, false);
        ContextMenuExpandCollapse(this, true);
        lastMenuItem = this;
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuTagging);


    var tcoContextMenuTagging_TagItem = document.createElement('div');
    tcoContextMenuTagging_TagItem.className = 'tcoContextMenuSubItem tcoContextHidden tcoGreen tcoContextMenuTagging_SubItem';
    tcoContextMenuTagging_TagItem.innerHTML = 'Tag Item';
    if ( (!tcoThronePresetData.taggedItems[itemId] && isThrone) || (!tcoChampPresetData.taggedItems[itemId] && !isThrone) ) {
        tcoContextMenuTagging_TagItem.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone) {
                Tabs.thronePresets.addTagItem(itemId);
                Tabs.thronePresets.paintTags();
            } else {
                Tabs.champPresets.addTagItem(itemId);
                Tabs.champPresets.paintTags();
            }
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuTagging_TagItem.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuTagging_TagItem);


    var tcoContextMenuTagging_RemoveTag = document.createElement('div');
    tcoContextMenuTagging_RemoveTag.className = 'tcoContextMenuSubItem tcoContextHidden tcoGreen tcoContextMenuTagging_SubItem';
    tcoContextMenuTagging_RemoveTag.innerHTML = 'Remove Tag';
    if ( (tcoThronePresetData.taggedItems[itemId] && isThrone) || (tcoChampPresetData.taggedItems[itemId] && !isThrone) ) {
        tcoContextMenuTagging_RemoveTag.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone) {
                Tabs.thronePresets.removeTagItem(itemId);
                Tabs.thronePresets.paintTags();
            } else {
                Tabs.champPresets.removeTagItem(itemId);
                Tabs.champPresets.paintTags();
            }
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuTagging_RemoveTag.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuTagging_RemoveTag);


    var tcoContextMenuTagging_TagItemAll = document.createElement('div');
    tcoContextMenuTagging_TagItemAll.className = 'tcoContextMenuSubItem tcoContextHidden tcoGreen tcoContextMenuTagging_SubItem';
    tcoContextMenuTagging_TagItemAll.innerHTML = 'Tag All';
    tcoContextMenuTagging_TagItemAll.addEventListener('click', function(A) {
        A.stopPropagation();
        if (isThrone) {
            Tabs.thronePresets.addAllTagItems();
            Tabs.thronePresets.paintTags();
        } else {
            Tabs.champPresets.addAllTagItems();
            Tabs.champPresets.paintTags();
        }
        tcoContextMenu.remove();
    }, false);
    tcoContextMenu.appendChild(tcoContextMenuTagging_TagItemAll);


    var tcoContextMenuTagging_RemoveTagAll = document.createElement('div');
    tcoContextMenuTagging_RemoveTagAll.className = 'tcoContextMenuSubItem tcoContextHidden tcoGreen tcoContextMenuTagging_SubItem';
    tcoContextMenuTagging_RemoveTagAll.innerHTML = 'Remove All Tags';
    if ( (isThrone && getObjectCollectionCount(tcoThronePresetData.taggedItems) > 0) || 
         (!isThrone && getObjectCollectionCount(tcoChampPresetData.taggedItems) > 0) ) {
        tcoContextMenuTagging_RemoveTagAll.addEventListener('click', function(A) {
            A.stopPropagation();
            if (isThrone) {
                Tabs.thronePresets.clearAllTagItems();
                Tabs.thronePresets.paintTags();
            } else {
                Tabs.champPresets.removeAllTagItems();
                Tabs.champPresets.paintTags();
            }
            tcoContextMenu.remove();
        }, false);
    } else {
        tcoContextMenuTagging_RemoveTagAll.className += ' tcoDisabled';
    }
    tcoContextMenu.appendChild(tcoContextMenuTagging_RemoveTagAll);

    var tcoContextMenuCardInfo = document.createElement('div');
    tcoContextMenuCardInfo.innerHTML = howManyMessage;

    tcoContextMenu.appendChild(tcoContextMenuCardInfo);

    if (fromOrganizer) tileDiv.insertBefore(tcoContextMenu,  tileDiv.firstChild);

}

var sectionOpener = function() {
    var imgs = this.childNodes;
    if (imgs[0].src == tcoDownArrow) {
        imgs[0].src = tcoRightArrow
        imgs[2].src = tcoRightArrow
    } else {
        imgs[0].src = tcoDownArrow
        imgs[2].src = tcoDownArrow
    }
    var section = this.nextSibling;
    if (section.className != "tcoSection") return;
    var sections = document.getElementsByClassName('tcoSection');
    for (var sect=0;sect<sections.length;sect++) {
        if (section != sections[sect]) {
            sections[sect].style.display = "none";
            var nextImgs = sections[sect].previousSibling.childNodes;
            nextImgs[0].src = tcoRightArrow
            nextImgs[2].src = tcoRightArrow
        }
    }
    if (section.style.display == "block") {
        section.style.display = "none";
    } else {
        section.style.display = "block";
    }
};

//onClick (city{name, id, x, y}, x, y) city may be null!
function CdispCityPicker (id, span, dispName, notify, selbut){
    function CcityButHandler (t) {
        var that = t;

        function clickedCityBut (e){
            if (that.selected != null)
                that.selected.className = "tcoCastleButton tcoCastleButtonNot";
            that.city = Cities.cities[e.target.id.substr(that.prefixLen)];
            if (that.dispName)
                document.getElementById(that.id+'cname').innerHTML = that.city.name;
            e.target.className = "tcoCastleButton tcoCastleButtonSelect";
            that.selected = e.target;
            if (that.coordBoxX){
                that.coordBoxX.value = that.city.x;
                that.coordBoxY.value = that.city.y;
                var evt = document.createEvent("HTMLEvents");
                evt.initEvent('change', true, true ); // event (type,bubbling,cancelable)
                that.coordBoxX.dispatchEvent(evt);
                that.coordBoxY.dispatchEvent(evt);
                that.coordBoxX.style.backgroundColor = '#ffffff';
                that.coordBoxY.style.backgroundColor = '#ffffff';
            }
            if (that.notify != null)
                that.notify(that.city, that.city.x, that.city.y);
        }

        this.clickedCityBut = clickedCityBut;
    }

    function selectBut (idx){
        document.getElementById(this.id+'_'+idx).click();
    }

    function bindToXYboxes (eX, eY){
        function CboxHandler (t){
            var that = t;
            this.eventChange = eventChange;
            if (that.city){
                eX.value = that.city.x;
                eY.value = that.city.y;
            }
            function eventChange (){
                var xValue=that.coordBoxX.value.trim();
                var xI=/^\s*([0-9]+)[\s|,|-|.]+([0-9]+)/.exec(xValue);
                if(xI) {
                    that.coordBoxX.value=xI[1]
                    that.coordBoxY.value=xI[2]
                }
                var x = parseInt(that.coordBoxX.value, 10);
                var y = parseInt(that.coordBoxY.value, 10);
                if (isNaN(x) || x<0 || x>750){
                    that.coordBoxX.style.backgroundColor = '#ff8888';
                    return;
                }
                if (isNaN(y) || y<0 || y>750){
                    that.coordBoxY.style.backgroundColor = '#ff8888';
                    return;
                }
                that.coordBoxX.style.backgroundColor = '#ffffff';
                that.coordBoxY.style.backgroundColor = '#ffffff';
                if (that.notify != null)
                    that.notify (null, x, y);
            }
            return false;
        }
        this.coordBoxX = eX;
        this.coordBoxY = eY;
        var bh = new CboxHandler(this);
        eX.maxLength=8;
        eY.maxLength=3;
        eX.style.width='2em';
        eY.style.width='2em';
        eX.addEventListener('change', bh.eventChange, false);
        eY.addEventListener('change', bh.eventChange, false);
    }

    this.selectBut = selectBut;
    this.bindToXYboxes = bindToXYboxes;
    this.coordBoxX = null;
    this.coordBoxY = null;
    this.id = id;
    this.dispName = dispName;
    this.prefixLen = id.length+1;
    this.notify = notify;
    this.selected = null;
    this.city = null;
    var m = '';
    for (var i=0; i < Cities.cities.length; i++)
        m += '<input class="tcoCastleButton tcoCastleButtonNot" id="'+ id +'_'+ i +'" value="'+ (i+1) +'" type=button />';
    if (dispName)
        m += ' &nbsp; <span style="display:inline-block; width:85px; font-weight:bold;" id='+ id +'cname' +'></span>';
    span.innerHTML = m;
    var handler = new CcityButHandler(this);
    for (var i=0; i < Cities.cities.length; i++)
        document.getElementById (id+'_'+i).addEventListener('click', handler.clickedCityBut, false);
    if (selbut != null)
        this.selectBut(selbut);
};

function upgradeIt(citynum, chId, cost) {
    var t = Tabs.champPresets;
    var params = uW.Object.clone(ajfx);
    params.action = '5';
    params.cityId = citynum;
    params.eid = chId;
    params.chanceItem = 0;
    params.aetherstones = cost;
    params.gems = 0;
	new AjaxRequest(uW.g_ajaxpath + "ajax/ceEquipmentManagerAjax.php" + uW.g_ajaxsuffix, {
		method: "post",
		parameters: params,
		loading: true,
		onSuccess: function (transport) {
            try {
				var rslt = eval("(" + transport.responseText + ")");
				if (rslt.ok) {
                    t.broke_items += 1;
                    t.setBreakStatus();
                    Seed.resources["city" + citynum]["rec5"][0] = Seed.resources["city" + citynum]["rec5"][0] - parseInt(rslt.aetherstones);
					if (rslt.updateSeed) uW.update_seed(rslt.updateSeed);
				}
				if (rslt.gems > 0) {
                	alert("UNEXPECTED ERROR: 'BREAK CH' accidentally spent gems.... Refreshing to stop the feature now!");
                    ActionLog('BREAK CH accidentally spent gems!  Stopping now!');
                    RefreshCamelot();
                    return false;
                }
	        } catch (e) {
	        }
		},
		onFailure: function (rrr) {
		}		
	});
    return true;
}

function repairTimeToText(total_time) {
    var secondsInMinutes = 60;
    var secondsInHours = 3600;
    var secondsInDays = 43200;

    var totalDays = 0;
    var totalHours = 0;
    var totalMinutes = 0;

    if (total_time > secondsInDays) {
        totalDays = (total_time - (total_time % secondsInDays)) / secondsInDays;
        total_time = total_time % secondsInDays;
    }
    if (total_time > secondsInHours) {
        totalHours = (total_time - (total_time % secondsInHours)) / secondsInHours;
        total_time = total_time % secondsInHours;
    }
    if (total_time > secondsInMinutes) {
        totalMinutes = (total_time - (total_time % secondsInMinutes)) / secondsInMinutes;
        total_time = total_time % secondsInMinutes;
    }
    var totalSeconds = total_time;

    return (totalDays + " Days " + totalHours + " Hours " + totalMinutes + " Minutes " + totalSeconds + " Seconds");
};

function ExportChampPresetToExcel(presetNumber) {
    var headers = [ "ID", "NAME", "FACTION", "QUALITY", "TYPE", "LEVEL", "MIGHT", "ROW 1", "ROW 2", "ROW 3", "ROW 4", "ROW 5"];
    var ExcelTable = document.createElement('table');
    var ExcelBody = document.createElement('tbody');
    var ExcelRow = document.createElement('tr'); 
    var ExcelColumn = "";
    for (i = 0; i < headers.length; i++) {
        ExcelColumn = document.createElement('th');
        ExcelColumn.appendChild(document.createTextNode(headers[i]));
        ExcelRow.appendChild(ExcelColumn);
    }
    ExcelBody.appendChild(ExcelRow);
    
    var columns = [];

    var preset = getChampPresetObject(parseInt(presetNumber));

    for (chId in preset) {
        var champ_item = uW.kocChampionItems[chId];
        if (!champ_item) continue;
        columns = [];
        columns.push(chId);
        columns.push(champ_item.name);
        columns.push(CM.CHAMPION.getFactionClasses(champ_item.faction));
        if (champ_item.unique) {
            columns.push("unique");
        } else {
            columns.push(CM.CHAMPION.getRarityClasses(champ_item.rarity));
        }
        columns.push(CM.CHAMPION.getEquipmentNames(champ_item.type));
        columns.push(champ_item.level);
        columns.push(champ_item.might);
        for (var slotNumber = 1; slotNumber < tcoMaxChampQuality + 1; slotNumber++) {
            var effectLine = champ_item.effects[slotNumber];
            var effect = CM.ChampionManager.getEffect(effectLine, champ_item.level);
            columns.push(effect.amount + " " + effect.name);
        }
        columns.reverse();
        ExcelRow = document.createElement('tr');
        while (columns.length > 0) {
            ExcelColumn = document.createElement('td');
            ExcelColumn.appendChild(document.createTextNode(columns.pop()));
            ExcelRow.appendChild(ExcelColumn);
        }
        ExcelBody.appendChild(ExcelRow);
    }
    ExcelTable.appendChild(ExcelBody);

    window.open('data:application/vnd.ms-excel,' + encodeURIComponent(ExcelTable.outerHTML));
}

function ExportChampToExcel(preview) {
    var headers = [ "ID", "NAME", "FACTION", "QUALITY", "TYPE", "LEVEL", "MIGHT", "ROW 1", "ROW 2", "ROW 3", "ROW 4", "ROW 5"];
    var ExcelTable = document.createElement('table');
    var ExcelBody = document.createElement('tbody');
    var ExcelRow = document.createElement('tr'); 
    var ExcelColumn = "";
    for (i = 0; i < headers.length; i++) {
        ExcelColumn = document.createElement('th');
        ExcelColumn.appendChild(document.createTextNode(headers[i]));
        ExcelRow.appendChild(ExcelColumn);
    }
    ExcelBody.appendChild(ExcelRow);
    
    var columns = [];

    for (chId in uW.kocChampionItems) {
        if (preview && tcoChampPresetData.previewChamp.indexOf(chId) == -1 ) continue;
        var champ_item = uW.kocChampionItems[chId];
        if (!champ_item) continue;
        columns = [];
        columns.push(chId);
        columns.push(champ_item.name);
        columns.push(CM.CHAMPION.getFactionClasses(champ_item.faction));
        if (champ_item.unique) {
            columns.push("unique");
        } else {
            columns.push(CM.CHAMPION.getRarityClasses(champ_item.rarity));
        }
        columns.push(CM.CHAMPION.getEquipmentNames(champ_item.type));
        columns.push(champ_item.level);
        columns.push(champ_item.might);
        for (var slotNumber = 1; slotNumber < tcoMaxChampQuality + 1; slotNumber++) {
            var effectLine = champ_item.effects[slotNumber];
            var effect = CM.ChampionManager.getEffect(effectLine, champ_item.level);
            columns.push(effect.amount + " " + effect.name);
        }
        columns.reverse();
        ExcelRow = document.createElement('tr');
        while (columns.length > 0) {
            ExcelColumn = document.createElement('td');
            ExcelColumn.appendChild(document.createTextNode(columns.pop()));
            ExcelRow.appendChild(ExcelColumn);
        }
        ExcelBody.appendChild(ExcelRow);
    }
    ExcelTable.appendChild(ExcelBody);

    window.open('data:application/vnd.ms-excel,' + encodeURIComponent(ExcelTable.outerHTML));
};

function ExportThronePresetToExcel(presetNumber) {
    var headers = [ "ID", "NAME", "FACTION", "QUALITY", "TYPE", "LEVEL", "MIGHT", "JEWEL", "ROW 1", "ROW 2", "ROW 3", "ROW 4", "ROW 5", "ROW 6"];
    var ExcelTable = document.createElement('table');
    var ExcelBody = document.createElement('tbody');
    var ExcelRow = document.createElement('tr'); 
    var ExcelColumn = "";
    for (i = 0; i < headers.length; i++) {
        ExcelColumn = document.createElement('th');
        ExcelColumn.appendChild(document.createTextNode(headers[i]));
        ExcelRow.appendChild(ExcelColumn);
    }
    ExcelBody.appendChild(ExcelRow);
    
    var columns = [];
    
    var preset = getThronePresetObject(parseInt(presetNumber));

    for (trId in preset) {
        var throne_item = uW.kocThroneItems[trId];
        if (!throne_item) continue;
        columns = [];
        columns.push(trId);
        columns.push(throne_item.name);
        columns.push(throne_item.faction);
        columns.push(throne_item.quality);
        columns.push(throne_item.type);
        columns.push(throne_item.level);
        columns.push(CM.ThroneView.getMightBonus(throne_item));
        if (throne_item.jewel) {
            var jewel_item = throne_item.jewel;
            var qlty = CM.thronestats.jewelGrowthLimit[jewel_item.quality];
            var amt = CM.ThroneController.getEffectAmount(jewel_item, qlty);
            var jewelName = CM.ThroneController.jewelName(jewel_item);
            if (amt == 0) jewelName = "none";
            columns.push(jewelName);
        } else {
            columns.push("none");
        }
        for (var O in throne_item["effects"]) {
            var slotNumber = +(O.split("slot")[1]);
            var id = throne_item["effects"]["slot" + slotNumber]["id"];
            var tier = parseInt(throne_item["effects"]["slot" + slotNumber]["tier"]);
            var level = throne_item.level;
            p = CM.thronestats.tiers[id][tier];
            var effectName = CM.thronestats["effects"][id]["1"];
            while (!p && (tier > 0)) { tier--; p = CM.thronestats.tiers[id][tier]; }
            if (!p) continue; // can't find stats for tier

            if (slotNumber == 6) {
                JewelQuality = throne_item["effects"]["slot" + slotNumber].quality;
                GrowthLimit = CM.thronestats.jewelGrowthLimit[JewelQuality];
                if (GrowthLimit <= level) level = GrowthLimit
            }
            var Current = p.base + ((level * level + level) * p.growth * 0.5);
            columns.push(Current + "% " + effectName);
        }
        
        columns.reverse();
        ExcelRow = document.createElement('tr');
        while (columns.length > 0) {
            ExcelColumn = document.createElement('td');
            ExcelColumn.appendChild(document.createTextNode(columns.pop()));
            ExcelRow.appendChild(ExcelColumn);
        }
        ExcelBody.appendChild(ExcelRow);
    }
    ExcelTable.appendChild(ExcelBody);

    window.open('data:application/vnd.ms-excel,' + encodeURIComponent(ExcelTable.outerHTML));
};

function getThroneMight() {
    var totMight = 0;
    for (trId in uW.kocThroneItems) {
        var throne_item = uW.kocThroneItems[trId];
        if (throne_item == null || !throne_item) continue;
        totMight += CM.ThroneView.getMightBonus(throne_item);
    }
    return addCommas(totMight);
};

function postThroneSlot( slot ) {
    var throneStats = GenerateThronePresetEffectsString(Seed.throne.slotEquip[slot], false);
    var D = [];
    D.push("Throne Room Slot #" + slot);
    if (tcoThronePresetData.showThroneName) D.push("(" + tcoThronePresetData.presetNames[slot] + ")");
    if (tcoThronePresetData.showThroneMight) D.push("TR Might: " + getThroneMight());
    D.push(throneStats);

    sendChat(":::. |" + D.join("||"));
};

function postThronePreset( presetIndex ) {
    var trP = getThronePresetObject(parseInt(presetIndex));
    var D = [];
    for (var p in trP) D.push(p);
    var throneStats = GenerateThronePresetEffectsString(D, false);
    D = [];
    D.push("Throne Room Tag #" + presetIndex);
    if (tcoThronePresetData.showThroneName) D.push("(" + tcoThronePresetData.presetNames[presetIndex] + ")");
    if (tcoThronePresetData.showThroneMight) D.push("TR Might: " + getThroneMight());
    D.push(throneStats);

    sendChat(":::. |" + D.join("||"));
};

function GenerateThronePresetEffectsString(presetObject, htmlEffects ) {
    
    var J = new Array();

    var Effects = [];
    for (var effect in CM.thronestats.effects) Effects[effect] = 0;
    var counter = presetObject.length;
    var items = [];

    for (i = 0; i < counter; i++) items.push(presetObject[i]);

    while (items.length > 0) {
        var throne_item = uW.kocThroneItems[items.pop()];
        if (throne_item == null || !throne_item) continue;
        for (var O in throne_item["effects"]) {
            var slotNumber = +(O.split("slot")[1]);
            var id = throne_item["effects"]["slot" + slotNumber]["id"];
            var tier = parseInt(throne_item["effects"]["slot" + slotNumber]["tier"]);
            var level = throne_item.level;
            p = CM.thronestats.tiers[id][tier];
            while (!p && (tier > 0)) { tier--; p = CM.thronestats.tiers[id][tier]; }
            if (!p) continue; // can't find stats for tier

            if (slotNumber == 6) {
                JewelQuality = throne_item["effects"]["slot" + slotNumber].quality;
                GrowthLimit = CM.thronestats.jewelGrowthLimit[JewelQuality];
                if (GrowthLimit <= level) level = GrowthLimit
            }
            var Current = p.base + ((level * level + level) * p.growth * 0.5);
            if (slotNumber <= parseInt(throne_item.quality)) Effects[id] += Current;
        }
    }

    for (effect in Effects) {
        if (Effects[effect] && (Effects[effect] != 0) && CM.thronestats["effects"][effect]) {
            var effectName = CM.thronestats["effects"][effect]["1"];
            if (htmlEffects == true) {
                J.push("<div>" + (Math.round(Effects[effect] * 100) / 100) + '% ' + effectName + "</div>");
            } else {
                J.push((Math.round(Effects[effect] * 100) / 100) + '% ' + effectName);
            }
        }
    }
    if (htmlEffects == true) {
        return J.join("");
    } else {
        return J.join("||");
    }
};

function getObjectCollectionCount( objColl ) {
    var c = 0;
    for (var k in objColl) {
        c++;
    }
    return c;
};


function getChampPresetTagCount(presetIndex) {
    switch(presetIndex) {
        case 1:
            return getObjectCollectionCount(tcoChampPresetData.taggedItems01);
            break;
        case 2:
            return getObjectCollectionCount(tcoChampPresetData.taggedItems02);
            break;
        case 3:
            return getObjectCollectionCount(tcoChampPresetData.taggedItems03);
            break;
        case 4:
            return getObjectCollectionCount(tcoChampPresetData.taggedItems04);
            break;
    }
    return 0;
};

function getThronePresetTagCount(presetIndex) {
    switch(presetIndex) {
        case 1:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems01);
            break;
        case 2:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems02);
            break;
        case 3:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems03);
            break;
        case 4:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems04);
            break;
        case 5:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems05);
            break;
        case 6:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems06);
            break;
        case 7:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems07);
            break;
        case 8:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems08);
            break;
        case 9:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems09);
            break;
        case 10:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems10);
            break;
        case 11:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems11);
            break;
        case 12:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems12);
            break;
        case 13:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems13);
            break;
        case 14:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems14);
            break;
        case 15:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems15);
            break;
        case 16:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems16);
            break;
        case 17:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems17);
            break;
        case 18:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems18);
            break;
        case 19:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems19);
            break;
        case 20:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems20);
            break;
        case 21:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems21);
            break;
        case 22:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems22);
            break;
        case 23:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems23);
            break;
        case 24:
            return getObjectCollectionCount(tcoThronePresetData.taggedItems24);
            break;
    };
    return 0;
};

function getThronePresetObject(presetIndex) {
    switch(presetIndex) {
        case 1:
            return tcoThronePresetData.taggedItems01;
            break;
        case 2:
            return tcoThronePresetData.taggedItems02;
            break;
        case 3:
            return tcoThronePresetData.taggedItems03;
            break;
        case 4:
            return tcoThronePresetData.taggedItems04;
            break;
        case 5:
            return tcoThronePresetData.taggedItems05;
            break;
        case 6:
            return tcoThronePresetData.taggedItems06;
            break;
        case 7:
            return tcoThronePresetData.taggedItems07;
            break;
        case 8:
            return tcoThronePresetData.taggedItems08;
            break;
        case 9:
            return tcoThronePresetData.taggedItems09;
            break;
        case 10:
            return tcoThronePresetData.taggedItems10;
            break;
        case 11:
            return tcoThronePresetData.taggedItems11;
            break;
        case 12:
            return tcoThronePresetData.taggedItems12;
            break;
        case 13:
            return tcoThronePresetData.taggedItems13;
            break;
        case 14:
            return tcoThronePresetData.taggedItems14;
            break;
        case 15:
            return tcoThronePresetData.taggedItems15;
            break;
        case 16:
            return tcoThronePresetData.taggedItems16;
            break;
        case 17:
            return tcoThronePresetData.taggedItems17;
            break;
        case 18:
            return tcoThronePresetData.taggedItems18;
            break;
        case 19:
            return tcoThronePresetData.taggedItems19;
            break;
        case 20:
            return tcoThronePresetData.taggedItems20;
            break;
        case 21:
            return tcoThronePresetData.taggedItems21;
            break;
        case 22:
            return tcoThronePresetData.taggedItems22;
            break;
        case 23:
            return tcoThronePresetData.taggedItems23;
            break;
        case 24:
            return tcoThronePresetData.taggedItems24;
            break;
    };
    return null;
};

function getChampPresetObject(presetIndex) {
    switch(presetIndex) {
        case 1:
            return tcoChampPresetData.taggedItems01;
            break;
        case 2:
            return tcoChampPresetData.taggedItems02;
            break;
        case 3:
            return tcoChampPresetData.taggedItems03;
            break;
        case 4:
            return tcoChampPresetData.taggedItems04;
            break;
    };
    return null;
};

function logit (msg) {
    var now = new Date();
    GM_log (getServerId() +' @ '+ now.toTimeString().substring (0,8) +'.' + now.getMilliseconds() +': '+  msg);
};

function addCommas(nStr){
    nStr += '';
    var x = nStr.split('.');
    var x1 = x[0];
    var x2 = x.length > 1 ? '.' + x[1] : '';
    var rgx = /(\d+)(\d{3})/;
    while (rgx.test(x1)) {
        x1 = x1.replace(rgx, '$1' + ',' + '$2');
    }
    return x1 + x2;
};

function setCities(){
    Cities.numCities = Seed.cities.length;
    Cities.cities = [];
    Cities.byID = {};
    for (i=0; i<Cities.numCities; i++){
        city = {};
        city.idx = i;
        city.id = parseInt(Seed.cities[i][0]);
        city.name = Seed.cities[i][1];
        city.x = parseInt(Seed.cities[i][2]);
        city.y = parseInt(Seed.cities[i][3]);
        city.tileId = parseInt(Seed.cities[i][5]);
        city.provId = parseInt(Seed.cities[i][4]);
        Cities.cities[i] = city;
        Cities.byID[Seed.cities[i][0]] = city;
    }
};

function isAnyChampBroke() {
    for (champId in uW.kocChampionItems) {
        var champItem = uW.kocChampionItems[champId];
        if (champItem == null || !champItem) return false;
        if (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE) return true;
    }
    return false;
}

function isAnyThroneBroke() {
    for (trId in uW.kocThroneItems) {
        var throne_item = uW.kocThroneItems[trId];
        if (throne_item == null || !throne_item) return false;
        if (throne_item.isBroken) return true;
    }
    return false;
};

function getChampItemStats(chId, separater) {

    separater = separater || "    ";

    var champ_item = uW.kocChampionItems[chId];
    
    var D = [];

    D.push(champ_item.name);

    D.push("Faction: " + CM.CHAMPION.getFactionClasses(champ_item.faction));
    var quality = (champ_item.unique > 0) ? "Unique" : CM.CHAMPION.getRarityClasses(champ_item.rarity);
    D.push("Quality: " + quality);
    D.push("Type: " + uW.g_js_strings.champ[CM.CHAMPION.getEquipmentNames(champ_item.type)]);
    D.push("Level: " + champ_item.level);
    D.push("Might: " + champ_item.might);
    
    for (var slotNumber = 1; slotNumber < tcoMaxChampQuality + 1; slotNumber++) {
        var effectLine = champ_item.effects[slotNumber];
        var effect = CM.ChampionManager.getEffect(effectLine, champ_item.level);
        D.push("Row " + slotNumber + ": " + effect.amount + " " + effect.name);
    }

    var cText = D.join(separater);

    if (separater == "||") cText = ":::. |" + cText;

    return cText;
}

function getThroneItemStats(trId, separater) {

    separater = separater || "    ";

    var throne_item = uW.kocThroneItems[trId];

    if (throne_item == null || !throne_item) return "";

    var D = [];

    D.push(throne_item.name);
    D.push("Faction: " + throne_item.faction);
    D.push("Quality: " + throne_item.createPrefix());
    D.push("Type: " + throne_item.type);
    D.push("Level: " + throne_item.level);
    D.push("Might: " + CM.ThroneView.getMightBonus(throne_item));
    for (slot in throne_item.effects) {
        try {
            var N = throne_item.effects[slot];
            effect = CM.thronestats.effects[N.id];

            tier = CM.thronestats.tiers[N.id][N.tier];
            if (!tier) tier = CM.thronestats.tiers[N.id][N.tier - 1];

            var base = tier.base || 0;
            var level = throne_item.level || 0;
            var growth = tier.growth || 0;

            if (slot == 'slot6') {  //if it has a slot 6, it automatically has a jewel
                JewelQuality = throne_item["effects"]['slot6'].quality;
                GrowthLimit = CM.thronestats.jewelGrowthLimit[JewelQuality];
                if (GrowthLimit <= level) level = GrowthLimit
            }

            percent = +(base + ((level * level + level) * growth * 0.5));

            var wholeNumber = false;
            if (Math.round(parseFloat(percent)) == parseFloat(percent)) wholeNumber = true;

            percent = (percent > 0) ? "+" + percent : +percent;

            if (wholeNumber)
                percent = parseFloat(percent)           .toFixed(0);
            else
                percent = parseFloat(percent).toFixed(2);

            css = (slot % 2 === 0) ? "even" : "odd";
            B = +(slot.split("slot")[1]);

            effect[1] = effect[1];

            D.push("Row " + B + ": " + percent + "% " + effect[1]);
        }
        catch (e) { }

    }
    var cText = D.join(separater);
    if (separater == "||") cText = ":::. |" + cText;

    return cText;
}

function displayCityAstone() {
    var city = pickAetherUseCity();
    var m = '';
    if (city == -1) {
        m = '<div>No Aetherstone Available</div>';
    } else {
        var aether = parseInt(Seed.resources["city" + Seed.cities[city][0]]["rec5"][0]);
        m = '<div>AETHER: City #' + (city + 1) + ' = ' + addCommas(aether) + '</div>';
    }
    return m;
};

function pickAetherUseCity() {
    if (parseInt(Seed.resources["city" + Seed.cities[tcoGeneralOptions.usedCityNum][0]]["rec5"][0]) >= tcoGeneralOptions.minStones) return tcoGeneralOptions.usedCityNum;
    if (tcoGeneralOptions.usedAnyCity) {
        for (i = 0; i < Seed.cities.length; i++) {
            if (parseInt(Seed.resources["city" + Seed.cities[i][0]]["rec5"][0]) >= tcoGeneralOptions.minStones) return i;
        }
    }
    return -1;
};

function getThroneBrokeMight() {
    var totMight = 0;
    for (trId in uW.kocThroneItems) {
        var throne_item = uW.kocThroneItems[trId];
        if (throne_item == null || !throne_item) continue;
        if (throne_item.isBroken) totMight += CM.ThroneView.getMightBonus(throne_item);
    }
    return "<b>You have " + addCommas(totMight) + " in broken throne might</b>";
};

function contentEval(source) {
    // Check for function input.
    if ('function' == typeof source) {
        // Execute this function with no arguments, by adding parentheses.
        // One set around the function, required for valid syntax, and a
        // second empty set calls the surrounded function.
        source = '(' + source + ')();'
    }

    // Create a script node holding this  source code.
    var script = document.createElement('script');
    script.setAttribute("type", "application/javascript");
    script.textContent = source;

    // Insert the script node into the page, so it will run, and immediately
    // remove it to clean up.
    document.body.appendChild(script);
    document.body.removeChild(script);
};
function addWatchFunctions() {
//  object.watch
    if (!Object.prototype.multiWatch) {
        Object.defineProperty(Object.prototype, "multiWatch", {
            enumerable: false,
            configurable: true,
            writable: false,
            value: function (prop, watcher) {
                var obj = this,
                oldval = this[prop],
                newval = oldval,
                getter = function () {
                    return newval;
                },
                setter = function (val) {

                    oldval = newval;

                    for (var f=0; f < obj.watchers[prop].length; f++) {
                        obj.watchers[prop][f](prop, oldval, val);
                    }
                    newval = val;
                    return newval;
                };

                if (delete obj[prop]) { // can't watch constants
                    Object.defineProperty(this, prop, {
                        get: getter,
                        set: setter,
                        enumerable: true,
                        configurable: true
                    });

                    if (!obj.watchers) obj.watchers = {};

                    if (!obj.watchers[prop]) obj.watchers[prop] = [];

                    // check for duplicates
                    for (var i=0; i < obj.watchers[prop].length; i++){
                        if(obj.watchers[prop][i] === watcher){
                            return;
                        }
                    }

                    //obj.watchers[prop].push( eval(watcher)); //add the new watcher in the watchers array
                    obj.watchers[prop].push(watcher);
                }

            }
        });
    }

//  object.unwatch
    if (!Object.prototype.multiUnwatch) {
        Object.defineProperty(Object.prototype, "multiUnwatch", {
            enumerable: false,
            configurable: true,
            writable: false,
            value: function (prop, watcher) {
                var obj = this;

                // if a watcher is supplied, just remove it 
                if(arguments.length == 2) {
                    for(var i=0; i < obj.watchers[prop].length; i++){
                        var w = obj.watchers[prop][i];

                        if(w == watcher) {
                            obj.watchers[prop].splice(i, 1);
                        }
                    }
                } else {
                    obj.watchers[prop] = [];
                }

                if (obj.watchers[prop].length == 0 )
                {
                    delete obj.watchers[prop];
                    var val = this[prop];
                    delete this[prop]; // remove accessors
                    this[prop] = val;
                }
            }
        });
    }
}


function matTypeof (v){
    if (typeof (v) == 'object') {
        if (!v)
            return 'null';
        else if (v.constructor.toString().indexOf("Array")>=0 && typeof(v.splice)=='function')
            return 'array';
        else return 'object';
    }
    return typeof (v);
};

function inspect(obj, maxLevels, level, doFunctions){
    var str = '', type, msg;
    if(level == null) level = 0;
    if(maxLevels == null) maxLevels = 1;
    if(maxLevels < 1) return 'Inspect Error: Levels number must be > 0';
    if(obj == null) return 'ERROR: Object is NULL\n';
    var indent = '';
    for (var i=0; i<level; i++) indent += '  ';
    for(property in obj) {
        try {
            type =  matTypeof(obj[property]);
            if (doFunctions==true && (type == 'function')) {
                str += indent + '(' + type + ') ' + property + "[FUNCTION]\n";
            } else if (type != 'function') {
                str += indent + '(' + type + ') ' + property + ( (obj[property]==null)?(': null'):('')) +' = '+ obj[property] +"\n";
            }
            if((type=='object' || type=='array') && (obj[property] != null) && (level+1 < maxLevels))
                str += inspect(obj[property], maxLevels, level+1, doFunctions);  // recurse
        } catch(err) {
            // Is there some properties in obj we can't access? Print it red.
            if(typeof(err) == 'string') msg = err;
            else if(err.message)        msg = err.message;
            else if(err.description)    msg = err.description;
            else                        msg = 'Unknown';
            str += '(Error) ' + property + ': ' + msg +"\n";
        }
    }
    str += "\n";
    return str;
};

function setUpgradeColor() {
//TODO
    if (tcoThroneUpgradeData.newUpgradeState == 0)
        $("#tcoTab>span").css('color', '#FFFF66');
    else if (tcoThroneUpgradeData.newUpgradeState == 1)
        $("#tcoTab>span").css('color', 'cyan');
    else if (tcoThroneUpgradeData.newUpgradeState == 2)
        $("#tcoTab>span").css('color', 'red');
};

function sendChat (msg){  //Simple method, as if it were typed in thru DOM
    document.getElementById('mod_comm_input').value = msg;
    uW.Chat.sendChat ();
};

function sendComposedMail (sendTo, subject, msg) {
    var params = uW.Object.clone(ajfx);
    params.emailTo = sendTo;
    params.subject = subject;
    params.message = msg;
    params.requestType = "COMPOSED_MAIL";
    new AjaxRequest(uW.g_ajaxpath + "ajax/getEmail.php" + uW.g_ajaxsuffix, {
        method:"post",
        parameters:params,
        onSuccess:function(message){
        },
        onFailure:function(){
        }
    })
};

function unixTime () {
    return parseInt (new Date().getTime() / 1000) + uW.g_timeoff;
};

function parseIntNan (n){
	x = parseInt(n, 10);
	if (isNaN(x))
		return 0;
	return x;
};

function implodeUrlArgs (obj){
    var a = [];
    for (var k in obj) a.push (k +'='+ encodeURI(obj[k]) );
    return a.join ('&');    
};

function addUrlArgs (url, args){
    if (!args) return url;
    if (url.indexOf('?') < 0)
        url += '?';
    else if (url.substr(url.length-1) != '&')
        url += '&';    
    if (matTypeof(args == 'object')) return url + implodeUrlArgs (args);    
    return url + args;
};

var myServerId = null;  //example: https://www150.kingdomsofcamelot.com
function getServerId() {
    if (myServerId == null){
        var m=/^[a-zA-Z]+([0-9]+)\./.exec(document.location.hostname);
        if (m)
            myServerId = m[1];
        else
            myServerId = '??';
    }
    return myServerId;
};

var withAnim = null;
if (CM && CM.ThronePanelView) withAnim = CM.ThronePanelView.statusAnim;

function noAnim(result) {
    if (result == "success") {
        var isChamp = true;
        var champUpgEnhContainer = document.getElementById('champUpgEnhContainer');
        if (!champUpgEnhContainer || champUpgEnhContainer == null) isChamp = false;
        var msg = "Manual";
        if (isChamp) {
            var attempt_type = document.getElementById('upgEnhButton');
            msg += ' ' + attempt_type.innerHTML.replace('--', '').trim() + ' successful.  Item:';
            var upgEnhTitle = document.getElementById('upgEnhTitle');
            msg += ' ' + upgEnhTitle.innerHTML;
        } else {
            var thronePanelItemRequirementsContainer = document.getElementById('thronePanelItemRequirementsContainer');
            attempt_type = thronePanelItemRequirementsContainer.getElementsByClassName('gemButtonv2')[0];
            msg += ' ' + attempt_type.innerHTML + ' successful.  Item:';
            var thronePanelName = document.getElementById('thronePanelName');
            msg += ' ' + thronePanelName.innerHTML;
        }

        SuccessLog(msg);

        //if (!OrganizerDisableSuccessCheck) {
            if (withAnim) withAnim(result);
        //} else {
        //    unsafeWindow.cm.ThroneView.renderInventory(unsafeWindow.kocThroneItems);
        //}
    }
    //$("div.thronePanelItemContainer").append("<div>" + result + "</div>");
}

function autoSelectMasters() {
    var ThroneID = 0;
    ThroneID = Tabs.throneOrganizer.panelId;

    var throne_item = uW.kocThroneItems[ThroneID];
    nextMastersID = getNextAvailableMasters(throne_item);
    if (nextMastersID == 0) {
        unselectToken();
    } else {
        var selected_index = 0;
        //TODO
        $(document.querySelector("#buffDropDown")).children("option").each(function () {
            if ( $(this).text() == uW.ksoItems[nextMastersID].name ) {
                selected_index = $(this).val();
                return false;
            }
        });
        $('#buffDropDown').val(selected_index).change();
        if (selected_index > 0) {
            $("#thronePanelBuffPrice span").text(uW.ksoItems[nextMastersID].count + "/1");
            $("div.mastersTokenLevel").text(getMastersText(nextMastersID));
            var thronePanelBuffIcon = document.getElementById('thronePanelBuffIcon');
            thronePanelBuffIcon.className = 'icon mastersToken i' + nextMastersID;
            thronePanelBuffIcon.style.backgroundImage = "url('https://rycamelot1-a.akamaihd.net/fb/e2/src/img/items/70/masters_token_bg.png')";
            thronePanelBuffIcon.innerHTML = '<div class="mastersTokenLevel">' + tcoTokenText[nextMastersID] + '</div>';
        }
    }
    if (tcoGeneralOptions.safetyOn) {
        setTimeout(function() {
            safetyCheck();
        }, 2000);
    }
}

var disableUpgradeButton = function () {
    // change the appearance
    //TODO
    var container = document.querySelector('#thronePanelItemRequirementsContainer');
    $(container).children("a.gemButtonv2").remove();
	var an = $("<a/>");
    an.addClass("gemButtonv2 gray");
    an.html("Low A-Stone");
    $(container).append(an);
}

var safetyCheck = function () {
//TODO
    // remove the gem option
    var sel = document.getElementById("costDropDown");
    sel.remove(1);
    // see if we have enough a-stone
    if (checkAstoneLevel()) {
        $(document.querySelector("#thronePanelItemRequirementsContainer")).children("a.gemButtonv2").click(function () {
            // every time the button is pushed, check the levels
            checkAstoneLevel();
            safetyCheck();
        });
    }
}

var checkAstoneLevel = function () {
    // check limit
    var stones = parseInt(Seed.resources["city" + unsafeWindow.currentcityid]["rec5"][0]);
    if (stones < tcoGeneralOptions.safetyLimit || isNaN(stones) ) {
        disableUpgradeButton();
        return false;
    } else {
        return true;    
    }
}

function getMastersText(ksoID) {
    switch(ksoID) {
        case 20032:
            return "XXIV";
        case 20031:
            return "XXIII";
        case 20030:
            return "XXII";
        case 20029:
            return "XXI";
        case 20028:
            return "XX";       
        case 20027:
            return "XIX";
        case 20026:
            return "XVIII";
        case 20025:
            return "XVII";
        case 20024:
            return "XVI";
        case 20023:
            return "XV";
        case 20021:
            return "XIV";
        case 20020:
            return "XIII";
        case 20018:
            return "XII";
        case 20017:
            return "XI";
        case 20016:
            return "X";
        case 20015:
            return "IX";
        case 20014:
            return "VII";
        case 20013:
            return "V";
        case 20012:
            return "III";
        default:
            return "";
    }
}

var buffChanged = false;

function unselectToken() {
//TODO
    // if the user manually selected a buff, leave it alone
    if (!buffChanged) {

        // set the pull down to nothing when first displayed
        $(document.querySelector("#buffDropDown")).val(0);

        // set the pull down to nothing when first displayed
        $(document.querySelector("#costDropDown")).val(0);

        // remove the icon ....
        $(document.querySelector("#thronePanelBuffIcon")).removeClass().addClass('icon').addClass('i0');
        $(document.querySelector("#thronePanelBuffPrice")).children("span.items").html('');

        // install an action to track when a buff is selected
        $(document.querySelector("#buffDropDown")).change(function () {
            buffChanged = true;
        });

        // install an action to track when a buff is selected
        $(document.querySelector("#costDropDown")).change(function () {
            buffChanged = true;
        });

        // reset once the dialog is closed
        $(".throneContainer").children("div.close").click(function () {
            buffChanged = false;
        });
    }
}

function getNextAvailableMasters(throneItem) {
    var curCode = 0;
    if (uW.ksoItems[20033].count > 0 && throneItem.level <= 24) curCode = 20033; //25s
    if (uW.ksoItems[20032].count > 0 && throneItem.level <= 23) curCode = 20032; //24s
    if (uW.ksoItems[20031].count > 0 && throneItem.level <= 22) curCode = 20031; //23s
    if (uW.ksoItems[20030].count > 0 && throneItem.level <= 21) curCode = 20030; //22s
    if (uW.ksoItems[20029].count > 0 && throneItem.level <= 20) curCode = 20029; //21s
    if (uW.ksoItems[20028].count > 0 && throneItem.level <= 19) curCode = 20028; //20s
    if (uW.ksoItems[20027].count > 0 && throneItem.level <= 18) curCode = 20027; //19s
    if (uW.ksoItems[20026].count > 0 && throneItem.level <= 17) curCode = 20026; //18s
    if (uW.ksoItems[20025].count > 0 && throneItem.level <= 16) curCode = 20025; //17s
    if (uW.ksoItems[20024].count > 0 && throneItem.level <= 15) curCode = 20024; //16s
    if (uW.ksoItems[20023].count > 0 && throneItem.level <= 14) curCode = 20023; //15s
    if (uW.ksoItems[20021].count > 0 && throneItem.level <= 13) curCode = 20021; //14s
    if (uW.ksoItems[20020].count > 0 && throneItem.level <= 12) curCode = 20020; //13s
    if (uW.ksoItems[20018].count > 0 && throneItem.level <= 11) curCode = 20018; //12s
    if (uW.ksoItems[20017].count > 0 && throneItem.level <= 10) curCode = 20017; //11s
    if (uW.ksoItems[20016].count > 0 && throneItem.level <= 9) curCode = 20016; //10s
    if (uW.ksoItems[20015].count > 0 && throneItem.level <= 8) curCode = 20015; //9s
    if (uW.ksoItems[20015].count > 0 && throneItem.level <= 7) curCode = 20015; //9s
    if (uW.ksoItems[20014].count > 0 && throneItem.level <= 6) curCode = 20014; //7s
    if (uW.ksoItems[20014].count > 0 && throneItem.level <= 5) curCode = 20014; //7s
    if (uW.ksoItems[20013].count > 0 && throneItem.level <= 4) curCode = 20013; //5s
    if (uW.ksoItems[20013].count > 0 && throneItem.level <= 3) curCode = 20013; //5s
    if (uW.ksoItems[20012].count > 0 && throneItem.level <= 2) curCode = 20012; //3s
    if (uW.ksoItems[20012].count > 0 && throneItem.level <= 1) curCode = 20012; //3s
    return curCode;
}

function disableAnimation(disable) {
    if (disable) {
        // override the success failure animations
        CM.ThronePanelView.statusAnim = noAnim;
    } else {
        if (withAnim) CM.ThronePanelView.statusAnim = withAnim;
    }
};

function getChampName( presetIndex ) { //presetIndex is 1 based but needs to be 0 based for champ name so we will minus 1
    var thisChampion = Seed.champion.champions[presetIndex-1];
    return thisChampion.name;
};

function getChampID( presetIndex ) { //presetIndex is 1 based but needs to be 0 based for champ name so we will minus 1
    var thisChampion = Seed.champion.champions[presetIndex-1];
    return thisChampion.championId;
};

function postChampSlot ( slot ) {
    var champId = getChampID(slot);
    var D = [];
    for (var chId in uW.kocChampionItems) if (uW.kocChampionItems[chId].equippedTo == champId) D.push(chId);
    var champStats = GenerateChampPresetEffectsString(D, false);
    D = [];
    D.push("Champ Hall Slot #" + slot);
    D.push(getChampName(slot));
    if (tcoChampPresetData.showChampName) D.push("(" + tcoChampPresetData.presetNames[slot-1] + ")");
    if (tcoChampPresetData.showChampMight) D.push(getChampMight());
    D.push(champStats);
    sendChat(":::. |" + D.join("||"));
};

function postChampPreset ( presetIndex ) {
    var chP = getChampPresetObject(parseInt(presetIndex));
    var D = [];
    for (var p in chP) D.push(p);
    var champStats = GenerateChampPresetEffectsString(D, false);
    D = [];
    D.push("Champ Hall Tag #" + presetIndex);
    D.push(getChampName(presetIndex));
    if (tcoChampPresetData.showChampName) D.push("(" + tcoChampPresetData.presetNames[presetIndex-1] + ")");
    if (tcoChampPresetData.showChampMight) D.push(getChampMight());
    D.push(champStats);
    sendChat(":::. |" + D.join("||"));
};

function getChampMight() {
    var totMight = 0;
    for (chId in uW.kocChampionItems) {
        var champ_item = uW.kocChampionItems[chId];
        var q = champ_item.rarity;
        if (champ_item.unique != 0) q -= 1;
        var l = champ_item.level;
        totMight += CM.thronestats.mightByQuality[q].Might + CM.thronestats.mightByLevel[l].Might;
    }
    return "Approx Might: " + addCommas(totMight);
};

function GenerateChampPresetEffectsString( presetObject, htmlEffects ) {

    var ChampStats = [];
    var TroopStats = [];

    for (var eff in CM.thronestats.effects) TroopStats[eff] = 0;
    //base stats for champ with no items
    ChampStats[201] = 30;
    ChampStats[202] = 0;
    ChampStats[203] = 7;
    ChampStats[204] = 27;
    ChampStats[205] = 27;
    ChampStats[206] = 60;
    ChampStats[207] = 4;
    ChampStats[208] = 3;
    ChampStats[209] = 3;

    var counter = presetObject.length;
    var items = [];

    for (i = 0; i < counter; i++) items.push(presetObject[i]);

    while (items.length > 0) {
        var champ_item = uW.kocChampionItems[items.pop()];
        if (champ_item == null || !champ_item) continue;
        for (var O in champ_item["effects"]) {
            var effectLine = champ_item["effects"][O];
            var id = effectLine["id"];
            var effect = CM.ChampionManager.getEffect(effectLine, champ_item.level);
            if (id >= 201 && id <= 209) {
                ChampStats[id] += effect.amount;
            } else {
                TroopStats[id] += effect.amount;
            }
        }
    }

    var J = new Array();

    if (htmlEffects) {
        J.push("<div><b><i>CHAMP STATS</i></b></div>");
    } else {
        J.push("CHAMP STATS");
    }
    for (stat in ChampStats) {
        var effectName = uW.g_js_strings.effects["name_"+ stat];
        if (ChampStats[stat] && ChampStats[stat] != 0) {
            if (htmlEffects) {
                J.push("<div>&nbsp;&nbsp;" + effectName + " " + ChampStats[stat] + "</div>");
            } else {
                J.push("&nbsp;&nbsp;" + effectName + " " + ChampStats[stat]);
            }
        }
    }
    if (htmlEffects) {
        J.push("<div><b><i>TROOP STATS</i></b></div>");
    } else {
        J.push("TROOP STATS");
    }
    for (stat in TroopStats) {
        var effectName = CM.thronestats.effects[stat][1];
        if (TroopStats[stat] && TroopStats[stat] != 0) {
            if (htmlEffects) {
                J.push("<div>&nbsp;&nbsp;" + effectName + " " + TroopStats[stat] + "</div>");
            } else {
                J.push("&nbsp;&nbsp;" + effectName + " " + TroopStats[stat]);
            }
        }
    }
    if (htmlEffects) {
        return J.join("");
    } else {
        return J.join("||");
    }

}

function getChampBrokeMight() {
    var totMight = 0;
    for (chId in uW.kocChampionItems) {
        var champ_item = uW.kocChampionItems[chId];
        if (champ_item.status == 1) continue;
        var q = champ_item.rarity;
        if (champ_item.unique != 0) q -= 1;
        var l = champ_item.level;
        totMight += CM.thronestats.mightByQuality[q].Might + CM.thronestats.mightByLevel[l].Might;
    }
    return "<b>You have approx " + addCommas(totMight) + " in broken champ might</b>";
};

function ChampLoadDomainSalvageData(domainId) {
    var t = Tabs.champSalvager;

    s = GM_getValue('tcoChampSalvageData_'+ domainId + uW.tvuid);

    if (s==null) {
        alert("Unable to find data from domain: " + domainId);
        return;
    }

    if (s != null){
        opts = JSON2.parse (s);
        for (k in opts){
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoChampSalvageData[k][kk] = opts[k][kk];
            else
                tcoChampSalvageData[k] = opts[k];
        }
    }

    // recreate the objects w/ functions
    for (k in tcoChampSalvageData.ruleSet)
    {
        var r = tcoChampSalvageData.ruleSet[k];
        var rule = new ChampRule(r.type, r.faction, r.conditions, r.advancedrule);
        for (j in rule.conditions) {
            rule.conditions[j].ChampCheckCondition = ChampCheckCondition;
        }
        tcoChampSalvageData.ruleSet[k] = rule;
    }

    // turn off
    tcoChampSalvageData.active = false;
    clearInterval(t.sTimer);
    clearInterval(t.delTimer);
    t.deleting = false;
    SAVEtcoChampSalvageData();
    alert('Salvage settings loaded from domain ' + domainId);
    t.buildChampRuleDisplay();
};

function ThroneLoadDomainSalvageData(domainId) {
    var t = Tabs.throneSalvager;

    s = GM_getValue ('tcoThroneSalvageData_'+ domainId + uW.tvuid);

    if (s==null) {
        alert("Unable to find data from domain: " + domainId);
        return;
    }

    if (s != null){
        opts = JSON2.parse (s);
        for (k in opts){
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoThroneSalvageData[k][kk] = opts[k][kk];
            else
                tcoThroneSalvageData[k] = opts[k];
        }
    }

    // recreate the objects w/ functions
    for (k in tcoThroneSalvageData.ruleSet)
    {
        var r = tcoThroneSalvageData.ruleSet[k];
        var rule = new ThroneRule(r.type, r.faction, r.conditions, r.advancedrule);
        for (j in rule.conditions) {
            rule.conditions[j].ThroneCheckCondition = ThroneCheckCondition;
        }
        tcoThroneSalvageData.ruleSet[k] = rule;
    }

    // turn off
    tcoThroneSalvageData.active = false;
    clearInterval(t.sTimer);
    clearInterval(t.delTimer);
    t.deleting = false;
    SAVEtcoThroneSalvageData();
    alert('Salvage settings loaded from domain ' + domainId);
    t.buildThroneRuleDisplay();
};

function secondsToTime(seconds) {
    if (seconds == 0) return "Complete";
    var remainderSeconds = seconds % 60;
    seconds = seconds - remainderSeconds;
    var remainderMinutes = seconds / 60;
    return (remainderMinutes + 'm ' + remainderSeconds + 's');
};

function onUnload (){
    if (uW.tcoLoaded) {
        if (mainPop) {
            var pos = mainPop.getLocation();
            tcoGeneralOptions.xPos = pos.x;
            tcoGeneralOptions.yPos = pos.y;
            //tcoGeneralOptions.xPos = mainPop.getLocation.x;
            //tcoGeneralOptions.yPos = mainPop.getLocation.y;
            SAVEtcoGeneralOptions();
        }
    }
};

function RefreshCamelot() {  //This piece of code was taken from KoC Power BOT.  All credit goes to them for this piece.  Thanks guys/gals!
    var serverId = getServerId();
    var goto = window.location.protocol + '//apps.facebook.com/kingdomsofcamelot/?s=' + serverId;
    if (document.URL.match(/standalone=1/i)) {
        goto = window.location.protocol + '//www.kabam.com/games/kingdoms-of-camelot/play?s=' + serverId;
    };
    setTimeout (function (){window.top.location = goto;}, 0);
};

// emulate protoype's Ajax.Request ...
function AjaxRequest (url, opts) {  //emulate protoype's Ajax.Request ...
    var headers = {
            'X-Requested-With': 'XMLHttpRequest',
            'X-Prototype-Version': '1.6.1',
            'Accept': 'text/javascript, text/html, application/xml, text/xml, */*'
    };
    var ajax = null;

    if (window.XMLHttpRequest)
        ajax=new XMLHttpRequest();
    else
        ajax=new ActiveXObject("Microsoft.XMLHTTP");

    if (opts.method==null || opts.method=='')
        method = 'GET';
    else
        method = opts.method.toUpperCase();

    if (method == 'POST'){
        headers['Content-type'] = 'application/x-www-form-urlencoded; charset=UTF-8';
    } else if (method == 'GET'){
        addUrlArgs (url, opts.parameters);
    }

    ajax.onreadystatechange = function(){
//      ['Uninitialized', 'Loading', 'Loaded', 'Interactive', 'Complete']; states 0-4
        if (ajax.readyState==4) {
            if (ajax.status >= 200 && ajax.status < 305)
                if (opts.onSuccess) opts.onSuccess(ajax);
                else
                    if (opts.onFailure) opts.onFailure(ajax);
        } else {
            if (opts.onChange) opts.onChange (ajax);
        }
    }

    ajax.open(method, url, true);   // always async!

    for (var k in headers)
        ajax.setRequestHeader (k, headers[k]);
    if (matTypeof(opts.requestHeaders)=='object')
        for (var k in opts.requestHeaders)
            ajax.setRequestHeader (k, opts.requestHeaders[k]);

    if (method == 'POST'){
        var a = [];
        for (k in opts.parameters){
            if(matTypeof(opts.parameters[k]) == 'object')
                for(var h in opts.parameters[k])
                    a.push (k+'['+h+'] ='+ opts.parameters[k][h] );
            else
                a.push (k +'='+ opts.parameters[k] );
        }
        ajax.send (a.join ('&'));
    } else               {
        ajax.send();
    }
};

function MyAjaxRequest (url, o, noRetryX) {
    if (DEBUG_TRACE) logit (" 0 myAjaxRequest: "+ url +"\n" + inspect (o, 2, 1));
    var opts = uW.Object.clone(o);
    var wasSuccess = o.onSuccess;
    var wasFailure = o.onFailure;
    var retry = 0;
    var delay = 10;
    var noRetry = noRetry===true?true:false;
    opts.onSuccess = mySuccess;
    opts.onFailure = myFailure;

    new AjaxRequest(url, opts);
    return;

    function myRetry(){
        ++retry;
        new AjaxRequest(url, opts);
        delay = delay * 2.25;
    }
    function myFailure(){
        var o = {};
        o.ok = false;
        o.errorMsg = "AJAX Communication Failure";
        wasFailure (o);
    }
    function mySuccess (msg){
        var rslt = eval("(" + msg.responseText + ")");
        if (!rslt)
        {
            logit("Message error: " + inspect(msg,3,1));
            return;
        }
        var x;
        if (window.EmulateAjaxError){
            rslt.ok = false;
            rslt.error_code=8;
        }
        if (rslt.ok){
            if (rslt.updateSeed)
                uW.update_seed(rslt.updateSeed);
            wasSuccess (rslt);
            return;
        }
        rslt.errorMsg = uW.printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null));

        if (!noRetry && (rslt.error_code==0 || rslt.error_code==8 || rslt.error_code==1 || rslt.error_code==3)){
            dialogRetry (inspect(rslt.errorMsg), delay, function(){myRetry()}, function(){wasSuccess (rslt)}, rslt.error_code);
        } else {
            wasSuccess (rslt);
        }
    }
};

function ExportThroneToExcel(isPreview) {
    var headers = [ "ID", "NAME", "FACTION", "QUALITY", "TYPE", "LEVEL", "MIGHT", "JEWEL", "ROW 1", "ROW 2", "ROW 3", "ROW 4", "ROW 5", "ROW 6"];
    var ExcelTable = document.createElement('table');
    var ExcelBody = document.createElement('tbody');
    var ExcelRow = document.createElement('tr'); 
    var ExcelColumn = "";
    for (i = 0; i < headers.length; i++) {
        ExcelColumn = document.createElement('th');
        ExcelColumn.appendChild(document.createTextNode(headers[i]));
        ExcelRow.appendChild(ExcelColumn);
    }
    ExcelBody.appendChild(ExcelRow);
    
    var columns = [];

    for (trId in uW.kocThroneItems) {
        if (isPreview && !tcoThronePresetData.previewThrone[trId]) continue;
        var throne_item = uW.kocThroneItems[trId];
        if (!throne_item) continue;
        columns = [];
        columns.push(trId);
        columns.push(throne_item.name);
        columns.push(throne_item.faction);
        columns.push(throne_item.quality);
        columns.push(throne_item.type);
        columns.push(throne_item.level);
        columns.push(CM.ThroneView.getMightBonus(throne_item));
        if (throne_item.jewel) {
            var jewel_item = throne_item.jewel;
            var qlty = CM.thronestats.jewelGrowthLimit[jewel_item.quality];
            var amt = CM.ThroneController.getEffectAmount(jewel_item, qlty);
            var jewelName = CM.ThroneController.jewelName(jewel_item);
            if (amt == 0) jewelName = "none";
            columns.push(jewelName);
        } else {
            columns.push("none");
        }
        for (var O in throne_item["effects"]) {
            var slotNumber = +(O.split("slot")[1]);
            var id = throne_item["effects"]["slot" + slotNumber]["id"];
            var tier = parseInt(throne_item["effects"]["slot" + slotNumber]["tier"]);
            var level = throne_item.level;
            p = CM.thronestats.tiers[id][tier];
            var effectName = CM.thronestats["effects"][id]["1"];
            while (!p && (tier > 0)) { tier--; p = CM.thronestats.tiers[id][tier]; }
            if (!p) continue; // can't find stats for tier

            if (slotNumber == 6) {
                JewelQuality = throne_item["effects"]["slot" + slotNumber].quality;
                GrowthLimit = CM.thronestats.jewelGrowthLimit[JewelQuality];
                if (GrowthLimit <= level) level = GrowthLimit
            }
            var Current = p.base + ((level * level + level) * p.growth * 0.5);
            columns.push(Current + "% " + effectName);
        }
        
        columns.reverse();
        ExcelRow = document.createElement('tr');
        while (columns.length > 0) {
            ExcelColumn = document.createElement('td');
            ExcelColumn.appendChild(document.createTextNode(columns.pop()));
            ExcelRow.appendChild(ExcelColumn);
        }
        ExcelBody.appendChild(ExcelRow);
    }
    ExcelTable.appendChild(ExcelBody);

    window.open('data:application/vnd.ms-excel,' + encodeURIComponent(ExcelTable.outerHTML));
}
function ConvertUniqueAndBuildChampCard (champId, lvl) {
    var t = Tabs.champUniques;
	var ChampCard = {};
	ChampCard = t.UniqueItems[champId];
	ChampCard.id = ChampCard.Id;
	ChampCard.name = ChampCard.Name;
	if (ChampCard.Faction != 0) {
		ChampCard.faction = ChampCard.Faction;
		ChampCard.type = ChampCard.Type;
	}
	else {
		ChampCard.faction = 'unknown';
		ChampCard.type = 'unknown';
		ChampCard.unknown = true;
	}
	ChampCard.unique = ChampCard.id;
	ChampCard.level = parseInt(lvl);
	ChampCard.rarity = 5;
	ChampCard.createPrefix = function () { return ""; };
	ChampCard.createSuffix = function () { return ""; };
	ChampCard.effects = {};
	var effects = eval(ChampCard.Effects);
	var slot = 0;
	for (k in effects) {
		slot++
		ChampCard.effects["slot"+slot] = {};
		ChampCard.effects["slot"+slot].id = effects[k].type;
		ChampCard.effects["slot"+slot].tier = effects[k].tier;
	}
	return BuildChampCard(ChampCard);
};

function ConvertUniqueAndBuildThroneCard(throneID, lvl) {
    var t = Tabs.throneUniques;
    var ThroneCard = {};
    ThroneCard = t.UniqueItems[throneID];
    ThroneCard.id = ThroneCard.Id;
    ThroneCard.name = ThroneCard.Name;
    ThroneCard.faction = uW.g_js_strings.commonstr[CM.CHAMPION.getFactionClasses(ThroneCard.Faction)].toLowerCase();
    ThroneCard.type = throneCardTypes[parseInt(ThroneCard.Type)-1].toLowerCase();
    ThroneCard.unique = ThroneCard.id;
    ThroneCard.level = parseInt(lvl);
    ThroneCard.quality = tcoMaxThroneQuality;
    ThroneCard.createPrefix = function () { return ""; };
    ThroneCard.createSuffix = function () { return ""; };
    ThroneCard.effects = {};
    var effects = eval(ThroneCard.Effects);
    var slot = 0;

    for (k in effects) {
        slot++
        ThroneCard.effects["slot"+slot] = {};
        ThroneCard.effects["slot"+slot].id = effects[k].type;
        ThroneCard.effects["slot"+slot].tier = effects[k].tier;
           
        if (slot==6) {
            ThroneCard.effects["slot"+slot].quality = 5; // assume bright jewel
            ThroneCard.effects["slot"+slot].fromJewel = true;
               
            ThroneCard.jewel = {};
            ThroneCard.jewel.valid = true;
            ThroneCard.jewel.id = ThroneCard.effects["slot"+slot].id;
            ThroneCard.jewel.quality = 5; // assume bright jewel
            ThroneCard.jewel.tier = ThroneCard.effects["slot"+slot].tier;
            ThroneCard.jewel.fromJewel = true;
            ThroneCard.jewel.gift = false;
            ThroneCard.jewel.quantity = 1;
        }   
    }
    return BuildThroneCard(ThroneCard);
};

function BuildChampCard(champItem) { 

    var D = [];

    if (champItem == null) {
        D.push('<div>');
        D.push('</div>');
        return D.join('');
    }
    D.push('<div class=tcoCard style="white-space: normal; padding: 0px;">');
    D.push('<div class=section style="overflow: visible;" id=idsection>');
    D.push('<div div class="champ_item_section">');

    var champName = champItem.name;
    champName = champName.replace(champItem.createPrefix(), '');
    champName = champName.replace('Chest Armor of', 'Chest Of');
    champName = champName.trim();
    D.push('<div class="tcoTitle ' + champCardQualities[champItem.rarity] + '" title="' + champName + '" style="text-transform: capitalize;">');
    if (champItem.status == CM.CHAMPION.STATUS_BROKEN_UPGRADE || champItem.status == CM.CHAMPION.STATUS_BROKEN_ENHANCE) D.push('<font color=red><b>BROKEN</b></font><br>');
    D.push(champName);
    D.push('</div>');
    D.push('<div class=description>');
    var uniquestyle = "";
	if (champItem.unique != 0) uniquestyle = 'background:transparent url("' + IMGURL +'champion_hall/unique_' + champItemNames[champItem.Type] + '_' + champItem.faction + '_70x70_' + champItem.unique + '.png"); top left no-repeat; background-size: 70px 70px;';
    D.push('<div class="portrait ' + tcoFactions[champItem.faction-1] + ' ' + champItemNames[champItem.type] + '" style="'+uniquestyle+'"></div>');
    D.push('<ul>');
    D.push('<li>Faction: ' + tcoFactions[champItem.faction] + '</li>');
    D.push('<li>Quality: ' + champCardQualities[champItem.rarity] + '</li>');
    D.push('<li>Might: ' + (champItem.might > 0 ? champItem.might : '') + '</li>');
    D.push('</ul>');
    D.push('</div>');
    D.push('<ul class="effects">');

    for (var ef in champItem["effects"]) {
        var effectLine = champItem["effects"][ef];
        var effect = CM.ChampionManager.getEffect(effectLine, champItem.level);
        D.push('<li class="effect ' + (effect.id >= 200 ? 'statChamp' : 'statTroop') + '">' + effect.amount + ' ' + uW.g_js_strings.effects["name_" + effect.id ] + '</li>');
    }

    D.push('</ul>');
    D.push('</div>');
    D.push('</div>');
    D.push('</div>');
    D.push('</div>');
    return D.join('');
};

function BuildThroneCard(throneItem) {
    var D = [];
    var w = CM.thronestats.mightByQuality;
    var z = CM.thronestats.mightByLevel;

    if (throneItem == null) {
        D.push('<div>');
        D.push('</div>');
        return D.join('');
    }
    
    D.push('<div class=tcoCard style="white-space: normal; padding: 0px;">');
    D.push('<div class=section style="overflow: visible;" id=idsection>');
    D.push('<div div class="throne_item_section">');
    var throneName = throneItem.name;
    throneName = throneName.replace(throneItem.createPrefix(), '');
    throneName = throneName.trim();
    D.push('<div class="tcoTitle ' + throneItem.createPrefix().toLowerCase() + '" title="' + throneName + '" style="text-transform: capitalize;">');
    if (throneItem.isBroken) D.push('<font color=red><b>BROKEN</b></font><br>');
    D.push(throneName + (throneItem.unique ? ' +' + throneItem.level : ''));
    D.push('</div>');
    D.push('<div class=description>');

    var uniquestyle = '';
    if (throneItem.unique > 29000) {
        uniquestyle = 'background:transparent url("https://rycamelot1-a.akamaihd.net/silooneofcamelot/fb/e2/src/img/throne/icons/70/'+throneItem.faction+'_'+throneItem.type+'_unique_'+throneItem.unique + '.png"); top left no-repeat; background-size: 70px 70px;';
        if (throneItem.unique == 30262 || throneItem.unique == 30264 || throneItem.unique == 30266) { uniquestyle = 'background:transparent url("https://rycamelot1-a.akamaihd.net/silooneofcamelot/fb/e2/src/img/throne/icons/70/christmas_advisor_normal_1.png"); top left no-repeat; background-size: 70px 70px;';};
        if (throneItem.unique == 30261 || throneItem.unique == 30263 || throneItem.unique == 30265) { uniquestyle = 'background:transparent url("https://rycamelot1-a.akamaihd.net/silooneofcamelot/fb/e2/src/img/throne/icons/70/christmas_candelabrum_normal_1.png"); top left no-repeat; background-size: 70px 70px;';};
        if (throneItem.unique == 30230 || throneItem.unique == 30240 || throneItem.unique == 30250) { uniquestyle = 'background:transparent url("https://rycamelot1-a.akamaihd.net/silooneofcamelot/fb/e2/src/img/throne/icons/70/halloween_table_normal_1.png"); top left no-repeat; background-size: 70px 70px;';};
        if (throneItem.unique == 30231 || throneItem.unique == 30241 || throneItem.unique == 30251) { uniquestyle = 'background:transparent url("https://rycamelot1-a.akamaihd.net/silooneofcamelot/fb/e2/src/img/throne/icons/70/halloween_chair_normal_1.png"); top left no-repeat; background-size: 70px 70px;';};
    }
    D.push('<div class="portrait ' + throneItem.faction + ' ' + throneItem.type + '" style="'+uniquestyle+'"></div>');
    D.push('<ul>');
    D.push('<li>Faction: ' + throneItem.faction + '</li>');
    D.push('<li>Quality: ' + throneItem.createPrefix() + '</li>');
    //D.push('<li>' + uW.g_js_strings.commonstr.type + ': ' + throneItem.type + '</li>');
    //D.push('<li>' + uW.g_js_strings.commonstr.level + ': ' + throneItem.level + '</li>');
    D.push('<li>Might: ' + CM.ThroneView.getMightBonus(throneItem) + '</li>');
    D.push('<li>Jewel: ' + (throneItem.jewel == null ? 'None' : tcoJewelQualities[throneItem.jewel.quality-1]) + '</li>');
    D.push('</ul>');
    D.push('</div>');
    D.push('<ul>');

    for (slot in throneItem.effects) {
        try {
            var N = throneItem.effects[slot];
            effect = CM.thronestats.effects[N.id];

            tier = CM.thronestats.tiers[N.id][N.tier];
            if (!tier) tier = CM.thronestats.tiers[N.id][N.tier - 1];

            var base = tier.base || 0;
            var level = throneItem.level;
            var growth = tier.growth || 0;

            if (slot == 'slot6') {  //if it has a slot 6, it automatically has a jewel
                JewelQuality = throneItem['effects']['slot6'].quality;
                GrowthLimit = CM.thronestats.jewelGrowthLimit[JewelQuality];
                if (GrowthLimit <= level) level = GrowthLimit
            }

            percent = +(base + ((level * level + level) * growth * 0.5));

            var wholeNumber = false;
            if (Math.round(parseFloat(percent)) == parseFloat(percent)) wholeNumber = true;

            percent = (percent > 0) ? "+" + percent : +percent;

            if (wholeNumber)
                percent = parseFloat(percent).toFixed(0);
            else
                percent = parseFloat(percent).toFixed(2);

            css = (slot % 2 === 0) ? 'even' : 'odd';
            B = +(slot.split("slot")[1]);

            if (B <= throneItem.quality) {
                D.push('<li class="effect ' + css + '"> ' + percent + '% ' + effect[1] + '</li>');
            } else {
                D.push('<li class="effect disabled ' + css + '"> ' + percent + '% ' + effect[1] + '</li>');
            }
        }
        catch (e) { }

    }
    D.push('</ul>');
    D.push('</div>');
    D.push('</div>');
    D.push('</div>');
    D.push('</div>');
    return D.join('');
};

function NewsItemRow(msg) {
    var m = '<tr><td>&#149';
    m += msg;
    m += '</td></tr>';
    return m;
};

function pickAetherSalvageCity() {

    if (parseInt(Seed.resources["city" + Seed.cities[tcoGeneralOptions.salvageCityNum][0]]["rec5"][0]) <= tcoGeneralOptions.maxStones) return tcoGeneralOptions.salvageCityNum;

    var ind = -1;
    var lowest = 9999999;

    if (tcoGeneralOptions.salvageAnyCity) {
        for (i = 0; i < Seed.cities.length; i++) {
            if (tcoGeneralOptions.overflow == "lowest") {
                // put in the city w/ the lowest number of a-stone
                if (parseInt(Seed.resources["city" + Seed.cities[i][0]]["rec5"][0]) < lowest) {
                    ind = i;
                    lowest = +Seed.resources["city" + Seed.cities[ind][0]]["rec5"][0];
                }
            } else {
                // put in the first city with low stones
                if (parseInt(Seed.resources["city" + Seed.cities[i][0]]["rec5"][0]) <= tcoGeneralOptions.maxStones) {
                    return i;
                }
            }
        }
    }
    return ind;
};

function SalvageChampItem(id) {
    var t = Tabs.champSalvager;

    var params = uW.Object.clone(ajfx);
    var num_city = pickAetherSalvageCity();
    if ( num_city < 0)
    {
        num_city = +tcoGeneralOptions.salvageCityNum;
        t.setStatus("All cities are (nearly) full of aetherstone");
    }

    params.action = "8";
    params.eids = id;
    params.cityId = Seed.cities[num_city][0];

    new AjaxRequest(uW.g_ajaxpath + "ajax/ceEquipmentManagerAjax.php" + uW.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        loading: true,
        onSuccess: function (transport) {
            try {
                var rslt = eval("(" + transport.responseText + ")");
                var champ_item = uW.kocChampionItems[id];
                        
                if(rslt.ok == true) {
                    var eid = rslt.equipmentIds[0];
                    champ_item = uW.kocChampionItems[eid];
                            
                    if (champ_item) SalvageLog('Deleted Champion item '+ champ_item.name);
                    tcoChampSalvageData.numSalvagedItems++;
                    tcoChampSalvageData.numSalvagedItems2++;
                    SAVEtcoChampSalvageData();

                    if (champ_item) {
                        tcoChampSalvageData.numSalvaged[champ_item.rarity]++;
                        SAVEtcoChampSalvageData();
                        t.removeItem(eid , Seed.cities[num_city][0], parseInt(rslt.aetherstones));
                    }
                    t.displayNumberSalvaged();
                }
                else
                {
                    //logit("rslt: " + inspect(rslt,3,1));
                    if (champ_item) t.setStatus('Unable to salvage item ' + champ_item.name);
                }

                var idx = t.delItems.indexOf(id);
                if (idx >=0)
                {
                    t.delItems.splice(idx,1); 
                    // Remove item from array regardless
                    // of success. Catch on next refresh
                }
                if (t.delItems.length > 0) { // Check if the array is empty
                    t.upgradeAndDelete();
                } else {
                    t.deleting = false;
                    t.setStatus('Salvaging complete.  Waiting for next cycle.');
                    return;
                }
            } catch (e) {
                t.deleting = false;
            }
        },
        onFailure: function () {
            t.delIems = [];
            t.deleting = false;
            //if (uW.kocChampionItems[id] )                logit("salvage failed for item " + unsafeWindow.kocChampionItems[id].name );
            return;
        }
    });
}

function ThroneUpdateTimerDisplay () {

    if (!document.getElementById('tcoTimerDisplay')) return;

    var t = Tabs.throneUpgrader;
    var timeUntilDone = 0;

    if (t.repairEnd != 0) timeUntilDone = t.repairEnd - unixTime();

    if (timeUntilDone > 0)
        document.getElementById('tcoTimerDisplay').innerHTML = '<span id=tcoHammer></span> ' + rectime(timeUntilDone);
    else
        document.getElementById('tcoTimerDisplay').innerHTML = 'DONE';
}

function rectime(secs) {
    var min = Math.floor((secs)/60);
    var sec = Math.ceil(secs - (min * 60));

    if (sec < 10) {sec = "0" + sec;}
    return  min + ':' + sec;
}

function getThroneImage(item) {
    var img = '';
    if (item.unique == 30262 || item.unique == 30264 || item.unique == 30266) {
        img = "https://rycamelot1-a.akamaihd.net/silooneofcamelot/fb/e2/src/img/throne/icons/70/christmas_advisor_normal_1.png";
    } else if (item.unique == 30261 || item.unique == 30263 || item.unique == 30265) {
        img = "https://rycamelot1-a.akamaihd.net/silooneofcamelot/fb/e2/src/img/throne/icons/70/christmas_candelabrum_normal_1.png";
    } else if (item.unique == 30230 || item.unique == 30240 || item.unique == 30250) {
        img = "https://rycamelot1-a.akamaihd.net/silooneofcamelot/fb/e2/src/img/throne/icons/70/halloween_table_normal_1.png";
    } else if (item.unique == 30231 || item.unique == 30241 || item.unique == 30251) {
        img = "https://rycamelot1-a.akamaihd.net/silooneofcamelot/fb/e2/src/img/throne/icons/70/halloween_chair_normal_1.png";
    } else if (item.unique > 0) {
        img = "https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/30/" + item.faction + "/" + item.faction + "_" + item.type + "_unique_normal_" + item.unique + ".png";
    } else {
        img = "https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/icons/30/" + item.faction + "/" + item.faction + "_" + item.type + "_normal_1_" + item.quality + ".png";
    }
            
    if (item.isBroken) img = "https://rycamelot1-a.akamaihd.net/fb/e2/src/img/throne/modal/sm_fail_overlay.png";

    return img;
}

function SalvageThroneItem(id) {
    
    var t = Tabs.throneSalvager;
    
    var params = uW.Object.clone(ajfx);
    var num_city = pickAetherSalvageCity();
    if (num_city < 0) {
        num_city = +tcoGeneralOptions.salvageCityNum;
        t.setStatus("All cities are (nearly) full of aetherstone");
    }

    params.ctrl = 'throneRoom\\ThroneRoomServiceAjax';
    params.action = 'salvage';
    params.itemId = id;
    params.cityId = Seed.cities[num_city][0];

    new AjaxRequest(uW.g_ajaxpath + "ajax/_dispatch53.php" + uW.g_ajaxsuffix, {
        method: "post",
        parameters: params,
        loading: true,
        onSuccess: function (transport) {
            try {
                var rslt = eval("(" + transport.responseText + ")");
                var throne_item = uW.kocThroneItems[id];
                if (rslt.ok) {
                    if (throne_item) SalvageLog('Deleted Throne Room item ' + throne_item.name);
                    tcoThroneSalvageData.numSalvagedItems++;
                    tcoThroneSalvageData.numSalvagedItems2++;
                    SAVEtcoThroneSalvageData();

                    if (throne_item) {
                        tcoThroneSalvageData.numSalvaged[throne_item.quality]++;
                        SAVEtcoThroneSalvageData();
                        Tabs.throneSalvager.removeItem(id, Seed.cities[num_city][0], rslt.aetherstones);
                    }

                    Tabs.throneSalvager.displayNumberSalvaged();

                    var sidx = tcoThroneSalvageData.upgradedToDelete.indexOf(id);
                    if (sidx >= 0) {
                        tcoThroneSalvageData.upgradedToDelete.splice(sidx, 1); // Remove item from array
                        SAVEtcoThroneSalvageData();
                    }
                    var cmContainerOpen = (document.getElementsByClassName('cmModalContainer').length == 1 ? true : false);
                    sortThroneSorter(!cmContainerOpen);
                    setThroneSorter(!cmContainerOpen);
                    SAVEtcoThroneSorter();
                } else {
                    if (throne_item) Tabs.throneSalvager.setStatus('Unable to salvage item ' + throne_item.name);
                    CM.ThroneView.renderInventory(uW.kocThroneItems);
                }

                var idx = t.delItems.indexOf(id);

                if (idx >= 0) t.delItems.splice(idx, 1); // Remove item from array regardless of success. Catch on next refresh

                if (t.delItems.length > 0) { // Check if the array is empty
                    t.upgradeAndDelete();
                } else {
                    t.deleting = false;
                    t.setStatus('Salvaging complete.  Waiting for next cycle.');
                    return;
                }
            } catch (e) {
                t.deleting = false;
            }
        },
        onFailure: function () {
            t.delIems = [];
            t.deleting = false;
            CM.ThroneView.renderInventory(uW.kocThroneItems);
            return;
        }
    });
};

function ThroneAttachTab() {

    uW.hideShow    = eventHideShow;
    uW.execSalvager = Tabs.throneSalvager.togglePower;
    uW.execUpgrader = Tabs.throneUpgrader.togglePower;
    uW.execRepair  = Tabs.throneRepair.togglePower;
    uW.clickNextThroneLevel = Tabs.throneOrganizer.showNextThroneLevel;
 
    var str = ThroneTemplates.mainThrone.replace(
            '<li id="throneStatTab" class="inactive"> #{stats} </li>',
            '<li id="throneStatTab" class="inactive" style="font-size: 12px;"> #{stats} </li>' +
            '<li id="tcoControls" class="inactive" style="font-size: 12px;" onclick="hideShow()">TCO</li>' +
            '<li id="tcoExecuteRepair" class="inactive" style="font-size: 10px;" onclick="execRepair()">Repair = ' + (tcoThroneRepairData.active ? 'ON' : 'OFF') + '</li>' +
            '<li id="tcoExecuteUpgrader" class="inactive" style="font-size: 10px;" onclick="execUpgrader()">Upgrader = ' + (tcoThroneUpgradeData.active ? 'ON' : 'OFF') + '</li>' +
            '<li id="tcoExecuteSalvager" class="inactive" style="font-size: 10px;" onclick="execSalvager()">Salvager = ' + (tcoThroneSalvageData.active ? 'ON' : 'OFF') + '</li>' +
            '<li id="tcoTimerDisplay" class="inactive" style="font-size: 10px;">Done</li>');
    str = str.replace( '<div id="thronePanelContainer">', '<div id="thronePanelContainer" style="z-index: 101">');
    str = str.replace( '<li id="throneInventoryTab" class="inactive"> #{inventory} </li>', '<li id="throneInventoryTab" class="inactive" style="font-size: 12px;"> #{inventory} </li>');
    ThroneTemplates.mainThrone = str;

    ThroneTemplates.throneInfo = ThroneTemplates.throneInfo.replace (
            '<div id="throneInfoContainer">',
            '<div id="throneInfoContainer" style="z-index: 100;">');

    ThroneTemplates.mainThrone = ThroneTemplates.mainThrone.replace (
            '<div id="throneInfoContainer">',
            '<div id="throneInfoContainer" style="z-index: 100;">');

    ThroneTemplates.thronePanel = ThroneTemplates.thronePanel.replace(
            '<div class="thronePanelContainer">',
            '<div class="thronePanelContainer" style="z-index: 101;">');

    ThroneTemplates.thronePanel = ThroneTemplates.thronePanel.replace(
            '<div id="nextStatContainer" class="nextStat">',
            '<div id="nextStatContainer" class="nextStat" onclick="clickNextThroneLevel()">');

    ThroneTemplates.mainThrone = ThroneTemplates.mainThrone.replace(
            '<ul id="throneStatDisplay"></ul>', 
            '<div style="width: 70%; margin-left: auto; margin-right: auto;"><input type="button" value="Post to Chat" onclick="postThroneStats()"></input></div><ul id="throneStatDisplay"></ul>');

    GM_addStyle( "div#throneMainContainer div#throneInfoContainer div.infoContainer div.statContainer div.stats > ul {height: 345px }");

    function postThroneStats() { postThroneSlot(Seed.throne.activeSlot); }
    
    uW.postThroneStats = postThroneStats;
}

function SAVEtcoGlobalOptions() {
    setTimeout(function () { GM_setValue('tcoGlobalOptions_' + uW.tvuid, JSON2.stringify(tcoGlobalOptions)); }, 0);
}
function SAVEtcoGeneralOptions() {
    setTimeout(function () { GM_setValue('tcoGeneralOptions_' + getServerId() + uW.tvuid, JSON2.stringify(tcoGeneralOptions)); }, 0);
}
function SAVEtcoLogData() {
    setTimeout(function () { GM_setValue('tcoLogData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoLogData)); }, 0);
}
function SAVEtcoThroneUpgradeStats() {
    setTimeout(function () { GM_setValue('tcoThroneUpgradeStats_' + getServerId() + uW.tvuid, JSON2.stringify(tcoThroneUpgradeStats)); }, 0);
}
function SAVEtcoThroneUpgradeData() {
    setTimeout(function () { GM_setValue('tcoThroneUpgradeData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoThroneUpgradeData)); }, 0);
}
function SAVEtcoThroneQueueData() {
    setTimeout(function () { GM_setValue('tcoThroneQueueData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoThroneQueueData)); }, 0);
}
function SAVEtcoThronePresetData() {
    setTimeout(function () { GM_setValue('tcoThronePresetData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoThronePresetData)); }, 0);
    uW.tcoPresetNames = tcoThronePresetData.presetNames; 
}
function SAVEtcoThroneRepairData() {
    setTimeout(function () { GM_setValue('tcoThroneRepairData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoThroneRepairData)); }, 0);
}
function SAVEtcoThroneSalvageData() {
    setTimeout(function () { GM_setValue('tcoThroneSalvageData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoThroneSalvageData)); }, 0);
}
function SAVEtcoChampUpgradeStats() {
    setTimeout(function () { GM_setValue('tcoChampUpgradeStats_' + getServerId() + uW.tvuid, JSON2.stringify(tcoChampUpgradeStats)); }, 0);
}
function SAVEtcoChampUpgradeData() {
    setTimeout(function () { GM_setValue('tcoChampUpgradeData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoChampUpgradeData)); }, 0);
}
function SAVEtcoChampQueueData() {
    setTimeout(function () { GM_setValue('tcoChampQueueData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoChampQueueData)); }, 0);
}
function SAVEtcoChampPresetData() {
    setTimeout(function () { GM_setValue('tcoChampPresetData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoChampPresetData)); }, 0);
}
function SAVEtcoChampRepairData() {
    setTimeout(function () { GM_setValue('tcoChampRepairData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoChampRepairData)); }, 0);
}
function SAVEtcoChampSalvageData() {
    setTimeout(function () { GM_setValue('tcoChampSalvageData_' + getServerId() + uW.tvuid, JSON2.stringify(tcoChampSalvageData)); }, 0);
}
function SAVEtcoThroneSorter() {
    setTimeout(function () { GM_setValue('tcoThroneSorter_' + getServerId() + uW.tvuid, JSON2.stringify(tcoThroneSorter)); }, 0);
}

function LOADtcoGlobalOptions() {
    var s = GM_getValue('tcoGlobalOptions_' + uW.tvuid);
    if (s != null) tcoGlobalOptions = JSON2.parse(s);
}

function LOADtcoGeneralOptions() {
    var s = GM_getValue('tcoGeneralOptions_' + getServerId() + uW.tvuid);
    if (s != null) tcoGeneralOptions = JSON2.parse(s);
}

function LOADtcoLogData() {
    var s = GM_getValue('tcoLogData_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoLogData[k][kk] = opts[k][kk];
            else
                tcoLogData[k] = opts[k];
        }
    }
}

function LOADtcoThroneUpgradeStats() {
    var s = GM_getValue('tcoThroneUpgradeStats_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoThroneUpgradeStats[k][kk] = opts[k][kk];
            else
                tcoThroneUpgradeStats[k] = opts[k];
        }
    }
}

function LOADtcoThronePresetData() {
    var s = GM_getValue('tcoThronePresetData_'+ getServerId() + uW.tvuid);
    if (s != null){
        opts = JSON2.parse (s);
        for (k in opts){
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoThronePresetData[k][kk] = opts[k][kk];
            else
                tcoThronePresetData[k] = opts[k];
        }
    }
    for (var i in tcoThronePresetData.previewThrone) {
        var throne_item = uW.kocThroneItems[i];
        if (throne_item == null || !throne_item) delete tcoThronePresetData.previewThrone[i];
    }
    uW.tcoPresetNames = tcoThronePresetData.presetNames;
}

function LOADtcoThroneSalvageData() {
    var s = GM_getValue('tcoThroneSalvageData_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoThroneSalvageData[k][kk] = opts[k][kk];
            else
                tcoThroneSalvageData[k] = opts[k];
        }
    }

    for (k in tcoThroneSalvageData.ruleSet)
    {
        var r = tcoThroneSalvageData.ruleSet[k];
        var rule = new ThroneRule(r.type, r.faction, r.conditions, r.advancedrule);
        for (j in rule.conditions)
        {
            rule.conditions[j].ThroneCheckCondition = ThroneCheckCondition;
        }
        tcoThroneSalvageData.ruleSet[k] = rule;
    }
}


function LOADtcoThroneUpgradeData() {
    var s = GM_getValue('tcoThroneUpgradeData_' + getServerId() + uW.tvuid);

    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoThroneUpgradeData[k][kk] = opts[k][kk];
            else
                tcoThroneUpgradeData[k] = opts[k];
        }
    }
}

function LOADtcoThroneRepairData() {
    var s = GM_getValue('tcoThroneRepairData_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoThroneRepairData[k][kk] = opts[k][kk];
            else
                tcoThroneRepairData[k] = opts[k];
        }
    }
}

function LOADtcoThroneQueueData() {
    var s = GM_getValue('tcoThroneQueueData_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoThroneQueueData[k][kk] = opts[k][kk];
            else
                tcoThroneQueueData[k] = opts[k];
        }
    }
}

function LOADtcoChampUpgradeStats() {
    var s = GM_getValue('tcoChampUpgradeStats_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoChampUpgradeStats[k][kk] = opts[k][kk];
            else
                tcoChampUpgradeStats[k] = opts[k];
        }
    }
}

function LOADtcoChampPresetData() {
    var s = GM_getValue('tcoChampPresetData_'+ getServerId() + uW.tvuid);
    if (s != null){
        opts = JSON2.parse (s);
        for (k in opts){
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoChampPresetData[k][kk] = opts[k][kk];
            else
                tcoChampPresetData[k] = opts[k];
        }
    }
}

function LOADtcoChampSalvageData() {
    var s = GM_getValue('tcoChampSalvageData_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoChampSalvageData[k][kk] = opts[k][kk];
            else
                tcoChampSalvageData[k] = opts[k];
        }
    }

    for (k in tcoChampSalvageData.ruleSet) {
        var r = tcoChampSalvageData.ruleSet[k];
        var rule = new ChampRule(r.type, r.faction, r.conditions, r.advancedrule);
        for (j in rule.conditions) rule.conditions[j].ChampCheckCondition = ChampCheckCondition;
        tcoChampSalvageData.ruleSet[k] = rule;
    }
}


function LOADtcoChampUpgradeData() {
    var s = GM_getValue('tcoChampUpgradeData_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoChampUpgradeData[k][kk] = opts[k][kk];
            else
                tcoChampUpgradeData[k] = opts[k];
        }
    }
}

function LOADtcoChampRepairData() {
    var s = GM_getValue('tcoChampRepairData_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoChampRepairData[k][kk] = opts[k][kk];
            else
                tcoChampRepairData[k] = opts[k];
        }
    }
}

function LOADtcoChampQueueData() {
    var s = GM_getValue('tcoChampQueueData_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoChampQueueData[k][kk] = opts[k][kk];
            else
                tcoChampQueueData[k] = opts[k];
        }
    }
}

function LOADtcoThroneSorter() {
    var s = GM_getValue('tcoThroneSorter_' + getServerId() + uW.tvuid);
    if (s != null) {
        opts = JSON2.parse(s);
        for (k in opts) {
            if (matTypeof(opts[k]) == 'object')
                for (kk in opts[k])
                    tcoThroneSorter[k][kk] = opts[k][kk];
            else
                tcoThroneSorter[k] = opts[k];
        }
    }
}

function LOADallData() {
    LOADtcoChampPresetData();
    LOADtcoChampQueueData();
    LOADtcoChampRepairData();
    LOADtcoChampSalvageData();
    LOADtcoChampUpgradeData();
    LOADtcoChampUpgradeStats();
    LOADtcoGeneralOptions();
    LOADtcoGlobalOptions();
    LOADtcoLogData();
    LOADtcoThronePresetData();
    LOADtcoThroneQueueData();
    LOADtcoThroneRepairData();
    LOADtcoThroneSalvageData();
    LOADtcoThroneUpgradeData();
    LOADtcoThroneUpgradeStats();
    LOADtcoThroneSorter();
}

function SAVEallData() {
    SAVEtcoChampPresetData();
    SAVEtcoChampQueueData();
    SAVEtcoChampRepairData();
    SAVEtcoChampSalvageData();
    SAVEtcoChampUpgradeData();
    SAVEtcoChampUpgradeStats();
    SAVEtcoGeneralOptions();
    SAVEtcoGlobalOptions();
    SAVEtcoLogData();
    SAVEtcoThronePresetData();
    SAVEtcoThroneQueueData();
    SAVEtcoThroneRepairData();
    SAVEtcoThroneSalvageData();
    SAVEtcoThroneUpgradeData();
    SAVEtcoThroneUpgradeStats();
    SAVEtcoThroneSorter();
}

function SaveSettingsToFile(objSettings) {
    var uriContent = 'data:application/octet-stream,' + encodeURIComponent(JSON2.stringify(objSettings));
    var newWindow = window.open(uriContent, 'file.txt');
}

function LoadSettingsFromFile(objSettings, objTab) {
    var fileInput = document.getElementById("tcoSettingsFile");
    var files = fileInput.files;
    if (files.length == 0) {
        alert('Failed To Select A File');
        return;
    }
    var file = files[0];

    var reader = new FileReader();

    reader.onload = function (e) {
        var output = e.target.result;
        if (output != null) {
            opts = JSON2.parse(output);
            for (k in opts) {
                if (matTypeof(opts[k]) == 'object') {
                    for (kk in opts[k]) objSettings[k][kk] = opts[k][kk];
                } else {
                    objSettings[k] = opts[k];
                }
            }
            SAVEallData();
            objTab.show();
        }
    };

    reader.readAsText(file);
}

function SuccessLog(msg) {
    var t = Tabs.tcoLog;
    msg = msg.replace(',', '\,');
    t.addLogEntry(logValues.SUCCESS, msg);
    t.show();
}

function ActionLog(msg) {
    var t = Tabs.tcoLog;
    msg = msg.replace(',', '\,');
    t.addLogEntry(logValues.ACTION, msg);
    t.show();
}

function SalvageLog(msg) {
    var t = Tabs.tcoLog;
    msg = msg.replace(',', '\,');
    t.addLogEntry(logValues.SALVAGE, msg);
    t.show();
}

var AutoUpdater = {
    id: 999999,
	URL: 'greasyfork.org/scripts/13089-throne-champ-organizer/code/Throne%20Champ%20Organizer.user.js',
	name: 'Throne Champ Organizer',
	homepage: 'https://greasyfork.org/en/scripts/13089-throne-champ-organizer',
    version: tcoVersion,
	secure: true,
    call: function(secure,response) {
		this.secure = secure;
        GM_xmlhttpRequest({
            method: 'GET',
			url: 'http'+(secure ? 's' : '')+'://'+ this.URL,//CheckURL,
			onload: function(xpr) {AutoUpdater.compare(xpr,response);},
            onerror: function(xpr) {if (secure) {AutoUpdater.call(false,response);} else {AutoUpdater.compare({responseText:""},response);}}
        });
    },
	
    compareVersion: function(r_version, l_version) {
            var r_parts = r_version.split(''),
            l_parts = l_version.split(''),
            r_len = r_parts.length,
            l_len = l_parts.length,
            r = l = 0;
            for(var i = 0, len = (r_len > l_len ? r_len : l_len); i < len && r == l; ++i) {
                r = +(parseIntNan(r_parts[i]||0));
                l = +(parseIntNan(l_parts[i]||0));
            }
            return (r !== l) ? r > l : false;
    },
	
    compare: function(xpr,response) {
        this.xversion=/\/\/\s*@version\s+(.+)\s*\n/i.exec(xpr.responseText);   
        if (this.xversion) this.xversion = this.xversion[1];
        else {
			if (response) {
				uW.Modal.showAlert('<div align="center"> Unable to check for updates to ' + this.name +'.<br>Please change the update options or visit the <br><a href="' + this.homepage + '" target="_blank">Script Homepage</a></div>');
			}
			return;
		}
        this.xrelnotes=/\/\/\s*@releasenotes\s+(.+)\s*\n/i.exec(xpr.responseText);   
        if (this.xrelnotes) this.xrelnotes = this.xrelnotes[1];
        var updated = this.compareVersion(this.xversion, this.version);   
        if (updated) {
 			var body = '<BR><DIV align=center><FONT size=3><B>New version ' + this.xversion + ' is available!</b></font></div><BR>';
			if (this.xrelnotes)
				body+='<BR><div align="center" style="border:0;width:470px;height:120px;max-height:120px;overflow:auto"><b>New Features!</b><p>' + this.xrelnotes + '</p></div><BR>';
 			body+='<BR><DIV align=center><a class="gemButtonv2 green" id="doBotUpdate">Update</a></div>';
 			this.ShowUpdate(body);
        }
        else
        {
			if (response) {
				uW.Modal.showAlert('<div align="center">No updates available for ' + this.name + ' at this time.</div>');
			}
        } 		
    },
	
    check: function() {
    	var now = unixTime();
    	var lastCheck = 0;
    	if (GM_getValue('updated_'+this.id, 0)) lastCheck = parseInt(GM_getValue('updated_'+this.id, 0));
		if (now > (lastCheck + 60*60*12)) this.call(true,false);
    },
	
	ShowUpdate: function (body) {
		var now = unixTime();	 
		CM.ModalManager.addMedium({
			title: this.name,
			body: body,
			closeNow: false,
			close: function () {
				setTimeout (function (){GM_setValue('updated_'+AutoUpdater.id, now);}, 0);
				CM.ModalManager.closeAll();
			},
			"class": "Warning",
			curtain: false,
			width: 500,
			height: 700,
			left: 140,
			top: 140
		});
		document.getElementById('doBotUpdate').addEventListener ('click', this.doUpdate, false);   
	},

	doUpdate: function () {
		CM.ModalManager.closeAll();
		CM.ModalManager.close();
		var now = unixTime();
		GM_setValue('updated_'+AutoUpdater.id, now);
		location.href = 'http'+(AutoUpdater.secure ? 's' : '')+'://'+AutoUpdater.URL;
	},

};

if (document.location.toString().match('src/main_src.php')) ScriptStartup();