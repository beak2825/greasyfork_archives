// ==UserScript==
// @name         Babel Analytics
// @namespace    http://violentmonkey.net/
// @version      3.0
// @description  Copy ratings with a hotkey, auto-save, and show Real BRH overlay.
// @author       happyglue
// @match        https://davidai.retool.com/*
// @grant        GM_addStyle
// @downloadURL https://update.greasyfork.org/scripts/543821/Babel%20Analytics.user.js
// @updateURL https://update.greasyfork.org/scripts/543821/Babel%20Analytics.meta.js
// ==/UserScript==

function _0x1013(){let $=["type","postMessage","detail","totalBrh",'[data-testid*="-filled"]',"[data-testid$='RatingStep-","Real BRH: <strong>","901182lkbFbS","toFixed","SYNC DEBUG: FAILED. Could not find clickable star for rating ","SYNC DEBUG: FAILED. Found 0 rating rows. Check your 'ratingRow' selector."," to click. Clicking now.","navigation","isThreeSpeakerCall","setItem","SYNC DEBUG: Found ","apply","[data-item-index]:has([data-column-id='38908'] [data-testid*='-filled'])","Babel Master: Could not get current Conference ID.","SYNC DEBUG: Found star ","isWaitingForAnalytics","SYNC DEBUG: Reading row. Found rating of: ","keydown","center","length","body","changeToCell","isFourSpeaker","saveButton","querySelector","get_work_duration","246EbbkxQ","816805cbPjHu","preventDefault","#conferenceAuditingV1\\:\\:gradingRubricV1\\:\\:table5--0 > div > div._bulkActions_1y096_46 > div > button._action_1lpvk_45._primary_1lpvk_83","isFiveSpeakerCall",'\n    #babel-analytics-display {\n      position: fixed;\n      bottom: 20px;\n      left: 20px;\n      z-index: 999997;\n      background: rgba(40, 40, 45, 0.6);\n      backdrop-filter: blur(8px) saturate(180%);\n      -webkit-backdrop-filter: blur(8px) saturate(180%);\n      padding: 10px 18px;\n      border-radius: 16px;\n      border: 1px solid rgba(255, 255, 255, 0.1);\n      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);\n      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;\n      color: #F5F5F7;\n      text-align: left;\n      font-size: 15px;\n      font-weight: 500;\n      line-height: 1.4;\n      pointer-events: none;\n    }\n    #babel-analytics-display strong { font-weight: 700; color: white; }\n  ',"scrollIntoView","href","appendChild","\uD83D\uDED1 Babel Filler + Analytics disabled","15467346fMadZI","6218008GSdrlF","isFourSpeakerCall",'iframe[src*="retool-edge.com"]',"105020jGrpWc","16ZtIWBQ","iframe_keydown","conference_id","contentWindow","</strong>","removeAllRanges","destination","target","getItem","totalMinutes","TEXTAREA","8994440xfnbTC","ctrlKey","SYNC DEBUG: FAILED. Could not find save button. Check 'saveButton' selector.","code","push","SYNC DEBUG: Found save button. Clicking now.","babel-session-info","tagName","click","data","filledStar","activeElement","currentValueCell","message","ratingRow","remove","work_duration_response","searchParams","INPUT","KeyB","log","addEventListener","lastRatedCount"," rating rows.","Babel Master: No iframe found. Cannot get duration.","dispatchEvent","querySelectorAll","SYNC DEBUG: FAILED. Could not find 'currentValueCell' or 'changeToCell' in a row. Check those selectors.","mouseover",". Check 'changeToCell' and 'clickableStar' selectors.","startsWith","âœ… Babel Filler + Analytics enabled on","navigate","babelAnalytics_totalMinutes","error","blur","isThreeSpeaker","1144264eaPZMm","innerHTML","10YeLGIg","iframe","currentConferenceId","removeEventListener","pushState","isFiveSpeaker","pendingConferenceId","getSelection","createElement"];return(_0x1013=function(){return $})()}function _0x3d50($,x){let e=_0x1013();return(_0x3d50=function($,x){return e[$-=442]})($,x)}(function($,x){let e=_0x3d50,t=$();for(;;)try{let a=parseInt(e(500))/1+parseInt(e(457))/2+parseInt(e(475))/3*(-parseInt(e(514))/4)+-parseInt(e(513))/5*(-parseInt(e(499))/6)+-parseInt(e(525))/7+-parseInt(e(510))/8+-parseInt(e(509))/9*(-parseInt(e(459))/10);if(704948===a)break;t.push(t.shift())}catch(n){t.push(t.shift())}})(_0x1013,704948),function(){"use strict";let $=_0x3d50,x=!1,e=[],t,a=$(544),n={2:.33,3:.33,4:.5,5:.5},l={ratingRow:'[data-table-id="conferenceAuditingV1::gradingRubricV1::table5--0"] [data-item-index]',currentValueCell:'[data-column-id="81da2"]',changeToCell:'[data-column-id="38908"]',filledStar:$(472),clickableStar:x=>$(473)+x+"']",saveButton:$(502),iframe:$(512)},i=$=>new Promise(x=>setTimeout(x,$));function r(x){let e=$;try{return new URL(x)[e(542)].get(e(516))}catch{return null}}let _={totalRealMinutes:0,totalBrh:0,isWaitingForAnalytics:!1,pendingConferenceId:null,currentConferenceId:null,isThreeSpeakerCall:!1,isFourSpeakerCall:!1,isFiveSpeakerCall:!1,lastRatedCount:0},o={totalMinutes:$(453),totalBrh:"babelAnalytics_totalBrh"};function c(){let x=$;t&&(t[x(458)]=x(474)+_[x(471)][x(476)](3)+x(518))}async function d(){let x=$;console[x(545)]("SYNC DEBUG: Hotkey pressed. Starting syncRatings...");let e=document.querySelectorAll(l[x(539)]);if(0===e.length)return console[x(454)](x(478));for(let t of(console.log(x(483)+e[x(492)]+x(443)),e)){let a=t[x(497)](l[x(537)]),n=t.querySelector(l[x(494)]);if(a&&n){let r=a[x(446)](l[x(535)])[x(492)];if(console[x(545)](x(489)+r),r>0){t[x(445)](new MouseEvent(x(448),{bubbles:!0})),await i(15);let _=n[x(497)](l.clickableStar(r));_?(console.log(x(487)+r+x(479)),_[x(533)]()):console[x(454)](x(477)+r+x(449)),await i(15)}}else console.error(x(447))}await i(20),document[x(536)]&&document[x(536)][x(455)]&&document.activeElement.blur(),window[x(466)]()[x(519)]();let o=document[x(497)](l[x(496)]);o?(console[x(545)](x(530)),o[x(533)]()):console.error(x(527))}function s(){let x=$;if(_[x(488)])return;_.isWaitingForAnalytics=!0;let e=_[x(461)];if(!e){console.error(x(486)),_.isWaitingForAnalytics=!1;return}_.pendingConferenceId=e;let t=document.querySelector(l.iframe);t&&t.contentWindow?t[x(517)][x(469)](x(498),"*"):(console.error(x(444)),_[x(488)]=!1)}function f(e){let t=$;x&&(_[t(481)]=e.detail[t(456)],_.isFourSpeakerCall=e[t(470)][t(495)],_.isFiveSpeakerCall=e[t(470)][t(464)])}function u(x){let e=$;if(x[e(534)]&&x[e(534)][e(468)]===e(541)){if(!_.isWaitingForAnalytics)return;let{minutes:t}=x[e(534)],i=0,r=_[e(442)],s=10;_[e(503)]?s=25:_[e(511)]?s=20:_[e(481)]&&(s=15),r>0&&s>0&&(i=t/s*r);let f=n[2];_[e(503)]?f=n[5]:_[e(511)]?f=n[4]:_[e(481)]&&(f=n[3]);let u=i/60*f;_[e(471)]+=u,_.totalRealMinutes+=i,function x(){let e=$;sessionStorage.setItem(o.totalMinutes,_.totalRealMinutes),sessionStorage[e(482)](o[e(471)],_[e(471)])}(),c(),_[e(488)]=!1,_[e(465)]=null,_[e(442)]=0;return}if(x[e(534)]&&x[e(534)].type===e(515)){let{code:b,altKey:g,ctrlKey:p,shiftKey:h}=x[e(534)];if(b===a&&!p&&g){x[e(501)]?.();let y=document[e(497)](l[e(460)]);y&&y[e(505)]({behavior:"smooth",block:e(491)}),d()}}}function b(x){let e=$,t=x[e(521)].closest(l[e(496)]);if(t){let a=document.querySelectorAll(e(485));_[e(442)]=a.length,setTimeout(s,50)}}function g(x){let e=$;if((!x[e(521)]||x[e(521)][e(532)]!==e(543)&&x[e(521)].tagName!==e(524))&&x[e(528)]===a&&x.altKey&&!x[e(526)]){x[e(501)]();let t=document[e(497)](l[e(460)]);t&&t[e(505)]({behavior:"smooth",block:e(491)}),d()}}function p(){let a=$;location[a(506)][a(450)]("https://davidai.retool.com/apps/a53801c8-d94c-11ef-be02-eb390bc730a8/Call%20Reviews/Audio%20Reviewing/review")?function a(){let n=$;x||(x=!0,console[n(545)](n(451),location[n(506)]),(t=document[n(467)]("div")).id="babel-analytics-display",document[n(493)][n(507)](t),document[n(493)][n(546)]("click",b,!0),window[n(546)](n(538),u),window[n(546)](n(531),f),document[n(546)]("keydown",g),e[n(529)](()=>document[n(493)][n(462)](n(533),b,!0)),e[n(529)](()=>window.removeEventListener(n(538),u)),e.push(()=>window.removeEventListener(n(531),f)),e[n(529)](()=>document[n(462)](n(490),g)),e[n(529)](()=>{t?.[n(540)](),t=null}),function x(){let e=$;_.totalRealMinutes=parseFloat(sessionStorage.getItem(o[e(523)])||"0"),_[e(471)]=parseFloat(sessionStorage[e(522)](o[e(471)])||"0"),_[e(461)]=r(location[e(506)]),c(),window[e(480)]&&window[e(480)][e(546)](e(452),$=>{let x=e;_[x(461)]=r($[x(520)].url)})}())}():function t(){let a=$;x&&(console.log(a(508)),x=!1,e.forEach($=>$()),e=[],_[a(461)]=null)}()}GM_addStyle($(504));let h=history.pushState;history[$(463)]=function(){h[$(484)](this,arguments),setTimeout(p,50)};let y=history.replaceState;history.replaceState=function(){y.apply(this,arguments),setTimeout(p,50)},window[$(546)]("popstate",p);let C=location[$(506)];new MutationObserver(()=>{let x=$;location[x(506)]!==C&&(C=location[x(506)],p())}).observe(document,{subtree:!0,childList:!0}),p()}();